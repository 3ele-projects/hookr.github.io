<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.5" data-slug="mailpoet-newsletters" data-type="class" data-id="41167"><head xmlns="http://www.w3.org/1999/xhtml"><title> wysija_help_user | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WYSIJA_help_user, class, plugin, mailpoet-newsletters, 2.7.5" /><meta name="description" content="The MailPoet Newsletters WYSIJA help user class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"http:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4"}};!function(a,b,c){function d(a){var c=b.createElement("canvas"),d=c.getContext&&c.getContext("2d");return d&&d.fillText?(d.textBaseline="top",d.font="600 32px Arial","flag"===a?(d.fillText(String.fromCharCode(55356,56806,55356,56826),0,0),c.toDataURL().length>3e3):("simple"===a?d.fillText(String.fromCharCode(55357,56835),0,0):d.fillText(String.fromCharCode(55356,57135),0,0),0!==d.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=16ec993ac35676092baef68ae7b362d5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wysija_help_user/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_help_user%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_help_user%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.5-class-wysija_help_user","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wysija_help_user" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.5." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/" class="H_VERSION"><span property="name">2.7.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wysija_help_user</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="299"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/all/" title="All">All <span class="count badge">299</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="active" data-id="class" data-count="132"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" title="Classes">Classes <span class="count badge">132</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WYSIJA_help_user</strong></h1><p>The MailPoet Newsletters <strong>WYSIJA help user</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/files/helpers-user/" class="file">/helpers/user.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="5" class="block" start="5"><li><div>class WYSIJA_help_user extends WYSIJA_object {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $no_confirmation_email = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used whend confirming email with dbl optin&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @param type $status&nbsp;</div></li><li><div>     * @param type $auto&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscribe($user_id, $status = true, $auto = false, $listids = array()) {&nbsp;</div></li><li><div>        $time = time();&nbsp;</div></li><li><div>        $cols = false;&nbsp;</div></li><li><div>        // get the enabled lists&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $listsdata = $model_list-&gt;get(array('list_id'), array('is_enabled' =&gt; '1'));&nbsp;</div></li><li><div>        $enabled_list_ids = array();&nbsp;</div></li><li><div>        foreach ($listsdata as $listdt) {&nbsp;</div></li><li><div>            $enabled_list_ids[] = $listdt['list_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get list_id from user&nbsp;</div></li><li><div>        $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>        $listidsfromuser = $model_user_list-&gt;get(array('list_id'), array('user_id' =&gt; $user_id, 'list_id' =&gt; $enabled_list_ids));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $listidsenableduser = array();&nbsp;</div></li><li><div>        foreach ($listidsfromuser as $listdt) {&nbsp;</div></li><li><div>            $listidsenableduser[] = $listdt['list_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($status) {&nbsp;</div></li><li><div>            $status = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if undo unsubscribe then we re-subscribe all the previously unsubscribed lists based on the unsub_date value&nbsp;</div></li><li><div>            if( !empty( $_REQUEST['action'] ) && $_REQUEST['action'] == 'undounsubscribe' ) {&nbsp;</div></li><li><div>                // get latest time when users unsubcribe from a list&nbsp;</div></li><li><div>                $model_user_list-&gt;columns['MAX(`unsub_date`) as `max_unsub_date`']=array(&quot;type&quot;=&gt;&quot;integer&quot;);&nbsp;</div></li><li><div>                $max_unsub_date = $model_user_list-&gt;get(array('MAX(`unsub_date`) as `max_unsub_date`'), array('user_id' =&gt; $user_id));&nbsp;</div></li><li><div>                $max_unsub_date = $max_unsub_date[0]['max_unsub_date'];&nbsp;</div></li><li><div>                // when somebody undo - unsubscribe, let's reset the unsub_date of all of the latest lists which users belong to&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date' =&gt; 0, 'sub_date' =&gt; time()), array('user_id' =&gt; $user_id, 'unsub_date' =&gt; $max_unsub_date));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // the data  we update on the user row&nbsp;</div></li><li><div>            $user_updated_data = array( 'status' =&gt; $status , 'confirmed_ip' =&gt; $this-&gt;getIP() , 'confirmed_at' =&gt; time() );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // when we unsubscribe somebody automatically(through the bounce) we set the status to -2 instead of -1 to make the difference&nbsp;</div></li><li><div>            $status = -1;&nbsp;</div></li><li><div>            $modelU = WYSIJA::get('queue', 'model');&nbsp;</div></li><li><div>            $modelU-&gt;delete(array('user_id' =&gt; $user_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // when somebody unsubscribe, let's set the unsub_date and reset the sub_date of all the lists which users belong to&nbsp;</div></li><li><div>            $model_user_list-&gt;update(array('unsub_date' =&gt; time(), 'sub_date' =&gt; 0), array('user_id' =&gt; $user_id, 'unsub_date' =&gt; 0));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // the data  we update on the user row&nbsp;</div></li><li><div>            $user_updated_data = array('status' =&gt; $status);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelUser = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $modelUser-&gt;update($user_updated_data, array('user_id' =&gt; $user_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the status is subscribed then we modify the user_list status and process the autonewsletter&nbsp;</div></li><li><div>        if ($status) {&nbsp;</div></li><li><div>            // update the sub_date col in the user_list table&nbsp;</div></li><li><div>            if (!$auto) {&nbsp;</div></li><li><div>                $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>                $cols = array('sub_date' =&gt; $time, 'unsub_date' =&gt; 0);&nbsp;</div></li><li><div>                $model_user_list-&gt;update($cols, array('user_id' =&gt; $user_id, 'list_id' =&gt; $listids));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // process the auto newsletter once the status changed&nbsp;</div></li><li><div>            $lists = $this-&gt;getUserLists($user_id, $listids);&nbsp;</div></li><li><div>            $this-&gt;sendAutoNl($user_id, $lists);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $listidsenableduser;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * check that a bot didn't stick his hand in our honey pot&nbsp;</div></li><li><div>     * @param type $data&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function checkData(&$data) {&nbsp;</div></li><li><div>        if (isset($data['user']['abs'])) {&nbsp;</div></li><li><div>            foreach ($data['user']['abs'] as $honeyKey =&gt; $honeyVal) {&nbsp;</div></li><li><div>                //if honey val then robotty is out !&nbsp;</div></li><li><div>                if ($honeyVal)&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset($data['user']['abs']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $user_keys = array('email', 'firstname', 'lastname');&nbsp;</div></li><li><div>        foreach($data['user'] as $keyi =&gt; $val) {&nbsp;</div></li><li><div>            if(!in_array($keyi, $user_keys)) {&nbsp;</div></li><li><div>                unset($data['user'][$keyi]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function to insert subscribers into wysija&nbsp;</div></li><li><div>     * data parameter is a multidimensional array&nbsp;</div></li><li><div>     * @param array  $data=array(&nbsp;</div></li><li><div>     *       'user'=&gt;array('email'=&gt;$myuserEMAIL, 'firstname'=&gt;$myuserFIRSTNAME), &nbsp;</div></li><li><div>     *       'user_lists'=&gt;array('list_ids'=&gt;array($listid1, $listid2))&nbsp;</div></li><li><div>     * );&nbsp;</div></li><li><div>     * @param boolean $subscribing_from_backend&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function addSubscriber( $data , $subscribing_from_backend = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_error = false;&nbsp;</div></li><li><div>        // 0 - action before any processing call third party services WangGuard for instance&nbsp;</div></li><li><div>        if ( !$subscribing_from_backend ) {&nbsp;</div></li><li><div>            $valid_email = apply_filters('wysija_beforeAddSubscriber', true, $data['user']['email']);&nbsp;</div></li><li><div>            if ( !$valid_email ) {&nbsp;</div></li><li><div>                $this-&gt;error( __( 'The email is not valid!' , WYSIJA ), true );&nbsp;</div></li><li><div>                $has_error = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 1-check if email is valid&nbsp;</div></li><li><div>        if ( !$this-&gt;validEmail( $data['user']['email'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;error( __( 'The email is not valid!' , WYSIJA ), true );&nbsp;</div></li><li><div>            $has_error = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if lists are specified?&nbsp;</div></li><li><div>        if ( empty( $data['user_list']['list_ids'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;error( __( 'You need to select at least one list.' , WYSIJA ) , true);&nbsp;</div></li><li><div>            $has_error = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure we get all the errors in one shot&nbsp;</div></li><li><div>        if ($has_error === true) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 2-check if email doesn't exists already&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $subscriber_exists_already = $model_user-&gt;getOne(false, array('email' =&gt; trim($data['user']['email'])));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $confirm_dbloptin = $model_config-&gt;getValue('confirm_dbleoptin');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // message success escaping, striping, setting&nbsp;</div></li><li><div>        $message_success = '';&nbsp;</div></li><li><div>        if ( isset( $data['message_success'] ) ) {&nbsp;</div></li><li><div>            $message_success = strip_tags( $data['message_success'] , '&lt;p&gt;&lt;em&gt;&lt;span&gt;&lt;b&gt;&lt;strong&gt;&lt;i&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt;&lt;a&gt;&lt;ul&gt;&lt;ol&gt;&lt;li&gt;&lt;br&gt;');&nbsp;</div></li><li><div>        } else if ( isset( $data['success_message'] ) ) {&nbsp;</div></li><li><div>            $message_success = strip_tags( nl2br(base64_decode( $data['success_message'] ) ) , '&lt;p&gt;&lt;em&gt;&lt;span&gt;&lt;b&gt;&lt;strong&gt;&lt;i&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt;&lt;a&gt;&lt;ul&gt;&lt;ol&gt;&lt;li&gt;&lt;br&gt;');&nbsp;</div></li><li><div>        } else if ( isset( $data['form_id'] ) ) {&nbsp;</div></li><li><div>            // we have a form_id parameter so let's fetch the form success message&nbsp;</div></li><li><div>            $model_forms = WYSIJA::get('forms', 'model');&nbsp;</div></li><li><div>            $form = $model_forms-&gt;getOne( array( 'data' ) , array( 'form_id' =&gt; (int) $data['form_id'] ) );&nbsp;</div></li><li><div>            $form_data = unserialize( base64_decode( $form['data'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if the on_success action is 'message', display message&nbsp;</div></li><li><div>            if ( $form_data['settings']['on_success'] === 'message') {&nbsp;</div></li><li><div>                $message_success = nl2br( $form_data['settings']['success_message'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $subscriber_exists_already ) {&nbsp;</div></li><li><div>            // show a message for that case scenario in the admin panel&nbsp;</div></li><li><div>            if ( $subscribing_from_backend ) {&nbsp;</div></li><li><div>                $this-&gt;error(str_replace(array('[link]', '[/link]'), array('&lt;a href=&quot;admin.php?page=wysija_subscribers&action=edit&id=' . $subscriber_exists_already['user_id'] . '&quot; &gt;', &quot;&lt;/a&gt;&quot;), __('Subscriber already exists. [link]Click to edit[/link].', WYSIJA)), true);&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get( 'user_list' , 'model' );&nbsp;</div></li><li><div>            $subscribed_but_require_confirmation = false;&nbsp;</div></li><li><div>            if( $subscriber_exists_already['status'] == 1 ) {&nbsp;</div></li><li><div>                $unsubscribed_lists = $model_user_list-&gt;get( array( 'list_id' ) , array( 'greater' =&gt; array( 'unsub_date' =&gt; 0 ), 'equal' =&gt; array( 'user_id' =&gt; $subscriber_exists_already['user_id'] ) ) );&nbsp;</div></li><li><div>                $already_unsubscribed_list_ids_formatted = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ($unsubscribed_lists as $user_list_detail) {&nbsp;</div></li><li><div>                    $already_unsubscribed_list_ids_formatted[] = $user_list_detail['list_id'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ($data['user_list']['list_ids'] as $list_id) {&nbsp;</div></li><li><div>                    if ( in_array( $list_id, $already_unsubscribed_list_ids_formatted ) ) {&nbsp;</div></li><li><div>                        $subscribed_but_require_confirmation = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if the status of the user is either unsubscribed or not confirmed&nbsp;</div></li><li><div>            // or he is unsubscribed from one of the list he is trying to subscribe again&nbsp;</div></li><li><div>            // we resend him the activation email&nbsp;</div></li><li><div>            if ( (int) $subscriber_exists_already['status'] &lt; 1 || $subscribed_but_require_confirmation ) {&nbsp;</div></li><li><div>                $model_user-&gt;reset();&nbsp;</div></li><li><div>                $model_user-&gt;update( array( 'status' =&gt; 0 ), array( 'user_id' =&gt; $subscriber_exists_already['user_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $subscribe_to_list = 0;&nbsp;</div></li><li><div>                if ( !$confirm_dbloptin ) {&nbsp;</div></li><li><div>                    $subscribe_to_list = time();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;addToLists( $data['user_list']['list_ids'], $subscriber_exists_already['user_id'], $subscribe_to_list);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // this is the double optin case, where we simply send the signup confirmation&nbsp;</div></li><li><div>                if ( $confirm_dbloptin ) {&nbsp;</div></li><li><div>                    $this-&gt;sendConfirmationEmail( (object) $subscriber_exists_already, true, $data['user_list']['list_ids']);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // this is the single optin case, where we fire the autoresponders directly&nbsp;</div></li><li><div>                    $lists = $this-&gt;getUserLists( $subscriber_exists_already['user_id'], $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                    $this-&gt;sendAutoNl( $subscriber_exists_already['user_id'], $lists );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $model_config-&gt;getValue( 'emails_notified' ) && $model_config-&gt;getValue( 'emails_notified_when_sub' ) ) {&nbsp;</div></li><li><div>                        // notify the administrators of a new subscribption&nbsp;</div></li><li><div>                        $this-&gt;uid = $subscriber_exists_already['user_id'];&nbsp;</div></li><li><div>                        if ( !$subscribing_from_backend )&nbsp;</div></li><li><div>                            $this-&gt;_notify( $data['user']['email'], true, $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( !empty( $message_success ) ) {&nbsp;</div></li><li><div>                    $this-&gt;notice( $message_success );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $already_subscribed_list_ids = $model_user_list-&gt;get(array('list_id'), array('greater' =&gt; array('sub_date' =&gt; 0), 'equal' =&gt; array( 'user_id' =&gt; $subscriber_exists_already['user_id'] ) ) );&nbsp;</div></li><li><div>            $already_subscribed_list_ids_formatted = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($already_subscribed_list_ids as $user_list_detail) {&nbsp;</div></li><li><div>                $already_subscribed_list_ids_formatted[] = $user_list_detail['list_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // a confirmation needs to be resend for those lists&nbsp;</div></li><li><div>            $list_ids_require_confirmation = array();&nbsp;</div></li><li><div>            foreach ( $data['user_list']['list_ids'] as $list_id ) {&nbsp;</div></li><li><div>                // only the list for which the subscribe request is made and is not already subscribed too willr equire confirmation&nbsp;</div></li><li><div>                if ( !in_array($list_id, $already_subscribed_list_ids_formatted ) ) {&nbsp;</div></li><li><div>                    $list_ids_require_confirmation[] = $list_id;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // this process require either a confirmation email to be sent or&nbsp;</div></li><li><div>            // the autoresponders to be triggerred&nbsp;</div></li><li><div>            if ( !empty( $list_ids_require_confirmation ) ) {&nbsp;</div></li><li><div>                $subscribe_to_list = $subscriber_status = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['user']['status'] ) ) {&nbsp;</div></li><li><div>                    $subscriber_status = $data['user']['status'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if double optin is activated and the subscriber status is 1 (subscribed)&nbsp;</div></li><li><div>                // or this is single optin, then we directly subscribe the user to the list&nbsp;</div></li><li><div>                if ( ( $confirm_dbloptin && $subscriber_status ) || !$confirm_dbloptin ) {&nbsp;</div></li><li><div>                    $subscribe_to_list = time();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // we can add the subscribers to the lists passed&nbsp;</div></li><li><div>                $this-&gt;addToLists( $data['user_list']['list_ids'] , $subscriber_exists_already['user_id'] , $subscribe_to_list );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // send a confirmation message when double optin is on&nbsp;</div></li><li><div>                if ( $confirm_dbloptin ) {&nbsp;</div></li><li><div>                    //if we have lists that are going to be added we send a confirmation email for double optin&nbsp;</div></li><li><div>                    $this-&gt;sendConfirmationEmail( (object) $subscriber_exists_already, true, $list_ids_require_confirmation );&nbsp;</div></li><li><div>                }else{&nbsp;</div></li><li><div>                    // send auto nl to single optin which have lists added&nbsp;</div></li><li><div>                    if ( !empty( $list_ids_require_confirmation ) ) {&nbsp;</div></li><li><div>                        $lists = $this-&gt;getUserLists( $subscriber_exists_already['user_id'] , $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                        $this-&gt;sendAutoNl( $subscriber_exists_already['user_id'] , $lists );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( !empty( $message_success ) ) {&nbsp;</div></li><li><div>                    $this-&gt;notice( $message_success );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                //no lists need to be added so we can simply return the message&nbsp;</div></li><li><div>                $this-&gt;notice(__(&quot;Oops! You're already subscribed.&quot;, WYSIJA));&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 3-insert the subscriber with the right status based on optin status&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscriber_data = $data['user'];&nbsp;</div></li><li><div>        $subscriber_data['ip'] = $this-&gt;getIP();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_user-&gt;reset();&nbsp;</div></li><li><div>        $user_id = $model_user-&gt;insert($subscriber_data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( (int)$user_id &gt; 0 ) {&nbsp;</div></li><li><div>            // if a form id is specified, let's increment its &quot;subscribed count&quot;&nbsp;</div></li><li><div>            if (isset($data['form_id']) && (int) $data['form_id'] &gt; 0) {&nbsp;</div></li><li><div>                // check if the form exists&nbsp;</div></li><li><div>                $model_forms = WYSIJA::get('forms', 'model');&nbsp;</div></li><li><div>                $form = $model_forms-&gt;getOne( array('form_id', 'subscribed') , array('form_id' =&gt; (int) $data['form_id']) );&nbsp;</div></li><li><div>                if ( isset( $form['form_id'] ) && (int) $form['form_id'] === (int) $data['form_id'] ) {&nbsp;</div></li><li><div>                    // the form exists so let's increment the &quot;subscribed&quot; count&nbsp;</div></li><li><div>                    $model_forms-&gt;update( array(&nbsp;</div></li><li><div>                        'subscribed' =&gt; $form['subscribed'] + 1&nbsp;</div></li><li><div> ), array(&nbsp;</div></li><li><div>                        'form_id' =&gt; (int) $form['form_id']&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set user profile data&nbsp;</div></li><li><div>            if( !empty( $data['user_field'] ) ) {&nbsp;</div></li><li><div>                WJ_FieldHandler::handle_all( $data['user_field'], $user_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // display success message&nbsp;</div></li><li><div>            if ( !empty( $message_success ) ) {&nbsp;</div></li><li><div>                $this-&gt;notice( $message_success );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            if ($subscribing_from_backend) {&nbsp;</div></li><li><div>                $this-&gt;notice(__('Subscriber has not been saved.', WYSIJA));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;notice(__('Oops! We could not add you!', WYSIJA));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscribe_to_list = $subscriber_status = 0;&nbsp;</div></li><li><div>        if ( isset( $data['user']['status'] ) ) {&nbsp;</div></li><li><div>            $subscriber_status = $data['user']['status'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ( $confirm_dbloptin && $subscriber_status ) || !$confirm_dbloptin ) {&nbsp;</div></li><li><div>            $subscribe_to_list = time();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //4-we add the user to the lists&nbsp;</div></li><li><div>        $this-&gt;addToLists( $data['user_list']['list_ids'], $user_id, $subscribe_to_list );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 5-send a confirmation email or add the user to the lists depending on the status&nbsp;</div></li><li><div>        $can_send_autoresponders = false;&nbsp;</div></li><li><div>        if ( $subscriber_status &gt; -1 ) {&nbsp;</div></li><li><div>            if ( $confirm_dbloptin ) {&nbsp;</div></li><li><div>                if ( $subscriber_status == 0 ) {&nbsp;</div></li><li><div>                    $model_user-&gt;reset();&nbsp;</div></li><li><div>                    $model_user-&gt;getFormat = OBJECT;&nbsp;</div></li><li><div>                    $receiver = $model_user-&gt;getOne( false , array('email' =&gt; trim($data['user']['email']) ) );&nbsp;</div></li><li><div>                    $this-&gt;sendConfirmationEmail( $receiver, true, $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    //the subscriber status is set to subscribed so we send the auto nl straight away&nbsp;</div></li><li><div>                    $can_send_autoresponders = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // single optin - we send a notification to the admin if settings are set&nbsp;</div></li><li><div>                $can_send_autoresponders = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($model_config-&gt;getValue( 'emails_notified' ) && $model_config-&gt;getValue( 'emails_notified_when_sub' ) ) {&nbsp;</div></li><li><div>                    $this-&gt;uid = $user_id;&nbsp;</div></li><li><div>                    if (!$subscribing_from_backend) {&nbsp;</div></li><li><div>                        $this-&gt;_notify( $data['user']['email'] , true, $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // let's send the autoresponders&nbsp;</div></li><li><div>            if ( $can_send_autoresponders ) {&nbsp;</div></li><li><div>                $lists = $this-&gt;getUserLists( $user_id, $data['user_list']['list_ids'] );&nbsp;</div></li><li><div>                $this-&gt;sendAutoNl( $user_id, $lists, 'subs-2-nl', $subscribing_from_backend );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $user_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * send auto nl based on the params passed&nbsp;</div></li><li><div>     * @staticvar type $emails&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @param mixed $params_based_on_type the params which are needed for this type of newsletter&nbsp;</div></li><li><div>     * @param string $process_type the type of auto newsletter that needs to be processed&nbsp;</div></li><li><div>     * @param boolean $added_by_admin to make the distinction between subscribers added through the admin interface or not&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function sendAutoNl($user_id, $params_based_on_type = false, $process_type = 'subs-2-nl', $added_by_admin = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check that the user we're trying to send the newsletter to has the right status&nbsp;</div></li><li><div>        $modelUser=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $modelC=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $dbloptin=(int)$modelC-&gt;getValue('confirm_dbleoptin');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we send an autonl if the subscriber is not added to the list by the admin and the user's status is greater or equal to 0 or 1 (if a user switch from double optin to single optin the greater or equal suddenly make sense)&nbsp;</div></li><li><div>        if(!$added_by_admin && !$modelUser-&gt;exists( array( 'equal' =&gt; array( 'user_id' =&gt; $user_id ), 'greater_eq' =&gt; array( 'status' =&gt; $dbloptin )))) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $userListss = array();&nbsp;</div></li><li><div>        if($dbloptin && !$added_by_admin) {&nbsp;</div></li><li><div>            $modelUserList=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $userListssres=$modelUserList-&gt;get(array('list_id'), array('equal'=&gt;array('user_id'=&gt;$user_id), 'greater'=&gt;array('sub_date'=&gt;0)));&nbsp;</div></li><li><div>            foreach($userListssres as $res) {&nbsp;</div></li><li><div>                $userListss[]=$res['list_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }elseif(!$dbloptin) {&nbsp;</div></li><li><div>            // in the case where double optin is off we're filling an array of lists from which the subscriber could receive autoresponders&nbsp;</div></li><li><div>            $modelUserList = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $userListssres = $modelUserList-&gt;get(array('list_id'), array('equal'=&gt;array('user_id'=&gt;$user_id)));&nbsp;</div></li><li><div>            foreach($userListssres as $res) {&nbsp;</div></li><li><div>                $userListss[] = $res['list_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // loading active automatic emails&nbsp;</div></li><li><div>        static $emails;&nbsp;</div></li><li><div>        if (empty($emails)) {&nbsp;</div></li><li><div>            $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $modelEmail-&gt;reset();&nbsp;</div></li><li><div>            $emails = $modelEmail-&gt;get(false, array('type' =&gt; 2, 'status' =&gt; array(1, 3, 99)));&nbsp;</div></li><li><div>            if (is_object($emails)) {&nbsp;</div></li><li><div>                $emailarr = null;&nbsp;</div></li><li><div>                foreach ($emails as $keyob =&gt; $valobj) {&nbsp;</div></li><li><div>                    $emailarr[$keyob] = $valobj;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $emails = $emailarr;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (is_array($emails) && isset($emails['body']))&nbsp;</div></li><li><div>                $emails = array($emails);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($emails as $key =&gt; $email) {&nbsp;</div></li><li><div>            if ($email['params']['autonl']['event'] != $process_type)&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            switch ($process_type) {&nbsp;</div></li><li><div>                case 'subs-2-nl':&nbsp;</div></li><li><div>                    // extra params in that case is an array of lists&nbsp;</div></li><li><div>                    foreach ($params_based_on_type as $details) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if (isset($email['params']['autonl']['subscribetolist']) && isset($details['list_id']) && $email['params']['autonl']['subscribetolist'] == $details['list_id']) {&nbsp;</div></li><li><div>                            $ok = true;&nbsp;</div></li><li><div>                            if (!$added_by_admin && $dbloptin && !in_array($details['list_id'], $userListss)) {&nbsp;</div></li><li><div>                                // make sure the list has sub_date&nbsp;</div></li><li><div>                                $ok = false;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ($ok)&nbsp;</div></li><li><div>                                $this-&gt;insertAutoQueue($user_id, $email['email_id'], $email['params']['autonl']);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'new-user':&nbsp;</div></li><li><div>                    // extra params in that case is a user object&nbsp;</div></li><li><div>                    $okInsert = false;&nbsp;</div></li><li><div>                    switch ($email['params']['autonl']['roles']) {&nbsp;</div></li><li><div>                        case 'any':&nbsp;</div></li><li><div>                            $okInsert = true;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                        default:&nbsp;</div></li><li><div>                            foreach ($params_based_on_type-&gt;roles as $rolename) {&nbsp;</div></li><li><div>                                if ($rolename == $email['params']['autonl']['roles'])&nbsp;</div></li><li><div>                                    $okInsert = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ($okInsert)&nbsp;</div></li><li><div>                        $this-&gt;insertAutoQueue($user_id, $email['email_id'], $email['params']['autonl']);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this is used when we want to send the email immediately after inserting it into the queue&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @param int $email_id&nbsp;</div></li><li><div>     * @param array $email_params_autonl&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function insertAutoQueue($user_id, $email_id, $email_params_autonl) {&nbsp;</div></li><li><div>        $model_queue = WYSIJA::get('queue', 'model');&nbsp;</div></li><li><div>        $queueData = array('priority' =&gt; '-1', 'email_id' =&gt; $email_id, 'user_id' =&gt; $user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $delay = $model_queue-&gt;calculate_delay($email_params_autonl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $queueData['send_at'] = time() + $delay;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the email is already queued for that autoresponder, we don't queue it&nbsp;</div></li><li><div>        if(!$model_queue-&gt;exists(array('email_id'=&gt;$email_id, 'user_id'=&gt;$user_id))) {&nbsp;</div></li><li><div>            // if the email has already been sent and is now in the stat table, we don't queue it either&nbsp;</div></li><li><div>            $modelEUS = WYSIJA::get('email_user_stat', 'model');&nbsp;</div></li><li><div>            if(!$modelEUS-&gt;exists(array('email_id'=&gt;$email_id, 'user_id'=&gt;$user_id))) {&nbsp;</div></li><li><div>                $model_queue-&gt;insert($queueData, true);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if delay is = to 0 then we need to try to send the email straight away&nbsp;</div></li><li><div>        if ($delay == 0) {&nbsp;</div></li><li><div>            $queueH = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>            $queueH-&gt;report = false;&nbsp;</div></li><li><div>            WYSIJA::log('insertAutoQueue queue process', array('email_id' =&gt; $email_id, 'user_id' =&gt; $user_id), 'queue_process');&nbsp;</div></li><li><div>            $queueH-&gt;process($email_id, $user_id);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * unsubscribe a user&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @param type $auto&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function unsubscribe($user_id, $auto = false) {&nbsp;</div></li><li><div>        return $this-&gt;subscribe($user_id, false, $auto);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Undo the action &quot;unsubscribe&quot; by a mistake&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @param type $auto&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function undounsubscribe($user_id, $auto = false) {&nbsp;</div></li><li><div>        return $this-&gt;subscribe($user_id, true, $auto);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * send confirmation email&nbsp;</div></li><li><div>     * @param type $user_ids&nbsp;</div></li><li><div>     * @param type $sendone&nbsp;</div></li><li><div>     * @param type $listids&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function sendConfirmationEmail($user_ids, $sendone = false, $listids = array()) {&nbsp;</div></li><li><div>        if ($this-&gt;no_confirmation_email === true)&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($sendone || is_object($user_ids)) {&nbsp;</div></li><li><div>            /** in this case user_ids is just one user object */&nbsp;</div></li><li><div>            $users = array($user_ids);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if (!is_array($user_ids)) {&nbsp;</div></li><li><div>                $user_ids = (array) $user_ids;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            /** get users objects */&nbsp;</div></li><li><div>            $modelU = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>            $modelU-&gt;getFormat = OBJECT_K;&nbsp;</div></li><li><div>            $users = $modelU-&gt;get(false, array('equal' =&gt; array('user_id' =&gt; $user_ids, 'status' =&gt; 0)));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $mailer = WYSIJA::get('mailer', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //check if there are lists&nbsp;</div></li><li><div>        if ($listids) {&nbsp;</div></li><li><div>            $mailer-&gt;listids = $listids;&nbsp;</div></li><li><div>            $mList = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $listnamesarray = $mList-&gt;get(array('name'), array('list_id' =&gt; $listids));&nbsp;</div></li><li><div>            $arrayNames = array();&nbsp;</div></li><li><div>            foreach ($listnamesarray as $detailname) {&nbsp;</div></li><li><div>                $arrayNames[] = $detailname['name'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $mailer-&gt;listnames = $arrayNames;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //load confirmation email, and if it doesn't exists create a new one&nbsp;</div></li><li><div>        $mEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $mEmail-&gt;getFormat = OBJECT;&nbsp;</div></li><li><div>        $emailConfirmationData = $mEmail-&gt;getOne(false, array('email_id' =&gt; $config-&gt;getValue('confirm_email_id')));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($emailConfirmationData)) {&nbsp;</div></li><li><div>            //somehow the confirmation email has been lost so we need to create a new one&nbsp;</div></li><li><div>            $dataEmailCon = array('from_name' =&gt; $config-&gt;getValue('from_name'), 'from_email' =&gt; $config-&gt;getValue('from_email'), &nbsp;</div></li><li><div>                'replyto_name' =&gt; $config-&gt;getValue('replyto_name'), 'replyto_email' =&gt; $config-&gt;getValue('replyto_email'), &nbsp;</div></li><li><div>                'subject' =&gt; $config-&gt;getValue('confirm_email_title'), 'body' =&gt; $config-&gt;getValue('confirm_email_body'), 'type' =&gt; '0', 'status' =&gt; '99');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $confemailid = $mEmail-&gt;insert($dataEmailCon);&nbsp;</div></li><li><div>            if ($confemailid)&nbsp;</div></li><li><div>                $config-&gt;save(array('confirm_email_id' =&gt; $confemailid));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $mEmail-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $mEmail-&gt;getFormat = OBJECT;&nbsp;</div></li><li><div>            $emailConfirmationData = $mEmail-&gt;getOne(false, array('email_id' =&gt; $config-&gt;getValue('confirm_email_id')));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result_send = false;&nbsp;</div></li><li><div>        foreach ($users as $userObj) {&nbsp;</div></li><li><div>            $result_send = $mailer-&gt;sendOne($emailConfirmationData, $userObj, true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$sendone) {&nbsp;</div></li><li><div>            if (count($users) &lt;= 0) {&nbsp;</div></li><li><div>                $this-&gt;notice(__('No email sent.', WYSIJA));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                                $this-&gt;notice( _n( 'One email has been sent.', '%d emails have been sent to unconfirmed subscribers.', count($users), WYSIJA ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            return $result_send;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all unconfirmed subscribers.&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     * @return Array $unconfirmed_ids Array with all the IDs of unconfirmed subscribers.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_unconfirmed_subscribers() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get all unconfirmed users ids.&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $query = 'SELECT user_id&nbsp;</div></li><li><div>                  FROM ' . '[wysija]' . $model_user-&gt;table_name . '&nbsp;</div></li><li><div>                  WHERE  status = 0';&nbsp;</div></li><li><div>        $result = $model_user-&gt;query('get_res', $query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Convert the array to a simple ids array.&nbsp;</div></li><li><div>        $unconfirmed_subscribers = array();&nbsp;</div></li><li><div>        foreach ($result as $unconfirmed_user) {&nbsp;</div></li><li><div>            $unconfirmed_subscribers[] = $unconfirmed_user['user_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $unconfirmed_subscribers;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bulk delete users&nbsp;</div></li><li><div>     * @param type $user_ids&nbsp;</div></li><li><div>     * @param type $sendone&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function delete($user_ids, $sendone = false, $is_batch_select = false) {&nbsp;</div></li><li><div>        $list_user_ids = null; // list of user ids to query, in a list or sub-query&nbsp;</div></li><li><div>        $user_model = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        if ($sendone) {&nbsp;</div></li><li><div>            // actually, this case is not implemeted yet&nbsp;</div></li><li><div>            // in this case user_ids is just one user object&nbsp;</div></li><li><div>            // $users=array($user_ids);&nbsp;</div></li><li><div>            exit('Not implemented! Please contact mailpoet.com');&nbsp;</div></li><li><div>        } elseif ($is_batch_select) {&nbsp;</div></li><li><div>            // in this case $users_ids = an associated array('query', 'from', 'select', ...etc)&nbsp;</div></li><li><div>            $list_user_ids = $user_ids['query'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if (!is_array($user_ids)) {&nbsp;</div></li><li><div>                $user_ids = (array) $user_ids;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $list_user_ids = implode(', ', $user_ids);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // table queue to delete&nbsp;</div></li><li><div>        $tables = array(&nbsp;</div></li><li><div>            'user_history', &nbsp;</div></li><li><div>            'email_user_url', &nbsp;</div></li><li><div>            'email_user_stat', &nbsp;</div></li><li><div>            'user_list', &nbsp;</div></li><li><div>            'queue', &nbsp;</div></li><li><div>            'user'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            foreach ($tables as $table_name) {&nbsp;</div></li><li><div>                $query = 'DELETE FROM [wysija]' . $table_name . ' WHERE user_id IN (' . $list_user_ids . ')';&nbsp;</div></li><li><div>                $user_model-&gt;query($query);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } catch (Exception $e) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * add many subsribers to one list&nbsp;</div></li><li><div>     * @param int $list_id&nbsp;</div></li><li><div>     * @param int $user_ids&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function addToList($list_id, $user_ids, $is_batch_select = false) {&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $sub_date = time();&nbsp;</div></li><li><div>        if (!$is_batch_select) {&nbsp;</div></li><li><div>            $total = count($user_ids);&nbsp;</div></li><li><div>            $list_user_ids = implode(', ', $user_ids);&nbsp;</div></li><li><div>            $query = 'REPLACE INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`) VALUES ';&nbsp;</div></li><li><div>            foreach ($user_ids as $key =&gt; $uid) {&nbsp;</div></li><li><div>                $query .= '(' . (int) $list_id . ', ' . (int) $uid . ', ' . $sub_date . &quot;)\n&quot;;&nbsp;</div></li><li><div>                if ($total &gt; ($key + 1))&nbsp;</div></li><li><div>                    $query.=', ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            $list_user_ids = $user_ids['query'];&nbsp;</div></li><li><div>            $query = 'REPLACE INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`)&nbsp;</div></li><li><div>                            SELECT ' . $list_id . ' AS `list_id`, `user_id` AS `user_id`, ' . $sub_date . ' AS `sub_date` ' . $user_ids['from'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $model_user-&gt;query($query);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * add one subscribers to some lists&nbsp;</div></li><li><div>     * @param array $list_ids&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @param int $subscribed_at&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function addToLists($list_ids, $user_id, $subscribed_at = 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($list_ids)) {&nbsp;</div></li><li><div>            // don't add subscriber to lists if no list ids specified&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelUser = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $extraFieldsName = $extraFieldsVal = '';&nbsp;</div></li><li><div>        if ($subscribed_at) {&nbsp;</div></li><li><div>            $extraFieldsName = ', `sub_date`';&nbsp;</div></li><li><div>            $extraFieldsVal = ', ' . $subscribed_at;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $query = 'INSERT IGNORE INTO `[wysija]user_list` (`list_id`, `user_id`' . $extraFieldsName . ')';&nbsp;</div></li><li><div>        $query.=' VALUES ';&nbsp;</div></li><li><div>        $total = count($list_ids);&nbsp;</div></li><li><div>        foreach ($list_ids as $key =&gt; $listid) {&nbsp;</div></li><li><div>            $query.='(' . (int) $listid . ', ' . (int) $user_id . $extraFieldsVal . &quot;)\n&quot;;&nbsp;</div></li><li><div>            if ($total &gt; ($key + 1))&nbsp;</div></li><li><div>                $query.=', ';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $modelUser-&gt;query($query);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Move bulk users to a list&nbsp;</div></li><li><div>     * @param int $listid&nbsp;</div></li><li><div>     * @param array $userids = array(int, int, int, ...) OR array('where'=&gt;'', 'from'=&gt;'', 'select'=&gt;'', 'query'=&gt;'', 'row_counts_query'=&gt;'')&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function moveToList($listid, $userids, $is_batch_select = false) {&nbsp;</div></li><li><div>        //1. Remove from all existing list&nbsp;</div></li><li><div>        $frozen_list = $this-&gt;_getHiddenLists();&nbsp;</div></li><li><div>        if (empty($frozen_list))&nbsp;</div></li><li><div>            $frozen_list_where = '';&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $frozen_list_where = ' AND `list_id` NOT IN (' . implode(', ', $frozen_list) . ')';&nbsp;</div></li><li><div>        if (!$is_batch_select)&nbsp;</div></li><li><div>            $userids_query = implode(', ', $userids);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $userids_query = $userids['query'];&nbsp;</div></li><li><div>        $query1 = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $userids_query . ')' . $frozen_list_where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //2. Add to the new list&nbsp;</div></li><li><div>        $sub_date = time();&nbsp;</div></li><li><div>        if (!$is_batch_select) {&nbsp;</div></li><li><div>            $records = array();&nbsp;</div></li><li><div>            foreach ($userids as $key =&gt; $uid) {&nbsp;</div></li><li><div>                $records[] = implode(', ', array($listid, $uid, $sub_date));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $values = '(' . implode('), (', $records) . ');';&nbsp;</div></li><li><div>            $query2 = 'INSERT INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`) VALUES ' . $values;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $query2 = 'INSERT INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`)&nbsp;</div></li><li><div>                            SELECT ' . $listid . ' AS `list_id`, `user_id` AS `user_id`, ' . $sub_date . ' AS `sub_date` ' . $userids['from'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //3. Execute&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $model_user-&gt;query($query1);&nbsp;</div></li><li><div>        $model_user-&gt;query($query2);&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Remove user(s) from list(s)&nbsp;</div></li><li><div>     * @param array $listids&nbsp;</div></li><li><div>     * @param array $userids&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function removeFromLists($listids = array(), $userids = array(), $is_batch_select = false) {&nbsp;</div></li><li><div>        if (empty($userids) || (empty($listids) && empty($userids)))&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        if ($is_batch_select)&nbsp;</div></li><li><div>            $list_userids = $userids['query'];&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $list_userids = implode(', ', $userids);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $frozen_list = $this-&gt;_getHiddenLists();&nbsp;</div></li><li><div>        if (empty($frozen_list)) {&nbsp;</div></li><li><div>            $frozen_list_where = '';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $frozen_list_where = ' AND `list_id` NOT IN (' . implode(', ', $frozen_list) . ')';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($listids)) {//remove from all lists&nbsp;</div></li><li><div>            $query = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $list_userids . ')';&nbsp;</div></li><li><div>        } else { // remove from specific lists&nbsp;</div></li><li><div>            $list_listids = implode(', ', $listids);&nbsp;</div></li><li><div>            $query = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $list_userids . ') AND `list_id` IN (' . $list_listids . ')';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $query .= $frozen_list_where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Execute&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        return $model_user-&gt;query($query);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk confirm user(s)&nbsp;</div></li><li><div>     * @param array $userids&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function confirmUsers($userids = array(), $is_batch_select = false) {&nbsp;</div></li><li><div>        if (empty($userids))&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        if ($is_batch_select) {&nbsp;</div></li><li><div>            $row_count = $userids['count'];&nbsp;</div></li><li><div>            $list_userids = $userids['query'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $list_userids = implode(', ', $userids);&nbsp;</div></li><li><div>            $row_count = !empty($_REQUEST['wysija']['user']['user_id']) ? count($_REQUEST['wysija']['user']['user_id']) : 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $query1 = 'UPDATE `[wysija]user` SET status = 1 WHERE `user_id` IN (' . $list_userids . ')';&nbsp;</div></li><li><div>        $query2 = 'UPDATE `[wysija]user_list` SET sub_date = ' . time() . ', unsub_date = 0  WHERE `user_id` IN (' . $list_userids . ')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Execute&nbsp;</div></li><li><div>        $model_user-&gt;query($query1);&nbsp;</div></li><li><div>        $model_user-&gt;query($query2);&nbsp;</div></li><li><div>        return $row_count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get hidden lists (typically Wordpress user list)&nbsp;</div></li><li><div>     * @return array(int, int)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _getHiddenLists() {&nbsp;</div></li><li><div>        $result = WYSIJA::get('user', 'model')-&gt;getResults('SELECT GROUP_CONCAT(`list_id`) as ids FROM `[wysija]list` WHERE `is_enabled` = 0');&nbsp;</div></li><li><div>        return $result[0]['ids'] ? explode(', ', $result[0]['ids']) : array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * send Admin notification about new subscriber or new unsubscribed user&nbsp;</div></li><li><div>     * @param type $email&nbsp;</div></li><li><div>     * @param type $subscribed&nbsp;</div></li><li><div>     * @param type $list_ids&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _notify($email, $subscribed = true, $list_ids = false) {&nbsp;</div></li><li><div>        // get the public list to which user is subscribed&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($list_ids) {&nbsp;</div></li><li><div>            $query = &quot;Select B.name from `[wysija]list` as B where B.list_id IN ('&quot; . implode(&quot;', '&quot;, $list_ids) . &quot;') and B.is_enabled&gt;0&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $query = 'Select B.name from `[wysija]user_list` as A join `[wysija]list` as B on A.list_id=B.list_id where A.user_id=' . $this-&gt;uid . ' and B.is_enabled&gt;0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $model_user-&gt;query('get_res', $query);&nbsp;</div></li><li><div>        $list_names = array();&nbsp;</div></li><li><div>        foreach ($result as $arra) {&nbsp;</div></li><li><div>            $list_names[] = $arra['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($subscribed) {&nbsp;</div></li><li><div>            $title = sprintf(__('New subscriber to %1$s', WYSIJA), implode(', ', $list_names));&nbsp;</div></li><li><div>            $body = sprintf(__(&quot;Howdy, \n\n The subscriber %1\$s has just subscribed to your list '%2\$s' \n\n Cheers, \n\n The MailPoet Plugin&quot;, WYSIJA), &quot;&lt;strong&gt;&quot; . $email . &quot;&lt;/strong&gt;&quot;, &quot;&lt;strong&gt;&quot; . implode(', ', $list_names) . &quot;&lt;/strong&gt;&quot;);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $title = sprintf(__('One less subscriber to %1$s', WYSIJA), implode(', ', $list_names));&nbsp;</div></li><li><div>            $body = sprintf(__(&quot;Howdy, \n\n The subscriber %1\$s has just unsubscribed to your list '%2\$s' \n\n Cheers, \n\n The MailPoet Plugin&quot;, WYSIJA), &quot;&lt;strong&gt;&quot; . $email . &quot;&lt;/strong&gt;&quot;, &quot;&lt;strong&gt;&quot; . implode(', ', $list_names) . &quot;&lt;/strong&gt;&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $mailer = WYSIJA::get('mailer', 'helper');&nbsp;</div></li><li><div>        $notifieds = $model_config-&gt;getValue('emails_notified');&nbsp;</div></li><li><div>        //$mailer-&gt;report=false;&nbsp;</div></li><li><div>        $notifieds = explode(', ', $notifieds);&nbsp;</div></li><li><div>        $mailer-&gt;testemail = true;&nbsp;</div></li><li><div>        $body = nl2br($body);&nbsp;</div></li><li><div>        foreach ($notifieds as $receiver) {&nbsp;</div></li><li><div>            $mailer-&gt;sendSimple(trim($receiver), $title, $body);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * refresh all related info of users&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function refreshUsers() {&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $model_user-&gt;reset();&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('confirm_dbleoptin')) {&nbsp;</div></li><li><div>            $model_user-&gt;setConditions(array('greater' =&gt; array('status' =&gt; 0)));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $model_user-&gt;setConditions(array('greater' =&gt; array('status' =&gt; -1)));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = $model_user-&gt;count();&nbsp;</div></li><li><div>        $model_config-&gt;save(array('total_subscribers' =&gt; $count));&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Regenerate domains based on users' emails&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_domains() {&nbsp;</div></li><li><div>        $query = &quot;UPDATE [wysija]user SET `domain` = SUBSTRING(`email`, LOCATE('@', `email`)+1) WHERE ISNULL(`domain`)&quot;;&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        return $model_user-&gt;query($query);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function used to update the synchronisation with a plugin list or WP's one table&nbsp;</div></li><li><div>     * @global object $wpdb&nbsp;</div></li><li><div>     * @param int $list_id&nbsp;</div></li><li><div>     * @param boolean $synch_all_wp_user_base means complete synch of the whole user base, it's used for multisite and the WordPress users list&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function synchList($list_id, $synch_all_wp_user_base = false) {&nbsp;</div></li><li><div>        $model = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $data = $model-&gt;getOne(false, array('list_id' =&gt; (int) $list_id, 'is_enabled' =&gt; '0'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (strpos($data['namekey'], '-listimported-') !== false) {&nbsp;</div></li><li><div>                // plugins list table synch&nbsp;</div></li><li><div>                $model-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // import synch list&nbsp;</div></li><li><div>                $listdata = explode('-listimported-', $data['namekey']);&nbsp;</div></li><li><div>                $dataMainList = $model-&gt;getOne(false, array('namekey' =&gt; $listdata[0], 'is_enabled' =&gt; '0'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $importHelper = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>                $connection_info = $importHelper-&gt;getPluginsInfo($listdata[0]);&nbsp;</div></li><li><div>                $lists_ids = array(&nbsp;</div></li><li><div>                    'wysija_list_main_id' =&gt; $dataMainList['list_id'], &nbsp;</div></li><li><div>                    'wysija_list_id' =&gt; $data['list_id'], &nbsp;</div></li><li><div>                    'plug_list_id' =&gt; $listdata[1]&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $importHelper-&gt;import($listdata[0], $connection_info, false, false, $lists_ids);&nbsp;</div></li><li><div>            } elseif ($data['namekey'] == 'users') {&nbsp;</div></li><li><div>                // wordpress user table synch&nbsp;</div></li><li><div>                //importwp&nbsp;</div></li><li><div>                $ismainsite = true;&nbsp;</div></li><li><div>                if (is_multisite()) {&nbsp;</div></li><li><div>                    global $wpdb;&nbsp;</div></li><li><div>                    if ($wpdb-&gt;prefix != $wpdb-&gt;base_prefix) {&nbsp;</div></li><li><div>                        $ismainsite = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $connection_info = array('name' =&gt; 'WordPress', &nbsp;</div></li><li><div>                    'pk' =&gt; 'ID', &nbsp;</div></li><li><div>                    'matches' =&gt; array('ID' =&gt; 'wpuser_id', 'user_email' =&gt; 'email', 'first_name' =&gt; 'firstname', 'last_name' =&gt; 'lastname'), &nbsp;</div></li><li><div>                    'matchesvar' =&gt; array('status' =&gt; 1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $importHelper = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>                $lists_ids = array(&nbsp;</div></li><li><div>                    'wysija_list_main_id' =&gt; $data['list_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $importHelper-&gt;import($data['namekey'], $connection_info, false, $synch_all_wp_user_base, $lists_ids);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;cleanWordpressUsersList();&nbsp;</div></li><li><div>            } elseif (strpos($data['namekey'], 'query-') !== false) {&nbsp;</div></li><li><div>                // special query look for an action to run the refresh&nbsp;</div></li><li><div>                //TODO maybe we don't need to create a list that we sync but simply need a way to make a filter&nbsp;</div></li><li><div>                $queryUid = apply_filters('wysija_synch_' . str_replace('-', '_', $data['namekey']));&nbsp;</div></li><li><div>                $importHelper = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>                $queryUid = str_replace(array('[list_id]', '[created_at]'), array($data['list_id'], time()), $queryUid);&nbsp;</div></li><li><div>                $importHelper-&gt;insertUserList(0, 0, 0, $queryUid);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // plugins table synch&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>                $importables = $config-&gt;getValue('pluginsImportableEgg');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (in_array($data['namekey'], array_keys($importables))) {&nbsp;</div></li><li><div>                    $importHelper = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>                    $dataMainList = $model-&gt;getOne(false, array('namekey' =&gt; $data['namekey'], 'is_enabled' =&gt; '0'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $importHelper-&gt;import($data['namekey'], $importHelper-&gt;getPluginsInfo($data['namekey']), false, false, array('wysija_list_main_id' =&gt; $dataMainList['list_id']));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('List &quot;%1$s&quot; has been synchronised.', WYSIJA), $data['name']));&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;error(__('The list does not exists or cannot be synched.', WYSIJA), true);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function used to cleanup the lost wpuser_id&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function cleanWordpressUsersList() {&nbsp;</div></li><li><div>        // update the screwed up wpuser_id&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $query = 'UPDATE [wysija]user as A JOIN [wp]users as B on A.email=B.user_email SET A.wpuser_id = B.ID WHERE A.wpuser_id = 0';&nbsp;</div></li><li><div>        $model_list-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get all the wysija user with a wpuser_id &gt;0 and insert them into the WordPress user list&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $selectuserCreated = 'SELECT [wysija]user.user_id, ' . $model_config-&gt;getValue('importwp_list_id') . ', ' . time() . ' FROM [wysija]user WHERE wpuser_id &gt; 0';&nbsp;</div></li><li><div>        $query = 'INSERT IGNORE INTO `[wysija]user_list` (`user_id`, `list_id`, `sub_date`) ' . $selectuserCreated;&nbsp;</div></li><li><div>        $model_list-&gt;reset();&nbsp;</div></li><li><div>        $model_list-&gt;query($query);&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get an IP for the current visitor/user&nbsp;</div></li><li><div>     * @return string IP address&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function getIP() {&nbsp;</div></li><li><div>        $ip = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // cloudFlare IP check&nbsp;</div></li><li><div>        if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) {&nbsp;</div></li><li><div>            $ip = strip_tags($_SERVER['HTTP_CF_CONNECTING_IP']);&nbsp;</div></li><li><div>        } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']) AND strlen($_SERVER['HTTP_X_FORWARDED_FOR']) &gt; 6) {&nbsp;</div></li><li><div>            $ip = strip_tags($_SERVER['HTTP_X_FORWARDED_FOR']);&nbsp;</div></li><li><div>        } elseif (!empty($_SERVER['HTTP_CLIENT_IP']) AND strlen($_SERVER['HTTP_CLIENT_IP']) &gt; 6) {&nbsp;</div></li><li><div>            $ip = strip_tags($_SERVER['HTTP_CLIENT_IP']);&nbsp;</div></li><li><div>        } elseif (!empty($_SERVER['REMOTE_ADDR']) AND strlen($_SERVER['REMOTE_ADDR']) &gt; 6) {&nbsp;</div></li><li><div>            $ip = strip_tags($_SERVER['REMOTE_ADDR']);&nbsp;</div></li><li><div>        }//endif&nbsp;</div></li><li><div>        if (empty($ip))&nbsp;</div></li><li><div>            $ip = '127.0.0.1';&nbsp;</div></li><li><div>        return strip_tags($ip);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * verify that an email string is valid&nbsp;</div></li><li><div>     * @param string $email&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function validEmail($email) {&nbsp;</div></li><li><div>        //1 - check if the email parameter looks like an email&nbsp;</div></li><li><div>        if (empty($email) || !is_string($email) || strpos($email, '@') === false)&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //2 - pregmatch the email&nbsp;</div></li><li><div>        $check_domain = false;&nbsp;</div></li><li><div>        $preg_check = true;&nbsp;</div></li><li><div>        $string_special_chars = '\\\\\\';&nbsp;</div></li><li><div>        $email_pattern = '/^([a-z0-9_\'&\.\-\+' . $string_special_chars . '])+\@(([a-z0-9\-' . $string_special_chars . '])+\.)+([a-z0-9\-' . $string_special_chars . ']{2, 10})+$/i';&nbsp;</div></li><li><div>        //$string_special_chars = '';&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('email_cyrillic')) {&nbsp;</div></li><li><div>            // check domain&nbsp;</div></li><li><div>            $preg_check = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('check_domain')) {&nbsp;</div></li><li><div>            // check domain&nbsp;</div></li><li><div>            $check_domain = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($preg_check) {&nbsp;</div></li><li><div>            if (!preg_match($email_pattern, $email))&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($check_domain) {&nbsp;</div></li><li><div>            //3 - make sure the domain of the email exists&nbsp;</div></li><li><div>            $helper_toolbox = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!$helper_toolbox-&gt;check_email_domain($email))&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * make sure that the request wysija-key parameter correspond to a user in the db&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function checkUserKey($user_id = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // the !is numeric condition is here because if we input wysija-key=3 in the url&nbsp;</div></li><li><div>        // our model will search keyuser=3 which will return the result of the user with key user 3b61ac508456ab6ee7594c47cddb86a5&nbsp;</div></li><li><div>        if((!empty($_REQUEST['wysija-key']) && !is_numeric($_REQUEST['wysija-key'])) || $user_id !==false) {&nbsp;</div></li><li><div>            $modelUser=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($user_id === false) {&nbsp;</div></li><li><div>                $where_condition = array('keyuser' =&gt; $_REQUEST['wysija-key']);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $where_condition = array('user_id' =&gt; $user_id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $modelUser-&gt;getDetails($where_condition);&nbsp;</div></li><li><div>            if ($result) {&nbsp;</div></li><li><div>                return $result;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;error(__('Page is not accessible.', WYSIJA), true);&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;error(__('Page is not accessible.', WYSIJA), true);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get all of the lists a user has subscribed to&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @param array $list_ids&nbsp;</div></li><li><div>     * @return array results&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function getUserLists($user_id, $list_ids = array()) {&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $list_id_in = '';&nbsp;</div></li><li><div>        $clean_ids = array();&nbsp;</div></li><li><div>        foreach ($list_ids as $id) {&nbsp;</div></li><li><div>          $clean_ids[] = (int)$id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (!empty($clean_ids)) {&nbsp;</div></li><li><div>          $list_id_in = &quot;AND A.list_id IN(&quot; . implode(&quot;, &quot;, $clean_ids) . &quot;)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $query = 'SELECT A.* FROM [wysija]user_list as A LEFT JOIN [wysija]list as B on A.list_id=B.list_id WHERE A.user_id=' . (int)$user_id . ' AND B.is_enabled=1 ' . $list_id_in;&nbsp;</div></li><li><div>        return $model_user-&gt;getResults($query);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * if we confirm the user manually we pass it a user_id otherwise it works with a global key&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function confirm_user($user_id = false) {&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        // we need to call the translation otherwise it will not be loaded and translated&nbsp;</div></li><li><div>        $model_config-&gt;add_translated_default();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $list_ids = array();&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['wysiconf'] ) ) {&nbsp;</div></li><li><div>            $list_ids = json_decode( base64_decode( $_REQUEST['wysiconf'] ), true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty( $list_ids ) || !is_array( $list_ids )) {&nbsp;</div></li><li><div>            $this-&gt;title = __('Your confirmation link expired, please subscribe again.', WYSIJA);&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // START part linked to the view&nbsp;</div></li><li><div>        $this-&gt;title = $model_config-&gt;getValue( 'subscribed_title' );&nbsp;</div></li><li><div>        if ( !empty( $list_ids ) && is_array( $list_ids ) ) {&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $lists_names_res = $model_list-&gt;get(array('name'), array('list_id' =&gt; $list_ids));&nbsp;</div></li><li><div>            $names = array();&nbsp;</div></li><li><div>            foreach ($lists_names_res as $nameob) {&nbsp;</div></li><li><div>                $names[] = $nameob['name'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!isset($model_config-&gt;values['subscribed_title'])) {&nbsp;</div></li><li><div>                $this-&gt;title = __('You\'ve subscribed to: %1$s', WYSIJA);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;title = sprintf($this-&gt;title, implode(', ', $names));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;subtitle = $model_config-&gt;getValue('subscribed_subtitle');&nbsp;</div></li><li><div>        if ( !isset( $model_config-&gt;values['subscribed_subtitle'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;subtitle = __(&quot;Yup, we've added you to our list. You'll hear from us shortly.&quot;, WYSIJA);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // END part linked to the view&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_data = $this-&gt;checkUserKey( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $user_data ) {&nbsp;</div></li><li><div>            //user is not confirmed yet&nbsp;</div></li><li><div>            $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( (int) $user_data['details']['status'] &lt; 1) {&nbsp;</div></li><li><div>                // let's confirm the subscriber&nbsp;</div></li><li><div>                $this-&gt;subscribe( $user_data['details']['user_id'], true, false, $list_ids );&nbsp;</div></li><li><div>                $this-&gt;uid = $user_data['details']['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // send a notification to the email specified in the settings if required to&nbsp;</div></li><li><div>                if ( $model_config-&gt;getValue( 'emails_notified' ) && $model_config-&gt;getValue( 'emails_notified_when_sub' ) ) {&nbsp;</div></li><li><div>                    $this-&gt;_notify( $user_data['details']['email'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( isset( $_REQUEST['wysiconf'] ) ) {&nbsp;</div></li><li><div>                    $needs_subscription = false;&nbsp;</div></li><li><div>                    foreach ( $user_data['lists'] as $list ) {&nbsp;</div></li><li><div>                        if ( in_array( $list['list_id'], $list_ids ) && (int) $list['sub_date'] &lt; 1) {&nbsp;</div></li><li><div>                            $needs_subscription = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $needs_subscription ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;subscribe( $user_data['details']['user_id'] , true, false, $list_ids );&nbsp;</div></li><li><div>                        $this-&gt;title = sprintf( $model_config-&gt;getValue('subscribed_title') , implode( ', ', $names ) );&nbsp;</div></li><li><div>                        $this-&gt;subtitle = $model_config-&gt;getValue( 'subscribed_subtitle' );&nbsp;</div></li><li><div>                        // send a notification to the email specified in the settings if required to&nbsp;</div></li><li><div>                        if ( $model_config-&gt;getValue( 'emails_notified' ) && $model_config-&gt;getValue( 'emails_notified_when_sub' ) ) {&nbsp;</div></li><li><div>                            $this-&gt;_notify( $user_data['details']['email'] , true , $list_ids );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $this-&gt;title = sprintf( __('You are already subscribed to : %1$s' , WYSIJA ) , implode( ', ', $names ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;title = __( 'You are already subscribed.' , WYSIJA );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wysija_help_user/" class="active">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wysija_help_user/" class="">2.7.4</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.3/classes/wysija_help_user/" class="">2.7.3</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.2/classes/wysija_help_user/" class="">2.7.2</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.1/classes/wysija_help_user/" class="">2.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WYSIJA_help_user</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>