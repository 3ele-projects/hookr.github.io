<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.5" data-slug="mailpoet-newsletters" data-type="class" data-id="41076"><head xmlns="http://www.w3.org/1999/xhtml"><title> wj_import | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WJ_Import, class, plugin, mailpoet-newsletters, 2.7.5" /><meta name="description" content="Class Import." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.8"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=840c4a86d97b65151379528b32e1fea6' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.8' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wj_import/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwj_import%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwj_import%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.5-class-wj_import","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wj_import" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.5." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/" class="H_VERSION"><span property="name">2.7.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wj_import</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="299"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/all/" title="All">All <span class="count badge">299</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="active" data-id="class" data-count="132"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" title="Classes">Classes <span class="count badge">132</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WJ_Import</strong></h1><p>Class Import.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/files/classes-wj-import/" class="file">/classes/WJ_Import.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="8" class="block" start="8"><li><div>class WJ_Import extends WYSIJA_object {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $_header_row = array();&nbsp;</div></li><li><div>    private $_csv_data = array();&nbsp;</div></li><li><div>    private $_match = array();&nbsp;</div></li><li><div>    private $_ignore_invalid_date = array(); // specific for date fields&nbsp;</div></li><li><div>    private $_custom_fields = array();&nbsp;</div></li><li><div>    private $_email_key = '';&nbsp;</div></li><li><div>    private $_data_to_insert = array();&nbsp;</div></li><li><div>    private $_number_list = 0;&nbsp;</div></li><li><div>    private $_data_numbers = array();&nbsp;</div></li><li><div>    private $_line_delimiter = &quot;\n&quot;;&nbsp;</div></li><li><div>    private $_duplicate_emails_count = array(); // detect the emails that are duplicates in the import file&nbsp;</div></li><li><div>    private $_csv_array = array(); // containing the csv into an array&nbsp;</div></li><li><div>    private $_ignored_row_count = 0; // the count of rows we ignore because there was no valid email present&nbsp;</div></li><li><div>    private $_lines_count = 0; // count the number of valid lines inserted in the DB&nbsp;</div></li><li><div>    private $_chunks_count = 0; // number of chunks we chopped from the csv&nbsp;</div></li><li><div>    private $_first_row_is_data = false; // means that there is no header on that csv file&nbsp;</div></li><li><div>    private $_emails_inserted_in_current_chunk = array(); // array of emails&nbsp;</div></li><li><div>    private $_csv_file_string = '';&nbsp;</div></li><li><div>    private $_data_result = array(); // used for importmatch refactor&nbsp;</div></li><li><div>    private $_regex_new_field = &quot;/^new_field\|([^\|]+)\|(.+)$/i&quot;;&nbsp;</div></li><li><div>        private $_field_separators_to_test = array( ', ', ';', &quot;\t&quot; );&nbsp;</div></li><li><div>    private    $_field_enclosers_to_test = array( '&quot;', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        if (!empty($_POST['wysija']['match']))&nbsp;</div></li><li><div>            $this-&gt;_match = $_POST['wysija']['match'];&nbsp;</div></li><li><div>        if (!empty($_POST['wysija']['ignore_invalid_date']))&nbsp;</div></li><li><div>            $this-&gt;_ignore_invalid_date = $_POST['wysija']['ignore_invalid_date'];&nbsp;</div></li><li><div>        if (!empty($_REQUEST['wysija']['user_list']['list']))&nbsp;</div></li><li><div>            $this-&gt;_number_list = count($_REQUEST['wysija']['user_list']['list']);&nbsp;</div></li><li><div>        if (!empty($_POST['firstrowisdata']))&nbsp;</div></li><li><div>            $this-&gt;_first_row_is_data = true;&nbsp;</div></li><li><div>        $this-&gt;_data_numbers = array('invalid' =&gt; array(), 'inserted' =&gt; 0, 'valid_email_processed' =&gt; 0, 'list_added' =&gt; 0, 'list_user_ids' =&gt; 0, 'list_list_ids' =&gt; $this-&gt;_number_list, 'emails_queued' =&gt; 0);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * loading file data passed in a global variable&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_temp_file_info() {&nbsp;</div></li><li><div>        if (!empty($_REQUEST['wysija']['dataImport'])) {&nbsp;</div></li><li><div>                    return (array) json_decode(base64_decode($_REQUEST['wysija']['dataImport']), true);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * loading the file based on global parameters&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _loading_file_content() {&nbsp;</div></li><li><div>        // try to access the temporary file created in the previous step&nbsp;</div></li><li><div>        $this-&gt;_csv_data = $this-&gt;_get_temp_file_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( empty($this-&gt;_csv_data['csv']) || !is_string( $this-&gt;_csv_data['csv'] ) || preg_match('|[^a-z0-9#_.-]|i', $this-&gt;_csv_data['csv']) !== 0 ) {&nbsp;</div></li><li><div>                    $this-&gt;error('Error with import file name');&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (!is_string($this-&gt;_csv_data['csv']) OR preg_match('|[^a-z0-9#_.-]|i', $this-&gt;_csv_data['csv']) !== 0 ) {&nbsp;</div></li><li><div>                    die('Import file error.');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>        $result_file = $helper_file-&gt;get($this-&gt;_csv_data['csv'], 'import');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$result_file) {&nbsp;</div></li><li><div>            $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>            $this-&gt;error(sprintf(__('Cannot access CSV file. Verify access rights to this directory &quot;%1$s&quot;', WYSIJA), $upload_dir['basedir']), true);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the temp csv file&nbsp;</div></li><li><div>        $this-&gt;_csv_file_string = file_get_contents($result_file);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _set_custom_fields() {&nbsp;</div></li><li><div>        $WJ_Field = new WJ_Field();&nbsp;</div></li><li><div>        $_custom_fields = $WJ_Field-&gt;get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_custom_fields)) {&nbsp;</div></li><li><div>           foreach($_custom_fields as $key =&gt; &$row) {&nbsp;</div></li><li><div>                $this-&gt;_custom_fields['cf_'.$row-&gt;id] = $row;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate if a column is already matched previously&nbsp;</div></li><li><div>     * @param string $column_name&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _is_column_matched($column_name) {&nbsp;</div></li><li><div>    if (empty($this-&gt;_data_to_insert)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $column_names = array_values($this-&gt;_data_to_insert);&nbsp;</div></li><li><div>    return in_array(trim($column_name), $column_names);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * match columns together with the csv data based on the data passed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _match_columns_to_insert() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we're going through all of the selected value in each dropdown when importing&nbsp;</div></li><li><div>        foreach($this-&gt;_match as $csv_column_number =&gt; $column_in_user_table) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if (!is_string($column_in_user_table) OR preg_match('|[^a-z0-9#_\|.-]|i', $column_in_user_table) !== 0 ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Reduce matching twice the same column&nbsp;</div></li><li><div>            if ($this-&gt;_is_column_matched($column_in_user_table))&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ignore `nomatch` columns&nbsp;</div></li><li><div>            if ($column_in_user_table == 'nomatch')&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if maybe it's a new field&nbsp;</div></li><li><div>            preg_match($this-&gt;_regex_new_field, $column_in_user_table, $maybe_newfield);&nbsp;</div></li><li><div>            if ( !empty($maybe_newfield) && in_array($maybe_newfield[1], array('date', 'input')) ) {&nbsp;</div></li><li><div>                // TODO need to change to WJ_Field I guess when Marco is done moving the files&nbsp;</div></li><li><div>                // saving a new custom field&nbsp;</div></li><li><div>                $custom_field = new WJ_Field();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $custom_field-&gt;set(array(&nbsp;</div></li><li><div>                    'name' =&gt; $maybe_newfield[2], &nbsp;</div></li><li><div>                    'type' =&gt; $maybe_newfield[1], &nbsp;</div></li><li><div>                    'required' =&gt; false, &nbsp;</div></li><li><div>                    'settings' =&gt; array(&nbsp;</div></li><li><div>                        'label' =&gt; $maybe_newfield[2], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $custom_field-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // this is the column name in the database so this is where we need to import that field&nbsp;</div></li><li><div>                $column_in_user_table = $custom_field-&gt;user_column_name();&nbsp;</div></li><li><div>                $this-&gt;_match[$csv_column_number] = $column_in_user_table;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // keep the match of CSV column number to column key in our database&nbsp;</div></li><li><div>            // not sure why do we trim the column key ...&nbsp;</div></li><li><div>            $this-&gt;_data_to_insert[$csv_column_number] = trim($column_in_user_table);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // this column is the email column, let's keep track of it for later validation etc..&nbsp;</div></li><li><div>            if($column_in_user_table == 'email') {&nbsp;</div></li><li><div>                $this-&gt;_email_key = $csv_column_number;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_set_custom_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the status column is not matched, we make sure that we have an entry for the status column so that we default it to some value on import&nbsp;</div></li><li><div>        if(!in_array('status', $this-&gt;_data_to_insert)) {&nbsp;</div></li><li><div>            $this-&gt;_data_to_insert['status'] = 'status';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * build the header of the  import query&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_import_query_header() {&nbsp;</div></li><li><div>        return 'INSERT INTO [wysija]user (`' . implode('` , `', $this-&gt;_data_to_insert) . '`, `created_at`) VALUES ';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param type $array_csv&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _check_duplicate_emails($array_csv) {&nbsp;</div></li><li><div>        // look for duplicate emails&nbsp;</div></li><li><div>        foreach ($array_csv as $keyline =&gt; $csv_line) {&nbsp;</div></li><li><div>            if (isset($csv_line[$this-&gt;_email_key])) {&nbsp;</div></li><li><div>                if (isset($this-&gt;_duplicate_emails_count[$csv_line[$this-&gt;_email_key]])) {&nbsp;</div></li><li><div>                    $this-&gt;_duplicate_emails_count[$csv_line[$this-&gt;_email_key]]++;&nbsp;</div></li><li><div>                    //$arra[$keyline]&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;_duplicate_emails_count[$csv_line[$this-&gt;_email_key]] = 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                //if the record doesn't have the attribute email then we just ignore it&nbsp;</div></li><li><div>                $this-&gt;_ignored_row_count++;&nbsp;</div></li><li><div>                unset($array_csv[$keyline]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * save new column/field match to improve usability the next time our admin&nbsp;</div></li><li><div>     * import a field with similar headers/columns names&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _smart_column_match_recording() {&nbsp;</div></li><li><div>        if ($this-&gt;_first_row_is_data === false) {&nbsp;</div></li><li><div>            //save the importing fields to be able to match them the next time&nbsp;</div></li><li><div>            $import_fields = get_option('wysija_import_fields');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach($this-&gt;_match as $csv_column_number =&gt; $column_in_user_table) {&nbsp;</div></li><li><div>                if($column_in_user_table != 'nomatch') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // make a column name key&nbsp;</div></li><li><div>                    $column_name_key = str_replace(array(' ', '-', '_'), '', strtolower($this-&gt;_header_row[$csv_column_number]));&nbsp;</div></li><li><div>                    // fill in the array of &quot;csv column name&quot; / &quot;user table column&quot; matches&nbsp;</div></li><li><div>                    $import_fields[$column_name_key] = $column_in_user_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_import_fields' , $import_fields);&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * import a csv type into wysija's subscribers' table&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function import_subscribers() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // import the contacts&nbsp;</div></li><li><div>        // 1-check that a list is selected and that there is a csv file pasted&nbsp;</div></li><li><div>        // 2-save the list if necessary&nbsp;</div></li><li><div>        // 3-save the contacts and record them for each list selected&nbsp;</div></li><li><div>        $this-&gt;_loading_file_content();&nbsp;</div></li><li><div>        // convert the csv file to an array of lines&nbsp;</div></li><li><div>        $this-&gt;_csv_array = $this-&gt;_csv_to_array( $this-&gt;_csv_file_string , 0 , $this-&gt;_csv_data['fsep'] , $this-&gt;_csv_data['fenc']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check what columns of the csv have been matched together with our subscribers' table&nbsp;</div></li><li><div>        $this-&gt;_match_columns_to_insert();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_header_row = array_map('trim', $this-&gt;_csv_array[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we process the sql insertion 200 by 200 so that we are safe with the server's memory and cpu&nbsp;</div></li><li><div>        $csv_chunks = array_chunk($this-&gt;_csv_array, 200);&nbsp;</div></li><li><div>        $this-&gt;_csv_array = null;&nbsp;</div></li><li><div>        $this-&gt;_chunks_count = 0;&nbsp;</div></li><li><div>        $this-&gt;_lines_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setting up a timeout value on the sql side to avoid timeout when importing a lot of data apparently.&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $wpdb-&gt;query('set session wait_timeout=600');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // loop and insert the data chunks by chunks&nbsp;</div></li><li><div>        foreach ($csv_chunks as $key_chunk =&gt; $csv_chunk) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;_check_duplicate_emails($csv_chunk);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $this-&gt;_import_rows($csv_chunk);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($result !== false)&nbsp;</div></li><li><div>                $this-&gt;_chunks_count++;&nbsp;</div></li><li><div>            else {&nbsp;</div></li><li><div>                // there was an error we try 3 more times the same chunk and se how it goes&nbsp;</div></li><li><div>                $try = 0;&nbsp;</div></li><li><div>                while ($result === false && $try &lt; 3) {&nbsp;</div></li><li><div>                    $result = $this-&gt;_import_rows($csv_chunk);&nbsp;</div></li><li><div>                    if ($result !== false) {&nbsp;</div></li><li><div>                        $this-&gt;_chunks_count++;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $try++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($result === false) {&nbsp;</div></li><li><div>                    $this-&gt;error(__('There seems to be an error with the list you\'re trying to import.', WYSIJA), true);&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // increment the lines count&nbsp;</div></li><li><div>            $this-&gt;_lines_count += $result;&nbsp;</div></li><li><div>            // free up some memory&nbsp;</div></li><li><div>            unset($csv_chunks[$key_chunk]);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // useful the next time we import a file with the same format&nbsp;</div></li><li><div>        $this-&gt;_smart_column_match_recording();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // refresh the total count of users in wysija&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // keep only the real duplicate emails unset the unique ones&nbsp;</div></li><li><div>        // TODO check that this email duplicate function could be a memory sink hole&nbsp;</div></li><li><div>        // especially that right now we don't use its value&nbsp;</div></li><li><div>        foreach ($this-&gt;_duplicate_emails_count as $email_address =&gt; $times_email_in_csv) {&nbsp;</div></li><li><div>            if ($times_email_in_csv == 1)&nbsp;</div></li><li><div>                unset($this-&gt;_duplicate_emails_count[$email_address]);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // how come we need to do that sometimes? how a lines count could become negative?&nbsp;</div></li><li><div>        if ($this-&gt;_lines_count &lt; 0)&nbsp;</div></li><li><div>            $this-&gt;_lines_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // all of these numbers were useful at some point when we were showing more information after an import&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['ignored'] = ($this-&gt;_data_numbers['valid_email_processed'] - $this-&gt;_data_numbers['inserted']);&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['ignored_list'] = ( ($this-&gt;_data_numbers['list_user_ids'] * $this-&gt;_data_numbers['list_list_ids']) - $this-&gt;_data_numbers['list_added'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;_data_numbers;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_duplicate_emails_count() {&nbsp;</div></li><li><div>        return $this-&gt;_duplicate_emails_count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * convert a csv string to an array&nbsp;</div></li><li><div>     * @param type $csv_file_content&nbsp;</div></li><li><div>     * @param type $rows_to_read&nbsp;</div></li><li><div>     * @param type $delimiter&nbsp;</div></li><li><div>     * @param type $enclosure&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _csv_to_array($csv_file_content, $rows_to_read = 0, $delimiter = ', ', $enclosure = '') {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if( !(in_array($delimiter, $this-&gt;_field_separators_to_test) && in_array($enclosure, $this-&gt;_field_enclosers_to_test)) ) {&nbsp;</div></li><li><div>                    $this-&gt;error('Unknown csv separators.');&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // the new way for splitting a string into an array of lines&nbsp;</div></li><li><div>        $csv_data_array = explode( $this-&gt;_line_delimiter, $csv_file_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $i=1;&nbsp;</div></li><li><div>        foreach($csv_data_array as $csv_line) {&nbsp;</div></li><li><div>            if($rows_to_read!=0 && $i&gt; $rows_to_read) return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // str_getcsv only exists in php5 and is a faster and cleaner function than our csv_explode&nbsp;</div></li><li><div>            if (!function_exists('str_getcsv') || strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {&nbsp;</div></li><li><div>                $data[] = $this-&gt;_lines_explode($csv_line, $delimiter, $enclosure);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $data[] = str_getcsv($csv_line, $delimiter, $enclosure);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $i++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *  explode lines to columns&nbsp;</div></li><li><div>     * @param type $csv_line&nbsp;</div></li><li><div>     * @param type $delimiter&nbsp;</div></li><li><div>     * @param type $enclose&nbsp;</div></li><li><div>     * @param type $preserve&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _lines_explode($csv_line, $delimiter, $enclose, $preserve = false) {&nbsp;</div></li><li><div>        $resArr = array();&nbsp;</div></li><li><div>        $n = 0;&nbsp;</div></li><li><div>        if (empty($enclose)) {&nbsp;</div></li><li><div>            $resArr = explode($delimiter, $csv_line);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $expEncArr = explode($enclose, $csv_line);&nbsp;</div></li><li><div>            foreach ($expEncArr as $EncItem) {&nbsp;</div></li><li><div>                if ($n++ % 2) {&nbsp;</div></li><li><div>                    array_push($resArr, array_pop($resArr) . ($preserve ? $enclose : '') . $EncItem . ( $preserve ? $enclose : ''));&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $expDelArr = explode($delimiter, $EncItem);&nbsp;</div></li><li><div>                    array_push($resArr, array_pop($resArr) . array_shift($expDelArr));&nbsp;</div></li><li><div>                    $resArr = array_merge($resArr, $expDelArr);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $resArr;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function processing a chunk of a csv array to import it in the DB&nbsp;</div></li><li><div>     * @global object $wpdb&nbsp;</div></li><li><div>     * @param array $csv_chunk&nbsp;</div></li><li><div>     * @return boolean|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _import_rows($csv_chunk) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_emails_inserted_in_current_chunk = array();&nbsp;</div></li><li><div>        $time = time();&nbsp;</div></li><li><div>        $lines = array();&nbsp;</div></li><li><div>        $lines_count = count($csv_chunk);&nbsp;</div></li><li><div>        $columns_count = count($this-&gt;_data_to_insert);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;_get_import_query_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure that each line has the right numbers of columns if it doesn't then we can skip it&nbsp;</div></li><li><div>        foreach ($csv_chunk as $k =&gt; $line) {&nbsp;</div></li><li><div>            if (!(count($line) &gt;= (count($this-&gt;_data_to_insert) - 1))) {&nbsp;</div></li><li><div>                unset($csv_chunk[$k]);&nbsp;</div></li><li><div>                $lines_count--;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $valid_email_processed = 0;&nbsp;</div></li><li><div>        $j = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($csv_chunk as $key_line =&gt; $line) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if first row is not data but header then we just skip it only on the first chunk&nbsp;</div></li><li><div>            if ($this-&gt;_first_row_is_data === false && $j == 1 && $this-&gt;_chunks_count == 0) {&nbsp;</div></li><li><div>                $j++;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $i = 1;&nbsp;</div></li><li><div>            $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // TODO maybe we should check the value of the status column so that if we export a wysija's subscribers' list&nbsp;</div></li><li><div>            // and import it again in another site then we keep the status&nbsp;</div></li><li><div>            if (isset($this-&gt;_data_to_insert['status']))&nbsp;</div></li><li><div>                $line['status'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($line as $key_column =&gt; &$value_column) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // make sure this column is a column we want to insert in our DB&nbsp;</div></li><li><div>                if (isset($this-&gt;_data_to_insert[$key_column])) {&nbsp;</div></li><li><div>                    $column_name = $this-&gt;_data_to_insert[$key_column];&nbsp;</div></li><li><div>                    $original_value_column = $value_column;&nbsp;</div></li><li><div>                    $value_column = $this-&gt;_validate_value($column_name, $value_column);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // if it is a a date column, we convert it as a unixtimestamp&nbsp;</div></li><li><div>                    if(isset($this-&gt;_custom_fields[$column_name]) && $this-&gt;_custom_fields[$column_name]-&gt;type == 'date') {&nbsp;</div></li><li><div>                        $value_column = strtotime($value_column);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // this kind of result invalidates the whole row&nbsp;</div></li><li><div>                    if ($value_column === false) {&nbsp;</div></li><li><div>                        // record the invalid row and continue with the loop&nbsp;</div></li><li><div>                        $this-&gt;_data_numbers['invalid'][] = $original_value_column;&nbsp;</div></li><li><div>                        unset($csv_chunk[$key_line]);&nbsp;</div></li><li><div>                        $lines_count--;&nbsp;</div></li><li><div>                        continue 2;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // only if this is the email row we record an entry in the recorded emails and the email processed count&nbsp;</div></li><li><div>                        if ($this-&gt;_email_key === $key_column) {&nbsp;</div></li><li><div>                            $this-&gt;_emails_inserted_in_current_chunk[] = $value_column;&nbsp;</div></li><li><div>                            $valid_email_processed++;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // prepare the query&nbsp;</div></li><li><div>                    $values[] = &quot;'&quot; . esc_sql($value_column, $wpdb-&gt;dbh) . &quot;'&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $values[] = $time;&nbsp;</div></li><li><div>            $lines[] .= &quot;(&quot; . implode(', ', $values) . &quot;)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query .= implode(', ', $lines);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // update values when the user already exists&nbsp;</div></li><li><div>        $query .= ' ON DUPLICATE KEY UPDATE '.implode(', ', array_map(array($this, 'process_data_to_insert'), $this-&gt;_data_to_insert));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // replace query to import the subscribers&nbsp;</div></li><li><div>        $model_wysija = new WYSIJA_model();&nbsp;</div></li><li><div>        $import_query = $model_wysija-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lines_count = $wpdb-&gt;rows_affected;&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['inserted'] += $wpdb-&gt;rows_affected;&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['valid_email_processed'] += $valid_email_processed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($import_query === false) {&nbsp;</div></li><li><div>            $this-&gt;error(__('Error when inserting emails.', WYSIJA), true);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $time_now = time();&nbsp;</div></li><li><div>        $result_query_import_list = $this-&gt;_import_new_users_into_lists($time_now);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_trigger_active_autoresponders($time_now);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($result_query_import_list === false) {&nbsp;</div></li><li><div>            $this-&gt;error(__('Error when inserting list.', WYSIJA), true);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($import_query == 0)&nbsp;</div></li><li><div>            return '0';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $lines_count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * used to validate or cast values before importing&nbsp;</div></li><li><div>     * TODO should we add a type for import of custom fields ?&nbsp;</div></li><li><div>     * Comment : Marco, feel free to modify entirely&nbsp;</div></li><li><div>     * @param type $column_name&nbsp;</div></li><li><div>     * @param type $value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _validate_value($column_name, $value) {&nbsp;</div></li><li><div>        $value = esc_attr(trim($value));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($column_name) {&nbsp;</div></li><li><div>            case 'email':&nbsp;</div></li><li><div>                return is_email($value);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'status':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (in_array(strtolower($value), array('subscribed', 'confirmed', 1, '1', 'true'))) {&nbsp;</div></li><li><div>                    return 1;&nbsp;</div></li><li><div>                } elseif (in_array(strtolower($value), array('unsubscribed', -1, '-1', 'false'))) {&nbsp;</div></li><li><div>                    return -1;&nbsp;</div></li><li><div>                } elseif (in_array(strtolower($value), array('unconfirmed', 0, '0'))) {&nbsp;</div></li><li><div>                    return 0;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    return 1;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                return $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * take care of active autoresponders retro-activity&nbsp;</div></li><li><div>     * @param type $time_now&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _trigger_active_autoresponders($time_now) {&nbsp;</div></li><li><div>        $helper_email = WYSIJA::get('email', 'helper');&nbsp;</div></li><li><div>        $model_wysija = new WYSIJA_model();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // list the active auto responders emails&nbsp;</div></li><li><div>        $active_autoresponders_per_list = $helper_email-&gt;get_active_follow_ups(array('email_id', 'params'), true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($active_autoresponders_per_list)) {&nbsp;</div></li><li><div>            foreach ($_REQUEST['wysija']['user_list']['list'] as $list_id) {&nbsp;</div></li><li><div>                // checking if this list has a list of follow ups&nbsp;</div></li><li><div>                if (isset($active_autoresponders_per_list[$list_id])) {&nbsp;</div></li><li><div>                    // for each follow up of that list we queu an email&nbsp;</div></li><li><div>                    foreach ($active_autoresponders_per_list[$list_id] as $key_queue =&gt; $follow_up) {&nbsp;</div></li><li><div>                        // insert query per active followup&nbsp;</div></li><li><div>                        $query_queue = 'INSERT IGNORE INTO [wysija]queue (`email_id` , `user_id`, `send_at`) ';&nbsp;</div></li><li><div>                        $query_queue .= ' SELECT ' . (int)$follow_up['email_id'] . ' , B.user_id , ' . ($time_now + $follow_up['delay']);&nbsp;</div></li><li><div>                        $query_queue .= ' FROM [wysija]user_list as B';&nbsp;</div></li><li><div>                        $query_queue .= ' WHERE B.list_id=' . (int) $list_id . ' AND sub_date=' . $time_now;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $model_wysija-&gt;query($query_queue);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;_data_numbers['emails_queued'] += $wpdb-&gt;rows_affected;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global type $wpdb&nbsp;</div></li><li><div>     * @param type $time_now&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _import_new_users_into_lists($time_now) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $wpdb-&gt;rows_affected = 0;&nbsp;</div></li><li><div>        $model_wysija = new WYSIJA_model();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_ids = $this-&gt;_get_imported_user_ids();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // insert query per list&nbsp;</div></li><li><div>        $query = 'INSERT IGNORE INTO [wysija]user_list (`list_id` , `user_id`, `sub_date`) VALUES ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($_REQUEST['wysija']['user_list']['list'] as $keyl =&gt; $list_id) {&nbsp;</div></li><li><div>            if (empty($list_id))&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            // for each list pre selected go through that process&nbsp;</div></li><li><div>            foreach ($user_ids as $key =&gt; $user_data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // inserting each user id to this list&nbsp;</div></li><li><div>                $query.='(' . (int)$list_id . ' , ' . (int)$user_data['user_id'] . ' , ' . (int)$time_now . ')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if this is not the last row we put a comma for the next row&nbsp;</div></li><li><div>                if (count($user_ids) &gt; ($key + 1)) {&nbsp;</div></li><li><div>                    $query.=' , ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if this is not the last row we put a comma for the next row&nbsp;</div></li><li><div>            if (count($_REQUEST['wysija']['user_list']['list']) &gt; ($keyl + 1)) {&nbsp;</div></li><li><div>                $query.=', ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result_query = $model_wysija-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['list_added']+=$wpdb-&gt;rows_affected;&nbsp;</div></li><li><div>        $this-&gt;_data_numbers['list_user_ids']+=count($user_ids);&nbsp;</div></li><li><div>        return $result_query;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get a list of user_ids freshly imported&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_imported_user_ids() {&nbsp;</div></li><li><div>        $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        // select query to get all of the ids of the emails that have just been inserted&nbsp;</div></li><li><div>        return $model_user-&gt;get(array('user_id'), array('email' =&gt; $this-&gt;_emails_inserted_in_current_chunk));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this save a default list of column matching to ease the import process, this is done only the first time when the&nbsp;</div></li><li><div>     * field is not populated yet&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _save_default_import_field_match() {&nbsp;</div></li><li><div>        $import_fields = get_option('wysija_import_fields');&nbsp;</div></li><li><div>        if (!$import_fields) {&nbsp;</div></li><li><div>            $import_fields = array(&nbsp;</div></li><li><div>                'fname' =&gt; 'firstname', &nbsp;</div></li><li><div>                'firstname' =&gt; 'firstname', &nbsp;</div></li><li><div>                'prenom' =&gt; 'firstname', &nbsp;</div></li><li><div>                'nom' =&gt; 'lastname', &nbsp;</div></li><li><div>                'name' =&gt; 'lastname', &nbsp;</div></li><li><div>                'lastname' =&gt; 'lastname', &nbsp;</div></li><li><div>                'lname' =&gt; 'lastname', &nbsp;</div></li><li><div>                'ipaddress' =&gt; 'ip', &nbsp;</div></li><li><div>                'ip' =&gt; 'ip', &nbsp;</div></li><li><div>                'addresseip' =&gt; 'ip', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_import_fields', $import_fields);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * put the whole file or posted string into one string and clean up the string that may cause trouble during import&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_csv_file_cleaned_up() {&nbsp;</div></li><li><div>        // is it a text import or a file import?&nbsp;</div></li><li><div>        if($_POST['wysija']['import']['type'] == 'copy') {&nbsp;</div></li><li><div>            if(!isset($_POST['wysija']['user_list']['csv'])) {&nbsp;</div></li><li><div>                // memory limit has been reached&nbsp;</div></li><li><div>                $this-&gt;error(__('The list you\'ve pasted is too big for the browser. &lt;strong&gt;Upload the file&lt;/strong&gt; instead.', WYSIJA), true);&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;_csv_file_string = trim(stripslashes($_POST['wysija']['user_list']['csv']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            // move_uploaded_file($_importfile, $destination);&nbsp;</div></li><li><div>            $this-&gt;_csv_file_string = trim(file_get_contents($_FILES['importfile']['tmp_name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_csv_file_string = str_replace(array(&quot;\r&quot;, &quot;\n\n&quot;, &quot;\n\t\t\n\t\n\t\n\t\n&quot;, &quot;\n\t\t\n\t\n\t\n&quot;, &quot;\xEF\xBB\xBF&quot;, &quot;\n\t\n&quot;, &quot;\n(+1)&quot;), array(&quot;\n&quot;, &quot;\n&quot;, &quot;\n ;&quot;, &quot;\n&quot;, '', ';', ''), $this-&gt;_csv_file_string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // this might be gmail recipients(copy-paste from a gmail account) rare paste ...&nbsp;</div></li><li><div>         if(!preg_match_all('/&lt;([a-z0-9_\'&\.\-\+])+\@(([a-z0-9\-])+\.)+([a-z0-9]{2, 10})+&gt;/i' , $this-&gt;_csv_file_string , $matches)) {&nbsp;</div></li><li><div>              //return false;&nbsp;</div></li><li><div>         }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (substr($this-&gt;_csv_file_string, -1) != &quot;, &quot;)&nbsp;</div></li><li><div>                $this-&gt;_csv_file_string = trim($this-&gt;_csv_file_string) . ', ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (count($matches[0]) == count($matches)) {&nbsp;</div></li><li><div>                //this is gmail simple paste&nbsp;</div></li><li><div>                $this-&gt;_csv_file_string = str_replace(array('&gt;, ', '&lt;'), array(&quot;\n&quot;, ', '), $this-&gt;_csv_file_string);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;_csv_file_string = trim($this-&gt;_csv_file_string);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * try to figure out the format of that CSV file, which separators and enclosure strings does it use&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _run_test_on_csv_file() {&nbsp;</div></li><li><div>        // try different set of enclosure and separator for the csv which can have different look depending on the data carried&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_csv_data['fsep'] = false;&nbsp;</div></li><li><div>        $this-&gt;_csv_data['fenc'] = '';&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($this-&gt;_field_enclosers_to_test as $enclosure) {&nbsp;</div></li><li><div>            foreach($this-&gt;_field_separators_to_test as $fsep) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // testing different combinations of separator and enclosers&nbsp;</div></li><li><div>                $this-&gt;_csv_array = $this-&gt;_csv_to_array( $this-&gt;_csv_file_string, 10, $fsep, $enclosure );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // make sure that our CSV has more than one row and that it has the same number of values in the first row and the second row&nbsp;</div></li><li><div>                if ( ( count( $this-&gt;_csv_array ) &gt; 1 && count( $this-&gt;_csv_array[0] ) == count( $this-&gt;_csv_array[1] ) ) ) {&nbsp;</div></li><li><div>                    if ( count( $this-&gt;_csv_array[0] ) &gt; 1 || $helper_user-&gt;validEmail( trim( $this-&gt;_csv_array[0][0] ) ) || $helper_user-&gt;validEmail( trim( $this-&gt;_csv_array[1][0] ) ) ) {&nbsp;</div></li><li><div>                        $this-&gt;_csv_data['fsep'] = $fsep;&nbsp;</div></li><li><div>                        $this-&gt;_csv_data['fenc'] = $enclosure;&nbsp;</div></li><li><div>                        break(2);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>         // if we didn't manage to find a separator in that file then it is not a csv file and we come out&nbsp;</div></li><li><div>        if(empty($this-&gt;_csv_data['fsep'])) {&nbsp;</div></li><li><div>            $this-&gt;notice( sprintf(&nbsp;</div></li><li><div>                &quot;%s &lt;a href='http://support.mailpoet.com/knowledgebase/importing-subscribers-with-a-csv-file/' target='_blank'&gt;%s&lt;/a&gt;&quot;, &nbsp;</div></li><li><div>                __(&quot;The data you are trying to import doesn't appear to be in the CSV format (Comma Separated Values).&quot;, WYSIJA), &nbsp;</div></li><li><div>                __(&quot;Read More&quot;, WYSIJA)&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            $this-&gt;notice(__('The first line of a CSV file should be the column headers : &quot;email&quot;, &quot;lastname&quot;, &quot;firstname&quot;.', WYSIJA));&nbsp;</div></li><li><div>            $this-&gt;notice(__('The second line of a CSV file should be a set of values : &quot;joeeg@example.com&quot;, &quot;Average&quot;, &quot;Joe&quot;.', WYSIJA));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(__('The two first lines of the file you\'ve uploaded are as follow:', WYSIJA));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $arraylines = explode(&quot;\n&quot;, $this-&gt;_csv_file_string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($arraylines[0]))&nbsp;</div></li><li><div>                $text = __('Line is empty', WYSIJA);&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                $text = $arraylines[0];&nbsp;</div></li><li><div>            $this-&gt;notice('&lt;strong&gt;' . esc_html($text) . '&lt;/strong&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($arraylines[1]))&nbsp;</div></li><li><div>                $text = __('Line is empty', WYSIJA);&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                $text = $arraylines[1];&nbsp;</div></li><li><div>            $this-&gt;notice('&lt;strong&gt;' . esc_html($text) . '&lt;/strong&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // test the size of the file&nbsp;</div></li><li><div>        $temp_csv_array = $this-&gt;_csv_to_array($this-&gt;_csv_file_string, 0, $this-&gt;_csv_data['fsep'], $this-&gt;_csv_data['fenc']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_data_result['totalrows'] = count($temp_csv_array);&nbsp;</div></li><li><div>        end($temp_csv_array);&nbsp;</div></li><li><div>        $this-&gt;_data_result['lastrow'] = current($temp_csv_array);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * save the CSV string into a file so that we can use it later in the next step of the process&nbsp;</div></li><li><div>     * @return boolean|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _save_csv_file() {&nbsp;</div></li><li><div>        // try to make a wysija dir to save the import file&nbsp;</div></li><li><div>        $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>        $result_dir = $helper_file-&gt;makeDir('import');&nbsp;</div></li><li><div>        if (!$result_dir) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file_name = 'import-' . time() . '.csv';&nbsp;</div></li><li><div>        $handle = fopen($result_dir . $file_name, 'w');&nbsp;</div></li><li><div>        fwrite($handle, $this-&gt;_csv_file_string);&nbsp;</div></li><li><div>        fclose($handle);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $file_name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * detect which column is an email one&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _test_csv_emails() {&nbsp;</div></li><li><div>        $found_email = 0;&nbsp;</div></li><li><div>        $this-&gt;_email_key = array();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        foreach ($this-&gt;_csv_array as $csv_row) {&nbsp;</div></li><li><div>            foreach ($csv_row as $key_column =&gt; $value_column) {&nbsp;</div></li><li><div>                if ($helper_user-&gt;validEmail(trim($value_column))) {&nbsp;</div></li><li><div>                    $found_email++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;_email_key[$key_column] = $this-&gt;_csv_array[0][$key_column];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_data_result['errormatch'] = false;&nbsp;</div></li><li><div>        $check_again = __('Check again what you\'re trying to import.', WYSIJA);&nbsp;</div></li><li><div>        if (($found_email &lt; 1)) {&nbsp;</div></li><li><div>            $this-&gt;error(__('We couldn\'t find any valid addresses in the first 10 rows.', WYSIJA).' '.$check_again, true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ((count($this-&gt;_csv_array) &lt; 2)) {&nbsp;</div></li><li><div>            $this-&gt;error(__('You\'re import file is not valid.', WYSIJA).' '.$check_again, true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function used to scan the CSV before trying to match each column with our own fields&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function scan_csv_file() {&nbsp;</div></li><li><div>        $this-&gt;_data_result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure the import match will be as easy as possible with default matches&nbsp;</div></li><li><div>        if( $this-&gt;_save_default_import_field_match() === false) return false;&nbsp;</div></li><li><div>        // get the csv into a string and check for messy email address etc&nbsp;</div></li><li><div>        if( $this-&gt;_get_csv_file_cleaned_up() === false) return false;&nbsp;</div></li><li><div>        // find out the format of that CSV file comma semi colon etc ..&nbsp;</div></li><li><div>        if( $this-&gt;_run_test_on_csv_file() === false) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // save the string into a file for later use&nbsp;</div></li><li><div>        $file_name = $this-&gt;_save_csv_file();&nbsp;</div></li><li><div>        if ($file_name === false)&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // look for the email column&nbsp;</div></li><li><div>        $this-&gt;_test_csv_emails();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // stock the data we will use in the next page&nbsp;</div></li><li><div>        $this-&gt;_data_result['csv'] = $this-&gt;_csv_array;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data_import = array(&nbsp;</div></li><li><div>            'csv' =&gt; $file_name, &nbsp;</div></li><li><div>            'fsep' =&gt; $this-&gt;_csv_data['fsep'], &nbsp;</div></li><li><div>            'fenc' =&gt; $this-&gt;_csv_data['fenc']);&nbsp;</div></li><li><div>        $this-&gt;_data_result['dataImport'] = base64_encode(json_encode($data_import));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_data_result['keyemail'] = $this-&gt;_email_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //test if the first row is data or not&nbsp;</div></li><li><div>        //test the email column&nbsp;</div></li><li><div>        foreach ($this-&gt;_data_result['keyemail'] as $k)&nbsp;</div></li><li><div>            $this-&gt;_email_key = $k;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // test whether the first row is a data row or is a descriptive header row&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if($helper_user-&gt;validEmail( $this-&gt;_email_key )) {&nbsp;</div></li><li><div>            $this-&gt;_data_result['firstrowisdata']=true;&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;_data_result['totalrows']--;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;_data_result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function process_data_to_insert($v) {&nbsp;</div></li><li><div>        return '`'.$v.'` = VALUES(`'.$v.'`)';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wj_import/" class="active">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wj_import/" class="">2.7.4</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.3/classes/wj_import/" class="">2.7.3</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.2/classes/wj_import/" class="">2.7.2</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.1/classes/wj_import/" class="">2.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WJ_Import</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>