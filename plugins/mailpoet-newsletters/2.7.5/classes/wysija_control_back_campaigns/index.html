<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.5" data-slug="mailpoet-newsletters" data-type="class" data-id="41096"><head xmlns="http://www.w3.org/1999/xhtml"><title> wysija_control_back_campaigns | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WYSIJA_control_back_campaigns, class, plugin, mailpoet-newsletters, 2.7.5" /><meta name="description" content="The MailPoet Newsletters WYSIJA control back campaigns class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.8"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=c633ed794fe7401ec41c1fd24f57036e' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.8' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wysija_control_back_campaigns/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_control_back_campaigns%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_control_back_campaigns%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.5-class-wysija_control_back_campaigns","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wysija_control_back_campaigns" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.5." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/" class="H_VERSION"><span property="name">2.7.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wysija_control_back_campaigns</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="299"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/all/" title="All">All <span class="count badge">299</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="active" data-id="class" data-count="132"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" title="Classes">Classes <span class="count badge">132</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WYSIJA_control_back_campaigns</strong></h1><p>The MailPoet Newsletters <strong>WYSIJA control back campaigns</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(2)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/files/controllers-ajax-campaigns/" class="file">/controllers/ajax/campaigns.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class WYSIJA_control_back_campaigns extends WYSIJA_control{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        if(!WYSIJA::current_user_can('wysija_newsletters'))  die('Action is forbidden.');&nbsp;</div></li><li><div>        parent::__construct();;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save_poll() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if( in_array($_REQUEST['how'], array('repository' , 'search_engine' , 'friend', 'url' )) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $data_conf = array( 'poll_origin' =&gt; $_REQUEST['how'] );&nbsp;</div></li><li><div>                    if( !empty( $_REQUEST['where'] ) ) {&nbsp;</div></li><li><div>                        $data_conf['poll_origin_url'] = esc_url($_REQUEST['where']);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>                    $model_config-&gt;save( $data_conf );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $res['result'] = true;&nbsp;</div></li><li><div>                    $res['msg'] = '&lt;span&gt;&lt;span class=&quot;checkmark&quot;&gt;---&lt;/span&gt;'. __('Thanks!', WYSIJA). '&lt;/span&gt;';&nbsp;</div></li><li><div>                    return $res;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $res['result'] = false;&nbsp;</div></li><li><div>                return $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function switch_theme() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                if(isset($_POST['wysijaData'])) {&nbsp;</div></li><li><div>            $rawData = $_POST['wysijaData'];&nbsp;</div></li><li><div>            // avoid using stripslashes as it's not reliable depending on the magic quotes settings&nbsp;</div></li><li><div>            $rawData = str_replace('\&quot;', '&quot;', $rawData);&nbsp;</div></li><li><div>            // decode JSON data&nbsp;</div></li><li><div>            $rawData = json_decode($rawData, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $theme = (isset($rawData['theme'])) ? $rawData['theme'] : 'default';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>            $res['templates'] = $helper_wj_engine-&gt;renderTheme($theme);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $campaignsHelper = WYSIJA::get('campaigns', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($res['templates']['divider_options'])) {&nbsp;</div></li><li><div>                // save divider&nbsp;</div></li><li><div>                $campaignsHelper-&gt;saveParameters($email_id, 'divider', $res['templates']['divider_options']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // save theme used&nbsp;</div></li><li><div>            $campaignsHelper-&gt;saveParameters($email_id, 'theme', $theme);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $res['templates']['theme'] = $theme;&nbsp;</div></li><li><div>            $res['styles'] = $helper_wj_engine-&gt;renderThemeStyles($theme);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $res['msg'] = __(&quot;The theme you selected could not be loaded.&quot;, WYSIJA);&nbsp;</div></li><li><div>            $res['result'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save_editor() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // decode json data and convert to array&nbsp;</div></li><li><div>        $rawData = '';&nbsp;</div></li><li><div>        if(isset($_POST['wysijaData'])) {&nbsp;</div></li><li><div>            $rawData = $_POST['wysijaData'];&nbsp;</div></li><li><div>            // avoid using stripslashes as it's not reliable depending on the magic quotes settings&nbsp;</div></li><li><div>            $rawData = str_replace('\&quot;', '&quot;', $rawData);&nbsp;</div></li><li><div>            // decode JSON data&nbsp;</div></li><li><div>            $rawData = json_decode($rawData, true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$rawData) {&nbsp;</div></li><li><div>            $this-&gt;error('Error saving', false);&nbsp;</div></li><li><div>            return array('result' =&gt; false);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        $helper_wj_engine-&gt;setData( $rawData );&nbsp;</div></li><li><div>        $result = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get email id&nbsp;</div></li><li><div>        $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $emailData = $model_email-&gt;getOne(array('wj_styles', 'subject', 'params', 'email_id', 'campaign_id'), array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_wj_engine-&gt;setStyles($emailData['wj_styles'], true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $values = array('wj_data' =&gt; $helper_wj_engine-&gt;getEncoded('data'));&nbsp;</div></li><li><div>        $values['body'] = $helper_wj_engine-&gt;renderEmail($emailData);&nbsp;</div></li><li><div>        $values['email_id'] = $email_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $updated_email = $helper_wj_engine-&gt;getEmailData();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update modified_at timestamp&nbsp;</div></li><li><div>        $model_email-&gt;columns['modified_at']['autoup']=1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update data in DB&nbsp;</div></li><li><div>        $result = $model_email-&gt;update($values, array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$result) {&nbsp;</div></li><li><div>            // throw error&nbsp;</div></li><li><div>            $this-&gt;error(__('Your email could not be saved', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // save successful&nbsp;</div></li><li><div>            $this-&gt;notice(__('Your email has been saved', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('result' =&gt; $result);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save_styles() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // decode json data and convert to array&nbsp;</div></li><li><div>        $rawData = '';&nbsp;</div></li><li><div>        if(isset($_POST['wysijaStyles'])) {&nbsp;</div></li><li><div>            $rawData = $_POST['wysijaStyles'];&nbsp;</div></li><li><div>            // avoid using stripslashes as it's not reliable depending on the magic quotes settings&nbsp;</div></li><li><div>            $rawData = str_replace('\&quot;', '&quot;', $rawData);&nbsp;</div></li><li><div>            // decode JSON data&nbsp;</div></li><li><div>            $rawData = json_decode($rawData, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // handle checkboxes&nbsp;</div></li><li><div>        if(array_key_exists('a-underline', $rawData) === false) {&nbsp;</div></li><li><div>            $rawData['a-underline'] = -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        $helper_wj_engine-&gt;setStyles($helper_wj_engine-&gt;formatStyles($rawData));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $values = array(&nbsp;</div></li><li><div>            'wj_styles' =&gt; $helper_wj_engine-&gt;getEncoded('styles')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get email id&nbsp;</div></li><li><div>        $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update data in DB&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $result = $model_email-&gt;update($values, array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$result) {&nbsp;</div></li><li><div>            // throw error&nbsp;</div></li><li><div>            $this-&gt;error(__('Styles could not be saved', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // save successful&nbsp;</div></li><li><div>            $this-&gt;notice(__('Styles have been saved', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'styles' =&gt; $helper_wj_engine-&gt;renderStyles(), &nbsp;</div></li><li><div>            'result' =&gt; $result&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deleteimg() {&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if(isset($_REQUEST['imgid']) && $_REQUEST['imgid']&gt;0) {&nbsp;</div></li><li><div>            /** delete the image with id imgid */&nbsp;</div></li><li><div>             $result=wp_delete_attachment($_REQUEST['imgid'], true);&nbsp;</div></li><li><div>             if($result) {&nbsp;</div></li><li><div>                 $this-&gt;notice(__('Image has been deleted.', WYSIJA));&nbsp;</div></li><li><div>             }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res=array();&nbsp;</div></li><li><div>        $res['result'] = $result;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deleteTheme() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                if(isset($_REQUEST['themekey']) && $_REQUEST['themekey']) {&nbsp;</div></li><li><div>            /** delete the image with id imgid */&nbsp;</div></li><li><div>            $helperTheme=WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>            $result=$helperTheme-&gt;delete($_REQUEST['themekey']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res=array();&nbsp;</div></li><li><div>        $res['result'] = $result;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // set newsletter default theme&nbsp;</div></li><li><div>    function setDefaultTheme() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                if(isset($_REQUEST['theme']) && $_REQUEST['theme']) {&nbsp;</div></li><li><div>            // check that the theme exists&nbsp;</div></li><li><div>            // TODO&nbsp;</div></li><li><div>            $theme_exists = true;&nbsp;</div></li><li><div>            if($theme_exists === true) {&nbsp;</div></li><li><div>                // update config&nbsp;</div></li><li><div>                $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>                $model_config-&gt;save(array('newsletter_default_theme' =&gt; $_REQUEST['theme']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $result = true;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $result = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('result' =&gt; $result);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save_IQS() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // decode json data and convert to array&nbsp;</div></li><li><div>        $wysijaIMG = '';&nbsp;</div></li><li><div>        if(isset($_POST['wysijaIMG'])) {&nbsp;</div></li><li><div>            $wysijaIMG = json_decode(stripslashes($_POST['wysijaIMG']), TRUE);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $values = array(&nbsp;</div></li><li><div>            'params' =&gt; array('quickselection'=&gt;$wysijaIMG)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get email id&nbsp;</div></li><li><div>        $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>        $values['email_id']=$email_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update data in DB&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $result = $model_email-&gt;update($values, array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$result) {&nbsp;</div></li><li><div>            // throw error&nbsp;</div></li><li><div>            $this-&gt;error(__('Image selection has not been saved.', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // save successful&nbsp;</div></li><li><div>            $this-&gt;notice(__('Image selection has been saved.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('result' =&gt; $result);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function insert_articles() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // get raw params&nbsp;</div></li><li><div>        $raw_params = $_REQUEST['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // format params&nbsp;</div></li><li><div>        $params = array();&nbsp;</div></li><li><div>        foreach($raw_params as $value) {&nbsp;</div></li><li><div>            $params[$value['name']] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($params['show_divider'] === 'yes') {&nbsp;</div></li><li><div>            // get divider&nbsp;</div></li><li><div>            $divider = $_REQUEST['divider'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $divider = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $params['divider'] = $divider;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get post ids&nbsp;</div></li><li><div>        $post_ids = array();&nbsp;</div></li><li><div>        if(isset($_REQUEST['post_ids']) && strlen(trim($_REQUEST['post_ids'])) &gt; 0) {&nbsp;</div></li><li><div>            $post_ids = explode(', ', $_REQUEST['post_ids']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($post_ids)) {&nbsp;</div></li><li><div>            // return error&nbsp;</div></li><li><div>            $res['msg'] = __('Please select an article.', WYSIJA);&nbsp;</div></li><li><div>            $res['result'] = false;&nbsp;</div></li><li><div>            return $res;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // specify custom fields to get from posts&nbsp;</div></li><li><div>        $post_params = array('include' =&gt; $post_ids);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // include sort by parameter into post params&nbsp;</div></li><li><div>        $post_params['sort_by'] = $params['sort_by'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get posts&nbsp;</div></li><li><div>        $model_wp_posts = WYSIJA::get('wp_posts', 'model');&nbsp;</div></li><li><div>        $posts = $model_wp_posts-&gt;get_posts($post_params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if we need to interpret shortcodes&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $interpret_shortcode = (bool)$model_config-&gt;getValue('interp_shortcode');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get some model and helpers&nbsp;</div></li><li><div>        $helper_articles = WYSIJA::get('articles', 'helper');&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $output = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // save parameters for next time&nbsp;</div></li><li><div>        $model_config-&gt;save(array('insert_post_parameters' =&gt; $helper_wj_engine-&gt;encodeParameters($params)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($posts as $key =&gt; $post) {&nbsp;</div></li><li><div>            if($interpret_shortcode === true) {&nbsp;</div></li><li><div>                // interpret shortcodes&nbsp;</div></li><li><div>                $posts[$key]['post_content'] = apply_filters('the_content', $post['post_content']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // get thumbnail&nbsp;</div></li><li><div>            $posts[$key]['post_image'] = $helper_articles-&gt;getImage($post);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $output .= base64_encode($helper_wj_engine-&gt;renderPostsToBlocks($posts, $params));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(strlen($output) &gt; 0) {&nbsp;</div></li><li><div>            $res['result'] = true;&nbsp;</div></li><li><div>            $res['posts'] = $output;&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            $res['msg'] = __('There are no posts corresponding to that search.', WYSIJA);&nbsp;</div></li><li><div>            $res['result'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function send_preview($spamtest=false) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                $mailer=WYSIJA::get('mailer', 'helper');&nbsp;</div></li><li><div>        $email_id = $_REQUEST['id'];&nbsp;</div></li><li><div>        $resultarray=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update data in DB&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $model_email-&gt;getFormat=OBJECT;&nbsp;</div></li><li><div>        $email_object = $model_email-&gt;getOne(false, array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>        $mailer-&gt;testemail=true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['data'])) {&nbsp;</div></li><li><div>           $dataTemp=$_REQUEST['data'];&nbsp;</div></li><li><div>            $_REQUEST['data']=array();&nbsp;</div></li><li><div>            foreach($dataTemp as $val) $_REQUEST['data'][$val['name']]=$val['value'];&nbsp;</div></li><li><div>            unset($dataTemp);&nbsp;</div></li><li><div>            foreach($_REQUEST['data'] as $k =&gt;$v) {&nbsp;</div></li><li><div>                $newkey=str_replace(array('wysija[email][', ']'), '', $k);&nbsp;</div></li><li><div>                $configVal[$newkey]=$v;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if(isset($configVal['from_name'])) {&nbsp;</div></li><li><div>                $params=array(&nbsp;</div></li><li><div>                    'from_name'=&gt;$configVal['from_name'], &nbsp;</div></li><li><div>                    'from_email'=&gt;$configVal['from_email'], &nbsp;</div></li><li><div>                    'replyto_name'=&gt;$configVal['replyto_name'], &nbsp;</div></li><li><div>                    'replyto_email'=&gt;$configVal['replyto_email']);&nbsp;</div></li><li><div>                if(isset($configVal['subject']))    $email_object-&gt;subject=$configVal['subject'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $params=array(&nbsp;</div></li><li><div>                'from_name'=&gt;$email_object-&gt;from_name, &nbsp;</div></li><li><div>                'from_email'=&gt;$email_object-&gt;from_email, &nbsp;</div></li><li><div>                'replyto_name'=&gt;$email_object-&gt;replyto_name, &nbsp;</div></li><li><div>                'replyto_email'=&gt;$email_object-&gt;replyto_email&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(strpos($_REQUEST['receiver'], ', ')) {&nbsp;</div></li><li><div>            $receivers = explode(', ', $_REQUEST['receiver']);&nbsp;</div></li><li><div>        } else if(strpos($_REQUEST['receiver'], ';')) {&nbsp;</div></li><li><div>            $receivers = explode(';', $_REQUEST['receiver']);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $receivers = array($_REQUEST['receiver']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_model = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        foreach($receivers as $key =&gt; $receiver) {&nbsp;</div></li><li><div>            $receiver = trim($receiver);&nbsp;</div></li><li><div>            $dummy_receiver = $user_model-&gt;get_object_by_email($receiver);&nbsp;</div></li><li><div>            if(empty($dummy_receiver)) {&nbsp;</div></li><li><div>                $dummy_receiver = new stdClass();&nbsp;</div></li><li><div>                $dummy_receiver-&gt;user_id = 0;&nbsp;</div></li><li><div>                $dummy_receiver-&gt;email = $receiver;&nbsp;</div></li><li><div>                $dummy_receiver-&gt;status = 1;&nbsp;</div></li><li><div>                $dummy_receiver-&gt;lastname = $dummy_receiver-&gt;firstname = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($spamtest) {&nbsp;</div></li><li><div>                $langextra = '';&nbsp;</div></li><li><div>                $dummy_receiver-&gt;firstname ='Mail Tester';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $wp_lang = get_locale();&nbsp;</div></li><li><div>                if(!empty($wp_lang)) $langextra ='&lang='.$wp_lang;&nbsp;</div></li><li><div>                $resultarray['urlredirect']='http://www.mail-tester.com/check.php?id='.urlencode($dummy_receiver-&gt;email).$langextra;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $receivers[$key] = $dummy_receiver;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_clone=array();&nbsp;</div></li><li><div>        foreach($email_object as $kk=&gt;$vv)  $email_clone[$kk]=$vv;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        // set data & styles&nbsp;</div></li><li><div>        if(isset($email_clone['wj_data'])) { $wj_engine-&gt;setData($email_clone['wj_data'], true); } else { $wj_engine-&gt;setData(); }&nbsp;</div></li><li><div>        if(isset($email_clone['wj_styles'])) { $wj_engine-&gt;setStyles($email_clone['wj_styles'], true); } else { $wj_engine-&gt;setStyles(); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // generate email html body&nbsp;</div></li><li><div>        $body = $wj_engine-&gt;renderEmail($email_clone);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get back email data as it will be updated during the rendering (articles ids + articles count)&nbsp;</div></li><li><div>        $email_child = $wj_engine-&gt;getEmailData();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // [total] [number] and [post_title] are only valid for post notifications newsletter&nbsp;</div></li><li><div>        if((int)$email_child['type'] === 2 && isset($email_child['params']['autonl']['event']) &&&nbsp;</div></li><li><div>                $email_child['params']['autonl']['event'] === 'new-articles' && isset($email_child['params']['autonl']['articles'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item_count = 0;&nbsp;</div></li><li><div>            $total_count = 1;&nbsp;</div></li><li><div>            $first_subject = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($email_child['params']['autonl']['articles']['count'])) $item_count = (int)$email_child['params']['autonl']['articles']['count'];&nbsp;</div></li><li><div>            if(isset($email_child['params']['autonl']['articles']['first_subject'])) $first_subject = $email_child['params']['autonl']['articles']['first_subject'];&nbsp;</div></li><li><div>            if(isset($email_child['params']['autonl']['total_child'])) $total_count = (int)$email_child['params']['autonl']['total_child'] + 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $email_object-&gt;subject = str_replace(&nbsp;</div></li><li><div>                array('[total]', '[number]', '[post_title]'), &nbsp;</div></li><li><div>                array($item_count, $total_count, $first_subject), &nbsp;</div></li><li><div>                $email_child['subject']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $successmsg = __('Your email preview has been sent to %1$s', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // correction added for post notifications with the tag [newsletter:post_title] failing to send&nbsp;</div></li><li><div>        if(isset($email_object-&gt;params['autonl']) && isset($email_child['params']['autonl'])) {&nbsp;</div></li><li><div>            $email_object-&gt;params['autonl']=$email_child['params']['autonl'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($email_object-&gt;params)) {&nbsp;</div></li><li><div>            $params['params']=$email_object-&gt;params;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($configVal['params[googletrackingcode'])) {&nbsp;</div></li><li><div>                $paramsemail=array();&nbsp;</div></li><li><div>                if(!is_array($email_object-&gt;params)) $paramsemail=unserialize(base64_decode($email_object-&gt;params));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if(trim($configVal['params[googletrackingcode'])) {&nbsp;</div></li><li><div>                    $paramsemail['googletrackingcode']=$configVal['params[googletrackingcode'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    unset($paramsemail['googletrackingcode']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $params['params'] = base64_encode(serialize($paramsemail));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $params['email_id'] = $email_object-&gt;email_id;&nbsp;</div></li><li><div>        $receiversList = array();&nbsp;</div></li><li><div>        $res = false;&nbsp;</div></li><li><div>        foreach($receivers as $receiver) {&nbsp;</div></li><li><div>            if($mailer-&gt;sendSimple($receiver, stripslashes($email_object-&gt;subject), $email_object-&gt;body, $params)) {&nbsp;</div></li><li><div>                $res = true;&nbsp;</div></li><li><div>                $receiversList[] = $receiver-&gt;email;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            WYSIJA::log('preview_sent', $mailer, 'manual');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($res === true) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf($successmsg, implode(', ', $receiversList)));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $resultarray['result'] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $resultarray;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * send spam test function step 2 of the newsletter edition process&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function send_spamtest() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                return apply_filters('wysija_send_spam_test', '', $this);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function set_divider()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                $src = isset($_POST['wysijaData']['src']) ? $_POST['wysijaData']['src'] : NULL;&nbsp;</div></li><li><div>        $width = isset($_POST['wysijaData']['width']) ? (int)$_POST['wysijaData']['width'] : NULL;&nbsp;</div></li><li><div>        $height = isset($_POST['wysijaData']['height']) ? (int)$_POST['wysijaData']['height'] : NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($src === NULL OR $width === NULL OR $height === NULL) {&nbsp;</div></li><li><div>            // there is a least one missing parameter, fallback to default divider&nbsp;</div></li><li><div>            $dividersHelper = WYSIJA::get('dividers', 'helper');&nbsp;</div></li><li><div>            $divider = $dividersHelper-&gt;getDefault();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // use provided params&nbsp;</div></li><li><div>            $divider = array(&nbsp;</div></li><li><div>                'src' =&gt; $src, &nbsp;</div></li><li><div>                'width' =&gt; $width, &nbsp;</div></li><li><div>                'height' =&gt; $height&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update campaign parameters&nbsp;</div></li><li><div>        $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>        $campaignsHelper = WYSIJA::get('campaigns', 'helper');&nbsp;</div></li><li><div>        $campaignsHelper-&gt;saveParameters($email_id, 'divider', $divider);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set params&nbsp;</div></li><li><div>        $block = array_merge(array('no-block' =&gt; true, 'type' =&gt; 'divider'), $divider);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_wj_engine=WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        return base64_encode($helper_wj_engine-&gt;renderEditorBlock($block));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_social_bookmarks() {&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $size = 'medium';&nbsp;</div></li><li><div>        $iconset = '01';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_POST['wysijaData']) && !empty($_POST['wysijaData'])) {&nbsp;</div></li><li><div>            $data = $_POST['wysijaData'];&nbsp;</div></li><li><div>            $items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach($data as $key =&gt; $values) {&nbsp;</div></li><li><div>                if($values['name'] === 'bookmarks-size') {&nbsp;</div></li><li><div>                    // get size&nbsp;</div></li><li><div>                    $size = $values['value'];&nbsp;</div></li><li><div>                } else if($values['name'] === 'bookmarks-theme') {&nbsp;</div></li><li><div>                    // get theme name&nbsp;</div></li><li><div>                    $theme = $values['value'];&nbsp;</div></li><li><div>                } else if($values['name'] === 'bookmarks-iconset') {&nbsp;</div></li><li><div>                    // get iconset&nbsp;</div></li><li><div>                    $iconset = $values['value'];&nbsp;</div></li><li><div>                    if(strlen(trim($iconset)) === 0) {&nbsp;</div></li><li><div>                        $this-&gt;error('No iconset specified', false);&nbsp;</div></li><li><div>                        return false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $keys = explode('-', $values['name']);&nbsp;</div></li><li><div>                    $network = $keys[1];&nbsp;</div></li><li><div>                    $property = $keys[2];&nbsp;</div></li><li><div>                    if(array_key_exists($network, $items)) {&nbsp;</div></li><li><div>                        $items[$network][$property] = $values['value'];&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $items[$network] = array($property =&gt; $values['value']);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $urls = array();&nbsp;</div></li><li><div>        // check data and remove network with an empty url&nbsp;</div></li><li><div>        foreach($items as $network =&gt; $item) {&nbsp;</div></li><li><div>            if(strlen(trim($item['url'])) === 0) {&nbsp;</div></li><li><div>                // empty url&nbsp;</div></li><li><div>                unset($items[$network]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // url specified&nbsp;</div></li><li><div>                $urls[$network] = $item['url'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if there's at least one url left&nbsp;</div></li><li><div>        if(empty($urls)) {&nbsp;</div></li><li><div>            $this-&gt;error('No url specified', false);&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // save url in config&nbsp;</div></li><li><div>        $config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $config-&gt;save(array('social_bookmarks' =&gt; $urls));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get iconset icons&nbsp;</div></li><li><div>        $bookmarksHelper = WYSIJA::get('bookmarks', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the iconset is 00, then it's the theme's bookmarks&nbsp;</div></li><li><div>        if($iconset === '00') {&nbsp;</div></li><li><div>            $icons = $bookmarksHelper-&gt;getAllByTheme($theme);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // otherwise it's a basic iconset&nbsp;</div></li><li><div>            $icons = $bookmarksHelper-&gt;getAllByIconset($size, $iconset);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // format data&nbsp;</div></li><li><div>        $block = array(&nbsp;</div></li><li><div>            'position' =&gt; 1, &nbsp;</div></li><li><div>            'type' =&gt; 'gallery', &nbsp;</div></li><li><div>            'items' =&gt; array(), &nbsp;</div></li><li><div>            'alignment' =&gt; 'center'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $width = 0;&nbsp;</div></li><li><div>        foreach($items as $key =&gt; $item) {&nbsp;</div></li><li><div>            $block['items'][] = array_merge($item, $icons[$key], array('alt' =&gt; ucfirst($key)));&nbsp;</div></li><li><div>            $width += (int)$icons[$key]['width'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // add margin between icons&nbsp;</div></li><li><div>        $width += (count($block['items']) - 1) * 10;&nbsp;</div></li><li><div>        // set optimal width&nbsp;</div></li><li><div>        $block['width'] = max(0, min($width, 564));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_wj_engine=WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        return base64_encode($helper_wj_engine-&gt;renderEditorBlock($block));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function install_theme() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                if( isset($_REQUEST['theme_id'])) {&nbsp;</div></li><li><div>            global $wp_version;&nbsp;</div></li><li><div>            //check if theme is premium if you have the premium licence&nbsp;</div></li><li><div>            if(isset($_REQUEST['premium']) && $_REQUEST['premium']) {&nbsp;</div></li><li><div>                $getpremiumtheme=apply_filters('wysija_install_theme_premium', false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if(!$getpremiumtheme) {&nbsp;</div></li><li><div>                    $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>                    $themes = $helper_wj_engine-&gt;renderThemes();&nbsp;</div></li><li><div>                    return array('result'=&gt;false, 'themes' =&gt; $themes);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helperToolbox = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>            $domain_name = $helperToolbox-&gt;_make_domain_name(admin_url('admin.php'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $request = 'http://api.mailpoet.com/download/zip/'.$_REQUEST['theme_id'].'?domain='.$domain_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = array(&nbsp;</div></li><li><div>                    'timeout' =&gt;  30, &nbsp;</div></li><li><div>                    'body' =&gt; array( ), &nbsp;</div></li><li><div>         'user-agent' =&gt; 'WordPress/' . $wp_version . '; ' . get_bloginfo( 'url' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $raw_response = wp_remote_post( $request, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $raw_response ) || 200 != wp_remote_retrieve_response_code( $raw_response ) ) {&nbsp;</div></li><li><div>                if(method_exists($raw_response, 'get_error_messages')) {&nbsp;</div></li><li><div>                    $this-&gt;error($raw_response-&gt;get_error_messages());&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $ZipfileResult = false;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $ZipfileResult = maybe_unserialize( wp_remote_retrieve_body( $raw_response ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($ZipfileResult === false) {&nbsp;</div></li><li><div>                $result = false;&nbsp;</div></li><li><div>                $this-&gt;error(__('We were unable to contact the API, the site may be down. Please try again later.', WYSIJA), true);&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $themesHelp=WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>                $result = $themesHelp-&gt;installTheme($ZipfileResult);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // refresh themes list&nbsp;</div></li><li><div>                $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>                $themes = $helper_wj_engine-&gt;renderThemes();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $result = false;&nbsp;</div></li><li><div>            $themes = '';&nbsp;</div></li><li><div>            $this-&gt;notice('missing info');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('result' =&gt; $result, 'themes' =&gt; $themes);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        function get_social_bookmarks() {&nbsp;</div></li><li><div>        $size = isset($_POST['wysijaData']['size']) ? $_POST['wysijaData']['size'] : NULL;&nbsp;</div></li><li><div>        $theme = isset($_POST['wysijaData']['theme']) ? $_POST['wysijaData']['theme'] : NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $bookmarksHelper = WYSIJA::get('bookmarks', 'helper');&nbsp;</div></li><li><div>        $bookmarks = $bookmarksHelper-&gt;getAll($size, $theme);&nbsp;</div></li><li><div>        return json_encode(array('icons' =&gt; $bookmarks));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function refresh_themes() {&nbsp;</div></li><li><div>        // refresh themes list&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        return array('result'=&gt;true, 'themes' =&gt; $helper_wj_engine-&gt;renderThemes());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_auto_post() {&nbsp;</div></li><li><div>        // get params and generate html&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        $helper_articles = WYSIJA::get('articles', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get parameters&nbsp;</div></li><li><div>        $block_params = array();&nbsp;</div></li><li><div>        if(isset($_POST['wysijaData'])) {&nbsp;</div></li><li><div>            // store category ids (TBR)&nbsp;</div></li><li><div>            $category_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach($_POST['wysijaData'] as $pairs) {&nbsp;</div></li><li><div>                // special cases&nbsp;</div></li><li><div>                switch($pairs['name']) {&nbsp;</div></li><li><div>                    case 'author_label':&nbsp;</div></li><li><div>                    case 'category_label':&nbsp;</div></li><li><div>                    case 'readmore':&nbsp;</div></li><li><div>                    case 'nopost_message':&nbsp;</div></li><li><div>                        $block_params[] = array('key' =&gt; $pairs['name'], 'value' =&gt; base64_encode(stripslashes($pairs['value'])));&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'category_ids':&nbsp;</div></li><li><div>                        $category_ids = array_filter( array_map( 'absint', explode( ', ', $pairs['value'] ) ) );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $block_params[] = array('key' =&gt; $pairs['name'], 'value' =&gt; $pairs['value']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // make sure we have only unique ids in categories&nbsp;</div></li><li><div>            $block_params[] = array('key' =&gt; 'category_ids', 'value' =&gt; join(', ', array_unique($category_ids)));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($block_params)) {&nbsp;</div></li><li><div>            // an error occurred, do something!&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $data = array(&nbsp;</div></li><li><div>                'type' =&gt; 'auto-post', &nbsp;</div></li><li><div>                'params' =&gt; $block_params&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            return base64_encode($helper_wj_engine-&gt;renderEditorBlock($data));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function load_auto_post() {&nbsp;</div></li><li><div>        $params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_POST['wysijaData'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $pairs = explode('&', $_POST['wysijaData']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach($pairs as $pair) {&nbsp;</div></li><li><div>                list($key, $value) = explode('=', $pair);&nbsp;</div></li><li><div>                switch($key) {&nbsp;</div></li><li><div>                    case 'autopost_count':&nbsp;</div></li><li><div>                        $params[$key] = (int)$value;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'readmore':&nbsp;</div></li><li><div>                    case 'author_label':&nbsp;</div></li><li><div>                    case 'category_label':&nbsp;</div></li><li><div>                    case 'nopost_message':&nbsp;</div></li><li><div>                        $params[$key] = base64_decode($value);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'exclude':&nbsp;</div></li><li><div>                        $params[$key] = explode(', ', $value);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $params[$key] = $value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($params)) {&nbsp;</div></li><li><div>            // an error occurred, do something!&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // get email params&nbsp;</div></li><li><div>            $email_id = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>            $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $email = $model_email-&gt;getOne(array('params', 'sent_at', 'campaign_id'), array('email_id' =&gt; $email_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_articles = WYSIJA::get('articles', 'helper');&nbsp;</div></li><li><div>            $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // see if posts have already been sent&nbsp;</div></li><li><div>            if(!empty($email['params']['autonl']['articles']['ids'])) {&nbsp;</div></li><li><div>                if(!isset($params['exclude'])) { $params['exclude'] = array(); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $params['exclude'] = array_unique(array_merge($email['params']['autonl']['articles']['ids'], $params['exclude']));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //we set the post_date to filter articles only older than that one&nbsp;</div></li><li><div>            if(isset($email['params']['autonl']['firstSend'])) {&nbsp;</div></li><li><div>                $params['post_date'] = $email['params']['autonl']['firstSend'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if immediate let it know to the get post&nbsp;</div></li><li><div>            if(isset($email['params']['autonl']['articles']['immediatepostid'])) {&nbsp;</div></li><li><div>                $params['include'] = $email['params']['autonl']['articles']['immediatepostid'];&nbsp;</div></li><li><div>                $params['post_limit'] = 1;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                //we set the post_date to filter articles only older than the last time we sent articles&nbsp;</div></li><li><div>                if(isset($email['params']['autonl']['lastSend'])) {&nbsp;</div></li><li><div>                    $params['post_date'] = $email['params']['autonl']['lastSend'];&nbsp;</div></li><li><div>                }else{&nbsp;</div></li><li><div>                    //get the latest child newsletter sent_at value&nbsp;</div></li><li><div>                    $mEmail=WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>                    $mEmail-&gt;reset();&nbsp;</div></li><li><div>                    $mEmail-&gt;orderBy('email_id', 'DESC');&nbsp;</div></li><li><div>                    $lastEmailSent=$mEmail-&gt;getOne(false, array('campaign_id'=&gt;$email['campaign_id'], 'type'=&gt;'1'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if(!empty($lastEmailSent)) $params['post_date'] = $lastEmailSent['sent_at'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // get posts&nbsp;</div></li><li><div>            $model_wp_posts = WYSIJA::get('wp_posts', 'model');&nbsp;</div></li><li><div>            $posts = $model_wp_posts-&gt;get_posts($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($posts)) {&nbsp;</div></li><li><div>                // nothing to display&nbsp;</div></li><li><div>                $posts = array();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // used to keep track of post ids present in the auto post&nbsp;</div></li><li><div>                $post_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // cleanup post and get image&nbsp;</div></li><li><div>                foreach($posts as $key =&gt; $post) {&nbsp;</div></li><li><div>                    if($params['image_alignment'] !== 'none') {&nbsp;</div></li><li><div>                        // attempt to get post image&nbsp;</div></li><li><div>                        $posts[$key]['post_image'] = $helper_articles-&gt;getImage($post);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // store article id&nbsp;</div></li><li><div>                    $post_ids[] = $post['ID'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // store article ids&nbsp;</div></li><li><div>                $params['post_ids'] = join(', ', $post_ids);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // get divider if necessary (for immediate post notification, the &quot;show_divider&quot; parameter is not available)&nbsp;</div></li><li><div>            if(isset($params['show_divider']) && $params['show_divider'] === 'yes') {&nbsp;</div></li><li><div>                if(isset($email['params']['divider'])) {&nbsp;</div></li><li><div>                    $params['divider'] = $email['params']['divider'];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $helper_dividers = WYSIJA::get('dividers', 'helper');&nbsp;</div></li><li><div>                    $params['divider'] = $helper_dividers-&gt;getDefault();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return base64_encode($helper_wj_engine-&gt;renderEditorAutoPost($posts, $params));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        function search_terms( $request = null ) {&nbsp;</div></li><li><div>        $response = (object) array(&nbsp;</div></li><li><div>            'status' =&gt; false, &nbsp;</div></li><li><div>            'message' =&gt; __( 'Your request has failed', WYSIJA ), &nbsp;</div></li><li><div>            'results' =&gt; array(), &nbsp;</div></li><li><div>            'more' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ( ! defined( 'DOING_AJAX' ) && is_null( $request ) ) || ! is_user_logged_in() ) {&nbsp;</div></li><li><div>            return $response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request = (object) wp_parse_args(&nbsp;</div></li><li><div>            $request, &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'search' =&gt; isset( $_GET['search'] ) ? $_GET['search'] : '', &nbsp;</div></li><li><div>                'post_type' =&gt; isset( $_GET['post_type'] ) ? $_GET['post_type'] : null, &nbsp;</div></li><li><div>                'page' =&gt; absint( isset( $_GET['page'] ) ? $_GET['page'] : 0 ), &nbsp;</div></li><li><div>                'page_limit' =&gt; absint( isset( $_GET['page_limit'] ) ? $_GET['page_limit'] : 10 ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_null( $request-&gt;post_type ) ) {&nbsp;</div></li><li><div>            return $response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response-&gt;status = true;&nbsp;</div></li><li><div>        $response-&gt;message = __( 'Request successful', WYSIJA );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response-&gt;post_type = get_post_types( array( 'name' =&gt; $request-&gt;post_type ) );&nbsp;</div></li><li><div>        $response-&gt;post_type = reset( $response-&gt;post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        preg_match( '/@(\w+)/i', $request-&gt;search, $response-&gt;regex );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $response-&gt;regex ) ) {&nbsp;</div></li><li><div>            $request-&gt;search = array_filter( array_map( 'trim', explode( '|', str_replace( $response-&gt;regex[0], '|', $request-&gt;search ) ) ) );&nbsp;</div></li><li><div>            $request-&gt;search = reset( $request-&gt;search );&nbsp;</div></li><li><div>            $taxonomies = $response-&gt;regex[1];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $taxonomies = get_object_taxonomies( $response-&gt;post_type );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $response-&gt;taxonomies = get_object_taxonomies( $response-&gt;post_type, 'objects' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response-&gt;results = get_terms(&nbsp;</div></li><li><div>            (array) $taxonomies, &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'hide_empty' =&gt; false, &nbsp;</div></li><li><div>                'search' =&gt; $request-&gt;search, &nbsp;</div></li><li><div>                'number' =&gt; $request-&gt;page_limit, &nbsp;</div></li><li><div>                'offset' =&gt; $request-&gt;page_limit * ( $request-&gt;page - 1 ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $response-&gt;results ) || count( $response-&gt;results ) &lt; $request-&gt;page_limit ) {&nbsp;</div></li><li><div>            $response-&gt;more = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>     * returns a list of articles to the popup in the visual editor&nbsp;</div></li><li><div>     * @global type $wpdb&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_articles() {&nbsp;</div></li><li><div>        // fixes issue with pcre functions&nbsp;</div></li><li><div>        @ini_set('pcre.backtrack_limit', 1000000);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get parameters&nbsp;</div></li><li><div>        $raw_data = $_REQUEST['data'];&nbsp;</div></li><li><div>        $params = array();&nbsp;</div></li><li><div>        foreach ($raw_data as $value) {&nbsp;</div></li><li><div>            $params[$value['name']] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get options&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $interpret_shortcode = (bool)$model_config-&gt;getValue('interp_shortcode');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // post statuses&nbsp;</div></li><li><div>        $helper_wp_tools = WYSIJA::get('wp_tools', 'helper');&nbsp;</div></li><li><div>        $post_statuses = $helper_wp_tools-&gt;get_post_statuses();&nbsp;</div></li><li><div>        $post_types = $helper_wp_tools-&gt;get_post_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // filter by post_type&nbsp;</div></li><li><div>        if(isset($params['post_type'])) {&nbsp;</div></li><li><div>            $post_types_filter = array();&nbsp;</div></li><li><div>            if(strlen(trim($params['post_type'])) === 0) {&nbsp;</div></li><li><div>                $post_types_filter = array_keys($post_types);&nbsp;</div></li><li><div>                $post_types_filter[] = 'post';&nbsp;</div></li><li><div>                $post_types_filter[] = 'page';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $post_types_filter = trim($params['post_type']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // set condition on post type&nbsp;</div></li><li><div>            $params['post_type'] = $post_types_filter;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // query offset when doing incremental loading&nbsp;</div></li><li><div>        $query_offset = (isset($_REQUEST['query_offset']) && (int)$_REQUEST['query_offset'] &gt;= 0) ? (int)$_REQUEST['query_offset'] : 0;&nbsp;</div></li><li><div>        $params['query_offset'] = $query_offset;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // fetch posts&nbsp;</div></li><li><div>        $helper_articles = WYSIJA::get('articles', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set is_search_query (true) to get a count in addition to the results&nbsp;</div></li><li><div>        $params['is_search_query'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_wp_posts = WYSIJA::get('wp_posts', 'model');&nbsp;</div></li><li><div>        $data = $model_wp_posts-&gt;get_posts($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // extract data&nbsp;</div></li><li><div>        $posts = $data['rows'];&nbsp;</div></li><li><div>        // contains the total number of rows available&nbsp;</div></li><li><div>        $count = $data['count'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // return results&nbsp;</div></li><li><div>        $result = array(&nbsp;</div></li><li><div>            'result' =&gt; true, &nbsp;</div></li><li><div>            'append' =&gt; ($query_offset &gt; 0)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($posts) === false) {&nbsp;</div></li><li><div>            foreach($posts as $key =&gt; $post) {&nbsp;</div></li><li><div>                // interpret shortcodes&nbsp;</div></li><li><div>                if($interpret_shortcode === true) {&nbsp;</div></li><li><div>                    $posts[$key]['post_content'] = apply_filters('the_content', $posts[$key]['post_content']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // get thumbnail&nbsp;</div></li><li><div>                $posts[$key]['post_image'] = $helper_articles-&gt;getImage($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // set post status&nbsp;</div></li><li><div>                $post_status_label = '';&nbsp;</div></li><li><div>                if(isset($post_statuses[$posts[$key]['post_status']])) {&nbsp;</div></li><li><div>                    $post_status_label = $post_statuses[$posts[$key]['post_status']];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $posts[$key]['post_status'] = $post_status_label;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $result['posts'] = $posts;&nbsp;</div></li><li><div>            $result['total'] = (int)$count['total'];&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            $result['msg'] = __('There are no posts corresponding to that search.', WYSIJA);&nbsp;</div></li><li><div>            $result['result'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/files/controllers-back-campaigns/" class="file">/controllers/back/campaigns.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="6" class="block" start="6"><li><div>class WYSIJA_control_back_campaigns extends WYSIJA_control_back {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $model = 'campaign';&nbsp;</div></li><li><div>    var $view = 'campaigns';&nbsp;</div></li><li><div>    var $list_columns = array('campaign_id', 'name', 'description');&nbsp;</div></li><li><div>    var $searchable = array('name', 'subject');&nbsp;</div></li><li><div>    var $filters = array();&nbsp;</div></li><li><div>    var $base_url = 'admin.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      parent::__construct();&nbsp;</div></li><li><div>      $this-&gt;wpdb = $wpdb;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _wysija_subaction() {&nbsp;</div></li><li><div>        if (isset($_REQUEST['subaction'])) {&nbsp;</div></li><li><div>            if ($_REQUEST['subaction'] === 'delete') {&nbsp;</div></li><li><div>                                $this-&gt;_verify_nonce_subaction();&nbsp;</div></li><li><div>                                if (isset($_REQUEST['imgid']) && (int) $_REQUEST['imgid'] &gt; 0) {&nbsp;</div></li><li><div>                    // delete the image with id imgid&nbsp;</div></li><li><div>                    $res = wp_delete_attachment((int) $_REQUEST['imgid'], true);&nbsp;</div></li><li><div>                    if ($res) {&nbsp;</div></li><li><div>                        $this-&gt;notice(__('Image has been deleted.', WYSIJA));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        private function _verify_nonce_subaction() {&nbsp;</div></li><li><div>            if(!wp_verify_nonce($_REQUEST['_wpnonce'], $_REQUEST['page'].'-action_sub_delete_image') ) {&nbsp;</div></li><li><div>                    wp_die(&quot;&lt;h2&gt;&quot; . __('Security failure during request') . &quot;&lt;/h2&gt;&quot;, __(&quot;Security Problem&quot;), array(&nbsp;</div></li><li><div>                            'response' =&gt; 403, &nbsp;</div></li><li><div>                            'back_link' =&gt; false&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        private function _getLists($enabled = true, $count = false, $simple_query = false) {&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        //get lists which have users  and are enabled */&nbsp;</div></li><li><div>        if ($enabled) {&nbsp;</div></li><li><div>                    $sql_enabled_condition = ' is_enabled&gt;0 and';&nbsp;</div></li><li><div>                }else{&nbsp;</div></li><li><div>                    $sql_enabled_condition = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $extra_sql = '';&nbsp;</div></li><li><div>        if (!$simple_query) {&nbsp;</div></li><li><div>                    $extra_sql = 'WHERE  list_id in (SELECT distinct(list_id) from [wysija]user_list )';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = 'SELECT * FROM [wysija]list ' . $extra_sql;&nbsp;</div></li><li><div>        $listres = $model_list-&gt;query('get_res', $query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($count) {&nbsp;</div></li><li><div>            $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>            $condition = '&gt;=';&nbsp;</div></li><li><div>            if ($model_config-&gt;getValue('confirm_dbleoptin'))&nbsp;</div></li><li><div>                $condition = '&gt;';&nbsp;</div></li><li><div>            $qry1 = &quot;SELECT count(distinct A.user_id) as nbsub, A.list_id FROM `[wysija]user_list` as A LEFT JOIN `[wysija]user` as B on A.user_id=B.user_id WHERE B.status $condition 0 and A.unsub_date=0 GROUP BY list_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $total = $model_list-&gt;getResults($qry1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($total as $tot) {&nbsp;</div></li><li><div>                foreach ($listres as $key =&gt; $res) {&nbsp;</div></li><li><div>                    if ($tot['list_id'] == $res['list_id'])&nbsp;</div></li><li><div>                        $listres[$key]['count'] = $tot['nbsub'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ($listres as $key =&gt; $res) {&nbsp;</div></li><li><div>            if (!isset($res['count']))&nbsp;</div></li><li><div>                $listres[$key]['count'] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $listres;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Welcome page first time install&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function welcome_new() {&nbsp;</div></li><li><div>        $this-&gt;title = $this-&gt;viewObj-&gt;title = __('Welcome Page!', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['instalwjp'] = __('Installing MailPoet Newsletter Premium plugin', WYSIJA);&nbsp;</div></li><li><div>        $helper_readme = WYSIJA::get('readme', 'helper');&nbsp;</div></li><li><div>        $helper_readme-&gt;scan();&nbsp;</div></li><li><div>        $this-&gt;data = array();&nbsp;</div></li><li><div>        $this-&gt;data['abouttext'] = __('A Brand New MailPoet. Let the Fun Begin.', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $is_multisite = is_multisite();&nbsp;</div></li><li><div>        $is_network_admin = WYSIJA::current_user_can('manage_network');&nbsp;</div></li><li><div>        if ($is_multisite && $is_network_admin) {&nbsp;</div></li><li><div>            $model_config-&gt;save(array('ms_wysija_whats_new' =&gt; WYSIJA::get_version()));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $model_config-&gt;save(array('wysija_whats_new' =&gt; WYSIJA::get_version()));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //add a new language code with a new video&nbsp;</div></li><li><div>        $video_language=array();&nbsp;</div></li><li><div>        $video_language['en_EN'] = '&lt;iframe src=&quot;//player.vimeo.com/video/130224536&quot; width=&quot;500&quot; height=&quot;281&quot; frameborder=&quot;0&quot; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_lang = get_locale();&nbsp;</div></li><li><div>        if (!empty($wp_lang) && isset($video_language[$wp_lang])) {&nbsp;</div></li><li><div>            $welcome_video_link = $video_language[$wp_lang];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $welcome_video_link = $video_language['en_EN'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['sections'][] = array(&nbsp;</div></li><li><div>            'title' =&gt; __('Stay up to date! Subscribe to our newsletters', WYSIJA) . '&lt;span id=&quot;poll_result&quot;&gt;&lt;/span&gt;', &nbsp;</div></li><li><div>            'format' =&gt; 'normal', &nbsp;</div></li><li><div>            'paragraphs' =&gt; array('&lt;div class=&quot;mpoet-update-subscribe&quot; &gt;&lt;h4&gt;&lt;/h4&gt;&lt;div class=&quot;mpoet-update-subscribe-left&quot;&gt; &lt;p&gt;'.__('We send a monthly newsletter with the following:', WYSIJA).'&lt;/p&gt;' .&nbsp;</div></li><li><div>                                                                                                    '&lt;ul&gt;' .&nbsp;</div></li><li><div>                                                                                                            '&lt;li&gt;'.__('Important plugin updates', WYSIJA).'&lt;/li&gt;' .&nbsp;</div></li><li><div>                                                                                                            '&lt;li&gt;'.__('Coupons', WYSIJA).'&lt;/li&gt;' .&nbsp;</div></li><li><div>                                                                                                            '&lt;li&gt;'.__('Tips for you, or your customers', WYSIJA).'&lt;/li&gt;' .&nbsp;</div></li><li><div>                                                                                                            '&lt;li&gt;'.__('What we*re working on', WYSIJA).'&lt;/li&gt;' .&nbsp;</div></li><li><div>                                                                                                            '&lt;li&gt;'.__('News from us, the team', WYSIJA).'&lt;/li&gt;' .&nbsp;</div></li><li><div>                                                                                                    '&lt;/ul&gt;&nbsp;</div></li><li><div>                                                                                                     &lt;p&gt;View an &lt;a target=&quot;_blank&quot; href=&quot;http://www.mailpoet.com/?wysija-page=1&controller=email&action=view&email_id=1181&wysijap=subscriptions-3&quot;&gt;an example blog post email&lt;/a&gt; and &lt;a target=&quot;_blank&quot; href=&quot;http://www.mailpoet.com/?wysija-page=1&controller=email&action=view&email_id=64&wysijap=subscriptions-2&quot;&gt;an example newsletter&lt;/a&gt;.&lt;/p&gt;&nbsp;</div></li><li><div>                                                                                                        &lt;/div&gt;' .&nbsp;</div></li><li><div>                                                                                            '&lt;div class=&quot;mpoet-update-subscribe-right&quot;&gt;' .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                                                            '&lt;iframe width=&quot;380&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; src=&quot;http://www.mailpoet.com/?wysija-page=1&controller=subscribers&action=wysija_outter&wysija_form=5&external_site=1&wysijap=subscriptions-3&quot; class=&quot;iframe-wysija&quot; vspace=&quot;0&quot; tabindex=&quot;0&quot; style=&quot;position: static; top: 0pt; margin: 0px; border-style: none; height: 180px; left: 0pt; visibility: visible; background-color: #f1f1f1!important;&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; hspace=&quot;0&quot; allowtransparency=&quot;true&quot; title=&quot;Subscription Wysija&quot;&gt;&lt;/iframe&gt;&nbsp;</div></li><li><div>                                                                                                &lt;/div&gt;&nbsp;</div></li><li><div>                                                                                                &lt;div style=&quot;clear:both;&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                                                                &lt;/div&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['sections'][]=array(&nbsp;</div></li><li><div>            'title'=&gt;__('First Time? See it in Action', WYSIJA), &nbsp;</div></li><li><div>            'format'=&gt;'normal', &nbsp;</div></li><li><div>            'paragraphs'=&gt;array(&nbsp;</div></li><li><div>                    __('You can start by watching this video by one of our users.', WYSIJA), &nbsp;</div></li><li><div>                    $welcome_video_link&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check if user is already sharing data, and hide the share link.&nbsp;</div></li><li><div>        if (!$model_config-&gt;getValue('analytics')) {&nbsp;</div></li><li><div>          $share_section = array(&nbsp;</div></li><li><div>            'title' =&gt; __('Share your data', WYSIJA), &nbsp;</div></li><li><div>            'content' =&gt; str_replace(&nbsp;</div></li><li><div>              array('[link]', '[/link]', '[ajaxlink]', '[/ajaxlink]'), array('&lt;a title=&quot;Anonymous Data&quot; target=&quot;_blank&quot; href=&quot;http://support.mailpoet.com/knowledgebase/share-your-data/?utm_source=wpadmin&utm_campaign=welcome_page&quot;&gt;', '&lt;/a&gt;', '&lt;a id=&quot;share_analytics&quot; href=&quot;javascript:;&quot;&gt;', '&lt;/a&gt;'), __(&quot;We know too little about our users. We're looking for [link]anonymous data[/link] to build a better plugin. [ajaxlink]Yes, count me in![/ajaxlink]&quot;, WYSIJA))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            $share_section = array(&nbsp;</div></li><li><div>              'title' =&gt; __('Share your data', WYSIJA), &nbsp;</div></li><li><div>              'content' =&gt; str_replace(&nbsp;</div></li><li><div>                array('[link]', '[/link]'), array('&lt;a title=&quot;Anonymous Data&quot; target=&quot;_blank&quot; href=&quot;http://support.mailpoet.com/knowledgebase/share-your-data/?utm_source=wpadmin&utm_campaign=welcome_page&quot;&gt;', '&lt;/a&gt;', '&lt;a id=&quot;share_analytics&quot; href=&quot;javascript:;&quot;&gt;', '&lt;/a&gt;'), __(&quot;We know too little about our users. We're looking for [link]anonymous data[/link] to build a better plugin. Thanks, you're already sharing!&quot;, WYSIJA))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['sections'][] = array(&nbsp;</div></li><li><div>            'title' =&gt; __('What You Can Do', WYSIJA), &nbsp;</div></li><li><div>            'cols' =&gt; array(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'title' =&gt; __('5 minute newbie guide', WYSIJA), &nbsp;</div></li><li><div>                    'content' =&gt; __('Your MailPoet comes with an example newsletter. You\'ll see it when you close this welcome page. Edit it to start playing with it.', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                $share_section, &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'title' =&gt; __('Help yourself. Or let us help you.', WYSIJA), &nbsp;</div></li><li><div>                    'content' =&gt; str_replace(&nbsp;</div></li><li><div>                            array('[link]', '[/link]'), array('&lt;a href=&quot;http://support.mailpoet.com/&quot; target=&quot;_blank&quot; title=&quot;On our blog!&quot;&gt;', '&lt;/a&gt;'), __('We got documentation and a ticket system on [link]support.mailpoet.com[/link]. We answer within 24h.', WYSIJA))&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'format' =&gt; 'three-col', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;skip_header = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Welcome page for updaters&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function whats_new() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;title = $this-&gt;viewObj-&gt;title = __('What\'s new?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['instalwjp'] = __('Installing MailPoet Newsletter Premium plugin', WYSIJA);&nbsp;</div></li><li><div>        wp_enqueue_style('wysija-admin-css-premium', WYSIJA_URL.'css/admin-premium.css', array(), WYSIJA::get_version());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;skip_header = true;&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** START prem check hook */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // when curl or any php remote function not available mailpoet.com returns lcheck to that function&nbsp;</div></li><li><div>    function licok() {&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>        $dt = get_option('wysijey');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['xtz']) && $dt === $_REQUEST['xtz']) {&nbsp;</div></li><li><div>                        $dataconf = array(&nbsp;</div></li><li><div>                            'premium_key' =&gt; base64_encode(get_option('home') . time()), &nbsp;</div></li><li><div>                            'premium_val' =&gt; time(), &nbsp;</div></li><li><div>                            'premium_expire_at' =&gt; (int)$_REQUEST['expire_at']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $this-&gt;notice(__('Premium version is valid for your site.', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $dataconf = array('premium_key' =&gt; '', 'premium_val' =&gt; '');&nbsp;</div></li><li><div>                        if(!empty($_REQUEST['expire_at'])) {&nbsp;</div></li><li><div>                            $dataconf['premium_expire_at'] = (int)$_REQUEST['expire_at'];&nbsp;</div></li><li><div>                        }else{&nbsp;</div></li><li><div>                            $url_premium = 'http://www.mailpoet.com/checkout/?wysijadomain=' . $dt . '&nc=1&utm_source=wpadmin&utm_campaign=error_licence_activation';&nbsp;</div></li><li><div>                            $this-&gt;error(str_replace(array('[link]', '[/link]'), array('&lt;a href=&quot;' . $url_premium . '&quot; target=&quot;_blank&quot;&gt;', '&lt;/a&gt;'), __('Premium licence does not exist for your site. Purchase it [link]here[/link].', WYSIJA)), 1);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        WYSIJA::update_option('wysicheck', false);&nbsp;</div></li><li><div>        $modelConf = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $modelConf-&gt;save($dataconf);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_config#tab-premium');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** END prem check hook */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function validateLic() {&nbsp;</div></li><li><div>        $helpLic = WYSIJA::get('licence', 'helper');&nbsp;</div></li><li><div>        $res = $helpLic-&gt;check();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this function is triggered when sending manually the emails with the &quot;Don't wait and send right now&quot; button&nbsp;</div></li><li><div>     * @param type $dataPost&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function manual_send($dataPost = false) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                $modelQ = WYSIJA::get('queue', 'model');&nbsp;</div></li><li><div>        $config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        if ((int) $config-&gt;getValue('total_subscribers') &lt; 2000) {&nbsp;</div></li><li><div>            if ($modelQ-&gt;count() &gt; 0) {&nbsp;</div></li><li><div>                $helperQ = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>                $emailid = false;&nbsp;</div></li><li><div>                if ($_REQUEST['emailid']) {&nbsp;</div></li><li><div>                    $emailid = (int)$_REQUEST['emailid'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $helperQ-&gt;process($emailid);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                echo '&lt;strong style=&quot;font-family: Arial; font-weight: bold; font-size: 12px;&quot;&gt;' . __('Queue is empty!', WYSIJA) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //deprecated&nbsp;</div></li><li><div>            do_action('wysija_send_test_editor');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action('wysija_manual_send');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * test the bounce handling maybe this should move somewhere else like config controller&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function test_bounce() {&nbsp;</div></li><li><div>        // bounce handling&nbsp;</div></li><li><div>        $helper_bounce = WYSIJA::get('bounce', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // in a multisite case we process first the bounce recording into the bounce table&nbsp;</div></li><li><div>        if (is_multisite()) {&nbsp;</div></li><li><div>            $helper_bounce-&gt;record_bounce_ms();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // then we take actions from what has been returned by the bounce&nbsp;</div></li><li><div>            $helper_bounce-&gt;process_bounce_ms();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $helper_bounce-&gt;process_bounce();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add($dataPost = false) {&nbsp;</div></li><li><div>        $this-&gt;title = sprintf(__('Step %1$s', WYSIJA), 1);&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-edit-autonl';&nbsp;</div></li><li><div>        $this-&gt;js['admin-campaigns-edit'] = 'admin-campaigns-edit';&nbsp;</div></li><li><div>        $this-&gt;jsTrans['descauto'] = str_replace(array('[newsletter:number]', '[newsletter:total]', '[newsletter:post_title]'), array('&lt;b&gt;[newsletter:number]&lt;/b&gt;', '&lt;b&gt;[newsletter:total]&lt;/b&gt;', '&lt;b&gt;[newsletter:post_title]&lt;/b&gt;'), __('Insert [newsletter:total] to show number of posts, [newsletter:post_title] to show the latest post\'s title & [newsletter:number] to display the issue number.', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;jsTrans['descstandard'] = __('The first thing your subscribers see. Be creative and increase your open rate!', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;immediateWarning();&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = __('First step: main details', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'add';&nbsp;</div></li><li><div>        $this-&gt;data = array();&nbsp;</div></li><li><div>        $this-&gt;data['campaign'] = array('name' =&gt; '', 'description' =&gt; '');&nbsp;</div></li><li><div>        $modelConfig = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['email'] = array('subject' =&gt; '', 'from_email' =&gt; $modelConfig-&gt;getValue('from_email'), 'from_name' =&gt; $modelConfig-&gt;getValue('from_name'));&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $this-&gt;_getLists(false, true, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;dataAutoNl();&nbsp;</div></li><li><div>        $this-&gt;jsLoc['admin-campaigns-edit']['autofields'] = $this-&gt;data['autonl']['fields'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get the fields and fields value necessary when dealing with automatic newsletters&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function dataAutoNl() {&nbsp;</div></li><li><div>        $dataFrequencyNoImmediate = $dataFrequency = array('daily' =&gt; __('once a day at...', WYSIJA), &nbsp;</div></li><li><div>            'weekly' =&gt; __('weekly on...', WYSIJA), &nbsp;</div></li><li><div>            'monthly' =&gt; __('monthly on the...', WYSIJA), &nbsp;</div></li><li><div>            'monthlyevery' =&gt; __('monthly every...', WYSIJA), &nbsp;</div></li><li><div>            'immediate' =&gt; __('immediately.', WYSIJA));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset($dataFrequencyNoImmediate['immediate']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $times = array();&nbsp;</div></li><li><div>        $time = strtotime('00:00:00');&nbsp;</div></li><li><div>        $toolboxH = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>        $times['00:00:00'] = $toolboxH-&gt;localtime($time);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        for ($i = 1; $i &lt; 24; $i++) {&nbsp;</div></li><li><div>            $time = strtotime('+ 1hour', $time);&nbsp;</div></li><li><div>            $key = date('H:i:s', $time);&nbsp;</div></li><li><div>            $times[$key] = $toolboxH-&gt;localtime($time);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $daysvalues = $toolboxH-&gt;getday();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $numberweeks = $toolboxH-&gt;getweeksnumber();&nbsp;</div></li><li><div>        $daynumbers = $toolboxH-&gt;getdaynumber();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dataLists = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($this-&gt;data['lists'] as $datal) {&nbsp;</div></li><li><div>            if ($datal['is_enabled'])&nbsp;</div></li><li><div>                $dataLists[$datal['list_id']] = $datal['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get all available roles&nbsp;</div></li><li><div>        $wptoolsH = WYSIJA::get('wp_tools', 'helper');&nbsp;</div></li><li><div>        $roles = $wptoolsH-&gt;wp_get_all_roles();&nbsp;</div></li><li><div>        $available_roles = array('any' =&gt; __('in any WordPress role', WYSIJA));&nbsp;</div></li><li><div>        foreach ($roles as $role =&gt; $name) {&nbsp;</div></li><li><div>            $available_roles[$role] = $name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['autonl']['fields'] = array(&nbsp;</div></li><li><div>            'event' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; array(&nbsp;</div></li><li><div>                    'new-articles' =&gt; __('When there\'s new content...', WYSIJA), &nbsp;</div></li><li><div>                    'subs-2-nl' =&gt; __('When someone subscribes to the list...', WYSIJA), &nbsp;</div></li><li><div>                    'new-user' =&gt; __('When a new WordPress user is added to your site...', WYSIJA), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'valueshow' =&gt; array(&nbsp;</div></li><li><div>                    'new-articles' =&gt; array('when-article'), &nbsp;</div></li><li><div>                    'subs-2-nl' =&gt; array('subscribetolist', 'numberafter', 'numberofwhat', 'unique_send'), &nbsp;</div></li><li><div>                    'new-user' =&gt; array('roles', 'numberafter', 'numberofwhat', 'unique_send'), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'style' =&gt; 'width:300px;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'when-article' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $dataFrequency, &nbsp;</div></li><li><div>                'valueshow' =&gt; array(&nbsp;</div></li><li><div>                    'daily' =&gt; array('time'), &nbsp;</div></li><li><div>                    'weekly' =&gt; array('dayname', 'time'), &nbsp;</div></li><li><div>                    'monthly' =&gt; array('daynumber', 'time'), &nbsp;</div></li><li><div>                    'monthlyevery' =&gt; array('dayevery', 'dayname', 'time'), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'subscribetolist' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $dataLists, &nbsp;</div></li><li><div>                'style' =&gt; 'width:300px;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'roles' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $available_roles&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'numberafter' =&gt; array(&nbsp;</div></li><li><div>                'type' =&gt; 'input', &nbsp;</div></li><li><div>                'style' =&gt; 'width:35px;', &nbsp;</div></li><li><div>                'class' =&gt; 'validate[required, custom[integer], min[1]]', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'numberofwhat' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; array(&nbsp;</div></li><li><div>                    'immediate' =&gt; __('immediately.', WYSIJA), &nbsp;</div></li><li><div>                    'hours' =&gt; __('hour(s) after.', WYSIJA), &nbsp;</div></li><li><div>                    'days' =&gt; __('day(s) after.', WYSIJA), &nbsp;</div></li><li><div>                    'weeks' =&gt; __('week(s) after.', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'valuesunit' =&gt; array(&nbsp;</div></li><li><div>                    'immediate' =&gt; __('immediately', WYSIJA), &nbsp;</div></li><li><div>                    'hours' =&gt; __('hour(s)', WYSIJA), &nbsp;</div></li><li><div>                    'days' =&gt; __('day(s)', WYSIJA), &nbsp;</div></li><li><div>                    'weeks' =&gt; __('week(s)', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'dayevery' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $numberweeks, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'dayname' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $daysvalues, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'daynumber' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $daynumbers, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'time' =&gt; array(&nbsp;</div></li><li><div>                'values' =&gt; $times, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                /** 'unique_send'=&gt;array(&nbsp;</div></li><li><div>                  'label_before'=&gt;__('Send this email only once.', WYSIJA), &nbsp;</div></li><li><div>                  'type'=&gt;'checkbox'&nbsp;</div></li><li><div> ), */&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $helpersEvent = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>        $extraEvents = $helpersEvent-&gt;events();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** if there are plugin to add autonewsletter event they are adding their customized field over here */&nbsp;</div></li><li><div>        if ($extraEvents) {&nbsp;</div></li><li><div>            foreach ($extraEvents as $k =&gt; $v) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;data['autonl']['fields']['event']['values'][$k] = $v['title'];&nbsp;</div></li><li><div>                foreach ($v['fields'] as $fieldCKEY =&gt; $fieldCVAL) {&nbsp;</div></li><li><div>                    if (isset($this-&gt;data['autonl']['fields'][$fieldCKEY]))&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;data['autonl']['fields']['event']['valueshow'][$k] = array_keys($v['fields']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function edit($dataPost = false) {&nbsp;</div></li><li><div>        if (!$this-&gt;_checkEmailExists($_REQUEST['id']))&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        $this-&gt;add();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['email'] = $modelEmail-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($this-&gt;data['email']['status'] &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;title = sprintf(__('Step %1$s', WYSIJA), 1) . ' | ' . $this-&gt;data['email']['subject'];&nbsp;</div></li><li><div>        $modelCamp = WYSIJA::get('campaign', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['campaign'] = $modelCamp-&gt;getOne(false, array('campaign_id' =&gt; $this-&gt;data['email']['campaign_id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelCL = WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['campaign_list'] = $modelCL-&gt;get(false, array('campaign_id' =&gt; $this-&gt;data['email']['campaign_id']));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function editTemplate() {&nbsp;</div></li><li><div>        // make sure the editor content is not cached&nbsp;</div></li><li><div>        header('Cache-Control: no-cache, max-age=0, must-revalidate, no-store'); // HTTP/1.1&nbsp;</div></li><li><div>        header('Expires: Fri, 9 Mar 1984 00:00:00 GMT');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;_checkEmailExists($_REQUEST['id']))&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'editTemplate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style('thickbox');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wjEngine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>        /** WJ editor translations */&nbsp;</div></li><li><div>        $this-&gt;jsTrans = array_merge($this-&gt;jsTrans, $wjEngine-&gt;getTranslations(), $wjEngine-&gt;getApplicationData());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['savingnl'] = __('Saving newsletter...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['errorsavingnl'] = __('Error Saving newsletter...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['savednl'] = __('Newsletter has been saved.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['previewemail'] = __('Sending preview...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['spamtestresult'] = __('Spam test results', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** WJ editor JS */&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-editor';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax-proto';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-base-script-64';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'media-upload';&nbsp;</div></li><li><div>        $this-&gt;js['admin-campaigns-editDetails'] = 'admin-campaigns-editDetails';&nbsp;</div></li><li><div>        $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $this-&gt;data = array();&nbsp;</div></li><li><div>        $this-&gt;data['email'] = $modelEmail-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;checkIsEditable();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = sprintf(__('Second step:  &quot;%1$s&quot;', WYSIJA), $this-&gt;data['email']['subject']);&nbsp;</div></li><li><div>        $this-&gt;title = sprintf(__('Step %1$s', WYSIJA), 2) . &quot; | &quot; . $this-&gt;data['email']['subject'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if html source is enabled in the config (this will add the &quot;html source&quot; button in tinymce)&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $this-&gt;jsTrans['html_source_enabled'] = (int) $model_config-&gt;getValue('html_source');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function checkIsEditable() {&nbsp;</div></li><li><div>        if (&nbsp;</div></li><li><div>                !($this-&gt;data['email'] == 2 || isset($this-&gt;data['email']['params']['schedule']['isscheduled'])) && $this-&gt;data['email']['status'] &gt; 0&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function pause() {&nbsp;</div></li><li><div>        /** pause the campaign entry */&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if (isset($_REQUEST['id']) && $_REQUEST['id']) {&nbsp;</div></li><li><div>            $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $myemail = $modelEmail-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>            $modelEmail-&gt;reset();&nbsp;</div></li><li><div>            $modelEmail-&gt;columns['modified_at']['autoup'] = 1;&nbsp;</div></li><li><div>            $modelEmail-&gt;update(array('status' =&gt; -1), array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($myemail['type'] == 2) {&nbsp;</div></li><li><div>                return $this-&gt;redirect('admin.php?page=wysija_campaigns&id=' . $myemail['email_id'] . '&action=edit');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;notice(__('Sending is now paused.', WYSIJA));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function resume() {&nbsp;</div></li><li><div>        /** pause the campaign entry */&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if (isset($_REQUEST['id']) && $_REQUEST['id']) {&nbsp;</div></li><li><div>            $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $modelEmail-&gt;columns['modified_at']['autoup'] = 1;&nbsp;</div></li><li><div>            $modelEmail-&gt;update(array('status' =&gt; 99), array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>            $this-&gt;notice(__('Sending has resumed.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function duplicate() {&nbsp;</div></li><li><div>        /** 1 - copy the campaign entry */&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $model = WYSIJA::get( 'campaign', 'model' );&nbsp;</div></li><li><div>        $query = 'INSERT INTO `[wysija]campaign` (`name`, `description`)&nbsp;</div></li><li><div>            SELECT concat(&quot;' . $this-&gt;wpdb-&gt;_real_escape( __( 'Copy of ', WYSIJA ) ) . '&quot;, `name`), `description` FROM [wysija]campaign&nbsp;</div></li><li><div>            WHERE campaign_id=' . (int) $_REQUEST['id'];&nbsp;</div></li><li><div>        $campaignid = $model-&gt;query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** 2 - copy the email entry */&nbsp;</div></li><li><div>        $query = 'INSERT INTO `[wysija]email` (`campaign_id`, `subject`, `body`, `type`, `params`, `wj_data`, `wj_styles`, `from_email`, `from_name`, `replyto_email`, `replyto_name`, `attachments`, `status`, `created_at`, `modified_at`)&nbsp;</div></li><li><div>            SELECT ' . $campaignid . ', concat(&quot;' . $this-&gt;wpdb-&gt;_real_escape( __( 'Copy of ', WYSIJA ) ) . '&quot;, `subject`), `body`, `type`, `params`, `wj_data`, `wj_styles`, `from_email`, `from_name`, `replyto_email`, `replyto_name`, `attachments`, 0, ' . time() . ', ' . time() . ' FROM [wysija]email&nbsp;</div></li><li><div>            WHERE email_id=' . (int) $_REQUEST['email_id'];&nbsp;</div></li><li><div>        $emailid = $model-&gt;query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //let's reset the count of total childs for auto newsletter&nbsp;</div></li><li><div>        $mEmail = WYSIJA::get( 'email', 'model' );&nbsp;</div></li><li><div>        $emailData = $mEmail-&gt;getOne( false, array( 'email_id' =&gt; $emailid ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $emailData['type'] == 1 ) {&nbsp;</div></li><li><div>            $params = $emailData['params'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $params['schedule'] ) ) {&nbsp;</div></li><li><div>                $date_scheduled = strtotime( $params['schedule']['day'] . ' ' . $params['schedule']['time'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $date_scheduled === false || $date_scheduled &lt; time() ) {&nbsp;</div></li><li><div>                    unset( $params['schedule'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $mEmail-&gt;update( array( 'params' =&gt; $params ), array( 'email_id' =&gt; $emailid ) );&nbsp;</div></li><li><div>        } elseif ( $emailData['type'] == 2 ) {&nbsp;</div></li><li><div>            $paramsReseted = $emailData['params'];&nbsp;</div></li><li><div>            if ( isset( $paramsReseted['autonl']['total_child'] ) ) {&nbsp;</div></li><li><div>                $paramsReseted['autonl']['total_child'] = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $paramsReseted['autonl']['nextSend'] ) ) {&nbsp;</div></li><li><div>                $paramsReseted['autonl']['nextSend'] = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $paramsReseted['autonl']['firstSend'] ) ) {&nbsp;</div></li><li><div>                unset( $paramsReseted['autonl']['firstSend'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $paramsReseted['autonl']['lastSend'] ) ) {&nbsp;</div></li><li><div>                unset( $paramsReseted['autonl']['lastSend'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $paramsReseted['autonl']['articles']['ids'] ) ) {&nbsp;</div></li><li><div>                unset( $paramsReseted['autonl']['articles']['ids'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $mEmail-&gt;update( array( 'params' =&gt; $paramsReseted ), array( 'email_id' =&gt; $emailid ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** 3 - copy the campaign_list entry */&nbsp;</div></li><li><div>        $query = &quot;INSERT INTO `[wysija]campaign_list` (`campaign_id`, `list_id`, `filter`)&nbsp;</div></li><li><div>            SELECT $campaignid, `list_id`, `filter` FROM [wysija]campaign_list&nbsp;</div></li><li><div>            WHERE campaign_id=&quot; . (int) $_REQUEST['id'];&nbsp;</div></li><li><div>        $model-&gt;query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice( __( 'The newsletter has been duplicated.', WYSIJA ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect( 'admin.php?page=wysija_campaigns&id=' . $emailid . '&action=edit' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function immediateWarning() {&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $is_multisite = is_multisite();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //$is_multisite=true;//PROD comment that line&nbsp;</div></li><li><div>        if ($is_multisite && $model_config-&gt;getValue('sending_method') == 'network') {&nbsp;</div></li><li><div>            $sending_emails_each = $model_config-&gt;getValue('ms_sending_emails_each');&nbsp;</div></li><li><div>            $number = $model_config-&gt;getValue('ms_sending_emails_number');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sending_emails_each = $model_config-&gt;getValue('sending_emails_each');&nbsp;</div></li><li><div>            $number = $model_config-&gt;getValue('sending_emails_number');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formsHelp = WYSIJA::get('forms', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $timespan = $formsHelp-&gt;eachValuesSec[$sending_emails_each];&nbsp;</div></li><li><div>        $helper_toolbox = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;immediatewarning = str_replace(&nbsp;</div></li><li><div>                array('[link]', '[/link]', '[settings]'), array('&lt;a href=&quot;#&quot;&gt;', '&lt;/a&gt;', sprintf(__('%1$s emails every %2$s', WYSIJA), $number, trim($helper_toolbox-&gt;duration_string($timespan, true)))), __('Your sending settings ([settings]) can\'t send that quickly to [number] subscribers. Expect delivery delays. [link]Read more[/link]', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;immediatewarning = '&lt;span class=&quot;warning-msg&quot; id=&quot;immediatewarning&quot;&gt;' . $this-&gt;immediatewarning . '&lt;/span&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['immediatewarning'] = $this-&gt;immediatewarning;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //how many emails can be sent in 12 hours&nbsp;</div></li><li><div>        //if the frequency is less than 12hours&nbsp;</div></li><li><div>        if ($timespan &lt; 43200) {&nbsp;</div></li><li><div>            $ratio = floor(43200 / $timespan);&nbsp;</div></li><li><div>            $this-&gt;jsTrans['possibleemails'] = $ratio * $number;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ($timespan == 43200) {&nbsp;</div></li><li><div>                $this-&gt;jsTrans['possibleemails'] = $number;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $ratio = floor($timespan / 43200);&nbsp;</div></li><li><div>                $this-&gt;jsTrans['possibleemails'] = $number / $ratio;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function editDetails() {&nbsp;</div></li><li><div>        if (!$this-&gt;_checkEmailExists($_REQUEST['id']))&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = __('Final step: last details', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'editDetails';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-validator';&nbsp;</div></li><li><div>        $this-&gt;jsTrans['previewemail'] = __('Sending preview...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['pickadate'] = __('Pick a date', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['saveclose'] = __('Save & close', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['sendlater'] = __('Send later', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['schedule'] = __('Schedule', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['emailCheck'] = WJ_Utils::get_tip_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;js[] = 'jquery-ui-datepicker';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-tooltip';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;limitON = false;&nbsp;</div></li><li><div>        $this-&gt;data = array();&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $this-&gt;_getLists(false, true, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['email'] = $model_email-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The first newsletter, we don't have replyto_email and replyto_name&nbsp;</div></li><li><div>        if (empty($this-&gt;data['email']['replyto_email']) || empty($this-&gt;data['email']['replyto_name'])) {&nbsp;</div></li><li><div>            $current_user = wp_get_current_user();&nbsp;</div></li><li><div>            $this-&gt;data['email']['replyto_email'] = $current_user-&gt;data-&gt;user_email;&nbsp;</div></li><li><div>            $this-&gt;data['email']['replyto_name'] = $current_user-&gt;data-&gt;display_name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ((int) $this-&gt;data['email']['type'] == 2) {&nbsp;</div></li><li><div>            $this-&gt;js['wysija-edit-autonl'] = 'wysija-edit-autonl';&nbsp;</div></li><li><div>            $this-&gt;jsTrans['autonl'] = true;&nbsp;</div></li><li><div>            $this-&gt;immediateWarning();&nbsp;</div></li><li><div>            $this-&gt;jsTrans['send'] = __('Activate now', WYSIJA);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;jsTrans['autonl'] = true;&nbsp;</div></li><li><div>            $this-&gt;viewObj-&gt;immediatewarning = '';&nbsp;</div></li><li><div>            $this-&gt;jsTrans['send'] = __('Send', WYSIJA);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ((int) $this-&gt;data['email']['type'] == 1) {&nbsp;</div></li><li><div>            $this-&gt;jsTrans['alertsend'] = __('You are about to send this newsletter. Please confirm.', WYSIJA);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if (isset($this-&gt;data['email']['params']['autonl']['event']) && $this-&gt;data['email']['params']['autonl']['event'] == 'subs-2-nl') {&nbsp;</div></li><li><div>                $this-&gt;data['autoresponder'] = 1;&nbsp;</div></li><li><div>                foreach ($this-&gt;data['lists'] as $list) {&nbsp;</div></li><li><div>                    if ($list['list_id'] == $this-&gt;data['email']['params']['autonl']['subscribetolist']) {&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;jsTrans['ignoreprevious'] = sprintf(__('Are you sure you want to ignore the %1$s subscribers of the list %2$s?', WYSIJA), '&quot;' . $list['count'] . '&quot;', '&quot;' . $list['name'] . '&quot;');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;checkIsEditable();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;title = sprintf(__('Step %1$s', WYSIJA), 3) . &quot; | &quot; . $this-&gt;data['email']['subject'];&nbsp;</div></li><li><div>        $this-&gt;dataAutoNl();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsLoc['wysija-edit-autonl']['autofields'] = $this-&gt;data['autonl']['fields'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelCL = WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['campaign_list'] = $modelCL-&gt;get(false, array('campaign_id' =&gt; $this-&gt;data['email']['campaign_id']));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function delete() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $campaign_ids = array();&nbsp;</div></li><li><div>        if(isset($_REQUEST['id'])) $campaign_ids[] = $_REQUEST['id'];&nbsp;</div></li><li><div>        if(isset($_REQUEST['campaign']['campaign_id'])) $campaign_ids[] = $_REQUEST['campaign']['campaign_id'];&nbsp;</div></li><li><div>        if(isset($_REQUEST['wysija']['campaign']['campaign_id'][0])) {&nbsp;</div></li><li><div>            $campaign_ids = array_merge($campaign_ids, $_REQUEST['wysija']['campaign']['campaign_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($campaign_ids)) {&nbsp;</div></li><li><div>            foreach($campaign_ids as $campaign_id) {&nbsp;</div></li><li><div>                if($campaign_id &gt; 0) {&nbsp;</div></li><li><div>                    $model_campaign = WYSIJA::get('campaign', 'model');&nbsp;</div></li><li><div>                    $model_campaign-&gt;delete(array('campaign_id' =&gt; $campaign_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $model_campaign_list = WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>                    $model_campaign_list-&gt;delete(array('campaign_id' =&gt; $campaign_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>                    $modelEmail-&gt;delete(array('campaign_id' =&gt; $campaign_id));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(_n(__('Newsletter deleted.', WYSIJA), __('Newsletters deleted.', WYSIJA), count($campaign_ids), WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;notice(__('Newsletter can\'t be deleted.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // retrieve saved filter&nbsp;</div></li><li><div>        if (!empty($_REQUEST['action']))&nbsp;</div></li><li><div>            unset($_REQUEST['action']);&nbsp;</div></li><li><div>        if (!empty($_REQUEST['id']))&nbsp;</div></li><li><div>            unset($_REQUEST['id']);&nbsp;</div></li><li><div>        if (!empty($_REQUEST['_wpnonce']))&nbsp;</div></li><li><div>            unset($_REQUEST['_wpnonce']);&nbsp;</div></li><li><div>        $redirect = $this-&gt;base_url . '?' . http_build_query($_REQUEST);&nbsp;</div></li><li><div>        $this-&gt;redirect($redirect);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * this function is to delete an email that belongs to a campaign&nbsp;</div></li><li><div>     * when we have a post notification all emails belong to the same campaign&nbsp;</div></li><li><div>     * we don't want to delete an entire campaign when we delete a single email&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function deleteEmail() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if(!$this-&gt;_checkEmailExists($_REQUEST['id'])) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['id'])) {&nbsp;</div></li><li><div>            $modelEmail=WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $modelEmail-&gt;delete(array('email_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>            $this-&gt;notice(__('Newsletter deleted.', WYSIJA));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;notice(__('Newsletter can\'t be deleted.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function savecamp() {&nbsp;</div></li><li><div>        $this-&gt;redirectAfterSave = false;&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        /** update email */&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // in case the newsletter already exists&nbsp;</div></li><li><div>        if (isset($_REQUEST['id'])) {&nbsp;</div></li><li><div>            $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $modelEmail-&gt;fieldValid = false;&nbsp;</div></li><li><div>            $emaildataarr = $modelEmail-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_campaign = WYSIJA::get('campaign', 'model');&nbsp;</div></li><li><div>            $model_campaign-&gt;update(array('name' =&gt; $_POST['wysija']['email']['subject'], 'description' =&gt; ''), array('campaign_id' =&gt; $emaildataarr['campaign_id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $campaign_id = $emaildataarr['campaign_id'];&nbsp;</div></li><li><div>            $email_id = $emaildataarr['email_id'];&nbsp;</div></li><li><div>            $dataEmail = array(&nbsp;</div></li><li><div>                'campaign_id' =&gt; $campaign_id, &nbsp;</div></li><li><div>                'subject' =&gt; $_POST['wysija']['email']['subject'], &nbsp;</div></li><li><div>                'type' =&gt; $_POST['wysija']['email']['type']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if((int)$dataEmail['type'] === 2) {&nbsp;</div></li><li><div>                // set autonl params&nbsp;</div></li><li><div>                $dataEmail['params'] = array('autonl' =&gt; $_POST['wysija']['email']['params']['autonl']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // WTF?&nbsp;</div></li><li><div>                if(!isset($newparams['autonl']['unique_send'])) {&nbsp;</div></li><li><div>                    unset($dataEmail['params']['autonl']['unique_send']);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $dataEmail['params']['autonl']['unique_send'] = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check if the newsletter used to be an automatic newsletter (if )&nbsp;</div></li><li><div>            if((int)$dataEmail['type'] === 1 && (int)$emaildataarr['type'] === 2) {&nbsp;</div></li><li><div>                // make sure we remove any kind of auto-post block&nbsp;</div></li><li><div>                $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>                $updated_email_data = $helper_autonews-&gt;remove_autopost_blocks($emaildataarr['wj_data']);&nbsp;</div></li><li><div>                if($updated_email_data !== false) {&nbsp;</div></li><li><div>                    // if the email data has been changed, make sure to update it in the DB&nbsp;</div></li><li><div>                    $dataEmail['wj_data'] = $updated_email_data;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $modelEmail-&gt;columns['modified_at']['autoup'] = 1;&nbsp;</div></li><li><div>            $modelEmail-&gt;debugupdate = true;&nbsp;</div></li><li><div>            $dataEmail['email_id'] = $_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($_REQUEST['save-reactivate'])) {&nbsp;</div></li><li><div>                //if the button save and reactivate has been clicked then we reactivate and redirect to the newsletter page&nbsp;</div></li><li><div>                $dataEmail['status'] = 99;&nbsp;</div></li><li><div>                $_REQUEST['return'] = 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data['email']['email_id'] = $modelEmail-&gt;update($dataEmail, array('email_id' =&gt; (int)$_REQUEST['id']));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // get default theme&nbsp;</div></li><li><div>            $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>            $default_theme = $model_config-&gt;getValue('newsletter_default_theme', 'default');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_themes = WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>            $theme_data = $helper_themes-&gt;getData($default_theme);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // get campaign data&nbsp;</div></li><li><div>            $model_campaign = WYSIJA::get('campaign', 'model');&nbsp;</div></li><li><div>            $campaign_id = $model_campaign-&gt;insert(array('name' =&gt; $_POST['wysija']['email']['subject'], 'description' =&gt; ''));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $modelEmail = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $modelEmail-&gt;fieldValid = false;&nbsp;</div></li><li><div>            $emaildata = array(&nbsp;</div></li><li><div>                'campaign_id' =&gt; $campaign_id, &nbsp;</div></li><li><div>                'subject' =&gt; $_POST['wysija']['email']['subject'], &nbsp;</div></li><li><div>                'type' =&gt; (int) $_POST['wysija']['email']['type']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create autonl parameters if necessary&nbsp;</div></li><li><div>            if ((int) $_POST['wysija']['email']['type'] === 2 && isset($_POST['wysija']['email']['params']['autonl'])) {&nbsp;</div></li><li><div>                $emaildata['params'] = array('autonl' =&gt; $_POST['wysija']['email']['params']['autonl']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create sample data depending on newsletter's type&nbsp;</div></li><li><div>            if ((int) $_POST['wysija']['email']['type'] === 2 && $_POST['wysija']['email']['params']['autonl']['event'] === 'new-articles') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if immediate, post_limit is set to 1&nbsp;</div></li><li><div>                if ($emaildata['params']['autonl']['when-article'] === 'immediate') {&nbsp;</div></li><li><div>                    $autopostParams = array(&nbsp;</div></li><li><div>                        array('key' =&gt; 'category_ids', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_tag', 'value' =&gt; 'h2'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_alignment', 'value' =&gt; 'left'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_position', 'value' =&gt; 'inside'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'image_alignment', 'value' =&gt; 'alternate'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'image_width', 'value' =&gt; 325), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_content', 'value' =&gt; 'excerpt'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'readmore', 'value' =&gt; base64_encode(__('Read more.', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'show_divider', 'value' =&gt; 'yes'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_limit', 'value' =&gt; 1), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_type', 'value' =&gt; 'post'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'author_show', 'value' =&gt; 'no'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'author_label', 'value' =&gt; base64_encode(__('Author:', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'category_show', 'value' =&gt; 'no'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'category_label', 'value' =&gt; base64_encode(__('Categories:', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'nopost_message', 'value' =&gt; base64_encode(__('Latest content already sent.', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'bgcolor1', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'bgcolor2', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'sort_by', 'value' =&gt; 'newest')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $autopostParams = array(&nbsp;</div></li><li><div>                        array('key' =&gt; 'category_ids', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_tag', 'value' =&gt; 'h2'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_alignment', 'value' =&gt; 'left'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'title_position', 'value' =&gt; 'inside'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'image_alignment', 'value' =&gt; 'alternate'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'image_width', 'value' =&gt; 325), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_content', 'value' =&gt; 'excerpt'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'readmore', 'value' =&gt; base64_encode(__('Read more.', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'show_divider', 'value' =&gt; 'yes'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_limit', 'value' =&gt; 2), &nbsp;</div></li><li><div>                        array('key' =&gt; 'post_type', 'value' =&gt; 'post'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'author_show', 'value' =&gt; 'no'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'author_label', 'value' =&gt; base64_encode(__('Author:', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'category_show', 'value' =&gt; 'no'), &nbsp;</div></li><li><div>                        array('key' =&gt; 'category_label', 'value' =&gt; base64_encode(__('Categories:', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'nopost_message', 'value' =&gt; base64_encode(__('Latest content already sent.', WYSIJA))), &nbsp;</div></li><li><div>                        array('key' =&gt; 'bgcolor1', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'bgcolor2', 'value' =&gt; null), &nbsp;</div></li><li><div>                        array('key' =&gt; 'sort_by', 'value' =&gt; 'newest')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // sample data for post notifications&nbsp;</div></li><li><div>                $newwjdata = array(&nbsp;</div></li><li><div>                    'version' =&gt; WYSIJA::get_version(), &nbsp;</div></li><li><div>                    'header' =&gt; array(&nbsp;</div></li><li><div>                        'text' =&gt; NULL, &nbsp;</div></li><li><div>                        'image' =&gt; array(&nbsp;</div></li><li><div>                            'src' =&gt; WYSIJA_EDITOR_IMG . 'transparent.png', &nbsp;</div></li><li><div>                            'width' =&gt; 600, &nbsp;</div></li><li><div>                            'height' =&gt; 86, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                            'static' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                        'static' =&gt; true, &nbsp;</div></li><li><div>                        'type' =&gt; 'header'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    'body' =&gt; array(&nbsp;</div></li><li><div>                        'block-1' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h3 class=&quot;align-right&quot;&gt;' . sprintf(__(&quot;The posts below were added with the widget %sAutomatic latest content%s&quot;, WYSIJA), '&lt;strong&gt;', '&lt;/strong&gt;') . '&lt;/h3&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; array(&nbsp;</div></li><li><div>                                'src' =&gt; WYSIJA_EDITOR_IMG . 'default-newsletter/autonewsletter/arrow-up.png', &nbsp;</div></li><li><div>                                'width' =&gt; 45, &nbsp;</div></li><li><div>                                'height' =&gt; 45, &nbsp;</div></li><li><div>                                'alignment' =&gt; 'right', &nbsp;</div></li><li><div>                                'static' =&gt; false&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'alignment' =&gt; 'right', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; '1', &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-2' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h3&gt;' . sprintf(__('%sTo edit%s, mouse over to show edit button below.', WYSIJA), '&lt;strong&gt;', '&lt;/strong&gt;') . '&lt;/h3&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; array(&nbsp;</div></li><li><div>                                'src' =&gt; WYSIJA_EDITOR_IMG . 'default-newsletter/autonewsletter/arrow-down.png', &nbsp;</div></li><li><div>                                'width' =&gt; 150, &nbsp;</div></li><li><div>                                'height' =&gt; 53, &nbsp;</div></li><li><div>                                'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                                'static' =&gt; false&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; '2', &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-3' =&gt; array(&nbsp;</div></li><li><div>                            'params' =&gt; $autopostParams, &nbsp;</div></li><li><div>                            'position' =&gt; '3', &nbsp;</div></li><li><div>                            'type' =&gt; 'auto-post'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    'footer' =&gt; array(&nbsp;</div></li><li><div>                        'text' =&gt; NULL, &nbsp;</div></li><li><div>                        'image' =&gt; array(&nbsp;</div></li><li><div>                            'src' =&gt; WYSIJA_EDITOR_IMG . 'transparent.png', &nbsp;</div></li><li><div>                            'width' =&gt; 600, &nbsp;</div></li><li><div>                            'height' =&gt; 86, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                            'static' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                        'static' =&gt; true, &nbsp;</div></li><li><div>                        'type' =&gt; 'footer'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(!isset($emaildata['params'])) {&nbsp;</div></li><li><div>                    $emaildata['params'] = array();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $emaildata['params']['quickselection'] = array(&nbsp;</div></li><li><div>                    'wp-301' =&gt; array(&nbsp;</div></li><li><div>                        'identifier' =&gt; 'wp-301', &nbsp;</div></li><li><div>                        'width' =&gt; 281, &nbsp;</div></li><li><div>                        'height' =&gt; 190, &nbsp;</div></li><li><div>                        'url' =&gt; WYSIJA_EDITOR_IMG . 'default-newsletter/newsletter/pigeon.png', &nbsp;</div></li><li><div>                        'thumb_url' =&gt; WYSIJA_EDITOR_IMG . 'default-newsletter/newsletter/pigeon-150x150.png'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if($theme_data['divider'] === null) {&nbsp;</div></li><li><div>                    // default theme does not exist anymore or there is no divider associated to the theme&nbsp;</div></li><li><div>                    // we need to get the default divider in this case&nbsp;</div></li><li><div>                    $helper_dividers = WYSIJA::get('dividers', 'helper');&nbsp;</div></li><li><div>                    $default_divider = $helper_dividers-&gt;getDefault();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // set default divider&nbsp;</div></li><li><div>                    $default_divider = $theme_data['divider'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // set default divider in email parameters&nbsp;</div></li><li><div>                $emaildata['params']['divider'] = $default_divider;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // get bookmarks from iconset 2&nbsp;</div></li><li><div>                $helper_bookmarks = WYSIJA::get('bookmarks', 'helper');&nbsp;</div></li><li><div>                $bookmarks = $helper_bookmarks-&gt;getAllByIconset('medium', '02');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // sample data for regular newsletter&nbsp;</div></li><li><div>                $newwjdata = array(&nbsp;</div></li><li><div>                    'version' =&gt; WYSIJA::get_version(), &nbsp;</div></li><li><div>                    'header' =&gt; array(&nbsp;</div></li><li><div>                        'text' =&gt; null, &nbsp;</div></li><li><div>                        'image' =&gt; array(&nbsp;</div></li><li><div>                            // 'src' =&gt; WYSIJA_EDITOR_IMG.'default-newsletter/newsletter/header.png', &nbsp;</div></li><li><div>                            'src' =&gt; WYSIJA_EDITOR_IMG . 'transparent.png', &nbsp;</div></li><li><div>                            'width' =&gt; 600, &nbsp;</div></li><li><div>                            'height' =&gt; 86, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                            'static' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                        'static' =&gt; true, &nbsp;</div></li><li><div>                        'type' =&gt; 'header'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    'body' =&gt; array(&nbsp;</div></li><li><div>                        'block-1' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h2&gt;&lt;strong&gt;' . __('Step 1:', WYSIJA) . '&lt;/strong&gt; ' . __('hey, click on this text!', WYSIJA) . '&lt;/h2&gt;' . '&lt;p&gt;' . __('To edit, simply click on this block of text.', WYSIJA) . '&lt;/p&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; null, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; 1, &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-2' =&gt; array_merge(array(&nbsp;</div></li><li><div>                                'position' =&gt; 2, &nbsp;</div></li><li><div>                                'type' =&gt; 'divider'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            $default_divider&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-3' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h2&gt;&lt;strong&gt;' . __('Step 2:', WYSIJA) . '&lt;/strong&gt; ' . __('play with this image', WYSIJA) . '&lt;/h2&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; null, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; 3, &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-4' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;p&gt;' . __('Position your mouse over the image to the left.', WYSIJA) . '&lt;/p&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; array(&nbsp;</div></li><li><div>                                'src' =&gt; WYSIJA_EDITOR_IMG . 'default-newsletter/newsletter/pigeon.png', &nbsp;</div></li><li><div>                                'width' =&gt; 281, &nbsp;</div></li><li><div>                                'height' =&gt; 190, &nbsp;</div></li><li><div>                                'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                                'static' =&gt; false&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; 4, &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-5' =&gt; array_merge(array(&nbsp;</div></li><li><div>                            'position' =&gt; 5, &nbsp;</div></li><li><div>                            'type' =&gt; 'divider'&nbsp;</div></li><li><div> ), $default_divider&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-6' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h2&gt;&lt;strong&gt;' . __('Step 3:', WYSIJA) . '&lt;/strong&gt; ' . __('drop content here', WYSIJA) . '&lt;/h2&gt;' .&nbsp;</div></li><li><div>                                '&lt;p&gt;' . sprintf(__('Drag and drop %1$stext, posts, dividers.%2$s Look on the right!', WYSIJA), '&lt;strong&gt;', '&lt;/strong&gt;') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                                '&lt;p&gt;' . sprintf(__('You can even %1$ssocial bookmarks%2$s like these:', WYSIJA), '&lt;strong&gt;', '&lt;/strong&gt;') . '&lt;/p&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; null, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; 6, &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-7' =&gt; array(&nbsp;</div></li><li><div>                            'width' =&gt; 184, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                            'items' =&gt; array(&nbsp;</div></li><li><div>                                array_merge(array(&nbsp;</div></li><li><div>                                    'url' =&gt; 'http://www.facebook.com/mailpoetplugin', &nbsp;</div></li><li><div>                                    'alt' =&gt; 'Facebook', &nbsp;</div></li><li><div>                                    'cellWidth' =&gt; 61, &nbsp;</div></li><li><div>                                    'cellHeight' =&gt; 32&nbsp;</div></li><li><div> ), $bookmarks['facebook']), &nbsp;</div></li><li><div>                                array_merge(array(&nbsp;</div></li><li><div>                                    'url' =&gt; 'http://www.twitter.com/mail_poet', &nbsp;</div></li><li><div>                                    'alt' =&gt; 'Twitter', &nbsp;</div></li><li><div>                                    'cellWidth' =&gt; 61, &nbsp;</div></li><li><div>                                    'cellHeight' =&gt; 32&nbsp;</div></li><li><div> ), $bookmarks['twitter']), &nbsp;</div></li><li><div>                                array_merge(array(&nbsp;</div></li><li><div>                                    'url' =&gt; 'https://plus.google.com/+Mailpoet', &nbsp;</div></li><li><div>                                    'alt' =&gt; 'Google', &nbsp;</div></li><li><div>                                    'cellWidth' =&gt; 61, &nbsp;</div></li><li><div>                                    'cellHeight' =&gt; 32&nbsp;</div></li><li><div> ), $bookmarks['google'])&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'position' =&gt; 7, &nbsp;</div></li><li><div>                            'type' =&gt; 'gallery'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-8' =&gt; array_merge(array(&nbsp;</div></li><li><div>                            'position' =&gt; 8, &nbsp;</div></li><li><div>                            'type' =&gt; 'divider'&nbsp;</div></li><li><div> ), $default_divider&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'block-9' =&gt; array(&nbsp;</div></li><li><div>                            'text' =&gt; array(&nbsp;</div></li><li><div>                                'value' =&gt; '&lt;h2&gt;&lt;strong&gt;' . __('Step 4:', WYSIJA) . '&lt;/strong&gt; ' . __('and the footer?', WYSIJA) . '&lt;/h2&gt;' .&nbsp;</div></li><li><div>                                '&lt;p&gt;' . sprintf(__('Change the footer\'s content in MailPoet\'s %1$sSettings%2$s page.', WYSIJA), '&lt;strong&gt;', '&lt;/strong&gt;') . '&lt;/p&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            'image' =&gt; null, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'left', &nbsp;</div></li><li><div>                            'static' =&gt; false, &nbsp;</div></li><li><div>                            'position' =&gt; 9, &nbsp;</div></li><li><div>                            'type' =&gt; 'content'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    'footer' =&gt; array(&nbsp;</div></li><li><div>                        'text' =&gt; NULL, &nbsp;</div></li><li><div>                        'image' =&gt; array(&nbsp;</div></li><li><div>                            // 'src' =&gt; WYSIJA_EDITOR_IMG.'default-newsletter/newsletter/footer.png', &nbsp;</div></li><li><div>                            'src' =&gt; WYSIJA_EDITOR_IMG . 'transparent.png', &nbsp;</div></li><li><div>                            'width' =&gt; 600, &nbsp;</div></li><li><div>                            'height' =&gt; 86, &nbsp;</div></li><li><div>                            'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                            'static' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'alignment' =&gt; 'center', &nbsp;</div></li><li><div>                        'static' =&gt; true, &nbsp;</div></li><li><div>                        'type' =&gt; 'footer'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set default styles&nbsp;</div></li><li><div>            $helper_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>            $styles = $helper_engine-&gt;getDefaultStyles();&nbsp;</div></li><li><div>            // end - set default styles&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set theme specific data&nbsp;</div></li><li><div>            if($theme_data['header'] !== null) {&nbsp;</div></li><li><div>                $newwjdata['header'] = $theme_data['header'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if($theme_data['footer'] !== null) {&nbsp;</div></li><li><div>                $newwjdata['footer'] = $theme_data['footer'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if($theme_data['divider'] !== null) {&nbsp;</div></li><li><div>                $newwjdata['widgets'] = array('divider' =&gt; $theme_data['divider']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // end - set theme specific data&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $emaildata['wj_data'] = base64_encode(serialize($newwjdata));&nbsp;</div></li><li><div>            $emaildata['wj_styles'] = base64_encode(serialize($styles));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $email_id = $data['email']['email_id'] = $modelEmail-&gt;insert($emaildata);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(__('Newsletter successfully created.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_saveLists($campaign_id, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['return']))&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=editTemplate&id=' . $email_id);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function saveemail() {&nbsp;</div></li><li><div>        $this-&gt;redirectAfterSave = false;&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $modelEmail = WYSIJA::get(&quot;email&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>        $modelEmail-&gt;fieldValid = false;&nbsp;</div></li><li><div>        $emaildataarr = $modelEmail-&gt;getOne(array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['save-reactivate'])) {&nbsp;</div></li><li><div>            //if the button save and reactivate has been clicked then we reactivate and redirect to the newsletter page&nbsp;</div></li><li><div>            $dataEmail['status'] = 99;&nbsp;</div></li><li><div>            $_REQUEST['return'] = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['return']))&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=editDetails&id=' . $emaildataarr['email_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function savelast() {&nbsp;</div></li><li><div>        $this-&gt;redirectAfterSave = false;&nbsp;</div></li><li><div>        $post_notification = false;&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!isset($_POST['wysija']['email']['from_name']) || !isset($_POST['wysija']['email']['from_email']) || !isset($_POST['wysija']['email']['replyto_name']) || !isset($_POST['wysija']['email']['replyto_email'])) {&nbsp;</div></li><li><div>            $this-&gt;error(__('Information is missing.', WYSIJA));&nbsp;</div></li><li><div>            return $this-&gt;editDetails();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (isset($_REQUEST['wysija']['email']['params']['googletrackingcode']) && $_REQUEST['wysija']['email']['params']['googletrackingcode'] &&&nbsp;</div></li><li><div>                (!is_string($_REQUEST['wysija']['email']['params']['googletrackingcode']) OR&nbsp;</div></li><li><div>                preg_match('#[^a-z0-9_\-\s]#i', $_REQUEST['wysija']['email']['params']['googletrackingcode']) !== 0 )) {&nbsp;</div></li><li><div>            //force to simple text&nbsp;</div></li><li><div>            $_REQUEST['wysija']['email']['params']['googletrackingcode'] = preg_replace('#[^a-z0-9_\-\s]#i', '_', $_REQUEST['wysija']['email']['params']['googletrackingcode']);&nbsp;</div></li><li><div>            $this-&gt;error(__('Your Google Campaign can only contain latin characters, numbers, spaces and hyphens!', WYSIJA), 1);&nbsp;</div></li><li><div>            return $this-&gt;editDetails();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $update_email = array(&nbsp;</div></li><li><div>            'email_id' =&gt; $_POST['wysija']['email']['email_id'], &nbsp;</div></li><li><div>            'from_name' =&gt; $_POST['wysija']['email']['from_name'], &nbsp;</div></li><li><div>            'from_email' =&gt; $_POST['wysija']['email']['from_email'], &nbsp;</div></li><li><div>            'replyto_name' =&gt; $_POST['wysija']['email']['replyto_name'], &nbsp;</div></li><li><div>            'replyto_email' =&gt; $_POST['wysija']['email']['replyto_email'], &nbsp;</div></li><li><div>            'subject' =&gt; $_POST['wysija']['email']['subject'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        if (isset($_POST['wysija']['email']['params']))&nbsp;</div></li><li><div>            $update_email['params'] = $_POST['wysija']['email']['params'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //insert into campaigns lists&nbsp;</div></li><li><div>        $this-&gt;_saveLists($_POST['wysija']['campaign']['campaign_id']);&nbsp;</div></li><li><div>        $email_data = $model_email-&gt;getOne($_POST['wysija']['email']['email_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if we just save the draf we don't go through the big sending process setup&nbsp;</div></li><li><div>        if (isset($_POST['submit-draft']) || isset($_POST['submit-pause']) || (isset($_REQUEST['wj_redir']) && $_REQUEST['wj_redir'] == 'savelastback')) {&nbsp;</div></li><li><div>            if (isset($_POST['wysija']['email']['params']['schedule']['isscheduled']))&nbsp;</div></li><li><div>                $this-&gt;notice(__('Newsletter has been scheduled.', WYSIJA));&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                $this-&gt;notice(__('Newsletter has been saved as a draft.', WYSIJA));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (isset($_POST['submit-draft'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $update_email['status'] = 0;// Email is being stored as draft&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (isset($update_email['params']['schedule']['isscheduled'])) {&nbsp;</div></li><li><div>                    // draft emails should not be scheduled, clear any schedules&nbsp;</div></li><li><div>                    unset($update_email['params']['schedule']['isscheduled']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            // we update the param attribute with what's has been posted&nbsp;</div></li><li><div>            foreach ($update_email as $ki =&gt; $vi) {&nbsp;</div></li><li><div>                if ($ki == 'params') {&nbsp;</div></li><li><div>                    foreach ($vi as $parake =&gt; $paraval) {&nbsp;</div></li><li><div>                        $email_data['params'][$parake] = $paraval;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $update_email[$ki] = $email_data[$ki];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $email_data[$ki] = $vi;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if the checkbox to ignore retroactivity is  here we just tell the class&nbsp;</div></li><li><div>            if (isset($_POST['wysija']['email']['ignore_subscribers'])) {&nbsp;</div></li><li><div>                $model_email-&gt;retro_active_autoresponders = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // activate or send the email depending on the typ&nbsp;</div></li><li><div>            $model_email-&gt;send_activate($email_data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update email&nbsp;</div></li><li><div>        $update_email['type'] = $email_data['type'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($post_notification) {&nbsp;</div></li><li><div>            $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>            $update_email['params']['autonl']['nextSend'] = $helper_autonews-&gt;getNextSend($update_email);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_email-&gt;reset();&nbsp;</div></li><li><div>        $model_email-&gt;columns['modified_at']['autoup'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update some fields of the email&nbsp;</div></li><li><div>        $model_email-&gt;update($update_email);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update the campaign subject which ispretty much useless but good to keep in sync with the email&nbsp;</div></li><li><div>        $model_campaign = WYSIJA::get('campaign', 'model');&nbsp;</div></li><li><div>        $model_campaign-&gt;reset();&nbsp;</div></li><li><div>        $update_campaign = array('campaign_id' =&gt; $_REQUEST['id'], 'name' =&gt; $_POST['wysija']['email']['subject']);&nbsp;</div></li><li><div>        $model_campaign-&gt;update($update_campaign);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['wj_redir']) && $_REQUEST['wj_redir'] == 'savelastback') {&nbsp;</div></li><li><div>            return $this-&gt;redirect('admin.php?page=wysija_campaigns&action=editTemplate&id=' . $_POST['wysija']['email']['email_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            return $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _saveLists($campaignId, $flagup = false) {&nbsp;</div></li><li><div>        //record the list that we have in that campaign&nbsp;</div></li><li><div>        $modelCampL = WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>        if ($flagup || (int) $campaignId &gt; 0) {&nbsp;</div></li><li><div>            $modelCampL-&gt;delete(array('equal' =&gt; array('campaign_id' =&gt; $campaignId)));&nbsp;</div></li><li><div>            $modelCampL-&gt;reset();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_POST['wysija']['campaign_list']['list_id'])) {&nbsp;</div></li><li><div>            //$modelCampL=WYSIJA::get(&quot;campaign_list&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>            foreach ($_POST['wysija']['campaign_list']['list_id'] as $listid) {&nbsp;</div></li><li><div>                $modelCampL-&gt;insert(array('campaign_id' =&gt; $campaignId, &quot;list_id&quot; =&gt; $listid));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _addLinkFilter($status, $type = 'status') {&nbsp;</div></li><li><div>        switch ($type) {&nbsp;</div></li><li><div>            case 'status':&nbsp;</div></li><li><div>                switch ($status) {&nbsp;</div></li><li><div>                    case 'draft':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('status' =&gt; 0);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'sending':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('status' =&gt; 99);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'sent':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('status' =&gt; 2);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'paused':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('status' =&gt; -1);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'scheduled':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('status' =&gt; 4);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'type':&nbsp;</div></li><li><div>                switch ($status) {&nbsp;</div></li><li><div>                    case 'regular':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('type' =&gt; 1);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'autonl':&nbsp;</div></li><li><div>                        $this-&gt;filters['equal'] = array('type' =&gt; 2);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all campaigns, based on the filters&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_campaigns() {&nbsp;</div></li><li><div>        $order_by = ' ORDER BY ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['orderby'])) {&nbsp;</div></li><li><div>            if (!is_string($_REQUEST['orderby']) OR preg_match('|[^a-z0-9#_.-]|i', $_REQUEST['orderby']) !== 0) {&nbsp;</div></li><li><div>                $_REQUEST['orderby'] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (!in_array(strtoupper($_REQUEST['ordert']), array('DESC', 'ASC'))) {&nbsp;</div></li><li><div>                            $_REQUEST['ordert'] = 'DESC';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>            $order_by.=$_REQUEST['orderby'] . ' ' . $_REQUEST['ordert'];&nbsp;</div></li><li><div>        }else {&nbsp;</div></li><li><div>            $order_by.='FIELD(B.status, 99, 3, 1, 0, 2), ';&nbsp;</div></li><li><div>            $order_by.='B.status desc, ';&nbsp;</div></li><li><div>            $order_by.='B.modified_at desc, ';&nbsp;</div></li><li><div>            $order_by.='B.sent_at desc, ';&nbsp;</div></li><li><div>            $order_by.='B.type desc, ';&nbsp;</div></li><li><div>            $order_by.='A.' . $this-&gt;modelObj-&gt;getPk() . ' DESC';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                A.`campaign_id`, &nbsp;</div></li><li><div>                A.`name` as `campaign_name`, &nbsp;</div></li><li><div>                B.`subject` as `name`, &nbsp;</div></li><li><div>                A.`description`, &nbsp;</div></li><li><div>                B.`params`, &nbsp;</div></li><li><div>                B.`type`, &nbsp;</div></li><li><div>                B.`number_sent`, &nbsp;</div></li><li><div>                B.`number_opened`, &nbsp;</div></li><li><div>                B.`number_clicked`, &nbsp;</div></li><li><div>                B.`number_unsub`, &nbsp;</div></li><li><div>            (B.`number_sent` +&nbsp;</div></li><li><div>            B.`number_opened` +&nbsp;</div></li><li><div>            B.`number_clicked` +&nbsp;</div></li><li><div>            B.`number_unsub` +&nbsp;</div></li><li><div>            B.`number_bounce` +&nbsp;</div></li><li><div>            B.`number_forward`&nbsp;</div></li><li><div> ) AS `number_total`, &nbsp;</div></li><li><div>                B.`status`, &nbsp;</div></li><li><div>                B.`created_at`, &nbsp;</div></li><li><div>                B.`modified_at`, &nbsp;</div></li><li><div>                B.`sent_at`, &nbsp;</div></li><li><div>                B.`email_id`&nbsp;</div></li><li><div>            FROM&nbsp;</div></li><li><div>                `[wysija]' . $this-&gt;modelObj-&gt;table_name . '` AS A&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]email` AS B on A.`campaign_id` = B.`campaign_id`&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]campaign_list` AS C on A.`campaign_id` = C.`campaign_id`';&nbsp;</div></li><li><div>        $campaigns = $this-&gt;modelObj-&gt;getResults($query . $this-&gt;modelObj-&gt;makeWhere() . ' GROUP BY B.email_id' . $order_by . $this-&gt;modelObj-&gt;setLimit());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // calculate percetange of open / click / unsubscribe&nbsp;</div></li><li><div>        $helper_numbers = WYSIJA::get('numbers', 'helper');&nbsp;</div></li><li><div>        foreach ($campaigns as &$campaign) {&nbsp;</div></li><li><div>            // open rate, based on sent number&nbsp;</div></li><li><div>            $campaign['rate_opened'] = $helper_numbers-&gt;calculate_percetage($campaign['number_opened'], $campaign['number_total'], 1);&nbsp;</div></li><li><div>            // click rate, based on opened number&nbsp;</div></li><li><div>            $campaign['rate_clicked'] = $helper_numbers-&gt;calculate_percetage($campaign['number_clicked'], $campaign['number_total'], 1);&nbsp;</div></li><li><div>            // unsubscribe rate, based on opened number&nbsp;</div></li><li><div>            $campaign['rate_unsub'] = $helper_numbers-&gt;calculate_percetage($campaign['number_unsub'], $campaign['number_total'], 1);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $campaigns;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the first campaign in history&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_oldest_compaign() {&nbsp;</div></li><li><div>        $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                MIN(B.created_at) as datemin&nbsp;</div></li><li><div>            FROM `[wysija]' . $this-&gt;modelObj-&gt;table_name . '` as A&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]email` AS B on A.campaign_id = B.campaign_id&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]campaign_list` as C on A.campaign_id = C.campaign_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;modelObj-&gt;query('get_row', $query . $this-&gt;modelObj-&gt;makeWhere());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Count ALL emails of each email-status&nbsp;</div></li><li><div>     * @todo: move to model&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function count_emails_by_status() {&nbsp;</div></li><li><div>       $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                COUNT(`email_id`) AS `campaigns`, &nbsp;</div></li><li><div>                `status`&nbsp;</div></li><li><div>            FROM&nbsp;</div></li><li><div>                `[wysija]email`&nbsp;</div></li><li><div>            WHERE&nbsp;</div></li><li><div>                `campaign_id` &gt; 0&nbsp;</div></li><li><div>            GROUP BY `status`';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $countss = $this-&gt;modelObj-&gt;query('get_res', $query);&nbsp;</div></li><li><div>        $counts = array();&nbsp;</div></li><li><div>        $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($countss as $count) {&nbsp;</div></li><li><div>            switch ($count['status']) {&nbsp;</div></li><li><div>                case '0':&nbsp;</div></li><li><div>                    $type = 'draft';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '1':&nbsp;</div></li><li><div>                case '3':&nbsp;</div></li><li><div>                case '99':&nbsp;</div></li><li><div>                    $type = 'sending';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '2':&nbsp;</div></li><li><div>                    $type = 'sent';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '-1':&nbsp;</div></li><li><div>                    $type = 'paused';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '4':&nbsp;</div></li><li><div>                    $type = 'scheduled';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $total = $total + $count['campaigns'];&nbsp;</div></li><li><div>            $counts['status-' . $type] = $count['campaigns'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $counts;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Count emails which matched the filters&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function count_emails() {&nbsp;</div></li><li><div>        $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                COUNT(DISTINCT B.`email_id`) AS `campaigns`&nbsp;</div></li><li><div>            FROM&nbsp;</div></li><li><div>                `[wysija]' . $this-&gt;modelObj-&gt;table_name . '` AS A&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]email` AS B ON A.`campaign_id` = B.`campaign_id`&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]campaign_list` AS C ON A.`campaign_id` = C.`campaign_id`';&nbsp;</div></li><li><div>        return $this-&gt;modelObj-&gt;count($query . $this-&gt;modelObj-&gt;makeWhere(), 'campaigns');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Count ALL emails of each type of email&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function count_emails_by_type() {&nbsp;</div></li><li><div>        $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                COUNT(`email_id`) AS `campaigns`, &nbsp;</div></li><li><div>                `type`&nbsp;</div></li><li><div>            FROM&nbsp;</div></li><li><div>                `[wysija]email`&nbsp;</div></li><li><div>            WHERE&nbsp;</div></li><li><div>                `campaign_id` &gt; 0&nbsp;</div></li><li><div>            GROUP BY `type`';&nbsp;</div></li><li><div>        $countss = $this-&gt;modelObj-&gt;query('get_res', $query, ARRAY_A);&nbsp;</div></li><li><div>        $counts = array();&nbsp;</div></li><li><div>        foreach ($countss as $count) {&nbsp;</div></li><li><div>            switch ($count['type']) {&nbsp;</div></li><li><div>                case '1':&nbsp;</div></li><li><div>                    $type = 'regular';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '2':&nbsp;</div></li><li><div>                    $type = 'autonl';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $counts['type-' . $type] = $count['campaigns'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $counts;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all existing lists&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_lists() {&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $query = '&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>                A.`list_id`, &nbsp;</div></li><li><div>                A.`name`, &nbsp;</div></li><li><div>                A.`is_enabled`, &nbsp;</div></li><li><div>                COUNT( B.`campaign_id` ) AS `users`&nbsp;</div></li><li><div>            FROM&nbsp;</div></li><li><div>                `[wysija]' . $model_list-&gt;table_name . '` as A&nbsp;</div></li><li><div>            LEFT JOIN&nbsp;</div></li><li><div>                `[wysija]campaign_list` AS B on A.`list_id` = B.`list_id`&nbsp;</div></li><li><div>            GROUP BY A.`list_id`';&nbsp;</div></li><li><div>        $result = $model_list-&gt;getResults($query);&nbsp;</div></li><li><div>        $lists = array();&nbsp;</div></li><li><div>        foreach ($result as $list_obj) {&nbsp;</div></li><li><div>            $lists[$list_obj['list_id']] = $list_obj;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $lists;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function defaultDisplay() {&nbsp;</div></li><li><div>        $this-&gt;data['base_url'] = $this-&gt;base_url . '?' . http_build_query($_REQUEST); // saved filter&nbsp;</div></li><li><div>        $this-&gt;title = __('Newsletters', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow = $this-&gt;action = 'main';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;jsTrans[&quot;selecmiss&quot;] = __('Please select a newsletter.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['suredelete'] = __('Delete this newsletter for ever?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['suredelete_bulk'] = __('Delete these newsletters for ever?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['processqueue'] = __('Sending batch of emails...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['viewnews'] = __('View newsletter', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['confirmpauseedit'] = __('The newsletter will be deactivated, you will need to reactivate it once you\'re over editing it. Do you want to proceed?', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get the filters&nbsp;</div></li><li><div>        if (isset($_REQUEST['search']) && $_REQUEST['search']) {&nbsp;</div></li><li><div>            $this-&gt;filters['like'] = array();&nbsp;</div></li><li><div>            foreach ($this-&gt;searchable as $field)&nbsp;</div></li><li><div>                $this-&gt;filters['like'][$field] = $_REQUEST['search'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['filter-list']) && $_REQUEST['filter-list']) {&nbsp;</div></li><li><div>            $this-&gt;filters['equal'] = array('C.list_id' =&gt; $_REQUEST['filter-list']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['filter-date']) && $_REQUEST['filter-date']) {&nbsp;</div></li><li><div>            $this-&gt;filters['greater_eq'] = array('created_at' =&gt; $_REQUEST['filter-date']);&nbsp;</div></li><li><div>            $this-&gt;filters['less_eq'] = array('created_at' =&gt; strtotime('+1 month', $_REQUEST['filter-date']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;filters['is'] = array('type' =&gt; 'IS NOT NULL');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_REQUEST['link_filter']) && $_REQUEST['link_filter']) {&nbsp;</div></li><li><div>            $linkfilters = explode('-', $_REQUEST['link_filter']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (count($linkfilters) &gt; 1) {&nbsp;</div></li><li><div>                $this-&gt;_addLinkFilter($linkfilters[1], $linkfilters[0]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;_addLinkFilter($_REQUEST['link_filter']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;noCheck = true;&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>        if ($this-&gt;filters) {&nbsp;</div></li><li><div>                    $this-&gt;modelObj-&gt;setConditions($this-&gt;filters);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Count emails by status and type&nbsp;</div></li><li><div>        $emails_by_status = $this-&gt;count_emails_by_status();&nbsp;</div></li><li><div>        $emails_by_type = $this-&gt;count_emails_by_type();&nbsp;</div></li><li><div>        $counts = array_merge($emails_by_status, $emails_by_type);&nbsp;</div></li><li><div>        $counts['all'] = array_sum($emails_by_status);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // collect data&nbsp;</div></li><li><div>        $this-&gt;data['campaigns'] = $this-&gt;get_campaigns();&nbsp;</div></li><li><div>        $this-&gt;data['datemin'] = $this-&gt;get_oldest_compaign();&nbsp;</div></li><li><div>        $lists = $this-&gt;get_lists(); // $lists is in use later within this scope&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $lists;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // for paging&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;countRows = $counts['all'];&nbsp;</div></li><li><div>                if ($this-&gt;filters) {&nbsp;</div></li><li><div>                    $count_emails = $this-&gt;count_emails();&nbsp;</div></li><li><div>                    if( !empty($count_emails) ) {&nbsp;</div></li><li><div>                        $this-&gt;modelObj-&gt;countRows = $count_emails;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // count queue&nbsp;</div></li><li><div>        $email_ids = array();&nbsp;</div></li><li><div>        foreach ($this-&gt;data['campaigns'] as $emailcamp) {&nbsp;</div></li><li><div>            if (in_array($emailcamp['status'], array(1, 3, 99)))&nbsp;</div></li><li><div>                $email_ids[] = $emailcamp['email_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $model_queue = WYSIJA::get('queue', 'model');&nbsp;</div></li><li><div>        $model_queue-&gt;setConditions(array(&quot;email_id&quot; =&gt; $email_ids));&nbsp;</div></li><li><div>        $model_queue-&gt;groupBy('email_id');&nbsp;</div></li><li><div>        $queue = $model_queue-&gt;count();&nbsp;</div></li><li><div>        if ($queue) {&nbsp;</div></li><li><div>            $this-&gt;viewObj-&gt;queuedemails = $queue;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //make a loop from the first created to now and increment an array of months&nbsp;</div></li><li><div>        $now = time();&nbsp;</div></li><li><div>        $this-&gt;data['dates'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ((int) $this-&gt;data['datemin']['datemin'] &gt; 1) {&nbsp;</div></li><li><div>            setlocale(LC_TIME, 'en_US');&nbsp;</div></li><li><div>            $formtlettres = &quot;1 &quot; . date('F', $this-&gt;data['datemin']['datemin']) . ' ' . date(&quot;Y&quot;, $this-&gt;data['datemin']['datemin']);&nbsp;</div></li><li><div>            $month_start = strtotime($formtlettres);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($month_start &gt; 0) {&nbsp;</div></li><li><div>                for ($i = $month_start; $i &lt; $now; $i = strtotime('+1 month', $i)) {&nbsp;</div></li><li><div>                    $this-&gt;data['dates'][$i] = date_i18n('F Y', $i); //date('F Y', $i);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $campaign_ids_sent = $campaign_ids = array();&nbsp;</div></li><li><div>        foreach ($this-&gt;data['campaigns'] as &$campaign) {&nbsp;</div></li><li><div>            $campaign_ids[] = $campaign['campaign_id'];&nbsp;</div></li><li><div>            $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $model_email-&gt;getParams($campaign);&nbsp;</div></li><li><div>            if (in_array((int) $campaign['status'], array(-1, 1, 2, 3, 99)))&nbsp;</div></li><li><div>                $campaign_ids_sent[] = $campaign['campaign_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 3 - campaign_list request & count request for queue */&nbsp;</div></li><li><div>        if ($campaign_ids) {&nbsp;</div></li><li><div>            $model_campaign_list = WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>            $userlists = $model_campaign_list-&gt;get(array('list_id', 'campaign_id'), array('campaign_id' =&gt; $campaign_ids));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($campaign_ids_sent) {&nbsp;</div></li><li><div>                $model_campaign_list = WYSIJA::get(&quot;email_user_stat&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>                $statstotal = $model_campaign_list-&gt;getResults(&quot;SELECT COUNT(A.user_id) as count, B.email_id FROM `[wysija]queue` as A&nbsp;</div></li><li><div>                     JOIN `[wysija]email` as B on A.email_id=B.email_id&nbsp;</div></li><li><div>                        WHERE B.campaign_id IN (&quot; . implode(&quot;, &quot;, $campaign_ids_sent) . &quot;) group by B.email_id&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $senttotalgroupedby = $model_campaign_list-&gt;getResults(&quot;SELECT COUNT(A.user_id) as count, B.campaign_id, B.email_id, B.type, B.status, A.status as statususer FROM `[wysija]&quot; . $model_campaign_list-&gt;table_name . &quot;` as A&nbsp;</div></li><li><div>                     JOIN `[wysija]email` as B on A.email_id=B.email_id&nbsp;</div></li><li><div>                        WHERE B.campaign_id IN (&quot; . implode(&quot;, &quot;, $campaign_ids_sent) . &quot;) group by A.status, B.email_id&quot;); //, A.status&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $updateEmail = array();&nbsp;</div></li><li><div>                $columnnamestatus = array(0 =&gt; &quot;number_sent&quot;, 1 =&gt; &quot;number_opened&quot;, 2 =&gt; &quot;number_clicked&quot;, 3 =&gt; &quot;number_unsub&quot;, -1 =&gt; &quot;number_bounce&quot;);&nbsp;</div></li><li><div>                foreach ($senttotalgroupedby as $sentbystatus) {&nbsp;</div></li><li><div>                    if ($sentbystatus['statususer'] != &quot;-2&quot;)&nbsp;</div></li><li><div>                        $updateEmail[$sentbystatus['email_id']][$columnnamestatus[$sentbystatus['statususer']]] = $sentbystatus['count'];&nbsp;</div></li><li><div>                    if (isset($senttotal[$sentbystatus['email_id']])) {&nbsp;</div></li><li><div>                        $senttotal[$sentbystatus['email_id']]['count'] = (int) $senttotal[$sentbystatus['email_id']]['count'] + (int) $sentbystatus['count'];&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        unset($sentbystatus['statususer']);&nbsp;</div></li><li><div>                        $senttotal[$sentbystatus['email_id']] = $sentbystatus;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ($updateEmail as $emailid =&gt; $update) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ($columnnamestatus as $v) {&nbsp;</div></li><li><div>                        if (!isset($update[$v]))&nbsp;</div></li><li><div>                            $update[$v] = 0;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $model_email-&gt;update($update, array('email_id' =&gt; $emailid));&nbsp;</div></li><li><div>                    $model_email-&gt;reset();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>                $running = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $is_multisite = is_multisite();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($is_multisite && $model_config-&gt;getValue('sending_method') == 'network') {&nbsp;</div></li><li><div>                    $sending_emails_each = $model_config-&gt;getValue('ms_sending_emails_each');&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $sending_emails_each = $model_config-&gt;getValue('sending_emails_each');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($model_config-&gt;getValue('cron_manual')) {&nbsp;</div></li><li><div>                    $formsHelp = WYSIJA::get('forms', 'helper');&nbsp;</div></li><li><div>                    $queue_frequency = $formsHelp-&gt;eachValuesSec[$sending_emails_each];&nbsp;</div></li><li><div>                    $queue_scheduled = WYSIJA::get_cron_schedule('queue');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $next_scheduled_queue = $queue_scheduled['next_schedule'];&nbsp;</div></li><li><div>                    $running = $queue_scheduled['running'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($running) {&nbsp;</div></li><li><div>                        $helper_toolbox = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>                        $running = time() - $running;&nbsp;</div></li><li><div>                        $running = $helper_toolbox-&gt;duration_string($running, true, 4);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $schedules = wp_get_schedules();&nbsp;</div></li><li><div>                    $queue_frequency = $schedules[wp_get_schedule('wysija_cron_queue')]['interval'];&nbsp;</div></li><li><div>                    $next_scheduled_queue = wp_next_scheduled('wysija_cron_queue');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $status_sent_complete = array();&nbsp;</div></li><li><div>                if (isset($senttotal) && $senttotal) {&nbsp;</div></li><li><div>                    foreach ($senttotal as $sentot) {&nbsp;</div></li><li><div>                        if ($sentot) {&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$sentot['email_id']]['total'] = $sentot['count'];&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$sentot['email_id']]['to'] = $sentot['count'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$sentot['email_id']]['total'] = $this-&gt;data['sent'][$sentot['email_id']]['to'] = 0;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;data['sent'][$sentot['email_id']]['status'] = $sentot['status'];&nbsp;</div></li><li><div>                        $this-&gt;data['sent'][$sentot['email_id']]['type'] = $sentot['type'];&nbsp;</div></li><li><div>                        $this-&gt;data['sent'][$sentot['email_id']]['left'] = (int) $this-&gt;data['sent'][$sentot['email_id']]['total'] - (int) $this-&gt;data['sent'][$sentot['email_id']]['to'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ($statstotal as $sentot) {&nbsp;</div></li><li><div>                    if (!isset($this-&gt;data['sent'][$sentot['email_id']])) {&nbsp;</div></li><li><div>                        $this-&gt;data['sent'][$sentot['email_id']]['total'] = 0;&nbsp;</div></li><li><div>                        $this-&gt;data['sent'][$sentot['email_id']]['to'] = 0;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $this-&gt;data['sent'][$sentot['email_id']]['total'] = $this-&gt;data['sent'][$sentot['email_id']]['total'] + $sentot['count'];&nbsp;</div></li><li><div>                    $this-&gt;data['sent'][$sentot['email_id']]['left'] = (int) $this-&gt;data['sent'][$sentot['email_id']]['total'] - (int) $this-&gt;data['sent'][$sentot['email_id']]['to'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($is_multisite && $model_config-&gt;getValue('sending_method') == 'network') {&nbsp;</div></li><li><div>                    $sending_emails_number = $model_config-&gt;getValue('ms_sending_emails_number');&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $sending_emails_number = $model_config-&gt;getValue('sending_emails_number');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (isset($this-&gt;data['sent'])) {&nbsp;</div></li><li><div>                    foreach ($this-&gt;data['sent'] as $key =&gt; &$camp) {&nbsp;</div></li><li><div>                        if ($this-&gt;data['sent'][$key]['left'] &gt; 0) {&nbsp;</div></li><li><div>                            $cronsneeded = ceil($this-&gt;data['sent'][$key]['left'] / $sending_emails_number);&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$key]['remaining_time'] = $cronsneeded * $queue_frequency;&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$key]['running_for'] = $running;&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$key]['next_batch'] = $next_scheduled_queue - time();&nbsp;</div></li><li><div>                            $this-&gt;data['sent'][$key]['remaining_time'] = $this-&gt;data['sent'][$key]['remaining_time'] - ($queue_frequency) + $this-&gt;data['sent'][$key]['next_batch'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ((in_array($this-&gt;data['sent'][$key]['status'], array(1, 3, 99))) && $this-&gt;data['sent'][$key]['type'] == 1)&nbsp;</div></li><li><div>                                $status_sent_complete[] = $key;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // status update to sent for the one that are sent&nbsp;</div></li><li><div>                if (count($status_sent_complete) &gt; 0) {&nbsp;</div></li><li><div>                    $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>                    $model_email-&gt;noCheck = true;&nbsp;</div></li><li><div>                    $model_email-&gt;reset();&nbsp;</div></li><li><div>                    $model_email-&gt;update(array('status' =&gt; 2), array('equal' =&gt; array('email_id' =&gt; $status_sent_complete)));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['counts'] = array_reverse($counts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // regrouping all the data in the same array&nbsp;</div></li><li><div>        foreach ($this-&gt;data['campaigns'] as &$campaign) {&nbsp;</div></li><li><div>            // default key while we don't have the data&nbsp;</div></li><li><div>            //TODO add data for stats about emails opened clicked etc&nbsp;</div></li><li><div>            $campaign[&quot;emails&quot;] = 0;&nbsp;</div></li><li><div>            $campaign[&quot;opened&quot;] = 0;&nbsp;</div></li><li><div>            $campaign[&quot;clicked&quot;] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($userlists) {&nbsp;</div></li><li><div>                foreach ($userlists as $key =&gt; $userlist) {&nbsp;</div></li><li><div>                    if ($campaign[&quot;campaign_id&quot;] == $userlist[&quot;campaign_id&quot;] && isset($lists[$userlist[&quot;list_id&quot;]])) {&nbsp;</div></li><li><div>                        if (!isset($campaign[&quot;lists&quot;]))&nbsp;</div></li><li><div>                            $campaign[&quot;lists&quot;] = $lists[$userlist[&quot;list_id&quot;]][&quot;name&quot;];&nbsp;</div></li><li><div>                        else&nbsp;</div></li><li><div>                            $campaign[&quot;lists&quot;].=&quot;, &quot; . $lists[$userlist[&quot;list_id&quot;]][&quot;name&quot;];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (isset($campaign[&quot;lists&quot;]) && !$campaign[&quot;lists&quot;])&nbsp;</div></li><li><div>                unset($campaign[&quot;lists&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (((isset($campaign['params']['schedule']['isscheduled']) ||&nbsp;</div></li><li><div>                    ($campaign['type'] == 2 && isset($campaign['params']['autonl']['event']) && in_array($campaign['params']['autonl']['event'], array('new-articles'/** , 'subs-2-nl' */)))&nbsp;</div></li><li><div> ) && $campaign['status'] != 2 && !isset($campaign[&quot;lists&quot;])) || ($campaign['type'] == 2 && isset($campaign['params']['autonl']['event']) && in_array($campaign['params']['autonl']['event'], array('subs-2-nl')) && $campaign['status'] != 2 && (!isset($campaign['params']['autonl']['subscribetolist']) || !isset($lists[$campaign['params']['autonl']['subscribetolist']]) ))&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $campaign['classRow'] = &quot; listmissing &quot;;&nbsp;</div></li><li><div>                $campaign['msgListEdit'] = '&lt;strong&gt;' . __('The list has been deleted.', WYSIJA) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>                $campaign['msgSendSuspended'] = '&lt;strong&gt;' . __('Sending suspended.', WYSIJA) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;dataAutoNl();&nbsp;</div></li><li><div>        if (!$this-&gt;data['campaigns']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('There are no newsletters.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function setviewStatsfilter() {&nbsp;</div></li><li><div>        // get the filters&nbsp;</div></li><li><div>        $this-&gt;searchable = array(&quot;email&quot;, &quot;firstname&quot;, &quot;lastname&quot;);&nbsp;</div></li><li><div>        $this-&gt;filters = array();&nbsp;</div></li><li><div>        if (isset($_REQUEST['search']) && $_REQUEST['search']) {&nbsp;</div></li><li><div>            $this-&gt;filters[&quot;like&quot;] = array();&nbsp;</div></li><li><div>            foreach ($this-&gt;searchable as $field)&nbsp;</div></li><li><div>                $this-&gt;filters[&quot;like&quot;][$field] = $_REQUEST['search'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;tableQuery = 'email_user_stat';&nbsp;</div></li><li><div>        $this-&gt;statusemail = 'B.status as umstatus';&nbsp;</div></li><li><div>        if (isset($_REQUEST['link_filter']) && $_REQUEST['link_filter']) {&nbsp;</div></li><li><div>            switch ($_REQUEST['link_filter']) {&nbsp;</div></li><li><div>                case 'inqueue':&nbsp;</div></li><li><div>                    $this-&gt;tableQuery = 'queue';&nbsp;</div></li><li><div>                    $this-&gt;statusemail = '-2 as umstatus';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'sent':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; 0);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'bounced':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; -1);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'opened':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; 1);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'clicked':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; 2);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'unsubscribe':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; 3);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'notsent':&nbsp;</div></li><li><div>                    $this-&gt;filters['equal'] = array('B.status' =&gt; -2);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // filter by url id&nbsp;</div></li><li><div>        if (isset($_REQUEST['url_id']) && (int) $_REQUEST['url_id'] &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;tableQuery = 'email_user_url';&nbsp;</div></li><li><div>            $this-&gt;filters['equal'] = array('B.url_id' =&gt; (int) $_REQUEST['url_id']);&nbsp;</div></li><li><div>            $this-&gt;statusemail = '2 as umstatus'; //by default, when filter by url_id, all subscribers had clicked&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function viewstats() {&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-charts';&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'viewstats';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj = WYSIJA::get(&quot;email&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;limitON = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_object = $this-&gt;modelObj-&gt;getOne(false, array(&quot;email_id&quot; =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>                if(empty($email_object)) {&nbsp;</div></li><li><div>                    $this-&gt;redirect('admin.php?page=wysija_campaigns');&nbsp;</div></li><li><div>                    return;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;model = $this-&gt;modelObj;&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;namecampaign = $email_object['subject'];&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = sprintf(__('Stats : %1$s', WYSIJA), $email_object['subject']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modelObjCamp = WYSIJA::get(&quot;campaign&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>        $limit_pp = false;&nbsp;</div></li><li><div>        if (isset($modelObjCamp-&gt;limit_pp))&nbsp;</div></li><li><div>            $limit_pp = $modelObjCamp-&gt;limit_pp;&nbsp;</div></li><li><div>        $modelObjCamp-&gt;limitON = false;&nbsp;</div></li><li><div>        $campaign = $modelObjCamp-&gt;getOne(false, array(&quot;campaign_id&quot; =&gt; $email_object['campaign_id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;setviewStatsfilter();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;noCheck = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 0 - counting request&nbsp;</div></li><li><div>        $queryCmmonStart = 'SELECT count(distinct B.user_id) as users FROM `[wysija]user` as A';&nbsp;</div></li><li><div>        $queryCmmonStart.=' LEFT JOIN `[wysija]' . $this-&gt;tableQuery . '` as B on A.user_id=B.user_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // all the counts query&nbsp;</div></li><li><div>        $query = &quot;SELECT count(user_id) as users, status FROM `[wysija]email_user_stat` as A&nbsp;</div></li><li><div>            WHERE A.email_id=&quot; . $email_object['email_id'] . &quot; GROUP BY status&quot;;&nbsp;</div></li><li><div>        $countss = $this-&gt;modelObj-&gt;query(&quot;get_res&quot;, $query, ARRAY_A);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we also count what is in the queue&nbsp;</div></li><li><div>        $query = &quot;SELECT count(user_id) as users FROM `[wysija]queue` as A&nbsp;</div></li><li><div>            WHERE A.email_id=&quot; . $email_object['email_id'];&nbsp;</div></li><li><div>        $countss[-2]['status'] = -3;&nbsp;</div></li><li><div>        $countss[-2]['users'] = $this-&gt;modelObj-&gt;count($query, 'users');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $counts = array();&nbsp;</div></li><li><div>        $truetotal = $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($countss as $count) {&nbsp;</div></li><li><div>            switch ($count['status']) {&nbsp;</div></li><li><div>                case &quot;-3&quot;:&nbsp;</div></li><li><div>                    $type = 'inqueue';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;-2&quot;:&nbsp;</div></li><li><div>                    $type = 'notsent';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;-1&quot;:&nbsp;</div></li><li><div>                    $type = 'bounced';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;0&quot;:&nbsp;</div></li><li><div>                    $type = 'sent';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;1&quot;:&nbsp;</div></li><li><div>                    $type = 'opened';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;2&quot;:&nbsp;</div></li><li><div>                    $type = 'clicked';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case &quot;3&quot;:&nbsp;</div></li><li><div>                    $type = 'unsubscribe';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($count['status'] != &quot;-2&quot;)&nbsp;</div></li><li><div>                $total = $total + $count['users'];&nbsp;</div></li><li><div>            $truetotal = $truetotal + $count['users'];&nbsp;</div></li><li><div>            $counts[$type] = $count['users'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $counts['allsent'] = $total;&nbsp;</div></li><li><div>        $counts['all'] = $truetotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>        $this-&gt;filters['equal'][&quot;B.email_id&quot;] = $email_object['email_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;noCheck = true;&nbsp;</div></li><li><div>        if ($this-&gt;filters) {&nbsp;</div></li><li><div>                        $this-&gt;modelObj-&gt;setConditions($this-&gt;filters);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 1 - subscriber request&nbsp;</div></li><li><div>        $query = 'SELECT A.user_id, A.firstname, A.lastname, A.status as ustatus, ' . $this-&gt;statusemail . ' , A.email, B.* FROM `[wysija]user` as A';&nbsp;</div></li><li><div>        $query.=' LEFT JOIN `[wysija]' . $this-&gt;tableQuery . '` as B on A.user_id=B.user_id';&nbsp;</div></li><li><div>        $queryFinal = $this-&gt;modelObj-&gt;makeWhere();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // without filter we already have the total number of subscribers&nbsp;</div></li><li><div>        if ($this-&gt;filters)&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows = $this-&gt;modelObj-&gt;count($queryCmmonStart . $queryFinal, 'users');&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows = $counts['all'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $orderby = '';&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Until now, we have&nbsp;</div></li><li><div>         * - 3 possible values of $this-&gt;tableQuery (queue, email_user_url, email_user_stat), set by $this-&gt;setviewStatsfilter()&nbsp;</div></li><li><div>         * - 2 possible values of $_REQUEST['orderby']&nbsp;</div></li><li><div>         * =&gt; 3x2 = 6 cases&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if (isset($_REQUEST['orderby'])) {&nbsp;</div></li><li><div>            switch ($this-&gt;tableQuery) {&nbsp;</div></li><li><div>                case 'email_user_url':&nbsp;</div></li><li><div>                case 'email_user_stat':&nbsp;</div></li><li><div>                    if (!is_string($_REQUEST['orderby']) OR preg_match('|[^a-z0-9#_.-]|i', $_REQUEST['orderby']) !== 0) {&nbsp;</div></li><li><div>                                                $_REQUEST['orderby'] = '';&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        if (!in_array(strtoupper($_REQUEST['ordert']), array('DESC', 'ASC'))) {&nbsp;</div></li><li><div>                                            $_REQUEST['ordert'] = 'DESC';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $orderby = ' ORDER BY ' . $_REQUEST['orderby'] . ' ' . $_REQUEST['ordert'];&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'queue':&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $orderby .= ' ORDER BY A.user_id DESC';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            switch ($this-&gt;tableQuery) {&nbsp;</div></li><li><div>                case 'email_user_url':&nbsp;</div></li><li><div>                    $orderby = ' ORDER BY B.clicked_at DESC, B.number_clicked DESC'; // by default, sort by last clicked and biggest hit&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'email_user_stat':&nbsp;</div></li><li><div>                    $orderby = ' ORDER BY B.opened_at DESC, B.status DESC'; // by default, sort by last open and its staus value&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'queue':&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $orderby = ' ORDER BY A.user_id DESC';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;data['tableQuery'] = $this-&gt;tableQuery;&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;limitON = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscribers = array();&nbsp;</div></li><li><div>        $hook_params = array(&nbsp;</div></li><li><div>            'email_id' =&gt; $email_object['email_id'], &nbsp;</div></li><li><div>            'url_id' =&gt; isset($_REQUEST['url_id']) && $_REQUEST['url_id'] ? $_REQUEST['url_id'] : false, &nbsp;</div></li><li><div>            'subscribers' =&gt; &$subscribers, &nbsp;</div></li><li><div>                        'id' =&gt; $email_object['campaign_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;data['subscribers'] = $this-&gt;modelObj-&gt;getResults($query . $queryFinal . &quot; GROUP BY A.user_id&quot; . $orderby . $this-&gt;modelObj-&gt;setLimit(0, (int)$limit_pp));&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make the data object for the listing view&nbsp;</div></li><li><div>        $modelList = WYSIJA::get(&quot;list&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 2 - list request&nbsp;</div></li><li><div>        $query = &quot;SELECT A.list_id, A.name, A.is_enabled, count( B.user_id ) AS users FROM `[wysija]&quot; . $modelList-&gt;table_name . &quot;` as A&quot;;&nbsp;</div></li><li><div>        $query.=&quot; LEFT JOIN `[wysija]user_list` as B on A.list_id = B.list_id&quot;;&nbsp;</div></li><li><div>        $query.=&quot; GROUP BY A.list_id&quot;;&nbsp;</div></li><li><div>        $listsDB = $modelList-&gt;getResults($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lists = array();&nbsp;</div></li><li><div>        foreach ($listsDB as $listobj) {&nbsp;</div></li><li><div>            $lists[$listobj[&quot;list_id&quot;]] = $listobj;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $listsDB = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_ids = array();&nbsp;</div></li><li><div>        foreach ($this-&gt;data['subscribers'] as $subscriber) {&nbsp;</div></li><li><div>            $user_ids[] = $subscriber['user_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 3 - user_list request&nbsp;</div></li><li><div>        if ($user_ids) {&nbsp;</div></li><li><div>            $modeluList = WYSIJA::get(&quot;user_list&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>            $userlists = $modeluList-&gt;get(array(&quot;list_id&quot;, &quot;user_id&quot;), array(&quot;user_id&quot; =&gt; $user_ids));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $lists;&nbsp;</div></li><li><div>        $this-&gt;data['counts'] = array_reverse($counts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // regrouping all the data in the same array&nbsp;</div></li><li><div>        foreach ($this-&gt;data['subscribers'] as $keysus =&gt; $subscriber) {&nbsp;</div></li><li><div>            // default key while we don't have the data&nbsp;</div></li><li><div>            //TODO add data for stats about emails opened clicked etc&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus][&quot;emails&quot;] = 0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus][&quot;opened&quot;] = 0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus][&quot;clicked&quot;] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($userlists) {&nbsp;</div></li><li><div>                foreach ($userlists as $key =&gt; $userlist) {&nbsp;</div></li><li><div>                    if ($subscriber[&quot;user_id&quot;] == $userlist[&quot;user_id&quot;] && isset($lists[$userlist[&quot;list_id&quot;]])) {&nbsp;</div></li><li><div>                        if (!isset($this-&gt;data['subscribers'][$keysus][&quot;lists&quot;]))&nbsp;</div></li><li><div>                            $this-&gt;data['subscribers'][$keysus][&quot;lists&quot;] = $lists[$userlist[&quot;list_id&quot;]][&quot;name&quot;];&nbsp;</div></li><li><div>                        else&nbsp;</div></li><li><div>                            $this-&gt;data['subscribers'][$keysus][&quot;lists&quot;].=&quot;, &quot; . $lists[$userlist[&quot;list_id&quot;]][&quot;name&quot;];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['email'] = $email_object;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;data['subscribers']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__(&quot;Your request can't retrieve any subscribers. Change your filters!&quot;, WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // execute hooks&nbsp;</div></li><li><div>        $hook_params = array(&nbsp;</div></li><li><div>            'email_id' =&gt; $_REQUEST['id'], &nbsp;</div></li><li><div>            'email_object' =&gt; $email_object, &nbsp;</div></li><li><div>            'url_id' =&gt; !empty($_REQUEST['url_id']) ? (int)$_REQUEST['url_id'] : null, &nbsp;</div></li><li><div>                        'id' =&gt; $email_object['campaign_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['hooks']['hook_newsletter_top'] = apply_filters('hook_newsletter_top', WYSIJA_module::execute_hook('hook_newsletter_top', $hook_params), $hook_params);&nbsp;</div></li><li><div>        $this-&gt;data['hooks']['hook_newsletter_bottom'] = apply_filters('hook_newsletter_bottom', WYSIJA_module::execute_hook('hook_newsletter_bottom', $hook_params), $hook_params);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getListSubscriberQry($selectcolumns) {&nbsp;</div></li><li><div>        $this-&gt;modelObj = WYSIJA::get(&quot;email&quot;, &quot;model&quot;);&nbsp;</div></li><li><div>        $this-&gt;emailObj = $this-&gt;modelObj-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // use the filter if there is&nbsp;</div></li><li><div>        $this-&gt;setviewStatsfilter();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($selectcolumns == &quot;B.user_id&quot;) {&nbsp;</div></li><li><div>            //unset($this-&gt;filters[&quot;like&quot;]);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;filters['equal'][&quot;B.email_id&quot;] = $this-&gt;emailObj['email_id'];&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;noCheck = true;&nbsp;</div></li><li><div>        if ($this-&gt;filters)&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;setConditions($this-&gt;filters);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // select insert all the subscribers from that campaign into user_list&nbsp;</div></li><li><div>        if ($selectcolumns == &quot;B.user_id&quot;) {&nbsp;</div></li><li><div>            $query = &quot;SELECT $selectcolumns FROM `[wysija]&quot; . $this-&gt;tableQuery . &quot;` as B&quot;;&nbsp;</div></li><li><div>            $query.=$this-&gt;modelObj-&gt;makeWhere();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $query = &quot;SELECT $selectcolumns FROM `[wysija]user` as A&quot;;&nbsp;</div></li><li><div>            $query.=&quot; LEFT JOIN `[wysija]&quot; . $this-&gt;tableQuery . &quot;` as B on A.user_id=B.user_id&quot;;&nbsp;</div></li><li><div>            $query.=$this-&gt;modelObj-&gt;makeWhere();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $query;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function createnewlist() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // get the email subject&nbsp;</div></li><li><div>        $emailModel = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $email = $emailModel-&gt;getOne(array('subject'), array('email_id' =&gt; $_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set the name of the new list&nbsp;</div></li><li><div>        $prefix = &quot;&quot;;&nbsp;</div></li><li><div>        if (isset($_REQUEST['link_filter']))&nbsp;</div></li><li><div>            $prefix = ' (' . $this-&gt;viewObj-&gt;getTransStatusEmail($_REQUEST['link_filter']) . ')';&nbsp;</div></li><li><div>        $listname = sprintf(__('Segment of %1$s', WYSIJA), $email['subject'] . $prefix);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // insert new list&nbsp;</div></li><li><div>        $modelL = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $listid = $modelL-&gt;insert(array('is_enabled' =&gt; 1, 'name' =&gt; $listname, 'description' =&gt; __('List created based on a newsletter segment.', WYSIJA)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get list of subscribers filtered or not&nbsp;</div></li><li><div>        $query = $this-&gt;getListSubscriberQry($listid . ', A.user_id, ' . time() . ', 0');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query2 = 'INSERT INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`, `unsub_date`) ' . $query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;query($query2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(sprintf(__('A new list &quot;%1$s&quot; has been created out of this segment.', WYSIJA), $listname));&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id=' . $_REQUEST['id']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function unsubscribeall() {&nbsp;</div></li><li><div>        // Update user_list, set unsubdate and sub_date&nbsp;</div></li><li><div>        $query = $this-&gt;getListSubscriberQry('B.user_id');&nbsp;</div></li><li><div>    $query1 = &quot;&nbsp;</div></li><li><div>        UPDATE `[wysija]user_list`&nbsp;</div></li><li><div>        SET&nbsp;</div></li><li><div>        `unsub_date` = &quot;.time().&quot;, &nbsp;</div></li><li><div>        `sub_date` = 0&nbsp;</div></li><li><div>        WHERE&nbsp;</div></li><li><div>        `user_id` IN ($query)&nbsp;</div></li><li><div>        AND `list_id` NOT IN (SELECT `list_id` FROM `[wysija]list` WHERE `is_enabled` &lt; 1)&nbsp;</div></li><li><div>    &quot;;&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;query($query1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // unsubscribe from user where select from email_user_stat&nbsp;</div></li><li><div>        $query2 = &quot;UPDATE `[wysija]user` SET `status`=-1 WHERE `user_id` IN ($query)&quot;;&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;query($query2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(__('The segment has been unsubscribed from all the lists.', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id=' . $_REQUEST['id']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function removequeue() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // delete from queue where select from email_user_stat&nbsp;</div></li><li><div>        $query = $this-&gt;getListSubscriberQry('B.user_id');&nbsp;</div></li><li><div>        $query2 = &quot;DELETE FROM `[wysija]queue` where user_id IN ($query) AND email_id=&quot; . $this-&gt;emailObj['email_id'];&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;query($query2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(__('The segment has been removed from the queue of this newsletter.', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id=' . $_REQUEST['id']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function export() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                // select from email_user_stat left join user&nbsp;</div></li><li><div>        $query = $this-&gt;getListSubscriberQry('B.user_id');&nbsp;</div></li><li><div>        $result = $this-&gt;modelObj-&gt;query('get_res', $query);&nbsp;</div></li><li><div>        $user_ids = array();&nbsp;</div></li><li><div>        foreach ($result as $user) {&nbsp;</div></li><li><div>                    $user_ids[] = $user['user_id'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>        $tempfilename = $helper_file-&gt;temp(implode(', ', $user_ids), 'export_userids', '.txt');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $wpnonce = '&_wpnonce='.WYSIJA_view::secure(array('controller' =&gt; 'wysija_subscribers' , 'action' =&gt; 'exportcampaign' ), true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=exportcampaign&camp_id=' . $_REQUEST['id'] .$wpnonce .'&file_name=' . base64_encode($tempfilename['name']));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function unsubscribelist($data) {&nbsp;</div></li><li><div>                $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $modelL = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $list = $modelL-&gt;getOne(false, array('list_id' =&gt; $data['listid']));&nbsp;</div></li><li><div>        if ($list['is_enabled']) {&nbsp;</div></li><li><div>            /** delete from user_lists where select from email_user_stat */&nbsp;</div></li><li><div>            $query = $this-&gt;getListSubscriberQry(&quot;B.user_id&quot;);&nbsp;</div></li><li><div>            $query2 = &quot;DELETE FROM `[wysija]user_list` where user_id IN ($query) and list_id=&quot; . $data['listid'];&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;query($query2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('The segment has been unsubscribed from the list &quot;%1$s&quot;.', WYSIJA), $list['name']));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('The segment cannot be unsubscribed from an [IMPORT] list.', WYSIJA), $list['name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id=' . $_REQUEST['id']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function articles() {&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('articles' =&gt; __(&quot;Post Selection&quot;, WYSIJA));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // required js files&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-base-script-64';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-scriptaculous';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-colorpicker';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'mailpoet-select2';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'mailpoet-field-select2-terms';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'mailpoet-field-select2-simple';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // translations&nbsp;</div></li><li><div>        $this-&gt;jsTrans['show_advanced'] = __('Display and insert options', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['hide_advanced'] = __('Back to selection', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['loading_results'] = __('Loading results...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['inserting_selection'] = __('Inserting selected articles...', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['post_selected'] = __('selected', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // default tab in popup (this needs to be removed at some point)&nbsp;</div></li><li><div>        $_GET['tab'] = 'articles';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get parameters&nbsp;</div></li><li><div>        $params = array(&nbsp;</div></li><li><div>            'category_ids' =&gt; null, &nbsp;</div></li><li><div>            'category' =&gt; null, &nbsp;</div></li><li><div>            'title_tag' =&gt; 'h2', &nbsp;</div></li><li><div>            'title_alignment' =&gt; 'left', &nbsp;</div></li><li><div>            'title_position' =&gt; 'inside', &nbsp;</div></li><li><div>            'image_alignment' =&gt; 'alternate', &nbsp;</div></li><li><div>            'image_width' =&gt; 325, &nbsp;</div></li><li><div>            'post_content' =&gt; 'excerpt', &nbsp;</div></li><li><div>            'readmore' =&gt; __('Read more.', WYSIJA), &nbsp;</div></li><li><div>            'show_divider' =&gt; 'yes', &nbsp;</div></li><li><div>            'post_limit' =&gt; 5, &nbsp;</div></li><li><div>            'post_type' =&gt; 'post', &nbsp;</div></li><li><div>            'author_show' =&gt; 'no', &nbsp;</div></li><li><div>            'author_label' =&gt; __('Author:', WYSIJA), &nbsp;</div></li><li><div>            'category_show' =&gt; 'no', &nbsp;</div></li><li><div>            'category_label' =&gt; __('Categories:', WYSIJA), &nbsp;</div></li><li><div>            'nopost_message' =&gt; __('Latest content already sent.', WYSIJA), &nbsp;</div></li><li><div>            'bgcolor1' =&gt; null, &nbsp;</div></li><li><div>            'bgcolor2' =&gt; null, &nbsp;</div></li><li><div>            'sort_by' =&gt; 'newest'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if GET parameters are specified&nbsp;</div></li><li><div>        foreach($params as $key =&gt; $value) {&nbsp;</div></li><li><div>            if(array_key_exists($key, $_GET)) {&nbsp;</div></li><li><div>                switch($key) {&nbsp;</div></li><li><div>                    case 'autopost_count':&nbsp;</div></li><li><div>                        $params[$key] = (int)$_GET[$key];&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'readmore':&nbsp;</div></li><li><div>                    case 'nopost_message':&nbsp;</div></li><li><div>                        $params[$key] = base64_decode($_GET[$key]);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $params[$key] = $_GET[$key];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $insert_post_parameters = $model_config-&gt;getValue('insert_post_parameters');&nbsp;</div></li><li><div>        $helper_wj_engine = WYSIJA::get('wj_engine', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($insert_post_parameters !== false) {&nbsp;</div></li><li><div>            // there are user params&nbsp;</div></li><li><div>            $params = $helper_wj_engine-&gt;decodeParameters(array_merge($params, $insert_post_parameters));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get autopost count&nbsp;</div></li><li><div>        $this-&gt;data['autopost_count'] = (array_key_exists('autopost_count', $_GET)) ? (int) $_GET['autopost_count'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get autopost type (single or multiple)&nbsp;</div></li><li><div>        $this-&gt;data['autopost_type'] = (array_key_exists('autopost_type', $_GET)) ? $_GET['autopost_type'] : 'multiple';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if only one group of post can be added, change default alignment to left&nbsp;</div></li><li><div>        if($this-&gt;data['autopost_type'] === 'single' && $params['image_alignment'] === 'alternate') {&nbsp;</div></li><li><div>            $params['image_alignment'] = 'left';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get post categories (even when there's no post)&nbsp;</div></li><li><div>        $post_categories = get_categories(array('hide_empty' =&gt; 0));&nbsp;</div></li><li><div>        $categories = array();&nbsp;</div></li><li><div>        foreach ($post_categories as $category) {&nbsp;</div></li><li><div>            $categories[] = array('id' =&gt; $category-&gt;cat_ID, 'name' =&gt; $category-&gt;name);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;data['categories'] = $categories;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // max number of posts&nbsp;</div></li><li><div>        $this-&gt;data['post_limits'] = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 30, 50);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['params'] = $params;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function themeupload() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>                $helperNumbers = WYSIJA::get('numbers', 'helper');&nbsp;</div></li><li><div>        $bytes = $helperNumbers-&gt;get_max_file_upload();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_SERVER['CONTENT_LENGTH']) && $_SERVER['CONTENT_LENGTH'] &gt; $bytes['maxbytes']) {&nbsp;</div></li><li><div>            if (isset($_FILES['my-theme']['name']) && $_FILES['my-theme']['name']) {&nbsp;</div></li><li><div>                $filename = $_FILES['my-theme']['name'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $filename = &quot;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;error(sprintf(__('Upload error, file %1$s is too large! (MAX:%2$s)', WYSIJA), $filename, $bytes['maxmegas']), true);&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=themes');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$_FILES['my-theme']['tmp_name'] || !is_file($_FILES['my-theme']['tmp_name']))  {&nbsp;</div></li><li><div>            $this-&gt;error(__('This file is empty. Please try another.', WYSIJA));&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=themes');&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ZipfileResult = trim(file_get_contents($_FILES['my-theme']['tmp_name']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $themesHelp = WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>        $result = $themesHelp-&gt;installTheme($_FILES['my-theme']['tmp_name'], true);&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_campaigns&action=themes&reload=1');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function themes() {&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('themes' =&gt; __('Install Themes', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-base-script-64';&nbsp;</div></li><li><div>        $this-&gt;jsTrans['viewinfos'] = __('Details & PSD', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['viewback'] = __('&lt;&lt; Back', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['install'] = __('Download', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['reinstall'] = __('Reinstall', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['premiumonly'] = __('Premium', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        //change the translation of the button when it's premium&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('premium_key'))&nbsp;</div></li><li><div>            $this-&gt;jsTrans['ispremium'] = 1;&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;jsTrans['ispremium'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['premiumfiles'] = __('Photoshop file available as part of [link]Premium features[/link].', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_licence = WYSIJA::get('licence', 'helper');&nbsp;</div></li><li><div>        $url_checkout = $helper_licence-&gt;get_url_checkout('themes');&nbsp;</div></li><li><div>        $this-&gt;jsTrans['premiumfiles'] = str_replace(array('[link]', '[/link]'), array('&lt;a href=&quot;' . $url_checkout . '&quot; target=&quot;_blank&quot; &gt;', '&lt;/a&gt;'), $this-&gt;jsTrans['premiumfiles']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['showallthemes'] = __('Show all themes', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['totalvotes'] = __('(%1$s votes)', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['voterecorded'] = __(&quot;Your vote has been recorded.&quot;, WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['votenotrecorded'] = __(&quot;Your vote could not be recorded.&quot;, WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['reinstallwarning'] = __('Watch out! If you reinstall this theme all the files which are in the folder:/wp-content/uploads/wysija/themes/%1$s will be overwritten. Are you sure you want to reinstall?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['errorconnecting'] = __(&quot;We were unable to contact the API, the site may be down. Please try again later.&quot;, WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['viewallthemes'] = __('View all themes by %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['downloadpsd'] = __(&quot;Download original Photoshop file&quot;, WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['downloadzip'] = __(&quot;Download as .zip&quot;, WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['viewauthorsite'] = __(&quot;View author's website&quot;, WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['stars'] = __('Average rating: %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['starsyr'] = __('My rating: %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['downloads'] = __('Downloads: %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['tags'] = __('Tags: %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['lastupdated'] = __('Last updated: %1$s', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['includes'] = __('Includes: %1$s', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_themes = WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['installedthemes'] = $helper_themes-&gt;getInstalled();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $url = admin_url('admin.php');&nbsp;</div></li><li><div>        $helper_toolbox = WYSIJA::get(&quot;toolbox&quot;, &quot;helper&quot;);&nbsp;</div></li><li><div>        $domain_name = $helper_toolbox-&gt;_make_domain_name($url);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['domainname'] = $domain_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $_GET['tab'] = 'themes';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function bookmarks() {&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('bookmarks' =&gt; __('Bookmarks Selection', WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $_GET['tab'] = 'bookmarks';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $networks = array(&nbsp;</div></li><li><div>            'facebook' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; 'Facebook', &nbsp;</div></li><li><div>                'url' =&gt; null, &nbsp;</div></li><li><div>                'placeholder' =&gt; 'https://www.facebook.com/mailpoetplugin'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'twitter' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; 'Twitter', &nbsp;</div></li><li><div>                'url' =&gt; null, &nbsp;</div></li><li><div>                'placeholder' =&gt; 'http://www.twitter.com/mail_poet'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'google' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; 'Google+', &nbsp;</div></li><li><div>                'url' =&gt; null, &nbsp;</div></li><li><div>                'placeholder' =&gt; null&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'linkedin' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; 'LinkedIn', &nbsp;</div></li><li><div>                'url' =&gt; null, &nbsp;</div></li><li><div>                'placeholder' =&gt; null&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get networks' url from config&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $urls = $model_config-&gt;getValue('social_bookmarks');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set url from config for each network if specified&nbsp;</div></li><li><div>        foreach ($networks as $network =&gt; $values) {&nbsp;</div></li><li><div>            if (isset($urls[$network]) and strlen(trim($urls[$network])) &gt; 0) {&nbsp;</div></li><li><div>                $networks[$network]['url'] = $urls[$network];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['networks'] = $networks;&nbsp;</div></li><li><div>        $this-&gt;data['size'] = 'medium';&nbsp;</div></li><li><div>        $this-&gt;data['theme'] = isset($_REQUEST['theme']) ? $_REQUEST['theme'] : 'default';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dividers() {&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('dividers' =&gt; __(&quot;Dividers Selection&quot;, WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-base-script-64';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $_GET['tab'] = 'dividers';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>        $this-&gt;data['email'] = $email = $model_email-&gt;getOne(false, array('email_id' =&gt; $_REQUEST['emailId']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get dividers&nbsp;</div></li><li><div>        $helper_dividers = WYSIJA::get('dividers', 'helper');&nbsp;</div></li><li><div>        $dividers = $helper_dividers-&gt;getAll();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get theme divider if it's not the default theme&nbsp;</div></li><li><div>        if (isset($email['params']['theme'])) {&nbsp;</div></li><li><div>            $helper_themes = WYSIJA::get('themes', 'helper');&nbsp;</div></li><li><div>            $themeDivider = $helper_themes-&gt;getDivider($email['params']['theme']);&nbsp;</div></li><li><div>            if ($themeDivider !== NULL) {&nbsp;</div></li><li><div>                array_unshift($dividers, $themeDivider);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get selected divider&nbsp;</div></li><li><div>        if (isset($email['params']['divider'])) {&nbsp;</div></li><li><div>            $selected_divider = $email['params']['divider'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $helper_dividers = WYSIJA::get('dividers', 'helper');&nbsp;</div></li><li><div>            $selected_divider = $helper_dividers-&gt;getDefault();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set selected divider in first position&nbsp;</div></li><li><div>        array_unshift($dividers, $selected_divider);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove selected divider if present in the list&nbsp;</div></li><li><div>        for ($i = 1; $i &lt; count($dividers); $i++) {&nbsp;</div></li><li><div>            if ($dividers[$i]['src'] === $selected_divider['src']) {&nbsp;</div></li><li><div>                unset($dividers[$i]);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['selected'] = $selected_divider;&nbsp;</div></li><li><div>        $this-&gt;data['dividers'] = $dividers;&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function autopost() {&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('autopost' =&gt; __(&quot;Add / Edit group of posts&quot;, WYSIJA));&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-admin-ajax';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-base64';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-scriptaculous';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-colorpicker';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'mailpoet-select2';&nbsp;</div></li><li><div>        $this-&gt;js[] = 'mailpoet-field-select2-terms';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // translations&nbsp;</div></li><li><div>        $this-&gt;jsTrans['show_advanced'] = __('Show display options', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;jsTrans['hide_advanced'] = __('Hide display options', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $_GET['tab'] = 'autopost';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get parameters&nbsp;</div></li><li><div>        $params = array(&nbsp;</div></li><li><div>            'category_ids' =&gt; null, &nbsp;</div></li><li><div>            'category_condition' =&gt; 'include', &nbsp;</div></li><li><div>            'title_tag' =&gt; 'h2', &nbsp;</div></li><li><div>            'title_alignment' =&gt; 'left', &nbsp;</div></li><li><div>            'title_position' =&gt; 'inside', &nbsp;</div></li><li><div>            'image_alignment' =&gt; 'alternate', &nbsp;</div></li><li><div>            'image_width' =&gt; 325, &nbsp;</div></li><li><div>            'post_content' =&gt; 'excerpt', &nbsp;</div></li><li><div>            'readmore' =&gt; __('Read more.', WYSIJA), &nbsp;</div></li><li><div>            'show_divider' =&gt; 'yes', &nbsp;</div></li><li><div>            'post_limit' =&gt; 5, &nbsp;</div></li><li><div>            'post_type' =&gt; 'post', &nbsp;</div></li><li><div>            'author_show' =&gt; 'no', &nbsp;</div></li><li><div>            'author_label' =&gt; __('Author:', WYSIJA), &nbsp;</div></li><li><div>            'category_show' =&gt; 'no', &nbsp;</div></li><li><div>            'category_label' =&gt; __('Categories:', WYSIJA), &nbsp;</div></li><li><div>            'nopost_message' =&gt; __('Latest content already sent.', WYSIJA), &nbsp;</div></li><li><div>            'bgcolor1' =&gt; null, &nbsp;</div></li><li><div>            'bgcolor2' =&gt; null, &nbsp;</div></li><li><div>            'sort_by' =&gt; 'newest'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // backwards compatibility since we replaced the 'cpt' parameter by 'post_type' in 2.6&nbsp;</div></li><li><div>        if(isset($_GET['cpt']) && strlen(trim($_GET['cpt'])) &gt; 0) {&nbsp;</div></li><li><div>            $params['post_type'] = trim($_GET['cpt']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if GET parameters are specified&nbsp;</div></li><li><div>        foreach ($params as $key =&gt; $value) {&nbsp;</div></li><li><div>            if (array_key_exists($key, $_GET)) {&nbsp;</div></li><li><div>                switch ($key) {&nbsp;</div></li><li><div>                    case 'autopost_count':&nbsp;</div></li><li><div>                        $params[$key] = (int)$_GET[$key];&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'author_label':&nbsp;</div></li><li><div>                    case 'category_label':&nbsp;</div></li><li><div>                    case 'readmore':&nbsp;</div></li><li><div>                    case 'nopost_message':&nbsp;</div></li><li><div>                        $params[$key] = base64_decode($_GET[$key]);&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $params[$key] = trim($_GET[$key]);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get autopost count&nbsp;</div></li><li><div>        $this-&gt;data['autopost_count'] = (array_key_exists('autopost_count', $_GET)) ? (int) $_GET['autopost_count'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get autopost type (single or multiple)&nbsp;</div></li><li><div>        $this-&gt;data['autopost_type'] = (array_key_exists('autopost_type', $_GET)) ? $_GET['autopost_type'] : 'multiple';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if only one group of post can be added, change default alignment to left&nbsp;</div></li><li><div>        if ($this-&gt;data['autopost_type'] === 'single') {&nbsp;</div></li><li><div>            if ($params['image_alignment'] === 'alternate')&nbsp;</div></li><li><div>                $params['image_alignment'] = 'left';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we use that now, because categories from a post are different than categories from a CPT&nbsp;</div></li><li><div>        // $helper_wp_tools = WYSIJA::get('wp_tools', 'helper');&nbsp;</div></li><li><div>        // $this-&gt;data['categories'] = $helper_wp_tools-&gt;get_categories();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // max number of posts&nbsp;</div></li><li><div>        $this-&gt;data['post_limits'] = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 30, 50);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['params'] = $params;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function image_data() {&nbsp;</div></li><li><div>        $this-&gt;data['url'] = (isset($_GET['url']) && $_GET['url'] !== '') ? trim(urldecode($_GET['url'])) : null;&nbsp;</div></li><li><div>        $this-&gt;data['alt'] = (isset($_GET['alt'])) ? trim(urldecode($_GET['alt'])) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;iframeTabs = array('image_data' =&gt; __(&quot;Image Parameters&quot;, WYSIJA));&nbsp;</div></li><li><div>        $_GET['tab'] = 'image_data';&nbsp;</div></li><li><div>        return $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function medias() {&nbsp;</div></li><li><div>        $this-&gt;popupContent();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function special_wysija_browse() {&nbsp;</div></li><li><div>        $this-&gt;_wysija_subaction();&nbsp;</div></li><li><div>        $this-&gt;jsTrans['deleteimg'] = __('Delete image for all newsletters?', WYSIJA);&nbsp;</div></li><li><div>        return wp_iframe(array($this-&gt;viewObj, 'popup_wysija_browse'), array());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function special_wordp_browse() {&nbsp;</div></li><li><div>        $this-&gt;_wysija_subaction();&nbsp;</div></li><li><div>        $this-&gt;jsTrans['deleteimg'] = __('This image might be in an article. Delete anyway?', WYSIJA);&nbsp;</div></li><li><div>        return wp_iframe(array($this-&gt;viewObj, 'popup_wp_browse'), array());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function special_new_wordp_upload() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('wysija-plupload-handlers', WYSIJA_URL . 'js/jquery/pluploadHandler.js', array('plupload-all', 'jquery'));&nbsp;</div></li><li><div>        $uploader_l10n = array(&nbsp;</div></li><li><div>            'queue_limit_exceeded' =&gt; __('You have attempted to queue too many files.'), &nbsp;</div></li><li><div>            'file_exceeds_size_limit' =&gt; __('%s exceeds the maximum upload size for this site.'), &nbsp;</div></li><li><div>            'zero_byte_file' =&gt; __('This file is empty. Please try another.'), &nbsp;</div></li><li><div>            'invalid_filetype' =&gt; __('This file type is not allowed. Please try another.'), &nbsp;</div></li><li><div>            'not_an_image' =&gt; __('This file is not an image. Please try another.'), &nbsp;</div></li><li><div>            'image_memory_exceeded' =&gt; __('Memory exceeded. Please try another smaller file.'), &nbsp;</div></li><li><div>            'image_dimensions_exceeded' =&gt; __('This is larger than the maximum size. Please try another.'), &nbsp;</div></li><li><div>            'default_error' =&gt; __('An error occurred in the upload. Please try again later.'), &nbsp;</div></li><li><div>            'missing_upload_url' =&gt; __('There was a configuration error. Please contact the server administrator.'), &nbsp;</div></li><li><div>            'upload_limit_exceeded' =&gt; __('You may only upload 1 file.'), &nbsp;</div></li><li><div>            'http_error' =&gt; __('HTTP error.'), &nbsp;</div></li><li><div>            'upload_failed' =&gt; __('Upload failed.'), &nbsp;</div></li><li><div>            'big_upload_failed' =&gt; __('Please try uploading this file with the %1$sbrowser uploader%2$s.'), &nbsp;</div></li><li><div>            'big_upload_queued' =&gt; __('%s exceeds the maximum upload size for the multi-file uploader when used in your browser.'), &nbsp;</div></li><li><div>            'io_error' =&gt; __('IO error.'), &nbsp;</div></li><li><div>            'security_error' =&gt; __('Security error.'), &nbsp;</div></li><li><div>            'file_cancelled' =&gt; __('File canceled.'), &nbsp;</div></li><li><div>            'upload_stopped' =&gt; __('Upload stopped.'), &nbsp;</div></li><li><div>            'dismiss' =&gt; __('Dismiss'), &nbsp;</div></li><li><div>            'crunching' =&gt; __('Crunching&hellip;'), &nbsp;</div></li><li><div>            'deleted' =&gt; __('moved to the trash.'), &nbsp;</div></li><li><div>            'error_uploading' =&gt; __('&#8220;%s&#8221; has failed to upload.'), &nbsp;</div></li><li><div>            'files_successfully_uploaded' =&gt; __('%d file(s) have been successfully uploaded.')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script('wysija-plupload-handlers', 'pluploadL10n', $uploader_l10n);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('image-edit');&nbsp;</div></li><li><div>        wp_enqueue_script('set-post-thumbnail');&nbsp;</div></li><li><div>        wp_enqueue_style('imgareaselect');&nbsp;</div></li><li><div>        wp_enqueue_script('media-gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errors = array();&nbsp;</div></li><li><div>        return wp_iframe(array($this-&gt;viewObj, 'popup_new_wp_upload'), $errors);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function special_wordp_upload() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('swfupload-all');&nbsp;</div></li><li><div>        wp_enqueue_script('swfupload-handlers');&nbsp;</div></li><li><div>        wp_enqueue_script('wysija-upload-handlers', WYSIJA_URL . &quot;js/jquery/uploadHandlers.js&quot;);&nbsp;</div></li><li><div>        wp_enqueue_script('image-edit');&nbsp;</div></li><li><div>        wp_enqueue_script('set-post-thumbnail');&nbsp;</div></li><li><div>        wp_enqueue_style('imgareaselect');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errors = array();&nbsp;</div></li><li><div>        $id = 0;&nbsp;</div></li><li><div>        if (isset($_GET['flash']))&nbsp;</div></li><li><div>            $_GET['flash'] = 1;&nbsp;</div></li><li><div>        if (isset($_POST['html-upload']) && !empty($_FILES)) {&nbsp;</div></li><li><div>            // Upload File button was clicked&nbsp;</div></li><li><div>            $id = media_handle_upload('async-upload', $_REQUEST['post_id']);&nbsp;</div></li><li><div>            unset($_FILES);&nbsp;</div></li><li><div>            if (is_wp_error($id)) {&nbsp;</div></li><li><div>                $errors['upload_error'] = $id;&nbsp;</div></li><li><div>                $id = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($_POST['insertonlybutton'])) {&nbsp;</div></li><li><div>            $href = $_POST['insertonly']['href'];&nbsp;</div></li><li><div>            if (!empty($href) && !strpos($href, '://'))&nbsp;</div></li><li><div>                $href = &quot;http://$href&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $title = esc_attr($_POST['insertonly']['title']);&nbsp;</div></li><li><div>            if (empty($title))&nbsp;</div></li><li><div>                $title = basename($href);&nbsp;</div></li><li><div>            if (!empty($title) && !empty($href))&nbsp;</div></li><li><div>                $html = &quot;&lt;a href='&quot; . esc_url($href) . &quot;' &gt;$title&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>            $html = apply_filters('file_send_to_editor_url', $html, esc_url_raw($href), $title);&nbsp;</div></li><li><div>            return media_send_to_editor($html);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($_POST)) {&nbsp;</div></li><li><div>            $return = media_upload_form_handler();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (is_string($return))&nbsp;</div></li><li><div>                return $return;&nbsp;</div></li><li><div>            if (is_array($return))&nbsp;</div></li><li><div>                $errors = $return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($_POST['save'])) {&nbsp;</div></li><li><div>            $errors['upload_notice'] = __('Saved.', WYSIJA);&nbsp;</div></li><li><div>            return media_upload_gallery();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return wp_iframe(array($this-&gt;viewObj, 'popup_wp_upload'), $errors);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _checkEmailExists($emailId) {&nbsp;</div></li><li><div>        $result = false;&nbsp;</div></li><li><div>        $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($model_email-&gt;exists(array('email_id' =&gt; $emailId))) {&nbsp;</div></li><li><div>                    $result = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$result) {&nbsp;</div></li><li><div>            $this-&gt;error(__(&quot;The newsletter doesn't exist.&quot;, WYSIJA), 1);&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns');&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>                   return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wysija_control_back_campaigns/" class="active">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wysija_control_back_campaigns/" class="">2.7.4</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.3/classes/wysija_control_back_campaigns/" class="">2.7.3</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.2/classes/wysija_control_back_campaigns/" class="">2.7.2</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.1/classes/wysija_control_back_campaigns/" class="">2.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WYSIJA_control_back_campaigns</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>