<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.5" data-slug="mailpoet-newsletters" data-type="class" data-id="41186"><head xmlns="http://www.w3.org/1999/xhtml"><title> wysija_model_config | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WYSIJA_model_config, class, plugin, mailpoet-newsletters, 2.7.5" /><meta name="description" content="The MailPoet Newsletters WYSIJA model config class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.8"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=815d11ba966ced9599a5fe72189bf818' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.8' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wysija_model_config/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_model_config%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_model_config%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.5-class-wysija_model_config","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wysija_model_config" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.5." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/" class="H_VERSION"><span property="name">2.7.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wysija_model_config</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="299"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/all/" title="All">All <span class="count badge">299</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="active" data-id="class" data-count="132"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/" title="Classes">Classes <span class="count badge">132</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WYSIJA_model_config</strong></h1><p>The MailPoet Newsletters <strong>WYSIJA model config</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/files/models-config/" class="file">/models/config.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class WYSIJA_model_config extends WYSIJA_object{&nbsp;</div></li><li><div>    // the name of our option in the settings&nbsp;</div></li><li><div>    var $name_option = 'wysija';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Check boxes are cheeky depending on the browser, some browser, won't post it, so it won't appear in the global _POST variable&nbsp;</div></li><li><div>     * SO in order to identify unchecked value, we list all of the fields which are checkboxes&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $cboxes = array(&nbsp;</div></li><li><div>        'emails_notified_when_sub', &nbsp;</div></li><li><div>        'emails_notified_when_unsub', &nbsp;</div></li><li><div>        'emails_notified_when_bounce', &nbsp;</div></li><li><div>        'emails_notified_when_dailysummary', &nbsp;</div></li><li><div>        'bounce_process_auto', &nbsp;</div></li><li><div>        'ms_bounce_process_auto', &nbsp;</div></li><li><div>        'sharedata', &nbsp;</div></li><li><div>        'manage_subscriptions', &nbsp;</div></li><li><div>        'viewinbrowser', &nbsp;</div></li><li><div>        'dkim_active', &nbsp;</div></li><li><div>        'cron_manual', &nbsp;</div></li><li><div>        'commentform', &nbsp;</div></li><li><div>        'smtp_rest', &nbsp;</div></li><li><div>        'ms_smtp_rest', &nbsp;</div></li><li><div>        'registerform', &nbsp;</div></li><li><div>        'ms_allow_admin_sending_method', &nbsp;</div></li><li><div>        'ms_allow_admin_toggle_signup_confirmation', &nbsp;</div></li><li><div>        'debug_log_cron', &nbsp;</div></li><li><div>        'debug_log_post_notif', &nbsp;</div></li><li><div>        'debug_log_query_errors', &nbsp;</div></li><li><div>        'debug_log_queue_process', &nbsp;</div></li><li><div>        'debug_log_manual', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * all of the default values in that option&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $defaults = array(&nbsp;</div></li><li><div>        'limit_listing' =&gt; 10, &nbsp;</div></li><li><div>        'role_campaign' =&gt; 'switch_themes', &nbsp;</div></li><li><div>        'role_subscribers' =&gt; 'switch_themes', &nbsp;</div></li><li><div>        'emails_notified_when_unsub' =&gt; true, &nbsp;</div></li><li><div>        'sending_method' =&gt; 'gmail', &nbsp;</div></li><li><div>        'sending_emails_number' =&gt; '70', &nbsp;</div></li><li><div>        'sending_method' =&gt; 'site', &nbsp;</div></li><li><div>        'sending_emails_site_method' =&gt; 'phpmail', &nbsp;</div></li><li><div>        'smtp_port' =&gt; '', &nbsp;</div></li><li><div>        'smtp_auth' =&gt; true, &nbsp;</div></li><li><div>        'bounce_port' =&gt; '', &nbsp;</div></li><li><div>        'confirm_dbleoptin' =&gt; 1, &nbsp;</div></li><li><div>        'bounce_selfsigned' =&gt; 0, &nbsp;</div></li><li><div>        'bounce_email_notexists' =&gt; 'unsub', &nbsp;</div></li><li><div>        'bouncing_emails_each' =&gt; 'daily', &nbsp;</div></li><li><div>        'bounce_inbox_full' =&gt; 'not', &nbsp;</div></li><li><div>        'pluginsImportedEgg' =&gt; false, &nbsp;</div></li><li><div>        'advanced_charset' =&gt; 'UTF-8', &nbsp;</div></li><li><div>        'sendmail_path' =&gt; '/usr/sbin/sendmail', &nbsp;</div></li><li><div>        'sending_emails_each' =&gt; 'hourly', &nbsp;</div></li><li><div>        'bounce_max' =&gt; 8, &nbsp;</div></li><li><div>        'debug_new' =&gt; false, &nbsp;</div></li><li><div>        'analytics' =&gt; 0, &nbsp;</div></li><li><div>        'send_analytics_now' =&gt; 0, &nbsp;</div></li><li><div>        'industry' =&gt; 'other', &nbsp;</div></li><li><div>        'manage_subscriptions' =&gt; false, &nbsp;</div></li><li><div>        'editor_fullarticle' =&gt; false, &nbsp;</div></li><li><div>        'allow_no_js' =&gt; true, &nbsp;</div></li><li><div>        'urlstats_base64' =&gt; true, &nbsp;</div></li><li><div>        'viewinbrowser' =&gt; true, &nbsp;</div></li><li><div>        'commentform' =&gt; false, &nbsp;</div></li><li><div>        'registerform' =&gt; false, &nbsp;</div></li><li><div>        'ms_sending_config' =&gt; 'one-each', &nbsp;</div></li><li><div>        'ms_sending_method' =&gt; 'site', &nbsp;</div></li><li><div>        'ms_sending_emails_site_method' =&gt; 'phpmail', &nbsp;</div></li><li><div>        'ms_sending_emails_each' =&gt; 'hourly', &nbsp;</div></li><li><div>        'ms_sending_emails_number' =&gt; '100', &nbsp;</div></li><li><div>        'ms_allow_admin_sending_method' =&gt; false, &nbsp;</div></li><li><div>        'ms_allow_admin_toggle_signup_confirmation' =&gt; false, &nbsp;</div></li><li><div>        'ms_bouncing_emails_each' =&gt; 'daily', &nbsp;</div></li><li><div>        'cron_page_hit_trigger' =&gt; 1, &nbsp;</div></li><li><div>        'beta_mode' =&gt; false, &nbsp;</div></li><li><div>        'cron_manual' =&gt; true, &nbsp;</div></li><li><div>        'email_cyrillic' =&gt; false, &nbsp;</div></li><li><div>        'allow_wpmail' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $capabilities = array();&nbsp;</div></li><li><div>    var $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        // global telling us if we're currently running the installation process install/helper&nbsp;</div></li><li><div>        global $wysija_installing;&nbsp;</div></li><li><div>        // get our WordPress option containing all of our settings&nbsp;</div></li><li><div>        $encoded_option = get_option( $this-&gt;name_option );&nbsp;</div></li><li><div>        // we set a flag to identify whether we need to run the helpers/install.php&nbsp;</div></li><li><div>        $plugin_needs_installing = $plugin_needs_fixing = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 1 - &quot;Is our plugin installed?&quot; we make all of the checks to be sure that the plugin has been installed already&nbsp;</div></li><li><div>        if ( $encoded_option ) {&nbsp;</div></li><li><div>            // our settings option needs to be a base64 encoded string containing a serialized array&nbsp;</div></li><li><div>            $this-&gt;values = unserialize( base64_decode( $encoded_option ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // we make sure that the installation of the plugin has been complete&nbsp;</div></li><li><div>            if ( ! isset( $this-&gt;values['installed'] ) ) {&nbsp;</div></li><li><div>                if ( defined( 'WP_ADMIN' ) && isset( $_GET['page'] ) && substr( $_GET['page'], 0, 7 ) == 'wysija_' && get_option( 'installation_step' ) == 16 ) {&nbsp;</div></li><li><div>                    // if we fall in that situation, there has been a problem&nbsp;</div></li><li><div>                    // the step 16 of the installation has to set the &quot;installed&quot; and &quot;installed_time&quot; parameters in our config option&nbsp;</div></li><li><div>                    // how could that happen?&nbsp;</div></li><li><div>                    // let's determine the real version number of this installation so that the proper update sequence are run&nbsp;</div></li><li><div>                    // let's run a hooked action the function cannot be run directly otherwise some missing WP functions will run a crash&nbsp;</div></li><li><div>                    $plugin_needs_fixing = true;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // when we come to that step, we know the plugin has not been installed so we tell it to run the installation helper&nbsp;</div></li><li><div>                    $plugin_needs_installing = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // our settings option is not set, that means the plugin is not installed&nbsp;</div></li><li><div>            $plugin_needs_installing = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // regenerate the DKIM key&nbsp;</div></li><li><div>        // dkim is not active that means the dkim_keys are not used so we can reinitialize them as 1024 if they are not already 1024&nbsp;</div></li><li><div>        // (we use to have a 512 DKIM which is not good enough for Gmail's spam filters)&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;values['dkim_active'] ) && ! empty( $this-&gt;values['dkim_pubk'] ) && ! isset( $this-&gt;values['dkim_1024'] ) ) {&nbsp;</div></li><li><div>            unset($this-&gt;values['dkim_pubk']);&nbsp;</div></li><li><div>            unset($this-&gt;values['dkim_privk']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // in multisite some options are global and need to have just one value accross all of the sites.&nbsp;</div></li><li><div>        // for instance (multisite sending method and multisite bounce handling)&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            // safety net for accidentaly saved ms values in the child site option&nbsp;</div></li><li><div>            foreach ( $this-&gt;values as $key =&gt; $val ) {&nbsp;</div></li><li><div>                // if we have a key prefixed by ms_ in that option then we just unset it.&nbsp;</div></li><li><div>                // the real ms value is loaded right after and comes from a global get_site_option&nbsp;</div></li><li><div>                if ( substr( $key, 0, 3 ) === 'ms_' ) {&nbsp;</div></li><li><div>                    unset( $this-&gt;values[ $key ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $encoded_option = get_site_option( 'ms_' . $this-&gt;name_option );&nbsp;</div></li><li><div>            // let's merge the global multisite options to our child site settings so that they can be fetched through getValue()&nbsp;</div></li><li><div>            if ( $encoded_option ) {&nbsp;</div></li><li><div>                $this-&gt;values = array_merge( $this-&gt;values, unserialize( base64_decode( $encoded_option ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // in multisite the default sending method is the network one&nbsp;</div></li><li><div>            $this-&gt;defaults['sending_method'] = 'network';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // install the application because there is no option setup it's safer than the classic activation scheme&nbsp;</div></li><li><div>        if ( defined( 'WP_ADMIN' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $plugin_needs_installing && $wysija_installing !== true ) {&nbsp;</div></li><li><div>                $wysija_installing = true;&nbsp;</div></li><li><div>                $helper_install = WYSIJA::get( 'install', 'helper', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                add_action( 'admin_menu', array( $helper_install, 'install' ), 97 );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $helper_update = WYSIJA::get( 'update' , 'helper' );&nbsp;</div></li><li><div>                if ( $plugin_needs_fixing ) {&nbsp;</div></li><li><div>                    // plugin needs fixing&nbsp;</div></li><li><div>                    add_action( 'admin_menu', array( $helper_update, 'repair_settings' ), 103 );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // plugin is clean let's look for update request&nbsp;</div></li><li><div>                    // the plugin has already been installed, so we check if there are some update query to be run&nbsp;</div></li><li><div>                    add_action( 'admin_menu', array( $helper_update, 'check' ), 103 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // wait until the translation files are loaded and load our strings&nbsp;</div></li><li><div>            // From the backend we load the translated strings for that function at admin_menu level&nbsp;</div></li><li><div>            // Ben: there is a reason for that, I just don't remember which&nbsp;</div></li><li><div>            add_action( 'admin_menu', array( $this, 'add_translated_default' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // wait until the translation files are loaded and load our strings&nbsp;</div></li><li><div>            add_action( 'init', array( $this, 'add_translated_default' ), 96 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we're already loading our translation files through hooks, this said&nbsp;</div></li><li><div>        $this-&gt;add_translated_default();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * to make sure the translation is not screwed by an empty space or so&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function cleanTrans( $string ) {&nbsp;</div></li><li><div>        return str_replace(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                '[ link]', &nbsp;</div></li><li><div>                '[link ]', &nbsp;</div></li><li><div>                '[ link ]', &nbsp;</div></li><li><div>                '[/ link]', &nbsp;</div></li><li><div>                '[/link ]', &nbsp;</div></li><li><div>                '[ /link]', &nbsp;</div></li><li><div>                '[/ link ]', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                '[link]', &nbsp;</div></li><li><div>                '[link]', &nbsp;</div></li><li><div>                '[link]', &nbsp;</div></li><li><div>                '[/link]', &nbsp;</div></li><li><div>                '[/link]', &nbsp;</div></li><li><div>                '[/link]', &nbsp;</div></li><li><div>                '[/link]', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            trim( $string )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this is translatable text we use in the plugin which needs to be loaded through a hook so that the translation files are already there&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function add_translated_default() {&nbsp;</div></li><li><div>        // definition of extra translated defaults fields&nbsp;</div></li><li><div>        $this-&gt;defaults['confirm_email_title'] = sprintf( __( 'Confirm your subscription to %1$s', WYSIJA ), get_option( 'blogname' ) );&nbsp;</div></li><li><div>        $this-&gt;defaults['confirm_email_body'] = __( &quot;Hello!\n\nHurray! You've subscribed to our site.\nWe need you to activate your subscription to the list(s): [lists_to_confirm] by clicking the link below: \n\n[activation_link]Click here to confirm your subscription.[/activation_link]\n\nThank you, \n\n The team!\n&quot;, WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['subscribed_title'] = __( 'You\'ve subscribed to: %1$s', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['subscribed_subtitle'] = __( 'Yup, we\'ve added you to our list. You\'ll hear from us shortly.', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['unsubscribed_title'] = __( 'You\'ve unsubscribed!', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['unsubscribed_subtitle'] = __( 'Great, you\'ll never hear from us again!', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['unsubscribe_linkname'] = __( 'Unsubscribe', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['manage_subscriptions_linkname'] = __( 'Edit your subscription', WYSIJA );&nbsp;</div></li><li><div>        $this-&gt;defaults['viewinbrowser_linkname'] = $this-&gt;cleanTrans( __( 'Display problems? [link]View this newsletter in your browser.[/link]', WYSIJA ) );&nbsp;</div></li><li><div>        $this-&gt;defaults['registerform_linkname'] = $this-&gt;defaults['commentform_linkname'] = __( 'Yes, add me to your mailing list.', WYSIJA );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;capabilities['newsletters'] = array(&nbsp;</div></li><li><div>            'label' =&gt; __( 'Who can create newsletters?', WYSIJA )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;capabilities['subscribers'] = array( // if this role (name) is changed, please change at the filter &quot;wysija_capabilities&quot; as well&nbsp;</div></li><li><div>            'label' =&gt; __( 'Who can manage subscribers?', WYSIJA )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;capabilities['config'] = array(&nbsp;</div></li><li><div>            'label' =&gt; __( 'Who can change MailPoet\'s settings?', WYSIJA )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;capabilities['theme_tab'] = array(&nbsp;</div></li><li><div>            'label' =&gt; __( 'Who can see the themes tab in the visual editor?', WYSIJA )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;capabilities['style_tab'] = array(&nbsp;</div></li><li><div>            'label' =&gt; __( 'Who can see the styles tab in the visual editor?', WYSIJA )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;capabilities = apply_filters( 'wysija_capabilities', $this-&gt;capabilities );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * we have a specific save for option since we are saving it in wordpress options table&nbsp;</div></li><li><div>     * @param array $data of data to save&nbsp;</div></li><li><div>     * @param boolean $saved_through_interfaces telling us whether&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function save( $data = false, $saved_through_interfaces = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $data ) {&nbsp;</div></li><li><div>            // when saving configuration from the settings page we need to make sure that if checkboxes have been unticked we remove the corresponding option&nbsp;</div></li><li><div>            $bouncing_freq_has_changed = $sending_freq_has_changed = $ms_sending_freq_has_changed = false;&nbsp;</div></li><li><div>            if ( $saved_through_interfaces ) {&nbsp;</div></li><li><div>                $helper_wp_tools = WYSIJA::get( 'wp_tools', 'helper', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                $editable_roles = $helper_wp_tools-&gt;wp_get_roles();&nbsp;</div></li><li><div>                foreach ( $this-&gt;capabilities as $keycap =&gt; $capability ) {&nbsp;</div></li><li><div>                    foreach ( $editable_roles as $role ) {&nbsp;</div></li><li><div>                        $this-&gt;cboxes[] = 'rolescap---' . $role['key'] . '---' . $keycap;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if the wysija's cron option has just been turned on from an off value&nbsp;</div></li><li><div>                // then we check the licence from mailpoet.com to share the cron url with us&nbsp;</div></li><li><div>                if ( isset( $data['cron_manual'] ) && $data['cron_manual'] != $this-&gt;getValue( 'cron_manual' ) ) {&nbsp;</div></li><li><div>                    $helper_licence = WYSIJA::get( 'licence', 'helper' );&nbsp;</div></li><li><div>                    $helper_licence-&gt;check( true );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // loop through all of the checkboxes values&nbsp;</div></li><li><div>                foreach ( $this-&gt;cboxes as $checkbox ) {&nbsp;</div></li><li><div>                    // set the value as false if the value doesn't exist in the array (happens when checkbox is unchecked)&nbsp;</div></li><li><div>                    if ( ! isset( $data[ $checkbox ] ) ) {&nbsp;</div></li><li><div>                        $data[ $checkbox ] = $this-&gt;values[ $checkbox ] = false;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // otherwise we set it as value 1&nbsp;</div></li><li><div>                        $data[ $checkbox ] = $this-&gt;values[ $checkbox ] = 1;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // identify all of the roles checkboxes to update the WP user roles live when changed&nbsp;</div></li><li><div>                    if ( strpos( $checkbox, 'rolescap---' ) !== false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $role_capability = str_replace( 'rolescap---', '', $checkbox );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $role_capability_exploded = explode( '---', $role_capability );&nbsp;</div></li><li><div>                        $role = get_role( $role_capability_exploded[0] );&nbsp;</div></li><li><div>                        $capability = 'wysija_' . $role_capability_exploded[1];&nbsp;</div></li><li><div>                        // added for invalid roles ...&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // this is a rolecap let's add or remove the cap to the role&nbsp;</div></li><li><div>                        if ( $role ) {&nbsp;</div></li><li><div>                            if ( $this-&gt;values[ $checkbox ] ) {&nbsp;</div></li><li><div>                                $role-&gt;add_cap( $capability );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                // remove cap only for roles different of admins&nbsp;</div></li><li><div>                                if ( $role-&gt;has_cap( $capability ) && ! in_array( $role_capability_exploded[0], array( 'administrator', 'super_admin' ) ) ) {&nbsp;</div></li><li><div>                                    $role-&gt;remove_cap( $capability );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // no need to keep these role values in our option, they already are saved in WordPress' roles options&nbsp;</div></li><li><div>                        unset( $this-&gt;values[ $checkbox ] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $helper_user = WYSIJA::get( 'user', 'helper', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // validating the from email&nbsp;</div></li><li><div>                if ( isset( $data['from_email'] ) && ! $helper_user-&gt;validEmail( $data['from_email'] ) ) {&nbsp;</div></li><li><div>                    if ( ! $data['from_email'] ) {&nbsp;</div></li><li><div>                        $data['from_email'] = __( 'empty', WYSIJA );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $this-&gt;error( sprintf( __( 'The &lt;strong&gt;from email&lt;/strong&gt; value you have entered (%1$s) is not a valid email address.', WYSIJA ), '' ), true );&nbsp;</div></li><li><div>                    $data['from_email'] = $this-&gt;values['from_email'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // validating the replyto email&nbsp;</div></li><li><div>                if ( isset( $data['replyto_email'] ) && ! $helper_user-&gt;validEmail( $data['replyto_email'] ) ) {&nbsp;</div></li><li><div>                    if ( ! $data['replyto_email'] ) {&nbsp;</div></li><li><div>                        $data['replyto_email'] = __( 'empty', WYSIJA );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $this-&gt;error( sprintf( __( 'The &lt;strong&gt;reply to&lt;/strong&gt; email value you have entered (%1$s) is not a valid email address.', WYSIJA ), '' ), true );&nbsp;</div></li><li><div>                    $data['replyto_email'] = $this-&gt;values['replyto_email'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( isset( $data['bounce_rule_action_required_forwardto'] ) && ! $helper_user-&gt;validEmail( $data['bounce_rule_action_required_forwardto'] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;error('Invalid bounce forward email');&nbsp;</div></li><li><div>                    $data['bounce_rule_action_required_forwardto'] = $this-&gt;values['bounce_rule_action_required_forwardto'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( isset( $data['bounce_rule_blocked_ip_forwardto'] ) && ! $helper_user-&gt;validEmail( $data['bounce_rule_blocked_ip_forwardto'] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;error('Invalid bounce forward email');&nbsp;</div></li><li><div>                    $data['bounce_rule_blocked_ip_forwardto'] = $this-&gt;values['bounce_rule_blocked_ip_forwardto'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( isset( $data['bounce_rule_nohandle_forwardto'] ) && ! $helper_user-&gt;validEmail( $data['bounce_rule_nohandle_forwardto'] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;error('Invalid bounce forward email');&nbsp;</div></li><li><div>                    $data['bounce_rule_nohandle_forwardto'] = $this-&gt;values['bounce_rule_nohandle_forwardto'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // in that case the admin changed the frequency of the wysija cron meaning that we need to clear it&nbsp;</div></li><li><div>                // network's method frequency has changed&nbsp;</div></li><li><div>                if ( isset( $data['ms_sending_emails_each'] ) && $data['ms_sending_emails_each'] != $this-&gt;getValue( 'ms_sending_emails_each' ) ) {&nbsp;</div></li><li><div>                    $ms_sending_freq_has_changed = true;&nbsp;</div></li><li><div>                    $data['last_save'] = time();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // we're on a single site and the sending frequency has been modified&nbsp;</div></li><li><div>                // we need to refresh the sending scheduled task down below&nbsp;</div></li><li><div>                if ( isset( $data['sending_emails_each'] ) && $data['sending_emails_each'] != $this-&gt;getValue( 'sending_emails_each' ) ) {&nbsp;</div></li><li><div>                    $sending_freq_has_changed = true;&nbsp;</div></li><li><div>                    $data['last_save'] = time();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // we're on a single site and the bounce frequency has been changed&nbsp;</div></li><li><div>                // we need to refresh the bounce scheduled task down below&nbsp;</div></li><li><div>                if ( isset( $data['bouncing_emails_each'] ) && $data['bouncing_emails_each'] != $this-&gt;getValue( 'bouncing_emails_each' ) ) {&nbsp;</div></li><li><div>                    $bouncing_freq_has_changed = true;&nbsp;</div></li><li><div>                    $data['last_save'] = time();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if saved with gmail then we set up the smtp settings&nbsp;</div></li><li><div>                // @deprecated since 2.6.12&nbsp;</div></li><li><div>                if ( isset( $data['sending_method'] ) ) {&nbsp;</div></li><li><div>                    if ( $data['sending_method'] == 'gmail' ) {&nbsp;</div></li><li><div>                        $data['smtp_host'] = 'smtp.gmail.com';&nbsp;</div></li><li><div>                        $data['smtp_port'] = '465';&nbsp;</div></li><li><div>                        $data['smtp_secure'] = 'ssl';&nbsp;</div></li><li><div>                        $data['smtp_auth'] = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // basic validation of the smtp_host field&nbsp;</div></li><li><div>                if ( isset( $data['smtp_host'] ) ) {&nbsp;</div></li><li><div>                    $data['smtp_host'] = trim( $data['smtp_host'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // specific case to identify common action to different rules there some that don't appear in the interface, yet we use them.&nbsp;</div></li><li><div>                // BEN: this code needs to be reviewed and retested... I know what is the purpose but I don't understand $indexrule and $ruleMain&nbsp;</div></li><li><div>                foreach ( $data as $key =&gt; $value ) {&nbsp;</div></li><li><div>                    $fs = 'bounce_rule_';&nbsp;</div></li><li><div>                    if ( strpos( $key, $fs ) !== false ) {&nbsp;</div></li><li><div>                        if ( strpos( $key, '_forwardto' ) === false ) {&nbsp;</div></li><li><div>                            $indexrule = str_replace( $fs, '', $key );&nbsp;</div></li><li><div>                            $helper_rules = WYSIJA::get( 'rules', 'helper', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                            $rules = $helper_rules-&gt;getRules();&nbsp;</div></li><li><div>                            foreach ( $rules as $keyy =&gt; $vals ) {&nbsp;</div></li><li><div>                                if ( isset( $vals['behave'] ) ) {&nbsp;</div></li><li><div>                                    $ruleMain = $helper_rules-&gt;getRules( $vals['behave'] );&nbsp;</div></li><li><div>                                    $data[ $fs . $vals['key'] ] = $value;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // the regenerate box appeared for old versions of MailPoet where we had to switch from a 512 bits DKIM key to a 1024 for better score with Gmail&nbsp;</div></li><li><div>                // if the dkim_regenerate box has been ticked then we unset the dkim values so that they are regenerated in the next page load&nbsp;</div></li><li><div>                if ( isset( $data['dkim_regenerate'] ) && $data['dkim_regenerate'] == 'regenerate' ) {&nbsp;</div></li><li><div>                    if ( isset( $this-&gt;values['dkim_pubk'] ) ) {&nbsp;</div></li><li><div>                        unset($data['dkim_pubk']);&nbsp;</div></li><li><div>                        unset($this-&gt;values['dkim_pubk']);&nbsp;</div></li><li><div>                        unset($data['dkim_privk']);&nbsp;</div></li><li><div>                        unset($this-&gt;values['dkim_privk']);&nbsp;</div></li><li><div>                        unset($data['dkim_regenerate']);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // when we switch the double optin value on to off or off to on, we refresh the total user count which is different in both cases&nbsp;</div></li><li><div>                if ( isset( $data['confirm_dbleoptin'] ) && isset( $this-&gt;values['confirm_dbleoptin'] ) && $data['confirm_dbleoptin'] != $this-&gt;values['confirm_dbleoptin'] ) {&nbsp;</div></li><li><div>                    $helper_user = WYSIJA::get( 'user', 'helper' );&nbsp;</div></li><li><div>                    $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_multisite = is_multisite();&nbsp;</div></li><li><div>            $is_network_admin = WYSIJA::current_user_can( 'manage_network' );&nbsp;</div></li><li><div>            $global_MS_settings = array();&nbsp;</div></li><li><div>            foreach ( $data as $key =&gt; $value ) {&nbsp;</div></li><li><div>                // we detect a ms value, so we put it in a separate array to store it somewhere else central&nbsp;</div></li><li><div>                if ( $is_multisite && $is_network_admin && strpos( $key, 'ms_' ) !== false ) {&nbsp;</div></li><li><div>                    $global_MS_settings[ $key ] = $value;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // verify that the confirm email body contains an activation link&nbsp;</div></li><li><div>                // if it doesn't add it at the end of the email&nbsp;</div></li><li><div>                if ( $key == 'confirm_email_body' && strpos( $value, '[activation_link]' ) === false ) {&nbsp;</div></li><li><div>                    $value .= &quot;\n&quot; . '[activation_link]Click here to confirm your subscription.[/activation_link]';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // I'm not sure why do we do that, we separate the DKIm wrappers from teh value saved in the option.. why not, there must be a reason&nbsp;</div></li><li><div>                if ( $key == 'dkim_pubk' ) {&nbsp;</div></li><li><div>                    $value = str_replace( array( '-----BEGIN PUBLIC KEY-----', '-----END PUBLIC KEY-----', &quot;\n&quot; ), '', $value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if( is_string($value) ) {&nbsp;</div></li><li><div>                    $value = preg_replace( '#&lt; *script(?:(?!&lt; */ *script *&gt;).)*&lt; */ *script *&gt;#isU', '', $value );&nbsp;</div></li><li><div>                                        $value = preg_replace(&quot;#&lt;([^&gt;&lt;]+?)([^a-z_\-]on\w*|xmlns)(\s*=\s*[^&gt;&lt;]*)([&gt;&lt;]*)#i&quot;, &quot;&lt;\\1\\4&quot;, $value);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // for the manage subscription option you can select which list appear publicy to the user in their subscription page.&nbsp;</div></li><li><div>                // this piece of code  make sure that they appear or not&nbsp;</div></li><li><div>                if ( $key == 'manage_subscriptions_lists' ) {&nbsp;</div></li><li><div>                    $model_list = WYSIJA::get( 'list', 'model' );&nbsp;</div></li><li><div>                    $model_list-&gt;update( array( 'is_public' =&gt; 0 ), array( 'is_public' =&gt; 1 ) );&nbsp;</div></li><li><div>                    $model_list-&gt;reset();&nbsp;</div></li><li><div>                    $model_list-&gt;update( array( 'is_public' =&gt; 1 ), array( 'list_id' =&gt; $value ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    unset( $this-&gt;values[ $key ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // we have a variable in this class which is defaults&nbsp;</div></li><li><div>                // we save the option only if its value is different than the default one: no need to overload the db.&nbsp;</div></li><li><div>                if ( ! isset( $this-&gt;defaults[ $key ] ) || ( isset( $this-&gt;defaults[ $key ] ) && $value != $this-&gt;defaults[ $key ] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;values[ $key ] = $value;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    unset( $this-&gt;values[ $key ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // save the confirmation email in the email table&nbsp;</div></li><li><div>            // IMPORTANT: once we move the confirmation email to the newsletter listing we can get rid of that&nbsp;</div></li><li><div>            if ( isset( $data['confirm_email_title'] ) && isset( $data['confirm_email_body'] ) ) {&nbsp;</div></li><li><div>                $model_email = WYSIJA::get( 'email', 'model', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                $is_multisite = is_multisite();&nbsp;</div></li><li><div>                // the from email on a multisite with the network method on is coming from the ms value&nbsp;</div></li><li><div>                if ( $is_multisite && $data['sending_method'] == 'network' ) {&nbsp;</div></li><li><div>                    $from_email = $data['ms_from_email'];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $from_email = $data['from_email'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // updating email&nbsp;</div></li><li><div>                $model_email-&gt;update(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'from_name' =&gt; $data['from_name'], &nbsp;</div></li><li><div>                        'from_email' =&gt; $from_email, &nbsp;</div></li><li><div>                        'replyto_name' =&gt; $data['replyto_name'], &nbsp;</div></li><li><div>                        'replyto_email' =&gt; $data['replyto_email'], &nbsp;</div></li><li><div>                        'subject' =&gt; $data['confirm_email_title'], &nbsp;</div></li><li><div>                        'body' =&gt; $data['confirm_email_body'], &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'email_id' =&gt; $this-&gt;values['confirm_email_id'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset($this-&gt;values['confirm_email_title']);&nbsp;</div></li><li><div>            unset($this-&gt;values['confirm_email_body']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // serialize and encode the option's values and save them in WP's options&nbsp;</div></li><li><div>        update_option( $this-&gt;name_option, base64_encode( serialize( $this-&gt;values ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // when we are on a multisite, part of the options need to be saved into a global option common to all of the sites&nbsp;</div></li><li><div>        if ( $is_multisite ) {&nbsp;</div></li><li><div>            // the network admin has access to that extra information through the interfaces when does interfaces are generated then $dataMultisite is filled with values&nbsp;</div></li><li><div>            if ( ! empty( $global_MS_settings ) ) {&nbsp;</div></li><li><div>                if ( $ms_sending_freq_has_changed ) {&nbsp;</div></li><li><div>                    // if the sending frequency on the network method has changed, we need to update each single cron task on all of the child sites&nbsp;</div></li><li><div>                    // we reset an array to clear the cron of every single site using the multisite method&nbsp;</div></li><li><div>                    update_site_option( 'ms_wysija_sending_cron', array() );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // get the data which was saved in the global option before&nbsp;</div></li><li><div>                $data_saved_ms_before = unserialize( base64_decode( get_site_option( 'ms_' . $this-&gt;name_option ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if it's not empty we just merge both sets of values&nbsp;</div></li><li><div>                if ( ! empty( $data_saved_ms_before ) ) {&nbsp;</div></li><li><div>                    $global_MS_settings = array_merge( $data_saved_ms_before, $global_MS_settings );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // we save the global ms option&nbsp;</div></li><li><div>                update_site_option( 'ms_' . $this-&gt;name_option, base64_encode( serialize( $global_MS_settings ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // let's merge the latest MS modified values with the values of the site's config, this is to avoid a bug after saving&nbsp;</div></li><li><div>            $data_saved_ms_fresh = unserialize( base64_decode( get_site_option( 'ms_' . $this-&gt;name_option ) ) );&nbsp;</div></li><li><div>            if ( ! empty( $data_saved_ms_fresh ) ) {&nbsp;</div></li><li><div>                $this-&gt;values = array_merge( $this-&gt;values, $data_saved_ms_fresh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // the sending frequency has changed on that site's settings let's clear the frequency recorded in WP's and wysija's crons&nbsp;</div></li><li><div>        if ( $sending_freq_has_changed ) {&nbsp;</div></li><li><div>            // WordPress cron clearing&nbsp;</div></li><li><div>            wp_clear_scheduled_hook( 'wysija_cron_queue' );&nbsp;</div></li><li><div>            // MailPoet's cron reset&nbsp;</div></li><li><div>            WYSIJA::set_cron_schedule( 'queue' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // same than above but with the bounce frequency&nbsp;</div></li><li><div>        if ( $bouncing_freq_has_changed ) {&nbsp;</div></li><li><div>            // WordPress cron clearing&nbsp;</div></li><li><div>            wp_clear_scheduled_hook( 'wysija_cron_bounce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // MailPoet's cron reset&nbsp;</div></li><li><div>            WYSIJA::set_cron_schedule( 'bounce' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if it has been saved through the interface we notify the admin&nbsp;</div></li><li><div>        if ( $saved_through_interfaces ) {&nbsp;</div></li><li><div>            $this-&gt;notice( __( 'Your settings are saved.', WYSIJA ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * some values in the settings needs to be overridden by ms values this is used in the getValue function&nbsp;</div></li><li><div>     * it's a filter because of the premium plugin interacting with it&nbsp;</div></li><li><div>     * eg bounce with ms_bounce&nbsp;</div></li><li><div>     * @param array $ms_overriden&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function ms_override( $ms_overriden ) {&nbsp;</div></li><li><div>        if ( $this-&gt;getValue( 'premium_key' ) ) {&nbsp;</div></li><li><div>            $bounce_value = array( 'bounce', 'bouncing' );&nbsp;</div></li><li><div>            return array_merge( $ms_overriden, $bounce_value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $ms_overriden;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return  a setting value from our encoded config WordPress' option&nbsp;</div></li><li><div>     * @param string $key&nbsp;</div></li><li><div>     * @param type $default&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function getValue( $key, $default = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // special case for multisite&nbsp;</div></li><li><div>        if ( is_multisite() && $key != 'premium_key' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if we're getting the from email value we set a default value for the ms FROM&nbsp;</div></li><li><div>            if ( $key == 'ms_from_email' && ! isset( $this-&gt;defaults['ms_from_email'] ) ) {&nbsp;</div></li><li><div>                $helper_toolbox = WYSIJA::get( 'toolbox', 'helper' );&nbsp;</div></li><li><div>                if ( is_object( $helper_toolbox ) ) {&nbsp;</div></li><li><div>                    $this-&gt;defaults['ms_from_email'] = 'info@' . $helper_toolbox-&gt;_make_domain_name( network_site_url() );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $values_overridden_by_multisite = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // apply a filter to add key/values to&nbsp;</div></li><li><div>            add_filter( 'mpoet_ms_override', array( $this, 'ms_override' ), 1 );&nbsp;</div></li><li><div>            $values_overidden_by_bounce = apply_filters( 'mpoet_ms_override', $values_overridden_by_multisite );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $values_overidden_by_bounce as $key_part_bounce ) {&nbsp;</div></li><li><div>                if ( strpos( $key, $key_part_bounce . '_' ) !== false && strpos( $key, 'ms_' . $key_part_bounce . '_' ) === false ) {&nbsp;</div></li><li><div>                    $key = 'ms_' . $key;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $key == 'beta_mode' ) {&nbsp;</div></li><li><div>                $key = 'ms_'.$key;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $this-&gt;values[ $key ] ) ) {&nbsp;</div></li><li><div>            if ( $key == 'pluginsImportableEgg' ) {&nbsp;</div></li><li><div>                $helperImport = WYSIJA::get( 'plugins_import', 'helper', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                foreach ( $this-&gt;values[ $key ] as $tablename =&gt; $plugInfosExtras ) {&nbsp;</div></li><li><div>                    $extra_data = $helperImport-&gt;getPluginsInfo( $tablename );&nbsp;</div></li><li><div>                    if ( $extra_data ) {&nbsp;</div></li><li><div>                        $this-&gt;values[ $key ][ $tablename ] = array_merge( $extra_data, $this-&gt;values[ $key ][ $tablename ] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $this-&gt;values[ $key ];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // special case for the confirmation email&nbsp;</div></li><li><div>            if ( in_array( $key, array( 'confirm_email_title', 'confirm_email_body' ) ) ) {&nbsp;</div></li><li><div>                $model_email = WYSIJA::get( 'email', 'model', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>                $result_email = $model_email-&gt;getOne( $this-&gt;getValue( 'confirm_email_id' ) );&nbsp;</div></li><li><div>                if ( $result_email ) {&nbsp;</div></li><li><div>                    $this-&gt;values['confirm_email_title'] = $result_email['subject'];&nbsp;</div></li><li><div>                    $this-&gt;values['confirm_email_body'] = $result_email['body'];&nbsp;</div></li><li><div>                    return $this-&gt;values[ $key ];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( $default === false && isset( $this-&gt;defaults[ $key ] ) ) {&nbsp;</div></li><li><div>                        return $this-&gt;defaults[ $key ];&nbsp;</div></li><li><div>                    } elseif ( ! ( $default === false ) ) {&nbsp;</div></li><li><div>                        return $default;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( $default === false && isset( $this-&gt;defaults[ $key ] ) ) {&nbsp;</div></li><li><div>                    return $this-&gt;defaults[ $key ];&nbsp;</div></li><li><div>                } elseif ( ! ( $default === false ) ) {&nbsp;</div></li><li><div>                    return $default;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * TODO should this method really be here? It is used when rendering an email or when sending one&nbsp;</div></li><li><div>     * @param type $editor&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function emailFooterLinks( $editor = false ) {&nbsp;</div></li><li><div>        $unsubscribe = array();&nbsp;</div></li><li><div>        $unsubscribetxt = $editsubscriptiontxt = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;values['unsubscribe_linkname'] ) ) {&nbsp;</div></li><li><div>            $unsubscribetxt = __( 'Unsubscribe', WYSIJA );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $unsubscribetxt = $this-&gt;getValue( 'unsubscribe_linkname' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;values['manage_subscriptions_linkname'] ) ) {&nbsp;</div></li><li><div>            $editsubscriptiontxt = __( 'Edit your subscription', WYSIJA );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $editsubscriptiontxt = $this-&gt;getValue( 'manage_subscriptions_linkname' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $unsubscribe[0] = array(&nbsp;</div></li><li><div>                'link' =&gt; '[unsubscribe_link]', &nbsp;</div></li><li><div>                'label' =&gt; $unsubscribetxt, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;getValue( 'manage_subscriptions' ) ) {&nbsp;</div></li><li><div>            $unsubscribe[1] = array(&nbsp;</div></li><li><div>                'link' =&gt; '[subscriptions_link]', &nbsp;</div></li><li><div>                'label' =&gt; $editsubscriptiontxt, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $editor ) {&nbsp;</div></li><li><div>            $modelU = WYSIJA::get( 'user', 'model', false, 'wysija-newsletters', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $unsubscribe[0]['link'] = $modelU-&gt;getConfirmLink( false, 'unsubscribe', false, true ) . '&demo=1';&nbsp;</div></li><li><div>            if ( $this-&gt;getValue( 'manage_subscriptions' ) ) {&nbsp;</div></li><li><div>                $unsubscribe[1]['link'] = $modelU-&gt;getConfirmLink( false, 'subscriptions', false, true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $unsubscribe;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * TODO should this method really be here?&nbsp;</div></li><li><div>     * It is used when rendering an email in the editor or before sending it&nbsp;</div></li><li><div>     * @param boolean $editor if the link is in the editor, then it will be a demo link&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function view_in_browser_link( $editor = false ) {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$this-&gt;getValue('viewinbrowser')) {&nbsp;</div></li><li><div>                    return $data;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $this-&gt;values['viewinbrowser_linkname'] ) ) {&nbsp;</div></li><li><div>                        // Grab the value for the view in browser link&nbsp;</div></li><li><div>                        $link = $this-&gt;values['viewinbrowser_linkname'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If we don't have the value from DB load a default&nbsp;</div></li><li><div>                if ( ! isset( $link ) ||  empty( $link ) || ! $link ) {&nbsp;</div></li><li><div>                        $link = esc_attr__( 'Display problems? [link]View this newsletter in your browser.[/link]', WYSIJA );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if we spot a link tag in the text we decompose the text in different parts pre rendering&nbsp;</div></li><li><div>        if ( strpos( $link, '[link]' ) !== false ) {&nbsp;</div></li><li><div>            $linkpre = explode( '[link]', $link );&nbsp;</div></li><li><div>            $data['pretext'] = $linkpre[0];&nbsp;</div></li><li><div>            $linkpost = explode( '[/link]', $linkpre[1] );&nbsp;</div></li><li><div>            $data['posttext'] = $linkpost[1];&nbsp;</div></li><li><div>            $data['label'] = $linkpost[0];&nbsp;</div></li><li><div>            $data['link'] = '[view_in_browser_link]';&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>                    $data['pretext'] = $data['posttext'] = '';&nbsp;</div></li><li><div>                    $data['label'] = $link;&nbsp;</div></li><li><div>                    $data['link'] = '[view_in_browser_link]';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $editor ) {&nbsp;</div></li><li><div>            $params_url = array(&nbsp;</div></li><li><div>                'wysija-page' =&gt; 1, &nbsp;</div></li><li><div>                'controller' =&gt; 'email', &nbsp;</div></li><li><div>                'action' =&gt; 'view', &nbsp;</div></li><li><div>                'email_id' =&gt; 0, &nbsp;</div></li><li><div>                'user_id' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            if ( ! empty( $_REQUEST['id'] ) ) {&nbsp;</div></li><li><div>                $params_url['email_id'] = (int)$_REQUEST['id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $data['link'] = WYSIJA::get_permalink( $this-&gt;getValue( 'confirm_email_link' ), $params_url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Add a deprecation warning for this Method.&nbsp;</div></li><li><div>    function viewInBrowserLink( $editor = false ) {&nbsp;</div></li><li><div>        _doing_it_wrong( 'WYSIJA_model_config-&gt;viewInBrowserLink()', __( 'Use `view_in_browser_link` instead.', WYSIJA ), '2.6.10' );&nbsp;</div></li><li><div>        return $this-&gt;view_in_browser_link( $editor );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wysija_model_config/" class="active">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wysija_model_config/" class="">2.7.4</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.3/classes/wysija_model_config/" class="">2.7.3</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.2/classes/wysija_model_config/" class="">2.7.2</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.1/classes/wysija_model_config/" class="">2.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WYSIJA_model_config</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>