<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.1.2" data-slug="gravity-forms-salesforce-add-on" data-type="file" data-id="37398"><head xmlns="http://www.w3.org/1999/xhtml"><title> inc-salesforce-api | file | Gravity Forms Salesforce Add On | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, gravity-forms-salesforce-add-on, 3.1.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.15"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=7d4d8c3ee040df928a6036de118fccb1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.15' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/inc-salesforce-api/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-salesforce-api%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-salesforce-api%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-forms-salesforce-add-on-3.1.2-file-inc-salesforce-api","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="inc-salesforce-api" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms-salesforce-add-&hellip;." href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/" class="plugin"><span property="name">gravity-forms-salesforce-add-&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.1.2." href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/" class="H_VERSION"><span property="name">3.1.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">inc-salesforce-api</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="290"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/all/" title="All">All <span class="count badge">290</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="44"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/hooks/" title="Hooks">Hooks <span class="count badge">44</span></a></li><li class="" data-id="action" data-count="4"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/actions/" title="Actions">Actions <span class="count badge">4</span></a></li><li class="" data-id="filter" data-count="40"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/filters/" title="Filters">Filters <span class="count badge">40</span></a></li><li class="" data-id="class" data-count="234"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/classes/" title="Classes">Classes <span class="count badge">234</span></a></li><li class="" data-id="constant" data-count="5"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/constants/" title="Constants">Constants <span class="count badge">5</span></a></li><li class="" data-id="function" data-count="7"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/functions/" title="Functions">Functions <span class="count badge">7</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/gravity-forms-salesforce-add-on/3.1.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/inc/salesforce-api.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gravity Forms Salesforce API Add-On</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Loaded by the salesforce.php core plugin file.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use OAuth\OAuth2\Service\Salesforce;&nbsp;</div></li><li><div>use OAuth\Common\Http\Client\CurlClient;&nbsp;</div></li><li><div>use OAuth\Common\Storage\WordPressMemory as WordPressMemory;&nbsp;</div></li><li><div>use OAuth\Common\Consumer\Credentials;&nbsp;</div></li><li><div>use OAuth\Common\Http\Uri\Uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>register_activation_hook( KWS_GF_Salesforce::$file, array(&quot;GFSalesforce&quot;, &quot;add_permissions&quot;));&nbsp;</div></li><li><div>register_activation_hook( KWS_GF_Salesforce::$file, array(&quot;GFSalesforce&quot;, &quot;force_refresh_transients&quot;));&nbsp;</div></li><li><div>register_deactivation_hook( KWS_GF_Salesforce::$file, array(&quot;GFSalesforce&quot;, &quot;force_refresh_transients&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class GFSalesforce {&nbsp;</div></li><li><div>  const GF_SF_SANDBOX = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static $instance;&nbsp;</div></li><li><div>  public static $foreign_keys = array();&nbsp;</div></li><li><div>  public $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $name = &quot;Salesforce: API&quot;;&nbsp;</div></li><li><div>  private static $api = '';&nbsp;</div></li><li><div>  private static $path = &quot;gravity-forms-salesforce/salesforce-api.php&quot;;&nbsp;</div></li><li><div>  private static $url = &quot;http:<span class="comment">//formplugin.com&quot;;</span>&nbsp;</div></li><li><div>  private static $slug = &quot;gravity-forms-salesforce&quot;;&nbsp;</div></li><li><div>  private static $version;&nbsp;</div></li><li><div>  private static $min_gravityforms_version = &quot;1.3.9&quot;;&nbsp;</div></li><li><div>  private static $cache_time = 86400; <span class="comment">// 24 hours</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Default settings</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static $settings = array(&nbsp;</div></li><li><div>      'notify' =&gt; false, &nbsp;</div></li><li><div>      &quot;notifyemail&quot; =&gt; '', &nbsp;</div></li><li><div>      'cache_time' =&gt; 86400, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::$version = KWS_GF_Salesforce::version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('init', array(&$this, 'init'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// New fields at entries export</span>&nbsp;</div></li><li><div>      add_filter( 'gform_export_fields', array( 'GFSalesforce', 'export_entries_add_fields' ), 10, 1 );&nbsp;</div></li><li><div>      add_filter( 'gform_export_field_value', array( 'GFSalesforce', 'export_entries_add_values' ), 999, 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Singleton instance of our class</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.1</span>&nbsp;</div></li><li><div><span class="comment">   * @return GFSalesforce</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function Instance()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (self::$instance === null) {&nbsp;</div></li><li><div>          self::$instance = new GFSalesforce();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_debug(__METHOD__ . ': init singleton instance');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          self::log_debug(__METHOD__ . ': refresh singleton instance');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Plugin starting point. Will load appropriate files</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init() {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($pagenow == 'plugins.php' || defined('RG_CURRENT_PAGE') && RG_CURRENT_PAGE == &quot;plugins.php&quot;) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter('plugin_action_links', array('GFSalesforce', 'settings_link'), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!self::is_gravityforms_supported()) {&nbsp;</div></li><li><div>         return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::$settings = get_option( &quot;gf_salesforce_settings&quot;, self::$settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::include_files();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_admin()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Process the OAuth chain</span>&nbsp;</div></li><li><div>          $this-&gt;processSalesforceResponse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//creates a new Settings page on Gravity Forms' settings screen</span>&nbsp;</div></li><li><div>          if(self::has_access(&quot;gravityforms_salesforce&quot;)) {&nbsp;</div></li><li><div>              RGForms::add_settings_page( array(&nbsp;</div></li><li><div>                  'name' =&gt; &quot;sf-loader-api&quot;, &nbsp;</div></li><li><div>                  'tab_label' =&gt; 'Salesforce: API', &nbsp;</div></li><li><div>                  'handler' =&gt; array(&quot;GFSalesforce&quot;, &quot;settings_page&quot;), &nbsp;</div></li><li><div>                  'icon_path' =&gt; self::get_base_url() . &quot;/assets/images/salesforce-128.png&quot;, &nbsp;</div></li><li><div> ), array(&quot;GFSalesforce&quot;, &quot;settings_page&quot;), self::get_base_url() . &quot;/assets/images/salesforce-128.png&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::refresh_transients();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Since 3.0 - add feed status to form array</span>&nbsp;</div></li><li><div>      add_filter( 'gform_pre_render', array('GFSalesforce', 'add_feed_status_to_form'), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// since 2.6.0</span> - send entry to Salesforce if updated in the admin</span>&nbsp;</div></li><li><div>      add_action( 'gform_after_update_entry', array( 'GFSalesforce', 'manual_export' ), 10, 2);&nbsp;</div></li><li><div>      add_action( 'admin_init', array( 'GFSalesforce', 'manual_export' ), 10, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//integrating with Members plugin</span>&nbsp;</div></li><li><div>      if(function_exists('members_get_capabilities'))&nbsp;</div></li><li><div>          add_filter('members_get_capabilities', array(&quot;GFSalesforce&quot;, &quot;members_get_capabilities&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//creates the subnav left menu</span>&nbsp;</div></li><li><div>      add_filter(&quot;gform_addon_navigation&quot;, array('GFSalesforce', 'create_menu'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(self::is_salesforce_page()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//enqueueing sack for AJAX requests</span>&nbsp;</div></li><li><div>          wp_enqueue_script(array(&quot;sack&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// since 2.5.2</span></span>&nbsp;</div></li><li><div>          add_action( 'admin_enqueue_scripts', array( 'GFSalesforce', 'add_custom_script') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//loading Gravity Forms tooltips</span>&nbsp;</div></li><li><div>          require_once(GFCommon::get_base_path() . &quot;/tooltips.php&quot;);&nbsp;</div></li><li><div>          add_filter('gform_tooltips', array('GFSalesforce', 'tooltips'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//runs the setup when version changes</span>&nbsp;</div></li><li><div>          self::setup();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       } else if(in_array(RG_CURRENT_PAGE, array(&quot;admin-ajax.php&quot;))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action('wp_ajax_rg_update_feed_active', array('GFSalesforce', 'update_feed_active'));&nbsp;</div></li><li><div>          add_action('wp_ajax_gf_select_salesforce_form', array('GFSalesforce', 'select_salesforce_form'));&nbsp;</div></li><li><div>          <span class="comment">//since 2.5.2</span>&nbsp;</div></li><li><div>          add_action('wp_ajax_get_options_as_fields', array( 'GFSalesforce', 'get_options_as_fields'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action('wp_ajax_rg_update_feed_sort', array('GFSalesforce', 'update_feed_sort'));&nbsp;</div></li><li><div>          add_action('wp_ajax_nopriv_rg_update_feed_sort', array('GFSalesforce', 'update_feed_sort'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else{&nbsp;</div></li><li><div>           <span class="comment">//handling post submission.</span>&nbsp;</div></li><li><div>          add_action(&quot;gform_after_submission&quot;, array('GFSalesforce', 'export'), 10, 2);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter(&quot;gform_logging_supported&quot;, array('GFSalesforce', &quot;set_logging_supported&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'gform_entry_info', array('GFSalesforce', 'entry_info_send_to_salesforce_checkbox'), 99, 2);&nbsp;</div></li><li><div>      add_filter( 'gform_entrydetail_update_button', array('GFSalesforce', 'entry_info_send_to_salesforce_button'), 999, 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Modify the form array to add slug feed activity to the form itself.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Adds [feed-{$slug}] key to the form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array      $form Form array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean      $ajax Is ajax or not</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function add_feed_status_to_form($form, $ajax) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(self::has_feed($form['id'])) {&nbsp;</div></li><li><div>          $form['feed-'.self::$slug] = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $form;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function set_logging_supported($plugins) {&nbsp;</div></li><li><div>      $plugins[self::$slug] = self::$name;&nbsp;</div></li><li><div>      return $plugins;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function force_refresh_transients() {&nbsp;</div></li><li><div>      self::refresh_transients(true);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function refresh_transients($force = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($force || (isset($_GET['refresh']) && current_user_can('manage_options') && $_GET['refresh'] === 'transients')) {&nbsp;</div></li><li><div>          $wpdb-&gt;query(&quot;DELETE FROM {$wpdb-&gt;options} WHERE `option_name` LIKE '%_transient_sfgf_%' OR `option_name` LIKE '%_transient_timeout_sfgf_%'&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the files needed to process OAuth, Gravity Forms</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function include_files() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//loading data class</span>&nbsp;</div></li><li><div>      require_once(self::get_base_path() . &quot;inc/data.php&quot;);&nbsp;</div></li><li><div>      require_once(self::get_base_path() . &quot;inc/edit-form.php&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !class_exists('OAuth\Common\autoloader') ) {&nbsp;</div></li><li><div>          include_once KWS_GF_Salesforce::$plugin_dir_path.'lib/PHPoAuthLib/src/OAuth/bootstrap.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !class_exists('OAuth\ServiceFactory') ) {&nbsp;</div></li><li><div>          include_once KWS_GF_Salesforce::$plugin_dir_path.'lib/PHPoAuthLib/src/OAuth/ServiceFactory.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !class_exists('WordpressMemory') ) {&nbsp;</div></li><li><div>          include_once KWS_GF_Salesforce::$plugin_dir_path.'lib/WordPressMemory.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Handle the OAuth response from Salesforce</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function processSalesforceResponse() {&nbsp;</div></li><li><div>      if (!empty($_GET['code']) && !empty($_GET['display']) && $_GET['display'] === 'page') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings = self::$settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $salesforceService = self::getSalesforceService();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The token's not the same, nor may the endpoint be.</span>&nbsp;</div></li><li><div>          delete_transient('salesforce_endpoint_token');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              self::log_debug( sprintf('processSalesforceResponse: Received access code (%s). Now fetching Access Token.', esc_attr($_GET['code']) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// This was a callback request from Salesforce, get the token</span>&nbsp;</div></li><li><div>              $salesforceService-&gt;requestAccessToken($_GET['code']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              unset($settings['error']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } catch (Exception $e) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_error('processSalesforceResponse: Clearing token, since there was an error.');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::clearToken();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $settings['error'] = self::processErrorMessage($e-&gt;getMessage());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_error('processSalesforceResponse: '.$settings['error'] .' [Raw error message: '. $e-&gt;getMessage() .']' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_option(&quot;gf_salesforce_settings&quot;, $settings);&nbsp;</div></li><li><div>          self::$settings = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Whether the response worked or not</span>&nbsp;</div></li><li><div>          wp_redirect( self::link_to_settings( false ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          exit();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function processErrorMessage($value='') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch(true) {&nbsp;</div></li><li><div>          case strpos($value, 'invalid_grant'):&nbsp;</div></li><li><div>              $message = &quot;This authorization request has expired, or (less likely) the IP is restricted or invalid login hours.&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case strpos($value, 'redirect_uri_mismatch'):&nbsp;</div></li><li><div>              $message = &quot;The redirect_uri is a mismatch with remote access application definition. See `getSalesforceService()` method in the code.&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case strpos($value, 'inactive_user'):&nbsp;</div></li><li><div>              $message = &quot;The user is inactive&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case strpos($value, 'inactive_org'):&nbsp;</div></li><li><div>              $message = &quot;The organization is locked, closed, or suspended&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case strpos($value, 'invalid_client_id'):&nbsp;</div></li><li><div>              $message = &quot;client ID invalid&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'invalid_request':&nbsp;</div></li><li><div>              $message = &quot;HTTPS required or must use HTTP POST or secret type not supported&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case strpos($value, 'invalid_client_credentials'):&nbsp;</div></li><li><div>          case strpos($value, 'invalid_client'):&nbsp;</div></li><li><div>              $message = &quot;Client consumer secret invalid&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $message;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get Salesforce OAuth service.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Uses the https://katz.co callback URL because of the developer token being used. If you want to use your own, filter</span>&nbsp;</div></li><li><div><span class="comment">   * the credentials using the filters provided.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @filter `gf_salesforce_service_credentials` `OAuth\Common\Consumer\Credentials` object.</span>&nbsp;</div></li><li><div><span class="comment">   * @filter `gf_salesforce_service_client` `OAuth\Common\Http\Client` object. Default: `CurlClient`</span>&nbsp;</div></li><li><div><span class="comment">   * @filter `gf_salesforce_service_storage` `OAuth\Common\Storage` object. Default: `WordPressMemory`</span>&nbsp;</div></li><li><div><span class="comment">   * @filter  `gf_salesforce_service_scopes` Modify the access the plugin has. Needs `api` and `refresh_token`.</span>&nbsp;</div></li><li><div><span class="comment">   * @filter  `gf_salesforce_service_is_sandbox` Modify whether to use the Sandbox. Returns `true` or `false`.</span>&nbsp;</div></li><li><div><span class="comment">   * @return OAuth\OAuth2\Service\Salesforce</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static private function getSalesforceService() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $credentials = new Credentials(&nbsp;</div></li><li><div>          '3MVG9y6x0357HledYGqazOFNBPUUAVtD9yRYNGk0TAknMvch_rM8aZxzmtd6T7lcBTB4mPQMJ9VZsBqF8kfBX', <span class="comment">// Consumer Token</span>&nbsp;</div></li><li><div>          '7911901779233377323', <span class="comment">// Consumer Secret, </span>&nbsp;</div></li><li><div>          'https:<span class="comment">//katz.co/oauth/' // Callback URL</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $client = new CurlClient;&nbsp;</div></li><li><div>      $storage = new WordPressMemory;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We want API access for the plugin, also the ability to refresh the token.</span>&nbsp;</div></li><li><div>      <span class="comment">// {@link http://www.salesforce.com/us/developer/docs/api_rest/Content/intro_understanding_refresh_token_oauth.htm}</span>&nbsp;</div></li><li><div>      $scopes = array('api', 'refresh_token');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Modify your service here.</span>&nbsp;</div></li><li><div>      $credentials = apply_filters( 'gf_salesforce_service_credentials', $credentials );&nbsp;</div></li><li><div>      $client = apply_filters( 'gf_salesforce_service_client', $client );&nbsp;</div></li><li><div>      $storage = apply_filters( 'gf_salesforce_service_storage', $storage );&nbsp;</div></li><li><div>      $scopes = apply_filters( 'gf_salesforce_service_scopes', $scopes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $salesforceService = new Salesforce($credentials, $client, $storage, $scopes);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is this a sandbox connection?</span>&nbsp;</div></li><li><div>      $salesforceService-&gt;setSandbox( (bool) apply_filters( 'gf_salesforce_service_is_sandbox', self::GF_SF_SANDBOX ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $salesforceService;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function getEndpoint($auth = '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If there's a cached endpoint, use it.</span>&nbsp;</div></li><li><div>      if( $cached = get_transient('salesforce_endpoint_token') ) {&nbsp;</div></li><li><div>          return $cached;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($auth)) {&nbsp;</div></li><li><div>          $auth = self::getAccessToken();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($auth)) {&nbsp;</div></li><li><div>          self::log_error('getEndpoint(): No OAuth token available');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = self::getTokenParam('id');&nbsp;</div></li><li><div>      $url = add_query_arg(array('oauth_token' =&gt; $auth), $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request = wp_remote_get( $url, array( 'sslverify' =&gt; false, 'timeout' =&gt; 60 ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_wp_error( $request ) && (int)$request['response']['code'] === 200) {&nbsp;</div></li><li><div>          $response = $request['body'];&nbsp;</div></li><li><div>          $response = json_decode($response);&nbsp;</div></li><li><div>          if(is_object($response)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $enterprise = apply_filters('gf_salesforce_enterprise', false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Set the version to the SOAP API version (SforceBaseClient-&gt;version)</span>&nbsp;</div></li><li><div>              if($enterprise) {&nbsp;</div></li><li><div>                  $output = str_replace('{version}', '27.0', $response-&gt;urls-&gt;enterprise);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $output = str_replace('{version}', '27.0', $response-&gt;urls-&gt;partner);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Cache the endpoint for a week</span>&nbsp;</div></li><li><div>              set_transient('salesforce_endpoint_token', $output, WEEK_IN_SECONDS);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $output;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else if(is_wp_error( $request )) {&nbsp;</div></li><li><div>          self::log_debug( sprintf( &quot;Could not get the endpoint. Here is the error data: %s\nand the request was made to:%s&quot;, print_r($request-&gt;get_error_messages(), true), $url ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          self::log_debug( sprintf( &quot;Could not get the endpoint. Here is the response: %s\nand the request was made to %s&quot;, print_r($request, true), $url) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function getToken() {&nbsp;</div></li><li><div>      $Storage = new WordPressMemory;&nbsp;</div></li><li><div>      if($Storage-&gt;hasAccessToken('Salesforce')) {&nbsp;</div></li><li><div>          return $Storage-&gt;retrieveAccessToken('Salesforce');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function clearToken() {&nbsp;</div></li><li><div>      $Storage = new WordPressMemory;&nbsp;</div></li><li><div>      self::log_debug('Token was cleared.');&nbsp;</div></li><li><div>      $Storage-&gt;clearToken('Salesforce');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Delete the refresh token if exists</span>&nbsp;</div></li><li><div>      delete_option( 'gf_salesforce_refreshtoken' );&nbsp;</div></li><li><div>      self::log_debug('Refresh Token cleared');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate a refresh token from the original OAuth token</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @link  http://help.salesforce.com/HTViewHelpDoc?id=remoteaccess_oauth_refresh_token_flow.htm</span>&nbsp;</div></li><li><div><span class="comment">   * @link  http://www.salesforce.com/us/developer/docs/api_rest/Content/intro_understanding_refresh_token_oauth.htm</span>&nbsp;</div></li><li><div><span class="comment">   * @return OAuth\Common\Token      New, refreshed token</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static private function refreshToken() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $Token = self::getToken();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $salesforceService = self::getSalesforceService();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug('refreshToken(): Refreshing access token.');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $Token = $salesforceService-&gt;refreshAccessToken($Token);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch(Exception $e) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_error('refreshToken(): Refreshing access token failed. Here is the error type: '. get_class($e) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug( sprintf('refreshToken(): Access token refreshed: %s', $Token-&gt;getAccessToken() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $Token;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function getRefreshToken() {&nbsp;</div></li><li><div>      if($TokenClass = self::getToken()) {&nbsp;</div></li><li><div>          return $TokenClass-&gt;getRefreshToken();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function getAccessToken() {&nbsp;</div></li><li><div>      if($TokenClass = self::getToken()) {&nbsp;</div></li><li><div>          return $TokenClass-&gt;getAccessToken();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function getTokenParams() {&nbsp;</div></li><li><div>      if($TokenClass = self::getToken()) {&nbsp;</div></li><li><div>          return $params = $TokenClass-&gt;getExtraParams();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function getTokenParam($key = '') {&nbsp;</div></li><li><div>      if(!empty($key) && $params = self::getTokenParams()) {&nbsp;</div></li><li><div>          if(array_key_exists($key, $params)) {&nbsp;</div></li><li><div>              return $params[$key];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns true if the current page is one of Gravity Forms pages. Returns false if not</span>&nbsp;</div></li><li><div>  public static function is_gravity_page($page = array()) {&nbsp;</div></li><li><div>      if(!class_exists('RGForms')) { return false; }&nbsp;</div></li><li><div>      $current_page = trim(strtolower(RGForms::get(&quot;page&quot;)));&nbsp;</div></li><li><div>      if(empty($page)) {&nbsp;</div></li><li><div>          $gf_pages = array(&quot;gf_edit_forms&quot;, &quot;gf_new_form&quot;, &quot;gf_entries&quot;, &quot;gf_settings&quot;, &quot;gf_export&quot;, &quot;gf_help&quot;);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $gf_pages = is_array($page) ? $page : array($page);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return in_array($current_page, $gf_pages);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function update_feed_active() {&nbsp;</div></li><li><div>      check_ajax_referer('rg_update_feed_active', 'rg_update_feed_active');&nbsp;</div></li><li><div>      $id = $_POST[&quot;feed_id&quot;];&nbsp;</div></li><li><div>      $feed = GFSalesforceData::get_feed($id);&nbsp;</div></li><li><div>      GFSalesforceData::update_feed($id, $feed[&quot;form_id&quot;], $_POST[&quot;is_active&quot;], $feed[&quot;meta&quot;]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update the feed sort order</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.1</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function update_feed_sort() {&nbsp;</div></li><li><div>      if( empty( $_POST['sort'] ) || !isset( $_POST['nonce'] ))&nbsp;</div></li><li><div>              <span class="comment">// ! wp_verify_nonce( $_POST['nonce'], 'rg_update_feed_sort' ) )</span>&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          exit(false);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      GFSalesforceData::update_feed_order($_POST['sort']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//--------------   Automatic upgrade ---------------------------------------------------</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function settings_link( $links, $file ) {&nbsp;</div></li><li><div>      static $this_plugin;&nbsp;</div></li><li><div>      if( ! $this_plugin ) $this_plugin = self::get_base_url();&nbsp;</div></li><li><div>      if ( $file == $this_plugin ) {&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;' . admin_url( 'admin.php?page=gf_salesforce' ) . '&quot; title=&quot;' . __('Select the Gravity Form you would like to integrate with Salesforce. Contacts generated by this form will be automatically added to your Salesforce account.', 'gravity-forms-salesforce') . '&quot;&gt;' . __('Feeds', 'gravity-forms-salesforce') . '&lt;/a&gt;';&nbsp;</div></li><li><div>          array_unshift( $links, $settings_link ); <span class="comment"><span class="comment">// before other links</span></span>&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;' . self::link_to_settings() . '&quot; title=&quot;' . __('Configure your Salesforce settings.', 'gravity-forms-salesforce') . '&quot;&gt;' . __('Settings', 'gravity-forms-salesforce') . '&lt;/a&gt;';&nbsp;</div></li><li><div>          array_unshift( $links, $settings_link ); <span class="comment"><span class="comment">// before other links</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns true if the current page is an Feed pages. Returns false if not</span>&nbsp;</div></li><li><div>  private static function is_salesforce_page() {&nbsp;</div></li><li><div>      global $plugin_page; $current_page = '';&nbsp;</div></li><li><div>      $salesforce_pages = array(&quot;gf_salesforce&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($_GET['page'])) {&nbsp;</div></li><li><div>          $current_page = trim(strtolower($_GET[&quot;page&quot;]));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (in_array($plugin_page, $salesforce_pages) || in_array($current_page, $salesforce_pages));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Creates or updates database tables. Will only run when version changes</span>&nbsp;</div></li><li><div>  private static function setup() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(get_option(&quot;gf_salesforce_version&quot;) != self::$version)&nbsp;</div></li><li><div>          GFSalesforceData::update_table();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_option(&quot;gf_salesforce_version&quot;, self::$version);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Adds feed tooltips to the list of tooltips</span>&nbsp;</div></li><li><div>  public static function tooltips($tooltips) {&nbsp;</div></li><li><div>      $salesforce_tooltips = array(&nbsp;</div></li><li><div>          &quot;salesforce_contact_list&quot; =&gt; &quot;&lt;h6&gt;&quot; . __(&quot;Salesforce Object&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/h6&gt;&quot; . __(&quot;Select the Salesforce object you would like to add your contacts to.&quot;, &quot;gravity-forms-salesforce&quot;), &nbsp;</div></li><li><div>          &quot;salesforce_gravity_form&quot; =&gt; &quot;&lt;h6&gt;&quot; . __(&quot;Gravity Form&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/h6&gt;&quot; . __(&quot;Select the Gravity Form you would like to integrate with Salesforce. Contacts generated by this form will be automatically added to your Salesforce account.&quot;, &quot;gravity-forms-salesforce&quot;), &nbsp;</div></li><li><div>          &quot;salesforce_map_fields&quot; =&gt; &quot;&lt;h6&gt;&quot; . __(&quot;Map Standard Fields&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/h6&gt;&quot; . __(&quot;Associate your Salesforce fields to the appropriate Gravity Form fields by selecting. &lt;a href='http:<span class="comment">//www.salesforce.com/us/developer/docs/api/Content/field_types.htm'&gt;Learn about the Field Types&lt;/a&gt; in Salesforce.&quot;, &quot;gravity-forms-salesforce&quot;), </span>&nbsp;</div></li><li><div>          &quot;salesforce_optin_condition&quot; =&gt; &quot;&lt;h6&gt;&quot; . __(&quot;Opt-In Condition&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/h6&gt;&quot; . __(&quot;When the opt-in condition is enabled, form submissions will only be exported to Salesforce when the condition is met. When disabled all form submissions will be exported.&quot;, &quot;gravity-forms-salesforce&quot;), &nbsp;</div></li><li><div>          &quot;salesforce_manual_export&quot; =&gt; &quot;&lt;h6&gt;&quot; . __(&quot;Manual Export&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/h6&gt;&quot; . __(&quot;If you don't want all entries sent to Salesforce, but only specific, approved entries, check this box. To send an entry to Salesforce, you go to Entries, choose the entry you would like to send to Salesforce, and then click the 'Send to Salesforce' button.&quot;, &quot;gravity-forms-salesforce&quot;), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return array_merge($tooltips, $salesforce_tooltips);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Creates Salesforce left nav menu under Forms</span>&nbsp;</div></li><li><div>  public static function create_menu($menus) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Adding submenu if user has access</span>&nbsp;</div></li><li><div>      $permission = self::has_access(&quot;gravityforms_salesforce&quot;);&nbsp;</div></li><li><div>      if(!empty($permission))&nbsp;</div></li><li><div>          $menus[] = array(&quot;name&quot; =&gt; &quot;gf_salesforce&quot;, &quot;label&quot; =&gt; __(&quot;Salesforce&quot;, &quot;gravity-forms-salesforce&quot;), &quot;callback&quot; =&gt;  array(&quot;GFSalesforce&quot;, &quot;salesforce_page&quot;), &quot;permission&quot; =&gt; $permission);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $menus;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Is there a setting to email when there's an error? If so, returns email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed     If setting exists: Email; if not: false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_notify_on_error() {&nbsp;</div></li><li><div>      $email = trim(rtrim(self::$settings['notifyemail']));&nbsp;</div></li><li><div>      if(!empty($email) && is_email($email)) {&nbsp;</div></li><li><div>          return $email;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function settings_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($_POST[&quot;uninstall&quot;])) {&nbsp;</div></li><li><div>          check_admin_referer(&quot;uninstall&quot;, &quot;gf_salesforce_uninstall&quot;);&nbsp;</div></li><li><div>          self::uninstall();&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;updated fade&quot; style=&quot;padding:20px;&quot;&gt;&lt;?php esc_attr( sprintf( __(&quot;Gravity Forms Salesforce Add-On has been successfully uninstalled. It can be re-activated from the %splugins page%s.&quot;, &quot;gravity-forms-salesforce&quot;), &quot;&lt;a href='plugins.php'&gt;&quot;, &quot;&lt;/a&gt;&quot;) ); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if(isset($_POST[&quot;gf_salesforce_submit&quot;])) {&nbsp;</div></li><li><div>          check_admin_referer(&quot;update&quot;, &quot;gf_salesforce_update&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If the new transient time is less than the old, we can assume they want it cleared out.</span>&nbsp;</div></li><li><div>          if(floatval($_POST[&quot;gf_salesforce_cache_time&quot;]) &lt; floatval(self::$settings['cache_time'])) {&nbsp;</div></li><li><div>              self::refresh_transients(true);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $settings = array(&nbsp;</div></li><li><div>              &quot;notifyemail&quot; =&gt; trim(rtrim(esc_html($_POST[&quot;gf_salesforce_notifyemail&quot;]))), &nbsp;</div></li><li><div>              'cache_time' =&gt; floatval($_POST[&quot;gf_salesforce_cache_time&quot;])&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          update_option(&quot;gf_salesforce_settings&quot;, $settings);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else{&nbsp;</div></li><li><div>          $settings = get_option(&quot;gf_salesforce_settings&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If user revoked access manually, clear the token.</span>&nbsp;</div></li><li><div>      if(wp_verify_nonce(@$_GET['cleartoken'], 'cleartoken')) {&nbsp;</div></li><li><div>          self::clearToken();&nbsp;</div></li><li><div>          $token = false;&nbsp;</div></li><li><div>          unset($_GET['cleartoken']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $token = self::getAccessToken();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = wp_parse_args( $settings, self::$settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api($settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($api && $token && self::api_is_valid($api)) {&nbsp;</div></li><li><div>          $message = sprintf(__(&quot;Valid configuration. Now go %sconfigure form integration with Salesforce%s!&quot;, &quot;gravity-forms-salesforce&quot;), '&lt;a href=&quot;'.admin_url('admin.php?page=gf_salesforce').'&quot;&gt;', '&lt;/a&gt;');&nbsp;</div></li><li><div>          $class = &quot;updated valid_credentials&quot;;&nbsp;</div></li><li><div>          $valid = true;&nbsp;</div></li><li><div>      } else if(!$api) {&nbsp;</div></li><li><div>          $message = sprintf(__('%sYour Salesforce connection isn&#8217;t working properly. Please log in again below.%s For more information, please install the %sGravity Forms Logging Tool%s and try again.%s', 'gravity-forms-salesforce'), '&lt;h3 style=&quot;margin-top:1em;&quot;&gt;', '&lt;/h3&gt;&lt;p&gt;', &quot;&lt;a href='http:<span class="comment">//www.gravityhelp.com/downloads/#Gravity_Forms_Logging_Tool' target='_blank'&gt;&quot;, '&lt;/a&gt;', '&lt;/p&gt;');</span>&nbsp;</div></li><li><div>          $valid = false;&nbsp;</div></li><li><div>          $class = &quot;error invalid_credentials&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $valid = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($message) {&nbsp;</div></li><li><div>          $message = str_replace('Api', 'API', $message);&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;message&quot; class=&quot;inline &lt;?php echo $class ?&gt; widefat&quot;&gt;&lt;?php echo wpautop($message); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;form method=&quot;post&quot; action=&quot;&lt;?php echo remove_query_arg('refresh'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php wp_nonce_field(&quot;update&quot;, &quot;gf_salesforce_update&quot;) ?&gt;&nbsp;</div></li><li><div>          &lt;h3&gt;&lt;span&gt;&lt;img class=&quot;alignleft&quot; style=&quot;margin:0 10px 10px 0&quot; alt=&quot;&quot; src=&quot;&lt;?php echo self::get_base_url() . &quot;/assets/images/salesforce-256x256.png&quot;; ?&gt;&quot; width=&quot;84&quot; /&gt; &lt;?php esc_html_e(&quot;Salesforce Account Information&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>          &lt;h4 class=&quot;gf_settings_subgroup_title&quot;&gt;&lt;?php esc_html_e('Salesforce API', 'gravity-forms-salesforce'); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;th scope=&quot;row&quot;&gt;&lt;label&gt;&lt;?php esc_html_e(&quot;Salesforce Account&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/label&gt; &lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;td&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $auth_button_output = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Is there an OAuth token stored?</span>&nbsp;</div></li><li><div>                  if(!empty($valid)) {&nbsp;</div></li><li><div>                      $params = self::getTokenParams();&nbsp;</div></li><li><div>                      $auth_button_output .= '&lt;span class=&quot;gf_keystatus_valid_text&quot;&gt;';&nbsp;</div></li><li><div>                      $auth_button_output .= '&lt;i class=&quot;fa fa-check gf_keystatus_valid&quot;&gt;&lt;/i&gt; ';&nbsp;</div></li><li><div>                      $auth_button_output .= sprintf(__('Authorized connection to &lt;code&gt;%s&lt;/code&gt; on %s'), str_replace('https:<span class="comment">//', '', $params['instance_url']), date_i18n('F d, Y H:i:m \G\M\T', substr($params['issued_at'], 0, 10)));</span>&nbsp;</div></li><li><div>                      $auth_button_output .= '&lt;/span&gt;';&nbsp;</div></li><li><div>                      $url = wp_nonce_url(add_query_arg(array('cleartoken' =&gt; true)), 'cleartoken', 'cleartoken');&nbsp;</div></li><li><div>                      $auth_button_output .= &quot;&lt;p&gt;&lt;a href='{$url}' class='button button-secondary'&gt;Revoke Access&lt;/a&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment">// Was there an error?</span>&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if(!empty($settings['error'])) {&nbsp;</div></li><li><div>                          $auth_button_output .= '&lt;div class=&quot;error inline clear&quot;&gt;'.wpautop( $settings['error'] ).'&lt;/div&gt;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// If not, we need to authorize.</span>&nbsp;</div></li><li><div>                      $salesforceService = self::getSalesforceService();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $url = $salesforceService-&gt;getAuthorizationUri(array(&nbsp;</div></li><li><div>                          'grant_type' =&gt; 'authorization_code', &nbsp;</div></li><li><div>                          'response_type' =&gt; 'code', &nbsp;</div></li><li><div>                          'display' =&gt; 'page', &nbsp;</div></li><li><div>                          'scope' =&gt; 'api refresh_token', &nbsp;</div></li><li><div>                          'state' =&gt; self::link_to_settings( false )&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $auth_button_output .= sprintf(&quot;&lt;p&gt;&lt;a href='%s' class='button button-primary button-hero'&gt;%s&lt;/a&gt;&lt;/p&gt;&quot;, $url, __('Login with Salesforce!', 'gravity-forms-salesforce'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  echo $auth_button_output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;/td&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;gf_salesforce_notifyemail&quot;&gt;&lt;?php esc_html_e(&quot;Notify by Email on Errors&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/label&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;td&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;text&quot; id=&quot;gf_salesforce_notifyemail&quot; name=&quot;gf_salesforce_notifyemail&quot; size=&quot;30&quot; value=&quot;&lt;?php echo empty($settings[&quot;notifyemail&quot;]) ? '' : esc_attr($settings[&quot;notifyemail&quot;]); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>                      &lt;span class=&quot;howto&quot;&gt;&lt;?php esc_html_e('An email will be sent to this email address if an entry is not properly added to Salesforce. Leave blank to disable.', 'gravity-forms-salesforce'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;/td&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;gf_salesforce_cache_time&quot;&gt;&lt;?php esc_html_e(&quot;Remote Cache Time&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/label&gt;&lt;span class=&quot;howto&quot;&gt;&lt;?php esc_html_e(&quot;This is an advanced setting. You likely won't need to change this.&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/span&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;td&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;select name=&quot;gf_salesforce_cache_time&quot; id=&quot;gf_salesforce_cache_time&quot;&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;60&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '60', true); ?&gt;&gt;&lt;?php esc_html_e('One Minute (for testing only!)', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;3600&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '3600', true); ?&gt;&gt;&lt;?php esc_html_e('One Hour', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;21600&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '21600', true); ?&gt;&gt;&lt;?php esc_html_e('Six Hours', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;43200&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '43200', true); ?&gt;&gt;&lt;?php esc_html_e('12 Hours', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;86400&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '86400', true); ?&gt;&gt;&lt;?php esc_html_e('1 Day', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;172800&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '172800', true); ?&gt;&gt;&lt;?php esc_html_e('2 Days', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;259200&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '259200', true); ?&gt;&gt;&lt;?php esc_html_e('3 Days', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;432000&quot; &lt;?php selected($settings[&quot;cache_time&quot;] == '432000', true); ?&gt;&gt;&lt;?php esc_html_e('5 Days', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value=&quot;604800&quot; &lt;?php selected(empty($settings[&quot;cache_time&quot;]) || $settings[&quot;cache_time&quot;] == '604800', true); ?&gt;&gt;&lt;?php esc_html_e('1 Week', 'gravity-forms-salesforce'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                      &lt;/select&gt;&nbsp;</div></li><li><div>                      &lt;span class=&quot;howto&quot;&gt;&lt;?php esc_html_e('How long should form and field data be stored? This affects how often remote picklists will be checked for the Live Remote Field Mapping feature.', 'gravity-forms-salesforce'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                      &lt;span class=&quot;howto&quot;&gt;&lt;?php printf( esc_html__(&quot;%sRefresh now%s.&quot;, &quot;gravity-forms-salesforce&quot;), '&lt;a href=&quot;'.add_query_arg('refresh', 'transients').'&quot;&gt;', '&lt;/a&gt;'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;/td&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;td colspan=&quot;2&quot; &gt;&lt;input type=&quot;submit&quot; name=&quot;gf_salesforce_submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e(&quot;Save Settings&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; /&gt;&lt;/td&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>          &lt;div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php wp_nonce_field(&quot;uninstall&quot;, &quot;gf_salesforce_uninstall&quot;) ?&gt;&nbsp;</div></li><li><div>          &lt;?php if(GFCommon::current_user_can_any(&quot;gravityforms_salesforce_uninstall&quot;)) { ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;hr-divider&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;h3&gt;&lt;?php esc_html_e(&quot;Uninstall Salesforce Add-On&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;delete-alert&quot;&gt;&lt;?php esc_html_e(&quot;Warning! This operation deletes ALL Salesforce Feeds.&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $uninstall_button = '&lt;input type=&quot;submit&quot; name=&quot;uninstall&quot; value=&quot;' . __(&quot;Uninstall Salesforce Add-On&quot;, &quot;gravity-forms-salesforce&quot;) . '&quot; class=&quot;button&quot; onclick=&quot;return confirm(\'' . __(&quot;Warning! ALL Salesforce Feeds will be deleted. This cannot be undone. \'OK\' to delete, \'Cancel\' to stop&quot;, &quot;gravity-forms-salesforce&quot;) . '\');&quot;/&gt;';&nbsp;</div></li><li><div>                  echo apply_filters(&quot;gform_salesforce_uninstall_button&quot;, $uninstall_button);&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php } ?&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the list or edit page based on the current view</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function salesforce_page() {&nbsp;</div></li><li><div>      $view = isset($_GET[&quot;view&quot;]) ? $_GET[&quot;view&quot;] : '';&nbsp;</div></li><li><div>      if($view == &quot;edit&quot;) {&nbsp;</div></li><li><div>          self::edit_page($_GET[&quot;id&quot;]);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          self::list_page();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Displays the Salesforce feeds list page</span>&nbsp;</div></li><li><div>  private static function list_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($_POST[&quot;action&quot;]) && $_POST[&quot;action&quot;] == &quot;delete&quot;) {&nbsp;</div></li><li><div>          check_admin_referer(&quot;list_action&quot;, &quot;gf_salesforce_list&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $id = absint($_POST[&quot;action_argument&quot;]);&nbsp;</div></li><li><div>          GFSalesforceData::delete_feed($id);&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;updated fade&quot; style=&quot;margin:10px 0;&quot;&gt;&lt;p&gt;&lt;?php esc_html_e(&quot;Feed deleted.&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/p&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (!empty($_POST[&quot;bulk_action&quot;])) {&nbsp;</div></li><li><div>          check_admin_referer(&quot;list_action&quot;, &quot;gf_salesforce_list&quot;);&nbsp;</div></li><li><div>          $selected_feeds = $_POST[&quot;feed&quot;];&nbsp;</div></li><li><div>          if(is_array($selected_feeds)) {&nbsp;</div></li><li><div>              foreach($selected_feeds as $feed_id)&nbsp;</div></li><li><div>                  GFSalesforceData::delete_feed($feed_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;updated fade&quot; style=&quot;margin:10px 0;&quot;&gt;&lt;p&gt;&lt;?php esc_html_e(&quot;Feeds deleted.&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/p&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>          .user-list tr {&nbsp;</div></li><li><div>              cursor: move;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          .user-list tr td a {&nbsp;</div></li><li><div>              cursor: pointer;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          .user-list tr:nth-child(even) {&nbsp;</div></li><li><div>              background-color: #f5f5f5;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      &lt;/style&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;img alt=&quot;&lt;?php esc_attr_e(&quot;Salesforce.com Feeds&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; src=&quot;&lt;?php echo self::get_base_url()?&gt;/assets/images/salesforce-256x256.png&quot; style=&quot;float:left; margin:0 7px 10px 0;&quot; width=&quot;64&quot; /&gt;&nbsp;</div></li><li><div>          &lt;h2&gt;&lt;?php esc_html_e(&quot;Salesforce.com Feeds&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&nbsp;</div></li><li><div>          &lt;a class=&quot;button add-new-h2&quot; href=&quot;admin.php?page=gf_salesforce&amp;view=edit&amp;id=0&quot;&gt;&lt;?php esc_html_e(&quot;Add New&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>              if(!self::api_is_valid($api)) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;error&quot; id=&quot;message&quot; style=&quot;margin-top:20px;&quot;&gt;&nbsp;</div></li><li><div>              &lt;h3&gt;&lt;?php esc_html_e('Salesforce Error', &quot;gravity-forms-salesforce&quot;);?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php echo empty($api) ? sprintf( __(&quot;To get started, please configure your %sSalesforce Settings%s.&quot;, &quot;gravity-forms-salesforce&quot;), '&lt;a href=&quot;'.self::link_to_settings().'&quot;&gt;', &quot;&lt;/a&gt;&quot;) : $api; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;updated&quot; id=&quot;message&quot; style=&quot;margin-top:20px;&quot;&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php printf( esc_html__('Do you like this free plugin? %sPlease review it on WordPress.org%s!', 'gravity-forms-salesforce'), '&lt;a href=&quot;http:<span class="comment">//katz.si/gfsfrate&quot;&gt;', '&lt;/a&gt;') ; ?&gt;&lt;/p&gt;</span>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php } ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;ul class=&quot;subsubsub&quot; style=&quot;margin-top:0;&quot;&gt;&nbsp;</div></li><li><div>              &lt;li&gt;&lt;a href=&quot;&lt;?php echo self::link_to_settings(); ?&gt;&quot;&gt;Salesforce Settings&lt;/a&gt; |&lt;/li&gt;&nbsp;</div></li><li><div>              &lt;li&gt;&lt;a href=&quot;&lt;?php echo admin_url('admin.php?page=gf_salesforce'); ?&gt;&quot; class=&quot;current&quot;&gt;Salesforce Feeds&lt;/a&gt;&lt;/li&gt;&nbsp;</div></li><li><div>          &lt;/ul&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;form id=&quot;feed_form&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field('list_action', 'gf_salesforce_list') ?&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; id=&quot;action&quot; name=&quot;action&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; id=&quot;action_argument&quot; name=&quot;action_argument&quot;/&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;alignleft actions&quot; style=&quot;padding:8px 0 7px; 0&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label class=&quot;hidden&quot; for=&quot;bulk_action&quot;&gt;&lt;?php esc_html_e(&quot;Bulk action&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;select name=&quot;bulk_action&quot; id=&quot;bulk_action&quot;&gt;&nbsp;</div></li><li><div>                          &lt;option value=''&gt; &lt;?php esc_html_e(&quot;Bulk action&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt; &lt;/option&gt;&nbsp;</div></li><li><div>                          &lt;option value='delete'&gt;&lt;?php esc_html_e(&quot;Delete&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                      &lt;/select&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;submit&quot; class=&quot;button&quot; value=&quot;' . __(&quot;Apply&quot;, &quot;gravity-forms-salesforce&quot;) . '&quot; onclick=&quot;if( jQuery(\'#bulk_action\').val() == \'delete\' && !confirm(\'' . __(&quot;Delete selected feeds? &quot;, &quot;gravity-forms-salesforce&quot;) . __(&quot;\'Cancel\' to stop, \'OK\' to delete.&quot;, &quot;gravity-forms-salesforce&quot;) .'\')) { return false; } return true;&quot;/&gt;';&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;table class=&quot;widefat fixed sort&quot; cellspacing=&quot;0&quot;&gt;&nbsp;</div></li><li><div>                  &lt;thead&gt;&nbsp;</div></li><li><div>                      &lt;tr&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;cb&quot; class=&quot;manage-column column-cb check-column&quot; style=&quot;&quot;&gt;&lt;input type=&quot;checkbox&quot; /&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;active&quot; class=&quot;manage-column check-column&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; class=&quot;manage-column&quot;&gt;&lt;?php esc_html_e(&quot;Form&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; class=&quot;manage-column&quot;&gt;&lt;?php esc_html_e(&quot;Salesforce Object&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;tfoot&gt;&nbsp;</div></li><li><div>                      &lt;tr&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;cb&quot; class=&quot;manage-column column-cb check-column&quot; style=&quot;&quot;&gt;&lt;input type=&quot;checkbox&quot; /&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;active&quot; class=&quot;manage-column check-column&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; class=&quot;manage-column&quot;&gt;&lt;?php esc_html_e(&quot;Form&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; class=&quot;manage-column&quot;&gt;&lt;?php esc_html_e(&quot;Salesforce Object&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;tbody class=&quot;list:user user-list&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $settings = GFSalesforceData::get_feeds();&nbsp;</div></li><li><div>                      if(is_array($settings) && !empty($settings)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($settings as $setting) {&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;tr class='author-self status-inherit' data-id=&quot;&lt;?php echo $setting['id'] ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;th scope=&quot;row&quot; class=&quot;check-column&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;feed[]&quot; value=&quot;&lt;?php echo $setting[&quot;id&quot;] ?&gt;&quot;/&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                  &lt;td&gt;&lt;img src=&quot;&lt;?php echo self::get_base_url() ?&gt;/assets/images/active&lt;?php echo intval($setting[&quot;is_active&quot;]) ?&gt;.png&quot; alt=&quot;&lt;?php echo $setting[&quot;is_active&quot;] ? __(&quot;Active&quot;, &quot;gravity-forms-salesforce&quot;) : __(&quot;Inactive&quot;, &quot;gravity-forms-salesforce&quot;);?&gt;&quot; title=&quot;&lt;?php echo $setting[&quot;is_active&quot;] ? __(&quot;Active&quot;, &quot;gravity-forms-salesforce&quot;) : __(&quot;Inactive&quot;, &quot;gravity-forms-salesforce&quot;);?&gt;&quot; onclick=&quot;ToggleActive(this); &quot; /&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;column-title&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;a href=&quot;admin.php?page=gf_salesforce&amp;view=edit&amp;id=&lt;?php echo $setting[&quot;id&quot;] ?&gt;&quot; title=&quot;&lt;?php esc_attr_e(&quot;Edit&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot;&gt;&lt;?php echo esc_html( $setting[&quot;form_title&quot;] ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                      &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;span class=&quot;edit&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;a title=&quot;Edit this setting&quot; href=&quot;admin.php?page=gf_salesforce&amp;view=edit&amp;id=&lt;?php echo $setting[&quot;id&quot;] ?&gt;&quot; title=&quot;&lt;?php esc_attr_e(&quot;Edit&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot;&gt;&lt;?php esc_html_e(&quot;Edit&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                          |&nbsp;</div></li><li><div>                                          &lt;/span&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          &lt;span class=&quot;edit&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;a title=&quot;&lt;?php esc_html_e(&quot;Delete&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; href=&quot;javascript: if(confirm('&lt;?php echo esc_js(__(&quot;Delete this feed? 'Cancel' to stop, 'OK' to delete.&quot;, &quot;gravity-forms-salesforce&quot;)); ?&gt;')) { DeleteSetting(&lt;?php echo $setting[&quot;id&quot;] ?&gt;);}&quot;&gt;&lt;?php esc_html_e(&quot;Delete&quot;, &quot;gravity-forms-salesforce&quot;)?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                          |&nbsp;</div></li><li><div>                                          &lt;/span&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          &lt;span class=&quot;edit&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;a title=&quot;&lt;?php esc_html_e(&quot;Edit Form&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; href=&quot;&lt;?php echo add_query_arg(array('page' =&gt; 'gf_edit_forms', 'id' =&gt; $setting['form_id']), admin_url('admin.php')); ?&gt;&quot;&gt;&lt;?php esc_html_e(&quot;Edit Form&quot;, &quot;gravity-forms-salesforce&quot;)?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                          |&nbsp;</div></li><li><div>                                          &lt;/span&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          &lt;span class=&quot;edit&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;a title=&quot;&lt;?php esc_html_e(&quot;Preview Form&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; href=&quot;&lt;?php echo add_query_arg(array('gf_page' =&gt; 'preview', 'id' =&gt; $setting['form_id']), site_url()); ?&gt;&quot;&gt;&lt;?php esc_html_e(&quot;Preview Form&quot;, &quot;gravity-forms-salesforce&quot;)?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                          &lt;/span&gt;&nbsp;</div></li><li><div>                                      &lt;/div&gt;&nbsp;</div></li><li><div>                                  &lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;column-name&quot; style=&quot;width:40%&quot;&gt;&lt;p&gt;&lt;?php echo esc_html($setting[&quot;meta&quot;][&quot;contact_object_name&quot;]); ?&gt;&lt;/p&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else {&nbsp;</div></li><li><div>                          if(self::api_is_valid($api)) {&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;td colspan=&quot;4&quot; style=&quot;padding:20px;&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php printf( esc_html__(&quot;You don't have any Salesforce feeds configured. Let's go %screate one%s!&quot;, &quot;gravity-forms-salesforce&quot;), '&lt;a href=&quot;'.admin_url('admin.php?page=gf_salesforce&view=edit&id=0').'&quot;&gt;', &quot;&lt;/a&gt;&quot;); ?&gt;&nbsp;</div></li><li><div>                                  &lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          else{&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;td colspan=&quot;4&quot; style=&quot;padding:20px;&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php printf( esc_html__(&quot;To get started, please configure your %sSalesforce Settings%s.&quot;, &quot;gravity-forms-salesforce&quot;), '&lt;a href=&quot;'.self::link_to_settings().'&quot;&gt;', &quot;&lt;/a&gt;&quot;); ?&gt;&nbsp;</div></li><li><div>                                  &lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/tbody&gt;&nbsp;</div></li><li><div>              &lt;/table&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>          function DeleteSetting(id) {&nbsp;</div></li><li><div>              jQuery(&quot;#action_argument&quot;).val(id);&nbsp;</div></li><li><div>              jQuery(&quot;#action&quot;).val(&quot;delete&quot;);&nbsp;</div></li><li><div>              jQuery(&quot;#feed_form&quot;)[0].submit();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          function ToggleActive(img) {&nbsp;</div></li><li><div>              var feed_id;&nbsp;</div></li><li><div>              var is_active = img.src.indexOf(&quot;active1.png&quot;) &gt;=0&nbsp;</div></li><li><div>              var $img = jQuery(img);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(is_active) {&nbsp;</div></li><li><div>                  img.src = img.src.replace(&quot;active1.png&quot;, &quot;active0.png&quot;);&nbsp;</div></li><li><div>                  $img.attr('title', '&lt;?php _e(&quot;Inactive&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;').attr('alt', '&lt;?php _e(&quot;Inactive&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>                  img.src = img.src.replace(&quot;active0.png&quot;, &quot;active1.png&quot;);&nbsp;</div></li><li><div>                  $img.attr('title', '&lt;?php _e(&quot;Active&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;').attr('alt', '&lt;?php _e(&quot;Active&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(feed_id = $img.closest('tr').attr('data-id')) {&nbsp;</div></li><li><div>                  var mysack = new sack(&quot;&lt;?php echo admin_url(&quot;admin-ajax.php&quot;)?&gt;&quot; );&nbsp;</div></li><li><div>                  mysack.execute = 1;&nbsp;</div></li><li><div>                  mysack.method = 'POST';&nbsp;</div></li><li><div>                  mysack.setVar( &quot;action&quot;, &quot;rg_update_feed_active&quot; );&nbsp;</div></li><li><div>                  mysack.setVar( &quot;rg_update_feed_active&quot;, &quot;&lt;?php echo wp_create_nonce(&quot;rg_update_feed_active&quot;) ?&gt;&quot; );&nbsp;</div></li><li><div>                  mysack.setVar( &quot;feed_id&quot;, feed_id );&nbsp;</div></li><li><div>                  mysack.setVar( &quot;is_active&quot;, is_active ? 0 : 1 );&nbsp;</div></li><li><div>                  mysack.encVar( &quot;cookie&quot;, document.cookie, false );&nbsp;</div></li><li><div>                  mysack.onError = function() { alert('&lt;?php _e(&quot;Ajax error while updating feed&quot;, &quot;gravity-forms-salesforce&quot; ) ?&gt;' )};&nbsp;</div></li><li><div>                  mysack.runAJAX();&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function api_is_valid($api) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($api === false || is_string($api) || !empty($api-&gt;lastError)) {&nbsp;</div></li><li><div>          self::log_error('api_is_valid(): $api is string or has an error: '.print_r($api, true));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } elseif( !is_a($api, 'SforcePartnerClient') && !is_a($api, 'SforceEnterpriseClient')) {&nbsp;</div></li><li><div>          self::log_error('api_is_valid(): $api is not SforcePartnerClient or SforceEnterpriseClient: '.print_r($api, true));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } elseif(!method_exists($api, 'getLastResponseHeaders') || (!is_null($api-&gt;getLastResponseHeaders()) && !preg_match('/200\sOK/ism', $api-&gt;getLastResponseHeaders())) ) {&nbsp;</div></li><li><div>          self::log_error('api_is_valid(): !method_exists(getLastResponseHeaders) || 200 OK $api-&gt;getLastResponseHeaders() '.print_r($api, true));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug('api_is_valid(): valid api');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_api($settings = array(), $after_refresh = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If it's already set, use it.</span>&nbsp;</div></li><li><div>      if(!empty(self::$api)) {&nbsp;</div></li><li><div>          self::log_debug(&quot;get_api(): API connection already set.&quot;);&nbsp;</div></li><li><div>          return self::$api;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_array($settings) || empty($settings)) {&nbsp;</div></li><li><div>          $settings = self::$settings;&nbsp;</div></li><li><div>          if(!is_array($settings) || empty($settings)) {&nbsp;</div></li><li><div>              $settings = get_option(&quot;gf_salesforce_settings&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the settings aren't set...return false</span>&nbsp;</div></li><li><div>      if(!is_array($settings) || empty($settings)) {&nbsp;</div></li><li><div>          self::log_error(&quot;get_api(): Settings not set, so we can't get the Salesforce connection.&quot;);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $libpath = plugin_dir_path(KWS_GF_Salesforce::$file).'lib/Force.com-Toolkit-for-PHP/soapclient/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $enterprise = apply_filters('gf_salesforce_enterprise', false, $settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          <span class="comment">//This is instantiating the service used for the sfdc api</span>&nbsp;</div></li><li><div>          if($enterprise) {&nbsp;</div></li><li><div>              if(!class_exists(&quot;SforceEnterpriseClient&quot;)) {&nbsp;</div></li><li><div>                  require_once $libpath.'SforceEnterpriseClient.php';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $mySforceConnection = new SforceEnterpriseClient();&nbsp;</div></li><li><div>              $_wsdl = 'enterprise.wsdl.xml';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              if(!class_exists(&quot;SforcePartnerClient&quot;)) {&nbsp;</div></li><li><div>                  require_once $libpath.'SforcePartnerClient.php';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $mySforceConnection = new SforcePartnerClient();&nbsp;</div></li><li><div>              $_wsdl = 'partner.wsdl.xml';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(self::GF_SF_SANDBOX && file_exists($libpath . 'sandbox.wsdl.xml')) {&nbsp;</div></li><li><div>              $_wsdl = 'sandbox.wsdl.xml';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">          * Create a connection using SforceBaseClient::createConnection().</span>&nbsp;</div></li><li><div><span class="comment">          *</span>&nbsp;</div></li><li><div><span class="comment">          * @param string $wsdl   Salesforce.com Partner WSDL</span>&nbsp;</div></li><li><div><span class="comment">          * @param object $proxy  (optional) proxy settings with properties host, port, </span>&nbsp;</div></li><li><div><span class="comment">          *                       login and password</span>&nbsp;</div></li><li><div><span class="comment">          * @param array $soap_options (optional) Additional options to send to the</span>&nbsp;</div></li><li><div><span class="comment">          *                       SoapClient constructor. @see</span>&nbsp;</div></li><li><div><span class="comment">          *                       http://php.net/manual/en/soapclient.soapclient.php</span>&nbsp;</div></li><li><div><span class="comment">          */</span>&nbsp;</div></li><li><div>          $mySforceConnection-&gt;createConnection(&nbsp;</div></li><li><div>              apply_filters('gf_salesforce_wsdl', $libpath.$_wsdl), &nbsp;</div></li><li><div>              apply_filters('gf_salesforce_proxy', NULL), &nbsp;</div></li><li><div>              apply_filters('gf_salesforce_soap_options', array())&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Set access using OAuth instead of Basic</span>&nbsp;</div></li><li><div><span class="comment">           * @link  https://developer.salesforce.com/blogs/developer-relations/2011/03/oauth-and-the-soap-api.html</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $token = self::getAccessToken();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( empty( $token ) ) {&nbsp;</div></li><li><div>              self::log_debug(&quot;get_api(): The access token is empty - app is not yet authenticated&quot;);&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mySforceConnection-&gt;setSessionHeader($token);&nbsp;</div></li><li><div>          $mySforceConnection-&gt;setEndpoint(self::getEndpoint($token));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mySforceConnection = apply_filters('gf_salesforce_connection', $mySforceConnection);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//let's force some action through the connection to make sure is up and running!</span>&nbsp;</div></li><li><div>          $timestamp = $mySforceConnection-&gt;getServerTimestamp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::$api = $mySforceConnection;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $mySforceConnection;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_error( sprintf(&quot;get_api(): There was an error getting the connection to Salesforce. The error message was: %s\nHere's the exception: %s&quot;, $e-&gt;getMessage(), print_r( $e, true) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The token has expired. We need to refresh the token.</span>&nbsp;</div></li><li><div>          if( isset($e-&gt;faultcode) && in_array( $e-&gt;faultcode, array( 'sf:INVALID_SESSION_ID', 'UNKNOWN_EXCEPTION' ) ) && !$after_refresh ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              try{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  self::log_error(&quot;get_api(): The access token has expired; fetching a refresh token.&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Refresh the token</span>&nbsp;</div></li><li><div>                  $refreshToken = self::refreshToken();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// If the token fetch failed, return false.</span>&nbsp;</div></li><li><div>                  if(empty($refreshToken)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      self::log_error('get_api(): The refreshToken call has failed. This may be due to your Salesforce Instance &quot;Refresh Token Policy&quot;. If it is not set to &quot;Refresh token is valid until revoked&quot; (the default), that can cause problems.');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      self::log_error('See http:<span class="comment">//www.salesforce.com/us/developer/docs/packagingGuide/Content/connected_app_manage_edit.htm#oauth_policies for more information.');</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } catch(Exception $e) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  self::log_error( sprintf(&quot;get_api(): There was an error refreshing the access token to Salesforce. The error message was: %s\nHere's the exception: %s&quot;, $e-&gt;getMessage(), print_r($e, true)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_error(&quot;get_api(): The refresh token has been fetched; now trying get_api() again.&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// And try one more time.</span>&nbsp;</div></li><li><div>              return self::get_api($settings, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_error( sprintf( &quot;get_api(): Token was not refreshed for this error: %s &quot;, $e-&gt;getMessage() ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return isset($e-&gt;faultstring) ? $e-&gt;faultstring : false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Writes an error message to the Gravity Forms log. Requires the Gravity Forms logging Add-On.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function log_error($message) {&nbsp;</div></li><li><div>      if (class_exists(&quot;GFLogging&quot;)) {&nbsp;</div></li><li><div>          GFLogging::include_logger();&nbsp;</div></li><li><div>          GFLogging::log_message(self::$slug, $message, KLogger::ERROR);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Writes an error message to the Gravity Forms log. Requires the Gravity Forms logging Add-On.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function log_debug($message) {&nbsp;</div></li><li><div>      if (class_exists(&quot;GFLogging&quot;)) {&nbsp;</div></li><li><div>          GFLogging::include_logger();&nbsp;</div></li><li><div>          GFLogging::log_message(self::$slug, $message, KLogger::DEBUG);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          error_log ( $message );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function r($content, $die = false) {&nbsp;</div></li><li><div>      echo '&lt;pre&gt;';&nbsp;</div></li><li><div>      print_r($content);&nbsp;</div></li><li><div>      echo '&lt;/pre&gt;';&nbsp;</div></li><li><div>      if($die) { exit(); }&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function getField($objectType = 'account', $field_name = '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cache the field to save lookups.</span>&nbsp;</div></li><li><div>      <span class="comment">// Sha1 is to ensure length is correct.</span>&nbsp;</div></li><li><div>      $field = get_site_transient('sfgf_'.sha1('lists_'.$objectType.'_'.$field_name));&nbsp;</div></li><li><div>      if($field && !is_wp_error($field) && !(current_user_can('manage_options') && (isset($_REQUEST['refresh']) || isset($_REQUEST['cache'])))) { return $field; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $fields = self::getFieldsForObject($objectType);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($fields as $field) {&nbsp;</div></li><li><div>          if($field['tag'] === $field_name) {&nbsp;</div></li><li><div>              set_site_transient('sfgf_'.sha1('lists_'.$objectType.'_'.$field_name), $field, self::$settings['cache_time']);&nbsp;</div></li><li><div>              return $field;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get an array of fields for an object type</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string      $objectType Type of object, for example &quot;Lead&quot; or &quot;Contact&quot;</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string      $fieldType  The type of field you're trying to return, for example: &quot;picklist&quot; or &quot;string&quot;</span>&nbsp;</div></li><li><div><span class="comment">   * @return array|false                  Array if fields exist; false if failed to fetch.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function getFieldsForObject($objectType = 'account', $fieldType = null) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This is passed by $_POST; let's just make sure it's sanitized</span>&nbsp;</div></li><li><div>      $objectType = esc_attr( $objectType );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lists = maybe_unserialize(get_site_transient('sfgf_lists_fields_'.$objectType));&nbsp;</div></li><li><div>      if($lists && !empty($lists) && is_array($lists) && (!isset($_REQUEST['refresh']) || (isset($_REQUEST['refresh']) && $_REQUEST['refresh'] !== 'lists'))) {&nbsp;</div></li><li><div>          self::log_debug('getFields: fields have been cached.');&nbsp;</div></li><li><div>          foreach($lists as $key =&gt; $list) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// If you only want one type of field, and it's not that type, keep going</span></span>&nbsp;</div></li><li><div>              if(!empty($fieldType)) {&nbsp;</div></li><li><div>                  if(&nbsp;</div></li><li><div>                      (is_string($fieldType) && $list['type'] !== $fieldType) ||&nbsp;</div></li><li><div>                      (is_array($fieldType) && !in_array($list['type'], $fieldType))&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                      unset($lists[$key]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $lists;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else if(!empty($_REQUEST['refresh']) && $_REQUEST['refresh'] === 'lists') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We don't want to fetch multiple times, so we unset the refresh parameter.</span>&nbsp;</div></li><li><div>          unset($_REQUEST['refresh']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !self::api_is_valid($api)) {&nbsp;</div></li><li><div>          self::log_error('Can\'t get fields because API isn\'t valid.');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug('getFields: fields are being fetched for $objectType '.$objectType);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $accountdescribe = $api-&gt;describeSObject($objectType);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_object($accountdescribe) || !isset($accountdescribe-&gt;fields)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_debug('getFields: There was an error with the describeSObject call: '.print_r($accountdescribe, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lists = $field_details = array();&nbsp;</div></li><li><div>      foreach($accountdescribe-&gt;fields as $Field) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!is_object($Field)) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $field_details = array(&nbsp;</div></li><li><div>              'name' =&gt; esc_js($Field-&gt;label), &nbsp;</div></li><li><div>              'req' =&gt; (!empty($Field-&gt;createable) && empty($Field-&gt;nillable) && empty($Field-&gt;defaultedOnCreate)), &nbsp;</div></li><li><div>              'tag' =&gt; esc_js($Field-&gt;name), &nbsp;</div></li><li><div>              'type' =&gt; $Field-&gt;type, &nbsp;</div></li><li><div>              'length' =&gt; $Field-&gt;length, &nbsp;</div></li><li><div>              'picklistValues' =&gt; isset($Field-&gt;picklistValues) ? $Field-&gt;picklistValues : null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $all_lists[] = $field_details;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// If you only want one type of field, and it's not that type, keep going</span></span>&nbsp;</div></li><li><div>          if(!empty($fieldType)) {&nbsp;</div></li><li><div>              if(&nbsp;</div></li><li><div>                  (is_string($fieldType) && $Field-&gt;type !== $fieldType) ||&nbsp;</div></li><li><div>                  (is_array($fieldType) && !in_array($Field-&gt;type, $fieldType))&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lists[] = $field_details;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      asort($lists);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_site_transient('sfgf_lists_fields_'.$objectType, $all_lists, self::$settings['cache_time']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $lists;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a list of available objects from Salesforce</span>&nbsp;</div></li><li><div><span class="comment">   * @return array      array of object types with `sObject-&gt;name` as the key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function getObjectTypes() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lists = get_site_transient('sfgf_objects');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($lists && (!isset($_REQUEST['refresh']) || (isset($_REQUEST['refresh']) && $_REQUEST['refresh'] !== 'lists'))) {&nbsp;</div></li><li><div>          return $lists;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!self::api_is_valid($api)) {&nbsp;</div></li><li><div>          self::log_error('getObjectTypes(): API is invalid. '.print_r($api, true));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          $objects = $api-&gt;describeGlobal();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(empty($objects) || !is_object($objects) || !isset($objects-&gt;sobjects)) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lists = array();&nbsp;</div></li><li><div>          foreach ($objects-&gt;sobjects as $object) {&nbsp;</div></li><li><div>              if(!is_object($object) || empty($object-&gt;createable)) { continue; }&nbsp;</div></li><li><div>              $lists[$object-&gt;name] = esc_html( $object-&gt;label );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          asort($lists);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          set_site_transient('sfgf_objects', $lists, self::$settings['cache_time']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $lists;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>          self::log_error( sprintf( &quot;getObjectTypes():\n\nException While Getting Object Types\n Here's the error:\n%s&quot;, $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function link_to_settings( $escaped = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = admin_url('admin.php?page=gf_settings&subview=sf-loader-api');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $escaped ? esc_attr( $url ) : $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function edit_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!function_exists('gform_tooltip')) {&nbsp;</div></li><li><div>          require_once(GFCommon::get_base_path() . &quot;/tooltips.php&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>          label span.howto { cursor: default; }&nbsp;</div></li><li><div>          .salesforce_col_heading{padding-bottom:2px; border-bottom: 1px solid #ccc; font-weight:bold; width:50%;}&nbsp;</div></li><li><div>          #salesforce_field_list table { width: 60%; min-width: 500px; border-collapse: collapse; margin-top: 1em; }&nbsp;</div></li><li><div>          .salesforce_field_cell { padding: 6px 17px 0 0; margin-right:15px; min-width: 150px;}&nbsp;</div></li><li><div>          .gfield_required{color:red;}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          .feeds_validation_error{ background-color:#FFDFDF;}&nbsp;</div></li><li><div>          .feeds_validation_error td{ margin-top:4px; margin-bottom:6px; padding-top:6px; padding-bottom:6px; border-top:1px dotted #C89797; border-bottom:1px dotted #C89797}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          .left_header{float:left; width:200px; padding-right: 20px;}&nbsp;</div></li><li><div>          #salesforce_field_list .left_header { margin-top: 1em; }&nbsp;</div></li><li><div>          .margin_vertical_10{margin: 20px 0;}&nbsp;</div></li><li><div>          #gf_salesforce_list { margin-left:220px; padding-top: 1px }&nbsp;</div></li><li><div>          #salesforce_doubleoptin_warning{padding-left: 5px; padding-bottom:4px; font-size: 10px;}&nbsp;</div></li><li><div>      &lt;/style&gt;&nbsp;</div></li><li><div>      &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>          var form = Array();&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;img alt=&quot;&lt;?php _e(&quot;Salesforce Feeds&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&quot; src=&quot;&lt;?php echo self::get_base_url()?&gt;/assets/images/salesforce-256x256.png&quot; style=&quot;float:left; margin:15px 7px 10px 0;&quot; width=&quot;84&quot;/&gt;&nbsp;</div></li><li><div>          &lt;h2&gt;&lt;?php _e(&quot;Salesforce Feeds&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;ul class=&quot;subsubsub&quot;&gt;&nbsp;</div></li><li><div>              &lt;li&gt;&lt;a href=&quot;&lt;?php echo self::link_to_settings(); ?&gt;&quot;&gt;Salesforce Settings&lt;/a&gt; |&lt;/li&gt;&nbsp;</div></li><li><div>              &lt;li&gt;&lt;a href=&quot;&lt;?php echo admin_url('admin.php?page=gf_salesforce'); ?&gt;&quot;&gt;Salesforce Feeds&lt;/a&gt;&lt;/li&gt;&nbsp;</div></li><li><div>          &lt;/ul&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      <span class="comment">//getting Salesforce API</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//ensures valid credentials were entered in the settings page</span>&nbsp;</div></li><li><div>      if(!self::api_is_valid($api)) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;error&quot; id=&quot;message&quot; style=&quot;margin-top:20px;&quot;&gt;&lt;?php echo wpautop(sprintf(__(&quot;We are unable to login to Salesforce with the provided username and API key. Please make sure they are valid in the %sSettings Page%s&quot;, &quot;gravity-forms-salesforce&quot;), &quot;&lt;a href='&quot;.self::link_to_settings().&quot;'&gt;&quot;, &quot;&lt;/a&gt;&quot;)); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//getting setting id (0 when creating a new one)</span>&nbsp;</div></li><li><div>      $id = !empty($_POST[&quot;salesforce_setting_id&quot;]) ? absint($_POST[&quot;salesforce_setting_id&quot;]) : absint($_GET[&quot;id&quot;]);&nbsp;</div></li><li><div>      $config = empty($id) ? array(&quot;meta&quot; =&gt; array(), &quot;is_active&quot; =&gt; true) : GFSalesforceData::get_feed($id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//getting merge vars</span>&nbsp;</div></li><li><div>      $merge_vars = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//updating meta information</span>&nbsp;</div></li><li><div>      if(isset($_POST[&quot;gf_salesforce_submit&quot;])) {&nbsp;</div></li><li><div>          $objectType = $list_names = array();&nbsp;</div></li><li><div>          $list = stripslashes($_POST[&quot;gf_salesforce_list&quot;]);&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;contact_object_name&quot;] = $list;&nbsp;</div></li><li><div>          $config[&quot;form_id&quot;] = absint($_POST[&quot;gf_salesforce_form&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_valid = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $merge_vars = (array)self::getFieldsForObject($_POST['gf_salesforce_list']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $field_map = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($merge_vars as $var) {&nbsp;</div></li><li><div>              $field_name = &quot;salesforce_map_field_&quot; . $var['tag'];&nbsp;</div></li><li><div>              $mapped_field = isset($_POST[$field_name]) ? stripslashes($_POST[$field_name]) : '';&nbsp;</div></li><li><div>              if(!empty($mapped_field)) {&nbsp;</div></li><li><div>                  $field_map[$var['tag']] = $mapped_field;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>                  unset($field_map[$var['tag']]);&nbsp;</div></li><li><div>                  if(!empty($var[&quot;req&quot;])) {&nbsp;</div></li><li><div>                      $is_valid = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              unset($_POST[&quot;{$field_name}&quot;]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;field_map&quot;] = $field_map;&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;optin_enabled&quot;] = !empty($_POST[&quot;salesforce_optin_enable&quot;]) ? true : false;&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;optin_field_id&quot;] = $config[&quot;meta&quot;][&quot;optin_enabled&quot;] ? isset($_POST[&quot;salesforce_optin_field_id&quot;]) ? $_POST[&quot;salesforce_optin_field_id&quot;] : '' : &quot;&quot;;&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;optin_operator&quot;] = $config[&quot;meta&quot;][&quot;optin_enabled&quot;] ? isset($_POST[&quot;salesforce_optin_operator&quot;]) ? $_POST[&quot;salesforce_optin_operator&quot;] : '' : &quot;&quot;;&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;optin_value&quot;] = $config[&quot;meta&quot;][&quot;optin_enabled&quot;] ? $_POST[&quot;salesforce_optin_value&quot;] : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $config['meta']['manual_export'] = !empty($_POST['salesforce_manual_export']) ? true : false; <span class="comment">// since 2.6.0</span>&nbsp;</div></li><li><div>          $config[&quot;meta&quot;][&quot;primary_field&quot;] = !empty( $_POST['salesforce_primary_field'] ) ? $_POST['salesforce_primary_field'] : ''; <span class="comment"><span class="comment">// since 2.5.2</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($is_valid) {&nbsp;</div></li><li><div>              $id = GFSalesforceData::update_feed($id, $config[&quot;form_id&quot;], $config[&quot;is_active&quot;], $config[&quot;meta&quot;]);&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;message&quot; class=&quot;updated fade&quot; style=&quot;margin-top:10px;&quot;&gt;&lt;p&gt;&lt;?php echo sprintf(__(&quot;Feed Updated. %sback to list%s&quot;, &quot;gravity-forms-salesforce&quot;), &quot;&lt;a href='?page=gf_salesforce'&gt;&quot;, &quot;&lt;/a&gt;&quot;) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;input type=&quot;hidden&quot; name=&quot;salesforce_setting_id&quot; value=&quot;&lt;?php echo $id ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else{&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;error&quot; style=&quot;padding:6px&quot;&gt;&lt;?php echo __(&quot;Feed could not be updated. Please enter all required information below.&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>      &lt;form method=&quot;post&quot; action=&quot;&lt;?php echo remove_query_arg('refresh'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;hidden&quot; name=&quot;salesforce_setting_id&quot; value=&quot;&lt;?php echo $id ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;margin_vertical_10&quot;&gt;&nbsp;</div></li><li><div>              &lt;h2&gt;&lt;?php _e('1. Select the Object to create when a form is submitted.', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;gf_salesforce_list&quot; class=&quot;left_header&quot;&gt;&lt;?php _e(&quot;Salesforce Object&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;?php gform_tooltip(&quot;salesforce_contact_list&quot;) ?&gt; &lt;span class=&quot;howto&quot;&gt;&lt;?php _e(sprintf(&quot;%sRefresh objects & fields%s&quot;, '&lt;a href=&quot;'.add_query_arg('refresh', 'lists').'&quot;&gt;', '&lt;/a&gt;'), &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>              <span class="comment">//getting all contact lists</span>&nbsp;</div></li><li><div>              $lists = self::getObjectTypes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$lists) {&nbsp;</div></li><li><div>                  echo __(&quot;Could not load Salesforce contact lists.&quot;, &quot;gravity-forms-salesforce&quot;);&nbsp;</div></li><li><div>                  echo isset($api-&gt;errorMessage) ? ' &lt;br/&gt;'.$api-&gt;errorMessage : '';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>                  &lt;select id=&quot;gf_salesforce_list&quot; name=&quot;gf_salesforce_list&quot; onchange=&quot;SelectList(jQuery(this).val()); SelectForm(jQuery(this).val(), jQuery('#gf_salesforce_form').val());&quot;&gt;&nbsp;</div></li><li><div>                      &lt;option value=&quot;&quot;&gt;&lt;?php _e(&quot;Select a Salesforce Object&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  foreach ($lists as $name =&gt; $label) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;option value=&quot;&lt;?php echo esc_html($name) ?&gt;&quot; &lt;?php selected(isset($config[&quot;meta&quot;][&quot;contact_object_name&quot;]) && ($name === $config[&quot;meta&quot;][&quot;contact_object_name&quot;])); ?&gt;&gt;&lt;?php echo esc_html($label) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>                  if(jQuery('#lists_loading').length && jQuery('#gf_salesforce_list').length) {&nbsp;</div></li><li><div>                      jQuery('#lists_loading').fadeOut(function() { jQuery('#gf_salesforce_list').fadeIn(); });&nbsp;</div></li><li><div>                   } else if(jQuery('#gf_salesforce_list').length) {&nbsp;</div></li><li><div>                      jQuery('#gf_salesforce_list').show();&nbsp;</div></li><li><div>                   }&nbsp;</div></li><li><div>               &lt;/script&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php flush(); ?&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;salesforce_form_container&quot; class=&quot;margin_vertical_10&quot; &lt;?php echo empty($config[&quot;meta&quot;][&quot;contact_object_name&quot;]) ? &quot;style='display:none;'&quot; : &quot;&quot; ?&gt;&gt;&nbsp;</div></li><li><div>              &lt;h2&gt;&lt;?php _e('2. Select the form to tap into.', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              $forms = RGFormsModel::get_forms();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(isset($config[&quot;form_id&quot;])) {&nbsp;</div></li><li><div>                  foreach($forms as $form) {&nbsp;</div></li><li><div>                      if($form-&gt;id == $config[&quot;form_id&quot;]) {&nbsp;</div></li><li><div>                          echo '&lt;h3 style=&quot;margin:0; padding:0 0 1em 1.75em; font-weight:normal;&quot;&gt;'.sprintf(__('(Currently linked with %s)', &quot;gravity-forms-salesforce&quot;), $form-&gt;title).'&lt;/h3&gt;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;gf_salesforce_form&quot; class=&quot;left_header&quot;&gt;&lt;?php _e(&quot;Gravity Form&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;?php gform_tooltip(&quot;salesforce_gravity_form&quot;) ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;select id=&quot;gf_salesforce_form&quot; name=&quot;gf_salesforce_form&quot; onchange=&quot;SelectForm(jQuery('#gf_salesforce_list').val(), jQuery(this).val());&quot;&gt;&nbsp;</div></li><li><div>              &lt;option value=&quot;&quot;&gt;&lt;?php _e(&quot;Select a form&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;/option&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($forms as $form) {&nbsp;</div></li><li><div>                  if(isset($config[&quot;form_id&quot;]) && absint($form-&gt;id) == $config[&quot;form_id&quot;]) {&nbsp;</div></li><li><div>                      $selected = &quot;selected='selected'&quot;;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $selected = &quot;&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;option value=&quot;&lt;?php echo absint($form-&gt;id) ?&gt;&quot;  &lt;?php echo $selected ?&gt;&gt;&lt;?php echo esc_html($form-&gt;title) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;/select&gt;&lt;span class=&quot;spinner salesforce_wait&quot; style=&quot;display: none; position: absolute;&quot;&gt;&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;salesforce_field_group&quot; &lt;?php echo empty($config[&quot;meta&quot;][&quot;contact_object_name&quot;]) || empty($config[&quot;form_id&quot;]) ? &quot;style='display:none;'&quot; : &quot;&quot; ?&gt;&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;salesforce_field_container&quot; class=&quot;margin_vertical_10&quot; &gt;&nbsp;</div></li><li><div>                  &lt;h2&gt;&lt;?php _e('3. Map form fields to Salesforce fields.', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>                  &lt;h3 class=&quot;description&quot;&gt;&lt;?php _e('About field mapping:', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;salesforce_fields&quot; class=&quot;left_header&quot;&gt;&lt;?php _e(&quot;Standard Fields&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;?php gform_tooltip(&quot;salesforce_map_fields&quot;) ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;salesforce_field_list&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  if(!empty($config[&quot;form_id&quot;])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">//getting list of all Salesforce merge variables for the selected contact list</span></span>&nbsp;</div></li><li><div>                      if(empty($merge_vars))&nbsp;</div></li><li><div>                          $merge_vars = self::getFieldsForObject($config['meta']['contact_object_name']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">//getting field map UI</span></span>&nbsp;</div></li><li><div>                      echo self::get_field_mapping($config, $config[&quot;form_id&quot;], $merge_vars );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">//getting list of selection fields to be used by the optin</span>&nbsp;</div></li><li><div>                      $form_meta = RGFormsModel::get_form_meta($config[&quot;form_id&quot;]);&nbsp;</div></li><li><div>                      $selection_fields = GFCommon::get_selection_fields($form_meta, $config[&quot;meta&quot;][&quot;optin_field_id&quot;]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php <span class="comment">/** Manual Export - Bypass automatic export (since 2.6.0) */</span> ?&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;salesforce_manual_export_container&quot; class=&quot;margin_vertical_10&quot;&gt;&nbsp;</div></li><li><div>                  &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                      &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;row&quot;&gt;&lt;?php esc_html_e('Disable Automatic Export', &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;?php gform_tooltip(&quot;salesforce_manual_export&quot;); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;td&gt;&nbsp;</div></li><li><div>                              &lt;fieldset&gt;&nbsp;</div></li><li><div>                                  &lt;legend class=&quot;screen-reader-text&quot;&gt;&lt;span&gt;&lt;?php _e('Disable Automatic Export', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/span&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>                                  &lt;label for=&quot;salesforce_manual_export&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;input name=&quot;salesforce_manual_export&quot; type=&quot;checkbox&quot; id=&quot;salesforce_manual_export&quot; value=&quot;1&quot; &lt;?php echo !empty( $config['meta']['manual_export'] ) ? 'checked=&quot;checked&quot;' : ''; ?&gt;&gt;&nbsp;</div></li><li><div>                                      &lt;?php esc_html_e( 'Entries will be sent to Salesforce when updated in the admin', &quot;gravity-forms-salesforce&quot;); ?&gt;&nbsp;</div></li><li><div>                                  &lt;/label&gt;&nbsp;</div></li><li><div>                              &lt;/fieldset&gt;&nbsp;</div></li><li><div>                          &lt;/td&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;/table&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div id=&quot;salesforce_optin_container&quot; class=&quot;margin_vertical_10&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;salesforce_optin&quot; class=&quot;left_header&quot;&gt;&lt;?php _e(&quot;Opt-In Condition&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt; &lt;?php gform_tooltip(&quot;salesforce_optin_condition&quot;); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;salesforce_optin&quot;&gt;&nbsp;</div></li><li><div>                      &lt;table&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;td&gt;&nbsp;</div></li><li><div>                                  &lt;input type=&quot;checkbox&quot; id=&quot;salesforce_optin_enable&quot; name=&quot;salesforce_optin_enable&quot; value=&quot;1&quot; onclick=&quot;if(this.checked) {jQuery('#salesforce_optin_condition_field_container').show('slow');} else{jQuery('#salesforce_optin_condition_field_container').hide('slow');}&quot; &lt;?php echo !empty($config[&quot;meta&quot;][&quot;optin_enabled&quot;]) ? &quot;checked='checked'&quot; : &quot;&quot;?&gt;/&gt;&nbsp;</div></li><li><div>                                  &lt;label for=&quot;salesforce_optin_enable&quot;&gt;&lt;?php _e(&quot;Enable&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;td&gt;&nbsp;</div></li><li><div>                                  &lt;div id=&quot;salesforce_optin_condition_field_container&quot; &lt;?php echo empty($config[&quot;meta&quot;][&quot;optin_enabled&quot;]) ? &quot;style='display:none'&quot; : &quot;&quot;?&gt;&gt;&nbsp;</div></li><li><div>                                      &lt;div id=&quot;salesforce_optin_condition_fields&quot; &lt;?php echo empty($selection_fields) ? &quot;style='display:none'&quot; : &quot;&quot;?&gt;&gt;&nbsp;</div></li><li><div>                                          &lt;?php _e(&quot;Export to Salesforce if &quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          &lt;select id=&quot;salesforce_optin_field_id&quot; name=&quot;salesforce_optin_field_id&quot; class='optin_select' onchange='jQuery(&quot;#salesforce_optin_value&quot;).html(GetFieldValues(jQuery(this).val(), &quot;&quot;, 20));'&gt;&lt;?php echo $selection_fields ?&gt;&lt;/select&gt;&nbsp;</div></li><li><div>                                          &lt;select id=&quot;salesforce_optin_operator&quot; name=&quot;salesforce_optin_operator&quot; /&gt;&nbsp;</div></li><li><div>                                              &lt;option value=&quot;is&quot; &lt;?php echo (isset($config[&quot;meta&quot;][&quot;optin_operator&quot;]) && $config[&quot;meta&quot;][&quot;optin_operator&quot;] == &quot;is&quot;) ? &quot;selected='selected'&quot; : &quot;&quot; ?&gt;&gt;&lt;?php _e(&quot;is&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                              &lt;option value=&quot;isnot&quot; &lt;?php echo (isset($config[&quot;meta&quot;][&quot;optin_operator&quot;]) && $config[&quot;meta&quot;][&quot;optin_operator&quot;] == &quot;isnot&quot;) ? &quot;selected='selected'&quot; : &quot;&quot; ?&gt;&gt;&lt;?php _e(&quot;is not&quot;, &quot;gravity-forms-salesforce&quot;) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                          &lt;/select&gt;&nbsp;</div></li><li><div>                                          &lt;select id=&quot;salesforce_optin_value&quot; name=&quot;salesforce_optin_value&quot; class='optin_select'&gt;&nbsp;</div></li><li><div>                                          &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      &lt;/div&gt;&nbsp;</div></li><li><div>                                      &lt;div id=&quot;salesforce_optin_condition_message&quot; &lt;?php echo !empty($selection_fields) ? &quot;style='display:none'&quot; : &quot;&quot;?&gt;&gt;&nbsp;</div></li><li><div>                                          &lt;?php _e(&quot;To create an Opt-In condition, your form must have a drop down, checkbox or multiple choice field.&quot;, &quot;gravityform&quot;) ?&gt;&nbsp;</div></li><li><div>                                      &lt;/div&gt;&nbsp;</div></li><li><div>                                  &lt;/div&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      if(!empty($config[&quot;form_id&quot;])) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          <span class="comment">//creating Javascript form object</span>&nbsp;</div></li><li><div>                          form = &lt;?php echo GFCommon::json_encode($form_meta)?&gt; ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">//initializing drop downs</span>&nbsp;</div></li><li><div>                          jQuery(document).ready(function() {&nbsp;</div></li><li><div>                              var selectedField = &quot;&lt;?php echo str_replace('&quot;', '\&quot;', $config[&quot;meta&quot;][&quot;optin_field_id&quot;])?&gt;&quot;;&nbsp;</div></li><li><div>                              var selectedValue = &quot;&lt;?php echo str_replace('&quot;', '\&quot;', $config[&quot;meta&quot;][&quot;optin_value&quot;])?&gt;&quot;;&nbsp;</div></li><li><div>                              SetOptin(selectedField, selectedValue);&nbsp;</div></li><li><div>                          });&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/script&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php <span class="comment">/** define the field to be used as primary key when exporting entry to salesforce, thus avoiding duplicate entries (since 2.5.2) */</span> ?&gt;&nbsp;</div></li><li><div>              &lt;?php if( !empty( $config['meta']['contact_object_name'] ) ) :&nbsp;</div></li><li><div>                  $current_primary_field = !empty( $config['meta']['primary_field'] ) ? $config['meta']['primary_field'] : ''; ?&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;salesforce_optin_container&quot; class=&quot;margin_vertical_10&quot;&gt;&nbsp;</div></li><li><div>                      &lt;h2&gt;&lt;?php _e('4. Choose a &quot;Primary Key&quot; field.', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>                      &lt;h3 class=&quot;description&quot;&gt;&lt;?php _e('What field should be used to update existing objects?', &quot;gravity-forms-salesforce&quot;); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;salesforce_primary_field&quot; class=&quot;left_header&quot;&gt;&lt;?php esc_html_e( 'Update Field', 'gravity-forms-salesforce' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;table&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                              &lt;td scope=&quot;row&quot;&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;td&gt;&nbsp;</div></li><li><div>                                  &lt;select id=&quot;salesforce_primary_field&quot; name=&quot;salesforce_primary_field&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php echo self::render_options_as_fields( $config['meta']['contact_object_name'], $current_primary_field ); ?&gt;&nbsp;</div></li><li><div>                                  &lt;/select&gt;&nbsp;</div></li><li><div>                                  &lt;span class=&quot;howto&quot;&gt;&lt;?php esc_html_e('If you want to update a pre-existing object, define what should be used as an unique identifier (&quot;Primary Key&quot;). For example, this may be an email address, Lead ID, or address.', 'gravity-forms-salesforce'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div class=&quot;button-controls submit&quot;&gt;&nbsp;</div></li><li><div>                  &lt;input type=&quot;submit&quot; name=&quot;gf_salesforce_submit&quot; value=&quot;&lt;?php echo empty($id) ? __(&quot;Save Feed&quot;, &quot;gravity-forms-salesforce&quot;) : __(&quot;Update Feed&quot;, &quot;gravity-forms-salesforce&quot;); ?&gt;&quot; class=&quot;button button-primary button-hero&quot;/&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>  jQuery(document).ready(function($) {&nbsp;</div></li><li><div>          $('#gf_salesforce_list').live('load change', function() {&nbsp;</div></li><li><div>              $('#lists_loading').hide();&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>          $(&quot;#gf_salesforce_list input&quot;).bind('click change', function() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($(&quot;#gf_salesforce_list input:checked&quot;).length &gt; 0) {&nbsp;</div></li><li><div>                  SelectList(1);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  SelectList(false);&nbsp;</div></li><li><div>                  jQuery(&quot;#gf_salesforce_form&quot;).val(&quot;&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php if(isset($_REQUEST['id'])) { ?&gt;&nbsp;</div></li><li><div>      $('#salesforce_field_list').live('load', function() {&nbsp;</div></li><li><div>          $('.salesforce_field_cell select').each(function() {&nbsp;</div></li><li><div>              var $select = $(this);&nbsp;</div></li><li><div>              var label = $.trim($('label[for='+$(this).prop('name')+']').text());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              label = label.replace(' *', '');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($select.val() === '') {&nbsp;</div></li><li><div>                  $('option', $select).each(function() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if($(this).text() === label) {&nbsp;</div></li><li><div>                          $(this).prop('selected', true);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  });&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>  &lt;?php } ?&gt;&nbsp;</div></li><li><div>  });&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function SelectList(listId) {&nbsp;</div></li><li><div>              if(listId) {&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_form_container&quot;).slideDown();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_form_container&quot;).slideUp();&nbsp;</div></li><li><div>                  EndSelectForm(&quot;&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function SelectForm(listId, formId) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!formId) {&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_field_group&quot;).slideUp();&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              jQuery(&quot;.salesforce_wait&quot;).css({&nbsp;</div></li><li><div>                  'display': 'inline-block', &nbsp;</div></li><li><div>              });&nbsp;</div></li><li><div>              jQuery(&quot;#salesforce_field_group&quot;).slideUp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              var mysack = new sack(&quot;&lt;?php bloginfo( 'wpurl' ); ?&gt;/wp-admin/admin-ajax.php&quot; );&nbsp;</div></li><li><div>              mysack.execute = 1;&nbsp;</div></li><li><div>              mysack.method = 'POST';&nbsp;</div></li><li><div>              mysack.setVar( &quot;action&quot;, &quot;gf_select_salesforce_form&quot; );&nbsp;</div></li><li><div>              mysack.setVar( &quot;gf_select_salesforce_form&quot;, &quot;&lt;?php echo wp_create_nonce(&quot;gf_select_salesforce_form&quot;) ?&gt;&quot; );&nbsp;</div></li><li><div>              mysack.setVar( &quot;objectType&quot;, listId);&nbsp;</div></li><li><div>              mysack.setVar( &quot;form_id&quot;, formId);&nbsp;</div></li><li><div>              mysack.encVar( &quot;cookie&quot;, document.cookie, false );&nbsp;</div></li><li><div>              mysack.onError = function() {jQuery(&quot;.salesforce_wait&quot;).hide(); alert('&lt;?php echo esc_js(__(&quot;Ajax error while selecting a form&quot;, &quot;gravity-forms-salesforce&quot;)); ?&gt;' )};&nbsp;</div></li><li><div>              mysack.runAJAX();&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function SetOptin(selectedField, selectedValue) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//load form fields</span>&nbsp;</div></li><li><div>              jQuery(&quot;#salesforce_optin_field_id&quot;).html(GetSelectableFields(selectedField, 20));&nbsp;</div></li><li><div>              var optinConditionField = jQuery(&quot;#salesforce_optin_field_id&quot;).val();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(optinConditionField) {&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_optin_condition_message&quot;).hide();&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_optin_condition_fields&quot;).show();&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_optin_value&quot;).html(GetFieldValues(optinConditionField, selectedValue, 20));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_optin_condition_message&quot;).show();&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_optin_condition_fields&quot;).hide();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function EndSelectForm(fieldList, form_meta) {&nbsp;</div></li><li><div>              <span class="comment">//setting global form object</span>&nbsp;</div></li><li><div>              form = form_meta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(fieldList) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  SetOptin(&quot;&quot;, &quot;&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_field_list&quot;).html(fieldList);&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_field_group&quot;).slideDown();&nbsp;</div></li><li><div>                  jQuery('#salesforce_field_list').trigger('load');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_field_group&quot;).slideUp();&nbsp;</div></li><li><div>                  jQuery(&quot;#salesforce_field_list&quot;).html(&quot;&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              jQuery(&quot;.salesforce_wait&quot;).hide();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function GetFieldValues(fieldId, selectedValue, labelMaxCharacters) {&nbsp;</div></li><li><div>              if(!fieldId)&nbsp;</div></li><li><div>                  return &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              var str = &quot;&quot;;&nbsp;</div></li><li><div>              var field = GetFieldById(fieldId);&nbsp;</div></li><li><div>              if(!field || !field.choices)&nbsp;</div></li><li><div>                  return &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              var isAnySelected = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              for(var i=0; i&lt;field.choices.length; i++) {&nbsp;</div></li><li><div>                  var fieldValue = field.choices[i].value ? field.choices[i].value : field.choices[i].text;&nbsp;</div></li><li><div>                  var isSelected = fieldValue == selectedValue;&nbsp;</div></li><li><div>                  var selected = isSelected ? &quot;selected='selected'&quot; : &quot;&quot;;&nbsp;</div></li><li><div>                  if(isSelected)&nbsp;</div></li><li><div>                      isAnySelected = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  str += &quot;&lt;option value='&quot; + fieldValue.replace(&quot;'&quot;, &quot;&#039;&quot;) + &quot;' &quot; + selected + &quot;&gt;&quot; + TruncateMiddle(field.choices[i].text, labelMaxCharacters) + &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!isAnySelected && selectedValue) {&nbsp;</div></li><li><div>                  str += &quot;&lt;option value='&quot; + selectedValue.replace(&quot;'&quot;, &quot;&#039;&quot;) + &quot;' selected='selected'&gt;&quot; + TruncateMiddle(selectedValue, labelMaxCharacters) + &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return str;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function GetFieldById(fieldId) {&nbsp;</div></li><li><div>              for(var i=0; i&lt;form.fields.length; i++) {&nbsp;</div></li><li><div>                  if(form.fields[i].id == fieldId)&nbsp;</div></li><li><div>                      return form.fields[i];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function TruncateMiddle(text, maxCharacters) {&nbsp;</div></li><li><div>              if(text.length &lt;= maxCharacters)&nbsp;</div></li><li><div>                  return text;&nbsp;</div></li><li><div>              var middle = parseInt(maxCharacters / 2);&nbsp;</div></li><li><div>              return text.substr(0, middle) + &quot;...&quot; + text.substr(text.length - middle, middle);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function GetSelectableFields(selectedFieldId, labelMaxCharacters) {&nbsp;</div></li><li><div>              var str = &quot;&quot;;&nbsp;</div></li><li><div>              var inputType;&nbsp;</div></li><li><div>              for(var i=0; i&lt;form.fields.length; i++) {&nbsp;</div></li><li><div>                  fieldLabel = form.fields[i].adminLabel ? form.fields[i].adminLabel : form.fields[i].label;&nbsp;</div></li><li><div>                  inputType = form.fields[i].inputType ? form.fields[i].inputType : form.fields[i].type;&nbsp;</div></li><li><div>                  if(inputType == &quot;checkbox&quot; || inputType == &quot;radio&quot; || inputType == &quot;select&quot;) {&nbsp;</div></li><li><div>                      var selected = form.fields[i].id == selectedFieldId ? &quot;selected='selected'&quot; : &quot;&quot;;&nbsp;</div></li><li><div>                      str += &quot;&lt;option value='&quot; + form.fields[i].id + &quot;' &quot; + selected + &quot;&gt;&quot; + TruncateMiddle(fieldLabel, labelMaxCharacters) + &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return str;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render html select options where values are the fields of a specific salesforce object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $object</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $current (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @return string html</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function render_options_as_fields( $object, $current = '' ) {&nbsp;</div></li><li><div>      if( empty( $object ) ) {&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $fields = self::getFieldsForObject( $object );&nbsp;</div></li><li><div>      self::sorter($fields, 'name');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output = '&lt;option value=&quot;&quot; '. selected( $current, '', false ) .'&gt;'. esc_html__( 'None', 'gravity-forms-salesforce' ) .'&lt;/option&gt;';&nbsp;</div></li><li><div>      if( !empty( $fields ) ) {&nbsp;</div></li><li><div>          foreach( $fields as $field ) {&nbsp;</div></li><li><div>              $output .= '&lt;option value=&quot;'. esc_attr( $field['tag'] ) .'&quot; '. selected( $current , $field['tag'], false ) .'&gt;'.esc_html( $field['name'] ) .'&lt;/option&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Ajax support function. Retrieve html for select options for a specific Salesforce object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @return string html</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.2</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_options_as_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $_POST['sf_object'] ) || ! isset( $_POST['nonce'] ) ||&nbsp;</div></li><li><div>          ! wp_verify_nonce( $_POST['nonce'], 'gf_salesforce_edit_feed' ) )&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          exit(false);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo self::render_options_as_fields( $_POST['sf_object'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enqueue custom scripts at salesforce settings page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $hook</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.2</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function add_custom_script( $hook ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !in_array( $hook , array( 'forms_page_gf_salesforce' ) ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_register_script( 'gf_salesforce_edit_feed', plugin_dir_url( KWS_GF_Salesforce::$file ) . 'assets/js/edit-feed.js', array( 'jquery' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'gf_salesforce_edit_feed');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_localize_script('gf_salesforce_edit_feed', 'ajax_object', array( 'ajaxurl' =&gt; admin_url( 'admin-ajax.php' ), 'nonce' =&gt; wp_create_nonce( 'gf_salesforce_edit_feed' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function add_permissions() {&nbsp;</div></li><li><div>      global $wp_roles;&nbsp;</div></li><li><div>      $wp_roles-&gt;add_cap(&quot;administrator&quot;, &quot;gravityforms_salesforce&quot;);&nbsp;</div></li><li><div>      $wp_roles-&gt;add_cap(&quot;administrator&quot;, &quot;gravityforms_salesforce_uninstall&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Target of Member plugin filter. Provides the plugin with Gravity Forms lists of capabilities</span>&nbsp;</div></li><li><div>  public static function members_get_capabilities( $caps ) {&nbsp;</div></li><li><div>      return array_merge($caps, array(&quot;gravityforms_salesforce&quot;, &quot;gravityforms_salesforce_uninstall&quot;));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function disable_salesforce() {&nbsp;</div></li><li><div>      delete_option(&quot;gf_salesforce_settings&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function select_salesforce_form() {&nbsp;</div></li><li><div>      check_ajax_referer(&quot;gf_select_salesforce_form&quot;, &quot;gf_select_salesforce_form&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!self::api_is_valid($api) || !isset($_POST[&quot;objectType&quot;])) {&nbsp;</div></li><li><div>          exit(&quot;EndSelectForm();&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_id =  intval($_POST[&quot;form_id&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $setting_id =  0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//getting list of all Salesforce merge variables for the selected contact list</span></span>&nbsp;</div></li><li><div>      $merge_vars = @self::getFieldsForObject($_POST['objectType']);;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($merge_vars)) {&nbsp;</div></li><li><div>          echo sprintf(&quot;alert('There was an error retrieving fields for the %s Object');&quot;, esc_js($_POST['objectType']));&nbsp;</div></li><li><div>          exit(&quot; EndSelectForm();&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//getting configuration</span>&nbsp;</div></li><li><div>      $config = GFSalesforceData::get_feed($setting_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//getting field map UI</span></span>&nbsp;</div></li><li><div>      $str = self::get_field_mapping($config, $form_id, $merge_vars);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//fields meta</span>&nbsp;</div></li><li><div>      $form = RGFormsModel::get_form_meta($form_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      exit(&quot;EndSelectForm('&quot; .str_replace(&quot;'&quot;, &quot;\'&quot;, $str). &quot;', &quot; . GFCommon::json_encode($form) . &quot;);&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function show_field_type_desc($field = '') {&nbsp;</div></li><li><div>      $types = array(&nbsp;</div></li><li><div>          'anyType', &nbsp;</div></li><li><div>          'calculated', &nbsp;</div></li><li><div>          'combobox', &nbsp;</div></li><li><div>          'currency', &nbsp;</div></li><li><div>          'DataCategoryGroupReference', &nbsp;</div></li><li><div>          'email', &nbsp;</div></li><li><div>          'encryptedstring', &nbsp;</div></li><li><div>          'ID', &nbsp;</div></li><li><div>          'masterrecord', &nbsp;</div></li><li><div>          'multipicklist', &nbsp;</div></li><li><div>          'percent', &nbsp;</div></li><li><div>          'phone', &nbsp;</div></li><li><div>          'picklist', &nbsp;</div></li><li><div>          'reference', &nbsp;</div></li><li><div>          'textarea', &nbsp;</div></li><li><div>          'url', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return in_array($field, $types);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function get_field_mapping($config = array(), $form_id, $merge_vars) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $usedFields = array();&nbsp;</div></li><li><div>      $str = $custom = $standard = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//getting list of all fields for the selected form</span>&nbsp;</div></li><li><div>      $form_fields = self::get_form_fields($form_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $str = &quot;&lt;table cellpadding='0' cellspacing='0'&gt;&lt;thead&gt;&lt;tr&gt;&lt;th scope='col' class='salesforce_col_heading'&gt;&quot; . __(&quot;List Fields&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/th&gt;&lt;th scope='col' class='salesforce_col_heading'&gt;&quot; . __(&quot;Form Fields&quot;, &quot;gravity-forms-salesforce&quot;) . &quot;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach((array)$merge_vars as $var) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($var['type'] === 'reference' && empty($var['req']) && apply_filters('gf_salesforce_skip_reference_types', true)) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $selected_field = isset($config[&quot;meta&quot;][&quot;field_map&quot;][$var[&quot;tag&quot;]]) ? $config[&quot;meta&quot;][&quot;field_map&quot;][$var[&quot;tag&quot;]] : false;&nbsp;</div></li><li><div>          $required = $var[&quot;req&quot;] === true ? &quot;&lt;span class='gfield_required' title='This field is required.'&gt;&quot;.__('(Required)', 'gravity-forms-salesforce').&quot;&lt;/span&gt;&quot; : &quot;&quot;;&nbsp;</div></li><li><div>          $error_class = $var[&quot;req&quot;] === true && empty($selected_field) && !empty($_POST[&quot;gf_salesforce_submit&quot;]) ? &quot; feeds_validation_error&quot; : &quot;&quot;;&nbsp;</div></li><li><div>          $field_desc = '';&nbsp;</div></li><li><div>          if(self::show_field_type_desc($var['type'])) {&nbsp;</div></li><li><div>              $field_desc = '&lt;div&gt;'.sprintf( __('Type: %s', 'gravity-forms-salesforce'), esc_attr( $var[&quot;type&quot;] ) ) .'&lt;/div&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if(!empty($var[&quot;length&quot;])) { $field_desc .= '&lt;div&gt;' . sprintf( __('Max Length: %s', 'gravity-forms-salesforce' ), esc_attr( $var[&quot;length&quot;] ) ).'&lt;/div&gt;'; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add Daddy Analytics notice</span>&nbsp;</div></li><li><div>          if($var['tag'] === 'LeadSource') {&nbsp;</div></li><li><div>              $field_desc = apply_filters('gf_salesforce_lead_source_label', $field_desc );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $row = &quot;&lt;tr class='$error_class'&gt;&lt;td class='salesforce_field_cell'&gt;&lt;label for='salesforce_map_field_{$var['tag']}'&gt;&quot; . stripslashes( $var[&quot;name&quot;] )  . &quot; $required&lt;/label&gt;&lt;small class='description' style='display:block'&gt;{$field_desc}&lt;/small&gt;&lt;/td&gt;&lt;td class='salesforce_field_cell'&gt;&quot; . self::get_mapped_field_list($var[&quot;tag&quot;], $selected_field, $form_fields) . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $str .= $row;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } <span class="comment">// End foreach merge var.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $str .= &quot;&lt;/tbody&gt;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_form_fields($form_id) {&nbsp;</div></li><li><div>      $form = RGFormsModel::get_form_meta($form_id);&nbsp;</div></li><li><div>      $fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Adding default fields</span>&nbsp;</div></li><li><div>      array_push($form['fields'], array(&quot;id&quot; =&gt; &quot;date_created&quot; , &quot;label&quot; =&gt; __(&quot;Entry Date&quot;, &quot;gravity-forms-salesforce&quot;)));&nbsp;</div></li><li><div>      array_push($form['fields'], array(&quot;id&quot; =&gt; &quot;ip&quot; , &quot;label&quot; =&gt; __(&quot;User IP&quot;, &quot;gravity-forms-salesforce&quot;)));&nbsp;</div></li><li><div>      array_push($form['fields'], array(&quot;id&quot; =&gt; &quot;source_url&quot; , &quot;label&quot; =&gt; __(&quot;Source Url&quot;, &quot;gravity-forms-salesforce&quot;)));&nbsp;</div></li><li><div>      array_push($form['fields'], array(&quot;id&quot; =&gt; &quot;form_title&quot; , &quot;label&quot; =&gt; __(&quot;Form Title&quot;, &quot;gravity-forms-salesforce&quot;)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_array($form['fields'])) {&nbsp;</div></li><li><div>          self::sorter($form['fields'], 'label');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// push other form field options onto stack as &quot;Primary Keys&quot;</span>&nbsp;</div></li><li><div>          if($form_id) {&nbsp;</div></li><li><div>              if($feeds = GFSalesforceData::get_feed_by_form($form_id, true)) {&nbsp;</div></li><li><div>                  foreach($feeds as $feed) {&nbsp;</div></li><li><div>                      $label = self::primary_key_label($feed);&nbsp;</div></li><li><div>                      $options = array(&nbsp;</div></li><li><div>                          &quot;id&quot; =&gt; self::primary_key_id($feed), &nbsp;</div></li><li><div>                          &quot;label&quot; =&gt; __($label, &quot;gravity-forms-salesforce&quot;)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      array_unshift($form['fields'], $options);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($form['fields'] as $field) {&nbsp;</div></li><li><div>              if(isset($field[&quot;inputs&quot;]) && is_array($field[&quot;inputs&quot;]) && $field['type'] !== 'checkbox' && $field['type'] !== 'select') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//If this is an address field, add full name to the list</span>&nbsp;</div></li><li><div>                  if(RGFormsModel::get_input_type($field) == &quot;address&quot;) {&nbsp;</div></li><li><div>                      $fields[] =  array($field[&quot;id&quot;], GFCommon::get_label($field) . &quot; (&quot; . _x(&quot;Full&quot; , 'Full field label', &quot;gravity-forms-salesforce&quot;) . &quot;)&quot;);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($field[&quot;inputs&quot;] as $input)&nbsp;</div></li><li><div>                      $fields[] =  array($input[&quot;id&quot;], GFCommon::get_label($field, $input[&quot;id&quot;]));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else if(empty($field[&quot;displayOnly&quot;])) {&nbsp;</div></li><li><div>                  $fields[] =  array($field[&quot;id&quot;], GFCommon::get_label($field));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function get_address($entry, $field_id) {&nbsp;</div></li><li><div>      $street_value = str_replace(&quot;  &quot;, &quot; &quot;, trim($entry[$field_id . &quot;.1&quot;]));&nbsp;</div></li><li><div>      $street2_value = str_replace(&quot;  &quot;, &quot; &quot;, trim($entry[$field_id . &quot;.2&quot;]));&nbsp;</div></li><li><div>      $city_value = str_replace(&quot;  &quot;, &quot; &quot;, trim($entry[$field_id . &quot;.3&quot;]));&nbsp;</div></li><li><div>      $state_value = str_replace(&quot;  &quot;, &quot; &quot;, trim($entry[$field_id . &quot;.4&quot;]));&nbsp;</div></li><li><div>      $zip_value = trim($entry[$field_id . &quot;.5&quot;]);&nbsp;</div></li><li><div>      $country_value = GFCommon::get_country_code(trim($entry[$field_id . &quot;.6&quot;]));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $address = $street_value;&nbsp;</div></li><li><div>      $address .= !empty($address) && !empty($street2_value) ? &quot;  $street2_value&quot; : $street2_value;&nbsp;</div></li><li><div>      $address .= !empty($address) && (!empty($city_value) || !empty($state_value)) ? &quot;  $city_value&quot; : $city_value;&nbsp;</div></li><li><div>      $address .= !empty($address) && !empty($city_value) && !empty($state_value) ? &quot;  $state_value&quot; : $state_value;&nbsp;</div></li><li><div>      $address .= !empty($address) && !empty($zip_value) ? &quot;  $zip_value&quot; : $zip_value;&nbsp;</div></li><li><div>      $address .= !empty($address) && !empty($country_value) ? &quot;  $country_value&quot; : $country_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $address;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_mapped_field_list($variable_name, $selected_field, $fields) {&nbsp;</div></li><li><div>      $field_name = &quot;salesforce_map_field_&quot; . $variable_name;&nbsp;</div></li><li><div>      $str = &quot;&lt;select name='$field_name' id='$field_name'&gt;&lt;option value=''&gt;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>      foreach($fields as $field) {&nbsp;</div></li><li><div>          $field_id = $field[0];&nbsp;</div></li><li><div>          $field_label = $field[1];&nbsp;</div></li><li><div>          $str .= &quot;&lt;option value='&quot; . $field_id . &quot;' &quot;. selected(($field_id == $selected_field), true, false) . &quot;&gt;&quot; . $field_label . &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $str .= &quot;&lt;/select&gt;&quot;;&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_mapped_field_checkbox($variable_name, $selected_field, $field) {&nbsp;</div></li><li><div>      $field_name = &quot;salesforce_map_field_&quot; . $variable_name;&nbsp;</div></li><li><div>      $field_id = $field[0];&nbsp;</div></li><li><div>      $str =  &quot;&lt;input name='$field_name' id='$field_name' type='checkbox' value='$field_id'&quot;;&nbsp;</div></li><li><div>      $selected = $field_id == $selected_field ? &quot; checked='checked'&quot; : false;&nbsp;</div></li><li><div>      if($selected) {&nbsp;</div></li><li><div>          $str .= $selected;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $str .= &quot; /&gt;&quot;;&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Called when entry is manually updated in the Single Entry view of Gravity Forms.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method is called by both `admin_init` and `gforms_after_update_entry`.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo  Convert to using GFCommon::send_notification() instead</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $form GF Form array</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $entry_id Entry ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function manual_export( $form, $entry_id = NULL ) {&nbsp;</div></li><li><div>      global $plugin_page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is this the Gravity Forms entries page?</span>&nbsp;</div></li><li><div>      if(false === (self::is_gravity_page('gf_entries') && rgget(&quot;view&quot;) == 'entry' && (rgget('lid') || !rgblank(rgget('pos'))))) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Both admin_init and gforms_after_update_entry will have this set</span>&nbsp;</div></li><li><div>      if( empty( $_POST['gforms_save_entry'] ) || empty( $_POST['action'] ) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Different checks since admin_init runs in both cases but we need to wait for entry update</span>&nbsp;</div></li><li><div>      $current_hook = current_filter();&nbsp;</div></li><li><div>      if( $current_hook == 'admin_init' && empty( $_POST['send_to_salesforce'] ) ) { return; }&nbsp;</div></li><li><div>      if( $current_hook == 'gform_after_update_entry' && empty( $_POST['update_to_salesforce'] ) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Verify authenticity of request</span>&nbsp;</div></li><li><div>      check_admin_referer('gforms_save_entry', 'gforms_save_entry');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For admin_init hook, get the entry ID from the URL</span>&nbsp;</div></li><li><div>      if(empty($entry_id)) {&nbsp;</div></li><li><div>          $entry_id = rgget('lid');&nbsp;</div></li><li><div>          $form_id = rgget('id');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// fetch alternative entry id: look for gf list details when using pagination</span>&nbsp;</div></li><li><div>          if(empty($entry_id)) {&nbsp;</div></li><li><div>              $position = rgget('pos');&nbsp;</div></li><li><div>              $paging = array('offset' =&gt; $position, 'page_size' =&gt; 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $entries = GFAPI::get_entries($form_id, array(), null, $paging);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!empty($entries)) {&nbsp;</div></li><li><div>                  <span class="comment">// pluck first entry to use id from, should always only be one</span>&nbsp;</div></li><li><div>                  $entry = array_shift($entries);&nbsp;</div></li><li><div>                  $entry_id = $entry['id'];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  self::log_error(__METHOD__ . ': Could not locate GF entry.');&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $form = RGFormsModel::get_form_meta($form_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fetch entry (use new GF API from version 1.8)</span>&nbsp;</div></li><li><div>      if( class_exists( 'GFAPI' ) && !empty( $entry_id ) ) {&nbsp;</div></li><li><div>          $entry = GFAPI::get_entry( $entry_id );&nbsp;</div></li><li><div>      } elseif( class_exists( 'RGFormsModel' ) && !empty( $entry_id ) ) {&nbsp;</div></li><li><div>          $entry = RGFormsModel::get_lead( $entry_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          self::log_error('manual_export(): Expected Gravity Forms classes did not exist. Have to leave now.');&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Export the entry</span>&nbsp;</div></li><li><div>      self::export($entry, $form, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Don't send twice.</span>&nbsp;</div></li><li><div>      unset($_POST['update_to_salesforce']);&nbsp;</div></li><li><div>      unset($_POST['send_to_salesforce']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function export($entry, $form, $manual_export = false) {&nbsp;</div></li><li><div>      <span class="comment">//Login to Salesforce</span>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!self::api_is_valid($api)) {&nbsp;</div></li><li><div>          self::log_error('export(): Invalid API. '.print_r($api, true));&nbsp;</div></li><li><div>          do_action('gf_salesforce_error', 'export', $api);&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// getting all active feeds</span>&nbsp;</div></li><li><div>      $feeds = GFSalesforceData::get_feed_by_form($form[&quot;id&quot;], true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($feeds as $feed) {&nbsp;</div></li><li><div>          <span class="comment">// If feed has Manual Export enabled, stop export - since 2.6.0</span>&nbsp;</div></li><li><div>          <span class="comment">// If it's manual, though, go head.</span>&nbsp;</div></li><li><div>          if( !empty( $feed['meta']['manual_export'] ) && !$manual_export) {&nbsp;</div></li><li><div>              self::log_debug('export(): Not processing export for feed, since manual export is enabled in feed settings.');&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Manual opt-ins have different logic.</span>&nbsp;</div></li><li><div>          $manual_opt_in = ( $manual_export && self::is_optin_ok( $entry, $feed ) );&nbsp;</div></li><li><div>          $auto_opt_in = ( !$manual_export && self::is_optin($form, $feed) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// only export if user has opted in</span>&nbsp;</div></li><li><div>          if( $auto_opt_in || $manual_opt_in ) {&nbsp;</div></li><li><div>              self::export_feed($entry, $form, $feed);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function export_feed($entry, $form, $feed) {&nbsp;</div></li><li><div>      if(empty($feed['meta']['contact_object_name'])) {&nbsp;</div></li><li><div>          self::log_error(__METHOD__ . ': There was no Object type defined in the feed (like Contact or Lead)');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug(sprintf('%s: Starting export for entry #%s to Salesforce...', __METHOD__, $entry['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $contactId = self::create($entry, $form, $feed);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($contactId)) {&nbsp;</div></li><li><div>          self::log_debug(sprintf('%1$s: %2$s created/updated. Salesforce %2$s: %3$s', &nbsp;</div></li><li><div>                                      __METHOD__, $feed['meta']['contact_object_name'], $contactId));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          self::log_debug(sprintf('%s: %s failed to be created/updated', &nbsp;</div></li><li><div>                                      __METHOD__, $feed['meta']['contact_object_name']));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $contactId;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * During export, create an export array based on the feed mappings.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array      $entry Entry array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array      $form  Form array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array      $feed  Feed array</span>&nbsp;</div></li><li><div><span class="comment">   * @return [type]             [description]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function process_merge_vars($entry, $form, $feed) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug('process_merge_vars(): Starting...');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $merge_vars = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($feed[&quot;meta&quot;][&quot;field_map&quot;] as $var_tag =&gt; $field_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $field = RGFormsModel::get_field($form, $field_id);&nbsp;</div></li><li><div>          $input_type = RGFormsModel::get_input_type($field);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($var_tag == 'address_full') {&nbsp;</div></li><li><div>              $merge_vars[$var_tag] = self::get_address($entry, $field_id);&nbsp;</div></li><li><div>          } else if($var_tag == 'country') {&nbsp;</div></li><li><div>              $merge_vars[$var_tag] = empty($entry[$field_id]) ? '' : GFCommon::get_country_code(trim($entry[$field_id]));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// If, for example an user enters 0 in a text field type expecting a number</span>&nbsp;</div></li><li><div>          else if(isset($entry[$field_id]) && $entry[$field_id] === &quot;0&quot;) {&nbsp;</div></li><li><div>              $merge_vars[$var_tag] = &quot;0&quot;;&nbsp;</div></li><li><div>          } else if($var_tag != &quot;email&quot;) {&nbsp;</div></li><li><div>              if(!empty($entry[$field_id]) && !($entry[$field_id] == &quot;0&quot;)) {&nbsp;</div></li><li><div>                  switch($input_type) {&nbsp;</div></li><li><div>                      <span class="comment">// Thanks to Scott Kingsley Clark</span>&nbsp;</div></li><li><div>                      <span class="comment">// http://wordpress.org/support/topic/likert-field-compatibility-with-survey-add-on</span>&nbsp;</div></li><li><div>                      case 'likert':&nbsp;</div></li><li><div>                          $value = $entry[$field_id];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($field['choices'] as $choice ) {&nbsp;</div></li><li><div>                              if($value === $choice['value']) {&nbsp;</div></li><li><div>                                  $value = $choice['text'];&nbsp;</div></li><li><div>                                  break;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $value = htmlspecialchars($value);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      case 'multiselect':&nbsp;</div></li><li><div>                          <span class="comment">// If there are commas in the value, this makes it so it can be comma exploded.</span>&nbsp;</div></li><li><div>                          <span class="comment">// Values cannot contain semicolons: http://boards.developerforce.com/t5/NET-Development/Salesforce-API-inserting-values-into-multiselect-fields-using/td-p/125910</span>&nbsp;</div></li><li><div>                          foreach($field['choices'] as $choice) {&nbsp;</div></li><li><div>                              $entry[$field_id] = str_replace($choice, str_replace(', ', '&#44;', $choice), $entry[$field_id]);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          <span class="comment">// Break into an array</span>&nbsp;</div></li><li><div>                          $elements = explode(&quot;, &quot;, $entry[$field_id]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// We decode first so that the commas are commas again, then</span>&nbsp;</div></li><li><div>                          <span class="comment">// implode the array to be picklist format for SF</span>&nbsp;</div></li><li><div>                          $value = implode(';', array_map('html_entity_decode', array_map('htmlspecialchars', $elements)));&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      default:&nbsp;</div></li><li><div>                          $value = htmlspecialchars($entry[$field_id]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $merge_vars[$var_tag] = GFCommon::replace_variables($value, $form, $entry, false, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else if(array_key_exists($field_id, self::$foreign_keys)) {&nbsp;</div></li><li><div>              $merge_vars[$var_tag] = self::$foreign_keys[$field_id];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// This is for checkboxes</span>&nbsp;</div></li><li><div>                  $elements = array();&nbsp;</div></li><li><div>                  foreach($entry as $key =&gt; $value) {&nbsp;</div></li><li><div>                      if(floor($key) == floor($field_id) && !empty($value)) {&nbsp;</div></li><li><div>                          $elements[] = htmlspecialchars($value);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $value = implode(';', array_map('htmlspecialchars', $elements));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $merge_vars[$var_tag] = GFCommon::replace_variables($value, $form, $entry, false, false, false );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $merge_vars[ $var_tag ] = apply_filters( 'gf_salesforce_mapped_value_' . $var_tag, $merge_vars[ $var_tag ], $field, $var_tag, $form, $entry );&nbsp;</div></li><li><div>          $merge_vars[ $var_tag ] = apply_filters( 'gf_salesforce_mapped_value', $merge_vars[ $var_tag ], $field, $var_tag, $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug('process_merge_vars(): Completed.');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $merge_vars;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function create($entry, $form, $feed) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::log_debug(__METHOD__ . ': Starting the create process...');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api = self::get_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $token = self::getToken();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// There was no token. This is all wrong.</span>&nbsp;</div></li><li><div>      if(empty($token)) {&nbsp;</div></li><li><div>          self::log_error(__METHOD__ . ': There was no OAuth token. It was likely revoked. Aborting.');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!isset($feed['is_active']) || $feed['is_active'] == 0) {&nbsp;</div></li><li><div>          self::log_error(sprintf('%s: Feed `%s` is not active.', __METHOD__, $feed['meta']['contact_object_name']));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $merge_vars = self::process_merge_vars($entry, $form, $feed);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $merge_vars = apply_filters( 'gf_salesforce_create_data', $merge_vars, $form, $entry, $feed, $api );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Make sure the charset is UTF-8 for Salesforce.</span>&nbsp;</div></li><li><div>      $merge_vars = array_map(array('GFSalesforce', '_convert_to_utf_8'), $merge_vars);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Don't send merge_vars that are empty. It can cause problems with Salesforce strict typing.  For example, </span>&nbsp;</div></li><li><div>      <span class="comment">// if the form has a text field where a number should go, but that number isn't always required, when it's</span>&nbsp;</div></li><li><div>      <span class="comment">// not supplied, we don't want to send &lt;var&gt;&lt;/var&gt; to Salesforce. It might choke because it expects a Double</span>&nbsp;</div></li><li><div>      <span class="comment">// data type, not an empty string</span>&nbsp;</div></li><li><div>      $merge_vars = array_filter($merge_vars, array('GFSalesforce', '_remove_empty_fields'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We create the object to insert/upsert into Salesforce</span>&nbsp;</div></li><li><div>      $Account = new SObject();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The fields to use are the merge vars</span>&nbsp;</div></li><li><div>      $Account-&gt;fields = $merge_vars;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the type of object</span>&nbsp;</div></li><li><div>      $Account-&gt;type = $feed['meta']['contact_object_name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $foreign_key_label = self::primary_key_id($feed);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          if( !(self::$instance instanceof GFSalesforce) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::$instance = self::Instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If the primary field has been set, use that to upsert instead of create.</span>&nbsp;</div></li><li><div>          <span class="comment">// @since 2.5.2, to avoid duplicates at Salesforce</span>&nbsp;</div></li><li><div>          if( !empty( $feed['meta']['primary_field'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_debug(sprintf('%s: Upserting using primary field of `%s`', &nbsp;</div></li><li><div>                                          __METHOD__, $feed['meta']['primary_field']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(empty(self::$instance-&gt;result-&gt;id)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// old upsert</span>&nbsp;</div></li><li><div>                  <span class="comment">// https://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_upsert.htm</span>&nbsp;</div></li><li><div>                  self::log_debug(__METHOD__ . ': Upserting');&nbsp;</div></li><li><div>                  $result = $api-&gt;upsert( $feed['meta']['primary_field'], array($Account) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  self::log_debug(sprintf('%s: Creating with previous id %s', __METHOD__, self::$instance-&gt;result-&gt;id));&nbsp;</div></li><li><div>                  $Account-&gt;fields[$feed['meta']['primary_field']] = self::$instance-&gt;result-&gt;id;&nbsp;</div></li><li><div>                  $result = $api-&gt;create( array($Account) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_debug(__METHOD__ . ': Creating, not upserting');&nbsp;</div></li><li><div>              $result = $api-&gt;create( array($Account) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $api_exception = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_debug(sprintf('%s: $Account object: %s', __METHOD__, print_r($Account, true)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_error(sprintf(&quot;%s:\n\nException While Exporting Entry\nThere was an error exporting Entry #%s for Form #%s. Here's the error:\n%s&quot;, &nbsp;</div></li><li><div>                                      __METHOD__ , $entry['id'], $form['id'], $e-&gt;getMessage()));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $api_exception = &quot;&nbsp;</div></li><li><div>              Exception Message: &quot;  . $e-&gt;getMessage() .&nbsp;</div></li><li><div>              &quot;\nFaultstring: &quot; . $e-&gt;faultstring .&nbsp;</div></li><li><div>              &quot;\nFile: &quot; . $e-&gt;getFile() .&nbsp;</div></li><li><div>              &quot;\nLine: &quot; . $e-&gt;getLine() .&nbsp;</div></li><li><div>              &quot;\nArgs: &quot; . serialize($merge_vars) .&nbsp;</div></li><li><div>              &quot;\nTrace: &quot; . serialize($e-&gt;getTrace());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          gform_update_meta( $entry['id'], 'salesforce_api_result', 'Error: ' . $e-&gt;getMessage() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($result) && count($result) == 1 && !empty($result[0])) {&nbsp;</div></li><li><div>          self::$instance-&gt;result = $result = $result[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($result-&gt;success) && !empty($result-&gt;success)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $result_id = $result-&gt;id;&nbsp;</div></li><li><div>          self::$foreign_keys[$foreign_key_label] = $result_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          gform_update_meta( $entry['id'], 'salesforce_id', $result_id );&nbsp;</div></li><li><div>          gform_update_meta( $entry['id'], 'salesforce_api_result', 'success' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $success_note = sprintf(__('Successfully added/updated to Salesforce (%s) with ID #%s. View entry at %s', 'gravity-forms-salesforce'), &nbsp;</div></li><li><div>                                      $Account-&gt;type, $result_id, self::getTokenParam('instance_url').'/'.$result_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::log_debug(__METHOD__ . ': '.$success_note);&nbsp;</div></li><li><div>          self::add_note($entry[&quot;id&quot;], $success_note);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::admin_screen_message( __( 'Entry added/updated in Salesforce.', 'gravity-forms-salesforce' ), 'updated');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.1.2</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'gravityforms_salesforce_object_added_updated', $Account, $feed, $result_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $result_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if(isset($result-&gt;errors[0])) {&nbsp;</div></li><li><div>              $errors = $result-&gt;errors[0];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($errors)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::log_error(sprintf('%s: There was an error exporting Entry #%s for Form #%s. Salesforce responded with:', &nbsp;</div></li><li><div>                                          __METHOD__, $entry['id'], $form['id']) .&quot;\n&quot;.print_r($errors, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($email = self::is_notify_on_error()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $error_heading = __('Error adding to Salesforce', 'gravity-forms-salesforce');&nbsp;</div></li><li><div>                  <span class="comment">// Create the email message to send</span>&nbsp;</div></li><li><div>                  $message = sprintf(apply_filters('gravityforms_salesforce_notify_on_error_message', '&lt;h3&gt;'.$error_heading.'&lt;/h3&gt;'.wpautop(__(&quot;There was an error when attempting to add %sEntry #%s from the form \&quot;%s\&quot;&quot;, 'gravity-forms-salesforce')), $errors, $entry, $form), '&lt;a href=&quot;'.admin_url('admin.php?page=gf_entries&view=entry&id='.$entry['form_id'].'&lid='.$entry['id']).'&quot;&gt;', $entry['id'].'&lt;/a&gt;', $form['title']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Send as HTML</span>&nbsp;</div></li><li><div>                  $headers = &quot;Content-type: text/html; charset=&quot; . get_option('blog_charset') . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Send email</span>&nbsp;</div></li><li><div>                  $sent = wp_mail($email, $error_heading, $message, $headers);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!$sent) {&nbsp;</div></li><li><div>                      self::log_error(__METHOD__ . ': There was an error sending the error email. This really isn\'t your day, is it?');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::add_note($entry[&quot;id&quot;], &nbsp;</div></li><li><div>                      sprintf(__('Errors when adding to Salesforce (%s): %s', 'gravity-forms-salesforce'), &nbsp;</div></li><li><div>                                  $Account-&gt;type, $errors-&gt;message.$api_exception));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::admin_screen_message( __( 'Errors when adding to Salesforce. Entry not sent! Check the Entry Notes below for more details.', 'gravity-forms-salesforce' ), 'error');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function _remove_empty_fields($merge_var) {&nbsp;</div></li><li><div>      return (&nbsp;</div></li><li><div>          (function_exists('mb_strlen') && mb_strlen($merge_var) &gt; 0) ||&nbsp;</div></li><li><div>          !function_exists('mb_strlen') && strlen($merge_var) &gt; 0&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function _convert_to_utf_8($string) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(function_exists('mb_convert_encoding') && !seems_utf8($string)) {&nbsp;</div></li><li><div>          $string = mb_convert_encoding($string, &quot;UTF-8&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Salesforce can't handle newlines in SOAP; we encode them instead.</span>&nbsp;</div></li><li><div>      $string = str_replace(&quot;\n&quot;, '&#x0a;', $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;\r&quot;, '&#x0d;', $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;\t&quot;, '&#09;', $string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove control characters (like page break, etc.)</span>&nbsp;</div></li><li><div>      $string = preg_replace('/[[:cntrl:]]+/', '', $string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Escape XML characters like `&lt; ' &quot; & &gt;`</span>&nbsp;</div></li><li><div>      $string = esc_attr($string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Print a link to the Salesforce entry ID in the Entry actions box</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $form_id ID of the form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $lead    GF Entry array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function entry_info_link_to_salesforce($form_id, $lead) {&nbsp;</div></li><li><div>      $salesforce_id = gform_get_meta($lead['id'], 'salesforce_id');&nbsp;</div></li><li><div>      if(!empty($salesforce_id)) {&nbsp;</div></li><li><div>          echo sprintf(__('Salesforce ID: %s', 'gravity-forms-salesforce'), '&lt;a href=&quot;'.self::getTokenParam('instance_url').'/'.$salesforce_id.'&quot;&gt;'.$salesforce_id.'&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether to show the Entry &quot;Send to Salesforce&quot; button or not</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If the entry's form has been mapped to Salesforce feed, show the Send to Salesforce button. Otherwise, don't.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True: Show the button; False: don't show the button.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function show_send_to_salesforce_button() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_id = rgget('id');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::has_feed($form_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Does the current form have a feed assigned to it?</span>&nbsp;</div></li><li><div><span class="comment">   * @param  INT      $form_id Form ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function has_feed($form_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $feeds = GFSalesforceData::get_feed_by_form( $form_id , true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return !empty($feeds);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add button to entry info - option to send entry to Salesforce</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.1</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $form_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $lead</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function entry_info_send_to_salesforce_button( $button = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this entry's form isn't connected to salesforce, don't show the button</span>&nbsp;</div></li><li><div>      if(!self::show_send_to_salesforce_button() || !apply_filters( 'gf_salesforce_show_manual_export_button', true ) ) { return $button; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is this the view or the edit screen?</span>&nbsp;</div></li><li><div>      $mode = empty($_POST[&quot;screen_mode&quot;]) ? &quot;view&quot; : $_POST[&quot;screen_mode&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($mode === 'view') {&nbsp;</div></li><li><div>          $button_html = '&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;send_to_salesforce&quot; id=&quot;send_to_salesforce&quot; value=&quot;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;submit&quot; class=&quot;button button-large button-secondary alignright&quot; style=&quot;margin-left:5px;&quot; value=&quot;%s&quot; title=&quot;%s&quot; onclick=&quot;jQuery(\'#send_to_salesforce\').val(\'1\'); jQuery(\'#action\').val(\'send_to_salesforce\')&quot; /&gt;&nbsp;</div></li><li><div>          ';&nbsp;</div></li><li><div>          $button .= sprintf( $button_html, esc_html__('Send to Salesforce', 'gravity-forms-salesforce'), esc_html__('Create or update this entry in Salesforce. The fields will be mapped according to the form feed settings.', 'gravity-forms-salesforce'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $button;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add checkbox to entry info - option to send entry to salesforce</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.1</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $form_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $lead</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function entry_info_send_to_salesforce_checkbox( $form_id, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this entry's form isn't connected to salesforce, don't show the checkbox</span>&nbsp;</div></li><li><div>      if(!self::show_send_to_salesforce_button() ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this is not the Edit screen, get outta here.</span>&nbsp;</div></li><li><div>      if(empty($_POST[&quot;screen_mode&quot;]) || $_POST[&quot;screen_mode&quot;] === 'view') { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( apply_filters( 'gf_salesforce_show_manual_export_button', true ) ) {&nbsp;</div></li><li><div>          printf('&lt;input type=&quot;checkbox&quot; name=&quot;update_to_salesforce&quot; id=&quot;update_to_salesforce&quot; value=&quot;1&quot; /&gt;&lt;label for=&quot;update_to_salesforce&quot; title=&quot;%s&quot;&gt;%s&lt;/label&gt;&lt;br /&gt;&lt;br /&gt;', esc_html__('Create or update this entry in Salesforce. The fields will be mapped according to the form feed settings.', 'gravity-forms-salesforce'), esc_html__('Send to Salesforce', 'gravity-forms-salesforce'));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          echo '&lt;input type=&quot;hidden&quot; name=&quot;update_to_salesforce&quot; id=&quot;update_to_salesforce&quot; value=&quot;1&quot; /&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * admin_screen_message function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.1</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $message</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $level</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function admin_screen_message( $message, $level = 'updated') {&nbsp;</div></li><li><div>      if( is_admin() ) {&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;'. esc_attr( $level ) .' fade&quot; style=&quot;padding:6px;&quot;&gt;';&nbsp;</div></li><li><div>          echo esc_html( $message );&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function add_note($id, $note) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!apply_filters('gravityforms_salesforce_add_notes_to_entries', true)) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      RGFormsModel::add_note($id, 0, __('Gravity Forms Salesforce Add-on'), $note);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove the plugin settings on uninstall.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function uninstall() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!GFSalesforce::has_access(&quot;gravityforms_salesforce_uninstall&quot;))&nbsp;</div></li><li><div>          exit(__(&quot;You don't have adequate permission to uninstall Salesforce Add-On.&quot;, &quot;gravity-forms-salesforce&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//droping all tables</span>&nbsp;</div></li><li><div>      GFSalesforceData::drop_tables();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//removing options</span>&nbsp;</div></li><li><div>      delete_option(&quot;gf_salesforce_settings&quot;);&nbsp;</div></li><li><div>      delete_option(&quot;gf_salesforce_version&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Deactivating plugin</span>&nbsp;</div></li><li><div>      $plugin = &quot;gravity-forms-salesforce/salesforce.php&quot;;&nbsp;</div></li><li><div>      deactivate_plugins($plugin);&nbsp;</div></li><li><div>      update_option('recently_activated', array($plugin =&gt; time()) + (array)get_option('recently_activated'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Opt-in logic: returns true if entry is OK to be exported</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_optin($form, $settings) {&nbsp;</div></li><li><div>      $config = $settings[&quot;meta&quot;];&nbsp;</div></li><li><div>      $operator = $config[&quot;optin_operator&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field = RGFormsModel::get_field($form, $config[&quot;optin_field_id&quot;]);&nbsp;</div></li><li><div>      $field_value = RGFormsModel::get_field_value($field, array());&nbsp;</div></li><li><div>      $is_value_match = is_array($field_value) ? in_array($config[&quot;optin_value&quot;], $field_value) : $field_value == $config[&quot;optin_value&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return  !$config[&quot;optin_enabled&quot;] || empty($field) || ($operator == &quot;is&quot; && $is_value_match) || ($operator == &quot;isnot&quot; && !$is_value_match);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alternative is_optin function to use when entry is manually updated, </span>&nbsp;</div></li><li><div><span class="comment">   * returns true if entry is OK to be exported</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $settings</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_optin_ok( $entry, $settings ) {&nbsp;</div></li><li><div>      if( empty( $settings['meta']['optin_enabled'] ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $operator = $settings['meta']['optin_operator'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $entry as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if( floor( $key ) == $settings['meta']['optin_field_id'] ) {&nbsp;</div></li><li><div>              $field_value[] = empty( $value ) ? '' : $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_value_match = is_array( $field_value ) ? in_array( $settings['meta']['optin_value'], $field_value) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ( $operator == &quot;is&quot; && $is_value_match ) || ( $operator == &quot;isnot&quot; && !$is_value_match );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function is_gravityforms_supported() {&nbsp;</div></li><li><div>      if(class_exists(&quot;GFCommon&quot;)) {&nbsp;</div></li><li><div>          $is_correct_version = version_compare(GFCommon::$version, self::$min_gravityforms_version, &quot;&gt;=&quot;);&nbsp;</div></li><li><div>          return $is_correct_version;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else{&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static function has_access($required_permission) {&nbsp;</div></li><li><div>      $has_members_plugin = function_exists('members_get_capabilities');&nbsp;</div></li><li><div>      $has_access = $has_members_plugin ? current_user_can($required_permission) : current_user_can(&quot;level_7&quot;);&nbsp;</div></li><li><div>      if($has_access)&nbsp;</div></li><li><div>          return $has_members_plugin ? $required_permission : &quot;level_7&quot;;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns the url of the plugin's root folder</span>&nbsp;</div></li><li><div>  static public function get_base_url() {&nbsp;</div></li><li><div>      return plugins_url(null, KWS_GF_Salesforce::$file);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns the physical path of the plugin's root folder</span>&nbsp;</div></li><li><div>  static protected function get_base_path() {&nbsp;</div></li><li><div>      return plugin_dir_path(KWS_GF_Salesforce::$file);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Export Entries</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add meta fields to entries export screen</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $form object</span>&nbsp;</div></li><li><div><span class="comment">   * @return object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function export_entries_add_fields( $form ) {&nbsp;</div></li><li><div>      $form['fields'][] = array('id' =&gt; 'salesforce_id' , 'label' =&gt; __( 'Salesforce ID', 'gravity-forms-salesforce' ) );&nbsp;</div></li><li><div>      $form['fields'][] = array('id' =&gt; 'salesforce_api_result' , 'label' =&gt; __( 'Salesforce API result', 'gravity-forms-salesforce' ) );&nbsp;</div></li><li><div>      return $form;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Populate meta field values when exporting entries</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $value    Value of the field being exported</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $form_id     ID of the current form.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $field_id    ID of the current field.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  object $lead     The current entry.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function export_entries_add_values( $value, $form_id, $field_id, $lead ) {&nbsp;</div></li><li><div>      switch( $field_id ) {&nbsp;</div></li><li><div>          case 'salesforce_id':&nbsp;</div></li><li><div>              $value = gform_get_meta( $lead['id'], 'salesforce_id' );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'salesforce_api_result':&nbsp;</div></li><li><div>              $value = gform_get_meta( $lead['id'], 'salesforce_api_result' );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create primary key id</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.1</span>&nbsp;</div></li><li><div><span class="comment">   * @param Feed</span>&nbsp;</div></li><li><div><span class="comment">   * @return String</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function primary_key_id($feed)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $id = strtolower(self::primary_key_label($feed));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return preg_replace('/\W+/', '_', $id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create primary key label</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.1</span>&nbsp;</div></li><li><div><span class="comment">   * @param Feed</span>&nbsp;</div></li><li><div><span class="comment">   * @return String</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function primary_key_label($feed)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($feed['meta']['contact_object_name'])) {&nbsp;</div></li><li><div>          $label = sprintf( _x('%s (Primary Key)', 'Label for the Primary Key selector in the Edit Feed form', 'gravity-forms-salesforce'), $feed['meta']['contact_object_name']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $label;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Try and sort array based on column name</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.1</span>&nbsp;</div></li><li><div><span class="comment">   * @param Array</span>&nbsp;</div></li><li><div><span class="comment">   * @return Void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function sorter(&$array, $column = null)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!is_array($column)) {&nbsp;</div></li><li><div>          $props = array($column =&gt; true);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $props = $column;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      usort($array, function($a, $b) use ($props) {&nbsp;</div></li><li><div>          foreach($props as $prop =&gt; $ascending)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              if($a[$prop] != $b[$prop])&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if($ascending)&nbsp;</div></li><li><div>                      return $a[$prop] &gt; $b[$prop] ? 1 : -1;&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      return $b[$prop] &gt; $a[$prop] ? 1 : -1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return -1; <span class="comment">//if all props equal</span>&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>new GFSalesforce;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Gravity Forms Salesforce Add-On</li><li><span></span>3.1.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>