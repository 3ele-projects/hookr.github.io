<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.3" data-slug="woocommerce-products-designer" data-type="class" data-id="20888"><head xmlns="http://www.w3.org/1999/xhtml"><title> qrcode | class | Woocommerce Products Designer | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="QRcode, class, plugin, woocommerce-products-designer, 2.3" /><meta name="description" content="The Woocommerce Products Designer QRcode class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=593ebfbdc02d8aa87e9be5052665916e' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/qrcode/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fqrcode%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fqrcode%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-products-designer-2.3-class-qrcode","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="qrcode" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-products-designer." href="http://hookr.io/plugins/woocommerce-products-designer/" class="plugin"><span property="name">woocommerce-products-designer</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.3." href="http://hookr.io/plugins/woocommerce-products-designer/2.3/" class="H_VERSION"><span property="name">2.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce-products-designer/2.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">qrcode</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="208"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/all/" title="All">All <span class="count badge">208</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="8"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/hooks/" title="Hooks">Hooks <span class="count badge">8</span></a></li><li class="" data-id="action" data-count="8"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/actions/" title="Actions">Actions <span class="count badge">8</span></a></li><li class="" data-id="filter" data-count="0"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/filters/" title="Filters">Filters <span class="count badge">0</span></a></li><li class="active" data-id="class" data-count="52"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/classes/" title="Classes">Classes <span class="count badge">52</span></a></li><li class="" data-id="constant" data-count="120"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/constants/" title="Constants">Constants <span class="count badge">120</span></a></li><li class="" data-id="function" data-count="22"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/functions/" title="Functions">Functions <span class="count badge">22</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>QRcode</strong></h1><p>The Woocommerce Products Designer <strong>QRcode</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(2)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/files/includes-tcpdf-include-barcodes-qrcode/" class="file">/includes/tcpdf/include/barcodes/qrcode.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="51" class="block" start="291"><li><div>/* @class QRcode&nbsp;</div></li><li><div> * Class to create QR-code arrays for TCPDF class.&nbsp;</div></li><li><div> * QR Code symbol is a 2D barcode that can be scanned by handy terminals such as a mobile phone with CCD.&nbsp;</div></li><li><div> * The capacity of QR Code is up to 7000 digits or 4000 characters, and has high robustness.&nbsp;</div></li><li><div> * This class supports QR Code model 2, described in JIS (Japanese Industrial Standards) X0510:2004 or ISO/IEC 18004.&nbsp;</div></li><li><div> * Currently the following features are not supported: ECI and FNC1 mode, Micro QR Code, QR Code model 1, Structured mode.&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> * This class is derived from &quot;PHP QR Code encoder&quot; by Dominik Dzienia (http://phpqrcode.sourceforge.net/) based on &quot;libqrencode C library 3.1.1.&quot; by Kentaro Fukuchi (http://megaui.net/fukuchi/works/qrencode/index.en.html), contains Reed-Solomon code written by Phil Karn, KA9Q. QR Code is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/index-e.html).&nbsp;</div></li><li><div> * Please read comments on this class source file for full copyright and license information.&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> * @package com.tecnick.tcpdf&nbsp;</div></li><li><div> * @author Nicola Asuni&nbsp;</div></li><li><div> * @version 3.010&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>class QRcode {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Barcode array to be returned which is readable by TCPDF.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $barcode_array = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * QR code version. Size of QRcode is defined as version. Version is from 1 to 40. Version 1 is 21*21 matrix. And 4 modules increases whenever 1 version increases. So version 40 is 177*177 matrix.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $version = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Levels of error correction. See definitions for possible values.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encoding mode.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $hint = QR_MODE_8B;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Boolean flag, if true the input string will be converted to uppercase.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $casesensitive = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Structured QR code (not supported yet).&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $structured = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Mask data.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// FrameFiller&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Width.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Frame.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $frame;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * X position of bit.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $x;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Y position of bit.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Direction.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Single bit value.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $bit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRrawcode ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Data code.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $datacode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Error correction code.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $ecccode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Blocks.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $blocks;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Reed-Solomon blocks.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $rsblocks = array(); //of RSblock&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Counter.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Data length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dataLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Error correction length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $eccLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Value b1.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $b1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRmask ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Run length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $runLength = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRsplit ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Input data string.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dataStr = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Input items.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// Reed-Solomon items&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Reed-Solomon items.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $rsitems = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array of frames.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $frames = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Alphabet-numeric convesion table.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $anTable = array(&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    36, -1, -1, -1, 37, 38, -1, -1, -1, -1, 39, 40, -1, 41, 42, 43, //&nbsp;</div></li><li><div>     0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 44, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, //&nbsp;</div></li><li><div>    25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1  //&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Table of the capacity of symbols.&nbsp;</div></li><li><div> * See Table 1 (pp.13) and Table 12-16 (pp.30-36), JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $capacity = array(&nbsp;</div></li><li><div>    array(  0, 0, 0, array(   0, 0, 0, 0)), //&nbsp;</div></li><li><div>    array( 21, 26, 0, array(   7, 10, 13, 17)), //  1&nbsp;</div></li><li><div>    array( 25, 44, 7, array(  10, 16, 22, 28)), //&nbsp;</div></li><li><div>    array( 29, 70, 7, array(  15, 26, 36, 44)), //&nbsp;</div></li><li><div>    array( 33, 100, 7, array(  20, 36, 52, 64)), //&nbsp;</div></li><li><div>    array( 37, 134, 7, array(  26, 48, 72, 88)), //  5&nbsp;</div></li><li><div>    array( 41, 172, 7, array(  36, 64, 96, 112)), //&nbsp;</div></li><li><div>    array( 45, 196, 0, array(  40, 72, 108, 130)), //&nbsp;</div></li><li><div>    array( 49, 242, 0, array(  48, 88, 132, 156)), //&nbsp;</div></li><li><div>    array( 53, 292, 0, array(  60, 110, 160, 192)), //&nbsp;</div></li><li><div>    array( 57, 346, 0, array(  72, 130, 192, 224)), // 10&nbsp;</div></li><li><div>    array( 61, 404, 0, array(  80, 150, 224, 264)), //&nbsp;</div></li><li><div>    array( 65, 466, 0, array(  96, 176, 260, 308)), //&nbsp;</div></li><li><div>    array( 69, 532, 0, array( 104, 198, 288, 352)), //&nbsp;</div></li><li><div>    array( 73, 581, 3, array( 120, 216, 320, 384)), //&nbsp;</div></li><li><div>    array( 77, 655, 3, array( 132, 240, 360, 432)), // 15&nbsp;</div></li><li><div>    array( 81, 733, 3, array( 144, 280, 408, 480)), //&nbsp;</div></li><li><div>    array( 85, 815, 3, array( 168, 308, 448, 532)), //&nbsp;</div></li><li><div>    array( 89, 901, 3, array( 180, 338, 504, 588)), //&nbsp;</div></li><li><div>    array( 93, 991, 3, array( 196, 364, 546, 650)), //&nbsp;</div></li><li><div>    array( 97, 1085, 3, array( 224, 416, 600, 700)), // 20&nbsp;</div></li><li><div>    array(101, 1156, 4, array( 224, 442, 644, 750)), //&nbsp;</div></li><li><div>    array(105, 1258, 4, array( 252, 476, 690, 816)), //&nbsp;</div></li><li><div>    array(109, 1364, 4, array( 270, 504, 750, 900)), //&nbsp;</div></li><li><div>    array(113, 1474, 4, array( 300, 560, 810, 960)), //&nbsp;</div></li><li><div>    array(117, 1588, 4, array( 312, 588, 870, 1050)), // 25&nbsp;</div></li><li><div>    array(121, 1706, 4, array( 336, 644, 952, 1110)), //&nbsp;</div></li><li><div>    array(125, 1828, 4, array( 360, 700, 1020, 1200)), //&nbsp;</div></li><li><div>    array(129, 1921, 3, array( 390, 728, 1050, 1260)), //&nbsp;</div></li><li><div>    array(133, 2051, 3, array( 420, 784, 1140, 1350)), //&nbsp;</div></li><li><div>    array(137, 2185, 3, array( 450, 812, 1200, 1440)), // 30&nbsp;</div></li><li><div>    array(141, 2323, 3, array( 480, 868, 1290, 1530)), //&nbsp;</div></li><li><div>    array(145, 2465, 3, array( 510, 924, 1350, 1620)), //&nbsp;</div></li><li><div>    array(149, 2611, 3, array( 540, 980, 1440, 1710)), //&nbsp;</div></li><li><div>    array(153, 2761, 3, array( 570, 1036, 1530, 1800)), //&nbsp;</div></li><li><div>    array(157, 2876, 0, array( 570, 1064, 1590, 1890)), // 35&nbsp;</div></li><li><div>    array(161, 3034, 0, array( 600, 1120, 1680, 1980)), //&nbsp;</div></li><li><div>    array(165, 3196, 0, array( 630, 1204, 1770, 2100)), //&nbsp;</div></li><li><div>    array(169, 3362, 0, array( 660, 1260, 1860, 2220)), //&nbsp;</div></li><li><div>    array(173, 3532, 0, array( 720, 1316, 1950, 2310)), //&nbsp;</div></li><li><div>    array(177, 3706, 0, array( 750, 1372, 2040, 2430))  // 40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Length indicator.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $lengthTableBits = array(&nbsp;</div></li><li><div>    array(10, 12, 14), &nbsp;</div></li><li><div>    array( 9, 11, 13), &nbsp;</div></li><li><div>    array( 8, 16, 16), &nbsp;</div></li><li><div>    array( 8, 10, 12)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Table of the error correction code (Reed-Solomon block).&nbsp;</div></li><li><div> * See Table 12-16 (pp.30-36), JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $eccTable = array(&nbsp;</div></li><li><div>    array(array( 0, 0), array( 0, 0), array( 0, 0), array( 0, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), //  1&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 2, 0), array( 2, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 2, 0), array( 2, 0), array( 4, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 2, 0), array( 2, 2), array( 2, 2)), //  5&nbsp;</div></li><li><div>    array(array( 2, 0), array( 4, 0), array( 4, 0), array( 4, 0)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 4, 0), array( 2, 4), array( 4, 1)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 2, 2), array( 4, 2), array( 4, 2)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 3, 2), array( 4, 4), array( 4, 4)), //&nbsp;</div></li><li><div>    array(array( 2, 2), array( 4, 1), array( 6, 2), array( 6, 2)), // 10&nbsp;</div></li><li><div>    array(array( 4, 0), array( 1, 4), array( 4, 4), array( 3, 8)), //&nbsp;</div></li><li><div>    array(array( 2, 2), array( 6, 2), array( 4, 6), array( 7, 4)), //&nbsp;</div></li><li><div>    array(array( 4, 0), array( 8, 1), array( 8, 4), array(12, 4)), //&nbsp;</div></li><li><div>    array(array( 3, 1), array( 4, 5), array(11, 5), array(11, 5)), //&nbsp;</div></li><li><div>    array(array( 5, 1), array( 5, 5), array( 5, 7), array(11, 7)), // 15&nbsp;</div></li><li><div>    array(array( 5, 1), array( 7, 3), array(15, 2), array( 3, 13)), //&nbsp;</div></li><li><div>    array(array( 1, 5), array(10, 1), array( 1, 15), array( 2, 17)), //&nbsp;</div></li><li><div>    array(array( 5, 1), array( 9, 4), array(17, 1), array( 2, 19)), //&nbsp;</div></li><li><div>    array(array( 3, 4), array( 3, 11), array(17, 4), array( 9, 16)), //&nbsp;</div></li><li><div>    array(array( 3, 5), array( 3, 13), array(15, 5), array(15, 10)), // 20&nbsp;</div></li><li><div>    array(array( 4, 4), array(17, 0), array(17, 6), array(19, 6)), //&nbsp;</div></li><li><div>    array(array( 2, 7), array(17, 0), array( 7, 16), array(34, 0)), //&nbsp;</div></li><li><div>    array(array( 4, 5), array( 4, 14), array(11, 14), array(16, 14)), //&nbsp;</div></li><li><div>    array(array( 6, 4), array( 6, 14), array(11, 16), array(30, 2)), //&nbsp;</div></li><li><div>    array(array( 8, 4), array( 8, 13), array( 7, 22), array(22, 13)), // 25&nbsp;</div></li><li><div>    array(array(10, 2), array(19, 4), array(28, 6), array(33, 4)), //&nbsp;</div></li><li><div>    array(array( 8, 4), array(22, 3), array( 8, 26), array(12, 28)), //&nbsp;</div></li><li><div>    array(array( 3, 10), array( 3, 23), array( 4, 31), array(11, 31)), //&nbsp;</div></li><li><div>    array(array( 7, 7), array(21, 7), array( 1, 37), array(19, 26)), //&nbsp;</div></li><li><div>    array(array( 5, 10), array(19, 10), array(15, 25), array(23, 25)), // 30&nbsp;</div></li><li><div>    array(array(13, 3), array( 2, 29), array(42, 1), array(23, 28)), //&nbsp;</div></li><li><div>    array(array(17, 0), array(10, 23), array(10, 35), array(19, 35)), //&nbsp;</div></li><li><div>    array(array(17, 1), array(14, 21), array(29, 19), array(11, 46)), //&nbsp;</div></li><li><div>    array(array(13, 6), array(14, 23), array(44, 7), array(59, 1)), //&nbsp;</div></li><li><div>    array(array(12, 7), array(12, 26), array(39, 14), array(22, 41)), // 35&nbsp;</div></li><li><div>    array(array( 6, 14), array( 6, 34), array(46, 10), array( 2, 64)), //&nbsp;</div></li><li><div>    array(array(17, 4), array(29, 14), array(49, 10), array(24, 46)), //&nbsp;</div></li><li><div>    array(array( 4, 18), array(13, 32), array(48, 14), array(42, 32)), //&nbsp;</div></li><li><div>    array(array(20, 4), array(40, 7), array(43, 22), array(10, 67)), //&nbsp;</div></li><li><div>    array(array(19, 6), array(18, 31), array(34, 34), array(20, 61))  // 40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Positions of alignment patterns.&nbsp;</div></li><li><div> * This array includes only the second and the third position of the alignment patterns. Rest of them can be calculated from the distance between them.&nbsp;</div></li><li><div> * See Table 1 in Appendix E (pp.71) of JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $alignmentPattern = array(&nbsp;</div></li><li><div>    array( 0, 0), &nbsp;</div></li><li><div>    array( 0, 0), array(18, 0), array(22, 0), array(26, 0), array(30, 0), //  1- 5&nbsp;</div></li><li><div>    array(34, 0), array(22, 38), array(24, 42), array(26, 46), array(28, 50), //  6-10&nbsp;</div></li><li><div>    array(30, 54), array(32, 58), array(34, 62), array(26, 46), array(26, 48), // 11-15&nbsp;</div></li><li><div>    array(26, 50), array(30, 54), array(30, 56), array(30, 58), array(34, 62), // 16-20&nbsp;</div></li><li><div>    array(28, 50), array(26, 50), array(30, 54), array(28, 54), array(32, 58), // 21-25&nbsp;</div></li><li><div>    array(30, 58), array(34, 62), array(26, 50), array(30, 54), array(26, 52), // 26-30&nbsp;</div></li><li><div>    array(30, 56), array(34, 60), array(30, 58), array(34, 62), array(30, 54), // 31-35&nbsp;</div></li><li><div>    array(24, 50), array(28, 54), array(32, 58), array(26, 54), array(30, 58)  // 35-40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Version information pattern (BCH coded).&nbsp;</div></li><li><div> * See Table 1 in Appendix D (pp.68) of JIS X0510:2004.&nbsp;</div></li><li><div> * size: [QRSPEC_VERSION_MAX - 6]&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $versionPattern = array(&nbsp;</div></li><li><div>    0x07c94, 0x085bc, 0x09a99, 0x0a4d3, 0x0bbf6, 0x0c762, 0x0d847, 0x0e60d, //&nbsp;</div></li><li><div>    0x0f928, 0x10b78, 0x1145d, 0x12a17, 0x13532, 0x149a6, 0x15683, 0x168c9, //&nbsp;</div></li><li><div>    0x177ec, 0x18ec4, 0x191e1, 0x1afab, 0x1b08e, 0x1cc1a, 0x1d33f, 0x1ed75, //&nbsp;</div></li><li><div>    0x1f250, 0x209d5, 0x216f0, 0x228ba, 0x2379f, 0x24b0b, 0x2542e, 0x26a64, //&nbsp;</div></li><li><div>    0x27541, 0x28c69&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Format information&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $formatInfo = array(&nbsp;</div></li><li><div>    array(0x77c4, 0x72f3, 0x7daa, 0x789d, 0x662f, 0x6318, 0x6c41, 0x6976), //&nbsp;</div></li><li><div>    array(0x5412, 0x5125, 0x5e7c, 0x5b4b, 0x45f9, 0x40ce, 0x4f97, 0x4aa0), //&nbsp;</div></li><li><div>    array(0x355f, 0x3068, 0x3f31, 0x3a06, 0x24b4, 0x2183, 0x2eda, 0x2bed), //&nbsp;</div></li><li><div>    array(0x1689, 0x13be, 0x1ce7, 0x19d0, 0x0762, 0x0255, 0x0d0c, 0x083b)  //&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// -------------------------------------------------&nbsp;</div></li><li><div>// -------------------------------------------------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * This is the class constructor.&nbsp;</div></li><li><div> * Creates a QRcode object&nbsp;</div></li><li><div> * @param $code (string) code to represent using QRcode&nbsp;</div></li><li><div> * @param $eclevel (string) error level: &lt;ul&gt;&lt;li&gt;L : About 7% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;M : About 15% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;Q : About 25% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;H : About 30% or less errors can be corrected.&lt;/li&gt;&lt;/ul&gt;&nbsp;</div></li><li><div> * @public&nbsp;</div></li><li><div> * @since 3.000&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>public function __construct($code, $eclevel = 'L') {&nbsp;</div></li><li><div>    $barcode_array = array();&nbsp;</div></li><li><div>    if ((is_null($code)) OR ($code == '\0') OR ($code == '')) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // set error correction level&nbsp;</div></li><li><div>    $this-&gt;level = array_search($eclevel, array('L', 'M', 'Q', 'H'));&nbsp;</div></li><li><div>    if ($this-&gt;level === false) {&nbsp;</div></li><li><div>        $this-&gt;level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($this-&gt;hint != QR_MODE_8B) AND ($this-&gt;hint != QR_MODE_KJ)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($this-&gt;version &lt; 0) OR ($this-&gt;version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = array();&nbsp;</div></li><li><div>    $this-&gt;encodeString($code);&nbsp;</div></li><li><div>    if (is_null($this-&gt;data)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $qrTab = $this-&gt;binarize($this-&gt;data);&nbsp;</div></li><li><div>    $size = count($qrTab);&nbsp;</div></li><li><div>    $barcode_array['num_rows'] = $size;&nbsp;</div></li><li><div>    $barcode_array['num_cols'] = $size;&nbsp;</div></li><li><div>    $barcode_array['bcode'] = array();&nbsp;</div></li><li><div>    foreach ($qrTab as $line) {&nbsp;</div></li><li><div>        $arrAdd = array();&nbsp;</div></li><li><div>        foreach (str_split($line) as $char) {&nbsp;</div></li><li><div>            $arrAdd[] = ($char=='1')?1:0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $barcode_array['bcode'][] = $arrAdd;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;barcode_array = $barcode_array;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Returns a barcode array which is readable by TCPDF&nbsp;</div></li><li><div> * @return array barcode array readable by TCPDF;&nbsp;</div></li><li><div> * @public&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>public function getBarcodeArray() {&nbsp;</div></li><li><div>    return $this-&gt;barcode_array;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Convert the frame in binary form&nbsp;</div></li><li><div> * @param $frame (array) array to binarize&nbsp;</div></li><li><div> * @return array frame in binary form&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function binarize($frame) {&nbsp;</div></li><li><div>    $len = count($frame);&nbsp;</div></li><li><div>    // the frame is square (width = height)&nbsp;</div></li><li><div>    foreach ($frame as &$frameLine) {&nbsp;</div></li><li><div>        for ($i=0; $i&lt;$len; $i++) {&nbsp;</div></li><li><div>            $frameLine[$i] = (ord($frameLine[$i])&1)?'1':'0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode the input string to QR code&nbsp;</div></li><li><div> * @param $string (string) input string to encode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function encodeString($string) {&nbsp;</div></li><li><div>    $this-&gt;dataStr = $string;&nbsp;</div></li><li><div>    if (!$this-&gt;casesensitive) {&nbsp;</div></li><li><div>        $this-&gt;toUpper();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $ret = $this-&gt;splitString();&nbsp;</div></li><li><div>    if ($ret &lt; 0) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;encodeMask(-1);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode mask&nbsp;</div></li><li><div> * @param $mask (int) masking mode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function encodeMask($mask) {&nbsp;</div></li><li><div>    $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>    $this-&gt;datacode = $this-&gt;getByteStream($this-&gt;items);&nbsp;</div></li><li><div>    if (is_null($this-&gt;datacode)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $spec = $this-&gt;getEccSpec($this-&gt;version, $this-&gt;level, $spec);&nbsp;</div></li><li><div>    $this-&gt;b1 = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>    $this-&gt;dataLength = $this-&gt;rsDataLength($spec);&nbsp;</div></li><li><div>    $this-&gt;eccLength = $this-&gt;rsEccLength($spec);&nbsp;</div></li><li><div>    $this-&gt;ecccode = array_fill(0, $this-&gt;eccLength, 0);&nbsp;</div></li><li><div>    $this-&gt;blocks = $this-&gt;rsBlockNum($spec);&nbsp;</div></li><li><div>    $ret = $this-&gt;init($spec);&nbsp;</div></li><li><div>    if ($ret &lt; 0) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;count = 0;&nbsp;</div></li><li><div>    $this-&gt;width = $this-&gt;getWidth($this-&gt;version);&nbsp;</div></li><li><div>    $this-&gt;frame = $this-&gt;newFrame($this-&gt;version);&nbsp;</div></li><li><div>    $this-&gt;x = $this-&gt;width - 1;&nbsp;</div></li><li><div>    $this-&gt;y = $this-&gt;width - 1;&nbsp;</div></li><li><div>    $this-&gt;dir = -1;&nbsp;</div></li><li><div>    $this-&gt;bit = -1;&nbsp;</div></li><li><div>    // inteleaved data and ecc codes&nbsp;</div></li><li><div>    for ($i=0; $i &lt; ($this-&gt;dataLength + $this-&gt;eccLength); $i++) {&nbsp;</div></li><li><div>        $code = $this-&gt;getCode();&nbsp;</div></li><li><div>        $bit = 0x80;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>            $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>            $this-&gt;setFrameAt($addr, 0x02 | (($bit & $code) != 0));&nbsp;</div></li><li><div>            $bit = $bit &gt;&gt; 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // remainder bits&nbsp;</div></li><li><div>    $j = $this-&gt;getRemainder($this-&gt;version);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$j; $i++) {&nbsp;</div></li><li><div>        $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>        $this-&gt;setFrameAt($addr, 0x02);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // masking&nbsp;</div></li><li><div>    $this-&gt;runLength = array_fill(0, QRSPEC_WIDTH_MAX + 1, 0);&nbsp;</div></li><li><div>    if ($mask &lt; 0) {&nbsp;</div></li><li><div>        if (QR_FIND_BEST_MASK) {&nbsp;</div></li><li><div>            $masked = $this-&gt;mask($this-&gt;width, $this-&gt;frame, $this-&gt;level);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, (intval(QR_DEFAULT_MASK) % 8), $this-&gt;level);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, $mask, $this-&gt;level);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($masked == NULL) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;data = $masked;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// FrameFiller&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Set frame value at specified position&nbsp;</div></li><li><div> * @param $at (array) x, y position&nbsp;</div></li><li><div> * @param $val (int) value of the character to set&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function setFrameAt($at, $val) {&nbsp;</div></li><li><div>    $this-&gt;frame[$at['y']][$at['x']] = chr($val);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Get frame value at specified position&nbsp;</div></li><li><div> * @param $at (array) x, y position&nbsp;</div></li><li><div> * @return value at specified position&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getFrameAt($at) {&nbsp;</div></li><li><div>    return ord($this-&gt;frame[$at['y']][$at['x']]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the next frame position&nbsp;</div></li><li><div> * @return array of x, y coordinates&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getNextPosition() {&nbsp;</div></li><li><div>    do {&nbsp;</div></li><li><div>        if ($this-&gt;bit == -1) {&nbsp;</div></li><li><div>            $this-&gt;bit = 0;&nbsp;</div></li><li><div>            return array('x'=&gt;$this-&gt;x, 'y'=&gt;$this-&gt;y);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $x = $this-&gt;x;&nbsp;</div></li><li><div>        $y = $this-&gt;y;&nbsp;</div></li><li><div>        $w = $this-&gt;width;&nbsp;</div></li><li><div>        if ($this-&gt;bit == 0) {&nbsp;</div></li><li><div>            $x--;&nbsp;</div></li><li><div>            $this-&gt;bit++;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $x++;&nbsp;</div></li><li><div>            $y += $this-&gt;dir;&nbsp;</div></li><li><div>            $this-&gt;bit--;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($this-&gt;dir &lt; 0) {&nbsp;</div></li><li><div>            if ($y &lt; 0) {&nbsp;</div></li><li><div>                $y = 0;&nbsp;</div></li><li><div>                $x -= 2;&nbsp;</div></li><li><div>                $this-&gt;dir = 1;&nbsp;</div></li><li><div>                if ($x == 6) {&nbsp;</div></li><li><div>                    $x--;&nbsp;</div></li><li><div>                    $y = 9;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ($y == $w) {&nbsp;</div></li><li><div>                $y = $w - 1;&nbsp;</div></li><li><div>                $x -= 2;&nbsp;</div></li><li><div>                $this-&gt;dir = -1;&nbsp;</div></li><li><div>                if ($x == 6) {&nbsp;</div></li><li><div>                    $x--;&nbsp;</div></li><li><div>                    $y -= 8;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (($x &lt; 0) OR ($y &lt; 0)) {&nbsp;</div></li><li><div>            return NULL;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;x = $x;&nbsp;</div></li><li><div>        $this-&gt;y = $y;&nbsp;</div></li><li><div>    } while(ord($this-&gt;frame[$y][$x]) & 0x80);&nbsp;</div></li><li><div>    return array('x'=&gt;$x, 'y'=&gt;$y);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrawcode&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize code.&nbsp;</div></li><li><div> * @param $spec (array) array of ECC specification&nbsp;</div></li><li><div> * @return 0 in case of success, -1 in case of error&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function init($spec) {&nbsp;</div></li><li><div>    $dl = $this-&gt;rsDataCodes1($spec);&nbsp;</div></li><li><div>    $el = $this-&gt;rsEccCodes1($spec);&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>    $blockNo = 0;&nbsp;</div></li><li><div>    $dataPos = 0;&nbsp;</div></li><li><div>    $eccPos = 0;&nbsp;</div></li><li><div>    $endfor = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>        $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>        $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>        $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>        $dataPos += $dl;&nbsp;</div></li><li><div>        $eccPos += $el;&nbsp;</div></li><li><div>        $blockNo++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($this-&gt;rsBlockNum2($spec) == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $dl = $this-&gt;rsDataCodes2($spec);&nbsp;</div></li><li><div>    $el = $this-&gt;rsEccCodes2($spec);&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>    if ($rs == NULL) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $endfor = $this-&gt;rsBlockNum2($spec);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>        $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>        $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>        $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>        $dataPos += $dl;&nbsp;</div></li><li><div>        $eccPos += $el;&nbsp;</div></li><li><div>        $blockNo++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return Reed-Solomon block code.&nbsp;</div></li><li><div> * @return array rsblocks&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getCode() {&nbsp;</div></li><li><div>    if ($this-&gt;count &lt; $this-&gt;dataLength) {&nbsp;</div></li><li><div>        $row = $this-&gt;count % $this-&gt;blocks;&nbsp;</div></li><li><div>        $col = $this-&gt;count / $this-&gt;blocks;&nbsp;</div></li><li><div>        if ($col &gt;= $this-&gt;rsblocks[0]['dataLength']) {&nbsp;</div></li><li><div>            $row += $this-&gt;b1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $ret = $this-&gt;rsblocks[$row]['data'][$col];&nbsp;</div></li><li><div>    } elseif ($this-&gt;count &lt; $this-&gt;dataLength + $this-&gt;eccLength) {&nbsp;</div></li><li><div>        $row = ($this-&gt;count - $this-&gt;dataLength) % $this-&gt;blocks;&nbsp;</div></li><li><div>        $col = ($this-&gt;count - $this-&gt;dataLength) / $this-&gt;blocks;&nbsp;</div></li><li><div>        $ret = $this-&gt;rsblocks[$row]['ecc'][$col];&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;count++;&nbsp;</div></li><li><div>    return $ret;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRmask&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Write Format Information on frame and returns the number of black bits&nbsp;</div></li><li><div> * @param $width (int) frame width&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $mask (array) masking mode&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int blacks&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function writeFormatInformation($width, &$frame, $mask, $level) {&nbsp;</div></li><li><div>    $blacks = 0;&nbsp;</div></li><li><div>    $format =  $this-&gt;getFormatInfo($mask, $level);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;8; ++$i) {&nbsp;</div></li><li><div>        if ($format & 1) {&nbsp;</div></li><li><div>            $blacks += 2;&nbsp;</div></li><li><div>            $v = 0x85;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $v = 0x84;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $frame[8][$width - 1 - $i] = chr($v);&nbsp;</div></li><li><div>        if ($i &lt; 6) {&nbsp;</div></li><li><div>            $frame[$i][8] = chr($v);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $frame[$i + 1][8] = chr($v);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($i=0; $i&lt;7; ++$i) {&nbsp;</div></li><li><div>    if ($format & 1) {&nbsp;</div></li><li><div>        $blacks += 2;&nbsp;</div></li><li><div>        $v = 0x85;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $v = 0x84;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $frame[$width - 7 + $i][8] = chr($v);&nbsp;</div></li><li><div>    if ($i == 0) {&nbsp;</div></li><li><div>        $frame[8][7] = chr($v);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $frame[8][6 - $i] = chr($v);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $blacks;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask0&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask0($x, $y) {&nbsp;</div></li><li><div>    return ($x + $y) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask1&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask1($x, $y) {&nbsp;</div></li><li><div>    return ($y & 1);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask2&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask2($x, $y) {&nbsp;</div></li><li><div>    return ($x % 3);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask3&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask3($x, $y) {&nbsp;</div></li><li><div>    return ($x + $y) % 3;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask4&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask4($x, $y) {&nbsp;</div></li><li><div>    return (((int)($y / 2)) + ((int)($x / 3))) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask5&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask5($x, $y) {&nbsp;</div></li><li><div>    return (($x * $y) & 1) + ($x * $y) % 3;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask6&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask6($x, $y) {&nbsp;</div></li><li><div>    return ((($x * $y) & 1) + ($x * $y) % 3) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask7&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask7($x, $y) {&nbsp;</div></li><li><div>    return ((($x * $y) % 3) + (($x + $y) & 1)) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return bitmask&nbsp;</div></li><li><div> * @param $maskNo (int) mask number&nbsp;</div></li><li><div> * @param $width (int) width&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @return array bitmask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function generateMaskNo($maskNo, $width, $frame) {&nbsp;</div></li><li><div>    $bitMask = array_fill(0, $width, array_fill(0, $width, 0));&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if (ord($frame[$y][$x]) & 0x80) {&nbsp;</div></li><li><div>                $bitMask[$y][$x] = 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $maskFunc = call_user_func(array($this, 'mask'.$maskNo), $x, $y);&nbsp;</div></li><li><div>                $bitMask[$y][$x] = ($maskFunc == 0)?1:0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bitMask;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * makeMaskNo&nbsp;</div></li><li><div> * @param $maskNo (int)&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $s (int)&nbsp;</div></li><li><div> * @param $d (int)&nbsp;</div></li><li><div> * @param $maskGenOnly (boolean)&nbsp;</div></li><li><div> * @return int b&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function makeMaskNo($maskNo, $width, $s, &$d, $maskGenOnly=false) {&nbsp;</div></li><li><div>    $b = 0;&nbsp;</div></li><li><div>    $bitMask = array();&nbsp;</div></li><li><div>    $bitMask = $this-&gt;generateMaskNo($maskNo, $width, $s, $d);&nbsp;</div></li><li><div>    if ($maskGenOnly) {&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $d = $s;&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if ($bitMask[$y][$x] == 1) {&nbsp;</div></li><li><div>                $d[$y][$x] = chr(ord($s[$y][$x]) ^ ((int)($bitMask[$y][$x])));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $b += (int)(ord($d[$y][$x]) & 1);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $b;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * makeMask&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @param $maskNo (int)&nbsp;</div></li><li><div> * @param $level (int)&nbsp;</div></li><li><div> * @return array mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function makeMask($width, $frame, $maskNo, $level) {&nbsp;</div></li><li><div>    $masked = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>    $this-&gt;makeMaskNo($maskNo, $width, $frame, $masked);&nbsp;</div></li><li><div>    $this-&gt;writeFormatInformation($width, $masked, $maskNo, $level);&nbsp;</div></li><li><div>    return $masked;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * calcN1N3&nbsp;</div></li><li><div> * @param $length (int)&nbsp;</div></li><li><div> * @return int demerit&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function calcN1N3($length) {&nbsp;</div></li><li><div>    $demerit = 0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$length; ++$i) {&nbsp;</div></li><li><div>        if ($this-&gt;runLength[$i] &gt;= 5) {&nbsp;</div></li><li><div>            $demerit += (N1 + ($this-&gt;runLength[$i] - 5));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($i & 1) {&nbsp;</div></li><li><div>            if (($i &gt;= 3) AND ($i &lt; ($length-2)) AND ($this-&gt;runLength[$i] % 3 == 0)) {&nbsp;</div></li><li><div>                $fact = (int)($this-&gt;runLength[$i] / 3);&nbsp;</div></li><li><div>                if (($this-&gt;runLength[$i-2] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i-1] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i+1] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i+2] == $fact)) {&nbsp;</div></li><li><div>                    if (($this-&gt;runLength[$i-3] &lt; 0) OR ($this-&gt;runLength[$i-3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                        $demerit += N3;&nbsp;</div></li><li><div>                    } elseif ((($i+3) &gt;= $length) OR ($this-&gt;runLength[$i+3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                        $demerit += N3;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $demerit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * evaluateSymbol&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @return int demerit&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function evaluateSymbol($width, $frame) {&nbsp;</div></li><li><div>    $head = 0;&nbsp;</div></li><li><div>    $demerit = 0;&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        $head = 0;&nbsp;</div></li><li><div>        $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>        $frameY = $frame[$y];&nbsp;</div></li><li><div>        if ($y &gt; 0) {&nbsp;</div></li><li><div>            $frameYM = $frame[$y-1];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if (($x &gt; 0) AND ($y &gt; 0)) {&nbsp;</div></li><li><div>                $b22 = ord($frameY[$x]) & ord($frameY[$x-1]) & ord($frameYM[$x]) & ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                $w22 = ord($frameY[$x]) | ord($frameY[$x-1]) | ord($frameYM[$x]) | ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                if (($b22 | ($w22 ^ 1)) & 1) {&nbsp;</div></li><li><div>                    $demerit += N2;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (($x == 0) AND (ord($frameY[$x]) & 1)) {&nbsp;</div></li><li><div>                $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                $head = 1;&nbsp;</div></li><li><div>                $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>            } elseif ($x &gt; 0) {&nbsp;</div></li><li><div>                if ((ord($frameY[$x]) ^ ord($frameY[$x-1])) & 1) {&nbsp;</div></li><li><div>                    $head++;&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>        $head = 0;&nbsp;</div></li><li><div>        $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>        for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>            if (($y == 0) AND (ord($frame[$y][$x]) & 1)) {&nbsp;</div></li><li><div>                $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                $head = 1;&nbsp;</div></li><li><div>                $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>            } elseif ($y &gt; 0) {&nbsp;</div></li><li><div>                if ((ord($frame[$y][$x]) ^ ord($frame[$y-1][$x])) & 1) {&nbsp;</div></li><li><div>                    $head++;&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $demerit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @param $level (int)&nbsp;</div></li><li><div> * @return array best mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask($width, $frame, $level) {&nbsp;</div></li><li><div>    $minDemerit = PHP_INT_MAX;&nbsp;</div></li><li><div>    $bestMaskNum = 0;&nbsp;</div></li><li><div>    $bestMask = array();&nbsp;</div></li><li><div>    $checked_masks = array(0, 1, 2, 3, 4, 5, 6, 7);&nbsp;</div></li><li><div>    if (QR_FIND_FROM_RANDOM !== false) {&nbsp;</div></li><li><div>        $howManuOut = 8 - (QR_FIND_FROM_RANDOM % 9);&nbsp;</div></li><li><div>        for ($i = 0; $i &lt;  $howManuOut; ++$i) {&nbsp;</div></li><li><div>            $remPos = rand (0, count($checked_masks)-1);&nbsp;</div></li><li><div>            unset($checked_masks[$remPos]);&nbsp;</div></li><li><div>            $checked_masks = array_values($checked_masks);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bestMask = $frame;&nbsp;</div></li><li><div>    foreach ($checked_masks as $i) {&nbsp;</div></li><li><div>        $mask = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>        $demerit = 0;&nbsp;</div></li><li><div>        $blacks = 0;&nbsp;</div></li><li><div>        $blacks = $this-&gt;makeMaskNo($i, $width, $frame, $mask);&nbsp;</div></li><li><div>        $blacks += $this-&gt;writeFormatInformation($width, $mask, $i, $level);&nbsp;</div></li><li><div>        $blacks = (int)(100 * $blacks / ($width * $width));&nbsp;</div></li><li><div>        $demerit = (int)((int)(abs($blacks - 50) / 5) * N4);&nbsp;</div></li><li><div>        $demerit += $this-&gt;evaluateSymbol($width, $mask);&nbsp;</div></li><li><div>        if ($demerit &lt; $minDemerit) {&nbsp;</div></li><li><div>            $minDemerit = $demerit;&nbsp;</div></li><li><div>            $bestMask = $mask;&nbsp;</div></li><li><div>            $bestMaskNum = $i;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bestMask;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRsplit&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return true if the character at specified position is a number&nbsp;</div></li><li><div> * @param $str (string) string&nbsp;</div></li><li><div> * @param $pos (int) characted position&nbsp;</div></li><li><div> * @return boolean true of false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function isdigitat($str, $pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return ((ord($str[$pos]) &gt;= ord('0'))&&(ord($str[$pos]) &lt;= ord('9')));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return true if the character at specified position is an alphanumeric character&nbsp;</div></li><li><div> * @param $str (string) string&nbsp;</div></li><li><div> * @param $pos (int) characted position&nbsp;</div></li><li><div> * @return boolean true of false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function isalnumat($str, $pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return ($this-&gt;lookAnTable(ord($str[$pos])) &gt;= 0);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * identifyMode&nbsp;</div></li><li><div> * @param $pos (int)&nbsp;</div></li><li><div> * @return int mode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function identifyMode($pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>        return QR_MODE_NL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $c = $this-&gt;dataStr[$pos];&nbsp;</div></li><li><div>    if ($this-&gt;isdigitat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>        return QR_MODE_NM;&nbsp;</div></li><li><div>    } elseif ($this-&gt;isalnumat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>        return QR_MODE_AN;&nbsp;</div></li><li><div>    } elseif ($this-&gt;hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>        if ($pos+1 &lt; strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>            $d = $this-&gt;dataStr[$pos+1];&nbsp;</div></li><li><div>            $word = (ord($c) &lt;&lt; 8) | ord($d);&nbsp;</div></li><li><div>            if (($word &gt;= 0x8140 && $word &lt;= 0x9ffc) OR ($word &gt;= 0xe040 && $word &lt;= 0xebbf)) {&nbsp;</div></li><li><div>                return QR_MODE_KJ;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return QR_MODE_8B;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatNum&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatNum() {&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        $p++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>    if ($mode == QR_MODE_8B) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsMode8(1)         // + 4 + l8&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsMode8($run + 1); // - 4 - l8&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eat8();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsModeAn(1)        // + 4 + la&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsModeAn($run + 1);// - 4 - la&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eatAn();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_NM, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatAn&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatAn() {&nbsp;</div></li><li><div>    $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p =1 ;&nbsp;</div></li><li><div>    while($this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        if ($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsModeAn($p) // + 4 + la&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsModeAn($q); // - 4 - la&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    if (!$this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeAn($run) + 4 + $la&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsMode8(1) // + 4 + l8&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsMode8($run + 1); // - 4 - l8&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eat8();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_AN, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatKanji&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatKanji() {&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while($this-&gt;identifyMode($p) == QR_MODE_KJ) {&nbsp;</div></li><li><div>        $p += 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_KJ, $p, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eat8&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eat8() {&nbsp;</div></li><li><div>    $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p = 1;&nbsp;</div></li><li><div>    $dataStrLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>    while($p &lt; $dataStrLen) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>        if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($mode == QR_MODE_NM) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsMode8($p) // + 4 + l8&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsMode8($q); // - 4 - l8&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isalnumat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsMode8($p)  // + 4 + l8&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeAn($q - $p) + 4 + $la&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsMode8($q); // - 4 - l8&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_8B, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * splitString&nbsp;</div></li><li><div> * @return (int)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function splitString() {&nbsp;</div></li><li><div>    while (strlen($this-&gt;dataStr) &gt; 0) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode(0);&nbsp;</div></li><li><div>        switch ($mode) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $length = $this-&gt;eatNum();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $length = $this-&gt;eatAn();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                if ($hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>                    $length = $this-&gt;eatKanji();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($length == 0) {&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($length &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;dataStr = substr($this-&gt;dataStr, $length);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * toUpper&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function toUpper() {&nbsp;</div></li><li><div>    $stringLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while ($p &lt; $stringLen) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode(substr($this-&gt;dataStr, $p), $this-&gt;hint);&nbsp;</div></li><li><div>        if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>            $p += 2;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ((ord($this-&gt;dataStr[$p]) &gt;= ord('a')) AND (ord($this-&gt;dataStr[$p]) &lt;= ord('z'))) {&nbsp;</div></li><li><div>                $this-&gt;dataStr[$p] = chr(ord($this-&gt;dataStr[$p]) - 32);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;dataStr;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRinputItem&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * newInputItem&nbsp;</div></li><li><div> * @param $mode (int)&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @param $bstream (array)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newInputItem($mode, $size, $data, $bstream=null) {&nbsp;</div></li><li><div>    $setData = array_slice($data, 0, $size);&nbsp;</div></li><li><div>    if (count($setData) &lt; $size) {&nbsp;</div></li><li><div>        $setData = array_merge($setData, array_fill(0, ($size - count($setData)), 0));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (!$this-&gt;check($mode, $size, $setData)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $inputitem = array();&nbsp;</div></li><li><div>    $inputitem['mode'] = $mode;&nbsp;</div></li><li><div>    $inputitem['size'] = $size;&nbsp;</div></li><li><div>    $inputitem['data'] = $setData;&nbsp;</div></li><li><div>    $inputitem['bstream'] = $bstream;&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeNum&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeNum($inputitem, $version) {&nbsp;</div></li><li><div>    $words = (int)($inputitem['size'] / 3);&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $val = 0x1;&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_NM, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$i*3 ]) - ord('0')) * 100;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$i*3+1]) - ord('0')) * 10;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$i*3+2]) - ord('0'));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 10, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($inputitem['size'] - $words * 3 == 1) {&nbsp;</div></li><li><div>        $val = ord($inputitem['data'][$words*3]) - ord('0');&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>    } elseif (($inputitem['size'] - ($words * 3)) == 2) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$words*3 ]) - ord('0')) * 10;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$words*3+1]) - ord('0'));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 7, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeAn&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeAn($inputitem, $version) {&nbsp;</div></li><li><div>    $words = (int)($inputitem['size'] / 2);&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x02);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_AN, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>        $val = (int)($this-&gt;lookAnTable(ord($inputitem['data'][$i*2])) * 45);&nbsp;</div></li><li><div>        $val += (int)($this-&gt;lookAnTable(ord($inputitem['data'][($i*2)+1])));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 11, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($inputitem['size'] & 1) {&nbsp;</div></li><li><div>        $val = $this-&gt;lookAnTable(ord($inputitem['data'][($words * 2)]));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 6, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeMode8&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeMode8($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x4);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_8B, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $inputitem['size']; ++$i) {&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][$i]));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeKanji&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeKanji($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x8);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_KJ, $version), (int)($inputitem['size'] / 2));&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$inputitem['size']; $i+=2) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$i]) &lt;&lt; 8) | ord($inputitem['data'][$i+1]);&nbsp;</div></li><li><div>        if ($val &lt;= 0x9ffc) {&nbsp;</div></li><li><div>            $val -= 0x8140;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $val -= 0xc140;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $h = ($val &gt;&gt; 8) * 0xc0;&nbsp;</div></li><li><div>        $val = ($val & 0xff) + $h;&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 13, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeStructure&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeStructure($inputitem) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x03);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][1]) - 1);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][0]) - 1);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][2]));&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeBitStream&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeBitStream($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $words = $this-&gt;maximumWords($inputitem['mode'], $version);&nbsp;</div></li><li><div>    if ($inputitem['size'] &gt; $words) {&nbsp;</div></li><li><div>        $st1 = $this-&gt;newInputItem($inputitem['mode'], $words, $inputitem['data']);&nbsp;</div></li><li><div>        $st2 = $this-&gt;newInputItem($inputitem['mode'], $inputitem['size'] - $words, array_slice($inputitem['data'], $words));&nbsp;</div></li><li><div>        $st1 = $this-&gt;encodeBitStream($st1, $version);&nbsp;</div></li><li><div>        $st2 = $this-&gt;encodeBitStream($st2, $version);&nbsp;</div></li><li><div>        $inputitem['bstream'] = array();&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st1['bstream']);&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st2['bstream']);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        switch($inputitem['mode']) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeNum($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeAn($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_8B: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeMode8($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeKanji($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_ST: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeStructure($inputitem);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRinput&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append data to an input object.&nbsp;</div></li><li><div> * The data is copied and appended to the input object.&nbsp;</div></li><li><div> * @param $items (arrray) input items&nbsp;</div></li><li><div> * @param $mode (int) encoding mode.&nbsp;</div></li><li><div> * @param $size (int) size of data (byte).&nbsp;</div></li><li><div> * @param $data (array) array of input data.&nbsp;</div></li><li><div> * @return items&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function appendNewInputItem($items, $mode, $size, $data) {&nbsp;</div></li><li><div>    $newitem = $this-&gt;newInputItem($mode, $size, $data);&nbsp;</div></li><li><div>    if (!empty($newitem)) {&nbsp;</div></li><li><div>        $items[] = $newitem;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * insertStructuredAppendHeader&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $index (int)&nbsp;</div></li><li><div> * @param $parity (int)&nbsp;</div></li><li><div> * @return array items&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function insertStructuredAppendHeader($items, $size, $index, $parity) {&nbsp;</div></li><li><div>    if ($size &gt; MAX_STRUCTURED_SYMBOLS) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($index &lt;= 0) OR ($index &gt; MAX_STRUCTURED_SYMBOLS)) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $buf = array($size, $index, $parity);&nbsp;</div></li><li><div>    $entry = $this-&gt;newInputItem(QR_MODE_ST, 3, buf);&nbsp;</div></li><li><div>    array_unshift($items, $entry);&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * calcParity&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return int parity&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function calcParity($items) {&nbsp;</div></li><li><div>    $parity = 0;&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        if ($item['mode'] != QR_MODE_ST) {&nbsp;</div></li><li><div>            for ($i=$item['size']-1; $i&gt;=0; --$i) {&nbsp;</div></li><li><div>                $parity ^= $item['data'][$i];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $parity;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeNum&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeNum($size, $data) {&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        if ((ord($data[$i]) &lt; ord('0')) OR (ord($data[$i]) &gt; ord('9'))) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Look up the alphabet-numeric convesion table (see JIS X0510:2004, pp.19).&nbsp;</div></li><li><div> * @param $c (int) character value&nbsp;</div></li><li><div> * @return value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function lookAnTable($c) {&nbsp;</div></li><li><div>    return (($c &gt; 127)?-1:$this-&gt;anTable[$c]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeAn&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeAn($size, $data) {&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        if ($this-&gt;lookAnTable(ord($data[$i])) == -1) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeNum&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeNum($size) {&nbsp;</div></li><li><div>    $w = (int)($size / 3);&nbsp;</div></li><li><div>    $bits = ($w * 10);&nbsp;</div></li><li><div>    switch($size - ($w * 3)) {&nbsp;</div></li><li><div>        case 1: {&nbsp;</div></li><li><div>            $bits += 4;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case 2: {&nbsp;</div></li><li><div>            $bits += 7;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeAn&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeAn($size) {&nbsp;</div></li><li><div>    $bits = (int)($size * 5.5); // (size / 2 ) * 11&nbsp;</div></li><li><div>    if ($size & 1) {&nbsp;</div></li><li><div>        $bits += 6;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsMode8&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsMode8($size) {&nbsp;</div></li><li><div>    return (int)($size * 8);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeKanji&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeKanji($size) {&nbsp;</div></li><li><div>    return (int)($size * 6.5); // (size / 2 ) * 13&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeKanji&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeKanji($size, $data) {&nbsp;</div></li><li><div>    if ($size & 1) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; $i+=2) {&nbsp;</div></li><li><div>        $val = (ord($data[$i]) &lt;&lt; 8) | ord($data[$i+1]);&nbsp;</div></li><li><div>        if (($val &lt; 0x8140) OR (($val &gt; 0x9ffc) AND ($val &lt; 0xe040)) OR ($val &gt; 0xebbf)) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Validate the input data.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode.&nbsp;</div></li><li><div> * @param $size (int) size of data (byte).&nbsp;</div></li><li><div> * @param $data (array) data to validate&nbsp;</div></li><li><div> * @return boolean true in case of valid data, false otherwise&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function check($mode, $size, $data) {&nbsp;</div></li><li><div>    if ($size &lt;= 0) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    switch($mode) {&nbsp;</div></li><li><div>        case QR_MODE_NM: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeNum($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_AN: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeAn($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_KJ: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeKanji($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_8B: {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_ST: {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        default: {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitStreamSize&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return int bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitStreamSize($items, $version) {&nbsp;</div></li><li><div>    $bits = 0;&nbsp;</div></li><li><div>    if ($version == 0) {&nbsp;</div></li><li><div>        $version = 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        switch($item['mode']) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeNum($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeAn($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_8B: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsMode8($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeKanji($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_ST: {&nbsp;</div></li><li><div>                return STRUCTURE_HEADER_BITS;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                return 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $l = $this-&gt;lengthIndicator($item['mode'], $version);&nbsp;</div></li><li><div>        $m = 1 &lt;&lt; $l;&nbsp;</div></li><li><div>        $num = (int)(($item['size'] + $m - 1) / $m);&nbsp;</div></li><li><div>        $bits += $num * (4 + $l);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateVersion&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return int version&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateVersion($items) {&nbsp;</div></li><li><div>    $version = 0;&nbsp;</div></li><li><div>    $prev = 0;&nbsp;</div></li><li><div>    do {&nbsp;</div></li><li><div>        $prev = $version;&nbsp;</div></li><li><div>        $bits = $this-&gt;estimateBitStreamSize($items, $prev);&nbsp;</div></li><li><div>        $version = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>        if ($version &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } while ($version &gt; $prev);&nbsp;</div></li><li><div>    return $version;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * lengthOfCode&nbsp;</div></li><li><div> * @param $mode (int)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @param $bits (int)&nbsp;</div></li><li><div> * @return int size&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function lengthOfCode($mode, $version, $bits) {&nbsp;</div></li><li><div>    $payload = $bits - 4 - $this-&gt;lengthIndicator($mode, $version);&nbsp;</div></li><li><div>    switch($mode) {&nbsp;</div></li><li><div>        case QR_MODE_NM: {&nbsp;</div></li><li><div>            $chunks = (int)($payload / 10);&nbsp;</div></li><li><div>            $remain = $payload - $chunks * 10;&nbsp;</div></li><li><div>            $size = $chunks * 3;&nbsp;</div></li><li><div>            if ($remain &gt;= 7) {&nbsp;</div></li><li><div>                $size += 2;&nbsp;</div></li><li><div>            } elseif ($remain &gt;= 4) {&nbsp;</div></li><li><div>                $size += 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_AN: {&nbsp;</div></li><li><div>            $chunks = (int)($payload / 11);&nbsp;</div></li><li><div>            $remain = $payload - $chunks * 11;&nbsp;</div></li><li><div>            $size = $chunks * 2;&nbsp;</div></li><li><div>            if ($remain &gt;= 6) {&nbsp;</div></li><li><div>                ++$size;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_8B: {&nbsp;</div></li><li><div>            $size = (int)($payload / 8);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_KJ: {&nbsp;</div></li><li><div>            $size = (int)(($payload / 13) * 2);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_ST: {&nbsp;</div></li><li><div>            $size = (int)($payload / 8);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        default: {&nbsp;</div></li><li><div>            $size = 0;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $maxsize = $this-&gt;maximumWords($mode, $version);&nbsp;</div></li><li><div>    if ($size &lt; 0) {&nbsp;</div></li><li><div>        $size = 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($size &gt; $maxsize) {&nbsp;</div></li><li><div>        $size = $maxsize;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $size;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * createBitStream&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return array of items and total bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function createBitStream($items) {&nbsp;</div></li><li><div>    $total = 0;&nbsp;</div></li><li><div>    foreach ($items as $key =&gt; $item) {&nbsp;</div></li><li><div>        $items[$key] = $this-&gt;encodeBitStream($item, $this-&gt;version);&nbsp;</div></li><li><div>        $bits = count($items[$key]['bstream']);&nbsp;</div></li><li><div>        $total += $bits;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return array($items, $total);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * convertData&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return array items&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function convertData($items) {&nbsp;</div></li><li><div>    $ver = $this-&gt;estimateVersion($items);&nbsp;</div></li><li><div>    if ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>        $this-&gt;version = $ver;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    while (true) {&nbsp;</div></li><li><div>        $cbs = $this-&gt;createBitStream($items);&nbsp;</div></li><li><div>        $items = $cbs[0];&nbsp;</div></li><li><div>        $bits = $cbs[1];&nbsp;</div></li><li><div>        if ($bits &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $ver = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>        if ($ver &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        } elseif ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>            $this-&gt;version = $ver;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append Padding Bit to bitstream&nbsp;</div></li><li><div> * @param $bstream (array)&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendPaddingBit($bstream) {&nbsp;</div></li><li><div>     if (is_null($bstream)) {&nbsp;</div></li><li><div>         return null;&nbsp;</div></li><li><div>     }&nbsp;</div></li><li><div>    $bits = count($bstream);&nbsp;</div></li><li><div>    $maxwords = $this-&gt;getDataLength($this-&gt;version, $this-&gt;level);&nbsp;</div></li><li><div>    $maxbits = $maxwords * 8;&nbsp;</div></li><li><div>    if ($maxbits == $bits) {&nbsp;</div></li><li><div>        return $bstream;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($maxbits - $bits &lt; 5) {&nbsp;</div></li><li><div>        return $this-&gt;appendNum($bstream, $maxbits - $bits, 0);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bits += 4;&nbsp;</div></li><li><div>    $words = (int)(($bits + 7) / 8);&nbsp;</div></li><li><div>    $padding = array();&nbsp;</div></li><li><div>    $padding = $this-&gt;appendNum($padding, $words * 8 - $bits + 4, 0);&nbsp;</div></li><li><div>    $padlen = $maxwords - $words;&nbsp;</div></li><li><div>    if ($padlen &gt; 0) {&nbsp;</div></li><li><div>        $padbuf = array();&nbsp;</div></li><li><div>        for ($i=0; $i&lt;$padlen; ++$i) {&nbsp;</div></li><li><div>            $padbuf[$i] = ($i&1)?0x11:0xec;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $padding = $this-&gt;appendBytes($padding, $padlen, $padbuf);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bstream, $padding);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mergeBitStream&nbsp;</div></li><li><div> * @param $items (array) items&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mergeBitStream($items) {&nbsp;</div></li><li><div>    $items = $this-&gt;convertData($items);&nbsp;</div></li><li><div>    if (!is_array($items)) {&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bstream = array();&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        $bstream = $this-&gt;appendBitstream($bstream, $item['bstream']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Returns a stream of bits.&nbsp;</div></li><li><div> * @param $items (int)&nbsp;</div></li><li><div> * @return array padded merged byte stream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getBitStream($items) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;mergeBitStream($items);&nbsp;</div></li><li><div>    return $this-&gt;appendPaddingBit($bstream);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Pack all bit streams padding bits into a byte array.&nbsp;</div></li><li><div> * @param $items (int)&nbsp;</div></li><li><div> * @return array padded merged byte stream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getByteStream($items) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;getBitStream($items);&nbsp;</div></li><li><div>    return $this-&gt;bitstreamToByte($bstream);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRbitstream&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return an array with zeros&nbsp;</div></li><li><div> * @param $setLength (int) array size&nbsp;</div></li><li><div> * @return array&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function allocate($setLength) {&nbsp;</div></li><li><div>    return array_fill(0, $setLength, 0);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return new bitstream from number&nbsp;</div></li><li><div> * @param $bits (int) number of bits&nbsp;</div></li><li><div> * @param $num (int) number&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newFromNum($bits, $num) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;allocate($bits);&nbsp;</div></li><li><div>    $mask = 1 &lt;&lt; ($bits - 1);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$bits; ++$i) {&nbsp;</div></li><li><div>        if ($num & $mask) {&nbsp;</div></li><li><div>            $bstream[$i] = 1;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $bstream[$i] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return new bitstream from bytes&nbsp;</div></li><li><div> * @param $size (int) size&nbsp;</div></li><li><div> * @param $data (array) bytes&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newFromBytes($size, $data) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;allocate($size * 8);&nbsp;</div></li><li><div>    $p=0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        $mask = 0x80;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; ++$j) {&nbsp;</div></li><li><div>            if ($data[$i] & $mask) {&nbsp;</div></li><li><div>                $bstream[$p] = 1;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $bstream[$p] = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>            $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $append (array) bitstream to append&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendBitstream($bitstream, $append) {&nbsp;</div></li><li><div>    if ((!is_array($append)) OR (count($append) == 0)) {&nbsp;</div></li><li><div>        return $bitstream;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (count($bitstream) == 0) {&nbsp;</div></li><li><div>        return $append;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return array_values(array_merge($bitstream, $append));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream created from number to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $bits (int) number of bits&nbsp;</div></li><li><div> * @param $num (int) number&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendNum($bitstream, $bits, $num) {&nbsp;</div></li><li><div>    if ($bits == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b = $this-&gt;newFromNum($bits, $num);&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream created from bytes to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $size (int) size&nbsp;</div></li><li><div> * @param $data (array) bytes&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendBytes($bitstream, $size, $data) {&nbsp;</div></li><li><div>    if ($size == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b = $this-&gt;newFromBytes($size, $data);&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Convert bitstream to bytes&nbsp;</div></li><li><div> * @param $bstream (array) original bitstream&nbsp;</div></li><li><div> * @return array of bytes&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function bitstreamToByte($bstream) {&nbsp;</div></li><li><div>    if (is_null($bstream)) {&nbsp;</div></li><li><div>         return null;&nbsp;</div></li><li><div>     }&nbsp;</div></li><li><div>    $size = count($bstream);&nbsp;</div></li><li><div>    if ($size == 0) {&nbsp;</div></li><li><div>        return array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $data = array_fill(0, (int)(($size + 7) / 8), 0);&nbsp;</div></li><li><div>    $bytes = (int)($size / 8);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$bytes; $i++) {&nbsp;</div></li><li><div>        $v = 0;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>            $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>            $v |= $bstream[$p];&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data[$i] = $v;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($size & 7) {&nbsp;</div></li><li><div>        $v = 0;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;($size & 7); $j++) {&nbsp;</div></li><li><div>            $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>            $v |= $bstream[$p];&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data[$bytes] = $v;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRspec&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Replace a value on the array at the specified position&nbsp;</div></li><li><div> * @param $srctab (array)&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @param $repl (string) value to replace&nbsp;</div></li><li><div> * @param $replLen (int) length of the repl string&nbsp;</div></li><li><div> * @return array srctab&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function qrstrset($srctab, $x, $y, $repl, $replLen=false) {&nbsp;</div></li><li><div>    $srctab[$y] = substr_replace($srctab[$y], ($replLen !== false)?substr($repl, 0, $replLen):$repl, $x, ($replLen !== false)?$replLen:strlen($repl));&nbsp;</div></li><li><div>    return $srctab;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return maximum data code length (bytes) for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int maximum size (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getDataLength($version, $level) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_WORDS] - $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return maximum error correction code length (bytes) for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int ECC size (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getECCLength($version, $level) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the width of the symbol for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int width&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getWidth($version) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the numer of remainder bits.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int number of remainder bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getRemainder($version) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_REMINDER];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return a version number that satisfies the input code length.&nbsp;</div></li><li><div> * @param $size (int) input code length (bytes)&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int version number&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getMinimumVersion($size, $level) {&nbsp;</div></li><li><div>    for ($i = 1; $i &lt;= QRSPEC_VERSION_MAX; ++$i) {&nbsp;</div></li><li><div>        $words = ($this-&gt;capacity[$i][QRCAP_WORDS] - $this-&gt;capacity[$i][QRCAP_EC][$level]);&nbsp;</div></li><li><div>        if ($words &gt;= $size) {&nbsp;</div></li><li><div>            return $i;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // the size of input data is greater than QR capacity, try to lover the error correction mode&nbsp;</div></li><li><div>    return -1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the size of length indicator for the mode and version.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int the size of the appropriate length indicator (bits).&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function lengthIndicator($mode, $version) {&nbsp;</div></li><li><div>    if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($version &lt;= 9) {&nbsp;</div></li><li><div>        $l = 0;&nbsp;</div></li><li><div>    } elseif ($version &lt;= 26) {&nbsp;</div></li><li><div>        $l = 1;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $l = 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the maximum length for the mode and version.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int the maximum length (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function maximumWords($mode, $version) {&nbsp;</div></li><li><div>    if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>        return 3;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($version &lt;= 9) {&nbsp;</div></li><li><div>        $l = 0;&nbsp;</div></li><li><div>    } else if ($version &lt;= 26) {&nbsp;</div></li><li><div>        $l = 1;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $l = 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bits = $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>    $words = (1 &lt;&lt; $bits) - 1;&nbsp;</div></li><li><div>    if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>        $words *= 2; // the number of bytes is required&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $words;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return an array of ECC specification.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @param $spec (array) an array of ECC specification contains as following: {# of type1 blocks, # of data code, # of ecc code, # of type2 blocks, # of data code}&nbsp;</div></li><li><div> * @return array spec&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getEccSpec($version, $level, $spec) {&nbsp;</div></li><li><div>    if (count($spec) &lt; 5) {&nbsp;</div></li><li><div>        $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b1 = $this-&gt;eccTable[$version][$level][0];&nbsp;</div></li><li><div>    $b2 = $this-&gt;eccTable[$version][$level][1];&nbsp;</div></li><li><div>    $data = $this-&gt;getDataLength($version, $level);&nbsp;</div></li><li><div>    $ecc = $this-&gt;getECCLength($version, $level);&nbsp;</div></li><li><div>    if ($b2 == 0) {&nbsp;</div></li><li><div>        $spec[0] = $b1;&nbsp;</div></li><li><div>        $spec[1] = (int)($data / $b1);&nbsp;</div></li><li><div>        $spec[2] = (int)($ecc / $b1);&nbsp;</div></li><li><div>        $spec[3] = 0;&nbsp;</div></li><li><div>        $spec[4] = 0;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $spec[0] = $b1;&nbsp;</div></li><li><div>        $spec[1] = (int)($data / ($b1 + $b2));&nbsp;</div></li><li><div>        $spec[2] = (int)($ecc  / ($b1 + $b2));&nbsp;</div></li><li><div>        $spec[3] = $b2;&nbsp;</div></li><li><div>        $spec[4] = $spec[1] + 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $spec;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put an alignment marker.&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $ox (int) X center coordinate of the pattern&nbsp;</div></li><li><div> * @param $oy (int) Y center coordinate of the pattern&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function putAlignmentMarker($frame, $ox, $oy) {&nbsp;</div></li><li><div>    $finder = array(&nbsp;</div></li><li><div>        &quot;\xa1\xa1\xa1\xa1\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa1\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa1\xa1\xa1\xa1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    $yStart = $oy - 2;&nbsp;</div></li><li><div>    $xStart = $ox - 2;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 5; $y++) {&nbsp;</div></li><li><div>        $frame = $this-&gt;qrstrset($frame, $xStart, $yStart+$y, $finder[$y]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put an alignment pattern.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $width (int) width&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function putAlignmentPattern($version, $frame, $width) {&nbsp;</div></li><li><div>    if ($version &lt; 2) {&nbsp;</div></li><li><div>        return $frame;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $d = $this-&gt;alignmentPattern[$version][1] - $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    if ($d &lt; 0) {&nbsp;</div></li><li><div>        $w = 2;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $w = (int)(($width - $this-&gt;alignmentPattern[$version][0]) / $d + 2);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($w * $w - 3 == 1) {&nbsp;</div></li><li><div>        $x = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        $y = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, $x, $y);&nbsp;</div></li><li><div>        return $frame;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    $wo = $w - 1;&nbsp;</div></li><li><div>    for ($x=1; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, 6, $cx);&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, $cx, 6);&nbsp;</div></li><li><div>        $cx += $d;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $cy = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    for ($y=0; $y &lt; $wo; ++$y) {&nbsp;</div></li><li><div>        $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        for ($x=0; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>            $frame = $this-&gt;putAlignmentMarker($frame, $cx, $cy);&nbsp;</div></li><li><div>            $cx += $d;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cy += $d;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return BCH encoded version information pattern that is used for the symbol of version 7 or greater. Use lower 18 bits.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return BCH encoded version information pattern&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getVersionPattern($version) {&nbsp;</div></li><li><div>    if (($version &lt; 7) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;versionPattern[($version - 7)];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return BCH encoded format information pattern.&nbsp;</div></li><li><div> * @param $mask (array)&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return BCH encoded format information pattern&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getFormatInfo($mask, $level) {&nbsp;</div></li><li><div>    if (($mask &lt; 0) OR ($mask &gt; 7)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($level &lt; 0) OR ($level &gt; 3)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;formatInfo[$level][$mask];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put a finder pattern.&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $ox (int) X center coordinate of the pattern&nbsp;</div></li><li><div> * @param $oy (int) Y center coordinate of the pattern&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function putFinderPattern($frame, $ox, $oy) {&nbsp;</div></li><li><div>    $finder = array(&nbsp;</div></li><li><div>    &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 7; $y++) {&nbsp;</div></li><li><div>        $frame = $this-&gt;qrstrset($frame, $ox, ($oy + $y), $finder[$y]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return a copy of initialized frame.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return Array of unsigned char.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function createFrame($version) {&nbsp;</div></li><li><div>    $width = $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>    $frameLine = str_repeat (&quot;\0&quot;, $width);&nbsp;</div></li><li><div>    $frame = array_fill(0, $width, $frameLine);&nbsp;</div></li><li><div>    // Finder pattern&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, 0, 0);&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, $width - 7, 0);&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, 0, $width - 7);&nbsp;</div></li><li><div>    // Separator&nbsp;</div></li><li><div>    $yOffset = $width - 7;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 7; ++$y) {&nbsp;</div></li><li><div>        $frame[$y][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        $frame[$y][$width - 8] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        $frame[$yOffset][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        ++$yOffset;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $setPattern = str_repeat(&quot;\xc0&quot;, 8);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, 7, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, $width-8, 7, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, $width - 8, $setPattern);&nbsp;</div></li><li><div>    // Format info&nbsp;</div></li><li><div>    $setPattern = str_repeat(&quot;\x84&quot;, 9);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, 8, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, $width - 8, 8, $setPattern, 8);&nbsp;</div></li><li><div>    $yOffset = $width - 8;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 8; ++$y, ++$yOffset) {&nbsp;</div></li><li><div>        $frame[$y][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>        $frame[$yOffset][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Timing pattern&nbsp;</div></li><li><div>    $wo = $width - 15;&nbsp;</div></li><li><div>    for ($i=1; $i &lt; $wo; ++$i) {&nbsp;</div></li><li><div>        $frame[6][7+$i] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>        $frame[7+$i][6] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Alignment pattern&nbsp;</div></li><li><div>    $frame = $this-&gt;putAlignmentPattern($version, $frame, $width);&nbsp;</div></li><li><div>    // Version information&nbsp;</div></li><li><div>    if ($version &gt;= 7) {&nbsp;</div></li><li><div>        $vinf = $this-&gt;getVersionPattern($version);&nbsp;</div></li><li><div>        $v = $vinf;&nbsp;</div></li><li><div>        for ($x=0; $x&lt;6; ++$x) {&nbsp;</div></li><li><div>            for ($y=0; $y&lt;3; ++$y) {&nbsp;</div></li><li><div>                $frame[($width - 11)+$y][$x] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $v = $vinf;&nbsp;</div></li><li><div>        for ($y=0; $y&lt;6; ++$y) {&nbsp;</div></li><li><div>            for ($x=0; $x&lt;3; ++$x) {&nbsp;</div></li><li><div>                $frame[$y][$x+($width - 11)] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // and a little bit...&nbsp;</div></li><li><div>    $frame[$width - 8][8] = &quot;\x81&quot;;&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Set new frame for the specified version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return Array of unsigned char.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function newFrame($version) {&nbsp;</div></li><li><div>    if (($version &lt; 1) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (!isset($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>        $this-&gt;frames[$version] = $this-&gt;createFrame($version);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (is_null($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;frames[$version];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return block number 0&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum($spec) {&nbsp;</div></li><li><div>    return ($spec[0] + $spec[3]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div>* Return block number 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum1($spec) {&nbsp;</div></li><li><div>    return $spec[0];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data codes 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataCodes1($spec) {&nbsp;</div></li><li><div>    return $spec[1];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc codes 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccCodes1($spec) {&nbsp;</div></li><li><div>    return $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return block number 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum2($spec) {&nbsp;</div></li><li><div>    return $spec[3];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data codes 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataCodes2($spec) {&nbsp;</div></li><li><div>    return $spec[4];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc codes 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccCodes2($spec) {&nbsp;</div></li><li><div>    return $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data length&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataLength($spec) {&nbsp;</div></li><li><div>    return ($spec[0] * $spec[1]) + ($spec[3] * $spec[4]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc length&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccLength($spec) {&nbsp;</div></li><li><div>    return ($spec[0] + $spec[3]) * $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrs&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize a Reed-Solomon codec and add it to existing rsitems&nbsp;</div></li><li><div> * @param $symsize (int) symbol size, bits&nbsp;</div></li><li><div> * @param $gfpoly (int)  Field generator polynomial coefficients&nbsp;</div></li><li><div> * @param $fcr (int)  first root of RS code generator polynomial, index form&nbsp;</div></li><li><div> * @param $prim (int)  primitive element to generate polynomial roots&nbsp;</div></li><li><div> * @param $nroots (int) RS code generator polynomial degree (number of roots)&nbsp;</div></li><li><div> * @param $pad (int)  padding bytes at front of shortened block&nbsp;</div></li><li><div> * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function init_rs($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>    foreach ($this-&gt;rsitems as $rs) {&nbsp;</div></li><li><div>        if (($rs['pad'] != $pad) OR ($rs['nroots'] != $nroots) OR ($rs['mm'] != $symsize)&nbsp;</div></li><li><div>            OR ($rs['gfpoly'] != $gfpoly) OR ($rs['fcr'] != $fcr) OR ($rs['prim'] != $prim)) {&nbsp;</div></li><li><div>            continue;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad);&nbsp;</div></li><li><div>    array_unshift($this-&gt;rsitems, $rs);&nbsp;</div></li><li><div>    return $rs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrsItem&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * modnn&nbsp;</div></li><li><div> * @param $rs (array) RS values&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @return int X osition&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function modnn($rs, $x) {&nbsp;</div></li><li><div>    while ($x &gt;= $rs['nn']) {&nbsp;</div></li><li><div>        $x -= $rs['nn'];&nbsp;</div></li><li><div>        $x = ($x &gt;&gt; $rs['mm']) + ($x & $rs['nn']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $x;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize a Reed-Solomon codec and returns an array of values.&nbsp;</div></li><li><div> * @param $symsize (int) symbol size, bits&nbsp;</div></li><li><div> * @param $gfpoly (int)  Field generator polynomial coefficients&nbsp;</div></li><li><div> * @param $fcr (int)  first root of RS code generator polynomial, index form&nbsp;</div></li><li><div> * @param $prim (int)  primitive element to generate polynomial roots&nbsp;</div></li><li><div> * @param $nroots (int) RS code generator polynomial degree (number of roots)&nbsp;</div></li><li><div> * @param $pad (int)  padding bytes at front of shortened block&nbsp;</div></li><li><div> * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>    // Based on Reed solomon encoder by Phil Karn, KA9Q (GNU-LGPLv2)&nbsp;</div></li><li><div>    $rs = null;&nbsp;</div></li><li><div>    // Check parameter ranges&nbsp;</div></li><li><div>    if (($symsize &lt; 0) OR ($symsize &gt; 8)) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($fcr &lt; 0) OR ($fcr &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($prim &lt;= 0) OR ($prim &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($nroots &lt; 0) OR ($nroots &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($pad &lt; 0) OR ($pad &gt;= ((1&lt;&lt;$symsize) -1 - $nroots))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs = array();&nbsp;</div></li><li><div>    $rs['mm'] = $symsize;&nbsp;</div></li><li><div>    $rs['nn'] = (1 &lt;&lt; $symsize) - 1;&nbsp;</div></li><li><div>    $rs['pad'] = $pad;&nbsp;</div></li><li><div>    $rs['alpha_to'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>    $rs['index_of'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>    // PHP style macro replacement ;)&nbsp;</div></li><li><div>    $NN =& $rs['nn'];&nbsp;</div></li><li><div>    $A0 =& $NN;&nbsp;</div></li><li><div>    // Generate Galois field lookup tables&nbsp;</div></li><li><div>    $rs['index_of'][0] = $A0; // log(zero) = -inf&nbsp;</div></li><li><div>    $rs['alpha_to'][$A0] = 0; // alpha**-inf = 0&nbsp;</div></li><li><div>    $sr = 1;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$rs['nn']; ++$i) {&nbsp;</div></li><li><div>        $rs['index_of'][$sr] = $i;&nbsp;</div></li><li><div>        $rs['alpha_to'][$i] = $sr;&nbsp;</div></li><li><div>        $sr &lt;&lt;= 1;&nbsp;</div></li><li><div>        if ($sr & (1 &lt;&lt; $symsize)) {&nbsp;</div></li><li><div>            $sr ^= $gfpoly;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $sr &= $rs['nn'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($sr != 1) {&nbsp;</div></li><li><div>        // field generator polynomial is not primitive!&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Form RS code generator polynomial from its roots&nbsp;</div></li><li><div>    $rs['genpoly'] = array_fill(0, ($nroots + 1), 0);&nbsp;</div></li><li><div>    $rs['fcr'] = $fcr;&nbsp;</div></li><li><div>    $rs['prim'] = $prim;&nbsp;</div></li><li><div>    $rs['nroots'] = $nroots;&nbsp;</div></li><li><div>    $rs['gfpoly'] = $gfpoly;&nbsp;</div></li><li><div>    // Find prim-th root of 1, used in decoding&nbsp;</div></li><li><div>    for ($iprim=1; ($iprim % $prim) != 0; $iprim += $rs['nn']) {&nbsp;</div></li><li><div>        ; // intentional empty-body loop!&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs['iprim'] = (int)($iprim / $prim);&nbsp;</div></li><li><div>    $rs['genpoly'][0] = 1;&nbsp;</div></li><li><div>    for ($i = 0, $root=$fcr*$prim; $i &lt; $nroots; $i++, $root += $prim) {&nbsp;</div></li><li><div>        $rs['genpoly'][$i+1] = 1;&nbsp;</div></li><li><div>        // Multiply rs-&gt;genpoly[] by  @**(root + x)&nbsp;</div></li><li><div>        for ($j = $i; $j &gt; 0; --$j) {&nbsp;</div></li><li><div>            if ($rs['genpoly'][$j] != 0) {&nbsp;</div></li><li><div>                $rs['genpoly'][$j] = $rs['genpoly'][$j-1] ^ $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][$j]] + $root)];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $rs['genpoly'][$j] = $rs['genpoly'][$j-1];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // rs-&gt;genpoly[0] can never be zero&nbsp;</div></li><li><div>        $rs['genpoly'][0] = $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][0]] + $root)];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // convert rs-&gt;genpoly[] to index form for quicker encoding&nbsp;</div></li><li><div>    for ($i = 0; $i &lt;= $nroots; ++$i) {&nbsp;</div></li><li><div>        $rs['genpoly'][$i] = $rs['index_of'][$rs['genpoly'][$i]];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $rs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode a Reed-Solomon codec and returns the parity array&nbsp;</div></li><li><div> * @param $rs (array) RS values&nbsp;</div></li><li><div> * @param $data (array) data&nbsp;</div></li><li><div> * @param $parity (array) parity&nbsp;</div></li><li><div> * @return parity array&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encode_rs_char($rs, $data, $parity) {&nbsp;</div></li><li><div>    $MM =& $rs['mm']; // bits per symbol&nbsp;</div></li><li><div>    $NN =& $rs['nn']; // the total number of symbols in a RS block&nbsp;</div></li><li><div>    $ALPHA_TO =& $rs['alpha_to']; // the address of an array of NN elements to convert Galois field elements in index (log) form to polynomial form&nbsp;</div></li><li><div>    $INDEX_OF =& $rs['index_of']; // the address of an array of NN elements to convert Galois field elements in polynomial form to index (log) form&nbsp;</div></li><li><div>    $GENPOLY =& $rs['genpoly']; // an array of NROOTS+1 elements containing the generator polynomial in index form&nbsp;</div></li><li><div>    $NROOTS =& $rs['nroots']; // the number of roots in the RS code generator polynomial, which is the same as the number of parity symbols in a block&nbsp;</div></li><li><div>    $FCR =& $rs['fcr']; // first consecutive root, index form&nbsp;</div></li><li><div>    $PRIM =& $rs['prim']; // primitive element, index form&nbsp;</div></li><li><div>    $IPRIM =& $rs['iprim']; // prim-th root of 1, index form&nbsp;</div></li><li><div>    $PAD =& $rs['pad']; // the number of pad symbols in a block&nbsp;</div></li><li><div>    $A0 =& $NN;&nbsp;</div></li><li><div>    $parity = array_fill(0, $NROOTS, 0);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; ($NN - $NROOTS - $PAD); $i++) {&nbsp;</div></li><li><div>        $feedback = $INDEX_OF[$data[$i] ^ $parity[0]];&nbsp;</div></li><li><div>        if ($feedback != $A0) {&nbsp;</div></li><li><div>            // feedback term is non-zero&nbsp;</div></li><li><div>            // This line is unnecessary when GENPOLY[NROOTS] is unity, as it must&nbsp;</div></li><li><div>            // always be for the polynomials constructed by init_rs()&nbsp;</div></li><li><div>            $feedback = $this-&gt;modnn($rs, $NN - $GENPOLY[$NROOTS] + $feedback);&nbsp;</div></li><li><div>            for ($j=1; $j &lt; $NROOTS; ++$j) {&nbsp;</div></li><li><div>            $parity[$j] ^= $ALPHA_TO[$this-&gt;modnn($rs, $feedback + $GENPOLY[($NROOTS - $j)])];&nbsp;</div></li></ol></pre><pre><ol data-line="51" class="block" start="291"><li><div>/* @class QRcode&nbsp;</div></li><li><div> * Class to create QR-code arrays for TCPDF class.&nbsp;</div></li><li><div> * QR Code symbol is a 2D barcode that can be scanned by handy terminals such as a mobile phone with CCD.&nbsp;</div></li><li><div> * The capacity of QR Code is up to 7000 digits or 4000 characters, and has high robustness.&nbsp;</div></li><li><div> * This class supports QR Code model 2, described in JIS (Japanese Industrial Standards) X0510:2004 or ISO/IEC 18004.&nbsp;</div></li><li><div> * Currently the following features are not supported: ECI and FNC1 mode, Micro QR Code, QR Code model 1, Structured mode.&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> * This class is derived from &quot;PHP QR Code encoder&quot; by Dominik Dzienia (http://phpqrcode.sourceforge.net/) based on &quot;libqrencode C library 3.1.1.&quot; by Kentaro Fukuchi (http://megaui.net/fukuchi/works/qrencode/index.en.html), contains Reed-Solomon code written by Phil Karn, KA9Q. QR Code is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/index-e.html).&nbsp;</div></li><li><div> * Please read comments on this class source file for full copyright and license information.&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> * @package com.tecnick.tcpdf&nbsp;</div></li><li><div> * @author Nicola Asuni&nbsp;</div></li><li><div> * @version 3.010&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>class QRcode {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Barcode array to be returned which is readable by TCPDF.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $barcode_array = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * QR code version. Size of QRcode is defined as version. Version is from 1 to 40. Version 1 is 21*21 matrix. And 4 modules increases whenever 1 version increases. So version 40 is 177*177 matrix.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $version = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Levels of error correction. See definitions for possible values.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encoding mode.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $hint = QR_MODE_8B;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Boolean flag, if true the input string will be converted to uppercase.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $casesensitive = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Structured QR code (not supported yet).&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $structured = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Mask data.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// FrameFiller&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Width.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Frame.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $frame;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * X position of bit.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $x;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Y position of bit.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Direction.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Single bit value.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $bit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRrawcode ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Data code.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $datacode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Error correction code.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $ecccode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Blocks.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $blocks;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Reed-Solomon blocks.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $rsblocks = array(); //of RSblock&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Counter.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Data length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dataLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Error correction length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $eccLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Value b1.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $b1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRmask ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Run length.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $runLength = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// ---- QRsplit ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Input data string.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $dataStr = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Input items.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// Reed-Solomon items&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Reed-Solomon items.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $rsitems = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array of frames.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $frames = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Alphabet-numeric convesion table.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $anTable = array(&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    36, -1, -1, -1, 37, 38, -1, -1, -1, -1, 39, 40, -1, 41, 42, 43, //&nbsp;</div></li><li><div>     0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 44, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, //&nbsp;</div></li><li><div>    25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //&nbsp;</div></li><li><div>    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1  //&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Table of the capacity of symbols.&nbsp;</div></li><li><div> * See Table 1 (pp.13) and Table 12-16 (pp.30-36), JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $capacity = array(&nbsp;</div></li><li><div>    array(  0, 0, 0, array(   0, 0, 0, 0)), //&nbsp;</div></li><li><div>    array( 21, 26, 0, array(   7, 10, 13, 17)), //  1&nbsp;</div></li><li><div>    array( 25, 44, 7, array(  10, 16, 22, 28)), //&nbsp;</div></li><li><div>    array( 29, 70, 7, array(  15, 26, 36, 44)), //&nbsp;</div></li><li><div>    array( 33, 100, 7, array(  20, 36, 52, 64)), //&nbsp;</div></li><li><div>    array( 37, 134, 7, array(  26, 48, 72, 88)), //  5&nbsp;</div></li><li><div>    array( 41, 172, 7, array(  36, 64, 96, 112)), //&nbsp;</div></li><li><div>    array( 45, 196, 0, array(  40, 72, 108, 130)), //&nbsp;</div></li><li><div>    array( 49, 242, 0, array(  48, 88, 132, 156)), //&nbsp;</div></li><li><div>    array( 53, 292, 0, array(  60, 110, 160, 192)), //&nbsp;</div></li><li><div>    array( 57, 346, 0, array(  72, 130, 192, 224)), // 10&nbsp;</div></li><li><div>    array( 61, 404, 0, array(  80, 150, 224, 264)), //&nbsp;</div></li><li><div>    array( 65, 466, 0, array(  96, 176, 260, 308)), //&nbsp;</div></li><li><div>    array( 69, 532, 0, array( 104, 198, 288, 352)), //&nbsp;</div></li><li><div>    array( 73, 581, 3, array( 120, 216, 320, 384)), //&nbsp;</div></li><li><div>    array( 77, 655, 3, array( 132, 240, 360, 432)), // 15&nbsp;</div></li><li><div>    array( 81, 733, 3, array( 144, 280, 408, 480)), //&nbsp;</div></li><li><div>    array( 85, 815, 3, array( 168, 308, 448, 532)), //&nbsp;</div></li><li><div>    array( 89, 901, 3, array( 180, 338, 504, 588)), //&nbsp;</div></li><li><div>    array( 93, 991, 3, array( 196, 364, 546, 650)), //&nbsp;</div></li><li><div>    array( 97, 1085, 3, array( 224, 416, 600, 700)), // 20&nbsp;</div></li><li><div>    array(101, 1156, 4, array( 224, 442, 644, 750)), //&nbsp;</div></li><li><div>    array(105, 1258, 4, array( 252, 476, 690, 816)), //&nbsp;</div></li><li><div>    array(109, 1364, 4, array( 270, 504, 750, 900)), //&nbsp;</div></li><li><div>    array(113, 1474, 4, array( 300, 560, 810, 960)), //&nbsp;</div></li><li><div>    array(117, 1588, 4, array( 312, 588, 870, 1050)), // 25&nbsp;</div></li><li><div>    array(121, 1706, 4, array( 336, 644, 952, 1110)), //&nbsp;</div></li><li><div>    array(125, 1828, 4, array( 360, 700, 1020, 1200)), //&nbsp;</div></li><li><div>    array(129, 1921, 3, array( 390, 728, 1050, 1260)), //&nbsp;</div></li><li><div>    array(133, 2051, 3, array( 420, 784, 1140, 1350)), //&nbsp;</div></li><li><div>    array(137, 2185, 3, array( 450, 812, 1200, 1440)), // 30&nbsp;</div></li><li><div>    array(141, 2323, 3, array( 480, 868, 1290, 1530)), //&nbsp;</div></li><li><div>    array(145, 2465, 3, array( 510, 924, 1350, 1620)), //&nbsp;</div></li><li><div>    array(149, 2611, 3, array( 540, 980, 1440, 1710)), //&nbsp;</div></li><li><div>    array(153, 2761, 3, array( 570, 1036, 1530, 1800)), //&nbsp;</div></li><li><div>    array(157, 2876, 0, array( 570, 1064, 1590, 1890)), // 35&nbsp;</div></li><li><div>    array(161, 3034, 0, array( 600, 1120, 1680, 1980)), //&nbsp;</div></li><li><div>    array(165, 3196, 0, array( 630, 1204, 1770, 2100)), //&nbsp;</div></li><li><div>    array(169, 3362, 0, array( 660, 1260, 1860, 2220)), //&nbsp;</div></li><li><div>    array(173, 3532, 0, array( 720, 1316, 1950, 2310)), //&nbsp;</div></li><li><div>    array(177, 3706, 0, array( 750, 1372, 2040, 2430))  // 40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Length indicator.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $lengthTableBits = array(&nbsp;</div></li><li><div>    array(10, 12, 14), &nbsp;</div></li><li><div>    array( 9, 11, 13), &nbsp;</div></li><li><div>    array( 8, 16, 16), &nbsp;</div></li><li><div>    array( 8, 10, 12)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Table of the error correction code (Reed-Solomon block).&nbsp;</div></li><li><div> * See Table 12-16 (pp.30-36), JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $eccTable = array(&nbsp;</div></li><li><div>    array(array( 0, 0), array( 0, 0), array( 0, 0), array( 0, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), //  1&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 1, 0), array( 2, 0), array( 2, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 2, 0), array( 2, 0), array( 4, 0)), //&nbsp;</div></li><li><div>    array(array( 1, 0), array( 2, 0), array( 2, 2), array( 2, 2)), //  5&nbsp;</div></li><li><div>    array(array( 2, 0), array( 4, 0), array( 4, 0), array( 4, 0)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 4, 0), array( 2, 4), array( 4, 1)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 2, 2), array( 4, 2), array( 4, 2)), //&nbsp;</div></li><li><div>    array(array( 2, 0), array( 3, 2), array( 4, 4), array( 4, 4)), //&nbsp;</div></li><li><div>    array(array( 2, 2), array( 4, 1), array( 6, 2), array( 6, 2)), // 10&nbsp;</div></li><li><div>    array(array( 4, 0), array( 1, 4), array( 4, 4), array( 3, 8)), //&nbsp;</div></li><li><div>    array(array( 2, 2), array( 6, 2), array( 4, 6), array( 7, 4)), //&nbsp;</div></li><li><div>    array(array( 4, 0), array( 8, 1), array( 8, 4), array(12, 4)), //&nbsp;</div></li><li><div>    array(array( 3, 1), array( 4, 5), array(11, 5), array(11, 5)), //&nbsp;</div></li><li><div>    array(array( 5, 1), array( 5, 5), array( 5, 7), array(11, 7)), // 15&nbsp;</div></li><li><div>    array(array( 5, 1), array( 7, 3), array(15, 2), array( 3, 13)), //&nbsp;</div></li><li><div>    array(array( 1, 5), array(10, 1), array( 1, 15), array( 2, 17)), //&nbsp;</div></li><li><div>    array(array( 5, 1), array( 9, 4), array(17, 1), array( 2, 19)), //&nbsp;</div></li><li><div>    array(array( 3, 4), array( 3, 11), array(17, 4), array( 9, 16)), //&nbsp;</div></li><li><div>    array(array( 3, 5), array( 3, 13), array(15, 5), array(15, 10)), // 20&nbsp;</div></li><li><div>    array(array( 4, 4), array(17, 0), array(17, 6), array(19, 6)), //&nbsp;</div></li><li><div>    array(array( 2, 7), array(17, 0), array( 7, 16), array(34, 0)), //&nbsp;</div></li><li><div>    array(array( 4, 5), array( 4, 14), array(11, 14), array(16, 14)), //&nbsp;</div></li><li><div>    array(array( 6, 4), array( 6, 14), array(11, 16), array(30, 2)), //&nbsp;</div></li><li><div>    array(array( 8, 4), array( 8, 13), array( 7, 22), array(22, 13)), // 25&nbsp;</div></li><li><div>    array(array(10, 2), array(19, 4), array(28, 6), array(33, 4)), //&nbsp;</div></li><li><div>    array(array( 8, 4), array(22, 3), array( 8, 26), array(12, 28)), //&nbsp;</div></li><li><div>    array(array( 3, 10), array( 3, 23), array( 4, 31), array(11, 31)), //&nbsp;</div></li><li><div>    array(array( 7, 7), array(21, 7), array( 1, 37), array(19, 26)), //&nbsp;</div></li><li><div>    array(array( 5, 10), array(19, 10), array(15, 25), array(23, 25)), // 30&nbsp;</div></li><li><div>    array(array(13, 3), array( 2, 29), array(42, 1), array(23, 28)), //&nbsp;</div></li><li><div>    array(array(17, 0), array(10, 23), array(10, 35), array(19, 35)), //&nbsp;</div></li><li><div>    array(array(17, 1), array(14, 21), array(29, 19), array(11, 46)), //&nbsp;</div></li><li><div>    array(array(13, 6), array(14, 23), array(44, 7), array(59, 1)), //&nbsp;</div></li><li><div>    array(array(12, 7), array(12, 26), array(39, 14), array(22, 41)), // 35&nbsp;</div></li><li><div>    array(array( 6, 14), array( 6, 34), array(46, 10), array( 2, 64)), //&nbsp;</div></li><li><div>    array(array(17, 4), array(29, 14), array(49, 10), array(24, 46)), //&nbsp;</div></li><li><div>    array(array( 4, 18), array(13, 32), array(48, 14), array(42, 32)), //&nbsp;</div></li><li><div>    array(array(20, 4), array(40, 7), array(43, 22), array(10, 67)), //&nbsp;</div></li><li><div>    array(array(19, 6), array(18, 31), array(34, 34), array(20, 61))  // 40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Positions of alignment patterns.&nbsp;</div></li><li><div> * This array includes only the second and the third position of the alignment patterns. Rest of them can be calculated from the distance between them.&nbsp;</div></li><li><div> * See Table 1 in Appendix E (pp.71) of JIS X0510:2004.&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $alignmentPattern = array(&nbsp;</div></li><li><div>    array( 0, 0), &nbsp;</div></li><li><div>    array( 0, 0), array(18, 0), array(22, 0), array(26, 0), array(30, 0), //  1- 5&nbsp;</div></li><li><div>    array(34, 0), array(22, 38), array(24, 42), array(26, 46), array(28, 50), //  6-10&nbsp;</div></li><li><div>    array(30, 54), array(32, 58), array(34, 62), array(26, 46), array(26, 48), // 11-15&nbsp;</div></li><li><div>    array(26, 50), array(30, 54), array(30, 56), array(30, 58), array(34, 62), // 16-20&nbsp;</div></li><li><div>    array(28, 50), array(26, 50), array(30, 54), array(28, 54), array(32, 58), // 21-25&nbsp;</div></li><li><div>    array(30, 58), array(34, 62), array(26, 50), array(30, 54), array(26, 52), // 26-30&nbsp;</div></li><li><div>    array(30, 56), array(34, 60), array(30, 58), array(34, 62), array(30, 54), // 31-35&nbsp;</div></li><li><div>    array(24, 50), array(28, 54), array(32, 58), array(26, 54), array(30, 58)  // 35-40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Version information pattern (BCH coded).&nbsp;</div></li><li><div> * See Table 1 in Appendix D (pp.68) of JIS X0510:2004.&nbsp;</div></li><li><div> * size: [QRSPEC_VERSION_MAX - 6]&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $versionPattern = array(&nbsp;</div></li><li><div>    0x07c94, 0x085bc, 0x09a99, 0x0a4d3, 0x0bbf6, 0x0c762, 0x0d847, 0x0e60d, //&nbsp;</div></li><li><div>    0x0f928, 0x10b78, 0x1145d, 0x12a17, 0x13532, 0x149a6, 0x15683, 0x168c9, //&nbsp;</div></li><li><div>    0x177ec, 0x18ec4, 0x191e1, 0x1afab, 0x1b08e, 0x1cc1a, 0x1d33f, 0x1ed75, //&nbsp;</div></li><li><div>    0x1f250, 0x209d5, 0x216f0, 0x228ba, 0x2379f, 0x24b0b, 0x2542e, 0x26a64, //&nbsp;</div></li><li><div>    0x27541, 0x28c69&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Array Format information&nbsp;</div></li><li><div> * @protected&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected $formatInfo = array(&nbsp;</div></li><li><div>    array(0x77c4, 0x72f3, 0x7daa, 0x789d, 0x662f, 0x6318, 0x6c41, 0x6976), //&nbsp;</div></li><li><div>    array(0x5412, 0x5125, 0x5e7c, 0x5b4b, 0x45f9, 0x40ce, 0x4f97, 0x4aa0), //&nbsp;</div></li><li><div>    array(0x355f, 0x3068, 0x3f31, 0x3a06, 0x24b4, 0x2183, 0x2eda, 0x2bed), //&nbsp;</div></li><li><div>    array(0x1689, 0x13be, 0x1ce7, 0x19d0, 0x0762, 0x0255, 0x0d0c, 0x083b)  //&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// -------------------------------------------------&nbsp;</div></li><li><div>// -------------------------------------------------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * This is the class constructor.&nbsp;</div></li><li><div> * Creates a QRcode object&nbsp;</div></li><li><div> * @param $code (string) code to represent using QRcode&nbsp;</div></li><li><div> * @param $eclevel (string) error level: &lt;ul&gt;&lt;li&gt;L : About 7% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;M : About 15% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;Q : About 25% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;H : About 30% or less errors can be corrected.&lt;/li&gt;&lt;/ul&gt;&nbsp;</div></li><li><div> * @public&nbsp;</div></li><li><div> * @since 3.000&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>public function __construct($code, $eclevel = 'L') {&nbsp;</div></li><li><div>    $barcode_array = array();&nbsp;</div></li><li><div>    if ((is_null($code)) OR ($code == '\0') OR ($code == '')) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // set error correction level&nbsp;</div></li><li><div>    $this-&gt;level = array_search($eclevel, array('L', 'M', 'Q', 'H'));&nbsp;</div></li><li><div>    if ($this-&gt;level === false) {&nbsp;</div></li><li><div>        $this-&gt;level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($this-&gt;hint != QR_MODE_8B) AND ($this-&gt;hint != QR_MODE_KJ)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($this-&gt;version &lt; 0) OR ($this-&gt;version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = array();&nbsp;</div></li><li><div>    $this-&gt;encodeString($code);&nbsp;</div></li><li><div>    if (is_null($this-&gt;data)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $qrTab = $this-&gt;binarize($this-&gt;data);&nbsp;</div></li><li><div>    $size = count($qrTab);&nbsp;</div></li><li><div>    $barcode_array['num_rows'] = $size;&nbsp;</div></li><li><div>    $barcode_array['num_cols'] = $size;&nbsp;</div></li><li><div>    $barcode_array['bcode'] = array();&nbsp;</div></li><li><div>    foreach ($qrTab as $line) {&nbsp;</div></li><li><div>        $arrAdd = array();&nbsp;</div></li><li><div>        foreach (str_split($line) as $char) {&nbsp;</div></li><li><div>            $arrAdd[] = ($char=='1')?1:0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $barcode_array['bcode'][] = $arrAdd;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;barcode_array = $barcode_array;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Returns a barcode array which is readable by TCPDF&nbsp;</div></li><li><div> * @return array barcode array readable by TCPDF;&nbsp;</div></li><li><div> * @public&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>public function getBarcodeArray() {&nbsp;</div></li><li><div>    return $this-&gt;barcode_array;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Convert the frame in binary form&nbsp;</div></li><li><div> * @param $frame (array) array to binarize&nbsp;</div></li><li><div> * @return array frame in binary form&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function binarize($frame) {&nbsp;</div></li><li><div>    $len = count($frame);&nbsp;</div></li><li><div>    // the frame is square (width = height)&nbsp;</div></li><li><div>    foreach ($frame as &$frameLine) {&nbsp;</div></li><li><div>        for ($i=0; $i&lt;$len; $i++) {&nbsp;</div></li><li><div>            $frameLine[$i] = (ord($frameLine[$i])&1)?'1':'0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode the input string to QR code&nbsp;</div></li><li><div> * @param $string (string) input string to encode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function encodeString($string) {&nbsp;</div></li><li><div>    $this-&gt;dataStr = $string;&nbsp;</div></li><li><div>    if (!$this-&gt;casesensitive) {&nbsp;</div></li><li><div>        $this-&gt;toUpper();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $ret = $this-&gt;splitString();&nbsp;</div></li><li><div>    if ($ret &lt; 0) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;encodeMask(-1);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode mask&nbsp;</div></li><li><div> * @param $mask (int) masking mode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function encodeMask($mask) {&nbsp;</div></li><li><div>    $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>    $this-&gt;datacode = $this-&gt;getByteStream($this-&gt;items);&nbsp;</div></li><li><div>    if (is_null($this-&gt;datacode)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $spec = $this-&gt;getEccSpec($this-&gt;version, $this-&gt;level, $spec);&nbsp;</div></li><li><div>    $this-&gt;b1 = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>    $this-&gt;dataLength = $this-&gt;rsDataLength($spec);&nbsp;</div></li><li><div>    $this-&gt;eccLength = $this-&gt;rsEccLength($spec);&nbsp;</div></li><li><div>    $this-&gt;ecccode = array_fill(0, $this-&gt;eccLength, 0);&nbsp;</div></li><li><div>    $this-&gt;blocks = $this-&gt;rsBlockNum($spec);&nbsp;</div></li><li><div>    $ret = $this-&gt;init($spec);&nbsp;</div></li><li><div>    if ($ret &lt; 0) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;count = 0;&nbsp;</div></li><li><div>    $this-&gt;width = $this-&gt;getWidth($this-&gt;version);&nbsp;</div></li><li><div>    $this-&gt;frame = $this-&gt;newFrame($this-&gt;version);&nbsp;</div></li><li><div>    $this-&gt;x = $this-&gt;width - 1;&nbsp;</div></li><li><div>    $this-&gt;y = $this-&gt;width - 1;&nbsp;</div></li><li><div>    $this-&gt;dir = -1;&nbsp;</div></li><li><div>    $this-&gt;bit = -1;&nbsp;</div></li><li><div>    // inteleaved data and ecc codes&nbsp;</div></li><li><div>    for ($i=0; $i &lt; ($this-&gt;dataLength + $this-&gt;eccLength); $i++) {&nbsp;</div></li><li><div>        $code = $this-&gt;getCode();&nbsp;</div></li><li><div>        $bit = 0x80;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>            $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>            $this-&gt;setFrameAt($addr, 0x02 | (($bit & $code) != 0));&nbsp;</div></li><li><div>            $bit = $bit &gt;&gt; 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // remainder bits&nbsp;</div></li><li><div>    $j = $this-&gt;getRemainder($this-&gt;version);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$j; $i++) {&nbsp;</div></li><li><div>        $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>        $this-&gt;setFrameAt($addr, 0x02);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // masking&nbsp;</div></li><li><div>    $this-&gt;runLength = array_fill(0, QRSPEC_WIDTH_MAX + 1, 0);&nbsp;</div></li><li><div>    if ($mask &lt; 0) {&nbsp;</div></li><li><div>        if (QR_FIND_BEST_MASK) {&nbsp;</div></li><li><div>            $masked = $this-&gt;mask($this-&gt;width, $this-&gt;frame, $this-&gt;level);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, (intval(QR_DEFAULT_MASK) % 8), $this-&gt;level);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, $mask, $this-&gt;level);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($masked == NULL) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;data = $masked;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// FrameFiller&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Set frame value at specified position&nbsp;</div></li><li><div> * @param $at (array) x, y position&nbsp;</div></li><li><div> * @param $val (int) value of the character to set&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function setFrameAt($at, $val) {&nbsp;</div></li><li><div>    $this-&gt;frame[$at['y']][$at['x']] = chr($val);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Get frame value at specified position&nbsp;</div></li><li><div> * @param $at (array) x, y position&nbsp;</div></li><li><div> * @return value at specified position&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getFrameAt($at) {&nbsp;</div></li><li><div>    return ord($this-&gt;frame[$at['y']][$at['x']]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the next frame position&nbsp;</div></li><li><div> * @return array of x, y coordinates&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getNextPosition() {&nbsp;</div></li><li><div>    do {&nbsp;</div></li><li><div>        if ($this-&gt;bit == -1) {&nbsp;</div></li><li><div>            $this-&gt;bit = 0;&nbsp;</div></li><li><div>            return array('x'=&gt;$this-&gt;x, 'y'=&gt;$this-&gt;y);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $x = $this-&gt;x;&nbsp;</div></li><li><div>        $y = $this-&gt;y;&nbsp;</div></li><li><div>        $w = $this-&gt;width;&nbsp;</div></li><li><div>        if ($this-&gt;bit == 0) {&nbsp;</div></li><li><div>            $x--;&nbsp;</div></li><li><div>            $this-&gt;bit++;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $x++;&nbsp;</div></li><li><div>            $y += $this-&gt;dir;&nbsp;</div></li><li><div>            $this-&gt;bit--;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($this-&gt;dir &lt; 0) {&nbsp;</div></li><li><div>            if ($y &lt; 0) {&nbsp;</div></li><li><div>                $y = 0;&nbsp;</div></li><li><div>                $x -= 2;&nbsp;</div></li><li><div>                $this-&gt;dir = 1;&nbsp;</div></li><li><div>                if ($x == 6) {&nbsp;</div></li><li><div>                    $x--;&nbsp;</div></li><li><div>                    $y = 9;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ($y == $w) {&nbsp;</div></li><li><div>                $y = $w - 1;&nbsp;</div></li><li><div>                $x -= 2;&nbsp;</div></li><li><div>                $this-&gt;dir = -1;&nbsp;</div></li><li><div>                if ($x == 6) {&nbsp;</div></li><li><div>                    $x--;&nbsp;</div></li><li><div>                    $y -= 8;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (($x &lt; 0) OR ($y &lt; 0)) {&nbsp;</div></li><li><div>            return NULL;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;x = $x;&nbsp;</div></li><li><div>        $this-&gt;y = $y;&nbsp;</div></li><li><div>    } while(ord($this-&gt;frame[$y][$x]) & 0x80);&nbsp;</div></li><li><div>    return array('x'=&gt;$x, 'y'=&gt;$y);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrawcode&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize code.&nbsp;</div></li><li><div> * @param $spec (array) array of ECC specification&nbsp;</div></li><li><div> * @return 0 in case of success, -1 in case of error&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function init($spec) {&nbsp;</div></li><li><div>    $dl = $this-&gt;rsDataCodes1($spec);&nbsp;</div></li><li><div>    $el = $this-&gt;rsEccCodes1($spec);&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>    $blockNo = 0;&nbsp;</div></li><li><div>    $dataPos = 0;&nbsp;</div></li><li><div>    $eccPos = 0;&nbsp;</div></li><li><div>    $endfor = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>        $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>        $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>        $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>        $dataPos += $dl;&nbsp;</div></li><li><div>        $eccPos += $el;&nbsp;</div></li><li><div>        $blockNo++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($this-&gt;rsBlockNum2($spec) == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $dl = $this-&gt;rsDataCodes2($spec);&nbsp;</div></li><li><div>    $el = $this-&gt;rsEccCodes2($spec);&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>    if ($rs == NULL) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $endfor = $this-&gt;rsBlockNum2($spec);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>        $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>        $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>        $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>        $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>        $dataPos += $dl;&nbsp;</div></li><li><div>        $eccPos += $el;&nbsp;</div></li><li><div>        $blockNo++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return Reed-Solomon block code.&nbsp;</div></li><li><div> * @return array rsblocks&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getCode() {&nbsp;</div></li><li><div>    if ($this-&gt;count &lt; $this-&gt;dataLength) {&nbsp;</div></li><li><div>        $row = $this-&gt;count % $this-&gt;blocks;&nbsp;</div></li><li><div>        $col = $this-&gt;count / $this-&gt;blocks;&nbsp;</div></li><li><div>        if ($col &gt;= $this-&gt;rsblocks[0]['dataLength']) {&nbsp;</div></li><li><div>            $row += $this-&gt;b1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $ret = $this-&gt;rsblocks[$row]['data'][$col];&nbsp;</div></li><li><div>    } elseif ($this-&gt;count &lt; $this-&gt;dataLength + $this-&gt;eccLength) {&nbsp;</div></li><li><div>        $row = ($this-&gt;count - $this-&gt;dataLength) % $this-&gt;blocks;&nbsp;</div></li><li><div>        $col = ($this-&gt;count - $this-&gt;dataLength) / $this-&gt;blocks;&nbsp;</div></li><li><div>        $ret = $this-&gt;rsblocks[$row]['ecc'][$col];&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;count++;&nbsp;</div></li><li><div>    return $ret;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRmask&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Write Format Information on frame and returns the number of black bits&nbsp;</div></li><li><div> * @param $width (int) frame width&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $mask (array) masking mode&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int blacks&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function writeFormatInformation($width, &$frame, $mask, $level) {&nbsp;</div></li><li><div>    $blacks = 0;&nbsp;</div></li><li><div>    $format =  $this-&gt;getFormatInfo($mask, $level);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;8; ++$i) {&nbsp;</div></li><li><div>        if ($format & 1) {&nbsp;</div></li><li><div>            $blacks += 2;&nbsp;</div></li><li><div>            $v = 0x85;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $v = 0x84;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $frame[8][$width - 1 - $i] = chr($v);&nbsp;</div></li><li><div>        if ($i &lt; 6) {&nbsp;</div></li><li><div>            $frame[$i][8] = chr($v);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $frame[$i + 1][8] = chr($v);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($i=0; $i&lt;7; ++$i) {&nbsp;</div></li><li><div>    if ($format & 1) {&nbsp;</div></li><li><div>        $blacks += 2;&nbsp;</div></li><li><div>        $v = 0x85;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $v = 0x84;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $frame[$width - 7 + $i][8] = chr($v);&nbsp;</div></li><li><div>    if ($i == 0) {&nbsp;</div></li><li><div>        $frame[8][7] = chr($v);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $frame[8][6 - $i] = chr($v);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $blacks;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask0&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask0($x, $y) {&nbsp;</div></li><li><div>    return ($x + $y) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask1&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask1($x, $y) {&nbsp;</div></li><li><div>    return ($y & 1);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask2&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask2($x, $y) {&nbsp;</div></li><li><div>    return ($x % 3);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask3&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask3($x, $y) {&nbsp;</div></li><li><div>    return ($x + $y) % 3;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask4&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask4($x, $y) {&nbsp;</div></li><li><div>    return (((int)($y / 2)) + ((int)($x / 3))) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask5&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask5($x, $y) {&nbsp;</div></li><li><div>    return (($x * $y) & 1) + ($x * $y) % 3;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask6&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask6($x, $y) {&nbsp;</div></li><li><div>    return ((($x * $y) & 1) + ($x * $y) % 3) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask7&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @return int mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask7($x, $y) {&nbsp;</div></li><li><div>    return ((($x * $y) % 3) + (($x + $y) & 1)) & 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return bitmask&nbsp;</div></li><li><div> * @param $maskNo (int) mask number&nbsp;</div></li><li><div> * @param $width (int) width&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @return array bitmask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function generateMaskNo($maskNo, $width, $frame) {&nbsp;</div></li><li><div>    $bitMask = array_fill(0, $width, array_fill(0, $width, 0));&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if (ord($frame[$y][$x]) & 0x80) {&nbsp;</div></li><li><div>                $bitMask[$y][$x] = 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $maskFunc = call_user_func(array($this, 'mask'.$maskNo), $x, $y);&nbsp;</div></li><li><div>                $bitMask[$y][$x] = ($maskFunc == 0)?1:0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bitMask;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * makeMaskNo&nbsp;</div></li><li><div> * @param $maskNo (int)&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $s (int)&nbsp;</div></li><li><div> * @param $d (int)&nbsp;</div></li><li><div> * @param $maskGenOnly (boolean)&nbsp;</div></li><li><div> * @return int b&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function makeMaskNo($maskNo, $width, $s, &$d, $maskGenOnly=false) {&nbsp;</div></li><li><div>    $b = 0;&nbsp;</div></li><li><div>    $bitMask = array();&nbsp;</div></li><li><div>    $bitMask = $this-&gt;generateMaskNo($maskNo, $width, $s, $d);&nbsp;</div></li><li><div>    if ($maskGenOnly) {&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $d = $s;&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if ($bitMask[$y][$x] == 1) {&nbsp;</div></li><li><div>                $d[$y][$x] = chr(ord($s[$y][$x]) ^ ((int)($bitMask[$y][$x])));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $b += (int)(ord($d[$y][$x]) & 1);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $b;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * makeMask&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @param $maskNo (int)&nbsp;</div></li><li><div> * @param $level (int)&nbsp;</div></li><li><div> * @return array mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function makeMask($width, $frame, $maskNo, $level) {&nbsp;</div></li><li><div>    $masked = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>    $this-&gt;makeMaskNo($maskNo, $width, $frame, $masked);&nbsp;</div></li><li><div>    $this-&gt;writeFormatInformation($width, $masked, $maskNo, $level);&nbsp;</div></li><li><div>    return $masked;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * calcN1N3&nbsp;</div></li><li><div> * @param $length (int)&nbsp;</div></li><li><div> * @return int demerit&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function calcN1N3($length) {&nbsp;</div></li><li><div>    $demerit = 0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$length; ++$i) {&nbsp;</div></li><li><div>        if ($this-&gt;runLength[$i] &gt;= 5) {&nbsp;</div></li><li><div>            $demerit += (N1 + ($this-&gt;runLength[$i] - 5));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($i & 1) {&nbsp;</div></li><li><div>            if (($i &gt;= 3) AND ($i &lt; ($length-2)) AND ($this-&gt;runLength[$i] % 3 == 0)) {&nbsp;</div></li><li><div>                $fact = (int)($this-&gt;runLength[$i] / 3);&nbsp;</div></li><li><div>                if (($this-&gt;runLength[$i-2] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i-1] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i+1] == $fact)&nbsp;</div></li><li><div>                    AND ($this-&gt;runLength[$i+2] == $fact)) {&nbsp;</div></li><li><div>                    if (($this-&gt;runLength[$i-3] &lt; 0) OR ($this-&gt;runLength[$i-3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                        $demerit += N3;&nbsp;</div></li><li><div>                    } elseif ((($i+3) &gt;= $length) OR ($this-&gt;runLength[$i+3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                        $demerit += N3;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $demerit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * evaluateSymbol&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @return int demerit&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function evaluateSymbol($width, $frame) {&nbsp;</div></li><li><div>    $head = 0;&nbsp;</div></li><li><div>    $demerit = 0;&nbsp;</div></li><li><div>    for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>        $head = 0;&nbsp;</div></li><li><div>        $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>        $frameY = $frame[$y];&nbsp;</div></li><li><div>        if ($y &gt; 0) {&nbsp;</div></li><li><div>            $frameYM = $frame[$y-1];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>            if (($x &gt; 0) AND ($y &gt; 0)) {&nbsp;</div></li><li><div>                $b22 = ord($frameY[$x]) & ord($frameY[$x-1]) & ord($frameYM[$x]) & ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                $w22 = ord($frameY[$x]) | ord($frameY[$x-1]) | ord($frameYM[$x]) | ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                if (($b22 | ($w22 ^ 1)) & 1) {&nbsp;</div></li><li><div>                    $demerit += N2;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (($x == 0) AND (ord($frameY[$x]) & 1)) {&nbsp;</div></li><li><div>                $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                $head = 1;&nbsp;</div></li><li><div>                $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>            } elseif ($x &gt; 0) {&nbsp;</div></li><li><div>                if ((ord($frameY[$x]) ^ ord($frameY[$x-1])) & 1) {&nbsp;</div></li><li><div>                    $head++;&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>        $head = 0;&nbsp;</div></li><li><div>        $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>        for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>            if (($y == 0) AND (ord($frame[$y][$x]) & 1)) {&nbsp;</div></li><li><div>                $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                $head = 1;&nbsp;</div></li><li><div>                $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>            } elseif ($y &gt; 0) {&nbsp;</div></li><li><div>                if ((ord($frame[$y][$x]) ^ ord($frame[$y-1][$x])) & 1) {&nbsp;</div></li><li><div>                    $head++;&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $demerit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mask&nbsp;</div></li><li><div> * @param $width (int)&nbsp;</div></li><li><div> * @param $frame (array)&nbsp;</div></li><li><div> * @param $level (int)&nbsp;</div></li><li><div> * @return array best mask&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mask($width, $frame, $level) {&nbsp;</div></li><li><div>    $minDemerit = PHP_INT_MAX;&nbsp;</div></li><li><div>    $bestMaskNum = 0;&nbsp;</div></li><li><div>    $bestMask = array();&nbsp;</div></li><li><div>    $checked_masks = array(0, 1, 2, 3, 4, 5, 6, 7);&nbsp;</div></li><li><div>    if (QR_FIND_FROM_RANDOM !== false) {&nbsp;</div></li><li><div>        $howManuOut = 8 - (QR_FIND_FROM_RANDOM % 9);&nbsp;</div></li><li><div>        for ($i = 0; $i &lt;  $howManuOut; ++$i) {&nbsp;</div></li><li><div>            $remPos = rand (0, count($checked_masks)-1);&nbsp;</div></li><li><div>            unset($checked_masks[$remPos]);&nbsp;</div></li><li><div>            $checked_masks = array_values($checked_masks);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bestMask = $frame;&nbsp;</div></li><li><div>    foreach ($checked_masks as $i) {&nbsp;</div></li><li><div>        $mask = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>        $demerit = 0;&nbsp;</div></li><li><div>        $blacks = 0;&nbsp;</div></li><li><div>        $blacks = $this-&gt;makeMaskNo($i, $width, $frame, $mask);&nbsp;</div></li><li><div>        $blacks += $this-&gt;writeFormatInformation($width, $mask, $i, $level);&nbsp;</div></li><li><div>        $blacks = (int)(100 * $blacks / ($width * $width));&nbsp;</div></li><li><div>        $demerit = (int)((int)(abs($blacks - 50) / 5) * N4);&nbsp;</div></li><li><div>        $demerit += $this-&gt;evaluateSymbol($width, $mask);&nbsp;</div></li><li><div>        if ($demerit &lt; $minDemerit) {&nbsp;</div></li><li><div>            $minDemerit = $demerit;&nbsp;</div></li><li><div>            $bestMask = $mask;&nbsp;</div></li><li><div>            $bestMaskNum = $i;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bestMask;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRsplit&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return true if the character at specified position is a number&nbsp;</div></li><li><div> * @param $str (string) string&nbsp;</div></li><li><div> * @param $pos (int) characted position&nbsp;</div></li><li><div> * @return boolean true of false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function isdigitat($str, $pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return ((ord($str[$pos]) &gt;= ord('0'))&&(ord($str[$pos]) &lt;= ord('9')));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return true if the character at specified position is an alphanumeric character&nbsp;</div></li><li><div> * @param $str (string) string&nbsp;</div></li><li><div> * @param $pos (int) characted position&nbsp;</div></li><li><div> * @return boolean true of false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function isalnumat($str, $pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return ($this-&gt;lookAnTable(ord($str[$pos])) &gt;= 0);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * identifyMode&nbsp;</div></li><li><div> * @param $pos (int)&nbsp;</div></li><li><div> * @return int mode&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function identifyMode($pos) {&nbsp;</div></li><li><div>    if ($pos &gt;= strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>        return QR_MODE_NL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $c = $this-&gt;dataStr[$pos];&nbsp;</div></li><li><div>    if ($this-&gt;isdigitat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>        return QR_MODE_NM;&nbsp;</div></li><li><div>    } elseif ($this-&gt;isalnumat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>        return QR_MODE_AN;&nbsp;</div></li><li><div>    } elseif ($this-&gt;hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>        if ($pos+1 &lt; strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>            $d = $this-&gt;dataStr[$pos+1];&nbsp;</div></li><li><div>            $word = (ord($c) &lt;&lt; 8) | ord($d);&nbsp;</div></li><li><div>            if (($word &gt;= 0x8140 && $word &lt;= 0x9ffc) OR ($word &gt;= 0xe040 && $word &lt;= 0xebbf)) {&nbsp;</div></li><li><div>                return QR_MODE_KJ;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return QR_MODE_8B;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatNum&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatNum() {&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        $p++;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>    if ($mode == QR_MODE_8B) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsMode8(1)         // + 4 + l8&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsMode8($run + 1); // - 4 - l8&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eat8();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsModeAn(1)        // + 4 + la&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsModeAn($run + 1);// - 4 - la&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eatAn();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_NM, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatAn&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatAn() {&nbsp;</div></li><li><div>    $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p =1 ;&nbsp;</div></li><li><div>    while($this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        if ($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsModeAn($p) // + 4 + la&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsModeAn($q); // - 4 - la&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    if (!$this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>        $dif = $this-&gt;estimateBitsModeAn($run) + 4 + $la&nbsp;</div></li><li><div>        + $this-&gt;estimateBitsMode8(1) // + 4 + l8&nbsp;</div></li><li><div>        - $this-&gt;estimateBitsMode8($run + 1); // - 4 - l8&nbsp;</div></li><li><div>        if ($dif &gt; 0) {&nbsp;</div></li><li><div>            return $this-&gt;eat8();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_AN, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eatKanji&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eatKanji() {&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while($this-&gt;identifyMode($p) == QR_MODE_KJ) {&nbsp;</div></li><li><div>        $p += 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_KJ, $p, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * eat8&nbsp;</div></li><li><div> * @return int run&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function eat8() {&nbsp;</div></li><li><div>    $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>    $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>    $p = 1;&nbsp;</div></li><li><div>    $dataStrLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>    while($p &lt; $dataStrLen) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>        if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($mode == QR_MODE_NM) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsMode8($p) // + 4 + l8&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsMode8($q); // - 4 - l8&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>            $q = $p;&nbsp;</div></li><li><div>            while($this-&gt;isalnumat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                $q++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $dif = $this-&gt;estimateBitsMode8($p)  // + 4 + l8&nbsp;</div></li><li><div>            + $this-&gt;estimateBitsModeAn($q - $p) + 4 + $la&nbsp;</div></li><li><div>            - $this-&gt;estimateBitsMode8($q); // - 4 - l8&nbsp;</div></li><li><div>            if ($dif &lt; 0) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $p = $q;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $run = $p;&nbsp;</div></li><li><div>    $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_8B, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>    return $run;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * splitString&nbsp;</div></li><li><div> * @return (int)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function splitString() {&nbsp;</div></li><li><div>    while (strlen($this-&gt;dataStr) &gt; 0) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode(0);&nbsp;</div></li><li><div>        switch ($mode) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $length = $this-&gt;eatNum();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $length = $this-&gt;eatAn();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                if ($hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>                    $length = $this-&gt;eatKanji();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($length == 0) {&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($length &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;dataStr = substr($this-&gt;dataStr, $length);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * toUpper&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function toUpper() {&nbsp;</div></li><li><div>    $stringLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    while ($p &lt; $stringLen) {&nbsp;</div></li><li><div>        $mode = $this-&gt;identifyMode(substr($this-&gt;dataStr, $p), $this-&gt;hint);&nbsp;</div></li><li><div>        if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>            $p += 2;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ((ord($this-&gt;dataStr[$p]) &gt;= ord('a')) AND (ord($this-&gt;dataStr[$p]) &lt;= ord('z'))) {&nbsp;</div></li><li><div>                $this-&gt;dataStr[$p] = chr(ord($this-&gt;dataStr[$p]) - 32);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;dataStr;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRinputItem&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * newInputItem&nbsp;</div></li><li><div> * @param $mode (int)&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @param $bstream (array)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newInputItem($mode, $size, $data, $bstream=null) {&nbsp;</div></li><li><div>    $setData = array_slice($data, 0, $size);&nbsp;</div></li><li><div>    if (count($setData) &lt; $size) {&nbsp;</div></li><li><div>        $setData = array_merge($setData, array_fill(0, ($size - count($setData)), 0));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (!$this-&gt;check($mode, $size, $setData)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $inputitem = array();&nbsp;</div></li><li><div>    $inputitem['mode'] = $mode;&nbsp;</div></li><li><div>    $inputitem['size'] = $size;&nbsp;</div></li><li><div>    $inputitem['data'] = $setData;&nbsp;</div></li><li><div>    $inputitem['bstream'] = $bstream;&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeNum&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeNum($inputitem, $version) {&nbsp;</div></li><li><div>    $words = (int)($inputitem['size'] / 3);&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $val = 0x1;&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_NM, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$i*3 ]) - ord('0')) * 100;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$i*3+1]) - ord('0')) * 10;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$i*3+2]) - ord('0'));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 10, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($inputitem['size'] - $words * 3 == 1) {&nbsp;</div></li><li><div>        $val = ord($inputitem['data'][$words*3]) - ord('0');&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>    } elseif (($inputitem['size'] - ($words * 3)) == 2) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$words*3 ]) - ord('0')) * 10;&nbsp;</div></li><li><div>        $val += (ord($inputitem['data'][$words*3+1]) - ord('0'));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 7, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeAn&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeAn($inputitem, $version) {&nbsp;</div></li><li><div>    $words = (int)($inputitem['size'] / 2);&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x02);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_AN, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>        $val = (int)($this-&gt;lookAnTable(ord($inputitem['data'][$i*2])) * 45);&nbsp;</div></li><li><div>        $val += (int)($this-&gt;lookAnTable(ord($inputitem['data'][($i*2)+1])));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 11, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($inputitem['size'] & 1) {&nbsp;</div></li><li><div>        $val = $this-&gt;lookAnTable(ord($inputitem['data'][($words * 2)]));&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 6, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeMode8&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeMode8($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x4);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_8B, $version), $inputitem['size']);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; $inputitem['size']; ++$i) {&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][$i]));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeKanji&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeKanji($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x8);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_KJ, $version), (int)($inputitem['size'] / 2));&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$inputitem['size']; $i+=2) {&nbsp;</div></li><li><div>        $val = (ord($inputitem['data'][$i]) &lt;&lt; 8) | ord($inputitem['data'][$i+1]);&nbsp;</div></li><li><div>        if ($val &lt;= 0x9ffc) {&nbsp;</div></li><li><div>            $val -= 0x8140;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $val -= 0xc140;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $h = ($val &gt;&gt; 8) * 0xc0;&nbsp;</div></li><li><div>        $val = ($val & 0xff) + $h;&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 13, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeModeStructure&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeModeStructure($inputitem) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x03);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][1]) - 1);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][0]) - 1);&nbsp;</div></li><li><div>    $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][2]));&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * encodeBitStream&nbsp;</div></li><li><div> * @param $inputitem (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return array input item&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encodeBitStream($inputitem, $version) {&nbsp;</div></li><li><div>    $inputitem['bstream'] = array();&nbsp;</div></li><li><div>    $words = $this-&gt;maximumWords($inputitem['mode'], $version);&nbsp;</div></li><li><div>    if ($inputitem['size'] &gt; $words) {&nbsp;</div></li><li><div>        $st1 = $this-&gt;newInputItem($inputitem['mode'], $words, $inputitem['data']);&nbsp;</div></li><li><div>        $st2 = $this-&gt;newInputItem($inputitem['mode'], $inputitem['size'] - $words, array_slice($inputitem['data'], $words));&nbsp;</div></li><li><div>        $st1 = $this-&gt;encodeBitStream($st1, $version);&nbsp;</div></li><li><div>        $st2 = $this-&gt;encodeBitStream($st2, $version);&nbsp;</div></li><li><div>        $inputitem['bstream'] = array();&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st1['bstream']);&nbsp;</div></li><li><div>        $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st2['bstream']);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        switch($inputitem['mode']) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeNum($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeAn($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_8B: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeMode8($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeKanji($inputitem, $version);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_ST: {&nbsp;</div></li><li><div>                $inputitem = $this-&gt;encodeModeStructure($inputitem);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $inputitem;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRinput&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append data to an input object.&nbsp;</div></li><li><div> * The data is copied and appended to the input object.&nbsp;</div></li><li><div> * @param $items (arrray) input items&nbsp;</div></li><li><div> * @param $mode (int) encoding mode.&nbsp;</div></li><li><div> * @param $size (int) size of data (byte).&nbsp;</div></li><li><div> * @param $data (array) array of input data.&nbsp;</div></li><li><div> * @return items&nbsp;</div></li><li><div> *&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function appendNewInputItem($items, $mode, $size, $data) {&nbsp;</div></li><li><div>    $newitem = $this-&gt;newInputItem($mode, $size, $data);&nbsp;</div></li><li><div>    if (!empty($newitem)) {&nbsp;</div></li><li><div>        $items[] = $newitem;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * insertStructuredAppendHeader&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $index (int)&nbsp;</div></li><li><div> * @param $parity (int)&nbsp;</div></li><li><div> * @return array items&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function insertStructuredAppendHeader($items, $size, $index, $parity) {&nbsp;</div></li><li><div>    if ($size &gt; MAX_STRUCTURED_SYMBOLS) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($index &lt;= 0) OR ($index &gt; MAX_STRUCTURED_SYMBOLS)) {&nbsp;</div></li><li><div>        return -1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $buf = array($size, $index, $parity);&nbsp;</div></li><li><div>    $entry = $this-&gt;newInputItem(QR_MODE_ST, 3, buf);&nbsp;</div></li><li><div>    array_unshift($items, $entry);&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * calcParity&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return int parity&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function calcParity($items) {&nbsp;</div></li><li><div>    $parity = 0;&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        if ($item['mode'] != QR_MODE_ST) {&nbsp;</div></li><li><div>            for ($i=$item['size']-1; $i&gt;=0; --$i) {&nbsp;</div></li><li><div>                $parity ^= $item['data'][$i];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $parity;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeNum&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeNum($size, $data) {&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        if ((ord($data[$i]) &lt; ord('0')) OR (ord($data[$i]) &gt; ord('9'))) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Look up the alphabet-numeric convesion table (see JIS X0510:2004, pp.19).&nbsp;</div></li><li><div> * @param $c (int) character value&nbsp;</div></li><li><div> * @return value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function lookAnTable($c) {&nbsp;</div></li><li><div>    return (($c &gt; 127)?-1:$this-&gt;anTable[$c]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeAn&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeAn($size, $data) {&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        if ($this-&gt;lookAnTable(ord($data[$i])) == -1) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeNum&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeNum($size) {&nbsp;</div></li><li><div>    $w = (int)($size / 3);&nbsp;</div></li><li><div>    $bits = ($w * 10);&nbsp;</div></li><li><div>    switch($size - ($w * 3)) {&nbsp;</div></li><li><div>        case 1: {&nbsp;</div></li><li><div>            $bits += 4;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case 2: {&nbsp;</div></li><li><div>            $bits += 7;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeAn&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeAn($size) {&nbsp;</div></li><li><div>    $bits = (int)($size * 5.5); // (size / 2 ) * 11&nbsp;</div></li><li><div>    if ($size & 1) {&nbsp;</div></li><li><div>        $bits += 6;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsMode8&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsMode8($size) {&nbsp;</div></li><li><div>    return (int)($size * 8);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitsModeKanji&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @return int number of bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitsModeKanji($size) {&nbsp;</div></li><li><div>    return (int)($size * 6.5); // (size / 2 ) * 13&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * checkModeKanji&nbsp;</div></li><li><div> * @param $size (int)&nbsp;</div></li><li><div> * @param $data (array)&nbsp;</div></li><li><div> * @return boolean true or false&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function checkModeKanji($size, $data) {&nbsp;</div></li><li><div>    if ($size & 1) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; $i+=2) {&nbsp;</div></li><li><div>        $val = (ord($data[$i]) &lt;&lt; 8) | ord($data[$i+1]);&nbsp;</div></li><li><div>        if (($val &lt; 0x8140) OR (($val &gt; 0x9ffc) AND ($val &lt; 0xe040)) OR ($val &gt; 0xebbf)) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Validate the input data.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode.&nbsp;</div></li><li><div> * @param $size (int) size of data (byte).&nbsp;</div></li><li><div> * @param $data (array) data to validate&nbsp;</div></li><li><div> * @return boolean true in case of valid data, false otherwise&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function check($mode, $size, $data) {&nbsp;</div></li><li><div>    if ($size &lt;= 0) {&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    switch($mode) {&nbsp;</div></li><li><div>        case QR_MODE_NM: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeNum($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_AN: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeAn($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_KJ: {&nbsp;</div></li><li><div>            return $this-&gt;checkModeKanji($size, $data);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_8B: {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_ST: {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        default: {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateBitStreamSize&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @return int bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateBitStreamSize($items, $version) {&nbsp;</div></li><li><div>    $bits = 0;&nbsp;</div></li><li><div>    if ($version == 0) {&nbsp;</div></li><li><div>        $version = 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        switch($item['mode']) {&nbsp;</div></li><li><div>            case QR_MODE_NM: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeNum($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_AN: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeAn($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_8B: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsMode8($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_KJ: {&nbsp;</div></li><li><div>                $bits = $this-&gt;estimateBitsModeKanji($item['size']);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            case QR_MODE_ST: {&nbsp;</div></li><li><div>                return STRUCTURE_HEADER_BITS;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            default: {&nbsp;</div></li><li><div>                return 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $l = $this-&gt;lengthIndicator($item['mode'], $version);&nbsp;</div></li><li><div>        $m = 1 &lt;&lt; $l;&nbsp;</div></li><li><div>        $num = (int)(($item['size'] + $m - 1) / $m);&nbsp;</div></li><li><div>        $bits += $num * (4 + $l);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bits;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * estimateVersion&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return int version&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function estimateVersion($items) {&nbsp;</div></li><li><div>    $version = 0;&nbsp;</div></li><li><div>    $prev = 0;&nbsp;</div></li><li><div>    do {&nbsp;</div></li><li><div>        $prev = $version;&nbsp;</div></li><li><div>        $bits = $this-&gt;estimateBitStreamSize($items, $prev);&nbsp;</div></li><li><div>        $version = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>        if ($version &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } while ($version &gt; $prev);&nbsp;</div></li><li><div>    return $version;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * lengthOfCode&nbsp;</div></li><li><div> * @param $mode (int)&nbsp;</div></li><li><div> * @param $version (int)&nbsp;</div></li><li><div> * @param $bits (int)&nbsp;</div></li><li><div> * @return int size&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function lengthOfCode($mode, $version, $bits) {&nbsp;</div></li><li><div>    $payload = $bits - 4 - $this-&gt;lengthIndicator($mode, $version);&nbsp;</div></li><li><div>    switch($mode) {&nbsp;</div></li><li><div>        case QR_MODE_NM: {&nbsp;</div></li><li><div>            $chunks = (int)($payload / 10);&nbsp;</div></li><li><div>            $remain = $payload - $chunks * 10;&nbsp;</div></li><li><div>            $size = $chunks * 3;&nbsp;</div></li><li><div>            if ($remain &gt;= 7) {&nbsp;</div></li><li><div>                $size += 2;&nbsp;</div></li><li><div>            } elseif ($remain &gt;= 4) {&nbsp;</div></li><li><div>                $size += 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_AN: {&nbsp;</div></li><li><div>            $chunks = (int)($payload / 11);&nbsp;</div></li><li><div>            $remain = $payload - $chunks * 11;&nbsp;</div></li><li><div>            $size = $chunks * 2;&nbsp;</div></li><li><div>            if ($remain &gt;= 6) {&nbsp;</div></li><li><div>                ++$size;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_8B: {&nbsp;</div></li><li><div>            $size = (int)($payload / 8);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_KJ: {&nbsp;</div></li><li><div>            $size = (int)(($payload / 13) * 2);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        case QR_MODE_ST: {&nbsp;</div></li><li><div>            $size = (int)($payload / 8);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        default: {&nbsp;</div></li><li><div>            $size = 0;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $maxsize = $this-&gt;maximumWords($mode, $version);&nbsp;</div></li><li><div>    if ($size &lt; 0) {&nbsp;</div></li><li><div>        $size = 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($size &gt; $maxsize) {&nbsp;</div></li><li><div>        $size = $maxsize;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $size;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * createBitStream&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return array of items and total bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function createBitStream($items) {&nbsp;</div></li><li><div>    $total = 0;&nbsp;</div></li><li><div>    foreach ($items as $key =&gt; $item) {&nbsp;</div></li><li><div>        $items[$key] = $this-&gt;encodeBitStream($item, $this-&gt;version);&nbsp;</div></li><li><div>        $bits = count($items[$key]['bstream']);&nbsp;</div></li><li><div>        $total += $bits;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return array($items, $total);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * convertData&nbsp;</div></li><li><div> * @param $items (array)&nbsp;</div></li><li><div> * @return array items&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function convertData($items) {&nbsp;</div></li><li><div>    $ver = $this-&gt;estimateVersion($items);&nbsp;</div></li><li><div>    if ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>        $this-&gt;version = $ver;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    while (true) {&nbsp;</div></li><li><div>        $cbs = $this-&gt;createBitStream($items);&nbsp;</div></li><li><div>        $items = $cbs[0];&nbsp;</div></li><li><div>        $bits = $cbs[1];&nbsp;</div></li><li><div>        if ($bits &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $ver = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>        if ($ver &lt; 0) {&nbsp;</div></li><li><div>            return -1;&nbsp;</div></li><li><div>        } elseif ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>            $this-&gt;version = $ver;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $items;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append Padding Bit to bitstream&nbsp;</div></li><li><div> * @param $bstream (array)&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendPaddingBit($bstream) {&nbsp;</div></li><li><div>     if (is_null($bstream)) {&nbsp;</div></li><li><div>         return null;&nbsp;</div></li><li><div>     }&nbsp;</div></li><li><div>    $bits = count($bstream);&nbsp;</div></li><li><div>    $maxwords = $this-&gt;getDataLength($this-&gt;version, $this-&gt;level);&nbsp;</div></li><li><div>    $maxbits = $maxwords * 8;&nbsp;</div></li><li><div>    if ($maxbits == $bits) {&nbsp;</div></li><li><div>        return $bstream;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($maxbits - $bits &lt; 5) {&nbsp;</div></li><li><div>        return $this-&gt;appendNum($bstream, $maxbits - $bits, 0);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bits += 4;&nbsp;</div></li><li><div>    $words = (int)(($bits + 7) / 8);&nbsp;</div></li><li><div>    $padding = array();&nbsp;</div></li><li><div>    $padding = $this-&gt;appendNum($padding, $words * 8 - $bits + 4, 0);&nbsp;</div></li><li><div>    $padlen = $maxwords - $words;&nbsp;</div></li><li><div>    if ($padlen &gt; 0) {&nbsp;</div></li><li><div>        $padbuf = array();&nbsp;</div></li><li><div>        for ($i=0; $i&lt;$padlen; ++$i) {&nbsp;</div></li><li><div>            $padbuf[$i] = ($i&1)?0x11:0xec;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $padding = $this-&gt;appendBytes($padding, $padlen, $padbuf);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bstream, $padding);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * mergeBitStream&nbsp;</div></li><li><div> * @param $items (array) items&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function mergeBitStream($items) {&nbsp;</div></li><li><div>    $items = $this-&gt;convertData($items);&nbsp;</div></li><li><div>    if (!is_array($items)) {&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bstream = array();&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>        $bstream = $this-&gt;appendBitstream($bstream, $item['bstream']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Returns a stream of bits.&nbsp;</div></li><li><div> * @param $items (int)&nbsp;</div></li><li><div> * @return array padded merged byte stream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getBitStream($items) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;mergeBitStream($items);&nbsp;</div></li><li><div>    return $this-&gt;appendPaddingBit($bstream);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Pack all bit streams padding bits into a byte array.&nbsp;</div></li><li><div> * @param $items (int)&nbsp;</div></li><li><div> * @return array padded merged byte stream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getByteStream($items) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;getBitStream($items);&nbsp;</div></li><li><div>    return $this-&gt;bitstreamToByte($bstream);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRbitstream&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return an array with zeros&nbsp;</div></li><li><div> * @param $setLength (int) array size&nbsp;</div></li><li><div> * @return array&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function allocate($setLength) {&nbsp;</div></li><li><div>    return array_fill(0, $setLength, 0);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return new bitstream from number&nbsp;</div></li><li><div> * @param $bits (int) number of bits&nbsp;</div></li><li><div> * @param $num (int) number&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newFromNum($bits, $num) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;allocate($bits);&nbsp;</div></li><li><div>    $mask = 1 &lt;&lt; ($bits - 1);&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$bits; ++$i) {&nbsp;</div></li><li><div>        if ($num & $mask) {&nbsp;</div></li><li><div>            $bstream[$i] = 1;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $bstream[$i] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return new bitstream from bytes&nbsp;</div></li><li><div> * @param $size (int) size&nbsp;</div></li><li><div> * @param $data (array) bytes&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function newFromBytes($size, $data) {&nbsp;</div></li><li><div>    $bstream = $this-&gt;allocate($size * 8);&nbsp;</div></li><li><div>    $p=0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>        $mask = 0x80;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; ++$j) {&nbsp;</div></li><li><div>            if ($data[$i] & $mask) {&nbsp;</div></li><li><div>                $bstream[$p] = 1;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $bstream[$p] = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>            $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $bstream;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $append (array) bitstream to append&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendBitstream($bitstream, $append) {&nbsp;</div></li><li><div>    if ((!is_array($append)) OR (count($append) == 0)) {&nbsp;</div></li><li><div>        return $bitstream;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (count($bitstream) == 0) {&nbsp;</div></li><li><div>        return $append;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return array_values(array_merge($bitstream, $append));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream created from number to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $bits (int) number of bits&nbsp;</div></li><li><div> * @param $num (int) number&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendNum($bitstream, $bits, $num) {&nbsp;</div></li><li><div>    if ($bits == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b = $this-&gt;newFromNum($bits, $num);&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Append one bitstream created from bytes to another&nbsp;</div></li><li><div> * @param $bitstream (array) original bitstream&nbsp;</div></li><li><div> * @param $size (int) size&nbsp;</div></li><li><div> * @param $data (array) bytes&nbsp;</div></li><li><div> * @return array bitstream&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function appendBytes($bitstream, $size, $data) {&nbsp;</div></li><li><div>    if ($size == 0) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b = $this-&gt;newFromBytes($size, $data);&nbsp;</div></li><li><div>    return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Convert bitstream to bytes&nbsp;</div></li><li><div> * @param $bstream (array) original bitstream&nbsp;</div></li><li><div> * @return array of bytes&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function bitstreamToByte($bstream) {&nbsp;</div></li><li><div>    if (is_null($bstream)) {&nbsp;</div></li><li><div>         return null;&nbsp;</div></li><li><div>     }&nbsp;</div></li><li><div>    $size = count($bstream);&nbsp;</div></li><li><div>    if ($size == 0) {&nbsp;</div></li><li><div>        return array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $data = array_fill(0, (int)(($size + 7) / 8), 0);&nbsp;</div></li><li><div>    $bytes = (int)($size / 8);&nbsp;</div></li><li><div>    $p = 0;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$bytes; $i++) {&nbsp;</div></li><li><div>        $v = 0;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>            $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>            $v |= $bstream[$p];&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data[$i] = $v;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($size & 7) {&nbsp;</div></li><li><div>        $v = 0;&nbsp;</div></li><li><div>        for ($j=0; $j&lt;($size & 7); $j++) {&nbsp;</div></li><li><div>            $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>            $v |= $bstream[$p];&nbsp;</div></li><li><div>            $p++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data[$bytes] = $v;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRspec&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Replace a value on the array at the specified position&nbsp;</div></li><li><div> * @param $srctab (array)&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @param $y (int) Y position&nbsp;</div></li><li><div> * @param $repl (string) value to replace&nbsp;</div></li><li><div> * @param $replLen (int) length of the repl string&nbsp;</div></li><li><div> * @return array srctab&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function qrstrset($srctab, $x, $y, $repl, $replLen=false) {&nbsp;</div></li><li><div>    $srctab[$y] = substr_replace($srctab[$y], ($replLen !== false)?substr($repl, 0, $replLen):$repl, $x, ($replLen !== false)?$replLen:strlen($repl));&nbsp;</div></li><li><div>    return $srctab;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return maximum data code length (bytes) for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int maximum size (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getDataLength($version, $level) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_WORDS] - $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return maximum error correction code length (bytes) for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int ECC size (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getECCLength($version, $level) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the width of the symbol for the version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int width&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getWidth($version) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the numer of remainder bits.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int number of remainder bits&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getRemainder($version) {&nbsp;</div></li><li><div>    return $this-&gt;capacity[$version][QRCAP_REMINDER];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return a version number that satisfies the input code length.&nbsp;</div></li><li><div> * @param $size (int) input code length (bytes)&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return int version number&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getMinimumVersion($size, $level) {&nbsp;</div></li><li><div>    for ($i = 1; $i &lt;= QRSPEC_VERSION_MAX; ++$i) {&nbsp;</div></li><li><div>        $words = ($this-&gt;capacity[$i][QRCAP_WORDS] - $this-&gt;capacity[$i][QRCAP_EC][$level]);&nbsp;</div></li><li><div>        if ($words &gt;= $size) {&nbsp;</div></li><li><div>            return $i;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // the size of input data is greater than QR capacity, try to lover the error correction mode&nbsp;</div></li><li><div>    return -1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the size of length indicator for the mode and version.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int the size of the appropriate length indicator (bits).&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function lengthIndicator($mode, $version) {&nbsp;</div></li><li><div>    if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($version &lt;= 9) {&nbsp;</div></li><li><div>        $l = 0;&nbsp;</div></li><li><div>    } elseif ($version &lt;= 26) {&nbsp;</div></li><li><div>        $l = 1;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $l = 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return the maximum length for the mode and version.&nbsp;</div></li><li><div> * @param $mode (int) encoding mode&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return int the maximum length (bytes)&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function maximumWords($mode, $version) {&nbsp;</div></li><li><div>    if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>        return 3;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($version &lt;= 9) {&nbsp;</div></li><li><div>        $l = 0;&nbsp;</div></li><li><div>    } else if ($version &lt;= 26) {&nbsp;</div></li><li><div>        $l = 1;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $l = 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $bits = $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>    $words = (1 &lt;&lt; $bits) - 1;&nbsp;</div></li><li><div>    if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>        $words *= 2; // the number of bytes is required&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $words;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return an array of ECC specification.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @param $spec (array) an array of ECC specification contains as following: {# of type1 blocks, # of data code, # of ecc code, # of type2 blocks, # of data code}&nbsp;</div></li><li><div> * @return array spec&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getEccSpec($version, $level, $spec) {&nbsp;</div></li><li><div>    if (count($spec) &lt; 5) {&nbsp;</div></li><li><div>        $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $b1 = $this-&gt;eccTable[$version][$level][0];&nbsp;</div></li><li><div>    $b2 = $this-&gt;eccTable[$version][$level][1];&nbsp;</div></li><li><div>    $data = $this-&gt;getDataLength($version, $level);&nbsp;</div></li><li><div>    $ecc = $this-&gt;getECCLength($version, $level);&nbsp;</div></li><li><div>    if ($b2 == 0) {&nbsp;</div></li><li><div>        $spec[0] = $b1;&nbsp;</div></li><li><div>        $spec[1] = (int)($data / $b1);&nbsp;</div></li><li><div>        $spec[2] = (int)($ecc / $b1);&nbsp;</div></li><li><div>        $spec[3] = 0;&nbsp;</div></li><li><div>        $spec[4] = 0;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $spec[0] = $b1;&nbsp;</div></li><li><div>        $spec[1] = (int)($data / ($b1 + $b2));&nbsp;</div></li><li><div>        $spec[2] = (int)($ecc  / ($b1 + $b2));&nbsp;</div></li><li><div>        $spec[3] = $b2;&nbsp;</div></li><li><div>        $spec[4] = $spec[1] + 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $spec;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put an alignment marker.&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $ox (int) X center coordinate of the pattern&nbsp;</div></li><li><div> * @param $oy (int) Y center coordinate of the pattern&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function putAlignmentMarker($frame, $ox, $oy) {&nbsp;</div></li><li><div>    $finder = array(&nbsp;</div></li><li><div>        &quot;\xa1\xa1\xa1\xa1\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa1\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>        &quot;\xa1\xa1\xa1\xa1\xa1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    $yStart = $oy - 2;&nbsp;</div></li><li><div>    $xStart = $ox - 2;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 5; $y++) {&nbsp;</div></li><li><div>        $frame = $this-&gt;qrstrset($frame, $xStart, $yStart+$y, $finder[$y]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put an alignment pattern.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $width (int) width&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function putAlignmentPattern($version, $frame, $width) {&nbsp;</div></li><li><div>    if ($version &lt; 2) {&nbsp;</div></li><li><div>        return $frame;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $d = $this-&gt;alignmentPattern[$version][1] - $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    if ($d &lt; 0) {&nbsp;</div></li><li><div>        $w = 2;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>        $w = (int)(($width - $this-&gt;alignmentPattern[$version][0]) / $d + 2);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($w * $w - 3 == 1) {&nbsp;</div></li><li><div>        $x = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        $y = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, $x, $y);&nbsp;</div></li><li><div>        return $frame;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    $wo = $w - 1;&nbsp;</div></li><li><div>    for ($x=1; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, 6, $cx);&nbsp;</div></li><li><div>        $frame = $this-&gt;putAlignmentMarker($frame, $cx, 6);&nbsp;</div></li><li><div>        $cx += $d;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $cy = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>    for ($y=0; $y &lt; $wo; ++$y) {&nbsp;</div></li><li><div>        $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>        for ($x=0; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>            $frame = $this-&gt;putAlignmentMarker($frame, $cx, $cy);&nbsp;</div></li><li><div>            $cx += $d;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cy += $d;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return BCH encoded version information pattern that is used for the symbol of version 7 or greater. Use lower 18 bits.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return BCH encoded version information pattern&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getVersionPattern($version) {&nbsp;</div></li><li><div>    if (($version &lt; 7) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;versionPattern[($version - 7)];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return BCH encoded format information pattern.&nbsp;</div></li><li><div> * @param $mask (array)&nbsp;</div></li><li><div> * @param $level (int) error correction level&nbsp;</div></li><li><div> * @return BCH encoded format information pattern&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function getFormatInfo($mask, $level) {&nbsp;</div></li><li><div>    if (($mask &lt; 0) OR ($mask &gt; 7)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($level &lt; 0) OR ($level &gt; 3)) {&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;formatInfo[$level][$mask];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Put a finder pattern.&nbsp;</div></li><li><div> * @param $frame (array) frame&nbsp;</div></li><li><div> * @param $ox (int) X center coordinate of the pattern&nbsp;</div></li><li><div> * @param $oy (int) Y center coordinate of the pattern&nbsp;</div></li><li><div> * @return array frame&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function putFinderPattern($frame, $ox, $oy) {&nbsp;</div></li><li><div>    $finder = array(&nbsp;</div></li><li><div>    &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>    &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 7; $y++) {&nbsp;</div></li><li><div>        $frame = $this-&gt;qrstrset($frame, $ox, ($oy + $y), $finder[$y]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return a copy of initialized frame.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return Array of unsigned char.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function createFrame($version) {&nbsp;</div></li><li><div>    $width = $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>    $frameLine = str_repeat (&quot;\0&quot;, $width);&nbsp;</div></li><li><div>    $frame = array_fill(0, $width, $frameLine);&nbsp;</div></li><li><div>    // Finder pattern&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, 0, 0);&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, $width - 7, 0);&nbsp;</div></li><li><div>    $frame = $this-&gt;putFinderPattern($frame, 0, $width - 7);&nbsp;</div></li><li><div>    // Separator&nbsp;</div></li><li><div>    $yOffset = $width - 7;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 7; ++$y) {&nbsp;</div></li><li><div>        $frame[$y][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        $frame[$y][$width - 8] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        $frame[$yOffset][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>        ++$yOffset;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $setPattern = str_repeat(&quot;\xc0&quot;, 8);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, 7, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, $width-8, 7, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, $width - 8, $setPattern);&nbsp;</div></li><li><div>    // Format info&nbsp;</div></li><li><div>    $setPattern = str_repeat(&quot;\x84&quot;, 9);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, 0, 8, $setPattern);&nbsp;</div></li><li><div>    $frame = $this-&gt;qrstrset($frame, $width - 8, 8, $setPattern, 8);&nbsp;</div></li><li><div>    $yOffset = $width - 8;&nbsp;</div></li><li><div>    for ($y=0; $y &lt; 8; ++$y, ++$yOffset) {&nbsp;</div></li><li><div>        $frame[$y][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>        $frame[$yOffset][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Timing pattern&nbsp;</div></li><li><div>    $wo = $width - 15;&nbsp;</div></li><li><div>    for ($i=1; $i &lt; $wo; ++$i) {&nbsp;</div></li><li><div>        $frame[6][7+$i] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>        $frame[7+$i][6] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Alignment pattern&nbsp;</div></li><li><div>    $frame = $this-&gt;putAlignmentPattern($version, $frame, $width);&nbsp;</div></li><li><div>    // Version information&nbsp;</div></li><li><div>    if ($version &gt;= 7) {&nbsp;</div></li><li><div>        $vinf = $this-&gt;getVersionPattern($version);&nbsp;</div></li><li><div>        $v = $vinf;&nbsp;</div></li><li><div>        for ($x=0; $x&lt;6; ++$x) {&nbsp;</div></li><li><div>            for ($y=0; $y&lt;3; ++$y) {&nbsp;</div></li><li><div>                $frame[($width - 11)+$y][$x] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $v = $vinf;&nbsp;</div></li><li><div>        for ($y=0; $y&lt;6; ++$y) {&nbsp;</div></li><li><div>            for ($x=0; $x&lt;3; ++$x) {&nbsp;</div></li><li><div>                $frame[$y][$x+($width - 11)] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // and a little bit...&nbsp;</div></li><li><div>    $frame[$width - 8][8] = &quot;\x81&quot;;&nbsp;</div></li><li><div>    return $frame;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Set new frame for the specified version.&nbsp;</div></li><li><div> * @param $version (int) version&nbsp;</div></li><li><div> * @return Array of unsigned char.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function newFrame($version) {&nbsp;</div></li><li><div>    if (($version &lt; 1) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (!isset($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>        $this-&gt;frames[$version] = $this-&gt;createFrame($version);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (is_null($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $this-&gt;frames[$version];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return block number 0&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum($spec) {&nbsp;</div></li><li><div>    return ($spec[0] + $spec[3]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div>* Return block number 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum1($spec) {&nbsp;</div></li><li><div>    return $spec[0];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data codes 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataCodes1($spec) {&nbsp;</div></li><li><div>    return $spec[1];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc codes 1&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccCodes1($spec) {&nbsp;</div></li><li><div>    return $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return block number 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsBlockNum2($spec) {&nbsp;</div></li><li><div>    return $spec[3];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data codes 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataCodes2($spec) {&nbsp;</div></li><li><div>    return $spec[4];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc codes 2&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccCodes2($spec) {&nbsp;</div></li><li><div>    return $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return data length&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsDataLength($spec) {&nbsp;</div></li><li><div>    return ($spec[0] * $spec[1]) + ($spec[3] * $spec[4]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Return ecc length&nbsp;</div></li><li><div> * @param $spec (array)&nbsp;</div></li><li><div> * @return int value&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function rsEccLength($spec) {&nbsp;</div></li><li><div>    return ($spec[0] + $spec[3]) * $spec[2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrs&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize a Reed-Solomon codec and add it to existing rsitems&nbsp;</div></li><li><div> * @param $symsize (int) symbol size, bits&nbsp;</div></li><li><div> * @param $gfpoly (int)  Field generator polynomial coefficients&nbsp;</div></li><li><div> * @param $fcr (int)  first root of RS code generator polynomial, index form&nbsp;</div></li><li><div> * @param $prim (int)  primitive element to generate polynomial roots&nbsp;</div></li><li><div> * @param $nroots (int) RS code generator polynomial degree (number of roots)&nbsp;</div></li><li><div> * @param $pad (int)  padding bytes at front of shortened block&nbsp;</div></li><li><div> * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function init_rs($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>    foreach ($this-&gt;rsitems as $rs) {&nbsp;</div></li><li><div>        if (($rs['pad'] != $pad) OR ($rs['nroots'] != $nroots) OR ($rs['mm'] != $symsize)&nbsp;</div></li><li><div>            OR ($rs['gfpoly'] != $gfpoly) OR ($rs['fcr'] != $fcr) OR ($rs['prim'] != $prim)) {&nbsp;</div></li><li><div>            continue;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs = $this-&gt;init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad);&nbsp;</div></li><li><div>    array_unshift($this-&gt;rsitems, $rs);&nbsp;</div></li><li><div>    return $rs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// QRrsItem&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * modnn&nbsp;</div></li><li><div> * @param $rs (array) RS values&nbsp;</div></li><li><div> * @param $x (int) X position&nbsp;</div></li><li><div> * @return int X osition&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function modnn($rs, $x) {&nbsp;</div></li><li><div>    while ($x &gt;= $rs['nn']) {&nbsp;</div></li><li><div>        $x -= $rs['nn'];&nbsp;</div></li><li><div>        $x = ($x &gt;&gt; $rs['mm']) + ($x & $rs['nn']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $x;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Initialize a Reed-Solomon codec and returns an array of values.&nbsp;</div></li><li><div> * @param $symsize (int) symbol size, bits&nbsp;</div></li><li><div> * @param $gfpoly (int)  Field generator polynomial coefficients&nbsp;</div></li><li><div> * @param $fcr (int)  first root of RS code generator polynomial, index form&nbsp;</div></li><li><div> * @param $prim (int)  primitive element to generate polynomial roots&nbsp;</div></li><li><div> * @param $nroots (int) RS code generator polynomial degree (number of roots)&nbsp;</div></li><li><div> * @param $pad (int)  padding bytes at front of shortened block&nbsp;</div></li><li><div> * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div>protected function init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>    // Based on Reed solomon encoder by Phil Karn, KA9Q (GNU-LGPLv2)&nbsp;</div></li><li><div>    $rs = null;&nbsp;</div></li><li><div>    // Check parameter ranges&nbsp;</div></li><li><div>    if (($symsize &lt; 0) OR ($symsize &gt; 8)) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($fcr &lt; 0) OR ($fcr &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($prim &lt;= 0) OR ($prim &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($nroots &lt; 0) OR ($nroots &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if (($pad &lt; 0) OR ($pad &gt;= ((1&lt;&lt;$symsize) -1 - $nroots))) {&nbsp;</div></li><li><div>        return $rs;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs = array();&nbsp;</div></li><li><div>    $rs['mm'] = $symsize;&nbsp;</div></li><li><div>    $rs['nn'] = (1 &lt;&lt; $symsize) - 1;&nbsp;</div></li><li><div>    $rs['pad'] = $pad;&nbsp;</div></li><li><div>    $rs['alpha_to'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>    $rs['index_of'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>    // PHP style macro replacement ;)&nbsp;</div></li><li><div>    $NN =& $rs['nn'];&nbsp;</div></li><li><div>    $A0 =& $NN;&nbsp;</div></li><li><div>    // Generate Galois field lookup tables&nbsp;</div></li><li><div>    $rs['index_of'][0] = $A0; // log(zero) = -inf&nbsp;</div></li><li><div>    $rs['alpha_to'][$A0] = 0; // alpha**-inf = 0&nbsp;</div></li><li><div>    $sr = 1;&nbsp;</div></li><li><div>    for ($i=0; $i&lt;$rs['nn']; ++$i) {&nbsp;</div></li><li><div>        $rs['index_of'][$sr] = $i;&nbsp;</div></li><li><div>        $rs['alpha_to'][$i] = $sr;&nbsp;</div></li><li><div>        $sr &lt;&lt;= 1;&nbsp;</div></li><li><div>        if ($sr & (1 &lt;&lt; $symsize)) {&nbsp;</div></li><li><div>            $sr ^= $gfpoly;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $sr &= $rs['nn'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    if ($sr != 1) {&nbsp;</div></li><li><div>        // field generator polynomial is not primitive!&nbsp;</div></li><li><div>        return NULL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Form RS code generator polynomial from its roots&nbsp;</div></li><li><div>    $rs['genpoly'] = array_fill(0, ($nroots + 1), 0);&nbsp;</div></li><li><div>    $rs['fcr'] = $fcr;&nbsp;</div></li><li><div>    $rs['prim'] = $prim;&nbsp;</div></li><li><div>    $rs['nroots'] = $nroots;&nbsp;</div></li><li><div>    $rs['gfpoly'] = $gfpoly;&nbsp;</div></li><li><div>    // Find prim-th root of 1, used in decoding&nbsp;</div></li><li><div>    for ($iprim=1; ($iprim % $prim) != 0; $iprim += $rs['nn']) {&nbsp;</div></li><li><div>        ; // intentional empty-body loop!&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $rs['iprim'] = (int)($iprim / $prim);&nbsp;</div></li><li><div>    $rs['genpoly'][0] = 1;&nbsp;</div></li><li><div>    for ($i = 0, $root=$fcr*$prim; $i &lt; $nroots; $i++, $root += $prim) {&nbsp;</div></li><li><div>        $rs['genpoly'][$i+1] = 1;&nbsp;</div></li><li><div>        // Multiply rs-&gt;genpoly[] by  @**(root + x)&nbsp;</div></li><li><div>        for ($j = $i; $j &gt; 0; --$j) {&nbsp;</div></li><li><div>            if ($rs['genpoly'][$j] != 0) {&nbsp;</div></li><li><div>                $rs['genpoly'][$j] = $rs['genpoly'][$j-1] ^ $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][$j]] + $root)];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $rs['genpoly'][$j] = $rs['genpoly'][$j-1];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // rs-&gt;genpoly[0] can never be zero&nbsp;</div></li><li><div>        $rs['genpoly'][0] = $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][0]] + $root)];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // convert rs-&gt;genpoly[] to index form for quicker encoding&nbsp;</div></li><li><div>    for ($i = 0; $i &lt;= $nroots; ++$i) {&nbsp;</div></li><li><div>        $rs['genpoly'][$i] = $rs['index_of'][$rs['genpoly'][$i]];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $rs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/**&nbsp;</div></li><li><div> * Encode a Reed-Solomon codec and returns the parity array&nbsp;</div></li><li><div> * @param $rs (array) RS values&nbsp;</div></li><li><div> * @param $data (array) data&nbsp;</div></li><li><div> * @param $parity (array) parity&nbsp;</div></li><li><div> * @return parity array&nbsp;</div></li><li><div> */&nbsp;</div></li><li><div> protected function encode_rs_char($rs, $data, $parity) {&nbsp;</div></li><li><div>    $MM =& $rs['mm']; // bits per symbol&nbsp;</div></li><li><div>    $NN =& $rs['nn']; // the total number of symbols in a RS block&nbsp;</div></li><li><div>    $ALPHA_TO =& $rs['alpha_to']; // the address of an array of NN elements to convert Galois field elements in index (log) form to polynomial form&nbsp;</div></li><li><div>    $INDEX_OF =& $rs['index_of']; // the address of an array of NN elements to convert Galois field elements in polynomial form to index (log) form&nbsp;</div></li><li><div>    $GENPOLY =& $rs['genpoly']; // an array of NROOTS+1 elements containing the generator polynomial in index form&nbsp;</div></li><li><div>    $NROOTS =& $rs['nroots']; // the number of roots in the RS code generator polynomial, which is the same as the number of parity symbols in a block&nbsp;</div></li><li><div>    $FCR =& $rs['fcr']; // first consecutive root, index form&nbsp;</div></li><li><div>    $PRIM =& $rs['prim']; // primitive element, index form&nbsp;</div></li><li><div>    $IPRIM =& $rs['iprim']; // prim-th root of 1, index form&nbsp;</div></li><li><div>    $PAD =& $rs['pad']; // the number of pad symbols in a block&nbsp;</div></li><li><div>    $A0 =& $NN;&nbsp;</div></li><li><div>    $parity = array_fill(0, $NROOTS, 0);&nbsp;</div></li><li><div>    for ($i=0; $i &lt; ($NN - $NROOTS - $PAD); $i++) {&nbsp;</div></li><li><div>        $feedback = $INDEX_OF[$data[$i] ^ $parity[0]];&nbsp;</div></li><li><div>        if ($feedback != $A0) {&nbsp;</div></li><li><div>            // feedback term is non-zero&nbsp;</div></li><li><div>            // This line is unnecessary when GENPOLY[NROOTS] is unity, as it must&nbsp;</div></li><li><div>            // always be for the polynomials constructed by init_rs()&nbsp;</div></li><li><div>            $feedback = $this-&gt;modnn($rs, $NN - $GENPOLY[$NROOTS] + $feedback);&nbsp;</div></li><li><div>            for ($j=1; $j &lt; $NROOTS; ++$j) {&nbsp;</div></li><li><div>            $parity[$j] ^= $ALPHA_TO[$this-&gt;modnn($rs, $feedback + $GENPOLY[($NROOTS - $j)])];&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce-products-designer/2.3/classes/qrcode/" class="active">2.3</a></li><li><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/classes/qrcode/" class="">2.2</a></li><li><a href="http://hookr.io/plugins/woocommerce-products-designer/2.1/classes/qrcode/" class="">2.1</a></li><li><a href="http://hookr.io/plugins/woocommerce-products-designer/2.0/classes/qrcode/" class="">2.0</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>QRcode</li><li><span></span>Woocommerce Products Designer</li><li><span></span>2.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>