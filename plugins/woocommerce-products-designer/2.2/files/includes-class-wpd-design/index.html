<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.2" data-slug="woocommerce-products-designer" data-type="file" data-id="64023"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-class-wpd-design | file | Woocommerce Products Designer | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-products-designer, 2.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=fb0244b5c7b4e1f7e3958d5983a766cb' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-class-wpd-design/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wpd-design%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wpd-design%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-products-designer-2.2-file-includes-class-wpd-design","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-class-wpd-design" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-products-designer." href="http://hookr.io/plugins/woocommerce-products-designer/" class="plugin"><span property="name">woocommerce-products-designer</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.2." href="http://hookr.io/plugins/woocommerce-products-designer/2.2/" class="H_VERSION"><span property="name">2.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-products-designer/2.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-class-wpd-design</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="104"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/all/" title="All">All <span class="count badge">104</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="4"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/hooks/" title="Hooks">Hooks <span class="count badge">4</span></a></li><li class="" data-id="action" data-count="4"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/actions/" title="Actions">Actions <span class="count badge">4</span></a></li><li class="" data-id="filter" data-count="0"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/filters/" title="Filters">Filters <span class="count badge">0</span></a></li><li class="" data-id="class" data-count="26"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/classes/" title="Classes">Classes <span class="count badge">26</span></a></li><li class="" data-id="constant" data-count="60"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/constants/" title="Constants">Constants <span class="count badge">60</span></a></li><li class="" data-id="function" data-count="11"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/functions/" title="Functions">Functions <span class="count badge">11</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/woocommerce-products-designer/2.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/class-wpd-design.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * To change this license header, choose License Headers in Project Properties.</span>&nbsp;</div></li><li><div><span class="comment"> * To change this template file, choose Tools | Templates</span>&nbsp;</div></li><li><div><span class="comment"> * and open the template in the editor.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Contains all methods and hooks callbacks related to the user design</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author HL</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WPD_Design {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function delete_saved_design_ajax() {&nbsp;</div></li><li><div>      $design_index = $_GET['design_index'];&nbsp;</div></li><li><div>      $variation_id = $_GET['variation_id'];&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>      $user_designs = get_user_meta($current_user-&gt;ID, 'wpc_saved_designs');&nbsp;</div></li><li><div>      unset($user_designs[$design_index]);&nbsp;</div></li><li><div>      delete_user_meta($current_user-&gt;ID, &quot;wpc_saved_designs&quot;);&nbsp;</div></li><li><div>      foreach ($user_designs as $index =&gt; $design) {&nbsp;</div></li><li><div>          $result = add_user_meta($current_user-&gt;ID, &quot;wpc_saved_designs&quot;, $design);&nbsp;</div></li><li><div>          if (!$result)&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $url = WPD_Product::get_url($variation_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode(array(&nbsp;</div></li><li><div>          &quot;success&quot; =&gt; $result, &nbsp;</div></li><li><div>          &quot;url&quot; =&gt; $url, &nbsp;</div></li><li><div>          &quot;message&quot; =&gt; __('An error occured. Please try again later', 'wpd')&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_custom_design_to_cart_ajax() {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      $cart_url = $woocommerce-&gt;cart-&gt;get_cart_url();&nbsp;</div></li><li><div>      $final_canvas_parts = $_POST[&quot;final_canvas_parts&quot;];&nbsp;</div></li><li><div>      $variation_id = $_POST[&quot;variation_id&quot;];&nbsp;</div></li><li><div>      $quantity = $_POST[&quot;quantity&quot;];&nbsp;</div></li><li><div>      $cart_item_key = $_POST[&quot;cart_item_key&quot;];&nbsp;</div></li><li><div>      $newly_added_cart_item_key = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tmp_dir = uniqid();&nbsp;</div></li><li><div>      $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>      $generation_path = $upload_dir[&quot;basedir&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>      $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>      if (wp_mkdir_p($generation_path)) {&nbsp;</div></li><li><div>          $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>          $zip_name = uniqid(&quot;wpc_&quot;) . &quot;.zip&quot;;&nbsp;</div></li><li><div>          $result = $this-&gt;export_data_to_files($generation_path, $final_canvas_parts, $variation_id, $zip_name);&nbsp;</div></li><li><div>          if (!empty($result) && is_array($result)) {&nbsp;</div></li><li><div>              $final_canvas_parts[&quot;output&quot;][&quot;files&quot;] = $result;&nbsp;</div></li><li><div>              $final_canvas_parts[&quot;output&quot;][&quot;working_dir&quot;] = $tmp_dir;&nbsp;</div></li><li><div>              $final_canvas_parts[&quot;output&quot;][&quot;zip&quot;] = $zip_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $newly_added_cart_item_key = true;&nbsp;</div></li><li><div>              if ($cart_item_key) {&nbsp;</div></li><li><div>                  $_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key] = $final_canvas_parts;&nbsp;</div></li><li><div>                  $message = &quot;&lt;div class='wpc_notification success f-right'&gt;&quot; . __(&quot;Item successfully updated.&quot;, &quot;wpd&quot;) . &quot; &lt;a href='$cart_url'&gt;&quot; . __(&quot;View Cart&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $variable_product = wc_get_product($variation_id);&nbsp;</div></li><li><div>                  $variation = array();&nbsp;</div></li><li><div>                  if ($variable_product-&gt;product_type == &quot;simple&quot;)&nbsp;</div></li><li><div>                      $product_id = $variation_id;&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>                      $variation = $variable_product-&gt;variation_data;&nbsp;</div></li><li><div>                      $product_id = $variable_product-&gt;parent-&gt;id;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $newly_added_cart_item_key = $woocommerce-&gt;cart-&gt;add_to_cart($product_id, $quantity, $variation_id, $variation, $final_canvas_parts);&nbsp;</div></li><li><div>                  if (method_exists($woocommerce-&gt;cart, &quot;maybe_set_cart_cookies&quot;))&nbsp;</div></li><li><div>                      $woocommerce-&gt;cart-&gt;maybe_set_cart_cookies();&nbsp;</div></li><li><div>                  if ($newly_added_cart_item_key) {&nbsp;</div></li><li><div>                      if (!isset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id]))&nbsp;</div></li><li><div>                          $_SESSION[&quot;wpc_generated_data&quot;][$variation_id] = array();&nbsp;</div></li><li><div>                      $_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$newly_added_cart_item_key] = $final_canvas_parts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $message = &quot;&lt;div class='wpc_notification success f-right'&gt;&quot; . __(&quot;Product successfully added to basket.&quot;, &quot;wpd&quot;) . &quot; &lt;a href='$cart_url'&gt;View Cart&lt;/a&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                  } else&nbsp;</div></li><li><div>                      $message = &quot;&lt;div class='wpc_notification failure f-right'&gt;&quot; . __(&quot;A problem occured. Please try again.&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else&nbsp;</div></li><li><div>              $message = &quot;&lt;div class='wpc_notification failure f-right'&gt;&quot; . __(&quot;A problem occured. Please try again.&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode(array(&quot;success&quot; =&gt; $newly_added_cart_item_key, &nbsp;</div></li><li><div>          &quot;message&quot; =&gt; $message, &nbsp;</div></li><li><div>          &quot;url&quot; =&gt; $cart_url&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  private function merge_pictures($base_layer, $top_layer, $final_img) {&nbsp;</div></li><li><div>      $base = imagecreatefrompng($base_layer);&nbsp;</div></li><li><div>      imagealphablending($base, true);&nbsp;</div></li><li><div>      list($base_w, $base_h, $type, $attr) = getimagesize($base_layer);&nbsp;</div></li><li><div>      $top = imagecreatefrompng($top_layer);         &nbsp;</div></li><li><div>      imagealphablending($top, true);&nbsp;</div></li><li><div>      list($top_w, $top_h, $type, $attr) = getimagesize($top_layer);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $src_x=($base_w-$top_w)/2;&nbsp;</div></li><li><div>      $src_y=($base_h-$top_h)/2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagecopyresampled($base, $top, $src_x, $src_y, 0, 0, $top_w, $top_h, $top_w, $top_h);&nbsp;</div></li><li><div>      imagedestroy($top);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagecolortransparent($base, imagecolorallocatealpha($base, 0, 0, 0, 127));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagealphablending($base, false);&nbsp;</div></li><li><div>      imagesavealpha($base, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagepng($base, $final_img);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function get_watermarked_preview()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $watermark=  get_attached_file($_POST[&quot;watermark&quot;]);&nbsp;</div></li><li><div>      $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>      $preview_filename=  uniqid(&quot;preview_&quot;).&quot;.png&quot;;&nbsp;</div></li><li><div>      $output_file_path = $upload_dir[&quot;basedir&quot;].&quot;/&quot;.$preview_filename;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(move_uploaded_file($_FILES[&quot;image&quot;]['tmp_name'], $output_file_path))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $url=$upload_dir[&quot;baseurl&quot;].&quot;/&quot;.$preview_filename;&nbsp;</div></li><li><div>          $this-&gt;merge_pictures($output_file_path, $watermark, $output_file_path);            &nbsp;</div></li><li><div>          echo json_encode(array(&quot;url&quot; =&gt;$url));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          echo &quot;&lt;div class='wpc_notification failure'&gt;&quot; . __(&quot;An error has occured. Please try again later or contact the administrator.&quot;, &quot;wpd&quot;);&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_custom_design_for_later_ajax() {&nbsp;</div></li><li><div>      $final_canvas_parts = $_POST[&quot;final_canvas_parts&quot;];&nbsp;</div></li><li><div>      $variation_id = $_POST[&quot;variation_id&quot;];&nbsp;</div></li><li><div>      $design_index = $_POST[&quot;design_index&quot;];&nbsp;</div></li><li><div>      $cart_item_key = &quot;&quot;;&nbsp;</div></li><li><div>      if (isset($_POST[&quot;cart_item_key&quot;]))&nbsp;</div></li><li><div>          $cart_item_key = $_POST[&quot;cart_item_key&quot;];&nbsp;</div></li><li><div>      $is_logged = 0;&nbsp;</div></li><li><div>      $result = 0;&nbsp;</div></li><li><div>      $message = &quot;&quot;;&nbsp;</div></li><li><div>      $customization_url = WPD_Product::get_url($variation_id);&nbsp;</div></li><li><div>      $url = wp_login_url($customization_url);&nbsp;</div></li><li><div>      if (is_user_logged_in()) {&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          get_currentuserinfo();&nbsp;</div></li><li><div>          $message = $current_user-&gt;ID;&nbsp;</div></li><li><div>          $is_logged = 1;&nbsp;</div></li><li><div>          $today = date(&quot;Y-m-d H:i:s&quot;);&nbsp;</div></li><li><div>          $tmp_dir = uniqid();&nbsp;</div></li><li><div>          $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>          $generation_path = $upload_dir[&quot;basedir&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>          $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>          if (wp_mkdir_p($generation_path)) {&nbsp;</div></li><li><div>              $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>              $zip_name = uniqid(&quot;wpc_&quot;) . &quot;.zip&quot;;&nbsp;</div></li><li><div>              $export_result = $this-&gt;export_data_to_files($generation_path, $final_canvas_parts, $variation_id, $zip_name);&nbsp;</div></li><li><div>              if (!empty($export_result) && is_array($export_result)) {&nbsp;</div></li><li><div>                  $final_canvas_parts[&quot;output&quot;][&quot;files&quot;] = $export_result;&nbsp;</div></li><li><div>                  $final_canvas_parts[&quot;output&quot;][&quot;working_dir&quot;] = $tmp_dir;&nbsp;</div></li><li><div>                  $final_canvas_parts[&quot;output&quot;][&quot;zip&quot;] = $zip_name;&nbsp;</div></li><li><div>                  $to_save = array($variation_id, $today, $final_canvas_parts);&nbsp;</div></li><li><div>                  $user_designs = get_user_meta($current_user-&gt;ID, 'wpc_saved_designs');&nbsp;</div></li><li><div>                  if ($design_index != -1) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $user_designs[$design_index] = $to_save;&nbsp;</div></li><li><div>                  } else&nbsp;</div></li><li><div>                      array_push($user_designs, $to_save);&nbsp;</div></li><li><div>                  delete_user_meta($current_user-&gt;ID, &quot;wpc_saved_designs&quot;);&nbsp;</div></li><li><div>                  foreach ($user_designs as $index =&gt; $design) {&nbsp;</div></li><li><div>                      $result = add_user_meta($current_user-&gt;ID, &quot;wpc_saved_designs&quot;, $design);&nbsp;</div></li><li><div>                      if (!$result)&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($result) {&nbsp;</div></li><li><div>                      $result = 1;&nbsp;</div></li><li><div>                      $message = &quot;&lt;div class='wpc_notification success'&gt;&quot; . __(&quot;The design has successfully been saved to your account.&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                      <span class="comment">//$user_designs=get_user_meta($current_user-&gt;ID, 'wpc_saved_designs');</span>&nbsp;</div></li><li><div>                      if ($design_index == -1)&nbsp;</div></li><li><div>                          $design_index = count($user_designs) - 1;&nbsp;</div></li><li><div>                      $url = WPD_Product::get_url($variation_id, $design_index);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>                      $result = 0;&nbsp;</div></li><li><div>                      $message = &quot;&lt;div class='wpc_notification failure'&gt;&quot; . __(&quot;An error has occured. Please try again later or contact the administrator.&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (!isset($_SESSION['wpc_designs_to_save']))&nbsp;</div></li><li><div>              $_SESSION['wpc_designs_to_save'] = array();&nbsp;</div></li><li><div>          if (!isset($_SESSION['wpc_designs_to_save'][$variation_id]))&nbsp;</div></li><li><div>              $_SESSION['wpc_designs_to_save'][$variation_id] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          array_push($_SESSION['wpc_designs_to_save'][$variation_id], $final_canvas_parts);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo json_encode(array(&quot;is_logged&quot; =&gt; $is_logged, &nbsp;</div></li><li><div>          &quot;success&quot; =&gt; $result, &nbsp;</div></li><li><div>          &quot;message&quot; =&gt; $message, &nbsp;</div></li><li><div>          &quot;url&quot; =&gt; $url&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_canvas_to_session_ajax() {&nbsp;</div></li><li><div>      $final_canvas_parts = $_POST[&quot;final_canvas_parts&quot;];&nbsp;</div></li><li><div>      $template_object = get_post_type_object(&quot;wpc-template&quot;);&nbsp;</div></li><li><div>      $can_manage_templates = current_user_can($template_object-&gt;cap-&gt;edit_posts);&nbsp;</div></li><li><div>      if ($can_manage_templates) {&nbsp;</div></li><li><div>          $_SESSION[&quot;to_save&quot;] = $final_canvas_parts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function generate_downloadable_file() {&nbsp;</div></li><li><div>      GLOBAL $wpc_options_settings;&nbsp;</div></li><li><div>      $wpc_output_options = $wpc_options_settings['wpc-output-options'];&nbsp;</div></li><li><div>      $final_canvas_parts = $_POST[&quot;final_canvas_parts&quot;];&nbsp;</div></li><li><div>      $tmp_dir = uniqid();&nbsp;</div></li><li><div>      $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>      $generation_path = $upload_dir[&quot;basedir&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>      $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>      $variation_id = $_POST[&quot;variation_id&quot;];&nbsp;</div></li><li><div>      if (isset($wpc_output_options['wpc-generate-zip']))&nbsp;</div></li><li><div>          $generate_zip = ($wpc_output_options['wpc-generate-zip'] === &quot;yes&quot;) ? true : false;&nbsp;</div></li><li><div>      if (wp_mkdir_p($generation_path)) {&nbsp;</div></li><li><div>          $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $zip_name = uniqid(&quot;wpc_&quot;) . &quot;.zip&quot;;&nbsp;</div></li><li><div>          $result = $this-&gt;export_data_to_files($generation_path, $final_canvas_parts, $variation_id, $zip_name, true);&nbsp;</div></li><li><div>          if (!empty($result) && is_array($result)) {&nbsp;</div></li><li><div>              $output_msg = &quot;&quot;;&nbsp;</div></li><li><div>              if ($generate_zip)&nbsp;</div></li><li><div>                  $output_msg = &quot;&lt;div&gt;&quot; . __(&quot;The generation has been successfully completed. Please click &quot;, &quot;wpd&quot;) . &quot;&lt;a href='$generation_url/&quot; . $zip_name . &quot;' download='&quot; . $zip_name . &quot;'&gt;&quot; . __(&quot;here&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot; . __(&quot;to download your design&quot;, &quot;wpd&quot;) . &quot;.&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>              else {&nbsp;</div></li><li><div>                  foreach ($result as $part_key =&gt; $part_file_arr) {&nbsp;</div></li><li><div>                      $part_file = $part_file_arr[&quot;preview&quot;];&nbsp;</div></li><li><div>                      if (strpos($part_file, &quot;.pdf&quot;))&nbsp;</div></li><li><div>                          $output_msg.=&quot;&lt;div&gt;&quot; . ucfirst($part_key) . __(&quot;: please click &quot;, &quot;wpd&quot;) . &quot;&lt;a href='$generation_url/$part_key/$part_key.pdf' class='print_pdf'&gt;&quot; . __(&quot;here&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot; . __(&quot;to download&quot;, &quot;wpd&quot;) . &quot;.&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                      else&nbsp;</div></li><li><div>                          $output_msg.=&quot;&lt;div&gt;&quot; . ucfirst($part_key) . __(&quot;: please click &quot;, &quot;wpd&quot;) . &quot;&lt;a href='$generation_url/$part_key/$part_file' download='$part_file'&gt;&quot; . __(&quot;here&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot; . __(&quot;to download&quot;, &quot;wpd&quot;) . &quot;.&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              echo json_encode(array(&nbsp;</div></li><li><div>                  &quot;success&quot; =&gt; 1, &nbsp;</div></li><li><div>                  &quot;message&quot; =&gt; &quot;&lt;div class='wpc-success'&gt;&quot; . $output_msg . &quot;&lt;/div&gt;&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else&nbsp;</div></li><li><div>              echo json_encode(array(&nbsp;</div></li><li><div>                  &quot;success&quot; =&gt; 0, &nbsp;</div></li><li><div>                  &quot;message&quot; =&gt; &quot;&lt;div class='wpc-failure'&gt;&quot; . __(&quot;An error occured in the generation process. Please try again later.&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else&nbsp;</div></li><li><div>          echo json_encode(array(&nbsp;</div></li><li><div>              &quot;success&quot; =&gt; 0, &nbsp;</div></li><li><div>              &quot;message&quot; =&gt; &quot;&lt;div class='wpc-failure'&gt;&quot; . __(&quot;Can't create a generation directory...&quot;, &quot;wpd&quot;) . &quot;&lt;/div&gt;&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_user_account_products_meta($output, $item) {&nbsp;</div></li><li><div>      GLOBAL $wpc_options_settings;&nbsp;</div></li><li><div>      $options = $wpc_options_settings['wpc-general-options'];&nbsp;</div></li><li><div>      $download_btn = WPD_Admin::get_proper_value($options, 'wpc-user-account-download-btn', &quot;&quot;);&nbsp;</div></li><li><div>      if ($download_btn !== &quot;0&quot; && isset($item[&quot;variation_id&quot;]) && (!empty($item[&quot;variation_id&quot;]) || $item[&quot;variation_id&quot;] == &quot;0&quot;)) {&nbsp;</div></li><li><div>          $product = wc_get_product($item[&quot;variation_id&quot;]);&nbsp;</div></li><li><div>          $item_id = uniqid();&nbsp;</div></li><li><div>          <span class="comment">//        var_dump($product);</span>&nbsp;</div></li><li><div>          ob_start();&nbsp;</div></li><li><div>          $this-&gt;get_order_custom_admin_data($product, $item, $item_id);&nbsp;</div></li><li><div>          $admin_data = ob_get_contents();&nbsp;</div></li><li><div>          ob_end_clean();&nbsp;</div></li><li><div>          $output.=$admin_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_customized_item_meta($item_id, $values, $cart_item_key) {&nbsp;</div></li><li><div>      $variation_id = $values[&quot;variation_id&quot;];&nbsp;</div></li><li><div>      if (isset($values[&quot;output&quot;])) {&nbsp;</div></li><li><div>          if (isset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key])) {&nbsp;</div></li><li><div>              wc_add_order_item_meta($item_id, 'wpc_data', $_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key]);&nbsp;</div></li><li><div>              unset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (empty($_SESSION[&quot;wpc_generated_data&quot;][$variation_id]))&nbsp;</div></li><li><div>              unset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (isset($_SESSION[&quot;wpc-uploaded-designs&quot;][$cart_item_key])) {&nbsp;</div></li><li><div>          wc_add_order_item_meta($item_id, 'wpc_data_upl', $_SESSION[&quot;wpc-uploaded-designs&quot;][$cart_item_key]);&nbsp;</div></li><li><div>          unset($_SESSION[&quot;wpc-uploaded-designs&quot;][$cart_item_key]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key]) && !empty($_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key])) {&nbsp;</div></li><li><div>          $wpc_design_pricing_options_data = $this-&gt;get_design_pricing_options_data($_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key]);&nbsp;</div></li><li><div>          wc_add_order_item_meta($item_id, '_wpc_design_pricing_options', $wpc_design_pricing_options_data);&nbsp;</div></li><li><div>          unset($_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_wpc_customization($cart_item_key) {&nbsp;</div></li><li><div>      foreach ($_SESSION[&quot;wpc_generated_data&quot;] as $variation_id =&gt; $variation_customizations) {&nbsp;</div></li><li><div>          if (isset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key])) {&nbsp;</div></li><li><div>              unset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id][$cart_item_key]);&nbsp;</div></li><li><div>              if (empty($_SESSION[&quot;wpc_generated_data&quot;][$variation_id]))&nbsp;</div></li><li><div>                  unset($_SESSION[&quot;wpc_generated_data&quot;][$variation_id]);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else if (isset($_SESSION[&quot;wpc-uploaded-designs&quot;]))&nbsp;</div></li><li><div>              unset($_SESSION[&quot;wpc-uploaded-designs&quot;][$cart_item_key]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_order_custom_admin_data($_product, $item, $item_id) {&nbsp;</div></li><li><div>      $output = &quot;&quot;;&nbsp;</div></li><li><div>      if (isset($item[&quot;wpc_data&quot;])) {&nbsp;</div></li><li><div>          $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>          foreach ($item[&quot;item_meta&quot;][&quot;wpc_data&quot;] as $s_index =&gt; $serialized_data) {&nbsp;</div></li><li><div>              $output.=&quot;&lt;div class='wpc_order_item' data-item='$item_id'&gt;&quot;;&nbsp;</div></li><li><div>              <span class="comment">//            $output.=get_variable_order_item_attributes($_product);</span>&nbsp;</div></li><li><div>              $unserialized_data = unserialize($serialized_data);&nbsp;</div></li><li><div><span class="comment">//                $old_version=false;</span>&nbsp;</div></li><li><div>              <span class="comment">//Previous version compatibility</span>&nbsp;</div></li><li><div><span class="comment">//                if(!isset($unserialized_data[&quot;output&quot;][&quot;files&quot;]))</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                {</span></span></span>&nbsp;</div></li><li><div><span class="comment">//                    $old_version=true;</span>&nbsp;</div></li><li><div><span class="comment">//                    $design_data=$unserialized_data;</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                else</span></span>&nbsp;</div></li><li><div>              $design_data = $unserialized_data[&quot;output&quot;][&quot;files&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (count($item[&quot;item_meta&quot;][&quot;wpc_data&quot;]) &gt; 1)&nbsp;</div></li><li><div>                  $output.=($s_index + 1) . &quot;-&quot;;&nbsp;</div></li><li><div>              foreach ($design_data as $data_key =&gt; $data) {&nbsp;</div></li><li><div><span class="comment">//                    if(!$old_version)</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                    {</span></span></span>&nbsp;</div></li><li><div>                  $tmp_dir = $unserialized_data[&quot;output&quot;][&quot;working_dir&quot;];&nbsp;</div></li><li><div>                  $generation_url = $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir/$data_key/&quot;;&nbsp;</div></li><li><div>                  if(is_admin())&nbsp;</div></li><li><div>                      $img_src = $generation_url . $data[&quot;image&quot;];&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      if(isset($data[&quot;preview&quot;]))&nbsp;</div></li><li><div>                          $img_src = $generation_url . $data[&quot;preview&quot;];&nbsp;</div></li><li><div>                      else&nbsp;</div></li><li><div>                          $img_src = $generation_url . $data[&quot;image&quot;];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                    }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                    else</span></span>&nbsp;</div></li><li><div><span class="comment">//                        $img_src=$data[&quot;image&quot;];</span>&nbsp;</div></li><li><div>                  $original_part_img_url = $unserialized_data[$data_key][&quot;original_part_img&quot;];&nbsp;</div></li><li><div>                  $modal_id = $s_index . &quot;_$item_id&quot; . &quot;_$data_key&quot;;&nbsp;</div></li><li><div>                  $output.='&lt;span&gt;&lt;a class=&quot;button&quot; data-toggle=&quot;modal&quot; data-target=&quot;#' . $modal_id . '&quot;&gt;' . ucfirst($data_key) . '&lt;/a&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>                  $output.='&lt;div class=&quot;modal fade wpc_part&quot; id=&quot;' . $modal_id . '&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot; aria-labelledby=&quot;myModalLabel&quot; aria-hidden=&quot;true&quot;&gt;&nbsp;</div></li><li><div>                              &lt;div class=&quot;modal-dialog&quot;&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;modal-content&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;div class=&quot;modal-header&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-hidden=&quot;true&quot;&gt;&times;&lt;/button&gt;&nbsp;</div></li><li><div>                                    &lt;h4 class=&quot;modal-title&quot; id=&quot;myModalLabel' . $modal_id . '&quot;&gt;Preview&lt;/h4&gt;&nbsp;</div></li><li><div>                                  &lt;/div&gt;&nbsp;</div></li><li><div>                                  &lt;div class=&quot;modal-body&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;div style=&quot;background-image:url(' . $original_part_img_url . ')&quot;&gt;&lt;img src=&quot;' . $img_src . '&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                  &lt;/div&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                              &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">//Deb</span>&nbsp;</div></li><li><div><span class="comment">//                if($old_version)</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                {</span></span></span>&nbsp;</div></li><li><div><span class="comment">//                    $zip_file=wc_get_order_item_meta( $item_id, &quot;wpc_data_zip&quot;, $single = true );</span>&nbsp;</div></li><li><div><span class="comment">//                    if(!empty($zip_file)&& is_array($zip_file))</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                    {</span></span></span>&nbsp;</div></li><li><div><span class="comment">//                        $output.=&quot;&lt;a class='button' href='&quot;.$zip_file[&quot;url&quot;].&quot;' download='&quot;.basename($zip_file[&quot;url&quot;]).&quot;'&gt;&quot;.__( &quot;Download design&quot;, &quot;wpd&quot;).&quot;&lt;/a&gt; &quot;;</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                    }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                    else</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                    {</span></span></span>&nbsp;</div></li><li><div><span class="comment">//                        $output.=$this-&gt;wpc_generate_order_item_zip($item_id, $unserialized_data, false, $_product-&gt;id);</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                    }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                else</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                {</span></span></span>&nbsp;</div></li><li><div>              $zip_file = $unserialized_data[&quot;output&quot;][&quot;zip&quot;];&nbsp;</div></li><li><div>              if (!empty($zip_file))&nbsp;</div></li><li><div>                  $output.=&quot;&lt;a class='button' href='&quot; . $upload_dir[&quot;baseurl&quot;] . &quot;/WPC/$tmp_dir/$zip_file' download='&quot; . basename($zip_file) . &quot;'&gt;&quot; . __(&quot;Download design&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot;;&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div>              if (isset($item[&quot;wpc_design_pricing_options&quot;])) {&nbsp;</div></li><li><div>                  $output.=$item[&quot;wpc_design_pricing_options&quot;];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">//End</span>&nbsp;</div></li><li><div>              $output.=&quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else if (isset($item[&quot;wpc_data_upl&quot;])) {&nbsp;</div></li><li><div>          $output.=&quot;&lt;div class='wpc_order_item' data-item='$item_id'&gt;&quot;;&nbsp;</div></li><li><div>          <span class="comment">//Looks like the structure changed for latest versions of WC (tested on 2.3.7)</span>&nbsp;</div></li><li><div>          $design_url = $item[&quot;item_meta&quot;][&quot;wpc_data_upl&quot;][0];&nbsp;</div></li><li><div>          if(is_serialized($design_url))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $unserialized_urls=  unserialize($design_url);&nbsp;</div></li><li><div>              foreach ($unserialized_urls as $design_url)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $output.=&quot;&lt;a class='button' href='&quot; . $design_url . &quot;' download='&quot; . basename($design_url) . &quot;'&gt;&quot; . __(&quot;Download custom design&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>          <span class="comment">//        $output.=get_variable_order_item_attributes($_product);</span>&nbsp;</div></li><li><div>              $output.=&quot;&lt;a class='button' href='&quot; . $design_url . &quot;' download='&quot; . basename($design_url) . &quot;'&gt;&quot; . __(&quot;Download custom design&quot;, &quot;wpd&quot;) . &quot;&lt;/a&gt; &quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (isset($item[&quot;wpc_design_pricing_options&quot;])) {&nbsp;</div></li><li><div>              $output.=$item[&quot;wpc_design_pricing_options&quot;];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $output.=&quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_custom_design_upload() {&nbsp;</div></li><li><div>      $nonce = $_POST['nonce'];&nbsp;</div></li><li><div>      if (!wp_verify_nonce($nonce, 'wpc-custom-upload-nonce')) {&nbsp;</div></li><li><div>          $busted = __(&quot;Cheating huh?&quot;, &quot;wpd&quot;);&nbsp;</div></li><li><div>          die($busted);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>      $product_id = $_POST[&quot;wpc-product-id-upl&quot;];&nbsp;</div></li><li><div>      $generation_path = $upload_dir[&quot;basedir&quot;];&nbsp;</div></li><li><div>      $generation_url = $upload_dir[&quot;baseurl&quot;];&nbsp;</div></li><li><div>      $file_name = uniqid();&nbsp;</div></li><li><div>      $valid_formats = array();&nbsp;</div></li><li><div>      $options = get_option('wpc-upload-options');&nbsp;</div></li><li><div>      $valid_formats_raw = $options['wpc-custom-designs-extensions'];&nbsp;</div></li><li><div>      if (!empty($valid_formats_raw)) {&nbsp;</div></li><li><div>          $valid_formats = array_map('trim', explode(', ', $valid_formats_raw));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $name = $_FILES['user-custom-design']['name'];&nbsp;</div></li><li><div>      $size = $_FILES['user-custom-design']['size'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($_POST) and $_SERVER['REQUEST_METHOD'] == &quot;POST&quot;) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (strlen($name)) {&nbsp;</div></li><li><div>              if (!isset($_SESSION[&quot;wpc-user-uploaded-designs&quot;]))&nbsp;</div></li><li><div>                  $_SESSION[&quot;wpc-user-uploaded-designs&quot;] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (isset($_SESSION[&quot;wpc-user-uploaded-designs&quot;][$product_id]))&nbsp;</div></li><li><div>                  unset($_SESSION[&quot;wpc-user-uploaded-designs&quot;][$product_id]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $path_parts = pathinfo($name);&nbsp;</div></li><li><div>              $ext=  $path_parts['extension'];&nbsp;</div></li><li><div>              $ext = strtolower($ext);&nbsp;</div></li><li><div>              if (in_array($ext, $valid_formats) || empty($valid_formats)) {&nbsp;</div></li><li><div>                  <span class="comment">//            var_dump($_FILES);</span>&nbsp;</div></li><li><div>                  $tmp = $_FILES['user-custom-design']['tmp_name'];&nbsp;</div></li><li><div>                  $success = 0;&nbsp;</div></li><li><div>                  $message = &quot;&quot;;&nbsp;</div></li><li><div>                  if (move_uploaded_file($tmp, $generation_path . &quot;/&quot; . $file_name . &quot;.$ext&quot;)) {&nbsp;</div></li><li><div>                      $success = 1;&nbsp;</div></li><li><div>                      $_SESSION[&quot;wpc-user-uploaded-designs&quot;][$product_id] = &quot;$generation_url/$file_name.$ext&quot;;&nbsp;</div></li><li><div>                      $message = $_FILES['user-custom-design']['name'] . &quot; successfully uploaded. Click on the Add to cart button to add this product and your design to the cart.&quot;;&nbsp;</div></li><li><div>                      $valid_formats_for_thumb = array(&quot;psd&quot;, &quot;eps&quot;);&nbsp;</div></li><li><div>                      if (in_array($ext, $valid_formats_for_thumb)) {&nbsp;</div></li><li><div>                          $output_thumb = uniqid() . &quot;.png&quot;;&nbsp;</div></li><li><div>                          $thumb_generation_success = $this-&gt;generate_adobe_thumb($generation_path, $file_name . &quot;.$ext&quot;, $output_thumb);&nbsp;</div></li><li><div>                          if ($thumb_generation_success)&nbsp;</div></li><li><div>                              $message.=&quot;&lt;div class='wpc-file-preview'&gt;&lt;b&gt;Preview&lt;/b&gt;&lt;br&gt;&lt;img src='$generation_url/$output_thumb'&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>                      $success = 0;&nbsp;</div></li><li><div>                      $message = __('An error occured during the upload. Please try again later', 'wpd');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else if (!in_array($ext, $valid_formats)) {&nbsp;</div></li><li><div>                  $success = 0;&nbsp;</div></li><li><div>                  $message = __('Incorrect file extension. Allowed extensions: ', 'wpd') . implode(&quot;, &quot;, $valid_formats);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              echo json_encode(&nbsp;</div></li><li><div>                      array(&nbsp;</div></li><li><div>                          &quot;success&quot; =&gt; $success, &nbsp;</div></li><li><div>                          &quot;message&quot; =&gt; $message, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function wpc_starts_with($haystack, $needle) {&nbsp;</div></li><li><div>      return $needle === &quot;&quot; || strpos($haystack, $needle) === 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function wpc_check_rule($objects, $rule) {&nbsp;</div></li><li><div>      $param = $rule[&quot;param&quot;];&nbsp;</div></li><li><div>      $value = $rule[&quot;value&quot;];&nbsp;</div></li><li><div>      $operator = $rule[&quot;operator&quot;];&nbsp;</div></li><li><div>      $results = array();&nbsp;</div></li><li><div>      foreach ($objects as $object) {&nbsp;</div></li><li><div>          $to_eval = &quot;if($object[$param] $operator $value) return true; else return false;&quot;;&nbsp;</div></li><li><div>          $evaluation = eval($to_eval);&nbsp;</div></li><li><div>          array_push($results, $evaluation);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $results;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function get_group_valid_items_count($group_results) {&nbsp;</div></li><li><div>      $group_count = false;&nbsp;</div></li><li><div>      foreach ($group_results as $group_type =&gt; $type_results) {&nbsp;</div></li><li><div>          if (count($type_results) === 1)&nbsp;</div></li><li><div>              $intersection = current($type_results);&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $intersection = call_user_func_array('array_intersect', $type_results);&nbsp;</div></li><li><div>          $group_type_count = count(array_filter($intersection));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//If at least one rule is not valid for any item, the group is not valid</span>&nbsp;</div></li><li><div>          if (!$group_type_count)&nbsp;</div></li><li><div>              return 0;&nbsp;</div></li><li><div>          else if ($group_count)&nbsp;</div></li><li><div>              $group_count = min(array($group_count, $group_type_count));&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $group_count = $group_type_count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $group_count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function get_group_results($priceable_elements, $rules) {&nbsp;</div></li><li><div>      $group_results = array();&nbsp;</div></li><li><div>      <span class="comment">//For each rule in the group</span>&nbsp;</div></li><li><div>      foreach ($rules as $rule_arr) {&nbsp;</div></li><li><div>          <span class="comment">//We skip invalid rules</span>&nbsp;</div></li><li><div>          if (!$rule_arr[&quot;param&quot;] || !$rule_arr[&quot;operator&quot;] || !$rule_arr[&quot;value&quot;])&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          <span class="comment">//If it's a i-text rule</span>&nbsp;</div></li><li><div>          if ($this-&gt;wpc_starts_with($rule_arr[&quot;param&quot;], &quot;txt&quot;)) {&nbsp;</div></li><li><div>              if (isset($priceable_elements[&quot;i-text&quot;]))&nbsp;</div></li><li><div>                  $results_arr = $this-&gt;wpc_check_rule($priceable_elements[&quot;i-text&quot;], $rule_arr);&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $results_arr = array(false);&nbsp;</div></li><li><div>              if (!isset($group_results[&quot;i-text&quot;]))&nbsp;</div></li><li><div>                  $group_results[&quot;i-text&quot;] = array();&nbsp;</div></li><li><div>              array_push($group_results[&quot;i-text&quot;], $results_arr);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//else if it's an image rule</span>&nbsp;</div></li><li><div>          else if ($this-&gt;wpc_starts_with($rule_arr[&quot;param&quot;], &quot;img&quot;)) {&nbsp;</div></li><li><div>              if (isset($priceable_elements[&quot;image&quot;]))&nbsp;</div></li><li><div>                  $results_arr = $this-&gt;wpc_check_rule($priceable_elements[&quot;image&quot;], $rule_arr);&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $results_arr = array(false);&nbsp;</div></li><li><div>              if (!isset($group_results[&quot;image&quot;]))&nbsp;</div></li><li><div>                  $group_results[&quot;image&quot;] = array();&nbsp;</div></li><li><div>              array_push($group_results[&quot;image&quot;], $results_arr);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//else if it's a vector rule</span>&nbsp;</div></li><li><div>          else if ($this-&gt;wpc_starts_with($rule_arr[&quot;param&quot;], &quot;path&quot;)) {&nbsp;</div></li><li><div>              if (isset($priceable_elements[&quot;path&quot;]))&nbsp;</div></li><li><div>                  $results_arr = $this-&gt;wpc_check_rule($priceable_elements[&quot;path&quot;], $rule_arr);&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $results_arr = array(false);&nbsp;</div></li><li><div>              if (!isset($group_results[&quot;path&quot;]))&nbsp;</div></li><li><div>                  $group_results[&quot;path&quot;] = array();&nbsp;</div></li><li><div>              <span class="comment">//            var_dump($results_arr);</span>&nbsp;</div></li><li><div>              array_push($group_results[&quot;path&quot;], $results_arr);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $group_results;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function wpd_exec($cmd) {&nbsp;</div></li><li><div>      $output = array();&nbsp;</div></li><li><div>      exec(&quot;$cmd 2&gt;&1&quot;, $output);&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function get_design_options_prices($json_wpc_design_options) {&nbsp;</div></li><li><div>      $wpc_design_options_prices = 0;&nbsp;</div></li><li><div>      if (!empty($json_wpc_design_options)) {&nbsp;</div></li><li><div>          $json = $json_wpc_design_options;&nbsp;</div></li><li><div>          $json = str_replace(&quot;\n&quot;, &quot;|n&quot;, $json);&nbsp;</div></li><li><div>          $unslashed_json = stripslashes_deep($json);&nbsp;</div></li><li><div>          $decoded_json = json_decode($unslashed_json);&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//var_dump($decoded_json);</span></span>&nbsp;</div></li><li><div>          if (is_object($decoded_json) && property_exists($decoded_json, 'opt_price')) {&nbsp;</div></li><li><div>              $wpc_design_options_prices = $decoded_json-&gt;opt_price;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $wpc_design_options_prices;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_design_pricing_options_data($wpc_design_pricing_options) {&nbsp;</div></li><li><div>      $wpc_design_pricing_options_data = '';&nbsp;</div></li><li><div>      <span class="comment">//    var_dump($wpc_design_pricing_options);</span>&nbsp;</div></li><li><div>      if (!empty($wpc_design_pricing_options) && function_exists('ninja_forms_get_field_by_id')) {&nbsp;</div></li><li><div>          <span class="comment">//        $json=$wpc_design_pricing_options;</span>&nbsp;</div></li><li><div>          <span class="comment">//        $json=  str_replace(&quot;\n&quot;, &quot;|n&quot;, $json);</span>&nbsp;</div></li><li><div>          <span class="comment">//        $unslashed_json=  stripslashes_deep($json);</span>&nbsp;</div></li><li><div>          <span class="comment">//        $decoded_json=  json_decode($unslashed_json);</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//var_dump($decoded_json);</span></span>&nbsp;</div></li><li><div>          $decoded_json = self::wpc_json_decode($wpc_design_pricing_options);&nbsp;</div></li><li><div>          if (is_object($decoded_json)) {&nbsp;</div></li><li><div>              $wpc_ninja_form_fields_to_hide_name = array('_wpnonce', '_ninja_forms_display_submit', '_form_id', '_wp_http_referer');&nbsp;</div></li><li><div>              $wpc_ninja_form_fields_type_to_hide = array('_calc', '_honeypot');&nbsp;</div></li><li><div>              $wpc_ninja_form_id = '';&nbsp;</div></li><li><div>              $wpc_ninja_form_id = $decoded_json-&gt;wpc_design_opt_list-&gt;_form_id;&nbsp;</div></li><li><div>              $wpc_design_pricing_options_data .= '&lt;div class = &quot;wpc_cart_item_form_data_wrap mg-bot-10&quot;&gt;';&nbsp;</div></li><li><div>              foreach ($decoded_json-&gt;wpc_design_opt_list as $ninja_forms_field_id =&gt; $ninja_forms_field_value) {&nbsp;</div></li><li><div>                  if (!in_array($ninja_forms_field_id, $wpc_ninja_form_fields_to_hide_name)) {&nbsp;</div></li><li><div>                      <span class="comment">//var_dump($ninja_forms_field_id);</span>&nbsp;</div></li><li><div>                      $wpc_get_ninjaform_field_arg = array(&nbsp;</div></li><li><div>                          'id' =&gt; str_replace('ninja_forms_field_', '', $ninja_forms_field_id), &nbsp;</div></li><li><div>                          'form_id' =&gt; $wpc_ninja_form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                      $wpc_ninjaform_field = ninja_forms_get_field_by_id($wpc_get_ninjaform_field_arg);&nbsp;</div></li><li><div>                      <span class="comment">//var_dump($wpc_ninjaform_field);</span>&nbsp;</div></li><li><div>                      if (!in_array($wpc_ninjaform_field[&quot;type&quot;], $wpc_ninja_form_fields_type_to_hide)) {&nbsp;</div></li><li><div>                          <span class="comment">//                        if (empty($ninja_forms_field_value)) {</span>&nbsp;</div></li><li><div>                          <span class="comment">//                            $wpc_ninja_form_field_value = __(' ', 'wpd');</span>&nbsp;</div></li><li><div>                          <span class="comment">//                        }else{</span>&nbsp;</div></li><li><div>                          $wpc_ninja_form_field_value = $ninja_forms_field_value;&nbsp;</div></li><li><div>                          <span class="comment">//                        }   </span>&nbsp;</div></li><li><div>                          $wpc_design_pricing_options_data .= '&lt;b&gt;' . $wpc_ninjaform_field[&quot;data&quot;][&quot;label&quot;] . '&lt;/b&gt;: ' . $wpc_ninja_form_field_value . '&lt;br /&gt;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $wpc_design_pricing_options_data .= '&lt;div class = &quot;wpc_cart_item_form_data_wrap&quot;&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $wpc_design_pricing_options_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_option_form($product_id, $wpc_metas) {&nbsp;</div></li><li><div>      if (function_exists('ninja_forms_display_form')) {&nbsp;</div></li><li><div>          global $woocommerce;&nbsp;</div></li><li><div>          $product = wc_get_product($product_id);&nbsp;</div></li><li><div>          if ($product-&gt;product_type == &quot;variation&quot;)&nbsp;</div></li><li><div>              $normal_product_id = $product-&gt;parent-&gt;id;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $normal_product_id = $product_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($wpc_metas['ninja-form-options'])&nbsp;</div></li><li><div>              $form_id = $wpc_metas['ninja-form-options'];&nbsp;</div></li><li><div>          if (!empty($form_id)) {&nbsp;</div></li><li><div>              global $woocommerce;&nbsp;</div></li><li><div>              $currency_symbol = get_woocommerce_currency_symbol();&nbsp;</div></li><li><div>              $product_regular_price = get_post_meta(get_the_ID(), '_regular_price', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//Fill the form in cart item edition case</span>&nbsp;</div></li><li><div>              add_filter('ninja_forms_field', 'WPD_Design::wpc_fill_option_form', 10, 2);&nbsp;</div></li><li><div>              echo '&lt;div class = &quot;wpd-design-opt&quot; data-currency_symbol = &quot;' . $currency_symbol . '&quot; data-regular_price = &quot;' . $product_regular_price . '&quot; &gt;';&nbsp;</div></li><li><div>              ninja_forms_display_form($form_id);&nbsp;</div></li><li><div>              echo '&lt;/div&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function wpc_json_decode($json) {&nbsp;</div></li><li><div>      $decoded_json = '';&nbsp;</div></li><li><div>      if (!empty($json)) {&nbsp;</div></li><li><div>          $json = str_replace(&quot;\n&quot;, &quot;|n&quot;, $json);&nbsp;</div></li><li><div>          $unslashed_json = stripslashes_deep($json);&nbsp;</div></li><li><div>          $decoded_json = json_decode($unslashed_json);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $decoded_json;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function wpc_fill_option_form($data, $field_id) {&nbsp;</div></li><li><div>      <span class="comment">// $data will contain all of the field settings that have been saved for this field.</span>&nbsp;</div></li><li><div>      <span class="comment">// Let's change the default value of the field if in cart item edition case</span>&nbsp;</div></li><li><div>      GLOBAL $wp_query;&nbsp;</div></li><li><div>      if (isset($wp_query-&gt;query_vars[&quot;edit&quot;]) && isset($_SESSION[&quot;wpc_design_pricing_options&quot;])) {&nbsp;</div></li><li><div>          $cart_item_key = $wp_query-&gt;query_vars[&quot;edit&quot;];&nbsp;</div></li><li><div>          if (isset($_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key])) {&nbsp;</div></li><li><div>              $wpc_json_ninja_form_fields = $_SESSION[&quot;wpc_design_pricing_options&quot;][$cart_item_key];&nbsp;</div></li><li><div>              $wpc_ninja_form_fields = self::wpc_json_decode($wpc_json_ninja_form_fields);&nbsp;</div></li><li><div>              if (is_object($wpc_ninja_form_fields)) {&nbsp;</div></li><li><div>                  $wpc_design_opt_list = $wpc_ninja_form_fields-&gt;wpc_design_opt_list;&nbsp;</div></li><li><div>                  $wpc_ninja_form_id = $wpc_design_opt_list-&gt;_form_id;&nbsp;</div></li><li><div>                  $wpc_get_ninjaform_field_arg = array(&nbsp;</div></li><li><div>                      'id' =&gt; $field_id, &nbsp;</div></li><li><div>                      'form_id' =&gt; $wpc_ninja_form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  $wpc_ninjaform_field = ninja_forms_get_field_by_id($wpc_get_ninjaform_field_arg);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if (property_exists($wpc_design_opt_list, 'ninja_forms_field_' . $field_id)) {     <span class="comment">// if it is a single field</span>&nbsp;</div></li><li><div>                      $ninja_forms_field_id = 'ninja_forms_field_' . $field_id;&nbsp;</div></li><li><div>                      if ($wpc_ninjaform_field[&quot;type&quot;] == '_checkbox') {&nbsp;</div></li><li><div>                          $default_value = '';&nbsp;</div></li><li><div>                          $checkbox = trim($wpc_design_opt_list-&gt;$ninja_forms_field_id);&nbsp;</div></li><li><div>                          if ($checkbox == 'checked') {&nbsp;</div></li><li><div>                              $default_value = $checkbox;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $data['default_value'] = $default_value;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $data['default_value'] = $wpc_design_opt_list-&gt;$ninja_forms_field_id;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } elseif (property_exists($wpc_design_opt_list, 'ninja_forms_field_' . $field_id . '[]')) {      <span class="comment">//if it is a list of field</span>&nbsp;</div></li><li><div>                      $ninja_forms_field_id = 'ninja_forms_field_' . $field_id . '[]';&nbsp;</div></li><li><div>                      if ($wpc_ninjaform_field['data']['list_type'] == 'checkbox') {&nbsp;</div></li><li><div>                          $checkbox_list = explode(';', $wpc_design_opt_list-&gt;$ninja_forms_field_id);&nbsp;</div></li><li><div>                          $default_value = array();&nbsp;</div></li><li><div>                          foreach ($checkbox_list as $checkbox) {&nbsp;</div></li><li><div>                              $checkbox = explode(':', $checkbox);&nbsp;</div></li><li><div>                              if (isset($checkbox[1]) && trim($checkbox[1]) == 'checked') {&nbsp;</div></li><li><div>                                  $default_value[] = trim($checkbox[0]);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $data['default_value'] = $default_value;&nbsp;</div></li><li><div>                      } elseif ($wpc_ninjaform_field['data']['list_type'] == 'multi') {&nbsp;</div></li><li><div>                          $multi_list = explode('|', $wpc_design_opt_list-&gt;$ninja_forms_field_id);&nbsp;</div></li><li><div>                          $default_value = array();&nbsp;</div></li><li><div>                          foreach ($multi_list as $value) {&nbsp;</div></li><li><div>                              $default_value[] = trim($value);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $data['default_value'] = $default_value;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function save_pdf_output_new($variation_id, $input_file, $output_file) {&nbsp;</div></li><li><div>      GLOBAL $wpc_options_settings;&nbsp;</div></li><li><div>      $product_id = WPD_Product::get_parent($variation_id);&nbsp;</div></li><li><div>      $wpc_metas = get_post_meta($product_id, 'wpc-metas', true);&nbsp;</div></li><li><div>      $product_metas=  WPD_Admin::get_proper_value($wpc_metas, $variation_id, array());&nbsp;</div></li><li><div>      $variation_output_settings=WPD_Admin::get_proper_value($product_metas, &quot;output-settings&quot;, array());&nbsp;</div></li><li><div>      $global_output_settings = $wpc_options_settings['wpc-output-options'];&nbsp;</div></li><li><div>      $pdf_format=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-format&quot;, &quot;A0&quot;);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-format&quot;, &quot;A0&quot;);</span></span>&nbsp;</div></li><li><div>      $pdf_orientation=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-orientation&quot;, &quot;P&quot;);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-orientation&quot;, &quot;P&quot;);</span></span>&nbsp;</div></li><li><div>      $pdf_margin_lr=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-margin-lr&quot;, 20);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-margin-lr&quot;, 20);</span></span>&nbsp;</div></li><li><div>      $pdf_margin_tb=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-margin-tb&quot;, 20);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-margin-tb&quot;, 20);</span></span>&nbsp;</div></li><li><div>      <span class="comment">/**if ($nbCol &lt;= 0 || $total &lt;= 0) {</span>&nbsp;</div></li><li><div><span class="comment">          $nbCol = 1;</span>&nbsp;</div></li><li><div><span class="comment">          $total = 1;</span>&nbsp;</div></li><li><div><span class="comment">      }*/</span>&nbsp;</div></li><li><div>      $pdf = new TCPDF($pdf_orientation, PDF_UNIT, $pdf_format, true, 'UTF-8', false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf-&gt;SetCreator(&quot;Woocommerce Products Designer by ORION&quot;);&nbsp;</div></li><li><div>      $pdf-&gt;SetAuthor('Woocommerce Products Designer by ORION');&nbsp;</div></li><li><div>      $pdf-&gt;SetTitle('Output');&nbsp;</div></li><li><div>      $pdf-&gt;setPrintHeader(false);&nbsp;</div></li><li><div>      $pdf-&gt;setPrintFooter(false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set default monospaced font</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set margins</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetMargins($pdf_margin_lr, $pdf_margin_tb, -1, true);&nbsp;</div></li><li><div>      $pdf-&gt;SetHeaderMargin(PDF_MARGIN_HEADER);&nbsp;</div></li><li><div>      $pdf-&gt;SetFooterMargin(PDF_MARGIN_FOOTER);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set auto page breaks</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set image scale factor</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;setImageScale(PDF_IMAGE_SCALE_RATIO);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set some language-dependent strings (optional)</span></span>&nbsp;</div></li><li><div>      if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {&nbsp;</div></li><li><div>          require_once(dirname(__FILE__) . '/lang/eng.php');&nbsp;</div></li><li><div>          $pdf-&gt;setLanguageArray($l);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf-&gt;AddPage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//        $defaultImageSize = getimagesize($input_file);</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        $pageWidth = $pdf-&gt;getPageWidth();</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        $pagHeight = $pdf-&gt;getPageHeight();</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf-&gt;Image($input_file, '', '', '', '', '', false, 'C', false, 300, 'C', false, false, 0, false, false, false);&nbsp;</div></li><li><div>      <span class="comment">/**$nblign = $total / $nbCol;</span>&nbsp;</div></li><li><div><span class="comment">      $marge = 10;</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">      //Set width and height </span>&nbsp;</div></li><li><div><span class="comment">      $w = ($pageWidth - $marge * ($nbCol + 1)) / $nbCol;</span>&nbsp;</div></li><li><div><span class="comment">      $h = ($defaultImageSize[1] * $w) / $defaultImageSize[0];</span>&nbsp;</div></li><li><div><span class="comment">      if ($h * ($nblign + 1) + 20 &gt; $pagHeight) {</span>&nbsp;</div></li><li><div><span class="comment">          $h = ($pagHeight - 2 * ($nblign + 1) - 20) / ($nblign + 1);</span>&nbsp;</div></li><li><div><span class="comment">          $w = ($defaultImageSize[0] * $h) / $defaultImageSize[1];</span>&nbsp;</div></li><li><div><span class="comment">          $marge = ($pageWidth - ($w * $nbCol)) / ($nbCol + 1);</span>&nbsp;</div></li><li><div><span class="comment">      }</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">      //Print images</span>&nbsp;</div></li><li><div><span class="comment">      $x = $marge;</span>&nbsp;</div></li><li><div><span class="comment">      $y = 20;</span>&nbsp;</div></li><li><div><span class="comment">      $i = 0;</span>&nbsp;</div></li><li><div><span class="comment">      while ($i &lt; $total) {</span>&nbsp;</div></li><li><div><span class="comment">          for ($i2 = 0; $i2 &lt; $nbCol; $i2++) {</span>&nbsp;</div></li><li><div><span class="comment">              if ($i &lt; $total) {</span>&nbsp;</div></li><li><div><span class="comment">                  $pdf-&gt;Image($input_file, $x, $y, $w, $h, '', '', '', true, 300, '', false, false, 0, '', false, false);</span>&nbsp;</div></li><li><div><span class="comment">                  $x += ($w + $marge);</span>&nbsp;</div></li><li><div><span class="comment">                  $i ++;</span>&nbsp;</div></li><li><div><span class="comment">              }</span>&nbsp;</div></li><li><div><span class="comment">          }</span>&nbsp;</div></li><li><div><span class="comment">          $x = $marge;</span>&nbsp;</div></li><li><div><span class="comment">          $y += $h;</span>&nbsp;</div></li><li><div><span class="comment">      }*/</span>&nbsp;</div></li><li><div>      $pdf-&gt;Output($output_file, 'F');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function convert_png_to_jpg($input_path, $remove_input = true) {&nbsp;</div></li><li><div>      $output_path = str_replace(&quot;.png&quot;, &quot;.jpg&quot;, $input_path);&nbsp;</div></li><li><div>      <span class="comment">// create new imagick object from image.jpg</span>&nbsp;</div></li><li><div>      $im = new Imagick($input_path);&nbsp;</div></li><li><div>      $im-&gt;setImageBackgroundColor('white');&nbsp;</div></li><li><div>      $im = $im-&gt;flattenImages();&nbsp;</div></li><li><div>      $im-&gt;setImageFormat(&quot;jpg&quot;);&nbsp;</div></li><li><div>      $im-&gt;writeImage($output_path);&nbsp;</div></li><li><div>      if ($remove_input)&nbsp;</div></li><li><div>          unlink($input_path);&nbsp;</div></li><li><div>      return $output_path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Export data to archive</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $generation_dir Working directory path</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $data Data to export</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $variation_id Product/Variation ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function export_data_to_files($generation_dir, $data, $variation_id, $zip_name, $pdf_watermark=false) {&nbsp;</div></li><li><div>      GLOBAL $wpc_options_settings;&nbsp;</div></li><li><div>      $wpc_output_options = $wpc_options_settings['wpc-output-options'];&nbsp;</div></li><li><div>      $generate_layers = false;&nbsp;</div></li><li><div>      $generate_pdf = false;&nbsp;</div></li><li><div>      $generate_zip = false;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $product_id = WPD_Product::get_parent($variation_id);&nbsp;</div></li><li><div>      $wpc_metas = get_post_meta($product_id, 'wpc-metas', true);&nbsp;</div></li><li><div>      $product_metas=  WPD_Admin::get_proper_value($wpc_metas, $variation_id, array());&nbsp;</div></li><li><div>      $watermark_id= WPD_Admin::get_proper_value($product_metas, &quot;watermark&quot;, false);&nbsp;</div></li><li><div>      $watermark=false;&nbsp;</div></li><li><div>      if($watermark_id)&nbsp;</div></li><li><div>          $watermark=  get_attached_file($watermark_id);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if (isset($wpc_output_options['wpc-generate-layers']))&nbsp;</div></li><li><div>          $generate_layers = ($wpc_output_options['wpc-generate-layers'] === &quot;yes&quot;) ? true : false;&nbsp;</div></li><li><div>      if (isset($wpc_output_options['wpc-generate-pdf']))&nbsp;</div></li><li><div>          $generate_pdf = ($wpc_output_options['wpc-generate-pdf'] === &quot;yes&quot;) ? true : false;&nbsp;</div></li><li><div>      if (isset($wpc_output_options['wpc-generate-zip']))&nbsp;</div></li><li><div>          $generate_zip = ($wpc_output_options['wpc-generate-zip'] === &quot;yes&quot;) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpc_img_format = &quot;png&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output_arr = array();&nbsp;</div></li><li><div>      foreach ($data as $part_key =&gt; $part_data) {&nbsp;</div></li><li><div>          $part_dir = &quot;$generation_dir/$part_key&quot;;&nbsp;</div></li><li><div>          if (!wp_mkdir_p($part_dir)) {&nbsp;</div></li><li><div>              echo &quot;Can't create part directory...&quot;;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//Layers</span>&nbsp;</div></li><li><div>          $layers_array = array();&nbsp;</div></li><li><div>          if ($generate_layers) {&nbsp;</div></li><li><div>              $part_layers_dir = &quot;$part_dir/layers&quot;;&nbsp;</div></li><li><div>              if (!wp_mkdir_p($part_layers_dir)) {&nbsp;</div></li><li><div>                  echo &quot;Can't create layers directory...&quot;;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!isset($_FILES[&quot;layers&quot;]))&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              if (isset($_FILES[&quot;layers&quot;][&quot;tmp_name&quot;][$part_key])) {&nbsp;</div></li><li><div>                  foreach ($_FILES[&quot;layers&quot;][&quot;tmp_name&quot;][$part_key] as $layer_data) {&nbsp;</div></li><li><div>                      $file_name = uniqid(&quot;wpc_layer_&quot;);&nbsp;</div></li><li><div>                      $output_file_path = $part_layers_dir . &quot;/$file_name.$wpc_img_format&quot;;&nbsp;</div></li><li><div>                      if (move_uploaded_file($layer_data, $output_file_path)) {&nbsp;</div></li><li><div>                          if($pdf_watermark&&$watermark_id)&nbsp;</div></li><li><div>                          {&nbsp;</div></li><li><div>                              $watermarked_layer_name=  uniqid(&quot;watermarked_layer_&quot;).&quot;.png&quot;;&nbsp;</div></li><li><div>                              $watermarked_layer_path = &quot;$part_layers_dir/&quot;.$watermarked_layer_name;&nbsp;</div></li><li><div>                              $this-&gt;merge_pictures($output_file_path, $watermark, $watermarked_layer_path);&nbsp;</div></li><li><div>                              array_push($layers_array, $watermarked_layer_path);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          else&nbsp;</div></li><li><div>                              array_push($layers_array, $output_file_path);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Part image</span>&nbsp;</div></li><li><div>          $output_file_path = $part_dir . &quot;/$part_key.$wpc_img_format&quot;;&nbsp;</div></li><li><div><span class="comment">//            var_dump($_FILES[$part_key]);</span>&nbsp;</div></li><li><div>          $moved=move_uploaded_file($_FILES[$part_key]['tmp_name']['image'], $output_file_path);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $output_arr[$part_key][&quot;image&quot;] = &quot;$part_key.$wpc_img_format&quot;;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">//Preview</span>&nbsp;</div></li><li><div>          if($watermark_id)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $preview_filename=  uniqid(&quot;preview_&quot;).&quot;.png&quot;;&nbsp;</div></li><li><div>              $preview_file_path = &quot;$part_dir/&quot;.$preview_filename;&nbsp;</div></li><li><div>              $this-&gt;merge_pictures($output_file_path, $watermark, $preview_file_path);            &nbsp;</div></li><li><div>              $output_arr[$part_key][&quot;preview&quot;]=$preview_filename;&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $output_arr[$part_key][&quot;preview&quot;] = $output_arr[$part_key][&quot;image&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$generate_pdf && !$generate_zip)&nbsp;</div></li><li><div>              $output_arr[$part_key][&quot;file&quot;] = &quot;$part_key.$wpc_img_format&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//            $product_id = WPD_Product::get_parent($variation_id);</span>&nbsp;</div></li><li><div><span class="comment">//            $wpc_output_product_settings = get_post_meta($product_id, &quot;wpc_output_product_settings&quot;, true);</span>&nbsp;</div></li><li><div>          $total_img=1;&nbsp;</div></li><li><div>          $nbCol=1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Part pdf</span>&nbsp;</div></li><li><div>          if ($generate_pdf && !$generate_layers) {&nbsp;</div></li><li><div><span class="comment">//                $total_img = WPD_Product::get_option($wpc_output_product_settings, $wpc_output_options, &quot;wpc-outputpdf-img-number&quot;, $product_id, $variation_id);</span>&nbsp;</div></li><li><div><span class="comment">//                $nbCol = WPD_Product::get_option($wpc_output_product_settings, $wpc_output_options, &quot;wpc-outputpdf-img-col&quot;, $product_id, $variation_id);</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $output_pdf_file_path = $part_dir . &quot;/$part_key.pdf&quot;;&nbsp;</div></li><li><div>              if($pdf_watermark&&$watermark_id)&nbsp;</div></li><li><div>                  $this-&gt;save_pdf_output_new($variation_id, $preview_file_path, $output_pdf_file_path);&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $this-&gt;save_pdf_output_new($variation_id, $output_file_path, $output_pdf_file_path);&nbsp;</div></li><li><div>              if (!$generate_zip)&nbsp;</div></li><li><div>                  $output_arr[$part_key][&quot;file&quot;] = &quot;$part_key.pdf&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// PDF Layers</span>&nbsp;</div></li><li><div>          else if ($generate_layers && $generate_pdf) {&nbsp;</div></li><li><div>              $this-&gt;generate_pdf_layers($variation_id, $layers_array, $generation_dir . &quot;/$part_key/$part_key.pdf&quot;);&nbsp;</div></li><li><div>              if (!$generate_zip)&nbsp;</div></li><li><div>                  $output_arr[$part_key][&quot;file&quot;] = &quot;$part_key.pdf&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result = $this-&gt;generate_design_archive($generation_dir, &quot;$generation_dir/$zip_name&quot;);&nbsp;</div></li><li><div>      return $output_arr;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates a compressed zip file</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $source Input directory path to zip</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $destination Output file path</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function generate_design_archive($source, $destination) {&nbsp;</div></li><li><div>      if (!extension_loaded('zip') || !file_exists($source)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $zip = new ZipArchive();&nbsp;</div></li><li><div>      if (!$zip-&gt;open($destination, ZIPARCHIVE::CREATE)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $source = str_replace('\\', DIRECTORY_SEPARATOR, realpath($source));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (is_dir($source) === true) {&nbsp;</div></li><li><div>          $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($source), RecursiveIteratorIterator::SELF_FIRST);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($files as $file) {&nbsp;</div></li><li><div>              $file = str_replace('\\', DIRECTORY_SEPARATOR, $file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Ignore &quot;.&quot; and &quot;..&quot; folders</span>&nbsp;</div></li><li><div>              if (in_array(substr($file, strrpos($file, '/') + 1), array('.', '..')))&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $file = realpath($file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (is_dir($file) === true)&nbsp;</div></li><li><div>                  $zip-&gt;addEmptyDir(str_replace($source . DIRECTORY_SEPARATOR, '', $file . DIRECTORY_SEPARATOR));&nbsp;</div></li><li><div>              else if (is_file($file) === true)&nbsp;</div></li><li><div>                  $zip-&gt;addFromString(str_replace($source . DIRECTORY_SEPARATOR, '', $file), file_get_contents($file));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (is_file($source) === true) {&nbsp;</div></li><li><div>          $zip-&gt;addFromString(basename($source), file_get_contents($source));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $zip-&gt;close();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function generate_pdf_layers($variation_id, $layers_array, $output_file) {&nbsp;</div></li><li><div>      GLOBAL $wpc_options_settings;&nbsp;</div></li><li><div>      $product_id = WPD_Product::get_parent($variation_id);&nbsp;</div></li><li><div>      $wpc_metas = get_post_meta($product_id, 'wpc-metas', true);&nbsp;</div></li><li><div>      $product_metas=  WPD_Admin::get_proper_value($wpc_metas, $variation_id, array());&nbsp;</div></li><li><div>      $variation_output_settings=WPD_Admin::get_proper_value($product_metas, &quot;output-settings&quot;, array());&nbsp;</div></li><li><div>      $global_output_settings = $wpc_options_settings['wpc-output-options'];&nbsp;</div></li><li><div>      $pdf_format=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-format&quot;, &quot;A0&quot;);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-format&quot;, &quot;A0&quot;);</span></span>&nbsp;</div></li><li><div>      $pdf_orientation=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-orientation&quot;, &quot;P&quot;);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-orientation&quot;, &quot;P&quot;);</span></span>&nbsp;</div></li><li><div>      $pdf_margin_lr=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-margin-lr&quot;, 20);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-margin-lr&quot;, 20);</span></span>&nbsp;</div></li><li><div>      $pdf_margin_tb=WPD_Product::get_option($variation_output_settings, $global_output_settings, &quot;pdf-margin-tb&quot;, 20);<span class="comment"><span class="comment">//WPD_Admin::get_proper_value($wpc_output_options, &quot;pdf-margin-tb&quot;, 20);</span></span>&nbsp;</div></li><li><div>      <span class="comment">/**if ($nbCol &lt;= 0 || $total &lt;= 0) {</span>&nbsp;</div></li><li><div><span class="comment">          $nbCol = 1;</span>&nbsp;</div></li><li><div><span class="comment">          $total = 1;</span>&nbsp;</div></li><li><div><span class="comment">      }*/</span>&nbsp;</div></li><li><div>      $pdf = new TCPDF($pdf_orientation, PDF_UNIT, $pdf_format, true, 'UTF-8', false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf-&gt;SetCreator(&quot;Woocommerce Products Designer by ORION&quot;);&nbsp;</div></li><li><div>      $pdf-&gt;SetAuthor('Woocommerce Products Designer by ORION');&nbsp;</div></li><li><div>      $pdf-&gt;SetTitle('Output');&nbsp;</div></li><li><div>      $pdf-&gt;setPrintHeader(false);&nbsp;</div></li><li><div>      $pdf-&gt;setPrintFooter(false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set default monospaced font</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set margins</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetMargins($pdf_margin_lr, $pdf_margin_tb, -1, true);&nbsp;</div></li><li><div>      $pdf-&gt;SetHeaderMargin(PDF_MARGIN_HEADER);&nbsp;</div></li><li><div>      $pdf-&gt;SetFooterMargin(PDF_MARGIN_FOOTER);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set auto page breaks</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set image scale factor</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;setImageScale(PDF_IMAGE_SCALE_RATIO);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set some language-dependent strings (optional)</span></span>&nbsp;</div></li><li><div>      if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {&nbsp;</div></li><li><div>          require_once(dirname(__FILE__) . '/lang/eng.php');&nbsp;</div></li><li><div>          $pdf-&gt;setLanguageArray($l);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf-&gt;AddPage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//$pdf-&gt;Image($input_file, '', '', '', '', '', false, 'C', false, 300, 'C', false, false, 0, false, false, false);</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $layers_id = 0;&nbsp;</div></li><li><div>                  foreach ($layers_array as $layer) {&nbsp;</div></li><li><div>                      $pdf-&gt;startLayer('layer' . $layers_id, true, true, false);&nbsp;</div></li><li><div>          $pdf-&gt;Image($layer, '', '', '', '', '', '', 'C', true, 300, 'C', false, false, 0, '', false, false);&nbsp;</div></li><li><div>                      $pdf-&gt;endLayer();&nbsp;</div></li><li><div>                      $layers_id ++;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div><span class="comment">//        $defaultImageSize = getimagesize($img_output_file_path);</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        $pageWidth = $pdf-&gt;getPageWidth();</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        $pagHeight = $pdf-&gt;getPageHeight();</span></span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">//        $nblign = $total / $nbCol;</span>&nbsp;</div></li><li><div><span class="comment">//        $marge = 10;</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">//        //Set width and height </span>&nbsp;</div></li><li><div><span class="comment">//        $w = ($pageWidth - $marge * ($nbCol + 1)) / $nbCol;</span>&nbsp;</div></li><li><div><span class="comment">//        $h = ($defaultImageSize[1] * $w) / $defaultImageSize[0];</span>&nbsp;</div></li><li><div><span class="comment">//        if ($h * ($nblign + 1) + 20 &gt; $pagHeight) {</span>&nbsp;</div></li><li><div><span class="comment">//            $h = ($pagHeight - 2 * ($nblign + 1) - 20) / ($nblign + 1);</span>&nbsp;</div></li><li><div><span class="comment">//            $w = ($defaultImageSize[0] * $h) / $defaultImageSize[1];</span>&nbsp;</div></li><li><div><span class="comment">//            $marge = ($pageWidth - ($w * $nbCol)) / ($nbCol + 1);</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        }</span></span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">//        //Print images</span>&nbsp;</div></li><li><div><span class="comment">//        $x = $marge;</span>&nbsp;</div></li><li><div><span class="comment">//        $y = 20;</span>&nbsp;</div></li><li><div><span class="comment">//        $i = 0;</span>&nbsp;</div></li><li><div><span class="comment">//        $layers_id = 0;</span>&nbsp;</div></li><li><div><span class="comment">//        while ($i &lt; $total) {</span>&nbsp;</div></li><li><div><span class="comment">//            for ($i2 = 0; $i2 &lt; $nbCol; $i2++) {</span>&nbsp;</div></li><li><div><span class="comment">//                if ($i &lt; $total) {</span>&nbsp;</div></li><li><div><span class="comment">//                    foreach ($layers_array as $layer) {</span>&nbsp;</div></li><li><div><span class="comment">//                        $pdf-&gt;startLayer('layer' . $layers_id, true, true, false);</span>&nbsp;</div></li><li><div><span class="comment">//                        $pdf-&gt;Image($layer, $x, $y, $w, $h, '', '', '', true, 300, '', false, false, 0, '', false, false);</span>&nbsp;</div></li><li><div><span class="comment">//                        $pdf-&gt;endLayer();</span>&nbsp;</div></li><li><div><span class="comment">//                        $layers_id ++;</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                    }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">//                    $x += ($w + $marge);</span>&nbsp;</div></li><li><div><span class="comment">//                    $i ++;</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//            }</span>&nbsp;</div></li><li><div><span class="comment">//            $x = $marge;</span>&nbsp;</div></li><li><div><span class="comment">//            $y += $h;</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        }</span></span>&nbsp;</div></li><li><div>      $pdf-&gt;Output($output_file, 'F');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function unset_wpc_data_upl_meta($hidden_meta) {&nbsp;</div></li><li><div>      array_push($hidden_meta, &quot;wpc_data_upl&quot;);&nbsp;</div></li><li><div>      array_push($hidden_meta, &quot;_wpc_design_pricing_options&quot;);&nbsp;</div></li><li><div>      return $hidden_meta;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function force_individual_cart_items( $cart_item_data, $product_id ) {&nbsp;</div></li><li><div>      if(isset($_SESSION[&quot;wpc-user-uploaded-designs&quot;][$product_id])) {&nbsp;</div></li><li><div>          $unique_cart_item_key = md5( microtime().rand() );&nbsp;</div></li><li><div>          $cart_item_data['unique_key'] = $unique_cart_item_key;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cart_item_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }   &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Woocommerce Products Designer</li><li><span></span>2.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>