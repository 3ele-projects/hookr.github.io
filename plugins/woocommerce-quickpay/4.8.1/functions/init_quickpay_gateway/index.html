<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr function lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr function lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr function lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr function ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr function gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr function" data-site="plugin" data-version="4.8.1" data-slug="woocommerce-quickpay" data-type="function" data-id="14030"><head xmlns="http://www.w3.org/1999/xhtml"><title> init_quickpay_gateway | function | Woocommerce Quickpay | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="init_quickpay_gateway, function, plugin, woocommerce-quickpay, 4.8.1" /><meta name="description" content="The WooCommerce QuickPay init quickpay gateway function." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=dcd346f08f2f872269f42f278e0500cf' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/functions/init_quickpay_gateway/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffunctions%2Finit_quickpay_gateway%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffunctions%2Finit_quickpay_gateway%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-quickpay-4.8.1-function-init_quickpay_gateway","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="init_quickpay_gateway" class="single single-function single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-quickpay." href="http://hookr.io/plugins/woocommerce-quickpay/" class="plugin"><span property="name">woocommerce-quickpay</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.8.1." href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/" class="H_VERSION"><span property="name">4.8.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to functions." href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/" class=""><span property="name">functions</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">init_quickpay_gateway</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="function"><ul role="navigation"><li class="" data-id="all" data-count="41"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/all/" title="All">All <span class="count badge">41</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="15"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/hooks/" title="Hooks">Hooks <span class="count badge">15</span></a></li><li class="" data-id="action" data-count="4"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/" title="Actions">Actions <span class="count badge">4</span></a></li><li class="" data-id="filter" data-count="11"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/" title="Filters">Filters <span class="count badge">11</span></a></li><li class="" data-id="class" data-count="20"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/" title="Classes">Classes <span class="count badge">20</span></a></li><li class="" data-id="constant" data-count="3"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/" title="Constants">Constants <span class="count badge">3</span></a></li><li class="active" data-id="function" data-count="3"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/" title="Functions">Functions <span class="count badge">3</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>init_quickpay_gateway</strong></h1><p>The WooCommerce QuickPay <strong>init quickpay gateway</strong> function.</p> </section> <section id="description"><h2>Description</h2><pre><div>init_quickpay_gateway();&nbsp;</div></pre></section><hr /> <section id="usage"><h2>Usage</h2><pre><ol><li><div>if ( !function_exists( '<span class="func">init_quickpay_gateway</span>' ) ) {&nbsp;</div></li><li><div>    require_once ABSPATH . PLUGINDIR . 'woocommerce-quickpay/woocommerce-quickpay.php';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> &nbsp;</div></li><li><div><span class="comment">// NOTICE! Understand what this does before running.</span>&nbsp;</div></li><li><div><span class="param">$result</span> = <span class="func">init_quickpay_gateway</span>(<span class="param"></span>);&nbsp;</div></li><li><div>   &nbsp;</div></li></ol></pre></section><hr /> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The function is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/files/woocommerce-quickpay/" class="file">/woocommerce-quickpay.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="26" class="block" start="34"><li><div>function init_quickpay_gateway()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Required functions&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    if ( ! function_exists( '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/is_woocommerce_active/" data-id="1411936" title="is_woocommerce_active" class="function">is_woocommerce_active</a>' ) ) {&nbsp;</div></li><li><div>        require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'woo-includes/woo-functions.php';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if WooCommerce is active, and if it isn't, disable Subscriptions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    if ( ! <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/is_woocommerce_active/" data-id="1411936" title="is_woocommerce_active" class="function">is_woocommerce_active</a>() ) {&nbsp;</div></li><li><div>        add_action( <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/admin_notices/" data-id="1411970" title="admin_notices" class="action">'admin_notices'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/wc_quickpay_woocommerce_inactive_notice/" data-id="1411940" title="wc_quickpay_woocommerce_inactive_notice" class="function">wc_quickpay_woocommerce_inactive_notice</a>');&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Import helper classes&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-install.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/api/woocommerce-quickpay-api.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/api/woocommerce-quickpay-api-transaction.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/api/woocommerce-quickpay-api-payment.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/api/woocommerce-quickpay-api-subscription.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-exceptions.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-log.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-helper.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-settings.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-order.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-subscription.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-countries.php';&nbsp;</div></li><li><div>    require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/woocommerce-quickpay-views.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Main class&nbsp;</div></li><li><div>    class WC_QuickPay extends WC_Payment_Gateway&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * $_instance&nbsp;</div></li><li><div>         * @var mixed&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @static&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public static $_instance = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * @var WC_QuickPay_Log&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public $log;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * get_instance&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Returns a new instance of self, if it does not already exist.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @static&nbsp;</div></li><li><div>         * @return WC_QuickPay&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public static function get_instance()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if ( null === self::$_instance ) {&nbsp;</div></li><li><div>                self::$_instance = new self();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return self::$_instance;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * __construct function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * The class construct&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function __construct()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $this-&gt;id = 'quickpay';&nbsp;</div></li><li><div>            $this-&gt;method_title = 'QuickPay';&nbsp;</div></li><li><div>            $this-&gt;icon = '';&nbsp;</div></li><li><div>            $this-&gt;has_fields = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;supports = array(&nbsp;</div></li><li><div>                'subscriptions', &nbsp;</div></li><li><div>                'products', &nbsp;</div></li><li><div>                'subscription_cancellation', &nbsp;</div></li><li><div>                'subscription_reactivation', &nbsp;</div></li><li><div>                'subscription_suspension', &nbsp;</div></li><li><div>                'subscription_amount_changes', &nbsp;</div></li><li><div>                'subscription_date_changes', &nbsp;</div></li><li><div>                'subscription_payment_method_change_customer', &nbsp;</div></li><li><div>                'refunds', &nbsp;</div></li><li><div>                'multiple_subscriptions', &nbsp;</div></li><li><div>                'pre-orders'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;log = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_log/" data-id="1411919" title="WC_QuickPay_Log" class="class">WC_QuickPay_Log</a>();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Load the form fields and settings&nbsp;</div></li><li><div>            $this-&gt;init_form_fields();&nbsp;</div></li><li><div>            $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get gateway variables&nbsp;</div></li><li><div>            $this-&gt;title = $this-&gt;s('title');&nbsp;</div></li><li><div>            $this-&gt;description = $this-&gt;s('description');&nbsp;</div></li><li><div>            $this-&gt;instructions = $this-&gt;s('instructions');&nbsp;</div></li><li><div>            $this-&gt;order_button_text = $this-&gt;s('checkout_button_text');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/woocommerce_quickpay_loaded/" data-id="1411944" title="woocommerce_quickpay_loaded" class="action">'woocommerce_quickpay_loaded'</a>);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * filter_load_instances function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Loads in extra instances of as separate gateways&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public static&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public static function filter_load_instances($methods)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/instances/instance.php';&nbsp;</div></li><li><div>            require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/instances/mobilepay.php';&nbsp;</div></li><li><div>            require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/instances/viabill.php';&nbsp;</div></li><li><div>            require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/instances/klarna.php';&nbsp;</div></li><li><div>            require_once <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_path/" data-id="1411939" title="WCQP_PATH" class="constant">WCQP_PATH</a> . 'classes/instances/sofort.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $methods[] = '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_mobile_pay/" data-id="1411895" title="WC_QuickPay_MobilePay" class="class">WC_QuickPay_MobilePay</a>';&nbsp;</div></li><li><div>            $methods[] = '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_via_bill/" data-id="1411898" title="WC_QuickPay_ViaBill" class="class">WC_QuickPay_ViaBill</a>';&nbsp;</div></li><li><div>            $methods[] = '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_klarna/" data-id="1411894" title="WC_QuickPay_Klarna" class="class">WC_QuickPay_Klarna</a>';&nbsp;</div></li><li><div>            $methods[] = '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_sofort/" data-id="1411897" title="WC_QuickPay_Sofort" class="class">WC_QuickPay_Sofort</a>';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $methods;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * hooks_and_filters function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Applies plugin hooks and filters&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function hooks_and_filters()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            add_action('woocommerce_api_wc_' . $this-&gt;id, array($this, 'callback_handler'));&nbsp;</div></li><li><div>            add_action('woocommerce_receipt_' . $this-&gt;id, array($this, 'receipt_page'));&nbsp;</div></li><li><div>            add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/woocommerce_order_status_completed/" data-id="1411947" title="woocommerce_order_status_completed" class="action">'woocommerce_order_status_completed'</a>, array($this, 'woocommerce_order_status_completed'));&nbsp;</div></li><li><div>            add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/in_plugin_update_message_woocommerce_quickpay_woocommerce_quickpay_php/" data-id="1411965" title="in_plugin_update_message-woocommerce-quickpay/woocommerce-quickpay.php" class="action">'in_plugin_update_message-woocommerce-quickpay/woocommerce-quickpay.php'</a>, array(__CLASS__, 'in_plugin_update_message'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // WooCommerce Subscriptions hooks/filters&nbsp;</div></li><li><div>            add_action('woocommerce_scheduled_subscription_payment_' . $this-&gt;id, array($this, 'scheduled_subscription_payment'), 10, 2);&nbsp;</div></li><li><div>            add_action('woocommerce_subscription_cancelled_' . $this-&gt;id, array($this, 'subscription_cancellation'));&nbsp;</div></li><li><div>            add_action('woocommerce_subscription_payment_method_updated_to_' . $this-&gt;id, array($this, 'on_subscription_payment_method_updated_to_quickpay'), 10, 2);&nbsp;</div></li><li><div>            add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/wcs_renewal_order_meta_query/" data-id="1411953" title="wcs_renewal_order_meta_query" class="filter">'wcs_renewal_order_meta_query'</a>, array($this, 'remove_failed_quickpay_attempts_meta_query'), 10);&nbsp;</div></li><li><div>            add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/wcs_renewal_order_meta_query/" data-id="1411953" title="wcs_renewal_order_meta_query" class="filter">'wcs_renewal_order_meta_query'</a>, array($this, 'remove_legacy_transaction_id_meta_query'), 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Custom bulk actions&nbsp;</div></li><li><div>            add_action( <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/admin_footer_edit_php/" data-id="1411954" title="admin_footer-edit.php" class="action">'admin_footer-edit.php'</a>, array( $this, 'register_bulk_actions' ) );&nbsp;</div></li><li><div>            add_action( <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/load_edit_php/" data-id="1411955" title="load-edit.php" class="action">'load-edit.php'</a>, array( $this, 'handle_bulk_actions' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // WooCommerce Pre-Orders&nbsp;</div></li><li><div>            add_action('wc_pre_orders_process_pre_order_completion_payment_' . $this-&gt;id, array($this, 'process_pre_order_payments'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (is_admin()) {&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/admin_menu/" data-id="1411958" title="admin_menu" class="action">'admin_menu'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::enqueue_stylesheet');&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/admin_menu/" data-id="1411958" title="admin_menu" class="action">'admin_menu'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::enqueue_javascript_backend');&nbsp;</div></li><li><div>                add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array($this, 'process_admin_options'));&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/wp_ajax_quickpay_manual_transaction_actions/" data-id="1411960" title="wp_ajax_quickpay_manual_transaction_actions" class="action">'wp_ajax_quickpay_manual_transaction_actions'</a>, array($this, 'ajax_quickpay_manual_transaction_actions'));&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/wp_ajax_quickpay_get_transaction_information/" data-id="1411961" title="wp_ajax_quickpay_get_transaction_information" class="action">'wp_ajax_quickpay_get_transaction_information'</a>, array($this, 'ajax_quickpay_get_transaction_information'));&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/wp_ajax_quickpay_empty_logs/" data-id="1411962" title="wp_ajax_quickpay_empty_logs" class="action">'wp_ajax_quickpay_empty_logs'</a>, array($this, 'ajax_empty_logs'));&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/wp_ajax_quickpay_ping_api/" data-id="1411963" title="wp_ajax_quickpay_ping_api" class="action">'wp_ajax_quickpay_ping_api'</a>, array($this, 'ajax_ping_api'));&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/wp_ajax_quickpay_run_data_upgrader/" data-id="1411964" title="wp_ajax_quickpay_run_data_upgrader" class="action">'wp_ajax_quickpay_run_data_upgrader'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_install/" data-id="1411916" title="WC_QuickPay_Install" class="class">WC_QuickPay_Install</a>::ajax_run_upgrader');&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/in_plugin_update_message_woocommerce_quickpay_woocommerce_quickpay_php/" data-id="1411965" title="in_plugin_update_message-woocommerce-quickpay/woocommerce-quickpay.php" class="action">'in_plugin_update_message-woocommerce-quickpay/woocommerce-quickpay.php'</a>, array(__CLASS__, 'in_plugin_update_message'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Make sure not to add these actions multiple times&nbsp;</div></li><li><div>            if (!has_action('init', '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::load_i18n')) {&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/woocommerce_email_before_order_table/" data-id="1411966" title="woocommerce_email_before_order_table" class="action">'woocommerce_email_before_order_table'</a>, array($this, 'email_instructions'), 10, 2);&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/add_meta_boxes/" data-id="1411967" title="add_meta_boxes" class="action">'add_meta_boxes'</a>, array($this, 'add_meta_boxes'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (WC_QuickPay_Helper::option_is_enabled($this-&gt;s('quickpay_orders_transaction_info', 'yes'))) {&nbsp;</div></li><li><div>                    add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/manage_shop_order_posts_custom_column/" data-id="1411968" title="manage_shop_order_posts_custom_column" class="filter">'manage_shop_order_posts_custom_column'</a>, array($this, 'apply_custom_order_data'));&nbsp;</div></li><li><div>                    add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/manage_shop_subscription_posts_custom_column/" data-id="1411969" title="manage_shop_subscription_posts_custom_column" class="filter">'manage_shop_subscription_posts_custom_column'</a>, array($this, 'apply_custom_order_data'));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/admin_notices/" data-id="1411970" title="admin_notices" class="action">'admin_notices'</a>, array($this, 'admin_notices'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/add_action/init/" data-id="1411971" title="init" class="action">'init'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::load_i18n');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/woocommerce_gateway_icon/" data-id="1411972" title="woocommerce_gateway_icon" class="filter">'woocommerce_gateway_icon'</a>, array($this, 'apply_gateway_icons'), 2, 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Third party plugins&nbsp;</div></li><li><div>            add_filter( <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/qtranslate_language_detect_redirect/" data-id="1411973" title="qtranslate_language_detect_redirect" class="filter">'qtranslate_language_detect_redirect'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::qtranslate_prevent_redirect', 10, 3 );&nbsp;</div></li><li><div>            add_filter( <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/wpss_misc_form_spam_check_bypass/" data-id="1411974" title="wpss_misc_form_spam_check_bypass" class="filter">'wpss_misc_form_spam_check_bypass'</a>, '<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::spamshield_bypass_security_check', -10, 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * s function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Returns a setting if set. Introduced to prevent undefined key when introducing new settings.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @param $key&nbsp;</div></li><li><div>         * @param null $default&nbsp;</div></li><li><div>         * @return mixed&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function s($key, $default = NULL)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if (isset($this-&gt;settings[$key])) {&nbsp;</div></li><li><div>                return $this-&gt;settings[$key];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return !is_null($default) ? $default : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Hook used to display admin notices&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function admin_notices()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_settings/" data-id="1411928" title="WC_QuickPay_Settings" class="class">WC_QuickPay_Settings</a>::show_admin_setup_notices();&nbsp;</div></li><li><div>            <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_install/" data-id="1411916" title="WC_QuickPay_Install" class="class">WC_QuickPay_Install</a>::show_update_warning();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * add_action_links function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Adds action links inside the plugin overview&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public static&nbsp;</div></li><li><div>         * @return array&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public static function add_action_links($links)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $links = array_merge(array(&nbsp;</div></li><li><div>                '&lt;a href=&quot;' . <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_settings/" data-id="1411928" title="WC_QuickPay_Settings" class="class">WC_QuickPay_Settings</a>::get_settings_page_url() . '&quot;&gt;' . __('Settings', 'woo-quickpay') . '&lt;/a&gt;', &nbsp;</div></li><li><div> ), $links);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $links;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * ajax_quickpay_manual_transaction_actions function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Ajax method taking manual transactionrequestsfrom wp-admin.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function ajax_quickpay_manual_transaction_actions()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if (isset($_REQUEST['quickpay_action']) AND isset($_REQUEST['post'])) {&nbsp;</div></li><li><div>                $param_action = $_REQUEST['quickpay_action'];&nbsp;</div></li><li><div>                $param_post = $_REQUEST['post'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order((int) $param_post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>                    $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Subscription&nbsp;</div></li><li><div>                    if ($order-&gt;contains_subscription()) {&nbsp;</div></li><li><div>                        $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>                        $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>                    } // Payment&nbsp;</div></li><li><div>                    else {&nbsp;</div></li><li><div>                        $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>                        $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Based on the current transaction state, we check if&nbsp;</div></li><li><div>                    // the requested action is allowed&nbsp;</div></li><li><div>                    if ($payment-&gt;is_action_allowed($param_action)) {&nbsp;</div></li><li><div>                        // Check if the action method is available in the payment class&nbsp;</div></li><li><div>                        if (method_exists($payment, $param_action)) {&nbsp;</div></li><li><div>                            // Fetch amount if sent.&nbsp;</div></li><li><div>                            $amount = isset($_REQUEST['quickpay_amount']) ? <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::price_custom_to_multiplied($_REQUEST['quickpay_amount']) : $payment-&gt;get_remaining_balance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            // Call the action method and parse the transaction id and order object&nbsp;</div></li><li><div>                            call_user_func_array(array($payment, $param_action), array($transaction_id, $order, <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::price_multiplied_to_float($amount)));&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            throw new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/quick_pay_api_exception/" data-id="1411915" title="QuickPay_API_Exception" class="class">QuickPay_API_Exception</a>(sprintf(&quot;Unsupported action: %s.&quot;, $param_action));&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } // The action was not allowed. Throw an exception&nbsp;</div></li><li><div>                    else {&nbsp;</div></li><li><div>                        throw new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/quick_pay_api_exception/" data-id="1411915" title="QuickPay_API_Exception" class="class">QuickPay_API_Exception</a>(sprintf(&nbsp;</div></li><li><div>                            &quot;Action: \&quot;%s\&quot;, is not allowed for order #%d, with type state \&quot;%s\&quot;&quot;, &nbsp;</div></li><li><div>                            $param_action, &nbsp;</div></li><li><div>                            $order-&gt;get_clean_order_number(), &nbsp;</div></li><li><div>                            $payment-&gt;get_current_type()&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } catch (QuickPay_Exception $e) {&nbsp;</div></li><li><div>                    $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                    $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * ajax_quickpay_get_transaction_information function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Ajax method retrieving status information about a transaction&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return json&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function ajax_quickpay_get_transaction_information()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                if (isset($_REQUEST['quickpay-transaction-id']) && isset($_REQUEST['quickpay-post-id'])) {&nbsp;</div></li><li><div>                    $post_id = $_REQUEST['quickpay-post-id'];&nbsp;</div></li><li><div>                    $order = new WC_QuickPay_Order($post_id);&nbsp;</div></li><li><div>                    $transaction_id = $_REQUEST['quickpay-transaction-id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $data_transaction_id = $transaction_id;&nbsp;</div></li><li><div>                    $data_test = '';&nbsp;</div></li><li><div>                    $data_order = $order-&gt;get_transaction_order_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Subscription&nbsp;</div></li><li><div>                    if (WC_QuickPay_Subscription::is_subscription($post_id)) {&nbsp;</div></li><li><div>                        $transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>                        $transaction-&gt;get($transaction_id);&nbsp;</div></li><li><div>                        $status = $transaction-&gt;get_current_type() . ' (' . __('subscription', 'woo-quickpay') . ')';&nbsp;</div></li><li><div>                    } // Renewal failure&nbsp;</div></li><li><div>                    else if ($order-&gt;subscription_is_renewal_failure()) {&nbsp;</div></li><li><div>                        $data_transaction_id .= ' ( ' . __('initial order transaction ID', 'woo-quickpay') . ')';&nbsp;</div></li><li><div>                        $status = __('Failed renewal', 'woo-quickpay');&nbsp;</div></li><li><div>                    } // Payment&nbsp;</div></li><li><div>                    else {&nbsp;</div></li><li><div>                        $transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>                        $transaction-&gt;get($transaction_id);&nbsp;</div></li><li><div>                        $status = $transaction-&gt;get_current_type();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if (isset($transaction) AND is_object($transaction) AND $transaction-&gt;is_test()) {&nbsp;</div></li><li><div>                        $data_test = __('Test transaction', 'woo-quickpay');&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $response = array(&nbsp;</div></li><li><div>                        'id' =&gt; array(&nbsp;</div></li><li><div>                            'value' =&gt; sprintf(__('Transaction ID: %s', 'woo-quickpay'), $data_transaction_id)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'order' =&gt; array(&nbsp;</div></li><li><div>                            'value' =&gt; empty($data_order) ? '' : sprintf(__('Transaction Order ID: %s', 'woo-quickpay'), $data_order)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'status' =&gt; array(&nbsp;</div></li><li><div>                            'value' =&gt; sprintf(__('Transaction state: %s', 'woo-quickpay'), $status), &nbsp;</div></li><li><div>                            'attr' =&gt; array(&nbsp;</div></li><li><div>                                'class' =&gt; 'woocommerce-quickpay-' . $status&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'test' =&gt; array(&nbsp;</div></li><li><div>                            'value' =&gt; $data_test, &nbsp;</div></li><li><div>                            'attr' =&gt; array(&nbsp;</div></li><li><div>                                'style' =&gt; empty($data_test) ? '' : 'color:red'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        'cardtype' =&gt; array(&nbsp;</div></li><li><div>                            'value' =&gt; sprintf('&lt;img src=&quot;%s&quot; /&gt;', <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::get_payment_type_logo($transaction-&gt;get_brand()))&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    echo json_encode($response);&nbsp;</div></li><li><div>                    exit;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $response = array(&nbsp;</div></li><li><div>                    error =&gt; array(&nbsp;</div></li><li><div>                        'value' =&gt; $e-&gt;getMessage()&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                echo json_encode($response);&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * ajax_empty_logs function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Ajax method to empty the debug logs&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return json&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function ajax_empty_logs()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $this-&gt;log-&gt;clear();&nbsp;</div></li><li><div>            echo json_encode(array('status' =&gt; 'success', 'message' =&gt; 'Logs successfully emptied'));&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Checks if an API key is able to connect to the API&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function ajax_ping_api()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $status = error;&nbsp;</div></li><li><div>            if (!empty($_POST['apiKey'])) {&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>                    $api = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api/" data-id="1411884" title="WC_QuickPay_API" class="class">WC_QuickPay_API</a>(sanitize_text_field($_POST['apiKey']));&nbsp;</div></li><li><div>                    $api-&gt;get('/payments?page_size=1');&nbsp;</div></li><li><div>                    $status = 'success';&nbsp;</div></li><li><div>                } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                    //&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            echo json_encode(array('status' =&gt; $status));&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * woocommerce_order_status_completed function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Captures one or several transactions when order state changes to complete.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function woocommerce_order_status_completed($post_id)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            // Instantiate new order object&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($post_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check the gateway settings.&nbsp;</div></li><li><div>            if ($order-&gt;has_quickpay_payment() && <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::option_is_enabled($this-&gt;s('quickpay_captureoncomplete'))) {&nbsp;</div></li><li><div>                // Capture only orders that are actual payments (regular orders / recurring payments)&nbsp;</div></li><li><div>                if (!WC_QuickPay_Subscription::is_subscription($order)) {&nbsp;</div></li><li><div>                    $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>                    $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Check if there is a transaction ID&nbsp;</div></li><li><div>                    if ($transaction_id) {&nbsp;</div></li><li><div>                        // Retrieve resource data about the transaction&nbsp;</div></li><li><div>                        $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Check if the transaction can be captured&nbsp;</div></li><li><div>                        if ($payment-&gt;is_action_allowed('capture')) {&nbsp;</div></li><li><div>                            // Capture the payment&nbsp;</div></li><li><div>                            $payment-&gt;capture($transaction_id, $order);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * payment_fields function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Prints out the description of the gateway. Also adds two checkboxes for viaBill/creditcard for customers to choose how to pay.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function payment_fields()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if ($this-&gt;description) echo wpautop(wptexturize($this-&gt;description));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * receipt_page function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Shows the recipt. This is the very last step before opening the payment window.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function receipt_page($order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            echo $this-&gt;generate_quickpay_form($order);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Processing payments on checkout&nbsp;</div></li><li><div>         * @param $order_id&nbsp;</div></li><li><div>         * @return array&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function process_payment($order_id)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                // Instantiate order object&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Does the order need a new QuickPay payment?&nbsp;</div></li><li><div>                $needs_payment = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Default redirect to&nbsp;</div></li><li><div>                $redirect_to = $this-&gt;get_return_url($order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Instantiate a new transaction&nbsp;</div></li><li><div>                $api_transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If the order is a subscripion or an attempt of updating the payment method&nbsp;</div></li><li><div>                if (! <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_subscription/" data-id="1411927" title="WC_QuickPay_Subscription" class="class">WC_QuickPay_Subscription</a>::cart_contains_switches() && ($order-&gt;contains_subscription() || $order-&gt;is_request_to_change_payment())) {&nbsp;</div></li><li><div>                    // Instantiate a subscription transaction instead of a payment transaction&nbsp;</div></li><li><div>                    $api_transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>                    // Clean up any legacy data regarding old payment links before creating a new payment.&nbsp;</div></li><li><div>                    $order-&gt;delete_payment_id();&nbsp;</div></li><li><div>                    $order-&gt;delete_payment_link();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // If the order contains a product switch and does not need a payment, we will skip the QuickPay&nbsp;</div></li><li><div>                // payment window since we do not need to create a new payment nor modify an existing.&nbsp;</div></li><li><div>                else if ($order-&gt;order_contains_switch() && ! $order-&gt;needs_payment()) {&nbsp;</div></li><li><div>                    $needs_payment = false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($needs_payment) {&nbsp;</div></li><li><div>                    // Create a new object&nbsp;</div></li><li><div>                    $payment = new stdClass();&nbsp;</div></li><li><div>                    // If a payment ID exists, go get it&nbsp;</div></li><li><div>                    $payment-&gt;id = $order-&gt;get_payment_id();&nbsp;</div></li><li><div>                    // Create a payment link&nbsp;</div></li><li><div>                    $link = new stdClass();&nbsp;</div></li><li><div>                    // If a payment link exists, go get it&nbsp;</div></li><li><div>                    $link-&gt;url = $order-&gt;get_payment_link();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // If the order does not already have a payment ID, &nbsp;</div></li><li><div>                    // we will create one an attach it to the order&nbsp;</div></li><li><div>                    // We also check if a payment already exists. If a link exists, we don't&nbsp;</div></li><li><div>                    // need to create a payment.&nbsp;</div></li><li><div>                    if (empty($payment-&gt;id) && empty($link-&gt;url)) {&nbsp;</div></li><li><div>                        $payment = $api_transaction-&gt;create($order);&nbsp;</div></li><li><div>                        $order-&gt;set_payment_id($payment-&gt;id);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Create or update the payment link. This is necessary to do EVERY TIME&nbsp;</div></li><li><div>                    // to avoid fraud with changing amounts.&nbsp;</div></li><li><div>                    $link = $api_transaction-&gt;patch_link($payment-&gt;id, $order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if (WC_QuickPay_Helper::is_url($link-&gt;url)) {&nbsp;</div></li><li><div>                        $order-&gt;set_payment_link($link-&gt;url);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Overwrite the standard checkout url. Go to the QuickPay payment window.&nbsp;</div></li><li><div>                    if (WC_QuickPay_Helper::is_url($link-&gt;url)) {&nbsp;</div></li><li><div>                        $redirect_to = $link-&gt;url;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Perform redirect&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'result' =&gt; 'success', &nbsp;</div></li><li><div>                    'redirect' =&gt; $redirect_to&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } catch (QuickPay_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                wc_add_notice( $e-&gt;getMessage(), error );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * HOOK: Handles pre-order payments&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function process_pre_order_payments($order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            // Set order object&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get transaction ID&nbsp;</div></li><li><div>            $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if there is a transaction ID&nbsp;</div></li><li><div>            if ($transaction_id) {&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>                    // Set payment object&nbsp;</div></li><li><div>                    $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Retrieve resource data about the transaction&nbsp;</div></li><li><div>                    $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Check if the transaction can be captured&nbsp;</div></li><li><div>                    if ($payment-&gt;is_action_allowed('capture')) {&nbsp;</div></li><li><div>                        try {&nbsp;</div></li><li><div>                            // Capture the payment&nbsp;</div></li><li><div>                            $payment-&gt;capture($transaction_id, $order);&nbsp;</div></li><li><div>                        } // Payment failed&nbsp;</div></li><li><div>                        catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                            $this-&gt;log-&gt;add(&nbsp;</div></li><li><div>                                sprintf(&quot;Could not process pre-order payment for order: #%s with transaction id: %s. Payment failed. Exception: %s&quot;, &nbsp;</div></li><li><div>                                    $order-&gt;get_clean_order_number(), $transaction_id, $e-&gt;getMessage())&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $order-&gt;update_status('failed');&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(&nbsp;</div></li><li><div>                        sprintf(&quot;Could not process pre-order payment for order: #%s with transaction id: %s. Transaction not found. Exception: %s&quot;, &nbsp;</div></li><li><div>                            $order-&gt;get_clean_order_number(), $transaction_id, $e-&gt;getMessage())&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Process refunds&nbsp;</div></li><li><div>         * WooCommerce 2.2 or later&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param  int $order_id&nbsp;</div></li><li><div>         * @param  float $amount&nbsp;</div></li><li><div>         * @param  string $reason&nbsp;</div></li><li><div>         * @return bool|WP_Error&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function process_refund($order_id, $amount = NULL, $reason = '')&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Check if there is a transaction ID&nbsp;</div></li><li><div>                if (!$transaction_id) {&nbsp;</div></li><li><div>                    throw new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/quick_pay_exception/" data-id="1411914" title="QuickPay_Exception" class="class">QuickPay_Exception</a>(sprintf(__(&quot;No transaction ID for order: %s&quot;, 'woo-quickpay'), $order_id));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Create a payment instance and retrieve transaction information&nbsp;</div></li><li><div>                $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>                $payment-&gt;get($transaction_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Check if the transaction can be refunded&nbsp;</div></li><li><div>                if (!$payment-&gt;is_action_allowed('refund')) {&nbsp;</div></li><li><div>                    throw new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/quick_pay_exception/" data-id="1411914" title="QuickPay_Exception" class="class">QuickPay_Exception</a>(__(&quot;Transaction state does not allow refunds.&quot;, 'woo-quickpay'));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Perform a refund API request&nbsp;</div></li><li><div>                $payment-&gt;refund($transaction_id, $order, $amount);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return TRUE;&nbsp;</div></li><li><div>            } catch (QuickPay_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return FALSE;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Clear cart in case its not already done.&nbsp;</div></li><li><div>         * @return [type] [description]&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function thankyou_page()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            global $woocommerce;&nbsp;</div></li><li><div>            $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * scheduled_subscription_payment function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Runs every time a scheduled renewal of a subscription is required&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return The API response&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function scheduled_subscription_payment($amount_to_charge, $renewal_order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            // Create subscription instance&nbsp;</div></li><li><div>            $transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Block the callback&nbsp;</div></li><li><div>            $transaction-&gt;block_callback = TRUE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** @var WC_Subscription $subscription */&nbsp;</div></li><li><div>            // Get the subscription based on the renewal order&nbsp;</div></li><li><div>            $subscription = <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_subscription/" data-id="1411927" title="WC_QuickPay_Subscription" class="class">WC_QuickPay_Subscription</a>::get_subscriptions_for_renewal_order($renewal_order, $single = TRUE);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subscription_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $subscription-&gt;id : $subscription-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Make new instance to properly get the transaction ID with built in fallbacks.&nbsp;</div></li><li><div>            $subscription_order = new WC_QuickPay_Order($subscription_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get the transaction ID from the subscription&nbsp;</div></li><li><div>            $transaction_id = $subscription_order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Capture a recurring payment with fixed amount&nbsp;</div></li><li><div>            $response = $this-&gt;process_recurring_payment($transaction, $transaction_id, $amount_to_charge, $renewal_order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Wrapper to process a recurring payment on an order/subscription&nbsp;</div></li><li><div>         * @param <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a> $transaction&nbsp;</div></li><li><div>         * @param $subscription_transaction_id&nbsp;</div></li><li><div>         * @param $amount_to_charge&nbsp;</div></li><li><div>         * @param $order&nbsp;</div></li><li><div>         * @return mixed&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function process_recurring_payment(WC_QuickPay_API_Subscription $transaction, $subscription_transaction_id, $amount_to_charge, $order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if (!$order instanceof WC_QuickPay_Order) {&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order($order);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $response = NULL;&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                // Block the callback&nbsp;</div></li><li><div>                $transaction-&gt;block_callback = TRUE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Capture a recurring payment with fixed amount&nbsp;</div></li><li><div>                list($response) = $transaction-&gt;recurring($subscription_transaction_id, $order, $amount_to_charge);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (!$response-&gt;accepted) {&nbsp;</div></li><li><div>                    throw new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/quick_pay_exception/" data-id="1411914" title="QuickPay_Exception" class="class">QuickPay_Exception</a>(&quot;Recurring payment not accepted by acquirer.&quot;);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If there is a fee added to the transaction.&nbsp;</div></li><li><div>                if (!empty($response-&gt;fee)) {&nbsp;</div></li><li><div>                    $order-&gt;add_transaction_fee($response-&gt;fee);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // Process the recurring payment on the orders&nbsp;</div></li><li><div>                <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_subscription/" data-id="1411927" title="WC_QuickPay_Subscription" class="class">WC_QuickPay_Subscription</a>::process_recurring_response($response, $order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Reset failed attempts.&nbsp;</div></li><li><div>                $order-&gt;reset_failed_quickpay_payment_count();&nbsp;</div></li><li><div>            } catch (QuickPay_Exception $e) {&nbsp;</div></li><li><div>                $order-&gt;increase_failed_quickpay_payment_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Set the payment as failed&nbsp;</div></li><li><div>                $order-&gt;update_status('failed', 'Automatic renewal of ' . $order-&gt;get_order_number() . ' failed. Message: ' . $e-&gt;getMessage());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Write debug information to the logs&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                $order-&gt;increase_failed_quickpay_payment_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Set the payment as failed&nbsp;</div></li><li><div>                $order-&gt;update_status('failed', 'Automatic renewal of ' . $order-&gt;get_order_number() . ' failed. Message: ' . $e-&gt;getMessage());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Write debug information to the logs&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Prevents the failed attempts count to be copied to renewal orders&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param $order_meta_query&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function remove_failed_quickpay_attempts_meta_query($order_meta_query)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $order_meta_query .= &quot; AND `meta_key` NOT IN ('&quot; . WC_QuickPay_Order::META_FAILED_PAYMENT_COUNT . &quot;')&quot;;&nbsp;</div></li><li><div>            $order_meta_query .= &quot; AND `meta_key` NOT IN ('_quickpay_transaction_id')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $order_meta_query;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Prevents the legacy transaction ID from being copied to renewal orders&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param $order_meta_query&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function remove_legacy_transaction_id_meta_query($order_meta_query)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $order_meta_query .= &quot; AND `meta_key` NOT IN ('TRANSACTION_ID')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $order_meta_query;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Triggered when customers are changing payment method to QuickPay.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param $new_payment_method&nbsp;</div></li><li><div>         * @param $subscription&nbsp;</div></li><li><div>         * @param $old_payment_method&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function on_subscription_payment_method_updated_to_quickpay($subscription, $old_payment_method)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $subscription_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $subscription-&gt;id : $subscription-&gt;get_id();&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($subscription_id);&nbsp;</div></li><li><div>            $order-&gt;increase_payment_method_change_count();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * subscription_cancellation function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Cancels a transaction when the subscription is cancelled&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @param WC_Order $order - WC_Order object&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function subscription_cancellation($order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if ('cancelled' !== $order-&gt;get_status()) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                if (WC_QuickPay_Subscription::is_subscription($order)) {&nbsp;</div></li><li><div>                    $order = new WC_QuickPay_Order($order);&nbsp;</div></li><li><div>                    $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $subscription = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>                    $subscription-&gt;get($transaction_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($subscription-&gt;is_action_allowed('cancel')) {&nbsp;</div></li><li><div>                        $subscription-&gt;cancel($transaction_id);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } catch (QuickPay_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                $e-&gt;write_to_logs();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * on_order_cancellation function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Is called when a customer cancels the payment process from the QuickPay payment window.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function on_order_cancellation($order_id)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $order = new WC_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Redirect the customer to account page if the current order is failed&nbsp;</div></li><li><div>            if ($order-&gt;get_status() === 'failed') {&nbsp;</div></li><li><div>                $payment_failure_text = sprintf(__('&lt;p&gt;&lt;strong&gt;Payment failure&lt;/strong&gt; A problem with your payment on order &lt;strong&gt;#%i&lt;/strong&gt; occured. Please try again to complete your order.&lt;/p&gt;', 'woo-quickpay'), $order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wc_add_notice($payment_failure_text, error);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_redirect(get_permalink(get_option('woocommerce_myaccount_page_id')));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order-&gt;add_order_note(__('QuickPay Payment', 'woo-quickpay') . ': ' . __('Cancelled during process', 'woo-quickpay'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_add_notice(__('&lt;p&gt;&lt;strong&gt;%s&lt;/strong&gt;: %s&lt;/p&gt;', &nbsp;</div></li><li><div>                    __('Payment cancelled', 'woo-quickpay'), &nbsp;</div></li><li><div>                    __('Due to cancellation of your payment, the order process was not completed. Please fulfill the payment to complete your order.', 'woo-quickpay')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            error);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * callback_handler function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Is called after a payment has been submitted in the QuickPay payment window.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function callback_handler()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            // Get callback body&nbsp;</div></li><li><div>            $request_body = file_get_contents(&quot;php://input&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($request_body)) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Decode the body into JSON&nbsp;</div></li><li><div>            $json = json_decode($request_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Instantiate payment object&nbsp;</div></li><li><div>            $payment = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>($json);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Fetch order number;&nbsp;</div></li><li><div>            $order_number = WC_QuickPay_Order::get_order_id_from_callback($json);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Fetch subscription post ID if present&nbsp;</div></li><li><div>            $subscription_id = WC_QuickPay_Order::get_subscription_id_from_callback($json);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!empty($subscription_id)) {&nbsp;</div></li><li><div>                $subscription = new WC_QuickPay_Order($subscription_id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($payment-&gt;is_authorized_callback($request_body)) {&nbsp;</div></li><li><div>                // Instantiate order object&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order($order_number);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Get last transaction in operation history&nbsp;</div></li><li><div>                $transaction = end($json-&gt;operations);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Is the transaction accepted and approved by QP / Acquirer?&nbsp;</div></li><li><div>                if ($json-&gt;accepted) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Perform action depending on the operation status type&nbsp;</div></li><li><div>                    try {&nbsp;</div></li><li><div>                        switch ($transaction-&gt;type) {&nbsp;</div></li><li><div>                            //&nbsp;</div></li><li><div>                            // Cancel callbacks are currently not supported by the QuickPay API&nbsp;</div></li><li><div>                            //&nbsp;</div></li><li><div>                            case 'cancel' :&nbsp;</div></li><li><div>                                // Write a note to the order history&nbsp;</div></li><li><div>                                $order-&gt;note(__('Payment cancelled.', 'woo-quickpay'));&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            case 'capture' :&nbsp;</div></li><li><div>                                // Write a note to the order history&nbsp;</div></li><li><div>                                $order-&gt;note(__('Payment captured.', 'woo-quickpay'));&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            case 'refund' :&nbsp;</div></li><li><div>                                $order-&gt;note(sprintf(__('Refunded %s %s', 'woo-quickpay'), <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_helper/" data-id="1411917" title="WC_QuickPay_Helper" class="class">WC_QuickPay_Helper</a>::price_normalize($transaction-&gt;amount), $json-&gt;currency));&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            case 'authorize' :&nbsp;</div></li><li><div>                                // Set the transaction order ID&nbsp;</div></li><li><div>                                $order-&gt;set_transaction_order_id($json-&gt;order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                // Remove payment link&nbsp;</div></li><li><div>                                $order-&gt;delete_payment_link();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                // Remove payment ID, now we have the transaction ID&nbsp;</div></li><li><div>                                $order-&gt;delete_payment_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                // Subscription authorization&nbsp;</div></li><li><div>                                if (!empty($subscription_id)) {&nbsp;</div></li><li><div>                                    // Write log&nbsp;</div></li><li><div>                                    $subscription-&gt;note(sprintf(__('Subscription authorized. Transaction ID: %s', 'woo-quickpay'), $json-&gt;id));&nbsp;</div></li><li><div>                                    // Activate the subscription&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // Check if there is an initial payment on the subscription.&nbsp;</div></li><li><div>                                    // We are saving the total before completing the original payment.&nbsp;</div></li><li><div>                                    // This gives us the correct payment for the auto initial payment on subscriptions.&nbsp;</div></li><li><div>                                    $subscription_initial_payment = $order-&gt;get_total();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // Mark the payment as complete&nbsp;</div></li><li><div>                                    //$subscription-&gt;set_transaction_id($json-&gt;id);&nbsp;</div></li><li><div>                                    // Temporarily save the transaction ID on a custom meta row to avoid empty values in 3.0.&nbsp;</div></li><li><div>                                    update_post_meta( $subscription_id, '_quickpay_transaction_id', $json-&gt;id );&nbsp;</div></li><li><div>                                    //$subscription-&gt;payment_complete($json-&gt;id);&nbsp;</div></li><li><div>                                    $subscription-&gt;set_transaction_order_id($json-&gt;order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // Only make an instant payment if there is an initial payment&nbsp;</div></li><li><div>                                    if ($subscription_initial_payment &gt; 0) {&nbsp;</div></li><li><div>                                        // Check if this is an order containing a subscription&nbsp;</div></li><li><div>                                        if (!WC_QuickPay_Subscription::is_subscription($order_id) && $order-&gt;contains_subscription()) {&nbsp;</div></li><li><div>                                            // Process a recurring payment.&nbsp;</div></li><li><div>                                            $this-&gt;process_recurring_payment(new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>(), $json-&gt;id, $subscription_initial_payment, $order);&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    // If there is no initial payment, we will mark the order as complete.&nbsp;</div></li><li><div>                                    // This is usually happening if a subscription has a free trial.&nbsp;</div></li><li><div>                                    else {&nbsp;</div></li><li><div>                                        $order-&gt;payment_complete();&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                } // Regular payment authorization&nbsp;</div></li><li><div>                                else {&nbsp;</div></li><li><div>                                    // Add order transaction fee if available&nbsp;</div></li><li><div>                                    if (!empty($json-&gt;fee)) {&nbsp;</div></li><li><div>                                        $order-&gt;add_transaction_fee($json-&gt;fee);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // Check for pre-order&nbsp;</div></li><li><div>                                    if (WC_QuickPay_Helper::has_preorder_plugin() && WC_Pre_Orders_Order::order_contains_pre_order($order) && WC_Pre_Orders_Order::order_requires_payment_tokenization($order_id)) {&nbsp;</div></li><li><div>                                        try {&nbsp;</div></li><li><div>                                            // Set transaction ID without marking the payment as complete&nbsp;</div></li><li><div>                                            $order-&gt;set_transaction_id($json-&gt;id);&nbsp;</div></li><li><div>                                        } catch (WC_Data_Exception $e) {&nbsp;</div></li><li><div>                                            $this-&gt;log-&gt;add(__( 'Anerroroccured while setting transaction id: %d on order %s. %s', $json-&gt;id, $order_id, $e-&gt;getMessage()));&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        WC_Pre_Orders_Order::mark_order_as_pre_ordered($order);&nbsp;</div></li><li><div>                                    } // Regular product&nbsp;</div></li><li><div>                                    else {&nbsp;</div></li><li><div>                                        // Register the payment on the order&nbsp;</div></li><li><div>                                        $order-&gt;payment_complete($json-&gt;id);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // Write a note to the order history&nbsp;</div></li><li><div>                                    $order-&gt;note(sprintf(__('Payment authorized. Transaction ID: %s', 'woo-quickpay'), $json-&gt;id));&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        do_action('woocommerce_quickpay_accepted_callback_status_' . $transaction-&gt;type, $order, $json);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                        $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // The transaction was not accepted.&nbsp;</div></li><li><div>                // Print debug information to logs&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    // Write debug information&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;separator();&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(sprintf(__('Transaction failed for #%s.', 'woo-quickpay'), $order_number));&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(sprintf(__('QuickPay status code: %s.', 'woo-quickpay'), $transaction-&gt;qp_status_code));&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(sprintf(__('QuickPay status message: %s.', 'woo-quickpay'), $transaction-&gt;qp_status_msg));&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(sprintf(__('Acquirer status code: %s', 'woo-quickpay'), $transaction-&gt;aq_status_code));&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;add(sprintf(__('Acquirer status message: %s', 'woo-quickpay'), $transaction-&gt;aq_status_msg));&nbsp;</div></li><li><div>                    $this-&gt;log-&gt;separator();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($transaction-&gt;type == 'recurring') {&nbsp;</div></li><li><div>                        WC_Subscriptions_Manager::process_subscription_payment_failure_on_order($order);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ('rejected' != $json-&gt;state) {&nbsp;</div></li><li><div>                        // Update the order statuses&nbsp;</div></li><li><div>                        if ($transaction-&gt;type == 'subscribe') {&nbsp;</div></li><li><div>                            WC_Subscriptions_Manager::process_subscription_payment_failure_on_order($order);&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $order-&gt;update_status('failed');&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;log-&gt;add(sprintf(__('Invalid callback body for order #%s.', 'woo-quickpay'), $order_number));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * init_form_fields function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Initiates the plugin settings form fields&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return array&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function init_form_fields()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $this-&gt;form_fields = <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_settings/" data-id="1411928" title="WC_QuickPay_Settings" class="class">WC_QuickPay_Settings</a>::get_fields();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * admin_options function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Prints the admin settings form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function admin_options()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            echo &quot;&lt;h3&gt;QuickPay - {$this-&gt;id}, v&quot; . <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_version/" data-id="1411937" title="WCQP_VERSION" class="constant">WCQP_VERSION</a> . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;p&gt;&quot; . __('Allows you to receive payments via QuickPay.', 'woo-quickpay') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_settings/" data-id="1411928" title="WC_QuickPay_Settings" class="class">WC_QuickPay_Settings</a>::clear_logs_section();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/woocommerce_quickpay_settings_table_before/" data-id="1411976" title="woocommerce_quickpay_settings_table_before" class="action">'woocommerce_quickpay_settings_table_before'</a>);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;table class=\&quot;form-table\&quot;&gt;&quot;;&nbsp;</div></li><li><div>            $this-&gt;generate_settings_html();&nbsp;</div></li><li><div>            echo &quot;&lt;/table&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/actions/woocommerce_quickpay_settings_table_after/" data-id="1411977" title="woocommerce_quickpay_settings_table_after" class="action">'woocommerce_quickpay_settings_table_after'</a>);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * add_meta_boxes function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Adds the action meta box inside the single order view.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function add_meta_boxes()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $screen = get_current_screen();&nbsp;</div></li><li><div>            $post_types = array('shop_order', 'shop_subscription');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array($screen-&gt;id, $post_types, true) && in_array( $post-&gt;post_type, $post_types, true ) ) {&nbsp;</div></li><li><div>                $order = new WC_QuickPay_Order($post-&gt;ID);&nbsp;</div></li><li><div>                if ($order-&gt;has_quickpay_payment()) {&nbsp;</div></li><li><div>                    add_meta_box('quickpay-payment-actions', __('QuickPay Payment', 'woo-quickpay'), array(&$this, 'meta_box_payment'), 'shop_order', 'side', 'high');&nbsp;</div></li><li><div>                    add_meta_box('quickpay-payment-actions', __('QuickPay Subscription', 'woo-quickpay'), array(&$this, 'meta_box_subscription'), 'shop_subscription', 'side', 'high');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * meta_box_payment function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Inserts the content of the API actions meta box - Payments&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function meta_box_payment()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            global $post;&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>            if ($transaction_id && $order-&gt;has_quickpay_payment()) {&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>                    $transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_payment/" data-id="1411881" title="WC_QuickPay_API_Payment" class="class">WC_QuickPay_API_Payment</a>();&nbsp;</div></li><li><div>                    $transaction-&gt;get($transaction_id);&nbsp;</div></li><li><div>                    $status = $transaction-&gt;get_current_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    echo &quot;&lt;p class=\&quot;woocommerce-quickpay-{$status}\&quot;&gt;&lt;strong&gt;&quot; . __('Current payment state', 'woo-quickpay') . &quot;: &quot; . $status . &quot;&lt;/strong&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($transaction-&gt;is_action_allowed('standard_actions')) {&nbsp;</div></li><li><div>                        echo &quot;&lt;h4&gt;&lt;strong&gt;&quot; . __('Actions', 'woo-quickpay') . &quot;&lt;/strong&gt;&lt;/h4&gt;&quot;;&nbsp;</div></li><li><div>                        echo &quot;&lt;ul class=\&quot;order_action\&quot;&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($transaction-&gt;is_action_allowed('capture')) {&nbsp;</div></li><li><div>                            echo &quot;&lt;li class=\&quot;qp-full-width\&quot;&gt;&lt;a class=\&quot;button button-primary\&quot; data-action=\&quot;capture\&quot; data-confirm=\&quot;&quot; . __('You are about to CAPTURE this payment', 'woo-quickpay') . &quot;\&quot;&gt;&quot; . sprintf(__('Capture Full Amount (%s)', 'woo-quickpay'), $transaction-&gt;get_formatted_remaining_balance()) . &quot;&lt;/a&gt;&lt;/li&gt;&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        printf(&quot;&lt;li class=\&quot;qp-balance\&quot;&gt;&lt;span class=\&quot;qp-balance__label\&quot;&gt;%s:&lt;/span&gt;&lt;span class=\&quot;qp-balance__amount\&quot;&gt;&lt;span class='qp-balance__currency'&gt;%s&lt;/span&gt;%s&lt;/span&gt;&lt;/li&gt;&quot;, __('Remaining balance', 'woo-quickpay'), $transaction-&gt;get_currency(), $transaction-&gt;get_formatted_remaining_balance());&nbsp;</div></li><li><div>                        printf(&quot;&lt;li class=\&quot;qp-balance last\&quot;&gt;&lt;span class=\&quot;qp-balance__label\&quot;&gt;%s:&lt;/span&gt;&lt;span class=\&quot;qp-balance__amount\&quot;&gt;&lt;span class='qp-balance__currency'&gt;%s&lt;/span&gt;&lt;input id='qp-balance__amount-field' type='text' value='%s' /&gt;&lt;/span&gt;&lt;/li&gt;&quot;, __('Capture amount', 'woo-quickpay'), $transaction-&gt;get_currency(), $transaction-&gt;get_formatted_remaining_balance());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($transaction-&gt;is_action_allowed('capture')) {&nbsp;</div></li><li><div>                            echo &quot;&lt;li class=\&quot;qp-full-width\&quot;&gt;&lt;a class=\&quot;button\&quot; data-action=\&quot;captureAmount\&quot; data-confirm=\&quot;&quot; . __('You are about to CAPTURE this payment', 'woo-quickpay') . &quot;\&quot;&gt;&quot; . __('Capture Specified Amount', 'woo-quickpay') . &quot;&lt;/a&gt;&lt;/li&gt;&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($transaction-&gt;is_action_allowed('cancel')) {&nbsp;</div></li><li><div>                            echo &quot;&lt;li class=\&quot;qp-full-width\&quot;&gt;&lt;a class=\&quot;button\&quot; data-action=\&quot;cancel\&quot; data-confirm=\&quot;&quot; . __('You are about to CANCEL this payment', 'woo-quickpay') . &quot;\&quot;&gt;&quot; . __('Cancel', 'woo-quickpay') . &quot;&lt;/a&gt;&lt;/li&gt;&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        echo &quot;&lt;/ul&gt;&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; %d &lt;span class=&quot;qp-meta-card&quot;&gt;&lt;img src=&quot;%s&quot; /&gt;&lt;/span&gt;&lt;/small&gt;', &nbsp;</div></li><li><div>                        __('Transaction ID', 'woo-quickpay'), &nbsp;</div></li><li><div>                        $transaction_id, &nbsp;</div></li><li><div>                       WC_Quickpay_Helperget_payment_type_logo($transaction-&gt;get_brand())&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $transaction_order_id = $order-&gt;get_transaction_order_id();&nbsp;</div></li><li><div>                    if (isset($transaction_order_id) && !empty($transaction_order_id)) {&nbsp;</div></li><li><div>                        printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; %s&lt;/small&gt;', __('Transaction Order ID', 'woo-quickpay'), $transaction_order_id);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                    $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                    $e-&gt;write_standard_warning();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Show payment ID and payment link for orders that have not yet&nbsp;</div></li><li><div>            // been paid. Show this information even if the transaction ID is missing.&nbsp;</div></li><li><div>            $payment_id = $order-&gt;get_payment_id();&nbsp;</div></li><li><div>            if (isset($payment_id) && !empty($payment_id)) {&nbsp;</div></li><li><div>                printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; %d&lt;/small&gt;', __('Payment ID', 'woo-quickpay'), $payment_id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $payment_link = $order-&gt;get_payment_link();&nbsp;</div></li><li><div>            if (isset($payment_link) && !empty($payment_link)) {&nbsp;</div></li><li><div>                printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; &lt;br /&gt;&lt;input type=&quot;text&quot; style=&quot;%s&quot;value=&quot;%s&quot; readonly /&gt;&lt;/small&gt;&lt;/p&gt;', __('Payment Link', 'woo-quickpay'), 'width:100%', $payment_link);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * meta_box_payment function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Inserts the content of the API actions meta box - Subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function meta_box_subscription()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            global $post;&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>            if ($transaction_id && $order-&gt;has_quickpay_payment()) {&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $transaction = new <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_api_subscription/" data-id="1411882" title="WC_QuickPay_API_Subscription" class="class">WC_QuickPay_API_Subscription</a>();&nbsp;</div></li><li><div>                    $transaction-&gt;get($transaction_id);&nbsp;</div></li><li><div>                    $status = $transaction-&gt;get_current_type() . ' (' . __('subscription', 'woo-quickpay') . ')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    echo &quot;&lt;p class=\&quot;woocommerce-quickpay-{$status}\&quot;&gt;&lt;strong&gt;&quot; . __('Current payment state', 'woo-quickpay') . &quot;: &quot; . $status . &quot;&lt;/strong&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; %d &lt;span class=&quot;qp-meta-card&quot;&gt;&lt;img src=&quot;%s&quot; /&gt;&lt;/span&gt;&lt;/small&gt;', &nbsp;</div></li><li><div>                        __('Transaction ID', 'woo-quickpay'), &nbsp;</div></li><li><div>                        $transaction_id, &nbsp;</div></li><li><div>                       WC_Quickpay_Helperget_payment_type_logo($transaction-&gt;get_brand())&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $transaction_order_id = $order-&gt;get_transaction_order_id();&nbsp;</div></li><li><div>                    if (isset($transaction_order_id) && !empty($transaction_order_id)) {&nbsp;</div></li><li><div>                        printf('&lt;p&gt;&lt;small&gt;&lt;strong&gt;%s:&lt;/strong&gt; %s&lt;/small&gt;', __('Transaction Order ID', 'woo-quickpay'), $transaction_order_id);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } catch (QuickPay_API_Exception $e) {&nbsp;</div></li><li><div>                    $e-&gt;write_to_logs();&nbsp;</div></li><li><div>                    $e-&gt;write_standard_warning();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * email_instructions function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Adds custom text to the order confirmation email.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param WC_Order $order&nbsp;</div></li><li><div>         * @param boolean $sent_to_admin&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @return bool /string/void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function email_instructions($order, $sent_to_admin)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $payment_method = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;payment_method : $order-&gt;get_payment_method();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($sent_to_admin || ($order-&gt;get_status() !== 'processing' && $order-&gt;get_status() !== 'completed') || $payment_method !== 'quickpay') {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($this-&gt;instructions) {&nbsp;</div></li><li><div>                echo wpautop(wptexturize($this-&gt;instructions));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * apply_custom_order_data function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Applies transaction ID and state to the order data overview&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function apply_custom_order_data($column)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            global $post, $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = new WC_QuickPay_Order($post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // ? ABOVE 2.1 : BELOW 2.1&nbsp;</div></li><li><div>            $check_column = version_compare($woocommerce-&gt;version, '2.1', '&gt;') ? 'shipping_address' : 'billing_address';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Show transaction ID on the overview&nbsp;</div></li><li><div>            if (($post-&gt;post_type == 'shop_order' && $column == $check_column) || ($post-&gt;post_type == 'shop_subscription' && $column == 'order_title')) {&nbsp;</div></li><li><div>                // Insert transaction id and payment status if any&nbsp;</div></li><li><div>                $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ($transaction_id && $order-&gt;has_quickpay_payment()) {&nbsp;</div></li><li><div>                    <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_views/" data-id="1411925" title="WC_QuickPay_Views" class="class">WC_QuickPay_Views</a>::get_view('html-order-table-transaction-data.php', array(&nbsp;</div></li><li><div>                        'transaction_id' =&gt; $transaction_id, &nbsp;</div></li><li><div>                        'post_id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * FILTER: apply_gateway_icons function.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Sets gateway icons on frontend&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function apply_gateway_icons($icon, $id)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if ($id == $this-&gt;id) {&nbsp;</div></li><li><div>                $icon = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $icons = $this-&gt;s('quickpay_icons');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (!empty($icons)) {&nbsp;</div></li><li><div>                    $icons_maxheight = $this-&gt;gateway_icon_size();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ($icons as $key =&gt; $item) {&nbsp;</div></li><li><div>                        $icon .= $this-&gt;gateway_icon_create($item, $icons_maxheight);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $icon;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * gateway_icon_create&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Helper to get the a gateway icon image tag&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access protected&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        protected function gateway_icon_create($icon, $max_height)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $icon_url = WC_HTTPS::force_https_url(plugin_dir_url(__FILE__) . 'assets/images/cards/' . $icon . '.png');&nbsp;</div></li><li><div>            return '&lt;img src=&quot;' . $icon_url . '&quot; alt=&quot;' . esc_attr($this-&gt;get_title()) . '&quot; style=&quot;max-height:' . $max_height . '&quot;/&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * gateway_icon_size&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Helper to get the a gateway icon image max height&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access protected&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        protected function gateway_icon_size()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $settings_icons_maxheight = $this-&gt;s('quickpay_icons_maxheight');&nbsp;</div></li><li><div>            return !empty($settings_icons_maxheight) ? $settings_icons_maxheight . 'px' : '20px';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * get_gateway_currency&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Returns the gateway currency&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param WC_Order $order&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function get_gateway_currency($order)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            if (WC_QuickPay_Helper::option_is_enabled($this-&gt;s('quickpay_currency_auto'))) {&nbsp;</div></li><li><div>                $currency = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;get_order_currency() : $order-&gt;get_currency();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $currency = $this-&gt;s('quickpay_currency');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $currency = apply_filters(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/woocommerce_quickpay_currency/" data-id="1411978" title="woocommerce_quickpay_currency" class="filter">'woocommerce_quickpay_currency'</a>, $currency, $order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $currency;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * get_gateway_language&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Returns the gateway language&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function get_gateway_language()&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $language = apply_filters(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/woocommerce_quickpay_language/" data-id="1411979" title="woocommerce_quickpay_language" class="filter">'woocommerce_quickpay_language'</a>, $this-&gt;s('quickpay_language'));&nbsp;</div></li><li><div>            return $language;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Registers custom bulk actions&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function register_bulk_actions() {&nbsp;</div></li><li><div>            global $post_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $post_type === 'shop_order' && <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_subscription/" data-id="1411927" title="WC_QuickPay_Subscription" class="class">WC_QuickPay_Subscription</a>::plugin_is_active()) {&nbsp;</div></li><li><div>                <a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/classes/wc_quick_pay_views/" data-id="1411925" title="WC_QuickPay_Views" class="class">WC_QuickPay_Views</a>::get_view('bulk-actions.php');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Handles custom bulk actions&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function handle_bulk_actions() {&nbsp;</div></li><li><div>            $wp_list_table = _get_list_table( 'WP_Posts_List_Table' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $action = $wp_list_table-&gt;current_action();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for posts&nbsp;</div></li><li><div>            if ( ! empty( $_GET['post'] ) ) {&nbsp;</div></li><li><div>                $order_ids = $_GET['post'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Make sure the $posts variable is an array&nbsp;</div></li><li><div>                if ( ! is_array( $order_ids ) ) {&nbsp;</div></li><li><div>                    $order_ids = array( $order_ids );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>                switch ( $action ) {&nbsp;</div></li><li><div>                    // 3. Perform the action&nbsp;</div></li><li><div>                    case 'quickpay_capture_recurring':&nbsp;</div></li><li><div>                        // Security check&nbsp;</div></li><li><div>                        $this-&gt;bulk_action_quickpay_capture_recurring( $order_ids );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        return;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // 4. Redirect client&nbsp;</div></li><li><div>            wp_redirect( $_SERVER['HTTP_REFERER'] );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * @param array $order_ids&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function bulk_action_quickpay_capture_recurring( $order_ids = array() ) {&nbsp;</div></li><li><div>            if (!empty($order_ids)) {&nbsp;</div></li><li><div>                foreach ( $order_ids as $order_id ) {&nbsp;</div></li><li><div>                    $order = new WC_QuickPay_Order($order_id);&nbsp;</div></li><li><div>                    $payment_method = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;payment_method : $order-&gt;get_payment_method();&nbsp;</div></li><li><div>                    if (WC_QuickPay_Subscription::is_renewal($order) && $order-&gt;needs_payment() && $payment_method === $this-&gt;id) {&nbsp;</div></li><li><div>                        $this-&gt;scheduled_subscription_payment($order-&gt;get_total(), $order);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * in_plugin_update_message&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Show plugin changes. Code adapted from W3 Total Cache.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @access public&nbsp;</div></li><li><div>         * @static&nbsp;</div></li><li><div>         * @return void&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public static function in_plugin_update_message($args)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $transient_name = 'wcqp_upgrade_notice_' . $args['Version'];&nbsp;</div></li><li><div>            if (false === ($upgrade_notice = get_transient($transient_name))) {&nbsp;</div></li><li><div>                $response = wp_remote_get('https://plugins.svn.wordpress.org/woocommerce-quickpay/trunk/README.txt');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (!is_wp_error($response) && !empty($response['body'])) {&nbsp;</div></li><li><div>                    $upgrade_notice = self::parse_update_notice($response['body']);&nbsp;</div></li><li><div>                    set_transient($transient_name, $upgrade_notice, DAY_IN_SECONDS);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo wp_kses_post($upgrade_notice);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * parse_update_notice&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Parse update notice from readme file.&nbsp;</div></li><li><div>         * @param  string $content&nbsp;</div></li><li><div>         * @return string&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        private static function parse_update_notice($content)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            // Output Upgrade Notice&nbsp;</div></li><li><div>            $matches = null;&nbsp;</div></li><li><div>            $regexp = '~==\s*Upgrade Notice\s*==\s*=\s*(.*)\s*=(.*)(=\s*' . preg_quote(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_version/" data-id="1411937" title="WCQP_VERSION" class="constant">WCQP_VERSION</a>, '/' ) . '\s*=|$)~Uis';&nbsp;</div></li><li><div>            $upgrade_notice = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (preg_match($regexp, $content, $matches)) {&nbsp;</div></li><li><div>                $version = trim($matches[1]);&nbsp;</div></li><li><div>                $notices = (array)preg_split('~[\r\n]+~', trim($matches[2]));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if (version_compare(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/constants/wcqp_version/" data-id="1411937" title="WCQP_VERSION" class="constant">WCQP_VERSION</a>, $version, '&lt;')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $upgrade_notice .= '&lt;div class=&quot;wc_plugin_upgrade_notice&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ($notices as $index =&gt; $line) {&nbsp;</div></li><li><div>                        $upgrade_notice .= wp_kses_post(preg_replace('~\[([^\]]*)\]\(([^\)]*)\)~', '&lt;a href=&quot;${2}&quot;&gt;${1}&lt;/a&gt;', $line));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $upgrade_notice .= '&lt;/div&gt; ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return wp_kses_post($upgrade_notice);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * path&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Returns a plugin URL path&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param $path&nbsp;</div></li><li><div>         * @return mixed&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function plugin_url($path)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            return plugins_url($path, __FILE__);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Make the object available for later use&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return WC_QuickPay&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function WC_QP()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        return WC_QuickPay::get_instance();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Instantiate&nbsp;</div></li><li><div>    WC_QP();&nbsp;</div></li><li><div>    WC_QP()-&gt;hooks_and_filters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Add the gateway to WooCommerce&nbsp;</div></li><li><div>    function add_quickpay_gateway($methods)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $methods[] = 'WC_QuickPay';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/woocommerce_quickpay_load_instances/" data-id="1411982" title="woocommerce_quickpay_load_instances" class="filter">'woocommerce_quickpay_load_instances'</a>, $methods);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/woocommerce_payment_gateways/" data-id="1411981" title="woocommerce_payment_gateways" class="filter">'woocommerce_payment_gateways'</a>, 'add_quickpay_gateway');&nbsp;</div></li><li><div>    add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/woocommerce_quickpay_load_instances/" data-id="1411982" title="woocommerce_quickpay_load_instances" class="filter">'woocommerce_quickpay_load_instances'</a>, 'WC_QuickPay::filter_load_instances');&nbsp;</div></li><li><div>    add_filter(<a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/filters/add_filter/plugin_action_links_file/" data-id="1411983" title="plugin_action_links_&lt;file&gt;" class="filter">'plugin_action_links_' . plugin_basename(__FILE__)</a>, 'WC_QuickPay::add_action_links');&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 4.6.6</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.1/functions/init_quickpay_gateway/" class="active">4.8.1</a></li><li><a href="http://hookr.io/plugins/woocommerce-quickpay/4.8.0/functions/init_quickpay_gateway/" class="">4.8.0</a></li><li><a href="http://hookr.io/plugins/woocommerce-quickpay/4.6.8/functions/init_quickpay_gateway/" class="">4.6.8</a></li><li><a href="http://hookr.io/plugins/woocommerce-quickpay/4.6.7/functions/init_quickpay_gateway/" class="">4.6.7</a></li><li><a href="http://hookr.io/plugins/woocommerce-quickpay/4.6.6/functions/init_quickpay_gateway/" class="">4.6.6</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>function</li><li><span></span>init_quickpay_gateway</li><li><span></span>WooCommerce QuickPay</li><li><span></span>4.8.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>