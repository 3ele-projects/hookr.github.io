<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.1.0" data-slug="woocommerce-rache-aqui" data-type="file" data-id="68161"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-class-wc-racheaqui-gateway | file | Woocommerce Rache Aqui | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-rache-aqui, 2.1.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.14"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=af29726eb7bfe03459c2bfe3d1be55e1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.14' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-class-wc-racheaqui-gateway/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-racheaqui-gateway%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-racheaqui-gateway%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-rache-aqui-2.1.0-file-includes-class-wc-racheaqui-gateway","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-class-wc-racheaqui-gateway" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-rache-aqui." href="http://hookr.io/plugins/woocommerce-rache-aqui/" class="plugin"><span property="name">woocommerce-rache-aqui</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.1.0." href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/" class="H_VERSION"><span property="name">2.1.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-class-wc-racheaqui-g&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="5"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/all/" title="All">All <span class="count badge">5</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/hooks/" title="Hooks">Hooks <span class="count badge">3</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="3"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/filters/" title="Filters">Filters <span class="count badge">3</span></a></li><li class="" data-id="class" data-count="2"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/classes/" title="Classes">Classes <span class="count badge">2</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-rache-aqui/2.1.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/class-wc-racheaqui-gateway.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WC Rache Aqui! Gateway Class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Built the Rache Aqui! method.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_RacheAqui_Gateway extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor for the gateway.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;id = 'racheaqui';&nbsp;</div></li><li><div>      $this-&gt;icon = apply_filters( 'woocommerce_racheaqui_icon', plugins_url( 'assets/images/racheaqui.png', plugin_dir_path( __FILE__ ) ) );&nbsp;</div></li><li><div>      $this-&gt;has_fields = false;&nbsp;</div></li><li><div>      $this-&gt;method_title = __( 'Rache Aqui!', 'woocommerce-racheaqui' );&nbsp;</div></li><li><div>      $this-&gt;method_description = __( 'Allow your customers to pay with more than a single credit card using the Rache Aqui!', 'woocommerce-racheaqui' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// API URLs.</span>&nbsp;</div></li><li><div>      $this-&gt;production_url = 'https:<span class="comment">//pagamentos.racheaqui.com.br';</span>&nbsp;</div></li><li><div>      $this-&gt;sandbox_url = 'https:<span class="comment">//testes.racheaqui.com.br';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the form fields.</span>&nbsp;</div></li><li><div>      $this-&gt;init_form_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>      $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Define user set variables.</span>&nbsp;</div></li><li><div>      $this-&gt;title = $this-&gt;get_option( 'title' );&nbsp;</div></li><li><div>      $this-&gt;description = $this-&gt;get_option( 'description' );&nbsp;</div></li><li><div>      $this-&gt;store_id = $this-&gt;get_option( 'store_id' );&nbsp;</div></li><li><div>      $this-&gt;split = $this-&gt;get_option( 'split' );&nbsp;</div></li><li><div>      $this-&gt;installments = $this-&gt;get_option( 'installments' );&nbsp;</div></li><li><div>      $this-&gt;sandbox = $this-&gt;get_option( 'sandbox' );&nbsp;</div></li><li><div>      $this-&gt;debug = $this-&gt;get_option( 'debug' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Actions.</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_receipt_' . $this-&gt;id, array( $this, 'receipt_page' ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_api_wc_racheaqui_gateway', array( $this, 'process_return' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Active logs.</span>&nbsp;</div></li><li><div>      if ( 'yes' == $this-&gt;debug ) {&nbsp;</div></li><li><div>          if ( class_exists( 'WC_Logger' ) ) {&nbsp;</div></li><li><div>              $this-&gt;log = new WC_Logger();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;log = $woocommerce-&gt;logger();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          <span class="comment">// Checks if store_id is not empty.</span>&nbsp;</div></li><li><div>          if ( empty( $this-&gt;store_id ) ) {&nbsp;</div></li><li><div>              add_action( 'admin_notices', array( $this, 'store_id_missing_message' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Checks that the currency is supported.</span>&nbsp;</div></li><li><div>          if ( ! $this-&gt;using_supported_currency() ) {&nbsp;</div></li><li><div>              add_action( 'admin_notices', array( $this, 'currency_not_supported_message' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a bool that indicates if currency is amongst the supported ones.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function using_supported_currency() {&nbsp;</div></li><li><div>      return 'BRL' == get_woocommerce_currency();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a value indicating the the Gateway is available or not. It's called</span>&nbsp;</div></li><li><div><span class="comment">   * automatically by WooCommerce before allowing customers to use the gateway</span>&nbsp;</div></li><li><div><span class="comment">   * for payment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_available() {&nbsp;</div></li><li><div>      <span class="comment">// Test if is valid for use.</span>&nbsp;</div></li><li><div>      $available = parent::is_available() && 'yes' == $this-&gt;get_option( 'enabled' ) && ! empty( $this-&gt;store_id ) && $this-&gt;using_supported_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $available;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init_form_fields() {&nbsp;</div></li><li><div>      $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Enable/Disable', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable Rache Aqui!', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Title', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div>              'default' =&gt; __( 'Rache Aqui!', 'woocommerce-racheaqui' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Description', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'textarea', &nbsp;</div></li><li><div>              'description' =&gt; __( 'This controls the description which the user sees during checkout.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'default' =&gt; __( 'Pay with Rache Aqui!', 'woocommerce-racheaqui' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'store_id' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Store ID provided by Rache Aqui!', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Please enter your Rache Aqui! Store ID.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'split' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Max Raches', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Must be less than or equal to the number registered in the Store Settings. If its value is zero OR is greater than the number registered, shall be deemed the number registered in the Store Settings.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  '0' =&gt; '0', &nbsp;</div></li><li><div>                  '1' =&gt; '1', &nbsp;</div></li><li><div>                  '2' =&gt; '2', &nbsp;</div></li><li><div>                  '3' =&gt; '3', &nbsp;</div></li><li><div>                  '4' =&gt; '4', &nbsp;</div></li><li><div>                  '5' =&gt; '5', &nbsp;</div></li><li><div>                  '6' =&gt; '6', &nbsp;</div></li><li><div>                  '7' =&gt; '7', &nbsp;</div></li><li><div>                  '8' =&gt; '8', &nbsp;</div></li><li><div>                  '9' =&gt; '9', &nbsp;</div></li><li><div>                  '10' =&gt; '10', &nbsp;</div></li><li><div>                  '11' =&gt; '11', &nbsp;</div></li><li><div>                  '12' =&gt; '12', &nbsp;</div></li><li><div>                  '13' =&gt; '13', &nbsp;</div></li><li><div>                  '14' =&gt; '14', &nbsp;</div></li><li><div>                  '15' =&gt; '15', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'installments' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Max Installments', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Must be less than or equal to the number registered in the Store Settings. If its value is zero OR is greater than the number registered, shall be deemed the number registered in the Store Settings.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  '0' =&gt; '0', &nbsp;</div></li><li><div>                  '1' =&gt; '1', &nbsp;</div></li><li><div>                  '2' =&gt; '2', &nbsp;</div></li><li><div>                  '3' =&gt; '3', &nbsp;</div></li><li><div>                  '4' =&gt; '4', &nbsp;</div></li><li><div>                  '5' =&gt; '5', &nbsp;</div></li><li><div>                  '6' =&gt; '6', &nbsp;</div></li><li><div>                  '7' =&gt; '7', &nbsp;</div></li><li><div>                  '8' =&gt; '8', &nbsp;</div></li><li><div>                  '9' =&gt; '9', &nbsp;</div></li><li><div>                  '10' =&gt; '10', &nbsp;</div></li><li><div>                  '11' =&gt; '11', &nbsp;</div></li><li><div>                  '12' =&gt; '12', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testing' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Gateway Testing', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'title', &nbsp;</div></li><li><div>              'description' =&gt; '', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Rache Aqui! Sandbox', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable Rache Aqui! sandbox', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Check this option when testing payments. Leave it unchecked to the environment will be used for production.', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'debug' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Debug Log', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable logging', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; sprintf( __( 'Log Rache Aqui! events, such as payment requests and return data, inside %s', 'woocommerce-racheaqui' ), '&lt;code&gt;woocommerce/logs/' . $this-&gt;id . '-' . sanitize_file_name( wp_hash( $this-&gt;id ) ) . '.txt&lt;/code&gt;' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate the args to form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  WC_Order $order Order data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array           Form arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_form_args( $order ) {&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'lojaID' =&gt; $this-&gt;store_id, &nbsp;</div></li><li><div>          'valor_pedido' =&gt; number_format( $order-&gt;order_total, 2, '', '' ), &nbsp;</div></li><li><div>          'pedidoID' =&gt; $order-&gt;id, &nbsp;</div></li><li><div>          'num_raches' =&gt; $this-&gt;split, &nbsp;</div></li><li><div>          'maximo_parcelas' =&gt; $this-&gt;installments, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = apply_filters( 'woocommerce_racheaqui_form_args', $args, $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate the form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $order_id Order ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string           Payment form.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function generate_form( $order_id ) {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>      $args = $this-&gt;get_form_args( $order );&nbsp;</div></li><li><div>      $form_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' == $this-&gt;debug ) {&nbsp;</div></li><li><div>          $this-&gt;log-&gt;add( $this-&gt;id, 'Payment arguments for order ' . $order-&gt;get_order_number() . ': ' . print_r( $args, true ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $args as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $form_args[] = '&lt;input type=&quot;hidden&quot; name=&quot;' . esc_attr( $key ) . '&quot; value=&quot;' . esc_attr( $value ) . '&quot; /&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wc_enqueue_js' ) ) {&nbsp;</div></li><li><div>          wc_enqueue_js( '&nbsp;</div></li><li><div>              jQuery.blockUI({&nbsp;</div></li><li><div>                  message: &quot;' . esc_js( __( 'Thank you for your order. We are now redirecting you to Rache Aqui! to make payment.', 'woocommerce-racheaqui' ) ) . '&quot;, &nbsp;</div></li><li><div>                  baseZ: 99999, &nbsp;</div></li><li><div>                  overlayCSS: {&nbsp;</div></li><li><div>                      background: &quot;#fff&quot;, &nbsp;</div></li><li><div>                      opacity: 0.6&nbsp;</div></li><li><div>                  }, &nbsp;</div></li><li><div>                  css: {&nbsp;</div></li><li><div>                      padding:        &quot;20px&quot;, &nbsp;</div></li><li><div>                      zindex:         &quot;9999999&quot;, &nbsp;</div></li><li><div>                      textAlign:      &quot;center&quot;, &nbsp;</div></li><li><div>                      color:          &quot;#555&quot;, &nbsp;</div></li><li><div>                      border:         &quot;3px solid #aaa&quot;, &nbsp;</div></li><li><div>                      backgroundColor:&quot;#fff&quot;, &nbsp;</div></li><li><div>                      cursor:         &quot;wait&quot;, &nbsp;</div></li><li><div>                      lineHeight:        &quot;24px&quot;, &nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              });&nbsp;</div></li><li><div>              jQuery(&quot;#submit-payment-form&quot;).click();&nbsp;</div></li><li><div>          ' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $woocommerce-&gt;add_inline_js( '&nbsp;</div></li><li><div>              jQuery( &quot;body&quot; ).block({&nbsp;</div></li><li><div>                  message: &quot;' . esc_js( __( 'Thank you for your order. We are now redirecting you to Rache Aqui! to make payment.', 'woocommerce-racheaqui' ) ) . '&quot;, &nbsp;</div></li><li><div>                  overlayCSS: {&nbsp;</div></li><li><div>                      background: &quot;#fff&quot;, &nbsp;</div></li><li><div>                      opacity:    0.6&nbsp;</div></li><li><div>                  }, &nbsp;</div></li><li><div>                  css: {&nbsp;</div></li><li><div>                      padding:         &quot;20px&quot;, &nbsp;</div></li><li><div>                      zIndex:          &quot;9999999&quot;, &nbsp;</div></li><li><div>                      textAlign:       &quot;center&quot;, &nbsp;</div></li><li><div>                      color:           &quot;#555&quot;, &nbsp;</div></li><li><div>                      border:          &quot;3px solid #aaa&quot;, &nbsp;</div></li><li><div>                      backgroundColor: &quot;#fff&quot;, &nbsp;</div></li><li><div>                      cursor:          &quot;wait&quot;, &nbsp;</div></li><li><div>                      lineHeight:      &quot;24px&quot;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              });&nbsp;</div></li><li><div>              jQuery(&quot;#submit-payment-form&quot;).click();&nbsp;</div></li><li><div>          ' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' == $this-&gt;sandbox ) {&nbsp;</div></li><li><div>          $url = $this-&gt;sandbox_url;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $url = $this-&gt;production_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return '&lt;form action=&quot;' . $url . '&quot; method=&quot;post&quot; id=&quot;payment-form&quot; target=&quot;_top&quot;&gt;&nbsp;</div></li><li><div>              ' . implode( '', $form_args ) . '&nbsp;</div></li><li><div>              &lt;input type=&quot;submit&quot; class=&quot;button alt&quot; id=&quot;submit-payment-form&quot; value=&quot;' . __( 'Pay via Rache Aqui!', 'woocommerce-racheaqui' ) . '&quot; /&gt; &lt;a class=&quot;button cancel&quot; href=&quot;' . esc_url( $order-&gt;get_cancel_order_url() ) . '&quot;&gt;' . __( 'Cancel order &amp; restore cart', 'woocommerce-racheaqui' ) . '&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment and return the result.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $order_id Order ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array           Redirect.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_payment( $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( WOOCOMMERCE_VERSION, '2.1', '&gt;=' ) ) {&nbsp;</div></li><li><div>          $url = $order-&gt;get_checkout_payment_url( true );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $url = add_query_arg( 'order', $order-&gt;id, add_query_arg( 'key', $order-&gt;order_key, get_permalink( woocommerce_get_page_id( 'pay' ) ) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'result' =&gt; 'success', &nbsp;</div></li><li><div>          'redirect' =&gt; $url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Output for the order received page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function receipt_page( $order ) {&nbsp;</div></li><li><div>      echo '&lt;p&gt;' . __( 'Thank you for your order, please click the button below to pay with Rache Aqui!.', 'woocommerce-racheaqui' ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>      echo $this-&gt;generate_form( $order );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the Rache Aqui! return.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_return() {&nbsp;</div></li><li><div>      @ob_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $posted = stripslashes_deep( $_POST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          isset( $posted['pedidoID'] )&nbsp;</div></li><li><div>          && isset( $posted['status'] )&nbsp;</div></li><li><div>          && isset( $posted['valor_pedido'] )&nbsp;</div></li><li><div>          && isset( $posted['num_raches'] )&nbsp;</div></li><li><div>          && 'OK' == $posted['status']&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          header( 'HTTP/1.1 200 OK' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'yes' == $this-&gt;debug ) {&nbsp;</div></li><li><div>              $this-&gt;log-&gt;add( $this-&gt;id, 'Processing a payment return with the follow data: ' . print_r( $posted, true ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $order_id = absint( $posted['pedidoID'] );&nbsp;</div></li><li><div>          $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>          $total_received = number_format( str_replace( array( '.', ', ' ), array( '', '.' ), $posted['valor_pedido'] ), 2, '', '' );&nbsp;</div></li><li><div>          $order_total = number_format( $order-&gt;order_total, 2, '', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $order-&gt;id === $order_id && $total_received === $order_total ) {&nbsp;</div></li><li><div>              if ( 'yes' == $this-&gt;debug ) {&nbsp;</div></li><li><div>                  $this-&gt;log-&gt;add( $this-&gt;id, 'The return is CORRECT for the order ' . $order-&gt;get_order_number() . ', payment status updated to processing' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $posted['num_raches'] ) ) {&nbsp;</div></li><li><div>                  update_post_meta(&nbsp;</div></li><li><div>                      $order_id, &nbsp;</div></li><li><div>                      __( 'Number of raches', 'woocommerce-racheaqui' ), &nbsp;</div></li><li><div>                      $posted['num_raches']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $order-&gt;add_order_note( __( 'Order completed, please check the payment status on the Rache Aqui! panel', 'woocommerce-racheaqui' ) );&nbsp;</div></li><li><div>              $order-&gt;payment_complete();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_redirect( $this-&gt;get_return_url( $order ) );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'yes' == $this-&gt;debug ) {&nbsp;</div></li><li><div>              $this-&gt;log-&gt;add( $this-&gt;id, 'Failed to process the payment return wit the follow data:' . print_r( $posted, true ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die( __( 'Raque Aqui! Request Failure', 'woocommerce-racheaqui' ), 'Raque Aqui! Return', array( 'response' =&gt; 200 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the admin url.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function admin_url() {&nbsp;</div></li><li><div>      if ( version_compare( WOOCOMMERCE_VERSION, '2.1', '&gt;=' ) ) {&nbsp;</div></li><li><div>          return admin_url( 'admin.php?page=wc-settings&tab=checkout&section=wc_racheaqui_gateway' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return admin_url( 'admin.php?page=woocommerce_settings&tab=payment_gateways&section=WC_RacheAqui_Gateway' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds error message when not configured the store_id.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Error Mensage.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function store_id_missing_message() {&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;&lt;strong&gt;' . __( 'Rache Aqui! Disabled', 'woocommerce-racheaqui' ) . '&lt;/strong&gt;: ' . sprintf( __( 'You should inform your Store ID. %s', 'woocommerce-racheaqui' ), '&lt;a href=&quot;' . $this-&gt;admin_url() . '&quot;&gt;' . __( 'Click here to configure!', 'woocommerce-racheaqui' ) . '&lt;/a&gt;' ) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds error message when an unsupported currency is used.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function currency_not_supported_message() {&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;&lt;strong&gt;' . __( 'Rache Aqui! Disabled', 'woocommerce-racheaqui' ) . '&lt;/strong&gt;: ' . sprintf( __( 'Currency &lt;code&gt;%s&lt;/code&gt; is not supported. The Rache Aqui! works only with &lt;code&gt;BRL&lt;/code&gt;.', 'woocommerce-racheaqui' ), get_woocommerce_currency() ) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Rache Aqui!</li><li><span></span>2.1.0</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>