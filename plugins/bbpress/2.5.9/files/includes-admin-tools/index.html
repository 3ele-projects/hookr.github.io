<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.5.9" data-slug="bbpress" data-type="file" data-id="58114"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-admin-tools | file | Bbpress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, bbpress, 2.5.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=7e6710b6a53be517a7faac06f557a4fe' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-admin-tools/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-admin-tools%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-admin-tools%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-bbpress-2.5.9-file-includes-admin-tools","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-admin-tools" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to bbpress." href="http://hookr.io/plugins/bbpress/" class="plugin"><span property="name">bbpress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.5.9." href="http://hookr.io/plugins/bbpress/2.5.9/" class="H_VERSION"><span property="name">2.5.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/bbpress/2.5.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-admin-tools</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2373"><a href="http://hookr.io/plugins/bbpress/2.5.9/all/" title="All">All <span class="count badge">2373</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/bbpress/2.5.9/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="1132"><a href="http://hookr.io/plugins/bbpress/2.5.9/hooks/" title="Hooks">Hooks <span class="count badge">1132</span></a></li><li class="" data-id="action" data-count="471"><a href="http://hookr.io/plugins/bbpress/2.5.9/actions/" title="Actions">Actions <span class="count badge">471</span></a></li><li class="" data-id="filter" data-count="661"><a href="http://hookr.io/plugins/bbpress/2.5.9/filters/" title="Filters">Filters <span class="count badge">661</span></a></li><li class="" data-id="class" data-count="54"><a href="http://hookr.io/plugins/bbpress/2.5.9/classes/" title="Classes">Classes <span class="count badge">54</span></a></li><li class="" data-id="constant" data-count="28"><a href="http://hookr.io/plugins/bbpress/2.5.9/constants/" title="Constants">Constants <span class="count badge">28</span></a></li><li class="" data-id="function" data-count="1158"><a href="http://hookr.io/plugins/bbpress/2.5.9/functions/" title="Functions">Functions <span class="count badge">1158</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/bbpress/2.5.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/admin/tools.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * bbPress Admin Tools Page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( !defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Repair ********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Admin repair page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_admin_repair_list() To get the recount list</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_admin_referer() To verify the nonce and the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_flush() To flush the cache</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'admin_notices' to display the notices</span>&nbsp;</div></li><li><div><span class="comment"> * @uses screen_icon() To display the screen icon</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_nonce_field() To add a hidden nonce field</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair() {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php screen_icon( 'tools' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;h2 class=&quot;nav-tab-wrapper&quot;&gt;&lt;?php bbp_tools_admin_tabs( __( 'Repair Forums', 'bbpress' ) ); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php esc_html_e( 'bbPress keeps track of relationships between forums, topics, replies, and topic tags, and users. Occasionally these relationships become out of sync, most often after an import or migration. Use the tools below to manually recalculate these relationships.', 'bbpress' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;description&quot;&gt;&lt;?php esc_html_e( 'Some of these tools create substantial database overhead. Avoid running more than 1 repair job at a time.', 'bbpress' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;form class=&quot;settings&quot; method=&quot;post&quot; action=&quot;&quot;&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>              &lt;tbody&gt;&nbsp;</div></li><li><div>                  &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                      &lt;th scope=&quot;row&quot;&gt;&lt;?php esc_html_e( 'Relationships to Repair:', 'bbpress' ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&nbsp;</div></li><li><div>                          &lt;fieldset&gt;&nbsp;</div></li><li><div>                              &lt;legend class=&quot;screen-reader-text&quot;&gt;&lt;span&gt;&lt;?php esc_html_e( 'Repair', 'bbpress' ) ?&gt;&lt;/span&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;?php foreach ( bbp_admin_repair_list() as $item ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  &lt;label&gt;&lt;input type=&quot;checkbox&quot; class=&quot;checkbox&quot; name=&quot;&lt;?php echo esc_attr( $item[0] ) . '&quot; id=&quot;' . esc_attr( str_replace( '_', '-', $item[0] ) ); ?&gt;&quot; value=&quot;1&quot; /&gt; &lt;?php echo esc_html( $item[1] ); ?&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;/fieldset&gt;&nbsp;</div></li><li><div>                      &lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/tbody&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;fieldset class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>              &lt;input class=&quot;button-primary&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php esc_attr_e( 'Repair Items', 'bbpress' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field( 'bbpress-do-counts' ); ?&gt;&nbsp;</div></li><li><div>          &lt;/fieldset&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle the processing and feedback of the admin tools page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_admin_repair_list() To get the recount list</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_admin_referer() To verify the nonce and the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_flush() To flush the cache</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'admin_notices' to display the notices</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_handler() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! bbp_is_post_request() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_admin_referer( 'bbpress-do-counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Stores messages</span></span>&nbsp;</div></li><li><div>  $messages = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) bbp_admin_repair_list() as $item ) {&nbsp;</div></li><li><div>      if ( isset( $item[2] ) && isset( $_POST[$item[0]] ) && 1 === absint( $_POST[$item[0]] ) && is_callable( $item[2] ) ) {&nbsp;</div></li><li><div>          $messages[] = call_user_func( $item[2] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $messages ) ) {&nbsp;</div></li><li><div>      foreach ( $messages as $message ) {&nbsp;</div></li><li><div>          bbp_admin_tools_feedback( $message[1] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Assemble the admin notices</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|WP_Error $message A message to be displayed or {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $class Optional. A class to be added to the message div</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error::get_error_messages() To get the error messages of $message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_action() Adds the admin notice action with the message HTML</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The message HTML</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_tools_feedback( $message, $class = false ) {&nbsp;</div></li><li><div>  if ( is_string( $message ) ) {&nbsp;</div></li><li><div>      $message = '&lt;p&gt;' . $message . '&lt;/p&gt;';&nbsp;</div></li><li><div>      $class = $class ? $class : 'updated';&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $message ) ) {&nbsp;</div></li><li><div>      $errors = $message-&gt;get_error_messages();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( count( $errors ) ) {&nbsp;</div></li><li><div>          case 0:&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 1:&nbsp;</div></li><li><div>              $message = '&lt;p&gt;' . $errors[0] . '&lt;/p&gt;';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $message = '&lt;ul&gt;' . &quot;\n\t&quot; . '&lt;li&gt;' . implode( '&lt;/li&gt;' . &quot;\n\t&quot; . '&lt;li&gt;', $errors ) . '&lt;/li&gt;' . &quot;\n&quot; . '&lt;/ul&gt;';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $class = $class ? $class : 'error';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = '&lt;div id=&quot;message&quot; class=&quot;' . esc_attr( $class ) . '&quot;&gt;' . $message . '&lt;/div&gt;';&nbsp;</div></li><li><div>  $message = str_replace( &quot;'&quot;, &quot;\'&quot;, $message );&nbsp;</div></li><li><div>  $lambda = create_function( '', &quot;echo '$message';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_action( 'admin_notices', $lambda );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $lambda;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the array of the repair list</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_repair_list' with the list array</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Repair list of options</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_list() {&nbsp;</div></li><li><div>  $repair_list = array(&nbsp;</div></li><li><div>      0 =&gt; array( 'bbp-sync-topic-meta', __( 'Recalculate the parent topic for each post', 'bbpress' ), 'bbp_admin_repair_topic_meta' ), &nbsp;</div></li><li><div>      5 =&gt; array( 'bbp-sync-forum-meta', __( 'Recalculate the parent forum for each post', 'bbpress' ), 'bbp_admin_repair_forum_meta' ), &nbsp;</div></li><li><div>      10 =&gt; array( 'bbp-sync-forum-visibility', __( 'Recalculate private and hidden forums', 'bbpress' ), 'bbp_admin_repair_forum_visibility' ), &nbsp;</div></li><li><div>      15 =&gt; array( 'bbp-sync-all-topics-forums', __( 'Recalculate last activity in each topic and forum', 'bbpress' ), 'bbp_admin_repair_freshness' ), &nbsp;</div></li><li><div>      20 =&gt; array( 'bbp-sync-all-topics-sticky', __( 'Recalculate the sticky relationship of each topic', 'bbpress' ), 'bbp_admin_repair_sticky' ), &nbsp;</div></li><li><div>      25 =&gt; array( 'bbp-sync-all-reply-positions', __( 'Recalculate the position of each reply', 'bbpress' ), 'bbp_admin_repair_reply_menu_order' ), &nbsp;</div></li><li><div>      30 =&gt; array( 'bbp-group-forums', __( 'Repair BuddyPress Group Forum relationships', 'bbpress' ), 'bbp_admin_repair_group_forum_relationship' ), &nbsp;</div></li><li><div>      35 =&gt; array( 'bbp-forum-topics', __( 'Count topics in each forum', 'bbpress' ), 'bbp_admin_repair_forum_topic_count' ), &nbsp;</div></li><li><div>      40 =&gt; array( 'bbp-forum-replies', __( 'Count replies in each forum', 'bbpress' ), 'bbp_admin_repair_forum_reply_count' ), &nbsp;</div></li><li><div>      45 =&gt; array( 'bbp-topic-replies', __( 'Count replies in each topic', 'bbpress' ), 'bbp_admin_repair_topic_reply_count' ), &nbsp;</div></li><li><div>      50 =&gt; array( 'bbp-topic-voices', __( 'Count voices in each topic', 'bbpress' ), 'bbp_admin_repair_topic_voice_count' ), &nbsp;</div></li><li><div>      55 =&gt; array( 'bbp-topic-hidden-replies', __( 'Count spammed & trashed replies in each topic', 'bbpress' ), 'bbp_admin_repair_topic_hidden_reply_count' ), &nbsp;</div></li><li><div>      60 =&gt; array( 'bbp-user-topics', __( 'Count topics for each user', 'bbpress' ), 'bbp_admin_repair_user_topic_count' ), &nbsp;</div></li><li><div>      65 =&gt; array( 'bbp-user-replies', __( 'Count replies for each user', 'bbpress' ), 'bbp_admin_repair_user_reply_count' ), &nbsp;</div></li><li><div>      70 =&gt; array( 'bbp-user-favorites', __( 'Remove trashed topics from user favorites', 'bbpress' ), 'bbp_admin_repair_user_favorites' ), &nbsp;</div></li><li><div>      75 =&gt; array( 'bbp-user-topic-subscriptions', __( 'Remove trashed topics from user subscriptions', 'bbpress' ), 'bbp_admin_repair_user_topic_subscriptions' ), &nbsp;</div></li><li><div>      80 =&gt; array( 'bbp-user-forum-subscriptions', __( 'Remove trashed forums from user subscriptions', 'bbpress' ), 'bbp_admin_repair_user_forum_subscriptions' ), &nbsp;</div></li><li><div>      85 =&gt; array( 'bbp-user-role-map', __( 'Remap existing users to default forum roles', 'bbpress' ), 'bbp_admin_repair_user_roles' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  ksort( $repair_list );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (array) apply_filters( 'bbp_repair_list', $repair_list );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount topic replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_topic_reply_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of replies in each topic&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Post type</span></span>s and status</span></span>&nbsp;</div></li><li><div>  $tpt = bbp_get_topic_post_type();&nbsp;</div></li><li><div>  $rpt = bbp_get_reply_post_type();&nbsp;</div></li><li><div>  $pps = bbp_get_public_status_id();&nbsp;</div></li><li><div>  $cps = bbp_get_closed_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete the meta key _bbp_reply_count for each topic</span>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE `postmeta` FROM `{$wpdb-&gt;postmeta}` AS `postmeta`&nbsp;</div></li><li><div>                      LEFT JOIN `{$wpdb-&gt;posts}` AS `posts` ON `posts`.`ID` = `postmeta`.`post_id`&nbsp;</div></li><li><div>                      WHERE `posts`.`post_type` = '{$tpt}'&nbsp;</div></li><li><div>                      AND `postmeta`.`meta_key` = '_bbp_reply_count'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ) {&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Recalculate the meta key _bbp_reply_count for each topic</span>&nbsp;</div></li><li><div>  $sql = &quot;INSERT INTO `{$wpdb-&gt;postmeta}` (`post_id`, `meta_key`, `meta_value`) (&nbsp;</div></li><li><div>          SELECT `topics`.`ID` AS `post_id`, '_bbp_reply_count' AS `meta_key`, COUNT(`replies`.`ID`) As `meta_value`&nbsp;</div></li><li><div>              FROM `{$wpdb-&gt;posts}` AS `topics`&nbsp;</div></li><li><div>                  LEFT JOIN `{$wpdb-&gt;posts}` as `replies`&nbsp;</div></li><li><div>                      ON  `replies`.`post_parent` = `topics`.`ID`&nbsp;</div></li><li><div>                      AND `replies`.`post_status` = '{$pps}'&nbsp;</div></li><li><div>                      AND `replies`.`post_type` = '{$rpt}'&nbsp;</div></li><li><div>              WHERE `topics`.`post_type` = '{$tpt}'&nbsp;</div></li><li><div>                  AND `topics`.`post_status` IN ( '{$pps}', '{$cps}' )&nbsp;</div></li><li><div>              GROUP BY `topics`.`ID`);&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql ) ) ) {&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount topic voices</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_topic_voice_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of voices in each topic&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;postmeta}` WHERE `meta_key` = '_bbp_voice_count';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Post type</span></span>s and status</span></span>&nbsp;</div></li><li><div>  $tpt = bbp_get_topic_post_type();&nbsp;</div></li><li><div>  $rpt = bbp_get_reply_post_type();&nbsp;</div></li><li><div>  $pps = bbp_get_public_status_id();&nbsp;</div></li><li><div>  $cps = bbp_get_closed_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;INSERT INTO `{$wpdb-&gt;postmeta}` (`post_id`, `meta_key`, `meta_value`) (&nbsp;</div></li><li><div>          SELECT `postmeta`.`meta_value`, '_bbp_voice_count', COUNT(DISTINCT `post_author`) as `meta_value`&nbsp;</div></li><li><div>              FROM `{$wpdb-&gt;posts}` AS `posts`&nbsp;</div></li><li><div>              LEFT JOIN `{$wpdb-&gt;postmeta}` AS `postmeta`&nbsp;</div></li><li><div>                  ON `posts`.`ID` = `postmeta`.`post_id`&nbsp;</div></li><li><div>                  AND `postmeta`.`meta_key` = '_bbp_topic_id'&nbsp;</div></li><li><div>              WHERE `posts`.`post_type` IN ( '{$tpt}', '{$rpt}' )&nbsp;</div></li><li><div>                  AND `posts`.`post_status` IN ( '{$pps}', '{$cps}' )&nbsp;</div></li><li><div>                  AND `posts`.`post_author` != '0'&nbsp;</div></li><li><div>              GROUP BY `postmeta`.`meta_value`);&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql ) ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount topic hidden replies (spammed/trashed)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2747)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_topic_hidden_reply_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of spammed and trashed replies in each topic&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;postmeta}` WHERE `meta_key` = '_bbp_reply_count_hidden';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;INSERT INTO `{$wpdb-&gt;postmeta}` (`post_id`, `meta_key`, `meta_value`) (SELECT `post_parent`, '_bbp_reply_count_hidden', COUNT(`post_status`) as `meta_value` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_reply_post_type() . &quot;' AND `post_status` IN ( '&quot; . implode( &quot;', '&quot;, array( bbp_get_trash_status_id(), bbp_get_spam_status_id() ) ) . &quot;') GROUP BY `post_parent`);&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql ) ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Repair group forum ID mappings after a bbPress 1.1 to bbPress 2.2 conversion</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4395)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WPDB $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @return If a wp_error() occurs and no converted forums are found</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_group_forum_relationship() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Repairing BuddyPress group-forum relationships&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $g_count = 0;&nbsp;</div></li><li><div>  $f_count = 0;&nbsp;</div></li><li><div>  $s_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the BuddyPress filter here, incase BuddyPress is not active</span>&nbsp;</div></li><li><div>  $prefix = apply_filters( 'bp_core_get_table_prefix', $wpdb-&gt;base_prefix );&nbsp;</div></li><li><div>  $groups_table = $prefix . 'bp_groups';&nbsp;</div></li><li><div>  $groups_meta_table = $prefix . 'bp_groups_groupmeta';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the converted forum IDs</span>&nbsp;</div></li><li><div>  $forum_ids = $wpdb-&gt;query( &quot;SELECT `forum`.`ID`, `forummeta`.`meta_value`&nbsp;</div></li><li><div>                              FROM `{$wpdb-&gt;posts}` AS `forum`&nbsp;</div></li><li><div>                                  LEFT JOIN `{$wpdb-&gt;postmeta}` AS `forummeta`&nbsp;</div></li><li><div>                                      ON `forum`.`ID` = `forummeta`.`post_id`&nbsp;</div></li><li><div>                                      AND `forummeta`.`meta_key` = '_bbp_old_forum_id'&nbsp;</div></li><li><div>                              WHERE `forum`.`post_type` = 'forum'&nbsp;</div></li><li><div>                              GROUP BY `forum`.`ID`;&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if forum IDs returned an error</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $forum_ids ) || empty( $wpdb-&gt;last_result ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, __( 'Failed!', 'bbpress' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stash the last results</span>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;last_result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update each group forum</span>&nbsp;</div></li><li><div>  foreach ( $results as $group_forums ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only update if is a converted forum</span>&nbsp;</div></li><li><div>      if ( ! isset( $group_forums-&gt;meta_value ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Attempt to update group meta</span>&nbsp;</div></li><li><div>      $updated = $wpdb-&gt;query( &quot;UPDATE `{$groups_meta_table}` SET `meta_value` = '{$group_forums-&gt;ID}' WHERE `meta_key` = 'forum_id' AND `meta_value` = '{$group_forums-&gt;meta_value}';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bump the count</span>&nbsp;</div></li><li><div>      if ( !empty( $updated ) && ! is_wp_error( $updated ) ) {&nbsp;</div></li><li><div>          ++$g_count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update group to forum relationship data</span>&nbsp;</div></li><li><div>      $group_id = (int) $wpdb-&gt;get_var( &quot;SELECT `group_id` FROM `{$groups_meta_table}` WHERE `meta_key` = 'forum_id' AND `meta_value` = '{$group_forums-&gt;ID}';&quot; );&nbsp;</div></li><li><div>      if ( !empty( $group_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update the group to forum meta connection in forums</span>&nbsp;</div></li><li><div>          update_post_meta( $group_forums-&gt;ID, '_bbp_group_ids', array( $group_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the group status</span>&nbsp;</div></li><li><div>          $group_status = $wpdb-&gt;get_var( &quot;SELECT `status` FROM `{$groups_table}` WHERE `id` = '{$group_id}';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Sync up forum visibility based on group status</span>&nbsp;</div></li><li><div>          switch ( $group_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Public groups have public forums</span>&nbsp;</div></li><li><div>              case 'public' :&nbsp;</div></li><li><div>                  bbp_publicize_forum( $group_forums-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Bump the count</span> for output later&nbsp;</div></li><li><div>                  ++$s_count;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Private/hidden groups have hidden forums</span>&nbsp;</div></li><li><div>              case 'private' :&nbsp;</div></li><li><div>              case 'hidden'  :&nbsp;</div></li><li><div>                  bbp_hide_forum( $group_forums-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Bump the count</span> for output later&nbsp;</div></li><li><div>                  ++$s_count;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Bump the count</span> for output later&nbsp;</div></li><li><div>          ++$f_count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make some logical guesses at the old group root forum</span>&nbsp;</div></li><li><div>  if ( function_exists( 'bp_forums_parent_forum_id' ) ) {&nbsp;</div></li><li><div>      $old_default_forum_id = bp_forums_parent_forum_id();&nbsp;</div></li><li><div>  } elseif ( defined( 'BP_FORUMS_PARENT_FORUM_ID' ) ) {&nbsp;</div></li><li><div>      $old_default_forum_id = (int) BP_FORUMS_PARENT_FORUM_ID;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $old_default_forum_id = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to get the group root forum</span>&nbsp;</div></li><li><div>  $posts = get_posts( array(&nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_forum_post_type(), &nbsp;</div></li><li><div>      'meta_key' =&gt; '_bbp_old_forum_id', &nbsp;</div></li><li><div>      'meta_value' =&gt; $old_default_forum_id, &nbsp;</div></li><li><div>      'numberposts' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Found the group root forum</span>&nbsp;</div></li><li><div>  if ( ! empty( $posts ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Rename 'Default Forum'  since it's now visible in sitewide forums</span>&nbsp;</div></li><li><div>      if ( 'Default Forum' === $posts[0]-&gt;post_title ) {&nbsp;</div></li><li><div>          wp_update_post( array(&nbsp;</div></li><li><div>              'ID' =&gt; $posts[0]-&gt;ID, &nbsp;</div></li><li><div>              'post_title' =&gt; __( 'Group Forums', 'bbpress' ), &nbsp;</div></li><li><div>              'post_name' =&gt; __( 'group-forums', 'bbpress' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update the group forums root metadata</span>&nbsp;</div></li><li><div>      update_option( '_bbp_group_forums_root_id', $posts[0]-&gt;ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove old bbPress 1.1 roles (BuddyPress)</span>&nbsp;</div></li><li><div>  remove_role( 'member' );&nbsp;</div></li><li><div>  remove_role( 'inactive' );&nbsp;</div></li><li><div>  remove_role( 'blocked' );&nbsp;</div></li><li><div>  remove_role( 'moderator' );&nbsp;</div></li><li><div>  remove_role( 'keymaster' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  $result = sprintf( __( 'Complete! %s groups updated; %s forums updated; %s forum statuses synced.', 'bbpress' ), bbp_number_format( $g_count ), bbp_number_format( $f_count ), bbp_number_format( $s_count ) );&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount forum topics</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_post_type() To get the forum post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_posts() To get the forums</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_topic_count() To update the forum topic count</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_forum_topic_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of topics in each forum&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM {$wpdb-&gt;postmeta} WHERE meta_key IN ( '_bbp_topic_count', '_bbp_total_topic_count' );&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forums = get_posts( array( 'post_type' =&gt; bbp_get_forum_post_type(), 'numberposts' =&gt; -1 ) );&nbsp;</div></li><li><div>  if ( !empty( $forums ) ) {&nbsp;</div></li><li><div>      foreach ( $forums as $forum ) {&nbsp;</div></li><li><div>          bbp_update_forum_topic_count( $forum-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount forum replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_post_type() To get the forum post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_posts() To get the forums</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_reply_count() To update the forum reply count</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_forum_reply_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of replies in each forum&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Post type</span></span>&nbsp;</div></li><li><div>  $fpt = bbp_get_forum_post_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete the meta keys _bbp_reply_count and _bbp_total_reply_count for each forum</span>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE `postmeta` FROM `{$wpdb-&gt;postmeta}` AS `postmeta`&nbsp;</div></li><li><div>                      LEFT JOIN `{$wpdb-&gt;posts}` AS `posts` ON `posts`.`ID` = `postmeta`.`post_id`&nbsp;</div></li><li><div>                      WHERE `posts`.`post_type` = '{$fpt}'&nbsp;</div></li><li><div>                      AND `postmeta`.`meta_key` = '_bbp_reply_count'&nbsp;</div></li><li><div>                      OR `postmeta`.`meta_key` = '_bbp_total_reply_count'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ) {&nbsp;</div></li><li><div>       return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>  <span class="comment">// Recalculate the metas key _bbp_reply_count and _bbp_total_reply_count for each forum</span>&nbsp;</div></li><li><div>  $forums = get_posts( array( 'post_type' =&gt; bbp_get_forum_post_type(), 'numberposts' =&gt; -1 ) );&nbsp;</div></li><li><div>  if ( !empty( $forums ) ) {&nbsp;</div></li><li><div>      foreach ( $forums as $forum ) {&nbsp;</div></li><li><div>          bbp_update_forum_reply_count( $forum-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount topics by the users</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3889)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_topic_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of topics each user has created&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $sql_select = &quot;SELECT `post_author`, COUNT(DISTINCT `ID`) as `_count` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_topic_post_type() . &quot;' AND `post_status` = '&quot; . bbp_get_public_status_id() . &quot;' GROUP BY `post_author`;&quot;;&nbsp;</div></li><li><div>  $insert_rows = $wpdb-&gt;get_results( $sql_select );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $insert_rows ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $key = $wpdb-&gt;prefix . '_bbp_topic_count';&nbsp;</div></li><li><div>  $insert_values = array();&nbsp;</div></li><li><div>  foreach ( $insert_rows as $insert_row )&nbsp;</div></li><li><div>      $insert_values[] = &quot;('{$insert_row-&gt;post_author}', '{$key}', '{$insert_row-&gt;_count}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !count( $insert_values ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 3, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_chunk( $insert_values, 10000 ) as $chunk ) {&nbsp;</div></li><li><div>      $chunk = &quot;\n&quot; . implode( &quot;, \n&quot;, $chunk );&nbsp;</div></li><li><div>      $sql_insert = &quot;INSERT INTO `{$wpdb-&gt;usermeta}` (`user_id`, `meta_key`, `meta_value`) VALUES $chunk;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $wpdb-&gt;query( $sql_insert ) ) ) {&nbsp;</div></li><li><div>          return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recount topic replied by the users</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_reply_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Counting the number of topics to which each user has replied&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $sql_select = &quot;SELECT `post_author`, COUNT(DISTINCT `ID`) as `_count` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_reply_post_type() . &quot;' AND `post_status` = '&quot; . bbp_get_public_status_id() . &quot;' GROUP BY `post_author`;&quot;;&nbsp;</div></li><li><div>  $insert_rows = $wpdb-&gt;get_results( $sql_select );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $insert_rows ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $key = $wpdb-&gt;prefix . '_bbp_reply_count';&nbsp;</div></li><li><div>  $insert_values = array();&nbsp;</div></li><li><div>  foreach ( $insert_rows as $insert_row )&nbsp;</div></li><li><div>      $insert_values[] = &quot;('{$insert_row-&gt;post_author}', '{$key}', '{$insert_row-&gt;_count}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !count( $insert_values ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 3, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_chunk( $insert_values, 10000 ) as $chunk ) {&nbsp;</div></li><li><div>      $chunk = &quot;\n&quot; . implode( &quot;, \n&quot;, $chunk );&nbsp;</div></li><li><div>      $sql_insert = &quot;INSERT INTO `{$wpdb-&gt;usermeta}` (`user_id`, `meta_key`, `meta_value`) VALUES $chunk;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $wpdb-&gt;query( $sql_insert ) ) ) {&nbsp;</div></li><li><div>          return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean the users' favorites</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_favorites() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Removing trashed topics from user favorites&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $key = $wpdb-&gt;prefix . '_bbp_favorites';&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results( &quot;SELECT `user_id`, `meta_value` AS `favorites` FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $users ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $topics = $wpdb-&gt;get_col( &quot;SELECT `ID` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_topic_post_type() . &quot;' AND `post_status` = '&quot; . bbp_get_public_status_id() . &quot;';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $topics ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $values = array();&nbsp;</div></li><li><div>  foreach ( $users as $user ) {&nbsp;</div></li><li><div>      if ( empty( $user-&gt;favorites ) || !is_string( $user-&gt;favorites ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $favorites = array_intersect( $topics, explode( ', ', $user-&gt;favorites ) );&nbsp;</div></li><li><div>      if ( empty( $favorites ) || !is_array( $favorites ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $favorites_joined = implode( ', ', $favorites );&nbsp;</div></li><li><div>      $values[] = &quot;('{$user-&gt;user_id}', '{$key}, '{$favorites_joined}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span></span></span>&nbsp;</div></li><li><div>      unset( $favorites, $favorites_joined );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !count( $values ) ) {&nbsp;</div></li><li><div>      $result = __( 'Nothing to remove!', 'bbpress' );&nbsp;</div></li><li><div>      return array( 0, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_chunk( $values, 10000 ) as $chunk ) {&nbsp;</div></li><li><div>      $chunk = &quot;\n&quot; . implode( &quot;, \n&quot;, $chunk );&nbsp;</div></li><li><div>      $sql_insert = &quot;INSERT INTO `$wpdb-&gt;usermeta` (`user_id`, `meta_key`, `meta_value`) VALUES $chunk;&quot;;&nbsp;</div></li><li><div>      if ( is_wp_error( $wpdb-&gt;query( $sql_insert ) ) ) {&nbsp;</div></li><li><div>          return array( 5, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean the users' topic subscriptions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2668)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_topic_subscriptions() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Removing trashed topics from user subscriptions&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $key = $wpdb-&gt;prefix . '_bbp_subscriptions';&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results( &quot;SELECT `user_id`, `meta_value` AS `subscriptions` FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $users ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $topics = $wpdb-&gt;get_col( &quot;SELECT `ID` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_topic_post_type() . &quot;' AND `post_status` = '&quot; . bbp_get_public_status_id() . &quot;';&quot; );&nbsp;</div></li><li><div>  if ( is_wp_error( $topics ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $values = array();&nbsp;</div></li><li><div>  foreach ( $users as $user ) {&nbsp;</div></li><li><div>      if ( empty( $user-&gt;subscriptions ) || !is_string( $user-&gt;subscriptions ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscriptions = array_intersect( $topics, explode( ', ', $user-&gt;subscriptions ) );&nbsp;</div></li><li><div>      if ( empty( $subscriptions ) || !is_array( $subscriptions ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscriptions_joined = implode( ', ', $subscriptions );&nbsp;</div></li><li><div>      $values[] = &quot;('{$user-&gt;user_id}', '{$key}', '{$subscriptions_joined}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span></span></span>&nbsp;</div></li><li><div>      unset( $subscriptions, $subscriptions_joined );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !count( $values ) ) {&nbsp;</div></li><li><div>      $result = __( 'Nothing to remove!', 'bbpress' );&nbsp;</div></li><li><div>      return array( 0, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_chunk( $values, 10000 ) as $chunk ) {&nbsp;</div></li><li><div>      $chunk = &quot;\n&quot; . implode( &quot;, \n&quot;, $chunk );&nbsp;</div></li><li><div>      $sql_insert = &quot;INSERT INTO `{$wpdb-&gt;usermeta}` (`user_id`, `meta_key`, `meta_value`) VALUES $chunk;&quot;;&nbsp;</div></li><li><div>      if ( is_wp_error( $wpdb-&gt;query( $sql_insert ) ) ) {&nbsp;</div></li><li><div>          return array( 5, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean the users' forum subscriptions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5155)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_forum_subscriptions() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Removing trashed forums from user subscriptions&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $key = $wpdb-&gt;prefix . '_bbp_forum_subscriptions';&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results( &quot;SELECT `user_id`, `meta_value` AS `subscriptions` FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $users ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forums = $wpdb-&gt;get_col( &quot;SELECT `ID` FROM `{$wpdb-&gt;posts}` WHERE `post_type` = '&quot; . bbp_get_forum_post_type() . &quot;' AND `post_status` = '&quot; . bbp_get_public_status_id() . &quot;';&quot; );&nbsp;</div></li><li><div>  if ( is_wp_error( $forums ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $values = array();&nbsp;</div></li><li><div>  foreach ( $users as $user ) {&nbsp;</div></li><li><div>      if ( empty( $user-&gt;subscriptions ) || !is_string( $user-&gt;subscriptions ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscriptions = array_intersect( $forums, explode( ', ', $user-&gt;subscriptions ) );&nbsp;</div></li><li><div>      if ( empty( $subscriptions ) || !is_array( $subscriptions ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscriptions_joined = implode( ', ', $subscriptions );&nbsp;</div></li><li><div>      $values[] = &quot;('{$user-&gt;user_id}', '{$key}', '{$subscriptions_joined}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span></span></span>&nbsp;</div></li><li><div>      unset( $subscriptions, $subscriptions_joined );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !count( $values ) ) {&nbsp;</div></li><li><div>      $result = __( 'Nothing to remove!', 'bbpress' );&nbsp;</div></li><li><div>      return array( 0, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '{$key}';&quot;;&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( $sql_delete ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_chunk( $values, 10000 ) as $chunk ) {&nbsp;</div></li><li><div>      $chunk = &quot;\n&quot; . implode( &quot;, \n&quot;, $chunk );&nbsp;</div></li><li><div>      $sql_insert = &quot;INSERT INTO `{$wpdb-&gt;usermeta}` (`user_id`, `meta_key`, `meta_value`) VALUES $chunk;&quot;;&nbsp;</div></li><li><div>      if ( is_wp_error( $wpdb-&gt;query( $sql_insert ) ) ) {&nbsp;</div></li><li><div>          return array( 5, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * This repair tool will map each user of the current site to their respective</span>&nbsp;</div></li><li><div><span class="comment"> * forums role. By default, Admins will be Key Masters, and every other role</span>&nbsp;</div></li><li><div><span class="comment"> * will be the default role defined in Settings &gt; Forums (Participant).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4340)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_user_role_map() To get the map of user roles</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_editable_roles() To get the current WordPress roles</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_users() To get the users of each role (limited to ID field)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_set_user_role() To set each user's forums role</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_user_roles() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Remapping forum role for each user on this site&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $changed = 0;&nbsp;</div></li><li><div>  $role_map = bbp_get_user_role_map();&nbsp;</div></li><li><div>  $default_role = bbp_get_default_role();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no role map exists</span>&nbsp;</div></li><li><div>  if ( empty( $role_map ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, __( 'Failed!', 'bbpress' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Iterate through each role...</span>&nbsp;</div></li><li><div>  foreach ( array_keys( bbp_get_blog_roles() ) as $role ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Reset the offset</span>&nbsp;</div></li><li><div>      $offset = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If no role map exists, give the default forum role (bbp-participant)</span>&nbsp;</div></li><li><div>      $new_role = isset( $role_map[$role] ) ? $role_map[$role] : $default_role;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get users of this site, limited to 1000</span>&nbsp;</div></li><li><div>      while ( $users = get_users( array(&nbsp;</div></li><li><div>              'role' =&gt; $role, &nbsp;</div></li><li><div>              'fields' =&gt; 'ID', &nbsp;</div></li><li><div>              'number' =&gt; 1000, &nbsp;</div></li><li><div>              'offset' =&gt; $offset&nbsp;</div></li><li><div> ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Iterate through each user of $role and try to set it</span>&nbsp;</div></li><li><div>          foreach ( (array) $users as $user_id ) {&nbsp;</div></li><li><div>              if ( bbp_set_user_role( $user_id, $new_role ) ) {&nbsp;</div></li><li><div>                  ++$changed; <span class="comment">// Keep a count to display at the end</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Bump the offset for the next query iteration</span>&nbsp;</div></li><li><div>          $offset = $offset + 1000;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = sprintf( __( 'Complete! %s users updated.', 'bbpress' ), bbp_number_format( $changed ) );&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recaches the last post in every topic and forum</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3040)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_freshness() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Recomputing latest post in every topic and forum&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// First, delete everything.</span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;DELETE FROM `$wpdb-&gt;postmeta` WHERE `meta_key` IN ( '_bbp_last_reply_id', '_bbp_last_topic_id', '_bbp_last_active_id', '_bbp_last_active_time' );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `topic`.`ID`, '_bbp_last_reply_id', MAX( `reply`.`ID` )&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` INNER JOIN `$wpdb-&gt;posts` AS `reply` ON `topic`.`ID` = `reply`.`post_parent`&nbsp;</div></li><li><div>          WHERE `reply`.`post_status` IN ( '&quot; . bbp_get_public_status_id() . &quot;' ) AND `topic`.`post_type` = 'topic' AND `reply`.`post_type` = 'reply'&nbsp;</div></li><li><div>          GROUP BY `topic`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For any remaining topics, give a reply ID of 0.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `ID`, '_bbp_last_reply_id', 0&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` LEFT JOIN `$wpdb-&gt;postmeta` AS `reply`&nbsp;</div></li><li><div>          ON `topic`.`ID` = `reply`.`post_id` AND `reply`.`meta_key` = '_bbp_last_reply_id'&nbsp;</div></li><li><div>          WHERE `reply`.`meta_id` IS NULL AND `topic`.`post_type` = 'topic' );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 3, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Now we give all the forums with topics the ID their last topic.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `forum`.`ID`, '_bbp_last_topic_id', `topic`.`ID`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `forum` INNER JOIN `$wpdb-&gt;posts` AS `topic` ON `forum`.`ID` = `topic`.`post_parent`&nbsp;</div></li><li><div>          WHERE `topic`.`post_status` IN ( '&quot; . bbp_get_public_status_id() . &quot;' ) AND `forum`.`post_type` = 'forum' AND `topic`.`post_type` = 'topic'&nbsp;</div></li><li><div>          GROUP BY `forum`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For any remaining forums, give a topic ID of 0.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `ID`, '_bbp_last_topic_id', 0&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `forum` LEFT JOIN `$wpdb-&gt;postmeta` AS `topic`&nbsp;</div></li><li><div>          ON `forum`.`ID` = `topic`.`post_id` AND `topic`.`meta_key` = '_bbp_last_topic_id'&nbsp;</div></li><li><div>          WHERE `topic`.`meta_id` IS NULL AND `forum`.`post_type` = 'forum' );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 5, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// After that, we give all the topics with replies the ID their last reply (again, this time for a different reason).</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `topic`.`ID`, '_bbp_last_active_id', MAX( `reply`.`ID` )&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` INNER JOIN `$wpdb-&gt;posts` AS `reply` ON `topic`.`ID` = `reply`.`post_parent`&nbsp;</div></li><li><div>          WHERE `reply`.`post_status` IN ( '&quot; . bbp_get_public_status_id() . &quot;' ) AND `topic`.`post_type` = 'topic' AND `reply`.`post_type` = 'reply'&nbsp;</div></li><li><div>          GROUP BY `topic`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 6, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For any remaining topics, give a reply ID of themself.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `ID`, '_bbp_last_active_id', `ID`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` LEFT JOIN `$wpdb-&gt;postmeta` AS `reply`&nbsp;</div></li><li><div>          ON `topic`.`ID` = `reply`.`post_id` AND `reply`.`meta_key` = '_bbp_last_active_id'&nbsp;</div></li><li><div>          WHERE `reply`.`meta_id` IS NULL AND `topic`.`post_type` = 'topic' );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 7, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Give topics with replies their last update time.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `topic`.`ID`, '_bbp_last_active_time', MAX( `reply`.`post_date` )&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` INNER JOIN `$wpdb-&gt;posts` AS `reply` ON `topic`.`ID` = `reply`.`post_parent`&nbsp;</div></li><li><div>          WHERE `reply`.`post_status` IN ( '&quot; . bbp_get_public_status_id() . &quot;' ) AND `topic`.`post_type` = 'topic' AND `reply`.`post_type` = 'reply'&nbsp;</div></li><li><div>          GROUP BY `topic`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 8, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Give topics without replies their last update time.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `ID`, '_bbp_last_active_time', `post_date`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts` AS `topic` LEFT JOIN `$wpdb-&gt;postmeta` AS `reply`&nbsp;</div></li><li><div>          ON `topic`.`ID` = `reply`.`post_id` AND `reply`.`meta_key` = '_bbp_last_active_time'&nbsp;</div></li><li><div>          WHERE `reply`.`meta_id` IS NULL AND `topic`.`post_type` = 'topic' );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 9, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forums need to know what their last active item is as well. Now it gets a bit more complex to do in the database.</span>&nbsp;</div></li><li><div>  $forums = $wpdb-&gt;get_col( &quot;SELECT `ID` FROM `$wpdb-&gt;posts` WHERE `post_type` = 'forum' and `post_status` != 'auto-draft';&quot; );&nbsp;</div></li><li><div>  if ( is_wp_error( $forums ) )&nbsp;</div></li><li><div>      return array( 10, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   <span class="comment">// Loop through forums</span>&nbsp;</div></li><li><div>   foreach ( $forums as $forum_id ) {&nbsp;</div></li><li><div>      if ( !bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_update_forum( array( 'forum_id' =&gt; $forum_id ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through categories when forums are done</span>&nbsp;</div></li><li><div>  foreach ( $forums as $forum_id ) {&nbsp;</div></li><li><div>      if ( bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_update_forum( array( 'forum_id' =&gt; $forum_id ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Repairs the relationship of sticky topics to the actual parent forum</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4695)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_col() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_sticky() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Repairing the sticky topic to the parent forum relationships&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>  $forums = $wpdb-&gt;get_col( &quot;SELECT ID FROM `{$wpdb-&gt;posts}` WHERE `post_type` = 'forum';&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no forums found</span>&nbsp;</div></li><li><div>  if ( empty( $forums ) || is_wp_error( $forums ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through forums</span> and get their sticky topics&nbsp;</div></li><li><div>  foreach ( $forums as $forum ) {&nbsp;</div></li><li><div>      $forum_stickies[$forum] = get_post_meta( $forum, '_bbp_sticky_topics', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span></span></span>&nbsp;</div></li><li><div>  unset( $forums, $forum );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through each forum with sticky topics</span>&nbsp;</div></li><li><div>  foreach ( $forum_stickies as $forum_id =&gt; $stickies ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Skip if no stickies</span>&nbsp;</div></li><li><div>      if ( empty( $stickies ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through each sticky topic</span>&nbsp;</div></li><li><div>      foreach ( $stickies as $id =&gt; $topic_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If the topic is not a super sticky, and the forum ID does not</span>&nbsp;</div></li><li><div>          <span class="comment">// match the topic's forum ID, unset the forum's sticky meta.</span>&nbsp;</div></li><li><div>          if ( ! bbp_is_topic_super_sticky( $topic_id ) && $forum_id !== bbp_get_topic_forum_id( $topic_id ) ) {&nbsp;</div></li><li><div>              unset( $forum_stickies[$forum_id][$id] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get sticky topic ID's, or use empty string</span>&nbsp;</div></li><li><div>      $stickers = empty( $forum_stickies[$forum_id] ) ? '' : array_values( $forum_stickies[$forum_id] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update the forum's sticky topics meta</span>&nbsp;</div></li><li><div>      update_post_meta( $forum_id, '_bbp_sticky_topics', $stickers );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recaches the private and hidden forums</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4104)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_option() to delete private and hidden forum pointers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Query() To query post IDs</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To return if error occurred</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_option() To update the private and hidden post ID pointers</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_forum_visibility() {&nbsp;</div></li><li><div>  $statement = __( 'Recalculating forum visibility &hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if queries returned errors</span>&nbsp;</div></li><li><div>  if ( ! bbp_repair_forum_visibility() ) {&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, __( 'Failed!', 'bbpress' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recaches the forum for each post</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3876)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_forum_meta() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Recalculating the forum for each post &hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// First, delete everything.</span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;DELETE FROM `$wpdb-&gt;postmeta` WHERE `meta_key` = '_bbp_forum_id';&quot; ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `forum`.`ID`, '_bbp_forum_id', `forum`.`post_parent`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `forum`&nbsp;</div></li><li><div>          WHERE `forum`.`post_type` = 'forum'&nbsp;</div></li><li><div>          GROUP BY `forum`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 2, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `topic`.`ID`, '_bbp_forum_id', `topic`.`post_parent`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `topic`&nbsp;</div></li><li><div>          WHERE `topic`.`post_type` = 'topic'&nbsp;</div></li><li><div>          GROUP BY `topic`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 3, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `reply`.`ID`, '_bbp_forum_id', `topic`.`post_parent`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `reply`&nbsp;</div></li><li><div>          INNER JOIN `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `topic`&nbsp;</div></li><li><div>              ON `reply`.`post_parent` = `topic`.`ID`&nbsp;</div></li><li><div>          WHERE `topic`.`post_type` = 'topic'&nbsp;</div></li><li><div>              AND `reply`.`post_type` = 'reply'&nbsp;</div></li><li><div>          GROUP BY `reply`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recaches the topic for each post</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3876)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_topic_meta() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Recalculating the topic for each post &hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'Failed!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// First, delete everything.</span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;DELETE FROM `$wpdb-&gt;postmeta` WHERE `meta_key` = '_bbp_topic_id';&quot; ) ) )&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `topic`.`ID`, '_bbp_topic_id', `topic`.`ID`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `topic`&nbsp;</div></li><li><div>          WHERE `topic`.`post_type` = 'topic'&nbsp;</div></li><li><div>          GROUP BY `topic`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 3, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Next, give all the topics with replies the ID their last reply.</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` (`post_id`, `meta_key`, `meta_value`)&nbsp;</div></li><li><div>          ( SELECT `reply`.`ID`, '_bbp_topic_id', `topic`.`ID`&nbsp;</div></li><li><div>          FROM `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `reply`&nbsp;</div></li><li><div>          INNER JOIN `$wpdb-&gt;posts`&nbsp;</div></li><li><div>              AS `topic`&nbsp;</div></li><li><div>              ON `reply`.`post_parent` = `topic`.`ID`&nbsp;</div></li><li><div>          WHERE `topic`.`post_type` = 'topic'&nbsp;</div></li><li><div>              AND `reply`.`post_type` = 'reply'&nbsp;</div></li><li><div>          GROUP BY `reply`.`ID` );&quot; ) ) )&nbsp;</div></li><li><div>      return array( 4, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Complete results</span></span></span></span></span></span>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Recalculate reply menu order</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5367)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::query() To run our recount sql queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the executed query returned {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_position() To update the reply position</span>&nbsp;</div></li><li><div><span class="comment"> * @return array An array of the status code and the message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_repair_reply_menu_order() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Recalculating reply menu order &hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $result = __( 'No reply positions to recalculate!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete cases where `_bbp_reply_to` was accidentally set to itself</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $wpdb-&gt;query( &quot;DELETE FROM `{$wpdb-&gt;postmeta}` WHERE `meta_key` = '_bbp_reply_to' AND `post_id` = `meta_value`;&quot; ) ) ) {&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) ); &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Post type</span></span>&nbsp;</div></li><li><div>  $rpt = bbp_get_reply_post_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get an array of reply id's to update the menu oder for each reply</span>&nbsp;</div></li><li><div>  $replies = $wpdb-&gt;get_results( &quot;SELECT `a`.`ID` FROM `{$wpdb-&gt;posts}` AS `a`&nbsp;</div></li><li><div>                                      INNER JOIN (&nbsp;</div></li><li><div>                                          SELECT `menu_order`, `post_parent`&nbsp;</div></li><li><div>                                          FROM `{$wpdb-&gt;posts}`&nbsp;</div></li><li><div>                                          GROUP BY `menu_order`, `post_parent`&nbsp;</div></li><li><div>                                          HAVING COUNT( * ) &gt;1&nbsp;</div></li><li><div> )`b`&nbsp;</div></li><li><div>                                      ON `a`.`menu_order` = `b`.`menu_order`&nbsp;</div></li><li><div>                                      AND `a`.`post_parent` = `b`.`post_parent`&nbsp;</div></li><li><div>                                      WHERE `post_type` = '{$rpt}';&quot;, OBJECT_K );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no replies returned</span>&nbsp;</div></li><li><div>  if ( empty( $replies ) ) {&nbsp;</div></li><li><div>      return array( 1, sprintf( $statement, $result ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Recalculate the menu order position for each reply</span>&nbsp;</div></li><li><div>  foreach ( $replies as $reply ) {&nbsp;</div></li><li><div>      bbp_update_reply_position( $reply-&gt;ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span></span></span>&nbsp;</div></li><li><div>  unset( $replies, $reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Flush the cache; things are about to get ugly.</span></span>&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 0, sprintf( $statement, __( 'Complete!', 'bbpress' ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Reset ********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Admin reset page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_admin_referer() To verify the nonce and the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'admin_notices' to display the notices</span>&nbsp;</div></li><li><div><span class="comment"> * @uses screen_icon() To display the screen icon</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_nonce_field() To add a hidden nonce field</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_reset() {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php screen_icon( 'tools' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;h2 class=&quot;nav-tab-wrapper&quot;&gt;&lt;?php bbp_tools_admin_tabs( __( 'Reset Forums', 'bbpress' ) ); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php esc_html_e( 'Revert your forums back to a brand new installation. This process cannot be undone.', 'bbpress' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;strong&gt;&lt;?php esc_html_e( 'Backup your database before proceeding.', 'bbpress' ); ?&gt;&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;form class=&quot;settings&quot; method=&quot;post&quot; action=&quot;&quot;&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>              &lt;tbody&gt;&nbsp;</div></li><li><div>                  &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                      &lt;th scope=&quot;row&quot;&gt;&lt;?php esc_html_e( 'The following data will be removed:', 'bbpress' ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'All Forums', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'All Topics', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'All Replies', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'All Topic Tags', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'Related Meta Data', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'Forum Settings', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'Forum Activity', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'Forum User Roles', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;?php esc_html_e( 'Importer Helper Data', 'bbpress' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                      &lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                      &lt;th scope=&quot;row&quot;&gt;&lt;?php esc_html_e( 'Delete imported users?', 'bbpress' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&nbsp;</div></li><li><div>                          &lt;fieldset&gt;&nbsp;</div></li><li><div>                              &lt;legend class=&quot;screen-reader-text&quot;&gt;&lt;span&gt;&lt;?php esc_html_e( &quot;Say it ain't so!&quot;, 'bbpress' ); ?&gt;&lt;/span&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>                              &lt;label&gt;&lt;input type=&quot;checkbox&quot; class=&quot;checkbox&quot; name=&quot;bbpress-delete-imported-users&quot; id=&quot;bbpress-delete-imported-users&quot; value=&quot;1&quot; /&gt; &lt;?php esc_html_e( 'This option will delete all previously imported users, and cannot be undone.', 'bbpress' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                              &lt;p class=&quot;description&quot;&gt;&lt;?php esc_html_e( 'Note: Resetting without this checked will delete the meta-data necessary to delete these users.', 'bbpress' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                          &lt;/fieldset&gt;&nbsp;</div></li><li><div>                      &lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                      &lt;th scope=&quot;row&quot;&gt;&lt;?php esc_html_e( 'Are you sure you want to do this?', 'bbpress' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&nbsp;</div></li><li><div>                          &lt;fieldset&gt;&nbsp;</div></li><li><div>                              &lt;legend class=&quot;screen-reader-text&quot;&gt;&lt;span&gt;&lt;?php esc_html_e( &quot;Say it ain't so!&quot;, 'bbpress' ); ?&gt;&lt;/span&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>                              &lt;label&gt;&lt;input type=&quot;checkbox&quot; class=&quot;checkbox&quot; name=&quot;bbpress-are-you-sure&quot; id=&quot;bbpress-are-you-sure&quot; value=&quot;1&quot; /&gt; &lt;?php esc_html_e( 'This process cannot be undone.', 'bbpress' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                              &lt;p class=&quot;description&quot;&gt;&lt;?php esc_html_e( 'Human sacrifice, dogs and cats living together... mass hysteria!', 'bbpress' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                          &lt;/fieldset&gt;&nbsp;</div></li><li><div>                      &lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/tbody&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;fieldset class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>              &lt;input class=&quot;button-primary&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php esc_attr_e( 'Reset bbPress', 'bbpress' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field( 'bbpress-reset' ); ?&gt;&nbsp;</div></li><li><div>          &lt;/fieldset&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle the processing and feedback of the admin tools page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2613)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_admin_referer() To verify the nonce and the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_flush() To flush the cache</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_admin_reset_handler() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if not resetting</span>&nbsp;</div></li><li><div>  if ( ! bbp_is_post_request() || empty( $_POST['bbpress-are-you-sure'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only keymasters can proceed</span>&nbsp;</div></li><li><div>  if ( ! bbp_is_user_keymaster() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_admin_referer( 'bbpress-reset' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Stores messages</span></span>&nbsp;</div></li><li><div>  $messages = array();&nbsp;</div></li><li><div>  $failed = __( 'Failed', 'bbpress' );&nbsp;</div></li><li><div>  $success = __( 'Success!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Flush the cache; things are about to get ugly.</span></span>&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Posts *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Deleting Posts&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $sql_posts = $wpdb-&gt;get_results( &quot;SELECT `ID` FROM `{$wpdb-&gt;posts}` WHERE `post_type` IN ('forum', 'topic', 'reply')&quot;, OBJECT_K );&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;posts}` WHERE `post_type` IN ('forum', 'topic', 'reply')&quot;;&nbsp;</div></li><li><div>  $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>  $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Post Meta *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $sql_posts ) ) {&nbsp;</div></li><li><div>      $sql_meta = array();&nbsp;</div></li><li><div>      foreach ( $sql_posts as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $sql_meta[] = $key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $statement = __( 'Deleting Post Meta&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>      $sql_meta = implode( &quot;', '&quot;, $sql_meta );&nbsp;</div></li><li><div>      $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;postmeta}` WHERE `post_id` IN ('{$sql_meta}');&quot;;&nbsp;</div></li><li><div>      $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>      $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Tags ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Deleting Topic Tags&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $sql_delete = &quot;DELETE a, b, c FROM `{$wpdb-&gt;terms}` AS a LEFT JOIN `{$wpdb-&gt;term_taxonomy}` AS c ON a.term_id = c.term_id LEFT JOIN `{$wpdb-&gt;term_relationships}` AS b ON b.term_taxonomy_id = c.term_taxonomy_id WHERE c.taxonomy = 'topic-tag';&quot;;&nbsp;</div></li><li><div>  $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>  $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** User ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete users</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbpress-delete-imported-users'] ) ) {&nbsp;</div></li><li><div>      $sql_users = $wpdb-&gt;get_results( &quot;SELECT `user_id` FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` = '_bbp_user_id'&quot;, OBJECT_K );&nbsp;</div></li><li><div>      if ( !empty( $sql_users ) ) {&nbsp;</div></li><li><div>          $sql_meta = array();&nbsp;</div></li><li><div>          foreach ( $sql_users as $key =&gt; $value ) {&nbsp;</div></li><li><div>              $sql_meta[] = $key;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $statement = __( 'Deleting User&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>          $sql_meta = implode( &quot;', '&quot;, $sql_meta );&nbsp;</div></li><li><div>          $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;users}` WHERE `ID` IN ('{$sql_meta}');&quot;;&nbsp;</div></li><li><div>          $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>          $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>          $statement = __( 'Deleting User Meta&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>          $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `user_id` IN ('{$sql_meta}');&quot;;&nbsp;</div></li><li><div>          $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>          $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete imported user metadata</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $statement = __( 'Deleting User Meta&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>      $sql_delete = &quot;DELETE FROM `{$wpdb-&gt;usermeta}` WHERE `meta_key` LIKE '%%_bbp_%%';&quot;;&nbsp;</div></li><li><div>      $result = is_wp_error( $wpdb-&gt;query( $sql_delete ) ) ? $failed : $success;&nbsp;</div></li><li><div>      $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Converter *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Deleting Conversion Table&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  $table_name = $wpdb-&gt;prefix . 'bbp_converter_translator';&nbsp;</div></li><li><div>  if ( $wpdb-&gt;get_var( &quot;SHOW TABLES LIKE '{$table_name}'&quot; ) === $table_name ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;DROP TABLE {$table_name}&quot; );&nbsp;</div></li><li><div>      $result = $success;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $result = $failed;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $messages[] = sprintf( $statement, $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Options ***************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Deleting Settings&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  bbp_delete_options();&nbsp;</div></li><li><div>  $messages[] = sprintf( $statement, $success );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Roles *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statement = __( 'Deleting Roles and Capabilities&hellip; %s', 'bbpress' );&nbsp;</div></li><li><div>  remove_role( bbp_get_moderator_role() );&nbsp;</div></li><li><div>  remove_role( bbp_get_participant_role() );&nbsp;</div></li><li><div>  bbp_remove_caps();&nbsp;</div></li><li><div>  $messages[] = sprintf( $statement, $success );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Output ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $messages ) ) {&nbsp;</div></li><li><div>      foreach ( $messages as $message ) {&nbsp;</div></li><li><div>          bbp_admin_tools_feedback( $message );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>bbPress</li><li><span></span>2.5.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>