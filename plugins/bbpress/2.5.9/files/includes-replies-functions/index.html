<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.5.9" data-slug="bbpress" data-type="file" data-id="62469"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-replies-functions | file | Bbpress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, bbpress, 2.5.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=56f6345e2ae21f1a17720dc52b49efc7' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-replies-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-replies-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-replies-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-bbpress-2.5.9-file-includes-replies-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-replies-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to bbpress." href="http://hookr.io/plugins/bbpress/" class="plugin"><span property="name">bbpress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.5.9." href="http://hookr.io/plugins/bbpress/2.5.9/" class="H_VERSION"><span property="name">2.5.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/bbpress/2.5.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-replies-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2373"><a href="http://hookr.io/plugins/bbpress/2.5.9/all/" title="All">All <span class="count badge">2373</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/bbpress/2.5.9/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="1132"><a href="http://hookr.io/plugins/bbpress/2.5.9/hooks/" title="Hooks">Hooks <span class="count badge">1132</span></a></li><li class="" data-id="action" data-count="471"><a href="http://hookr.io/plugins/bbpress/2.5.9/actions/" title="Actions">Actions <span class="count badge">471</span></a></li><li class="" data-id="filter" data-count="661"><a href="http://hookr.io/plugins/bbpress/2.5.9/filters/" title="Filters">Filters <span class="count badge">661</span></a></li><li class="" data-id="class" data-count="54"><a href="http://hookr.io/plugins/bbpress/2.5.9/classes/" title="Classes">Classes <span class="count badge">54</span></a></li><li class="" data-id="constant" data-count="28"><a href="http://hookr.io/plugins/bbpress/2.5.9/constants/" title="Constants">Constants <span class="count badge">28</span></a></li><li class="" data-id="function" data-count="1158"><a href="http://hookr.io/plugins/bbpress/2.5.9/functions/" title="Functions">Functions <span class="count badge">1158</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/bbpress/2.5.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/replies/functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * bbPress Reply Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Functions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( !defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Insert ********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A wrapper for wp_insert_post() that also includes the necessary meta values</span>&nbsp;</div></li><li><div><span class="comment"> * for the reply to function properly.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3349)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_parse_args()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_post()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $reply_data Forum post data</span>&nbsp;</div></li><li><div><span class="comment"> * @param arrap $reply_meta Forum meta data</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_insert_reply( $reply_data = array(), $reply_meta = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span>&nbsp;</div></li><li><div>  $reply_data = bbp_parse_args( $reply_data, array(&nbsp;</div></li><li><div>      'post_parent' =&gt; 0, <span class="comment">// topic ID</span>&nbsp;</div></li><li><div>      'post_status' =&gt; bbp_get_public_status_id(), &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'post_author' =&gt; bbp_get_current_user_id(), &nbsp;</div></li><li><div>      'post_password' =&gt; '', &nbsp;</div></li><li><div>      'post_content' =&gt; '', &nbsp;</div></li><li><div>      'post_title' =&gt; '', &nbsp;</div></li><li><div>      'menu_order' =&gt; 0, &nbsp;</div></li><li><div>      'comment_status' =&gt; 'closed'&nbsp;</div></li><li><div> ), 'insert_reply' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Insert reply</span></span>&nbsp;</div></li><li><div>  $reply_id = wp_insert_post( $reply_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no reply was added</span>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span> meta&nbsp;</div></li><li><div>  $reply_meta = bbp_parse_args( $reply_meta, array(&nbsp;</div></li><li><div>      'author_ip' =&gt; bbp_current_author_ip(), &nbsp;</div></li><li><div>      'forum_id' =&gt; 0, &nbsp;</div></li><li><div>      'topic_id' =&gt; 0, &nbsp;</div></li><li><div> ), 'insert_reply_meta' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Insert reply</span></span> meta&nbsp;</div></li><li><div>  foreach ( $reply_meta as $meta_key =&gt; $meta_value ) {&nbsp;</div></li><li><div>      update_post_meta( $reply_id, '_bbp_' . $meta_key, $meta_value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the topic</span></span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>  if ( !empty( $topic_id ) ) {&nbsp;</div></li><li><div>      bbp_update_topic( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return new reply ID</span>&nbsp;</div></li><li><div>  return $reply_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Post Form Handlers ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end reply submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2574)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_anonymous() To check if an anonymous post is being made</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can publish replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_current_user_id() To get the current user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_filter_anonymous_post_data() To filter anonymous data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_set_current_anonymous_user_data() To set the anonymous user</span>&nbsp;</div></li><li><div><span class="comment"> *                                                cookies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses remove_filter() To remove kses filters if needed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses esc_attr() For sanitization</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_check_for_flood() To check for flooding</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_check_for_duplicate() To check for duplicates</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_new_reply_pre_title' with the title</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_new_reply_pre_content' with the content</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_set_post_terms() To set the topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_post() To insert the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_new_reply' with the reply id, topic id, forum</span>&nbsp;</div></li><li><div><span class="comment"> *                    id, anonymous data, reply author, edit (false), and</span>&nbsp;</div></li><li><div><span class="comment"> *                    the reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_url() To get the paginated url to the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the reply url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_message() To get the {@link WP_Error} error</span>&nbsp;</div></li><li><div><span class="comment"> *                                              message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_new_reply_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not bbp-new-reply</span>&nbsp;</div></li><li><div>  if ( 'bbp-new-reply' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Nonce check</span></span>&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-new-reply' ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_new_reply_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Define local variable(s)</span></span>&nbsp;</div></li><li><div>  $topic_id = $forum_id = $reply_author = $anonymous_data = $reply_to = 0;&nbsp;</div></li><li><div>  $reply_title = $reply_content = $terms = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply Author **********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is anonymous</span>&nbsp;</div></li><li><div>  if ( bbp_is_anonymous() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Filter anonymous data</span></span>&nbsp;</div></li><li><div>      $anonymous_data = bbp_filter_anonymous_post_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Anonymous data checks out, so set cookies, etc...</span>&nbsp;</div></li><li><div>      if ( !empty( $anonymous_data ) && is_array( $anonymous_data ) ) {&nbsp;</div></li><li><div>          bbp_set_current_anonymous_user_data( $anonymous_data );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is logged in</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User cannot create replies</span>&nbsp;</div></li><li><div>      if ( !current_user_can( 'publish_replies' ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have permission to reply.', 'bbpress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Reply author is current user</span>&nbsp;</div></li><li><div>      $reply_author = bbp_get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic ID **************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic id was not passed</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_topic_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_topic_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic id is not a number</span>&nbsp;</div></li><li><div>  } elseif ( ! is_numeric( $_POST['bbp_topic_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_topic_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic ID must be a number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic id might be valid</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the topic id</span>&nbsp;</div></li><li><div>      $posted_topic_id = intval( $_POST['bbp_topic_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Topic id is a negative number</span>&nbsp;</div></li><li><div>      if ( 0 &gt; $posted_topic_id ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_topic_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic ID cannot be a negative number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Topic does not exist</span>&nbsp;</div></li><li><div>      } elseif ( ! bbp_get_topic( $posted_topic_id ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_topic_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic does not exist.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Use the POST'ed topic id</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $topic_id = $posted_topic_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Forum ID **************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to use the forum id of the topic</span>&nbsp;</div></li><li><div>  if ( !isset( $_POST['bbp_forum_id'] ) && !empty( $topic_id ) ) {&nbsp;</div></li><li><div>      $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Error check the POST'ed forum id</span>&nbsp;</div></li><li><div>  } elseif ( isset( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Empty Forum id was passed</span>&nbsp;</div></li><li><div>      if ( empty( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> id is not a number&nbsp;</div></li><li><div>      } elseif ( ! is_numeric( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID must be a number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> id might be valid&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the forum id</span>&nbsp;</div></li><li><div>          $posted_forum_id = intval( $_POST['bbp_forum_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> id is empty&nbsp;</div></li><li><div>          if ( 0 === $posted_forum_id ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> id is a negative number&nbsp;</div></li><li><div>          } elseif ( 0 &gt; $posted_forum_id ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID cannot be a negative number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> does not exist&nbsp;</div></li><li><div>          } elseif ( ! bbp_get_forum( $posted_forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum does not exist.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Use the POST'ed forum id</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $forum_id = $posted_forum_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span> exists&nbsp;</div></li><li><div>  if ( !empty( $forum_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> is a category&nbsp;</div></li><li><div>      if ( bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_new_reply_forum_category', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is a category. No replies can be created in this forum.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> is not a category&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is closed and user cannot access&nbsp;</div></li><li><div>          if ( bbp_is_forum_closed( $forum_id ) && !current_user_can( 'edit_forum', $forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_new_reply_forum_closed', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum has been closed to new replies.', 'bbpress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is private and user cannot access&nbsp;</div></li><li><div>          if ( bbp_is_forum_private( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_private_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_new_reply_forum_private', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is private and you do not have the capability to read or create new replies in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is hidden and user cannot access&nbsp;</div></li><li><div>          } elseif ( bbp_is_forum_hidden( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_hidden_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_new_reply_forum_hidden', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is hidden and you do not have the capability to read or create new replies in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Unfiltered HTML *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove kses filters from title and content for capable users and if the nonce is verified</span></span>&nbsp;</div></li><li><div>  if ( current_user_can( 'unfiltered_html' ) && !empty( $_POST['_bbp_unfiltered_html_reply'] ) && wp_create_nonce( 'bbp-unfiltered-html-reply_' . $topic_id ) === $_POST['_bbp_unfiltered_html_reply'] ) {&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_reply_pre_title', 'wp_filter_kses' );&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_reply_pre_content', 'bbp_encode_bad', 10 );&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_reply_pre_content', 'bbp_filter_kses', 30 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Title ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_title'] ) )&nbsp;</div></li><li><div>      $reply_title = esc_attr( strip_tags( $_POST['bbp_reply_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $reply_title = apply_filters( 'bbp_new_reply_pre_title', $reply_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Content *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_content'] ) )&nbsp;</div></li><li><div>      $reply_content = $_POST['bbp_reply_content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $reply_content = apply_filters( 'bbp_new_reply_pre_content', $reply_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No reply content</span></span>&nbsp;</div></li><li><div>  if ( empty( $reply_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_content', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your reply cannot be empty.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply Flooding ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_flood( $anonymous_data, $reply_author ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_flood', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Slow down; you move too fast.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply Duplicate *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_duplicate( array( 'post_type' =&gt; bbp_get_reply_post_type(), 'post_author' =&gt; $reply_author, 'post_content' =&gt; $reply_content, 'post_parent' =&gt; $topic_id, 'anonymous_data' =&gt; $anonymous_data ) ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_duplicate', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Duplicate reply detected; it looks as though you&#8217;ve already said that!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Blacklist *******************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_blacklist( $anonymous_data, $reply_author, $reply_title, $reply_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_blacklist', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your reply cannot be created at this time.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Status **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Maybe put into moderation</span></span>&nbsp;</div></li><li><div>  if ( !bbp_check_for_moderation( $anonymous_data, $reply_author, $reply_title, $reply_content ) ) {&nbsp;</div></li><li><div>      $reply_status = bbp_get_pending_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $reply_status = bbp_get_public_status_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply To **************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Handle Reply To of the reply; $_REQUEST for non-JS submissions</span></span>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['bbp_reply_to'] ) ) {&nbsp;</div></li><li><div>      $reply_to = bbp_validate_reply_to( $_REQUEST['bbp_reply_to'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Closed **********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If topic is closed, moderators can still reply</span>&nbsp;</div></li><li><div>  if ( bbp_is_topic_closed( $topic_id ) && ! current_user_can( 'moderate' ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_topic_closed', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic is closed.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Either replace terms</span></span>&nbsp;</div></li><li><div>  if ( bbp_allow_topic_tags() && current_user_can( 'assign_topic_tags' ) && ! empty( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>      $terms = esc_attr( strip_tags( $_POST['bbp_topic_tags'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// ...or remove them.</span></span>&nbsp;</div></li><li><div>  } elseif ( isset( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>      $terms = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Existing terms</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $terms = bbp_get_topic_tag_names( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Additional Actions (Before Save) **************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_new_reply_pre_extras', $topic_id, $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if errors</span></span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add the content of the form to $reply_data as an array</span></span>&nbsp;</div></li><li><div>  <span class="comment">// Just in time manipulation of reply data before being created</span>&nbsp;</div></li><li><div>  $reply_data = apply_filters( 'bbp_new_reply_pre_insert', array(&nbsp;</div></li><li><div>      'post_author' =&gt; $reply_author, &nbsp;</div></li><li><div>      'post_title' =&gt; $reply_title, &nbsp;</div></li><li><div>      'post_content' =&gt; $reply_content, &nbsp;</div></li><li><div>      'post_status' =&gt; $reply_status, &nbsp;</div></li><li><div>      'post_parent' =&gt; $topic_id, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'comment_status' =&gt; 'closed', &nbsp;</div></li><li><div>      'menu_order' =&gt; bbp_get_topic_reply_count( $topic_id, false ) + 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Insert reply</span></span>&nbsp;</div></li><li><div>  $reply_id = wp_insert_post( $reply_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for missing reply_id or error</span>&nbsp;</div></li><li><div>  if ( !empty( $reply_id ) && !is_wp_error( $reply_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Topic Tags ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Just in time manipulation of reply terms before being edited</span></span>&nbsp;</div></li><li><div>      $terms = apply_filters( 'bbp_new_reply_pre_set_terms', $terms, $topic_id, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Insert terms</span></span>&nbsp;</div></li><li><div>      $terms = wp_set_post_terms( $topic_id, $terms, bbp_get_topic_tag_tax_id(), false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Term error</span></span>&nbsp;</div></li><li><div>      if ( is_wp_error( $terms ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_reply_tags', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem adding the tags to the topic.', 'bbpress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Trash Check *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this reply starts as trash, add it to pre_trashed_replies</span>&nbsp;</div></li><li><div>      <span class="comment">// for the topic, so it is properly restored.</span>&nbsp;</div></li><li><div>      if ( bbp_is_topic_trash( $topic_id ) || ( $reply_data['post_status'] === bbp_get_trash_status_id() ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Trash the reply</span>&nbsp;</div></li><li><div>          wp_trash_post( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Only add to pre-trashed array if topic is trashed</span>&nbsp;</div></li><li><div>          if ( bbp_is_topic_trash( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get pre_trashed_replies for topic</span>&nbsp;</div></li><li><div>              $pre_trashed_replies = get_post_meta( $topic_id, '_bbp_pre_trashed_replies', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Add this reply to the end of the existing replies</span></span>&nbsp;</div></li><li><div>              $pre_trashed_replies[] = $reply_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update the pre_trashed_reply post meta</span>&nbsp;</div></li><li><div>              update_post_meta( $topic_id, '_bbp_pre_trashed_replies', $pre_trashed_replies );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Spam Check ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If reply or topic are spam, officially spam this reply</span>&nbsp;</div></li><li><div>      } elseif ( bbp_is_topic_spam( $topic_id ) || ( $reply_data['post_status'] === bbp_get_spam_status_id() ) ) {&nbsp;</div></li><li><div>          add_post_meta( $reply_id, '_bbp_spam_meta_status', bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Only add to pre-spammed array if topic is spam</span>&nbsp;</div></li><li><div>          if ( bbp_is_topic_spam( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get pre_spammed_replies for topic</span>&nbsp;</div></li><li><div>              $pre_spammed_replies = get_post_meta( $topic_id, '_bbp_pre_spammed_replies', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Add this reply to the end of the existing replies</span></span>&nbsp;</div></li><li><div>              $pre_spammed_replies[] = $reply_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update the pre_spammed_replies post meta</span>&nbsp;</div></li><li><div>              update_post_meta( $topic_id, '_bbp_pre_spammed_replies', $pre_spammed_replies );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Update counts, etc... *********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_new_reply', $reply_id, $topic_id, $forum_id, $anonymous_data, $reply_author, false, $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Additional Actions (After Save) ***********************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_new_reply_post_extras', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">/** Redirect **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Redirect to</span></span></span>&nbsp;</div></li><li><div>      $redirect_to = bbp_get_redirect_to();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the reply URL</span></span></span>&nbsp;</div></li><li><div>      $reply_url = bbp_get_reply_url( $reply_id, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Allow to be filtered</span></span>&nbsp;</div></li><li><div>      $reply_url = apply_filters( 'bbp_new_reply_redirect_to', $reply_url, $redirect_to, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Successful Save ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Redirect back to new reply</span></span>&nbsp;</div></li><li><div>      wp_safe_redirect( $reply_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Errors ****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $append_error = ( is_wp_error( $reply_id ) && $reply_id-&gt;get_error_message() ) ? $reply_id-&gt;get_error_message() . ' ' : '';&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_error', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found with your reply:' . $append_error . 'Please try again.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end edit reply submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply_anonymous() To check if the reply was by an anonymous user</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit that reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_filter_anonymous_post_data() To filter anonymous data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses remove_filter() To remove kses filters if needed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses esc_attr() For sanitization</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_edit_reply_pre_title' with the title and</span>&nbsp;</div></li><li><div><span class="comment"> *                       reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_edit_reply_pre_content' with the content</span>&nbsp;</div></li><li><div><span class="comment"> *                        reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_set_post_terms() To set the topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_has_errors() To get the {@link WP_Error} errors</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_save_post_revision() To save a reply revision</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_revision_log() To update the reply revision log</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_to() To get the reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_edit_reply' with the reply id, topic id, forum</span>&nbsp;</div></li><li><div><span class="comment"> *                    id, anonymous data, reply author, bool true (for edit), </span>&nbsp;</div></li><li><div><span class="comment"> *                    and the reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_url() To get the paginated url to the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the reply url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_message() To get the {@link WP_Error} error</span>&nbsp;</div></li><li><div><span class="comment"> *                                             message</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_edit_reply_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not bbp-edit-reply</span>&nbsp;</div></li><li><div>  if ( 'bbp-edit-reply' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Define local variable(s)</span></span>&nbsp;</div></li><li><div>  $revisions_removed = false;&nbsp;</div></li><li><div>  $reply = $reply_id = $reply_author = $topic_id = $forum_id = $anonymous_data = 0;&nbsp;</div></li><li><div>  $reply_title = $reply_content = $reply_edit_reason = $terms = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply id was not passed</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_reply_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_reply_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Reply ID not found.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply id was passed</span>&nbsp;</div></li><li><div>  } elseif ( is_numeric( $_POST['bbp_reply_id'] ) ) {&nbsp;</div></li><li><div>      $reply_id = (int) $_POST['bbp_reply_id'];&nbsp;</div></li><li><div>      $reply = bbp_get_reply( $reply_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Nonce check</span></span>&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-edit-reply_' . $reply_id ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_reply_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply does not exist</span>&nbsp;</div></li><li><div>  if ( empty( $reply ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_reply_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The reply you want to edit was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Reply exists</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check users ability to create new reply</span>&nbsp;</div></li><li><div>      if ( ! bbp_is_reply_anonymous( $reply_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// User cannot edit this reply</span>&nbsp;</div></li><li><div>          if ( !current_user_can( 'edit_reply', $reply_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_edit_reply_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have permission to edit that reply.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set reply author</span>&nbsp;</div></li><li><div>          $reply_author = bbp_get_reply_author_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// It is an anonymous post</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Filter anonymous data</span></span>&nbsp;</div></li><li><div>          $anonymous_data = bbp_filter_anonymous_post_data();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove kses filters from title and content for capable users and if the nonce is verified</span></span>&nbsp;</div></li><li><div>  if ( current_user_can( 'unfiltered_html' ) && !empty( $_POST['_bbp_unfiltered_html_reply'] ) && wp_create_nonce( 'bbp-unfiltered-html-reply_' . $reply_id ) === $_POST['_bbp_unfiltered_html_reply'] ) {&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_reply_pre_title', 'wp_filter_kses' );&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_reply_pre_content', 'bbp_encode_bad', 10 );&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_reply_pre_content', 'bbp_filter_kses', 30 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply Topic ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $topic_id = bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Forum ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span> exists&nbsp;</div></li><li><div>  if ( !empty( $forum_id ) && ( $forum_id !== bbp_get_reply_forum_id( $reply_id ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> is a category&nbsp;</div></li><li><div>      if ( bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_edit_reply_forum_category', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is a category. No replies can be created in this forum.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum</span> is not a category&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is closed and user cannot access&nbsp;</div></li><li><div>          if ( bbp_is_forum_closed( $forum_id ) && !current_user_can( 'edit_forum', $forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_edit_reply_forum_closed', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum has been closed to new replies.', 'bbpress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is private and user cannot access&nbsp;</div></li><li><div>          if ( bbp_is_forum_private( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_private_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_edit_reply_forum_private', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is private and you do not have the capability to read or create new replies in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> is hidden and user cannot access&nbsp;</div></li><li><div>          } elseif ( bbp_is_forum_hidden( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_hidden_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_edit_reply_forum_hidden', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is hidden and you do not have the capability to read or create new replies in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Title ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_title'] ) )&nbsp;</div></li><li><div>      $reply_title = esc_attr( strip_tags( $_POST['bbp_reply_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $reply_title = apply_filters( 'bbp_edit_reply_pre_title', $reply_title, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Content *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_content'] ) )&nbsp;</div></li><li><div>      $reply_content = $_POST['bbp_reply_content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $reply_content = apply_filters( 'bbp_edit_reply_pre_content', $reply_content, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No reply content</span></span>&nbsp;</div></li><li><div>  if ( empty( $reply_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_reply_content', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your reply cannot be empty.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Blacklist *******************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_blacklist( $anonymous_data, $reply_author, $reply_title, $reply_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_blacklist', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your reply cannot be edited at this time.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply Status **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Maybe put into moderation</span></span>&nbsp;</div></li><li><div>  if ( !bbp_check_for_moderation( $anonymous_data, $reply_author, $reply_title, $reply_content ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set post status to pending if public</span>&nbsp;</div></li><li><div>      if ( bbp_get_public_status_id() === $reply-&gt;post_status ) {&nbsp;</div></li><li><div>          $reply_status = bbp_get_pending_status_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use existing post_status</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $reply_status = $reply-&gt;post_status;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Reply To **************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Handle Reply To of the reply; $_REQUEST for non-JS submissions</span></span>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['bbp_reply_to'] ) ) {&nbsp;</div></li><li><div>      $reply_to = bbp_validate_reply_to( $_REQUEST['bbp_reply_to'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Either replace terms</span></span>&nbsp;</div></li><li><div>  if ( bbp_allow_topic_tags() && current_user_can( 'assign_topic_tags' ) && ! empty( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>      $terms = esc_attr( strip_tags( $_POST['bbp_topic_tags'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// ...or remove them.</span></span>&nbsp;</div></li><li><div>  } elseif ( isset( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>      $terms = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Existing terms</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $terms = bbp_get_topic_tag_names( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Additional Actions (Before Save) **************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_edit_reply_pre_extras', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if errors</span></span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add the content of the form to $reply_data as an array</span></span>&nbsp;</div></li><li><div>  <span class="comment">// Just in time manipulation of reply data before being edited</span>&nbsp;</div></li><li><div>  $reply_data = apply_filters( 'bbp_edit_reply_pre_insert', array(&nbsp;</div></li><li><div>      'ID' =&gt; $reply_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $reply_title, &nbsp;</div></li><li><div>      'post_content' =&gt; $reply_content, &nbsp;</div></li><li><div>      'post_status' =&gt; $reply_status, &nbsp;</div></li><li><div>      'post_parent' =&gt; $topic_id, &nbsp;</div></li><li><div>      'post_author' =&gt; $reply_author, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type()&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Toggle revisions to avoid duplicates</span>&nbsp;</div></li><li><div>  if ( post_type_supports( bbp_get_reply_post_type(), 'revisions' ) ) {&nbsp;</div></li><li><div>      $revisions_removed = true;&nbsp;</div></li><li><div>      remove_post_type_support( bbp_get_reply_post_type(), 'revisions' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Insert topic</span>&nbsp;</div></li><li><div>  $reply_id = wp_update_post( $reply_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Toggle revisions back on</span>&nbsp;</div></li><li><div>  if ( true === $revisions_removed ) {&nbsp;</div></li><li><div>      $revisions_removed = false;&nbsp;</div></li><li><div>      add_post_type_support( bbp_get_reply_post_type(), 'revisions' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Just in time manipulation of reply terms before being edited</span></span>&nbsp;</div></li><li><div>  $terms = apply_filters( 'bbp_edit_reply_pre_set_terms', $terms, $topic_id, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Insert terms</span></span>&nbsp;</div></li><li><div>  $terms = wp_set_post_terms( $topic_id, $terms, bbp_get_topic_tag_tax_id(), false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Term error</span></span>&nbsp;</div></li><li><div>  if ( is_wp_error( $terms ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_tags', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem adding the tags to the topic.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Revisions *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Revision Reason</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_edit_reason'] ) )&nbsp;</div></li><li><div>      $reply_edit_reason = esc_attr( strip_tags( $_POST['bbp_reply_edit_reason'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update revision log</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_log_reply_edit'] ) && ( &quot;1&quot; === $_POST['bbp_log_reply_edit'] ) ) {&nbsp;</div></li><li><div>      $revision_id = wp_save_post_revision( $reply_id );&nbsp;</div></li><li><div>      if ( !empty( $revision_id ) ) {&nbsp;</div></li><li><div>          bbp_update_reply_revision_log( array(&nbsp;</div></li><li><div>              'reply_id' =&gt; $reply_id, &nbsp;</div></li><li><div>              'revision_id' =&gt; $revision_id, &nbsp;</div></li><li><div>              'author_id' =&gt; bbp_get_current_user_id(), &nbsp;</div></li><li><div>              'reason' =&gt; $reply_edit_reason&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $reply_id ) && !is_wp_error( $reply_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span>&nbsp;</div></li><li><div>      do_action( 'bbp_edit_reply', $reply_id, $topic_id, $forum_id, $anonymous_data, $reply_author , true, $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Additional Actions (After Save) ***********************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_edit_reply_post_extras', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">/** Redirect **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Redirect to</span></span></span>&nbsp;</div></li><li><div>      $redirect_to = bbp_get_redirect_to();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the reply URL</span></span></span>&nbsp;</div></li><li><div>      $reply_url = bbp_get_reply_url( $reply_id, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Allow to be filtered</span></span>&nbsp;</div></li><li><div>      $reply_url = apply_filters( 'bbp_edit_reply_redirect_to', $reply_url, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Successful Edit ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Redirect back to new reply</span></span>&nbsp;</div></li><li><div>      wp_safe_redirect( $reply_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Errors ****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $append_error = ( is_wp_error( $reply_id ) && $reply_id-&gt;get_error_message() ) ? $reply_id-&gt;get_error_message() . ' ' : '';&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_reply_error', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found with your reply:' . $append_error . 'Please try again.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle all the extra meta stuff from posting a new reply or editing a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool|array $anonymous_data Optional logged-out user data.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $author_id Author id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $is_edit Optional. Is the post being edited? Defaults to false.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_to Optional. Reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To get the forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_current_user_id() To get the current user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the reply metas</span>&nbsp;</div></li><li><div><span class="comment"> * @uses set_transient() To update the flood check transient for the ip</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_user_last_posted() To update the users last posted time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_subscriptions_active() To check if the subscriptions feature is</span>&nbsp;</div></li><li><div><span class="comment"> *                                      activated or not</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_user_subscribed() To check if the user is subscribed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_subscription() To remove the user's subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_subscription() To add the user's subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_forum_id() To update the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_topic_id() To update the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_to() To update the reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_walker() To update the reply's ancestors' counts</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply( $reply_id = 0, $topic_id = 0, $forum_id = 0, $anonymous_data = false, $author_id = 0, $is_edit = false, $reply_to = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate the ID's passed from 'bbp_new_reply' action</span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $forum_id = bbp_get_forum_id( $forum_id );&nbsp;</div></li><li><div>  $reply_to = bbp_validate_reply_to( $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if there is no reply</span>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check author_id</span>&nbsp;</div></li><li><div>  if ( empty( $author_id ) )&nbsp;</div></li><li><div>      $author_id = bbp_get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check topic_id</span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) )&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check forum_id</span>&nbsp;</div></li><li><div>  if ( !empty( $topic_id ) && empty( $forum_id ) )&nbsp;</div></li><li><div>      $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If anonymous post, store name, email, website and ip in post_meta.</span>&nbsp;</div></li><li><div>  <span class="comment">// It expects anonymous_data to be sanitized.</span>&nbsp;</div></li><li><div>  <span class="comment">// Check bbp_filter_anonymous_post_data() for sanitization.</span>&nbsp;</div></li><li><div>  if ( !empty( $anonymous_data ) && is_array( $anonymous_data ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Parse arguments against default values</span></span>&nbsp;</div></li><li><div>      $r = bbp_parse_args( $anonymous_data, array(&nbsp;</div></li><li><div>          'bbp_anonymous_name' =&gt; '', &nbsp;</div></li><li><div>          'bbp_anonymous_email' =&gt; '', &nbsp;</div></li><li><div>          'bbp_anonymous_website' =&gt; '', &nbsp;</div></li><li><div> ), 'update_reply' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update all anonymous metas</span>&nbsp;</div></li><li><div>      foreach ( $r as $anon_key =&gt; $anon_value ) {&nbsp;</div></li><li><div>          update_post_meta( $reply_id, '_' . $anon_key, (string) $anon_value, false );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set transient for throttle check (only on new, not edit)</span>&nbsp;</div></li><li><div>      if ( empty( $is_edit ) ) {&nbsp;</div></li><li><div>          set_transient( '_bbp_' . bbp_current_author_ip() . '_last_posted', time() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( empty( $is_edit ) && !current_user_can( 'throttle' ) ) {&nbsp;</div></li><li><div>          bbp_update_user_last_posted( $author_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle Subscription Checkbox</span>&nbsp;</div></li><li><div>  if ( bbp_is_subscriptions_active() && !empty( $author_id ) && !empty( $topic_id ) ) {&nbsp;</div></li><li><div>      $subscribed = bbp_is_user_subscribed( $author_id, $topic_id );&nbsp;</div></li><li><div>      $subscheck = ( !empty( $_POST['bbp_topic_subscription'] ) && ( 'bbp_subscribe' === $_POST['bbp_topic_subscription'] ) ) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Subscribed and unsubscribing</span>&nbsp;</div></li><li><div>      if ( true === $subscribed && false === $subscheck ) {&nbsp;</div></li><li><div>          bbp_remove_user_subscription( $author_id, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Subscribing</span>&nbsp;</div></li><li><div>      } elseif ( false === $subscribed && true === $subscheck ) {&nbsp;</div></li><li><div>          bbp_add_user_subscription( $author_id, $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply meta relating to reply position in tree</span>&nbsp;</div></li><li><div>  bbp_update_reply_forum_id( $reply_id, $forum_id );&nbsp;</div></li><li><div>  bbp_update_reply_topic_id( $reply_id, $topic_id );&nbsp;</div></li><li><div>  bbp_update_reply_to      ( $reply_id, $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update associated topic values if this is a new reply</span>&nbsp;</div></li><li><div>  if ( empty( $is_edit ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update poster IP if not editing</span>&nbsp;</div></li><li><div>      update_post_meta( $reply_id, '_bbp_author_ip', bbp_current_author_ip(), false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Last active time</span>&nbsp;</div></li><li><div>      $last_active_time = current_time( 'mysql' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Walk up ancestors</span> and do the dirty work</span>&nbsp;</div></li><li><div>      bbp_update_reply_walker( $reply_id, $last_active_time, $forum_id, $topic_id, false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Walk up the ancestor tree from the current reply, and update all the counts</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2884)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $last_active_time Optional. Last active time</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $refresh If set to true, unsets all the previous parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *                       Defaults to true</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_forum_id() To get the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_ancestors() To get the ancestors of the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the ancestor is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the ancestor is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_reply_id() To update the topic last reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_id() To update the topic last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_last_active_id() To get the topic last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_field() To get the post date of the last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_time() To update the last active topic meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_voice_count() To update the topic voice count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count() To update the topic reply count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count_hidden() To update the topic hidden reply</span>&nbsp;</div></li><li><div><span class="comment"> *                                              count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum() To check if the ancestor is a forum</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_last_topic_id() To update the last topic id forum meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_last_reply_id() To update the last reply id forum meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_last_active_id() To update the forum last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_last_active_id() To get the forum last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_last_active_time() To update the forum last active time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_reply_count() To update the forum reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_walker( $reply_id, $last_active_time = '', $forum_id = 0, $topic_id = 0, $refresh = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify the reply ID</span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply was passed</span>&nbsp;</div></li><li><div>  if ( !empty( $reply_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the topic ID if none was passed</span>&nbsp;</div></li><li><div>      if ( empty( $topic_id ) ) {&nbsp;</div></li><li><div>          $topic_id = bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the forum ID if none was passed</span>&nbsp;</div></li><li><div>      if ( empty( $forum_id ) ) {&nbsp;</div></li><li><div>          $forum_id = bbp_get_reply_forum_id( $reply_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the active_id based on topic_id/reply_id</span>&nbsp;</div></li><li><div>  $active_id = empty( $reply_id ) ? $topic_id : $reply_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup ancestors array to walk up</span>&nbsp;</div></li><li><div>  $ancestors = array_values( array_unique( array_merge( array( $topic_id, $forum_id ), (array) get_post_ancestors( $topic_id ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we want a full refresh, unset any of the possibly passed variables</span>&nbsp;</div></li><li><div>  if ( true === $refresh )&nbsp;</div></li><li><div>      $forum_id = $topic_id = $reply_id = $active_id = $last_active_time = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Walk up ancestors</span>&nbsp;</div></li><li><div>  if ( !empty( $ancestors ) ) {&nbsp;</div></li><li><div>      foreach ( $ancestors as $ancestor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Reply meta relating to most recent reply</span>&nbsp;</div></li><li><div>          if ( bbp_is_reply( $ancestor ) ) {&nbsp;</div></li><li><div>              <span class="comment">// @todo - hierarchical replies</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Topic meta relating to most recent reply</span>&nbsp;</div></li><li><div>          } elseif ( bbp_is_topic( $ancestor ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Last reply and active ID's</span>&nbsp;</div></li><li><div>              bbp_update_topic_last_reply_id ( $ancestor, $reply_id );&nbsp;</div></li><li><div>              bbp_update_topic_last_active_id( $ancestor, $active_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get the last active time if none was passed</span></span>&nbsp;</div></li><li><div>              $topic_last_active_time = $last_active_time;&nbsp;</div></li><li><div>              if ( empty( $last_active_time ) ) {&nbsp;</div></li><li><div>                  $topic_last_active_time = get_post_field( 'post_date', bbp_get_topic_last_active_id( $ancestor ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Only update if reply is published</span></span>&nbsp;</div></li><li><div>              if ( bbp_is_reply_published( $reply_id ) ) {&nbsp;</div></li><li><div>                  bbp_update_topic_last_active_time( $ancestor, $topic_last_active_time );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Counts</span></span>&nbsp;</div></li><li><div>              bbp_update_topic_voice_count       ( $ancestor );&nbsp;</div></li><li><div>              bbp_update_topic_reply_count       ( $ancestor );&nbsp;</div></li><li><div>              bbp_update_topic_reply_count_hidden( $ancestor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum</span> meta relating to most recent topic&nbsp;</div></li><li><div>          } elseif ( bbp_is_forum( $ancestor ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Last topic and reply ID's</span>&nbsp;</div></li><li><div>              bbp_update_forum_last_topic_id( $ancestor, $topic_id );&nbsp;</div></li><li><div>              bbp_update_forum_last_reply_id( $ancestor, $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Last Active</span>&nbsp;</div></li><li><div>              bbp_update_forum_last_active_id( $ancestor, $active_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get the last active time if none was passed</span></span>&nbsp;</div></li><li><div>              $forum_last_active_time = $last_active_time;&nbsp;</div></li><li><div>              if ( empty( $last_active_time ) ) {&nbsp;</div></li><li><div>                  $forum_last_active_time = get_post_field( 'post_date', bbp_get_forum_last_active_id( $ancestor ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Only update if reply is published</span></span>&nbsp;</div></li><li><div>              if ( bbp_is_reply_published( $reply_id ) ) {&nbsp;</div></li><li><div>                  bbp_update_forum_last_active_time( $ancestor, $forum_last_active_time );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Counts</span></span>&nbsp;</div></li><li><div>              bbp_update_forum_reply_count( $ancestor );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Reply Updaters ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the reply with its forum id it is in</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2855)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To get the forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_ancestors() To get the reply's forum</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_field() To get the post type of the post</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the reply forum id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_reply_forum_id' with the forum id</span>&nbsp;</div></li><li><div><span class="comment"> *                        and reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Reply's forum id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_forum_id( $reply_id = 0, $forum_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Validation</span></span></span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $forum_id = bbp_get_forum_id( $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no forum_id was passed, walk up ancestors and look for forum type</span>&nbsp;</div></li><li><div>  if ( empty( $forum_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get ancestors</span></span>&nbsp;</div></li><li><div>      $ancestors = (array) get_post_ancestors( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through ancestors</span></span>&nbsp;</div></li><li><div>      if ( !empty( $ancestors ) ) {&nbsp;</div></li><li><div>          foreach ( $ancestors as $ancestor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get first parent that is a forum</span></span>&nbsp;</div></li><li><div>              if ( get_post_field( 'post_type', $ancestor ) === bbp_get_forum_post_type() ) {&nbsp;</div></li><li><div>                  $forum_id = $ancestor;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Found a forum, so exit the loop and continue</span></span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the forum ID</span>&nbsp;</div></li><li><div>  bbp_update_forum_id( $reply_id, $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_reply_forum_id', (int) $forum_id, $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the reply with its topic id it is in</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2855)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_ancestors() To get the reply's topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_field() To get the post type of the post</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the reply topic id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_reply_topic_id' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> *                        and reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Reply's topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_topic_id( $reply_id = 0, $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Validation</span></span></span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no topic_id was passed, walk up ancestors and look for topic type</span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get ancestors</span></span>&nbsp;</div></li><li><div>      $ancestors = (array) get_post_ancestors( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through ancestors</span></span>&nbsp;</div></li><li><div>      if ( !empty( $ancestors ) ) {&nbsp;</div></li><li><div>          foreach ( $ancestors as $ancestor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get first parent that is a forum</span></span>&nbsp;</div></li><li><div>              if ( get_post_field( 'post_type', $ancestor ) === bbp_get_topic_post_type() ) {&nbsp;</div></li><li><div>                  $topic_id = $ancestor;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Found a forum, so exit the loop and continue</span></span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the topic</span></span> ID&nbsp;</div></li><li><div>  bbp_update_topic_id( $reply_id, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_reply_topic_id', (int) $topic_id, $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the reply's meta data with its reply to id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4944)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Reply id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_to Optional. Reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the reply to meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_reply_to' with the reply id and</span>&nbsp;</div></li><li><div><span class="comment"> *                        and reply to id</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Reply's parent reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_to( $reply_id = 0, $reply_to = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Validation</span></span></span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $reply_to = bbp_validate_reply_to( $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update or delete the `reply_to` postmeta</span>&nbsp;</div></li><li><div>  if ( ! empty( $reply_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update the reply</span></span></span> to</span>&nbsp;</div></li><li><div>      if ( !empty( $reply_to ) ) {&nbsp;</div></li><li><div>          update_post_meta( $reply_id, '_bbp_reply_to', $reply_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete the reply to</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          delete_post_meta( $reply_id, '_bbp_reply_to' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_update_reply_to', (int) $reply_to, $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the revision log of the reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2782)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $args Supports these args:</span>&nbsp;</div></li><li><div><span class="comment"> *  - reply_id: reply id</span>&nbsp;</div></li><li><div><span class="comment"> *  - author_id: Author id</span>&nbsp;</div></li><li><div><span class="comment"> *  - reason: Reason for editing</span>&nbsp;</div></li><li><div><span class="comment"> *  - revision_id: Revision id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_format_revision_reason() To format the reason</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_raw_revision_log() To get the raw reply revision log</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the reply revision log meta</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False on failure, true on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_revision_log( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Parse arguments against default values</span></span>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $args, array(&nbsp;</div></li><li><div>      'reason' =&gt; '', &nbsp;</div></li><li><div>      'reply_id' =&gt; 0, &nbsp;</div></li><li><div>      'author_id' =&gt; 0, &nbsp;</div></li><li><div>      'revision_id' =&gt; 0&nbsp;</div></li><li><div> ), 'update_reply_revision_log' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Populate the variables</span>&nbsp;</div></li><li><div>  $r['reason'] = bbp_format_revision_reason( $r['reason'] );&nbsp;</div></li><li><div>  $r['reply_id'] = bbp_get_reply_id( $r['reply_id'] );&nbsp;</div></li><li><div>  $r['author_id'] = bbp_get_user_id ( $r['author_id'], false, true );&nbsp;</div></li><li><div>  $r['revision_id'] = (int) $r['revision_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the logs and append the new one to those</span>&nbsp;</div></li><li><div>  $revision_log = bbp_get_reply_raw_revision_log( $r['reply_id'] );&nbsp;</div></li><li><div>  $revision_log[ $r['revision_id'] ] = array( 'author' =&gt; $r['author_id'], 'reason' =&gt; $r['reason'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally, update</span>&nbsp;</div></li><li><div>  update_post_meta( $r['reply_id'], '_bbp_revision_log', $revision_log );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_reply_revision_log', $revision_log, $r['reply_id'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Move reply handler</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end move reply submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4521)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit the reply and topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_pre_move_reply' with the from reply id, source</span>&nbsp;</div></li><li><div><span class="comment"> *                    and destination topic ids</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare our sql query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_results() To execute the sql query and get results</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_topic_id() To update the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_forum_id() To update the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_split_topic_reply' with the reply id and</span>&nbsp;</div></li><li><div><span class="comment"> *                    destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_reply_id() To update the topic last reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_time() To update the topic last active meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_post_split_topic' with the destination and</span>&nbsp;</div></li><li><div><span class="comment"> *                    source topic ids and source topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic permalink</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic link</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_move_reply_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not 'bbp-move-reply'</span>&nbsp;</div></li><li><div>  if ( 'bbp-move-reply' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prevent debug notices</span>&nbsp;</div></li><li><div>  $move_reply_id = $destination_topic_id = 0;&nbsp;</div></li><li><div>  $destination_topic_title = '';&nbsp;</div></li><li><div>  $destination_topic = $move_reply = $source_topic = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Move Reply ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_reply_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_move_reply_reply_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Reply ID to move not found!', 'bbpress' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $move_reply_id = (int) $_POST['bbp_reply_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $move_reply = bbp_get_reply( $move_reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Reply exists</span></span>&nbsp;</div></li><li><div>  if ( empty( $move_reply ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_mover_reply_r_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The reply you want to move was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic to Move From ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the reply's current topic</span>&nbsp;</div></li><li><div>  $source_topic = bbp_get_topic( $move_reply-&gt;post_parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No topic</span>&nbsp;</div></li><li><div>  if ( empty( $source_topic ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_move_reply_source_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to move from was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Nonce check</span></span> failed&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-move-reply_' . $move_reply-&gt;ID ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_move_reply_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use cannot edit topic</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', $source_topic-&gt;ID ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_move_reply_source_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the source topic.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// How to move</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_reply_move_option'] ) ) {&nbsp;</div></li><li><div>      $move_option = (string) trim( $_POST['bbp_reply_move_option'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Invalid move option</span>&nbsp;</div></li><li><div>  if ( empty( $move_option ) || !in_array( $move_option, array( 'existing', 'topic' ) ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_move_reply_option', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You need to choose a valid move option.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Valid move option</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// What kind of move</span>&nbsp;</div></li><li><div>      switch ( $move_option ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Into an existing topic</span>&nbsp;</div></li><li><div>          case 'existing' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get destination topic id</span>&nbsp;</div></li><li><div>              if ( empty( $_POST['bbp_destination_topic'] ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_move_reply_destination_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Destination topic ID not found!', 'bbpress' ) );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $destination_topic_id = (int) $_POST['bbp_destination_topic'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the destination topic</span>&nbsp;</div></li><li><div>              $destination_topic = bbp_get_topic( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// No destination topic</span>&nbsp;</div></li><li><div>              if ( empty( $destination_topic ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_move_reply_destination_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to move to was not found!', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User cannot edit the destination topic</span>&nbsp;</div></li><li><div>              if ( !current_user_can( 'edit_topic', $destination_topic-&gt;ID ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_move_reply_destination_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the destination topic!', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Bump the reply position</span>&nbsp;</div></li><li><div>              $reply_position = bbp_get_topic_reply_count( $destination_topic-&gt;ID ) + 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Update the reply</span></span></span>&nbsp;</div></li><li><div>              wp_update_post( array(&nbsp;</div></li><li><div>                  'ID' =&gt; $move_reply-&gt;ID, &nbsp;</div></li><li><div>                  'post_title' =&gt; sprintf( __( 'Reply To: %s', 'bbpress' ), $destination_topic-&gt;post_title ), &nbsp;</div></li><li><div>                  'post_name' =&gt; false, <span class="comment">// will be automatically generated</span>&nbsp;</div></li><li><div>                  'post_parent' =&gt; $destination_topic-&gt;ID, &nbsp;</div></li><li><div>                  'menu_order' =&gt; $reply_position, &nbsp;</div></li><li><div>                  'guid' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Adjust reply meta values</span>&nbsp;</div></li><li><div>              bbp_update_reply_topic_id( $move_reply-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>              bbp_update_reply_forum_id( $move_reply-&gt;ID, bbp_get_topic_forum_id( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Move reply to a new topic</span>&nbsp;</div></li><li><div>          case 'topic' :&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User needs to be able to publish topics</span>&nbsp;</div></li><li><div>              if ( current_user_can( 'publish_topics' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Use the new title that was passed</span>&nbsp;</div></li><li><div>                  if ( !empty( $_POST['bbp_reply_move_destination_title'] ) ) {&nbsp;</div></li><li><div>                      $destination_topic_title = esc_attr( strip_tags( $_POST['bbp_reply_move_destination_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Use the source topic title</span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $destination_topic_title = $source_topic-&gt;post_title;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Update the topic</span></span>&nbsp;</div></li><li><div>                  $destination_topic_id = wp_update_post( array(&nbsp;</div></li><li><div>                      'ID' =&gt; $move_reply-&gt;ID, &nbsp;</div></li><li><div>                      'post_title' =&gt; $destination_topic_title, &nbsp;</div></li><li><div>                      'post_name' =&gt; false, &nbsp;</div></li><li><div>                      'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>                      'post_parent' =&gt; $source_topic-&gt;post_parent, &nbsp;</div></li><li><div>                      'guid' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                  $destination_topic = bbp_get_topic( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Make sure the new topic knows its a topic</span>&nbsp;</div></li><li><div>                  bbp_update_topic_topic_id( $move_reply-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Shouldn't happen</span>&nbsp;</div></li><li><div>                  if ( false === $destination_topic_id || is_wp_error( $destination_topic_id ) || empty( $destination_topic ) ) {&nbsp;</div></li><li><div>                      bbp_add_error( 'bbp_move_reply_destination_reply', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem converting the reply into the topic. Please try again.', 'bbpress' ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User cannot publish posts</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_move_reply_destination_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to create new topics. The reply could not be converted into a topic.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if there are errors</span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** No Errors - Clean Up **************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span>&nbsp;</div></li><li><div>  do_action( 'bbp_pre_move_reply', $move_reply-&gt;ID, $source_topic-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Date Check ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the destination topic is older than the move reply</span>&nbsp;</div></li><li><div>  if ( strtotime( $move_reply-&gt;post_date ) &lt; strtotime( $destination_topic-&gt;post_date ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set destination topic post_date to 1 second before from reply</span>&nbsp;</div></li><li><div>      $destination_post_date = date( 'Y-m-d H:i:s', strtotime( $move_reply-&gt;post_date ) - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update destination topic</span>&nbsp;</div></li><li><div>      wp_update_post( array(&nbsp;</div></li><li><div>          'ID' =&gt; $destination_topic_id, &nbsp;</div></li><li><div>          'post_date' =&gt; $destination_post_date, &nbsp;</div></li><li><div>          'post_date_gmt' =&gt; get_gmt_from_date( $destination_post_date )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the last reply ID and freshness to the move_reply</span>&nbsp;</div></li><li><div>  $last_reply_id = $move_reply-&gt;ID;&nbsp;</div></li><li><div>  $freshness = $move_reply-&gt;post_date;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the reply to</span>&nbsp;</div></li><li><div>  $parent = bbp_get_reply_to( $move_reply-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fix orphaned children</span>&nbsp;</div></li><li><div>  $children = get_posts( array(&nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'meta_key' =&gt; '_bbp_reply_to', &nbsp;</div></li><li><div>      'meta_value' =&gt; $move_reply-&gt;ID, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  foreach ( $children as $child )&nbsp;</div></li><li><div>      bbp_update_reply_to( $child-&gt;ID, $parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove reply_to from moved reply</span>&nbsp;</div></li><li><div>  delete_post_meta( $move_reply-&gt;ID, '_bbp_reply_to' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It is a new topic and we need to set some default metas to make</span>&nbsp;</div></li><li><div>  <span class="comment">// the topic display in bbp_has_topics() list</span>&nbsp;</div></li><li><div>  if ( 'topic' === $move_option ) {&nbsp;</div></li><li><div>      bbp_update_topic_last_reply_id   ( $destination_topic-&gt;ID, $last_reply_id );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_id  ( $destination_topic-&gt;ID, $last_reply_id );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_time( $destination_topic-&gt;ID, $freshness );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Otherwise update the existing destination topic</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bbp_update_topic_last_reply_id   ( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_id  ( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_time( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update source topic ID last active</span>&nbsp;</div></li><li><div>  bbp_update_topic_last_reply_id   ( $source_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_id  ( $source_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_time( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Successful Move ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span>&nbsp;</div></li><li><div>  do_action( 'bbp_post_move_reply', $move_reply-&gt;ID, $source_topic-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Redirect back to the topic</span>&nbsp;</div></li><li><div>  wp_safe_redirect( bbp_get_topic_permalink( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fix counts on reply move</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When a reply is moved, update the counts of source and destination topic</span>&nbsp;</div></li><li><div><span class="comment"> * and their forums.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4521)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $move_reply_id Move reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $source_topic_id Source topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $destination_topic_id Destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_topic_count() To update the forum topic counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_reply_count() To update the forum reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count() To update the topic reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_voice_count() To update the topic voice counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count_hidden() To update the topic hidden reply</span>&nbsp;</div></li><li><div><span class="comment"> *                                              count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_move_reply_count' with the move reply id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    source topic id & destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_move_reply_count( $move_reply_id, $source_topic_id, $destination_topic_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span> topic counts&nbsp;</div></li><li><div>  bbp_update_forum_topic_count( bbp_get_topic_forum_id( $destination_topic_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum</span> reply counts&nbsp;</div></li><li><div>  bbp_update_forum_reply_count( bbp_get_topic_forum_id( $destination_topic_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic reply counts</span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_reply_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic hidden reply counts</span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count_hidden( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_reply_count_hidden( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic voice counts</span>&nbsp;</div></li><li><div>  bbp_update_topic_voice_count( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_voice_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_move_reply_count', $move_reply_id, $source_topic_id, $destination_topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">/** Reply Actions *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end spamming/unspamming and trashing/untrashing/deleting of</span>&nbsp;</div></li><li><div><span class="comment"> * replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the user is capable of editing or</span>&nbsp;</div></li><li><div><span class="comment"> *                           deleting the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_ajax_referer() To verify the nonce and check the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply_spam() To check if the reply is marked as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_spam_reply() To make the reply as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unspam_reply() To unmark the reply as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_trash_post() To trash the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_untrash_post() To untrash the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_delete_post() To delete the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_toggle_reply_handler' with success, post data</span>&nbsp;</div></li><li><div><span class="comment"> *                    and action</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_url() To get the reply url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors:add() To log the error messages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_toggle_reply_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if required GET actions aren't passed</span>&nbsp;</div></li><li><div>  if ( empty( $_GET['reply_id'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup possible get actions</span>&nbsp;</div></li><li><div>  $possible_actions = array(&nbsp;</div></li><li><div>      'bbp_toggle_reply_spam', &nbsp;</div></li><li><div>      'bbp_toggle_reply_trash'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if actions aren't meant for this function</span>&nbsp;</div></li><li><div>  if ( !in_array( $action, $possible_actions ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $failure = '';                         <span class="comment">// Empty failure string</span>&nbsp;</div></li><li><div>  $view_all = false;                      <span class="comment">// Assume not viewing all</span>&nbsp;</div></li><li><div>  $reply_id = (int) $_GET['reply_id'];    <span class="comment">// What's the reply id?</span>&nbsp;</div></li><li><div>  $success = false;                      <span class="comment">// Flag</span>&nbsp;</div></li><li><div>  $post_data = array( 'ID' =&gt; $reply_id ); <span class="comment">// Prelim array</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure reply exists</span>&nbsp;</div></li><li><div>  $reply = bbp_get_reply( $reply_id );&nbsp;</div></li><li><div>  if ( empty( $reply ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// What is the user doing here?</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_reply', $reply-&gt;ID ) || ( 'bbp_toggle_reply_trash' === $action && !current_user_can( 'delete_reply', $reply-&gt;ID ) ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_toggle_reply_permission', __( '&lt;strong&gt;ERROR:&lt;/strong&gt; You do not have the permission to do that!', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// What action are we trying to perform?</span>&nbsp;</div></li><li><div>  switch ( $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle spam</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_reply_spam' :&nbsp;</div></li><li><div>          check_ajax_referer( 'spam-reply_' . $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_spam = bbp_is_reply_spam( $reply_id );&nbsp;</div></li><li><div>          $success = $is_spam ? bbp_unspam_reply( $reply_id ) : bbp_spam_reply( $reply_id );&nbsp;</div></li><li><div>          $failure = $is_spam ? __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem unmarking the reply as spam!', 'bbpress' ) : __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem marking the reply as spam!', 'bbpress' );&nbsp;</div></li><li><div>          $view_all = !$is_spam;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle trash</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_reply_trash' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sub_action = in_array( $_GET['sub_action'], array( 'trash', 'untrash', 'delete' ) ) ? $_GET['sub_action'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $sub_action ) )&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $sub_action ) {&nbsp;</div></li><li><div>              case 'trash':&nbsp;</div></li><li><div>                  check_ajax_referer( 'trash-' . bbp_get_reply_post_type() . '_' . $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $view_all = true;&nbsp;</div></li><li><div>                  $success = wp_trash_post( $reply_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem trashing the reply!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'untrash':&nbsp;</div></li><li><div>                  check_ajax_referer( 'untrash-' . bbp_get_reply_post_type() . '_' . $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $success = wp_untrash_post( $reply_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem untrashing the reply!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'delete':&nbsp;</div></li><li><div>                  check_ajax_referer( 'delete-' . bbp_get_reply_post_type() . '_' . $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $success = wp_delete_post( $reply_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem deleting the reply!', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do additional reply toggle actions</span>&nbsp;</div></li><li><div>  do_action( 'bbp_toggle_reply_handler', $success, $post_data, $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No errors</span>&nbsp;</div></li><li><div>  if ( ( false !== $success ) && !is_wp_error( $success ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">/** Redirect **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Redirect to</span></span></span>&nbsp;</div></li><li><div>      $redirect_to = bbp_get_redirect_to();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the reply URL</span></span></span>&nbsp;</div></li><li><div>      $reply_url = bbp_get_reply_url( $reply_id, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add view all if needed</span>&nbsp;</div></li><li><div>      if ( !empty( $view_all ) )&nbsp;</div></li><li><div>          $reply_url = bbp_add_view_all( $reply_url, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Redirect back to reply</span>&nbsp;</div></li><li><div>      wp_safe_redirect( $reply_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle errors</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_toggle_reply', $failure );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">/** Reply Actions *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Marks a reply as spam</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_spam_reply' with the reply ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_post_meta() To add the previous status to a meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To insert the updated post</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_spammed_reply' with the reply ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, reply id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_spam_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get reply</span></span>&nbsp;</div></li><li><div>  $reply = bbp_get_reply( $reply_id );&nbsp;</div></li><li><div>  if ( empty( $reply ) )&nbsp;</div></li><li><div>      return $reply;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if already spam</span>&nbsp;</div></li><li><div>  if ( bbp_get_spam_status_id() === $reply-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre spam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_spam_reply', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the original post status as post meta for future restoration</span>&nbsp;</div></li><li><div>  add_post_meta( $reply_id, '_bbp_spam_meta_status', $reply-&gt;post_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set post status to spam</span>&nbsp;</div></li><li><div>  $reply-&gt;post_status = bbp_get_spam_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No revisions</span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update the reply</span></span></span>&nbsp;</div></li><li><div>  $reply_id = wp_update_post( $reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post spam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_spammed_reply', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Return reply_id</span></span>&nbsp;</div></li><li><div>  return $reply_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Unspams a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unspam_reply' with the reply ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the previous status meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_meta() To delete the previous status meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To insert the updated post</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unspammed_reply' with the reply ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, reply id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_unspam_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get reply</span></span>&nbsp;</div></li><li><div>  $reply = bbp_get_reply( $reply_id );&nbsp;</div></li><li><div>  if ( empty( $reply ) )&nbsp;</div></li><li><div>      return $reply;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if already not spam</span>&nbsp;</div></li><li><div>  if ( bbp_get_spam_status_id() !== $reply-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre unspam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_unspam_reply', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get pre spam status</span>&nbsp;</div></li><li><div>  $reply-&gt;post_status = get_post_meta( $reply_id, '_bbp_spam_meta_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no previous status, default to publish</span>&nbsp;</div></li><li><div>  if ( empty( $reply-&gt;post_status ) ) {&nbsp;</div></li><li><div>      $reply-&gt;post_status = bbp_get_public_status_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete pre spam meta</span>&nbsp;</div></li><li><div>  delete_post_meta( $reply_id, '_bbp_spam_meta_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No revisions</span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update the reply</span></span></span>&nbsp;</div></li><li><div>  $reply_id = wp_update_post( $reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post unspam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_unspammed_reply', $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Return reply_id</span></span>&nbsp;</div></li><li><div>  return $reply_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Before Delete/Trash/Untrash ***********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before deleting a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_delete_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_delete_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_delete_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before trashing a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_trash_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_trash_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_trash_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before untrashing (restoring) a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unstrash_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_untrash_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_untrash_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** After Delete/Trash/Untrash ************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after deleting a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_deleted_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_deleted_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_deleted_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after trashing a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_trashed_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_trashed_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_trashed_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after untrashing (restoring) a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_untrashed_reply' with the reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_untrashed_reply( $reply_id = 0 ) {&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_untrashed_reply', $reply_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Settings ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the replies per page setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3540)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $default Default replies per page (15)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get the setting</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() To allow the return value to be manipulated</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_replies_per_page( $default = 15 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get database option and cast as integer</span></span>&nbsp;</div></li><li><div>  $retval = get_option( '_bbp_replies_per_page', $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If return val is empty, set it to default</span></span>&nbsp;</div></li><li><div>  if ( empty( $retval ) )&nbsp;</div></li><li><div>      $retval = $default;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Filter and return</span></span>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_get_replies_per_page', $retval, $default );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the replies per RSS page setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3540)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $default Default replies per page (25)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get the setting</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() To allow the return value to be manipulated</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_replies_per_rss_page( $default = 25 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get database option and cast as integer</span></span>&nbsp;</div></li><li><div>  $retval = get_option( '_bbp_replies_per_rss_page', $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If return val is empty, set it to default</span></span>&nbsp;</div></li><li><div>  if ( empty( $retval ) )&nbsp;</div></li><li><div>      $retval = $default;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Filter and return</span></span>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_get_replies_per_rss_page', $retval, $default );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Autoembed *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if autoembeds are enabled and hook them in if so</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3752)</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Embed $wp_embed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_reply_content_autoembed() {&nbsp;</div></li><li><div>  global $wp_embed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bbp_use_autoembed() && is_a( $wp_embed, 'WP_Embed' ) ) {&nbsp;</div></li><li><div>      add_filter( 'bbp_get_reply_content', array( $wp_embed, 'autoembed' ), 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Filters *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Used by bbp_has_replies() to add the lead topic post to the posts loop</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function filters the 'post_where' of the WP_Query, and changes the query</span>&nbsp;</div></li><li><div><span class="comment"> * to include both the topic AND its children in the same loop.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4058)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $where</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _bbp_has_replies_where( $where = '', $query = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Bail ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if the sky is falling</span>&nbsp;</div></li><li><div>  if ( empty( $where ) || empty( $query ) ) {&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no post_parent to replace</span>&nbsp;</div></li><li><div>  if ( ! is_numeric( $query-&gt;get( 'post_parent' ) ) ) {&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if not a topic and reply query</span>&nbsp;</div></li><li><div>  if ( array( bbp_get_topic_post_type(), bbp_get_reply_post_type() ) !== $query-&gt;get( 'post_type' ) ) {&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if including or excluding specific post ID's</span>&nbsp;</div></li><li><div>  if ( $query-&gt;get( 'post__not_in' ) || $query-&gt;get( 'post__in' ) ) {&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Proceed ***************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Table name for posts</span>&nbsp;</div></li><li><div>  $table_name = $wpdb-&gt;prefix . 'posts';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the topic ID from the post_parent, set in bbp_has_replies()</span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $query-&gt;get( 'post_parent' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The texts to search for</span>&nbsp;</div></li><li><div>  $search = array(&nbsp;</div></li><li><div>      &quot;FROM {$table_name} &quot; , &nbsp;</div></li><li><div>      &quot;WHERE 1=1  AND {$table_name}.post_parent = {$topic_id}&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The texts to replace them with</span>&nbsp;</div></li><li><div>  $replace = array(&nbsp;</div></li><li><div>      $search[0] . &quot;FORCE INDEX (PRIMARY, post_parent) &quot; , &nbsp;</div></li><li><div>      &quot;WHERE 1=1 AND ({$table_name}.ID = {$topic_id} OR {$table_name}.post_parent = {$topic_id})&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to replace the search text with the replacement</span>&nbsp;</div></li><li><div>  $new_where = str_replace( $search, $replace, $where );&nbsp;</div></li><li><div>  if ( ! empty( $new_where ) ) {&nbsp;</div></li><li><div>      $where = $new_where;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $where;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Feeds *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output an RSS2 feed of replies, based on the query passed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3171)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_version()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_single_topic()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_user_can_view_forum()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_show_load_topic()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_permalink()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_title()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_reply_count()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_content()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_has_replies()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_replies()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_the_reply()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_reply_url()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_reply_title()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_reply_content()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_wp_title_rss()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bloginfo_rss</span>&nbsp;</div></li><li><div><span class="comment"> * @uses self_link()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses the_author()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_time()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses rss_enclosure()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $replies_query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_display_replies_feed_rss2( $replies_query = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User cannot access forum this topic is in</span>&nbsp;</div></li><li><div>  if ( bbp_is_single_topic() && !bbp_user_can_view_forum( array( 'forum_id' =&gt; bbp_get_topic_forum_id() ) ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Adjust the title based on context</span>&nbsp;</div></li><li><div>  if ( bbp_is_single_topic() && bbp_user_can_view_forum( array( 'forum_id' =&gt; bbp_get_topic_forum_id() ) ) )&nbsp;</div></li><li><div>      $title = apply_filters( 'wp_title_rss', get_wp_title_rss( ' &#187; ' ) );&nbsp;</div></li><li><div>  elseif ( !bbp_show_lead_topic() )&nbsp;</div></li><li><div>      $title = ' &#187; ' .  __( 'All Posts', 'bbpress' );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $title = ' &#187; ' .  __( 'All Replies', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Display the feed</span>&nbsp;</div></li><li><div>  header( 'Content-Type: ' . feed_content_type( 'rss2' ) . '; charset=' . get_option( 'blog_charset' ), true );&nbsp;</div></li><li><div>  header( 'Status: 200 OK' );&nbsp;</div></li><li><div>  echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;' . get_option( 'blog_charset' ) . '&quot;?' . '&gt;'; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;rss version=&quot;2.0&quot;&nbsp;</div></li><li><div>      xmlns:content=&quot;http:<span class="comment">//purl.org/rss/1.0/modules/content/&quot;</span>&nbsp;</div></li><li><div>      xmlns:wfw=&quot;http:<span class="comment">//wellformedweb.org/CommentAPI/&quot;</span>&nbsp;</div></li><li><div>      xmlns:dc=&quot;http:<span class="comment">//purl.org/dc/elements/1.1/&quot;</span>&nbsp;</div></li><li><div>      xmlns:atom=&quot;http:<span class="comment">//www.w3.org/2005/Atom&quot;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed' ); ?&gt;&nbsp;</div></li><li><div>  &gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;channel&gt;&nbsp;</div></li><li><div>      &lt;title&gt;&lt;?php bloginfo_rss('name'); echo $title; ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>      &lt;atom:link href=&quot;&lt;?php self_link(); ?&gt;&quot; rel=&quot;self&quot; type=&quot;application/rss+xml&quot; /&gt;&nbsp;</div></li><li><div>      &lt;link&gt;&lt;?php self_link(); ?&gt;&lt;/link&gt;&nbsp;</div></li><li><div>      &lt;description&gt;&lt;?php <span class="comment">//?&gt;&lt;/description&gt;</span>&nbsp;</div></li><li><div>      &lt;pubDate&gt;&lt;?php echo mysql2date( 'D, d M Y H:i:s O', current_time( 'mysql' ), false ); ?&gt;&lt;/pubDate&gt;&nbsp;</div></li><li><div>      &lt;generator&gt;http:<span class="comment">//bbpress.org/?v=&lt;?php bbp_version(); ?&gt;&lt;/generator&gt;</span>&nbsp;</div></li><li><div>      &lt;language&gt;&lt;?php bloginfo_rss( 'language' ); ?&gt;&lt;/language&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed_head' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php if ( bbp_is_single_topic() ) : ?&gt;&nbsp;</div></li><li><div>          &lt;?php if ( bbp_user_can_view_forum( array( 'forum_id' =&gt; bbp_get_topic_forum_id() ) ) ) : ?&gt;&nbsp;</div></li><li><div>              &lt;?php if ( bbp_show_lead_topic() ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;item&gt;&nbsp;</div></li><li><div>                      &lt;guid&gt;&lt;?php bbp_topic_permalink(); ?&gt;&lt;/guid&gt;&nbsp;</div></li><li><div>                      &lt;title&gt;&lt;![CDATA[&lt;?php bbp_topic_title(); ?&gt;]]&gt;&lt;/title&gt;&nbsp;</div></li><li><div>                      &lt;link&gt;&lt;?php bbp_topic_permalink(); ?&gt;&lt;/link&gt;&nbsp;</div></li><li><div>                      &lt;pubDate&gt;&lt;?php echo mysql2date( 'D, d M Y H:i:s +0000', get_post_time( 'Y-m-d H:i:s', true ), false ); ?&gt;&lt;/pubDate&gt;&nbsp;</div></li><li><div>                      &lt;dc:creator&gt;&lt;?php the_author(); ?&gt;&lt;/dc:creator&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;description&gt;&nbsp;</div></li><li><div>                          &lt;![CDATA[&nbsp;</div></li><li><div>                          &lt;p&gt;&lt;?php printf( __( 'Replies: %s', 'bbpress' ), bbp_get_topic_reply_count() ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                          &lt;?php bbp_topic_content(); ?&gt;&nbsp;</div></li><li><div> ]]&gt;&nbsp;</div></li><li><div>                      &lt;/description&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;?php rss_enclosure(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;?php do_action( 'bbp_feed_item' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;/item&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php if ( bbp_has_replies( $replies_query ) ) : ?&gt;&nbsp;</div></li><li><div>          &lt;?php while ( bbp_replies() ) : bbp_the_reply(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;item&gt;&nbsp;</div></li><li><div>                  &lt;guid&gt;&lt;?php bbp_reply_url(); ?&gt;&lt;/guid&gt;&nbsp;</div></li><li><div>                  &lt;title&gt;&lt;![CDATA[&lt;?php bbp_reply_title(); ?&gt;]]&gt;&lt;/title&gt;&nbsp;</div></li><li><div>                  &lt;link&gt;&lt;?php bbp_reply_url(); ?&gt;&lt;/link&gt;&nbsp;</div></li><li><div>                  &lt;pubDate&gt;&lt;?php echo mysql2date( 'D, d M Y H:i:s +0000', get_post_time( 'Y-m-d H:i:s', true ), false ); ?&gt;&lt;/pubDate&gt;&nbsp;</div></li><li><div>                  &lt;dc:creator&gt;&lt;?php the_author() ?&gt;&lt;/dc:creator&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;description&gt;&nbsp;</div></li><li><div>                      &lt;![CDATA[&nbsp;</div></li><li><div>                      &lt;?php bbp_reply_content(); ?&gt;&nbsp;</div></li><li><div> ]]&gt;&nbsp;</div></li><li><div>                  &lt;/description&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php rss_enclosure(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php do_action( 'bbp_feed_item' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;/item&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endwhile; ?&gt;&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed_footer' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;/channel&gt;&nbsp;</div></li><li><div>  &lt;/rss&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We're done here</span>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Permissions ***************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirect if unathorized user is attempting to edit a reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3605)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply_edit()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_reply_edit() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if not editing a topic</span>&nbsp;</div></li><li><div>  if ( !bbp_is_reply_edit() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User cannot edit topic, so redirect back to reply</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_reply', bbp_get_reply_id() ) ) {&nbsp;</div></li><li><div>      wp_safe_redirect( bbp_get_reply_url() );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Reply Position ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the position of the reply.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The reply position is stored in the menu_order column of the posts table.</span>&nbsp;</div></li><li><div><span class="comment"> * This is done to prevent using a meta_query to retrieve posts in the proper</span>&nbsp;</div></li><li><div><span class="comment"> * freshness order. By updating the menu_order accordingly, we're able to</span>&nbsp;</div></li><li><div><span class="comment"> * leverage core WordPress query ordering much more effectively.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3933)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global type $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @param type $reply_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param type $reply_position</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_reply_position( $reply_id = 0, $reply_position = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if reply_id is empty</span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  if ( empty( $reply_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no position was passed, get it from the db and update the menu_order</span>&nbsp;</div></li><li><div>  if ( empty( $reply_position ) ) {&nbsp;</div></li><li><div>      $reply_position = bbp_get_reply_position_raw( $reply_id, bbp_get_reply_topic_id( $reply_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the replies' 'menp_order' with the reply position</span>&nbsp;</div></li><li><div>  wp_update_post( array(&nbsp;</div></li><li><div>      'ID' =&gt; $reply_id, &nbsp;</div></li><li><div>      'menu_order' =&gt; $reply_position&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) $reply_position;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the position of a reply by querying the DB directly for the replies</span>&nbsp;</div></li><li><div><span class="comment"> * of a given topic.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3933)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_reply_position_raw( $reply_id = 0, $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get required data</span>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $topic_id = !empty( $topic_id ) ? bbp_get_topic_id( $topic_id ) : bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>  $reply_position = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If reply is actually the first post in a topic, return 0</span>&nbsp;</div></li><li><div>  if ( $reply_id !== $topic_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Make sure the topic has replies before running another query</span>&nbsp;</div></li><li><div>      $reply_count = bbp_get_topic_reply_count( $topic_id, false );&nbsp;</div></li><li><div>      if ( !empty( $reply_count ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Get reply</span></span> id's&nbsp;</div></li><li><div>          $topic_replies = bbp_get_all_child_ids( $topic_id, bbp_get_reply_post_type() );&nbsp;</div></li><li><div>          if ( !empty( $topic_replies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Reverse replies array and search for current reply position</span>&nbsp;</div></li><li><div>              $topic_replies = array_reverse( $topic_replies );&nbsp;</div></li><li><div>              $reply_position = array_search( (string) $reply_id, $topic_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Bump the position to compensate for the lead topic post</span>&nbsp;</div></li><li><div>              $reply_position++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) $reply_position;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Hierarchical Replies ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * List replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4944)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_list_replies( $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reset the reply depth</span>&nbsp;</div></li><li><div>  bbpress()-&gt;reply_query-&gt;reply_depth = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// In reply loop</span>&nbsp;</div></li><li><div>  bbpress()-&gt;reply_query-&gt;in_the_loop = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $args, array(&nbsp;</div></li><li><div>      'walker' =&gt; null, &nbsp;</div></li><li><div>      'max_depth' =&gt; bbp_thread_replies_depth(), &nbsp;</div></li><li><div>      'style' =&gt; 'ul', &nbsp;</div></li><li><div>      'callback' =&gt; null, &nbsp;</div></li><li><div>      'end_callback' =&gt; null, &nbsp;</div></li><li><div>      'page' =&gt; 1, &nbsp;</div></li><li><div>      'per_page' =&gt; -1&nbsp;</div></li><li><div> ), 'list_replies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get replies to loop through in $_replies</span>&nbsp;</div></li><li><div>  $walker = new BBP_Walker_Reply;&nbsp;</div></li><li><div>  $walker-&gt;paged_walk( bbpress()-&gt;reply_query-&gt;posts, $r['max_depth'], $r['page'], $r['per_page'], $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bbpress()-&gt;max_num_pages = $walker-&gt;max_pages;&nbsp;</div></li><li><div>  bbpress()-&gt;reply_query-&gt;in_the_loop = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate a `reply_to` field for hierarchical replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks for 2 scenarios:</span>&nbsp;</div></li><li><div><span class="comment"> * -- The reply to ID is actually a reply</span>&nbsp;</div></li><li><div><span class="comment"> * -- The reply to ID does not match the current reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5377)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_to</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int $reply_to</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_validate_reply_to( $reply_to = 0, $reply_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The parent reply must actually be a reply</span>&nbsp;</div></li><li><div>  if ( ! bbp_is_reply( $reply_to ) ) {&nbsp;</div></li><li><div>      $reply_to = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The parent reply cannot be itself</span>&nbsp;</div></li><li><div>  if ( $reply_id === $reply_to ) {&nbsp;</div></li><li><div>      $reply_to = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) $reply_to;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>bbPress</li><li><span></span>2.5.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>