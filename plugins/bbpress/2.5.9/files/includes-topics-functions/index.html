<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.5.9" data-slug="bbpress" data-type="file" data-id="62476"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-topics-functions | file | Bbpress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, bbpress, 2.5.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3b250de1c2735c6e82718fde36a1f409' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-topics-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-topics-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-topics-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-bbpress-2.5.9-file-includes-topics-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-topics-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to bbpress." href="http://hookr.io/plugins/bbpress/" class="plugin"><span property="name">bbpress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.5.9." href="http://hookr.io/plugins/bbpress/2.5.9/" class="H_VERSION"><span property="name">2.5.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/bbpress/2.5.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-topics-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2373"><a href="http://hookr.io/plugins/bbpress/2.5.9/all/" title="All">All <span class="count badge">2373</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/bbpress/2.5.9/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="1132"><a href="http://hookr.io/plugins/bbpress/2.5.9/hooks/" title="Hooks">Hooks <span class="count badge">1132</span></a></li><li class="" data-id="action" data-count="471"><a href="http://hookr.io/plugins/bbpress/2.5.9/actions/" title="Actions">Actions <span class="count badge">471</span></a></li><li class="" data-id="filter" data-count="661"><a href="http://hookr.io/plugins/bbpress/2.5.9/filters/" title="Filters">Filters <span class="count badge">661</span></a></li><li class="" data-id="class" data-count="54"><a href="http://hookr.io/plugins/bbpress/2.5.9/classes/" title="Classes">Classes <span class="count badge">54</span></a></li><li class="" data-id="constant" data-count="28"><a href="http://hookr.io/plugins/bbpress/2.5.9/constants/" title="Constants">Constants <span class="count badge">28</span></a></li><li class="" data-id="function" data-count="1158"><a href="http://hookr.io/plugins/bbpress/2.5.9/functions/" title="Functions">Functions <span class="count badge">1158</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/bbpress/2.5.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/topics/functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * bbPress Topic Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Functions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( !defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Insert ********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A wrapper for wp_insert_post() that also includes the necessary meta values</span>&nbsp;</div></li><li><div><span class="comment"> * for the topic to function properly.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3349)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_parse_args()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_post()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $topic_data Forum post data</span>&nbsp;</div></li><li><div><span class="comment"> * @param arrap $topic_meta Forum meta data</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_insert_topic( $topic_data = array(), $topic_meta = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse arguments against default values</span></span></span></span>&nbsp;</div></li><li><div>  $topic_data = bbp_parse_args( $topic_data, array(&nbsp;</div></li><li><div>      'post_parent' =&gt; 0, <span class="comment">// forum ID</span>&nbsp;</div></li><li><div>      'post_status' =&gt; bbp_get_public_status_id(), &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>      'post_author' =&gt; bbp_get_current_user_id(), &nbsp;</div></li><li><div>      'post_password' =&gt; '', &nbsp;</div></li><li><div>      'post_content' =&gt; '', &nbsp;</div></li><li><div>      'post_title' =&gt; '', &nbsp;</div></li><li><div>      'comment_status' =&gt; 'closed', &nbsp;</div></li><li><div>      'menu_order' =&gt; 0, &nbsp;</div></li><li><div> ), 'insert_topic' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Insert topic</span></span></span>&nbsp;</div></li><li><div>  $topic_id = wp_insert_post( $topic_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if no topic</span></span> was added</span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse arguments against default values</span></span></span></span>&nbsp;</div></li><li><div>  $topic_meta = bbp_parse_args( $topic_meta, array(&nbsp;</div></li><li><div>      'author_ip' =&gt; bbp_current_author_ip(), &nbsp;</div></li><li><div>      'forum_id' =&gt; 0, &nbsp;</div></li><li><div>      'topic_id' =&gt; $topic_id, &nbsp;</div></li><li><div>      'voice_count' =&gt; 1, &nbsp;</div></li><li><div>      'reply_count' =&gt; 0, &nbsp;</div></li><li><div>      'reply_count_hidden' =&gt; 0, &nbsp;</div></li><li><div>      'last_reply_id' =&gt; 0, &nbsp;</div></li><li><div>      'last_active_id' =&gt; $topic_id, &nbsp;</div></li><li><div>      'last_active_time' =&gt; get_post_field( 'post_date', $topic_id, 'db' ), &nbsp;</div></li><li><div> ), 'insert_topic_meta' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Insert topic</span></span></span> meta&nbsp;</div></li><li><div>  foreach ( $topic_meta as $meta_key =&gt; $meta_value ) {&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_' . $meta_key, $meta_value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the forum</span></span>&nbsp;</div></li><li><div>  $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>  if ( !empty( $forum_id ) ) {&nbsp;</div></li><li><div>      bbp_update_forum( array( 'forum_id' =&gt; $forum_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return new topic ID</span>&nbsp;</div></li><li><div>  return $topic_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Post Form Handlers ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end topic submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_anonymous() To check if an anonymous post is being made</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can publish topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_current_user_id() To get the current user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_filter_anonymous_post_data() To filter anonymous data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_set_current_anonymous_user_data() To set the anonymous user cookies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses esc_attr() For sanitization</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_category() To check if the forum is a category</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_closed() To check if the forum is closed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_private() To check if the forum is private</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_check_for_flood() To check for flooding</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_check_for_duplicate() To check for duplicates</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses remove_filter() To remove kses filters if needed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_new_topic_pre_title' with the content</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_new_topic_pre_content' with the content</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_codes() To get the {@link WP_Error} errors</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_post() To insert the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_new_topic' with the topic id, forum id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    anonymous data and reply author</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_stick_topic() To stick or super stick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unstick_topic() To unstick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic permalink</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic link</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_messages() To get the {@link WP_Error} error</span>&nbsp;</div></li><li><div><span class="comment"> *                                              messages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_new_topic_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not bbp-new-topic</span>&nbsp;</div></li><li><div>  if ( 'bbp-new-topic' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-new-topic' ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_new_topic_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Define local variable(s)</span></span></span></span></span>&nbsp;</div></li><li><div>  $view_all = false;&nbsp;</div></li><li><div>  $forum_id = $topic_author = $anonymous_data = 0;&nbsp;</div></li><li><div>  $topic_title = $topic_content = '';&nbsp;</div></li><li><div>  $terms = array( bbp_get_topic_tag_tax_id() =&gt; array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Author **********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is anonymous</span>&nbsp;</div></li><li><div>  if ( bbp_is_anonymous() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Filter anonymous data</span></span>&nbsp;</div></li><li><div>      $anonymous_data = bbp_filter_anonymous_post_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Anonymous data checks out, so set cookies, etc...</span>&nbsp;</div></li><li><div>      if ( !empty( $anonymous_data ) && is_array( $anonymous_data ) ) {&nbsp;</div></li><li><div>          bbp_set_current_anonymous_user_data( $anonymous_data );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is logged in</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User cannot create topics</span>&nbsp;</div></li><li><div>      if ( !current_user_can( 'publish_topics' ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_topic_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have permission to create new topics.', 'bbpress' ) );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Topic author is current user</span>&nbsp;</div></li><li><div>      $topic_author = bbp_get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove kses filters from title and content for capable users and if the nonce is verified</span></span>&nbsp;</div></li><li><div>  if ( current_user_can( 'unfiltered_html' ) && !empty( $_POST['_bbp_unfiltered_html_topic'] ) && wp_create_nonce( 'bbp-unfiltered-html-topic_new' ) === $_POST['_bbp_unfiltered_html_topic'] ) {&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_topic_pre_title', 'wp_filter_kses' );&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_topic_pre_content', 'bbp_encode_bad', 10 );&nbsp;</div></li><li><div>      remove_filter( 'bbp_new_topic_pre_content', 'bbp_filter_kses', 30 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Title ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_title'] ) )&nbsp;</div></li><li><div>      $topic_title = esc_attr( strip_tags( $_POST['bbp_topic_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $topic_title = apply_filters( 'bbp_new_topic_pre_title', $topic_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// No topic</span> title</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_title ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_title', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic needs a title.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Content *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_content'] ) )&nbsp;</div></li><li><div>      $topic_content = $_POST['bbp_topic_content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $topic_content = apply_filters( 'bbp_new_topic_pre_content', $topic_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// No topic</span> content</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_content', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic cannot be empty.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Forum ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Error check the POST'ed topic id</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Empty Forum id was passed</span>&nbsp;</div></li><li><div>      if ( empty( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum id is not a number</span>&nbsp;</div></li><li><div>      } elseif ( ! is_numeric( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID must be a number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Forum id might be valid</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the forum id</span>&nbsp;</div></li><li><div>          $posted_forum_id = intval( $_POST['bbp_forum_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum id is empty</span>&nbsp;</div></li><li><div>          if ( 0 === $posted_forum_id ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum id is a negative number</span>&nbsp;</div></li><li><div>          } elseif ( 0 &gt; $posted_forum_id ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID cannot be a negative number.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Forum does not exist</span>&nbsp;</div></li><li><div>          } elseif ( ! bbp_get_forum( $posted_forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum does not exist.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Use the POST'ed forum id</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $forum_id = $posted_forum_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum exists</span></span>&nbsp;</div></li><li><div>  if ( !empty( $forum_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Forum is a category</span></span>&nbsp;</div></li><li><div>      if ( bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_new_topic_forum_category', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is a category. No topics can be created in this forum.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Forum is not a category</span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is closed and user cannot access</span></span>&nbsp;</div></li><li><div>          if ( bbp_is_forum_closed( $forum_id ) && !current_user_can( 'edit_forum', $forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_new_topic_forum_closed', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum has been closed to new topics.', 'bbpress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is private and user cannot access</span></span>&nbsp;</div></li><li><div>          if ( bbp_is_forum_private( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_private_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_new_topic_forum_private', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is private and you do not have the capability to read or create new topics in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is hidden and user cannot access</span></span>&nbsp;</div></li><li><div>          } elseif ( bbp_is_forum_hidden( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_hidden_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_new_topic_forum_hidden', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is hidden and you do not have the capability to read or create new topics in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Flooding ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_flood( $anonymous_data, $topic_author ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_flood', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Slow down; you move too fast.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Duplicate *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_duplicate( array( 'post_type' =&gt; bbp_get_topic_post_type(), 'post_author' =&gt; $topic_author, 'post_content' =&gt; $topic_content, 'anonymous_data' =&gt; $anonymous_data ) ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_duplicate', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Duplicate topic detected; it looks as though you&#8217;ve already said that!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Blacklist *******************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_blacklist( $anonymous_data, $topic_author, $topic_title, $topic_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_blacklist', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic cannot be created at this time.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Status **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Maybe put into moderation</span></span>&nbsp;</div></li><li><div>  if ( !bbp_check_for_moderation( $anonymous_data, $topic_author, $topic_title, $topic_content ) ) {&nbsp;</div></li><li><div>      $topic_status = bbp_get_pending_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check a whitelist of possible topic status ID's</span></span>&nbsp;</div></li><li><div>  } elseif ( !empty( $_POST['bbp_topic_status'] ) && in_array( $_POST['bbp_topic_status'], array_keys( bbp_get_topic_statuses() ) ) ) {&nbsp;</div></li><li><div>      $topic_status = $_POST['bbp_topic_status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default to published if nothing else</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_status = bbp_get_public_status_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bbp_allow_topic_tags() && !empty( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Escape tag input</span></span>&nbsp;</div></li><li><div>      $terms = esc_attr( strip_tags( $_POST['bbp_topic_tags'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Explode by comma</span></span>&nbsp;</div></li><li><div>      if ( strstr( $terms, ', ' ) ) {&nbsp;</div></li><li><div>          $terms = explode( ', ', $terms );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add topic tag ID as main key</span></span>&nbsp;</div></li><li><div>      $terms = array( bbp_get_topic_tag_tax_id() =&gt; $terms );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Additional Actions (Before Save) **************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_new_topic_pre_extras', $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if errors</span></span></span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add the content of the form to $topic_data as an array</span>.</span>&nbsp;</div></li><li><div>  <span class="comment">// Just in time manipulation of topic data before being created</span>&nbsp;</div></li><li><div>  $topic_data = apply_filters( 'bbp_new_topic_pre_insert', array(&nbsp;</div></li><li><div>      'post_author' =&gt; $topic_author, &nbsp;</div></li><li><div>      'post_title' =&gt; $topic_title, &nbsp;</div></li><li><div>      'post_content' =&gt; $topic_content, &nbsp;</div></li><li><div>      'post_status' =&gt; $topic_status, &nbsp;</div></li><li><div>      'post_parent' =&gt; $forum_id, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>      'tax_input' =&gt; $terms, &nbsp;</div></li><li><div>      'comment_status' =&gt; 'closed'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Insert topic</span></span></span>&nbsp;</div></li><li><div>  $topic_id = wp_insert_post( $topic_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $topic_id ) && !is_wp_error( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Trash Check *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the forum is trash, or the topic_status is switched to</span>&nbsp;</div></li><li><div>      <span class="comment">// trash, trash it properly</span>&nbsp;</div></li><li><div>      if ( ( get_post_field( 'post_status', $forum_id ) === bbp_get_trash_status_id() ) || ( $topic_data['post_status'] === bbp_get_trash_status_id() ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Trash the reply</span>&nbsp;</div></li><li><div>          wp_trash_post( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Force view=all</span></span>&nbsp;</div></li><li><div>          $view_all = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Spam Check ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If reply or topic are spam, officially spam this reply</span>&nbsp;</div></li><li><div>      if ( $topic_data['post_status'] === bbp_get_spam_status_id() ) {&nbsp;</div></li><li><div>          add_post_meta( $topic_id, '_bbp_spam_meta_status', bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Force view=all</span></span>&nbsp;</div></li><li><div>          $view_all = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Update counts, etc... *********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_new_topic', $topic_id, $forum_id, $anonymous_data, $topic_author );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Stickies **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Sticky</span> check after 'bbp_new_topic' action so forum ID meta is set</span>&nbsp;</div></li><li><div>      if ( !empty( $_POST['bbp_stick_topic'] ) && in_array( $_POST['bbp_stick_topic'], array( 'stick', 'super', 'unstick' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// What's the caps?</span></span>&nbsp;</div></li><li><div>          if ( current_user_can( 'moderate' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// What's the haps?</span></span>&nbsp;</div></li><li><div>              switch ( $_POST['bbp_stick_topic'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Sticky</span> in this forum</span>&nbsp;</div></li><li><div>                  case 'stick'   :&nbsp;</div></li><li><div>                      bbp_stick_topic( $topic_id );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Super sticky in all forums</span>&nbsp;</div></li><li><div>                  case 'super'   :&nbsp;</div></li><li><div>                      bbp_stick_topic( $topic_id, true );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// We can avoid this as it is a new topic</span>&nbsp;</div></li><li><div>                  case 'unstick' :&nbsp;</div></li><li><div>                  default        :&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Additional Actions (After Save) ***********************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_new_topic_post_extras', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Redirect **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> to</span></span>&nbsp;</div></li><li><div>      $redirect_to = bbp_get_redirect_to();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the topic</span></span> URL</span></span>&nbsp;</div></li><li><div>      $redirect_url = bbp_get_topic_permalink( $topic_id, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add view all?</span></span>&nbsp;</div></li><li><div>      if ( bbp_get_view_all() || !empty( $view_all ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// User can moderate, so redirect to topic with view all set</span>&nbsp;</div></li><li><div>          if ( current_user_can( 'moderate' ) ) {&nbsp;</div></li><li><div>              $redirect_url = bbp_add_view_all( $redirect_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// User cannot moderate, so redirect to forum</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $redirect_url = bbp_get_forum_permalink( $forum_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Allow to be filtered</span></span>&nbsp;</div></li><li><div>      $redirect_url = apply_filters( 'bbp_new_topic_redirect_to', $redirect_url, $redirect_to, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Successful Save ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to new topic</span></span></span>&nbsp;</div></li><li><div>      wp_safe_redirect( $redirect_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Errors</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $append_error = ( is_wp_error( $topic_id ) && $topic_id-&gt;get_error_message() ) ? $topic_id-&gt;get_error_message() . ' ' : '';&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_error', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found with your topic:' . $append_error, 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end edit topic submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_anonymous() To check if topic is by an anonymous user</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_filter_anonymous_post_data() To filter anonymous data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses esc_attr() For sanitization</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_category() To check if the forum is a category</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_closed() To check if the forum is closed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum_private() To check if the forum is private</span>&nbsp;</div></li><li><div><span class="comment"> * @uses remove_filter() To remove kses filters if needed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_edit_topic_pre_title' with the title and</span>&nbsp;</div></li><li><div><span class="comment"> *                        topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_edit_topic_pre_content' with the content</span>&nbsp;</div></li><li><div><span class="comment"> *                        and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_codes() To get the {@link WP_Error} errors</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_save_post_revision() To save a topic revision</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_revision_log() To update the topic revision log</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_stick_topic() To stick or super stick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unstick_topic() To unstick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_edit_topic' with the topic id, forum id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    anonymous data and reply author</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_move_topic_handler() To handle movement of a topic from one forum</span>&nbsp;</div></li><li><div><span class="comment"> *                                 to another</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic permalink</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic link</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors::get_error_messages() To get the {@link WP_Error} error</span>&nbsp;</div></li><li><div><span class="comment"> *                                              messages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_edit_topic_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not bbp-edit-topic</span>&nbsp;</div></li><li><div>  if ( 'bbp-edit-topic' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Define local variable(s)</span></span></span></span></span>&nbsp;</div></li><li><div>  $revisions_removed = false;&nbsp;</div></li><li><div>  $topic = $topic_id = $topic_author = $forum_id = $anonymous_data = 0;&nbsp;</div></li><li><div>  $topic_title = $topic_content = $topic_edit_reason = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Topic id</span></span> was not passed</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_topic_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_topic_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic ID not found.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Topic id</span></span> was passed</span>&nbsp;</div></li><li><div>  } elseif ( is_numeric( $_POST['bbp_topic_id'] ) ) {&nbsp;</div></li><li><div>      $topic_id = (int) $_POST['bbp_topic_id'];&nbsp;</div></li><li><div>      $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic does not exist</span>&nbsp;</div></li><li><div>  if ( empty( $topic ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_topic_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to edit was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic exists</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check users ability to create new topic</span>&nbsp;</div></li><li><div>      if ( ! bbp_is_topic_anonymous( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// User cannot edit this topic</span>&nbsp;</div></li><li><div>          if ( !current_user_can( 'edit_topic', $topic_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_edit_topic_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have permission to edit that topic.', 'bbpress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set topic author</span>&nbsp;</div></li><li><div>          $topic_author = bbp_get_topic_author_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// It is an anonymous post</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Filter anonymous data</span></span>&nbsp;</div></li><li><div>          $anonymous_data = bbp_filter_anonymous_post_data( array(), true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-edit-topic_' . $topic_id ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_topic_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove kses filters from title and content for capable users and if the nonce is verified</span></span>&nbsp;</div></li><li><div>  if ( current_user_can( 'unfiltered_html' ) && !empty( $_POST['_bbp_unfiltered_html_topic'] ) && ( wp_create_nonce( 'bbp-unfiltered-html-topic_' . $topic_id ) === $_POST['_bbp_unfiltered_html_topic'] ) ) {&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_topic_pre_title', 'wp_filter_kses' );&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_topic_pre_content', 'bbp_encode_bad', 10 );&nbsp;</div></li><li><div>      remove_filter( 'bbp_edit_topic_pre_content', 'bbp_filter_kses', 30 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Forum ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum id was not passed</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_forum_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Forum ID is missing.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum id was passed</span>&nbsp;</div></li><li><div>  } elseif ( is_numeric( $_POST['bbp_forum_id'] ) ) {&nbsp;</div></li><li><div>      $forum_id = (int) $_POST['bbp_forum_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Current forum this topic is in</span>&nbsp;</div></li><li><div>  $current_forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum exists</span></span>&nbsp;</div></li><li><div>  if ( !empty( $forum_id ) && ( $forum_id !== $current_forum_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Forum is a category</span></span>&nbsp;</div></li><li><div>      if ( bbp_is_forum_category( $forum_id ) ) {&nbsp;</div></li><li><div>          bbp_add_error( 'bbp_edit_topic_forum_category', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is a category. No topics can be created in it.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Forum is not a category</span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is closed and user cannot access</span></span>&nbsp;</div></li><li><div>          if ( bbp_is_forum_closed( $forum_id ) && !current_user_can( 'edit_forum', $forum_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_edit_topic_forum_closed', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum has been closed to new topics.', 'bbpress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is private and user cannot access</span></span>&nbsp;</div></li><li><div>          if ( bbp_is_forum_private( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_private_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_edit_topic_forum_private', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is private and you do not have the capability to read or create new topics in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum is hidden and user cannot access</span></span>&nbsp;</div></li><li><div>          } elseif ( bbp_is_forum_hidden( $forum_id ) ) {&nbsp;</div></li><li><div>              if ( !current_user_can( 'read_hidden_forums' ) ) {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_edit_topic_forum_hidden', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This forum is hidden and you do not have the capability to read or create new topics in it.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Title ***********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_title'] ) )&nbsp;</div></li><li><div>      $topic_title = esc_attr( strip_tags( $_POST['bbp_topic_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $topic_title = apply_filters( 'bbp_edit_topic_pre_title', $topic_title, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// No topic</span> title</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_title ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_topic_title', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic needs a title.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Content *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_content'] ) )&nbsp;</div></li><li><div>      $topic_content = $_POST['bbp_topic_content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and sanitize</span></span></span></span>&nbsp;</div></li><li><div>  $topic_content = apply_filters( 'bbp_edit_topic_pre_content', $topic_content, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// No topic</span> content</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_edit_topic_content', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic cannot be empty.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic Blacklist *******************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bbp_check_for_blacklist( $anonymous_data, $topic_author, $topic_title, $topic_content ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_blacklist', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your topic cannot be edited at this time.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Status **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Maybe put into moderation</span></span>&nbsp;</div></li><li><div>  if ( !bbp_check_for_moderation( $anonymous_data, $topic_author, $topic_title, $topic_content ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set post status to pending if public or closed</span>&nbsp;</div></li><li><div>      if ( in_array( $topic-&gt;post_status, array( bbp_get_public_status_id(), bbp_get_closed_status_id() ) ) ) {&nbsp;</div></li><li><div>          $topic_status = bbp_get_pending_status_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check a whitelist of possible topic status ID's</span></span>&nbsp;</div></li><li><div>  } elseif ( !empty( $_POST['bbp_topic_status'] ) && in_array( $_POST['bbp_topic_status'], array_keys( bbp_get_topic_statuses() ) ) ) {&nbsp;</div></li><li><div>      $topic_status = $_POST['bbp_topic_status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use existing post_status</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_status = $topic-&gt;post_status;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Either replace terms</span>&nbsp;</div></li><li><div>  if ( bbp_allow_topic_tags() && current_user_can( 'assign_topic_tags' ) && ! empty( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Escape tag input</span></span>&nbsp;</div></li><li><div>      $terms = esc_attr( strip_tags( $_POST['bbp_topic_tags'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Explode by comma</span></span>&nbsp;</div></li><li><div>      if ( strstr( $terms, ', ' ) )&nbsp;</div></li><li><div>          $terms = explode( ', ', $terms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add topic tag ID as main key</span></span>&nbsp;</div></li><li><div>      $terms = array( bbp_get_topic_tag_tax_id() =&gt; $terms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// ...or remove them.</span>&nbsp;</div></li><li><div>  } elseif ( isset( $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>      $terms = array( bbp_get_topic_tag_tax_id() =&gt; array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Existing terms</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $terms = array( bbp_get_topic_tag_tax_id() =&gt; explode( ', ', bbp_get_topic_tag_names( $topic_id, ', ' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Additional Actions (Before Save) **************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_edit_topic_pre_extras', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if errors</span></span></span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the content of the form to $topic_data as an array</span>&nbsp;</div></li><li><div>  <span class="comment">// Just in time manipulation of topic data before being edited</span>&nbsp;</div></li><li><div>  $topic_data = apply_filters( 'bbp_edit_topic_pre_insert', array(&nbsp;</div></li><li><div>      'ID' =&gt; $topic_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $topic_title, &nbsp;</div></li><li><div>      'post_content' =&gt; $topic_content, &nbsp;</div></li><li><div>      'post_status' =&gt; $topic_status, &nbsp;</div></li><li><div>      'post_parent' =&gt; $forum_id, &nbsp;</div></li><li><div>      'post_author' =&gt; $topic_author, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>      'tax_input' =&gt; $terms, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Toggle revisions to avoid duplicates</span>&nbsp;</div></li><li><div>  if ( post_type_supports( bbp_get_topic_post_type(), 'revisions' ) ) {&nbsp;</div></li><li><div>      $revisions_removed = true;&nbsp;</div></li><li><div>      remove_post_type_support( bbp_get_topic_post_type(), 'revisions' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Insert topic</span></span></span>&nbsp;</div></li><li><div>  $topic_id = wp_update_post( $topic_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Toggle revisions back on</span>&nbsp;</div></li><li><div>  if ( true === $revisions_removed ) {&nbsp;</div></li><li><div>      $revisions_removed = false;&nbsp;</div></li><li><div>      add_post_type_support( bbp_get_topic_post_type(), 'revisions' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $topic_id ) && !is_wp_error( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>      do_action( 'bbp_edit_topic', $topic_id, $forum_id, $anonymous_data, $topic_author , true <span class="comment">/** Is edit */</span> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Revisions *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Revision Reason</span>&nbsp;</div></li><li><div>      if ( !empty( $_POST['bbp_topic_edit_reason'] ) ) {&nbsp;</div></li><li><div>          $topic_edit_reason = esc_attr( strip_tags( $_POST['bbp_topic_edit_reason'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update revision log</span>&nbsp;</div></li><li><div>      if ( !empty( $_POST['bbp_log_topic_edit'] ) && ( &quot;1&quot; === $_POST['bbp_log_topic_edit'] ) )  {&nbsp;</div></li><li><div>          $revision_id = wp_save_post_revision( $topic_id );&nbsp;</div></li><li><div>          if ( ! empty( $revision_id ) ) {&nbsp;</div></li><li><div>              bbp_update_topic_revision_log( array(&nbsp;</div></li><li><div>                  'topic_id' =&gt; $topic_id, &nbsp;</div></li><li><div>                  'revision_id' =&gt; $revision_id, &nbsp;</div></li><li><div>                  'author_id' =&gt; bbp_get_current_user_id(), &nbsp;</div></li><li><div>                  'reason' =&gt; $topic_edit_reason&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Move Topic ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the new forum id is not equal to the old forum id, run the</span>&nbsp;</div></li><li><div>      <span class="comment">// bbp_move_topic action and pass the topic's forum id as the</span>&nbsp;</div></li><li><div>      <span class="comment">// first arg and topic id as the second to update counts.</span>&nbsp;</div></li><li><div>      if ( $forum_id !== $topic-&gt;post_parent ) {&nbsp;</div></li><li><div>          bbp_move_topic_handler( $topic_id, $topic-&gt;post_parent, $forum_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Stickies **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $_POST['bbp_stick_topic'] ) && in_array( $_POST['bbp_stick_topic'], array_keys( bbp_get_topic_types() ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// What's the caps?</span></span>&nbsp;</div></li><li><div>          if ( current_user_can( 'moderate' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// What's the haps?</span></span>&nbsp;</div></li><li><div>              switch ( $_POST['bbp_stick_topic'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Sticky</span> in forum</span>&nbsp;</div></li><li><div>                  case 'stick'   :&nbsp;</div></li><li><div>                      bbp_stick_topic( $topic_id );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Sticky</span> in all forums</span>&nbsp;</div></li><li><div>                  case 'super'   :&nbsp;</div></li><li><div>                      bbp_stick_topic( $topic_id, true );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Normal</span>&nbsp;</div></li><li><div>                  case 'unstick' :&nbsp;</div></li><li><div>                  default        :&nbsp;</div></li><li><div>                      bbp_unstick_topic( $topic_id );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Additional Actions (After Save) ***********************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'bbp_edit_topic_post_extras', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Redirect **********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> to</span></span>&nbsp;</div></li><li><div>      $redirect_to = bbp_get_redirect_to();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// View all?</span>&nbsp;</div></li><li><div>      $view_all = bbp_get_view_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the topic</span></span> URL</span></span>&nbsp;</div></li><li><div>      $topic_url = bbp_get_topic_permalink( $topic_id, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add view all?</span></span>&nbsp;</div></li><li><div>      if ( !empty( $view_all ) )&nbsp;</div></li><li><div>          $topic_url = bbp_add_view_all( $topic_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Allow to be filtered</span></span>&nbsp;</div></li><li><div>      $topic_url = apply_filters( 'bbp_edit_topic_redirect_to', $topic_url, $view_all, $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Successful Edit ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to new topic</span></span></span>&nbsp;</div></li><li><div>      wp_safe_redirect( $topic_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Errors ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $append_error = ( is_wp_error( $topic_id ) && $topic_id-&gt;get_error_message() ) ? $topic_id-&gt;get_error_message() . ' ' : '';&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_topic_error', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found with your topic:' . $append_error . 'Please try again.', 'bbpress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle all the extra meta stuff from posting a new topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool|array $anonymous_data Optional logged-out user data.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $author_id Author id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $is_edit Optional. Is the post being edited? Defaults to false.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To get the forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_current_user_id() To get the current user id</span>&nbsp;</div></li><li><div><span class="comment"> * @yses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic metas</span>&nbsp;</div></li><li><div><span class="comment"> * @uses set_transient() To update the flood check transient for the ip</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_user_last_posted() To update the users last posted time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_subscriptions_active() To check if the subscriptions feature is</span>&nbsp;</div></li><li><div><span class="comment"> *                                      activated or not</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_user_subscribed() To check if the user is subscribed</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_subscription() To remove the user's subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_subscription() To add the user's subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_forum_id() To update the topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_topic_id() To update the topic's topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_reply_id() To update the last reply id topic meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_id() To update the topic last active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_time() To update the last active topic meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count() To update the topic reply count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count_hidden() To udpate the topic hidden reply count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_voice_count() To update the topic voice count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_walker() To udpate the topic's ancestors</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic( $topic_id = 0, $forum_id = 0, $anonymous_data = false, $author_id = 0, $is_edit = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate the ID's passed from 'bbp_new_topic' action</span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $forum_id = bbp_get_forum_id( $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if there is no topic</span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check author_id</span>&nbsp;</div></li><li><div>  if ( empty( $author_id ) )&nbsp;</div></li><li><div>      $author_id = bbp_get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check forum_id</span>&nbsp;</div></li><li><div>  if ( empty( $forum_id ) )&nbsp;</div></li><li><div>      $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If anonymous post, store name, email, website and ip in post_meta.</span>&nbsp;</div></li><li><div>  <span class="comment">// It expects anonymous_data to be sanitized.</span>&nbsp;</div></li><li><div>  <span class="comment">// Check bbp_filter_anonymous_post_data() for sanitization.</span>&nbsp;</div></li><li><div>  if ( !empty( $anonymous_data ) && is_array( $anonymous_data ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse arguments against default values</span></span></span></span>&nbsp;</div></li><li><div>      $r = bbp_parse_args( $anonymous_data, array(&nbsp;</div></li><li><div>          'bbp_anonymous_name' =&gt; '', &nbsp;</div></li><li><div>          'bbp_anonymous_email' =&gt; '', &nbsp;</div></li><li><div>          'bbp_anonymous_website' =&gt; '', &nbsp;</div></li><li><div> ), 'update_topic' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update all anonymous metas</span>&nbsp;</div></li><li><div>      foreach ( $r as $anon_key =&gt; $anon_value ) {&nbsp;</div></li><li><div>          update_post_meta( $topic_id, '_' . $anon_key, (string) $anon_value, false );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set transient for throttle check (only on new, not edit)</span>&nbsp;</div></li><li><div>      if ( empty( $is_edit ) ) {&nbsp;</div></li><li><div>          set_transient( '_bbp_' . bbp_current_author_ip() . '_last_posted', time() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( empty( $is_edit ) && !current_user_can( 'throttle' ) ) {&nbsp;</div></li><li><div>          bbp_update_user_last_posted( $author_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle Subscription Checkbox</span>&nbsp;</div></li><li><div>  if ( bbp_is_subscriptions_active() && !empty( $author_id ) ) {&nbsp;</div></li><li><div>      $subscribed = bbp_is_user_subscribed( $author_id, $topic_id );&nbsp;</div></li><li><div>      $subscheck = ( !empty( $_POST['bbp_topic_subscription'] ) && ( 'bbp_subscribe' === $_POST['bbp_topic_subscription'] ) ) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Subscribed and unsubscribing</span>&nbsp;</div></li><li><div>      if ( true === $subscribed && false === $subscheck ) {&nbsp;</div></li><li><div>          bbp_remove_user_subscription( $author_id, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Subscribing</span>&nbsp;</div></li><li><div>      } elseif ( false === $subscribed && true === $subscheck ) {&nbsp;</div></li><li><div>          bbp_add_user_subscription( $author_id, $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Forum topic meta</span>&nbsp;</div></li><li><div>  bbp_update_topic_forum_id( $topic_id, $forum_id );&nbsp;</div></li><li><div>  bbp_update_topic_topic_id( $topic_id, $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update associated topic values if this is a new topic</span>&nbsp;</div></li><li><div>  if ( empty( $is_edit ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update poster IP if not editing</span>&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_author_ip', bbp_current_author_ip(), false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Last active time</span>&nbsp;</div></li><li><div>      $last_active = current_time( 'mysql' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Reply topic meta</span>&nbsp;</div></li><li><div>      bbp_update_topic_last_reply_id      ( $topic_id, 0 );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_id     ( $topic_id, $topic_id );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_time   ( $topic_id, $last_active );&nbsp;</div></li><li><div>      bbp_update_topic_reply_count        ( $topic_id, 0 );&nbsp;</div></li><li><div>      bbp_update_topic_reply_count_hidden ( $topic_id, 0 );&nbsp;</div></li><li><div>      bbp_update_topic_voice_count        ( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Walk up ancestors and do the dirty work</span>&nbsp;</div></li><li><div>      bbp_update_topic_walker( $topic_id, $last_active, $forum_id, 0, false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Walks up the post_parent tree from the current topic_id, and updates the</span>&nbsp;</div></li><li><div><span class="comment"> * counts of forums above it. This calls a few internal functions that all run</span>&nbsp;</div></li><li><div><span class="comment"> * manual queries against the database to get their results. As such, this</span>&nbsp;</div></li><li><div><span class="comment"> * function can be costly to run but is necessary to keep everything accurate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2800)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $last_active_time Optional. Last active time</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $refresh Reset all the previous parameters? Defaults to true.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_ancestors() To get the topic's ancestors</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum() To check if the ancestor is a forum</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum() To update the forum</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_walker( $topic_id, $last_active_time = '', $forum_id = 0, $reply_id = 0, $refresh = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate topic_id</span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Define local variable(s)</span></span></span></span></span>&nbsp;</div></li><li><div>  $active_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic was passed</span>&nbsp;</div></li><li><div>  if ( !empty( $topic_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the forum ID if none was passed</span>&nbsp;</div></li><li><div>      if ( empty( $forum_id ) ) {&nbsp;</div></li><li><div>          $forum_id = bbp_get_topic_forum_id( $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the active_id based on topic_id/reply_id</span>&nbsp;</div></li><li><div>      $active_id = empty( $reply_id ) ? $topic_id : $reply_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get topic</span></span> ancestors</span></span></span>&nbsp;</div></li><li><div>  $ancestors = array_values( array_unique( array_merge( array( $forum_id ), (array) get_post_ancestors( $topic_id ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic status</span>&nbsp;</div></li><li><div>  $topic_status = get_post_status( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we want a full refresh, unset any of the possibly passed variables</span>&nbsp;</div></li><li><div>  if ( true === $refresh ) {&nbsp;</div></li><li><div>      $forum_id = $topic_id = $reply_id = $active_id = $last_active_time = 0;&nbsp;</div></li><li><div>      $topic_status = bbp_get_public_status_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through ancestors</span>&nbsp;</div></li><li><div>  if ( !empty( $ancestors ) ) {&nbsp;</div></li><li><div>      foreach ( $ancestors as $ancestor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If ancestor is a forum, update counts</span>&nbsp;</div></li><li><div>          if ( bbp_is_forum( $ancestor ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Update the forum</span></span>&nbsp;</div></li><li><div>              bbp_update_forum( array(&nbsp;</div></li><li><div>                  'forum_id' =&gt; $ancestor, &nbsp;</div></li><li><div>                  'last_topic_id' =&gt; $topic_id, &nbsp;</div></li><li><div>                  'last_reply_id' =&gt; $reply_id, &nbsp;</div></li><li><div>                  'last_active_id' =&gt; $active_id, &nbsp;</div></li><li><div>                  'last_active_time' =&gt; 0, &nbsp;</div></li><li><div>                  'last_active_status' =&gt; $topic_status&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle the moving of a topic from one forum to another. This includes walking</span>&nbsp;</div></li><li><div><span class="comment"> * up the old and new branches and updating the counts.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $old_forum_id Old forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $new_forum_id New forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To get the forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_stickies() To get the old forums sticky topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_meta() To delete the forum sticky meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the old forum sticky meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_stick_topic() To stick the topic in the new forum</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_all_child_ids() To get the public child ids</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_forum_id() To update the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_forum_id() To update the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_ancestors() To get the topic's ancestors</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_forum() To check if the ancestor is a forum</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum() To update the forum</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_move_topic_handler( $topic_id, $old_forum_id, $new_forum_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate parameters</span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $old_forum_id = bbp_get_forum_id( $old_forum_id );&nbsp;</div></li><li><div>  $new_forum_id = bbp_get_forum_id( $new_forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update topic</span></span> forum's ID</span>&nbsp;</div></li><li><div>  bbp_update_topic_forum_id( $topic_id, $new_forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Stickies **************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get forum stickies</span>&nbsp;</div></li><li><div>  $old_stickies = bbp_get_stickies( $old_forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only proceed if stickies are found</span>&nbsp;</div></li><li><div>  if ( !empty( $old_stickies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Define local variables</span>&nbsp;</div></li><li><div>      $updated_stickies = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through stickies of forum and add misses to the updated array</span>&nbsp;</div></li><li><div>      foreach ( (array) $old_stickies as $sticky_topic_id ) {&nbsp;</div></li><li><div>          if ( $topic_id !== $sticky_topic_id ) {&nbsp;</div></li><li><div>              $updated_stickies[] = $sticky_topic_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If stickies are different, update or delete them</span>&nbsp;</div></li><li><div>      if ( $updated_stickies !== $old_stickies ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// No more stickies so delete the meta</span>&nbsp;</div></li><li><div>          if ( empty( $updated_stickies ) ) {&nbsp;</div></li><li><div>              delete_post_meta( $old_forum_id, '_bbp_sticky_topics' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Still stickies so update the meta</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_post_meta( $old_forum_id, '_bbp_sticky_topics', $updated_stickies );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Topic was sticky, so restick in new forum</span>&nbsp;</div></li><li><div>          bbp_stick_topic( $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic Replies *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Get the topic</span></span>s replies</span>&nbsp;</div></li><li><div>  $replies = bbp_get_all_child_ids( $topic_id, bbp_get_reply_post_type() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the forum</span></span>_id of all replies in the topic&nbsp;</div></li><li><div>  foreach ( $replies as $reply_id ) {&nbsp;</div></li><li><div>      bbp_update_reply_forum_id( $reply_id, $new_forum_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Old forum_id **********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get topic</span></span> ancestors</span></span></span>&nbsp;</div></li><li><div>  $old_forum_ancestors = array_values( array_unique( array_merge( array( $old_forum_id ), (array) get_post_ancestors( $old_forum_id ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through ancestors</span> and update them&nbsp;</div></li><li><div>  if ( !empty( $old_forum_ancestors ) ) {&nbsp;</div></li><li><div>      foreach ( $old_forum_ancestors as $ancestor ) {&nbsp;</div></li><li><div>          if ( bbp_is_forum( $ancestor ) ) {&nbsp;</div></li><li><div>              bbp_update_forum( array(&nbsp;</div></li><li><div>                  'forum_id' =&gt; $ancestor, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** New forum_id **********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Make sure we're not walking twice</span></span>&nbsp;</div></li><li><div>  if ( !in_array( $new_forum_id, $old_forum_ancestors ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get topic</span></span> ancestors</span></span></span>&nbsp;</div></li><li><div>      $new_forum_ancestors = array_values( array_unique( array_merge( array( $new_forum_id ), (array) get_post_ancestors( $new_forum_id ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Make sure we're not walking twice</span></span>&nbsp;</div></li><li><div>      $new_forum_ancestors = array_diff( $new_forum_ancestors, $old_forum_ancestors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through ancestors</span> and update them&nbsp;</div></li><li><div>      if ( !empty( $new_forum_ancestors ) ) {&nbsp;</div></li><li><div>          foreach ( $new_forum_ancestors as $ancestor ) {&nbsp;</div></li><li><div>              if ( bbp_is_forum( $ancestor ) ) {&nbsp;</div></li><li><div>                  bbp_update_forum( array(&nbsp;</div></li><li><div>                      'forum_id' =&gt; $ancestor, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Merge topic handler</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end merge topic submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2756)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit the topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_merge_topic' with the destination and source</span>&nbsp;</div></li><li><div><span class="comment"> *                    topic ids</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_subscribers() To get the source topic subscribers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_subscription() To add the user subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_subscription() To remove the user subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_favoriters() To get the source topic favoriters</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_favorite() To add the user favorite</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_favorite() To remove the user favorite</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_get_post_terms() To get the source topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_set_post_terms() To set the topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_delete_object_term_relationships() To delete the topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_open_topic() To open the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unstick_topic() To unstick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_posts() To get the replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_topic_id() To update the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_forum_id() To update the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_merged_topic_reply' with the reply id and</span>&nbsp;</div></li><li><div><span class="comment"> *                    destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_merged_topic' with the destination and source</span>&nbsp;</div></li><li><div><span class="comment"> *                    topic ids and source topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic permalink</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic link</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_merge_topic_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not bbp-merge-topic</span>&nbsp;</div></li><li><div>  if ( 'bbp-merge-topic' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Define local variable(s)</span></span></span></span></span>&nbsp;</div></li><li><div>  $source_topic_id = $destination_topic_id = 0;&nbsp;</div></li><li><div>  $source_topic = $destination_topic = 0;&nbsp;</div></li><li><div>  $subscribers = $favoriters = $replies = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Source Topic **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic id</span></span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_topic_id'] ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_source_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Topic ID not found.', 'bbpress' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $source_topic_id = (int) $_POST['bbp_topic_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-merge-topic_' . $source_topic_id ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Source topic not found</span>&nbsp;</div></li><li><div>  } elseif ( !$source_topic = bbp_get_topic( $source_topic_id ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_source_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to merge was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cannot edit source topic</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', $source_topic-&gt;ID ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_source_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the source topic.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Destination Topic *****************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic id</span></span>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_destination_topic'] ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_destination_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Destination topic ID not found.', 'bbpress' ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $destination_topic_id = (int) $_POST['bbp_destination_topic'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Destination topic not found</span>&nbsp;</div></li><li><div>  if ( !$destination_topic = bbp_get_topic( $destination_topic_id ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_destination_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to merge to was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cannot edit destination topic</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', $destination_topic-&gt;ID ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_merge_topic_destination_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the destination topic.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if errors</span></span></span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** No Errors *************************************************************/</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'bbp_merge_topic', $destination_topic-&gt;ID, $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Date Check ************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the destination topic is older than the source topic</span>&nbsp;</div></li><li><div>  if ( strtotime( $source_topic-&gt;post_date ) &lt; strtotime( $destination_topic-&gt;post_date ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set destination topic post_date to 1 second before source topic</span>&nbsp;</div></li><li><div>      $destination_post_date = date( 'Y-m-d H:i:s', strtotime( $source_topic-&gt;post_date ) - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Update destination topic</span></span>&nbsp;</div></li><li><div>      wp_update_post( array(&nbsp;</div></li><li><div>          'ID' =&gt; $destination_topic_id, &nbsp;</div></li><li><div>          'post_date' =&gt; $destination_post_date, &nbsp;</div></li><li><div>          'post_date_gmt' =&gt; get_gmt_from_date( $destination_post_date )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Subscriptions *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get subscribers from source topic</span>&nbsp;</div></li><li><div>  $subscribers = bbp_get_topic_subscribers( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the topic from everybody's subscriptions</span>&nbsp;</div></li><li><div>  if ( !empty( $subscribers ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through each user</span></span>&nbsp;</div></li><li><div>      foreach ( (array) $subscribers as $subscriber ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Shift the subscriber if told to</span>&nbsp;</div></li><li><div>          if ( !empty( $_POST['bbp_topic_subscribers'] ) && ( &quot;1&quot; === $_POST['bbp_topic_subscribers'] ) && bbp_is_subscriptions_active() )&nbsp;</div></li><li><div>              bbp_add_user_subscription( $subscriber, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Remove old subscription</span>&nbsp;</div></li><li><div>          bbp_remove_user_subscription( $subscriber, $source_topic-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Favorites *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get favoriters from source topic</span>&nbsp;</div></li><li><div>  $favoriters = bbp_get_topic_favoriters( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the topic from everybody's favorites</span>&nbsp;</div></li><li><div>  if ( !empty( $favoriters ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through each user</span></span>&nbsp;</div></li><li><div>      foreach ( (array) $favoriters as $favoriter ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Shift the favoriter if told to</span>&nbsp;</div></li><li><div>          if ( !empty( $_POST['bbp_topic_favoriters'] ) && &quot;1&quot; === $_POST['bbp_topic_favoriters'] )&nbsp;</div></li><li><div>              bbp_add_user_favorite( $favoriter, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Remove old favorite</span>&nbsp;</div></li><li><div>          bbp_remove_user_favorite( $favoriter, $source_topic-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Tags ******************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the source topic tags</span></span>&nbsp;</div></li><li><div>  $source_topic_tags = wp_get_post_terms( $source_topic-&gt;ID, bbp_get_topic_tag_tax_id(), array( 'fields' =&gt; 'names' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Tags to possibly merge</span>&nbsp;</div></li><li><div>  if ( !empty( $source_topic_tags ) && !is_wp_error( $source_topic_tags ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shift the tags if told to</span>&nbsp;</div></li><li><div>      if ( !empty( $_POST['bbp_topic_tags'] ) && ( &quot;1&quot; === $_POST['bbp_topic_tags'] ) )&nbsp;</div></li><li><div>          wp_set_post_terms( $destination_topic-&gt;ID, $source_topic_tags, bbp_get_topic_tag_tax_id(), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete the tags from the source topic</span>&nbsp;</div></li><li><div>      wp_delete_object_term_relationships( $source_topic-&gt;ID, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Source Topic **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Status</span>&nbsp;</div></li><li><div>  bbp_open_topic( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sticky</span>&nbsp;</div></li><li><div>  bbp_unstick_topic( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the replies of the source topic</span>&nbsp;</div></li><li><div>  $replies = (array) get_posts( array(&nbsp;</div></li><li><div>      'post_parent' =&gt; $source_topic-&gt;ID, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>      'order' =&gt; 'ASC'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prepend the source topic to its replies array for processing</span>&nbsp;</div></li><li><div>  array_unshift( $replies, $source_topic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $replies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Merge Replies *****************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Change the post_parent of each reply to the destination topic id</span></span>&nbsp;</div></li><li><div>      foreach ( $replies as $reply ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Update the reply</span></span>&nbsp;</div></li><li><div>          wp_update_post( array(&nbsp;</div></li><li><div>              'ID' =&gt; $reply-&gt;ID, &nbsp;</div></li><li><div>              'post_title' =&gt; sprintf( __( 'Reply To: %s', 'bbpress' ), $destination_topic-&gt;post_title ), &nbsp;</div></li><li><div>              'post_name' =&gt; false, &nbsp;</div></li><li><div>              'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>              'post_parent' =&gt; $destination_topic-&gt;ID, &nbsp;</div></li><li><div>              'guid' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Adjust reply meta values</span></span>&nbsp;</div></li><li><div>          bbp_update_reply_topic_id( $reply-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>          bbp_update_reply_forum_id( $reply-&gt;ID, bbp_get_topic_forum_id( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Adjust reply to values</span></span>&nbsp;</div></li><li><div>          $reply_to = bbp_get_reply_to( $reply-&gt;ID );&nbsp;</div></li><li><div>          if ( empty( $reply_to ) ) {&nbsp;</div></li><li><div>              bbp_update_reply_to( $reply-&gt;ID, $source_topic-&gt;ID );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Do additional actions per merged reply</span>&nbsp;</div></li><li><div>          do_action( 'bbp_merged_topic_reply', $reply-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Successful Merge ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update topic</span></span>'s last meta data</span>&nbsp;</div></li><li><div>  bbp_update_topic_last_reply_id   ( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_id  ( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_time( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Send the post parent of the source topic as it has been shifted</span>&nbsp;</div></li><li><div>  <span class="comment">// (possibly to a new forum) so we need to update the counts of the</span>&nbsp;</div></li><li><div>  <span class="comment">// old forum as well as the new one</span>&nbsp;</div></li><li><div>  do_action( 'bbp_merged_topic', $destination_topic-&gt;ID, $source_topic-&gt;ID, $source_topic-&gt;post_parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to new topic</span></span></span>&nbsp;</div></li><li><div>  wp_safe_redirect( bbp_get_topic_permalink( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fix counts on topic merge</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When a topic is merged, update the counts of source and destination topic</span>&nbsp;</div></li><li><div><span class="comment"> * and their forums.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2756)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $destination_topic_id Destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $source_topic_id Source topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $source_topic_forum Source topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_topic_count() To update the forum topic counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_reply_count() To update the forum reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count() To update the topic reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_voice_count() To update the topic voice counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count_hidden() To update the topic hidden reply</span>&nbsp;</div></li><li><div><span class="comment"> *                                              count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_merge_topic_count' with the destination topic</span>&nbsp;</div></li><li><div><span class="comment"> *                    id, source topic id & source topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_merge_topic_count( $destination_topic_id, $source_topic_id, $source_topic_forum_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Source Topic **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum Topic Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_forum_topic_count( $source_topic_forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_forum_reply_count( $source_topic_forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Destination Topic *****************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Hidden Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count_hidden( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Voice Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_voice_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_merge_topic_count', $destination_topic_id, $source_topic_id, $source_topic_forum_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Split topic handler</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end split topic submission</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2756)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit the topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_pre_split_topic' with the from reply id, source</span>&nbsp;</div></li><li><div><span class="comment"> *                    and destination topic ids</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_subscribers() To get the source topic subscribers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_subscription() To add the user subscription</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_favoriters() To get the source topic favoriters</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_user_favorite() To add the user favorite</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_get_post_terms() To get the source topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_set_post_terms() To set the topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare our sql query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_results() To execute the sql query and get results</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_topic_id() To update the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_reply_forum_id() To update the reply forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_split_topic_reply' with the reply id and</span>&nbsp;</div></li><li><div><span class="comment"> *                    destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_reply_id() To update the topic last reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_last_active_time() To update the topic last active meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_post_split_topic' with the destination and</span>&nbsp;</div></li><li><div><span class="comment"> *                    source topic ids and source topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic permalink</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic link</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_split_topic_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if action is not 'bbp-split-topic'</span>&nbsp;</div></li><li><div>  if ( 'bbp-split-topic' !== $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Prevent debug notices</span></span></span>&nbsp;</div></li><li><div>  $from_reply_id = $destination_topic_id = 0;&nbsp;</div></li><li><div>  $destination_topic_title = '';&nbsp;</div></li><li><div>  $destination_topic = $from_reply = $source_topic = '';&nbsp;</div></li><li><div>  $split_option = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Split Reply ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['bbp_reply_id'] ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_reply_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Reply ID to split the topic from not found!', 'bbpress' ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $from_reply_id = (int) $_POST['bbp_reply_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $from_reply = bbp_get_reply( $from_reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reply exists</span>&nbsp;</div></li><li><div>  if ( empty( $from_reply ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_r_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The reply you want to split from was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Topic to Split ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Get the topic</span></span> being split</span>&nbsp;</div></li><li><div>  $source_topic = bbp_get_topic( $from_reply-&gt;post_parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No topic</span>&nbsp;</div></li><li><div>  if ( empty( $source_topic ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_source_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to split was not found.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span> failed&nbsp;</div></li><li><div>  if ( ! bbp_verify_nonce_request( 'bbp-split-topic_' . $source_topic-&gt;ID ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use cannot edit topic</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', $source_topic-&gt;ID ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_source_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the source topic.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// How to Split</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_split_option'] ) )&nbsp;</div></li><li><div>      $split_option = (string) trim( $_POST['bbp_topic_split_option'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Invalid split option</span>&nbsp;</div></li><li><div>  if ( empty( $split_option ) || !in_array( $split_option, array( 'existing', 'reply' ) ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_split_topic_option', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You need to choose a valid split option.', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Valid Split Option</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// What kind of split</span>&nbsp;</div></li><li><div>      switch ( $split_option ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Into an existing topic</span>&nbsp;</div></li><li><div>          case 'existing' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get destination topic id</span>&nbsp;</div></li><li><div>              if ( empty( $_POST['bbp_destination_topic'] ) )&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_split_topic_destination_id', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Destination topic ID not found!', 'bbpress' ) );&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $destination_topic_id = (int) $_POST['bbp_destination_topic'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the destination topic</span>&nbsp;</div></li><li><div>              $destination_topic = bbp_get_topic( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// No destination topic</span>&nbsp;</div></li><li><div>              if ( empty( $destination_topic ) )&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_split_topic_destination_not_found', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The topic you want to split to was not found!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User cannot edit the destination topic</span>&nbsp;</div></li><li><div>              if ( !current_user_can( 'edit_topic', $destination_topic-&gt;ID ) )&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_split_topic_destination_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the destination topic!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Split at reply into a new topic</span>&nbsp;</div></li><li><div>          case 'reply' :&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User needs to be able to publish topics</span>&nbsp;</div></li><li><div>              if ( current_user_can( 'publish_topics' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Use the new title that was passed</span>&nbsp;</div></li><li><div>                  if ( !empty( $_POST['bbp_topic_split_destination_title'] ) ) {&nbsp;</div></li><li><div>                      $destination_topic_title = esc_attr( strip_tags( $_POST['bbp_topic_split_destination_title'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Use the source topic title</span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $destination_topic_title = $source_topic-&gt;post_title;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Update the topic</span></span></span>&nbsp;</div></li><li><div>                  $destination_topic_id = wp_update_post( array(&nbsp;</div></li><li><div>                      'ID' =&gt; $from_reply-&gt;ID, &nbsp;</div></li><li><div>                      'post_title' =&gt; $destination_topic_title, &nbsp;</div></li><li><div>                      'post_name' =&gt; false, &nbsp;</div></li><li><div>                      'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>                      'post_parent' =&gt; $source_topic-&gt;post_parent, &nbsp;</div></li><li><div>                      'menu_order' =&gt; 0, &nbsp;</div></li><li><div>                      'guid' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                  $destination_topic = bbp_get_topic( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Make sure the new topic knows its a topic</span>&nbsp;</div></li><li><div>                  bbp_update_topic_topic_id( $from_reply-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Shouldn't happen</span>&nbsp;</div></li><li><div>                  if ( false === $destination_topic_id || is_wp_error( $destination_topic_id ) || empty( $destination_topic ) ) {&nbsp;</div></li><li><div>                      bbp_add_error( 'bbp_split_topic_destination_reply', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem converting the reply into the topic. Please try again.', 'bbpress' ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// User cannot publish posts</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  bbp_add_error( 'bbp_split_topic_destination_permission', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to create new topics. The reply could not be converted into a topic.', 'bbpress' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if there are errors</span>&nbsp;</div></li><li><div>  if ( bbp_has_errors() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** No Errors - Do the Spit ***********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'bbp_pre_split_topic', $from_reply-&gt;ID, $source_topic-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Date Check ************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the destination topic is older than the from reply</span>&nbsp;</div></li><li><div>  if ( strtotime( $from_reply-&gt;post_date ) &lt; strtotime( $destination_topic-&gt;post_date ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set destination topic post_date to 1 second before from reply</span>&nbsp;</div></li><li><div>      $destination_post_date = date( 'Y-m-d H:i:s', strtotime( $from_reply-&gt;post_date ) - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Update destination topic</span></span>&nbsp;</div></li><li><div>      wp_update_post( array(&nbsp;</div></li><li><div>          'ID' =&gt; $destination_topic_id, &nbsp;</div></li><li><div>          'post_date' =&gt; $destination_post_date, &nbsp;</div></li><li><div>          'post_date_gmt' =&gt; get_gmt_from_date( $destination_post_date )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Subscriptions *********************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the subscribers</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_subscribers'] ) && &quot;1&quot; === $_POST['bbp_topic_subscribers'] && bbp_is_subscriptions_active() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the subscribers</span>&nbsp;</div></li><li><div>      $subscribers = bbp_get_topic_subscribers( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $subscribers ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add subscribers to new topic</span>&nbsp;</div></li><li><div>          foreach ( (array) $subscribers as $subscriber ) {&nbsp;</div></li><li><div>              bbp_add_user_subscription( $subscriber, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Favorites *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the favoriters if told to</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_favoriters'] ) && ( &quot;1&quot; === $_POST['bbp_topic_favoriters'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the favoriters</span>&nbsp;</div></li><li><div>      $favoriters = bbp_get_topic_favoriters( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $favoriters ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add the favoriters to new topic</span>&nbsp;</div></li><li><div>          foreach ( (array) $favoriters as $favoriter ) {&nbsp;</div></li><li><div>              bbp_add_user_favorite( $favoriter, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Tags ******************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the tags if told to</span>&nbsp;</div></li><li><div>  if ( !empty( $_POST['bbp_topic_tags'] ) && ( &quot;1&quot; === $_POST['bbp_topic_tags'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get the source topic tags</span></span>&nbsp;</div></li><li><div>      $source_topic_tags = wp_get_post_terms( $source_topic-&gt;ID, bbp_get_topic_tag_tax_id(), array( 'fields' =&gt; 'names' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $source_topic_tags ) ) {&nbsp;</div></li><li><div>          wp_set_post_terms( $destination_topic-&gt;ID, $source_topic_tags, bbp_get_topic_tag_tax_id(), true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Split Replies *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get_posts() is not used because it doesn't allow us to use '&gt;='</span>&nbsp;</div></li><li><div>  <span class="comment">// comparision without a filter.</span>&nbsp;</div></li><li><div>  $replies = (array) $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT * FROM {$wpdb-&gt;posts} WHERE {$wpdb-&gt;posts}.post_date &gt;= %s AND {$wpdb-&gt;posts}.post_parent = %d AND {$wpdb-&gt;posts}.post_type = %s ORDER BY {$wpdb-&gt;posts}.post_date ASC&quot;, $from_reply-&gt;post_date, $source_topic-&gt;ID, bbp_get_reply_post_type() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure there are replies to loop through</span>&nbsp;</div></li><li><div>  if ( !empty( $replies ) && !is_wp_error( $replies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Calculate starting point for reply positions</span>&nbsp;</div></li><li><div>      switch ( $split_option ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Get topic</span></span> reply count for existing topic</span>&nbsp;</div></li><li><div>          case 'existing' :&nbsp;</div></li><li><div>              $reply_position = bbp_get_topic_reply_count( $destination_topic-&gt;ID );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Account for new lead topic</span>&nbsp;</div></li><li><div>          case 'reply'    :&nbsp;</div></li><li><div>              $reply_position = 1;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save reply ids</span>&nbsp;</div></li><li><div>      $reply_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Change the post_parent of each reply to the destination topic id</span></span>&nbsp;</div></li><li><div>      foreach ( $replies as $reply ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Bump the reply position each iteration through the loop</span>&nbsp;</div></li><li><div>          $reply_position++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Update the reply</span></span>&nbsp;</div></li><li><div>          wp_update_post( array(&nbsp;</div></li><li><div>              'ID' =&gt; $reply-&gt;ID, &nbsp;</div></li><li><div>              'post_title' =&gt; sprintf( __( 'Reply To: %s', 'bbpress' ), $destination_topic-&gt;post_title ), &nbsp;</div></li><li><div>              'post_name' =&gt; false, <span class="comment">// will be automatically generated</span>&nbsp;</div></li><li><div>              'post_parent' =&gt; $destination_topic-&gt;ID, &nbsp;</div></li><li><div>              'menu_order' =&gt; $reply_position, &nbsp;</div></li><li><div>              'guid' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Gather reply ids</span>&nbsp;</div></li><li><div>          $reply_ids[] = $reply-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Adjust reply meta values</span></span>&nbsp;</div></li><li><div>          bbp_update_reply_topic_id( $reply-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>          bbp_update_reply_forum_id( $reply-&gt;ID, bbp_get_topic_forum_id( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Adjust reply to values</span></span>&nbsp;</div></li><li><div>          $reply_to = bbp_get_reply_to( $reply-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Not a reply to a reply that moved over</span>&nbsp;</div></li><li><div>          if ( !in_array( $reply_to, $reply_ids ) ) {&nbsp;</div></li><li><div>              bbp_update_reply_to( $reply-&gt;ID, 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// New topic from reply can't be a reply to</span>&nbsp;</div></li><li><div>          if ( ( $from_reply-&gt;ID === $destination_topic-&gt;ID ) && ( $from_reply-&gt;ID === $reply_to ) ) {&nbsp;</div></li><li><div>              bbp_update_reply_to( $reply-&gt;ID, 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Do additional actions per split reply</span>&nbsp;</div></li><li><div>          do_action( 'bbp_split_topic_reply', $reply-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove reply to from new topic</span>&nbsp;</div></li><li><div>      if ( $from_reply-&gt;ID === $destination_topic-&gt;ID ) {&nbsp;</div></li><li><div>          delete_post_meta( $from_reply-&gt;ID, '_bbp_reply_to' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the last reply ID and freshness</span>&nbsp;</div></li><li><div>      $last_reply_id = $reply-&gt;ID;&nbsp;</div></li><li><div>      $freshness = $reply-&gt;post_date;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the last reply ID and freshness</span> to the from_reply&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $last_reply_id = $from_reply-&gt;ID;&nbsp;</div></li><li><div>      $freshness = $from_reply-&gt;post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It is a new topic and we need to set some default metas to make</span>&nbsp;</div></li><li><div>  <span class="comment">// the topic display in bbp_has_topics() list</span>&nbsp;</div></li><li><div>  if ( 'reply' === $split_option ) {&nbsp;</div></li><li><div>      bbp_update_topic_last_reply_id   ( $destination_topic-&gt;ID, $last_reply_id );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_id  ( $destination_topic-&gt;ID, $last_reply_id );&nbsp;</div></li><li><div>      bbp_update_topic_last_active_time( $destination_topic-&gt;ID, $freshness );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update source topic ID last active</span>&nbsp;</div></li><li><div>  bbp_update_topic_last_reply_id   ( $source_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_id  ( $source_topic-&gt;ID );&nbsp;</div></li><li><div>  bbp_update_topic_last_active_time( $source_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Successful Split ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'bbp_post_split_topic', $from_reply-&gt;ID, $source_topic-&gt;ID, $destination_topic-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to the topic</span>&nbsp;</div></li><li><div>  wp_safe_redirect( bbp_get_topic_permalink( $destination_topic-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fix counts on topic split</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When a topic is split, update the counts of source and destination topic</span>&nbsp;</div></li><li><div><span class="comment"> * and their forums.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2756)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $from_reply_id From reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $source_topic_id Source topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $destination_topic_id Destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_topic_count() To update the forum topic counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_forum_reply_count() To update the forum reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count() To update the topic reply counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_voice_count() To update the topic voice counts</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_update_topic_reply_count_hidden() To update the topic hidden reply</span>&nbsp;</div></li><li><div><span class="comment"> *                                              count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_split_topic_count' with the from reply id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    source topic id & destination topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_split_topic_count( $from_reply_id, $source_topic_id, $destination_topic_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum Topic Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_forum_topic_count( bbp_get_topic_forum_id( $destination_topic_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Forum Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_forum_reply_count( bbp_get_topic_forum_id( $destination_topic_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_reply_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Hidden Reply Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_reply_count_hidden( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_reply_count_hidden( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic Voice Counts</span></span>&nbsp;</div></li><li><div>  bbp_update_topic_voice_count( $source_topic_id );&nbsp;</div></li><li><div>  bbp_update_topic_voice_count( $destination_topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_split_topic_count', $from_reply_id, $source_topic_id, $destination_topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end tag management (renaming, merging, destroying)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2768)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_verify_nonce_request() To verify the nonce and check the request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can edit/delete tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_add_error() To add an error message</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_term() To update the topic tag</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_term_link() To get the topic tag url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses term_exists() To check if the topic tag already exists</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_term() To insert a topic tag</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_delete_term() To delete the topic tag</span>&nbsp;</div></li><li><div><span class="comment"> * @uses home_url() To get the blog's home page url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls actions based on the actions with associated args</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error() To check if the value retrieved is a {@link WP_Error}</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the url</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_edit_topic_tag_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if required POST actions aren't passed</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['tag-id'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup possible get actions</span></span>&nbsp;</div></li><li><div>  $possible_actions = array(&nbsp;</div></li><li><div>      'bbp-update-topic-tag', &nbsp;</div></li><li><div>      'bbp-merge-topic-tag', &nbsp;</div></li><li><div>      'bbp-delete-topic-tag'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if actions aren't meant for this function</span></span>&nbsp;</div></li><li><div>  if ( !in_array( $action, $possible_actions ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup vars</span>&nbsp;</div></li><li><div>  $tag_id = (int) $_POST['tag-id'];&nbsp;</div></li><li><div>  $tag = get_term( $tag_id, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Tag does not exist</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $tag ) && $tag-&gt;get_error_message() ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_manage_topic_invalid_tag', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found while getting the tag: %s', 'bbpress' ), $tag-&gt;get_error_message() ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// What action are we trying to perform?</span></span>&nbsp;</div></li><li><div>  switch ( $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update tag</span>&nbsp;</div></li><li><div>      case 'bbp-update-topic-tag' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! bbp_verify_nonce_request( 'update-tag_' . $tag_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_update_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Can user edit topic tags?</span></span>&nbsp;</div></li><li><div>          if ( !current_user_can( 'edit_topic_tags' ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_update_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the topic tags.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// No tag name was provided</span></span>&nbsp;</div></li><li><div>          if ( empty( $_POST['tag-name'] ) || !$name = $_POST['tag-name'] ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_update_name', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You need to enter a tag name.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Attempt to update the tag</span>&nbsp;</div></li><li><div>          $slug = !empty( $_POST['tag-slug'] ) ? $_POST['tag-slug'] : '';&nbsp;</div></li><li><div>          $tag = wp_update_term( $tag_id, bbp_get_topic_tag_tax_id(), array( 'name' =&gt; $name, 'slug' =&gt; $slug ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Cannot update tag</span>&nbsp;</div></li><li><div>          if ( is_wp_error( $tag ) && $tag-&gt;get_error_message() ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_update_error', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found while updating the tag: %s', 'bbpress' ), $tag-&gt;get_error_message() ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Redirect</span></span>&nbsp;</div></li><li><div>          $redirect = get_term_link( $tag_id, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'bbp_update_topic_tag', $tag_id, $tag, $name, $slug );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Merge two tags</span>&nbsp;</div></li><li><div>      case 'bbp-merge-topic-tag'  :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! bbp_verify_nonce_request( 'merge-tag_' . $tag_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Can user edit topic tags?</span></span>&nbsp;</div></li><li><div>          if ( !current_user_can( 'edit_topic_tags' ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to edit the topic tags.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// No tag name was provided</span></span>&nbsp;</div></li><li><div>          if ( empty( $_POST['tag-existing-name'] ) || !$name = $_POST['tag-existing-name'] ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_name', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You need to enter a tag name.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If term does not exist, create it</span>&nbsp;</div></li><li><div>          if ( !$tag = term_exists( $name, bbp_get_topic_tag_tax_id() ) )&nbsp;</div></li><li><div>              $tag = wp_insert_term( $name, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Problem inserting the new term</span>&nbsp;</div></li><li><div>          if ( is_wp_error( $tag ) && $tag-&gt;get_error_message() ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_error', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found while merging the tags: %s', 'bbpress' ), $tag-&gt;get_error_message() ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Merging in to...</span>&nbsp;</div></li><li><div>          $to_tag = $tag['term_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Attempting to merge a tag into itself</span>&nbsp;</div></li><li><div>          if ( $tag_id === $to_tag ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_same', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The tags which are being merged can not be the same.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Delete the old term</span>&nbsp;</div></li><li><div>          $tag = wp_delete_term( $tag_id, bbp_get_topic_tag_tax_id(), array( 'default' =&gt; $to_tag, 'force_default' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Error merging the terms</span>&nbsp;</div></li><li><div>          if ( is_wp_error( $tag ) && $tag-&gt;get_error_message() ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_merge_error', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found while merging the tags: %s', 'bbpress' ), $tag-&gt;get_error_message() ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Redirect</span></span>&nbsp;</div></li><li><div>          $redirect = get_term_link( (int) $to_tag, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'bbp_merge_topic_tag', $tag_id, $to_tag, $tag );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete tag</span>&nbsp;</div></li><li><div>      case 'bbp-delete-topic-tag' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Nonce check</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! bbp_verify_nonce_request( 'delete-tag_' . $tag_id ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_delete_nonce', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Are you sure you wanted to do that?', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Can user delete topic tags?</span>&nbsp;</div></li><li><div>          if ( !current_user_can( 'delete_topic_tags' ) ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_delete_permissions', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: You do not have the permissions to delete the topic tags.', 'bbpress' ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Attempt to delete term</span>&nbsp;</div></li><li><div>          $tag = wp_delete_term( $tag_id, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Error deleting term</span>&nbsp;</div></li><li><div>          if ( is_wp_error( $tag ) && $tag-&gt;get_error_message() ) {&nbsp;</div></li><li><div>              bbp_add_error( 'bbp_manage_topic_tag_delete_error', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The following problem(s) have been found while deleting the tag: %s', 'bbpress' ), $tag-&gt;get_error_message() ) );&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We don't have any other place to go other than home! Or we may die because of the 404 disease</span>&nbsp;</div></li><li><div>          $redirect = home_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Update counts, etc...</span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'bbp_delete_topic_tag', $tag_id, $tag );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Successful Moderation *************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Redirect</span></span> back&nbsp;</div></li><li><div>  $redirect = ( !empty( $redirect ) && !is_wp_error( $redirect ) ) ? $redirect : home_url();&nbsp;</div></li><li><div>  wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Helpers *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return an associative array of available topic statuses</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5059)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_topic_statuses() {&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_topic_statuses', array(&nbsp;</div></li><li><div>      bbp_get_public_status_id() =&gt; _x( 'Open', 'Open the topic', 'bbpress' ), &nbsp;</div></li><li><div>      bbp_get_closed_status_id() =&gt; _x( 'Closed', 'Close the topic', 'bbpress' ), &nbsp;</div></li><li><div>      bbp_get_spam_status_id() =&gt; _x( 'Spam', 'Spam the topic', 'bbpress' ), &nbsp;</div></li><li><div>      bbp_get_trash_status_id() =&gt; _x( 'Trash', 'Trash the topic', 'bbpress' ), &nbsp;</div></li><li><div>      bbp_get_pending_status_id() =&gt; _x( 'Pending', 'Mark topic as pending', 'bbpress' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return an associative array of topic sticky types</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5059)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_topic_types() {&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_topic_types', array(&nbsp;</div></li><li><div>      'unstick' =&gt; _x( 'Normal', 'Unstick a topic', 'bbpress' ), &nbsp;</div></li><li><div>      'stick' =&gt; _x( 'Sticky', 'Make topic sticky', 'bbpress' ), &nbsp;</div></li><li><div>      'super' =&gt; _x( 'Super Sticky', 'Make topic super sticky', 'bbpress' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Stickies ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return sticky topics of a forum</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2592)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. If not passed, super stickies are returned.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_super_stickies() To get the super stickies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the forum stickies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_stickies' with the stickies and forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @return array IDs of sticky topics of a forum or super stickies</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_stickies( $forum_id = 0 ) {&nbsp;</div></li><li><div>  $stickies = empty( $forum_id ) ? bbp_get_super_stickies() : get_post_meta( $forum_id, '_bbp_sticky_topics', true );&nbsp;</div></li><li><div>  $stickies = ( empty( $stickies ) || !is_array( $stickies ) ) ? array() : $stickies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_stickies', $stickies, (int) $forum_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return topics stuck to front page of the forums</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2592)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get super sticky topics</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_super_stickies' with the stickies</span>&nbsp;</div></li><li><div><span class="comment"> * @return array IDs of super sticky topics</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_super_stickies() {&nbsp;</div></li><li><div>  $stickies = get_option( '_bbp_super_sticky_topics', array() );&nbsp;</div></li><li><div>  $stickies = ( empty( $stickies ) || !is_array( $stickies ) ) ? array() : $stickies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_super_stickies', $stickies );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Topics Actions ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the front end opening/closing, spamming/unspamming, </span>&nbsp;</div></li><li><div><span class="comment"> * sticking/unsticking and trashing/untrashing/deleting of topics</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2727)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action The requested action to compare this function to</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the user is capable of editing or</span>&nbsp;</div></li><li><div><span class="comment"> *                           deleting the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_ajax_referer() To verify the nonce and check the referer</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_open() To check if the topic is open</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_close_topic() To close the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_open_topic() To open the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_sticky() To check if the topic is a sticky</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unstick_topic() To unstick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_stick_topic() To stick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_spam() To check if the topic is marked as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_spam_topic() To make the topic as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unspam_topic() To unmark the topic as spam</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_trash_post() To trash the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_untrash_post() To untrash the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_delete_post() To delete the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_toggle_topic_handler' with success, post data</span>&nbsp;</div></li><li><div><span class="comment"> *                    and action</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_permalink() To get the forum link</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink() To get the topic link</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect() To redirect to the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbPress::errors:add() To log the error messages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_toggle_topic_handler( $action = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if required GET actions aren't passed</span>&nbsp;</div></li><li><div>  if ( empty( $_GET['topic_id'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup possible get actions</span></span>&nbsp;</div></li><li><div>  $possible_actions = array(&nbsp;</div></li><li><div>      'bbp_toggle_topic_close', &nbsp;</div></li><li><div>      'bbp_toggle_topic_stick', &nbsp;</div></li><li><div>      'bbp_toggle_topic_spam', &nbsp;</div></li><li><div>      'bbp_toggle_topic_trash'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if actions aren't meant for this function</span></span>&nbsp;</div></li><li><div>  if ( !in_array( $action, $possible_actions ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $failure = '';                         <span class="comment">// Empty failure string</span>&nbsp;</div></li><li><div>  $view_all = false;                      <span class="comment">// Assume not viewing all</span>&nbsp;</div></li><li><div>  $topic_id = (int) $_GET['topic_id'];    <span class="comment">// What's the topic id?</span>&nbsp;</div></li><li><div>  $success = false;                      <span class="comment">// Flag</span>&nbsp;</div></li><li><div>  $post_data = array( 'ID' =&gt; $topic_id ); <span class="comment">// Prelim array</span>&nbsp;</div></li><li><div>  $redirect = '';                         <span class="comment">// Empty redirect URL</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure topic exists</span>&nbsp;</div></li><li><div>  $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  if ( empty( $topic ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// What is the user doing here?</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', $topic-&gt;ID ) || ( 'bbp_toggle_topic_trash' === $action && !current_user_can( 'delete_topic', $topic-&gt;ID ) ) ) {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_toggle_topic_permission', __( '&lt;strong&gt;ERROR:&lt;/strong&gt; You do not have the permission to do that.', 'bbpress' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// What action are we trying to perform?</span></span>&nbsp;</div></li><li><div>  switch ( $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle open/close</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_topic_close' :&nbsp;</div></li><li><div>          check_ajax_referer( 'close-topic_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_open = bbp_is_topic_open( $topic_id );&nbsp;</div></li><li><div>          $success = true === $is_open ? bbp_close_topic( $topic_id ) : bbp_open_topic( $topic_id );&nbsp;</div></li><li><div>          $failure = true === $is_open ? __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem closing the topic.', 'bbpress' ) : __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem opening the topic.', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle sticky/super-sticky/unstick</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_topic_stick' :&nbsp;</div></li><li><div>          check_ajax_referer( 'stick-topic_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_sticky = bbp_is_topic_sticky( $topic_id );&nbsp;</div></li><li><div>          $is_super = false === $is_sticky && !empty( $_GET['super'] ) && ( &quot;1&quot; === $_GET['super'] ) ? true : false;&nbsp;</div></li><li><div>          $success = true === $is_sticky ? bbp_unstick_topic( $topic_id ) : bbp_stick_topic( $topic_id, $is_super );&nbsp;</div></li><li><div>          $failure = true === $is_sticky ? __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem unsticking the topic.', 'bbpress' ) : __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem sticking the topic.', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle spam</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_topic_spam' :&nbsp;</div></li><li><div>          check_ajax_referer( 'spam-topic_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_spam = bbp_is_topic_spam( $topic_id );&nbsp;</div></li><li><div>          $success = true === $is_spam ? bbp_unspam_topic( $topic_id ) : bbp_spam_topic( $topic_id );&nbsp;</div></li><li><div>          $failure = true === $is_spam ? __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem unmarking the topic as spam.', 'bbpress' ) : __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem marking the topic as spam.', 'bbpress' );&nbsp;</div></li><li><div>          $view_all = !$is_spam;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Toggle trash</span>&nbsp;</div></li><li><div>      case 'bbp_toggle_topic_trash' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sub_action = !empty( $_GET['sub_action'] ) && in_array( $_GET['sub_action'], array( 'trash', 'untrash', 'delete' ) ) ? $_GET['sub_action'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $sub_action ) )&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $sub_action ) {&nbsp;</div></li><li><div>              case 'trash':&nbsp;</div></li><li><div>                  check_ajax_referer( 'trash-' . bbp_get_topic_post_type() . '_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $view_all = true;&nbsp;</div></li><li><div>                  $success = wp_trash_post( $topic_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem trashing the topic.', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'untrash':&nbsp;</div></li><li><div>                  check_ajax_referer( 'untrash-' . bbp_get_topic_post_type() . '_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $success = wp_untrash_post( $topic_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem untrashing the topic.', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'delete':&nbsp;</div></li><li><div>                  check_ajax_referer( 'delete-' . bbp_get_topic_post_type() . '_' . $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $success = wp_delete_post( $topic_id );&nbsp;</div></li><li><div>                  $failure = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: There was a problem deleting the topic.', 'bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do additional topic toggle actions</span>&nbsp;</div></li><li><div>  do_action( 'bbp_toggle_topic_handler', $success, $post_data, $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No errors</span>&nbsp;</div></li><li><div>  if ( false !== $success && !is_wp_error( $success ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to the topic</span>'s forum&nbsp;</div></li><li><div>      if ( isset( $sub_action ) && ( 'delete' === $sub_action ) ) {&nbsp;</div></li><li><div>          $redirect = bbp_get_forum_permalink( $success-&gt;post_parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Redirect</span></span> back to the topic</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the redirect detination</span>&nbsp;</div></li><li><div>          $permalink = bbp_get_topic_permalink( $topic_id );&nbsp;</div></li><li><div>          $redirect = bbp_add_view_all( $permalink, $view_all );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// For good measure</span></span></span></span></span></span>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle errors</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_toggle_topic', $failure );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Favorites & Subscriptions *************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove a deleted topic from all users' favorites</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2652)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Get the topic id to remove</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_favoriters() To get the topic's favoriters</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_favorite() To remove the topic from user's favorites</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_remove_topic_from_all_favorites( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if no topic</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get users</span></span>&nbsp;</div></li><li><div>  $users = (array) bbp_get_topic_favoriters( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Users exist</span></span>&nbsp;</div></li><li><div>  if ( !empty( $users ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through users</span></span>&nbsp;</div></li><li><div>      foreach ( $users as $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Remove each user</span></span>&nbsp;</div></li><li><div>          bbp_remove_user_favorite( $user, $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove a deleted topic from all users' subscriptions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2652)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Get the topic id to remove</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_subscriptions_active() To check if the subscriptions are active</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_subscribers() To get the topic subscribers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_remove_user_subscription() To remove the user subscription</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_remove_topic_from_all_subscriptions( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Subscriptions are not active</span>&nbsp;</div></li><li><div>  if ( !bbp_is_subscriptions_active() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if no topic</span></span>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get users</span></span>&nbsp;</div></li><li><div>  $users = (array) bbp_get_topic_subscribers( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Users exist</span></span>&nbsp;</div></li><li><div>  if ( !empty( $users ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through users</span></span>&nbsp;</div></li><li><div>      foreach ( $users as $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Remove each user</span></span>&nbsp;</div></li><li><div>          bbp_remove_user_subscription( $user, $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Count Bumpers *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Bump the total reply count of a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3825)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Forum id.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $difference Optional. Default 1</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $update_ancestors Optional. Default true</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic's reply count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_bump_topic_reply_count' with the reply</span>&nbsp;</div></li><li><div><span class="comment"> *                        count, topic id, and difference</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Forum reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_bump_topic_reply_count( $topic_id = 0, $difference = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get counts</span></span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $reply_count = bbp_get_topic_reply_count( $topic_id, true );&nbsp;</div></li><li><div>  $new_count = (int) $reply_count + (int) $difference;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update this topic id's reply count</span>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_reply_count', (int) $new_count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_bump_topic_reply_count', (int) $new_count, $topic_id, (int) $difference );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Bump the total hidden reply count of a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3825)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Forum id.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $difference Optional. Default 1</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic's reply count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_bump_topic_reply_count_hidden' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        reply count, topic id, and difference</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Forum hidden reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_bump_topic_reply_count_hidden( $topic_id = 0, $difference = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get counts</span></span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $reply_count = bbp_get_topic_reply_count_hidden( $topic_id, true );&nbsp;</div></li><li><div>  $new_count = (int) $reply_count + (int) $difference;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update this topic id's hidder reply count</span>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_reply_count_hidden', (int) $new_count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_bump_topic_reply_count_hidden', (int) $new_count, $topic_id, (int) $difference );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Topic Updaters ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the topic's forum id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2855)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id Optional. Forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() TO check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_field() To get the post parent of the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To get the forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic forum id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_forum_id' with the forum id</span>&nbsp;</div></li><li><div><span class="comment"> *                        and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Forum id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_forum_id( $topic_id = 0, $forum_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $forum_id ) ) {&nbsp;</div></li><li><div>      $forum_id = get_post_field( 'post_parent', $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_forum_id', (int) $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_forum_id', (int) $forum_id, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the topic's topic id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2954)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic's topic id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_topic_id' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_topic_id( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_topic_id', (int) $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_topic_id', (int) $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adjust the total reply count of a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2467)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_count Optional. Set the reply count manually.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_public_child_count() To get the reply count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic reply count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_reply_count' with the reply</span>&nbsp;</div></li><li><div><span class="comment"> *                        count and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Topic reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_reply_count( $topic_id = 0, $reply_count = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get replies of topic</span> if not passed</span>&nbsp;</div></li><li><div>  if ( empty( $reply_count ) ) {&nbsp;</div></li><li><div>      $reply_count = bbp_get_public_child_count( $topic_id, bbp_get_reply_post_type() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_reply_count', (int) $reply_count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_reply_count', (int) $reply_count, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adjust the total hidden reply count of a topic (hidden includes trashed and spammed replies)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_count Optional. Set the reply count manually</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare our sql query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_var() To execute our query and get the var back</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic hidden reply count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_reply_count_hidden' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        hidden reply count and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Topic hidden reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_reply_count_hidden( $topic_id = 0, $reply_count = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get replies of topic</span>&nbsp;</div></li><li><div>  if ( empty( $reply_count ) ) {&nbsp;</div></li><li><div>      $post_status = &quot;'&quot; . implode( &quot;', '&quot;, array( bbp_get_trash_status_id(), bbp_get_spam_status_id() ) ) . &quot;'&quot;;&nbsp;</div></li><li><div>      $reply_count = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT(ID) FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_status IN ( {$post_status} ) AND post_type = '%s';&quot;, $topic_id, bbp_get_reply_post_type() ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_reply_count_hidden', (int) $reply_count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_reply_count_hidden', (int) $reply_count, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the topic with the last active post ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2888)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $active_id Optional. active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_public_child_last_id() To get the last public reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_active_id() To get the active id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic last active id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_last_active_id' with the active</span>&nbsp;</div></li><li><div><span class="comment"> *                        id and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Active id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_last_active_id( $topic_id = 0, $active_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $active_id ) ) {&nbsp;</div></li><li><div>      $active_id = bbp_get_public_child_last_id( $topic_id, bbp_get_reply_post_type() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Adjust last_id's based on last_reply post_type</span></span>&nbsp;</div></li><li><div>  if ( empty( $active_id ) || !bbp_is_reply( $active_id ) ) {&nbsp;</div></li><li><div>      $active_id = $topic_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update only if published</span></span>&nbsp;</div></li><li><div>  if ( bbp_get_public_status_id() === get_post_status( $active_id ) ) {&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_last_active_id', (int) $active_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_last_active_id', (int) $active_id, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the topics last active date/time (aka freshness)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2680)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_time Optional. New time in mysql format</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_time() To get the current time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic last active meta</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_last_active_time( $topic_id = 0, $new_time = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check time and use current if empty</span>&nbsp;</div></li><li><div>  if ( empty( $new_time ) ) {&nbsp;</div></li><li><div>      $new_time = get_post_field( 'post_date', bbp_get_public_child_last_id( $topic_id, bbp_get_reply_post_type() ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update only if published</span></span>&nbsp;</div></li><li><div>  if ( !empty( $new_time ) ) {&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_last_active_time', $new_time );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_last_active_time', $new_time, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the topic with the most recent reply ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2625)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id Optional. Reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_public_child_last_id() To get the last public reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic last reply id meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_last_reply_id' with the reply</span>&nbsp;</div></li><li><div><span class="comment"> *                        id and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Reply id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_last_reply_id( $topic_id = 0, $reply_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) && bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $reply_id = bbp_get_reply_id( $topic_id );&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $reply_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) ) {&nbsp;</div></li><li><div>      $reply_id = bbp_get_public_child_last_id( $topic_id, bbp_get_reply_post_type() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Adjust last_id's based on last_reply post_type</span></span>&nbsp;</div></li><li><div>  if ( empty( $reply_id ) || !bbp_is_reply( $reply_id ) ) {&nbsp;</div></li><li><div>      $reply_id = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update if reply is published</span>&nbsp;</div></li><li><div>  if ( bbp_is_reply_published( $reply_id ) ) {&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_last_reply_id', (int) $reply_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_last_reply_id', (int) $reply_id, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adjust the total voice count of a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2567)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare our sql query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_col() To execute our query and get the column back</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic voice count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_voice_count' with the voice</span>&nbsp;</div></li><li><div><span class="comment"> *                        count and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Voice count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_voice_count( $topic_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } elseif ( bbp_is_topic( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Query the DB to get voices in this topic</span>&nbsp;</div></li><li><div>  $voices = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT COUNT( DISTINCT post_author ) FROM {$wpdb-&gt;posts} WHERE ( post_parent = %d AND post_status = '%s' AND post_type = '%s' ) OR ( ID = %d AND post_type = '%s' );&quot;, $topic_id, bbp_get_public_status_id(), bbp_get_reply_post_type(), $topic_id, bbp_get_topic_post_type() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If there's an error, make sure we have at least have 1 voice</span>&nbsp;</div></li><li><div>  $voices = ( empty( $voices ) || is_wp_error( $voices ) ) ? 1 : $voices[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the voice count for this topic id</span>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_voice_count', (int) $voices );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_voice_count', (int) $voices, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adjust the total anonymous reply count of a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2567)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id to update</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply() To check if the passed topic id is a reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_topic_id() To get the reply topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare our sql query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_col() To execute our query and get the column back</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic anonymous reply count meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_update_topic_anonymous_reply_count' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        anonymous reply count and topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Anonymous reply count</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_anonymous_reply_count( $topic_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// If it's a reply, then get the parent (topic id)</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( bbp_is_reply( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_reply_topic_id( $topic_id );&nbsp;</div></li><li><div>  } elseif ( bbp_is_topic( $topic_id ) ) {&nbsp;</div></li><li><div>      $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $anonymous_replies = (int) $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT( ID ) FROM {$wpdb-&gt;posts} WHERE ( post_parent = %d AND post_status = '%s' AND post_type = '%s' AND post_author = 0 ) OR ( ID = %d AND post_type = '%s' AND post_author = 0 );&quot;, $topic_id, bbp_get_public_status_id(), bbp_get_reply_post_type(), $topic_id, bbp_get_topic_post_type() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $topic_id, '_bbp_anonymous_reply_count', (int) $anonymous_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_update_topic_anonymous_reply_count', (int) $anonymous_replies, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the revision log of the topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2782)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $args Supports these args:</span>&nbsp;</div></li><li><div><span class="comment"> *  - topic_id: Topic id</span>&nbsp;</div></li><li><div><span class="comment"> *  - author_id: Author id</span>&nbsp;</div></li><li><div><span class="comment"> *  - reason: Reason for editing</span>&nbsp;</div></li><li><div><span class="comment"> *  - revision_id: Revision id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_format_revision_reason() To format the reason</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_raw_revision_log() To get the raw topic revision log</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the topic revision log meta</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False on failure, true on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_update_topic_revision_log( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse arguments against default values</span></span></span></span>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $args, array(&nbsp;</div></li><li><div>      'reason' =&gt; '', &nbsp;</div></li><li><div>      'topic_id' =&gt; 0, &nbsp;</div></li><li><div>      'author_id' =&gt; 0, &nbsp;</div></li><li><div>      'revision_id' =&gt; 0&nbsp;</div></li><li><div> ), 'update_topic_revision_log' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Populate the variables</span>&nbsp;</div></li><li><div>  $r['reason'] = bbp_format_revision_reason( $r['reason'] );&nbsp;</div></li><li><div>  $r['topic_id'] = bbp_get_topic_id( $r['topic_id'] );&nbsp;</div></li><li><div>  $r['author_id'] = bbp_get_user_id ( $r['author_id'], false, true );&nbsp;</div></li><li><div>  $r['revision_id'] = (int) $r['revision_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the logs and append the new one to those</span>&nbsp;</div></li><li><div>  $revision_log = bbp_get_topic_raw_revision_log( $r['topic_id'] );&nbsp;</div></li><li><div>  $revision_log[ $r['revision_id'] ] = array( 'author' =&gt; $r['author_id'], 'reason' =&gt; $r['reason'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally, update</span>&nbsp;</div></li><li><div>  return update_post_meta( $r['topic_id'], '_bbp_revision_log', $revision_log );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Topic Actions *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Closes a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_close_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_post_meta() To add the previous status to a meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic with the new status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_opened_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, topic id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_close_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get topic</span></span>&nbsp;</div></li><li><div>  $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  if ( empty( $topic ) )&nbsp;</div></li><li><div>      return $topic;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if already closed</span>&nbsp;</div></li><li><div>  if ( bbp_get_closed_status_id() === $topic-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre close code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_close_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add pre close status</span>&nbsp;</div></li><li><div>  add_post_meta( $topic_id, '_bbp_status', $topic-&gt;post_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set closed status</span>&nbsp;</div></li><li><div>  $topic-&gt;post_status = bbp_get_closed_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No revisions</span></span></span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update topic</span></span>&nbsp;</div></li><li><div>  $topic_id = wp_update_post( $topic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post close code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_closed_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Return topic_id</span></span></span></span>&nbsp;</div></li><li><div>  return $topic_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Opens a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_open_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the previous status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_meta() To delete the previous status meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic with the new status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_opened_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, topic id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_open_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get topic</span></span>&nbsp;</div></li><li><div>  $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  if ( empty( $topic ) )&nbsp;</div></li><li><div>      return $topic;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if already open</span>&nbsp;</div></li><li><div>  if ( bbp_get_closed_status_id() !== $topic-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre open code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_open_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get previous status</span>&nbsp;</div></li><li><div>  $topic_status = get_post_meta( $topic_id, '_bbp_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set previous status</span>&nbsp;</div></li><li><div>  $topic-&gt;post_status = $topic_status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove old status meta</span>&nbsp;</div></li><li><div>  delete_post_meta( $topic_id, '_bbp_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No revisions</span></span></span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update topic</span></span>&nbsp;</div></li><li><div>  $topic_id = wp_update_post( $topic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post open code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_opened_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Return topic_id</span></span></span></span>&nbsp;</div></li><li><div>  return $topic_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Marks a topic as spam</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_spam_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_post_meta() To add the previous status to a meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic with the new status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_spammed_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, topic id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_spam_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the topic</span></span>&nbsp;</div></li><li><div>  $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  if ( empty( $topic ) )&nbsp;</div></li><li><div>      return $topic;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if topic is spam</span>&nbsp;</div></li><li><div>  if ( bbp_get_spam_status_id() === $topic-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre spam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_spam_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Trash Replies *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic is being spammed, so its replies are trashed</span>&nbsp;</div></li><li><div>  $replies = new WP_Query( array(&nbsp;</div></li><li><div>      'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'post_status' =&gt; bbp_get_public_status_id(), &nbsp;</div></li><li><div>      'post_parent' =&gt; $topic_id, &nbsp;</div></li><li><div>      'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>      'nopaging' =&gt; true, &nbsp;</div></li><li><div>      'fields' =&gt; 'id=&gt;parent'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $replies-&gt;posts ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Prevent debug notices</span></span></span>&nbsp;</div></li><li><div>      $pre_spammed_replies = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Loop through replies</span></span>, trash them, and add them to array</span>&nbsp;</div></li><li><div>      foreach ( $replies-&gt;posts as $reply ) {&nbsp;</div></li><li><div>          wp_trash_post( $reply-&gt;ID );&nbsp;</div></li><li><div>          $pre_spammed_replies[] = $reply-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Set a post_meta entry of the replies that were trashed by this action.</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// This is so we can possibly untrash them, without untrashing replies</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// that were purposefully trashed before.</span></span>&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_pre_spammed_replies', $pre_spammed_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Reset the $post global</span></span></span>&nbsp;</div></li><li><div>      wp_reset_postdata();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span>&nbsp;</div></li><li><div>  unset( $replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add the original post status as post meta for future restoration</span></span>&nbsp;</div></li><li><div>  add_post_meta( $topic_id, '_bbp_spam_meta_status', $topic-&gt;post_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get topic</span></span> tags&nbsp;</div></li><li><div>  $terms = get_the_terms( $topic_id, bbp_get_topic_tag_tax_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Define local variable(s)</span></span></span></span></span>&nbsp;</div></li><li><div>  $term_names = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic has tags</span>&nbsp;</div></li><li><div>  if ( !empty( $terms ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through and collect term names</span>&nbsp;</div></li><li><div>      foreach ( $terms as $term ) {&nbsp;</div></li><li><div>          $term_names[] = $term-&gt;name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Topic terms have slugs</span>&nbsp;</div></li><li><div>      if ( !empty( $term_names ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Add the original post status as post meta for future restoration</span></span>&nbsp;</div></li><li><div>          add_post_meta( $topic_id, '_bbp_spam_topic_tags', $term_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Empty the topic of its tags</span>&nbsp;</div></li><li><div>          $topic-&gt;tax_input = array( bbp_get_topic_tag_tax_id() =&gt; '' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set post status to spam</span>&nbsp;</div></li><li><div>  $topic-&gt;post_status = bbp_get_spam_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No revisions</span></span></span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update the topic</span></span></span>&nbsp;</div></li><li><div>  $topic_id = wp_update_post( $topic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post spam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_spammed_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Return topic_id</span></span></span></span>&nbsp;</div></li><li><div>  return $topic_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Unspams a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2740)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unspam_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the previous status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_meta() To delete the previous status meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post() To update the topic with the new status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unspammed_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False or {@link WP_Error} on failure, topic id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_unspam_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the topic</span></span>&nbsp;</div></li><li><div>  $topic = bbp_get_topic( $topic_id );&nbsp;</div></li><li><div>  if ( empty( $topic ) )&nbsp;</div></li><li><div>      return $topic;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if already not spam</span>&nbsp;</div></li><li><div>  if ( bbp_get_spam_status_id() !== $topic-&gt;post_status )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute pre unspam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_unspam_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Untrash Replies *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the replies that were not previously trashed</span></span>&nbsp;</div></li><li><div>  $pre_spammed_replies = get_post_meta( $topic_id, '_bbp_pre_spammed_replies', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// There are replies to untrash</span></span>&nbsp;</div></li><li><div>  if ( !empty( $pre_spammed_replies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Maybe reverse the trashed replies array</span></span>&nbsp;</div></li><li><div>      if ( is_array( $pre_spammed_replies ) )&nbsp;</div></li><li><div>          $pre_spammed_replies = array_reverse( $pre_spammed_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through replies</span></span>&nbsp;</div></li><li><div>      foreach ( (array) $pre_spammed_replies as $reply ) {&nbsp;</div></li><li><div>          wp_untrash_post( $reply );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** Topic Tags ************************************************************/</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get pre-spam topic tags</span>&nbsp;</div></li><li><div>  $terms = get_post_meta( $topic_id, '_bbp_spam_topic_tags', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic had tags before it was spammed</span>&nbsp;</div></li><li><div>  if ( !empty( $terms ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the tax_input of the topic</span>&nbsp;</div></li><li><div>      $topic-&gt;tax_input = array( bbp_get_topic_tag_tax_id() =&gt; $terms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete pre-spam topic tag meta</span>&nbsp;</div></li><li><div>      delete_post_meta( $topic_id, '_bbp_spam_topic_tags' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** Topic Status **********************************************************/</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get pre spam status</span>&nbsp;</div></li><li><div>  $topic_status = get_post_meta( $topic_id, '_bbp_spam_meta_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no previous status, default to publish</span>&nbsp;</div></li><li><div>  if ( empty( $topic_status ) ) {&nbsp;</div></li><li><div>      $topic_status = bbp_get_public_status_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set post status to pre spam</span>&nbsp;</div></li><li><div>  $topic-&gt;post_status = $topic_status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete pre spam meta</span>&nbsp;</div></li><li><div>  delete_post_meta( $topic_id, '_bbp_spam_meta_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No revisions</span></span></span></span>&nbsp;</div></li><li><div>  remove_action( 'pre_post_update', 'wp_save_post_revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Update the topic</span></span></span>&nbsp;</div></li><li><div>  $topic_id = wp_update_post( $topic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute post unspam code</span>&nbsp;</div></li><li><div>  do_action( 'bbp_unspammed_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Return topic_id</span></span></span></span>&nbsp;</div></li><li><div>  return $topic_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sticks a topic to a forum or front</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2754)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $super Should we make the topic a super sticky?</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_unstick_topic() To unstick the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_stickies() To get the stickies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() 'bbp_stick_topic' with topic id and bool super</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_option() To update the super stickies option</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the forum stickies meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_sticked_topic' with the topic id, bool super</span>&nbsp;</div></li><li><div><span class="comment"> *                    and success</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_stick_topic( $topic_id = 0, $super = false ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if a topic is not a topic (prevents revisions as stickies)</span>&nbsp;</div></li><li><div>  if ( ! bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We may have a super sticky to which we want to convert into a normal</span>&nbsp;</div></li><li><div>  <span class="comment">// sticky and vice versa; unstick the topic first to avoid any possible error.</span>&nbsp;</div></li><li><div>  bbp_unstick_topic( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_id = empty( $super ) ? bbp_get_topic_forum_id( $topic_id ) : 0;&nbsp;</div></li><li><div>  $stickies = bbp_get_stickies( $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_stick_topic', $topic_id, $super );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_array( $stickies ) ) {&nbsp;</div></li><li><div>      $stickies = array( $topic_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $stickies[] = $topic_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Pull out duplicates and empties</span>&nbsp;</div></li><li><div>  $stickies = array_unique( array_filter( $stickies ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Unset incorrectly stuck revisions</span>&nbsp;</div></li><li><div>  foreach ( (array) $stickies as $key =&gt; $id ) {&nbsp;</div></li><li><div>      if ( ! bbp_is_topic( $id ) ) {&nbsp;</div></li><li><div>          unset( $stickies[$key] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reset keys</span>&nbsp;</div></li><li><div>  $stickies = array_values( $stickies );&nbsp;</div></li><li><div>  $success = !empty( $super ) ? update_option( '_bbp_super_sticky_topics', $stickies ) : update_post_meta( $forum_id, '_bbp_sticky_topics', $stickies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_sticked_topic', $topic_id, $super, $success );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) $success;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Unsticks a topic both from front and it's forum</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2754)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_super_sticky() To check if the topic is a super sticky</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id() To get the topic forum id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_stickies() To get the forum stickies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unstick_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_option() To delete the super stickies option</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_option() To update the super stickies option</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_meta() To delete the forum stickies meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To update the forum stickies meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_unsticked_topic' with the topic id and success</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Always true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_unstick_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $super = bbp_is_topic_super_sticky( $topic_id );&nbsp;</div></li><li><div>  $forum_id = empty( $super ) ? bbp_get_topic_forum_id( $topic_id ) : 0;&nbsp;</div></li><li><div>  $stickies = bbp_get_stickies( $forum_id );&nbsp;</div></li><li><div>  $offset = array_search( $topic_id, $stickies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_unstick_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $stickies ) ) {&nbsp;</div></li><li><div>      $success = true;&nbsp;</div></li><li><div>  } elseif ( !in_array( $topic_id, $stickies ) ) {&nbsp;</div></li><li><div>      $success = true;&nbsp;</div></li><li><div>  } elseif ( false === $offset ) {&nbsp;</div></li><li><div>      $success = true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      array_splice( $stickies, $offset, 1 );&nbsp;</div></li><li><div>      if ( empty( $stickies ) ) {&nbsp;</div></li><li><div>          $success = !empty( $super ) ? delete_option( '_bbp_super_sticky_topics' ) : delete_post_meta( $forum_id, '_bbp_sticky_topics' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $success = !empty( $super ) ? update_option( '_bbp_super_sticky_topics', $stickies ) : update_post_meta( $forum_id, '_bbp_sticky_topics', $stickies );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_unsticked_topic', $topic_id, $success );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) $success;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Before Delete/Trash/Untrash ***********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before deleting a topic.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is supplemental to the actual topic deletion which is</span>&nbsp;</div></li><li><div><span class="comment"> * handled by WordPress core API functions. It is used to clean up after</span>&nbsp;</div></li><li><div><span class="comment"> * a topic that is being deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_delete_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_has_replies() To check if the topic has replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_replies() To loop through the replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_the_reply() To set a reply as the current reply in the loop</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To get the reply id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_delete_post() To delete the reply</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_delete_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Validate topic ID</span></span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_delete_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic is being permanently deleted, so its replies gotta go too</span>&nbsp;</div></li><li><div>  <span class="comment">// Note that we get all post statuses here</span>&nbsp;</div></li><li><div>  $replies = new WP_Query( array(&nbsp;</div></li><li><div>      'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'post_status' =&gt; array_keys( get_post_stati() ), &nbsp;</div></li><li><div>      'post_parent' =&gt; $topic_id, &nbsp;</div></li><li><div>      'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>      'nopaging' =&gt; true, &nbsp;</div></li><li><div>      'fields' =&gt; 'id=&gt;parent'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Loop through and delete child replies</span>&nbsp;</div></li><li><div>  if ( ! empty( $replies-&gt;posts ) ) {&nbsp;</div></li><li><div>      foreach ( $replies-&gt;posts as $reply ) {&nbsp;</div></li><li><div>          wp_delete_post( $reply-&gt;ID, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Reset the $post global</span></span></span>&nbsp;</div></li><li><div>      wp_reset_postdata();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span>&nbsp;</div></li><li><div>  unset( $replies );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before trashing a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is supplemental to the actual topic being trashed which is</span>&nbsp;</div></li><li><div><span class="comment"> * handled by WordPress core API functions. It is used to clean up after</span>&nbsp;</div></li><li><div><span class="comment"> * a topic that is being trashed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_trash_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_trash_post() To trash the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses update_post_meta() To save a list of just trashed replies for future use</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_trash_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Validate topic ID</span></span>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_trash_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Topic is being trashed, so its replies are trashed too</span>&nbsp;</div></li><li><div>  $replies = new WP_Query( array(&nbsp;</div></li><li><div>      'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>      'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>      'post_status' =&gt; bbp_get_public_status_id(), &nbsp;</div></li><li><div>      'post_parent' =&gt; $topic_id, &nbsp;</div></li><li><div>      'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>      'nopaging' =&gt; true, &nbsp;</div></li><li><div>      'fields' =&gt; 'id=&gt;parent'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $replies-&gt;posts ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Prevent debug notices</span></span></span>&nbsp;</div></li><li><div>      $pre_trashed_replies = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Loop through replies</span></span>, trash them, and add them to array</span>&nbsp;</div></li><li><div>      foreach ( $replies-&gt;posts as $reply ) {&nbsp;</div></li><li><div>          wp_trash_post( $reply-&gt;ID );&nbsp;</div></li><li><div>          $pre_trashed_replies[] = $reply-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Set a post_meta entry of the replies that were trashed by this action.</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// This is so we can possibly untrash them, without untrashing replies</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// that were purposefully trashed before.</span></span>&nbsp;</div></li><li><div>      update_post_meta( $topic_id, '_bbp_pre_trashed_replies', $pre_trashed_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Reset the $post global</span></span></span>&nbsp;</div></li><li><div>      wp_reset_postdata();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Cleanup</span></span></span>&nbsp;</div></li><li><div>  unset( $replies );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called before untrashing a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_untrash_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the list of replies which were trashed with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_untrash_post() To untrash the reply</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_untrash_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_untrash_topic', $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the replies that were not previously trashed</span></span>&nbsp;</div></li><li><div>  $pre_trashed_replies = get_post_meta( $topic_id, '_bbp_pre_trashed_replies', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// There are replies to untrash</span></span>&nbsp;</div></li><li><div>  if ( !empty( $pre_trashed_replies ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Maybe reverse the trashed replies array</span></span>&nbsp;</div></li><li><div>      if ( is_array( $pre_trashed_replies ) )&nbsp;</div></li><li><div>          $pre_trashed_replies = array_reverse( $pre_trashed_replies );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through replies</span></span>&nbsp;</div></li><li><div>      foreach ( (array) $pre_trashed_replies as $reply ) {&nbsp;</div></li><li><div>          wp_untrash_post( $reply );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** After Delete/Trash/Untrash ************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after deleting a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_deleted_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_deleted_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_deleted_topic', $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after trashing a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_trashed_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_trashed_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_trashed_topic', $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called after untrashing a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To get the topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic() To check if the passed id is a topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_untrashed_topic' with the topic id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_untrashed_topic( $topic_id = 0 ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $topic_id ) || !bbp_is_topic( $topic_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_untrashed_topic', $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Settings ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the topics per page setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3540)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $default Default replies per page (15)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get the setting</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() To allow the return value to be manipulated</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_topics_per_page( $default = 15 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get database option and cast as integer</span></span>&nbsp;</div></li><li><div>  $retval = get_option( '_bbp_topics_per_page', $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If return val is empty, set it to default</span></span>&nbsp;</div></li><li><div>  if ( empty( $retval ) )&nbsp;</div></li><li><div>      $retval = $default;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Filter and return</span></span>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_get_topics_per_page', $retval, $default );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the topics per RSS page setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3540)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $default Default replies per page (25)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get the setting</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() To allow the return value to be manipulated</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_topics_per_rss_page( $default = 25 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get database option and cast as integer</span></span>&nbsp;</div></li><li><div>  $retval = get_option( '_bbp_topics_per_rss_page', $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If return val is empty, set it to default</span></span>&nbsp;</div></li><li><div>  if ( empty( $retval ) )&nbsp;</div></li><li><div>      $retval = $default;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Filter and return</span></span>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bbp_get_topics_per_rss_page', $retval, $default );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Topic Tags ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get topic tags for a specific topic ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4165)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $sep</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_topic_tag_names( $topic_id = 0, $sep = ', ' ) {&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $topic_tags = array_filter( (array) get_the_terms( $topic_id, bbp_get_topic_tag_tax_id() ) );&nbsp;</div></li><li><div>  $terms = array();&nbsp;</div></li><li><div>  foreach ( $topic_tags as $term ) {&nbsp;</div></li><li><div>      $terms[] = $term-&gt;name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $terms = !empty( $terms ) ? implode( $sep, $terms ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_topic_tags', $terms, $topic_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Autoembed *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if autoembeds are enabled and hook them in if so</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3752)</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Embed $wp_embed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_topic_content_autoembed() {&nbsp;</div></li><li><div>  global $wp_embed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bbp_use_autoembed() && is_a( $wp_embed, 'WP_Embed' ) ) {&nbsp;</div></li><li><div>      add_filter( 'bbp_get_topic_content', array( $wp_embed, 'autoembed' ), 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Feeds *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output an RSS2 feed of topics, based on the query passed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3171)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_version()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_single_topic()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_user_can_view_forum()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_forum_id()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_show_load_topic()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_permalink()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_title()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_reply_count()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topic_content()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_has_topics()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_topics()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_the_topic()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_wp_title_rss()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bloginfo_rss</span>&nbsp;</div></li><li><div><span class="comment"> * @uses self_link()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses the_author()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_time()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses rss_enclosure()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $topics_query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_display_topics_feed_rss2( $topics_query = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User cannot access this forum</span>&nbsp;</div></li><li><div>  if ( bbp_is_single_forum() && !bbp_user_can_view_forum( array( 'forum_id' =&gt; bbp_get_forum_id() ) ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Display the feed</span>&nbsp;</div></li><li><div>  header( 'Content-Type: ' . feed_content_type( 'rss2' ) . '; charset=' . get_option( 'blog_charset' ), true );&nbsp;</div></li><li><div>  header( 'Status: 200 OK' );&nbsp;</div></li><li><div>  echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;' . get_option( 'blog_charset' ) . '&quot;?' . '&gt;'; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;rss version=&quot;2.0&quot;&nbsp;</div></li><li><div>      xmlns:content=&quot;http:<span class="comment">//purl.org/rss/1.0/modules/content/&quot;</span>&nbsp;</div></li><li><div>      xmlns:wfw=&quot;http:<span class="comment">//wellformedweb.org/CommentAPI/&quot;</span>&nbsp;</div></li><li><div>      xmlns:dc=&quot;http:<span class="comment">//purl.org/dc/elements/1.1/&quot;</span>&nbsp;</div></li><li><div>      xmlns:atom=&quot;http:<span class="comment">//www.w3.org/2005/Atom&quot;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed' ); ?&gt;&nbsp;</div></li><li><div>  &gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;channel&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;title&gt;&lt;?php bloginfo_rss( 'name' ); ?&gt; &#187; &lt;?php _e( 'All Topics', 'bbpress' ); ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>      &lt;atom:link href=&quot;&lt;?php self_link(); ?&gt;&quot; rel=&quot;self&quot; type=&quot;application/rss+xml&quot; /&gt;&nbsp;</div></li><li><div>      &lt;link&gt;&lt;?php self_link(); ?&gt;&lt;/link&gt;&nbsp;</div></li><li><div>      &lt;description&gt;&lt;?php <span class="comment">//?&gt;&lt;/description&gt;</span>&nbsp;</div></li><li><div>      &lt;pubDate&gt;&lt;?php echo mysql2date( 'D, d M Y H:i:s O', current_time( 'mysql' ), false ); ?&gt;&lt;/pubDate&gt;&nbsp;</div></li><li><div>      &lt;generator&gt;http:<span class="comment">//bbpress.org/?v=&lt;?php bbp_version(); ?&gt;&lt;/generator&gt;</span>&nbsp;</div></li><li><div>      &lt;language&gt;&lt;?php bloginfo_rss( 'language' ); ?&gt;&lt;/language&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed_head' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php if ( bbp_has_topics( $topics_query ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php while ( bbp_topics() ) : bbp_the_topic(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;item&gt;&nbsp;</div></li><li><div>                  &lt;guid&gt;&lt;?php bbp_topic_permalink(); ?&gt;&lt;/guid&gt;&nbsp;</div></li><li><div>                  &lt;title&gt;&lt;![CDATA[&lt;?php bbp_topic_title(); ?&gt;]]&gt;&lt;/title&gt;&nbsp;</div></li><li><div>                  &lt;link&gt;&lt;?php bbp_topic_permalink(); ?&gt;&lt;/link&gt;&nbsp;</div></li><li><div>                  &lt;pubDate&gt;&lt;?php echo mysql2date('D, d M Y H:i:s +0000', get_post_meta( bbp_get_topic_id(), '_bbp_last_active_time', true ) ); ?&gt;&lt;/pubDate&gt;&nbsp;</div></li><li><div>                  &lt;dc:creator&gt;&lt;?php the_author() ?&gt;&lt;/dc:creator&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php if ( !post_password_required() ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;description&gt;&nbsp;</div></li><li><div>                      &lt;![CDATA[&nbsp;</div></li><li><div>                      &lt;p&gt;&lt;?php printf( esc_html__( 'Replies: %s', 'bbpress' ), bbp_get_topic_reply_count() ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                      &lt;?php bbp_topic_content(); ?&gt;&nbsp;</div></li><li><div> ]]&gt;&nbsp;</div></li><li><div>                  &lt;/description&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php rss_enclosure(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php do_action( 'bbp_feed_item' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;/item&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endwhile; ?&gt;&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'bbp_feed_footer' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;/channel&gt;&nbsp;</div></li><li><div>  &lt;/rss&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Permissions ***************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirect if unathorized user is attempting to edit a topic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3605)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_edit()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_permalink()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_topic_edit() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if not editing a topic</span>&nbsp;</div></li><li><div>  if ( !bbp_is_topic_edit() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User cannot edit topic, so redirect back to topic</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic', bbp_get_topic_id() ) ) {&nbsp;</div></li><li><div>      wp_safe_redirect( bbp_get_topic_permalink() );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirect if unathorized user is attempting to edit a topic tag</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3605)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_tag_edit()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_tag_id()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_safe_redirect()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_tag_link()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_topic_tag_edit() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if not editing a topic</span> tag&nbsp;</div></li><li><div>  if ( !bbp_is_topic_tag_edit() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if current user cannot edit topic tags</span>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_topic_tags', bbp_get_topic_tag_id() ) ) {&nbsp;</div></li><li><div>      wp_safe_redirect( bbp_get_topic_tag_link() );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>bbPress</li><li><span></span>2.5.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>