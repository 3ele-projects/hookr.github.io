<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.5.9" data-slug="bbpress" data-type="file" data-id="62437"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-common-functions | file | Bbpress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, bbpress, 2.5.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=bdb95e35558bd2a2cda88da220419b42' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-common-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-common-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-common-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-bbpress-2.5.9-file-includes-common-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-common-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to bbpress." href="http://hookr.io/plugins/bbpress/" class="plugin"><span property="name">bbpress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.5.9." href="http://hookr.io/plugins/bbpress/2.5.9/" class="H_VERSION"><span property="name">2.5.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/bbpress/2.5.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-common-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2373"><a href="http://hookr.io/plugins/bbpress/2.5.9/all/" title="All">All <span class="count badge">2373</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/bbpress/2.5.9/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="1132"><a href="http://hookr.io/plugins/bbpress/2.5.9/hooks/" title="Hooks">Hooks <span class="count badge">1132</span></a></li><li class="" data-id="action" data-count="471"><a href="http://hookr.io/plugins/bbpress/2.5.9/actions/" title="Actions">Actions <span class="count badge">471</span></a></li><li class="" data-id="filter" data-count="661"><a href="http://hookr.io/plugins/bbpress/2.5.9/filters/" title="Filters">Filters <span class="count badge">661</span></a></li><li class="" data-id="class" data-count="54"><a href="http://hookr.io/plugins/bbpress/2.5.9/classes/" title="Classes">Classes <span class="count badge">54</span></a></li><li class="" data-id="constant" data-count="28"><a href="http://hookr.io/plugins/bbpress/2.5.9/constants/" title="Constants">Constants <span class="count badge">28</span></a></li><li class="" data-id="function" data-count="1158"><a href="http://hookr.io/plugins/bbpress/2.5.9/functions/" title="Functions">Functions <span class="count badge">1158</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/bbpress/2.5.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/common/functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * bbPress Common Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Common functions are ones that are used by more than one component, like</span>&nbsp;</div></li><li><div><span class="comment"> * forums, topics, replies, users, topic tags, etc...</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Functions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( !defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Formatting ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A bbPress specific method of formatting numeric values</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2486)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $number Number to format</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $decimals Optional. Display decimals</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_number_format' with the formatted values, </span>&nbsp;</div></li><li><div><span class="comment"> *                        number and display decimals bool</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Formatted string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_number_format( $number = 0, $decimals = false, $dec_point = '.', $thousands_sep = ', ' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If empty, set $number to (int) 0</span></span>&nbsp;</div></li><li><div>  if ( ! is_numeric( $number ) )&nbsp;</div></li><li><div>      $number = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_number_format', number_format( $number, $decimals, $dec_point, $thousands_sep ), $number, $decimals, $dec_point, $thousands_sep );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A bbPress specific method of formatting numeric values</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3857)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $number Number to format</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $decimals Optional. Display decimals</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_number_format' with the formatted values, </span>&nbsp;</div></li><li><div><span class="comment"> *                        number and display decimals bool</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Formatted string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_number_format_i18n( $number = 0, $decimals = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If empty, set $number to (int) 0</span></span>&nbsp;</div></li><li><div>  if ( ! is_numeric( $number ) )&nbsp;</div></li><li><div>      $number = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_number_format_i18n', number_format_i18n( $number, $decimals ), $number, $decimals );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Convert time supplied from database query into specified date format.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2455)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|object $post Optional. Default is global post object. A post_id or</span>&nbsp;</div></li><li><div><span class="comment"> *                          post object</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $d Optional. Default is 'U'. Either 'G', 'U', or php date</span>&nbsp;</div></li><li><div><span class="comment"> *                             format</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $translate Optional. Default is false. Whether to translate the</span>&nbsp;</div></li><li><div><span class="comment"> *                                   result</span>&nbsp;</div></li><li><div><span class="comment"> * @uses mysql2date() To convert the format</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_convert_date' with the time, date format</span>&nbsp;</div></li><li><div><span class="comment"> *                        and translate bool</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Returns timestamp</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_convert_date( $time, $d = 'U', $translate = false ) {&nbsp;</div></li><li><div>  $time = mysql2date( $d, $time, $translate );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_convert_date', $time, $d, $translate );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output formatted time to display human readable time difference.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2544)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $older_date Unix timestamp from which the difference begins.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $newer_date Optional. Unix timestamp from which the</span>&nbsp;</div></li><li><div><span class="comment"> *                            difference ends. False for current time.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $gmt Optional. Whether to use GMT timezone. Default is false.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_time_since() To get the formatted time</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_time_since( $older_date, $newer_date = false, $gmt = false ) {&nbsp;</div></li><li><div>  echo bbp_get_time_since( $older_date, $newer_date, $gmt );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return formatted time to display human readable time difference.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since bbPress (r2544)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $older_date Unix timestamp from which the difference begins.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $newer_date Optional. Unix timestamp from which the</span>&nbsp;</div></li><li><div><span class="comment">   *                            difference ends. False for current time.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $gmt Optional. Whether to use GMT timezone. Default is false.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses current_time() To get the current time in mysql format</span>&nbsp;</div></li><li><div><span class="comment">   * @uses human_time_diff() To get the time differene in since format</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Calls 'bbp_get_time_since' with the time</span>&nbsp;</div></li><li><div><span class="comment">   *                        difference and time</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Formatted time</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bbp_get_time_since( $older_date, $newer_date = false, $gmt = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup the strings</span>&nbsp;</div></li><li><div>      $unknown_text = apply_filters( 'bbp_core_time_since_unknown_text', __( 'sometime', 'bbpress' ) );&nbsp;</div></li><li><div>      $right_now_text = apply_filters( 'bbp_core_time_since_right_now_text', __( 'right now', 'bbpress' ) );&nbsp;</div></li><li><div>      $ago_text = apply_filters( 'bbp_core_time_since_ago_text', __( '%s ago', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// array of time period chunks</span>&nbsp;</div></li><li><div>      $chunks = array(&nbsp;</div></li><li><div>          array( 60 * 60 * 24 * 365 , __( 'year', 'bbpress' ), __( 'years', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 60 * 60 * 24 * 30 , __( 'month', 'bbpress' ), __( 'months', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 60 * 60 * 24 * 7, __( 'week', 'bbpress' ), __( 'weeks', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 60 * 60 * 24 , __( 'day', 'bbpress' ), __( 'days', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 60 * 60 , __( 'hour', 'bbpress' ), __( 'hours', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 60 , __( 'minute', 'bbpress' ), __( 'minutes', 'bbpress' ) ), &nbsp;</div></li><li><div>          array( 1, __( 'second', 'bbpress' ), __( 'seconds', 'bbpress' ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $older_date ) && !is_numeric( $older_date ) ) {&nbsp;</div></li><li><div>          $time_chunks = explode( ':', str_replace( ' ', ':', $older_date ) );&nbsp;</div></li><li><div>          $date_chunks = explode( '-', str_replace( ' ', '-', $older_date ) );&nbsp;</div></li><li><div>          $older_date = gmmktime( (int) $time_chunks[1], (int) $time_chunks[2], (int) $time_chunks[3], (int) $date_chunks[1], (int) $date_chunks[2], (int) $date_chunks[0] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $newer_date will equal false if we want to know the time elapsed</span>&nbsp;</div></li><li><div>      <span class="comment">// between a date and the current time. $newer_date will have a value if</span>&nbsp;</div></li><li><div>      <span class="comment">// we want to work out time elapsed between two known dates.</span>&nbsp;</div></li><li><div>      $newer_date = ( !$newer_date ) ? strtotime( current_time( 'mysql', $gmt ) ) : $newer_date;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Difference in seconds</span>&nbsp;</div></li><li><div>      $since = $newer_date - $older_date;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Something went wrong with date calculation and we ended up with a negative date.</span>&nbsp;</div></li><li><div>      if ( 0 &gt; $since ) {&nbsp;</div></li><li><div>          $output = $unknown_text;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We only want to output two chunks of time here, eg:</span>&nbsp;</div></li><li><div>      <span class="comment">//     x years, xx months</span>&nbsp;</div></li><li><div>      <span class="comment">//     x days, xx hours</span>&nbsp;</div></li><li><div>      <span class="comment">// so there's only two bits of calculation below:</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Step one: the first chunk</span>&nbsp;</div></li><li><div>          for ( $i = 0, $j = count( $chunks ); $i &lt; $j; ++$i ) {&nbsp;</div></li><li><div>              $seconds = $chunks[$i][0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Finding the biggest chunk (if the chunk fits, break)</span>&nbsp;</div></li><li><div>              $count = floor( $since / $seconds );&nbsp;</div></li><li><div>              if ( 0 != $count ) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If $i iterates all the way to $j, then the event happened 0 seconds ago</span>&nbsp;</div></li><li><div>          if ( !isset( $chunks[$i] ) ) {&nbsp;</div></li><li><div>              $output = $right_now_text;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Set output var</span>&nbsp;</div></li><li><div>              $output = ( 1 == $count ) ? '1 '. $chunks[$i][1] : $count . ' ' . $chunks[$i][2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Step two: the second chunk</span>&nbsp;</div></li><li><div>              if ( $i + 2 &lt; $j ) {&nbsp;</div></li><li><div>                  $seconds2 = $chunks[$i + 1][0];&nbsp;</div></li><li><div>                  $name2 = $chunks[$i + 1][1];&nbsp;</div></li><li><div>                  $count2 = floor( ( $since - ( $seconds * $count ) ) / $seconds2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Add to output var</span>&nbsp;</div></li><li><div>                  if ( 0 != $count2 ) {&nbsp;</div></li><li><div>                      $output .= ( 1 == $count2 ) ? _x( ', ', 'Separator in time since', 'bbpress' ) . ' 1 '. $name2 : _x( ', ', 'Separator in time since', 'bbpress' ) . ' ' . $count2 . ' ' . $chunks[$i + 1][2];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// No output, so happened right now</span>&nbsp;</div></li><li><div>              if ( ! (int) trim( $output ) ) {&nbsp;</div></li><li><div>                  $output = $right_now_text;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Append 'ago' to the end of time-since if not 'right now'</span>&nbsp;</div></li><li><div>      if ( $output != $right_now_text ) {&nbsp;</div></li><li><div>          $output = sprintf( $ago_text, $output );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'bbp_get_time_since', $output, $older_date, $newer_date );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Formats the reason for editing the topic/reply.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Does these things:</span>&nbsp;</div></li><li><div><span class="comment"> *  - Trimming</span>&nbsp;</div></li><li><div><span class="comment"> *  - Removing periods from the end of the string</span>&nbsp;</div></li><li><div><span class="comment"> *  - Trimming again</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2782)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id Optional. Topic id</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Status of topic</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_format_revision_reason( $reason = '' ) {&nbsp;</div></li><li><div>  $reason = (string) $reason;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Format reason for proper display</span>&nbsp;</div></li><li><div>  if ( empty( $reason ) )&nbsp;</div></li><li><div>      return $reason;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Trimming</span>&nbsp;</div></li><li><div>  $reason = trim( $reason );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We add our own full stop.</span>&nbsp;</div></li><li><div>  while ( substr( $reason, -1 ) === '.' )&nbsp;</div></li><li><div>      $reason = substr( $reason, 0, -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Trim again</span>&nbsp;</div></li><li><div>  $reason = trim( $reason );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $reason;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Misc **********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the unescaped redirect_to request value</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @bbPress (r4655)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The URL to redirect to, if set</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_redirect_to() {&nbsp;</div></li><li><div>  $retval = !empty( $_REQUEST['redirect_to'] ) ? $_REQUEST['redirect_to'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_redirect_to', $retval );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Append 'view=all' to query string if it's already there from referer</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3325)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $original_link Original Link to be modified</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $force Override bbp_get_view_all() check</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can moderate</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_query_arg() To add args to the url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_add_view_all' with the link and original link</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The link with 'view=all' appended if necessary</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_add_view_all( $original_link = '', $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Are we appending the view=all vars?</span>&nbsp;</div></li><li><div>  if ( bbp_get_view_all() || !empty( $force ) ) {&nbsp;</div></li><li><div>      $link = add_query_arg( array( 'view' =&gt; 'all' ), $original_link );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $link = $original_link;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_add_view_all', $link, $original_link );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove 'view=all' from query string</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3325)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $original_link Original Link to be modified</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can moderate</span>&nbsp;</div></li><li><div><span class="comment"> * @uses remove_query_arg() To add args to the url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_add_view_all' with the link and original link</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The link with 'view=all' appended if necessary</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_remove_view_all( $original_link = '' ) {&nbsp;</div></li><li><div>  return apply_filters( 'bbp_add_view_all', remove_query_arg( 'view', $original_link ), $original_link );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * If current user can and is vewing all topics/replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3325)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can moderate</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_view_all' with the link and original link</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether current user can and is viewing all</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_view_all( $cap = 'moderate' ) {&nbsp;</div></li><li><div>  $retval = ( ( !empty( $_GET['view'] ) && ( 'all' === $_GET['view'] ) && current_user_can( $cap ) ) );&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_view_all', (bool) $retval );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Assist pagination by returning correct page number</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2628)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_query_var() To get the 'paged' value</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Current page number</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_paged() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the query var</span>&nbsp;</div></li><li><div>  if ( get_query_var( 'paged' ) ) {&nbsp;</div></li><li><div>      $paged = get_query_var( 'paged' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check query paged</span>&nbsp;</div></li><li><div>  } elseif ( !empty( $wp_query-&gt;query['paged'] ) ) {&nbsp;</div></li><li><div>      $paged = $wp_query-&gt;query['paged'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Paged found</span>&nbsp;</div></li><li><div>  if ( !empty( $paged ) )&nbsp;</div></li><li><div>      return (int) $paged;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default to first page</span>&nbsp;</div></li><li><div>  return 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fix post author id on post save</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When a logged in user changes the status of an anonymous reply or topic, or</span>&nbsp;</div></li><li><div><span class="comment"> * edits it, the post_author field is set to the logged in user's id. This</span>&nbsp;</div></li><li><div><span class="comment"> * function fixes that.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2734)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $data Post data</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $postarr Original post array (includes post id)</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_anonymous() To check if the topic is by an anonymous user</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply_anonymous() To check if the reply is by an anonymous user</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Data</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_fix_post_author( $data = array(), $postarr = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Post is not being updated or the post_author is already 0, return</span>&nbsp;</div></li><li><div>  if ( empty( $postarr['ID'] ) || empty( $data['post_author'] ) )&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Post is not a topic or reply, return</span>&nbsp;</div></li><li><div>  if ( !in_array( $data['post_type'], array( bbp_get_topic_post_type(), bbp_get_reply_post_type() ) ) )&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is the post by an anonymous user?</span>&nbsp;</div></li><li><div>  if ( ( bbp_get_topic_post_type() === $data['post_type'] && !bbp_is_topic_anonymous( $postarr['ID'] ) ) ||&nbsp;</div></li><li><div>       ( bbp_get_reply_post_type() === $data['post_type'] && !bbp_is_reply_anonymous( $postarr['ID'] ) ) )&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The post is being updated. It is a topic or a reply and is written by an anonymous user.</span>&nbsp;</div></li><li><div>  <span class="comment">// Set the post_author back to 0</span>&nbsp;</div></li><li><div>  $data['post_author'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check the date against the _bbp_edit_lock setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3133)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_date_gmt</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() Get the edit lock time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_time() Get the current time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses strtotime() Convert strings to time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Allow output to be manipulated</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_past_edit_lock( $post_date_gmt ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume editing is allowed</span>&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if empty date</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_date_gmt ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Period of time</span>&nbsp;</div></li><li><div>      $lockable = '+' . get_option( '_bbp_edit_lock', '5' ) . ' minutes';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now</span>&nbsp;</div></li><li><div>      $cur_time = current_time( 'timestamp', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add lockable time to post time</span>&nbsp;</div></li><li><div>      $lock_time = strtotime( $lockable, strtotime( $post_date_gmt ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Compare</span>&nbsp;</div></li><li><div>      if ( $cur_time &gt;= $lock_time ) {&nbsp;</div></li><li><div>          $retval = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_past_edit_lock', (bool) $retval, $cur_time, $lock_time, $post_date_gmt );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Statistics ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the forum statistics</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2769)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $args Optional. The function supports these arguments (all</span>&nbsp;</div></li><li><div><span class="comment"> *                     default to true):</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_users: Count users?</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_forums: Count forums?</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_topics: Count topics? If set to false, private, spammed and trashed</span>&nbsp;</div></li><li><div><span class="comment"> *                   topics are also not counted.</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_private_topics: Count private topics? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has read_private_topics cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_spammed_topics: Count spammed topics? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has edit_others_topics cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_trashed_topics: Count trashed topics? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has view_trash cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_replies: Count replies? If set to false, private, spammed and</span>&nbsp;</div></li><li><div><span class="comment"> *                   trashed replies are also not counted.</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_private_replies: Count private replies? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has read_private_replies cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_spammed_replies: Count spammed replies? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has edit_others_replies cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_trashed_replies: Count trashed replies? (only counted if the current</span>&nbsp;</div></li><li><div><span class="comment"> *                           user has view_trash cap)</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_tags: Count tags? If set to false, empty tags are also not counted</span>&nbsp;</div></li><li><div><span class="comment"> *  - count_empty_tags: Count empty tags?</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_count_users() To count the number of registered users</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_post_type() To get the forum post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_post_type() To get the reply post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_count_posts() To count the number of forums, topics and replies</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_count_terms() To count the number of topic tags</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the user is capable of doing things</span>&nbsp;</div></li><li><div><span class="comment"> * @uses number_format_i18n() To format the number</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_statistics' with the statistics and args</span>&nbsp;</div></li><li><div><span class="comment"> * @return object Walked forum tree</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_statistics( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse</span> arguments against default values</span></span></span>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $args, array(&nbsp;</div></li><li><div>      'count_users' =&gt; true, &nbsp;</div></li><li><div>      'count_forums' =&gt; true, &nbsp;</div></li><li><div>      'count_topics' =&gt; true, &nbsp;</div></li><li><div>      'count_private_topics' =&gt; true, &nbsp;</div></li><li><div>      'count_spammed_topics' =&gt; true, &nbsp;</div></li><li><div>      'count_trashed_topics' =&gt; true, &nbsp;</div></li><li><div>      'count_replies' =&gt; true, &nbsp;</div></li><li><div>      'count_private_replies' =&gt; true, &nbsp;</div></li><li><div>      'count_spammed_replies' =&gt; true, &nbsp;</div></li><li><div>      'count_trashed_replies' =&gt; true, &nbsp;</div></li><li><div>      'count_tags' =&gt; true, &nbsp;</div></li><li><div>      'count_empty_tags' =&gt; true&nbsp;</div></li><li><div> ), 'get_statistics' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Defaults</span>&nbsp;</div></li><li><div>  $user_count = 0;&nbsp;</div></li><li><div>  $forum_count = 0;&nbsp;</div></li><li><div>  $topic_count = 0;&nbsp;</div></li><li><div>  $topic_count_hidden = 0;&nbsp;</div></li><li><div>  $reply_count = 0;&nbsp;</div></li><li><div>  $reply_count_hidden = 0;&nbsp;</div></li><li><div>  $topic_tag_count = 0;&nbsp;</div></li><li><div>  $empty_topic_tag_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Users</span>&nbsp;</div></li><li><div>  if ( !empty( $r['count_users'] ) ) {&nbsp;</div></li><li><div>      $user_count = bbp_get_total_users();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Forum</span></span>s</span>&nbsp;</div></li><li><div>  if ( !empty( $r['count_forums'] ) ) {&nbsp;</div></li><li><div>      $forum_count = wp_count_posts( bbp_get_forum_post_type() )-&gt;publish;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Post statuses</span>&nbsp;</div></li><li><div>  $private = bbp_get_private_status_id();&nbsp;</div></li><li><div>  $spam = bbp_get_spam_status_id();&nbsp;</div></li><li><div>  $trash = bbp_get_trash_status_id();&nbsp;</div></li><li><div>  $closed = bbp_get_closed_status_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic</span>s</span>&nbsp;</div></li><li><div>  if ( !empty( $r['count_topics'] ) ) {&nbsp;</div></li><li><div>      $all_topics = wp_count_posts( bbp_get_topic_post_type() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Published</span> (publish + closed)</span>&nbsp;</div></li><li><div>      $topic_count = $all_topics-&gt;publish + $all_topics-&gt;{$closed};&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( current_user_can( 'read_private_topics' ) || current_user_can( 'edit_others_topics' ) || current_user_can( 'view_trash' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Private</span></span>&nbsp;</div></li><li><div>          $topics['private'] = ( !empty( $r['count_private_topics'] ) && current_user_can( 'read_private_topics' ) ) ? (int) $all_topics-&gt;{$private} : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Spam</span></span>&nbsp;</div></li><li><div>          $topics['spammed'] = ( !empty( $r['count_spammed_topics'] ) && current_user_can( 'edit_others_topics' ) ) ? (int) $all_topics-&gt;{$spam}    : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Trash</span></span>&nbsp;</div></li><li><div>          $topics['trashed'] = ( !empty( $r['count_trashed_topics'] ) && current_user_can( 'view_trash' ) ) ? (int) $all_topics-&gt;{$trash}   : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Total hidden (private + spam + trash)</span></span>&nbsp;</div></li><li><div>          $topic_count_hidden = $topics['private'] + $topics['spammed'] + $topics['trashed'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Generate the hidden topic count's title attribute</span></span>&nbsp;</div></li><li><div>          $topic_titles[] = !empty( $topics['private'] ) ? sprintf( __( 'Private: %s', 'bbpress' ), number_format_i18n( $topics['private'] ) ) : '';&nbsp;</div></li><li><div>          $topic_titles[] = !empty( $topics['spammed'] ) ? sprintf( __( 'Spammed: %s', 'bbpress' ), number_format_i18n( $topics['spammed'] ) ) : '';&nbsp;</div></li><li><div>          $topic_titles[] = !empty( $topics['trashed'] ) ? sprintf( __( 'Trashed: %s', 'bbpress' ), number_format_i18n( $topics['trashed'] ) ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Compile the hidden topic title</span>&nbsp;</div></li><li><div>          $hidden_topic_title = implode( ' | ', array_filter( $topic_titles ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Replies</span></span>&nbsp;</div></li><li><div>  if ( !empty( $r['count_replies'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $all_replies = wp_count_posts( bbp_get_reply_post_type() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Published</span>&nbsp;</div></li><li><div>      $reply_count = $all_replies-&gt;publish;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( current_user_can( 'read_private_replies' ) || current_user_can( 'edit_others_replies' ) || current_user_can( 'view_trash' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Private</span></span>&nbsp;</div></li><li><div>          $replies['private'] = ( !empty( $r['count_private_replies'] ) && current_user_can( 'read_private_replies' ) ) ? (int) $all_replies-&gt;{$private} : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Spam</span></span>&nbsp;</div></li><li><div>          $replies['spammed'] = ( !empty( $r['count_spammed_replies'] ) && current_user_can( 'edit_others_replies' ) ) ? (int) $all_replies-&gt;{$spam}    : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Trash</span></span>&nbsp;</div></li><li><div>          $replies['trashed'] = ( !empty( $r['count_trashed_replies'] ) && current_user_can( 'view_trash' ) ) ? (int) $all_replies-&gt;{$trash}   : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Total hidden (private + spam + trash)</span></span>&nbsp;</div></li><li><div>          $reply_count_hidden = $replies['private'] + $replies['spammed'] + $replies['trashed'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Generate the hidden topic count's title attribute</span></span>&nbsp;</div></li><li><div>          $reply_titles[] = !empty( $replies['private'] ) ? sprintf( __( 'Private: %s', 'bbpress' ), number_format_i18n( $replies['private'] ) ) : '';&nbsp;</div></li><li><div>          $reply_titles[] = !empty( $replies['spammed'] ) ? sprintf( __( 'Spammed: %s', 'bbpress' ), number_format_i18n( $replies['spammed'] ) ) : '';&nbsp;</div></li><li><div>          $reply_titles[] = !empty( $replies['trashed'] ) ? sprintf( __( 'Trashed: %s', 'bbpress' ), number_format_i18n( $replies['trashed'] ) ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Compile the hidden replies title</span>&nbsp;</div></li><li><div>          $hidden_reply_title = implode( ' | ', array_filter( $reply_titles ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Topic</span> Tags</span>&nbsp;</div></li><li><div>  if ( !empty( $r['count_tags'] ) && bbp_allow_topic_tags() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the count</span>&nbsp;</div></li><li><div>      $topic_tag_count = wp_count_terms( bbp_get_topic_tag_tax_id(), array( 'hide_empty' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Empty tags</span>&nbsp;</div></li><li><div>      if ( !empty( $r['count_empty_tags'] ) && current_user_can( 'edit_topic_tags' ) ) {&nbsp;</div></li><li><div>          $empty_topic_tag_count = wp_count_terms( bbp_get_topic_tag_tax_id() ) - $topic_tag_count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Tally the tallies</span>&nbsp;</div></li><li><div>  $statistics = array_map( 'number_format_i18n', array_map( 'absint', compact(&nbsp;</div></li><li><div>      'user_count', &nbsp;</div></li><li><div>      'forum_count', &nbsp;</div></li><li><div>      'topic_count', &nbsp;</div></li><li><div>      'topic_count_hidden', &nbsp;</div></li><li><div>      'reply_count', &nbsp;</div></li><li><div>      'reply_count_hidden', &nbsp;</div></li><li><div>      'topic_tag_count', &nbsp;</div></li><li><div>      'empty_topic_tag_count'&nbsp;</div></li><li><div> ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the hidden (topic/reply) count title attribute strings because we</span>&nbsp;</div></li><li><div>  <span class="comment">// don't need to run the math functions on these (see above)</span>&nbsp;</div></li><li><div>  $statistics['hidden_topic_title'] = isset( $hidden_topic_title ) ? $hidden_topic_title : '';&nbsp;</div></li><li><div>  $statistics['hidden_reply_title'] = isset( $hidden_reply_title ) ? $hidden_reply_title : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_statistics', $statistics, $r );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** New/edit topic/reply helpers **********************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filter anonymous post data</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We use REMOTE_ADDR here directly. If you are behind a proxy, you should</span>&nbsp;</div></li><li><div><span class="comment"> * ensure that it is properly set, such as in wp-config.php, for your</span>&nbsp;</div></li><li><div><span class="comment"> * environment. See {@link http://core.trac.wordpress.org/ticket/9235}</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that bbp_pre_anonymous_filters() is responsible for sanitizing each</span>&nbsp;</div></li><li><div><span class="comment"> * of the filtered core anonymous values here.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If there are any errors, those are directly added to {@link bbPress:errors}</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2734)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $args Optional. If no args are there, then $_POST values are</span>&nbsp;</div></li><li><div><span class="comment"> *                     used.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_pre_anonymous_post_author_name' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        anonymous user name</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_pre_anonymous_post_author_email' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        anonymous user email</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_pre_anonymous_post_author_website' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        anonymous user website</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|array False on errors, values in an array on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_filter_anonymous_post_data( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse</span> arguments against default values</span></span></span>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $args, array (&nbsp;</div></li><li><div>      'bbp_anonymous_name' =&gt; !empty( $_POST['bbp_anonymous_name'] ) ? $_POST['bbp_anonymous_name']    : false, &nbsp;</div></li><li><div>      'bbp_anonymous_email' =&gt; !empty( $_POST['bbp_anonymous_email'] ) ? $_POST['bbp_anonymous_email']   : false, &nbsp;</div></li><li><div>      'bbp_anonymous_website' =&gt; !empty( $_POST['bbp_anonymous_website'] ) ? $_POST['bbp_anonymous_website'] : false, &nbsp;</div></li><li><div> ), 'filter_anonymous_post_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Filter variables and add errors if necessary</span>&nbsp;</div></li><li><div>  $r['bbp_anonymous_name'] = apply_filters( 'bbp_pre_anonymous_post_author_name', $r['bbp_anonymous_name'] );&nbsp;</div></li><li><div>  if ( empty( $r['bbp_anonymous_name'] ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_anonymous_name', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Invalid author name submitted!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r['bbp_anonymous_email'] = apply_filters( 'bbp_pre_anonymous_post_author_email', $r['bbp_anonymous_email'] );&nbsp;</div></li><li><div>  if ( empty( $r['bbp_anonymous_email'] ) )&nbsp;</div></li><li><div>      bbp_add_error( 'bbp_anonymous_email', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Invalid email address submitted!', 'bbpress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Website is optional</span>&nbsp;</div></li><li><div>  $r['bbp_anonymous_website'] = apply_filters( 'bbp_pre_anonymous_post_author_website', $r['bbp_anonymous_website'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return false if we have any errors</span>&nbsp;</div></li><li><div>  $retval = bbp_has_errors() ? false : $r;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally, return sanitized data or false</span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_filter_anonymous_post_data', $retval, $r );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check for duplicate topics/replies</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Check to make sure that a user is not making a duplicate post</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2763)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_data Contains information about the comment</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can throttle</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_meta_sql() To generate the meta sql for checking anonymous email</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_check_for_duplicate_query' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                        duplicate check query and post data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_var() To execute our query and get the var back</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_post_meta() To get the anonymous user email post meta</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_post_duplicate_trigger' with the post data when</span>&nbsp;</div></li><li><div><span class="comment"> *                    it is found that it is a duplicate</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if it is not a duplicate, false if it is</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_for_duplicate( $post_data = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No duplicate checks for those who can throttle</span>&nbsp;</div></li><li><div>  if ( current_user_can( 'throttle' ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Define global to use get_meta_sql() and get_var() methods</span>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Parse</span> arguments against default values</span></span></span>&nbsp;</div></li><li><div>  $r = bbp_parse_args( $post_data, array(&nbsp;</div></li><li><div>      'post_author' =&gt; 0, &nbsp;</div></li><li><div>      'post_type' =&gt; array( bbp_get_topic_post_type(), bbp_get_reply_post_type() ), &nbsp;</div></li><li><div>      'post_parent' =&gt; 0, &nbsp;</div></li><li><div>      'post_content' =&gt; '', &nbsp;</div></li><li><div>      'post_status' =&gt; bbp_get_trash_status_id(), &nbsp;</div></li><li><div>      'anonymous_data' =&gt; false&nbsp;</div></li><li><div> ), 'check_for_duplicate' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for anonymous post</span>&nbsp;</div></li><li><div>  if ( empty( $r['post_author'] ) && ( !empty( $r['anonymous_data'] ) && !empty( $r['anonymous_data']['bbp_anonymous_email'] ) ) ) {&nbsp;</div></li><li><div>      $clauses = get_meta_sql( array( array(&nbsp;</div></li><li><div>          'key' =&gt; '_bbp_anonymous_email', &nbsp;</div></li><li><div>          'value' =&gt; $r['anonymous_data']['bbp_anonymous_email']&nbsp;</div></li><li><div> ) ), 'post', $wpdb-&gt;posts, 'ID' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $join = $clauses['join'];&nbsp;</div></li><li><div>      $where = $clauses['where'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $join = $where = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Unslash $r to pass through $wpdb-&gt;prepare()</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // @see: http://bbpress.trac.wordpress.org/ticket/2185/</span>&nbsp;</div></li><li><div>  <span class="comment">// @see: http://core.trac.wordpress.org/changeset/23973/</span>&nbsp;</div></li><li><div>  $r = function_exists( 'wp_unslash' ) ? wp_unslash( $r ) : stripslashes_deep( $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prepare duplicate check query</span>&nbsp;</div></li><li><div>  $query = $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} {$join} WHERE post_type = %s AND post_status != %s AND post_author = %d AND post_content = %s {$where}&quot;, $r['post_type'], $r['post_status'], $r['post_author'], $r['post_content'] );&nbsp;</div></li><li><div>  $query .= !empty( $r['post_parent'] ) ? $wpdb-&gt;prepare( &quot; AND post_parent = %d&quot;, $r['post_parent'] ) : '';&nbsp;</div></li><li><div>  $query .= &quot; LIMIT 1&quot;;&nbsp;</div></li><li><div>  $dupe = apply_filters( 'bbp_check_for_duplicate_query', $query, $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wpdb-&gt;get_var( $dupe ) ) {&nbsp;</div></li><li><div>      do_action( 'bbp_check_for_duplicate_trigger', $post_data );&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check for flooding</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Check to make sure that a user is not making too many posts in a short amount</span>&nbsp;</div></li><li><div><span class="comment"> * of time.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2734)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param false|array $anonymous_data Optional - if it's an anonymous post. Do</span>&nbsp;</div></li><li><div><span class="comment"> *                                     not supply if supplying $author_id.</span>&nbsp;</div></li><li><div><span class="comment"> *                                     Should have key 'bbp_author_ip'.</span>&nbsp;</div></li><li><div><span class="comment"> *                                     Should be sanitized (see</span>&nbsp;</div></li><li><div><span class="comment"> *                                     {@link bbp_filter_anonymous_post_data()}</span>&nbsp;</div></li><li><div><span class="comment"> *                                     for sanitization)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $author_id Optional. Supply if it's a post by a logged in user.</span>&nbsp;</div></li><li><div><span class="comment"> *                        Do not supply if supplying $anonymous_data.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To get the throttle time</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_transient() To get the last posted transient of the ip</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_user_last_posted() To get the last posted time of the user</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can() To check if the current user can throttle</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if there is no flooding, false if there is</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_for_flood( $anonymous_data = false, $author_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Option disabled. No flood checks.</span>&nbsp;</div></li><li><div>  $throttle_time = get_option( '_bbp_throttle_time' );&nbsp;</div></li><li><div>  if ( empty( $throttle_time ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is anonymous, so check a transient based on the IP</span>&nbsp;</div></li><li><div>  if ( !empty( $anonymous_data ) && is_array( $anonymous_data ) ) {&nbsp;</div></li><li><div>      $last_posted = get_transient( '_bbp_' . bbp_current_author_ip() . '_last_posted' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $last_posted ) && time() &lt; $last_posted + $throttle_time ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is logged in, so check their last posted time</span>&nbsp;</div></li><li><div>  } elseif ( !empty( $author_id ) ) {&nbsp;</div></li><li><div>      $author_id = (int) $author_id;&nbsp;</div></li><li><div>      $last_posted = bbp_get_user_last_posted( $author_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $last_posted ) && time() &lt; $last_posted + $throttle_time && !current_user_can( 'throttle' ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks topics and replies against the discussion moderation of blocked keys</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3581)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $anonymous_data Anonymous user data</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $author_id Topic or reply author ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title The title of the content</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The content being posted</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_user_keymaster() Allow keymasters to bypass blacklist</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_current_author_ip() To get current user IP address</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_current_author_ua() To get current user agent</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if test is passed, false if fail</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_for_moderation( $anonymous_data = false, $author_id = 0, $title = '', $content = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow for moderation check to be skipped</span>&nbsp;</div></li><li><div>  if ( apply_filters( 'bbp_bypass_check_for_moderation', false, $anonymous_data, $author_id, $title, $content ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if keymaster is author</span></span>&nbsp;</div></li><li><div>  if ( !empty( $author_id ) && bbp_is_user_keymaster( $author_id ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Define local variable</span>(s)</span>&nbsp;</div></li><li><div>  $_post = array();&nbsp;</div></li><li><div>  $match_out = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Blacklist *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the moderation keys</span></span>&nbsp;</div></li><li><div>  $blacklist = trim( get_option( 'moderation_keys' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if blacklist is empty</span></span>&nbsp;</div></li><li><div>  if ( empty( $blacklist ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** User Data *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Map anonymous user data</span></span>&nbsp;</div></li><li><div>  if ( !empty( $anonymous_data ) ) {&nbsp;</div></li><li><div>      $_post['author'] = $anonymous_data['bbp_anonymous_name'];&nbsp;</div></li><li><div>      $_post['email'] = $anonymous_data['bbp_anonymous_email'];&nbsp;</div></li><li><div>      $_post['url'] = $anonymous_data['bbp_anonymous_website'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Map current user data</span></span>&nbsp;</div></li><li><div>  } elseif ( !empty( $author_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get author data</span></span>&nbsp;</div></li><li><div>      $user = get_userdata( $author_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If data exists, map it</span></span>&nbsp;</div></li><li><div>      if ( !empty( $user ) ) {&nbsp;</div></li><li><div>          $_post['author'] = $user-&gt;display_name;&nbsp;</div></li><li><div>          $_post['email'] = $user-&gt;user_email;&nbsp;</div></li><li><div>          $_post['url'] = $user-&gt;user_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Current user IP and user agent</span></span>&nbsp;</div></li><li><div>  $_post['user_ip'] = bbp_current_author_ip();&nbsp;</div></li><li><div>  $_post['user_ua'] = bbp_current_author_ua();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Post title and content</span></span>&nbsp;</div></li><li><div>  $_post['title'] = $title;&nbsp;</div></li><li><div>  $_post['content'] = $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Max Links *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $max_links = get_option( 'comment_max_links' );&nbsp;</div></li><li><div>  if ( !empty( $max_links ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// How many links?</span>&nbsp;</div></li><li><div>      $num_links = preg_match_all( '/&lt;a [^&gt;]*href/i', $content, $match_out );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Allow for bumping the max to include the user's URL</span>&nbsp;</div></li><li><div>      $num_links = apply_filters( 'comment_max_links_url', $num_links, $_post['url'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Das ist zu viele links!</span>&nbsp;</div></li><li><div>      if ( $num_links &gt;= $max_links ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Words *****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get words separated by new lines</span></span>&nbsp;</div></li><li><div>  $words = explode( &quot;\n&quot;, $blacklist );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Loop through words</span></span>&nbsp;</div></li><li><div>  foreach ( (array) $words as $word ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Trim the whitespace from the word</span></span>&nbsp;</div></li><li><div>      $word = trim( $word );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Skip empty lines</span></span>&nbsp;</div></li><li><div>      if ( empty( $word ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Do some escaping magic so that '#' chars in the</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// spam words don't break things:</span></span>&nbsp;</div></li><li><div>      $word = preg_quote( $word, '#' );&nbsp;</div></li><li><div>      $pattern = &quot;#$word#i&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through post data</span></span>&nbsp;</div></li><li><div>      foreach ( $_post as $post_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Check each user data for current word</span></span>&nbsp;</div></li><li><div>          if ( preg_match( $pattern, $post_data ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Post does not pass</span></span>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check passed successfully</span></span>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks topics and replies against the discussion blacklist of blocked keys</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3446)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $anonymous_data Anonymous user data</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $author_id Topic or reply author ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title The title of the content</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The content being posted</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_user_keymaster() Allow keymasters to bypass blacklist</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_current_author_ip() To get current user IP address</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_current_author_ua() To get current user agent</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if test is passed, false if fail</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_check_for_blacklist( $anonymous_data = false, $author_id = 0, $title = '', $content = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow for blacklist check to be skipped</span>&nbsp;</div></li><li><div>  if ( apply_filters( 'bbp_bypass_check_for_blacklist', false, $anonymous_data, $author_id, $title, $content ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if keymaster is author</span></span>&nbsp;</div></li><li><div>  if ( !empty( $author_id ) && bbp_is_user_keymaster( $author_id ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Define local variable</span>&nbsp;</div></li><li><div>  $_post = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Blacklist *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the moderation keys</span></span>&nbsp;</div></li><li><div>  $blacklist = trim( get_option( 'blacklist_keys' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if blacklist is empty</span></span>&nbsp;</div></li><li><div>  if ( empty( $blacklist ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** User Data *************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Map anonymous user data</span></span>&nbsp;</div></li><li><div>  if ( !empty( $anonymous_data ) ) {&nbsp;</div></li><li><div>      $_post['author'] = $anonymous_data['bbp_anonymous_name'];&nbsp;</div></li><li><div>      $_post['email'] = $anonymous_data['bbp_anonymous_email'];&nbsp;</div></li><li><div>      $_post['url'] = $anonymous_data['bbp_anonymous_website'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Map current user data</span></span>&nbsp;</div></li><li><div>  } elseif ( !empty( $author_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get author data</span></span>&nbsp;</div></li><li><div>      $user = get_userdata( $author_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If data exists, map it</span></span>&nbsp;</div></li><li><div>      if ( !empty( $user ) ) {&nbsp;</div></li><li><div>          $_post['author'] = $user-&gt;display_name;&nbsp;</div></li><li><div>          $_post['email'] = $user-&gt;user_email;&nbsp;</div></li><li><div>          $_post['url'] = $user-&gt;user_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Current user IP and user agent</span></span>&nbsp;</div></li><li><div>  $_post['user_ip'] = bbp_current_author_ip();&nbsp;</div></li><li><div>  $_post['user_ua'] = bbp_current_author_ua();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Post title and content</span></span>&nbsp;</div></li><li><div>  $_post['title'] = $title;&nbsp;</div></li><li><div>  $_post['content'] = $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Words *****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get words separated by new lines</span></span>&nbsp;</div></li><li><div>  $words = explode( &quot;\n&quot;, $blacklist );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Loop through words</span></span>&nbsp;</div></li><li><div>  foreach ( (array) $words as $word ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Trim the whitespace from the word</span></span>&nbsp;</div></li><li><div>      $word = trim( $word );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Skip empty lines</span></span>&nbsp;</div></li><li><div>      if ( empty( $word ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Do some escaping magic so that '#' chars in the</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// spam words don't break things:</span></span>&nbsp;</div></li><li><div>      $word = preg_quote( $word, '#' );&nbsp;</div></li><li><div>      $pattern = &quot;#$word#i&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through post data</span></span>&nbsp;</div></li><li><div>      foreach ( $_post as $post_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Check each user data for current word</span></span>&nbsp;</div></li><li><div>          if ( preg_match( $pattern, $post_data ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Post does not pass</span></span>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check passed successfully</span></span>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Subscriptions *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the &quot;Do Not Reply&quot; email address to use when sending subscription emails.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We make some educated guesses here based on the home URL. Filters are</span>&nbsp;</div></li><li><div><span class="comment"> * available to customize this address further. In the future, we may consider</span>&nbsp;</div></li><li><div><span class="comment"> * using `admin_email` instead, though this is not normally publicized.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We use `$_SERVER['SERVER_NAME']` here to mimic similar functionality in</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress core. Previously, we used `get_home_url()` to use already validated</span>&nbsp;</div></li><li><div><span class="comment"> * user input, but it was causing issues in some installations.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5409)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see  wp_mail</span>&nbsp;</div></li><li><div><span class="comment"> * @see  wp_notify_postauthor</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://bbpress.trac.wordpress.org/ticket/2618</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_do_not_reply_address() {&nbsp;</div></li><li><div>  $sitename = strtolower( $_SERVER['SERVER_NAME'] );&nbsp;</div></li><li><div>  if ( substr( $sitename, 0, 4 ) === 'www.' ) {&nbsp;</div></li><li><div>      $sitename = substr( $sitename, 4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_do_not_reply_address', 'noreply@' . $sitename );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends notification emails for new replies to subscribed topics</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Gets new post's ID and check if there are subscribed users to that topic, and</span>&nbsp;</div></li><li><div><span class="comment"> * if there are, send notifications</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note: in bbPress 2.6, we've moved away from 1 email per subscriber to 1 email</span>&nbsp;</div></li><li><div><span class="comment"> * with everyone BCC'd. This may have negative repercussions for email services</span>&nbsp;</div></li><li><div><span class="comment"> * that limit the number of addresses in a BCC field (often to around 500.) In</span>&nbsp;</div></li><li><div><span class="comment"> * those cases, we recommend unhooking this function and creating your own</span>&nbsp;</div></li><li><div><span class="comment"> * custom emailer script.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5413)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id ID of the newly made reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id ID of the topic of the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id ID of the forum of the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $anonymous_data Array of anonymous user data</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_author ID of the topic author ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_subscriptions_active() To check if the subscriptions are active</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_id() To validate the reply ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To validate the topic ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To validate the forum ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply() To get the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_reply_published() To make sure the reply is published</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To validate the topic ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic() To get the reply's topic</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_published() To make sure the topic is published</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_reply_author_display_name() To get the reply author's display name</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_pre_notify_subscribers' with the reply id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    topic id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_subscribers() To get the topic subscribers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_subscription_mail_message' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                    message, reply id, topic id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_subscription_mail_title' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                    topic title, reply id, topic id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_subscription_mail_headers'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_userdata() To get the user data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_mail() To send the mail</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_post_notify_subscribers' with the reply id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    topic id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_notify_topic_subscribers( $reply_id = 0, $topic_id = 0, $forum_id = 0, $anonymous_data = false, $reply_author = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if subscriptions are turned off</span></span>&nbsp;</div></li><li><div>  if ( !bbp_is_subscriptions_active() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Validation ************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $reply_id = bbp_get_reply_id( $reply_id );&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $forum_id = bbp_get_forum_id( $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic *****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if topic is not published</span></span>&nbsp;</div></li><li><div>  if ( !bbp_is_topic_published( $topic_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Reply *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if reply is not published</span>&nbsp;</div></li><li><div>  if ( !bbp_is_reply_published( $reply_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Poster name</span></span>&nbsp;</div></li><li><div>  $reply_author_name = bbp_get_reply_author_display_name( $reply_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Mail ******************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove filters from reply content and topic title to prevent content</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// from being encoded with HTML entities, wrapped in paragraph tags, etc...</span></span>&nbsp;</div></li><li><div>  remove_all_filters( 'bbp_get_reply_content' );&nbsp;</div></li><li><div>  remove_all_filters( 'bbp_get_topic_title' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Strip tags from text and setup mail data</span></span>&nbsp;</div></li><li><div>  $topic_title = strip_tags( bbp_get_topic_title( $topic_id ) );&nbsp;</div></li><li><div>  $reply_content = strip_tags( bbp_get_reply_content( $reply_id ) );&nbsp;</div></li><li><div>  $reply_url = bbp_get_reply_url( $reply_id );&nbsp;</div></li><li><div>  $blog_name = wp_specialchars_decode( get_option( 'blogname' ), ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// For plugins to filter messages per reply/topic/user</span></span>&nbsp;</div></li><li><div>  $message = sprintf( __( '%1$s wrote:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>%2$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Post Link: %3$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>-----------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>You are receiving this email because you subscribed to a forum topic.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Login and visit the topic to unsubscribe from these emails.', 'bbpress' ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $reply_author_name, &nbsp;</div></li><li><div>      $reply_content, &nbsp;</div></li><li><div>      $reply_url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = apply_filters( 'bbp_subscription_mail_message', $message, $reply_id, $topic_id );&nbsp;</div></li><li><div>  if ( empty( $message ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// For plugins to filter titles per reply/topic/user</span></span>&nbsp;</div></li><li><div>  $subject = apply_filters( 'bbp_subscription_mail_title', '[' . $blog_name . '] ' . $topic_title, $reply_id, $topic_id );&nbsp;</div></li><li><div>  if ( empty( $subject ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Users *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the noreply@ address</span></span>&nbsp;</div></li><li><div>  $no_reply = bbp_get_do_not_reply_address();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup &quot;From&quot; email address</span></span>&nbsp;</div></li><li><div>  $from_email = apply_filters( 'bbp_subscription_from_email', $no_reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup the From header</span></span>&nbsp;</div></li><li><div>  $headers = array( 'From: ' . get_bloginfo( 'name' ) . ' &lt;' . $from_email . '&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get topic subscribers and bail if empty</span></span>&nbsp;</div></li><li><div>  $user_ids = bbp_get_topic_subscribers( $topic_id, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Dedicated filter to manipulate user ID's to send emails to</span></span>&nbsp;</div></li><li><div>  $user_ids = apply_filters( 'bbp_topic_subscription_user_ids', $user_ids );&nbsp;</div></li><li><div>  if ( empty( $user_ids ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Loop through users</span></span>&nbsp;</div></li><li><div>  foreach ( (array) $user_ids as $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Don't send notifications to the person who made the post</span></span>&nbsp;</div></li><li><div>      if ( !empty( $reply_author ) && (int) $user_id === (int) $reply_author ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get email address of subscribed user</span></span>&nbsp;</div></li><li><div>      $headers[] = 'Bcc: ' . get_userdata( $user_id )-&gt;user_email;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Send it ***************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Custom headers</span></span>&nbsp;</div></li><li><div>  $headers = apply_filters( 'bbp_subscription_mail_headers', $headers );&nbsp;</div></li><li><div>   $to_email = apply_filters( 'bbp_subscription_to_email', $no_reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_pre_notify_subscribers', $reply_id, $topic_id, $user_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Send notification email</span></span>&nbsp;</div></li><li><div>  wp_mail( $to_email, $subject, $message, $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_post_notify_subscribers', $reply_id, $topic_id, $user_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends notification emails for new topics to subscribed forums</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Gets new post's ID and check if there are subscribed users to that forum, and</span>&nbsp;</div></li><li><div><span class="comment"> * if there are, send notifications</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note: in bbPress 2.6, we've moved away from 1 email per subscriber to 1 email</span>&nbsp;</div></li><li><div><span class="comment"> * with everyone BCC'd. This may have negative repercussions for email services</span>&nbsp;</div></li><li><div><span class="comment"> * that limit the number of addresses in a BCC field (often to around 500.) In</span>&nbsp;</div></li><li><div><span class="comment"> * those cases, we recommend unhooking this function and creating your own</span>&nbsp;</div></li><li><div><span class="comment"> * custom emailer script.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r5156)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id ID of the newly made reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id ID of the forum for the topic</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $anonymous_data Array of anonymous user data</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_author ID of the topic author ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_subscriptions_active() To check if the subscriptions are active</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_id() To validate the topic ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_id() To validate the forum ID</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_is_topic_published() To make sure the topic is published</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_forum_subscribers() To get the forum subscribers</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_author_display_name() To get the topic author's display name</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_pre_notify_forum_subscribers' with the topic id, </span>&nbsp;</div></li><li><div><span class="comment"> *                    forum id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_forum_subscription_mail_message' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                    message, topic id, forum id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_forum_subscription_mail_title' with the</span>&nbsp;</div></li><li><div><span class="comment"> *                    topic title, topic id, forum id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_forum_subscription_mail_headers'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_userdata() To get the user data</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_mail() To send the mail</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_post_notify_forum_subscribers' with the topic, </span>&nbsp;</div></li><li><div><span class="comment"> *                    id, forum id and user id</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_notify_forum_subscribers( $topic_id = 0, $forum_id = 0, $anonymous_data = false, $topic_author = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if subscriptions are turned off</span></span>&nbsp;</div></li><li><div>  if ( !bbp_is_subscriptions_active() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Validation ************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $topic_id = bbp_get_topic_id( $topic_id );&nbsp;</div></li><li><div>  $forum_id = bbp_get_forum_id( $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Necessary for backwards compatibility</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see https://bbpress.trac.wordpress.org/ticket/2620</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Topic *****************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if topic is not published</span></span>&nbsp;</div></li><li><div>  if ( ! bbp_is_topic_published( $topic_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Poster name</span></span>&nbsp;</div></li><li><div>  $topic_author_name = bbp_get_topic_author_display_name( $topic_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Mail ******************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Remove filters from reply content and topic title to prevent content</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// from being encoded with HTML entities, wrapped in paragraph tags, etc...</span></span>&nbsp;</div></li><li><div>  remove_all_filters( 'bbp_get_topic_content' );&nbsp;</div></li><li><div>  remove_all_filters( 'bbp_get_topic_title' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Strip tags from text and setup mail data</span></span>&nbsp;</div></li><li><div>  $topic_title = strip_tags( bbp_get_topic_title( $topic_id ) );&nbsp;</div></li><li><div>  $topic_content = strip_tags( bbp_get_topic_content( $topic_id ) );&nbsp;</div></li><li><div>  $topic_url = get_permalink( $topic_id );&nbsp;</div></li><li><div>  $blog_name = wp_specialchars_decode( get_option( 'blogname' ), ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// For plugins to filter messages per reply/topic/user</span></span>&nbsp;</div></li><li><div>  $message = sprintf( __( '%1$s wrote:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>%2$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Topic Link: %3$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>-----------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>You are receiving this email because you subscribed to a forum.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Login and visit the topic to unsubscribe from these emails.', 'bbpress' ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $topic_author_name, &nbsp;</div></li><li><div>      $topic_content, &nbsp;</div></li><li><div>      $topic_url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = apply_filters( 'bbp_forum_subscription_mail_message', $message, $topic_id, $forum_id, $user_id );&nbsp;</div></li><li><div>  if ( empty( $message ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// For plugins to filter titles per reply/topic/user</span></span>&nbsp;</div></li><li><div>  $subject = apply_filters( 'bbp_forum_subscription_mail_title', '[' . $blog_name . '] ' . $topic_title, $topic_id, $forum_id, $user_id );&nbsp;</div></li><li><div>  if ( empty( $subject ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** User ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get the noreply@ address</span></span>&nbsp;</div></li><li><div>  $no_reply = bbp_get_do_not_reply_address();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup &quot;From&quot; email address</span></span>&nbsp;</div></li><li><div>  $from_email = apply_filters( 'bbp_subscription_from_email', $no_reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup the From header</span></span>&nbsp;</div></li><li><div>  $headers = array( 'From: ' . get_bloginfo( 'name' ) . ' &lt;' . $from_email . '&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get topic subscribers and bail if empty</span></span>&nbsp;</div></li><li><div>  $user_ids = bbp_get_forum_subscribers( $forum_id, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Dedicated filter to manipulate user ID's to send emails to</span></span>&nbsp;</div></li><li><div>  $user_ids = apply_filters( 'bbp_forum_subscription_user_ids', $user_ids );&nbsp;</div></li><li><div>  if ( empty( $user_ids ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Loop through users</span></span>&nbsp;</div></li><li><div>  foreach ( (array) $user_ids as $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Don't send notifications to the person who made the post</span></span>&nbsp;</div></li><li><div>      if ( !empty( $topic_author ) && (int) $user_id === (int) $topic_author ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get email address of subscribed user</span></span>&nbsp;</div></li><li><div>      $headers[] = 'Bcc: ' . get_userdata( $user_id )-&gt;user_email;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Send it ***************************************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Custom headers</span></span>&nbsp;</div></li><li><div>  $headers = apply_filters( 'bbp_subscription_mail_headers', $headers );&nbsp;</div></li><li><div>  $to_email = apply_filters( 'bbp_subscription_to_email', $no_reply );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_pre_notify_forum_subscribers', $topic_id, $forum_id, $user_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Send notification email</span></span>&nbsp;</div></li><li><div>  wp_mail( $to_email, $subject, $message, $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bbp_post_notify_forum_subscribers', $topic_id, $forum_id, $user_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends notification emails for new replies to subscribed topics</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is deprecated. Please use: bbp_notify_topic_subscribers()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2668)</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated bbPress (r5412)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_id ID of the newly made reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $topic_id ID of the topic of the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $forum_id ID of the forum of the reply</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $anonymous_data Array of anonymous user data</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $reply_author ID of the topic author ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_notify_subscribers( $reply_id = 0, $topic_id = 0, $forum_id = 0, $anonymous_data = false, $reply_author = 0 ) {&nbsp;</div></li><li><div>  return bbp_notify_topic_subscribers( $reply_id, $topic_id, $forum_id, $anonymous_data, $reply_author );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Login *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return a clean and reliable logout URL</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url URL</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $redirect_to Where to redirect to?</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_query_arg() To add args to the url</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_logout_url' with the url and redirect to</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The url</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_logout_url( $url = '', $redirect_to = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure we are directing somewhere</span>&nbsp;</div></li><li><div>  if ( empty( $redirect_to ) && !strstr( $url, 'redirect_to' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Rejig the $redirect_to</span>&nbsp;</div></li><li><div>      if ( !isset( $_SERVER['REDIRECT_URL'] ) || ( $redirect_to !== home_url( $_SERVER['REDIRECT_URL'] ) ) ) {&nbsp;</div></li><li><div>          $redirect_to = isset( $_SERVER['HTTP_REFERER'] ) ? $_SERVER['HTTP_REFERER'] : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect_to = ( is_ssl() ? 'https:<span class="comment">//' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Sanitize $redirect_to and add it to full $url</span>&nbsp;</div></li><li><div>      $redirect_to = add_query_arg( array( 'loggedout' =&gt; 'true' ), esc_url( $redirect_to ) );&nbsp;</div></li><li><div>      $url = add_query_arg( array( 'redirect_to' =&gt; urlencode( $redirect_to ) ), $url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and return</span></span></span></span></span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_logout_url', $url, $redirect_to );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Queries *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Merge user defined arguments into defaults array.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is used throughout bbPress to allow for either a string or array</span>&nbsp;</div></li><li><div><span class="comment"> * to be merged into another array. It is identical to wp_parse_args() except</span>&nbsp;</div></li><li><div><span class="comment"> * it allows for arguments to be passively or aggressively filtered using the</span>&nbsp;</div></li><li><div><span class="comment"> * optional $filter_key parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3839)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $args Value to merge with $defaults</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $defaults Array that serves as the defaults.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $filter_key String to key the filters from</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Merged user defined values with defaults.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_parse_args( $args, $defaults = array(), $filter_key = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup a temporary array from $args</span>&nbsp;</div></li><li><div>  if ( is_object( $args ) ) {&nbsp;</div></li><li><div>      $r = get_object_vars( $args );&nbsp;</div></li><li><div>  } elseif ( is_array( $args ) ) {&nbsp;</div></li><li><div>      $r =& $args;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_parse_str( $args, $r );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Passively filter the args before the parse</span>&nbsp;</div></li><li><div>  if ( !empty( $filter_key ) ) {&nbsp;</div></li><li><div>      $r = apply_filters( 'bbp_before_' . $filter_key . '_parse_args', $r );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Parse</span>&nbsp;</div></li><li><div>  if ( is_array( $defaults ) && !empty( $defaults ) ) {&nbsp;</div></li><li><div>      $r = array_merge( $defaults, $r );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Aggressively filter the args after the parse</span>&nbsp;</div></li><li><div>  if ( !empty( $filter_key ) ) {&nbsp;</div></li><li><div>      $r = apply_filters( 'bbp_after_' . $filter_key . '_parse_args', $r );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return the parsed results</span>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds ability to include or exclude specific post_parent ID's</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r2996)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global DB $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP $wp</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $where</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Query $object</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_query_post_parent__in( $where, $object = '' ) {&nbsp;</div></li><li><div>  global $wpdb, $wp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Noop if WP core supports this already</span>&nbsp;</div></li><li><div>  if ( in_array( 'post_parent__in', $wp-&gt;private_query_vars ) )&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no object passed</span>&nbsp;</div></li><li><div>  if ( empty( $object ) )&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only 1 post_parent so return $where</span>&nbsp;</div></li><li><div>  if ( is_numeric( $object-&gt;query_vars['post_parent'] ) )&nbsp;</div></li><li><div>      return $where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Including specific post_parent's</span>&nbsp;</div></li><li><div>  if ( ! empty( $object-&gt;query_vars['post_parent__in'] ) ) {&nbsp;</div></li><li><div>      $ids = implode( ', ', wp_parse_id_list( $object-&gt;query_vars['post_parent__in'] ) );&nbsp;</div></li><li><div>      $where .= &quot; AND {$wpdb-&gt;posts}.post_parent IN ($ids)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Excluding specific post_parent's</span>&nbsp;</div></li><li><div>  } elseif ( ! empty( $object-&gt;query_vars['post_parent__not_in'] ) ) {&nbsp;</div></li><li><div>      $ids = implode( ', ', wp_parse_id_list( $object-&gt;query_vars['post_parent__not_in'] ) );&nbsp;</div></li><li><div>      $where .= &quot; AND {$wpdb-&gt;posts}.post_parent NOT IN ($ids)&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return possibly modified $where</span>&nbsp;</div></li><li><div>  return $where;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Query the DB and get the last public post_id that has parent_id as post_parent</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $parent_id Parent id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type Post type. Defaults to 'post'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_get() To check if there is a cache of the last child id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare the query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_var() To get the result of the query in a variable</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_set() To set the cache for future use</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_public_child_last_id' with the child</span>&nbsp;</div></li><li><div><span class="comment"> *                        id, parent id and post type</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The last active post_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_public_child_last_id( $parent_id = 0, $post_type = 'post' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Bail if nothing passed</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $parent_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// The ID of the cached query</span></span></span></span>&nbsp;</div></li><li><div>  $cache_id = 'bbp_parent_' . $parent_id . '_type_' . $post_type . '_child_last_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check for cache and set if needed</span></span></span></span>&nbsp;</div></li><li><div>  $child_id = wp_cache_get( $cache_id, 'bbpress_posts' );&nbsp;</div></li><li><div>  if ( false === $child_id ) {&nbsp;</div></li><li><div>      $post_status = array( bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add closed status if topic post type</span></span></span>&nbsp;</div></li><li><div>      if ( $post_type === bbp_get_topic_post_type() ) {&nbsp;</div></li><li><div>          $post_status[] = bbp_get_closed_status_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Join post statuses together</span></span></span></span>&nbsp;</div></li><li><div>      $post_status = &quot;'&quot; . implode( &quot;', '&quot;, $post_status ) . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $child_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_status IN ( {$post_status} ) AND post_type = '%s' ORDER BY ID DESC LIMIT 1;&quot;, $parent_id, $post_type ) );&nbsp;</div></li><li><div>      wp_cache_set( $cache_id, $child_id, 'bbpress_posts' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and return</span></span></span></span></span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_public_child_last_id', (int) $child_id, $parent_id, $post_type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Query the DB and get a count of public children</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $parent_id Parent id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type Post type. Defaults to 'post'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_get() To check if there is a cache of the children count</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare the query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_var() To get the result of the query in a variable</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_set() To set the cache for future use</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_public_child_count' with the child</span>&nbsp;</div></li><li><div><span class="comment"> *                        count, parent id and post type</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The number of children</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_public_child_count( $parent_id = 0, $post_type = 'post' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Bail if nothing passed</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $parent_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// The ID of the cached query</span></span></span></span>&nbsp;</div></li><li><div>  $cache_id = 'bbp_parent_' . $parent_id . '_type_' . $post_type . '_child_count';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check for cache and set if needed</span></span></span></span>&nbsp;</div></li><li><div>  $child_count = wp_cache_get( $cache_id, 'bbpress_posts' );&nbsp;</div></li><li><div>  if ( false === $child_count ) {&nbsp;</div></li><li><div>      $post_status = array( bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add closed status if topic post type</span></span></span>&nbsp;</div></li><li><div>      if ( $post_type === bbp_get_topic_post_type() ) {&nbsp;</div></li><li><div>          $post_status[] = bbp_get_closed_status_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Join post statuses together</span></span></span></span>&nbsp;</div></li><li><div>      $post_status = &quot;'&quot; . implode( &quot;', '&quot;, $post_status ) . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $child_count = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT(ID) FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_status IN ( {$post_status} ) AND post_type = '%s';&quot;, $parent_id, $post_type ) );&nbsp;</div></li><li><div>      wp_cache_set( $cache_id, $child_count, 'bbpress_posts' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and return</span></span></span></span></span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_public_child_count', (int) $child_count, $parent_id, $post_type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Query the DB and get a the child id's of public children</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $parent_id Parent id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type Post type. Defaults to 'post'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_get() To check if there is a cache of the children</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare the query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_col() To get the result of the query in an array</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_set() To set the cache for future use</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_public_child_ids' with the child ids, </span>&nbsp;</div></li><li><div><span class="comment"> *                        parent id and post type</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The array of children</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_public_child_ids( $parent_id = 0, $post_type = 'post' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Bail if nothing passed</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $parent_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// The ID of the cached query</span></span></span></span>&nbsp;</div></li><li><div>  $cache_id = 'bbp_parent_public_' . $parent_id . '_type_' . $post_type . '_child_ids';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check for cache and set if needed</span></span></span></span>&nbsp;</div></li><li><div>  $child_ids = wp_cache_get( $cache_id, 'bbpress_posts' );&nbsp;</div></li><li><div>  if ( false === $child_ids ) {&nbsp;</div></li><li><div>      $post_status = array( bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add closed status if topic post type</span></span></span>&nbsp;</div></li><li><div>      if ( $post_type === bbp_get_topic_post_type() ) {&nbsp;</div></li><li><div>          $post_status[] = bbp_get_closed_status_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Join post statuses together</span></span></span></span>&nbsp;</div></li><li><div>      $post_status = &quot;'&quot; . implode( &quot;', '&quot;, $post_status ) . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $child_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_status IN ( {$post_status} ) AND post_type = '%s' ORDER BY ID DESC;&quot;, $parent_id, $post_type ) );&nbsp;</div></li><li><div>      wp_cache_set( $cache_id, $child_ids, 'bbpress_posts' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and return</span></span></span></span></span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_public_child_ids', $child_ids, $parent_id, $post_type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Query the DB and get a the child id's of all children</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $parent_id Parent id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type Post type. Defaults to 'post'</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bbp_get_topic_post_type() To get the topic post type</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_get() To check if there is a cache of the children</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::prepare() To prepare the query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpdb::get_col() To get the result of the query in an array</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_set() To set the cache for future use</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bbp_get_public_child_ids' with the child ids, </span>&nbsp;</div></li><li><div><span class="comment"> *                        parent id and post type</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The array of children</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_all_child_ids( $parent_id = 0, $post_type = 'post' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Bail if nothing passed</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $parent_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// The ID of the cached query</span></span></span></span>&nbsp;</div></li><li><div>  $cache_id = 'bbp_parent_all_' . $parent_id . '_type_' . $post_type . '_child_ids';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check for cache and set if needed</span></span></span></span>&nbsp;</div></li><li><div>  $child_ids = wp_cache_get( $cache_id, 'bbpress_posts' );&nbsp;</div></li><li><div>  if ( false === $child_ids ) {&nbsp;</div></li><li><div>      $post_status = array( bbp_get_public_status_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Extra post statuses based on post type</span>&nbsp;</div></li><li><div>      switch ( $post_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Forum</span></span>&nbsp;</div></li><li><div>          case bbp_get_forum_post_type() :&nbsp;</div></li><li><div>              $post_status[] = bbp_get_private_status_id();&nbsp;</div></li><li><div>              $post_status[] = bbp_get_hidden_status_id();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Topic</span>&nbsp;</div></li><li><div>          case bbp_get_topic_post_type() :&nbsp;</div></li><li><div>              $post_status[] = bbp_get_closed_status_id();&nbsp;</div></li><li><div>              $post_status[] = bbp_get_trash_status_id();&nbsp;</div></li><li><div>              $post_status[] = bbp_get_spam_status_id();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Reply</span>&nbsp;</div></li><li><div>          case bbp_get_reply_post_type() :&nbsp;</div></li><li><div>              $post_status[] = bbp_get_trash_status_id();&nbsp;</div></li><li><div>              $post_status[] = bbp_get_spam_status_id();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Join post statuses together</span></span></span></span>&nbsp;</div></li><li><div>      $post_status = &quot;'&quot; . implode( &quot;', '&quot;, $post_status ) . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $child_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_status IN ( {$post_status} ) AND post_type = '%s' ORDER BY ID DESC;&quot;, $parent_id, $post_type ) );&nbsp;</div></li><li><div>      wp_cache_set( $cache_id, $child_ids, 'bbpress_posts' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Filter and return</span></span></span></span></span>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_all_child_ids', $child_ids, (int) $parent_id, $post_type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Globals *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the unfiltered value of a global $post's key</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used most frequently when editing a forum/topic/reply</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3694)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Query $post</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $field Name of the key</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $context How to sanitize - raw|edit|db|display|attribute|js</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Field value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_global_post_field( $field = 'ID', $context = 'edit' ) {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = isset( $post-&gt;$field ) ? $post-&gt;$field : '';&nbsp;</div></li><li><div>  $retval = sanitize_post_field( $field, $retval, $post-&gt;ID, $context );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_global_post_field', $retval, $post );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Nonces ********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Makes sure the user requested an action from another page on this site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * To avoid security exploits within the theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r4022)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action() Calls 'bbp_check_referer' on $action.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action nonce</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $query_arg where to look for nonce in $_REQUEST</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_verify_nonce_request( $action = '', $query_arg = '_wpnonce' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Home URL **************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Parse</span> home_url() into pieces to remove query-strings, strange characters, &nbsp;</div></li><li><div>  <span class="comment">// and other funny things that plugins might to do to it.</span>&nbsp;</div></li><li><div>  $parsed_home = parse_url( home_url( '/', ( is_ssl() ? 'https' : 'http' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Maybe include the port, if it's included</span>&nbsp;</div></li><li><div>  if ( isset( $parsed_home['port'] ) ) {&nbsp;</div></li><li><div>      $parsed_host = $parsed_home['host'] . ':' . $parsed_home['port'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $parsed_host = $parsed_home['host'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the home URL for use in comparisons</span>&nbsp;</div></li><li><div>  $home_url = trim( strtolower( $parsed_home['scheme'] . ':<span class="comment">//' . $parsed_host . $parsed_home['path'] ), '/' );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Requested URL *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Maybe include the port, if it's included</span> in home_url()&nbsp;</div></li><li><div>  if ( isset( $parsed_home['port'] ) ) {&nbsp;</div></li><li><div>      $request_host = $_SERVER['HTTP_HOST'] . ':' . $_SERVER['SERVER_PORT'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $request_host = $_SERVER['HTTP_HOST'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Build the currently requested URL</span>&nbsp;</div></li><li><div>  $scheme = is_ssl() ? 'https:<span class="comment">//' : 'http://';</span>&nbsp;</div></li><li><div>  $requested_url = strtolower( $scheme . $request_host . $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Look for match ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Filter the requested URL, for configurations like reverse proxying</span>&nbsp;</div></li><li><div>  $matched_url = apply_filters( 'bbp_verify_nonce_request_url', $requested_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the nonce</span>&nbsp;</div></li><li><div>  $result = isset( $_REQUEST[$query_arg] ) ? wp_verify_nonce( $_REQUEST[$query_arg], $action ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Nonce check failed</span>&nbsp;</div></li><li><div>  if ( empty( $result ) || empty( $action ) || ( strpos( $matched_url, $home_url ) !== 0 ) ) {&nbsp;</div></li><li><div>      $result = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do extra things</span>&nbsp;</div></li><li><div>  do_action( 'bbp_verify_nonce_request', $action, $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Feeds *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * This function is hooked into the WordPress 'request' action and is</span>&nbsp;</div></li><li><div><span class="comment"> * responsible for sniffing out the query vars and serving up RSS2 feeds if</span>&nbsp;</div></li><li><div><span class="comment"> * the stars align and the user has requested a feed of any bbPress type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3171)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $query_vars</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_request_feed_trap( $query_vars = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Looking at a feed</span>&nbsp;</div></li><li><div>  if ( isset( $query_vars['feed'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Forum</span></span>/Topic/Reply Feed&nbsp;</div></li><li><div>      if ( isset( $query_vars['post_type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Matched post type</span>&nbsp;</div></li><li><div>          $post_type = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Post types to check</span>&nbsp;</div></li><li><div>          $post_types = array(&nbsp;</div></li><li><div>              bbp_get_forum_post_type(), &nbsp;</div></li><li><div>              bbp_get_topic_post_type(), &nbsp;</div></li><li><div>              bbp_get_reply_post_type()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Cast query vars as array outside of foreach loop</span>&nbsp;</div></li><li><div>          $qv_array = (array) $query_vars['post_type'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Check if this query is for a bbPress post type</span>&nbsp;</div></li><li><div>          foreach ( $post_types as $bbp_pt ) {&nbsp;</div></li><li><div>              if ( in_array( $bbp_pt, $qv_array, true ) ) {&nbsp;</div></li><li><div>                  $post_type = $bbp_pt;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Looking at a bbPress post type</span>&nbsp;</div></li><li><div>          if ( ! empty( $post_type ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Supported select query vars</span>&nbsp;</div></li><li><div>              $select_query_vars = array(&nbsp;</div></li><li><div>                  'p' =&gt; false, &nbsp;</div></li><li><div>                  'name' =&gt; false, &nbsp;</div></li><li><div>                  $post_type =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Setup matched variables to select</span>&nbsp;</div></li><li><div>              foreach ( $query_vars as $key =&gt; $value ) {&nbsp;</div></li><li><div>                  if ( isset( $select_query_vars[$key] ) ) {&nbsp;</div></li><li><div>                      $select_query_vars[$key] = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Remove any empties</span>&nbsp;</div></li><li><div>              $select_query_vars = array_filter( $select_query_vars );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// What bbPress post type are we looking for feeds on?</span>&nbsp;</div></li><li><div>              switch ( $post_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Forum</span></span>&nbsp;</div></li><li><div>                  case bbp_get_forum_post_type() :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Define local variable</span>(s)</span>&nbsp;</div></li><li><div>                      $meta_query = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Single forum</span>&nbsp;</div></li><li><div>                      if ( !empty( $select_query_vars ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment">// Load up our own query</span></span>&nbsp;</div></li><li><div>                          query_posts( array_merge( array(&nbsp;</div></li><li><div>                              'post_type' =&gt; bbp_get_forum_post_type(), &nbsp;</div></li><li><div>                              'feed' =&gt; true&nbsp;</div></li><li><div> ), $select_query_vars ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// Restrict to specific forum ID</span>&nbsp;</div></li><li><div>                          $meta_query = array( array(&nbsp;</div></li><li><div>                              'key' =&gt; '_bbp_forum_id', &nbsp;</div></li><li><div>                              'value' =&gt; bbp_get_forum_id(), &nbsp;</div></li><li><div>                              'type' =&gt; 'numeric', &nbsp;</div></li><li><div>                              'compare' =&gt; '='&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Only forum replies</span>&nbsp;</div></li><li><div>                      if ( !empty( $_GET['type'] ) && ( bbp_get_reply_post_type() === $_GET['type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// The query</span></span></span></span></span>&nbsp;</div></li><li><div>                          $the_query = array(&nbsp;</div></li><li><div>                              'author' =&gt; 0, &nbsp;</div></li><li><div>                              'feed' =&gt; true, &nbsp;</div></li><li><div>                              'post_type' =&gt; bbp_get_reply_post_type(), &nbsp;</div></li><li><div>                              'post_parent' =&gt; 'any', &nbsp;</div></li><li><div>                              'post_status' =&gt; array( bbp_get_public_status_id(), bbp_get_closed_status_id() ), &nbsp;</div></li><li><div>                              'posts_per_page' =&gt; bbp_get_replies_per_rss_page(), &nbsp;</div></li><li><div>                              'order' =&gt; 'DESC', &nbsp;</div></li><li><div>                              'meta_query' =&gt; $meta_query&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>                          bbp_display_replies_feed_rss2( $the_query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Only forum topics</span>&nbsp;</div></li><li><div>                      } elseif ( !empty( $_GET['type'] ) && ( bbp_get_topic_post_type() === $_GET['type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// The query</span></span></span></span></span>&nbsp;</div></li><li><div>                          $the_query = array(&nbsp;</div></li><li><div>                              'author' =&gt; 0, &nbsp;</div></li><li><div>                              'feed' =&gt; true, &nbsp;</div></li><li><div>                              'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>                              'post_parent' =&gt; bbp_get_forum_id(), &nbsp;</div></li><li><div>                              'post_status' =&gt; array( bbp_get_public_status_id(), bbp_get_closed_status_id() ), &nbsp;</div></li><li><div>                              'posts_per_page' =&gt; bbp_get_topics_per_rss_page(), &nbsp;</div></li><li><div>                              'order' =&gt; 'DESC'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>                          bbp_display_topics_feed_rss2( $the_query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// All forum topics and replies</span>&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// Exclude private/hidden forums if not looking at single</span>&nbsp;</div></li><li><div>                          if ( empty( $select_query_vars ) )&nbsp;</div></li><li><div>                              $meta_query = array( bbp_exclude_forum_ids( 'meta_query' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// The query</span></span></span></span></span>&nbsp;</div></li><li><div>                          $the_query = array(&nbsp;</div></li><li><div>                              'author' =&gt; 0, &nbsp;</div></li><li><div>                              'feed' =&gt; true, &nbsp;</div></li><li><div>                              'post_type' =&gt; array( bbp_get_reply_post_type(), bbp_get_topic_post_type() ), &nbsp;</div></li><li><div>                              'post_parent' =&gt; 'any', &nbsp;</div></li><li><div>                              'post_status' =&gt; array( bbp_get_public_status_id(), bbp_get_closed_status_id() ), &nbsp;</div></li><li><div>                              'posts_per_page' =&gt; bbp_get_replies_per_rss_page(), &nbsp;</div></li><li><div>                              'order' =&gt; 'DESC', &nbsp;</div></li><li><div>                              'meta_query' =&gt; $meta_query&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>                          bbp_display_replies_feed_rss2( $the_query );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Topic</span> feed - Show replies&nbsp;</div></li><li><div>                  case bbp_get_topic_post_type() :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Single topic</span>&nbsp;</div></li><li><div>                      if ( !empty( $select_query_vars ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment">// Load up our own query</span></span>&nbsp;</div></li><li><div>                          query_posts( array_merge( array(&nbsp;</div></li><li><div>                              'post_type' =&gt; bbp_get_topic_post_type(), &nbsp;</div></li><li><div>                              'feed' =&gt; true&nbsp;</div></li><li><div> ), $select_query_vars ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>                          bbp_display_replies_feed_rss2( array( 'feed' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// All topics</span>&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// The query</span></span></span></span></span>&nbsp;</div></li><li><div>                          $the_query = array(&nbsp;</div></li><li><div>                              'author' =&gt; 0, &nbsp;</div></li><li><div>                              'feed' =&gt; true, &nbsp;</div></li><li><div>                              'post_parent' =&gt; 'any', &nbsp;</div></li><li><div>                              'posts_per_page' =&gt; bbp_get_topics_per_rss_page(), &nbsp;</div></li><li><div>                              'show_stickies' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>                          bbp_display_topics_feed_rss2( $the_query );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Replies</span></span>&nbsp;</div></li><li><div>                  case bbp_get_reply_post_type() :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// The query</span></span></span></span></span>&nbsp;</div></li><li><div>                      $the_query = array(&nbsp;</div></li><li><div>                          'posts_per_page' =&gt; bbp_get_replies_per_rss_page(), &nbsp;</div></li><li><div>                          'meta_query' =&gt; array( array( ) ), &nbsp;</div></li><li><div>                          'feed' =&gt; true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// All replies</span>&nbsp;</div></li><li><div>                      if ( empty( $select_query_vars ) ) {&nbsp;</div></li><li><div>                          bbp_display_replies_feed_rss2( $the_query );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Single Topic Vview</span>&nbsp;</div></li><li><div>      } elseif ( isset( $query_vars[ bbp_get_view_rewrite_id() ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the view</span>&nbsp;</div></li><li><div>          $view = $query_vars[ bbp_get_view_rewrite_id() ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We have a view to display a feed</span>&nbsp;</div></li><li><div>          if ( !empty( $view ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the view</span> query&nbsp;</div></li><li><div>              $the_query = bbp_get_view_query_args( $view );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Output the feed</span></span></span></span></span></span>&nbsp;</div></li><li><div>              bbp_display_topics_feed_rss2( $the_query );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// @todo User profile feeds</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No feed so continue on</span>&nbsp;</div></li><li><div>  return $query_vars;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Templates ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Used to guess if page exists at requested path</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3304)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option() To see if pretty permalinks are enabled</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_page_by_path() To see if page exists at path</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed False if no page, Page object if true</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_get_page_by_path( $path = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default to false</span>&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Path is not empty</span>&nbsp;</div></li><li><div>  if ( !empty( $path ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Pretty permalinks are on so path might exist</span>&nbsp;</div></li><li><div>      if ( get_option( 'permalink_structure' ) ) {&nbsp;</div></li><li><div>          $retval = get_page_by_path( $path );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bbp_get_page_by_path', $retval, $path );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets the 404 status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used primarily with topics/replies inside hidden forums.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since bbPress (r3051)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Query $wp_query</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Query::set_404()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bbp_set_404() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $wp_query ) ) {&nbsp;</div></li><li><div>      _doing_it_wrong( __FUNCTION__, __( 'Conditional query tags do not work before the query is run. Before then, they always return false.', 'bbpress' ), '3.1' );&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_query-&gt;set_404();&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>bbPress</li><li><span></span>2.5.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>