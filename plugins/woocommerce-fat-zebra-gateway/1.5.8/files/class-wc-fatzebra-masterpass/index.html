<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.5.8" data-slug="woocommerce-fat-zebra-gateway" data-type="file" data-id="78254"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-wc-fatzebra-masterpass | file | Woocommerce Fat Zebra Gateway | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-fat-zebra-gateway, 1.5.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=e0a23748a5a681d642a30abcb3d7c03c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-wc-fatzebra-masterpass/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra-masterpass%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra-masterpass%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-fat-zebra-gateway-1.5.8-file-class-wc-fatzebra-masterpass","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-wc-fatzebra-masterpass" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-fat-zebra-gateway." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/" class="plugin"><span property="name">woocommerce-fat-zebra-gateway</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.5.8." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/" class="H_VERSION"><span property="name">1.5.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-wc-fatzebra-masterpass</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/all/" title="All">All <span class="count badge">4</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/hooks/" title="Hooks">Hooks <span class="count badge">1</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/filters/" title="Filters">Filters <span class="count badge">1</span></a></li><li class="" data-id="class" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/classes/" title="Classes">Classes <span class="count badge">0</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="3"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/functions/" title="Functions">Functions <span class="count badge">3</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class-wc-fatzebra-masterpass.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_masterpass_init() {&nbsp;</div></li><li><div>class WC_FatZebra_MasterPass extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>    $this-&gt;id = 'fatzebra_masterpass';&nbsp;</div></li><li><div>    $this-&gt;icon = &quot;https:<span class="comment">//www.mastercard.com/mc_us/wallet/img/en/AU/mcpp_wllt_btn_chk_147x034px.png&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;has_fields = true;&nbsp;</div></li><li><div>    $this-&gt;method_title = __( 'Fat Zebra (MasterPass)', 'woocommerce' );&nbsp;</div></li><li><div>    $this-&gt;version = &quot;1.5.8&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;api_version = &quot;1.0&quot;;&nbsp;</div></li><li><div>    $this-&gt;live_url = &quot;https:<span class="comment">//gateway.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;sandbox_url = &quot;https:<span class="comment">//gateway.sandbox.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;sandbox_paynow_url = &quot;https:<span class="comment">//paynow.sandbox.fatzebra.com.au/v2&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;live_paynow_url = &quot;https:<span class="comment">//paynow.fatzebra.com.au/v2&quot;;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;supports = array( 'subscriptions', 'products', 'refunds', 'subscription_cancellation', 'subscription_reactivation', 'subscription_suspension', 'subscription_amount_changes', 'subscription_payment_method_change', 'subscription_date_changes' );&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Define user set variables</span>&nbsp;</div></li><li><div>    $this-&gt;title = 'MasterPass';&nbsp;</div></li><li><div>    $this-&gt;description = in_array(&quot;description&quot;, $this-&gt;settings) ? $this-&gt;settings['description'] : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the form fields.</span>&nbsp;</div></li><li><div>    $this-&gt;init_form_fields();&nbsp;</div></li><li><div>    $this-&gt;init_parent_settings(); <span class="comment">// Allows us to access $this-&gt;parent_settings[] for username, token etc</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>    $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Actions</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways', array(&$this, 'process_admin_options')); <span class="comment">// &lt; 2.0</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) ); <span class="comment">//&gt; 2.0</span>&nbsp;</div></li><li><div>    add_action('scheduled_subscription_payment_' . $this-&gt;id, array(&$this, 'scheduled_subscription_payment'), 10, 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    add_action( 'woocommerce_api_wc_fatzebra_masterpass' , array( $this, 'check_masterpass_response' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initializes the parent (WC_FatZebra) settings</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_parent_settings() {&nbsp;</div></li><li><div>    $this-&gt;parent_settings = get_option(&quot;woocommerce_fatzebra_settings&quot;, null);&nbsp;</div></li><li><div>    if ( ! $this-&gt;parent_settings || ! is_array( $this-&gt;parent_settings ) ) {&nbsp;</div></li><li><div>      $this-&gt;parent_settings = array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $this-&gt;parent_settings && is_array( $this-&gt;parent_settings ) ) {&nbsp;</div></li><li><div>     $this-&gt;parent_settings = array_map( array( $this, 'format_settings' ), $this-&gt;parent_settings );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_form_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;form_fields = array(&nbsp;</div></li><li><div>    'enabled' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Enable/Disable', 'woocommerce' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; __( 'Enable MasterPass', 'woocommerce' ), &nbsp;</div></li><li><div>            'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>    'shared_secret' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __(&quot;Shared Secret&quot;, 'woocommerce'), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __(&quot;The shared secret for direct post request and response authentication.&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>            'default' =&gt; &quot;&quot;&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } <span class="comment">// End init_form_fields()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Admin Panel Options</span>&nbsp;</div></li><li><div><span class="comment">   * - Options for bits like 'title' and availability on a country-by-country basis</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_options() {&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>    &lt;h3&gt;&lt;?php _e('Fat Zebra', 'woocommerce'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>    &lt;p&gt;&lt;?php _e('Allows Fat Zebra Payments. ', 'woocommerce'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php $this-&gt;generate_settings_html(); ?&gt;&nbsp;</div></li><li><div>    &lt;/table&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>  } <span class="comment">// End admin_options()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function payment_fields() {&nbsp;</div></li><li><div>    $logo_url = plugins_url(&quot;images/Fat-Zebra-Certified-small.png&quot;, __FILE__);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>     &lt;p&gt;Check out with MasterCard MasterPass.&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment and return the result</span>&nbsp;</div></li><li><div><span class="comment">   **/</span>&nbsp;</div></li><li><div>  function process_payment( $order_id ) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (class_exists(&quot;WC_Subscriptions_Order&quot;) && WC_Subscriptions_Order::order_contains_subscription($order)) {&nbsp;</div></li><li><div>      <span class="comment">// Charge sign up fee + first period here..</span>&nbsp;</div></li><li><div>      <span class="comment">// Periodic charging should happen via scheduled_subscription_payment_fatzebra</span>&nbsp;</div></li><li><div>      $amount = (int)(WC_Subscriptions_Order::get_total_initial_payment($order) * 100);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $amount = (int)($order-&gt;order_total * 100);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $page_url = $this-&gt;parent_settings[&quot;sandbox_mode&quot;] == &quot;yes&quot; ? $this-&gt;sandbox_paynow_url : $this-&gt;live_paynow_url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $_SESSION['masterpass_order_id'] = $order_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $username = $this-&gt;parent_settings[&quot;username&quot;];&nbsp;</div></li><li><div>    $currency = $order-&gt;get_order_currency();&nbsp;</div></li><li><div>    $reference = (string)$order_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $return_args = array('wc-api' =&gt; 'WC_FatZebra_MasterPass', &quot;echo[order_id]&quot; =&gt; $order_id);&nbsp;</div></li><li><div>    if ($amount === 0) $return_args[&quot;echo[tokenize]&quot;] = true;&nbsp;</div></li><li><div>    $return_path = str_replace( 'https:', 'http:', add_query_arg($return_args, home_url( '/' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $verification_string = implode(&quot;:&quot;, array($reference, $amount, $currency, $return_path));&nbsp;</div></li><li><div>    $verification_value = hash_hmac(&quot;md5&quot;, $verification_string, $this-&gt;settings[&quot;shared_secret&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $redirect = &quot;$page_url/{$username}/{$reference}/{$currency}/{$amount}/{$verification_value}?masterpass=true&iframe=true&return_path=&quot; . urlencode($return_path);&nbsp;</div></li><li><div>    if ($amount === 0) $redirect .= &quot;&tokenize_only=true&quot;;&nbsp;</div></li><li><div>    $result = array('result' =&gt; 'success', 'redirect' =&gt; $redirect);&nbsp;</div></li><li><div>    return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For the thankyou page :)</span>&nbsp;</div></li><li><div>  function thankyou_page() {&nbsp;</div></li><li><div>    if ($this-&gt;description) echo wpautop(wptexturize($this-&gt;description));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * Process the subscription payment (manually... well via wp_cron)</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * @param $amount the amount for this payment</span>&nbsp;</div></li><li><div><span class="comment">  * @param $order the order ID</span>&nbsp;</div></li><li><div><span class="comment">  * @param $product_id the product ID</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function scheduled_subscription_payment($amount_to_charge, $order, $product_id) {&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>    $this-&gt;params[&quot;amount&quot;] = (int)($amount_to_charge * 100);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = $order-&gt;id . &quot;-&quot; . date(&quot;dmY&quot;); <span class="comment">// Reference for order ID 123 will become 123-01022012</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $token = get_post_meta($order-&gt;id, &quot;fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;card_token&quot;] = $token;&nbsp;</div></li><li><div>    $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>    if(empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;deferred&quot;] = false;&nbsp;</div></li><li><div>    $result = $this-&gt;do_payment($this-&gt;params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_wp_error($result)) {&nbsp;</div></li><li><div>      $error = &quot;&quot;;&nbsp;</div></li><li><div>      $txn_id = &quot;None&quot;;&nbsp;</div></li><li><div>      switch($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>        case 1: <span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span>&nbsp;</div></li><li><div>          $error = $result-&gt;get_error_message();&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2: <span class="comment">// Gateway error (data etc)</span>&nbsp;</div></li><li><div>          $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>          $error = implode(&quot;, &quot;, $errors);&nbsp;</div></li><li><div>          error_log(&quot;WooCommerce Fat Zebra - Gateway Error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 3: <span class="comment">// Declined - error data is array with keys: message, id</span>&nbsp;</div></li><li><div>          $error = $this-&gt;response_data-&gt;response-&gt;message;&nbsp;</div></li><li><div>          $txn_id = $this-&gt;response_data-&gt;response-&gt;transaction_id;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 4: <span class="comment">// Exception caught, something bad happened. Data is exception</span>&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>          $error = &quot;Unknown - Error - See error log&quot;;&nbsp;</div></li><li><div>          error_log(&quot;WC Fat Zebra (Subscriptions) - Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the error details and return</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Failed: &quot; . $error . &quot;. Transaction ID: &quot; . $txn_id));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payment_failure_on_order( $order, $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else { <span class="comment">// Success! Returned is an array with the transaction ID etc</span>&nbsp;</div></li><li><div>      <span class="comment">// Update the subscription and return</span>&nbsp;</div></li><li><div>      <span class="comment">// Add a note to the order</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Successful. Transaction ID: &quot; . $result[&quot;transaction_id&quot;]));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payments_on_order( $order );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function process_refund( $order_id, $amount = null, $reason = '' ) {&nbsp;</div></li><li><div>    $payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>    if (!isset($payment_gateways['fatzebra'])) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $gw = $payment_gateways['fatzebra'];&nbsp;</div></li><li><div>    return $gw-&gt;process_refund($order_id, $amount, $reason);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * Handle the callback from MasterPass for processing</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function check_masterpass_response() {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>    $message = &quot;&quot;;&nbsp;</div></li><li><div>    $response_class = &quot;success&quot;;&nbsp;</div></li><li><div>    $successful = false;&nbsp;</div></li><li><div>    $order_id = isset($_GET['reference']) ? $_GET['reference'] : $_GET['echo']['order_id'];&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $tokenize_only = isset($_GET['echo']['tokenize']);&nbsp;</div></li><li><div>    <span class="comment">// Verify the response</span>&nbsp;</div></li><li><div>    $verification_str = $tokenize_only ? implode(&quot;:&quot;, array($_GET['r'], $_GET['token'])) : implode(&quot;:&quot;, array($_GET['r'], $_GET['successful'], $_GET['amount'], $_GET['currency'], $_GET['id'], $_GET['token']));&nbsp;</div></li><li><div>    $verification_value = hash_hmac(&quot;md5&quot;, $verification_str, $this-&gt;settings['shared_secret']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($verification_value !== $_GET['v']) {&nbsp;</div></li><li><div>      $woocommerce-&gt;add_error(__(&quot;Error verifying response from Hosted Payment Page&quot;, 'woocommerce'));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch((int)$_GET['r']) {&nbsp;</div></li><li><div>      case 1:&nbsp;</div></li><li><div>        $order-&gt;payment_complete($_GET['id']);&nbsp;</div></li><li><div>        $order-&gt;add_order_note(&quot;Payment via Fat Zebra (MasterPass) successful. Transaction ID: &quot; . $_GET['id'] .   &quot;. Message: &quot; . $_GET['message']);&nbsp;</div></li><li><div>        $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;fatzebra_card_token&quot;, $_GET[&quot;token&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $successful = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message = &quot;Approved&quot;;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>      case 2:&nbsp;</div></li><li><div>        $order-&gt;add_order_note(&quot;Payment failed: &quot; . $_GET['message']);&nbsp;</div></li><li><div>        $order-&gt;update_status('failed');&nbsp;</div></li><li><div>        $successful = false;&nbsp;</div></li><li><div>        $message = $_GET['message'];&nbsp;</div></li><li><div>        $response_class = &quot;error&quot;;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 94:&nbsp;</div></li><li><div>        $order-&gt;add_order_note(&quot;Payment failed: MasterPass Cancelled by Customer&quot;);&nbsp;</div></li><li><div>        $successful = false;&nbsp;</div></li><li><div>        $message = &quot;MasterPass Checkout Cancelled&quot;;&nbsp;</div></li><li><div>        $order-&gt;update_status(&quot;failed&quot;);&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>        if(isset($order)) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(&quot;Payment failed. Response code: &quot; . $_GET['r']);&nbsp;</div></li><li><div>          $order-&gt;update_status(&quot;failed&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $successful = false;&nbsp;</div></li><li><div>        $message = &quot;Unknown Error&quot;;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$successful) {&nbsp;</div></li><li><div>      $woocommerce-&gt;add_error( __( 'Payment error: ', 'woocommerce' ) . $message );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $redirect_url =  add_query_arg('order', &nbsp;</div></li><li><div>                                    $order-&gt;id, &nbsp;</div></li><li><div>                                    add_query_arg('key', $order-&gt;order_key, &nbsp;</div></li><li><div>                                    get_permalink(get_option('woocommerce_thanks_page_id'))));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    wp_redirect($redirect_url);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * @return mixed WP_Error or Array (result)</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function do_payment($params) {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;parent_settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;parent_settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Deferred payments need to post to the /credit_cards endpoint.</span>&nbsp;</div></li><li><div>    if (isset($params[&quot;deferred&quot;]) && $params[&quot;deferred&quot;]) {&nbsp;</div></li><li><div>      <span class="comment">// Replace the URL with the tokenize method and re-create the order text (json payload)</span>&nbsp;</div></li><li><div>      $url = str_replace(&quot;purchases&quot;, &quot;credit_cards&quot;, $url);&nbsp;</div></li><li><div>      $payload = array(&quot;card_holder&quot; =&gt; $params[&quot;card_holder&quot;], &quot;card_number&quot; =&gt; $params[&quot;card_number&quot;], &quot;card_expiry&quot; =&gt; $params[&quot;card_expiry&quot;], &quot;cvv&quot; =&gt; $params[&quot;cvv&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>      if(empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>      if(!isset($payload[&quot;customer_ip&quot;])) $payload[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order_text = json_encode($payload);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array(&nbsp;</div></li><li><div>      'method' =&gt; 'POST', &nbsp;</div></li><li><div>      'body' =&gt; $order_text, &nbsp;</div></li><li><div>      'headers' =&gt; array(&nbsp;</div></li><li><div>        'Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;parent_settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;parent_settings[&quot;token&quot;]), &nbsp;</div></li><li><div>        'X-Test-Mode' =&gt; $test_mode, &nbsp;</div></li><li><div>        'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'timeout' =&gt; 30&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(1, &quot;Credit Card Payment failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;]);&nbsp;</div></li><li><div>        $error-&gt;add_data($this-&gt;response);&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(2, &quot;Gateway Error&quot;, $this-&gt;response_data-&gt;errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we are doing a deferred payments we override the data here.</span>&nbsp;</div></li><li><div>      if (isset($params[&quot;deferred&quot;]) && $params[&quot;deferred&quot;]) {&nbsp;</div></li><li><div>        return array(&quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &quot;card_number&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_number, &quot;card_expiry&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_expiry, &quot;card_holder&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_holder);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(3, &quot;Payment Declined&quot;, array(&quot;message&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;message, &quot;id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id));&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        return array(&quot;transaction_id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id, &quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_token);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $error-&gt;add(4, &quot;Unknown Error&quot;, $e);&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add the gateway to WooCommerce</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function add_fz_masterpass_gateway( $methods ) {&nbsp;</div></li><li><div>  $methods[] = 'WC_FatZebra_MasterPass'; return $methods;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_payment_gateways', 'add_fz_masterpass_gateway' );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Fat Zebra Gateway</li><li><span></span>1.5.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>