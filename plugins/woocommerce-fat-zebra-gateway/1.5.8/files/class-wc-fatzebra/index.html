<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.5.8" data-slug="woocommerce-fat-zebra-gateway" data-type="file" data-id="78253"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-wc-fatzebra | file | Woocommerce Fat Zebra Gateway | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-fat-zebra-gateway, 1.5.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3149567619c7bb792de6c0dcb4814d54' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-wc-fatzebra/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-fat-zebra-gateway-1.5.8-file-class-wc-fatzebra","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-wc-fatzebra" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-fat-zebra-gateway." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/" class="plugin"><span property="name">woocommerce-fat-zebra-gateway</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.5.8." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/" class="H_VERSION"><span property="name">1.5.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-wc-fatzebra</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/all/" title="All">All <span class="count badge">4</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/hooks/" title="Hooks">Hooks <span class="count badge">1</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/filters/" title="Filters">Filters <span class="count badge">1</span></a></li><li class="" data-id="class" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/classes/" title="Classes">Classes <span class="count badge">0</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="3"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/functions/" title="Functions">Functions <span class="count badge">3</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class-wc-fatzebra.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name: WooCommerce Fat Zebra Gateway</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI: https://www.fatzebra.com.au/support/supported-carts</span>&nbsp;</div></li><li><div><span class="comment">Description: Extends WooCommerce with Fat Zebra payment gateway along with WooCommerce subscriptions support.</span>&nbsp;</div></li><li><div><span class="comment">Version: 1.5.8</span>&nbsp;</div></li><li><div><span class="comment">Author: Fat Zebra</span>&nbsp;</div></li><li><div><span class="comment">Author URI: https://www.fatzebra.com.au</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Copyright (C) 2012 Fat Zebra Pty. Ltd.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), </span>&nbsp;</div></li><li><div><span class="comment">to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, </span>&nbsp;</div></li><li><div><span class="comment">of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>&nbsp;</div></li><li><div><span class="comment">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>&nbsp;</div></li><li><div><span class="comment">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>&nbsp;</div></li><li><div><span class="comment">IN THE SOFTWARE.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('plugins_loaded', 'fz_init', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_init() {&nbsp;</div></li><li><div>if (!class_exists('WC_Payment_Gateway')) {&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;message&quot; class=&quot;error&quot;&gt;&nbsp;</div></li><li><div>    &lt;p&gt;&lt;?php printf(__('%sWooCommerce Fat Zebra Extension is inactive.%s The %sWooCommerce plugin%s must be active for the WooCommerce Fat Zebra Extension to work. Please %sinstall & activate WooCommerce%s', 'wc_fatzebra'), '&lt;strong&gt;', '&lt;/strong&gt;', '&lt;a href=&quot;http:<span class="comment">//wordpress.org/extend/plugins/woocommerce/&quot;&gt;', '&lt;/a&gt;', '&lt;a href=&quot;' . admin_url('plugins.php') . '&quot;&gt;', '&nbsp;&raquo;&lt;/a&gt;'); ?&gt;&lt;/p&gt;</span>&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>global $woocommerce;&nbsp;</div></li><li><div><span class="comment">// Check the WooCommerce version...</span>&nbsp;</div></li><li><div>if (!version_compare($woocommerce-&gt;version, '2.1', &quot;&gt;=&quot;)) {&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;message&quot; class=&quot;error&quot;&gt;&nbsp;</div></li><li><div>    &lt;p&gt;&lt;?php printf(__('%sWooCommerce Fat Zebra Extension is inactive.%s The version of WooCommerce you are using is not compatible with this verion of the Fat Zebra Extension. Please update WooCommerce to version 2.1 or greater, or remove this version of the Fat Zebra Extension and install an older version.', 'wc_fatzebra'), '&lt;strong&gt;', '&lt;/strong&gt;'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>include(&quot;class-wc-fatzebra-masterpass.php&quot;);&nbsp;</div></li><li><div>include(&quot;class-wc-fatzebra-visacheckout.php&quot;);&nbsp;</div></li><li><div>fz_masterpass_init();&nbsp;</div></li><li><div>fz_visacheckout_init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WC_FatZebra extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>    $this-&gt;id = 'fatzebra';&nbsp;</div></li><li><div>    $this-&gt;icon = apply_filters('woocommerce_fatzebra_icon', '');&nbsp;</div></li><li><div>    $this-&gt;has_fields = true;&nbsp;</div></li><li><div>    $this-&gt;method_title = __('Fat Zebra', 'woocommerce');&nbsp;</div></li><li><div>    $this-&gt;version = &quot;1.5.8&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;api_version = &quot;1.0&quot;;&nbsp;</div></li><li><div>    $this-&gt;live_url = &quot;https:<span class="comment">//gateway.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;sandbox_url = &quot;https:<span class="comment">//gateway.sandbox.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;supports = array('subscriptions', 'products', 'refunds', 'subscription_cancellation', 'subscription_reactivation', 'subscription_suspension', 'subscription_amount_changes', 'subscription_payment_method_change', 'subscription_date_changes');&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>    $this-&gt;country_map = array(&quot;AD&quot; =&gt; &quot;AND&quot;, &quot;AE&quot; =&gt; &quot;ARE&quot;, &quot;AF&quot; =&gt; &quot;AFG&quot;, &quot;AG&quot; =&gt; &quot;ATG&quot;, &quot;AI&quot; =&gt; &quot;AIA&quot;, &quot;AL&quot; =&gt; &quot;ALB&quot;, &quot;AM&quot; =&gt; &quot;ARM&quot;, &quot;AN&quot; =&gt; &quot;ANT&quot;, &quot;AO&quot; =&gt; &quot;AGO&quot;, &quot;AQ&quot; =&gt; &quot;ATA&quot;, &quot;AR&quot; =&gt; &quot;ARG&quot;, &quot;AS&quot; =&gt; &quot;ASM&quot;, &quot;AT&quot; =&gt; &quot;AUT&quot;, &quot;AU&quot; =&gt; &quot;AUS&quot;, &quot;AW&quot; =&gt; &quot;ABW&quot;, &quot;AX&quot; =&gt; &quot;ALA&quot;, &quot;AZ&quot; =&gt; &quot;AZE&quot;, &quot;BA&quot; =&gt; &quot;BIH&quot;, &quot;BB&quot; =&gt; &quot;BRB&quot;, &quot;BD&quot; =&gt; &quot;BGD&quot;, &quot;BE&quot; =&gt; &quot;BEL&quot;, &quot;BF&quot; =&gt; &quot;BFA&quot;, &quot;BG&quot; =&gt; &quot;BGR&quot;, &quot;BH&quot; =&gt; &quot;BHR&quot;, &quot;BI&quot; =&gt; &quot;BDI&quot;, &quot;BJ&quot; =&gt; &quot;BEN&quot;, &quot;BL&quot; =&gt; &quot;BLM&quot;, &quot;BM&quot; =&gt; &quot;BMU&quot;, &quot;BN&quot; =&gt; &quot;BRN&quot;, &quot;BO&quot; =&gt; &quot;BOL&quot;, &quot;BQ&quot; =&gt; &quot;BES&quot;, &quot;BR&quot; =&gt; &quot;BRA&quot;, &quot;BS&quot; =&gt; &quot;BHS&quot;, &quot;BT&quot; =&gt; &quot;BTN&quot;, &quot;BV&quot; =&gt; &quot;BVT&quot;, &quot;BW&quot; =&gt; &quot;BWA&quot;, &quot;BY&quot; =&gt; &quot;BLR&quot;, &quot;BZ&quot; =&gt; &quot;BLZ&quot;, &quot;CA&quot; =&gt; &quot;CAN&quot;, &quot;CC&quot; =&gt; &quot;CCK&quot;, &quot;CD&quot; =&gt; &quot;COD&quot;, &quot;CF&quot; =&gt; &quot;CAF&quot;, &quot;CG&quot; =&gt; &quot;COG&quot;, &quot;CH&quot; =&gt; &quot;CHE&quot;, &quot;CI&quot; =&gt; &quot;CIV&quot;, &quot;CK&quot; =&gt; &quot;COK&quot;, &quot;CL&quot; =&gt; &quot;CHL&quot;, &quot;CM&quot; =&gt; &quot;CMR&quot;, &quot;CN&quot; =&gt; &quot;CHN&quot;, &quot;CO&quot; =&gt; &quot;COL&quot;, &quot;CR&quot; =&gt; &quot;CRI&quot;, &quot;CU&quot; =&gt; &quot;CUB&quot;, &quot;CV&quot; =&gt; &quot;CPV&quot;, &quot;CW&quot; =&gt; &quot;CUW&quot;, &quot;CX&quot; =&gt; &quot;CXR&quot;, &quot;CY&quot; =&gt; &quot;CYP&quot;, &quot;CZ&quot; =&gt; &quot;CZE&quot;, &quot;DE&quot; =&gt; &quot;DEU&quot;, &quot;DJ&quot; =&gt; &quot;DJI&quot;, &quot;DK&quot; =&gt; &quot;DNK&quot;, &quot;DM&quot; =&gt; &quot;DMA&quot;, &quot;DO&quot; =&gt; &quot;DOM&quot;, &quot;DZ&quot; =&gt; &quot;DZA&quot;, &quot;EC&quot; =&gt; &quot;ECU&quot;, &quot;EE&quot; =&gt; &quot;EST&quot;, &quot;EG&quot; =&gt; &quot;EGY&quot;, &quot;EH&quot; =&gt; &quot;ESH&quot;, &quot;ER&quot; =&gt; &quot;ERI&quot;, &quot;ES&quot; =&gt; &quot;ESP&quot;, &quot;ET&quot; =&gt; &quot;ETH&quot;, &quot;FI&quot; =&gt; &quot;FIN&quot;, &quot;FJ&quot; =&gt; &quot;FJI&quot;, &quot;FK&quot; =&gt; &quot;FLK&quot;, &quot;FM&quot; =&gt; &quot;FSM&quot;, &quot;FO&quot; =&gt; &quot;FRO&quot;, &quot;FR&quot; =&gt; &quot;FRA&quot;, &quot;GA&quot; =&gt; &quot;GAB&quot;, &quot;GB&quot; =&gt; &quot;GBR&quot;, &quot;GD&quot; =&gt; &quot;GRD&quot;, &quot;GE&quot; =&gt; &quot;GEO&quot;, &quot;GF&quot; =&gt; &quot;GUF&quot;, &quot;GG&quot; =&gt; &quot;GGY&quot;, &quot;GH&quot; =&gt; &quot;GHA&quot;, &quot;GI&quot; =&gt; &quot;GIB&quot;, &quot;GL&quot; =&gt; &quot;GRL&quot;, &quot;GM&quot; =&gt; &quot;GMB&quot;, &quot;GN&quot; =&gt; &quot;GIN&quot;, &quot;GP&quot; =&gt; &quot;GLP&quot;, &quot;GQ&quot; =&gt; &quot;GNQ&quot;, &quot;GR&quot; =&gt; &quot;GRC&quot;, &quot;GS&quot; =&gt; &quot;SGS&quot;, &quot;GT&quot; =&gt; &quot;GTM&quot;, &quot;GU&quot; =&gt; &quot;GUM&quot;, &quot;GW&quot; =&gt; &quot;GNB&quot;, &quot;GY&quot; =&gt; &quot;GUY&quot;, &quot;HK&quot; =&gt; &quot;HKG&quot;, &quot;HM&quot; =&gt; &quot;HMD&quot;, &quot;HN&quot; =&gt; &quot;HND&quot;, &quot;HR&quot; =&gt; &quot;HRV&quot;, &quot;HT&quot; =&gt; &quot;HTI&quot;, &quot;HU&quot; =&gt; &quot;HUN&quot;, &quot;ID&quot; =&gt; &quot;IDN&quot;, &quot;IE&quot; =&gt; &quot;IRL&quot;, &quot;IL&quot; =&gt; &quot;ISR&quot;, &quot;IM&quot; =&gt; &quot;IMN&quot;, &quot;IN&quot; =&gt; &quot;IND&quot;, &quot;IO&quot; =&gt; &quot;IOT&quot;, &quot;IQ&quot; =&gt; &quot;IRQ&quot;, &quot;IR&quot; =&gt; &quot;IRN&quot;, &quot;IS&quot; =&gt; &quot;ISL&quot;, &quot;IT&quot; =&gt; &quot;ITA&quot;, &quot;JE&quot; =&gt; &quot;JEY&quot;, &quot;JM&quot; =&gt; &quot;JAM&quot;, &quot;JO&quot; =&gt; &quot;JOR&quot;, &quot;JP&quot; =&gt; &quot;JPN&quot;, &quot;KE&quot; =&gt; &quot;KEN&quot;, &quot;KG&quot; =&gt; &quot;KGZ&quot;, &quot;KH&quot; =&gt; &quot;KHM&quot;, &quot;KI&quot; =&gt; &quot;KIR&quot;, &quot;KM&quot; =&gt; &quot;COM&quot;, &quot;KN&quot; =&gt; &quot;KNA&quot;, &quot;KP&quot; =&gt; &quot;PRK&quot;, &quot;KR&quot; =&gt; &quot;KOR&quot;, &quot;KW&quot; =&gt; &quot;KWT&quot;, &quot;KY&quot; =&gt; &quot;CYM&quot;, &quot;KZ&quot; =&gt; &quot;KAZ&quot;, &quot;LA&quot; =&gt; &quot;LAO&quot;, &quot;LB&quot; =&gt; &quot;LBN&quot;, &quot;LC&quot; =&gt; &quot;LCA&quot;, &quot;LI&quot; =&gt; &quot;LIE&quot;, &quot;LK&quot; =&gt; &quot;LKA&quot;, &quot;LR&quot; =&gt; &quot;LBR&quot;, &quot;LS&quot; =&gt; &quot;LSO&quot;, &quot;LT&quot; =&gt; &quot;LTU&quot;, &quot;LU&quot; =&gt; &quot;LUX&quot;, &quot;LV&quot; =&gt; &quot;LVA&quot;, &quot;LY&quot; =&gt; &quot;LBY&quot;, &quot;MA&quot; =&gt; &quot;MAR&quot;, &quot;MC&quot; =&gt; &quot;MCO&quot;, &quot;MD&quot; =&gt; &quot;MDA&quot;, &quot;ME&quot; =&gt; &quot;MNE&quot;, &quot;MF&quot; =&gt; &quot;MAF&quot;, &quot;MG&quot; =&gt; &quot;MDG&quot;, &quot;MH&quot; =&gt; &quot;MHL&quot;, &quot;MK&quot; =&gt; &quot;MKD&quot;, &quot;ML&quot; =&gt; &quot;MLI&quot;, &quot;MM&quot; =&gt; &quot;MMR&quot;, &quot;MN&quot; =&gt; &quot;MNG&quot;, &quot;MO&quot; =&gt; &quot;MAC&quot;, &quot;MP&quot; =&gt; &quot;MNP&quot;, &quot;MQ&quot; =&gt; &quot;MTQ&quot;, &quot;MR&quot; =&gt; &quot;MRT&quot;, &quot;MS&quot; =&gt; &quot;MSR&quot;, &quot;MT&quot; =&gt; &quot;MLT&quot;, &quot;MU&quot; =&gt; &quot;MUS&quot;, &quot;MV&quot; =&gt; &quot;MDV&quot;, &quot;MW&quot; =&gt; &quot;MWI&quot;, &quot;MX&quot; =&gt; &quot;MEX&quot;, &quot;MY&quot; =&gt; &quot;MYS&quot;, &quot;MZ&quot; =&gt; &quot;MOZ&quot;, &quot;NA&quot; =&gt; &quot;NAM&quot;, &quot;NC&quot; =&gt; &quot;NCL&quot;, &quot;NE&quot; =&gt; &quot;NER&quot;, &quot;NF&quot; =&gt; &quot;NFK&quot;, &quot;NG&quot; =&gt; &quot;NGA&quot;, &quot;NI&quot; =&gt; &quot;NIC&quot;, &quot;NL&quot; =&gt; &quot;NLD&quot;, &quot;NO&quot; =&gt; &quot;NOR&quot;, &quot;NP&quot; =&gt; &quot;NPL&quot;, &quot;NR&quot; =&gt; &quot;NRU&quot;, &quot;NU&quot; =&gt; &quot;NIU&quot;, &quot;NZ&quot; =&gt; &quot;NZL&quot;, &quot;OM&quot; =&gt; &quot;OMN&quot;, &quot;PA&quot; =&gt; &quot;PAN&quot;, &quot;PE&quot; =&gt; &quot;PER&quot;, &quot;PF&quot; =&gt; &quot;PYF&quot;, &quot;PG&quot; =&gt; &quot;PNG&quot;, &quot;PH&quot; =&gt; &quot;PHL&quot;, &quot;PK&quot; =&gt; &quot;PAK&quot;, &quot;PL&quot; =&gt; &quot;POL&quot;, &quot;PM&quot; =&gt; &quot;SPM&quot;, &quot;PN&quot; =&gt; &quot;PCN&quot;, &quot;PR&quot; =&gt; &quot;PRI&quot;, &quot;PS&quot; =&gt; &quot;PSE&quot;, &quot;PT&quot; =&gt; &quot;PRT&quot;, &quot;PW&quot; =&gt; &quot;PLW&quot;, &quot;PY&quot; =&gt; &quot;PRY&quot;, &quot;QA&quot; =&gt; &quot;QAT&quot;, &quot;RE&quot; =&gt; &quot;REU&quot;, &quot;RO&quot; =&gt; &quot;ROU&quot;, &quot;RS&quot; =&gt; &quot;SRB&quot;, &quot;RU&quot; =&gt; &quot;RUS&quot;, &quot;RW&quot; =&gt; &quot;RWA&quot;, &quot;SA&quot; =&gt; &quot;SAU&quot;, &quot;SB&quot; =&gt; &quot;SLB&quot;, &quot;SC&quot; =&gt; &quot;SYC&quot;, &quot;SD&quot; =&gt; &quot;SDN&quot;, &quot;SE&quot; =&gt; &quot;SWE&quot;, &quot;SG&quot; =&gt; &quot;SGP&quot;, &quot;SH&quot; =&gt; &quot;SHN&quot;, &quot;SI&quot; =&gt; &quot;SVN&quot;, &quot;SJ&quot; =&gt; &quot;SJM&quot;, &quot;SK&quot; =&gt; &quot;SVK&quot;, &quot;SL&quot; =&gt; &quot;SLE&quot;, &quot;SM&quot; =&gt; &quot;SMR&quot;, &quot;SN&quot; =&gt; &quot;SEN&quot;, &quot;SO&quot; =&gt; &quot;SOM&quot;, &quot;SR&quot; =&gt; &quot;SUR&quot;, &quot;SS&quot; =&gt; &quot;SSD&quot;, &quot;ST&quot; =&gt; &quot;STP&quot;, &quot;SV&quot; =&gt; &quot;SLV&quot;, &quot;SX&quot; =&gt; &quot;SXM&quot;, &quot;SY&quot; =&gt; &quot;SYR&quot;, &quot;SZ&quot; =&gt; &quot;SWZ&quot;, &quot;TC&quot; =&gt; &quot;TCA&quot;, &quot;TD&quot; =&gt; &quot;TCD&quot;, &quot;TF&quot; =&gt; &quot;ATF&quot;, &quot;TG&quot; =&gt; &quot;TGO&quot;, &quot;TH&quot; =&gt; &quot;THA&quot;, &quot;TJ&quot; =&gt; &quot;TJK&quot;, &quot;TK&quot; =&gt; &quot;TKL&quot;, &quot;TL&quot; =&gt; &quot;TLS&quot;, &quot;TM&quot; =&gt; &quot;TKM&quot;, &quot;TN&quot; =&gt; &quot;TUN&quot;, &quot;TO&quot; =&gt; &quot;TON&quot;, &quot;TR&quot; =&gt; &quot;TUR&quot;, &quot;TT&quot; =&gt; &quot;TTO&quot;, &quot;TV&quot; =&gt; &quot;TUV&quot;, &quot;TW&quot; =&gt; &quot;TWN&quot;, &quot;TZ&quot; =&gt; &quot;TZA&quot;, &quot;UA&quot; =&gt; &quot;UKR&quot;, &quot;UG&quot; =&gt; &quot;UGA&quot;, &quot;UM&quot; =&gt; &quot;UMI&quot;, &quot;US&quot; =&gt; &quot;USA&quot;, &quot;UY&quot; =&gt; &quot;URY&quot;, &quot;UZ&quot; =&gt; &quot;UZB&quot;, &quot;VA&quot; =&gt; &quot;VAT&quot;, &quot;VC&quot; =&gt; &quot;VCT&quot;, &quot;VE&quot; =&gt; &quot;VEN&quot;, &quot;VG&quot; =&gt; &quot;VGB&quot;, &quot;VI&quot; =&gt; &quot;VIR&quot;, &quot;VN&quot; =&gt; &quot;VNM&quot;, &quot;VU&quot; =&gt; &quot;VUT&quot;, &quot;WF&quot; =&gt; &quot;WLF&quot;, &quot;WS&quot; =&gt; &quot;WSM&quot;, &quot;YE&quot; =&gt; &quot;YEM&quot;, &quot;YT&quot; =&gt; &quot;MYT&quot;, &quot;ZA&quot; =&gt; &quot;ZAF&quot;, &quot;ZM&quot; =&gt; &quot;ZMB&quot;, &quot;ZW&quot; =&gt; &quot;ZWE&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Define user set variables</span>&nbsp;</div></li><li><div>    $this-&gt;title = &quot;Credit Card&quot;;&nbsp;</div></li><li><div>    $this-&gt;description = in_array(&quot;description&quot;, $this-&gt;settings) ? $this-&gt;settings['description'] : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the form fields.</span>&nbsp;</div></li><li><div>    $this-&gt;init_form_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>    $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Actions</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways', array(&$this, 'process_admin_options')); <span class="comment">// &lt; 2.0</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array($this, 'process_admin_options')); <span class="comment">//&gt; 2.0</span>&nbsp;</div></li><li><div>    add_action('scheduled_subscription_payment_fatzebra', array(&$this, 'scheduled_subscription_payment'), 10, 3);&nbsp;</div></li><li><div>    add_action('woocommerce_order_actions', array(&$this, 'add_process_deferred_payment_button'), 99, 1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Indicates if direct post is enabled/configured or not</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function direct_post_enabled() {&nbsp;</div></li><li><div>    return $this-&gt;settings['use_direct_post'] == 'yes' && !is_null($this-&gt;settings['shared_secret']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Indicates if we should send fraud data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function fraud_detection_enabled() {&nbsp;</div></li><li><div>    return $this-&gt;settings['fraud_data'] == 'yes';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the direct post URL</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_direct_post_url() {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span></span></span>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>    <span class="comment"><span class="comment"><span class="comment">// Replace the URL with the tokenize method and re-create the order text (json payload)</span></span></span>&nbsp;</div></li><li><div>    $url = str_replace(&quot;purchases&quot;, &quot;credit_cards&quot;, $url);&nbsp;</div></li><li><div>    $url = str_replace(&quot;v1.0&quot;, &quot;v2&quot;, $url);&nbsp;</div></li><li><div>    $url = $url . &quot;/direct/&quot; . $this-&gt;settings[&quot;username&quot;] . &quot;.json&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_form_fields()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;form_fields = array(&nbsp;</div></li><li><div>      'enabled' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('Enable/Disable', 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'label' =&gt; __('Enable Fat Zebra', 'woocommerce'), &nbsp;</div></li><li><div>        'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'test_mode' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('Test Mode', 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; __('Switches the gateway to live mode.', 'woocommerce'), &nbsp;</div></li><li><div>        'default' =&gt; &quot;yes&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'sandbox_mode' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('Sandbox Mode', 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; &quot;checkbox&quot;, &nbsp;</div></li><li><div>        'description' =&gt; __('Switches the gateway URL to the sandbox URL', &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; &quot;yes&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'use_direct_post' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('Use Direct Post', 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; 'Uses the Direct Post method for payments which prevents card data from being sent to your web server.', &nbsp;</div></li><li><div>        'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'show_logo' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Show Fat Zebra Logo&quot;, 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;Shows or hides the 'Fat Zebra Certified' logo on the payment form&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; &quot;yes&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'show_card_logos' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Show credit card logos&quot;, 'woocommerce'), &nbsp;</div></li><li><div>        'type' =&gt; 'multiselect', &nbsp;</div></li><li><div>        'description' =&gt; &quot;Shows or hides the credit card icons (AMEX, Visa, Discover, JCB etc). &lt;a href=\&quot;http:<span class="comment">//www.iconshock.com/credit-card-icons/\&quot;&gt;Credit Card Icons by iconshock&lt;/a&gt;&quot;, </span>&nbsp;</div></li><li><div>        'default' =&gt; array(&quot;visa&quot;, &quot;mastercard&quot;), &nbsp;</div></li><li><div>        &quot;options&quot; =&gt; array(&quot;visa&quot; =&gt; &quot;VISA&quot;, &quot;mastercard&quot; =&gt; &quot;MasterCard&quot;, &quot;american_express&quot; =&gt; &quot;AMEX&quot;, &quot;jcb&quot; =&gt; &quot;JCB&quot;), <span class="comment">//, &quot;diners_club&quot; =&gt; &quot;Diners&quot;, &quot;discover&quot; =&gt; &quot;Discover&quot;)</span>&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'username' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Gateway Username&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; 'text', &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;The Gateway Authentication Username&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; &quot;test&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'token' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Gateway Token&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; &quot;text&quot;, &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;The Gateway Authentication Token&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; &quot;test&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'shared_secret' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Gateway Shared Secret&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; &quot;text&quot;, &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;The Gateway Shared Secret - Required for Direct Post&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; &quot;&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'deferred_payments' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Enable Deferred Payments&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;Deferred payments enable you to capture the customers card details in Fat Zebra's system and process them at a later date (for example, once you have reviewed the order for high-risk products). Note: Deferred Payments cannot be used with WooCommerce Subscription - any subscriptions will be processed in Real Time.&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'fraud_data' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Send Fraud Data&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;Send additional data for fraud detection. Note this must be enabled by Fat Zebra before the data will be used.&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'fraud_device_id' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __(&quot;Enable Device ID&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'description' =&gt; __(&quot;For fraud detection. Enable this if instructed by Fat Zebra.&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>        'default' =&gt; 'no'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } <span class="comment">// End init_form_fields()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Admin Panel Options</span>&nbsp;</div></li><li><div><span class="comment">   * - Options for bits like 'title' and availability on a country-by-country basis</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_options() {&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>    &lt;h3&gt;&lt;?php _e('Fat Zebra', 'woocommerce'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>    &lt;p&gt;&lt;?php _e('Allows Fat Zebra Payments. ', 'woocommerce'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php $this-&gt;generate_settings_html(); ?&gt;&nbsp;</div></li><li><div>    &lt;/table&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  } <span class="comment">// End admin_options()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function payment_fields() {&nbsp;</div></li><li><div>    if ($this-&gt;direct_post_enabled()) {&nbsp;</div></li><li><div>      <span class="comment">// Register and enqueue direct post handling script</span>&nbsp;</div></li><li><div>      $url = $this-&gt;get_direct_post_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return_path = uniqid('fatzebra-nonce-');&nbsp;</div></li><li><div>      $verification_value = hash_hmac('md5', $return_path, $this-&gt;settings[&quot;shared_secret&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_register_script('fz-direct-post-handler', plugin_dir_url(__FILE__) . '/images/fatzebra.js', array('jquery'), WC_VERSION, true);&nbsp;</div></li><li><div>      wp_localize_script('fz-direct-post-handler', 'fatzebra', array(&nbsp;</div></li><li><div>        'url' =&gt; $url, &nbsp;</div></li><li><div>        'return_path' =&gt; $return_path, &nbsp;</div></li><li><div>        'verification_value' =&gt; $verification_value)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      wp_enqueue_script('fz-direct-post-handler');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $extra_fields = array(&quot;&lt;input type='hidden' name='fatzebra-token' id='fatzebra-token' /&gt;&lt;span class='payment-errors required'&gt;&lt;/span&gt;&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;fraud_detection_enabled() && $this-&gt;settings[&quot;fraud_device_id&quot;] === &quot;yes&quot;) {&nbsp;</div></li><li><div>      $device_id_url = $this-&gt;settings['sandbox_mode'] == 'yes' ? 'https:<span class="comment">//ci-mpsnare.iovation.com/snare.js' : 'https://mpsnare.iesnare.com/snare.js';</span>&nbsp;</div></li><li><div>      wp_register_script('fz-deviceid', plugin_dir_url(__FILE__) . '/images/fatzebra-deviceid.js', array(), WC_VERSION, false);&nbsp;</div></li><li><div>      wp_register_script('fz-io-bb', $device_id_url, array('fz-deviceid'), '1', true);&nbsp;</div></li><li><div>      wp_enqueue_script('fz-io-bb');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;credit_card_form(array('fields_have_names' =&gt; !$this-&gt;direct_post_enabled()), $extra_fields);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment and return the result</span>&nbsp;</div></li><li><div><span class="comment">   **/</span>&nbsp;</div></li><li><div>  function process_payment($order_id) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;direct_post_enabled()) {&nbsp;</div></li><li><div>      $this-&gt;params[&quot;card_token&quot;] = $_POST['fatzebra-token'];&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;params[&quot;card_number&quot;] = str_replace(' ', '', $_POST['fatzebra-card-number']);&nbsp;</div></li><li><div>      if (!isset($_POST[&quot;fatzebra-card-number&quot;])) {&nbsp;</div></li><li><div>        $this-&gt;params[&quot;card_number&quot;] = $_POST['cardnumber'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;params[&quot;cvv&quot;] = $_POST[&quot;fatzebra-card-cvc&quot;];&nbsp;</div></li><li><div>      if (!isset($_POST['fatzebra-card-cvc'])) {&nbsp;</div></li><li><div>        $this-&gt;params[&quot;cvv&quot;] = $_POST['card_cvv'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($_POST['fatzebra-card-expiry']) && !empty($_POST['fatzebra-card-expiry'])) {&nbsp;</div></li><li><div>        list($exp_month, $exp_year) = explode('/', $_POST['fatzebra-card-expiry']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $exp_month = $_POST['card_expiry_month'];&nbsp;</div></li><li><div>        $exp_year = $_POST['card_expiry_year'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;params[&quot;card_expiry&quot;] = trim($exp_month) . &quot;/&quot; . (2000 + intval($exp_year));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;params[&quot;card_holder&quot;] = $_POST['billing_first_name'] . &quot; &quot; . $_POST['billing_last_name'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $this-&gt;get_customer_real_ip();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $defer_payment = $this-&gt;settings[&quot;deferred_payments&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;currency&quot;] = $order-&gt;get_order_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (class_exists(&quot;WC_Subscriptions_Order&quot;) && wcs_order_contains_subscription($order)) {&nbsp;</div></li><li><div>      <span class="comment">// No deferred payments for subscriptions.</span>&nbsp;</div></li><li><div>      $defer_payment = false;&nbsp;</div></li><li><div>      <span class="comment">// Charge sign up fee + first period here..</span>&nbsp;</div></li><li><div>      <span class="comment">// Periodic charging should happen via scheduled_subscription_payment_fatzebra</span>&nbsp;</div></li><li><div>      $this-&gt;params[&quot;amount&quot;] = $this-&gt;convert_to_cents($order-&gt;get_total());&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;params[&quot;amount&quot;] = $this-&gt;convert_to_cents($order-&gt;order_total);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = (string)$order_id;&nbsp;</div></li><li><div>    $test_mode = $this-&gt;settings['test_mode'] == 'yes';&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;deferred&quot;] = $defer_payment;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (trim($this-&gt;params[&quot;card_holder&quot;]) == &quot;&quot;) { <span class="comment">// If the customer is updating their details the $_POST values for name will be missing, so fetch from the order</span>&nbsp;</div></li><li><div>      $this-&gt;params[&quot;card_holder&quot;] = $order-&gt;billing_first_name . &quot; &quot; . $order-&gt;billing_last_name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;fraud_detection_enabled()) {&nbsp;</div></li><li><div>      <span class="comment">// Add in the fraud data payload</span>&nbsp;</div></li><li><div>      $fraud_data = $this-&gt;get_fraud_payload($order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;params['fraud'] = $fraud_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;params[&quot;amount&quot;] === 0) {&nbsp;</div></li><li><div>      $result = $this-&gt;tokenize_card($this-&gt;params);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $result = $this-&gt;do_payment($this-&gt;params);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_wp_error($result)) {&nbsp;</div></li><li><div>      switch ($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>        case 1: <span class="comment"><span class="comment"><span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span></span></span>&nbsp;</div></li><li><div>          $order-&gt;add_order_note($result-&gt;get_error_message());&nbsp;</div></li><li><div>          wc_add_notice($result-&gt;get_error_message(), 'error');&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2: <span class="comment"><span class="comment"><span class="comment">// Gateway error (data etc)</span></span></span>&nbsp;</div></li><li><div>          $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>          foreach ($errors as $error) {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Gateway Error: &quot; . $error);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          error_log(&quot;WooCommerce Fat Zebra - Gateway Error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>          wc_add_notice(&quot;Payment Failed: &quot; . implode(&quot;, &quot;, $errors), 'error');&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 3: <span class="comment"><span class="comment"><span class="comment">// Declined - error data is array with keys: message, id</span></span></span>&nbsp;</div></li><li><div>          wc_add_notice(&quot;Payment declined: &quot; . $this-&gt;response_data-&gt;response-&gt;message, 'error');&nbsp;</div></li><li><div>          if (isset($this-&gt;response_data-&gt;response-&gt;fraud_result) && !empty($this-&gt;response_data-&gt;response-&gt;fraud_result)) {&nbsp;</div></li><li><div>            if ($this-&gt;response_data-&gt;response-&gt;fraud_result == 'Accept') {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(&quot;Fraud Check Result: Accept&quot;);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(&quot;Fraud Check Result: &quot; . $this-&gt;response_data-&gt;response-&gt;fraud_result . &quot; - &quot; . implode(&quot;, &quot;, $this-&gt;response_data-&gt;response-&gt;fraud_messages));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 4: <span class="comment"><span class="comment"><span class="comment">// Exception caught, something bad happened. Data is exception</span></span></span>&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>          wc_add_notice(&quot;Unknown error.&quot;, 'error');&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true)));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else { <span class="comment"><span class="comment">// Success! Returned is an array with the transaction ID etc</span></span>&nbsp;</div></li><li><div>      <span class="comment">// For a deferred payment we set the status to on-hold and then add a detailed note for review.</span>&nbsp;</div></li><li><div>      if ($defer_payment) {&nbsp;</div></li><li><div>        $date = new DateTime($result[&quot;card_expiry&quot;], new DateTimeZone(&quot;Australia/Sydney&quot;));&nbsp;</div></li><li><div>        $note = &quot;Deferred Payment:&lt;ul&gt;&lt;li&gt;Card Token: &quot; . $result[&quot;card_token&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Card Holder: &quot; . $result[&quot;card_holder&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Card Number: &quot; . $result[&quot;card_number&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Expiry: &quot; . $date-&gt;format(&quot;m/Y&quot;) . &quot;&lt;/li&gt;&lt;/ul&gt;&quot;;&nbsp;</div></li><li><div>        $order-&gt;update_status(&quot;on-hold&quot;, $note);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;_fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        if ($this-&gt;params[&quot;amount&quot;] === 0) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Fat Zebra payment complete - $0 initial amount, card tokenized. Card token: &quot; . $result[&quot;card_token&quot;]));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Fat Zebra payment complete. Reference: &quot; . $result[&quot;transaction_id&quot;]));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($this-&gt;response_data-&gt;response-&gt;fraud_result) && !empty($this-&gt;response_data-&gt;response-&gt;fraud_result)) {&nbsp;</div></li><li><div>          if ($this-&gt;response_data-&gt;response-&gt;fraud_result == 'Accept') {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Fraud Check Result: Accept&quot;);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Fraud Check Result: &quot; . $this-&gt;response_data-&gt;response-&gt;fraud_result . &quot; - &quot; . implode(&quot;, &quot;, $this-&gt;response_data-&gt;response-&gt;fraud_messages));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order-&gt;payment_complete($result['transaction_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        <span class="comment">// Store the card token as post meta</span>&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;_fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>        update_post_meta($order_id, 'Fat Zebra Transaction ID', $result['transaction_id']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array('result' =&gt; 'success', 'redirect' =&gt; $this-&gt;get_return_url($order));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process refund</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If the gateway declares 'refunds' support, this will allow it to refund</span>&nbsp;</div></li><li><div><span class="comment">   * a passed in amount.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $order_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param  float $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $reason</span>&nbsp;</div></li><li><div><span class="comment">   * @return  boolean True or false based on success, or a WP_Error object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_refund( $order_id, $amount = null, $reason = '' ) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;amount&quot;] = $this-&gt;convert_to_cents($amount);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = $order_id . &quot;-&quot; . time(); <span class="comment">// It is not possible to simply refund against the order ID as multiple reunds are permitted...</span>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;transaction_id&quot;] = get_post_meta($order_id, '_transaction_id', true);&nbsp;</div></li><li><div>    if (empty($this-&gt;params['transaction_id'])) {&nbsp;</div></li><li><div>      $this-&gt;params[&quot;transaction_id&quot;] = $this-&gt;fetch_fatzebra_transaction_id($order_id);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $this-&gt;get_customer_real_ip();&nbsp;</div></li><li><div>    $this-&gt;params[&quot;currency&quot;] = $order-&gt;get_order_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;settings['test_mode'] == 'yes';&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($this-&gt;params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>    <span class="comment">// URL is for /refunds</span>&nbsp;</div></li><li><div>    $url = str_replace('purchases', 'refunds', $url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array('method' =&gt; 'POST', &nbsp;</div></li><li><div>                  'body' =&gt; $order_text, &nbsp;</div></li><li><div>                  'headers' =&gt; array('Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;settings[&quot;token&quot;]), &nbsp;</div></li><li><div>                    'X-Test-Mode' =&gt; $test_mode, &nbsp;</div></li><li><div>                    'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version), &nbsp;</div></li><li><div>                  'timeout' =&gt; 30);&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>       wc_add_notice(&quot;Refund failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;], 'error');&nbsp;</div></li><li><div>       return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        wc_add_notice('Refund Failed - Gateway Error: ' . implode(&quot;, &quot;, $this-&gt;response_data-&gt;errors), 'error');&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        wc_add_notice('Refund Declined: ' . $this-&gt;response_data-&gt;response-&gt;message, 'error');&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        wc_add_notice('Refund Approved');&nbsp;</div></li><li><div>        $order-&gt;add_order_note('Refund for ' . $amount . ' successful. Refund ID: ' . $this-&gt;response_data-&gt;response-&gt;id);&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      wc_add_notice(&quot;Unknown Refund Error - please see error log&quot;, &quot;error&quot;);&nbsp;</div></li><li><div>      error_log(&quot;Exception caught during refund: &quot; . print_r($e, true));&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function fetch_fatzebra_transaction_id($order_id) {&nbsp;</div></li><li><div>    return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For the thankyou page :)</span>&nbsp;</div></li><li><div>  function thankyou_page() {&nbsp;</div></li><li><div>    if ($this-&gt;description) echo wpautop(wptexturize($this-&gt;description));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the subscription payment (manually... well via wp_cron)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $amount the amount for this payment</span>&nbsp;</div></li><li><div><span class="comment">   * @param $order the order ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param $product_id the product ID</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function scheduled_subscription_payment($amount_to_charge, $order, $product_id) {&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>    $this-&gt;params[&quot;amount&quot;] = $this-&gt;convert_to_cents($amount_to_charge);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = $order-&gt;id . &quot;-&quot; . date(&quot;dmY&quot;); <span class="comment">// Reference for order ID 123 will become 123-01022012</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $token = get_post_meta($order-&gt;id, &quot;_fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>    if (empty($token)) $token = get_post_meta($order-&gt;id, &quot;fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;card_token&quot;] = $token;&nbsp;</div></li><li><div>    $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>    if (empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;deferred&quot;] = false;&nbsp;</div></li><li><div>    $result = $this-&gt;do_payment($this-&gt;params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_wp_error($result)) {&nbsp;</div></li><li><div>      $error = &quot;&quot;;&nbsp;</div></li><li><div>      $txn_id = &quot;None&quot;;&nbsp;</div></li><li><div>      switch ($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>        case 1: <span class="comment"><span class="comment"><span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span></span></span>&nbsp;</div></li><li><div>          $error = $result-&gt;get_error_message();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2: <span class="comment"><span class="comment"><span class="comment">// Gateway error (data etc)</span></span></span>&nbsp;</div></li><li><div>          $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>          $error = implode(&quot;, &quot;, $errors);&nbsp;</div></li><li><div>          error_log(&quot;WooCommerce Fat Zebra - Gateway Error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 3: <span class="comment"><span class="comment"><span class="comment">// Declined - error data is array with keys: message, id</span></span></span>&nbsp;</div></li><li><div>          $error = $this-&gt;response_data-&gt;response-&gt;message;&nbsp;</div></li><li><div>          $txn_id = $this-&gt;response_data-&gt;response-&gt;transaction_id;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 4: <span class="comment"><span class="comment"><span class="comment">// Exception caught, something bad happened. Data is exception</span></span></span>&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>          $error = &quot;Unknown - Error - See error log&quot;;&nbsp;</div></li><li><div>          error_log(&quot;WC Fat Zebra (Subscriptions) - Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the error details and return</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Failed: &quot; . $error . &quot;. Transaction ID: &quot; . $txn_id));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payment_failure_on_order($order, $product_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else { <span class="comment"><span class="comment">// Success! Returned is an array with the transaction ID etc</span></span>&nbsp;</div></li><li><div>      <span class="comment">// Update the subscription and return</span>&nbsp;</div></li><li><div>      <span class="comment">// Add a note to the order</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Successful. Transaction ID: &quot; . $result[&quot;transaction_id&quot;]));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payments_on_order($order);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed WP_Error or Array (result)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function do_payment($params) {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span></span></span>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Deferred payments need to post to the /credit_cards endpoint.</span>&nbsp;</div></li><li><div>    if (isset($params[&quot;deferred&quot;]) && $params[&quot;deferred&quot;]) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Replace the URL with the tokenize method and re-create the order text (json payload)</span></span></span>&nbsp;</div></li><li><div>      $url = str_replace(&quot;purchases&quot;, &quot;credit_cards&quot;, $url);&nbsp;</div></li><li><div>      $payload = array(&quot;card_holder&quot; =&gt; $params[&quot;card_holder&quot;], &quot;card_number&quot; =&gt; $params[&quot;card_number&quot;], &quot;card_expiry&quot; =&gt; $params[&quot;card_expiry&quot;], &quot;cvv&quot; =&gt; $params[&quot;cvv&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>      if (empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>      if (!isset($payload[&quot;customer_ip&quot;])) $payload[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order_text = json_encode($payload);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array(&nbsp;</div></li><li><div>      'method' =&gt; 'POST', &nbsp;</div></li><li><div>      'body' =&gt; $order_text, &nbsp;</div></li><li><div>      'headers' =&gt; array(&nbsp;</div></li><li><div>        'Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;settings[&quot;token&quot;]), &nbsp;</div></li><li><div>        'X-Test-Mode' =&gt; $test_mode, &nbsp;</div></li><li><div>        'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'timeout' =&gt; 30&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(1, &quot;Credit Card Payment failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;]);&nbsp;</div></li><li><div>        $error-&gt;add_data($this-&gt;response);&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(2, &quot;Gateway Error&quot;, $this-&gt;response_data-&gt;errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we are doing a deferred payments we override the data here.</span>&nbsp;</div></li><li><div>      if (isset($params[&quot;deferred&quot;]) && $params[&quot;deferred&quot;]) {&nbsp;</div></li><li><div>        return array(&quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &quot;card_number&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_number, &quot;card_expiry&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_expiry, &quot;card_holder&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_holder);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(3, &quot;Payment Declined&quot;, array(&quot;message&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;message, &quot;id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id));&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        return array(&quot;transaction_id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id, &quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_token);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $error-&gt;add(4, &quot;Unknown Error&quot;, $e);&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed WP_Error or Array (result)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function tokenize_card($params) {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span></span></span>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>    if (empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>    if (!isset($payload[&quot;customer_ip&quot;])) $payload[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>    <span class="comment"><span class="comment"><span class="comment">// Replace the URL with the tokenize method and re-create the order text (json payload)</span></span></span>&nbsp;</div></li><li><div>    $url = str_replace(&quot;purchases&quot;, &quot;credit_cards&quot;, $url);&nbsp;</div></li><li><div>    $payload = array(&quot;card_holder&quot; =&gt; $params[&quot;card_holder&quot;], &quot;card_number&quot; =&gt; $params[&quot;card_number&quot;], &quot;card_expiry&quot; =&gt; $params[&quot;card_expiry&quot;], &quot;cvv&quot; =&gt; $params[&quot;cvv&quot;]);&nbsp;</div></li><li><div>    $order_text = json_encode($payload);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array(&nbsp;</div></li><li><div>      'method' =&gt; 'POST', &nbsp;</div></li><li><div>      'body' =&gt; $order_text, &nbsp;</div></li><li><div>      'headers' =&gt; array(&nbsp;</div></li><li><div>        'Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;settings[&quot;token&quot;]), &nbsp;</div></li><li><div>        'X-Test-Mode' =&gt; $test_mode, &nbsp;</div></li><li><div>        'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'timeout' =&gt; 30&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(1, &quot;Credit Card Payment failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;]);&nbsp;</div></li><li><div>        $error-&gt;add_data($this-&gt;response);&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(2, &quot;Gateway Error&quot;, $this-&gt;response_data-&gt;errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &quot;card_number&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_number, &quot;card_expiry&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_expiry, &quot;card_holder&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_holder, &quot;transaction_id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token);&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $error-&gt;add(4, &quot;Unknown Error&quot;, $e);&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the 'Charge Card' button if the order is on-hold</span>&nbsp;</div></li><li><div>  function add_process_deferred_payment_button($order_id) {&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>    if ($order-&gt;status == &quot;on-hold&quot;) {&nbsp;</div></li><li><div>      echo '&lt;li&gt;&lt;input type=&quot;submit&quot; class=&quot;button tips&quot; name=&quot;process&quot; value=&quot;Charge Card&quot; data-tip=&quot;Attempts to process a deferred payment&quot; /&gt;&lt;/li&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Builds the fraud payload for the request</span>&nbsp;</div></li><li><div><span class="comment">   * @param $order WC_Order the order to build the payload against</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_fraud_payload($order) {&nbsp;</div></li><li><div>    $fraud_data = array(&quot;website&quot; =&gt; get_site_url(), &quot;customer&quot; =&gt; $this-&gt;get_fraud_customer($order), &quot;items&quot; =&gt; $this-&gt;get_fraud_items($order), &quot;shipping_address&quot; =&gt; $this-&gt;get_fraud_shipping($order));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;settings[&quot;fraud_device_id&quot;] === &quot;yes&quot;) {&nbsp;</div></li><li><div>      $fraud_data[&quot;device_id&quot;] = $_POST['io_bb'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $fraud_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fetches the customer details for the fraud check request</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_fraud_customer($order) {&nbsp;</div></li><li><div>    $data = array(&nbsp;</div></li><li><div>      'first_name' =&gt; $order-&gt;billing_first_name, &nbsp;</div></li><li><div>      'last_name' =&gt; $order-&gt;billing_last_name, &nbsp;</div></li><li><div>      'email' =&gt; $order-&gt;billing_email, &nbsp;</div></li><li><div>      'address_1' =&gt; $order-&gt;billing_address_1, &nbsp;</div></li><li><div>      'address_2' =&gt; $order-&gt;billing_address_2, &nbsp;</div></li><li><div>      'city' =&gt; $order-&gt;billing_city, &nbsp;</div></li><li><div>      'country' =&gt; $this-&gt;country_map[$order-&gt;billing_country], &nbsp;</div></li><li><div>      'post_code' =&gt; $order-&gt;billing_postcode, &nbsp;</div></li><li><div>      'home_phone' =&gt; $order-&gt;billing_phone&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fetches the item details from the order for the fraud check request</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_fraud_items($order) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $data = array();&nbsp;</div></li><li><div>    $items = $order-&gt;get_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach ($items as $item) {&nbsp;</div></li><li><div>      $product = new WC_Product($item['product_id']);&nbsp;</div></li><li><div>      if (isset($item['variation_id'])) {&nbsp;</div></li><li><div>        $name = $product-&gt;get_title();&nbsp;</div></li><li><div>        $product = new WC_Product($item['variation_id']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $name = $product-&gt;get_title();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data[] = array(&nbsp;</div></li><li><div>        'product_code' =&gt; (string)$product-&gt;id, &nbsp;</div></li><li><div>        'sku' =&gt; $product-&gt;sku, &nbsp;</div></li><li><div>        'description' =&gt; $name, &nbsp;</div></li><li><div>        'qty' =&gt; $item['qty'], &nbsp;</div></li><li><div>        'cost' =&gt; $product-&gt;get_price(), &nbsp;</div></li><li><div>        'line_total' =&gt; $order-&gt;get_line_subtotal($item)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fetches the shipping details from the order for the fraud check request</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_fraud_shipping($order) {&nbsp;</div></li><li><div>    $data = array(&nbsp;</div></li><li><div>    'first_name' =&gt; $order-&gt;shipping_first_name, &nbsp;</div></li><li><div>    'last_name' =&gt; $order-&gt;shipping_last_name, &nbsp;</div></li><li><div>    'email' =&gt; $order-&gt;shipping_email, &nbsp;</div></li><li><div>    'address_1' =&gt; $order-&gt;shipping_address_1, &nbsp;</div></li><li><div>    'address_2' =&gt; $order-&gt;shipping_address_2, &nbsp;</div></li><li><div>    'city' =&gt; $order-&gt;shipping_city, &nbsp;</div></li><li><div>    'country' =&gt; $this-&gt;country_map[$order-&gt;shipping_country], &nbsp;</div></li><li><div>    'post_code' =&gt; $order-&gt;shipping_postcode, &nbsp;</div></li><li><div>    'shipping_method' =&gt; 'low_cost' <span class="comment">// TODO: Shipping Method Map</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (empty($data['email'])) $data['email'] = $order-&gt;billing_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_customer_real_ip() {&nbsp;</div></li><li><div>    $customer_ip = $_SERVER['REMOTE_ADDR'];&nbsp;</div></li><li><div>    if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {&nbsp;</div></li><li><div>      $forwarded_ips = explode(', ', $_SERVER['HTTP_X_FORWARDED_FOR']);&nbsp;</div></li><li><div>      $customer_ip = $forwarded_ips[0];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $customer_ip;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Safely convert to cents, preventing rounding errors</span>&nbsp;</div></li><li><div><span class="comment">   * Before: $134.95 = 13, 494 cents</span>&nbsp;</div></li><li><div><span class="comment">   * After: $134.95 = 13, 495 cents</span>&nbsp;</div></li><li><div><span class="comment">   * @param  float $amount Amount in dollars (eg 134.95)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int           Amount in Cents (eg 13495)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function convert_to_cents($amount)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>    if(function_exists('bcmul')) {&nbsp;</div></li><li><div>      <span class="comment">// BCMath is the most reliable method, if enabled</span>&nbsp;</div></li><li><div>      return (int) bcmul($amount, 100);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    <span class="comment">// Hacky workaround</span>&nbsp;</div></li><li><div>    return (int) round(($amount * 100), 0, PHP_ROUND_HALF_UP);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add the gateway to WooCommerce</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function add_fz_gateway($methods) {&nbsp;</div></li><li><div>  $methods[] = 'WC_FatZebra';&nbsp;</div></li><li><div>  return $methods;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Attempt to process the deferred payment. This is called when you press the 'Charge card' button on the order page.</span>&nbsp;</div></li><li><div>function attempt_deferred_payment($post_id, $post) {&nbsp;</div></li><li><div>  global $wpdb, $woocommerce, $woocommerce_errors;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if we don't have anything to do.</span>&nbsp;</div></li><li><div>  if (!isset($_POST['process'])) return;&nbsp;</div></li><li><div>  $order = new WC_Order($post_id);&nbsp;</div></li><li><div>  if ($order-&gt;status != &quot;on-hold&quot;) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gateways = $woocommerce-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>  $gateway = $gateways['fatzebra'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Build the params for the payment</span>&nbsp;</div></li><li><div>  $token = get_post_meta($post_id, &quot;_fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>  if (empty($token)) $token = get_post_meta($post_id, &quot;fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>  if (empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>  $this-&gt;params[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $params = array(&quot;card_token&quot; =&gt; $token, &quot;amount&quot; =&gt; $this-&gt;convert_to_cents($order-&gt;order_total), &quot;reference&quot; =&gt; $order-&gt;id, &quot;customer_ip&quot; =&gt; $ip);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do the payment and handle the result.</span>&nbsp;</div></li><li><div>  $result = $gateway-&gt;do_payment($params);&nbsp;</div></li><li><div>  if (is_wp_error($result)) {&nbsp;</div></li><li><div>    switch ($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>      case 1: <span class="comment"><span class="comment"><span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span></span></span>&nbsp;</div></li><li><div>        $order-&gt;add_order_note($result-&gt;get_error_message());&nbsp;</div></li><li><div>        $woocommerce-&gt;add_error($result-&gt;get_error_message());&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 2: <span class="comment"><span class="comment"><span class="comment">// Gateway error (data etc)</span></span></span>&nbsp;</div></li><li><div>        $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>        foreach ($errors as $error) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(&quot;Gateway Error: &quot; . $error);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        error_log(&quot;WooCommerce Fat Zebra - Unknown error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>        $woocommerce-&gt;add_error(&quot;Payment Failed: &quot; . implode(&quot;, &quot;, $errors));&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 3: <span class="comment"><span class="comment"><span class="comment">// Declined - error data is array with keys: message, id</span></span></span>&nbsp;</div></li><li><div>        $order-&gt;add_order_note(__(&quot;Payment Declined: &quot; . $result-&gt;response-&gt;message . &quot;. Reference: &quot; . $result-&gt;response-&gt;transaction_id));&nbsp;</div></li><li><div>        $woocommerce-&gt;add_error(&quot;Payment declined: &quot; . $result-&gt;response-&gt;message);&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 4: <span class="comment"><span class="comment"><span class="comment">// Exception caught, something bad happened. Data is exception</span></span></span>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>        $woocommerce-&gt;add_error(&quot;Unknown error.&quot;);&nbsp;</div></li><li><div>        $order-&gt;add_order_note(__(&quot;Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true)));&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>    <span class="comment">// We're all good - update the notes, change status to payment complete and send invoice.</span>&nbsp;</div></li><li><div>    $order-&gt;add_order_note(&quot;Fat Zebra payment complete. Reference: &quot; . $result[&quot;transaction_id&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($_POST['order_status'])) unset($_POST['order_status']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order-&gt;payment_complete();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Only update the recurring payment method if:</span>&nbsp;</div></li><li><div><span class="comment">//  - The method is not set</span>&nbsp;</div></li><li><div><span class="comment">//  - the fatzebra_card_token is set</span>&nbsp;</div></li><li><div>function set_recurring_payment_method($post_id) {&nbsp;</div></li><li><div>  $method = get_post_meta($post_id, &quot;_recurring_payment_method&quot;, true);&nbsp;</div></li><li><div>  $token = get_post_meta($post_id, &quot;fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>  if (empty($method) && !empty($token)) {&nbsp;</div></li><li><div>    update_post_meta($post_id, &quot;_recurring_payment_method&quot;, &quot;fatzebra&quot;);&nbsp;</div></li><li><div>    update_post_meta($post_id, &quot;_recurring_payment_method_title&quot;, &quot;Credit Card&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_customize_woocommerce_states() {&nbsp;</div></li><li><div>  global $states;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $states['AU'] = array(&nbsp;</div></li><li><div>      'ACT' =&gt; __( 'ACT', 'woocommerce' ), &nbsp;</div></li><li><div>      'NSW' =&gt; __( 'NSW', 'woocommerce' ), &nbsp;</div></li><li><div>      'NT' =&gt; __( 'NT', 'woocommerce' ), &nbsp;</div></li><li><div>      'QLD' =&gt; __( 'QLD', 'woocommerce' ), &nbsp;</div></li><li><div>      'SA' =&gt; __( 'SA', 'woocommerce' ), &nbsp;</div></li><li><div>      'TAS' =&gt; __( 'TAS', 'woocommerce' ), &nbsp;</div></li><li><div>      'VIC' =&gt; __( 'VIC', 'woocommerce' ), &nbsp;</div></li><li><div>      'WA' =&gt; __( 'WA', 'woocommerce' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $states;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_payment_gateways', 'add_fz_gateway');&nbsp;</div></li><li><div>add_action('woocommerce_process_shop_order_meta', 'attempt_deferred_payment', 1, 2);&nbsp;</div></li><li><div>add_action('save_post', 'set_recurring_payment_method');&nbsp;</div></li><li><div>add_filter( 'woocommerce_states', 'fz_customize_woocommerce_states' );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Fat Zebra Gateway</li><li><span></span>1.5.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>