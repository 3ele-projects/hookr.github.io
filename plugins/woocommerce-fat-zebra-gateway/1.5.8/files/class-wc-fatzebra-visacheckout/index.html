<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.5.8" data-slug="woocommerce-fat-zebra-gateway" data-type="file" data-id="78255"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-wc-fatzebra-visacheckout | file | Woocommerce Fat Zebra Gateway | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-fat-zebra-gateway, 1.5.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=19002629ca6c38a739dcb28e00d79e1f' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-wc-fatzebra-visacheckout/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra-visacheckout%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-wc-fatzebra-visacheckout%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-fat-zebra-gateway-1.5.8-file-class-wc-fatzebra-visacheckout","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-wc-fatzebra-visacheckout" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-fat-zebra-gateway." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/" class="plugin"><span property="name">woocommerce-fat-zebra-gateway</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.5.8." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/" class="H_VERSION"><span property="name">1.5.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-wc-fatzebra-visacheckout</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/all/" title="All">All <span class="count badge">4</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/hooks/" title="Hooks">Hooks <span class="count badge">1</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="1"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/filters/" title="Filters">Filters <span class="count badge">1</span></a></li><li class="" data-id="class" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/classes/" title="Classes">Classes <span class="count badge">0</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="3"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/functions/" title="Functions">Functions <span class="count badge">3</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-fat-zebra-gateway/1.5.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class-wc-fatzebra-visacheckout.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_init() {&nbsp;</div></li><li><div>class WC_FatZebra_VisaCheckout extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>    $this-&gt;id = 'fatzebra_visacheckout';&nbsp;</div></li><li><div>    $this-&gt;icon = &quot;https:<span class="comment">//assets.secure.checkout.visa.com/VmeCardArts/partner/POS_horizontal_99x34.png&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;has_fields = true;&nbsp;</div></li><li><div>    $this-&gt;method_title = __( 'Fat Zebra (VISA Checkout)', 'woocommerce' );&nbsp;</div></li><li><div>    $this-&gt;version = &quot;1.5.8&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;api_version = &quot;1.0&quot;;&nbsp;</div></li><li><div>    $this-&gt;live_url = &quot;https:<span class="comment">//gateway.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>    $this-&gt;sandbox_url = &quot;https:<span class="comment">//gateway.sandbox.fatzebra.com.au/v{$this-&gt;api_version}/purchases&quot;;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;supports = array( 'subscriptions', 'products', 'refunds', 'subscription_cancellation', 'subscription_reactivation', 'subscription_suspension', 'subscription_amount_changes', 'subscription_payment_method_change', 'subscription_date_changes' );&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Define user set variables</span>&nbsp;</div></li><li><div>    $this-&gt;title = 'Visa Checkout';&nbsp;</div></li><li><div>    $this-&gt;description = in_array(&quot;description&quot;, $this-&gt;settings) ? $this-&gt;settings['description'] : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the form fields.</span>&nbsp;</div></li><li><div>    $this-&gt;init_form_fields();&nbsp;</div></li><li><div>    $this-&gt;init_parent_settings(); <span class="comment">// Allows us to access $this-&gt;parent_settings[] for username, token etc</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>    $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Actions</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways', array(&$this, 'process_admin_options')); <span class="comment">// &lt; 2.0</span>&nbsp;</div></li><li><div>    add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) ); <span class="comment">//&gt; 2.0</span>&nbsp;</div></li><li><div>    add_action('scheduled_subscription_payment_' . $this-&gt;id, array(&$this, 'scheduled_subscription_payment'), 10, 3);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initializes the parent (WC_FatZebra) settings</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_parent_settings() {&nbsp;</div></li><li><div>    $this-&gt;parent_settings = get_option(&quot;woocommerce_fatzebra_settings&quot;, null);&nbsp;</div></li><li><div>    if ( ! $this-&gt;parent_settings || ! is_array( $this-&gt;parent_settings ) ) {&nbsp;</div></li><li><div>      $this-&gt;parent_settings = array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $this-&gt;parent_settings && is_array( $this-&gt;parent_settings ) ) {&nbsp;</div></li><li><div>     $this-&gt;parent_settings = array_map( array( $this, 'format_settings' ), $this-&gt;parent_settings );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_form_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;form_fields = array(&nbsp;</div></li><li><div>    'enabled' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Enable/Disable', 'woocommerce' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; __( 'Enable Visa Checkout', 'woocommerce' ), &nbsp;</div></li><li><div>            'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>    'api_key' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __(&quot;API Key&quot;, 'woocommerce'), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __(&quot;The Visa Checkout API Key (provided by Fat Zebra).&quot;, &quot;woocommerce&quot;), &nbsp;</div></li><li><div>            'default' =&gt; &quot;&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>    'logo_url' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; &quot;Logo URL&quot;, &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; &quot;The HTTPS Logo URL to be displayed in the Visa Checkout Dialog. Maximum 174px wide and 34px high.&quot;, &nbsp;</div></li><li><div>            'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>    'collect_shipping' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; &quot;Collect Shipping Details&quot;, &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } <span class="comment">// End init_form_fields()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Admin Panel Options</span>&nbsp;</div></li><li><div><span class="comment">   * - Options for bits like 'title' and availability on a country-by-country basis</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_options() {&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>    &lt;h3&gt;&lt;?php _e('Fat Zebra', 'woocommerce'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>    &lt;p&gt;&lt;?php _e('Allows Fat Zebra Payments. ', 'woocommerce'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php $this-&gt;generate_settings_html(); ?&gt;&nbsp;</div></li><li><div>    &lt;/table&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>  } <span class="comment">// End admin_options()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function payment_fields() {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      $callid = WC()-&gt;session-&gt;get('visa_wallet_callid');&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>    &lt;input type='hidden' name='encKey' id='encKey' /&gt;&nbsp;</div></li><li><div>    &lt;input type='hidden' name='encPaymentData' id='encPaymentData' /&gt;&nbsp;</div></li><li><div>    &lt;input type='hidden' name='callid' id='callid' value='&lt;?php echo $callid; ?&gt;' /&gt;&nbsp;</div></li><li><div>    &lt;input type='hidden' name='token' id='token' value='&lt;?php echo WC()-&gt;session-&gt;get('visa_wallet_token'); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;p&gt;&nbsp;</div></li><li><div>      With Visa Checkout, you now have an easier way to pay with your card online, from the company you know and trust. Create an account once and speed through your purchase without re-entering payment or shipping information wherever you see Visa Checkout.&nbsp;</div></li><li><div>    &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php if (!empty($callid)) { ?&gt;&nbsp;</div></li><li><div>      &lt;p style='font-weight: bold'&gt;The following card has been selected via Visa Checkout:&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p style='font-size: 20px; padding-left: 40px; margin-top: 20px; font-family: monospace;'&gt;&nbsp;</div></li><li><div>        &lt;?php echo WC()-&gt;session-&gt;get('visa_wallet_masked_number'); ?&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;style type='text/css'&gt;&nbsp;</div></li><li><div>      #custom-visa-checkout-outer-container{&nbsp;</div></li><li><div>       float: right;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    &lt;/style&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $visa_base_url = $this-&gt;parent_settings['sandbox_mode'] == &quot;yes&quot; ? 'https:<span class="comment"><span class="comment">//sandbox.secure.checkout.visa.com' : 'https://secure.checkout.visa.com';</span></span>&nbsp;</div></li><li><div>    $accepted_cards = array();&nbsp;</div></li><li><div>    foreach($this-&gt;parent_settings['show_card_logos'] as $card) {&nbsp;</div></li><li><div>        if ($card == 'american_express') $card = &quot;AMEX&quot;;&nbsp;</div></li><li><div>        $accepted_cards[] = strtoupper($card);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    wp_register_script( 'fz-visacheckout', plugin_dir_url(__FILE__) . '/images/fatzebra-visacheckout.js', array(), WC_VERSION, false );&nbsp;</div></li><li><div>    wp_register_script( 'visa-checkout', &quot;{$visa_base_url}/checkout-widget/resources/js/integration/v1/sdk.js&quot;, array(), WC_VERSION, true );&nbsp;</div></li><li><div>    wp_localize_script( 'fz-visacheckout', 'fzvisa', array(&nbsp;</div></li><li><div>          'api_key' =&gt; $this-&gt;settings['api_key'], &nbsp;</div></li><li><div>          'website' =&gt; get_site_url(), &nbsp;</div></li><li><div>          'website_name' =&gt; get_bloginfo('title'), &nbsp;</div></li><li><div>          'logo_url' =&gt; $this-&gt;settings['logo_url'], &nbsp;</div></li><li><div>          'regions' =&gt; array('AU'), &nbsp;</div></li><li><div>          'card_brands' =&gt; $accepted_cards, &nbsp;</div></li><li><div>          'currency' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div>          'order_total' =&gt; $woocommerce-&gt;cart-&gt;total, &nbsp;</div></li><li><div>          'visa_checkout_button' =&gt; $this-&gt;get_visa_checkout_button($accepted_cards), &nbsp;</div></li><li><div>          'button_text' =&gt; 'Pay', &nbsp;</div></li><li><div>          'review_message' =&gt; 'Please select your card and click Pay to complete your order', &nbsp;</div></li><li><div>          'shipping' =&gt; $this-&gt;settings['collect_shipping'] == &quot;yes&quot;, &nbsp;</div></li><li><div>          'checkout_captured' =&gt; !is_null($callid)&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    wp_enqueue_script( 'fz-visacheckout' );&nbsp;</div></li><li><div>    wp_enqueue_script( 'visa-checkout' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;parent_settings['fraud_data'] == 'yes' && $this-&gt;parent_settings[&quot;fraud_device_id&quot;] === &quot;yes&quot;) {&nbsp;</div></li><li><div>      $device_id_url = $this-&gt;parent_settings['sandbox_mode'] == 'yes' ? 'https:<span class="comment">//ci-mpsnare.iovation.com/snare.js' : 'https://mpsnare.iesnare.com/snare.js';</span>&nbsp;</div></li><li><div>      wp_register_script('fz-deviceid', plugin_dir_url(__FILE__) . '/images/fatzebra-deviceid.js', array(), WC_VERSION, false);&nbsp;</div></li><li><div>      wp_register_script('fz-io-bb', $device_id_url, array('fz-deviceid'), '1', true);&nbsp;</div></li><li><div>      wp_enqueue_script('fz-io-bb');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!is_null($callid)) {&nbsp;</div></li><li><div>      <span class="comment">//pre-select Visa Checkout as the payment method</span>&nbsp;</div></li><li><div>      $available_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>      $available_gateways['fatzebra_visacheckout']-&gt;set_current();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment and return the result</span>&nbsp;</div></li><li><div><span class="comment">   **/</span>&nbsp;</div></li><li><div>  function process_payment( $order_id ) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $this-&gt;get_customer_real_ip();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $defer_payment = $this-&gt;parent_settings[&quot;deferred_payments&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>    $test_mode = $this-&gt;parent_settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>    $this-&gt;params[&quot;currency&quot;] = $order-&gt;get_order_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (class_exists(&quot;WC_Subscriptions_Order&quot;) && WC_Subscriptions_Order::order_contains_subscription($order)) {&nbsp;</div></li><li><div>      <span class="comment">// No deferred payments for subscriptions.</span>&nbsp;</div></li><li><div>      $defer_payment = false;&nbsp;</div></li><li><div>      <span class="comment">// Charge sign up fee + first period here..</span>&nbsp;</div></li><li><div>      <span class="comment">// Periodic charging should happen via scheduled_subscription_payment_fatzebra</span>&nbsp;</div></li><li><div>      $this-&gt;params[&quot;amount&quot;] = (int)(WC_Subscriptions_Order::get_total_initial_payment($order) * 100);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;params[&quot;amount&quot;] = (int)($order-&gt;order_total * 100);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = (string)$order_id;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;deferred&quot;] = $defer_payment;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;wallet&quot;] = array(&nbsp;</div></li><li><div>                                &quot;type&quot; =&gt; &quot;VISA&quot;, &nbsp;</div></li><li><div>                                &quot;callid&quot; =&gt; $_POST['callid']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($_POST['token'])) {&nbsp;</div></li><li><div>      $this-&gt;params['card_token'] = $_POST['token'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;parent_settings['fraud_data'] == 'yes') {&nbsp;</div></li><li><div>      $fz_base = new WC_FatZebra();&nbsp;</div></li><li><div>      $fraud_data = $fz_base-&gt;get_fraud_payload($order);&nbsp;</div></li><li><div>      $this-&gt;params['fraud'] = $fraud_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;params[&quot;amount&quot;] === 0) {&nbsp;</div></li><li><div>      $result = $this-&gt;tokenize_card($this-&gt;params);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $result = $this-&gt;do_payment($this-&gt;params);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_wp_error($result)) {&nbsp;</div></li><li><div>      switch($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>        case 1: <span class="comment"><span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span></span>&nbsp;</div></li><li><div>          $order-&gt;add_order_note($result-&gt;get_error_message());&nbsp;</div></li><li><div>          wc_add_notice($result-&gt;get_error_message(), 'error');&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2: <span class="comment"><span class="comment">// Gateway error (data etc)</span></span>&nbsp;</div></li><li><div>          $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>          foreach($errors as $error) {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Gateway Error: &quot; . $error);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          error_log(&quot;WooCommerce Fat Zebra - Gateway Error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>          wc_add_notice(&quot;Payment Failed: &quot; . implode(&quot;, &quot;, $errors), 'error');&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 3: <span class="comment"><span class="comment">// Declined - error data is array with keys: message, id</span></span>&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Payment Declined: &quot; . $this-&gt;response_data-&gt;response-&gt;message . &quot;. Reference: &quot; . $this-&gt;response_data-&gt;response-&gt;transaction_id));&nbsp;</div></li><li><div>          wc_add_notice(&quot;Payment declined: &quot; . $this-&gt;response_data-&gt;response-&gt;message, 'error');&nbsp;</div></li><li><div>          if (isset($this-&gt;response_data-&gt;response-&gt;fraud_result) && !empty($this-&gt;response_data-&gt;response-&gt;fraud_result)) {&nbsp;</div></li><li><div>            if ($this-&gt;response_data-&gt;response-&gt;fraud_result == 'Accept') {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(&quot;Fraud Check Result: Accept&quot;);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(&quot;Fraud Check Result: &quot; . $this-&gt;response_data-&gt;response-&gt;fraud_result . &quot; - &quot; . implode(&quot;, &quot;, $this-&gt;response_data-&gt;response-&gt;fraud_messages));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 4: <span class="comment"><span class="comment">// Exception caught, something bad happened. Data is exception</span></span>&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>          wc_add_notice(&quot;Unknown error.&quot;, 'error');&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true)));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else { <span class="comment"><span class="comment">// Success! Returned is an array with the transaction ID etc</span></span>&nbsp;</div></li><li><div>      <span class="comment">// For a deferred payment we set the status to on-hold and then add a detailed note for review.</span>&nbsp;</div></li><li><div>      if ($defer_payment) {&nbsp;</div></li><li><div>        $date = new DateTime($result[&quot;card_expiry&quot;], new DateTimeZone(&quot;Australia/Sydney&quot;));&nbsp;</div></li><li><div>        $note = &quot;Deferred Payment:&lt;ul&gt;&lt;li&gt;Card Token: &quot; . $result[&quot;card_token&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Card Holder: &quot; . $result[&quot;card_holder&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Card Number: &quot; . $result[&quot;card_number&quot;] . &quot;&lt;/li&gt;&lt;li&gt;Expiry: &quot; . $date-&gt;format(&quot;m/Y&quot;) . &quot;&lt;/li&gt;&lt;/ul&gt;&quot;;&nbsp;</div></li><li><div>        $order-&gt;update_status(&quot;on-hold&quot;, $note);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;_fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        if ($this-&gt;params[&quot;amount&quot;] === 0) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Fat Zebra payment complete - $0 initial amount, card tokenized. Card token: &quot; . $result[&quot;card_token&quot;]));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__(&quot;Fat Zebra payment complete. Reference: &quot; . $result[&quot;transaction_id&quot;]));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($this-&gt;response_data-&gt;response-&gt;fraud_result ) && !empty($this-&gt;response_data-&gt;response-&gt;fraud_result )) {&nbsp;</div></li><li><div>          if ($this-&gt;response_data-&gt;response-&gt;fraud_result == 'Accept') {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Fraud Check Result: Accept&quot;);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            $order-&gt;add_order_note(&quot;Fraud Check Result: &quot; . $this-&gt;response_data-&gt;response-&gt;fraud_result  . &quot; - &quot; . implode(&quot;, &quot;, $this-&gt;response_data-&gt;response-&gt;fraud_messages));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $order-&gt;payment_complete($result['transaction_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        <span class="comment">// Clear the session values</span>&nbsp;</div></li><li><div>        $this-&gt;clear_visa_checkout_session_values();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        <span class="comment">// Store the card token as post meta</span>&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;_fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>        update_post_meta($order_id, &quot;fatzebra_card_token&quot;, $result[&quot;card_token&quot;]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>        'result' =&gt; 'success', &nbsp;</div></li><li><div>        'redirect' =&gt; $this-&gt;get_return_url( $order )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function process_refund( $order_id, $amount = null, $reason = '' ) {&nbsp;</div></li><li><div>    $payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>    if (!isset($payment_gateways['fatzebra'])) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $gw = $payment_gateways['fatzebra'];&nbsp;</div></li><li><div>    return $gw-&gt;process_refund($order_id, $amount, $reason);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed WP_Error or Array (result)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function tokenize_card($params) {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;parent_settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;parent_settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $ip = null; <span class="comment">//get_post_meta($post_id, &quot;Customer IP Address&quot;, true);</span>&nbsp;</div></li><li><div>    if (empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>    if (!isset($payload[&quot;customer_ip&quot;])) $payload[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>    <span class="comment">// Replace the URL with the tokenize method and re-create the order text (json payload)</span>&nbsp;</div></li><li><div>    $url = str_replace(&quot;purchases&quot;, &quot;credit_cards&quot;, $url);&nbsp;</div></li><li><div>    if (isset($params['callid'])) {&nbsp;</div></li><li><div>      $payload = array(&quot;wallet&quot; =&gt; array(&quot;type&quot; =&gt; &quot;VISA&quot;, &quot;callid&quot; =&gt; $params['callid']));&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $payload = array(&quot;card_holder&quot; =&gt; $params[&quot;card_holder&quot;], &quot;card_number&quot; =&gt; $params[&quot;card_number&quot;], &quot;card_expiry&quot; =&gt; $params[&quot;card_expiry&quot;], &quot;cvv&quot; =&gt; $params[&quot;cvv&quot;]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $order_text = json_encode($payload);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array('method' =&gt; 'POST', 'body' =&gt; $order_text, 'headers' =&gt; array('Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;parent_settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;parent_settings[&quot;token&quot;]), 'X-Test-Mode' =&gt; $test_mode, 'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version), 'timeout' =&gt; 30);&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(1, &quot;Credit Card Payment failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;]);&nbsp;</div></li><li><div>        $error-&gt;add_data($this-&gt;response);&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(2, &quot;Gateway Error&quot;, $this-&gt;response_data-&gt;errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>        &quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &nbsp;</div></li><li><div>        &quot;card_number&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_number, &nbsp;</div></li><li><div>        &quot;card_expiry&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_expiry, &nbsp;</div></li><li><div>        &quot;card_holder&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_holder, &nbsp;</div></li><li><div>        &quot;transaction_id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &nbsp;</div></li><li><div>        &quot;wallet&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;wallet);&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $error-&gt;add(4, &quot;Unknown Error&quot;, $e);&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For the thankyou page :)</span>&nbsp;</div></li><li><div>  function thankyou_page() {&nbsp;</div></li><li><div>    if ($this-&gt;description) echo wpautop(wptexturize($this-&gt;description));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * Process the subscription payment (manually... well via wp_cron)</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * @param $amount the amount for this payment</span>&nbsp;</div></li><li><div><span class="comment">  * @param $order the order ID</span>&nbsp;</div></li><li><div><span class="comment">  * @param $product_id the product ID</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function scheduled_subscription_payment($amount_to_charge, $order, $product_id) {&nbsp;</div></li><li><div>    $this-&gt;params = array();&nbsp;</div></li><li><div>    $this-&gt;params[&quot;amount&quot;] = (int)($amount_to_charge * 100);&nbsp;</div></li><li><div>    $this-&gt;params[&quot;test&quot;] = $test_mode;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;reference&quot;] = $order-&gt;id . &quot;-&quot; . date(&quot;dmY&quot;); <span class="comment">// Reference for order ID 123 will become 123-01022012</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $token = get_post_meta($order-&gt;id, &quot;fatzebra_card_token&quot;, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;params[&quot;card_token&quot;] = $token;&nbsp;</div></li><li><div>    $ip = get_post_meta($post_id, &quot;Customer IP Address&quot;, true);&nbsp;</div></li><li><div>    if(empty($ip)) $ip = &quot;127.0.0.1&quot;;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;customer_ip&quot;] = $ip;&nbsp;</div></li><li><div>    $this-&gt;params[&quot;deferred&quot;] = false;&nbsp;</div></li><li><div>    $result = $this-&gt;do_payment($this-&gt;params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_wp_error($result)) {&nbsp;</div></li><li><div>      $error = &quot;&quot;;&nbsp;</div></li><li><div>      $txn_id = &quot;None&quot;;&nbsp;</div></li><li><div>      switch($result-&gt;get_error_code()) {&nbsp;</div></li><li><div>        case 1: <span class="comment"><span class="comment">// Non-200 response, so failed... (e.g. 401, 403, 500 etc).</span></span>&nbsp;</div></li><li><div>          $error = $result-&gt;get_error_message();&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2: <span class="comment"><span class="comment">// Gateway error (data etc)</span></span>&nbsp;</div></li><li><div>          $errors = $result-&gt;get_error_data();&nbsp;</div></li><li><div>          $error = implode(&quot;, &quot;, $errors);&nbsp;</div></li><li><div>          error_log(&quot;WooCommerce Fat Zebra - Gateway Error: &quot; . print_r($errors, true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 3: <span class="comment"><span class="comment">// Declined - error data is array with keys: message, id</span></span>&nbsp;</div></li><li><div>          $error = $this-&gt;response_data-&gt;response-&gt;message;&nbsp;</div></li><li><div>          $txn_id = $this-&gt;response_data-&gt;response-&gt;transaction_id;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 4: <span class="comment"><span class="comment">// Exception caught, something bad happened. Data is exception</span></span>&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>          $error = &quot;Unknown - Error - See error log&quot;;&nbsp;</div></li><li><div>          error_log(&quot;WC Fat Zebra (Subscriptions) - Unknown Error (exception): &quot; . print_r($result-&gt;get_error_data(), true));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the error details and return</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Failed: &quot; . $error . &quot;. Transaction ID: &quot; . $txn_id));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payment_failure_on_order( $order, $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else { <span class="comment"><span class="comment">// Success! Returned is an array with the transaction ID etc</span></span>&nbsp;</div></li><li><div>      <span class="comment">// Update the subscription and return</span>&nbsp;</div></li><li><div>      <span class="comment">// Add a note to the order</span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__(&quot;Subscription Payment Successful. Transaction ID: &quot; . $result[&quot;transaction_id&quot;]));&nbsp;</div></li><li><div>      WC_Subscriptions_Manager::process_subscription_payments_on_order( $order );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * @return mixed WP_Error or Array (result)</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function do_payment($params) {&nbsp;</div></li><li><div>    $sandbox_mode = $this-&gt;parent_settings[&quot;sandbox_mode&quot;] == &quot;yes&quot;; <span class="comment"><span class="comment">// Yup, the checkbox settings return as 'yes' or 'no'</span></span>&nbsp;</div></li><li><div>    $test_mode = $this-&gt;parent_settings[&quot;test_mode&quot;] == &quot;yes&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_text = json_encode($params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $url = $sandbox_mode ? $this-&gt;sandbox_url : $url = $this-&gt;live_url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $args = array(&nbsp;</div></li><li><div>      'method' =&gt; 'POST', &nbsp;</div></li><li><div>      'body' =&gt; $order_text, &nbsp;</div></li><li><div>      'headers' =&gt; array(&nbsp;</div></li><li><div>        'Authorization' =&gt; 'Basic ' . base64_encode($this-&gt;parent_settings[&quot;username&quot;] . &quot;:&quot; . $this-&gt;parent_settings[&quot;token&quot;]), &nbsp;</div></li><li><div>        'X-Test-Mode' =&gt; $test_mode, &nbsp;</div></li><li><div>        'User-Agent' =&gt; &quot;WooCommerce Plugin &quot; . $this-&gt;version&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'timeout' =&gt; 30&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    try {&nbsp;</div></li><li><div>      $this-&gt;response = (array)wp_remote_request($url, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ((int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 200 && (int)$this-&gt;response[&quot;response&quot;][&quot;code&quot;] != 201) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(1, &quot;Credit Card Payment failed: &quot; . $this-&gt;response[&quot;response&quot;][&quot;message&quot;]);&nbsp;</div></li><li><div>        $error-&gt;add_data($this-&gt;response);&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;response_data = json_decode($this-&gt;response['body']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(2, &quot;Gateway Error&quot;, $this-&gt;response_data-&gt;errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we are doing a deferred payments we override the data here.</span>&nbsp;</div></li><li><div>      if (isset($params[&quot;deferred&quot;]) && $params[&quot;deferred&quot;]) {&nbsp;</div></li><li><div>        return array(&quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;token, &quot;card_number&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_number, &quot;card_expiry&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_expiry, &quot;card_holder&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_holder);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>        $error-&gt;add(3, &nbsp;</div></li><li><div>          &quot;Payment Declined&quot;, &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>            &quot;message&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;message, &nbsp;</div></li><li><div>            &quot;id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id, &nbsp;</div></li><li><div>            &quot;fraud_result&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;fraud_result, &nbsp;</div></li><li><div>            &quot;fraud_messages&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;fraud_messages&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;response_data-&gt;response-&gt;successful) {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>          &quot;transaction_id&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;id, &nbsp;</div></li><li><div>          &quot;card_token&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;card_token, &nbsp;</div></li><li><div>          &quot;fraud_result&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;fraud_result, &nbsp;</div></li><li><div>          &quot;fraud_messages&quot; =&gt; $this-&gt;response_data-&gt;response-&gt;fraud_messages&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } catch (Exception $e) {&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $error-&gt;add(4, &quot;Unknown Error&quot;, $e);&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_customer_real_ip() {&nbsp;</div></li><li><div>    $customer_ip = $_SERVER['REMOTE_ADDR'];&nbsp;</div></li><li><div>    if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {&nbsp;</div></li><li><div>      $forwarded_ips = explode(', ', $_SERVER['HTTP_X_FORWARDED_FOR']);&nbsp;</div></li><li><div>      $customer_ip = $forwarded_ips[0];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $customer_ip;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function clear_visa_checkout_session_values() {&nbsp;</div></li><li><div>    $keys = array('visa_wallet_first_name', 'visa_wallet_last_name', 'visa_wallet_address_1', 'visa_wallet_address_2', 'visa_wallet_city', 'visa_wallet_state', 'visa_wallet_postcode', 'visa_wallet_phone', 'visa_wallet_email', 'visa_wallet_callid', 'visa_wallet_token');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach($keys as $key):&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set($key, null);&nbsp;</div></li><li><div>    endforeach;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_visa_checkout_button($accepted_cards) {&nbsp;</div></li><li><div>    return &quot;&lt;style type='text/css'&gt;&nbsp;</div></li><li><div>              #custom-visa-checkout-outer-container{&nbsp;</div></li><li><div>                position:relative;&nbsp;</div></li><li><div>                width: 213px;&nbsp;</div></li><li><div>                display: inline-block;&nbsp;</div></li><li><div>                margin-top: 5px;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              #custom-visa-checkout-learn-more{&nbsp;</div></li><li><div>                width:210px;&nbsp;</div></li><li><div>                text-align:right;&nbsp;</div></li><li><div>                margin-top: -10px;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              #custom-visa-checkout-learn-more-text{&nbsp;</div></li><li><div>                font:bold 8.5pt arial;&nbsp;</div></li><li><div>                text-decoration: none;&nbsp;</div></li><li><div>                color: #0044AA;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              img#custom-visa-checkout {&nbsp;</div></li><li><div>                max-width: inherit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              .v-button {&nbsp;</div></li><li><div>                cursor: pointer;&nbsp;</div></li><li><div>                width: 213px !important;&nbsp;</div></li><li><div>                box-shadow: none !important;&nbsp;</div></li><li><div>                border: none !important;&nbsp;</div></li><li><div>                backgound: none !important;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            &lt;/style&gt;&nbsp;</div></li><li><div>            &lt;div id='custom-visa-checkout-outer-container'&gt;&nbsp;</div></li><li><div>              &lt;img alt='Button' class='v-button' data-2x-image='https:<span class="comment">//secure.checkout.visa.com/wallet-services-web/xo/button.png?locale=en_AU&amp;card_brands=VISA, MasterCard&amp;style=color&amp;size=425' height='47' id='v-checkout-button' role='button' src='https://secure.checkout.visa.com/wallet-services-web/xo/button.png?locale=en_AU&amp;card_brands=VISA, MasterCard&amp;style=color&amp;size=213' width='213'&gt;</span>&nbsp;</div></li><li><div>              &lt;div id='custom-visa-checkout-learn-more'&gt;&nbsp;</div></li><li><div>                &lt;a href='javascript:void(0)' id='custom-visa-checkout-learn-more-text' onclick=\&quot;document.getElementById('custom-visa-checkout').style.display='block'\&quot;&gt;Learn More&lt;/a&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;img alt='Cart_learnmore_pop-up_left' id='custom-visa-checkout' onclick=\&quot;document.getElementById('custom-visa-checkout').style.display='none';\&quot; src='https:<span class="comment">//sandbox-assets.secure.checkout.visa.com/VmeCardArts/partner/Cart_LearnMore_Pop-Up_left.png' style='display: none; z-index: 9999; position: absolute; top: -170px; left: 220px; box-shadow: none; width: auto;'&gt;</span>&nbsp;</div></li><li><div>            &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add the gateway to WooCommerce</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function add_fz_visacheckout_gateway( $methods ) {&nbsp;</div></li><li><div>  $methods[] = 'WC_FatZebra_VisaCheckout'; return $methods;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function inject_visacheckout_button() {&nbsp;</div></li><li><div>  $payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>  if (!isset($payment_gateways['fatzebra_visacheckout'])) {&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gw = $payment_gateways['fatzebra_visacheckout'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $amount = WC()-&gt;cart-&gt;total;&nbsp;</div></li><li><div>  $visa_base_url = $gw-&gt;parent_settings['sandbox_mode'] == &quot;yes&quot; ? 'https:<span class="comment"><span class="comment">//sandbox.secure.checkout.visa.com' : 'https://secure.checkout.visa.com';</span></span>&nbsp;</div></li><li><div>    $accepted_cards = array();&nbsp;</div></li><li><div>    foreach($gw-&gt;parent_settings['show_card_logos'] as $card) {&nbsp;</div></li><li><div>        if ($card == 'american_express') $card = &quot;AMEX&quot;;&nbsp;</div></li><li><div>        $accepted_cards[] = strtoupper($card);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    wp_register_script( 'fz-visacheckout', plugin_dir_url(__FILE__) . '/images/fatzebra-visacheckout.js', array(), WC_VERSION, false );&nbsp;</div></li><li><div>    wp_register_script( 'visa-checkout', &quot;{$visa_base_url}/checkout-widget/resources/js/integration/v1/sdk.js&quot;, array(), WC_VERSION, true );&nbsp;</div></li><li><div>    wp_localize_script( 'fz-visacheckout', 'fzvisa', array(&nbsp;</div></li><li><div>          'api_key' =&gt; $gw-&gt;settings['api_key'], &nbsp;</div></li><li><div>          'website' =&gt; get_site_url(), &nbsp;</div></li><li><div>          'website_name' =&gt; get_bloginfo('title'), &nbsp;</div></li><li><div>          'logo_url' =&gt; $gw-&gt;settings['logo_url'], &nbsp;</div></li><li><div>          'regions' =&gt; array('AU'), &nbsp;</div></li><li><div>          'card_brands' =&gt; $accepted_cards, &nbsp;</div></li><li><div>          'currency' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div>          'order_total' =&gt; $amount, &nbsp;</div></li><li><div>          'visa_checkout_button' =&gt; $gw-&gt;get_visa_checkout_button($accepted_cards), &nbsp;</div></li><li><div>          'inline' =&gt; true, &nbsp;</div></li><li><div>          'shipping' =&gt; $gw-&gt;settings['collect_shipping'] == &quot;yes&quot;, &nbsp;</div></li><li><div>          'button_text' =&gt; 'Continue', &nbsp;</div></li><li><div>          'review_message' =&gt; 'Please select your card and click Continue to finish your order', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    wp_enqueue_script( 'fz-visacheckout' );&nbsp;</div></li><li><div>    wp_enqueue_script( 'visa-checkout' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_set_callid_cookie() {&nbsp;</div></li><li><div>  if (isset($_POST['callid']) && !empty($_POST['callid'])) {&nbsp;</div></li><li><div>    wc_setcookie( 'fatzebra_visacheckout_callid', $_POST['callid'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_load_from_callid($fields) {&nbsp;</div></li><li><div>  $payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>  if (!isset($payment_gateways['fatzebra_visacheckout'])) {&nbsp;</div></li><li><div>    return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gw = $payment_gateways['fatzebra_visacheckout'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $callid = isset($_COOKIE['fatzebra_visacheckout_callid']) ? $_COOKIE['fatzebra_visacheckout_callid'] : null;&nbsp;</div></li><li><div>  if (empty($callid)) {&nbsp;</div></li><li><div>    return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $token_result = $gw-&gt;tokenize_card(array(&quot;callid&quot; =&gt; $callid));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (is_wp_error($token_result)) {&nbsp;</div></li><li><div>    <span class="comment">// Tokenization error - for now lets return the fields with no manipulation..</span>&nbsp;</div></li><li><div>    <span class="comment">// error_log</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $fields;&nbsp;</div></li><li><div>  } <span class="comment">// Arghhh!</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wallet = $token_result['wallet'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store the wallet data in a session. It is important to remove this upon successful checkout....</span>&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_first_name', $wallet-&gt;name-&gt;first);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_last_name', $wallet-&gt;name-&gt;last);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_address_1', $wallet-&gt;address-&gt;line_1);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_address_2', $wallet-&gt;address-&gt;line_2);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_city', $wallet-&gt;address-&gt;city);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_state', $wallet-&gt;address-&gt;state);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_postcode', $wallet-&gt;address-&gt;postcode);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_phone', $wallet-&gt;address-&gt;phone);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_email', $wallet-&gt;email);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_callid', $callid);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_token', $token_result['card_token']);&nbsp;</div></li><li><div>  WC()-&gt;session-&gt;set('visa_wallet_masked_number', $token_result['card_number']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wc_setcookie('fatzebra_visacheckout_callid', null, time() - 3600);&nbsp;</div></li><li><div>  return $fields;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_populate_default_field_value($_, $fieldname) {&nbsp;</div></li><li><div>  switch($fieldname) {&nbsp;</div></li><li><div>    case 'billing_email':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_email');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_first_name':&nbsp;</div></li><li><div>    case 'shipping_first_name':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_first_name');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_last_name':&nbsp;</div></li><li><div>    case 'shipping_last_name':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_last_name');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_address_1':&nbsp;</div></li><li><div>    case 'shipping_address_1':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_address_1');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_address_2':&nbsp;</div></li><li><div>    case 'shipping_address_2':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_address_2');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_city':&nbsp;</div></li><li><div>    case 'shipping_city':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_city');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_state':&nbsp;</div></li><li><div>    case 'shipping_state':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_state');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_postcode':&nbsp;</div></li><li><div>    case 'shipping_postcode':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_postcode');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'billing_phone':&nbsp;</div></li><li><div>    case 'shipping_phone':&nbsp;</div></li><li><div>      return WC()-&gt;session-&gt;get('visa_wallet_phone');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'ship_to_different_address':&nbsp;</div></li><li><div>      return false; <span class="comment">// Using wallet we prefill the shipping address. The customer can change this if they want in the form.</span>&nbsp;</div></li><li><div>    break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_ship_to_different_address($value) {&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_force_gateway($gateways) {&nbsp;</div></li><li><div>  if (is_null(WC()-&gt;session && WC()-&gt;session-&gt;get('visa_wallet_callid')))  {&nbsp;</div></li><li><div>    return $gateways;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if(!isset($gateways['fatzebra_visacheckout'])) return $gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $forced_gateways = array();&nbsp;</div></li><li><div>    $forced_gateways['fatzebra_visacheckout'] = $gateways['fatzebra_visacheckout'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $forced_gateways;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fz_visacheckout_anticlickjack() {&nbsp;</div></li><li><div>  $payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();&nbsp;</div></li><li><div>  <span class="comment">// Only show if Visa Checkout enabled</span>&nbsp;</div></li><li><div>  if (!isset($payment_gateways['fatzebra_visacheckout'])) {&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only show on Cart and Checkout</span>&nbsp;</div></li><li><div>  if(wc_get_page_id( 'checkout' ) != get_the_ID() && wc_get_page_id('cart') != get_the_ID()) {&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>    &lt;style id=&quot;antiClickjack&quot;&gt;body{display:none;}&lt;/style&gt;&nbsp;</div></li><li><div>    &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>      if (self === top) {&nbsp;</div></li><li><div>        var antiClickjack = document.getElementById(&quot;antiClickjack&quot;);&nbsp;</div></li><li><div>        antiClickjack.parentNode.removeChild(antiClickjack);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        top.location = self.location;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    &lt;/script&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_payment_gateways', 'add_fz_visacheckout_gateway' );&nbsp;</div></li><li><div>add_action('woocommerce_proceed_to_checkout', 'inject_visacheckout_button');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'woocommerce_set_cart_cookies', 'fz_visacheckout_set_callid_cookie' );&nbsp;</div></li><li><div>add_filter( 'woocommerce_checkout_fields' , 'fz_visacheckout_load_from_callid' );&nbsp;</div></li><li><div>add_filter( 'woocommerce_checkout_get_value', 'fz_visacheckout_populate_default_field_value', -10, 2);&nbsp;</div></li><li><div>add_filter( 'woocommerce_ship_to_different_address_checked', 'fz_visacheckout_ship_to_different_address');&nbsp;</div></li><li><div>add_filter( 'woocommerce_available_payment_gateways', 'fz_visacheckout_force_gateway', -10, 1);&nbsp;</div></li><li><div>add_action( 'wp_head', 'fz_visacheckout_anticlickjack', 1);&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Fat Zebra Gateway</li><li><span></span>1.5.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>