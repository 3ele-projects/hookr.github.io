<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.9.3" data-slug="buddypress-docs" data-type="class" data-id="71864"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp_docs_attachments | class | Buddypress Docs | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="BP_Docs_Attachments, class, plugin, buddypress-docs, 1.9.3" /><meta name="description" content="The BuddyPress Docs BP Docs Attachments class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=a014887e05349833f340b452dad0f1c7' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/bp_docs_attachments/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_docs_attachments%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_docs_attachments%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-docs-1.9.3-class-bp_docs_attachments","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp_docs_attachments" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress-docs." href="http://hookr.io/plugins/buddypress-docs/" class="plugin"><span property="name">buddypress-docs</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.3." href="http://hookr.io/plugins/buddypress-docs/1.9.3/" class="H_VERSION"><span property="name">1.9.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/buddypress-docs/1.9.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp_docs_attachments</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="594"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/all/" title="All">All <span class="count badge">594</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="256"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/hooks/" title="Hooks">Hooks <span class="count badge">256</span></a></li><li class="" data-id="action" data-count="73"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/actions/" title="Actions">Actions <span class="count badge">73</span></a></li><li class="" data-id="filter" data-count="183"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/filters/" title="Filters">Filters <span class="count badge">183</span></a></li><li class="active" data-id="class" data-count="27"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/classes/" title="Classes">Classes <span class="count badge">27</span></a></li><li class="" data-id="constant" data-count="21"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/constants/" title="Constants">Constants <span class="count badge">21</span></a></li><li class="" data-id="function" data-count="290"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/functions/" title="Functions">Functions <span class="count badge">290</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>BP_Docs_Attachments</strong></h1><p>The BuddyPress Docs <strong>BP Docs Attachments</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/files/includes-attachments/" class="file">/includes/attachments.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class BP_Docs_Attachments {&nbsp;</div></li><li><div>    protected $doc_id;&nbsp;</div></li><li><div>    protected $override_doc_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    protected $is_private;&nbsp;</div></li><li><div>    protected $htaccess_path;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        if ( ! bp_docs_enable_attachments() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( $this, 'catch_attachment_request' ), 20 );&nbsp;</div></li><li><div>        add_filter( 'redirect_canonical', array( $this, 'redirect_canonical' ), 10, 2 );&nbsp;</div></li><li><div>        add_filter( 'upload_dir', array( $this, 'filter_upload_dir' ) );&nbsp;</div></li><li><div>        add_action( 'bp_docs_doc_saved', array( $this, 'check_privacy' ) );&nbsp;</div></li><li><div>        add_filter( 'wp_handle_upload_prefilter', array( $this, 'maybe_create_rewrites' ) );&nbsp;</div></li><li><div>        add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_scripts' ), 20 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'pre_get_posts', array( $this, 'filter_gallery_posts' ) );&nbsp;</div></li><li><div>        add_action( 'pre_get_posts', array( $this, 'filter_directory_posts' ), 48 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add the tags filter markup&nbsp;</div></li><li><div>        add_filter( 'bp_docs_filter_types', array( $this, 'filter_type' ) );&nbsp;</div></li><li><div>        add_filter( 'bp_docs_filter_sections', array( $this, 'filter_markup' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine whether the directory view is filtered by 'has-attachment' status.&nbsp;</div></li><li><div>        add_filter( 'bp_docs_is_directory_view_filtered', array( $this, 'is_directory_view_filtered' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Icon display&nbsp;</div></li><li><div>        add_filter( 'icon_dir', 'BP_Docs_Attachments::icon_dir' );&nbsp;</div></li><li><div>        add_filter( 'icon_dir_uri', 'BP_Docs_Attachments::icon_dir_uri' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Catch delete request&nbsp;</div></li><li><div>        add_action( 'bp_actions', array( $this, 'catch_delete_request' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure that all logged-in users have the 'upload_files' cap&nbsp;</div></li><li><div>        add_filter( 'map_meta_cap', array( __CLASS__, 'map_meta_cap' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Admin notice about directory accessibility&nbsp;</div></li><li><div>        add_action( 'admin_init', array( $this, 'admin_notice_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require( dirname( __FILE__ ) . '/attachments-ajax.php' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @todo&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * - Must have script for recreating .htaccess files when:&nbsp;</div></li><li><div>     *    - top-level Docs slug changes&nbsp;</div></li><li><div>     *    - single Doc slug changes&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Catches bp-attachment requests and serves attachmens if appropriate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function catch_attachment_request() {&nbsp;</div></li><li><div>        if ( ! empty( $_GET['bp-attachment'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fn = basename( $_GET['bp-attachment'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sanity check - don't do anything if this is not a Doc&nbsp;</div></li><li><div>            if ( ! bp_docs_is_existing_doc() ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;filename_is_safe( $fn ) ) {&nbsp;</div></li><li><div>                wp_die( __( 'File not found.', 'bp-docs' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $uploads = wp_upload_dir();&nbsp;</div></li><li><div>            $filepath = $uploads['path'] . DIRECTORY_SEPARATOR . $fn;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! file_exists( $filepath ) ) {&nbsp;</div></li><li><div>                wp_die( __( 'File not found.', 'bp-docs' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $headers = $this-&gt;generate_headers( $filepath );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // @todo Support xsendfile?&nbsp;</div></li><li><div>            // @todo Better to send header('Location') instead?&nbsp;</div></li><li><div>            //       Generate symlinks like Drupal. Needs FollowSymLinks&nbsp;</div></li><li><div>            foreach( $headers as $name =&gt; $field_value ) {&nbsp;</div></li><li><div>                @header(&quot;{$name}: {$field_value}&quot;);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_end_clean();&nbsp;</div></li><li><div>            readfile( $filepath );&nbsp;</div></li><li><div>            exit();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If redirecting from a 'p' URL to a rewritten URL, retain 'bp-attachment' param&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.6.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $redirect_url URL as calculated by redirect_canonical&nbsp;</div></li><li><div>     * @param string $requested_url Originally requested URL.&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function redirect_canonical( $redirect_url, $requested_url ) {&nbsp;</div></li><li><div>        if ( isset( $_GET['p'] ) && isset( $_GET['bp-attachment'] ) && false !== strpos( $requested_url, 'bp-attachments' ) ) {&nbsp;</div></li><li><div>            $redirect_url = add_query_arg( 'bp-attachment', $_GET['bp-attachment'], $redirect_url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $redirect_url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Attempts to customize upload_dir with our attachment paths&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo There's a quirk in wp_upload_dir() that will create the&nbsp;</div></li><li><div>     *   attachment directory if it doesn't already exist. This normally&nbsp;</div></li><li><div>     *   isn't a problem, because wp_upload_dir() is generally only called&nbsp;</div></li><li><div>     *   when a credentialed user is logged in and viewing the admin side.&nbsp;</div></li><li><div>     *   But the current code will force a folder to be created the first&nbsp;</div></li><li><div>     *   time the doc is viewed at all. Not sure whether this merits fixing&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function filter_upload_dir( $uploads ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_doc_id() ) {&nbsp;</div></li><li><div>            return $uploads;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $uploads = $this-&gt;mod_upload_dir( $uploads );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $uploads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * After a Doc is saved, check to see whether any action is necessary&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_privacy( $query ) {&nbsp;</div></li><li><div>        if ( empty( $query-&gt;doc_id ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;set_doc_id( $query-&gt;doc_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;get_is_private() ) {&nbsp;</div></li><li><div>            $this-&gt;create_htaccess();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;delete_htaccess();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete an htaccess file for the current Doc&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_htaccess() {&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_doc_id() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $path = $this-&gt;get_htaccess_path();&nbsp;</div></li><li><div>        if ( file_exists( $path ) ) {&nbsp;</div></li><li><div>            unlink( $path );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create rewrite rules for upload directory, if appropriate.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * As a hack, we've hooked to wp_handle_upload_prefilter. We don't&nbsp;</div></li><li><div>     * actually do anything with the passed value; we just need a place&nbsp;</div></li><li><div>     * to hook in reliably before the file is written.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.6.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $file&nbsp;</div></li><li><div>     * @return $file&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function maybe_create_rewrites( $file ) {&nbsp;</div></li><li><div>        global $is_apache;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_doc_id() ) {&nbsp;</div></li><li><div>            return $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_is_private() ) {&nbsp;</div></li><li><div>            return $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_apache ) {&nbsp;</div></li><li><div>            $this-&gt;create_htaccess();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $file;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates an .htaccess file in the appropriate upload dir, if appropriate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @param $file&nbsp;</div></li><li><div>     * @return $file&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function maybe_create_htaccess( $file ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_doc_id() ) {&nbsp;</div></li><li><div>            return $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_is_private() ) {&nbsp;</div></li><li><div>            return $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;create_htaccess();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $file;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates an .htaccess for a Doc upload directory&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * No check happens here to see whether an .htaccess is necessary. Make&nbsp;</div></li><li><div>     * sure you check $this-&gt;get_is_private() before running.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_htaccess() {&nbsp;</div></li><li><div>        $htaccess_path = $this-&gt;get_htaccess_path();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $rules = $this-&gt;generate_rewrite_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $rules ) ) {&nbsp;</div></li><li><div>            if ( ! function_exists( 'insert_with_markers' ) ) {&nbsp;</div></li><li><div>                require_once( ABSPATH . 'wp-admin/includes/misc.php' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            insert_with_markers( $htaccess_path, 'BuddyPress Docs', $rules );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates a path to htaccess for the Doc in question&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_htaccess_path() {&nbsp;</div></li><li><div>        $upload_dir = wp_upload_dir( null, true, true );&nbsp;</div></li><li><div>        $this-&gt;htaccess_path = $upload_dir['path'] . DIRECTORY_SEPARATOR . '.htaccess';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;htaccess_path;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check whether the current Doc is private ('read' != 'anyone')&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_is_private() {&nbsp;</div></li><li><div>//        if ( is_null( $this-&gt;is_private ) ) {&nbsp;</div></li><li><div>            $doc_id = $this-&gt;get_doc_id();&nbsp;</div></li><li><div>            $doc_settings = bp_docs_get_doc_settings( $doc_id );&nbsp;</div></li><li><div>            $this-&gt;is_private = isset( $doc_settings['read'] ) && 'anyone' !== $doc_settings['read'];&nbsp;</div></li><li><div>//        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;is_private;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set a doc id for this object&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is a hack that lets you manually bypass the doc sniffing in&nbsp;</div></li><li><div>     * get_doc_id()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_doc_id( $doc_id ) {&nbsp;</div></li><li><div>        $this-&gt;override_doc_id = intval( $doc_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Attempt to auto-detect a doc ID&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_doc_id() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;override_doc_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;doc_id = $this-&gt;override_doc_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! defined( 'DOING_AJAX' ) || ! DOING_AJAX ) {&nbsp;</div></li><li><div>                if ( bp_docs_is_existing_doc() ) {&nbsp;</div></li><li><div>                    $this-&gt;doc_id = get_queried_object_id();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // AJAX&nbsp;</div></li><li><div>                if ( isset( $_REQUEST['query']['auto_draft_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;doc_id = (int) $_REQUEST['query']['auto_draft_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                } else if ( isset( $_REQUEST['action'] ) && 'upload-attachment' == $_REQUEST['action'] && isset( $_REQUEST['post_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $maybe_doc = get_post( $_REQUEST['post_id'] );&nbsp;</div></li><li><div>                    if ( bp_docs_get_post_type_name() == $maybe_doc-&gt;post_type ) {&nbsp;</div></li><li><div>                        $this-&gt;doc_id = $maybe_doc-&gt;ID;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // In order to check if this is a doc, must check ajax referer&nbsp;</div></li><li><div>                    $this-&gt;doc_id = $this-&gt;get_doc_id_from_url( wp_get_referer() );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;doc_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function catch_delete_request() {&nbsp;</div></li><li><div>        if ( ! bp_docs_is_existing_doc() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_GET['delete_attachment'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'bp_docs_edit' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachment_id = intval( $_GET['delete_attachment'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_admin_referer( 'bp_docs_delete_attachment_' . $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( wp_delete_attachment( $attachment_id ) ) {&nbsp;</div></li><li><div>            bp_core_add_message( __( 'Attachment deleted', 'bp-docs' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            bp_core_add_message( __( 'Could not delete attachment', 'bp-docs' ), 'error' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_redirect( wp_get_referer() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a Doc's ID from its URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note that this only works for existing Docs, because (duh) new Docs&nbsp;</div></li><li><div>     * don't yet have a URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @param string $url&nbsp;</div></li><li><div>     * @return int $doc_id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_doc_id_from_url( $url ) {&nbsp;</div></li><li><div>        $doc_id = null;&nbsp;</div></li><li><div>        $url = untrailingslashit( $url );&nbsp;</div></li><li><div>        $edit_location = strrpos( $url, BP_DOCS_EDIT_SLUG );&nbsp;</div></li><li><div>        if ( false !== $edit_location && BP_DOCS_EDIT_SLUG == substr( $url, $edit_location ) ) {&nbsp;</div></li><li><div>            $doc_id = url_to_postid( substr( $url, 0, $edit_location - 1 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $doc_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Filter upload_dir to customize Doc upload locations&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @return array $uploads&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function mod_upload_dir( $uploads ) {&nbsp;</div></li><li><div>        $subdir = '/bp-attachments/' . $this-&gt;doc_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $uploads['subdir'] = $subdir;&nbsp;</div></li><li><div>        $uploads['path'] = $uploads['basedir'] . $subdir;&nbsp;</div></li><li><div>        $uploads['url'] = $uploads['baseurl'] . '/bp-attachments/' . $this-&gt;doc_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $uploads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function enqueue_scripts() {&nbsp;</div></li><li><div>        if ( bp_docs_is_doc_edit() || bp_docs_is_doc_create() ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'bp-docs-attachments', plugins_url( BP_DOCS_PLUGIN_SLUG . '/includes/js/attachments.js' ), array( 'media-editor', 'media-views', 'bp-docs-js' ), false, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_localize_script( 'bp-docs-attachments', 'bp_docs_attachments', array(&nbsp;</div></li><li><div>                'upload_title' =&gt; __( 'Upload File', 'bp-docs' ), &nbsp;</div></li><li><div>                'upload_button' =&gt; __( 'OK', 'bp-docs' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Filter the posts query on attachment pages, to ensure that only the&nbsp;</div></li><li><div>     * specific Doc's attachments show up in the Gallery&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Hooked to 'pre_get_posts'. Bail out if we're not in a Gallery&nbsp;</div></li><li><div>     * request for a Doc&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function filter_gallery_posts( $query ) {&nbsp;</div></li><li><div>        // This is also a surrogate check for DOING_AJAX&nbsp;</div></li><li><div>        if ( ! isset( $_POST['action'] ) || 'query-attachments' !== $_POST['action'] ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_id = isset( $_POST['post_id'] ) ? intval( $_POST['post_id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $post_id ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $post ) || is_wp_error( $post ) || bp_docs_get_post_type_name() !== $post-&gt;post_type ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Phew&nbsp;</div></li><li><div>        $query-&gt;set( 'post_parent', $_REQUEST['post_id'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function filter_directory_posts( $query ) {&nbsp;</div></li><li><div>        if ( bp_docs_get_post_type_name() !== $query-&gt;get( 'post_type' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        remove_action( 'pre_get_posts', array( $this, 'filter_directory_posts' ), 48 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_attachment = isset( $_REQUEST['has-attachment'] ) && in_array( $_REQUEST['has-attachment'], array( 'yes', 'no' ) ) ? $_REQUEST['has-attachment'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $has_attachment ) {&nbsp;</div></li><li><div>            $post__in = $query-&gt;get( 'post__in' );&nbsp;</div></li><li><div>            $att_posts = $this-&gt;get_docs_with_attachments();&nbsp;</div></li><li><div>            $att_posts = empty( $att_posts ) ? array( 0 ) : $att_posts;&nbsp;</div></li><li><div>            $query_arg = 'yes' === $has_attachment ? 'post__in' : 'post__not_in';&nbsp;</div></li><li><div>            $query-&gt;set( $query_arg, array_merge( (array) $post__in, (array) $att_posts ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'pre_get_posts', array( $this, 'filter_directory_posts' ), 48 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_docs_with_attachments() {&nbsp;</div></li><li><div>        $atts = get_posts( array(&nbsp;</div></li><li><div>            'update_meta_cache' =&gt; false, &nbsp;</div></li><li><div>            'update_term_cache' =&gt; false, &nbsp;</div></li><li><div>            'post_type' =&gt; 'attachment', &nbsp;</div></li><li><div>            'post_parent__in' =&gt; bp_docs_get_doc_ids_accessible_to_current_user(), &nbsp;</div></li><li><div>            'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_unique( wp_list_pluck( $atts, 'post_parent' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates the rewrite rules to be put in .htaccess of the upload dir&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @return array $rules One per line, to be put together by insert_with_markers()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_rewrite_rules() {&nbsp;</div></li><li><div>        $rules = array();&nbsp;</div></li><li><div>        $doc_id = $this-&gt;get_doc_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $doc_id ) {&nbsp;</div></li><li><div>            return $rules;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $url = bp_docs_get_doc_link( $doc_id );&nbsp;</div></li><li><div>        $url_parts = parse_url( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $url_parts['path'] ) ) {&nbsp;</div></li><li><div>            $rules = array(&nbsp;</div></li><li><div>                'RewriteEngine On', &nbsp;</div></li><li><div>                'RewriteBase ' . $url_parts['path'], &nbsp;</div></li><li><div>                'RewriteRule (.+) ?bp-attachment=$1 [R=302, NC]', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'bp_docs_attachments_generate_rewrite_rules', $rules, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check to see whether a filename is safe&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is used to sanitize file paths passed via $_GET params&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @param string $filename Filename to validate&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function filename_is_safe( $filename ) {&nbsp;</div></li><li><div>        // WP's core function handles most sanitization&nbsp;</div></li><li><div>        if ( $filename !== sanitize_file_name( $filename ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No leading dots&nbsp;</div></li><li><div>        if ( 0 === strpos( $filename, '.' ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No directory walking means no slashes&nbsp;</div></li><li><div>        $filename_parts = pathinfo( $filename );&nbsp;</div></li><li><div>        if ( $filename_parts['basename'] !== $filename ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check filetype&nbsp;</div></li><li><div>        $ft = wp_check_filetype( $filename );&nbsp;</div></li><li><div>        if ( empty( $ft['ext'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate download headers&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     * @param string $filename Full path to file&nbsp;</div></li><li><div>     * @return array Headers in key=&gt;value format&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function generate_headers( $filename ) {&nbsp;</div></li><li><div>        // Disable compression&nbsp;</div></li><li><div>        if ( function_exists( 'apache_setenv' ) ) {&nbsp;</div></li><li><div>            @apache_setenv( 'no-gzip', 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        @ini_set( 'zlib.output_compression', 'Off' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // @todo Make this more configurable&nbsp;</div></li><li><div>        $headers = wp_get_nocache_headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Content-Disposition&nbsp;</div></li><li><div>        $filename_parts = pathinfo( $filename );&nbsp;</div></li><li><div>        $headers['Content-Disposition'] = 'attachment; filename=&quot;' . $filename_parts['basename'] . '&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Content-Type&nbsp;</div></li><li><div>        $filetype = wp_check_filetype( $filename );&nbsp;</div></li><li><div>        $headers['Content-Type'] = $filetype['type'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Content-Length&nbsp;</div></li><li><div>        $filesize = filesize( $filename );&nbsp;</div></li><li><div>        $headers['Content-Length'] = $filesize;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $headers;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function icon_dir( $dir ) {&nbsp;</div></li><li><div>        if ( bp_docs_is_docs_component() ) {&nbsp;</div></li><li><div>            $dir = BP_DOCS_INSTALL_PATH . 'lib/nuvola';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $dir;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function icon_dir_uri( $url ) {&nbsp;</div></li><li><div>        if ( bp_docs_is_docs_component() ) {&nbsp;</div></li><li><div>            $url = plugins_url( BP_DOCS_PLUGIN_SLUG . '/lib/nuvola' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function filter_type( $types ) {&nbsp;</div></li><li><div>        $types[] = array(&nbsp;</div></li><li><div>            'slug' =&gt; 'attachments', &nbsp;</div></li><li><div>            'title' =&gt; __( 'Attachments', 'bp-docs' ), &nbsp;</div></li><li><div>            'query_arg' =&gt; 'has-attachment', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return $types;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function filter_markup() {&nbsp;</div></li><li><div>        $has_attachment = isset( $_REQUEST['has-attachment'] ) && in_array( $_REQUEST['has-attachment'], array( 'yes', 'no' ) ) ? $_REQUEST['has-attachment'] : '';&nbsp;</div></li><li><div>        $form_action = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>        foreach ( $_GET as $k =&gt; $v ) {&nbsp;</div></li><li><div>            $form_action = remove_query_arg( $k, $form_action );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div id=&quot;docs-filter-section-attachments&quot; class=&quot;docs-filter-section&lt;?php if ( $has_attachment ) : ?&gt; docs-filter-section-open&lt;?php endif ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;&lt;?php echo $form_action ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                &lt;label for=&quot;has-attachment&quot;&gt;&lt;?php _e( 'Has attachment?', 'bp-docs' ) ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                &lt;select id=&quot;has-attachment&quot; name=&quot;has-attachment&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;yes&quot;&lt;?php selected( $has_attachment, 'yes' ) ?&gt;&gt;&lt;?php _e( 'Yes', 'bp-docs' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;no&quot;&lt;?php selected( $has_attachment, 'no' ) ?&gt;&gt;&lt;?php _e( 'No', 'bp-docs' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;&quot;&lt;?php selected( $has_attachment, '' ) ?&gt;&gt;&lt;?php _e( 'Doesn&#8217;t matter', 'bp-docs' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/select&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;submit&quot; value=&quot;&lt;?php _e( 'Filter', 'bp-docs' ) ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;?php do_action( 'bp_docs_directory_filter_attachments_form' ) ?&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determine whether the directory view is filtered by 'has-attachment' status.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.9.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool  $is_filtered Is the current directory view filtered?&nbsp;</div></li><li><div>     * @param array $exclude Array of filter types to ignore.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool $is_filtered&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_directory_view_filtered( $is_filtered, $exclude ) {&nbsp;</div></li><li><div>        // If this filter is excluded, stop now.&nbsp;</div></li><li><div>        if ( in_array( 'has-attachment', $exclude ) ) {&nbsp;</div></li><li><div>            return $is_filtered;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['has-attachment'] ) && ( 'yes' == $_GET['has-attachment'] || 'no' == $_GET['has-attachment'] ) ) {&nbsp;</div></li><li><div>            $is_filtered = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $is_filtered;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Give users the 'edit_post' and 'upload_files' cap, when appropriate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $caps The mapped caps&nbsp;</div></li><li><div>     * @param string $cap The cap being mapped&nbsp;</div></li><li><div>     * @param int $user_id The user id in question&nbsp;</div></li><li><div>     * @param $args&nbsp;</div></li><li><div>     * @return array $caps&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function map_meta_cap( $caps, $cap, $user_id, $args ) {&nbsp;</div></li><li><div>        if ( 'upload_files' !== $cap && 'edit_post' !== $cap ) {&nbsp;</div></li><li><div>            return $caps;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $maybe_user = new WP_User( $user_id );&nbsp;</div></li><li><div>        if ( ! is_a( $maybe_user, 'WP_User' ) || empty( $maybe_user-&gt;ID ) ) {&nbsp;</div></li><li><div>            return $caps;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_doc = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // DOING_AJAX is not set yet, so we cheat&nbsp;</div></li><li><div>        $is_ajax = isset( $_SERVER['REQUEST_METHOD'] ) && 'POST' === $_SERVER['REQUEST_METHOD'] && 'async-upload.php' === substr( $_SERVER['REQUEST_URI'], strrpos( $_SERVER['REQUEST_URI'], '/' ) + 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_ajax ) {&nbsp;</div></li><li><div>            // WordPress sends the 'media-form' nonce, which we use&nbsp;</div></li><li><div>            // as an initial screen&nbsp;</div></li><li><div>            $nonce = isset( $_REQUEST['_wpnonce'] ) ? stripslashes( $_REQUEST['_wpnonce'] ) : '';&nbsp;</div></li><li><div>            $post_id = isset( $_REQUEST['post_id'] ) ? intval( $_REQUEST['post_id'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( wp_verify_nonce( $nonce, 'media-form' ) && $post_id ) {&nbsp;</div></li><li><div>                $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // The dummy Doc created during the Create&nbsp;</div></li><li><div>                // process should pass this test, in addition to&nbsp;</div></li><li><div>                // existing Docs&nbsp;</div></li><li><div>                $is_doc = isset( $post-&gt;post_type ) && bp_docs_get_post_type_name() === $post-&gt;post_type;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_doc = bp_docs_is_existing_doc() || bp_docs_is_doc_create();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_doc ) {&nbsp;</div></li><li><div>            $caps = array( 'exist' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Since we've already done the permissions check, &nbsp;</div></li><li><div>            // we can filter future current_user_can() checks on&nbsp;</div></li><li><div>            // this pageload&nbsp;</div></li><li><div>            add_filter( 'map_meta_cap', array( __CLASS__, 'map_meta_cap_supp' ), 10, 4 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $caps;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Make sure the current user has the 'edit_post' and 'upload_files' caps, when appropriate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * We do the necessary permissions checks in self::map_meta_cap(). If&nbsp;</div></li><li><div>     * the checks pass, then we can blindly hook this filter without doing&nbsp;</div></li><li><div>     * the permissions logic again. *Do not call this filter directly.* I'd&nbsp;</div></li><li><div>     * mark it private but it's not possible given the way that WP's filter&nbsp;</div></li><li><div>     * system works.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function map_meta_cap_supp( $caps, $cap, $user_id, $args ) {&nbsp;</div></li><li><div>        if ( 'upload_files' !== $cap && 'edit_post' !== $cap ) {&nbsp;</div></li><li><div>            return $caps;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'exist' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function admin_notice_init() {&nbsp;</div></li><li><div>        if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'delete_users' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the notice is being disabled, mark it as such and bail&nbsp;</div></li><li><div>        if ( isset( $_GET['bpdocs-disable-attachment-notice'] ) ) {&nbsp;</div></li><li><div>            check_admin_referer( 'bpdocs-disable-attachment-notice' );&nbsp;</div></li><li><div>            bp_update_option( 'bp_docs_disable_attachment_notice', 1 );&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the notice has already been disabled, bail&nbsp;</div></li><li><div>        if ( 1 == bp_get_option( 'bp_docs_disable_attachment_notice' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Nothing to see here&nbsp;</div></li><li><div>        if ( $this-&gt;check_is_protected() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_notices', array( $this, 'admin_notice' ) );&nbsp;</div></li><li><div>        add_action( 'network_admin_notices', array( $this, 'admin_notice' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function admin_notice() {&nbsp;</div></li><li><div>        global $is_apache, $is_nginx, $is_IIS, $is_iis7;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dismiss_url = add_query_arg( 'bpdocs-disable-attachment-notice', '1', $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>        $dismiss_url = wp_nonce_url( $dismiss_url, 'bpdocs-disable-attachment-notice' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! bp_is_root_blog() ) {&nbsp;</div></li><li><div>            switch_to_blog( bp_get_root_blog_id() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $upload_dir = $this-&gt;mod_upload_dir( wp_upload_dir() );&nbsp;</div></li><li><div>        $att_url = str_replace( get_option( 'home' ), '', $upload_dir['url'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_nginx ) {&nbsp;</div></li><li><div>            $help_url = 'https://github.com/boonebgorges/buddypress-docs/wiki/Attachment-Privacy#nginx';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $help_p = __( 'It looks like you are running &lt;strong&gt;nginx&lt;/strong&gt;. We recommend the following setting in your site configuration file:', 'bp-docs' );&nbsp;</div></li><li><div>            $help_p .= '&lt;pre&gt;&lt;code&gt;location ' . $att_url . ' {&nbsp;</div></li><li><div>    rewrite ^.*' . str_replace( '/wp-content/', '', $att_url ) . '([0-9]+)/(.*) /?p=$1&bp-attachment=$2 permanent;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&lt;/code&gt;&lt;/pre&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_iis7 ) {&nbsp;</div></li><li><div>            $help_url = 'https://github.com/boonebgorges/buddypress-docs/wiki/Attachment-Privacy#iis7';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $help_p = __( 'It looks like you are running &lt;strong&gt;IIS 7&lt;/strong&gt;. We recommend the following setting in your Web.config file:', 'bp-docs' );&nbsp;</div></li><li><div>            $help_p .= '&lt;pre&gt;&lt;code&gt;&lt;rule name=&quot;buddypress-docs-attachments&quot;&gt;&nbsp;</div></li><li><div>    &lt;match url=&quot;^' . $att_url . '([0-9]+)/(.*)$&quot;/&gt;&nbsp;</div></li><li><div>        &lt;conditions&gt;&nbsp;</div></li><li><div>        &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsFile&quot; negate=&quot;false&quot;/&gt;&nbsp;</div></li><li><div>    &lt;/conditions&gt;&nbsp;</div></li><li><div>    &lt;action type=&quot;Redirect&quot; url=&quot;?p={R:1}&amp;bp-attachment={R:2}&quot;/&gt;&nbsp;</div></li><li><div>&lt;/rule&gt; &lt;/code&gt;&lt;/pre&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_apache ) {&nbsp;</div></li><li><div>            $help_url = 'https://github.com/boonebgorges/buddypress-docs/wiki/Attachment-Privacy#apache';&nbsp;</div></li><li><div>            $help_p = __( 'It looks like you are running &lt;strong&gt;Apache&lt;/strong&gt;. The most likely cause of your problem is that the &lt;code&gt;AllowOverride&lt;/code&gt; directive has been disabled, either globally (&lt;code&gt;httpd.conf&lt;/code&gt;) or in a &lt;code&gt;VirtualHost&lt;/code&gt; definition. Contact your host for assistance.', 'bp-docs' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div class=&quot;message error&quot;&gt;&nbsp;</div></li><li><div>            &lt;p&gt;&lt;?php _e( '&lt;strong&gt;Your BuddyPress Docs attachments directory is publicly accessible.&lt;/strong&gt; Doc attachments will not be properly protected from direct viewing, even if the parent Docs are non-public.', 'bp-docs' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php if ( $help_p ) : ?&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php echo $help_p ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php endif ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php if ( $help_url ) : ?&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php printf( __( 'See &lt;a href=&quot;%s&quot;&gt;this wiki page&lt;/a&gt; for more information.', 'bp-docs' ), $help_url ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php endif ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;p&gt;&lt;a href=&quot;&lt;?php echo $dismiss_url ?&gt;&quot;&gt;&lt;?php _e( 'Dismiss this message', 'bp-docs' ) ?&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Test whether the attachment upload directory is protected.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * We create a dummy file in the directory, and then test to see&nbsp;</div></li><li><div>     * whether we can fetch a copy of the file with a remote request.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.6.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return True if protected, false if not.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_is_protected( $force_check = true ) {&nbsp;</div></li><li><div>        global $is_apache;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Fall back on cached value if it exists&nbsp;</div></li><li><div>        if ( ! $force_check ) {&nbsp;</div></li><li><div>            $is_protected = bp_get_option( 'bp_docs_attachment_protection' );&nbsp;</div></li><li><div>            if ( '' !== $is_protected ) {&nbsp;</div></li><li><div>                return (bool) $is_protected;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $uploads = wp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $test_dir = $uploads['basedir'] . DIRECTORY_SEPARATOR . 'bp-attachments' . DIRECTORY_SEPARATOR . '0';&nbsp;</div></li><li><div>        $test_file_dir = $test_dir . DIRECTORY_SEPARATOR . 'test.html';&nbsp;</div></li><li><div>        $test_text = 'This is a test of the Protected Attachment feature of BuddyPress Docs. Please do not remove.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! file_exists( $test_file_dir ) ) {&nbsp;</div></li><li><div>            if ( ! file_exists( $test_dir ) ) {&nbsp;</div></li><li><div>                wp_mkdir_p( $test_dir );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create an .htaccess, if we can&nbsp;</div></li><li><div>            if ( $is_apache ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Fake the doc ID&nbsp;</div></li><li><div>                $this-&gt;doc_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $rules = array(&nbsp;</div></li><li><div>                    'RewriteEngine On', &nbsp;</div></li><li><div>                    'RewriteBase /', &nbsp;</div></li><li><div>                    'RewriteRule (.+) ?bp-attachment=$1 [R=302, NC]', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $rules ) ) {&nbsp;</div></li><li><div>                    if ( ! file_exists( 'insert_with_markers' ) ) {&nbsp;</div></li><li><div>                        require_once( ABSPATH . 'wp-admin/includes/misc.php' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    insert_with_markers( $test_dir . DIRECTORY_SEPARATOR . '.htaccess', 'BuddyPress Docs', $rules );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Make a dummy file&nbsp;</div></li><li><div>            file_put_contents( $test_dir . DIRECTORY_SEPARATOR . 'test.html', $test_text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $test_url = $uploads['baseurl'] . '/bp-attachments/0/test.html';&nbsp;</div></li><li><div>        $r = wp_remote_get( $test_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the response body includes our test text, we have a problem&nbsp;</div></li><li><div>        $is_protected = true;&nbsp;</div></li><li><div>        if ( ! is_wp_error( $r ) && $r['body'] === $test_text ) {&nbsp;</div></li><li><div>            $is_protected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cache&nbsp;</div></li><li><div>        $cache = $is_protected ? '1' : '0';&nbsp;</div></li><li><div>        bp_update_option( 'bp_docs_attachment_protection', $cache );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_protected;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.8.8</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/buddypress-docs/1.9.3/classes/bp_docs_attachments/" class="active">1.9.3</a></li><li><a href="http://hookr.io/plugins/buddypress-docs/1.9.2/classes/bp_docs_attachments/" class="">1.9.2</a></li><li><a href="http://hookr.io/plugins/buddypress-docs/1.9.1/classes/bp_docs_attachments/" class="">1.9.1</a></li><li><a href="http://hookr.io/plugins/buddypress-docs/1.9.0/classes/bp_docs_attachments/" class="">1.9.0</a></li><li><a href="http://hookr.io/plugins/buddypress-docs/1.8.8/classes/bp_docs_attachments/" class="">1.8.8</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>BP_Docs_Attachments</li><li><span></span>BuddyPress Docs</li><li><span></span>1.9.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>