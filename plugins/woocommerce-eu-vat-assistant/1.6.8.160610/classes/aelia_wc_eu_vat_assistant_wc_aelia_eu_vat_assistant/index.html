<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.7.8.170421" data-slug="woocommerce-eu-vat-assistant" data-type="class" data-id="76249"><head xmlns="http://www.w3.org/1999/xhtml"><title> aeliawceu_vat_assistantwc_aelia_eu_vat_assistant | class | Woocommerce Eu Vat Assistant | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Aelia\WC\EU_VAT_Assistant\WC_Aelia_EU_VAT_Assistant, class, plugin, woocommerce-eu-vat-assistant, 1.7.8.170421" /><meta name="description" content="EU VAT Assistant plugin." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.15"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=7faf34d1d9c41b3c2b03761e5c45cc7a' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.15' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Faelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Faelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-eu-vat-assistant-1.7.8.170421-class-aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-eu-vat-assistant." href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/" class="plugin"><span property="name">woocommerce-eu-vat-assistant</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.7.8.170421." href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/" class="H_VERSION"><span property="name">1.7.8.170421</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">aelia_wc_eu_vat_assistant_wc_&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="95"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/all/" title="All">All <span class="count badge">95</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="23"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/hooks/" title="Hooks">Hooks <span class="count badge">23</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="23"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/filters/" title="Filters">Filters <span class="count badge">23</span></a></li><li class="active" data-id="class" data-count="59"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/classes/" title="Classes">Classes <span class="count badge">59</span></a></li><li class="" data-id="constant" data-count="1"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/constants/" title="Constants">Constants <span class="count badge">1</span></a></li><li class="" data-id="function" data-count="12"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/functions/" title="Functions">Functions <span class="count badge">12</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>AeliaWCEU_VAT_AssistantWC_Aelia_EU_VAT_Assistant</strong></h1><p>EU VAT Assistant plugin.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/files/src-plugin-main/" class="file">/src/plugin-main.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="21" class="block" start="21"><li><div>class WC_Aelia_EU_VAT_Assistant extends Aelia_Plugin {&nbsp;</div></li><li><div>    public static $version = '1.7.8.170421';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static $plugin_slug = Definitions::PLUGIN_SLUG;&nbsp;</div></li><li><div>    public static $text_domain = Definitions::TEXT_DOMAIN;&nbsp;</div></li><li><div>    public static $plugin_name = 'WooCommerce EU VAT Assistant';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * A list of countries to which sales are allowed. The list is altered by the&nbsp;</div></li><li><div>     * plugin if the admin populated the list of countries to which the sale is&nbsp;</div></li><li><div>     * not allowed.&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $allowed_sale_countries;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // @var string The country to which a VAT number applies (if any).&nbsp;</div></li><li><div>    protected $vat_country;&nbsp;</div></li><li><div>    // @var string The VAT number entered by the customer at checkout.&nbsp;</div></li><li><div>    protected $vat_number;&nbsp;</div></li><li><div>    // @var bool Indicates if the VAT number was validated.&nbsp;</div></li><li><div>    protected $vat_number_validated;&nbsp;</div></li><li><div>    // @var EU_VAT_Validation The instance of the EU VAT Number validator.&nbsp;</div></li><li><div>    protected $_eu_vat_validation;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Shop's base country. Used to determine if a VAT exemption can be applied&nbsp;</div></li><li><div>     * (usually, exemption cannot be applied to customers located in shop's base&nbsp;</div></li><li><div>     * country).&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     * @since 1.4.12.150923&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $shop_base_country;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Initialises and returns the plugin instance.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return Aelia\WC\EU_VAT_Assistant\WC_Aelia_EU_VAT_Assistant&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function factory() {&nbsp;</div></li><li><div>        // Load Composer autoloader&nbsp;</div></li><li><div>        require_once(__DIR__ . '/vendor/autoload.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Example on how to initialise a settings controller and a messages controller&nbsp;</div></li><li><div>        $settings_page_renderer = new Settings_Renderer();&nbsp;</div></li><li><div>        $settings_controller = new Settings(Settings::SETTINGS_KEY, &nbsp;</div></li><li><div>                                                                                self::$text_domain, &nbsp;</div></li><li><div>                                                                                $settings_page_renderer);&nbsp;</div></li><li><div>        $messages_controller = new Messages(self::$text_domain);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugin_instance = new self($settings_controller, $messages_controller);&nbsp;</div></li><li><div>        return $plugin_instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Constructor.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param \Aelia\WC\Settings settings_controller The controller that will handle&nbsp;</div></li><li><div>     * the plugin settings.&nbsp;</div></li><li><div>     * @param \Aelia\WC\Messages messages_controller The controller that will handle&nbsp;</div></li><li><div>     * the messages produced by the plugin.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct($settings_controller = null, &nbsp;</div></li><li><div>                                                            $messages_controller = null) {&nbsp;</div></li><li><div>        // Load Composer autoloader&nbsp;</div></li><li><div>        require_once(__DIR__ . '/vendor/autoload.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        parent::__construct($settings_controller, $messages_controller);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Instantiate the logger specific to this plugin&nbsp;</div></li><li><div>        $this-&gt;logger = new Logger(Definitions::PLUGIN_SLUG);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The commented line below is needed for Codestyling Localization plugin to&nbsp;</div></li><li><div>        // understand what text domain is used by this plugin&nbsp;</div></li><li><div>        //load_plugin_textdomain('wc-aelia-eu-vat-assistant', false, $this-&gt;path('languages') . '/');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Indicates if debug mode is active.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function debug_mode() {&nbsp;</div></li><li><div>        return self::settings()-&gt;get(Settings::FIELD_DEBUG_MODE);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an instance of the EU VAT numbers validator.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return EU_VAT_Validation&nbsp;</div></li><li><div>     * @since 1.3.20.150330&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function eu_vat_validation() {&nbsp;</div></li><li><div>        if(empty($this-&gt;_eu_vat_validation)) {&nbsp;</div></li><li><div>        // Instantiate the the EU VAT numbers validator&nbsp;</div></li><li><div>            $this-&gt;_eu_vat_validation = EU_VAT_Validation::factory();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $this-&gt;_eu_vat_validation;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the country corresponding to visitor's IP address.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_ip_address_country() {&nbsp;</div></li><li><div>        if(empty($this-&gt;ip_address_country)) {&nbsp;</div></li><li><div>            $this-&gt;ip_address_country = apply_filters('wc_aelia_eu_vat_assistant_ip_address_country', IP2Location::factory()-&gt;get_visitor_country());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $this-&gt;ip_address_country;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array with all the tax types in use in the European Union, together&nbsp;</div></li><li><div>     * with their descriptions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_eu_vat_rate_types() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'standard_rate' =&gt; __('Standard rates', self::$text_domain), &nbsp;</div></li><li><div>            'reduced_rate' =&gt; __('Reduced rates', self::$text_domain), &nbsp;</div></li><li><div>            'reduced_rate_alt' =&gt; __('Reduced rates (alternative)', self::$text_domain), &nbsp;</div></li><li><div>            'super_reduced_rate' =&gt; __('Super reduced rates', self::$text_domain), &nbsp;</div></li><li><div>            'parking_rate' =&gt; __('Parking rates', self::$text_domain), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of countries to which EU VAT applies. This method takes into&nbsp;</div></li><li><div>     * account countries such as Monaco and Isle of Man, which are not returned as&nbsp;</div></li><li><div>     * part of EU countries by WooCommerce.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_eu_vat_countries() {&nbsp;</div></li><li><div>        if(empty($this-&gt;eu_vat_countries)) {&nbsp;</div></li><li><div>            $this-&gt;eu_vat_countries = $this-&gt;wc()-&gt;countries-&gt;get_european_union_countries();&nbsp;</div></li><li><div>            // Add countries that are not strictly EU countries, but to which EU VAT rules apply&nbsp;</div></li><li><div>            $this-&gt;eu_vat_countries[] = 'MC';&nbsp;</div></li><li><div>            $this-&gt;eu_vat_countries[] = 'IM';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return apply_filters('wc_aelia_eu_vat_assistant_eu_vat_countries', $this-&gt;eu_vat_countries);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Indicates if the plugin has been configured.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function plugin_configured() {&nbsp;</div></li><li><div>        $vat_currency = $this-&gt;settings_controller()-&gt;get(Settings::FIELD_VAT_CURRENCY);&nbsp;</div></li><li><div>        return !empty($vat_currency);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks if the VAT rates retrieved by the EU VAT Assistant are valid. Rates&nbsp;</div></li><li><div>     * are valid when, for each country, they contain at least a standard rate&nbsp;</div></li><li><div>     * (invalid rates often have a &quot;null&quot; object associated to them).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array vat_rates An array containing the VAT rates for all EU countries.&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function valid_eu_vat_rates($vat_rates) {&nbsp;</div></li><li><div>        foreach($vat_rates as $country_code =&gt; $rates) {&nbsp;</div></li><li><div>            if(empty($rates['standard_rate']) ||&nbsp;</div></li><li><div>                 !is_numeric($rates['standard_rate'])) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the EU VAT rats from https://euvatrates.com website.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|null An array with the details of VAT rates, or null on failure.&nbsp;</div></li><li><div>     * @link https://euvatrates.com&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_eu_vat_rates() {&nbsp;</div></li><li><div>        $vat_rates = get_transient(Definitions::TRANSIENT_EU_VAT_RATES);&nbsp;</div></li><li><div>        if(!empty($vat_rates) && is_array($vat_rates)) {&nbsp;</div></li><li><div>            return $vat_rates;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $eu_vat_url = 'http://euvatrates.com/rates.json';&nbsp;</div></li><li><div>        $eu_vat_response = wp_remote_get($eu_vat_url, array(&nbsp;</div></li><li><div>            'timeout' =&gt; 5, &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        if(is_wp_error($eu_vat_response)) {&nbsp;</div></li><li><div>            $this-&gt;log(sprintf(__('Could not fetch EU VAT rates from remote site. Error(s): &quot;%s&quot;. Remote site: &quot;%s&quot;.', self::$text_domain), &nbsp;</div></li><li><div>                                                 implode(', ', $eu_vat_response-&gt;get_error_messages()), &nbsp;</div></li><li><div>                                                 $eu_vat_url));&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure that the VAT rates are in the correct format&nbsp;</div></li><li><div>        $vat_rates = json_decode(get_value('body', $eu_vat_response), true);&nbsp;</div></li><li><div>        if($vat_rates === null) {&nbsp;</div></li><li><div>            $this-&gt;log(sprintf(__('Unexpected response returned by EU VAT rates site. Returned data: &quot;%s&quot;. Remote site: &quot;%s&quot;.', self::$text_domain), &nbsp;</div></li><li><div>                                                 get_value('body', $eu_vat_response), &nbsp;</div></li><li><div>                                                 $eu_vat_url));&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Add rates for countries that use other countries' tax rates&nbsp;</div></li><li><div>        // Monaco uses French VAT&nbsp;</div></li><li><div>        $vat_rates['rates']['MC'] = $vat_rates['rates']['FR'];&nbsp;</div></li><li><div>        $vat_rates['rates']['MC']['country'] = 'Monaco';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Isle of Man uses UK's VAT&nbsp;</div></li><li><div>        $vat_rates['rates']['IM'] = $vat_rates['rates']['UK'];&nbsp;</div></li><li><div>        $vat_rates['rates']['IM']['country'] = 'Isle of Man';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Fix the country codes received from the feed. Some country codes are&nbsp;</div></li><li><div>        // actually the VAT country code. We need the ISO Code instead.&nbsp;</div></li><li><div>        $country_codes_to_fix = array(&nbsp;</div></li><li><div>            'EL' =&gt; 'GR', &nbsp;</div></li><li><div>            'UK' =&gt; 'GB', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        foreach($country_codes_to_fix as $code =&gt; $correct_code) {&nbsp;</div></li><li><div>            $vat_rates['rates'][$correct_code] = $vat_rates['rates'][$code];&nbsp;</div></li><li><div>            unset($vat_rates['rates'][$code]);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Fix the VAT rates for countries that don't have a reduced VAT rate. For&nbsp;</div></li><li><div>         * those countries, the standard rate should be used as the &quot;reduced&quot; rate.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.4.15.151029&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        foreach($vat_rates['rates'] as $country_code =&gt; $rates) {&nbsp;</div></li><li><div>            if(!is_numeric($rates['reduced_rate'])) {&nbsp;</div></li><li><div>                $rates['reduced_rate'] = $rates['standard_rate'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $vat_rates['rates'][$country_code] = $rates;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ksort($vat_rates['rates']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Debug&nbsp;</div></li><li><div>        //var_dump($vat_rates);die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure that the VAT rates are valid before caching them&nbsp;</div></li><li><div>        if($this-&gt;valid_eu_vat_rates($vat_rates['rates'])) {&nbsp;</div></li><li><div>            // Cache the VAT rates, to prevent unnecessary calls to the remote site&nbsp;</div></li><li><div>            set_transient(Definitions::TRANSIENT_EU_VAT_RATES, $vat_rates, 2 * HOUR_IN_SECONDS);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $vat_rates;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stores the list of countries to which sales are allowed, before the plugin&nbsp;</div></li><li><div>     * alters it.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function store_allowed_sale_countries() {&nbsp;</div></li><li><div>        $this-&gt;allowed_sale_countries = wc()-&gt;countries-&gt;get_allowed_countries();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the list of countries to which sales are not allowed.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_sale_disallowed_countries() {&nbsp;</div></li><li><div>        return $this-&gt;_settings_controller-&gt;get(Settings::FIELD_SALE_DISALLOWED_COUNTRIES, array());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Performs operation when woocommerce has been loaded.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_loaded() {&nbsp;</div></li><li><div>        if(!is_admin()) {&nbsp;</div></li><li><div>            // Add logic to filter the countries to which sales are allowed&nbsp;</div></li><li><div>            $this-&gt;store_allowed_sale_countries();&nbsp;</div></li><li><div>            $restricted_countries = $this-&gt;get_sale_disallowed_countries();&nbsp;</div></li><li><div>            if(!empty($restricted_countries)) {&nbsp;</div></li><li><div>                add_filter('pre_option_woocommerce_allowed_countries', array($this, 'pre_option_woocommerce_allowed_countries'), 10, 1);&nbsp;</div></li><li><div>                add_filter('woocommerce_countries_allowed_countries', array($this, 'woocommerce_countries_allowed_countries'), 10, 1);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Store shop base country for later use. This is necessary to prevent a&nbsp;</div></li><li><div>        // conflict with the Tax Display plugin, which may override the base country&nbsp;</div></li><li><div>        // at checkout&nbsp;</div></li><li><div>        $this-&gt;shop_base_country = $this-&gt;wc()-&gt;countries-&gt;get_base_country();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets the hooks required by the plugin.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_hooks() {&nbsp;</div></li><li><div>        parent::set_hooks();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_admin() && !$this-&gt;plugin_configured()) {&nbsp;</div></li><li><div>            add_action('admin_notices', array($this, 'settings_notice'));&nbsp;</div></li><li><div>            // Don't set any hook until the plugin has been configured&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_admin() || self::doing_ajax()) {&nbsp;</div></li><li><div>            // Set hooks that should be used on frontend only&nbsp;</div></li><li><div>            Frontend_Integration::init();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_admin()) {&nbsp;</div></li><li><div>            // Set hooks that should be used on backend only&nbsp;</div></li><li><div>            $this-&gt;set_admin_hooks();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Order actions&nbsp;</div></li><li><div>        add_action('woocommerce_checkout_update_order_meta', array($this, 'woocommerce_checkout_update_order_meta'), 20, 2);&nbsp;</div></li><li><div>        add_action('woocommerce_checkout_update_user_meta', array($this, 'woocommerce_checkout_update_user_meta'), 20, 2);&nbsp;</div></li><li><div>        add_action('woocommerce_checkout_billing', array($this, 'woocommerce_checkout_billing'), 40, 1);&nbsp;</div></li><li><div>        // Update VAT data for subscription renewals&nbsp;</div></li><li><div>        add_action('woocommerce_subscriptions_renewal_order_created', array($this, 'woocommerce_subscriptions_renewal_order_created'), 20, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Checkout hooks&nbsp;</div></li><li><div>        add_action('woocommerce_checkout_update_order_review', array($this, 'woocommerce_checkout_update_order_review'));&nbsp;</div></li><li><div>        add_action('woocommerce_checkout_process', array($this, 'woocommerce_checkout_process'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ajax hooks&nbsp;</div></li><li><div>        add_action('wp_ajax_validate_eu_vat_number', array($this, 'wp_ajax_validate_eu_vat_number'));&nbsp;</div></li><li><div>        add_action('wp_ajax_nopriv_validate_eu_vat_number', array($this, 'wp_ajax_validate_eu_vat_number'));&nbsp;</div></li><li><div>        add_action('wp_ajax_collect_order_vat_info', array($this, 'wp_ajax_collect_order_vat_info'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cron hooks&nbsp;</div></li><li><div>        // Add hooks to automatically update exchange rates&nbsp;</div></li><li><div>        add_action($this-&gt;_settings_controller-&gt;exchange_rates_update_hook(), &nbsp;</div></li><li><div>                             array($this-&gt;_settings_controller, 'scheduled_update_exchange_rates'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Integration with Currency Switcher&nbsp;</div></li><li><div>        add_action('wc_aelia_currencyswitcher_settings_saved', array($this, 'wc_aelia_currencyswitcher_settings_saved'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // UI&nbsp;</div></li><li><div>        add_action('add_meta_boxes', array($this, 'add_meta_boxes'));&nbsp;</div></li><li><div>        add_filter('woocommerce_order_formatted_billing_address', array($this, 'woocommerce_order_formatted_billing_address'), 10, 2);&nbsp;</div></li><li><div>        add_filter('woocommerce_formatted_address_replacements', array($this, 'woocommerce_formatted_address_replacements'), 10, 2);&nbsp;</div></li><li><div>        add_filter('woocommerce_localisation_address_formats', array($this, 'woocommerce_localisation_address_formats'), 10, 1);&nbsp;</div></li><li><div>        // Order Edit page - Add the VAT number to the billing fields&nbsp;</div></li><li><div>        // @since 1.6.2.160315&nbsp;</div></li><li><div>        add_filter('woocommerce_admin_billing_fields', array('\Aelia\WC\EU_VAT_Assistant\Orders_Integration', 'woocommerce_admin_billing_fields'), 10, 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Hooks to be called by 3rd party&nbsp;</div></li><li><div>        // Allow 3rd parties to convert a value from one currency to another&nbsp;</div></li><li><div>        add_filter('wc_aelia_eu_vat_assistant_convert', array($this, 'convert'), 10, 4);&nbsp;</div></li><li><div>        add_filter('wc_aelia_eu_vat_assistant_get_order_exchange_rate', array($this, 'wc_aelia_eu_vat_assistant_get_order_exchange_rate'), 10, 2);&nbsp;</div></li><li><div>        add_filter('wc_aelia_eu_vat_assistant_get_setting', array($this, 'wc_aelia_eu_vat_assistant_get_setting'), 10, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Reports&nbsp;</div></li><li><div>        ReportsManager::init();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    protected function set_admin_hooks() {&nbsp;</div></li><li><div>        Tax_Settings_Integration::set_hooks();&nbsp;</div></li><li><div>        Products_Integration::init();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines if one of plugin's admin pages is being rendered. Override it&nbsp;</div></li><li><div>     * if plugin implements pages in the Admin section.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function rendering_plugin_admin_page() {&nbsp;</div></li><li><div>        $screen = get_current_screen();&nbsp;</div></li><li><div>        $page_id = is_object($screen) ? $screen-&gt;id : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ($page_id == 'woocommerce_page_' . Definitions::MENU_SLUG);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers the script and style files needed by the admin pages of the&nbsp;</div></li><li><div>     * plugin. Extend in descendant plugins.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function register_plugin_admin_scripts() {&nbsp;</div></li><li><div>        // Scripts&nbsp;</div></li><li><div>        wp_register_script('chosen', &nbsp;</div></li><li><div>                                             '//cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.jquery.min.js', &nbsp;</div></li><li><div>                                             array('jquery'), &nbsp;</div></li><li><div>                                             null, &nbsp;</div></li><li><div>                                             true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Styles&nbsp;</div></li><li><div>        wp_register_style('chosen', &nbsp;</div></li><li><div>                                                '//cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.min.css', &nbsp;</div></li><li><div>                                                array(), &nbsp;</div></li><li><div>                                                null, &nbsp;</div></li><li><div>                                                'all');&nbsp;</div></li><li><div>        // WordPress already includes jQuery UI script, but no CSS for it. Therefore, &nbsp;</div></li><li><div>        // we need to load it from an external source&nbsp;</div></li><li><div>        wp_register_style('jquery-ui', &nbsp;</div></li><li><div>                                            '//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css', &nbsp;</div></li><li><div>                                            array(), &nbsp;</div></li><li><div>                                            null, &nbsp;</div></li><li><div>                                            'all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style('jquery-ui');&nbsp;</div></li><li><div>        wp_enqueue_style('chosen');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('jquery-ui-tabs');&nbsp;</div></li><li><div>        wp_enqueue_script('jquery-ui-sortable');&nbsp;</div></li><li><div>        wp_enqueue_script('chosen');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        parent::register_plugin_admin_scripts();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads the scripts required in the Admin section.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function load_admin_scripts() {&nbsp;</div></li><li><div>        parent::load_admin_scripts();&nbsp;</div></li><li><div>        $this-&gt;localize_admin_scripts();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads the settings that will be used by the admin scripts.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function localize_admin_scripts() {&nbsp;</div></li><li><div>        // Prepare parameters for common admin scripts&nbsp;</div></li><li><div>        $admin_scripts_params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Prepare parameters for Tax Settings pages&nbsp;</div></li><li><div>        if((get_value('page', $_GET) == 'wc-settings') &&&nbsp;</div></li><li><div>             (get_value('tab', $_GET) == 'tax')) {&nbsp;</div></li><li><div>            $admin_scripts_params = Tax_Settings_Integration::localize_admin_scripts($admin_scripts_params);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Prepare parameters for Orders pages&nbsp;</div></li><li><div>        // @since 1.6.1.160201&nbsp;</div></li><li><div>        if(Orders_Integration::editing_order()) {&nbsp;</div></li><li><div>            $admin_scripts_params = Orders_Integration::localize_admin_scripts($admin_scripts_params);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add localization parameters for EU VAT plugin settings page&nbsp;</div></li><li><div>        if($this-&gt;rendering_plugin_admin_page()) {&nbsp;</div></li><li><div>            $admin_scripts_params = array_merge($admin_scripts_params, array(&nbsp;</div></li><li><div>                'eu_vat_countries' =&gt; $this-&gt;get_eu_vat_countries(), &nbsp;</div></li><li><div>                'user_interface' =&gt; array(&nbsp;</div></li><li><div>                    'add_eu_countries_trigger' =&gt; __('Add European Union countries', self::$text_domain), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script(static::$plugin_slug . '-admin-common', &nbsp;</div></li><li><div>                                             'aelia_eu_vat_assistant_admin_params', &nbsp;</div></li><li><div>                                             $admin_scripts_params);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads Styles and JavaScript for the frontend. Extend as needed in&nbsp;</div></li><li><div>     * descendant classes.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function load_frontend_scripts() {&nbsp;</div></li><li><div>        // Enqueue the required Frontend stylesheets&nbsp;</div></li><li><div>        wp_enqueue_style(static::$plugin_slug . '-frontend');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // JavaScript&nbsp;</div></li><li><div>        wp_enqueue_script(static::$plugin_slug . '-frontend');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;localize_frontend_scripts();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads the settings that will be used by the frontend scripts.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function localize_frontend_scripts() {&nbsp;</div></li><li><div>        // Prepare parameters for common admin scripts&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build the list of countries for which the EU VAT field will be displayed&nbsp;</div></li><li><div>        // at checkout&nbsp;</div></li><li><div>        $eu_vat_countries = $this-&gt;get_eu_vat_countries();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $frontend_scripts_params = array(&nbsp;</div></li><li><div>            'tax_based_on' =&gt; get_option('woocommerce_tax_based_on'), &nbsp;</div></li><li><div>            'eu_vat_countries' =&gt; $eu_vat_countries, &nbsp;</div></li><li><div>            'ajax_url' =&gt; admin_url('admin-ajax.php', 'relative'), &nbsp;</div></li><li><div>            'show_self_cert_field' =&gt; self::settings()-&gt;get(Settings::FIELD_SHOW_SELF_CERTIFICATION_FIELD), &nbsp;</div></li><li><div>            'eu_vat_field_required' =&gt; self::settings()-&gt;get(Settings::FIELD_EU_VAT_NUMBER_FIELD_REQUIRED), &nbsp;</div></li><li><div>            'hide_self_cert_field_with_valid_vat' =&gt; self::settings()-&gt;get(Settings::FIELD_HIDE_SELF_CERTIFICATION_FIELD_VALID_VAT_NUMBER), &nbsp;</div></li><li><div>            'ip_address_country' =&gt; $this-&gt;get_ip_address_country(), &nbsp;</div></li><li><div>            'use_shipping_as_evidence' =&gt; self::settings()-&gt;get(Settings::FIELD_USE_SHIPPING_ADDRESS_AS_EVIDENCE), &nbsp;</div></li><li><div>            'user_interface' =&gt; array(&nbsp;</div></li><li><div>                'self_certification_field_title' =&gt; __(self::settings()-&gt;get(Settings::FIELD_SELF_CERTIFICATION_FIELD_TITLE), self::$text_domain), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'show_eu_vat_number_for_base_country' =&gt; (bool)self::settings()-&gt;get(Settings::FIELD_SHOW_EU_VAT_FIELD_IF_CUSTOMER_IN_BASE_COUNTRY), &nbsp;</div></li><li><div>            'shop_base_country' =&gt; $this-&gt;shop_base_country, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script(static::$plugin_slug . '-frontend', &nbsp;</div></li><li><div>                                             'aelia_eu_vat_assistant_params', &nbsp;</div></li><li><div>                                             $frontend_scripts_params);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of the report IDs introduced by this plugin.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array A list of report IDs.&nbsp;</div></li><li><div>     * @since 1.5.8.160112&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_available_reports() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'eu_vat_by_country_report', &nbsp;</div></li><li><div>            'vies_report', &nbsp;</div></li><li><div>            'intrastat_report', &nbsp;</div></li><li><div>            'sales_summary_report', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers the script and style files required in the backend (even outside&nbsp;</div></li><li><div>     * of plugin's pages). Extend in descendant plugins.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function register_common_admin_scripts() {&nbsp;</div></li><li><div>        parent::register_common_admin_scripts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The admin styles of this plugin are required throughout the WooCommerce&nbsp;</div></li><li><div>        // Administration, not just on the plugin settings page&nbsp;</div></li><li><div>        wp_register_style(static::$plugin_slug . '-admin', &nbsp;</div></li><li><div>                                            $this-&gt;url('plugin') . '/design/css/admin.css', &nbsp;</div></li><li><div>                                            array(), &nbsp;</div></li><li><div>                                            null, &nbsp;</div></li><li><div>                                            'all');&nbsp;</div></li><li><div>        wp_enqueue_style(static::$plugin_slug . '-admin');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load common JavaScript for the Admin section&nbsp;</div></li><li><div>        wp_enqueue_script(static::$plugin_slug . '-admin-common', &nbsp;</div></li><li><div>                                            $this-&gt;url('js') . '/admin/admin-common.js', &nbsp;</div></li><li><div>                                            array('jquery'), &nbsp;</div></li><li><div>                                            null, &nbsp;</div></li><li><div>                                            true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if((get_value('page', $_GET) == 'wc-reports') &&&nbsp;</div></li><li><div>             in_array(get_value('report', $_GET), $this-&gt;get_available_reports())) {&nbsp;</div></li><li><div>            // Load JavaScript for reports&nbsp;</div></li><li><div>            wp_enqueue_script(static::$plugin_slug . '-jquery-bbq', &nbsp;</div></li><li><div>                                                $this-&gt;url('js') . '/admin/jquery.ba-bbq.min.js', &nbsp;</div></li><li><div>                                                array('jquery'), &nbsp;</div></li><li><div>                                                null, &nbsp;</div></li><li><div>                                                true);&nbsp;</div></li><li><div>            wp_enqueue_script(static::$plugin_slug . '-admin-reports', &nbsp;</div></li><li><div>                                                $this-&gt;url('js') . '/admin/admin-reports.js', &nbsp;</div></li><li><div>                                                array('jquery'), &nbsp;</div></li><li><div>                                                null, &nbsp;</div></li><li><div>                                                true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds an error to WooCommerce, so that it can be displayed to the customer.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string error_message The error message to display.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function add_woocommerce_error($error_message) {&nbsp;</div></li><li><div>        wc_add_notice($error_message, 'error');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Converts an amount from a Currency to another.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param float amount The amount to convert.&nbsp;</div></li><li><div>     * @param string from_currency The source Currency.&nbsp;</div></li><li><div>     * @param string to_currency The destination Currency.&nbsp;</div></li><li><div>     * @param int price_decimals The amount of decimals to use when rounding the&nbsp;</div></li><li><div>     * converted result.&nbsp;</div></li><li><div>     * @return float The amount converted in the destination currency.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function convert($amount, $from_currency, $to_currency, $price_decimals = null) {&nbsp;</div></li><li><div>        // No need to try converting an amount that is not numeric. This can happen&nbsp;</div></li><li><div>        // quite easily, as &quot;no value&quot; is passed as an empty string&nbsp;</div></li><li><div>        if(!is_numeric($amount)) {&nbsp;</div></li><li><div>            return $amount;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No need to spend time converting a currency to itself&nbsp;</div></li><li><div>        if($from_currency == $to_currency) {&nbsp;</div></li><li><div>            return $amount;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($price_decimals)) {&nbsp;</div></li><li><div>            $price_decimals = absint(get_option('woocommerce_price_num_decimals'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Retrieve exchange rates from the configuration&nbsp;</div></li><li><div>        $exchange_rates = $this-&gt;_settings_controller-&gt;get_exchange_rates();&nbsp;</div></li><li><div>        //var_dump($exchange_rates);&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $error_message_template = __('Currency conversion - %s currency not valid or exchange rate ' .&nbsp;</div></li><li><div>                                                                     'not found for: &quot;%s&quot;. Please make sure that the EU VAT assistant '.&nbsp;</div></li><li><div>                                                                     'plugin is configured correctly and that an Exchange ' .&nbsp;</div></li><li><div>                                                                     'Rate has been specified for each of the available currencies.', &nbsp;</div></li><li><div>                                                                     self::$text_domain);&nbsp;</div></li><li><div>            $from_currency_rate = get_value($from_currency, $exchange_rates, null);&nbsp;</div></li><li><div>            if(empty($from_currency_rate)) {&nbsp;</div></li><li><div>                $error_message = sprintf($error_message_template, &nbsp;</div></li><li><div>                                                                 __('Source', self::$text_domain), &nbsp;</div></li><li><div>                                                                 $from_currency);&nbsp;</div></li><li><div>                $this-&gt;log($error_message, false);&nbsp;</div></li><li><div>                if($this-&gt;debug_mode()) {&nbsp;</div></li><li><div>                    throw new InvalidArgumentException($error_message);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $to_currency_rate = get_value($to_currency, $exchange_rates, null);&nbsp;</div></li><li><div>            if(empty($to_currency_rate)) {&nbsp;</div></li><li><div>                $error_message = sprintf($error_message_template, &nbsp;</div></li><li><div>                                                                 __('Destination', self::$text_domain), &nbsp;</div></li><li><div>                                                                 $from_currency);&nbsp;</div></li><li><div>                $this-&gt;log($error_message, false);&nbsp;</div></li><li><div>                if($this-&gt;debug_mode()) {&nbsp;</div></li><li><div>                    throw new InvalidArgumentException($error_message);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $exchange_rate = $to_currency_rate / $from_currency_rate;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        catch(Exception $e) {&nbsp;</div></li><li><div>            $full_message = $e-&gt;getMessage() .&nbsp;</div></li><li><div>                                            sprintf(__('Stack trace: %s', Definitions::TEXT_DOMAIN), &nbsp;</div></li><li><div>                                                            $e-&gt;getTraceAsString());&nbsp;</div></li><li><div>            $this-&gt;log($full_message, false);&nbsp;</div></li><li><div>            trigger_error($full_message, E_USER_ERROR);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return round($amount * $exchange_rate, $price_decimals);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the exchange rate used to calculate the VAT for an order in the&nbsp;</div></li><li><div>     * currency that has to be used for VAT returns.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int order_id The ID of the order from which to retrieve the exchange&nbsp;</div></li><li><div>     * rate.&nbsp;</div></li><li><div>     * @return float|false The exchange rate, if present, or false if it was not&nbsp;</div></li><li><div>     * saved against the order.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_vat_exchange_rate($order_id) {&nbsp;</div></li><li><div>        $order = new Order($order_id);&nbsp;</div></li><li><div>        $vat_exchange_rate = $order-&gt;get_vat_data('vat_currency_exchange_rate');&nbsp;</div></li><li><div>        return $vat_exchange_rate;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a full VAT number, inclusive of country prefix.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string country A country code.&nbsp;</div></li><li><div>     * @param string vat_number A VAT number.&nbsp;</div></li><li><div>     * @param string A full VAT number, with the country prefix (e.g. IE1234567X)&nbsp;</div></li><li><div>     * @since 1.3.20.150330&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_full_vat_number($country, $vat_number) {&nbsp;</div></li><li><div>        $vat_number = $this-&gt;eu_vat_validation()-&gt;parse_vat_number($vat_number);&nbsp;</div></li><li><div>        // If an invalid VAT number was passed, return an empty string&nbsp;</div></li><li><div>        if(!$vat_number) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $vat_prefix = $this-&gt;eu_vat_validation()-&gt;get_vat_prefix($country);&nbsp;</div></li><li><div>        return $vat_prefix . $vat_number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Saves the evidence used to determine the VAT rate to apply.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param Aelia_Order order The order to process.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_eu_vat_data($order_id) {&nbsp;</div></li><li><div>        // Save the VAT number details&nbsp;</div></li><li><div>        $order_vat_number = $this-&gt;get_full_vat_number($this-&gt;vat_country, $this-&gt;vat_number);&nbsp;</div></li><li><div>        if($order_vat_number == false) {&nbsp;</div></li><li><div>            $this-&gt;log(sprintf(__('Order ID &quot;%s&quot;. Invalid VAT Number parsed: &quot;%s&quot;.', self::$text_domain), &nbsp;</div></li><li><div>                                                 $order_id, &nbsp;</div></li><li><div>                                                 $order_vat_number), true);&nbsp;</div></li><li><div>            $order_vat_number = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        update_post_meta($order_id, 'vat_number', $order_vat_number);&nbsp;</div></li><li><div>        update_post_meta($order_id, '_vat_country', $this-&gt;vat_country);&nbsp;</div></li><li><div>        update_post_meta($order_id, '_vat_number_validated', $this-&gt;vat_number_validated);&nbsp;</div></li><li><div>        // Store customer's self-certification flag&nbsp;</div></li><li><div>        if(get_value(Definitions::ARG_LOCATION_SELF_CERTIFICATION, $_POST, 0)) {&nbsp;</div></li><li><div>            $location_self_certified = Definitions::YES;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $location_self_certified = Definitions::NO;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        update_post_meta($order_id, '_customer_location_self_certified', $location_self_certified);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Use plugins' internal Order class, which implements convenience methods&nbsp;</div></li><li><div>        // to handle EU VAT reguirements&nbsp;</div></li><li><div>        $order = new Order($order_id);&nbsp;</div></li><li><div>        // Generate and store details about order VAT&nbsp;</div></li><li><div>        $order-&gt;update_vat_data();&nbsp;</div></li><li><div>        // Save EU VAT compliance evidence&nbsp;</div></li><li><div>        $order-&gt;store_vat_evidence();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Renders the EU VAT field using the appropriate view.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function render_eu_vat_field() {&nbsp;</div></li><li><div>        wc_get_template('checkout-eu-vat-field.php', array(), 'woocommerce/eu-vat-assistant', $this-&gt;path('views') . '/frontend/');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Renders the self-certification field using the appropriate view.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function render_self_certification_field() {&nbsp;</div></li><li><div>        wc_get_template('checkout-self-certification-field.php', array(), 'woocommerce/eu-vat-assistant', $this-&gt;path('views') . '/frontend/');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validates an EU VAT number.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string country A country code.&nbsp;</div></li><li><div>     * @param string vat_number A VAT number.&nbsp;</div></li><li><div>     * @return array An array with the result of the validation.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_eu_vat_number($country, $vat_number) {&nbsp;</div></li><li><div>        $validation_result = $this-&gt;eu_vat_validation()-&gt;validate_vat_number($country, $vat_number);&nbsp;</div></li><li><div>        // TODO Refactor the communication with the EU_VAT_Validation class to make it easier to replace it with other classes&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // A validation result of &quot;null&quot; indicates a failure in sending the SOAP&nbsp;</div></li><li><div>        // request, therefore we can't process it&nbsp;</div></li><li><div>        if($validation_result['valid'] !== null) {&nbsp;</div></li><li><div>            $vat_number_valid = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Extract the error message, if any&nbsp;</div></li><li><div>            $validation_error = $validation_result['errors'][0];&nbsp;</div></li><li><div>            if(!empty($validation_error)) {&nbsp;</div></li><li><div>                // If server was busy, we may have to accept the VAT number as valid, &nbsp;</div></li><li><div>                // depending on plugin settings&nbsp;</div></li><li><div>                if(strcasecmp($validation_error, 'SERVER_BUSY') == 0) {&nbsp;</div></li><li><div>                    $validation_result['valid'] = self::settings()-&gt;get(Settings::FIELD_ACCEPT_VAT_NUMBER_WHEN_VALIDATION_SERVER_BUSY, true);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;log(sprintf(__('EU VAT validation response (JSON): &quot;%s&quot;.', &nbsp;</div></li><li><div>                                                    self::$text_domain), &nbsp;</div></li><li><div>                                             json_encode($validation_result)), &nbsp;</div></li><li><div>                             false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //var_dump($validation_result);die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters('wc_aelia_euva_eu_vat_number_raw_validation_result', $validation_result, $country, $vat_number);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines if a country is part of the EU.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string country The country code to check.&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_eu_country($country) {&nbsp;</div></li><li><div>        return in_array($country, $this-&gt;get_eu_vat_countries());&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines if there is enough evidence about customer's location to satisfy&nbsp;</div></li><li><div>     * EU requirements. The method collects all the country codes that can be derived&nbsp;</div></li><li><div>     * from the data posted at checkout, and looks for one that occurs twice or&nbsp;</div></li><li><div>     * more. As per EU regulations, we only need two matching pieces of evidence.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array posted_data The data posted at checkout.&nbsp;</div></li><li><div>     * @return string|bool The code of the country with the most entries, if one&nbsp;</div></li><li><div>     * with at least two occurrences is found, or false if no country appears more&nbsp;</div></li><li><div>     * than once.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function sufficient_location_evidence($posted_data) {&nbsp;</div></li><li><div>        // Collect all the countries we can get from the posted data&nbsp;</div></li><li><div>        $countries = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $countries[] = $billing_country = get_value('billing_country', $posted_data);&nbsp;</div></li><li><div>        $countries[] = $this-&gt;get_ip_address_country();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Take shipping country as evidence only if explicitly told so&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_USE_SHIPPING_ADDRESS_AS_EVIDENCE)) {&nbsp;</div></li><li><div>            if(get_value('ship_to_different_address', $posted_data)) {&nbsp;</div></li><li><div>                $countries[] = get_value('shipping_country', $posted_data);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            else {&nbsp;</div></li><li><div>                // If shipping to the same address as billing, add the billing country again&nbsp;</div></li><li><div>                // as a further proof of location&nbsp;</div></li><li><div>                $countries[] = $billing_country;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $countries = array_filter(apply_filters('wc_aelia_eu_vat_assistant_location_evidence_countries', $countries));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Calculate how many times each country appears in the list and sort the&nbsp;</div></li><li><div>        // array by count, in descending order, so that the country with most matches&nbsp;</div></li><li><div>        // is at the top&nbsp;</div></li><li><div>        $country_count = array_count_values($countries);&nbsp;</div></li><li><div>        arsort($country_count);&nbsp;</div></li><li><div>        reset($country_count);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We only need at least two matching entries in the array. If that is the&nbsp;</div></li><li><div>        // case, return the country code (it may be useful later, and it's better than&nbsp;</div></li><li><div>        // a simple &quot;true&quot;)&nbsp;</div></li><li><div>        $top_country = key($country_count);&nbsp;</div></li><li><div>        if($country_count[$top_country] &gt;= 2) {&nbsp;</div></li><li><div>            return $top_country;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // If the top country doesn't have at least a count of two, then the other&nbsp;</div></li><li><div>        // entries won't have it either. In such case, inform the caller that we&nbsp;</div></li><li><div>        // don't have sufficient evidence&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets customer's VAT exemption, depending on his country and the VAT number&nbsp;</div></li><li><div>     * he entered.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string country The country against which the VAT exemption will be checked.&nbsp;</div></li><li><div>     * @param string vat_number The VAT number entered by the customer.&nbsp;</div></li><li><div>     * @return int A numeric result code indicating if the check succeeded, whether&nbsp;</div></li><li><div>     * the customer is VAT exempt or not, or failed (i.e. when an EU customer&nbsp;</div></li><li><div>     * entered an invalid EU VAT number).&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_customer_vat_exemption($customer_country, $vat_number) {&nbsp;</div></li><li><div>        $this-&gt;log(sprintf(__('Setting customer VAT exemption. Customer country: &quot;%s&quot;. Number: &quot;%s&quot;.', &nbsp;</div></li><li><div>                                                    self::$text_domain), &nbsp;</div></li><li><div>                                             $customer_country, $vat_number), false);&nbsp;</div></li><li><div>        $result = Definitions::RES_OK;&nbsp;</div></li><li><div>        // Assume that customer is not VAT exempt. This is a sensible default, as&nbsp;</div></li><li><div>        // exemption applies only in specific cases, and only for EU customers.&nbsp;</div></li><li><div>        // Customers outside the EU are not technically &quot;VAT exempt&quot;. To them, a&nbsp;</div></li><li><div>        // special &quot;Zero VAT&quot; rate applies&nbsp;</div></li><li><div>        $customer_vat_exemption = false;&nbsp;</div></li><li><div>        // Clear VAT information before validation&nbsp;</div></li><li><div>        $this-&gt;vat_country = '';&nbsp;</div></li><li><div>        $this-&gt;vat_number = '';&nbsp;</div></li><li><div>        $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_VALIDATION_NO_NUMBER;&nbsp;</div></li><li><div>        $this-&gt;raw_vat_validation_response = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If VAT number was hidden, customer cannot be made VAT exempt. We can skip&nbsp;</div></li><li><div>        // the checks, in such case&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_EU_VAT_NUMBER_FIELD_REQUIRED) != Settings::OPTION_EU_VAT_NUMBER_FIELD_HIDDEN) {&nbsp;</div></li><li><div>            // No need to check the VAT number if either the country or the number are empty&nbsp;</div></li><li><div>            if(!empty($customer_country) && !empty($vat_number)) {&nbsp;</div></li><li><div>                // Store the VAT information. They will be used later, to update the order&nbsp;</div></li><li><div>                // when it's finalised&nbsp;</div></li><li><div>                $this-&gt;vat_country = $customer_country;&nbsp;</div></li><li><div>                $this-&gt;vat_number = $vat_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Customer is based in the European Union, therefore EU VAT rules and validations apply&nbsp;</div></li><li><div>                if($this-&gt;is_eu_country($customer_country)) {&nbsp;</div></li><li><div>                    // Validate the VAT number for EU customers&nbsp;</div></li><li><div>                    $this-&gt;raw_vat_validation_response = $this-&gt;validate_eu_vat_number($customer_country, $vat_number);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Debug&nbsp;</div></li><li><div>                    //var_dump($this-&gt;raw_vat_validation_response);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // If the EU VAT number is valid, we must determine if the customer should&nbsp;</div></li><li><div>                    // be considered exempt from VAT&nbsp;</div></li><li><div>                    if($this-&gt;raw_vat_validation_response['valid'] == true) {&nbsp;</div></li><li><div>                        /** An EU customer will be considered exempt from VAT if:&nbsp;</div></li><li><div>                         * - He is located in a country different from shop's base country.&nbsp;</div></li><li><div>                         * - He is located in the same country as the shop, and option &quot;remove VAT&nbsp;</div></li><li><div>                         *   when customer in located in shop's base country&quot; is enabled.&nbsp;</div></li><li><div>                         */&nbsp;</div></li><li><div>                        if(($customer_country != $this-&gt;shop_base_country) ||&nbsp;</div></li><li><div>                             self::settings()-&gt;get(Settings::FIELD_REMOVE_VAT_IF_CUSTOMER_IN_BASE_COUNTRY)) {&nbsp;</div></li><li><div>                            $customer_vat_exemption = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_VALIDATION_VALID;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    else {&nbsp;</div></li><li><div>                        // A &quot;null&quot; response means that nothing was returned by the server.&nbsp;</div></li><li><div>                        // In such case, log an error&nbsp;</div></li><li><div>                        if($this-&gt;raw_vat_validation_response['valid'] === null) {&nbsp;</div></li><li><div>                            $this-&gt;log(sprintf(__('EU VAT Number could not be validated due to errors in ' .&nbsp;</div></li><li><div>                                                                        'the communication with the remote service. Error details ' .&nbsp;</div></li><li><div>                                                                        '(JSON): &quot;%s&quot;.', &nbsp;</div></li><li><div>                                                                        self::$text_domain), &nbsp;</div></li><li><div>                                                                 json_encode($this-&gt;raw_vat_validation_response['errors'])));&nbsp;</div></li><li><div>                            $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_COULD_NOT_BE_VALIDATED;&nbsp;</div></li><li><div>                            $result = Definitions::ERR_COULD_NOT_VALIDATE_VAT_NUMBER;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        else {&nbsp;</div></li><li><div>                            $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_VALIDATION_NOT_VALID;&nbsp;</div></li><li><div>                            $result = Definitions::ERR_INVALID_EU_VAT_NUMBER;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_VALIDATION_NON_EU;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;log(__('EU VAT Number field was hidden by plugin configuration. Customer ' .&nbsp;</div></li><li><div>                                        'cannot be made VAT exempt.', &nbsp;</div></li><li><div>                                        self::$text_domain));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;log(sprintf(__('VAT exemption check completed. Customer exemption: %d. Result: %d.', &nbsp;</div></li><li><div>                                                    self::$text_domain), &nbsp;</div></li><li><div>                                             (int)$customer_vat_exemption, &nbsp;</div></li><li><div>                                             (int)$result));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customer_vat_exemption = apply_filters('wc_aelia_eu_vat_assistant_customer_vat_exemption', $customer_vat_exemption, $this-&gt;vat_country, $this-&gt;vat_number, $this-&gt;vat_number_validated, $this-&gt;raw_vat_validation_response);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;wc()-&gt;customer-&gt;set_is_vat_exempt($customer_vat_exemption);&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates the order meta after it has been created, or updated, at checkout.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int order_id The order just created, or updated.&nbsp;</div></li><li><div>     * @param array posted_data The data posted to create the order.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_checkout_update_order_meta($order_id, $posted_data) {&nbsp;</div></li><li><div>        $this-&gt;save_eu_vat_data($order_id);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates the metadata of a renewal order created by the Subscriptions plugin.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Order $renewal_order The renewal order.&nbsp;</div></li><li><div>     * @param WC_Order $original_order The original order used to create the renewal order.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_subscriptions_renewal_order_created($renewal_order, $original_order) {&nbsp;</div></li><li><div>        // If we are processing checkout, no action needs to be taken. Handler for&nbsp;</div></li><li><div>        // &quot;woocommerce_checkout_update_order_meta&quot; hook will take care of saving the&nbsp;</div></li><li><div>        // necessary data&nbsp;</div></li><li><div>        if(is_checkout()) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Use the internal Order classes&nbsp;</div></li><li><div>        $original_order = new Order(aelia_get_order_id($original_order));&nbsp;</div></li><li><div>        $renewal_order = new Order(aelia_get_order_id($renewal_order));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Copy the VAT evidence from the original subscription order. A renewal order&nbsp;</div></li><li><div>        // is created without customer's intervention, therefore&nbsp;</div></li><li><div>        $original_order_vat_info = array(&nbsp;</div></li><li><div>            Order::META_EU_VAT_EVIDENCE =&gt; $original_order-&gt;eu_vat_evidence, &nbsp;</div></li><li><div>            'vat_number' =&gt; $original_order-&gt;get_customer_vat_number(), &nbsp;</div></li><li><div>            '_vat_country' =&gt; $original_order-&gt;vat_country, &nbsp;</div></li><li><div>            '_vat_number_validated' =&gt; $original_order-&gt;vat_number_validated, &nbsp;</div></li><li><div>            '_customer_location_self_certified' =&gt; $original_order-&gt;customer_location_self_certified, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $original_order_vat_info = apply_filters('wc_aelia_eu_vat_assistant_subscription_original_order_vat_info', $original_order_vat_info, $original_order, $renewal_order);&nbsp;</div></li><li><div>        foreach($original_order_vat_info as $meta_key =&gt; $value) {&nbsp;</div></li><li><div>            $renewal_order-&gt;set_meta($meta_key, $value)    ;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Generate and store details about order VAT&nbsp;</div></li><li><div>        $renewal_order-&gt;update_vat_data();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates the customer meta at checkout.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int user_id The user ID who placed the order.&nbsp;</div></li><li><div>     * @param array posted_data The data posted to create the order.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_checkout_update_user_meta($user_id, $posted_data) {&nbsp;</div></li><li><div>        update_user_meta($user_id, 'vat_number', $this-&gt;get_full_vat_number($this-&gt;vat_country, $this-&gt;vat_number));&nbsp;</div></li><li><div>        update_user_meta($user_id, '_vat_country', $this-&gt;vat_country);&nbsp;</div></li><li><div>        update_user_meta($user_id, '_vat_number_validated', $this-&gt;vat_number_validated);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Renders the EU VAT field on the checkout form.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_checkout_billing() {&nbsp;</div></li><li><div>        // Render EU VAT Number element, unless it's hidden&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_EU_VAT_NUMBER_FIELD_REQUIRED) != Settings::OPTION_EU_VAT_NUMBER_FIELD_HIDDEN) {&nbsp;</div></li><li><div>            $this-&gt;render_eu_vat_field();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Render self-certification element, unless it's hidden&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_SHOW_SELF_CERTIFICATION_FIELD) != Settings::OPTION_SELF_CERTIFICATION_FIELD_NO) {&nbsp;</div></li><li><div>            $this-&gt;render_self_certification_field();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ajax handler. Validates an EU VAT number using VIES service and outputs&nbsp;</div></li><li><div>     * a JSON response with the validation result.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wp_ajax_validate_eu_vat_number() {&nbsp;</div></li><li><div>        // Validate EU VAT number and return the result as JSON&nbsp;</div></li><li><div>        wp_send_json($this-&gt;validate_eu_vat_number(&nbsp;</div></li><li><div>            get_value(Definitions::ARG_COUNTRY, $_GET), &nbsp;</div></li><li><div>            get_value(Definitions::ARG_VAT_NUMBER, $_GET)&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Performs VAT validation operations during order review.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array form_data The data posted from the order review page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_checkout_update_order_review($form_data) {&nbsp;</div></li><li><div>        // $form_data contains an HTTP query string. Let's &quot;explode&quot; it into an&nbsp;</div></li><li><div>        // array&nbsp;</div></li><li><div>        parse_str($form_data, $posted_data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Debug&nbsp;</div></li><li><div>        //var_dump(&quot;POSTED DATA&quot;, $posted_data);die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cannot continue without the billing country&nbsp;</div></li><li><div>        if(empty($posted_data['billing_country'])) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine which country will be used to calculate taxes&nbsp;</div></li><li><div>        switch(get_option('woocommerce_tax_based_on')) {&nbsp;</div></li><li><div>            case 'billing' :&nbsp;</div></li><li><div>            case 'base' :&nbsp;</div></li><li><div>                $country = !empty($posted_data['billing_country']) ? $posted_data['billing_country'] : '';&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case 'shipping' :&nbsp;</div></li><li><div>                if(get_value('ship_to_different_address', $posted_data) && !empty($posted_data['shipping_country'])) {&nbsp;</div></li><li><div>                    $country = $posted_data['shipping_country'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    $country = $posted_data['billing_country'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check if customer is VAT exempt&nbsp;</div></li><li><div>        $country = wc_clean($country);&nbsp;</div></li><li><div>        if(empty($country)) {&nbsp;</div></li><li><div>            $this-&gt;log(sprintf(__('Unexpected condition occurred: no customer country was posted ' .&nbsp;</div></li><li><div>                                                        'to &quot;checkout update order review&quot; event. Full posted data ' .&nbsp;</div></li><li><div>                                                        '(JSON): &quot;%s&quot;.', &nbsp;</div></li><li><div>                                                        self::$text_domain), &nbsp;</div></li><li><div>                                                 json_encode($posted_data)), false);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $vat_number = wc_clean(get_value('vat_number', $posted_data));&nbsp;</div></li><li><div>        $this-&gt;set_customer_vat_exemption($country, $vat_number);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Indicates if a customers is VAT exempt.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     * @since 1.7.5.170405&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function customer_is_vat_exempt() {&nbsp;</div></li><li><div>        // Use the new WC 3.0 method, if available. If not, default to the object&nbsp;</div></li><li><div>        // property&nbsp;</div></li><li><div>        return method_exists($this-&gt;wc()-&gt;customer, 'get_is_vat_exempt') ? $this-&gt;wc()-&gt;customer-&gt;get_is_vat_exempt() : $this-&gt;wc()-&gt;customer-&gt;is_vat_exempt;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Performs validations to make sure that either there is enough evidence to&nbsp;</div></li><li><div>     * determine customer's location, or customer had self-certified his location.&nbsp;</div></li><li><div>     * This method automatically adds a checkout error when needed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_self_certification() {&nbsp;</div></li><li><div>        // If the self-certification element was forcibly hidden, it doesn't make&nbsp;</div></li><li><div>        // sense to perform this validation&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_SHOW_SELF_CERTIFICATION_FIELD) == Settings::OPTION_SELF_CERTIFICATION_FIELD_NO) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** We need to check the available gelocation evidence in two cases:&nbsp;</div></li><li><div>         * - When customer is not VAT exempt.&nbsp;</div></li><li><div>         * - Regardless of the VAT number, if option &quot;hide self certification field&nbsp;</div></li><li><div>         *   with valid VAT number&quot; is DISABLED.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * In all other cases, there must be sufficient evidence for the order to&nbsp;</div></li><li><div>         * go through, or customer must self-certify.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if(($this-&gt;customer_is_vat_exempt() == false) ||&nbsp;</div></li><li><div>             (self::settings()-&gt;get(Settings::FIELD_HIDE_SELF_CERTIFICATION_FIELD_VALID_VAT_NUMBER) == false)) {&nbsp;</div></li><li><div>            // Check if we have sufficient evidence about customer's location&nbsp;</div></li><li><div>            $sufficient_location_evidence_result = $this-&gt;sufficient_location_evidence($_POST);&nbsp;</div></li><li><div>            if($sufficient_location_evidence_result == false) {&nbsp;</div></li><li><div>                // Convenience variable, to better understand the check below&nbsp;</div></li><li><div>                $ignore_insufficient_evidence = ($this-&gt;vat_number_validated == Definitions::VAT_NUMBER_VALIDATION_VALID);&nbsp;</div></li><li><div>                /** If insufficient location evidence has been provided, check if self-certification&nbsp;</div></li><li><div>                 * is required to accept the order. If it is required, and it was not provided, &nbsp;</div></li><li><div>                 * stop the checkout and inform the customer.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                if(!$ignore_insufficient_evidence &&&nbsp;</div></li><li><div>                     self::settings()-&gt;get(Settings::FIELD_SELF_CERTIFICATION_FIELD_REQUIRED_WHEN_CONFLICT) &&&nbsp;</div></li><li><div>                    (get_value(Definitions::ARG_LOCATION_SELF_CERTIFICATION, $_POST) == false)) {&nbsp;</div></li><li><div>                    // Inform the customer that he must self-certify to proceed with the purchase&nbsp;</div></li><li><div>                    $error = __('Unfortunately, we could not collect sufficient information to confirm ' .&nbsp;</div></li><li><div>                                            'your location. To proceed with the order, please tick the box below the ' .&nbsp;</div></li><li><div>                                            'billing details to confirm that you will be using the product(s) in ' .&nbsp;</div></li><li><div>                                            'country you selected.', &nbsp;</div></li><li><div>                                            self::$text_domain);&nbsp;</div></li><li><div>                    $this-&gt;add_woocommerce_error($error);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Indicates if a valid EU VAT number is required to complete checkout. A VAT&nbsp;</div></li><li><div>     * number is required in the following cases:&nbsp;</div></li><li><div>     * - When the requirement setting is &quot;always required&quot;.&nbsp;</div></li><li><div>     * - When the requirement setting is &quot;required for EU only&quot; and customer&nbsp;</div></li><li><div>     *   selected a billing country that is part of the EU.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string customer_country The country for which the check should be&nbsp;</div></li><li><div>     * performed.&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function is_eu_vat_number_required($customer_country) {&nbsp;</div></li><li><div>        $result = false;&nbsp;</div></li><li><div>        /** If the VAT field is visible for shop's base country, or the customer is&nbsp;</div></li><li><div>         * not in shop's base country, then we can check if it should be required.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if(self::settings()-&gt;get(Settings::FIELD_SHOW_EU_VAT_FIELD_IF_CUSTOMER_IN_BASE_COUNTRY) ||&nbsp;</div></li><li><div>             ($customer_country != $this-&gt;shop_base_country)) {&nbsp;</div></li><li><div>            $eu_vat_number_required = self::settings()-&gt;get(Settings::FIELD_EU_VAT_NUMBER_FIELD_REQUIRED);&nbsp;</div></li><li><div>            /** The EU VAT field is required in one of the following cases&nbsp;</div></li><li><div>             * 1- If the related option is set to &quot;required&quot;.&nbsp;</div></li><li><div>             * 2- If the option is set to &quot;only if company name is filled&quot; and the&nbsp;</div></li><li><div>             *    customer entered a company name.&nbsp;</div></li><li><div>             * 3- If the option is set &quot;only for EU customers&quot; and the customer selected&nbsp;</div></li><li><div>             *    a EU country.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $result = ($eu_vat_number_required == Settings::OPTION_EU_VAT_NUMBER_FIELD_REQUIRED) ||&nbsp;</div></li><li><div>                                // Check if option is &quot;required only if company has been entered&quot;&nbsp;</div></li><li><div>                                // and the company field is not empty&nbsp;</div></li><li><div>                                (($eu_vat_number_required == Settings::OPTION_EU_VAT_NUMBER_FIELD_REQUIRED_IF_COMPANY_FILLED) &&&nbsp;</div></li><li><div>                                    !empty($_POST['billing_company']) && (trim($_POST['billing_company']) != '')) ||&nbsp;</div></li><li><div>                                // Check if option is &quot;required only if company has been entered&nbsp;</div></li><li><div>                                // and address is in the EU&quot;, and the company field is not empty&nbsp;</div></li><li><div>                                (($eu_vat_number_required == Settings::OPTION_EU_VAT_NUMBER_FIELD_REQUIRED_IF_COMPANY_FILLED_EU_ONLY) &&&nbsp;</div></li><li><div>                                    $this-&gt;is_eu_country($customer_country) &&&nbsp;</div></li><li><div>                                    !empty($_POST['billing_company']) && (trim($_POST['billing_company']) != '')) ||&nbsp;</div></li><li><div>                                // Check if option is &quot;required only if company is in EU&quot; and the&nbsp;</div></li><li><div>                                // company is in the EU&nbsp;</div></li><li><div>                                (($eu_vat_number_required == Settings::OPTION_EU_VAT_NUMBER_FIELD_REQUIRED_EU_ONLY) && $this-&gt;is_eu_country($customer_country));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters('wc_aelia_euva_order_is_eu_vat_number_required', $result, $customer_country);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Performs validations related to the EU VAT Number, to ensure that customer&nbsp;</div></li><li><div>     * has entered all the information required to complete the checkout.&nbsp;</div></li><li><div>     * This method automatically adds a checkout error when needed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_vat_exemption() {&nbsp;</div></li><li><div>        // Check if customer is VAT exempt and set him as such&nbsp;</div></li><li><div>        if(aelia_wc_version_is('&gt;=', '2.7')) {&nbsp;</div></li><li><div>            $customer_country = $this-&gt;wc()-&gt;customer-&gt;get_billing_country();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $customer_country = $this-&gt;wc()-&gt;customer-&gt;get_country();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If customer's country is empty on customer object, take it from the data&nbsp;</div></li><li><div>        // posted at checkout&nbsp;</div></li><li><div>        if(empty($customer_country)) {&nbsp;</div></li><li><div>            $this-&gt;log(__('Billing country on Customer object is empty. Retrieving ' .&nbsp;</div></li><li><div>                                        'it from posted data.', &nbsp;</div></li><li><div>                                        self::$text_domain), false);&nbsp;</div></li><li><div>            $customer_country = get_value('billing_country', $_POST, '');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($customer_country)) {&nbsp;</div></li><li><div>                $this-&gt;log(sprintf(__('Unexpected condition occurred: no customer country was posted  ' .&nbsp;</div></li><li><div>                                                            'during checkout. VAT exemption cannot be applied correctly. ' .&nbsp;</div></li><li><div>                                                            'Full posted data (JSON): &quot;%s&quot;.', &nbsp;</div></li><li><div>                                                            self::$text_domain), &nbsp;</div></li><li><div>                                                     json_encode($_POST)), false);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $vat_number = get_value(Definitions::ARG_VAT_NUMBER, $_POST, '');&nbsp;</div></li><li><div>        // Check if customer is VAT exempt and set his exemption accordingly&nbsp;</div></li><li><div>        $exemption_check_result = $this-&gt;set_customer_vat_exemption($customer_country, $vat_number);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If VAT Number is required, but it was not entered or it's not valid, &nbsp;</div></li><li><div>        // display the appropriate error message and stop the checkout&nbsp;</div></li><li><div>        if($this-&gt;is_eu_vat_number_required($customer_country) &&&nbsp;</div></li><li><div>             ($this-&gt;vat_number_validated != Definitions::VAT_NUMBER_VALIDATION_VALID)) {&nbsp;</div></li><li><div>            $error = sprintf(__('You must enter a valid EU VAT number to complete the purchase.', self::$text_domain), $vat_number);&nbsp;</div></li><li><div>            $this-&gt;add_woocommerce_error($error);&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If VAT number is optional, check if customer may be allowed to complete&nbsp;</div></li><li><div>        // the purchase anyway&nbsp;</div></li><li><div>        if($exemption_check_result == Definitions::ERR_INVALID_EU_VAT_NUMBER &&&nbsp;</div></li><li><div>             // If &quot;store invalid VAT numbers&quot; option is enabled, don't show any error&nbsp;</div></li><li><div>             // The VAT number will be recorded with the order, but the customer won't&nbsp;</div></li><li><div>             // be made exempt from VAT&nbsp;</div></li><li><div>             self::settings()-&gt;get(Settings::FIELD_STORE_INVALID_VAT_NUMBERS) == false) {&nbsp;</div></li><li><div>            // Show an error when VAT number validation fails at checkout&nbsp;</div></li><li><div>            $error = sprintf(__('VAT number &quot;%s&quot; is not valid for your country.', self::$text_domain), $vat_number);&nbsp;</div></li><li><div>            $this-&gt;add_woocommerce_error($error);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Performs VAT validation operations during checkout.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array posted_data The data posted from the order review page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_checkout_process() {&nbsp;</div></li><li><div>        $this-&gt;validate_vat_exemption();&nbsp;</div></li><li><div>        $this-&gt;validate_self_certification();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Triggered when the Currency Switcher settings are updated. It updates&nbsp;</div></li><li><div>     * exchange rates automatically, so that they will include any new currency&nbsp;</div></li><li><div>     * that might have been added.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wc_aelia_currencyswitcher_settings_saved() {&nbsp;</div></li><li><div>        self::settings()-&gt;scheduled_update_exchange_rates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds meta boxes to the admin interface.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see add_meta_boxes().&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_meta_boxes() {&nbsp;</div></li><li><div>        add_meta_box('wc_aelia_eu_vat_assistant_order_vat_info_box', &nbsp;</div></li><li><div>                                 __('VAT information', self::$text_domain), &nbsp;</div></li><li><div>                                 array($this, 'render_order_vat_info_box'), &nbsp;</div></li><li><div>                                 'shop_order', &nbsp;</div></li><li><div>                                 'side', &nbsp;</div></li><li><div>                                 'default');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Renders the box with the VAT information associated to an order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int order_id The ID of the target order. If empty, the ID of the&nbsp;</div></li><li><div>     * current post is taken.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function render_order_vat_info_box($order_id = null) {&nbsp;</div></li><li><div>        if(empty($order_id)) {&nbsp;</div></li><li><div>            global $post;&nbsp;</div></li><li><div>            $order_id = $post-&gt;ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order = new Order($order_id);&nbsp;</div></li><li><div>        include_once($this-&gt;path('views') . '/admin/order-vat-info-box.php');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handler for &quot;wc_aelia_eu_vat_assistant_get_order_exchange_rate&quot; hook. It&nbsp;</div></li><li><div>     * just acts as a wrapper for WC_Aelia_EU_VAT_Assistant::get_order_vat_exchange_rate()&nbsp;</div></li><li><div>     * method.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param float default_rate The default exchange rate to return if the order&nbsp;</div></li><li><div>     * doesn't have any.&nbsp;</div></li><li><div>     * @param int order_id The ID of the order from which the exchange rate should&nbsp;</div></li><li><div>     * be retrieved.&nbsp;</div></li><li><div>     * @return float&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wc_aelia_eu_vat_assistant_get_order_exchange_rate($default_rate, $order_id) {&nbsp;</div></li><li><div>        $vat_exchange_rate = $this-&gt;get_order_vat_exchange_rate($order_id);&nbsp;</div></li><li><div>        if($vat_exchange_rate === false) {&nbsp;</div></li><li><div>            $vat_exchange_rate = $default_rate;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $vat_exchange_rate;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the value of a plugin's setting.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed default_value The default value to return if the setting is&nbsp;</div></li><li><div>     * not found.&nbsp;</div></li><li><div>     * @param string setting_key The setting to retrieved.&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wc_aelia_eu_vat_assistant_get_setting($defaut_value, $setting_key) {&nbsp;</div></li><li><div>        return self::settings()-&gt;get($setting_key, $defaut_value);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays a notice when the plugin has not yet been configured.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function settings_notice() {&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;updated woocommerce-message&quot;&gt;&nbsp;</div></li><li><div>            &lt;p&gt;&lt;?php echo __('&lt;strong&gt;EU VAT Assistant&lt;/strong&gt; is almost ready! Please go to ' .&nbsp;</div></li><li><div>                                             '&lt;code&gt;WooCommerce &gt; EU VAT Assistant&lt;/code&gt; settings page to complete the ' .&nbsp;</div></li><li><div>                                             'configuration and start collecting the information required for ' .&nbsp;</div></li><li><div>                                             'EU VAT compliance.', self::$text_domain); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                &lt;a href=&quot;&lt;?php echo admin_url('admin.php?page=' . Definitions::MENU_SLUG); ?&gt;&quot;&nbsp;</div></li><li><div>                     class=&quot;button-primary&quot;&gt;&lt;?php echo __('Go to EU VAT Assistant settings', self::$text_domain); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds elements to the billing address.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array address_parts The various parts of the address (name, company, &nbsp;</div></li><li><div>     * address, etc).&nbsp;</div></li><li><div>     * @param WC_Order order The order from which the address was taken.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     * @see \WC_Order::get_formatted_billing_address()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_order_formatted_billing_address($address_parts, $order) {&nbsp;</div></li><li><div>        $order = new Order(aelia_get_order_id($order));&nbsp;</div></li><li><div>        $address_parts['vat_number'] = $order-&gt;get_customer_vat_number();&nbsp;</div></li><li><div>        return $address_parts;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds tags that will be replaced with additional information on the address, &nbsp;</div></li><li><div>     * such as customers' VAT number.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array replacements The replacement tokens passed by WooCommerce.&nbsp;</div></li><li><div>     * @param array values The values from the billing address.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     * @see \WC_Countries::get_formatted_address()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_formatted_address_replacements($replacements, $values) {&nbsp;</div></li><li><div>        if(!empty($values['vat_number'])) {&nbsp;</div></li><li><div>            $replacements['{vat_number}'] = __('VAT #:', self::$text_domain) . ' ' . $values['vat_number'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $replacements['{vat_number}'] = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $replacements;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Alters the address formats and adds new tokens, such as the VAT number.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array formats An array of address formats.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     * @see \WC_Countries::get_address_formats()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_localisation_address_formats($formats) {&nbsp;</div></li><li><div>        foreach($formats as $format_idx =&gt; $address_format) {&nbsp;</div></li><li><div>            $formats[$format_idx] .= &quot;\n{vat_number}&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $formats;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Overrides the value of the &quot;woocommerce_allowed_countries&quot; setting when&nbsp;</div></li><li><div>     * admin entered a list of countries to which sales are disallowed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed value The original value of the parameter.&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function pre_option_woocommerce_allowed_countries($value) {&nbsp;</div></li><li><div>        /** If we reach this point, it means that the Admin placed some restrictions&nbsp;</div></li><li><div>         * on the list of countries to which he wishes to sell. In such case, the&nbsp;</div></li><li><div>         * &quot;allowed countries&quot; option must be forced to &quot;specific&quot;, so that the list&nbsp;</div></li><li><div>         * of available countries can be filtered.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return 'specific';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Filters the list of countries to which sale is allowed, taking into account&nbsp;</div></li><li><div>     * the ones explicitly disallowed by the administrator.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array countries A list of countries passed by WooCommerce.&nbsp;</div></li><li><div>     * @return array The list of countries, with the disallowed ones removed from&nbsp;</div></li><li><div>     * it.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function woocommerce_countries_allowed_countries($countries) {&nbsp;</div></li><li><div>        $allowed_sale_countries = $this-&gt;allowed_sale_countries;&nbsp;</div></li><li><div>        $disallowed_sale_countries = $this-&gt;get_sale_disallowed_countries();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($disallowed_sale_countries)) {&nbsp;</div></li><li><div>            foreach($disallowed_sale_countries as $disallowed_country) {&nbsp;</div></li><li><div>                if(isset($allowed_sale_countries[$disallowed_country])) {&nbsp;</div></li><li><div>                    unset($allowed_sale_countries[$disallowed_country]);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Debug&nbsp;</div></li><li><div>        //var_dump($allowed_sale_countries);&nbsp;</div></li><li><div>        return $allowed_sale_countries;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ajax handler. Handles the request to collect and store the VAT data related&nbsp;</div></li><li><div>     * to an order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.6.2.160210&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wp_ajax_collect_order_vat_info() {&nbsp;</div></li><li><div>        if(WC_Aelia_EU_VAT_Assistant::settings()-&gt;get(Settings::FIELD_COLLECT_VAT_DATA_FOR_MANUAL_ORDERS, false) &&&nbsp;</div></li><li><div>             Orders_Integration::validate_ajax_request('edit_shop_orders')) {&nbsp;</div></li><li><div>            $order_id = $_REQUEST[Definitions::ARG_COLLECT_ORDER_ID];&nbsp;</div></li><li><div>            $this-&gt;collect_order_vat_info($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            $this-&gt;render_order_vat_info_box($order_id);&nbsp;</div></li><li><div>            $vat_info_box_html = ob_get_contents();&nbsp;</div></li><li><div>            @ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json(array(&nbsp;</div></li><li><div>                'result' =&gt; Definitions::RES_OK, &nbsp;</div></li><li><div>                'vat_info_box_html' =&gt; $vat_info_box_html, &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Collects and saves the VAT data related to an order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int order_id An order ID.&nbsp;</div></li><li><div>     * @since 1.6.2.160210&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function collect_order_vat_info($order_id) {&nbsp;</div></li><li><div>        $order = new Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;vat_number = $order-&gt;get_meta('vat_number', '');&nbsp;</div></li><li><div>        $this-&gt;vat_country = $order-&gt;get_billing_country();&nbsp;</div></li><li><div>        $this-&gt;vat_number_validated = Definitions::VAT_NUMBER_ENTERED_MANUALLY_NOT_VALIDATED;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;save_eu_vat_data($order_id);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.7.2.170306</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.8.170421/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" class="active">1.7.8.170421</a></li><li><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.7.170415/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" class="">1.7.7.170415</a></li><li><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.6.170415/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" class="">1.7.6.170415</a></li><li><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.3.170324/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" class="">1.7.3.170324</a></li><li><a href="http://hookr.io/plugins/woocommerce-eu-vat-assistant/1.7.2.170306/classes/aelia_wc_eu_vat_assistant_wc_aelia_eu_vat_assistant/" class="">1.7.2.170306</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Aelia\WC\EU_VAT_Assistant\WC_Aelia_EU_VAT_Assistant</li><li><span></span>WooCommerce EU VAT Assistant</li><li><span></span>1.7.8.170421</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>