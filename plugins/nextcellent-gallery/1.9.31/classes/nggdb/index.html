<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.9.31" data-slug="nextcellent-gallery" data-type="class" data-id="65228"><head xmlns="http://www.w3.org/1999/xhtml"><title> nggdb | class | Nextcellent Gallery | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="nggdb, class, plugin, nextcellent-gallery, 1.9.31" /><meta name="description" content="NextGEN Gallery Database Class" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.15"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=e77104ee2d0230f087e3bf694645e956' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.15' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/nggdb/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fnggdb%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fnggdb%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-nextcellent-gallery-1.9.31-class-nggdb","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="nggdb" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to nextcellent-gallery." href="http://hookr.io/plugins/nextcellent-gallery/" class="plugin"><span property="name">nextcellent-gallery</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.31." href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/" class="H_VERSION"><span property="name">1.9.31</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">nggdb</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="202"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/all/" title="All">All <span class="count badge">202</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="87"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/hooks/" title="Hooks">Hooks <span class="count badge">87</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="57"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/filters/" title="Filters">Filters <span class="count badge">57</span></a></li><li class="active" data-id="class" data-count="46"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/classes/" title="Classes">Classes <span class="count badge">46</span></a></li><li class="" data-id="constant" data-count="13"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/constants/" title="Constants">Constants <span class="count badge">13</span></a></li><li class="" data-id="function" data-count="40"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/functions/" title="Functions">Functions <span class="count badge">40</span></a></li><li class="" data-id="shortcode" data-count="16"><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">16</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>nggdb</strong></h1><p>NextGEN Gallery Database Class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/files/lib-ngg-db/" class="file">/lib/ngg-db.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="10" class="block" start="10"><li><div>class nggdb {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds the list of all galleries&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.1.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var object|array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $galleries = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds the list of all images&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var object|array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $images = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds the list of all albums&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var object|array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $albums = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The array for the pagination&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.1.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $paged = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Init the Database Abstraction layer for NextGEN Gallery&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;galleries = array();&nbsp;</div></li><li><div>        $this-&gt;images = array();&nbsp;</div></li><li><div>        $this-&gt;albums = array();&nbsp;</div></li><li><div>        $this-&gt;paged = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        register_shutdown_function(array(&$this, '__destruct'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * PHP5 style destructor and will run when database object is destroyed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool Always true&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function __destruct() {&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all the album and unserialize the content&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.0&nbsp;</div></li><li><div>     * @param string $order_by&nbsp;</div></li><li><div>     * @param string $order_dir&nbsp;</div></li><li><div>     * @param int $limit number of albums, 0 shows all albums&nbsp;</div></li><li><div>     * @param int $start the start index for paged albums&nbsp;</div></li><li><div>     * @return array $album&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function find_all_album( $order_by = 'id', $order_dir = 'ASC', $limit = 0, $start = 0) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_dir = ( $order_dir == 'DESC') ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>        $limit_by = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($start) . ', ' . intval($limit) : '';&nbsp;</div></li><li><div>        $this-&gt;albums = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;nggalbum ORDER BY {$order_by} {$order_dir} {$limit_by}&quot; , OBJECT_K );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$this-&gt;albums )&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($this-&gt;albums as $key =&gt; $value) {&nbsp;</div></li><li><div>            $this-&gt;albums[$key]-&gt;galleries = empty ($this-&gt;albums[$key]-&gt;sortorder) ? array() : (array) unserialize($this-&gt;albums[$key]-&gt;sortorder)  ;&nbsp;</div></li><li><div>            $this-&gt;albums[$key]-&gt;name = stripslashes( $this-&gt;albums[$key]-&gt;name );&nbsp;</div></li><li><div>            $this-&gt;albums[$key]-&gt;albumdesc = stripslashes( $this-&gt;albums[$key]-&gt;albumdesc );&nbsp;</div></li><li><div>            wp_cache_add($key, $this-&gt;albums[$key], 'ngg_album');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;albums;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    static function count_galleries() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( &quot;SELECT COUNT(*) FROM $wpdb-&gt;nggallery&quot; );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param $id int The gallery ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function count_images_in_gallery( $id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT(*) FROM $wpdb-&gt;nggpictures WHERE galleryid = %d&quot;, $id ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all the galleries&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $order_by&nbsp;</div></li><li><div>     * @param string $order_dir&nbsp;</div></li><li><div>     * @param bool $counter (optional) Select true  when you need to count the images&nbsp;</div></li><li><div>     * @param int $limit number of paged galleries, 0 shows all galleries&nbsp;</div></li><li><div>     * @param int $start the start index for paged galleries&nbsp;</div></li><li><div>     * @param bool $exclude&nbsp;</div></li><li><div>     * @return array $galleries&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function find_all_galleries($order_by = 'gid', $order_dir = 'ASC', $counter = false, $limit = 0, $start = 0, $exclude = true) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for the exclude setting&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? ' AND exclude&lt;&gt;1 ' : '';&nbsp;</div></li><li><div>        $order_dir = ( $order_dir == 'DESC') ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>        $limit_by = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($start) . ', ' . intval($limit) : '';&nbsp;</div></li><li><div>        $this-&gt;galleries = $wpdb-&gt;get_results( &quot;SELECT SQL_CALC_FOUND_ROWS * FROM $wpdb-&gt;nggallery ORDER BY {$order_by} {$order_dir} {$limit_by}&quot;, OBJECT_K );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Count the number of galleries and calculate the pagination&nbsp;</div></li><li><div>        if ($limit &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;paged['total_objects'] = intval ( $wpdb-&gt;get_var( &quot;SELECT FOUND_ROWS()&quot; ) );&nbsp;</div></li><li><div>            $this-&gt;paged['objects_per_page'] = max ( count( $this-&gt;galleries ), $limit );&nbsp;</div></li><li><div>            $this-&gt;paged['max_objects_per_page'] = ( $limit &gt; 0 ) ? ceil( $this-&gt;paged['total_objects'] / intval($limit)) : 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$this-&gt;galleries )&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the galleries information&nbsp;</div></li><li><div>        foreach ($this-&gt;galleries as $key =&gt; $value) {&nbsp;</div></li><li><div>            $galleriesID[] = $key;&nbsp;</div></li><li><div>            // init the counter values&nbsp;</div></li><li><div>            $this-&gt;galleries[$key]-&gt;counter = 0;&nbsp;</div></li><li><div>            $this-&gt;galleries[$key]-&gt;title = stripslashes($this-&gt;galleries[$key]-&gt;title);&nbsp;</div></li><li><div>            $this-&gt;galleries[$key]-&gt;galdesc = stripslashes($this-&gt;galleries[$key]-&gt;galdesc);&nbsp;</div></li><li><div>            $this-&gt;galleries[$key]-&gt;abspath = WINABSPATH . $this-&gt;galleries[$key]-&gt;path;&nbsp;</div></li><li><div>            wp_cache_add($key, $this-&gt;galleries[$key], 'ngg_gallery');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if we didn't need to count the images then stop here&nbsp;</div></li><li><div>        if ( !$counter )&nbsp;</div></li><li><div>            return $this-&gt;galleries;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the counter values&nbsp;</div></li><li><div>        $picturesCounter = $wpdb-&gt;get_results('SELECT galleryid, COUNT(*) as counter FROM '.$wpdb-&gt;nggpictures.' WHERE galleryid IN (\''.implode('\', \'', $galleriesID).'\') ' . $exclude_clause . ' GROUP BY galleryid', OBJECT_K);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$picturesCounter )&nbsp;</div></li><li><div>            return $this-&gt;galleries;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the counter to the gallery objekt&nbsp;</div></li><li><div>        foreach ($picturesCounter as $key =&gt; $value) {&nbsp;</div></li><li><div>            $this-&gt;galleries[$value-&gt;galleryid]-&gt;counter = $value-&gt;counter;&nbsp;</div></li><li><div>            wp_cache_set($value-&gt;galleryid, $this-&gt;galleries[$value-&gt;galleryid], 'ngg_gallery');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;galleries;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a gallery given its ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|string $id or $slug&nbsp;</div></li><li><div>     * @return A nggGallery object (null if not found)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_gallery( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric($id) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $gallery = wp_cache_get($id, 'ngg_gallery') )&nbsp;</div></li><li><div>                return $gallery;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $gallery = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;nggallery WHERE gid = %d&quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            $gallery = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;nggallery WHERE slug = %s&quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build the object from the query result&nbsp;</div></li><li><div>        if ($gallery) {&nbsp;</div></li><li><div>            // it was a bad idea to use a object, stripslashes_deep() could not used here, learn from it&nbsp;</div></li><li><div>            $gallery-&gt;title = stripslashes($gallery-&gt;title);&nbsp;</div></li><li><div>            $gallery-&gt;galdesc = stripslashes($gallery-&gt;galdesc);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $gallery-&gt;abspath = WINABSPATH . $gallery-&gt;path;&nbsp;</div></li><li><div>            //TODO:Possible failure , $id could be a number or name&nbsp;</div></li><li><div>            wp_cache_add($id, $gallery, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $gallery;&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This function return all information about the gallery and the images inside&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|string $id or $name&nbsp;</div></li><li><div>     * @param string $order_by&nbsp;</div></li><li><div>     * @param string $order_dir (ASC |DESC)&nbsp;</div></li><li><div>     * @param bool $exclude&nbsp;</div></li><li><div>     * @param int $limit number of paged galleries, 0 shows all galleries&nbsp;</div></li><li><div>     * @param int $start the start index for paged galleries&nbsp;</div></li><li><div>     * @param bool $json remove the key for associative array in json request&nbsp;</div></li><li><div>     * @return An array containing the nggImage objects representing the images in the gallery.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_gallery($id, $order_by = 'sortorder', $order_dir = 'ASC', $exclude = true, $limit = 0, $start = 0, $json = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // init the gallery as empty array&nbsp;</div></li><li><div>        $gallery = array();&nbsp;</div></li><li><div>        $i = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for the exclude setting&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? ' AND tt.exclude&lt;&gt;1 ' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Say no to any other value&nbsp;</div></li><li><div>        $order_dir = ( $order_dir == 'DESC') ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>        $order_by = ( empty($order_by) ) ? 'sortorder' : $order_by;&nbsp;</div></li><li><div>        $order_clause = &quot;ABS(tt.{$order_by}) {$order_dir}, tt.{$order_by} {$order_dir}&quot;;&nbsp;</div></li><li><div>//        $order_clause = &quot;LENGTH(tt.{$order_by}) {$order_dir}, tt.{$order_by} {$order_dir}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Should we limit this query ?&nbsp;</div></li><li><div>        $limit_by = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($start) . ', ' . intval($limit) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database&nbsp;</div></li><li><div>        if( is_numeric($id) )&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT SQL_CALC_FOUND_ROWS tt.*, t.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE t.gid = %d {$exclude_clause} ORDER BY {$order_clause} {$limit_by}&quot;, $id ), OBJECT_K );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT SQL_CALC_FOUND_ROWS tt.*, t.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE t.slug = %s {$exclude_clause} ORDER BY {$order_clause} {$limit_by}&quot;, $id ), OBJECT_K );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Count the number of images and calculate the pagination&nbsp;</div></li><li><div>        if ($limit &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;paged['total_objects'] = intval ( $wpdb-&gt;get_var( &quot;SELECT FOUND_ROWS()&quot; ) );&nbsp;</div></li><li><div>            $this-&gt;paged['objects_per_page'] = max ( count( $result ), $limit );&nbsp;</div></li><li><div>            $this-&gt;paged['max_objects_per_page'] = ( $limit &gt; 0 ) ? ceil( $this-&gt;paged['total_objects'] / intval($limit)) : 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build the object&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Now added all image data&nbsp;</div></li><li><div>            foreach ($result as $key =&gt; $value) {&nbsp;</div></li><li><div>                // due to a browser bug we need to remove the key for associative array for json request&nbsp;</div></li><li><div>                // (see http://code.google.com/p/chromium/issues/detail?id=883)&nbsp;</div></li><li><div>                if ($json) $key = $i++;&nbsp;</div></li><li><div>                $gallery[$key] = new nggImage( $value ); // keep in mind each request require 8-16 kb memory usage&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Could not add to cache, the structure is different to find_gallery() cache_add, need rework&nbsp;</div></li><li><div>        //wp_cache_add($id, $gallery, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $gallery;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This function return all information about the gallery and the images inside&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|string $id or $name&nbsp;</div></li><li><div>     * @param string $orderby&nbsp;</div></li><li><div>     * @param string $order (ASC |DESC)&nbsp;</div></li><li><div>     * @param bool $exclude&nbsp;</div></li><li><div>     * @return array An array containing the nggImage objects representing the images in the gallery.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function get_ids_from_gallery($id, $order_by = 'sortorder', $order_dir = 'ASC', $exclude = true) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for the exclude setting&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? ' AND tt.exclude&lt;&gt;1 ' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Say no to any other value&nbsp;</div></li><li><div>        $order_dir = ( $order_dir == 'DESC') ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>        $order_by = ( empty($order_by) ) ? 'sortorder' : $order_by;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database&nbsp;</div></li><li><div>        if( is_numeric($id) )&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT tt.pid FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE t.gid = %d $exclude_clause ORDER BY tt.{$order_by} $order_dir&quot;, $id ) );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT tt.pid FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE t.slug = %s $exclude_clause ORDER BY tt.{$order_by} $order_dir&quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a gallery AND all the pictures associated to this gallery!&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @id The gallery ID&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function delete_gallery( $id ) {&nbsp;</div></li><li><div>        global $wpdb, $nggdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM $wpdb-&gt;nggpictures WHERE galleryid = %d&quot;, $id) );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM $wpdb-&gt;nggallery WHERE gid = %d&quot;, $id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete($id, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //TODO:Remove all tag relationship&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Update the galleries to remove the deleted ID's&nbsp;</div></li><li><div>        $albums = $nggdb-&gt;find_all_album();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($albums as $album) {&nbsp;</div></li><li><div>            $albumid = $album-&gt;id;&nbsp;</div></li><li><div>            $galleries = $album-&gt;galleries;&nbsp;</div></li><li><div>            $deleted = array_search($id, $galleries);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset($galleries[$deleted]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $new_galleries = serialize($galleries);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            nggdb::update_album($albumid, false, false, false, $new_galleries);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an album given its ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @id The album ID or name&nbsp;</div></li><li><div>     * @return A nggGallery object (false if not found)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_album( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database&nbsp;</div></li><li><div>        if ( is_numeric($id) && $id != 0 ) {&nbsp;</div></li><li><div>            if ( $album = wp_cache_get($id, 'ngg_album') )&nbsp;</div></li><li><div>                return $album;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $album = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;nggalbum WHERE id = %d&quot;, $id) );&nbsp;</div></li><li><div>        } elseif ( $id == 'all' || (is_numeric($id) && $id == 0) ) {&nbsp;</div></li><li><div>            // init the object and fill it&nbsp;</div></li><li><div>            $album = new stdClass();&nbsp;</div></li><li><div>            $album-&gt;id = 'all';&nbsp;</div></li><li><div>            $album-&gt;name = __('Album overview', 'nggallery');&nbsp;</div></li><li><div>            $album-&gt;albumdesc = __('Album overview', 'nggallery');&nbsp;</div></li><li><div>            $album-&gt;previewpic = 0;&nbsp;</div></li><li><div>            $album-&gt;sortorder =  serialize( $wpdb-&gt;get_col(&quot;SELECT gid FROM $wpdb-&gt;nggallery&quot;) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $album = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;nggalbum WHERE slug = %s&quot;, $id) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unserialize the galleries inside the album&nbsp;</div></li><li><div>        if ( $album ) {&nbsp;</div></li><li><div>            if ( !empty( $album-&gt;sortorder ) )&nbsp;</div></li><li><div>                $album-&gt;gallery_ids = unserialize( $album-&gt;sortorder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // it was a bad idea to use a object, stripslashes_deep() could not used here, learn from it&nbsp;</div></li><li><div>            $album-&gt;albumdesc = stripslashes($album-&gt;albumdesc);&nbsp;</div></li><li><div>            $album-&gt;name = stripslashes($album-&gt;name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_cache_add($album-&gt;id, $album, 'ngg_album');&nbsp;</div></li><li><div>            return $album;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete an album&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @id The album ID&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function delete_album( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM $wpdb-&gt;nggalbum WHERE id = %d&quot;, $id) );&nbsp;</div></li><li><div>        wp_cache_delete($id, 'ngg_album');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Insert an image in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return the ID of the inserted image&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function insert_image($gid, $filename, $alttext, $desc, $exclude) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query(&nbsp;</div></li><li><div>              &quot;INSERT INTO $wpdb-&gt;nggpictures (galleryid, filename, description, alttext, exclude) VALUES &quot;&nbsp;</div></li><li><div>            . &quot;('$gid', '$filename', '$desc', '$alttext', '$exclude');&quot;);&nbsp;</div></li><li><div>        $pid = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>        wp_cache_delete($gid, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $pid;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * nggdb::update_image() - Update an image in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $pid   id of the image&nbsp;</div></li><li><div>     * @param (optional) string|int $galleryid&nbsp;</div></li><li><div>     * @param (optional) string $filename&nbsp;</div></li><li><div>     * @param (optional) string $description&nbsp;</div></li><li><div>     * @param (optional) string $alttext&nbsp;</div></li><li><div>     * @param (optional) int $exclude (0 or 1)&nbsp;</div></li><li><div>     * @param (optional) int $sortorder&nbsp;</div></li><li><div>     * @return bool result of update query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function update_image($pid, $galleryid = false, $filename = false, $description = false, $alttext = false, $exclude = false, $sortorder = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = array();&nbsp;</div></li><li><div>        $pid = (int) $pid;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // slug must be unique, we use the alttext for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $alttext ), 'image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $update = array(&nbsp;</div></li><li><div>            'image_slug' =&gt; $slug, &nbsp;</div></li><li><div>            'galleryid' =&gt; $galleryid, &nbsp;</div></li><li><div>            'filename' =&gt; $filename, &nbsp;</div></li><li><div>            'description' =&gt; $description, &nbsp;</div></li><li><div>            'alttext' =&gt; $alttext, &nbsp;</div></li><li><div>            'exclude' =&gt; $exclude, &nbsp;</div></li><li><div>            'sortorder' =&gt; $sortorder);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the sql parameter &quot;name = value&quot;&nbsp;</div></li><li><div>        foreach ($update as $key =&gt; $value)&nbsp;</div></li><li><div>            if ($value !== false)&nbsp;</div></li><li><div>                $sql[] = $key . &quot; = '&quot; . $value . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the final string&nbsp;</div></li><li><div>        $sql = implode(', ', $sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty($sql) && $pid != 0)&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( &quot;UPDATE $wpdb-&gt;nggpictures SET $sql WHERE pid = $pid&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete($pid, 'ngg_image');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>     /**&nbsp;</div></li><li><div>     * nggdb::update_gallery() - Update an gallery in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since V1.7.0&nbsp;</div></li><li><div>     * @param int $id   id of the gallery&nbsp;</div></li><li><div>     * @param (optional) string $title or name of the gallery&nbsp;</div></li><li><div>     * @param (optional) string $path&nbsp;</div></li><li><div>     * @param (optional) string $description&nbsp;</div></li><li><div>     * @param (optional) int $pageid&nbsp;</div></li><li><div>     * @param (optional) int $previewpic&nbsp;</div></li><li><div>     * @param (optional) int $author&nbsp;</div></li><li><div>     * @return bool result of update query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function update_gallery($id, $name = false, $path = false, $title = false, $description = false, $pageid = false, $previewpic = false, $author = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = array();&nbsp;</div></li><li><div>        $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // slug must be unique, we use the title for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $title ), 'gallery' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $update = array(&nbsp;</div></li><li><div>            'name' =&gt; $name, &nbsp;</div></li><li><div>            'slug' =&gt; $slug, &nbsp;</div></li><li><div>            'path' =&gt; $path, &nbsp;</div></li><li><div>            'title' =&gt; $title, &nbsp;</div></li><li><div>            'galdesc' =&gt; $description, &nbsp;</div></li><li><div>            'pageid' =&gt; $pageid, &nbsp;</div></li><li><div>            'previewpic' =&gt; $previewpic, &nbsp;</div></li><li><div>            'author' =&gt; $author);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the sql parameter &quot;name = value&quot;&nbsp;</div></li><li><div>        foreach ($update as $key =&gt; $value)&nbsp;</div></li><li><div>            if ($value !== false)&nbsp;</div></li><li><div>                $sql[] = $key . &quot; = '&quot; . $value . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the final string&nbsp;</div></li><li><div>        $sql = implode(', ', $sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty($sql) && $id != 0)&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( &quot;UPDATE $wpdb-&gt;nggallery SET $sql WHERE gid = $id&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete($id, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>     /**&nbsp;</div></li><li><div>     * nggdb::update_album() - Update an album in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since V1.7.0&nbsp;</div></li><li><div>     * @param int $ id   id of the album&nbsp;</div></li><li><div>     * @param (optional) string $title&nbsp;</div></li><li><div>     * @param (optional) int $previewpic&nbsp;</div></li><li><div>     * @param (optional) string $description&nbsp;</div></li><li><div>     * @param (optional) serialized array $sortorder&nbsp;</div></li><li><div>     * @param (optional) int $pageid&nbsp;</div></li><li><div>     * @return bool result of update query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function update_album($id, $name = false, $previewpic = false, $description = false, $sortorder = false, $pageid = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = array();&nbsp;</div></li><li><div>        $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // slug must be unique, we use the title for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $name ), 'album' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $update = array(&nbsp;</div></li><li><div>            'name' =&gt; $name, &nbsp;</div></li><li><div>            'slug' =&gt; $slug, &nbsp;</div></li><li><div>            'previewpic' =&gt; $previewpic, &nbsp;</div></li><li><div>            'albumdesc' =&gt; $description, &nbsp;</div></li><li><div>            'sortorder' =&gt; $sortorder, &nbsp;</div></li><li><div>            'pageid' =&gt; $pageid);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the sql parameter &quot;name = value&quot;&nbsp;</div></li><li><div>        foreach ($update as $key =&gt; $value)&nbsp;</div></li><li><div>            if ($value !== false)&nbsp;</div></li><li><div>                $sql[] = $key . &quot; = '&quot; . $value . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the final string&nbsp;</div></li><li><div>        $sql = implode(', ', $sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty($sql) && $id != 0)&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( &quot;UPDATE $wpdb-&gt;nggalbum SET $sql WHERE id = $id&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete($id, 'ngg_album');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an image given its ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int|string The image ID or Slug&nbsp;</div></li><li><div>     * @return nggImage|bool The image, or false if it wasn't found.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_image( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric($id) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $image = wp_cache_get($id, 'ngg_image') )&nbsp;</div></li><li><div>                return $image;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT tt.*, t.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE tt.pid = %d &quot;, $id ) );&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT tt.*, t.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE tt.image_slug = %s &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build the object from the query result&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>            $image = new nggImage($result);&nbsp;</div></li><li><div>            return $image;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get images given a list of IDs&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $pids array of picture_ids&nbsp;</div></li><li><div>     * @return An array of nggImage objects representing the images&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_images_in_list( $pids, $exclude = false, $order = 'NOTSET') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $qry = nggdb::find_images_query( $pids, $exclude, $order); //Build query to get images&nbsp;</div></li><li><div>        $images =$wpdb-&gt;get_results($qry, OBJECT_K);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = array(); // Build the image objects from the query result&nbsp;</div></li><li><div>        if ($images) {&nbsp;</div></li><li><div>            foreach ($images as $key =&gt; $image)&nbsp;</div></li><li><div>                $result[$key] = new nggImage( $image );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Return sql query to get images&nbsp;</div></li><li><div>     * 20150110: workarounded case if $pids is a string or numeric value. Makes function more flexible, yet there is no case where&nbsp;</div></li><li><div>     * this functions is called using string/numeric...&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $pids array of Picture Ids | id value (string or integer) which is converted to array.&nbsp;</div></li><li><div>     * @param $exclude Boolean true to exclude images with field exclude set&nbsp;</div></li><li><div>     * @param $sort_dir  String order direction. Options: ASC, DESC, RAND and NOTSET where natural sort is used.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_images_query( $pids, $exclude = false , $sort_dir = 'NOTSET') {&nbsp;</div></li><li><div>        global $ngg, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Try to convert if there is one element.&nbsp;</div></li><li><div>        //TODO: empty or invalid arrays should be avoided. (they will make an invalid query)&nbsp;</div></li><li><div>        if (!is_array($pids)) {&nbsp;</div></li><li><div>            $pids= array($pids); //create one-element array&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? &quot; AND t.exclude &lt;&gt; 1&quot; : &quot;&quot;; //exclude images if required (notice one  space before, none after)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($sort_dir ==&quot;RAND&quot;) {&nbsp;</div></li><li><div>            $order_clause = &quot; ORDER BY rand()&quot;; //notice one space before, none after&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //get Sort field and sort direction to make order by sentence&nbsp;</div></li><li><div>            $sort_dir = ($sort_dir == 'NOTSET') ? $ngg-&gt;options['galSortDir'] : $sort_dir;&nbsp;</div></li><li><div>            $sort_field = $ngg-&gt;options['galSort'];&nbsp;</div></li><li><div>            $order_clause = &quot; ORDER BY t.$sort_field $sort_dir&quot;; //notice one space before, none after&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $id_list = &quot;'&quot; . implode(&quot;', '&quot;, $pids) . &quot;'&quot;;&nbsp;</div></li><li><div>        //notice NO spaces between $exclude_clause and $order_clause on purpose&nbsp;</div></li><li><div>        return &quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggpictures AS t INNER JOIN $wpdb-&gt;nggallery AS tt ON t.galleryid = tt.gid WHERE t.pid IN ($id_list)$exclude_clause$order_clause&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Add an image to the database&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @since V1.4.0&nbsp;</div></li><li><div>    * @param int $pid   id of the gallery&nbsp;</div></li><li><div>    * @param (optional) string|int $galleryid&nbsp;</div></li><li><div>    * @param (optional) string $filename&nbsp;</div></li><li><div>    * @param (optional) string $description&nbsp;</div></li><li><div>    * @param (optional) string $alttext&nbsp;</div></li><li><div>    * @param (optional) array $meta data&nbsp;</div></li><li><div>    * @param (optional) int $post_id (required for sync with WP media lib)&nbsp;</div></li><li><div>    * @param (optional) string $imagedate&nbsp;</div></li><li><div>    * @param (optional) int $exclude (0 or 1)&nbsp;</div></li><li><div>    * @param (optional) int $sortorder&nbsp;</div></li><li><div>    * @return bool result of the ID of the inserted image&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    static function add_image( $id = false, $filename = false, $description = '', $alttext = '', $meta_data = false, $post_id = 0, $imagedate = '0000-00-00 00:00:00', $exclude = 0, $sortorder = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array($meta_data) )&nbsp;</div></li><li><div>            $meta_data = serialize($meta_data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // slug must be unique, we use the alttext for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $alttext ), 'image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add the image&nbsp;</div></li><li><div>        if ( false === $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;nggpictures (image_slug, galleryid, filename, description, alttext, meta_data, post_id, imagedate, exclude, sortorder)&nbsp;</div></li><li><div>                                                     VALUES (%s, %d, %s, %s, %s, %s, %d, %s, %d, %d)&quot;, $slug, $id, $filename, $description, $alttext, $meta_data, $post_id, $imagedate, $exclude, $sortorder ) ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $imageID = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove from cache the galley, needs to be rebuild now&nbsp;</div></li><li><div>        wp_cache_delete( $id, 'ngg_gallery');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //and give me the new id&nbsp;</div></li><li><div>        return $imageID;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Add an album to the database&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @since V1.7.0&nbsp;</div></li><li><div>    * @param (optional) string $title&nbsp;</div></li><li><div>    * @param (optional) int $previewpic&nbsp;</div></li><li><div>    * @param (optional) string $description&nbsp;</div></li><li><div>    * @param (optional) serialized array $sortorder&nbsp;</div></li><li><div>    * @param (optional) int $pageid&nbsp;</div></li><li><div>    * @return bool result of the ID of the inserted album&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    static function add_album( $name = false, $previewpic = 0, $description = '', $sortorder = 0, $pageid = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // name must be unique, we use the title for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $name ), 'album' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add the album&nbsp;</div></li><li><div>        if ( false === $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;nggalbum (name, slug, previewpic, albumdesc, sortorder, pageid)&nbsp;</div></li><li><div>                                                     VALUES (%s, %s, %d, %s, %s, %d)&quot;, $name, $slug, $previewpic, $description, $sortorder, $pageid ) ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $albumID = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //and give me the new id&nbsp;</div></li><li><div>        return $albumID;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Add an gallery to the database&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @since V1.7.0&nbsp;</div></li><li><div>    * @param (optional) string $title or name of the gallery&nbsp;</div></li><li><div>    * @param (optional) string $path&nbsp;</div></li><li><div>    * @param (optional) string $description&nbsp;</div></li><li><div>    * @param (optional) int $pageid&nbsp;</div></li><li><div>    * @param (optional) int $previewpic&nbsp;</div></li><li><div>    * @param (optional) int $author&nbsp;</div></li><li><div>    * @return bool|int result of the ID of the inserted gallery&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    static function add_gallery( $title = '', $path = '', $description = '', $pageid = 0, $previewpic = 0, $author = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // slug must be unique, we use the title for that&nbsp;</div></li><li><div>        $slug = nggdb::get_unique_slug( sanitize_title( $title ), 'gallery' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Note : The field 'name' is deprecated, it's currently kept only for compat reason with older shortcodes, we copy the slug into this field&nbsp;</div></li><li><div>        if ( false === $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;nggallery (name, slug, path, title, galdesc, pageid, previewpic, author)&nbsp;</div></li><li><div>                                                     VALUES (%s, %s, %s, %s, %s, %d, %d, %d)&quot;, $slug, $slug, $path, $title, $description, $pageid, $previewpic, $author ) ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $galleryID = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //and give me the new id&nbsp;</div></li><li><div>        return $galleryID;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Delete an image entry from the database&nbsp;</div></li><li><div>    * @param integer $id is the Image ID&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    static function delete_image( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete the image&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM $wpdb-&gt;nggpictures WHERE pid = %d&quot;, $id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete tag references&nbsp;</div></li><li><div>        wp_delete_object_term_relationships( $id, 'ngg_tag');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove from cache&nbsp;</div></li><li><div>        wp_cache_delete( $id, 'ngg_image');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the last images registered in the database with a maximum number of $limit results&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer $page start offset as page number (0, 1, 2, 3, 4...)&nbsp;</div></li><li><div>     * @param integer $limit the number of result&nbsp;</div></li><li><div>     * @param bool $exclude do not show exluded images&nbsp;</div></li><li><div>     * @param int $galleryId Only look for images with this gallery id, or in all galleries if id is 0&nbsp;</div></li><li><div>     * @param string $orderby is one of &quot;id&quot; (default, order by pid), &quot;date&quot; (order by exif date), sort (order by user sort order)&nbsp;</div></li><li><div>     * @return&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_last_images($page = 0, $limit = 30, $exclude = true, $galleryId = 0, $orderby = &quot;id&quot;) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for the exclude setting&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? ' AND exclude&lt;&gt;1 ' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // a limit of 0 makes no sense&nbsp;</div></li><li><div>        $limit = ($limit == 0) ? 30 : $limit;&nbsp;</div></li><li><div>        // calculate the offset based on the pagr number&nbsp;</div></li><li><div>        $offset = (int) $page * $limit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $galleryId = (int) $galleryId;&nbsp;</div></li><li><div>        $gallery_clause = ($galleryId === 0) ? '' : ' AND galleryid = ' . $galleryId . ' ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // default order by pid&nbsp;</div></li><li><div>        $order = 'pid DESC';&nbsp;</div></li><li><div>        switch ($orderby) {&nbsp;</div></li><li><div>            case 'date':&nbsp;</div></li><li><div>                $order = 'imagedate DESC';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'sort':&nbsp;</div></li><li><div>                $order = 'sortorder ASC';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        $gallery_cache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database&nbsp;</div></li><li><div>        $images = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;nggpictures WHERE 1=1 $exclude_clause $gallery_clause ORDER BY $order LIMIT $offset, $limit&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build the object from the query result&nbsp;</div></li><li><div>        if ($images) {&nbsp;</div></li><li><div>            foreach ($images as $key =&gt; $image) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // cache a gallery , so we didn't need to lookup twice&nbsp;</div></li><li><div>                if (!array_key_exists($image-&gt;galleryid, $gallery_cache))&nbsp;</div></li><li><div>                    $gallery_cache[$image-&gt;galleryid] = nggdb::find_gallery($image-&gt;galleryid);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Join gallery information with picture information&nbsp;</div></li><li><div>                foreach ($gallery_cache[$image-&gt;galleryid] as $index =&gt; $value)&nbsp;</div></li><li><div>                    $image-&gt;$index = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Now get the complete image data&nbsp;</div></li><li><div>                $result[$key] = new nggImage( $image );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * nggdb::get_random_images() - Get an random image from one ore more gally&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer $number of images&nbsp;</div></li><li><div>     * @param integer $galleryID optional a Gallery&nbsp;</div></li><li><div>     * @return A nggImage object representing the image (null if not found)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function get_random_images($number = 1, $galleryID = 0) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $number = (int) $number;&nbsp;</div></li><li><div>        $galleryID = (int) $galleryID;&nbsp;</div></li><li><div>        $images = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database&nbsp;</div></li><li><div>        if ($galleryID == 0)&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_results(&quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE tt.exclude != 1 ORDER by rand() limit $number&quot;);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_results(&quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE t.gid = $galleryID AND tt.exclude != 1 ORDER by rand() limit {$number}&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return the object from the query result&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>            foreach ($result as $image) {&nbsp;</div></li><li><div>                $images[] = new nggImage( $image );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $images;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all the images from a given album&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param object|int $album The album object or the id&nbsp;</div></li><li><div>     * @param string $order_by&nbsp;</div></li><li><div>     * @param string $order_dir&nbsp;</div></li><li><div>     * @param bool $exclude&nbsp;</div></li><li><div>     * @return An array containing the nggImage objects representing the images in the album.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function find_images_in_album($album, $order_by = 'galleryid', $order_dir = 'ASC', $exclude = true) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !is_object($album) )&nbsp;</div></li><li><div>            $album = nggdb::find_album( $album );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get gallery list&nbsp;</div></li><li><div>        $gallery_list = implode(', ', $album-&gt;gallery_ids);&nbsp;</div></li><li><div>        // Check for the exclude setting&nbsp;</div></li><li><div>        $exclude_clause = ($exclude) ? ' AND tt.exclude&lt;&gt;1 ' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Say no to any other value&nbsp;</div></li><li><div>        $order_dir = ( $order_dir == 'DESC') ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>        $order_by = ( empty($order_by) ) ? 'galleryid' : $order_by;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_results(&quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE tt.galleryid IN ($gallery_list) $exclude_clause ORDER BY tt.$order_by $order_dir&quot;);&nbsp;</div></li><li><div>        // Return the object from the query result&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>            foreach ($result as $image) {&nbsp;</div></li><li><div>                $images[] = new nggImage( $image );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $images;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * search for images and return the result&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.0&nbsp;</div></li><li><div>     * @param string $request&nbsp;</div></li><li><div>     * @param int $limit number of results, 0 shows all results&nbsp;</div></li><li><div>     * @return Array Result of the request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function search_for_images( $request, $limit = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If a search pattern is specified, load the posts that match&nbsp;</div></li><li><div>        if ( !empty($request) ) {&nbsp;</div></li><li><div>            // added slashes screw with quote grouping when done early, so done later&nbsp;</div></li><li><div>            $request = stripslashes($request);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // split the words it a array if separated by a space or comma&nbsp;</div></li><li><div>            preg_match_all('/&quot;.*?(&quot;|$)|((?&lt;=[\\s&quot;, +])|^)[^\\s&quot;, +]+/', $request, $matches);&nbsp;</div></li><li><div>            $search_terms = array_map(create_function('$a', 'return trim($a, &quot;\\&quot;\'\\n\\r &quot;);'), $matches[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $n = '%';&nbsp;</div></li><li><div>            $searchand = '';&nbsp;</div></li><li><div>            $search = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach( (array) $search_terms as $term) {&nbsp;</div></li><li><div>                $term = addslashes_gpc($term);&nbsp;</div></li><li><div>                $search .= &quot;{$searchand}((tt.description LIKE '{$n}{$term}{$n}') OR (tt.alttext LIKE '{$n}{$term}{$n}') OR (tt.filename LIKE '{$n}{$term}{$n}'))&quot;;&nbsp;</div></li><li><div>                $searchand = ' AND ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = esc_sql($request);&nbsp;</div></li><li><div>            if (count($search_terms) &gt; 1 && $search_terms[0] != $request )&nbsp;</div></li><li><div>                $search .= &quot; OR (tt.description LIKE '{$n}{$term}{$n}') OR (tt.alttext LIKE '{$n}{$term}{$n}') OR (tt.filename LIKE '{$n}{$term}{$n}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !empty($search) )&nbsp;</div></li><li><div>                $search = &quot; AND ({$search}) &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $limit_by = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($limit) : '';&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // build the final query&nbsp;</div></li><li><div>        $query = &quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE 1=1 $search ORDER BY tt.pid ASC $limit_by&quot;;&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // TODO: Currently we didn't support a proper pagination&nbsp;</div></li><li><div>        $this-&gt;paged['total_objects'] = $this-&gt;paged['objects_per_page'] = intval ( $wpdb-&gt;get_var( &quot;SELECT FOUND_ROWS()&quot; ) );&nbsp;</div></li><li><div>        $this-&gt;paged['max_objects_per_page'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return the object from the query result&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>            foreach ($result as $image) {&nbsp;</div></li><li><div>                $images[] = new nggImage( $image );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $images;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * search for galleries and return the result&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.7.0&nbsp;</div></li><li><div>     * @param string $request&nbsp;</div></li><li><div>     * @param int $limit number of results, 0 shows all results&nbsp;</div></li><li><div>     * @return Array Result of the request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function search_for_galleries( $request, $limit = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If a search pattern is specified, load the posts that match&nbsp;</div></li><li><div>        if ( !empty($request) ) {&nbsp;</div></li><li><div>            // added slashes screw with quote grouping when done early, so done later&nbsp;</div></li><li><div>            $request = stripslashes($request);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // split the words it a array if separated by a space or comma&nbsp;</div></li><li><div>            preg_match_all('/&quot;.*?(&quot;|$)|((?&lt;=[\\s&quot;, +])|^)[^\\s&quot;, +]+/', $request, $matches);&nbsp;</div></li><li><div>            $search_terms = array_map(create_function('$a', 'return trim($a, &quot;\\&quot;\'\\n\\r &quot;);'), $matches[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $n = '%';&nbsp;</div></li><li><div>            $searchand = '';&nbsp;</div></li><li><div>            $search = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach( (array) $search_terms as $term) {&nbsp;</div></li><li><div>                $term = addslashes_gpc($term);&nbsp;</div></li><li><div>                $search .= &quot;{$searchand}((title LIKE '{$n}{$term}{$n}') OR (name LIKE '{$n}{$term}{$n}') )&quot;;&nbsp;</div></li><li><div>                $searchand = ' AND ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = esc_sql($request);&nbsp;</div></li><li><div>            if (count($search_terms) &gt; 1 && $search_terms[0] != $request )&nbsp;</div></li><li><div>                $search .= &quot; OR (title LIKE '{$n}{$term}{$n}') OR (name LIKE '{$n}{$term}{$n}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !empty($search) )&nbsp;</div></li><li><div>                $search = &quot; AND ({$search}) &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $limit = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($limit) : '';&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // build the final query&nbsp;</div></li><li><div>        $query = &quot;SELECT * FROM $wpdb-&gt;nggallery WHERE 1=1 $search ORDER BY title ASC $limit&quot;;&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * search for albums and return the result&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.7.0&nbsp;</div></li><li><div>     * @param string $request&nbsp;</div></li><li><div>     * @param int $limit number of results, 0 shows all results&nbsp;</div></li><li><div>     * @return Array Result of the request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function search_for_albums( $request, $limit = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If a search pattern is specified, load the posts that match&nbsp;</div></li><li><div>        if ( !empty($request) ) {&nbsp;</div></li><li><div>            // added slashes screw with quote grouping when done early, so done later&nbsp;</div></li><li><div>            $request = stripslashes($request);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // split the words it a array if separated by a space or comma&nbsp;</div></li><li><div>            preg_match_all('/&quot;.*?(&quot;|$)|((?&lt;=[\\s&quot;, +])|^)[^\\s&quot;, +]+/', $request, $matches);&nbsp;</div></li><li><div>            $search_terms = array_map(create_function('$a', 'return trim($a, &quot;\\&quot;\'\\n\\r &quot;);'), $matches[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $n = '%';&nbsp;</div></li><li><div>            $searchand = '';&nbsp;</div></li><li><div>            $search = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach( (array) $search_terms as $term) {&nbsp;</div></li><li><div>                $term = addslashes_gpc($term);&nbsp;</div></li><li><div>                $search .= &quot;{$searchand}(name LIKE '{$n}{$term}{$n}')&quot;;&nbsp;</div></li><li><div>                $searchand = ' AND ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = esc_sql($request);&nbsp;</div></li><li><div>            if (count($search_terms) &gt; 1 && $search_terms[0] != $request )&nbsp;</div></li><li><div>                $search .= &quot; OR (name LIKE '{$n}{$term}{$n}')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !empty($search) )&nbsp;</div></li><li><div>                $search = &quot; AND ({$search}) &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $limit = ( $limit &gt; 0 ) ? 'LIMIT ' . intval($limit) : '';&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // build the final query&nbsp;</div></li><li><div>        $query = &quot;SELECT * FROM $wpdb-&gt;nggalbum WHERE 1=1 $search ORDER BY name ASC $limit&quot;;&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * search for a filename&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.0&nbsp;</div></li><li><div>     * @param string $filename&nbsp;</div></li><li><div>     * @param int (optional) $galleryID&nbsp;</div></li><li><div>     * @return Array Result of the request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function search_for_file( $filename, $galleryID = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If a search pattern is specified, load the posts that match&nbsp;</div></li><li><div>        if ( !empty($filename) ) {&nbsp;</div></li><li><div>            // added slashes screw with quote grouping when done early, so done later&nbsp;</div></li><li><div>            $term = esc_sql($filename);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>               $where_clause = '';&nbsp;</div></li><li><div>            if ( is_numeric($galleryID) ) {&nbsp;</div></li><li><div>                $id = (int) $galleryID;&nbsp;</div></li><li><div>                $where_clause = &quot; AND tt.galleryid = {$id}&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // build the final query&nbsp;</div></li><li><div>        $query = &quot;SELECT t.*, tt.* FROM $wpdb-&gt;nggallery AS t INNER JOIN $wpdb-&gt;nggpictures AS tt ON t.gid = tt.galleryid WHERE tt.filename = '{$term}' {$where_clause} ORDER BY tt.pid ASC &quot;;&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_row($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return the object from the query result&nbsp;</div></li><li><div>        if ($result) {&nbsp;</div></li><li><div>            $image = new nggImage( $result );&nbsp;</div></li><li><div>            return $image;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update or add meta data for an image&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.0&nbsp;</div></li><li><div>     * @param int $id The image ID&nbsp;</div></li><li><div>     * @param array $values An array with existing or new values&nbsp;</div></li><li><div>     * @return bool result of query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function update_image_meta( $id, $new_values ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query database for existing values&nbsp;</div></li><li><div>        // Use cache object&nbsp;</div></li><li><div>        $old_values = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT meta_data FROM $wpdb-&gt;nggpictures WHERE pid = %d &quot;, $id ) );&nbsp;</div></li><li><div>        $old_values = unserialize( $old_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta = array_merge( (array)$old_values, (array)$new_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;UPDATE $wpdb-&gt;nggpictures SET meta_data = %s WHERE pid = %d&quot;, serialize($meta), $id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete($id, 'ngg_image');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Computes a unique slug for the gallery, album or image, when given the desired slug.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.7.0&nbsp;</div></li><li><div>     * @author taken from WP Core includes/post.php&nbsp;</div></li><li><div>     * @param string $slug the desired slug (post_name)&nbsp;</div></li><li><div>     * @param string $type ('image', 'album' or 'gallery')&nbsp;</div></li><li><div>     * @param int (optional) $id of the object, so that it's not checked against itself&nbsp;</div></li><li><div>     * @return string unique slug for the object, based on $slug (with a -1, -2, etc. suffix)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function get_unique_slug( $slug, $type, $id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($type) {&nbsp;</div></li><li><div>            case 'image':&nbsp;</div></li><li><div>                $check_sql = &quot;SELECT image_slug FROM $wpdb-&gt;nggpictures WHERE image_slug = %s AND NOT pid = %d LIMIT 1&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case 'album':&nbsp;</div></li><li><div>                $check_sql = &quot;SELECT slug FROM $wpdb-&gt;nggalbum WHERE slug = %s AND NOT id = %d LIMIT 1&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case 'gallery':&nbsp;</div></li><li><div>                $check_sql = &quot;SELECT slug FROM $wpdb-&gt;nggallery WHERE slug = %s AND NOT gid = %d LIMIT 1&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if you didn't give us a name we take the type&nbsp;</div></li><li><div>        $slug = empty($slug) ? $type: $slug;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>           // Slugs must be unique across all objects.&nbsp;</div></li><li><div>        $slug_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare( $check_sql, $slug, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $slug_check ) {&nbsp;</div></li><li><div>            $suffix = 2;&nbsp;</div></li><li><div>            do {&nbsp;</div></li><li><div>                $alt_name = substr ($slug, 0, 200 - ( strlen( $suffix ) + 1 ) ) . &quot;-$suffix&quot;;&nbsp;</div></li><li><div>                $slug_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare($check_sql, $alt_name, $id ) );&nbsp;</div></li><li><div>                $suffix++;&nbsp;</div></li><li><div>            } while ( $slug_check );&nbsp;</div></li><li><div>            $slug = $alt_name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>           return $slug;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.0.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.31/classes/nggdb/" class="active">1.9.31</a></li><li><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.30/classes/nggdb/" class="">1.9.30</a></li><li><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.27/classes/nggdb/" class="">1.9.27</a></li><li><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.26/classes/nggdb/" class="">1.9.26</a></li><li><a href="http://hookr.io/plugins/nextcellent-gallery/1.9.25.3/classes/nggdb/" class="">1.9.25.3</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>nggdb</li><li><span></span>NextCellent Gallery</li><li><span></span>1.9.31</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>