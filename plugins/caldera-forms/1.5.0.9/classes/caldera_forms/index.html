<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.5.0.9" data-slug="caldera-forms" data-type="class" data-id="79180"><head xmlns="http://www.w3.org/1999/xhtml"><title> caldera_forms | class | Caldera Forms | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Caldera_Forms, class, plugin, caldera-forms, 1.5.0.9" /><meta name="description" content="Caldera_Forms Plugin class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=624e173178e6d324a4b2d45db8cb5607' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/caldera_forms/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fcaldera_forms%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fcaldera_forms%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-caldera-forms-1.5.0.9-class-caldera_forms","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="caldera_forms" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to caldera-forms." href="http://hookr.io/plugins/caldera-forms/" class="plugin"><span property="name">caldera-forms</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.5.0.9." href="http://hookr.io/plugins/caldera-forms/1.5.0.9/" class="H_VERSION"><span property="name">1.5.0.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/caldera-forms/1.5.0.9/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">caldera_forms</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="407"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/all/" title="All">All <span class="count badge">407</span></a></li><li class="" data-id="new" data-count="4"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/new/" title="New">New <span class="count badge">4</span></a></li><li class="" data-id="hooks" data-count="223"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/hooks/" title="Hooks">Hooks <span class="count badge">223</span></a></li><li class="" data-id="action" data-count="67"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/actions/" title="Actions">Actions <span class="count badge">67</span></a></li><li class="" data-id="filter" data-count="156"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/filters/" title="Filters">Filters <span class="count badge">156</span></a></li><li class="active" data-id="class" data-count="115"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/classes/" title="Classes">Classes <span class="count badge">115</span></a></li><li class="" data-id="constant" data-count="17"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/constants/" title="Constants">Constants <span class="count badge">17</span></a></li><li class="" data-id="function" data-count="49"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/functions/" title="Functions">Functions <span class="count badge">49</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Caldera_Forms</strong></h1><p>Caldera_Forms Plugin class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/files/classes-core/" class="file">/classes/core.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class Caldera_Forms {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @var     string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const VERSION = CFCORE_VER;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @since 1.4.2&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const PLUGIN_SLUG = 'caldera-forms';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @var      string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $plugin_slug = 'caldera-forms';&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @var      string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $screen_prefix = null;&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @var      object&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected static $instance = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used to track if system has initialized and prevent recursion in init_cf_internal() method.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static $internal_init = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds modal HTML to be loaded in footer&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @deprecated 1.5.0.7&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.2&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected static $footer_modals;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * CF-API v2&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.4&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var Caldera_Forms_API_Load&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected static $api;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Initialize the plugin by setting localization, filters, and administration functions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load plugin text domain&nbsp;</div></li><li><div>        add_action( 'init', array( $this, 'load_plugin_textdomain' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( $this, 'api_handler' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add element & fields filters&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_get_form_processors', array( $this, 'get_form_processors' ) );&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_submit_redirect_complete', array( $this, 'do_redirect' ), 10, 4 );&nbsp;</div></li><li><div>        add_action( 'caldera_forms_edit_end', array( $this, 'calculations_templates' ) );&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_render_get_field', array( $this, 'auto_populate_options_field' ), 10, 2 );&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_render_get_field', array( $this, 'apply_conditional_groups' ), 10, 2 );&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_view_field_paragraph', 'wpautop' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //mailer magic&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_get_magic_tags', array( $this, 'set_magic_tags' ), 1 );&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_mailer', array( $this, 'mail_attachment_check' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // action&nbsp;</div></li><li><div>        add_action( 'caldera_forms_submit_complete', array( $this, 'save_final_form' ), 50 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // find if profile is loaded&nbsp;</div></li><li><div>        add_action( 'wp_loaded', array( $this, 'cf_init_system' ), 25 );&nbsp;</div></li><li><div>        add_action( 'wp', array( $this, 'cf_init_preview' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // render shortcode&nbsp;</div></li><li><div>        add_shortcode( 'caldera_form', array( $this, 'shortcode_handler' ) );&nbsp;</div></li><li><div>        // modal shortcode&nbsp;</div></li><li><div>        add_shortcode( 'caldera_form_modal', array( $this, 'shortcode_handler' ) );&nbsp;</div></li><li><div>        add_action( 'wp_footer', array( 'Caldera_Forms_Render_Modals', 'render_footer_modals' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //filter shortcode atts for defaults&nbsp;</div></li><li><div>        add_filter( 'shortcode_atts_caldera_form', array( 'Caldera_Forms_Shortcode_Atts', 'allow_default_set' ), 5, 4 );&nbsp;</div></li><li><div>        add_filter( 'shortcode_atts_caldera_form_modal', array( 'Caldera_Forms_Shortcode_Atts', 'allow_default_set' ), 5, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //emails&nbsp;</div></li><li><div>        add_action( 'caldera_forms_core_init', array( 'Caldera_Forms_Email_Settings', 'maybe_add_hooks' ) );&nbsp;</div></li><li><div>        add_action( 'caldera_forms_admin_footer', array( 'Caldera_Forms_Email_Settings', 'ui' ) );&nbsp;</div></li><li><div>        add_filter( 'pre_update_option__caldera_forms_email_api_settings', array(&nbsp;</div></li><li><div>            'Caldera_Forms_Email_Settings', &nbsp;</div></li><li><div>            'sanitize_save'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        if ( current_user_can( Caldera_Forms::get_manage_cap( 'admin' ) ) ) {&nbsp;</div></li><li><div>            add_action( 'wp_ajax_cf_email_save', array( 'Caldera_Forms_Email_Settings', 'save' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //auto-population via Easy Pods/ Easy Queries&nbsp;</div></li><li><div>        add_action( 'caldera_forms_render_start', array( __CLASS__, 'easy_pods_queries_setup' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //delete file uploads that are not going in media library&nbsp;</div></li><li><div>        add_action( 'caldera_forms_submit_complete', array( 'Caldera_Forms_Files', 'cleanup' ) );&nbsp;</div></li><li><div>        add_action( Caldera_Forms_Files::CRON_ACTION, array( 'Caldera_Forms_Files', 'cleanup_via_cron' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //entry permission&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_manage_cap', array( 'Caldera_Forms_Entry_UI', 'permissions_filter' ), 9, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( current_user_can( Caldera_Forms::get_manage_cap( 'admin' ) ) ) {&nbsp;</div></li><li><div>            $id = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $view = false;&nbsp;</div></li><li><div>            if ( isset( $_GET[ 'cf-email-preview' ], $_GET[ 'cf-email-preview-form' ] ) ) {&nbsp;</div></li><li><div>                if ( wp_verify_nonce( $_GET[ 'cf-email-preview' ], $_GET[ 'cf-email-preview-form' ] ) ) {&nbsp;</div></li><li><div>                    $id = $_GET[ 'cf-email-preview-form' ];&nbsp;</div></li><li><div>                    $view = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            new Caldera_Forms_Email_Previews( $id, $view );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //check for forms on page&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( $this, 'maybe_load_styles' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //format email&nbsp;</div></li><li><div>        add_filter( 'caldera_forms_mailer', array( $this, 'format_message' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Entry Viewer v1 */&nbsp;</div></li><li><div>        add_action( 'wp_ajax_browse_entries', array( Caldera_Forms_Entry_UI::get_instance(), 'view_entries' ) );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_get_entry', array( Caldera_Forms_Entry_UI::get_instance(), 'view_entry' ) );&nbsp;</div></li><li><div>        add_action( 'caldera_forms_entry_actions', array( Caldera_Forms_Entry_UI::get_instance(), 'get_entry_actions'), 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'rest_api_init', array( __CLASS__, 'init_rest_api' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //entry viewer shortcode&nbsp;</div></li><li><div>        add_shortcode( Caldera_Forms_Entry_Shortcode::get_shortcode_name(), array( 'Caldera_Forms_Entry_Shortcode', 'shortcode_callback' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //init Credit card # hash class here, not on hook, so it can't be unhooked&nbsp;</div></li><li><div>        new Caldera_Forms_Field_Credit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Load magic tag system */&nbsp;</div></li><li><div>        new Caldera_Forms_Magic();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //clear syncer cache on form update&nbsp;</div></li><li><div>        add_action( 'caldera_forms_save_form', array( 'Caldera_Forms_Sync_Factory', 'clear_cache' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after Caldera Forms core is initialized&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.5.3&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_core_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Adding anything to this constructor after caldera_forms_core_init action is a violation of intergalactic law */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load a form by ID or name&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $id_name ID or name of form.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|null Form config array if found. If not null.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_form( $id_name ) {&nbsp;</div></li><li><div>        return Caldera_Forms_Forms::get_form( $id_name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load all forms&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $internal Optional. If false, the default, all forms are returned. If true, only those saved in DB are returned.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_forms( $internal = false ) {&nbsp;</div></li><li><div>        return Caldera_Forms_Forms::get_forms( true, $internal );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load styles early if shortcodes or widgets are used on page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses &quot;template_redirect&quot; action&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function maybe_load_styles() {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Use this filter to force Caldera Forms styles to enqueue early -- IE force them into header&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $use To use or not&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $use = apply_filters( 'caldera_forms_force_enqueue_styles_early', false );&nbsp;</div></li><li><div>        $on_page = self::check_for_forms_on_page();&nbsp;</div></li><li><div>        if( $use || $on_page ) {&nbsp;</div></li><li><div>            add_action( 'wp_enqueue_scripts', array( 'Caldera_Forms_Render_Assets' , 'optional_style_includes' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if there are forms on page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WP_Post $post Optional, current post object&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function check_for_forms_on_page( $post = null ) {&nbsp;</div></li><li><div>        if( is_null( $post ) ) {&nbsp;</div></li><li><div>            global $post;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $post-&gt;post_content ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_shortcode = has_shortcode( $post-&gt;post_content, 'caldera_form' );&nbsp;</div></li><li><div>        if( $has_shortcode ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_shortcode = has_shortcode( $post-&gt;post_content, 'caldera_form_modal' );&nbsp;</div></li><li><div>        if( $has_shortcode ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check active widgets&nbsp;</div></li><li><div>        $sidebars = get_option( 'sidebars_widgets' );&nbsp;</div></li><li><div>        if ( is_array( $sidebars ) && ! empty( $sidebars ) ) {&nbsp;</div></li><li><div>            $form_widgets = get_option( 'widget_caldera_forms_widget' );&nbsp;</div></li><li><div>            unset( $sidebars[ 'wp_inactive_widgets' ] );&nbsp;</div></li><li><div>            foreach ( $sidebars as $sidebar =&gt; $set ) {&nbsp;</div></li><li><div>                if ( is_active_sidebar( $sidebar ) ) {&nbsp;</div></li><li><div>                    foreach ( $set as $setup ) {&nbsp;</div></li><li><div>                        if ( false !== strpos( $setup, 'caldera_forms_widget-' ) ) {&nbsp;</div></li><li><div>                            $widget_instance = str_replace( 'caldera_forms_widget-', '', $setup );&nbsp;</div></li><li><div>                            if ( ! empty( $form_widgets[ $widget_instance ][ 'form' ] ) ) {&nbsp;</div></li><li><div>                                return true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a modal button's HTML&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0.4&nbsp;</div></li><li><div>     * @deprecated 1.5.0.7&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $atts Form atts&nbsp;</div></li><li><div>     * @param string $content Content for opener&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected static function modal_button( $atts, $content, $form, $modal_id ) {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, '1.5.0.7', 'Caldera_Forms_Render_Modals::modal_button' );&nbsp;</div></li><li><div>        return Caldera_Forms_Render_Modals::modal_button( $atts, $content, $form, $modal_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load a field from form&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.2&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     * @param string $field_base_id Field ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_field( $form, $field_base_id ) {&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'fields' ][ $field_base_id ] ) ) {&nbsp;</div></li><li><div>            $field = $form[ 'fields' ][ $field_base_id ];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //probably bad, but opportunity to defined using &quot;caldera_forms_render_setup_field&quot;&nbsp;</div></li><li><div>            $field = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the field setup before render&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Note, $field might be empty, must be array after this or field will not render, which is useful for preventing render or creating field types at this filter.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $notice Notices HTML&nbsp;</div></li><li><div>         * @param array $config Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $field = apply_filters( 'caldera_forms_render_setup_field', $field, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load the plugin text domain for translation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function load_plugin_textdomain() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        load_plugin_textdomain( $this-&gt;plugin_slug, false, basename( CFCORE_PATH ) . '/languages' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Setup internals / AKA activate stuffs&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init_cf_internal() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false == self::$internal_init ) {&nbsp;</div></li><li><div>            add_rewrite_tag( '%cf_api%', '([^&]+)' );&nbsp;</div></li><li><div>            add_rewrite_tag( '%cf_entry%', '([^&]+)' );&nbsp;</div></li><li><div>            // INIT API&nbsp;</div></li><li><div>            add_rewrite_rule( '^cf-api/([^/]*)/([^/]*)/?', 'index.php?cf_api=$matches[1]&cf_entry=$matches[2]', 'top' );&nbsp;</div></li><li><div>            add_rewrite_rule( '^cf-api/([^/]*)/?', 'index.php?cf_api=$matches[1]', 'top' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            self::$internal_init = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check update version&nbsp;</div></li><li><div>            $db_version = get_option( 'CF_DB', 0 );&nbsp;</div></li><li><div>            $force_update = false;&nbsp;</div></li><li><div>            if ( is_admin() && isset( $_GET[ 'cal_db_update' ] ) ) { // ensure that admin can only force update&nbsp;</div></li><li><div>                $force_update = (bool) wp_verify_nonce( $_GET[ 'cal_db_update' ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            include_once CFCORE_PATH . 'includes/updater.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( CF_DB &gt; $db_version || $force_update ) {&nbsp;</div></li><li><div>                if ( $db_version &lt; 2 || $force_update ) {&nbsp;</div></li><li><div>                    caldera_forms_db_v2_update();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $db_version &lt; 4 || $force_update ) {&nbsp;</div></li><li><div>                    self::activate_caldera_forms( true );&nbsp;</div></li><li><div>                    caldera_forms_write_db_flag( 4 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $version = caldera_forms_get_last_update_version();&nbsp;</div></li><li><div>                if ( empty( $version ) || version_compare( $version, CFCORE_VER ) !== 0 ) {&nbsp;</div></li><li><div>                    flush_rewrite_rules();&nbsp;</div></li><li><div>                    update_option( '_calderaforms_lastupdate', CFCORE_VER );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Activate and setup plugin&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $force Optional. If true, tables are checked no matter what. Default is false&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function activate_caldera_forms( $force = false ) {&nbsp;</div></li><li><div>        include_once CFCORE_PATH . 'includes/updater.php';&nbsp;</div></li><li><div>        $version = caldera_forms_get_last_update_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_schedule_event( time(), 'daily', 'caldera_forms_tracking_send_rows' );&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure urls are there&nbsp;</div></li><li><div>        self::init_cf_internal();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure rewrites&nbsp;</div></li><li><div>        flush_rewrite_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $charset_collate = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $wpdb-&gt;charset ) ) {&nbsp;</div></li><li><div>            $charset_collate = &quot;DEFAULT CHARACTER SET $wpdb-&gt;charset&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $wpdb-&gt;collate ) ) {&nbsp;</div></li><li><div>            $charset_collate .= &quot; COLLATE $wpdb-&gt;collate&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Indexes have a maximum size of 767 bytes. Historically, we haven't need to be concerned about that.&nbsp;</div></li><li><div>         * As of WordPress 4.2, however, we moved to utf8mb4, which uses 4 bytes per character. This means that an index which&nbsp;</div></li><li><div>         * used to have room for floor(767/3) = 255 characters, now only has room for floor(767/4) = 191 characters.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $max_index_length = 191;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tables = $wpdb-&gt;get_results( &quot;SHOW TABLES&quot;, ARRAY_A );&nbsp;</div></li><li><div>        foreach ( $tables as $table ) {&nbsp;</div></li><li><div>            $alltables[] = implode( $table );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // meta table&nbsp;</div></li><li><div>        if ( ! in_array( $wpdb-&gt;prefix . 'cf_form_entry_meta', $alltables ) ) {&nbsp;</div></li><li><div>            // create meta tables&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $meta_table = &quot;CREATE TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_meta` (&nbsp;</div></li><li><div>            `meta_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, &nbsp;</div></li><li><div>            `entry_id` bigint(20) unsigned NOT NULL DEFAULT '0', &nbsp;</div></li><li><div>            `process_id` varchar(255) DEFAULT NULL, &nbsp;</div></li><li><div>            `meta_key` varchar(255) DEFAULT NULL, &nbsp;</div></li><li><div>            `meta_value` longtext, &nbsp;</div></li><li><div>            PRIMARY KEY (`meta_id`), &nbsp;</div></li><li><div>            KEY `meta_key` (meta_key(&quot; . $max_index_length . &quot;)), &nbsp;</div></li><li><div>            KEY `entry_id` (`entry_id`)&nbsp;</div></li><li><div> ) &quot; . $charset_collate . &quot;;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            dbDelta( $meta_table );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // tracking table&nbsp;</div></li><li><div>        if ( ! in_array( $wpdb-&gt;prefix . 'cf_tracking', $alltables ) ) {&nbsp;</div></li><li><div>            // create meta tables&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>            $tacking_table = &quot;CREATE TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_tracking` (&nbsp;</div></li><li><div>            `ID` bigint(20) unsigned NOT NULL AUTO_INCREMENT, &nbsp;</div></li><li><div>            `form_id` varchar(255) DEFAULT NULL, &nbsp;</div></li><li><div>            `process_id` varchar(255) DEFAULT NULL, &nbsp;</div></li><li><div>            PRIMARY KEY (`ID`)&nbsp;</div></li><li><div> ) &quot; . $charset_collate . &quot;;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            dbDelta( $tacking_table );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //tracking meta&nbsp;</div></li><li><div>        if ( ! in_array( $wpdb-&gt;prefix . 'cf_tracking_meta', $alltables ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $meta_table = &quot;CREATE TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_tracking_meta` (&nbsp;</div></li><li><div>            `meta_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, &nbsp;</div></li><li><div>            `event_id` bigint(20) unsigned NOT NULL DEFAULT '0', &nbsp;</div></li><li><div>            `meta_key` varchar(255) DEFAULT NULL, &nbsp;</div></li><li><div>            `meta_value` longtext, &nbsp;</div></li><li><div>            PRIMARY KEY (`meta_id`), &nbsp;</div></li><li><div>            KEY `meta_key` (`meta_key`(&quot; . $max_index_length . &quot;)), &nbsp;</div></li><li><div>            KEY `event_id` (`event_id`)&nbsp;</div></li><li><div> ) &quot; . $charset_collate . &quot;;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            dbDelta( $meta_table );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! in_array( $wpdb-&gt;prefix . 'cf_form_entries', $alltables ) || ! in_array( $wpdb-&gt;prefix . 'cf_form_entry_values', $alltables ) ) {&nbsp;</div></li><li><div>            // create tables&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( $wpdb-&gt;prefix . 'cf_form_entries', $alltables ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $entry_table = &quot;CREATE TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries` (&nbsp;</div></li><li><div>                `id` int(11) unsigned NOT NULL AUTO_INCREMENT, &nbsp;</div></li><li><div>                `form_id` varchar(18) NOT NULL DEFAULT '', &nbsp;</div></li><li><div>                `user_id` int(11) NOT NULL, &nbsp;</div></li><li><div>                `datestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP, &nbsp;</div></li><li><div>                `status` varchar(20) NOT NULL DEFAULT 'active', &nbsp;</div></li><li><div>                PRIMARY KEY (`id`), &nbsp;</div></li><li><div>                KEY `form_id` (`form_id`), &nbsp;</div></li><li><div>                KEY `user_id` (`user_id`), &nbsp;</div></li><li><div>                KEY `date_time` (`datestamp`), &nbsp;</div></li><li><div>                KEY `status` (`status`)&nbsp;</div></li><li><div> ) &quot; . $charset_collate . &quot;;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                dbDelta( $entry_table );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( $wpdb-&gt;prefix . 'cf_form_entry_values', $alltables ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $values_table = &quot;CREATE TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_values` (&nbsp;</div></li><li><div>                `id` int(11) unsigned NOT NULL AUTO_INCREMENT, &nbsp;</div></li><li><div>                `entry_id` int(11) NOT NULL, &nbsp;</div></li><li><div>                `field_id` varchar(20) NOT NULL, &nbsp;</div></li><li><div>                `slug` varchar(255) NOT NULL DEFAULT '', &nbsp;</div></li><li><div>                `value` longtext NOT NULL, &nbsp;</div></li><li><div>                PRIMARY KEY (`id`), &nbsp;</div></li><li><div>                KEY `form_id` (`entry_id`), &nbsp;</div></li><li><div>                KEY `field_id` (`field_id`), &nbsp;</div></li><li><div>                KEY `slug` (`slug`(&quot; . $max_index_length . &quot;))&nbsp;</div></li><li><div> ) &quot; . $charset_collate . &quot;;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                dbDelta( $values_table );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $version &gt;= '1.1.5' ) {&nbsp;</div></li><li><div>                return; // only if 1.1.4 or lower&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // check for field_id from 1.0.4&nbsp;</div></li><li><div>            $columns = $wpdb-&gt;get_results( &quot;SHOW COLUMNS FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_values`&quot;, ARRAY_A );&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>            foreach ( $columns as $column ) {&nbsp;</div></li><li><div>                $fields[] = $column[ 'Field' ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! in_array( 'field_id', $fields ) ) {&nbsp;</div></li><li><div>                $wpdb-&gt;query( &quot;ALTER TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_values` ADD `field_id` varchar(20) NOT NULL AFTER `entry_id`;&quot; );&nbsp;</div></li><li><div>                $wpdb-&gt;query( &quot;CREATE INDEX `field_id` ON `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_values` (`field_id`); &quot; );&nbsp;</div></li><li><div>                // update all entries&nbsp;</div></li><li><div>                $forms = $wpdb-&gt;get_results( &quot;SELECT `id`, `form_id` FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries`&quot;, ARRAY_A );&nbsp;</div></li><li><div>                $known = array();&nbsp;</div></li><li><div>                if ( ! empty( $forms ) ) {&nbsp;</div></li><li><div>                    foreach ( $forms as $form ) {&nbsp;</div></li><li><div>                        if ( ! isset( $known[ $form[ 'form_id' ] ] ) ) {&nbsp;</div></li><li><div>                            $config = Caldera_Forms_Forms::get_form( $form[ 'form_id' ] );&nbsp;</div></li><li><div>                            if ( empty( $config ) ) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $known[ $form[ 'form_id' ] ] = $config;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $config = $known[ $form[ 'form_id' ] ];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach ( $config[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>                            $wpdb-&gt;update( $wpdb-&gt;prefix . &quot;cf_form_entry_values&quot;, array( 'field_id' =&gt; $field_id ), array(&nbsp;</div></li><li><div>                                'entry_id' =&gt; $form[ 'id' ], &nbsp;</div></li><li><div>                                'slug' =&gt; $field[ 'slug' ]&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // add status&nbsp;</div></li><li><div>            $columns = $wpdb-&gt;get_results( &quot;SHOW COLUMNS FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries`&quot;, ARRAY_A );&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( 'status', $fields ) && $version &lt; '1.2.0' ) {&nbsp;</div></li><li><div>                $wpdb-&gt;query( &quot;ALTER TABLE `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries` ADD `status` varchar(20) NOT NULL DEFAULT 'active' AFTER `datestamp`;&quot; );&nbsp;</div></li><li><div>                $wpdb-&gt;query( &quot;CREATE INDEX `status` ON `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries` (`status`); &quot; );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * View a star rating form value&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $value Value for star ratring&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string HTML markup&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function star_rating_viewer( $value, $field, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $out = &quot;&lt;div style=\&quot;color: &quot; . $field[ 'config' ][ 'color' ] . &quot;; font-size: 10px;display: inline;\&quot; &gt;&quot;;&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'config' ][ 'number' ] ) ) {&nbsp;</div></li><li><div>            for ( $i = 1; $i &lt;= $field[ 'config' ][ 'number' ]; $i ++ ) {&nbsp;</div></li><li><div>                $star = 'raty-' . $field[ 'config' ][ 'type' ] . '-off';&nbsp;</div></li><li><div>                if ( $i &lt;= $value ) {&nbsp;</div></li><li><div>                    $star = 'raty-' . $field[ 'config' ][ 'type' ] . '-on';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $out .= '&lt;span data-alt=&quot;' . $i . '&quot; class=&quot;' . $star . '&quot; title=&quot;' . $i . '&quot; style=&quot;margin-right: -2px;&quot;&gt;&lt;/span&gt; ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $out .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $out;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Output markup for file fields&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $value Saved file paths&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function handle_file_view( $value, $field, $form ) {&nbsp;</div></li><li><div>        $out = array();&nbsp;</div></li><li><div>        foreach ( (array) $value as $file_url ) {&nbsp;</div></li><li><div>            $out[] = '&lt;a href=&quot;' . $file_url . '&quot; target=&quot;_blank&quot;&gt;' . basename( $file_url ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return implode( ', ', $out );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepare email attachments&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $mail Email data&nbsp;</div></li><li><div>     * @param array $data Form data&nbsp;</div></li><li><div>     * @param array $form For config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function mail_attachment_check( $mail, $data, $form) {&nbsp;</div></li><li><div>        foreach ( Caldera_Forms_Forms::get_fields( $form, false ) as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>            if ( Caldera_Forms_Field_Util::is_file_field( $field, $form ) ) {&nbsp;</div></li><li><div>                if( ! Caldera_Forms_Files::should_attach( $field, $form ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $dir = wp_upload_dir();&nbsp;</div></li><li><div>                if ( isset( $data[ $field_id ] ) && is_array( $data[ $field_id ] ) ) {&nbsp;</div></li><li><div>                    foreach ( $data[ $field_id ] as $file ) {&nbsp;</div></li><li><div>                        $file = str_replace( $dir[ 'baseurl' ], $dir[ 'basedir' ], $file );&nbsp;</div></li><li><div>                        if ( file_exists( $file ) ) {&nbsp;</div></li><li><div>                            $mail[ 'attachments' ][] = $file;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( isset( $data[ $field_id ] ) ) {&nbsp;</div></li><li><div>                    $file = $data[ $field_id ];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $file = self::get_field_data( $field_id, $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $file ) ) {&nbsp;</div></li><li><div>                    foreach ( $file as $a_file ) {&nbsp;</div></li><li><div>                        $file = str_replace( $dir[ 'baseurl' ], $dir[ 'basedir' ], $file );&nbsp;</div></li><li><div>                        if ( is_string( $a_file ) && file_exists( $a_file ) ) {&nbsp;</div></li><li><div>                            $mail[ 'attachments' ][] = $a_file;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $file = str_replace( $dir[ 'baseurl' ], $dir[ 'basedir' ], $file );&nbsp;</div></li><li><div>                    if ( is_string( $file ) && file_exists( $file ) ) {&nbsp;</div></li><li><div>                        $mail[ 'attachments' ][] = $file;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        if ( isset( $data[ $field_id ] ) && filter_var( $data[ $field_id ], FILTER_VALIDATE_URL ) ) {&nbsp;</div></li><li><div>                            $mail[ 'attachments' ][] = $data[ $field_id ];&nbsp;</div></li><li><div>                        } elseif ( isset( $_POST[ $field_id ] ) && filter_var( $_POST[ $field_id ], FILTER_VALIDATE_URL ) && 0 === strpos( $_POST[ $field_id ], $dir[ 'url' ] ) ) {&nbsp;</div></li><li><div>                            $mail[ 'attachments' ][] = $_POST[ $field_id ];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $mail;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check a captcha&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $value Attempted captcha value&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool|\WP_Error True if valid, WP_Error if not&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function captcha_check( $value, $field, $form ) {&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_POST[ 'g-recaptcha-response' ] ) || empty( $_POST[ 'g-recaptcha-response' ] ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'error' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'secret' =&gt; $field[ 'config' ][ 'private_key' ], &nbsp;</div></li><li><div>            'response' =&gt; sanitize_text_field( $_POST[ 'g-recaptcha-response' ] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request = wp_remote_get( 'https://www.google.com/recaptcha/api/siteverify?' . build_query( $args ) );&nbsp;</div></li><li><div>        $result = json_decode( wp_remote_retrieve_body( $request ) );&nbsp;</div></li><li><div>        if ( empty( $result-&gt;success ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'error', __( &quot;The wasn't entered correct.&quot;, 'caldera-forms' ) . ' &lt;a href=&quot;#&quot; class=&quot;reset_' . sanitize_text_field( $_POST[ $field[ 'ID' ] ] ) . '&quot;&gt;' . __( 'Reset', 'caldera-forms' ) . '&lt;a&gt;.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update saved entry data for a field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param int $entry_id The entry ID&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_field_data( $field, $entry_id, $form ) {&nbsp;</div></li><li><div>        global $wpdb, $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // is capture?&nbsp;</div></li><li><div>        $field_type = Caldera_Forms_Field_Util::get_type( $field, $form );&nbsp;</div></li><li><div>        $not_support = Caldera_Forms_Fields::not_support( $field_type, 'entry_list' );&nbsp;</div></li><li><div>        if ( $not_support ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_data = self::get_field_data( $field[ 'ID' ], $form );&nbsp;</div></li><li><div>        $original_data = self::get_field_data( $field[ 'ID' ], $form, $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $original_data === $new_data ) {&nbsp;</div></li><li><div>            // no change&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( has_filter( 'caldera_forms_save_field' ) ) {&nbsp;</div></li><li><div>            $new_data = apply_filters( 'caldera_forms_update_field', $new_data, $field, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( has_filter( 'caldera_forms_save_field_' . $field[ 'type' ] ) ) {&nbsp;</div></li><li><div>            $new_data = apply_filters( 'caldera_forms_update_field_' . $field[ 'type' ], $new_data, $field, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $original_data !== null ) {&nbsp;</div></li><li><div>            $wpdb-&gt;delete( $wpdb-&gt;prefix . 'cf_form_entry_values', array(&nbsp;</div></li><li><div>                'entry_id' =&gt; $entry_id, &nbsp;</div></li><li><div>                'field_id' =&gt; $field[ 'ID' ]&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( (array) $new_data as $entry_data ) {&nbsp;</div></li><li><div>            // no entry - add first&nbsp;</div></li><li><div>            $new_entry = array(&nbsp;</div></li><li><div>                'entry_id' =&gt; $entry_id, &nbsp;</div></li><li><div>                'field_id' =&gt; $field[ 'ID' ], &nbsp;</div></li><li><div>                'slug' =&gt; $field[ 'slug' ], &nbsp;</div></li><li><div>                'value' =&gt; $entry_data, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $wpdb-&gt;insert( $wpdb-&gt;prefix . 'cf_form_entry_values', $new_entry );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save entry data for a field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param int $entry_id The entry ID&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function save_field_data( $field, $entry_id, $form ) {&nbsp;</div></li><li><div>        global $wpdb, $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>            if ( ! self::check_condition( $field[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $field[ 'ID' ], $field[ 'slug' ] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = self::get_field_data( $field[ 'ID' ], $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $data ) && 0 != $data ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( (array) $data as $key =&gt; $raw_entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $entry = Caldera_Forms_Sanitize::sanitize( $raw_entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( has_filter( 'caldera_forms_save_field' ) ) {&nbsp;</div></li><li><div>                $entry = apply_filters( 'caldera_forms_save_field', $entry, $field );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( has_filter( 'caldera_forms_save_field_' . $field[ 'type' ] ) ) {&nbsp;</div></li><li><div>                $entry = apply_filters( 'caldera_forms_save_field_' . $field[ 'type' ], $entry, $field );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_item = array(&nbsp;</div></li><li><div>                'entry_id' =&gt; $entry_id, &nbsp;</div></li><li><div>                'field_id' =&gt; $field[ 'ID' ], &nbsp;</div></li><li><div>                'slug' =&gt; $field[ 'slug' ], &nbsp;</div></li><li><div>                'value' =&gt; self::do_magic_tags( $entry )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // named key kets .key to slug&nbsp;</div></li><li><div>            if ( ! is_int( $key ) ) {&nbsp;</div></li><li><div>                // Keyed&nbsp;</div></li><li><div>                $keyed = true;&nbsp;</div></li><li><div>                $field_item[ 'slug' ] .= '.' . $key;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Save&nbsp;</div></li><li><div>            $wpdb-&gt;insert( $wpdb-&gt;prefix . 'cf_form_entry_values', $field_item );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $keyed ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( has_filter( 'caldera_forms_save_field_combined' . $field[ 'type' ] ) ) {&nbsp;</div></li><li><div>                $data = apply_filters( 'caldera_forms_save_field_combined' . $field[ 'type' ], $entry, $field );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_item = array(&nbsp;</div></li><li><div>                'entry_id' =&gt; $entry_id, &nbsp;</div></li><li><div>                'field_id' =&gt; $field[ 'ID' ], &nbsp;</div></li><li><div>                'slug' =&gt; $field[ 'slug' ], &nbsp;</div></li><li><div>                'value' =&gt; json_encode( $data )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $wpdb-&gt;insert( $wpdb-&gt;prefix . 'cf_form_entry_values', $field_item );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save final form data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return void|\WP_Error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function save_final_form( $form ) {&nbsp;</div></li><li><div>        global $transdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entryid = null;&nbsp;</div></li><li><div>        // check submit type (new or update)&nbsp;</div></li><li><div>        if ( isset( $_POST[ '_cf_frm_edt' ] ) ) {&nbsp;</div></li><li><div>            // is edit&nbsp;</div></li><li><div>            //check user can edit this item.&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>            $details = Caldera_Forms::get_entry_detail( $_POST[ '_cf_frm_edt' ], $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check token&nbsp;</div></li><li><div>            if ( isset( $_POST[ '_cf_frm_edt_tkn' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $validated = Caldera_Forms_Entry_Token::verify_token( $_POST[ '_cf_frm_edt_tkn' ], $details[ 'id' ], $form[ 'ID' ] );&nbsp;</div></li><li><div>                if ( is_wp_error( $validated ) ) {&nbsp;</div></li><li><div>                    return $validated;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $entry_id = (int) $details[ 'id' ];&nbsp;</div></li><li><div>                    $edit_token = Caldera_Forms_Entry_Token::create_entry_token( $entry_id, $form[ 'ID' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $user_id ) ) {&nbsp;</div></li><li><div>                    if ( ! empty( $details ) ) {&nbsp;</div></li><li><div>                        // check user can edit&nbsp;</div></li><li><div>                        if ( current_user_can( 'edit_posts' ) || $details[ 'user_id' ] === $user_id ) {&nbsp;</div></li><li><div>                            $entryid = $_POST[ '_cf_frm_edt' ];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            return new WP_Error( 'error', __( &quot;Permission denied.&quot;, 'caldera-forms' ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'db_support' ] ) ) {&nbsp;</div></li><li><div>            Caldera_Forms_Save_Final::save_in_db( $form, $entryid );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::should_send_mail( $form, $transdata ) ) {&nbsp;</div></li><li><div>            Caldera_Forms_Save_Final::do_mailer( $form, $entryid );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates a send log to debug mailer problems&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param object $phpmailer The phpmailer object&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function debug_mail_send( $phpmailer ) {&nbsp;</div></li><li><div>        global $transdata, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // this is a hack since there is not filter / action for a failed mail... yet&nbsp;</div></li><li><div>        //$phpmailer-&gt;SMTPDebug = 3;&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        $phpmailer-&gt;SMTPDebug = 3;&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $phpmailer-&gt;Send();&nbsp;</div></li><li><div>        } catch ( phpmailerException $e ) {&nbsp;</div></li><li><div>            print_r( $phpmailer-&gt;ErrorInfo );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        print_r( $phpmailer );&nbsp;</div></li><li><div>        $phpmailer-&gt;SMTPDebug = 0;&nbsp;</div></li><li><div>        $result = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta_entry = array(&nbsp;</div></li><li><div>            'entry_id' =&gt; $transdata[ 'entry_id' ], &nbsp;</div></li><li><div>            'process_id' =&gt; '_debug_log', &nbsp;</div></li><li><div>            'meta_key' =&gt; 'debug_log', &nbsp;</div></li><li><div>            'meta_value' =&gt; $result&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;insert( $wpdb-&gt;prefix . 'cf_form_entry_meta', $meta_entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return an instance of this class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return    object    A single instance of this class.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_instance() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the single instance hasn't been set, set it now.&nbsp;</div></li><li><div>        if ( null == self::$instance ) {&nbsp;</div></li><li><div>            self::$instance = new self;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Change redirect notices using magic tags.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $notices Current notices&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function override_redirect_notice( $notices, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'processors' ] as $processor ) {&nbsp;</div></li><li><div>                if ( $processor[ 'type' ] == 'form_redirect' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $processor[ 'conditions' ] ) && ! empty( $processor[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                        if ( ! self::check_condition( $processor[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $notices[ 'success' ][ 'note' ] = self::do_magic_tags( $processor[ 'config' ][ 'message' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $notices;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Do the redirect&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $referrer Reffering URL&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     * @param $processid&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string URL to redirect to.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function do_redirect( $referrer, $form, $processid ) {&nbsp;</div></li><li><div>        if ( isset( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'processors' ] as $processor ) {&nbsp;</div></li><li><div>                if ( $processor[ 'type' ] == 'form_redirect' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $processor[ 'conditions' ] ) && ! empty( $processor[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                        if ( ! self::check_condition( $processor[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ( ! empty( $processor[ 'config' ][ 'url' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // set message&nbsp;</div></li><li><div>                        add_filter( 'caldera_forms_render_notices', array(&nbsp;</div></li><li><div>                            'Caldera_Forms', &nbsp;</div></li><li><div>                            'override_redirect_notice'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        //passback urls&nbsp;</div></li><li><div>                        $referrer = parse_url( $referrer );&nbsp;</div></li><li><div>                        $query_vars = array();&nbsp;</div></li><li><div>                        if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>                            parse_str( $referrer[ 'query' ], $referrer[ 'query' ] );&nbsp;</div></li><li><div>                            if ( isset( $referrer[ 'query' ][ 'cf_su' ] ) ) {&nbsp;</div></li><li><div>                                unset( $referrer[ 'query' ][ 'cf_su' ] );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $query_vars = array_merge( $query_vars, $referrer[ 'query' ] );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // get vars in url&nbsp;</div></li><li><div>                        $base_redirect = self::do_magic_tags( $processor[ 'config' ][ 'url' ] );&nbsp;</div></li><li><div>                        $redirect = parse_url( $base_redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! empty( $redirect[ 'query' ] ) ) {&nbsp;</div></li><li><div>                            parse_str( $redirect[ 'query' ], $redirect[ 'query' ] );&nbsp;</div></li><li><div>                            $base_redirect = explode( '?', $base_redirect, 2 );&nbsp;</div></li><li><div>                            $query_vars = array_merge( $redirect[ 'query' ], $query_vars );&nbsp;</div></li><li><div>                            $redirect = $base_redirect[ 0 ] . '?' . http_build_query( $query_vars );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $redirect = $base_redirect . '?' . http_build_query( $query_vars );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        return $redirect;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $referrer;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process the auto-responder&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $config Processor config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function send_auto_response( $config, $form ) {&nbsp;</div></li><li><div>        global $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // new filter to alter the config.&nbsp;</div></li><li><div>        $config = apply_filters( 'caldera_forms_autoresponse_config', $config, $form );&nbsp;</div></li><li><div>        // remove required bounds.&nbsp;</div></li><li><div>        unset( $config[ '_required_bounds' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message = $config[ 'message' ];&nbsp;</div></li><li><div>        foreach ( $config as $tag =&gt; &$value ) {&nbsp;</div></li><li><div>            if ( $tag !== 'message' ) {&nbsp;</div></li><li><div>                $message = str_replace( '%' . $tag . '%', $value, $message );&nbsp;</div></li><li><div>                $value = self::do_magic_tags( $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // set header&nbsp;</div></li><li><div>        $headers[] = 'From: ' . $config[ 'sender_name' ] . ' &lt;' . $config[ 'sender_email' ] . '&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $message ) ) {&nbsp;</div></li><li><div>            $message = '  ';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $html = false;&nbsp;</div></li><li><div>        if ( ! isset( $config[ 'html' ] ) || true == $config[ 'html' ] ) {&nbsp;</div></li><li><div>            $headers[] = &quot;Content-type: text/html&quot;;&nbsp;</div></li><li><div>            $message = wpautop( self::do_magic_tags( $message ) );&nbsp;</div></li><li><div>            $html = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $message = self::do_magic_tags( $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! $html ) {&nbsp;</div></li><li><div>            $message = strip_tags( $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setup mailer&nbsp;</div></li><li><div>        $subject = $config[ 'subject' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_message = array(&nbsp;</div></li><li><div>            'recipients' =&gt; array(&nbsp;</div></li><li><div>                $config[ 'recipient_name' ] . ' &lt;' . $config[ 'recipient_email' ] . '&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'subject' =&gt; $subject, &nbsp;</div></li><li><div>            'message' =&gt; $message, &nbsp;</div></li><li><div>            'headers' =&gt; $headers, &nbsp;</div></li><li><div>            'attachments' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_email( $config[ 'sender_email' ] ) ) {&nbsp;</div></li><li><div>            $config[ 'sender_email' ] = get_option( 'admin_email' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_message = apply_filters( 'caldera_forms_autoresponse_mail', $email_message, $config, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'wp' !== Caldera_Forms_Email_Settings::get_method() ) {&nbsp;</div></li><li><div>            $email_message[ 'from' ]      = $email_message[ 'replyto' ] = $config[ 'sender_email' ];&nbsp;</div></li><li><div>            $email_message[ 'from_name' ] = $config[ 'sender_name' ];&nbsp;</div></li><li><div>            $email_message[ 'bcc' ]       = $email_message[ 'csv' ] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Caldera_Forms_Save_Final::do_mailer( $form, null, null, $email_message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'caldera_forms_do_autoresponse', $config, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // send mail&nbsp;</div></li><li><div>        $sent = wp_mail( $email_message[ 'recipients' ], $email_message[ 'subject' ], implode( &quot;\r\n&quot;, (array) $email_message[ 'message' ] ), implode( &quot;\r\n&quot;, (array) $email_message[ 'headers' ] ), $email_message[ 'attachments' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $sent ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires if wp_mail returns false in autoresponder&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.2.3&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param array $email_message Email data&nbsp;</div></li><li><div>             * @param array $config Auto responder settings&nbsp;</div></li><li><div>             * @param array $form The form config&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'caldera_forms_autoresponder_failed', $email_message, $config, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load built-in form processors&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $processors&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_form_processors( $processors ) {&nbsp;</div></li><li><div>        $internal_processors = array(&nbsp;</div></li><li><div>            'auto_responder' =&gt; array(&nbsp;</div></li><li><div>                &quot;name&quot; =&gt; __( 'Auto Responder', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;description&quot; =&gt; __( 'Sends out an auto response e-mail', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;post_processor&quot; =&gt; array( $this, 'send_auto_response' ), &nbsp;</div></li><li><div>                &quot;template&quot; =&gt; CFCORE_PATH . &quot;processors/auto_responder/config.php&quot;, &nbsp;</div></li><li><div>                &quot;default&quot; =&gt; array(&nbsp;</div></li><li><div>                    'subject' =&gt; __( 'Thank you for contacting us', 'caldera-forms' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'form_redirect' =&gt; array(&nbsp;</div></li><li><div>                &quot;name&quot; =&gt; __( 'Redirect', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;description&quot; =&gt; __( 'Redirects user to URL on successful submit', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;template&quot; =&gt; CFCORE_PATH . &quot;processors/redirect/config.php&quot;, &nbsp;</div></li><li><div>                &quot;single&quot; =&gt; false&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'conditional_recipient' =&gt; array(&nbsp;</div></li><li><div>                &quot;name&quot; =&gt; __( 'Conditional Recipient', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;description&quot; =&gt; __( 'Send email to different recipients depending on conditions', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;template&quot; =&gt; CFCORE_PATH . &quot;processors/conditional_recipient/config.php&quot;, &nbsp;</div></li><li><div>                'post_processor' =&gt; array( 'Caldera_Forms_Processor_Conditional_Recipient', 'post_processor' ), &nbsp;</div></li><li><div>                &quot;single&quot; =&gt; false&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'increment_capture' =&gt; array(&nbsp;</div></li><li><div>                &quot;name&quot; =&gt; __( 'Increment Value', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;description&quot; =&gt; __( 'Increment a value per entry.', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;processor&quot; =&gt; array( $this, 'increment_value' ), &nbsp;</div></li><li><div>                &quot;template&quot; =&gt; CFCORE_PATH . &quot;processors/increment/config.php&quot;, &nbsp;</div></li><li><div>                &quot;single&quot; =&gt; true, &nbsp;</div></li><li><div>                &quot;conditionals&quot; =&gt; false, &nbsp;</div></li><li><div>                &quot;magic_tags&quot; =&gt; array(&nbsp;</div></li><li><div>                    'increment_value'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        // akismet&nbsp;</div></li><li><div>        $wp_api_key = get_option( 'wordpress_api_key' );&nbsp;</div></li><li><div>        if ( ! empty( $wp_api_key ) ) {&nbsp;</div></li><li><div>            $internal_processors[ 'akismet' ] = array(&nbsp;</div></li><li><div>                &quot;name&quot; =&gt; __( 'Akismet', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;description&quot; =&gt; __( 'Anti-spam filtering', 'caldera-forms' ), &nbsp;</div></li><li><div>                &quot;pre_processor&quot; =&gt; array( $this, 'akismet_scanner' ), &nbsp;</div></li><li><div>                &quot;template&quot; =&gt; CFCORE_PATH . &quot;processors/akismet/config.php&quot;, &nbsp;</div></li><li><div>                &quot;single&quot; =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $processors ) || empty( $processors ) ) {&nbsp;</div></li><li><div>            return $internal_processors;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge( $processors, $internal_processors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Increment value using the incrimental value processor&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $config Processor config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array Key is new value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function increment_value( $config, $form ) {&nbsp;</div></li><li><div>        $option = '_increment_' . $config[ 'processor_id' ];&nbsp;</div></li><li><div>        $field_id = $field_value = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $config[ 'field' ] ) ) {&nbsp;</div></li><li><div>            $field_id = $config[ 'field' ];&nbsp;</div></li><li><div>            $field_value = Caldera_Forms::get_field_data( $field_id, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $saved_value = get_option( $option, $config[ 'start' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric( $field_value ) ) {&nbsp;</div></li><li><div>            $increment_value = $saved_value + $field_value;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $increment_value = $saved_value + 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter value for incremental processor&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Runs after logic of incremental value is calculated, before is written to field value or tracking option&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.4.5&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $increment_value New value&nbsp;</div></li><li><div>         * @param int $saved_value Previous value&nbsp;</div></li><li><div>         * @param array $config Processor config&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $increment_value = apply_filters( 'caldera_forms_incremental_value', $increment_value, $saved_value, $config, $form );&nbsp;</div></li><li><div>        update_option( $option, $increment_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field_id ) {&nbsp;</div></li><li><div>            self::set_field_data( $field_id, $increment_value, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'increment_value' =&gt; $increment_value&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Apply Akismets&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $config Processor config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function akismet_scanner( $config, $form ) {&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_api_key = get_option( 'wordpress_api_key' );&nbsp;</div></li><li><div>        if ( empty( $wp_api_key ) ) {&nbsp;</div></li><li><div>            return array( 'type' =&gt; 'error', 'note' =&gt; __( 'Akismet not setup.' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // set permalink&nbsp;</div></li><li><div>        if ( $post-&gt;ID ) {&nbsp;</div></li><li><div>            $permalink = get_permalink( $post-&gt;ID );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $permalink = get_home_url();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // is contact form or reg form&nbsp;</div></li><li><div>        $regform = self::get_processor_by_type( 'user_register', $form );&nbsp;</div></li><li><div>        if ( ! empty( $regform ) ) {&nbsp;</div></li><li><div>            $type = 'signup';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $type = 'contact-form';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Call to comment check&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'blog' =&gt; get_home_url(), &nbsp;</div></li><li><div>            'user_ip' =&gt; $_SERVER[ 'REMOTE_ADDR' ], &nbsp;</div></li><li><div>            'user_agent' =&gt; $_SERVER[ 'HTTP_USER_AGENT' ], &nbsp;</div></li><li><div>            'referrer' =&gt; $_SERVER[ 'HTTP_REFERER' ], &nbsp;</div></li><li><div>            'permalink' =&gt; $permalink, &nbsp;</div></li><li><div>            'comment_type' =&gt; $type, &nbsp;</div></li><li><div>            'comment_author' =&gt; self::do_magic_tags( $config[ 'sender_name' ] ), &nbsp;</div></li><li><div>            'comment_author_email' =&gt; self::do_magic_tags( $config[ 'sender_email' ] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $config[ 'url' ] ) ) {&nbsp;</div></li><li><div>            $data[ 'comment_author_url' ] = self::do_magic_tags( $config[ 'url' ] );&nbsp;</div></li><li><div>        };&nbsp;</div></li><li><div>        if ( ! empty( $config[ 'content' ] ) ) {&nbsp;</div></li><li><div>            $data[ 'comment_content' ] = self::do_magic_tags( $config[ 'content' ] );&nbsp;</div></li><li><div>        };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request = http_build_query( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $host = $http_host = $wp_api_key . '.rest.akismet.com';&nbsp;</div></li><li><div>        $path = '/1.1/comment-check';&nbsp;</div></li><li><div>        $port = 80;&nbsp;</div></li><li><div>        $akismet_ua = &quot;WordPress/3.8.1 | Akismet/2.5.9&quot;;&nbsp;</div></li><li><div>        $content_length = strlen( $request );&nbsp;</div></li><li><div>        $http_request = &quot;POST $path HTTP/1.0\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= &quot;Host: $host\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= &quot;Content-Length: {$content_length}\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= &quot;User-Agent: {$akismet_ua}\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>        $http_request .= $request;&nbsp;</div></li><li><div>        $response = '';&nbsp;</div></li><li><div>        if ( false != ( $fs = @fsockopen( $http_host, $port, $errno, $errstr, 10 ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            fwrite( $fs, $http_request );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            while ( ! feof( $fs ) ) {&nbsp;</div></li><li><div>                $response .= fgets( $fs, 1160 );&nbsp;</div></li><li><div>            } // One TCP-IP packet&nbsp;</div></li><li><div>            fclose( $fs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $response = explode( &quot;\r\n\r\n&quot;, $response, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'true' == $response[ 1 ] ) {&nbsp;</div></li><li><div>            return array( 'type' =&gt; 'error', 'note' =&gt; self::do_magic_tags( $config[ 'error' ] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process a calculation field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $value The calculation to run&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return int|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function run_calculation( $value, $field, $form ) {&nbsp;</div></li><li><div>        if( false === Caldera_Forms_Field_Util::check_conditional( $field, $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formula = $field[ 'config' ][ 'formular' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get manual&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'config' ][ 'manual' ] ) ) {&nbsp;</div></li><li><div>            $formula = $field[ 'config' ][ 'manual_formula' ];&nbsp;</div></li><li><div>            preg_match_all( &quot;/%(.+?)%/&quot;, $formula, $hastags );&nbsp;</div></li><li><div>            if ( ! empty( $hastags[ 1 ] ) ) {&nbsp;</div></li><li><div>                $binds = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $hastags[ 1 ] as $tag_key =&gt; $tag ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $form[ 'fields' ] as $key_id =&gt; $fcfg ) {&nbsp;</div></li><li><div>                        if ( $fcfg[ 'slug' ] === $tag ) {&nbsp;</div></li><li><div>                            $binds[] = '#' . $key_id;&nbsp;</div></li><li><div>                            $bindfields[] = '&quot;' . $key_id . '&quot;';&nbsp;</div></li><li><div>                            $formula = str_replace( $hastags[ 0 ][ $tag_key ], $key_id, $formula );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( empty( $formula ) ) {&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formula = self::do_magic_tags( $formula, null, $form );&nbsp;</div></li><li><div>        if ( false !== strpos( $formula, 'Math.' ) ) {&nbsp;</div></li><li><div>            $formula = str_replace( 'Math.', '', $formula );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ( $form[ 'fields' ] as $fid =&gt; $cfg ) {&nbsp;</div></li><li><div>            if ( false !== strpos( $formula, $fid ) ) {&nbsp;</div></li><li><div>                $entry_value = self::get_field_data( $fid, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_array( $entry_value ) ) {&nbsp;</div></li><li><div>                    $number = floatval( array_sum( $entry_value ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $number = floatval( $entry_value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $formula = str_replace( $fid, $number, $formula );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( false !== strpos( $formula, '/0' ) ) {&nbsp;</div></li><li><div>            return new WP_Error( $field[ 'ID' ] . '-calculation', __( 'Calculation is invalid (division by zero)', 'caldera-forms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total_function = create_function( null, 'return ' . $formula . ';' );&nbsp;</div></li><li><div>        $total = $total_function();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_infinite( $total ) || ! is_numeric( $total ) ) {&nbsp;</div></li><li><div>            return new WP_Error( $field[ 'ID' ] . '-calculation', __( 'Calculation is invalid', 'caldera-forms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total = Caldera_Forms_Field_Util::format_calc_field( $field, $total );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Include the template for a calculation field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string HTML for field.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function calculations_templates() {&nbsp;</div></li><li><div>        include CFCORE_PATH . &quot;fields/calculation/line-templates.php&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check to see if the field is used in a calculation (use to display the label)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $value Value to filter.&nbsp;</div></li><li><div>     * @param array $field Field config.&nbsp;</div></li><li><div>     * @param array $form Form congig.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function filter_options_calculator( $value, $field, $form ) {&nbsp;</div></li><li><div>        //&nbsp;</div></li><li><div>        if ( ! empty( $form ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'fields' ] as $field_id =&gt; $field_conf ) {&nbsp;</div></li><li><div>                if ( $field_conf[ 'type' ] !== 'calculation' ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // auto&nbsp;</div></li><li><div>                if ( ! empty( $field_conf[ 'config' ] ) ) {&nbsp;</div></li><li><div>                    $binddown = json_encode( $field_conf[ 'config' ][ 'config' ] );&nbsp;</div></li><li><div>                    if ( false !== strpos( $binddown, $field[ 'ID' ] ) || false !== strpos( $field_conf[ 'config' ][ 'manual_formula' ], $field[ 'ID' ] ) ) {&nbsp;</div></li><li><div>                        foreach ( $field[ 'config' ][ 'option' ] as $option_id =&gt; $option ) {&nbsp;</div></li><li><div>                            if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                                if ( in_array( $option[ 'value' ], $value ) ) {&nbsp;</div></li><li><div>                                    $key = array_search( $option[ 'value' ], $value );&nbsp;</div></li><li><div>                                    $value[ $key ] = $option[ 'label' ] . '&nbsp;&lt;small class=&quot;view_option_value&quot;&gt;(' . $value[ $key ] . ')&lt;/small&gt;';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                if ( $option[ 'value' ] == $value ) {&nbsp;</div></li><li><div>                                    return $option[ 'label' ] . '&nbsp;&lt;small class=&quot;view_option_value&quot;&gt;(' . $value . ')&lt;/small&gt;';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                        $value = implode( '&lt;br&gt;', $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Applies the inline rules for fields conditionals&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array Options for field&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function apply_conditional_groups( $field, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'conditional_groups' ][ 'conditions' ][ $field[ 'conditions' ][ 'type' ] ] ) ) {&nbsp;</div></li><li><div>            $group = $form[ 'conditional_groups' ][ 'conditions' ][ $field[ 'conditions' ][ 'type' ] ];&nbsp;</div></li><li><div>            if ( ! isset( $field[ 'conditions' ][ 'group' ] ) ) {&nbsp;</div></li><li><div>                $field[ 'conditions' ][ 'group' ] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $group[ 'group' ] ) ) {&nbsp;</div></li><li><div>                $group[ 'group' ] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field[ 'conditions' ][ 'type' ]  = $group[ 'type' ];&nbsp;</div></li><li><div>            $field[ 'conditions' ][ 'group' ] = $group[ 'group' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Default callback for auto populating select fields&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array Options for field&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function auto_populate_options_field( $field, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'config' ][ 'auto' ] ) ) {&nbsp;</div></li><li><div>            $field[ 'config' ][ 'option' ] = array();&nbsp;</div></li><li><div>            switch ( $field[ 'config' ][ 'auto_type' ] ) {&nbsp;</div></li><li><div>                case 'post_type':&nbsp;</div></li><li><div>                case 'easy-query' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $field[ 'config' ][ 'orderby_post' ] ) ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'orderby_post' ] = 'date';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $field[ 'config' ][ 'order' ] ) ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'order' ] = 'ASC';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $args = array(&nbsp;</div></li><li><div>                        'post_type' =&gt; $field[ 'config' ][ 'post_type' ], &nbsp;</div></li><li><div>                        'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>                        'posts_per_page' =&gt; - 1, &nbsp;</div></li><li><div>                        'order' =&gt; $field[ 'config' ][ 'order' ], &nbsp;</div></li><li><div>                        'orderby' =&gt; $field[ 'config' ][ 'orderby_post' ]&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Modify arguments for WP_Query used to auto-populate post type fields&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since unknown&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param array $args Args for WP_Query&nbsp;</div></li><li><div>                     * @param array $form Form config&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $args = apply_filters( 'caldera_forms_autopopulate_post_type_args', $args, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $posts = get_posts( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $field[ 'config' ][ 'value_field' ] === 'id' ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'value_field' ] = 'ID';&nbsp;</div></li><li><div>                    } elseif ( $field[ 'config' ][ 'value_field' ] === 'name' ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'value_field' ] = 'post_name';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter which field is used for the VALUE when getting autopopulate option values when autopopulating options from post types&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * Value can be any WP_Post field, or a meta key (be careful will return an empty string if that meta key isn't set for the post.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 1.2.2&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $field What field to use for the value. Default is &quot;ID&quot;.&nbsp;</div></li><li><div>                     * @param array $field Config for the field.&nbsp;</div></li><li><div>                     * @param array $form Config for the form.&nbsp;</div></li><li><div>                     * @param array $posts Current post collection.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $field_for_value = apply_filters( 'caldera_forms_autopopulate_options_post_value_field', $field[ 'config' ][ 'value_field' ], $field, $form, $posts );&nbsp;</div></li><li><div>                    $field[ 'config' ][ 'value_field' ] = $field_for_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter which field is used for the LABEL when getting autopopulate option values when autopopulating options from post types&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * Value can be any WP_Post field, or a meta key (be careful will return an empty string if that meta key isn't set for the post.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 1.2.2&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $field What field to use for the label. Default is &quot;post_title&quot;.&nbsp;</div></li><li><div>                     * @param array $field Config for the field.&nbsp;</div></li><li><div>                     * @param array $form Config for the form.&nbsp;</div></li><li><div>                     * @param array $posts Current post collection.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $field_for_label = apply_filters( 'caldera_forms_autopopulate_options_post_label_field', 'post_title', $field, $form, $posts );&nbsp;</div></li><li><div>                    foreach ( $posts as $post_item ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'option' ][ $post_item-&gt;ID ] = array(&nbsp;</div></li><li><div>                            'value' =&gt; $post_item-&gt;{$field_for_value}, &nbsp;</div></li><li><div>                            'label' =&gt; $post_item-&gt;{$field_for_label}&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'taxonomy':&nbsp;</div></li><li><div>                    if ( $field[ 'config' ][ 'value_field' ] === 'id' ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'value_field' ] = 'term_id';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $field[ 'config' ][ 'orderby_tax' ] ) ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'orderby_tax' ] = 'count';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $field[ 'config' ][ 'order' ] ) ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'order' ] = 'ASC';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $args = array(&nbsp;</div></li><li><div>                        'orderby' =&gt; $field[ 'config' ][ 'orderby_tax' ], &nbsp;</div></li><li><div>                        'order' =&gt; $field[ 'config' ][ 'order' ], &nbsp;</div></li><li><div>                        'hide_empty' =&gt; 0&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Modify arguments for get_terms() used to auto-populate taxononmy type fields&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since unknown&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param array $args Args for get_terms()&nbsp;</div></li><li><div>                     * @param array $form Form config&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $args = apply_filters( 'caldera_forms_autopopulate_taxonomy_args', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $terms = get_terms( $field[ 'config' ][ 'taxonomy' ], $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter which field is used for the VALUE when getting autopopulate option values when autopopulating options from post types&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * Value must be a standard taxonomy term field.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 1.2.2&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $field What field to use for the value. Default is &quot;term_id&quot;.&nbsp;</div></li><li><div>                     * @param array $field Config for the field.&nbsp;</div></li><li><div>                     * @param array $form Config for the form.&nbsp;</div></li><li><div>                     * @param array $posts Current term collection.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $field_for_value = apply_filters( 'caldera_forms_autopopulate_options_taxonomy_value_field', $field[ 'config' ][ 'value_field' ], $field, $form, $terms );&nbsp;</div></li><li><div>                    $field[ 'config' ][ 'value_field' ] = $field_for_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter which field is used for the LABEL when getting autopopulate option values when autopopulating options from post types&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * Value must be a standard taxonomy term field.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 1.2.2&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $field What field to use for the label. Default is &quot;name&quot;.&nbsp;</div></li><li><div>                     * @param array $field Config for the field.&nbsp;</div></li><li><div>                     * @param array $form Config for the form.&nbsp;</div></li><li><div>                     * @param array $posts Current term collection.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $field_for_label = apply_filters( 'caldera_forms_autopopulate_options_taxonomy_label_field', 'name', $field, $form, $terms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $terms as $term ) {&nbsp;</div></li><li><div>                        $field[ 'config' ][ 'option' ][ $term-&gt;term_id ] = array(&nbsp;</div></li><li><div>                            'value' =&gt; $term-&gt;{$field_for_value}, &nbsp;</div></li><li><div>                            'label' =&gt; $term-&gt;{$field_for_label}&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $field = self::format_select_options( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify and format select options&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.2&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $field Field config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function format_select_options( $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'config' ][ 'option' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $field[ 'config' ][ 'option' ] as &$option ) {&nbsp;</div></li><li><div>                if ( strlen( $option[ 'value' ] ) === 0 ) {&nbsp;</div></li><li><div>                    $option[ 'value' ] = $option[ 'label' ] = self::do_magic_tags( $option[ 'label' ] );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $option[ 'value' ] = self::do_magic_tags( $option[ 'value' ] );&nbsp;</div></li><li><div>                    $option[ 'label' ] = self::do_magic_tags( $option[ 'label' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Evaluate a conditional.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $conditions Conditions.&nbsp;</div></li><li><div>     * @param array $form Form config.&nbsp;</div></li><li><div>     * @param null|int $entry_id Optional. Entry ID to test by.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function check_condition( $conditions, $form, $entry_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $trues = array();&nbsp;</div></li><li><div>        if ( empty( $conditions[ 'group' ] ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $conditions[ 'group' ] as $groupid =&gt; $lines ) {&nbsp;</div></li><li><div>            $truelines = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $lines as $lineid =&gt; $line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $form[ 'fields' ][ $line[ 'field' ] ][ 'config' ][ 'option' ][ $line[ 'value' ] ] ) ) {&nbsp;</div></li><li><div>                    $line[ 'value' ] = $form[ 'fields' ][ $line[ 'field' ] ][ 'config' ][ 'option' ][ $line[ 'value' ] ][ 'value' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $line[ 'value' ] = self::do_magic_tags( $line[ 'value' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $value = (array) self::get_field_data( $line[ 'field' ], $form, $entry_id );&nbsp;</div></li><li><div>                if ( empty( $value ) ) {&nbsp;</div></li><li><div>                    $value = array( '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // do field value replaces&nbsp;</div></li><li><div>                if ( false !== strpos( $line[ 'value' ], '%' ) ) {&nbsp;</div></li><li><div>                    $isslug = self::get_slug_data( trim( $line[ 'value' ], '%' ), $form, $entry_id );&nbsp;</div></li><li><div>                    if ( $isslug !== null ) {&nbsp;</div></li><li><div>                        $line[ 'value' ] = $isslug;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $truelines[ $lineid ] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $line[ 'compare' ] ) {&nbsp;</div></li><li><div>                    case 'is':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            if ( in_array( $line[ 'value' ], $value ) ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( $value == $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'isnot':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            if ( ! in_array( $line[ 'value' ], $value ) ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( $value != $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case '&gt;':&nbsp;</div></li><li><div>                    case 'greater':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            if ( array_sum( $value ) &gt; $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( $value &gt; $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case '&lt;':&nbsp;</div></li><li><div>                    case 'smaller':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            if ( array_sum( $value ) &lt; $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( $value &lt; $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'startswith':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            foreach ( $value as $part ) {&nbsp;</div></li><li><div>                                if ( 0 === strpos( $part, $line[ 'value' ] ) ) {&nbsp;</div></li><li><div>                                    $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( substr( $value, 0, strlen( $line[ 'value' ] ) ) == $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'endswith':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            foreach ( $value as $part ) {&nbsp;</div></li><li><div>                                if ( substr( $part, strlen( $part ) - strlen( $line[ 'value' ] ) ) == $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                    $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( substr( $value, strlen( $value ) - strlen( $line[ 'value' ] ) ) == $line[ 'value' ] ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'contains':&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            if ( false !== strpos( implode( '', $value ), $line[ 'value' ] ) ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            if ( false !== strpos( $value, $line[ 'value' ] ) ) {&nbsp;</div></li><li><div>                                $truelines[ $lineid ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $trues[ $groupid ] = in_array( false, $truelines ) ? false : true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $conditions[ 'type' ] == 'use' || $conditions[ 'type' ] == 'show' ) {&nbsp;</div></li><li><div>            if ( in_array( true, $trues ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( $conditions[ 'type' ] == 'not' || $conditions[ 'type' ] == 'hide' || $conditions[ 'type' ] == 'disable' ) {&nbsp;</div></li><li><div>            if ( ! in_array( true, $trues ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // false if nothing happens&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // FRONT END STUFFF&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Perform redirect&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $type Type of redirect being performed.&nbsp;</div></li><li><div>     * @param string $url URL to redirect to.&nbsp;</div></li><li><div>     * @param array $form Form config.&nbsp;</div></li><li><div>     * @param string $processid Process ID for process calling the redirect.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function form_redirect( $type, $url, $form, $processid ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $url = apply_filters( 'caldera_forms_redirect_url', $url, $form, $processid );&nbsp;</div></li><li><div>        $url = apply_filters( 'caldera_forms_redirect_url_' . $type, $url, $form, $processid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( headers_sent() ) {&nbsp;</div></li><li><div>            remove_action( 'caldera_forms_redirect', 'cf_ajax_redirect', 10 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'caldera_forms_redirect', $type, $url, $form, $processid );&nbsp;</div></li><li><div>        do_action( 'caldera_forms_redirect_' . $type, $url, $form, $processid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $url ) ) {&nbsp;</div></li><li><div>            cf_redirect( $url, 302 );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add default magic tags&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $tags&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_magic_tags( $tags ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get internal tags&nbsp;</div></li><li><div>        $system_tags = array(&nbsp;</div></li><li><div>            'entry_id', &nbsp;</div></li><li><div>            'entry_token', &nbsp;</div></li><li><div>            'ip', &nbsp;</div></li><li><div>            'user:id', &nbsp;</div></li><li><div>            'user:user_login', &nbsp;</div></li><li><div>            'user:first_name', &nbsp;</div></li><li><div>            'user:last_name', &nbsp;</div></li><li><div>            'user:user_email' =&gt; array(&nbsp;</div></li><li><div>                'text', &nbsp;</div></li><li><div>                'email'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'get:*', &nbsp;</div></li><li><div>            'post:*', &nbsp;</div></li><li><div>            'request:*', &nbsp;</div></li><li><div>            'post_meta:*', &nbsp;</div></li><li><div>            'embed_post:ID', &nbsp;</div></li><li><div>            'embed_post:post_title', &nbsp;</div></li><li><div>            'embed_post:permalink', &nbsp;</div></li><li><div>            'embed_post:post_date' =&gt; array(&nbsp;</div></li><li><div>                'text', &nbsp;</div></li><li><div>                'date_picker'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'date:Y-m-d H:i:s' =&gt; array(&nbsp;</div></li><li><div>                'text', &nbsp;</div></li><li><div>                'date_picker'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'date:Y/m/d', &nbsp;</div></li><li><div>            'date:Y/d/m', &nbsp;</div></li><li><div>            'login_url', &nbsp;</div></li><li><div>            'logout_url', &nbsp;</div></li><li><div>            'register_url', &nbsp;</div></li><li><div>            'lostpassword_url'&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tags[ 'system' ] = array(&nbsp;</div></li><li><div>            'type' =&gt; __( 'System Tags', 'caldera-forms' ), &nbsp;</div></li><li><div>            'tags' =&gt; $system_tags, &nbsp;</div></li><li><div>            'wrap' =&gt; array( '{', '}' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get processor tags&nbsp;</div></li><li><div>        $processors = Caldera_Forms_Processor_Load::get_instance()-&gt;get_processors();&nbsp;</div></li><li><div>        if ( ! empty( $processors ) ) {&nbsp;</div></li><li><div>            foreach ( $processors as $processor_key =&gt; $processor ) {&nbsp;</div></li><li><div>                if ( isset( $processor[ 'magic_tags' ] ) ) {&nbsp;</div></li><li><div>                    foreach ( $processor[ 'magic_tags' ] as $key_tag =&gt; $value_tag ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! isset( $tags[ $processor_key ] ) ) {&nbsp;</div></li><li><div>                            $tags[ $processor_key ] = array(&nbsp;</div></li><li><div>                                'type' =&gt; $processor[ 'name' ], &nbsp;</div></li><li><div>                                'tags' =&gt; array(), &nbsp;</div></li><li><div>                                'wrap' =&gt; array( '{', '}' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ( is_array( $value_tag ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            // compatibility specific&nbsp;</div></li><li><div>                            $tag = $processor_key . ':' . $key_tag;&nbsp;</div></li><li><div>                            if ( ! isset( $tags[ $processor_key ][ 'tags' ][ $tag ] ) ) {&nbsp;</div></li><li><div>                                if ( ! in_array( 'text', $value_tag ) ) {&nbsp;</div></li><li><div>                                    $value_tag[] = 'text';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $tags[ $processor_key ][ 'tags' ][ $tag ] = $value_tag;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            // compatibility text&nbsp;</div></li><li><div>                            $tag = $processor_key . ':' . $value_tag;&nbsp;</div></li><li><div>                            if ( ! in_array( $tag, $tags ) ) {&nbsp;</div></li><li><div>                                $tags[ $processor_key ][ 'tags' ][] = $tag;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $tags;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Parse magic tags&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $value&nbsp;</div></li><li><div>     * @param null|int $entry_id Optional. Entry ID to test by.&nbsp;</div></li><li><div>     * @param array $magic_caller The form/processorr/entry to evaluate against. May also be a powerful wizard.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function do_magic_tags( $value, $entry_id = null, $magic_caller = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global  $form, $referrer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_details = array();&nbsp;</div></li><li><div>        $input_value = $value;&nbsp;</div></li><li><div>        $this_form = $form;&nbsp;</div></li><li><div>        // pull in the metadata for entry ID&nbsp;</div></li><li><div>        if ( null !== $entry_id ) {&nbsp;</div></li><li><div>            $entry_details = Caldera_Forms_Magic_Doer::magic_tag_meta_prepare( $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $value ) ) {&nbsp;</div></li><li><div>            if( ! empty( $entry_details ) ) {&nbsp;</div></li><li><div>                $value = Caldera_Forms_Magic_Doer::do_processor_magic( $value, $entry_details );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check for magics&nbsp;</div></li><li><div>            $value = Caldera_Forms_Magic_Doer::do_bracket_magic( $value, $this_form, $entry_id, $magic_caller, $referrer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // fields&nbsp;</div></li><li><div>            $value = Caldera_Forms_Magic_Doer::do_field_magic( $value, $entry_id, $this_form);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all types of fields currently available.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @deprecated Soft deprecated in 1.5.0, will hard deprecated in 1.5.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array Array of field types.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_field_types() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all processors, in a form, of a specific type&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $type Processor type.&nbsp;</div></li><li><div>     * @param array $form Form config&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|bool Processor config if found. False if not.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_processor_by_type( $type, $form ) {&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form_cfg = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>            if ( ! empty( $form_cfg[ 'ID' ] ) ) {&nbsp;</div></li><li><div>                if ( $form_cfg[ 'ID' ] !== $form || empty( $form_cfg[ 'processors' ] ) ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $form = $form_cfg;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            $processors = array();&nbsp;</div></li><li><div>            foreach ( $form[ 'processors' ] as $processor ) {&nbsp;</div></li><li><div>                if ( $processor[ 'type' ] == $type ) {&nbsp;</div></li><li><div>                    $processors[] = $processor;&nbsp;</div></li><li><div>                    $processors[ $processor[ 'ID' ] ] = $processor;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( empty( $processors ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $processors;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set a specific meta key from form meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key Name of key.&nbsp;</div></li><li><div>     * @param mixed $value Value to save.&nbsp;</div></li><li><div>     * @param string|array form Form config array or ID of form.&nbsp;</div></li><li><div>     * @param string $processor_id Optional. ID of processor. Default is &quot;meta&quot;&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function set_submission_meta( $key, $value, $form, $processor_id = 'meta' ) {&nbsp;</div></li><li><div>        global $processed_meta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form[ 'ID' ] = $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set value&nbsp;</div></li><li><div>        if ( isset( $form[ 'ID' ] ) ) {&nbsp;</div></li><li><div>            if ( isset( $processed_meta[ $form[ 'ID' ] ][ $processor_id ][ $key ] ) ) {&nbsp;</div></li><li><div>                if ( in_array( $value, $processed_meta[ $form[ 'ID' ] ][ $processor_id ][ $key ] ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $processed_meta[ $form[ 'ID' ] ][ $processor_id ][ $key ][] = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set a field's data to be saved form a form entry.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $field_id ID of field.&nbsp;</div></li><li><div>     * @param mixed $data Data to save.&nbsp;</div></li><li><div>     * @param string|array form Form config array or ID of form.&nbsp;</div></li><li><div>     * @param bool|false $entry_id Optional. Entry ID to save in.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function set_field_data( $field_id, $data, $form, $entry_id = false ) {&nbsp;</div></li><li><div>        global $processed_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_data = self::get_field_data( $field_id, $form, $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! is_array( $form ) ) {&nbsp;</div></li><li><div>            global  $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! is_array( $form ) ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field = Caldera_Forms_Field_Util::get_field( $field_id, $form );&nbsp;</div></li><li><div>        if( is_array( $field ) && false === Caldera_Forms_Field_Util::check_conditional( $field, $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // form object&nbsp;</div></li><li><div>        if ( isset( $form[ 'ID' ] ) ) {&nbsp;</div></li><li><div>            if ( isset( $form[ 'fields' ][ $field_id ] ) ) {&nbsp;</div></li><li><div>                $processed_data[ $form[ 'ID' ] ][ $field_id ] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // is field_id a slug perhaps?&nbsp;</div></li><li><div>                foreach ( $form[ 'fields' ] as $field ) {&nbsp;</div></li><li><div>                    if ( $field[ 'slug' ] == $field_id ) {&nbsp;</div></li><li><div>                        $processed_data[ $form[ 'ID' ] ][ $field[ 'ID' ] ] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        return true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // generic field data&nbsp;</div></li><li><div>        $processed_data[ $form[ 'ID' ] ][ $field_id ] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a field's data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0.8&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $field_id ID of field.&nbsp;</div></li><li><div>     * @param string|array $form Form config array or ID of form.&nbsp;</div></li><li><div>     * @param bool|false $entry_id Optional. Entry ID to save in.&nbsp;</div></li><li><div>     * @param bool $check_conditionals. Optional. If conditionals should be checked. Default is true. @since 1.5.0.8&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_field_data( $field_id, $form, $entry_id = false, $check_conditionals = true ) {&nbsp;</div></li><li><div>        global $processed_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>            if ( ! isset( $form[ 'ID' ] ) || $form[ 'ID' ] !== $form ) {&nbsp;</div></li><li><div>                return null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! is_array( $form ) ) {&nbsp;</div></li><li><div>            global  $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! is_array( $form ) ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field = Caldera_Forms_Field_Util::get_field( $field_id, $form );&nbsp;</div></li><li><div>        if( $check_conditionals && is_array( $field ) && false === Caldera_Forms_Field_Util::check_conditional( $field, $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $indexkey = $form[ 'ID' ];&nbsp;</div></li><li><div>        if ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>            $indexkey = $form[ 'ID' ] . '_' . $entry_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // is ID or slug?&nbsp;</div></li><li><div>        if ( ! isset( $form[ 'fields' ][ $field_id ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'fields' ] as $field ) {&nbsp;</div></li><li><div>                if ( $field[ 'slug' ] == $field_id ) {&nbsp;</div></li><li><div>                    $field_id = $field[ 'ID' ];&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get processed cached item&nbsp;</div></li><li><div>        if ( isset( $processed_data[ $indexkey ][ $field_id ] ) ) {&nbsp;</div></li><li><div>            return $processed_data[ $indexkey ][ $field_id ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // entry fetch&nbsp;</div></li><li><div>        if ( ! empty( $entry_id ) && isset( $form[ 'fields' ][ $field_id ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $entry = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT `value` FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_values` WHERE `entry_id` = %d AND `field_id` = %s AND `slug` = %s&quot;, $entry_id, $field_id, $form[ 'fields' ][ $field_id ][ 'slug' ] ), ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //allow plugins to alter the value&nbsp;</div></li><li><div>            $entry = apply_filters( 'caldera_forms_get_field_entry', $entry, $field_id, $form, $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $entry ) ) {&nbsp;</div></li><li><div>                if ( count( $entry ) &gt; 1 ) {&nbsp;</div></li><li><div>                    $out = array();&nbsp;</div></li><li><div>                    foreach ( $entry as $item ) {&nbsp;</div></li><li><div>                        $out[] = $item[ 'value' ];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $processed_data[ $indexkey ][ $field_id ] = $out;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $processed_data[ $indexkey ][ $field_id ] = $entry[ 0 ][ 'value' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $processed_data[ $indexkey ][ $field_id ] = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $processed_data[ $indexkey ][ $field_id ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $form[ 'fields' ][ $field_id ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // get field&nbsp;</div></li><li><div>            $field = apply_filters( 'caldera_forms_render_setup_field', $form[ 'fields' ][ $field_id ], $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $field ) || ! isset( $field[ 'ID' ] ) ) {&nbsp;</div></li><li><div>                return null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // get field types&nbsp;</div></li><li><div>            $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $field_types[ $field[ 'type' ] ] ) ) {&nbsp;</div></li><li><div>                return null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $entry = null;&nbsp;</div></li><li><div>            // dont bother if conditions say it shouldnt be here.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $field[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                if ( ! self::check_condition( $field[ 'conditions' ], $form, $entry_id ) ) {&nbsp;</div></li><li><div>                    $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return $entry;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check condition to see if field should be there first.&nbsp;</div></li><li><div>            // check if conditions match first. ignore vailators if not part of condition&nbsp;</div></li><li><div>            if ( isset( $_POST[ $field_id ] ) ) {&nbsp;</div></li><li><div>                $entry = stripslashes_deep( $_POST[ $field_id ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } elseif ( isset( $_POST[ $field[ 'slug' ] ] ) ) {&nbsp;</div></li><li><div>                // is slug maybe?&nbsp;</div></li><li><div>                $entry = stripslashes_deep( $_POST[ $field[ 'slug' ] ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // apply field filter&nbsp;</div></li><li><div>            if ( has_filter( 'caldera_forms_process_field_' . $field[ 'type' ] ) ) {&nbsp;</div></li><li><div>                $entry = apply_filters( 'caldera_forms_process_field_' . $field[ 'type' ], $entry, $field, $form );&nbsp;</div></li><li><div>                if ( is_wp_error( $entry ) ) {&nbsp;</div></li><li><div>                    $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>                    return $entry;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_string( $entry ) && strlen( $entry ) &lt;= 0 ) {&nbsp;</div></li><li><div>                $entry = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // is static&nbsp;</div></li><li><div>            if ( ! empty( $field_types[ $field[ 'type' ] ][ 'static' ] ) ) {&nbsp;</div></li><li><div>                // is options or not&nbsp;</div></li><li><div>                if ( ! empty( $field_types[ $field[ 'type' ] ][ 'options' ] ) ) {&nbsp;</div></li><li><div>                    if ( is_array( $entry ) ) {&nbsp;</div></li><li><div>                        $out = array();&nbsp;</div></li><li><div>                        foreach ( $entry as $option_id =&gt; $option ) {&nbsp;</div></li><li><div>                            if ( isset( $field[ 'config' ][ 'option' ][ $option_id ] ) ) {&nbsp;</div></li><li><div>                                if ( ! isset( $field[ 'config' ][ 'option' ][ $option_id ][ 'value' ] ) ) {&nbsp;</div></li><li><div>                                    $field[ 'config' ][ 'option' ][ $option_id ][ 'value' ] = $field[ 'config' ][ 'option' ][ $option_id ][ 'label' ];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if( empty( $field[ 'config' ][ 'option' ][ $option_id ][ 'value' ] ) ) {&nbsp;</div></li><li><div>                                    $field[ 'config' ][ 'option' ][ $option_id ][ 'value' ] = $field[ 'config' ][ 'option' ][ $option_id ][ 'label' ];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $out[ $option_id ] = self::do_magic_tags( $field[ 'config' ][ 'option' ][ $option_id ][ 'value' ] );&nbsp;</div></li><li><div>                            } elseif ( isset( $field[ 'config' ][ 'option' ][ $option ] ) ) {&nbsp;</div></li><li><div>                                if ( ! isset( $field[ 'config' ][ 'option' ][ $option ][ 'value' ] ) ) {&nbsp;</div></li><li><div>                                    $field[ 'config' ][ 'option' ][ $option ][ 'value' ] = $field[ 'config' ][ 'option' ][ $option ][ 'label' ];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $out[ $option_id ] = self::do_magic_tags( $field[ 'config' ][ 'option' ][ $option ][ 'value' ] );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                // array based / check value agains submitted array.&nbsp;</div></li><li><div>                                foreach ( $field[ 'config' ][ 'option' ] as $option_id =&gt; $set_option ) {&nbsp;</div></li><li><div>                                    if ( $set_option[ 'value' ] === $option ) {&nbsp;</div></li><li><div>                                        $out[] = self::do_magic_tags( $set_option[ 'value' ] );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $processed_data[ $indexkey ][ $field_id ] = $out;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        if ( ! empty( $field[ 'config' ][ 'option' ] ) ) {&nbsp;</div></li><li><div>                            foreach ( $field[ 'config' ][ 'option' ] as $option ) {&nbsp;</div></li><li><div>                                if ( $option[ 'value' ] == $entry ) {&nbsp;</div></li><li><div>                                    $processed_data[ $indexkey ][ $field_id ] = self::do_magic_tags( $entry );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }else{&nbsp;</div></li><li><div>                    if( '0' === $entry || 0 === $entry ) {&nbsp;</div></li><li><div>                        $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>                    }elseif ( ! empty( $entry ) ) {&nbsp;</div></li><li><div>                        $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>                    } elseif( isset( $field[ 'config' ][ 'default' ] )) {&nbsp;</div></li><li><div>                        $processed_data[ $indexkey ][ $field_id ] = self::do_magic_tags( $field[ 'config' ][ 'default' ] );&nbsp;</div></li><li><div>                    }else{&nbsp;</div></li><li><div>                        $processed_data[ $indexkey ][ $field_id ] = '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                // dynamic&nbsp;</div></li><li><div>                $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_tag = self::do_magic_tags( $field_id );&nbsp;</div></li><li><div>            if ( $is_tag !== $field_id ) {&nbsp;</div></li><li><div>                $processed_data[ $indexkey ][ $field_id ] = $is_tag;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $processed_data[ $indexkey ][ $field_id ] ) ) {&nbsp;</div></li><li><div>            return $processed_data[ $indexkey ][ $field_id ];&nbsp;</div></li><li><div>        }elseif( ! empty( $entry ) ) {&nbsp;</div></li><li><div>            $processed_data[ $indexkey ][ $field_id ] = $entry;&nbsp;</div></li><li><div>            return $entry;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the configuration for a field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @deprecated (Soft deprecated in 1.5.0, will be for reals deprecated in 1.6.0)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $slug Slug of field to get config for.&nbsp;</div></li><li><div>     * @param array $form Form config array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool|mixed|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_field_by_slug( $slug, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return Caldera_Forms_Field_Util::get_field_by_slug( $slug, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get field data, by slug, and by entry.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $slug Slug of field to get config for.&nbsp;</div></li><li><div>     * @param array $form Form config array.&nbsp;</div></li><li><div>     * @param bool|false $entry_id Optional. The entry ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool|array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_slug_data( $slug, $form, $entry_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $out = array();&nbsp;</div></li><li><div>        if ( false !== strpos( $slug, '.' ) ) {&nbsp;</div></li><li><div>            $slug_parts = explode( '.', $slug );&nbsp;</div></li><li><div>            $slug = array_shift( $slug_parts );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field[ 'slug' ] == $slug ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return self::get_field_data( $field_id, $form, $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get saved data for a form entry&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $entry_id Entry ID&nbsp;</div></li><li><div>     * @param null|array $form Optional. Form config.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|null|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_entry_detail( $entry_id, $form = null ) {&nbsp;</div></li><li><div>        global $wpdb, $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entries` WHERE `id` = %d&quot;, $entry_id ), ARRAY_A );&nbsp;</div></li><li><div>        if ( ! empty( $entry ) ) {&nbsp;</div></li><li><div>            if ( null === $form ) {&nbsp;</div></li><li><div>                $form = Caldera_Forms_Forms::get_form( $entry[ 'form_id' ] );&nbsp;</div></li><li><div>                if ( empty( $form ) ) {&nbsp;</div></li><li><div>                    return null;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // get meta if any&nbsp;</div></li><li><div>            $meta = self::get_entry_meta( $entry_id, $form );&nbsp;</div></li><li><div>            if ( ! empty( $meta ) ) {&nbsp;</div></li><li><div>                $entry[ 'meta' ] = $meta;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $entry = apply_filters( 'caldera_forms_get_entry_detail', $entry, $entry_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $entry;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all meta for an entry.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $entry_id Entry ID&nbsp;</div></li><li><div>     * @param array $form Form config.&nbsp;</div></li><li><div>     * @param null|string $type Optional. Type of meta to get. If null, the default, all meta is returned.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_entry_meta( $entry_id, $form, $type = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_meta = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_meta_data = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT * FROM `&quot; . $wpdb-&gt;prefix . &quot;cf_form_entry_meta` WHERE `entry_id` = %d&quot;, $entry_id ), ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $entry_meta_data ) ) {&nbsp;</div></li><li><div>            $processors = Caldera_Forms_Processor_Load::get_instance()-&gt;get_processors();&nbsp;</div></li><li><div>            foreach ( $entry_meta_data as $meta_index =&gt; $meta ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // is json?&nbsp;</div></li><li><div>                $is_json = @json_decode( $meta[ 'meta_value' ], ARRAY_A );&nbsp;</div></li><li><div>                if ( ! empty( $is_json ) ) {&nbsp;</div></li><li><div>                    $meta[ 'meta_value' ] = $is_json;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $group = 'meta';&nbsp;</div></li><li><div>                $meta = apply_filters( 'caldera_forms_get_entry_meta', $meta, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $form[ 'processors' ][ $meta[ 'process_id' ] ] ) || $meta[ 'process_id' ] == '_debug_log' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $meta[ 'process_id' ] == '_debug_log' ) {&nbsp;</div></li><li><div>                        $meta[ 'meta_value' ]  = '&lt;pre&gt;' . $meta[ 'meta_value' ] . '&lt;/pre&gt;';&nbsp;</div></li><li><div>                        $entry_meta[ 'debug' ] = array(&nbsp;</div></li><li><div>                            'name' =&gt; __( 'Mailer Debug', 'caldera-forms' ), &nbsp;</div></li><li><div>                            'data' =&gt; array(&nbsp;</div></li><li><div>                                '_debug_log' =&gt; array(&nbsp;</div></li><li><div>                                    'entry' =&gt; array(&nbsp;</div></li><li><div>                                        'log' =&gt; $meta&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $process_config = array();&nbsp;</div></li><li><div>                    if ( isset( $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'config' ] ) ) {&nbsp;</div></li><li><div>                        $process_config = $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'config' ];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $group = $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ];&nbsp;</div></li><li><div>                    if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>                        if ( $group != $type ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $meta = apply_filters( 'caldera_forms_get_entry_meta_' . $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ], $meta, $process_config, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // allows plugins to remove it.&nbsp;</div></li><li><div>                    if ( ! empty( $meta ) ) {&nbsp;</div></li><li><div>                        if ( ! isset( $entry_meta[ $group ] ) ) {&nbsp;</div></li><li><div>                            // is processor&nbsp;</div></li><li><div>                            if ( isset( $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ] ) && isset( $processors[ $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ] ] ) ) {&nbsp;</div></li><li><div>                                $meta_name = $processors[ $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ] ][ 'name' ];&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                if ( $meta[ 'process_id' ] == '_debug_log' ) {&nbsp;</div></li><li><div>                                    $meta_name = __( 'Mailer Debug', 'caldera-forms' );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $meta_name = $meta[ 'process_id' ];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $entry_meta[ $group ] = array(&nbsp;</div></li><li><div>                                'name' =&gt; $meta_name, &nbsp;</div></li><li><div>                                'data' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                            // custom template&nbsp;</div></li><li><div>                            if ( isset( $processors[ $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ] ][ 'meta_template' ] ) && file_exists( $processors[ $form[ 'processors' ][ $meta[ 'process_id' ] ][ 'type' ] ][ 'meta_template' ] ) ) {&nbsp;</div></li><li><div>                                $entry_meta[ $group ][ $group . '_template' ] = $entry_meta[ $group ][ 'template' ] = true;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        //if(!empty($meta['meta_title'])) {&nbsp;</div></li><li><div>                        //    $entry_meta[$group]['data'][$meta['process_id']]['title'] = $meta['meta_title'];&nbsp;</div></li><li><div>                        //}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $entry_meta[ $group ][ 'data' ][ $meta[ 'process_id' ] ][ 'entry' ][ $meta[ 'meta_key' ] ] = $meta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        /**if(is_array($meta['meta_value'])) {&nbsp;</div></li><li><div>                            foreach($meta['meta_value'] as $mkey=&gt;$mval) {&nbsp;</div></li><li><div>                                $entry['meta'][$group]['data'][$meta['process_id']]['title'] = $meta['meta_key'];&nbsp;</div></li><li><div>                                $entry['meta'][$group]['data'][$meta['process_id']]['entry'][] = array(&nbsp;</div></li><li><div>                                    'meta_key' =&gt; $mkey, &nbsp;</div></li><li><div>                                    'meta_value' =&gt; $mval&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }else{&nbsp;</div></li><li><div>                            $entry['meta'][$group]['data'][$meta['process_id']]['entry'][] = array(&nbsp;</div></li><li><div>                                'meta_key' =&gt; $meta['meta_key'], &nbsp;</div></li><li><div>                                'meta_value' =&gt; $meta['meta_value']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        }*/&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // if type&nbsp;</div></li><li><div>        if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>            //return only type&nbsp;</div></li><li><div>            if ( ! empty( $entry_meta[ $type ][ 'data' ] ) ) {&nbsp;</div></li><li><div>                return $entry_meta[ $type ][ 'data' ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $entry_meta;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get submission data from a form being submitted or a saved entry&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form Form Config.&nbsp;</div></li><li><div>     * @param bool|false $entry_id Optional. Entry ID to get data for, or if false, the default, get form current submission.&nbsp;</div></li><li><div>     * @param bool $check_conditionals. Optional. If conditionals should be checked. Default is true. @since 1.5.0.8&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|\WP_Error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_submission_data( $form, $entry_id = false, $check_conditionals = true ) {&nbsp;</div></li><li><div>        global $processed_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form_id = $form;&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>            if ( ! isset( $form[ 'ID' ] ) || $form[ 'ID' ] !== $form_id ) {&nbsp;</div></li><li><div>                return new WP_Error( 'fail', __( 'Invalid form ID', 'caldera-forms' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $indexkey = $form[ 'ID' ];&nbsp;</div></li><li><div>        if ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>            $indexkey = $form[ 'ID' ] . '_' . $entry_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get processed cached item using the form id&nbsp;</div></li><li><div>        if ( isset( $processed_data[ $indexkey ] ) ) {&nbsp;</div></li><li><div>            return $processed_data[ $indexkey ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // prep data array&nbsp;</div></li><li><div>        $processed_data[ $indexkey ] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // initialize process data&nbsp;</div></li><li><div>        foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>            // get data&nbsp;</div></li><li><div>            if ( ! empty( $field[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                if ( $check_conditionals && ! self::check_condition( $field[ 'conditions' ], $form, $entry_id ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            self::get_field_data( $field_id, $form, $entry_id, $check_conditionals );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $processed_data[ $indexkey ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process current POST data as form submission.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function process_submission() {&nbsp;</div></li><li><div>        //ob_flush();&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>        global $process_id;&nbsp;</div></li><li><div>        global $form;&nbsp;</div></li><li><div>        global $field_types;&nbsp;</div></li><li><div>        global $rawdata;&nbsp;</div></li><li><div>        global $processed_data;&nbsp;</div></li><li><div>        global $transdata;&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        global $referrer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // clean out referrer&nbsp;</div></li><li><div>        if ( empty( $_POST[ '_wp_http_referer_true' ] ) ) {&nbsp;</div></li><li><div>            $_POST[ '_wp_http_referer_true' ] = $_SERVER[ 'HTTP_REFERER' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $referrer = parse_url( $_POST[ '_wp_http_referer_true' ] );&nbsp;</div></li><li><div>        if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>            parse_str( $referrer[ 'query' ], $referrer[ 'query' ] );&nbsp;</div></li><li><div>            if ( isset( $referrer[ 'query' ][ 'cf_er' ] ) ) {&nbsp;</div></li><li><div>                unset( $referrer[ 'query' ][ 'cf_er' ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( isset( $referrer[ 'query' ][ 'cf_su' ] ) ) {&nbsp;</div></li><li><div>                unset( $referrer[ 'query' ][ 'cf_su' ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ( isset( $_POST[ '_cf_cr_pst' ] ) && ! is_object( $post ) ) || ( isset( $_POST[ '_cf_cr_pst' ] ) && $post-&gt;ID !== (int) $_POST[ '_cf_cr_pst' ] ) ) {&nbsp;</div></li><li><div>            $post = get_post( (int) $_POST[ '_cf_cr_pst' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // get form and check&nbsp;</div></li><li><div>        $form = Caldera_Forms_Forms::get_form( $_POST[ '_cf_frm_id' ] );&nbsp;</div></li><li><div>        if ( empty( $form[ 'ID' ] ) || $form[ 'ID' ] != $_POST[ '_cf_frm_id' ] ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // instance number&nbsp;</div></li><li><div>        $form_instance_number = 1;&nbsp;</div></li><li><div>        if ( isset( $_POST[ '_cf_frm_ct' ] ) ) {&nbsp;</div></li><li><div>            $form_instance_number = $_POST[ '_cf_frm_ct' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check honey&nbsp;</div></li><li><div>        if ( isset( $form[ 'check_honey' ] ) ) {&nbsp;</div></li><li><div>            // use multiple honey words&nbsp;</div></li><li><div>            $honey_words = apply_filters( 'caldera_forms_get_honey_words', array(&nbsp;</div></li><li><div>                'web_site', &nbsp;</div></li><li><div>                'url', &nbsp;</div></li><li><div>                'email', &nbsp;</div></li><li><div>                'company', &nbsp;</div></li><li><div>                'name'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            foreach ( $_POST as $honey_word =&gt; $honey_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! is_array( $honey_value ) && strlen( $honey_value ) && in_array( $honey_word, $honey_words ) ) {&nbsp;</div></li><li><div>                    // yupo - bye bye&nbsp;</div></li><li><div>                    $referrer[ 'query' ][ 'cf_su' ] = $form_instance_number;&nbsp;</div></li><li><div>                    $query_str = array(&nbsp;</div></li><li><div>                        'cf_er' =&gt; $process_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>                        $query_str = array_merge( $referrer[ 'query' ], $query_str );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $referrer = $referrer[ 'path' ] . '?' . http_build_query( $query_str );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return self::form_redirect( 'complete', $referrer, $form, uniqid( '_cf_bliss_' ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // init filter&nbsp;</div></li><li><div>        $form = apply_filters( 'caldera_forms_submit_get_form', $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs at beginning of process of submitting form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param string $process_id Process ID, may not be set yet.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_start', $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'fields' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>                $field = Caldera_Forms_Field_Util::get_field( $field, $form, true );&nbsp;</div></li><li><div>                if ( ! is_array( $field ) || empty( $field ) ) {&nbsp;</div></li><li><div>                    unset( $form[ 'fields' ][ $field_id ] );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $form[ 'fields' ][ $field_id ] = $field;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check source is ajax to overide&nbsp;</div></li><li><div>        if ( ! empty( $_POST[ 'cfajax' ] ) && $_POST[ 'cfajax' ] == $form[ 'ID' ] ) {&nbsp;</div></li><li><div>            $form[ 'form_ajax' ] = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get all fieldtype&nbsp;</div></li><li><div>        $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setup fieldtypes field submissions&nbsp;</div></li><li><div>        if ( ! empty( $field_types ) ) {&nbsp;</div></li><li><div>            foreach ( $field_types as $fieldType =&gt; $fieldConfig ) {&nbsp;</div></li><li><div>                // check for a handler&nbsp;</div></li><li><div>                if ( isset( $fieldConfig[ 'handler' ] ) ) {&nbsp;</div></li><li><div>                    add_filter( 'caldera_forms_process_field_' . $fieldType, $fieldConfig[ 'handler' ], 10, 3 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // check for a hash&nbsp;</div></li><li><div>                if ( isset( $fieldConfig[ 'save' ] ) ) {&nbsp;</div></li><li><div>                    add_filter( 'caldera_forms_save_field_' . $fieldType, $fieldConfig[ 'save' ], 10, 3 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // check for a hash&nbsp;</div></li><li><div>                if ( isset( $fieldConfig[ 'validate' ] ) ) {&nbsp;</div></li><li><div>                    add_filter( 'caldera_forms_validate_field_' . $fieldType, $fieldConfig[ 'validate' ], 10, 3 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // SET process ID&nbsp;</div></li><li><div>        if ( isset( $_GET[ 'cf_er' ] ) ) {&nbsp;</div></li><li><div>            $_POST[ '_cf_frm_tr' ] = $_GET[ 'cf_er' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_POST['_cf_frm_tr'])) {&nbsp;</div></li><li><div>            $pretransient = Caldera_Forms_Transient::get_transient( $_POST['_cf_frm_tr'] );&nbsp;</div></li><li><div>            if(    !empty( $pretransient['transient'] ) && $pretransient['transient'] === $_POST['_cf_frm_tr']) {&nbsp;</div></li><li><div>                $transdata = $pretransient;&nbsp;</div></li><li><div>                $process_id = $transdata['transient'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // unset error details&nbsp;</div></li><li><div>                if ( isset( $transdata[ 'type' ] ) ) {&nbsp;</div></li><li><div>                    unset( $transdata[ 'type' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( isset( $transdata[ 'note' ] ) ) {&nbsp;</div></li><li><div>                    unset( $transdata[ 'note' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( isset( $transdata[ 'error' ] ) ) {&nbsp;</div></li><li><div>                    unset( $transdata[ 'error' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( isset( $transdata[ 'fields' ] ) ) {&nbsp;</div></li><li><div>                    unset( $transdata[ 'fields' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( empty( $process_id ) ) {&nbsp;</div></li><li><div>            $process_id = uniqid( '_cf_process_' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // initialize data&nbsp;</div></li><li><div>        $entry_id = false;&nbsp;</div></li><li><div>        if ( isset( $_POST[ '_cf_frm_edt' ] ) ) {&nbsp;</div></li><li><div>            $entry_id = (int) $_POST[ '_cf_frm_edt' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = self::get_submission_data( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set transient for returns submissions&nbsp;</div></li><li><div>        if ( empty( $transdata ) ) {&nbsp;</div></li><li><div>            $transdata = array(&nbsp;</div></li><li><div>                'transient' =&gt; $process_id, &nbsp;</div></li><li><div>                'form_instance' =&gt; $form_instance_number, &nbsp;</div></li><li><div>                'expire' =&gt; 600, &nbsp;</div></li><li><div>                'data' =&gt; array_merge( $_POST, $data ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove AJAX value for tp_&nbsp;</div></li><li><div>        if ( isset( $transdata[ 'data' ][ 'cfajax' ] ) ) {&nbsp;</div></li><li><div>            unset( $transdata[ 'data' ][ 'cfajax' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // setup transient data&nbsp;</div></li><li><div>        $transdata = apply_filters( 'caldera_forms_submit_transient_setup', $transdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setup processor bound requieds&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            $bound_fields = array();&nbsp;</div></li><li><div>            foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $processor[ 'config' ][ '_required_bounds' ] ) ) {&nbsp;</div></li><li><div>                    foreach ( $processor[ 'config' ] as $slug =&gt; &$value ) {&nbsp;</div></li><li><div>                        if ( $slug == '_required_bounds' ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( in_array( $slug, $processor[ 'config' ][ '_required_bounds' ] ) ) {&nbsp;</div></li><li><div>                            if ( isset( $form[ 'fields' ][ $value ] ) ) {&nbsp;</div></li><li><div>                                if ( ! isset( $process_data[ $value ] ) ) {&nbsp;</div></li><li><div>                                    $form[ 'fields' ][ $value ][ 'required' ] = 1;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check submit type (new or update)&nbsp;</div></li><li><div>        if ( isset( $_POST[ '_cf_frm_edt' ] ) ) {&nbsp;</div></li><li><div>            // is edit&nbsp;</div></li><li><div>            //check user can edit this item.&nbsp;</div></li><li><div>            $transdata[ 'edit' ] = (int) $_POST[ '_cf_frm_edt' ];&nbsp;</div></li><li><div>            // set entry_id&nbsp;</div></li><li><div>            self::set_field_data( '_entry_id', $transdata[ 'edit' ], $form );&nbsp;</div></li><li><div>            $details = self::get_entry_detail( $_POST[ '_cf_frm_edt' ], $form );&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // check token&nbsp;</div></li><li><div>            if ( isset( $_POST[ '_cf_frm_edt_tkn' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $validated = Caldera_Forms_Entry_Token::verify_token( $_POST[ '_cf_frm_edt_tkn' ], $entry_id, $form[ 'ID' ] );&nbsp;</div></li><li><div>                if ( is_wp_error( $validated ) ) {&nbsp;</div></li><li><div>                    return $validated;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $entry_id = (int) $details[ 'id' ];&nbsp;</div></li><li><div>                    $edit_token = Caldera_Forms_Entry_Token::create_entry_token( $entry_id, $form[ 'ID' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                    $transdata[ 'error' ] = true;&nbsp;</div></li><li><div>                    $transdata[ 'note' ]  = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( empty( $details ) ) {&nbsp;</div></li><li><div>                        $transdata[ 'error' ] = true;&nbsp;</div></li><li><div>                        $transdata[ 'note' ]  = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // check user can edit&nbsp;</div></li><li><div>                        if ( current_user_can( 'edit_posts' ) || $details[ 'user_id' ] === $user_id ) {&nbsp;</div></li><li><div>                            // can edit.&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $transdata[ 'error' ] = true;&nbsp;</div></li><li><div>                            $transdata[ 'note' ]  = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // start brining in entries&nbsp;</div></li><li><div>        foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $entry = self::get_field_data( $field_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $entry ) ) {&nbsp;</div></li><li><div>                $transdata[ 'fields' ][ $field_id ] = $entry-&gt;get_error_message();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // required check&nbsp;</div></li><li><div>                $failed = false;&nbsp;</div></li><li><div>                // run validators&nbsp;</div></li><li><div>                if ( has_filter( 'caldera_forms_validate_field_' . $field[ 'type' ] ) ) {&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Add custom validation by field type or change field value.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * Return WP_Error to trigger validation error&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since unknown&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param mixed $entry Field value&nbsp;</div></li><li><div>                     * @param array $field Field config&nbsp;</div></li><li><div>                     * @param array $form Form config&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    $entry = apply_filters( 'caldera_forms_validate_field_' . $field[ 'type' ], $entry, $field, $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Add custom validation by field ID or change field value.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * Return WP_Error to trigger validation error&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 1.5.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param mixed $entry Field value&nbsp;</div></li><li><div>                 * @param array $field Field config&nbsp;</div></li><li><div>                 * @param array $form Form config&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $entry = apply_filters( 'caldera_forms_validate_field_' . $field[ 'ID' ], $entry, $field, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if required, check the validators returned errors or not.&nbsp;</div></li><li><div>                if ( ! empty( $field[ 'required' ] ) ) {&nbsp;</div></li><li><div>                    // check is supported&nbsp;</div></li><li><div>                    if ( isset( $field_types[ $field[ 'type' ] ][ 'setup' ][ 'not_supported' ] ) && in_array( 'required', (array) $field_types[ $field[ 'type' ] ][ 'setup' ][ 'not_supported' ] ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // check if conditions match first. ignore vailators if not part of condition&nbsp;</div></li><li><div>                    if ( false === Caldera_Forms_Field_Util::check_conditional( $field, $form ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // if error - return so&nbsp;</div></li><li><div>                    if ( is_wp_error( $entry ) ) {&nbsp;</div></li><li><div>                        $transdata[ 'fields' ][ $field_id ] = $entry-&gt;get_error_message();&nbsp;</div></li><li><div>                    } elseif ( $entry === null ) {&nbsp;</div></li><li><div>                        $transdata[ 'fields' ][ $field_id ] = $field[ 'label' ] . ' ' . __( 'is required', 'caldera-forms' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check requireds&nbsp;</div></li><li><div>        if ( ! empty( $transdata[ 'fields' ] ) || ! empty( $transdata[ 'error' ] ) ) {&nbsp;</div></li><li><div>            $transdata[ 'type' ] = 'error';&nbsp;</div></li><li><div>            // set error transient&nbsp;</div></li><li><div>            $transdata = apply_filters( 'caldera_forms_submit_return_transient', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>            $transdata = apply_filters( 'caldera_forms_submit_return_transient_required', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // back to form&nbsp;</div></li><li><div>            $query_str = array(&nbsp;</div></li><li><div>                'cf_er' =&gt; $process_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>                $query_str = array_merge( $referrer[ 'query' ], $query_str );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $referrer = $referrer[ 'path' ] . '?' . http_build_query( $query_str );&nbsp;</div></li><li><div>            $referrer = apply_filters( 'caldera_forms_submit_return_redirect', $referrer, $form, $process_id );&nbsp;</div></li><li><div>            $referrer = apply_filters( 'caldera_forms_submit_return_redirect_required', $referrer, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Caldera_Forms_Transient::set_transient( $process_id, $transdata, $transdata['expire']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return self::form_redirect( 'error', $referrer, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // has processors&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_start_processors', $form, $referrer, $process_id );&nbsp;</div></li><li><div>        if ( ! isset( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            $form[ 'processors' ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get all form processors&nbsp;</div></li><li><div>        $form_processors = Caldera_Forms_Processor_Load::get_instance()-&gt;get_processors();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs before the 1st stage of processors &quot;pre-process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_pre_process_start', $form, $referrer, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Remove processors that are not allowed to run on this pass&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.2&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>            // the cf_version value in the form was introduced in 1.3.2&nbsp;</div></li><li><div>            // so if its set, its safe to asume the runtimes are set.&nbsp;</div></li><li><div>            if ( ! isset( $form[ 'cf_version' ] ) ) {&nbsp;</div></li><li><div>                // nope&nbsp;</div></li><li><div>                if ( ! empty( $transdata[ 'edit' ] ) ) {&nbsp;</div></li><li><div>                    unset( $form[ 'processors' ][ $processor_id ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // normal check within version&nbsp;</div></li><li><div>            // chec if editing and is allowed&nbsp;</div></li><li><div>            if ( ! empty( $transdata[ 'edit' ] ) && empty( $processor[ 'runtimes' ][ 'update' ] ) ) {&nbsp;</div></li><li><div>                // is editing and is set to not allow it so remove processor&nbsp;</div></li><li><div>                unset( $form[ 'processors' ][ $processor_id ] );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( empty( $transdata[ 'edit' ] ) && empty( $processor[ 'runtimes' ][ 'insert' ] ) ) {&nbsp;</div></li><li><div>                // is editing and is set to not allow it&nbsp;</div></li><li><div>                unset( $form[ 'processors' ][ $processor_id ] );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // PRE PROCESS&nbsp;</div></li><li><div>        foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $form_processors[ $processor[ 'type' ] ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Do Conditional&nbsp;</div></li><li><div>                if ( isset( $processor[ 'conditions' ] ) && ! empty( $processor[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                    if ( ! self::check_condition( $processor[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // has processor&nbsp;</div></li><li><div>                $process = $form_processors[ $processor[ 'type' ] ];&nbsp;</div></li><li><div>                if ( ! isset( $process[ 'pre_processor' ] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // set default config&nbsp;</div></li><li><div>                $config = array();&nbsp;</div></li><li><div>                $config[ 'processor_id' ] = $processor_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $process[ 'default' ] ) ) {&nbsp;</div></li><li><div>                    $config = $process[ 'default' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $processor[ 'config' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $config = array_merge( $config, $processor[ 'config' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $process[ 'pre_processor' ] ) ) {&nbsp;</div></li><li><div>                    $process_line_data = call_user_func_array( $process[ 'pre_processor' ], array(&nbsp;</div></li><li><div>                        $config, &nbsp;</div></li><li><div>                        $form, &nbsp;</div></li><li><div>                        $process_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( function_exists( $process[ 'pre_processor' ] ) ) {&nbsp;</div></li><li><div>                        $func = $process[ 'pre_processor' ];&nbsp;</div></li><li><div>                        $process_line_data = $func( $config, $form, $process_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // pre processors should not return unless a break in action for further&nbsp;</div></li><li><div>                // Returned something - check it&nbsp;</div></li><li><div>                if ( ! empty( $process_line_data ) ) {&nbsp;</div></li><li><div>                    if ( is_array( $process_line_data ) ) {&nbsp;</div></li><li><div>                        //type&nbsp;</div></li><li><div>                        if ( ! empty( $process_line_data[ 'type' ] ) ) {&nbsp;</div></li><li><div>                            $transdata[ 'type' ] = $process_line_data[ 'type' ];&nbsp;</div></li><li><div>                            // has note?&nbsp;</div></li><li><div>                            if ( ! empty( $process_line_data[ 'note' ] ) ) {&nbsp;</div></li><li><div>                                $transdata[ 'note' ] = $process_line_data[ 'note' ];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // fields involved?&nbsp;</div></li><li><div>                        if ( ! empty( $process_line_data[ 'fields' ] ) ) {&nbsp;</div></li><li><div>                            $transdata[ 'fields' ] = $process_line_data[ 'fields' ];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // set error transient&nbsp;</div></li><li><div>                        $transdata = apply_filters( 'caldera_forms_submit_return_transient', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>                        $transdata = apply_filters( 'caldera_forms_submit_return_transient_pre_process', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // back to form&nbsp;</div></li><li><div>                        $query_str = array(&nbsp;</div></li><li><div>                            'cf_er' =&gt; $process_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>                            $query_str = array_merge( $referrer[ 'query' ], $query_str );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $referrer = $referrer[ 'path' ] . '?' . http_build_query( $query_str );&nbsp;</div></li><li><div>                        $referrer = apply_filters( 'caldera_forms_submit_return_redirect', $referrer, $form, $process_id );&nbsp;</div></li><li><div>                        $referrer = apply_filters( 'caldera_forms_submit_return_redirect-' . $processor[ 'type' ], $referrer, $config, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // set transient data&nbsp;</div></li><li><div>                        Caldera_Forms_Transient::set_transient( $process_id, $transdata, $transdata['expire']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        return self::form_redirect( 'preprocess', $referrer, $form, $process_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after the 1st stage of processors &quot;pre-process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_pre_process_end', $form, $referrer, $process_id );&nbsp;</div></li><li><div>        /// AFTER PRE-PROCESS - check for errors etc to return else continue to process.&nbsp;</div></li><li><div>        if ( empty( $transdata[ 'edit' ] ) && ! empty( $form[ 'db_support' ] ) ) {&nbsp;</div></li><li><div>            // CREATE ENTRY&nbsp;</div></li><li><div>            $new_entry = array(&nbsp;</div></li><li><div>                'form_id' =&gt; $form[ 'ID' ], &nbsp;</div></li><li><div>                'user_id' =&gt; 0, &nbsp;</div></li><li><div>                'datestamp' =&gt; date_i18n( 'Y-m-d H:i:s', time(), 0 ), &nbsp;</div></li><li><div>                'status' =&gt; 'pending'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            // if user logged in&nbsp;</div></li><li><div>            if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>                $new_entry[ 'user_id' ] = get_current_user_id();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( isset( $data[ '_user_id' ] ) ) {&nbsp;</div></li><li><div>                    $new_entry[ 'user_id' ] = $data[ '_user_id' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $wpdb-&gt;insert( $wpdb-&gt;prefix . 'cf_form_entries', $new_entry );&nbsp;</div></li><li><div>            $entryid = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Runs after an entry is saved&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.2.1&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param int $entryid The ID of the entry that was just saved.&nbsp;</div></li><li><div>             * @param array $new_entry Data that was saved&nbsp;</div></li><li><div>             * @param array $form Form being processed&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'caldera_forms_entry_saved', $entryid, $new_entry, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // save entry_id&nbsp;</div></li><li><div>            self::set_field_data( '_entry_id', $entryid, $form );&nbsp;</div></li><li><div>            $token = Caldera_Forms_Entry_Token::create_entry_token( $entryid, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set edit token&nbsp;</div></li><li><div>            self::set_field_data( '_entry_token', $token, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif ( ! empty( $transdata[ 'edit' ] ) ) {&nbsp;</div></li><li><div>            $entryid = $transdata[ 'edit' ];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $entryid = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs before the 2nd stage of processors &quot;process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         * @param int|false $entryid Current entry ID or false if not set or being saved.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_process_start', $form, $referrer, $process_id, $entryid );&nbsp;</div></li><li><div>        /// PROCESS&nbsp;</div></li><li><div>        foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>            if ( isset( $form_processors[ $processor[ 'type' ] ] ) ) {&nbsp;</div></li><li><div>                // has processor&nbsp;</div></li><li><div>                // Do Conditional&nbsp;</div></li><li><div>                if ( isset( $processor[ 'conditions' ] ) && ! empty( $processor[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                    if ( ! self::check_condition( $processor[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $process = $form_processors[ $processor[ 'type' ] ];&nbsp;</div></li><li><div>                if ( ! isset( $process[ 'processor' ] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $hasmeta = null;&nbsp;</div></li><li><div>                // set default config&nbsp;</div></li><li><div>                $config = array();&nbsp;</div></li><li><div>                $config[ 'processor_id' ] = $processor_id;&nbsp;</div></li><li><div>                if ( isset( $process[ 'default' ] ) ) {&nbsp;</div></li><li><div>                    $config = $process[ 'default' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $processor[ 'config' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $config = array_merge( $config, $processor[ 'config' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $process[ 'processor' ] ) ) {&nbsp;</div></li><li><div>                    $hasmeta = call_user_func_array( $process[ 'processor' ], array( $config, $form, $process_id ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( function_exists( $process[ 'processor' ] ) ) {&nbsp;</div></li><li><div>                        $func = $process[ 'processor' ];&nbsp;</div></li><li><div>                        $hasmeta = $func( $config, $form, $process_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $hasmeta !== null ) {&nbsp;</div></li><li><div>                    foreach ( (array) $hasmeta as $metakey =&gt; $metavalue ) {&nbsp;</div></li><li><div>                        $meta_process_id = $processor_id;&nbsp;</div></li><li><div>                        // single processors are generallay used so not processor id is needed&nbsp;</div></li><li><div>                        if ( ! empty( $form_processors[ $processor[ 'type' ] ][ 'single' ] ) ) {&nbsp;</div></li><li><div>                            $meta_process_id = $processor[ 'type' ];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        self::set_submission_meta( $metakey, $metavalue, $form, $processor_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } // check for transdata errors&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $transdata[ 'error' ] ) ) {&nbsp;</div></li><li><div>                    // remove pending entry&nbsp;</div></li><li><div>                    if ( ! empty( $entryid ) && ! empty( $new_entry ) && $new_entry[ 'status' ] == 'pending' ) {&nbsp;</div></li><li><div>                        // kill it with fire&nbsp;</div></li><li><div>                        $wpdb-&gt;delete( $wpdb-&gt;prefix . 'cf_form_entries', array( 'id' =&gt; $entryid ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // set error transient&nbsp;</div></li><li><div>                    $transdata = apply_filters( 'caldera_forms_submit_error_transient', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>                    $transdata = apply_filters( 'caldera_forms_submit_error_transient_pre_process', $transdata, $form, $referrer, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // back to form&nbsp;</div></li><li><div>                    $query_str = array(&nbsp;</div></li><li><div>                        'cf_er' =&gt; $process_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    if ( ! empty( $referrer[ 'query' ] ) ) {&nbsp;</div></li><li><div>                        $query_str = array_merge( $referrer[ 'query' ], $query_str );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $referrer = $referrer[ 'path' ] . '?' . http_build_query( $query_str );&nbsp;</div></li><li><div>                    $referrer = apply_filters( 'caldera_forms_submit_error_redirect', $referrer, $form, $process_id );&nbsp;</div></li><li><div>                    $referrer = apply_filters( 'caldera_forms_submit_error_redirect_pre_process', $referrer, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // set transient data&nbsp;</div></li><li><div>                    Caldera_Forms_Transient::set_transient( $process_id, $transdata, $transdata['expire']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return self::form_redirect( 'error', $referrer, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after the 2nd stage of processors &quot;process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         * @param int|false $entryid Current entry ID or false if not set or being saved.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_process_end', $form, $referrer, $process_id, $entryid );&nbsp;</div></li><li><div>        // AFTER PROCESS - do post process for any additional stuff&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs before the 3rd and final stage of processors &quot;post-process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         * @param int|false $entryid Current entry ID or false if not set or being saved.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_post_process', $form, $referrer, $process_id, $entryid );&nbsp;</div></li><li><div>        // POST PROCESS&nbsp;</div></li><li><div>        foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>            if ( isset( $form_processors[ $processor[ 'type' ] ] ) ) {&nbsp;</div></li><li><div>                // has processor&nbsp;</div></li><li><div>                // Do Conditional&nbsp;</div></li><li><div>                if ( isset( $processor[ 'conditions' ] ) && ! empty( $processor[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>                    if ( ! self::check_condition( $processor[ 'conditions' ], $form ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $process = $form_processors[ $processor[ 'type' ] ];&nbsp;</div></li><li><div>                if ( ! isset( $process[ 'post_processor' ] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // set default config&nbsp;</div></li><li><div>                $config = array();&nbsp;</div></li><li><div>                $config[ 'processor_id' ] = $processor_id;&nbsp;</div></li><li><div>                if ( isset( $process[ 'default' ] ) ) {&nbsp;</div></li><li><div>                    $config = $process[ 'default' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $processor[ 'config' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $config = array_merge( $config, $processor[ 'config' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $process[ 'post_processor' ] ) ) {&nbsp;</div></li><li><div>                    $hasmeta = call_user_func_array( $process[ 'post_processor' ], array(&nbsp;</div></li><li><div>                        $config, &nbsp;</div></li><li><div>                        $form, &nbsp;</div></li><li><div>                        $process_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( function_exists( $process[ 'post_processor' ] ) ) {&nbsp;</div></li><li><div>                        $func = $process[ 'post_processor' ];&nbsp;</div></li><li><div>                        $hasmeta = $func( $config, $form, $process_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $hasmeta !== null ) {&nbsp;</div></li><li><div>                    foreach ( (array) $hasmeta as $metakey =&gt; $metavalue ) {&nbsp;</div></li><li><div>                        self::set_submission_meta( $metakey, $metavalue, $form, $processor_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after the 3rd and final stage of processors &quot;post-process&quot;&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         * @param int|false $entryid Current entry ID or false if not set or being saved.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_post_process_end', $form, $referrer, $process_id, $entryid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after all processing for form completes&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         * @param array $referrer URL form was submitted via -- is passed through parse_url() before this point.&nbsp;</div></li><li><div>         * @param string $process_id Unique ID for this processing&nbsp;</div></li><li><div>         * @param int|false $entryid Current entry ID or false if not set or being saved.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_submit_complete', $form, $referrer, $process_id, $entryid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // redirect back or to result page&nbsp;</div></li><li><div>        $referrer[ 'query' ][ 'cf_su' ] = $form_instance_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // last entry id - new only&nbsp;</div></li><li><div>        if ( empty( $transdata[ 'edit' ] ) ) {&nbsp;</div></li><li><div>            $cf_id = self::do_magic_tags( '{entry_id}' );&nbsp;</div></li><li><div>            if ( ! empty( $cf_id ) ) {&nbsp;</div></li><li><div>                $referrer[ 'query' ][ 'cf_id' ] = self::do_magic_tags( '{entry_id}' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // passback values&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'variables' ][ 'types' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'variables' ][ 'types' ] as $variable_index =&gt; $behavior_type ) {&nbsp;</div></li><li><div>                if ( $behavior_type == 'passback' ) {&nbsp;</div></li><li><div>                    $referrer[ 'query' ][ $form[ 'variables' ][ 'keys' ][ $variable_index ] ] = self::do_magic_tags( $form[ 'variables' ][ 'values' ][ $variable_index ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $referrer = $referrer[ 'path' ] . '?' . http_build_query( $referrer[ 'query' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // filter refer&nbsp;</div></li><li><div>        $referrer = apply_filters( 'caldera_forms_submit_redirect', $referrer, $form, $process_id );&nbsp;</div></li><li><div>        $referrer = apply_filters( 'caldera_forms_submit_redirect_complete', $referrer, $form, $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // kill transient data&nbsp;</div></li><li><div>        delete_transient( $process_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::form_redirect( 'complete', $referrer, $form, $process_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes Caldera Forms load the preview&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function cf_init_preview() {&nbsp;</div></li><li><div>        if( ! isset( $_GET, $_GET['cf_preview'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $post, $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $preview_id = trim( $_GET['cf_preview'] );&nbsp;</div></li><li><div>        if(!empty( $preview_id )) {&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form($preview_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $userid = get_current_user_id();&nbsp;</div></li><li><div>            if( !empty( $userid ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if(empty( $form['ID']) || $form['ID'] !== trim( $preview_id ) ) {&nbsp;</div></li><li><div>                    return;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if( empty($post) || $post-&gt;post_title !== 'Caldera Forms Preview' ) {&nbsp;</div></li><li><div>                    $temp_page = get_page_by_title('Caldera Forms Preview');&nbsp;</div></li><li><div>                    if(empty($temp_page)) {&nbsp;</div></li><li><div>                        // create page&nbsp;</div></li><li><div>                        $post = array(&nbsp;</div></li><li><div>                            'post_content' =&gt; '', &nbsp;</div></li><li><div>                            'post_name' =&gt; 'caldera_forms_preview', &nbsp;</div></li><li><div>                            'post_title' =&gt; 'Caldera Forms Preview', &nbsp;</div></li><li><div>                            'post_status' =&gt; 'draft', &nbsp;</div></li><li><div>                            'post_type' =&gt; 'page', &nbsp;</div></li><li><div>                            'ping_status' =&gt; 'closed', &nbsp;</div></li><li><div>                            'comment_status' =&gt; 'closed'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        $page_id = wp_insert_post( $post );&nbsp;</div></li><li><div>                        wp_redirect( trailingslashit( get_home_url() ) . '?page_id='.$page_id.'&preview=true&cf_preview='.$preview_id );&nbsp;</div></li><li><div>                        exit;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if( $temp_page-&gt;post_status !== 'draft') {&nbsp;</div></li><li><div>                        wp_update_post( array( 'ID' =&gt; $temp_page-&gt;ID, 'post_status' =&gt; 'draft' ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    wp_redirect( trailingslashit( get_home_url() ) . '?page_id='.$temp_page-&gt;ID.'&preview=true&cf_preview='.$preview_id );&nbsp;</div></li><li><div>                    exit;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $post-&gt;post_title = $form['name'];&nbsp;</div></li><li><div>                $post-&gt;post_content = '[caldera_form id=&quot;'.$_GET['cf_preview'].'&quot;]';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = self::check_for_forms_on_page( );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function api_handler() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check for API&nbsp;</div></li><li><div>        // if this is not a request for json or a singular object then bail&nbsp;</div></li><li><div>        if ( ! isset( $wp_query-&gt;query_vars[ 'cf_api' ] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if form exists&nbsp;</div></li><li><div>        $form = Caldera_Forms_Forms::get_form( $wp_query-&gt;query_vars[ 'cf_api' ] );&nbsp;</div></li><li><div>        $atts = array(&nbsp;</div></li><li><div>            'id' =&gt; $wp_query-&gt;query_vars[ 'cf_api' ], &nbsp;</div></li><li><div>            'ajax' =&gt; true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        if ( ! empty( $_REQUEST[ 'cf_instance' ] ) ) {&nbsp;</div></li><li><div>            $atts[ 'instance' ] = $_REQUEST[ 'cf_instance' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // push 200 status. in some cases plugins or permalink config may cause a 404 before going out&nbsp;</div></li><li><div>        header( &quot;HTTP/1.1 200 OK&quot;, true );&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'ID' ] ) ) {&nbsp;</div></li><li><div>            if ( $form[ 'ID' ] === $wp_query-&gt;query_vars[ 'cf_api' ] ) {&nbsp;</div></li><li><div>                // got it!&nbsp;</div></li><li><div>                // need entry?&nbsp;</div></li><li><div>                if ( ! empty( $wp_query-&gt;query_vars[ 'cf_entry' ] ) ) {&nbsp;</div></li><li><div>                    $atts[ 'entry' ] = (int) $wp_query-&gt;query_vars[ 'cf_entry' ];&nbsp;</div></li><li><div>                    //$entry = Caldera_Forms::get_entry($wp_query-&gt;query_vars['cf_entry'], $form);&nbsp;</div></li><li><div>                    //wp_send_json( $entry );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // is a post?&nbsp;</div></li><li><div>                if ( $_SERVER[ 'REQUEST_METHOD' ] === 'POST' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if( !empty( $_POST['control'] ) ) {&nbsp;</div></li><li><div>                        $transient_name = sanitize_key( $_POST['control'] );&nbsp;</div></li><li><div>                        $transdata = Caldera_Forms_Transient::get_transient( $transient_name );&nbsp;</div></li><li><div>                        if( false === $transdata ) {&nbsp;</div></li><li><div>                            $transdata = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ( ! empty( $_FILES ) && ! empty( $_POST[ 'field' ] ) ) {&nbsp;</div></li><li><div>                            $form = Caldera_Forms_Forms::get_form( $wp_query-&gt;query_vars[ 'cf_api' ] );&nbsp;</div></li><li><div>                            $field = $form[ 'fields' ][ $_POST[ 'field' ] ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $data = cf_handle_file_upload( true, $field, $form );&nbsp;</div></li><li><div>                            if ( is_wp_error( $data ) ) {&nbsp;</div></li><li><div>                                wp_send_json_error( $data-&gt;get_error_message() );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $transdata[] = $data;&nbsp;</div></li><li><div>                            //set&nbsp;</div></li><li><div>                            Caldera_Forms_Transient::set_transient( $transient_name, $transdata, DAY_IN_SECONDS );&nbsp;</div></li><li><div>                            // maybe put in some checks on file then can say yea or nei&nbsp;</div></li><li><div>                            wp_send_json_success( array() );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $_POST[ '_wp_http_referer_true' ] = 'api';&nbsp;</div></li><li><div>                    $_POST[ '_cf_frm_id' ]            = $_POST[ 'cfajax' ] = $wp_query-&gt;query_vars[ 'cf_api' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    Caldera_Forms::process_form_via_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo self::render_form( $atts );&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the URL to the endpoint.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note: The returned URL is NOT escaped.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.2&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $form_id form ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string Full URL&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function get_submit_url( $form_id = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_multisite() && get_blog_option( null, 'permalink_structure' ) || get_option( 'permalink_structure' ) ) {&nbsp;</div></li><li><div>            $url = get_home_url();&nbsp;</div></li><li><div>            $url .= '/cf-api/' . ltrim( $form_id, '/' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $url = trailingslashit( get_home_url() );&nbsp;</div></li><li><div>            $url = add_query_arg( 'cf_api', $form_id, $url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( is_ssl() ) {&nbsp;</div></li><li><div>            if ( $_SERVER[ 'SERVER_NAME' ] === parse_url( get_home_url(), PHP_URL_HOST ) ) {&nbsp;</div></li><li><div>                $url = set_url_scheme( $url, 'https' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Caldera Forms APU url&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.2&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $url URL.&nbsp;</div></li><li><div>         * @param string $form_id ID of form.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'caldera_forms_submission_url', $url, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes Caldera Forms go in front-end!&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function cf_init_system() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_GET['cf_tp'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // process a transient stored entry&nbsp;</div></li><li><div>            $data = Caldera_Forms_Transient::get_transient( $_GET[ 'cf_tp' ] );&nbsp;</div></li><li><div>            if(!empty($data) && $data['transient'] === $_GET['cf_tp'] && isset($data['data'])) {&nbsp;</div></li><li><div>                // create post values&nbsp;</div></li><li><div>                $_POST = array_merge( $_POST, $data['data']);&nbsp;</div></li><li><div>                // set transient id&nbsp;</div></li><li><div>                $_POST['_cf_frm_tr'] = $data['transient'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // hook into submission&nbsp;</div></li><li><div>        self::process_form_via_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Recursive array search.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|array $needle Value to search for.&nbsp;</div></li><li><div>     * @param array $haystack Array to search in&nbsp;</div></li><li><div>     * @param array $found Optional. Array to add found items to. Default is an empty array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array Array of found needles.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function search_array_fields( $needle, $haystack, $found = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $needle ) ) {&nbsp;</div></li><li><div>            foreach ( $needle as $pin ) {&nbsp;</div></li><li><div>                $found = array_merge( $found, self::search_array_fields( $pin, $haystack ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( in_array( $needle, $haystack ) ) {&nbsp;</div></li><li><div>                $found[] = $needle;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $found;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load a saved entry.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $entry_id Entry ID&nbsp;</div></li><li><div>     * @param string|array $form Optional. Config array, or ID of form.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|WP_Error|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_entry( $entry_id, $form ) {&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form_id = $form;&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>            if ( ! is_array( $form ) || ! isset( $form[ 'ID' ] ) || $form[ 'ID' ] !== $form_id ) {&nbsp;</div></li><li><div>                return new WP_Error( 'fail', esc_html__( 'Invalid form ID', 'caldera-forms' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get fields&nbsp;</div></li><li><div>        $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //False for third arg added in 1.5.0.8 to prevent conditions from being shown&nbsp;</div></li><li><div>        //See: https://github.com/CalderaWP/Caldera-Forms/issues/1494&nbsp;</div></li><li><div>        $entry = self::get_submission_data( $form, $entry_id, false );&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'data' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $entry as $field_id =&gt; $field_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $form[ 'fields' ][ $field_id ] ) || ! isset( $field_types[ $form[ 'fields' ][ $field_id ][ 'type' ] ] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //remove if not_supported&nbsp;</div></li><li><div>            $type = Caldera_Forms_Field_Util::get_type( Caldera_Forms_Field_Util::get_field( $field_id, $form ) );&nbsp;</div></li><li><div>            if ( Caldera_Forms_Fields::not_support( $type, 'entry_list' ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field = $form[ 'fields' ][ $field_id ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field = Caldera_Forms_Field_Util::get_field( $field, $form, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_string( $field_value ) ) {&nbsp;</div></li><li><div>                // maybe json?&nbsp;</div></li><li><div>                $is_json = json_decode( $field_value, ARRAY_A );&nbsp;</div></li><li><div>                if ( ! empty( $is_json ) && is_array( $is_json ) ) {&nbsp;</div></li><li><div>                    $field_value = $is_json;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $field_value = esc_html( stripslashes_deep( $field_value ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // set view&nbsp;</div></li><li><div>            $field_view = apply_filters( 'caldera_forms_view_field_' . $field[ 'type' ], $field_value, $field, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // has options?&nbsp;</div></li><li><div>            if ( ! empty( $field[ 'config' ][ 'option' ] ) ) {&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $field[ 'config' ][ 'option' ] as $opt =&gt; $option ) {&nbsp;</div></li><li><div>                    if ( $option[ 'value' ] == $field_view ) {&nbsp;</div></li><li><div>                        $field_view = $option[ 'label' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_array( $field_value ) ) {&nbsp;</div></li><li><div>                            if ( isset( $field_value[ $opt ] ) ) {&nbsp;</div></li><li><div>                                $field_value = $field_value[ $opt ];&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $field_value = '';&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( empty( $field_types[ $field[ 'type' ] ][ 'options' ] ) ) {&nbsp;</div></li><li><div>                            $data[ 'data' ][ $field_id . '_' . $i ] = array(&nbsp;</div></li><li><div>                                'label' =&gt; $field[ 'label' ], &nbsp;</div></li><li><div>                                'view' =&gt; $field_view, &nbsp;</div></li><li><div>                                'value' =&gt; $field_value&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                            $i ++;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data[ 'data' ][ $field_id ] = array(&nbsp;</div></li><li><div>                'label' =&gt; $field[ 'label' ], &nbsp;</div></li><li><div>                'view' =&gt; $field_view, &nbsp;</div></li><li><div>                'value' =&gt; $field_value&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get meta&nbsp;</div></li><li><div>        $entry_detail = self::get_entry_detail( $entry_id, $form );&nbsp;</div></li><li><div>        $data[ 'date' ] = self::localize_time( $entry_detail[ 'datestamp' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $entry_detail[ 'meta' ] ) ) {&nbsp;</div></li><li><div>            $data[ 'meta' ] = $entry_detail[ 'meta' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $entry_detail[ 'user_id' ] ) ) {&nbsp;</div></li><li><div>            $user = get_userdata( $entry_detail[ 'user_id' ] );&nbsp;</div></li><li><div>            if ( ! empty( $user ) ) {&nbsp;</div></li><li><div>                $data[ 'user' ] = array(&nbsp;</div></li><li><div>                    'ID' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>                    'name' =&gt; $user-&gt;data-&gt;display_name, &nbsp;</div></li><li><div>                    'email' =&gt; $user-&gt;data-&gt;user_email, &nbsp;</div></li><li><div>                    'avatar' =&gt; get_avatar( $user-&gt;ID, 150, 'identicon' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $avatar_field = null;&nbsp;</div></li><li><div>            if ( ! empty( $form[ 'avatar_field' ] ) ) {&nbsp;</div></li><li><div>                $avatar_field = self::get_field_data( $form[ 'avatar_field' ], $form, $entry_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $data[ 'user' ] = array(&nbsp;</div></li><li><div>                'avatar' =&gt; get_avatar( $avatar_field, 150 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'variables' ][ 'types' ] ) ) {&nbsp;</div></li><li><div>            foreach ( $form[ 'variables' ][ 'types' ] as $var_key =&gt; $var_type ) {&nbsp;</div></li><li><div>                if ( $var_type == 'entryitem' ) {&nbsp;</div></li><li><div>                    $var_val = Caldera_Forms::do_magic_tags( $form[ 'variables' ][ 'values' ][ $var_key ], $entry_id );&nbsp;</div></li><li><div>                    $data[ 'data' ][ '_var_' . $form[ 'variables' ][ 'keys' ][ $var_key ] ] = array(&nbsp;</div></li><li><div>                        'label' =&gt; ucwords( str_replace( '_', ' ', $form[ 'variables' ][ 'keys' ][ $var_key ] ) ), &nbsp;</div></li><li><div>                        'view' =&gt; $var_val, &nbsp;</div></li><li><div>                        'value' =&gt; sanitize_text_field( $var_val )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $data[ 'user' ] ) ) {&nbsp;</div></li><li><div>            $data[ 'user' ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allows changes to user profile of entry&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $data_user The user data&nbsp;</div></li><li><div>         * @param int $entry_id ID of entry being returned&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $data[ 'user' ] = apply_filters( 'caldera_forms_get_entry_user', $data[ 'user' ], $entry_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set the entry status&nbsp;</div></li><li><div>        $data[ 'status' ] = $entry_detail[ 'status' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Changes entry being returned.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $data The entry data&nbsp;</div></li><li><div>         * @param int $entry_id ID of entry&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $data = apply_filters( 'caldera_forms_get_entry', $data, $entry_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load a Caldera Form in a modal.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     * @deprecated  1.5.0.7&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|array $atts Shortcode atts or form ID&nbsp;</div></li><li><div>     * @param string $content Content to use in trigger link.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function render_modal_form( $atts, $content ) {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, '1.5.0.7', 'Caldera_Forms_Render_Modals::render_modal_form' );&nbsp;</div></li><li><div>        return Caldera_Forms_Render_Modals::modal_form( $atts, $content );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Print modal content in footer.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses &quot;wp_footer&quot;&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function render_footer_modals() {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, '1.5.0.7', 'Caldera_Forms_Render_Modals::render_footer_modals' );&nbsp;</div></li><li><div>        Caldera_Forms_Render_Modals::render_footer_modals();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create HTML markup for a field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since unknown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array|string $field Form ID or shortcode atts or form config array&nbsp;</div></li><li><div>     * @param array|null $form Optional Form to load field from. Not necessary, but helps the filters out.&nbsp;</div></li><li><div>     * @param array $entry_data Optional. Entry data to populate field with. Null, the default, loads form for creating a new entry.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return void|string HTML for form, if it was able to be loaded, &nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function render_field( $field, $form = null, $entry_data = array(), $field_errors = array() ) {&nbsp;</div></li><li><div>        $current_form_count = Caldera_Forms_Render_Util::get_current_form_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_classes = Caldera_Forms_Field_Util::prepare_field_classes( $field, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_wrapper_class = implode( ' ', $field_classes[ 'control_wrapper' ] );&nbsp;</div></li><li><div>        $field_input_class = implode( ' ', $field_classes[ 'field_wrapper' ] );&nbsp;</div></li><li><div>        $field_class = implode( ' ', $field_classes[ 'field' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add error class&nbsp;</div></li><li><div>        if ( ! empty( $field_errors ) ) {&nbsp;</div></li><li><div>            $field_wrapper_class .= &quot; &quot; . implode( ' ', $field_classes[ 'field_error' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'hide_label' ] ) ) {&nbsp;</div></li><li><div>            $field_classes[ 'field_label' ][] = 'screen-reader-text sr-only';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_structure = array(&nbsp;</div></li><li><div>            &quot;field&quot; =&gt; $field, &nbsp;</div></li><li><div>            &quot;id&quot; =&gt; $field[ 'ID' ], //'fld_' . $field['slug'], &nbsp;</div></li><li><div>            &quot;name&quot; =&gt; $field[ 'ID' ], //$field['slug'], &nbsp;</div></li><li><div>            &quot;wrapper_before&quot; =&gt; &quot;&lt;div role=\&quot;field\&quot; data-field-wrapper=\&quot;&quot; . $field[ 'ID' ] . &quot;\&quot; class=\&quot;&quot; . $field_wrapper_class . &quot;\&quot;&gt;\r\n&quot;, &nbsp;</div></li><li><div>            &quot;field_before&quot; =&gt; &quot;&lt;div class=\&quot;&quot; . $field_input_class . &quot;\&quot;&gt;\r\n&quot;, &nbsp;</div></li><li><div>            &quot;label_before&quot; =&gt;  &quot;&lt;label id=\&quot;&quot; . $field[ 'ID' ] . &quot;Label\&quot; for=\&quot;&quot; . $field[ 'ID' ] . '_' . $current_form_count . &quot;\&quot; class=\&quot;&quot; . implode( ' ', $field_classes[ 'field_label' ] ) . &quot;\&quot;&gt;&quot;, &nbsp;</div></li><li><div>            &quot;label&quot; =&gt;  $field[ 'label' ], &nbsp;</div></li><li><div>            &quot;label_required&quot; =&gt; ( empty( $field[ 'hide_label' ] ) ? ( ! empty( $field[ 'required' ] ) ? &quot; &lt;span aria-hidden=\&quot;true\&quot; role=\&quot;presentation\&quot; class=\&quot;&quot; . implode( ' ', $field_classes[ 'field_required_tag' ] ) . &quot;\&quot; style=\&quot;color:#ee0000;\&quot;&gt;*&lt;/span&gt;&quot; : &quot;&quot; ) : null ), &nbsp;</div></li><li><div>            &quot;label_after&quot; =&gt; &quot;&lt;/label&gt;&quot;, &nbsp;</div></li><li><div>            &quot;field_placeholder&quot; =&gt; ( ! empty( $field[ 'hide_label' ] ) ? 'placeholder=&quot;' . htmlentities( $field[ 'label' ] ) . '&quot;' : null ), &nbsp;</div></li><li><div>            &quot;field_required&quot; =&gt; ( ! empty( $field[ 'required' ] ) ? 'required=&quot;required&quot;' : null ), &nbsp;</div></li><li><div>            &quot;field_value&quot; =&gt; null, &nbsp;</div></li><li><div>            &quot;field_caption&quot; =&gt; ( ! empty( $field[ 'caption' ] ) ? &quot;&lt;span id=\&quot;&quot; . $field[ 'ID' ] . &quot;Caption\&quot; class=\&quot;&quot; . implode( ' ', $field_classes[ 'field_caption' ] ) . &quot;\&quot;&gt;&quot; . $field[ 'caption' ] . &quot;&lt;/span&gt;\r\n&quot; : &quot;&quot; ), &nbsp;</div></li><li><div>            &quot;field_after&quot; =&gt; &quot;&lt;/div&gt;\r\n&quot;, &nbsp;</div></li><li><div>            &quot;wrapper_after&quot; =&gt; &quot;&lt;/div&gt;\r\n&quot;, &nbsp;</div></li><li><div>            &quot;aria&quot; =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_structure[ 'aria' ][ 'labelledby' ] = $field[ 'ID' ] . 'Label';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if has caption&nbsp;</div></li><li><div>        if ( ! empty( $field[ 'caption' ] ) ) {&nbsp;</div></li><li><div>            $field_structure[ 'aria' ][ 'describedby' ] = $field[ 'ID' ] . 'Caption';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add error&nbsp;</div></li><li><div>        if ( ! empty( $field_errors ) ) {&nbsp;</div></li><li><div>            if ( is_string( $field_errors ) ) {&nbsp;</div></li><li><div>                $field_errors = array( $field_errors );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $field_errors as $error ) {&nbsp;</div></li><li><div>                $field_structure[ 'field_caption' ] = &quot;&lt;span class=\&quot;&quot; . implode( ' ', $field_classes[ 'field_caption' ] ) . &quot;\&quot;&gt;&quot; . $error . &quot;&lt;/span&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // value&nbsp;</div></li><li><div>        if ( isset( $field[ 'config' ][ 'default' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_structure[ 'field_value' ] = self::do_magic_tags( $field[ 'config' ][ 'default' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // transient data&nbsp;</div></li><li><div>        if ( isset( $entry_data[ $field[ 'ID' ] ] ) ) {&nbsp;</div></li><li><div>            $field_structure[ 'field_value' ] = $entry_data[ $field[ 'ID' ] ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_structure = apply_filters( 'caldera_forms_render_field_structure', $field_structure, $form );&nbsp;</div></li><li><div>        $field_structure = apply_filters( 'caldera_forms_render_field_structure_type-' . $field[ 'type' ], $field_structure, $form );&nbsp;</div></li><li><div>        $field_structure = apply_filters( 'caldera_forms_render_field_structure_slug-' . $field[ 'slug' ], $field_structure, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // compile aria tags&nbsp;</div></li><li><div>        if ( ! empty( $field_structure[ 'aria' ] ) ) {&nbsp;</div></li><li><div>            $aria_atts = null;&nbsp;</div></li><li><div>            foreach ( $field_structure[ 'aria' ] as $att =&gt; $att_val ) {&nbsp;</div></li><li><div>                $aria_atts .= ' aria-' . $att . '=&quot;' . esc_attr( $att_val ) . '&quot;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $field_structure[ 'aria' ] = $aria_atts;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_name = $field_structure[ 'name' ];&nbsp;</div></li><li><div>        $field_id = $field_structure[ 'id' ] . '_' . $current_form_count;&nbsp;</div></li><li><div>        $wrapper_before = $field_structure[ 'wrapper_before' ];&nbsp;</div></li><li><div>        $field_before = $field_structure[ 'field_before' ];&nbsp;</div></li><li><div>        $field_label = $field_structure[ 'label_before' ] . $field_structure[ 'label' ] . $field_structure[ 'label_required' ] . $field_structure[ 'label_after' ] . &quot;\r\n&quot;;&nbsp;</div></li><li><div>        $field_placeholder = $field_structure[ 'field_placeholder' ];&nbsp;</div></li><li><div>        $field_required = $field_structure[ 'field_required' ];&nbsp;</div></li><li><div>        $field_caption = $field_structure[ 'field_caption' ];&nbsp;</div></li><li><div>        $field_after = $field_structure[ 'field_after' ];&nbsp;</div></li><li><div>        $wrapper_after = $field_structure[ 'wrapper_after' ];&nbsp;</div></li><li><div>        // blank default&nbsp;</div></li><li><div>        $field_value = $field_structure[ 'field_value' ];&nbsp;</div></li><li><div>        // setup base instance ID&nbsp;</div></li><li><div>        $field_base_id = $field[ 'ID' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // register strings&nbsp;</div></li><li><div>        $form_field_strings[ $field_structure[ 'id' ] ] = array(&nbsp;</div></li><li><div>            'id' =&gt; $field_structure[ 'id' ], &nbsp;</div></li><li><div>            'instance' =&gt; $current_form_count, &nbsp;</div></li><li><div>            'slug' =&gt; $field[ 'slug' ], &nbsp;</div></li><li><div>            'label' =&gt; $field[ 'label' ]&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_file = $field_types[ $field[ 'type' ] ][ 'file' ];&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the file path to be used for a field's HTML in front-end&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.4&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $field_file The path to the file&nbsp;</div></li><li><div>         * @param string $field_type The field type&nbsp;</div></li><li><div>         * @param string $field The field ID.&nbsp;</div></li><li><div>         * @param string $field_structure Data to be used in field&nbsp;</div></li><li><div>         * @param array $form Current form (NOTE: May be null)&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $field_file = apply_filters( 'caldera_forms_render_field_file', $field_file, $field[ 'type' ], $field[ 'ID' ], $field_file, $field_structure, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        include $field_file;&nbsp;</div></li><li><div>        $field_html = apply_filters( 'caldera_forms_render_field', ob_get_clean(), $form );&nbsp;</div></li><li><div>        $field_html = apply_filters( 'caldera_forms_render_field_type-' . $field[ 'type' ], $field_html, $form );&nbsp;</div></li><li><div>        $field_html = apply_filters( 'caldera_forms_render_field_slug-' . $field[ 'slug' ], $field_html, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_html;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create HTML markup for a form.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array|string $atts Form ID or shortcode atts or form config array&nbsp;</div></li><li><div>     * @param null|int $entry_id Optional. Entry ID to load data from. Null, the default, loads form for creating a new entry.&nbsp;</div></li><li><div>     * @param null $shortcode No longer used.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return void|string HTML for form, if it was able to be laoded&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function render_form( $atts, $entry_id = null, $shortcode = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $current_form_count, $form, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $atts ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $atts ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $atts );&nbsp;</div></li><li><div>            $atts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif ( is_array( $atts ) && isset( $atts[ 'ID' ] ) ) {&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $atts[ 'ID' ] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $atts[ 'id' ] ) ) {&nbsp;</div></li><li><div>                if ( ! empty( $atts[ 'name' ] ) ) {&nbsp;</div></li><li><div>                    $form = Caldera_Forms_Forms::get_form( $atts[ 'name' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( ! empty( $atts[ 'id' ] ) ) {&nbsp;</div></li><li><div>                $form = Caldera_Forms_Forms::get_form( $atts[ 'id' ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // is this form allowed to render ( check state )&nbsp;</div></li><li><div>        if ( isset( $form[ 'form_draft' ] ) ) {&nbsp;</div></li><li><div>            if ( ! isset( $_GET[ 'cf_preview' ] ) || $_GET[ 'cf_preview' ] != $form[ 'ID' ] ) {&nbsp;</div></li><li><div>                if ( isset( $_POST[ 'action' ] ) && $_POST[ 'action' ] == 'cf_get_form_preview' ) {&nbsp;</div></li><li><div>                    echo '&lt;p style=&quot;color: #cf0000;&quot;&gt;' . __( 'Form is currently not active.', 'caldera-forms' ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    return;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                echo '&lt;div class=&quot;caldera-grid&quot;&gt;&lt;p class=&quot;alert alert-error alert-danger&quot;&gt;' . __( 'Form is currently not active.', 'caldera-forms' ) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Caldera_Forms_Render_Assets::optional_style_includes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $atts[ 'ajax' ] ) ) {&nbsp;</div></li><li><div>            if ( ! empty( $atts[ 'ajax' ] ) ) {&nbsp;</div></li><li><div>                $form[ 'form_ajax' ] = 1;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $form[ 'form_ajax' ] = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // set entry edit&nbsp;</div></li><li><div>        if ( ! empty( $atts[ 'entry' ] ) ) {&nbsp;</div></li><li><div>            $entry_id = self::do_magic_tags( $atts[ 'entry' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter form settings, before rendering form.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $entry_id The entry ID.&nbsp;</div></li><li><div>         * @param array $form Form config.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $form = apply_filters( 'caldera_forms_render_get_form', $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Set entry ID when loading form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.2.3&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $entry_id The entry ID.&nbsp;</div></li><li><div>         * @param array $form Form config.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $entry_id = apply_filters( 'caldera_forms_render_entry_id', $entry_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after form is loaded and before rendering starts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * NOTE: An excellent way to conditionally abort form loading.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.4&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param null|string $html By default, null. If string is returned, method will immediately return that string.&nbsp;</div></li><li><div>         * @param int $entry_id The entry ID.&nbsp;</div></li><li><div>         * @param array $form Form config.&nbsp;</div></li><li><div>         * @param array $atts Shortcode/function atts&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $html = apply_filters( 'caldera_forms_pre_render_form', null, $entry_id, $form, $atts );&nbsp;</div></li><li><div>        if ( is_string( $html ) ) {&nbsp;</div></li><li><div>            return $html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $current_form_count ) ) {&nbsp;</div></li><li><div>            $current_form_count = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $current_form_count += 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set instance&nbsp;</div></li><li><div>        if ( ! empty( $atts[ 'instance' ] ) ) {&nbsp;</div></li><li><div>            $current_form_count = absint( $atts[ 'instance' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_types = Caldera_Forms_Fields::get_all();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'caldera_forms_render_start', $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_attributes = array(&nbsp;</div></li><li><div>            'method' =&gt;    'POST', &nbsp;</div></li><li><div>            'enctype' =&gt;    'multipart/form-data', &nbsp;</div></li><li><div>            'role' =&gt;    'form', &nbsp;</div></li><li><div>            'id' =&gt;    $form['ID'] . '_' . $current_form_count&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //add extra attributes to make AJAX submissions JS do its thing&nbsp;</div></li><li><div>        if( ! empty( $form[ 'form_ajax'] ) ) {&nbsp;</div></li><li><div>            add_filter('caldera_forms_render_form_attributes', 'cf_ajax_setatts', 10, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Modify HTML attributes applied to form element&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form_attributes Array of HTML attributes&nbsp;</div></li><li><div>         * @param array $config Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $form_attributes = apply_filters( 'caldera_forms_render_form_attributes', $form_attributes, $form);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        include_once CFCORE_PATH . &quot;classes/caldera-grid.php&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gridsize = 'sm';&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'settings' ][ 'responsive' ][ 'break_point' ] ) ) {&nbsp;</div></li><li><div>            $gridsize = $form[ 'settings' ][ 'responsive' ][ 'break_point' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * What size grid to use for the grid&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $size Size for grid. Default is &quot;sm&quot;&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $gridsize = apply_filters( 'caldera_forms_render_set_grid_size', $gridsize );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set grid render engine&nbsp;</div></li><li><div>        $grid_settings = array(&nbsp;</div></li><li><div>            &quot;first&quot; =&gt; 'first_row', &nbsp;</div></li><li><div>            &quot;last&quot; =&gt; 'last_row', &nbsp;</div></li><li><div>            &quot;single&quot; =&gt; 'single', &nbsp;</div></li><li><div>            &quot;before&quot; =&gt; '&lt;div %1$s class=&quot;row %2$s&quot;&gt;', &nbsp;</div></li><li><div>            &quot;after&quot; =&gt; '&lt;/div&gt;', &nbsp;</div></li><li><div>            &quot;column_first&quot; =&gt; 'first_col', &nbsp;</div></li><li><div>            &quot;column_last&quot; =&gt; 'last_col', &nbsp;</div></li><li><div>            &quot;column_single&quot; =&gt; 'single', &nbsp;</div></li><li><div>            &quot;column_before&quot; =&gt; '&lt;div %1$s class=&quot;col-'.$gridsize.'-%2$d %3$s&quot;&gt;', &nbsp;</div></li><li><div>            &quot;column_after&quot; =&gt; '&lt;/div&gt;', &nbsp;</div></li><li><div>            'form_id' =&gt; $form['ID'], &nbsp;</div></li><li><div>            'form_id_attr' =&gt;   $form_attributes[ 'id']&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // filter settings&nbsp;</div></li><li><div>        $grid_settings = apply_filters( 'caldera_forms_render_grid_settings', $grid_settings, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form[ 'grid_object' ] = new Caldera_Form_Grid( $grid_settings );&nbsp;</div></li><li><div>        if ( empty( $form[ 'layout_grid' ] ) ) {&nbsp;</div></li><li><div>            $form[ 'layout_grid' ] = array( 'structure' =&gt; '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build Pages Breaks&nbsp;</div></li><li><div>        if ( false !== strpos( $form[ 'layout_grid' ][ 'structure' ], '#' ) ) {&nbsp;</div></li><li><div>            // setup pages&nbsp;</div></li><li><div>            $pages = explode( '#', $form[ 'layout_grid' ][ 'structure' ] );&nbsp;</div></li><li><div>            $page_breaks = array();&nbsp;</div></li><li><div>            foreach ( $pages as $page_no =&gt; $page ) {&nbsp;</div></li><li><div>                $point = substr_count( $page, '|' ) + 1;&nbsp;</div></li><li><div>                if ( isset( $page_breaks[ $page_no - 1 ] ) ) {&nbsp;</div></li><li><div>                    $point += $page_breaks[ $page_no - 1 ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $page_breaks[ $page_no ] = $point;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $form[ 'layout_grid' ][ 'structure' ] = str_replace( '#', '|', $form[ 'layout_grid' ][ 'structure' ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setup notcies&nbsp;</div></li><li><div>        $notices = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $note_general_classes = Caldera_Forms_Render_Notices::get_note_general_classes( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $note_classes = Caldera_Forms_Render_Notices::get_note_classes( $note_general_classes, $form );&nbsp;</div></li><li><div>        $field_errors = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // edit entry from url&nbsp;</div></li><li><div>        if ( ! empty( $_GET[ 'cf_ee' ] ) ) {&nbsp;</div></li><li><div>            $entry_id = $_GET[ 'cf_ee' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // attr entry id&nbsp;</div></li><li><div>        if ( ! empty( $atts[ 'entry' ] ) ) {&nbsp;</div></li><li><div>            $entry_id = $atts[ 'entry' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>            //check user can edit this item.&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>            $details = self::get_entry_detail( $entry_id, $form );&nbsp;</div></li><li><div>            if ( ! empty( $_GET[ 'cf_et' ] ) ) {&nbsp;</div></li><li><div>                // build token&nbsp;</div></li><li><div>                $validated = Caldera_Forms_Entry_Token::verify_token( trim( $_GET[ 'cf_et' ] ), $_GET[ 'cf_et' ], $form[ 'ID' ] );&nbsp;</div></li><li><div>                if ( ! is_wp_error( $validated ) ) {&nbsp;</div></li><li><div>                    $notices[ 'error' ][ 'note' ] = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $entry_id = (int) $details[ 'id' ];&nbsp;</div></li><li><div>                    $edit_token = Caldera_Forms_Entry_Token::create_entry_token( $entry_id, $form[ 'ID' ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $user_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $details ) ) {&nbsp;</div></li><li><div>                        // check user can edit&nbsp;</div></li><li><div>                        if ( current_user_can( 'edit_posts' ) || $details[ 'user_id' ] === $user_id ) {&nbsp;</div></li><li><div>                            // can edit.&nbsp;</div></li><li><div>                            $entry_id = (int) $details[ 'id' ];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $notices[ 'error' ][ 'note' ] = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $notices[ 'error' ][ 'note' ] = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $notices[ 'error' ][ 'note' ] = __( 'Permission denied or entry does not exist.', 'caldera-forms' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $notices[ 'error' ][ 'note' ] ) ) {&nbsp;</div></li><li><div>                $halt_render = true;&nbsp;</div></li><li><div>                $entry_id = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check for prev post&nbsp;</div></li><li><div>        $prev_data = apply_filters( 'caldera_forms_render_pre_get_entry', array(), $form, $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // load requested data&nbsp;</div></li><li><div>        if ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>            $prev_entry = self::get_entry( $entry_id, $form );&nbsp;</div></li><li><div>            $prev_data = array();&nbsp;</div></li><li><div>            self::set_field_data( '_entry_id', $entry_id, $form );&nbsp;</div></li><li><div>            foreach ( $prev_entry[ 'data' ] as $field_id =&gt; $entry_data ) {&nbsp;</div></li><li><div>                $prev_data[ $field_id ] = $entry_data[ 'value' ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $prev_data = apply_filters( 'caldera_forms_render_get_entry', $prev_data, $form, $entry_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_GET['cf_er'])) {&nbsp;</div></li><li><div>            $prev_post = Caldera_Forms_Transient::get_transient( $_GET['cf_er'] );&nbsp;</div></li><li><div>            if(!empty($prev_post['transient'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $prev_post[ 'transient' ] === $_GET[ 'cf_er' ] ) {&nbsp;</div></li><li><div>                    foreach ( $prev_post[ 'data' ] as $field_id =&gt; $field_entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! isset( $form[ 'fields' ][ $field_id ] ) ) {&nbsp;</div></li><li><div>                            continue; // ignore non field data&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! is_wp_error( $field_entry ) ) {&nbsp;</div></li><li><div>                            $prev_data[ $field_id ] = $field_entry;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $prev_post[ 'type' ] ) && ! empty( $prev_post[ 'note' ] ) ) {&nbsp;</div></li><li><div>                    $notices[ $prev_post[ 'type' ] ][ 'note' ] = $prev_post[ 'note' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $prev_post[ 'error' ] ) && ! empty( $prev_post[ 'note' ] ) ) {&nbsp;</div></li><li><div>                    $notices[ 'error' ][ 'note' ] = $prev_post[ 'note' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( $prev_post[ 'fields' ] ) ) {&nbsp;</div></li><li><div>                    $field_errors = array();&nbsp;</div></li><li><div>                    foreach ( $prev_post[ 'fields' ] as $field_id =&gt; $field_error ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_wp_error( $field_error ) ) {&nbsp;</div></li><li><div>                            $field_errors[ $field_id ] = $field_error-&gt;get_error_message();&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $field_errors[ $field_id ] = $field_error;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // filter transient&nbsp;</div></li><li><div>            $prev_post = apply_filters( 'caldera_forms_render_get_transient', $prev_post, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! empty( $_GET[ 'cf_su' ] ) && $current_form_count == $_GET[ 'cf_su' ] ) {&nbsp;</div></li><li><div>            if ( empty( $notices[ 'success' ][ 'note' ] ) ) {&nbsp;</div></li><li><div>                $notices[ 'success' ][ 'note' ] = $form[ 'success' ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // build grid & pages&nbsp;</div></li><li><div>        $form[ 'grid_object' ]-&gt;setLayout( $form[ 'layout_grid' ][ 'structure' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // insert page breaks&nbsp;</div></li><li><div>        if ( ! empty( $page_breaks ) ) {&nbsp;</div></li><li><div>            $currentpage = 1;&nbsp;</div></li><li><div>            if ( isset( $_GET[ 'cf_pg' ] ) && ! isset( $prev_post[ 'page' ] ) ) {&nbsp;</div></li><li><div>                $currentpage = (int) $_GET[ 'cf_pg' ];&nbsp;</div></li><li><div>            } elseif ( isset( $prev_post[ 'page' ] ) ) {&nbsp;</div></li><li><div>                $currentpage = (int) $prev_post[ 'page' ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $display = 'none';&nbsp;</div></li><li><div>            $hidden = 'true';&nbsp;</div></li><li><div>            if ( $currentpage === 1 ) {&nbsp;</div></li><li><div>                $display = 'block';&nbsp;</div></li><li><div>                $hidden = 'false';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $total_rows = substr_count( $form[ 'layout_grid' ][ 'structure' ], '|' ) + 1;&nbsp;</div></li><li><div>            $form[ 'grid_object' ]-&gt;before( '&lt;div id=&quot;form_page_' . $current_form_count . '_pg_1&quot; data-formpage=&quot;1&quot; class=&quot;caldera-form-page&quot; style=&quot;display:' . $display . ';&quot; role=&quot;region&quot; aria-labelledby=&quot;breadcrumb_' . $current_form_count . '_pg_1&quot; aria-hidden=&quot;' . $hidden . '&quot;&gt;', 1 );&nbsp;</div></li><li><div>            $form[ 'grid_object' ]-&gt;after( '&lt;/div&gt;', $total_rows );&nbsp;</div></li><li><div>            foreach ( $page_breaks as $page =&gt; $break ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $form[ 'grid_object' ]-&gt;after( '&lt;/div&gt;', $break );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $break + 1 &lt;= $total_rows ) {&nbsp;</div></li><li><div>                    $display = 'none';&nbsp;</div></li><li><div>                    $hidden = 'true';&nbsp;</div></li><li><div>                    if ( $page + 2 == $currentpage ) {&nbsp;</div></li><li><div>                        $display = 'block';&nbsp;</div></li><li><div>                        $hidden = 'false';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $form[ 'grid_object' ]-&gt;before( '&lt;div id=&quot;form_page_' . $current_form_count . '_pg_' . ( $page + 2 ) . '&quot; data-formpage=&quot;' . ( $page + 2 ) . '&quot; role=&quot;region&quot; aria-labelledby=&quot;breadcrumb_' . $current_form_count . '_pg_' . ( $page + 2 ) . '&quot; aria-hidden=&quot;' . $hidden . '&quot; class=&quot;caldera-form-page&quot; style=&quot;display:' . $display . ';&quot;&gt;', $break + 1 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // setup processor bound requieds&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'processors' ] ) ) {&nbsp;</div></li><li><div>            $bound_fields = array();&nbsp;</div></li><li><div>            foreach ( $form[ 'processors' ] as $processor_id =&gt; $processor ) {&nbsp;</div></li><li><div>                if ( ! empty( $processor[ 'config' ][ '_required_bounds' ] ) ) {&nbsp;</div></li><li><div>                    foreach ( $processor[ 'config' ] as $slug =&gt; &$value ) {&nbsp;</div></li><li><div>                        if ( $slug == '_required_bounds' ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ( in_array( $slug, $processor[ 'config' ][ '_required_bounds' ] ) ) {&nbsp;</div></li><li><div>                            $bound_fields = array_merge( $bound_fields, self::search_array_fields( $value, array_keys( $form[ 'fields' ] ) ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $bound_fields as $bound ) {&nbsp;</div></li><li><div>                $form[ 'fields' ][ $bound ][ 'required' ] = 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $conditions_templates = array();&nbsp;</div></li><li><div>        $conditions_configs = array();&nbsp;</div></li><li><div>        $used_slugs = array();&nbsp;</div></li><li><div>        $form_field_strings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'fields' ] ) ) {&nbsp;</div></li><li><div>            // prepare fields&nbsp;</div></li><li><div>            foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>                $field = apply_filters( 'caldera_forms_render_get_field', $field, $form );&nbsp;</div></li><li><div>                $field = apply_filters( 'caldera_forms_render_get_field_type-' . $field[ 'type' ], $field, $form );&nbsp;</div></li><li><div>                $field = apply_filters( 'caldera_forms_render_get_field_slug-' . $field[ 'slug' ], $field, $form );&nbsp;</div></li><li><div>                $form[ 'fields' ][ $field_id ] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'layout_grid' ][ 'fields' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $form[ 'layout_grid' ][ 'fields' ] as $field_base_id =&gt; $location ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $form[ 'fields' ][ $field_base_id ] ) ) {&nbsp;</div></li><li><div>                    $field = self::load_field( $form, $field_base_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( empty( $field ) || ! isset( $field_types[ $field[ 'type' ] ][ 'file' ] ) || ! file_exists( $field_types[ $field[ 'type' ] ][ 'file' ] ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field[ 'grid_location' ] = $location;&nbsp;</div></li><li><div>                    //$field[ 'page' ] = $cr&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    Caldera_Forms_Render_Assets::enqueue_field_scripts( $field_types, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_base_id = $field[ 'ID' ] . '_' . $current_form_count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_error = array();&nbsp;</div></li><li><div>                    if ( isset( $field_errors[ $field[ 'ID' ] ] ) ) {&nbsp;</div></li><li><div>                        $field_error = $field_errors[ $field[ 'ID' ] ];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_html = self::render_field( $field, $form, $prev_data, $field_error );&nbsp;</div></li><li><div>                    // conditional wrapper&nbsp;</div></li><li><div>                    if ( ! empty( $field[ 'conditions' ][ 'group' ] ) && ! empty( $field[ 'conditions' ][ 'type' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $conditions_configs[ $field_base_id ] = $field[ 'conditions' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $field[ 'conditions' ][ 'type' ] !== 'disable' ) {&nbsp;</div></li><li><div>                            // wrap it up&nbsp;</div></li><li><div>                            $conditions_templates[ $field_base_id ] = &quot;&lt;script type=\&quot;text/html\&quot; id=\&quot;conditional-&quot; . $field_base_id . &quot;-tmpl\&quot;&gt;\r\n&quot; . $field_html . &quot;&lt;/script&gt;\r\n&quot;;&nbsp;</div></li><li><div>                            // add in instance number&nbsp;</div></li><li><div>                            if ( ! empty( $field[ 'conditions' ][ 'group' ] ) ) {&nbsp;</div></li><li><div>                                foreach ( $field[ 'conditions' ][ 'group' ] as &$group_row ) {&nbsp;</div></li><li><div>                                    foreach ( $group_row as &$group_line ) {&nbsp;</div></li><li><div>                                        // add instance value&nbsp;</div></li><li><div>                                        $group_line[ 'instance' ] = $current_form_count;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $field[ 'conditions' ][ 'type' ] == 'show' || $field[ 'conditions' ][ 'type' ] == 'wdisable' ) {&nbsp;</div></li><li><div>                            // show if indicates hidden by default until condition is matched.&nbsp;</div></li><li><div>                            $field_html = null;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // wrapp it up&nbsp;</div></li><li><div>                        $field_html = '&lt;span class=&quot;caldera-forms-conditional-field&quot; role=&quot;region&quot; aria-live=&quot;polite&quot; id=&quot;conditional_' . $field_base_id . '&quot; data-field-id=&quot;' . $field_base_id . '&quot;&gt;' . $field_html . '&lt;/span&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $form[ 'grid_object' ]-&gt;append( $field_html, $field[ 'grid_location' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // form object strings&nbsp;</div></li><li><div>        wp_localize_script( 'cf-dynamic', $form[ 'ID' ] . '_' . $current_form_count, $form_field_strings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // do grid&nbsp;</div></li><li><div>        $form[ 'grid_object' ] = apply_filters( 'caldera_forms_render_grid_structure', $form[ 'grid_object' ], $form );&nbsp;</div></li><li><div>        // wrapper classes&nbsp;</div></li><li><div>        $form_wrapper_classes = array(&nbsp;</div></li><li><div>            &quot;caldera-grid&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Change classes of elements wrapping the grid&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form_wrapper_classes Array of classes&nbsp;</div></li><li><div>         * @param array $config Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $form_wrapper_classes = apply_filters( 'caldera_forms_render_form_wrapper_classes', $form_wrapper_classes, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_wrap_id = Caldera_Forms_Render_Util::form_id_attr( $current_form_count );&nbsp;</div></li><li><div>        $out = sprintf( '&lt;div class=&quot;%s&quot; id=&quot;%s&quot; data-cf-ver=&quot;%s&quot; data-cf-form-id=&quot;%s&quot;&gt;', esc_attr( implode( ' ', $form_wrapper_classes ) ), esc_attr( $form_wrap_id ), esc_attr( CFCORE_VER ), esc_attr( $form[ 'ID' ] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notices = Caldera_Forms_Render_Notices::prepare_notices( $notices, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set debug notice&nbsp;</div></li><li><div>        if ( ! empty( $form[ 'mailer' ][ 'enable_mailer' ] ) && ! empty( $form[ 'debug_mailer' ] ) ) {&nbsp;</div></li><li><div>            $notices[ 'error' ] = array( 'note' =&gt; __( 'WARNING: Form is in Mailer Debug mode. Disable before going live.', 'caldera-forms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $out .= '&lt;div id=&quot;caldera_notices_' . $current_form_count . '&quot; data-spinner=&quot;' . admin_url( 'images/spinner.gif' ) . '&quot;&gt;';&nbsp;</div></li><li><div>        if ( ! empty( $notices ) ) {&nbsp;</div></li><li><div>            // do notices&nbsp;</div></li><li><div>            // entry id&nbsp;</div></li><li><div>            if ( isset( $_GET[ 'cf_id' ] ) ) {&nbsp;</div></li><li><div>                $notice_entry_id = (int) $_GET[ 'cf_id' ];&nbsp;</div></li><li><div>            } elseif ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>                $notice_entry_id = $entry_id;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $notice_entry_id = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $notices as $note_type =&gt; $notice ) {&nbsp;</div></li><li><div>                if ( ! empty( $notice[ 'note' ] ) ) {&nbsp;</div></li><li><div>                    $out .= '&lt;div class=&quot; ' . implode( ' ', $note_classes[ $note_type ] ) . '&quot;&gt;' . self::do_magic_tags( $notice[ 'note' ], $notice_entry_id ) . '&lt;/div&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $out .= '&lt;/div&gt;';&nbsp;</div></li><li><div>        if ( ( empty( $notices[ 'success' ] ) || empty( $form[ 'hide_form' ] ) ) && empty( $halt_render ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_element = 'form';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_classes = array(&nbsp;</div></li><li><div>                $form[ 'ID' ], &nbsp;</div></li><li><div>                'caldera_forms_form', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Change what type of element form is in.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * Note: Using anything besides &quot;form&quot; here will make form cease to function as a form.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since unknown&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string $form_element Form element type.&nbsp;</div></li><li><div>             * @param array $config Form config&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $form_element = apply_filters( 'caldera_forms_render_form_element', $form_element, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Modify classes applied to form element&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since unknown&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param array $form_classes Array of classes&nbsp;</div></li><li><div>             * @param array $config Form config&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $form_classes = apply_filters( 'caldera_forms_render_form_classes', $form_classes, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attributes = array();&nbsp;</div></li><li><div>            foreach ( $form_attributes as $attribute =&gt; $value ) {&nbsp;</div></li><li><div>                $attributes[] = $attribute . '=&quot;' . htmlentities( $value ) . '&quot;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // render only non success&nbsp;</div></li><li><div>            $out .= &quot;&lt;&quot; . $form_element . &quot; data-instance=\&quot;&quot; . $current_form_count . &quot;\&quot; class=\&quot;&quot; . implode( ' ', $form_classes ) . &quot;\&quot; &quot; . implode( &quot; &quot;, $attributes ) . &quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            $out .= Caldera_Forms_Render_Nonce::nonce_field( $form[ 'ID' ] );&nbsp;</div></li><li><div>            $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_frm_id\&quot; value=\&quot;&quot; . $form[ 'ID' ] . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_frm_ct\&quot; value=\&quot;&quot; . $current_form_count . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            if ( ! empty( $form[ 'form_ajax' ] ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;cfajax\&quot; value=\&quot;&quot; . $form[ 'ID' ] . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( is_object( $post ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_cr_pst\&quot; value=\&quot;&quot; . $post-&gt;ID . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // user transient for continuation&nbsp;</div></li><li><div>            if ( ! empty( $prev_post[ 'transient' ] ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_frm_tr\&quot; value=\&quot;&quot; . $prev_post[ 'transient' ] . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // is edit?&nbsp;</div></li><li><div>            if ( ! empty( $entry_id ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_frm_edt\&quot; value=\&quot;&quot; . $entry_id . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // is edit via token?&nbsp;</div></li><li><div>            if ( ! empty( $edit_token ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;_cf_frm_edt_tkn\&quot; value=\&quot;&quot; . $edit_token . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //setup fieldjs&nbsp;</div></li><li><div>            Caldera_Forms_Field_Localizer::add_form( $form, Caldera_Forms_Render_Util::get_current_form_count() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // auto pagination&nbsp;</div></li><li><div>            if ( ! empty( $form[ 'auto_progress' ] ) && count( $form[ 'page_names' ] ) &gt; 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // retain query string&nbsp;</div></li><li><div>                $qurystr = array();&nbsp;</div></li><li><div>                parse_str( $_SERVER[ 'QUERY_STRING' ], $qurystr );&nbsp;</div></li><li><div>                $out .= &quot;&lt;span class=\&quot;caldera-grid\&quot;&gt;&lt;ol class=\&quot;breadcrumb\&quot; data-form=\&quot;caldera_form_&quot; . $current_form_count . &quot;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>                $current_page = 1;&nbsp;</div></li><li><div>                if ( ! empty( $_GET[ 'cf_pg' ] ) ) {&nbsp;</div></li><li><div>                    $current_page = $_GET[ 'cf_pg' ];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                foreach ( $form[ 'page_names' ] as $page_key =&gt; $page_name ) {&nbsp;</div></li><li><div>                    $tabclass = null;&nbsp;</div></li><li><div>                    $expanded = 'false';&nbsp;</div></li><li><div>                    if ( $current_page == $page_key + 1 ) {&nbsp;</div></li><li><div>                        $tabclass = ' class=&quot;active&quot;';&nbsp;</div></li><li><div>                        $expanded = 'true';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $qurystr[ 'cf_pg' ] = $page_key + 1;&nbsp;</div></li><li><div>                    $out .= &quot;&lt;li&quot; . $tabclass . &quot;&gt;&lt;a aria-controls=\&quot;form_page_&quot; . $current_form_count . &quot;_pg_&quot; . ( $page_key + 1 ) . &quot;\&quot; aria-expanded=\&quot;&quot; . $expanded . &quot;\&quot; id=\&quot;breadcrumb_&quot; . $current_form_count . &quot;_pg_&quot; . ( $page_key + 1 ) . &quot;\&quot; href=\&quot;?&quot; . http_build_query( $qurystr ) . &quot;\&quot; data-page=\&quot;&quot; . ( $page_key + 1 ) . &quot;\&quot; data-pagenav=\&quot;caldera_form_&quot; . $current_form_count . &quot;\&quot; title=\&quot;&quot; . sprintf( __( 'Navigate to %s', 'caldera-forms' ), $page_name ) . &quot;\&quot;&gt;&quot; . $page_name . &quot;&lt;/a&gt;&lt;/li&gt;\r\n&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $out .= &quot;&lt;/ol&gt;&lt;/span&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // sticky sticky honey&nbsp;</div></li><li><div>            if ( isset( $form[ 'check_honey' ] ) ) {&nbsp;</div></li><li><div>                $out .= &quot;&lt;div class=\&quot;hide\&quot; style=\&quot;display:none; overflow:hidden;height:0;width:0;\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Change which words are used to form honey pot&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since unknown&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param array $words An array of words.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $honey_words = apply_filters( 'caldera_forms_get_honey_words', array(&nbsp;</div></li><li><div>                    'web_site', &nbsp;</div></li><li><div>                    'url', &nbsp;</div></li><li><div>                    'email', &nbsp;</div></li><li><div>                    'company', &nbsp;</div></li><li><div>                    'name'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                $word = $honey_words[ rand( 0, count( $honey_words ) - 1 ) ];&nbsp;</div></li><li><div>                $out .= &quot;&lt;label&gt;&quot; . ucwords( str_replace( '_', ' ', $word ) ) . &quot;&lt;/label&gt;&lt;input type=\&quot;text\&quot; name=\&quot;&quot; . $word . &quot;\&quot; value=\&quot;\&quot; autocomplete=\&quot;off\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>                $out .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $out .= $form[ 'grid_object' ]-&gt;renderLayout();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $out .= &quot;&lt;/&quot; . $form_element . &quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $out .= &quot;&lt;/div&gt;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // output javascript conditions.&nbsp;</div></li><li><div>        if ( ! empty( $conditions_configs ) ) {&nbsp;</div></li><li><div>            // sortout magics&nbsp;</div></li><li><div>            foreach ( $conditions_configs as &$condition_field_conf ) {&nbsp;</div></li><li><div>                if ( ! empty( $condition_field_conf[ 'group' ] ) ) {&nbsp;</div></li><li><div>                    foreach ( $condition_field_conf[ 'group' ] as &$condition_group ) {&nbsp;</div></li><li><div>                        if ( ! empty( $condition_group ) ) {&nbsp;</div></li><li><div>                            foreach ( $condition_group as &$condition_line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( isset( $form[ 'fields' ][ $condition_line[ 'field' ] ][ 'config' ][ 'option' ][ $condition_line[ 'value' ] ] ) ) {&nbsp;</div></li><li><div>                                    $condition_line[ 'label' ] = $form[ 'fields' ][ $condition_line[ 'field' ] ][ 'config' ][ 'option' ][ $condition_line[ 'value' ] ][ 'label' ];&nbsp;</div></li><li><div>                                    $condition_line[ 'value' ] = $form[ 'fields' ][ $condition_line[ 'field' ] ][ 'config' ][ 'option' ][ $condition_line[ 'value' ] ][ 'value' ];&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if ( false !== strpos( $condition_line[ 'field' ], '{' ) && false !== strpos( $condition_line[ 'field' ], '}' ) ) {&nbsp;</div></li><li><div>                                        $condition_line[ 'field' ] = self::do_magic_tags( $condition_line[ 'field' ] );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                //strip out fields&nbsp;</div></li><li><div>                                $regex = &quot;/%([a-zA-Z0-9_:]*)%/&quot;;&nbsp;</div></li><li><div>                                preg_match_all( $regex, $condition_line[ 'value' ], $matches );&nbsp;</div></li><li><div>                                if ( ! empty( $matches[ 1 ] ) ) {&nbsp;</div></li><li><div>                                    foreach ( $matches[ 1 ] as $field_slug ) {&nbsp;</div></li><li><div>                                        $value_field = self::get_field_by_slug( $field_slug, $form );&nbsp;</div></li><li><div>                                        $condition_line[ 'selectors' ][ $value_field[ 'ID' ] ] = '[data-field=&quot;' . $value_field[ 'ID' ] . '&quot;]';&nbsp;</div></li><li><div>                                        $condition_line[ 'value' ]                             = str_replace( '%' . $field_slug . '%', $value_field[ 'ID' ], $condition_line[ 'value' ] );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $condition_line[ 'value' ] = self::do_magic_tags( $condition_line[ 'value' ] );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $conditions_str = wp_json_encode( $conditions_configs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $hastags = Caldera_Forms_Magic_Util::explode_field_magic( $conditions_str );&nbsp;</div></li><li><div>            if ( ! empty( $hastags[ 1 ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $hastags[ 1 ] as $tag_key =&gt; $tag ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $form[ 'fields' ] as $field_id =&gt; $field ) {&nbsp;</div></li><li><div>                        if ( $field[ 'slug' ] === $tag ) {&nbsp;</div></li><li><div>                            $conditions_str = str_replace( '&quot;' . $hastags[ 0 ][ $tag_key ] . '&quot;', &quot;function() { return jQuery('#&quot; . $field[ 'ID' ] . '_' . $current_form_count . &quot;').val(); }&quot;, $conditions_str );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $out .= &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;\r\n&quot;;&nbsp;</div></li><li><div>            $out .= 'if( typeof caldera_conditionals === &quot;undefined&quot; ) { var caldera_conditionals = {}; }';&nbsp;</div></li><li><div>            $out .= &quot;caldera_conditionals.&quot; . $form[ 'ID' ] . '_' . $current_form_count . &quot; = &quot; . $conditions_str . &quot;;\r\n&quot;;&nbsp;</div></li><li><div>            $out .= &quot;&lt;/script&gt;\r\n&quot;;&nbsp;</div></li><li><div>            if ( ! empty( $conditions_templates ) ) {&nbsp;</div></li><li><div>                $out .= implode( &quot;\r\n&quot;, $conditions_templates );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // enqueue conditionls app.&nbsp;</div></li><li><div>            Caldera_Forms_Render_Assets::enqueue_script( 'conditionals' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after form is rendered&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknown&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $config Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_render_end', $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Caldera_Forms_Render_Assets::enqueue_form_assets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter final HTML of form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since unknow&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $out The HTML&nbsp;</div></li><li><div>         * @param array $config Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'caldera_forms_render_form', $out, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the capability to manage Caldera Forms&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * By default, returns &quot;manage_options&quot; can be filtered with &quot;caldera_forms_manage_cap&quot;&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $context Optional. Context for checking capabilities.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_manage_cap( $context = 'admin', $form = false ) {&nbsp;</div></li><li><div>        if ( is_string( $form ) ) {&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Change capability for managing Caldera Forms&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.3.1&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $cap A capability. By default &quot;manage_options&quot;&nbsp;</div></li><li><div>         * @param string $context Context to check in.&nbsp;</div></li><li><div>         * @param array|null $form Form config if it was passed.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'caldera_forms_manage_cap', 'manage_options', $context, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handler for shortcode&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.3.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $atts Array of shortcode attributes&nbsp;</div></li><li><div>     * @param string $content Enclosed content&nbsp;</div></li><li><div>     * @param string $shortcode Shortcode type caldera_form|caldera_forms_modal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shortcode_handler( $atts, $content, $shortcode ) {&nbsp;</div></li><li><div>        if( ! in_array(  $shortcode, array(&nbsp;</div></li><li><div>            'caldera_form', &nbsp;</div></li><li><div>            'caldera_form_modal'&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $atts = shortcode_atts(array (&nbsp;</div></li><li><div>            'id' =&gt; null, &nbsp;</div></li><li><div>            'width' =&gt; null, &nbsp;</div></li><li><div>            'height' =&gt; null, &nbsp;</div></li><li><div>            'type' =&gt; 'link', &nbsp;</div></li><li><div>            'entry' =&gt; null, &nbsp;</div></li><li><div>            'ID' =&gt; null, &nbsp;</div></li><li><div> ), $atts, $shortcode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! empty( $atts[ 'ID' ] ) && empty( $atts[ 'id' ] )) {&nbsp;</div></li><li><div>            $atts[ 'id' ] = $atts[ 'ID' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! isset( $atts[ 'id' ] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $shortcode === 'caldera_form_modal' || ( ! empty( $atts[ 'modal' ] ) && $atts[ 'modal' ] ) ) {&nbsp;</div></li><li><div>            return Caldera_Forms_Render_Modals::modal_form( $atts, $content );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = self::render_form( $atts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Convert time entry was submitted (as MySQL timestamp in UTC) to local display time&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $submitted Timestamp&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function localize_time( $submitted ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = self::time_format();&nbsp;</div></li><li><div>        $time = get_date_from_gmt( $submitted, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $time;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get time format&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function time_format() {&nbsp;</div></li><li><div>        $dateformat = get_option( 'date_format' );&nbsp;</div></li><li><div>        $timeformat = get_option( 'time_format' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = $dateformat . ' ' . $timeformat;&nbsp;</div></li><li><div>        return $format;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Setup auto-population options for Easy Pods and Easy Queries&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.3&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses &quot;caldera_forms_render_start&quot; action&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function easy_pods_queries_setup() {&nbsp;</div></li><li><div>        if ( version_compare( phpversion(), '5.3.0', '&gt;=' ) ) {&nbsp;</div></li><li><div>            if ( function_exists( 'cep_get_easy_pod' ) || defined( 'CAEQ_PATH' ) ) {&nbsp;</div></li><li><div>                $setup = new Caldera_Forms_Render_AutoPopulation();&nbsp;</div></li><li><div>                $setup-&gt;add_hooks();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load the Caldera Forms REST API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.4&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses &quot;rest_api_init&quot; action&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init_rest_api() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::$api = new Caldera_Forms_API_Load( Caldera_Forms_API_Util::api_namespace() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after REST API loader is initialized, but before routes are initialized.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Use this hook to register routes in add-ons&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * do_action( 'caldera_forms_rest_api_pre_init', function( $api ) { $api-&gt;add_route(...&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.4.4&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param Caldera_Forms_API_Load $api API Load class&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_rest_api_pre_init', self::$api );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::$api-&gt;add_route( new Caldera_Forms_API_Tokens() );&nbsp;</div></li><li><div>        self::$api-&gt;add_route( new Caldera_Forms_API_Entries() );&nbsp;</div></li><li><div>        self::$api-&gt;add_route( new Caldera_Forms_API_Forms() );&nbsp;</div></li><li><div>        self::$api-&gt;add_route( new Caldera_Forms_API_Settings() );&nbsp;</div></li><li><div>        self::$api-&gt;init_routes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Runs after Caldera Forms REST API is loaded&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.4.4&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'caldera_forms_rest_api_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function should_send_mail( $form, $transadata = array() ) {&nbsp;</div></li><li><div>        $send = true;&nbsp;</div></li><li><div>        if ( empty( $transadata ) ) {&nbsp;</div></li><li><div>            global $transadata;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $transdata[ 'edit' ] ) ) {&nbsp;</div></li><li><div>            // update&nbsp;</div></li><li><div>            if ( empty( $form[ 'mailer' ][ 'on_update' ] ) ) {&nbsp;</div></li><li><div>                $send = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // insert&nbsp;</div></li><li><div>            if ( empty( $form[ 'mailer' ][ 'enable_mailer' ] ) && empty( $form[ 'mailer' ][ 'on_insert' ] ) ) {&nbsp;</div></li><li><div>                $send = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Change programmed decision to send mailer or not&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Useful for causing emails to send on entry edit, when they normally would not&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.4.4&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $send Whether to send or not&nbsp;</div></li><li><div>         * @param array $form Form config&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'caldera_forms_send_email', $send, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The one true handler for submissions via POST&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Does nonce check and then processes and returns, else 400.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function process_form_via_post() {&nbsp;</div></li><li><div>        if (isset($_POST['_cf_frm_id'])) {&nbsp;</div></li><li><div>            if ( isset( $_POST[ '_cf_verify' ] ) && Caldera_Forms_Render_Nonce::verify_nonce( $_POST[ '_cf_verify' ], $_POST[ '_cf_frm_id' ] ) ) {&nbsp;</div></li><li><div>                $submission = Caldera_Forms::process_submission();&nbsp;</div></li><li><div>                wp_send_json($submission);&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            status_header(400);&nbsp;</div></li><li><div>            $form = Caldera_Forms_Forms::get_form($_POST['_cf_frm_id']);&nbsp;</div></li><li><div>            $notices = array();&nbsp;</div></li><li><div>            $notices['error']['note'] = __('Submission rejected, token invalid', 'caldera-forms');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $note_general_classes = Caldera_Forms_Render_Notices::get_note_general_classes($form);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $note_classes = Caldera_Forms_Render_Notices::get_note_classes($note_general_classes, $form);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $out = array(&nbsp;</div></li><li><div>                'html' =&gt; Caldera_Forms_Render_Notices::html_from_notices($notices, $note_classes), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_error($out);&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Apply wpautop to email message.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This was separated out from main email generation method in 1.4.7 so it would be removable, see: https://github.com/CalderaWP/Caldera-Forms/issues/1048&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.4.7&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses &quot;caldera_forms_mailer&quot; filter&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $mail&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function format_message( $mail ) {&nbsp;</div></li><li><div>        $mail[ 'message' ] = wpautop( $mail[ 'message' ] );&nbsp;</div></li><li><div>        return $mail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.5.0.5</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/caldera-forms/1.5.0.9/classes/caldera_forms/" class="active">1.5.0.9</a></li><li><a href="http://hookr.io/plugins/caldera-forms/1.5.0.8/classes/caldera_forms/" class="">1.5.0.8</a></li><li><a href="http://hookr.io/plugins/caldera-forms/1.5.0.7/classes/caldera_forms/" class="">1.5.0.7</a></li><li><a href="http://hookr.io/plugins/caldera-forms/1.5.0.6/classes/caldera_forms/" class="">1.5.0.6</a></li><li><a href="http://hookr.io/plugins/caldera-forms/1.5.0.5/classes/caldera_forms/" class="">1.5.0.5</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Caldera_Forms</li><li><span></span>Caldera Forms</li><li><span></span>1.5.0.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>