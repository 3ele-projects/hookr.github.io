<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="8.43.0" data-slug="nextgen-facebook-ngfb" data-type="file" data-id="7680"><head xmlns="http://www.w3.org/1999/xhtml"><title> lib-util | file | Nextgen Facebook Ngfb | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, nextgen-facebook-ngfb, 8.43.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3894a7237cf9637cbe7a52d74a0e4794' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/lib-util/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Flib-util%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Flib-util%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-nextgen-facebook-ngfb-8.43.0-file-lib-util","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="lib-util" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to nextgen-facebook-ngfb." href="http://hookr.io/plugins/nextgen-facebook-ngfb/" class="plugin"><span property="name">nextgen-facebook-ngfb</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 8.43.0." href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/" class="H_VERSION"><span property="name">8.43.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">lib-util</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="406"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/all/" title="All">All <span class="count badge">406</span></a></li><li class="" data-id="new" data-count="86"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/new/" title="New">New <span class="count badge">86</span></a></li><li class="" data-id="hooks" data-count="283"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/hooks/" title="Hooks">Hooks <span class="count badge">283</span></a></li><li class="" data-id="action" data-count="12"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/actions/" title="Actions">Actions <span class="count badge">12</span></a></li><li class="" data-id="filter" data-count="271"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/filters/" title="Filters">Filters <span class="count badge">271</span></a></li><li class="" data-id="class" data-count="95"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/classes/" title="Classes">Classes <span class="count badge">95</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="13"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/functions/" title="Functions">Functions <span class="count badge">13</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/nextgen-facebook-ngfb/8.43.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/lib/util.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * License: GPLv3</span>&nbsp;</div></li><li><div><span class="comment"> * License URI: https://www.gnu.org/licenses/gpl.txt</span>&nbsp;</div></li><li><div><span class="comment"> * Copyright 2012-2017 Jean-Sebastien Morisset (https://surniaulula.com/)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) {&nbsp;</div></li><li><div>  die( 'These aren\'t the droids you\'re looking for...' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! class_exists( 'NgfbUtil' ) && class_exists( 'SucomUtil' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  class NgfbUtil extends SucomUtil {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      protected $uniq_urls = array();            <span class="comment">// array to detect duplicate images, etc.</span>&nbsp;</div></li><li><div>      protected $size_labels = array();        <span class="comment">// reference array for image size labels</span>&nbsp;</div></li><li><div>      protected $force_regen = array(&nbsp;</div></li><li><div>          'cache' =&gt; null, <span class="comment">// cache for returned values</span>&nbsp;</div></li><li><div>          'transient' =&gt; null, <span class="comment">// transient array from/to database</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      protected $sanitize_error_msgs = null;        <span class="comment">// translated error messages for sanitize_option_value()</span>&nbsp;</div></li><li><div>      protected $cleared_all_cache = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function __construct( &$plugin ) {&nbsp;</div></li><li><div>          $this-&gt;p =& $plugin;&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'wp', array( &$this, 'add_plugin_image_sizes' ), -100 );    <span class="comment">// runs everytime a posts query is triggered from a url</span>&nbsp;</div></li><li><div>          add_action( 'current_screen', array( &$this, 'add_plugin_image_sizes' ), -100 );&nbsp;</div></li><li><div>          add_action( 'wp_scheduled_delete', array( &$this, 'delete_expired_db_transients' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// the &quot;current_screen&quot; action hook is not called when editing / saving an image</span>&nbsp;</div></li><li><div>          <span class="comment">// hook the &quot;image_editor_save_pre&quot; filter as to add image sizes for that attachment / post</span>&nbsp;</div></li><li><div>          add_filter( 'image_save_pre', array( &$this, 'image_editor_save_pre_image_sizes' ), -100, 2 );    <span class="comment">// filter deprecated in wp 3.5</span>&nbsp;</div></li><li><div>          add_filter( 'image_editor_save_pre', array( &$this, 'image_editor_save_pre_image_sizes' ), -100, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// called from several class __construct() methods to hook their filters</span>&nbsp;</div></li><li><div>      public function add_plugin_filters( $class, $filters, $prio = 10, $lca = '' ) {&nbsp;</div></li><li><div>          $this-&gt;add_plugin_hooks( 'filter', $class, $filters, $prio, $lca );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function add_plugin_actions( $class, $actions, $prio = 10, $lca = '' ) {&nbsp;</div></li><li><div>          $this-&gt;add_plugin_hooks( 'action', $class, $actions, $prio, $lca );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      protected function add_plugin_hooks( $type, $class, $hook_list, $prio, $lca ) {&nbsp;</div></li><li><div>          $lca = $lca === '' ? $this-&gt;p-&gt;cf['lca'] : $lca;    <span class="comment">// default lca is ''</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $hook_list as $name =&gt; $val ) {&nbsp;</div></li><li><div>              if ( ! is_string( $name ) ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( $name.' =&gt; '.$val.' '.$type.' skipped: filter name must be a string' );&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * example:</span>&nbsp;</div></li><li><div><span class="comment">               *     'json_data_https_schema_org_website' =&gt; 5</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if ( is_int( $val ) ) {&nbsp;</div></li><li><div>                  $arg_nums = $val;&nbsp;</div></li><li><div>                  $hook_name = SucomUtil::sanitize_hookname( $lca.'_'.$name );&nbsp;</div></li><li><div>                  $method_name = SucomUtil::sanitize_hookname( $type.'_'.$name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  call_user_func( 'add_'.$type, $hook_name, array( &$class, $method_name ), $prio, $arg_nums );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'added '.$method_name.' (method) '.$type, 3 );&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * example:</span>&nbsp;</div></li><li><div><span class="comment">               *     'add_schema_meta_array' =&gt; '__return_false'</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              } elseif ( is_string( $val ) ) {&nbsp;</div></li><li><div>                  $arg_nums = 1;&nbsp;</div></li><li><div>                  $hook_name = SucomUtil::sanitize_hookname( $lca.'_'.$name );&nbsp;</div></li><li><div>                  $function_name = SucomUtil::sanitize_hookname( $val );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  call_user_func( 'add_'.$type, $hook_name, $function_name, $prio, $arg_nums );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'added '.$function_name.' (function) '.$type, 3 );&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * example:</span>&nbsp;</div></li><li><div><span class="comment">               *     'json_data_https_schema_org_article' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">               *        'json_data_https_schema_org_article' =&gt; 5, </span>&nbsp;</div></li><li><div><span class="comment">               *        'json_data_https_schema_org_newsarticle' =&gt; 5, </span>&nbsp;</div></li><li><div><span class="comment">               *        'json_data_https_schema_org_techarticle' =&gt; 5, </span>&nbsp;</div></li><li><div><span class="comment">               * )</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              } elseif ( is_array( $val ) ) {&nbsp;</div></li><li><div>                  $method_name = SucomUtil::sanitize_hookname( $type.'_'.$name );&nbsp;</div></li><li><div>                  foreach ( $val as $hook_name =&gt; $arg_nums ) {&nbsp;</div></li><li><div>                      $hook_name = SucomUtil::sanitize_hookname( $lca.'_'.$hook_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      call_user_func( 'add_'.$type, $hook_name, array( &$class, $method_name ), $prio, $arg_nums );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'added '.$method_name.' (method) '.$type.' to '.$hook_name, 3 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_image_size_label( $size_name ) {    <span class="comment">// ngfb-opengraph</span>&nbsp;</div></li><li><div>          if ( ! empty( $this-&gt;size_labels[$size_name] ) )&nbsp;</div></li><li><div>              return $this-&gt;size_labels[$size_name];&nbsp;</div></li><li><div>          else return $size_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function image_editor_save_pre_image_sizes( $image, $post_id = false ) {&nbsp;</div></li><li><div>          if ( empty( $post_id ) )&nbsp;</div></li><li><div>              return $image;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mod = $this-&gt;p-&gt;m['util']['post']-&gt;get_mod( $post_id );&nbsp;</div></li><li><div>          $this-&gt;add_plugin_image_sizes( false, array(), $mod, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $image;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// can be called directly and from the &quot;wp&quot; and &quot;current_screen&quot; actions</span>&nbsp;</div></li><li><div>      <span class="comment">// this method does not return a value, so do not use as a filter</span>&nbsp;</div></li><li><div>      public function add_plugin_image_sizes( $wp_obj = false, $sizes = array(), &$mod = false, $filter = true ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Allow various plugin extensions to provide their image names, labels, etc.</span>&nbsp;</div></li><li><div><span class="comment">           * The first dimension array key is the option name prefix by default.</span>&nbsp;</div></li><li><div><span class="comment">           * You can also include the width, height, crop, crop_x, and crop_y values.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           *    Array (</span>&nbsp;</div></li><li><div><span class="comment">           *        [og_img] =&gt; Array (</span>&nbsp;</div></li><li><div><span class="comment">           *            [name] =&gt; opengraph</span>&nbsp;</div></li><li><div><span class="comment">           *            [label] =&gt; Open Graph Image Dimensions</span>&nbsp;</div></li><li><div><span class="comment">           * )</span>&nbsp;</div></li><li><div><span class="comment">           *        [p_img] =&gt; Array (</span>&nbsp;</div></li><li><div><span class="comment">           *            [name] =&gt; richpin</span>&nbsp;</div></li><li><div><span class="comment">           *            [label] =&gt; Rich Pin Image Dimensions</span>&nbsp;</div></li><li><div><span class="comment">           * ) </span>&nbsp;</div></li><li><div><span class="comment">           * )</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark( 'define image sizes' );    <span class="comment">// begin timer</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $use_post = false;&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $aop = $this-&gt;p-&gt;check-&gt;aop( $lca, true, $this-&gt;p-&gt;avail['*']['p_dir'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod is preferred but not required</span></span></span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'optional call to get_page_mod()' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mod = $this-&gt;get_page_mod( $use_post, $mod, $wp_obj );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $md_opts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $filter === true ) {&nbsp;</div></li><li><div>              $sizes = apply_filters( $this-&gt;p-&gt;cf['lca'].'_plugin_image_sizes', &nbsp;</div></li><li><div>                  $sizes, $mod, SucomUtil::get_crawler_name() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $mod['id'] ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'module id is unknown' );&nbsp;</div></li><li><div>          } elseif ( empty( $mod['name'] ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'module name is unknown' );&nbsp;</div></li><li><div>          <span class="comment">// custom filters may use image sizes, so don't filter/cache the meta options</span>&nbsp;</div></li><li><div>          } elseif ( ! empty( $mod['id'] ) && ! empty( $mod['obj'] ) && $aop ) {&nbsp;</div></li><li><div>              <span class="comment">// returns an empty string if no meta found</span>&nbsp;</div></li><li><div>              $md_opts = $mod['obj']-&gt;get_options( $mod['id'], false, false );    <span class="comment">// $filter_opts = false</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( $sizes as $opt_prefix =&gt; $size_info ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! is_array( $size_info ) ) {&nbsp;</div></li><li><div>                  $save_name = empty( $size_info ) ? &nbsp;</div></li><li><div>                      $opt_prefix : $size_info;&nbsp;</div></li><li><div>                  $size_info = array( &nbsp;</div></li><li><div>                      'name' =&gt; $save_name, &nbsp;</div></li><li><div>                      'label' =&gt; $save_name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              } elseif ( ! empty( $size_info['prefix'] ) )                <span class="comment">// allow for alternate option prefix</span>&nbsp;</div></li><li><div>                  $opt_prefix = $size_info['prefix'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( array( 'width', 'height', 'crop', 'crop_x', 'crop_y' ) as $key ) {&nbsp;</div></li><li><div>                  if ( isset( $size_info[$key] ) )                <span class="comment">// prefer existing info from filters</span>&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  elseif ( isset( $md_opts[$opt_prefix.'_'.$key] ) )        <span class="comment">// use post meta if available</span>&nbsp;</div></li><li><div>                      $size_info[$key] = $md_opts[$opt_prefix.'_'.$key];&nbsp;</div></li><li><div>                  elseif ( isset( $this-&gt;p-&gt;options[$opt_prefix.'_'.$key] ) )    <span class="comment">// current plugin settings</span>&nbsp;</div></li><li><div>                      $size_info[$key] = $this-&gt;p-&gt;options[$opt_prefix.'_'.$key];&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>                      if ( ! isset( $def_opts ) ) {                <span class="comment">// only read once if necessary</span>&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'getting default option values' );&nbsp;</div></li><li><div>                          $def_opts = $this-&gt;p-&gt;opt-&gt;get_defaults();&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $size_info[$key] = $def_opts[$opt_prefix.'_'.$key];    <span class="comment">// fallback to default value</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ( $key === 'crop' )                        <span class="comment">// make sure crop is true or false</span>&nbsp;</div></li><li><div>                      $size_info[$key] = empty( $size_info[$key] ) ?&nbsp;</div></li><li><div>                          false : true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $size_info['width'] &gt; 0 && $size_info['height'] &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// preserve compatibility with older wordpress versions, use true or false when possible</span>&nbsp;</div></li><li><div>                  if ( $size_info['crop'] === true && &nbsp;</div></li><li><div>                      ( $size_info['crop_x'] !== 'center' || $size_info['crop_y'] !== 'center' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      global $wp_version;&nbsp;</div></li><li><div>                      if ( version_compare( $wp_version, 3.9, '&gt;=' ) ) {&nbsp;</div></li><li><div>                          $size_info['crop'] = array( $size_info['crop_x'], $size_info['crop_y'] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// allow custom function hooks to make changes</span>&nbsp;</div></li><li><div>                  if ( $filter === true )&nbsp;</div></li><li><div>                      $size_info = apply_filters( $this-&gt;p-&gt;cf['lca'].'_size_info_'.$size_info['name'], &nbsp;</div></li><li><div>                          $size_info, $mod['id'], $mod['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// a lookup array for image size labels, used in image size error messages</span>&nbsp;</div></li><li><div>                  $this-&gt;size_labels[$this-&gt;p-&gt;cf['lca'].'-'.$size_info['name']] = $size_info['label'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  add_image_size( $this-&gt;p-&gt;cf['lca'].'-'.$size_info['name'], &nbsp;</div></li><li><div>                      $size_info['width'], $size_info['height'], $size_info['crop'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'image size '.$this-&gt;p-&gt;cf['lca'].'-'.$size_info['name'].' '.&nbsp;</div></li><li><div>                          $size_info['width'].'x'.$size_info['height'].&nbsp;</div></li><li><div>                          ( empty( $size_info['crop'] ) ? '' : ' crop '.&nbsp;</div></li><li><div>                              $size_info['crop_x'].'/'.$size_info['crop_y'] ).' added' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark( 'define image sizes' );    <span class="comment">// end timer</span>&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log_arr( 'get_all_image_sizes', SucomUtil::get_image_sizes() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function set_force_regen( $mod, $md_pre = 'og', $value = true ) {&nbsp;</div></li><li><div>          $regen_key = $this-&gt;get_force_regen_key( $mod, $md_pre );&nbsp;</div></li><li><div>          if ( $regen_key !== false ) {&nbsp;</div></li><li><div>              $cache_salt = __CLASS__.'::force_regen_transient';&nbsp;</div></li><li><div>              $cache_id = $this-&gt;p-&gt;cf['lca'].'_'.md5( $cache_salt );&nbsp;</div></li><li><div>              if ( $this-&gt;force_regen['transient'] === null ) {&nbsp;</div></li><li><div>                  $this-&gt;force_regen['transient'] = get_transient( $cache_id );    <span class="comment"><span class="comment">// load transient if required</span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $this-&gt;force_regen['transient'] === false ) {    <span class="comment"><span class="comment">// no transient in database</span></span>&nbsp;</div></li><li><div>                  $this-&gt;force_regen['transient'] = array();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;force_regen['transient'][$regen_key] = $value;&nbsp;</div></li><li><div>              set_transient( $cache_id, $this-&gt;force_regen['transient'], 0 );    <span class="comment"><span class="comment">// never expire</span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function is_force_regen( $mod, $md_pre = 'og' ) {&nbsp;</div></li><li><div>          $regen_key = $this-&gt;get_force_regen_key( $mod, $md_pre );&nbsp;</div></li><li><div>          if ( $regen_key !== false ) {&nbsp;</div></li><li><div>              $cache_salt = __CLASS__.'::force_regen_transient';&nbsp;</div></li><li><div>              $cache_id = $this-&gt;p-&gt;cf['lca'].'_'.md5( $cache_salt );&nbsp;</div></li><li><div>              if ( $this-&gt;force_regen['transient'] === null ) {&nbsp;</div></li><li><div>                  $this-&gt;force_regen['transient'] = get_transient( $cache_id );    <span class="comment"><span class="comment">// load transient if required</span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $this-&gt;force_regen['transient'] === false ) {    <span class="comment"><span class="comment">// no transient in database</span></span>&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( isset( $this-&gt;force_regen['cache'][$regen_key] ) )    { <span class="comment">// previously returned value</span>&nbsp;</div></li><li><div>                  return $this-&gt;force_regen['cache'][$regen_key];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( isset( $this-&gt;force_regen['transient'][$regen_key] ) ) {&nbsp;</div></li><li><div>                  $this-&gt;force_regen['cache'][$regen_key] = $this-&gt;force_regen['transient'][$regen_key];    <span class="comment">// save value</span>&nbsp;</div></li><li><div>                  unset( $this-&gt;force_regen['transient'][$regen_key] );    <span class="comment">// unset the regen key and save transient</span>&nbsp;</div></li><li><div>                  if ( empty( $this-&gt;force_regen['transient'] ) ) {&nbsp;</div></li><li><div>                      delete_transient( $cache_id );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      set_transient( $cache_id, $this-&gt;force_regen['transient'], 0 );    <span class="comment"><span class="comment">// never expire</span></span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return $this-&gt;force_regen['cache'][$regen_key];    <span class="comment">// return the cached value</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return false;    <span class="comment">// not in the cache or transient array</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get the force regen transient id for set and get methods</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>      public function get_force_regen_key( $mod, $md_pre ) {&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_numeric( $mod ) && $mod &gt; 0 )    <span class="comment">// optimize by skipping get_page_mod()</span>&nbsp;</div></li><li><div>              return 'post_'.$mod.'_regen_'.$md_pre;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod is preferred but not required</span></span></span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'optional call to get_page_mod()' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mod = $this-&gt;get_page_mod( $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $mod['name'] ) && ! empty( $mod['id'] ) )&nbsp;</div></li><li><div>              return $mod['name'].'_'.$mod['id'].'_regen_'.$md_pre;&nbsp;</div></li><li><div>          else return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function add_ptns_to_opts( &$opts = array(), $mixed, $default = 1 ) {&nbsp;</div></li><li><div>          if ( ! is_array( $mixed ) ) {&nbsp;</div></li><li><div>              $mixed = array( $mixed =&gt; $default );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ( $mixed as $opt_pre =&gt; $def_val ) {&nbsp;</div></li><li><div>              foreach ( $this-&gt;get_post_types() as $post_type ) {&nbsp;</div></li><li><div>                  $key = $opt_pre.'_'.$post_type-&gt;name;&nbsp;</div></li><li><div>                  if ( ! isset( $opts[$key] ) ) {&nbsp;</div></li><li><div>                      $opts[$key] = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $opts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $output = objects | names</span>&nbsp;</div></li><li><div>      public function get_post_types( $output = 'objects' ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return apply_filters( $this-&gt;p-&gt;cf['lca'].'_post_types', &nbsp;</div></li><li><div>              get_post_types( array( 'public' =&gt; true ), $output ), $output );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function clear_all_cache( $clear_ext = true, $dis_key = false, $dis_time = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;cleared_all_cache ) {    <span class="comment">// already run once</span>&nbsp;</div></li><li><div>              return 0;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;cleared_all_cache = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_cache_flush();    <span class="comment">// clear non-database transients as well</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;delete_expired_db_transients( true );&nbsp;</div></li><li><div>          $this-&gt;delete_all_cache_files();&nbsp;</div></li><li><div>          $this-&gt;delete_all_column_meta();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $short = $this-&gt;p-&gt;cf['plugin'][$lca]['short'];&nbsp;</div></li><li><div>          $clear_all_msg = sprintf( __( '%s cached files, transient cache, sortable column meta, and the WordPress object cache have all been cleared.', &nbsp;</div></li><li><div>              'nextgen-facebook' ), $short );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $clear_ext ) {&nbsp;</div></li><li><div>              $ext_cache_msg = __( 'The cache for %s has also been cleared.', 'nextgen-facebook' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( function_exists( 'w3tc_pgcache_flush' ) ) {    <span class="comment">// w3 total cache</span>&nbsp;</div></li><li><div>                  w3tc_pgcache_flush();&nbsp;</div></li><li><div>                  w3tc_objectcache_flush();&nbsp;</div></li><li><div>                  $clear_all_msg .= ' '.sprintf( $ext_cache_msg, 'W3 Total Cache' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( function_exists( 'wp_cache_clear_cache' ) ) {    <span class="comment">// wp super cache</span>&nbsp;</div></li><li><div>                  wp_cache_clear_cache();&nbsp;</div></li><li><div>                  $clear_all_msg .= ' '.sprintf( $ext_cache_msg, 'WP Super Cache' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $GLOBALS['comet_cache'] ) ) {        <span class="comment">// comet cache</span>&nbsp;</div></li><li><div>                  $GLOBALS['comet_cache']-&gt;wipe_cache();&nbsp;</div></li><li><div>                  $clear_all_msg .= ' '.sprintf( $ext_cache_msg, 'Comet Cache' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif ( isset( $GLOBALS['zencache'] ) ) {        <span class="comment">// zencache</span>&nbsp;</div></li><li><div>                  $GLOBALS['zencache']-&gt;wipe_cache();&nbsp;</div></li><li><div>                  $clear_all_msg .= ' '.sprintf( $ext_cache_msg, 'ZenCache' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $clear_all_msg .= ' '.__( 'Site performance may be impacted slightly while all cache objects are rebuilt.', 'nextgen-facebook' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;p-&gt;notice-&gt;inf( $clear_all_msg, true, $dis_key, $dis_time );    <span class="comment">// can be dismissed depending on args</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function clear_cache_objects( array $transients, array $wp_objects ) {&nbsp;</div></li><li><div>          $deleted = 0;&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          foreach ( $transients as $group =&gt; $arr ) {&nbsp;</div></li><li><div>              foreach ( $arr as $val ) {&nbsp;</div></li><li><div>                  if ( ! empty( $val ) ) {&nbsp;</div></li><li><div>                      $cache_salt = $group.'('.$val.')';&nbsp;</div></li><li><div>                      $cache_id = $lca.'_'.md5( $cache_salt );&nbsp;</div></li><li><div>                      if ( delete_transient( $cache_id ) ) {&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'cleared cache transient '.$cache_salt );&nbsp;</div></li><li><div>                          $deleted++;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ( $wp_objects as $group =&gt; $arr ) {&nbsp;</div></li><li><div>              foreach ( $arr as $val ) {&nbsp;</div></li><li><div>                  if ( ! empty( $val ) ) {&nbsp;</div></li><li><div>                      $cache_salt = $group.'('.$val.')';&nbsp;</div></li><li><div>                      $cache_id = $lca.'_'.md5( $cache_salt );&nbsp;</div></li><li><div>                      if ( wp_cache_delete( $cache_id, $group ) ) {&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'cleared cache object '.$cache_salt );&nbsp;</div></li><li><div>                          $deleted++;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $deleted;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function delete_expired_db_transients( $all = false ) { &nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $current_time = isset ( $_SERVER['REQUEST_TIME'] ) ?&nbsp;</div></li><li><div>              (int) $_SERVER['REQUEST_TIME'] : time() ; &nbsp;</div></li><li><div>          if ( $all ) {&nbsp;</div></li><li><div>              $prefix = '_transient_';    <span class="comment">// clear all transients, even if no timeout value</span>&nbsp;</div></li><li><div>              $dbquery = 'SELECT option_name FROM '.$wpdb-&gt;options.&nbsp;</div></li><li><div>                  ' WHERE option_name LIKE \''.$prefix.$lca.'_%\';';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $prefix = '_transient_timeout_';&nbsp;</div></li><li><div>              $dbquery = 'SELECT option_name FROM '.$wpdb-&gt;options.&nbsp;</div></li><li><div>                  ' WHERE option_name LIKE \''.$prefix.$lca.'_%\''.&nbsp;</div></li><li><div>                  ' AND option_value &lt; '.$current_time.';';    <span class="comment">// expiration time older than current time</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $expired = $wpdb-&gt;get_col( $dbquery ); &nbsp;</div></li><li><div>          $deleted = 0;&nbsp;</div></li><li><div>          foreach( $expired as $option_name ) { &nbsp;</div></li><li><div>              $transient_name = str_replace( $prefix, '', $option_name );&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * If clearing all transients, skip the shortened URL transients </span>&nbsp;</div></li><li><div><span class="comment">               * unless the &quot;Clear Short URLs on Clear All Cache&quot; option is checked.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if ( $all ) {&nbsp;</div></li><li><div>                  if ( empty( $this-&gt;p-&gt;cf['plugin_clear_short_urls'] ) && &nbsp;</div></li><li><div>                      strpos( $transient_name, $lca.'_sh' ) === 0 )&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( delete_transient( $transient_name ) )&nbsp;</div></li><li><div>                  $deleted++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $deleted;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function delete_all_cache_files() {&nbsp;</div></li><li><div>          $uca = strtoupper( $this-&gt;p-&gt;cf['lca'] );&nbsp;</div></li><li><div>          $cache_dir = constant( $uca.'_CACHEDIR' );&nbsp;</div></li><li><div>          $deleted = 0;&nbsp;</div></li><li><div>          if ( ! $dh = @opendir( $cache_dir ) ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'Failed to open directory %s for reading.', &nbsp;</div></li><li><div>                  'nextgen-facebook' ), $cache_dir ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              while ( $file_name = @readdir( $dh ) ) {&nbsp;</div></li><li><div>                  $cache_file = $cache_dir.$file_name;&nbsp;</div></li><li><div>                  if ( ! preg_match( '/^(\..*|index\.php)$/', $file_name ) && is_file( $cache_file ) ) {&nbsp;</div></li><li><div>                      if ( @unlink( $cache_file ) ) {&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'removed cache file '.$cache_file );&nbsp;</div></li><li><div>                          $deleted++;&nbsp;</div></li><li><div>                      } else {    &nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'error removing cache file '.$cache_file );&nbsp;</div></li><li><div>                          if ( is_admin() )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'Error removing cache file %s.', &nbsp;</div></li><li><div>                                  'nextgen-facebook' ), $cache_file ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              closedir( $dh );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $deleted;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function delete_all_column_meta() {&nbsp;</div></li><li><div>          $col_meta_keys = NgfbMeta::get_column_meta_keys();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $col_meta_keys as $col_idx =&gt; $meta_key ) {&nbsp;</div></li><li><div>              delete_post_meta_by_key( $meta_key );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( get_users() as $user ) {&nbsp;</div></li><li><div>              foreach ( $col_meta_keys as $col_idx =&gt; $meta_key ) {&nbsp;</div></li><li><div>                  delete_user_meta( $user-&gt;ID, $meta_key );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( NgfbTerm::get_public_terms() as $term_id ) {&nbsp;</div></li><li><div>              foreach ( $col_meta_keys as $col_idx =&gt; $meta_key ) {&nbsp;</div></li><li><div>                  NgfbTerm::delete_term_meta( $term_id, $meta_key );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_article_topics() {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $cache_salt = __METHOD__.'('.NGFB_TOPICS_LIST.')';&nbsp;</div></li><li><div>          $cache_id = $lca.'_'.md5( $cache_salt );&nbsp;</div></li><li><div>          $cache_exp = (int) apply_filters( $lca.'_cache_expire_article_topics', &nbsp;</div></li><li><div>              $this-&gt;p-&gt;options['plugin_topics_cache_exp'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'transient cache salt '.$cache_salt );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $cache_exp &gt; 0 ) {&nbsp;</div></li><li><div>              $topics = get_transient( $cache_id );&nbsp;</div></li><li><div>              if ( is_array( $topics ) ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'article topics retrieved from transient '.$cache_id );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return $topics;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ( $topics = file( NGFB_TOPICS_LIST, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES ) ) === false ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'error reading %s article topic list file' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( is_admin() ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'Error reading %s article topic list file.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), NGFB_TOPICS_LIST ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $topics;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $topics = apply_filters( $lca.'_article_topics', $topics );&nbsp;</div></li><li><div>          natsort( $topics );&nbsp;</div></li><li><div>          $topics = array_merge( array( 'none' ), $topics );    <span class="comment">// after sorting the array, put 'none' first</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $cache_exp &gt; 0 ) {&nbsp;</div></li><li><div>              set_transient( $cache_id, $topics, $cache_exp );&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'article topics saved to transient '.&nbsp;</div></li><li><div>                      $cache_id.' ('.$cache_exp.' seconds)');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $topics;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function sanitize_option_value( $key, $val, $def_val, $network = false, &$mod = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array( $val ) ) {    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>              return $val;    <span class="comment"><span class="comment"><span class="comment">// stop here</span></span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// remove multiples, localization, and status for more generic match</span>&nbsp;</div></li><li><div>          $option_key = preg_replace( '/(_[0-9]+)?(#.*|:[0-9]+)?$/', '', $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// hooked by several extensions</span>&nbsp;</div></li><li><div>          $option_type = apply_filters( $this-&gt;p-&gt;cf['lca'].'_option_type', &nbsp;</div></li><li><div>              false, $option_key, $network, $mod );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// translate error messages only once</span>&nbsp;</div></li><li><div>          if ( $this-&gt;sanitize_error_msgs === null ) {&nbsp;</div></li><li><div>              $this-&gt;sanitize_error_msgs = array(&nbsp;</div></li><li><div>                  'url' =&gt; __( 'The value of option \'%s\' must be a URL - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'csv_urls' =&gt; __( 'The value of option \'%s\' must be a comma-delimited list of URL(s) - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'numeric' =&gt; __( 'The value of option \'%s\' must be numeric - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'pos_num' =&gt; __( 'The value of option \'%1$s\' must be equal to or greather than %2$s - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'blank_num' =&gt; __( 'The value of option \'%s\' must be blank or numeric - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'api_key' =&gt; __( 'The value of option \'%s\' must be alpha-numeric - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'color' =&gt; __( 'The value of option \'%s\' must be a CSS color code - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'date' =&gt; __( 'The value of option \'%s\' must be a yyyy-mm-dd date - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'time' =&gt; __( 'The value of option \'%s\' must be a hh:mm time - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'html' =&gt; __( 'The value of option \'%s\' must be HTML code - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div>                  'not_blank' =&gt; __( 'The value of option \'%s\' cannot be an empty string - resetting option to default value.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// pre-filter most values to remove html</span>&nbsp;</div></li><li><div>          switch ( $option_type ) {&nbsp;</div></li><li><div>              case 'ignore':&nbsp;</div></li><li><div>                  return $val;    <span class="comment"><span class="comment"><span class="comment">// stop here</span></span></span>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'html':        <span class="comment">// leave html, css, and javascript code blocks as-is</span>&nbsp;</div></li><li><div>              case 'code':&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $val = wp_filter_nohtml_kses( $val );    <span class="comment">// strips all the HTML in the content</span>&nbsp;</div></li><li><div>                  $val = stripslashes( $val );    <span class="comment">// strip slashes added by wp_filter_nohtml_kses()</span>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// optional cast on return</span>&nbsp;</div></li><li><div>          $cast_int = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $option_type ) {&nbsp;</div></li><li><div>              <span class="comment">// must be empty or texturized </span>&nbsp;</div></li><li><div>              case 'textured':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = trim( wptexturize( ' '.$val.' ' ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// must be empty or a url</span>&nbsp;</div></li><li><div>              case 'url':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      if ( filter_var( $val, FILTER_VALIDATE_URL ) === false ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs[$option_type], $key ) );&nbsp;</div></li><li><div>                          $val = $def_val;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// strip leading urls off facebook usernames</span>&nbsp;</div></li><li><div>              case 'url_base':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = preg_replace( '/(http|https):\/\/[^\/]*?\<span class="comment">//', '', $val );</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'csv_blank':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = implode( ', ', SucomUtil::explode_csv( $val ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'csv_urls':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $parts = array();&nbsp;</div></li><li><div>                      foreach ( SucomUtil::explode_csv( $val ) as $part ) {&nbsp;</div></li><li><div>                          if ( filter_var( $part, FILTER_VALIDATE_URL ) === false ) {&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs[$option_type], $key ) );&nbsp;</div></li><li><div>                              $val = $def_val;&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          } else $parts[] = $part;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $val = implode( ', ', $parts );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// twitter-style usernames (prepend with an @ character)</span>&nbsp;</div></li><li><div>              case 'at_name':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = SucomUtil::get_at_name( $val );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// must be integer / numeric</span>&nbsp;</div></li><li><div>              case 'integer':&nbsp;</div></li><li><div>                  $cast_int = true;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// no break</span></span></span>&nbsp;</div></li><li><div>              case 'numeric':&nbsp;</div></li><li><div>                  if ( ! is_numeric( $val ) ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs['numeric'], $key ) );&nbsp;</div></li><li><div>                      $val = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// integer / numeric options that must be 1 or more (not zero)</span>&nbsp;</div></li><li><div>              case 'pos_int':&nbsp;</div></li><li><div>              case 'img_width':    <span class="comment"><span class="comment">// image height, subject to minimum value (typically, at least 200px)</span></span>&nbsp;</div></li><li><div>              case 'img_height':    <span class="comment"><span class="comment">// image height, subject to minimum value (typically, at least 200px)</span></span>&nbsp;</div></li><li><div>                  $cast_int = true;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// no break</span></span></span>&nbsp;</div></li><li><div>              case 'pos_num':&nbsp;</div></li><li><div>                  if ( $option_type === 'img_width' ) {&nbsp;</div></li><li><div>                      $min_int = $this-&gt;p-&gt;cf['head']['limit_min']['og_img_width'];&nbsp;</div></li><li><div>                  } elseif ( $option_type === 'img_height' ) {&nbsp;</div></li><li><div>                      $min_int = $this-&gt;p-&gt;cf['head']['limit_min']['og_img_height'];&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $min_int = 1;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ( ! empty( $mod['name'] ) && $val === '' ) {    <span class="comment">// custom meta options can be empty</span>&nbsp;</div></li><li><div>                      $cast_int = false;&nbsp;</div></li><li><div>                  } elseif ( ! is_numeric( $val ) || $val &lt; $min_int ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs['pos_num'], $key, $min_int ) );&nbsp;</div></li><li><div>                      $val = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// must be blank or integer / numeric</span>&nbsp;</div></li><li><div>              case 'blank_int':&nbsp;</div></li><li><div>                  $cast_int = true;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// no break</span></span></span>&nbsp;</div></li><li><div>              case 'blank_num':&nbsp;</div></li><li><div>                  if ( $val === '' ) {&nbsp;</div></li><li><div>                      $cast_int = false;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ( ! is_numeric( $val ) ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs['blank_num'], $key ) );&nbsp;</div></li><li><div>                          $val = $def_val;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// empty or alpha-numeric uppercase (hyphens are allowed as well)</span>&nbsp;</div></li><li><div>              case 'auth_id':&nbsp;</div></li><li><div>                  <span class="comment">// silently convert illegal characters to single hyphens and trim excess</span>&nbsp;</div></li><li><div>                  $val = trim( preg_replace( '/[^A-Z0-9\-]+/', '-', $val ), '-' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// empty or alpha-numeric (upper or lower case), plus underscores</span>&nbsp;</div></li><li><div>              case 'api_key':&nbsp;</div></li><li><div>                  $val = trim( $val );&nbsp;</div></li><li><div>                  if ( $val !== '' && preg_match( '/[^a-zA-Z0-9_]/', $val ) ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs[$option_type], $key ) );&nbsp;</div></li><li><div>                      $val = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'color':&nbsp;</div></li><li><div>              case 'date':&nbsp;</div></li><li><div>              case 'time':&nbsp;</div></li><li><div>                  $val = trim( $val );&nbsp;</div></li><li><div>                  if ( $option_type === 'color' ) {&nbsp;</div></li><li><div>                      $fmt = '/^#[a-fA-f0-9]{6, 6}$/';    <span class="comment">// color #000000</span>&nbsp;</div></li><li><div>                  } elseif ( $option_type === 'date' ) {&nbsp;</div></li><li><div>                      $fmt = '/^[0-9]{4, 4}-[0-9]{2, 2}-[0-9]{2, 2}$/';    <span class="comment">// date yyyy-mm-dd</span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $fmt = '/^[0-9]{2, 2}:[0-9]{2, 2}$/';    <span class="comment">// time hh:mm</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ( $val !== '' && ! preg_match( $fmt, $val ) ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs[$option_type], $key ) );&nbsp;</div></li><li><div>                      $val = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// text strings that can be blank</span>&nbsp;</div></li><li><div>              case 'ok_blank':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = trim( $val );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// text strings that can be blank</span> (line breaks are removed)&nbsp;</div></li><li><div>              case 'desc':&nbsp;</div></li><li><div>              case 'one_line':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = trim( preg_replace( '/[\s\n\r]+/s', ' ', $val ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// empty string or must include at least one HTML tag</span>&nbsp;</div></li><li><div>              case 'html':&nbsp;</div></li><li><div>                  if ( $val !== '' ) {&nbsp;</div></li><li><div>                      $val = trim( $val );&nbsp;</div></li><li><div>                      if ( ! preg_match( '/&lt;.*&gt;/', $val ) ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs['html'], $key ) );&nbsp;</div></li><li><div>                          $val = $def_val;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// options that cannot be blank (aka empty string)</span>&nbsp;</div></li><li><div>              case 'code':&nbsp;</div></li><li><div>              case 'not_blank':&nbsp;</div></li><li><div>                  if ( $val === '' ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( $this-&gt;sanitize_error_msgs['not_blank'], $key ) );&nbsp;</div></li><li><div>                      $val = $def_val;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// everything else is a 1 or 0 checkbox option </span>&nbsp;</div></li><li><div>              case 'checkbox':&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  if ( $def_val === 0 || $def_val === 1 ) {    <span class="comment">// make sure the default option is also a 1 or 0, just in case</span>&nbsp;</div></li><li><div>                      $val = empty( $val ) ? 0 : 1;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $cast_int ) {&nbsp;</div></li><li><div>              return (int) $val;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $val;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// query examples:</span>&nbsp;</div></li><li><div>      <span class="comment">//    /html/head/link|/html/head/meta</span>&nbsp;</div></li><li><div>      <span class="comment">//    /html/head/meta[starts-with(@property, 'og:video:')]</span>&nbsp;</div></li><li><div>      public function get_head_meta( $request, $query = '/html/head/meta', $remove_self = false ) {&nbsp;</div></li><li><div>          if ( empty( $query ) )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $request, '&lt;' ) === 0 ) {    <span class="comment"><span class="comment">// check for HTML content</span></span>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'using html submitted in the request argument' );&nbsp;</div></li><li><div>              $html = $request;&nbsp;</div></li><li><div>          } elseif ( strpos( $request, ':<span class="comment"><span class="comment"><span class="comment">//' ) === false )</span> {</span></span>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: request argument is not html or valid url' );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          <span class="comment">// fetch the webpage content and save it as a transient</span>&nbsp;</div></li><li><div>          } elseif ( ( $html = $this-&gt;p-&gt;cache-&gt;get( $request, 'raw', 'transient' ) ) === false ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: error caching '.$request );&nbsp;</div></li><li><div>              if ( is_admin() )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'Error retrieving webpage from &lt;a href=&quot;%1$s&quot;&gt;%1$s&lt;/a&gt;.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), $request ) );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } elseif ( empty( $html ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: html for '.$request.' is empty' );&nbsp;</div></li><li><div>              if ( is_admin() )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'Webpage retrieved from &lt;a href=&quot;%1$s&quot;&gt;%1$s&lt;/a&gt; is empty.', &nbsp;</div></li><li><div>                      'nextgen-facebook' ), $request ) );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ret = array();&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $html = mb_convert_encoding( $html, 'HTML-ENTITIES', 'UTF-8' );    <span class="comment">// convert to UTF8</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $remove_self && strpos( $html, $lca.' meta tags begin' ) !== false ) {    <span class="comment">// quick check</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'removing self meta tags' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $mark_prefix = '&lt;(!--[\s\n\r]+|meta[\s\n\r]+name=&quot;'.$lca.':mark:(begin|end)&quot;[\s\n\r]+content=&quot;)';&nbsp;</div></li><li><div>              $mark_suffix = '([\s\n\r]+--|&quot;[\s\n\r]*\/?)&gt;';    <span class="comment">// space and slash are optional for html optimizers</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $html = preg_replace( '/'.$mark_prefix.$lca.' meta tags begin'.$mark_suffix.'.*'.&nbsp;</div></li><li><div>                  $mark_prefix.$lca.' meta tags end'.$mark_suffix.'/ums', <span class="comment">// enable utf8 functionality</span>&nbsp;</div></li><li><div>                      '&lt;!-- '.$lca.' meta tags removed --&gt;', $html, -1, $count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $count ) {&nbsp;</div></li><li><div>                  if ( is_admin() ) {&nbsp;</div></li><li><div>                      $short = $this-&gt;p-&gt;cf['plugin'][$lca]['short'];&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'The PHP preg_replace() function failed to remove the %1$s meta tag block &mdash; this could be an indication of a problem with PHP\'s PCRE library or an HTML filter corrupting the %1$s meta tags.', 'nextgen-facebook' ), $short ) );&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( class_exists( 'DOMDocument' ) ) {&nbsp;</div></li><li><div>              $doc = new DOMDocument();        <span class="comment">// since PHP v4.1</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( function_exists( 'libxml_use_internal_errors' ) ) {    <span class="comment">// since PHP v5.1</span>&nbsp;</div></li><li><div>                  $libxml_saved_state = libxml_use_internal_errors( true );&nbsp;</div></li><li><div>                  $doc-&gt;loadHTML( $html );&nbsp;</div></li><li><div>                  libxml_clear_errors();        <span class="comment">// clear any HTML parsing errors</span>&nbsp;</div></li><li><div>                  libxml_use_internal_errors( $libxml_saved_state );&nbsp;</div></li><li><div>              } else @$doc-&gt;loadHTML( $html );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $xpath = new DOMXPath( $doc );&nbsp;</div></li><li><div>              $metas = $xpath-&gt;query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $metas as $m ) {&nbsp;</div></li><li><div>                  $m_atts = array();        <span class="comment">// put all attributes in a single array</span>&nbsp;</div></li><li><div>                  foreach ( $m-&gt;attributes as $a )&nbsp;</div></li><li><div>                      $m_atts[$a-&gt;name] = $a-&gt;value;&nbsp;</div></li><li><div>                  if ( isset( $m-&gt;textContent ) )&nbsp;</div></li><li><div>                      $m_atts['textContent'] = $m-&gt;textContent;&nbsp;</div></li><li><div>                  $ret[$m-&gt;tagName][] = $m_atts;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else $this-&gt;missing_php_class_error( 'DOMDocument' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return empty( $ret ) ? false : $ret;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function missing_php_class_error( $classname ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( $classname.' PHP class is missing' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( is_admin() ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;notice-&gt;err( sprintf( __( 'The %1$s PHP class is missing - please contact your hosting provider to install the missing %1$s PHP class.', &nbsp;</div></li><li><div>                  'nextgen-facebook' ), $classname ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_body_html( $request, $remove_script = true ) {&nbsp;</div></li><li><div>          $html = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $request, '<span class="comment"><span class="comment"><span class="comment">//' ) === 0 )</span></span></span>&nbsp;</div></li><li><div>              $request = self::get_prot().':'.$request;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $request, '&lt;' ) === 0 ) {    <span class="comment"><span class="comment">// check for HTML content</span></span>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'using html submitted in the request argument' );&nbsp;</div></li><li><div>              $html = $request;&nbsp;</div></li><li><div>          } elseif ( empty( $request ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: request argument is empty' );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } elseif ( strpos( $request, 'data:' ) === 0 ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: request argument is inline data' );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } elseif ( strpos( $request, ':<span class="comment"><span class="comment"><span class="comment">//' ) === false )</span> {</span></span>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: request argument is not html or valid url' );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'fetching body html for '.$request );&nbsp;</div></li><li><div>              if ( ( $html = $this-&gt;p-&gt;cache-&gt;get( $request, 'raw', 'transient' ) ) === false ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'exiting early: error caching '.$request );&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $html = preg_replace( '/^.*&lt;body[^&gt;]*&gt;(.*)&lt;\/body&gt;.*$/Ums', '$1', $html );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $remove_script )&nbsp;</div></li><li><div>              $html = preg_replace( '/&lt;script[^&gt;]*&gt;.*&lt;\/script&gt;/Ums', '', $html );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $html;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function log_is_functions() {&nbsp;</div></li><li><div>          $is_functions = array( &nbsp;</div></li><li><div>              'is_ajax', &nbsp;</div></li><li><div>              'is_archive', &nbsp;</div></li><li><div>              'is_attachment', &nbsp;</div></li><li><div>              'is_author', &nbsp;</div></li><li><div>              'is_category', &nbsp;</div></li><li><div>              'is_front_page', &nbsp;</div></li><li><div>              'is_home', &nbsp;</div></li><li><div>              'is_multisite', &nbsp;</div></li><li><div>              'is_page', &nbsp;</div></li><li><div>              'is_search', &nbsp;</div></li><li><div>              'is_single', &nbsp;</div></li><li><div>              'is_singular', &nbsp;</div></li><li><div>              'is_ssl', &nbsp;</div></li><li><div>              'is_tag', &nbsp;</div></li><li><div>              'is_tax', &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * common e-commerce / woocommerce functions</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              'is_account_page', &nbsp;</div></li><li><div>              'is_cart', &nbsp;</div></li><li><div>              'is_checkout', &nbsp;</div></li><li><div>              'is_checkout_pay_page', &nbsp;</div></li><li><div>              'is_product', &nbsp;</div></li><li><div>              'is_product_category', &nbsp;</div></li><li><div>              'is_product_tag', &nbsp;</div></li><li><div>              'is_shop', &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * other functions</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              'is_amp_endpoint', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $is_functions = apply_filters( $this-&gt;p-&gt;cf['lca'].'_is_functions', $is_functions );&nbsp;</div></li><li><div>          foreach ( $is_functions as $function ) &nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( $function.'() = '.&nbsp;</div></li><li><div>                  ( function_exists( $function ) && &nbsp;</div></li><li><div>                      $function() ? 'true' : 'false' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// returns true if the default image is forced</span>&nbsp;</div></li><li><div>      public function force_default_image( array &$mod, $opt_pre = 'og' ) {&nbsp;</div></li><li><div>          return $this-&gt;force_default( 'img', $mod, $opt_pre );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// returns true if the default video is forced</span>&nbsp;</div></li><li><div>      public function force_default_video( array &$mod, $opt_pre = 'og' ) {&nbsp;</div></li><li><div>          return $this-&gt;force_default( 'vid', $mod, $opt_pre );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $type = author | img | vid</span>&nbsp;</div></li><li><div>      public function force_default( $type, array &$mod, $opt_pre = 'og') {&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $def = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// setup default true / false values</span>&nbsp;</div></li><li><div>          foreach ( array( 'id', 'url', 'on_index', 'on_search' ) as $key )&nbsp;</div></li><li><div>              $def[$key] = apply_filters( $lca.'_'.$opt_pre.'_default_'.$type.'_'.$key, &nbsp;</div></li><li><div>                  ( isset( $this-&gt;p-&gt;options[$opt_pre.'_def_'.$type.'_'.$key] ) ? &nbsp;</div></li><li><div>                      $this-&gt;p-&gt;options[$opt_pre.'_def_'.$type.'_'.$key] : null ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $def['id'] ) && empty( $def['url'] ) )    <span class="comment">// save time - if no default media, then return false</span>&nbsp;</div></li><li><div>              $ret = false;&nbsp;</div></li><li><div>          elseif ( $mod['is_post'] )                <span class="comment">// check for singular pages first</span>&nbsp;</div></li><li><div>              $ret = false;&nbsp;</div></li><li><div>          elseif ( $mod['is_user'] )                <span class="comment">// check for user pages first</span>&nbsp;</div></li><li><div>              $ret = false;&nbsp;</div></li><li><div>          elseif ( ! empty( $def['on_index'] ) && ( $mod['is_home_index'] || $mod['is_term'] || SucomUtil::is_archive_page() ) )&nbsp;</div></li><li><div>              $ret = true;&nbsp;</div></li><li><div>          elseif ( ! empty( $def['on_search'] ) && is_search() )&nbsp;</div></li><li><div>              $ret = true;&nbsp;</div></li><li><div>          else $ret = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// 'ngfb_force_default_img' is hooked by the woocommerce module (false for product category and tag pages)</span>&nbsp;</div></li><li><div>          $ret = apply_filters( $this-&gt;p-&gt;cf['lca'].'_force_default_'.$type, $ret, $mod, $opt_pre );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $ret && $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'default '.$type.' is forced' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $ret;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public static function save_all_times( $lca, $version ) {&nbsp;</div></li><li><div>          self::save_time( $lca, $version, 'update', $version );    <span class="comment">// $protect only if same version</span>&nbsp;</div></li><li><div>          self::save_time( $lca, $version, 'install', true );    <span class="comment">// $protect = true</span>&nbsp;</div></li><li><div>          self::save_time( $lca, $version, 'activate' );        <span class="comment">// always update timestamp</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $protect = true</span>/false/version&nbsp;</div></li><li><div>      public static function save_time( $lca, $version, $type, $protect = false ) {&nbsp;</div></li><li><div>          if ( ! is_bool( $protect ) ) {&nbsp;</div></li><li><div>              if ( ! empty( $protect ) ) {&nbsp;</div></li><li><div>                  if ( ( $ts_version = self::get_option_key( NGFB_TS_NAME, $lca.'_'.$type.'_version' ) ) !== null &&&nbsp;</div></li><li><div>                      version_compare( $ts_version, $protect, '==' ) ) {&nbsp;</div></li><li><div>                      $protect = true;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $protect = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $protect = true;    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! empty( $version ) ) {&nbsp;</div></li><li><div>              self::update_option_key( NGFB_TS_NAME, $lca.'_'.$type.'_version', $version, $protect );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          self::update_option_key( NGFB_TS_NAME, $lca.'_'.$type.'_time', time(), $protect );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get the timestamp array and perform a quick sanity check</span>&nbsp;</div></li><li><div>      public function get_all_times() {&nbsp;</div></li><li><div>          $has_changed = false;&nbsp;</div></li><li><div>          $ts = get_option( NGFB_TS_NAME, array() );&nbsp;</div></li><li><div>          foreach ( $this-&gt;p-&gt;cf['plugin'] as $lca =&gt; $info ) {&nbsp;</div></li><li><div>              if ( empty( $info['version'] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              foreach ( array( 'update', 'install', 'activate' ) as $type ) {&nbsp;</div></li><li><div>                  if ( empty( $ts[$lca.'_'.$type.'_time'] ) ||&nbsp;</div></li><li><div>                      ( $type === 'update' && ( empty( $ts[$lca.'_'.$type.'_version'] ) || &nbsp;</div></li><li><div>                          version_compare( $ts[$lca.'_'.$type.'_version'], $info['version'], '!=' ) ) ) ) {&nbsp;</div></li><li><div>                      $has_changed = self::save_time( $lca, $info['version'], $type );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $has_changed === false ?&nbsp;</div></li><li><div>              $ts : get_option( NGFB_TS_NAME, array() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_inline_vars() {&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              '%%request_url%%', &nbsp;</div></li><li><div>              '%%sharing_url%%', &nbsp;</div></li><li><div>              '%%short_url%%', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_inline_vals( $mod = false, &$atts = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod is preferred but not required</span></span></span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'optional call to get_page_mod()' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mod = $this-&gt;get_page_mod( $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $atts['url'] ) )&nbsp;</div></li><li><div>              $sharing_url = $atts['url'];&nbsp;</div></li><li><div>          else $sharing_url = $this-&gt;get_sharing_url( $mod, &nbsp;</div></li><li><div>              ( isset( $atts['add_page'] ) ? $atts['add_page'] : true ), &nbsp;</div></li><li><div>              ( isset( $atts['src_id'] ) ? $atts['src_id'] : '' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_admin() )&nbsp;</div></li><li><div>              $request_url = $sharing_url;&nbsp;</div></li><li><div>          else $request_url = self::get_prot().':<span class="comment"><span class="comment">//'.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $short_url = empty( $atts['short_url'] ) ?&nbsp;</div></li><li><div>              apply_filters( $this-&gt;p-&gt;cf['lca'].'_shorten_url', &nbsp;</div></li><li><div>                  $sharing_url, $this-&gt;p-&gt;options['plugin_shortener'] ) : $atts['short_url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              $request_url, <span class="comment">// %%request_url%%</span>&nbsp;</div></li><li><div>              $sharing_url, <span class="comment">// %%sharing_url%%</span>&nbsp;</div></li><li><div>              $short_url, <span class="comment">// %%short_url%%</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// allow the variables and values array to be extended</span>&nbsp;</div></li><li><div>      <span class="comment">// $ext must be an associative array with key/value pairs to be replaced</span>&nbsp;</div></li><li><div>      public function replace_inline_vars( $text, $mod = false, $atts = array(), $extra = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $text, '%%' ) === false ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: no inline vars' );&nbsp;</div></li><li><div>              return $text;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod is preferred but not required</span></span></span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'optional call to get_page_mod()' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mod = $this-&gt;get_page_mod( $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $vars = $this-&gt;get_inline_vars();&nbsp;</div></li><li><div>          $vals = $this-&gt;get_inline_vals( $mod, $atts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $extra ) && self::is_assoc( $extra ) ) {&nbsp;</div></li><li><div>              foreach ( $extra as $match =&gt; $replace ) {&nbsp;</div></li><li><div>                  $vars[] = '%%'.$match.'%%';&nbsp;</div></li><li><div>                  $vals[] = $replace;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ksort( $vars );&nbsp;</div></li><li><div>          ksort( $vals );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return str_replace( $vars, $vals, $text );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// use a reference to modify the $options array directly</span>&nbsp;</div></li><li><div>      <span class="comment">// $keys can be a single key name or an array of key names</span>&nbsp;</div></li><li><div>      public function add_image_url_size( $keys, array &$opts ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_array( $keys ) )&nbsp;</div></li><li><div>              $keys = array( $keys );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $disabled = SucomUtil::get_const( 'NGFB_PHP_GETIMGSIZE_DISABLE' );&nbsp;</div></li><li><div>          $cache_exp = (int) apply_filters( $lca.'_cache_expire_image_url_size', &nbsp;</div></li><li><div>              $this-&gt;p-&gt;options['plugin_imgsize_cache_exp'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $keys as $prefix ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $media_url = SucomUtil::get_mt_media_url( $opts, $prefix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $disabled && ! empty( $media_url ) && strpos( $media_url, ':<span class="comment"><span class="comment">//' ) !== false )</span> {</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $cache_salt = __METHOD__.'(url:'.$media_url.')';&nbsp;</div></li><li><div>                  $cache_id = $lca.'_'.md5( $cache_salt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'transient cache salt '.$cache_salt );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $cache_exp &gt; 0 ) {&nbsp;</div></li><li><div>                      $image_info = get_transient( $cache_id );&nbsp;</div></li><li><div>                      if ( is_array( $image_info ) ) {&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'image info for '.$media_url.' retrieved from transient' );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $image_info = false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'image info transient cache is disabled' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $image_info = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $image_info === false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $image_info = @getimagesize( $media_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( is_array( $image_info ) ) {&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'PHP getimagesize() for '.$media_url.' returned '.&nbsp;</div></li><li><div>                                  $image_info[0].'x'.$image_info[1] );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          if ( $cache_exp &gt; 0 ) {&nbsp;</div></li><li><div>                              set_transient( $cache_id, $image_info, $cache_exp );&nbsp;</div></li><li><div>                              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                                  $this-&gt;p-&gt;debug-&gt;log( 'image url size saved to transient '.&nbsp;</div></li><li><div>                                      $cache_id.' ('.$cache_exp.' seconds)');&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } elseif ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'PHP getimagesize() did not return an array' );&nbsp;</div></li><li><div>                          $image_info = array( NGFB_UNDEF_INT, NGFB_UNDEF_INT, '', '' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  list( $opts[$prefix.':width'], $opts[$prefix.':height'], $image_type, $image_attr ) = $image_info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  foreach ( array( 'width', 'height' ) as $attr )&nbsp;</div></li><li><div>                      if ( isset( $opts[$prefix.':'.$attr] ) )&nbsp;</div></li><li><div>                          $opts[$prefix.':'.$attr] = NGFB_UNDEF_INT;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $opts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// accepts json script or json array</span>&nbsp;</div></li><li><div>      public function json_format( $json, $options = 0, $depth = 32 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $do_pretty_print = self::get_const( 'NGFB_JSON_PRETTY_PRINT' );&nbsp;</div></li><li><div>          $ext_json_disable = self::get_const( 'NGFB_EXT_JSON_DISABLE', false );&nbsp;</div></li><li><div>          $do_ext_pretty = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $options === 0 && defined( 'JSON_UNESCAPED_SLASHES' ) ) {&nbsp;</div></li><li><div>              $options = JSON_UNESCAPED_SLASHES;    <span class="comment"><span class="comment">// since PHP v5.4</span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// decide if the encoded json will be minimized or not</span>&nbsp;</div></li><li><div>          if ( is_admin() || $this-&gt;p-&gt;debug-&gt;enabled || $do_pretty_print ) {&nbsp;</div></li><li><div>              if ( defined( 'JSON_PRETTY_PRINT' ) ) {    <span class="comment"><span class="comment">// since PHP v5.4</span></span>&nbsp;</div></li><li><div>                  $options = $options|JSON_PRETTY_PRINT;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $do_ext_pretty = true;    <span class="comment">// use the SuextJsonFormat lib</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// encode the json</span>&nbsp;</div></li><li><div>          if ( ! is_string( $json ) )&nbsp;</div></li><li><div>              $json = self::json_encode_array( $json, $options, $depth );    <span class="comment">// prefers wp_json_encode() to json_encode()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// use the pretty print external library for older PHP versions</span>&nbsp;</div></li><li><div>          <span class="comment">// define NGFB_EXT_JSON_DISABLE as true to prevent external json formatting </span>&nbsp;</div></li><li><div>          if ( ! $ext_json_disable && $do_ext_pretty ) {&nbsp;</div></li><li><div>              $classname = NgfbConfig::load_lib( false, 'ext/json-format', 'suextjsonformat' );&nbsp;</div></li><li><div>              if ( $classname !== false && class_exists( $classname ) )&nbsp;</div></li><li><div>                  $json = SuextJsonFormat::get( $json, $options, $depth );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $json;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Determine and return the post/user/term module array.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      public function get_page_mod( $use_post = false, $mod = false, $wp_obj = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              $mod = array();&nbsp;</div></li><li><div>          } elseif ( isset( $mod['obj'] ) && is_object( $mod['obj'] ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'exiting early: module object is defined' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $mod;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// check for a recognized object</span>&nbsp;</div></li><li><div>          if ( is_object( $wp_obj ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'wp_obj is '.get_class( $wp_obj ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              switch ( get_class( $wp_obj ) ) {&nbsp;</div></li><li><div>                  case 'WP_Post':&nbsp;</div></li><li><div>                      $mod['name'] = 'post';&nbsp;</div></li><li><div>                      $mod['id'] = $wp_obj-&gt;ID;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'WP_Term':&nbsp;</div></li><li><div>                      $mod['name'] = 'term';&nbsp;</div></li><li><div>                      $mod['id'] = $wp_obj-&gt;term_id;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'WP_User':&nbsp;</div></li><li><div>                      $mod['name'] = 'user';&nbsp;</div></li><li><div>                      $mod['id'] = $wp_obj-&gt;ID;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// we need a module name to get the id and object</span>&nbsp;</div></li><li><div>          if ( empty( $mod['name'] ) ) {&nbsp;</div></li><li><div>              if ( self::is_post_page( $use_post ) ) {    <span class="comment"><span class="comment">// $use_post = true | false | post_id </span></span>&nbsp;</div></li><li><div>                  $mod['name'] = 'post';&nbsp;</div></li><li><div>              } elseif ( self::is_term_page() ) {&nbsp;</div></li><li><div>                  $mod['name'] = 'term';&nbsp;</div></li><li><div>              } elseif ( self::is_user_page() ) {&nbsp;</div></li><li><div>                  $mod['name'] = 'user';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $mod['name'] = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $mod['id'] ) ) {&nbsp;</div></li><li><div>              if ( $mod['name'] === 'post' ) {&nbsp;</div></li><li><div>                  $mod['id'] = self::get_post_object( $use_post, 'id' );    <span class="comment"><span class="comment">// $use_post = true | false | post_id </span></span>&nbsp;</div></li><li><div>              } elseif ( $mod['name'] === 'term' ) {&nbsp;</div></li><li><div>                  $mod['id'] = self::get_term_object( false, '', 'id' );&nbsp;</div></li><li><div>              } elseif ( $mod['name'] === 'user' ) {&nbsp;</div></li><li><div>                  $mod['id'] = self::get_user_object( false, 'id' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $mod['id'] = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $this-&gt;p-&gt;m['util'][$mod['name']] ) ) {    <span class="comment">// make sure we have a complete $mod array</span>&nbsp;</div></li><li><div>              $mod = $this-&gt;p-&gt;m['util'][$mod['name']]-&gt;get_mod( $mod['id'] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mod = array_merge( NgfbMeta::$mod_defaults, $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mod['use_post'] = $use_post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * The post module defines is_home_page, is_home_index, and is_home.</span>&nbsp;</div></li><li><div><span class="comment">           * If we don't have a module, then check if we're on the home index page.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( $mod['name'] === false ) {&nbsp;</div></li><li><div>              $mod['is_home_index'] = $mod['is_home'] = is_home();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log_arr( '$mod', $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $mod;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * $mod is false when used for open graph meta tags and buttons in widget.</span>&nbsp;</div></li><li><div><span class="comment">       * $mod is true when buttons are added to individual posts on an index webpage.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      public function get_sharing_url( $mod = false, $add_page = true, $src_id = '' ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $this-&gt;get_page_url( 'sharing', $mod, $add_page, $src_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_canonical_url( $mod = false, $add_page = true, $src_id = '' ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;mark();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $this-&gt;get_page_url( 'canonical', $mod, $add_page, $src_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      private function get_page_url( $type, $mod, $add_page, $src_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log_args( array( &nbsp;</div></li><li><div>                  'type' =&gt; $type, &nbsp;</div></li><li><div>                  'mod' =&gt; $mod, &nbsp;</div></li><li><div>                  'add_page' =&gt; $add_page, &nbsp;</div></li><li><div>                  'src_id' =&gt; $src_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $url = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod is preferred but not required</span></span></span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// $mod = true | false | post_id | $mod array</span></span></span></span></span></span>&nbsp;</div></li><li><div>          if ( ! is_array( $mod ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'optional call to get_page_mod()' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mod = $this-&gt;get_page_mod( $mod );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $mod['is_post'] ) {&nbsp;</div></li><li><div>              if ( ! empty( $mod['id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $mod['obj'] ) ) {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// get_options() returns null if an index key is not found</span></span></span></span>&nbsp;</div></li><li><div>                      $url = $mod['obj']-&gt;get_options( $mod['id'], $type.'_url' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $url ) ) {    <span class="comment"><span class="comment"><span class="comment">// must be a non-empty string</span></span></span>&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'custom post '.$type.'_url = '.$url );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $url = $this-&gt;check_url_string( get_permalink( $mod['id'] ), 'post permalink' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $url ) && $add_page && get_query_var( 'page' ) &gt; 1 ) {&nbsp;</div></li><li><div>                      global $wp_rewrite;&nbsp;</div></li><li><div>                      $post_obj = self::get_post_object( $mod['id'] );&nbsp;</div></li><li><div>                      $numpages = substr_count( $post_obj-&gt;post_content, '&lt;!--nextpage--&gt;' ) + 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $numpages && get_query_var( 'page' ) &lt;= $numpages ) {&nbsp;</div></li><li><div>                          if ( ! $wp_rewrite-&gt;using_permalinks() || strpos( $url, '?' ) !== false )&nbsp;</div></li><li><div>                              $url = add_query_arg( 'page', get_query_var( 'page' ), $url );&nbsp;</div></li><li><div>                          else $url = user_trailingslashit( trailingslashit( $url ).get_query_var( 'page' ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'add page query url = '.$url );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $url = apply_filters( $lca.'_post_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $mod['is_home'] ) {&nbsp;</div></li><li><div>                  if ( get_option( 'show_on_front' ) === 'page' ) {    <span class="comment">// show_on_front = posts | page</span>&nbsp;</div></li><li><div>                      $url = $this-&gt;check_url_string( get_permalink( get_option( 'page_for_posts' ) ), 'page for posts' );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $url = apply_filters( $lca.'_home_url', home_url( '/' ), $mod, $add_page, $src_id );&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'home url = '.$url );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( $mod['is_term'] ) {&nbsp;</div></li><li><div>                  if ( ! empty( $mod['id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $mod['obj'] ) ) {&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// get_options() returns null if an index key is not found</span></span></span></span>&nbsp;</div></li><li><div>                          $url = $mod['obj']-&gt;get_options( $mod['id'], $type.'_url' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $url ) ) {    <span class="comment"><span class="comment"><span class="comment">// must be a non-empty string</span></span></span>&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'custom term '.$type.'_url = '.$url );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $url = $this-&gt;check_url_string( get_term_link( $mod['id'], $mod['tax_slug'] ), 'term link' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } &nbsp;</div></li><li><div>                  $url = apply_filters( $lca.'_term_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif ( $mod['is_user'] ) {&nbsp;</div></li><li><div>                  if ( ! empty( $mod['id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $mod['obj'] ) ) {&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// get_options() returns null if an index key is not found</span></span></span></span>&nbsp;</div></li><li><div>                          $url = $mod['obj']-&gt;get_options( $mod['id'], $type.'_url' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $url ) ) {    <span class="comment"><span class="comment"><span class="comment">// must be a non-empty string</span></span></span>&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'custom user '.$type.'_url = '.$url );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $url = $this-&gt;check_url_string( get_author_posts_url( $mod['id'] ), 'author posts' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $url = apply_filters( $lca.'_user_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif ( is_search() ) {&nbsp;</div></li><li><div>                  $url = $this-&gt;check_url_string( get_search_link(), 'search link' );&nbsp;</div></li><li><div>                  $url = apply_filters( $lca.'_search_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif ( function_exists( 'get_post_type_archive_link' ) && is_post_type_archive() ) {&nbsp;</div></li><li><div>                  $url = $this-&gt;check_url_string( get_post_type_archive_link( get_query_var( 'post_type' ) ), 'post type archive' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif ( SucomUtil::is_archive_page() ) {&nbsp;</div></li><li><div>                  if ( is_date() ) {&nbsp;</div></li><li><div>                      if ( is_day() )&nbsp;</div></li><li><div>                          $url = $this-&gt;check_url_string( get_day_link( get_query_var( 'year' ), &nbsp;</div></li><li><div>                              get_query_var( 'monthnum' ), get_query_var( 'day' ) ), 'day link' );&nbsp;</div></li><li><div>                      elseif ( is_month() )&nbsp;</div></li><li><div>                          $url = $this-&gt;check_url_string( get_month_link( get_query_var( 'year' ), &nbsp;</div></li><li><div>                              get_query_var( 'monthnum' ) ), 'month link' );&nbsp;</div></li><li><div>                      elseif ( is_year() )&nbsp;</div></li><li><div>                          $url = $this-&gt;check_url_string( get_year_link( get_query_var( 'year' ) ), &nbsp;</div></li><li><div>                              'year link' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $url = apply_filters( $lca.'_archive_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $url ) && $add_page && get_query_var( 'paged' ) &gt; 1 ) {&nbsp;</div></li><li><div>                  global $wp_rewrite;&nbsp;</div></li><li><div>                  if ( ! $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>                      $url = add_query_arg( 'paged', get_query_var( 'paged' ), $url );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ( $mod['is_home_page'] ) {    <span class="comment">// static home page (have post id)</span>&nbsp;</div></li><li><div>                          $base = $GLOBALS['wp_rewrite']-&gt;using_index_permalinks() ? 'index.php/' : '/';&nbsp;</div></li><li><div>                          $url = home_url( $base );&nbsp;</div></li><li><div>                          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                              $this-&gt;p-&gt;debug-&gt;log( 'home_url for '.$base.' = '.$url );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $url = user_trailingslashit( trailingslashit( $url ).&nbsp;</div></li><li><div>                          trailingslashit( $wp_rewrite-&gt;pagination_base ).get_query_var( 'paged' ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'add paged query url = '.$url );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// fallback for themes and plugins that don't use the standard wordpress functions/variables</span>&nbsp;</div></li><li><div>          if ( empty ( $url ) ) {&nbsp;</div></li><li><div>              <span class="comment">// strip out tracking query arguments by facebook, google, etc.</span>&nbsp;</div></li><li><div>              $url = preg_replace( '/([\?&])(fb_action_ids|fb_action_types|fb_source|fb_aggregation_id|'.&nbsp;</div></li><li><div>                  'utm_source|utm_medium|utm_campaign|utm_term|gclid|pk_campaign|pk_kwd)=[^&]*&?/i', &nbsp;</div></li><li><div>                      '$1', self::get_prot().':<span class="comment">//'.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'] );</span>&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'server request url = '.$url );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return apply_filters( $lca.'_'.$type.'_url', $url, $mod, $add_page, $src_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      private function check_url_string( $url, $source ) {&nbsp;</div></li><li><div>          if ( is_string( $url ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( $source.' url = '.$url );&nbsp;</div></li><li><div>              return $url;    <span class="comment"><span class="comment"><span class="comment">// stop here</span></span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( $source.' url is '.gettype( $url ) );&nbsp;</div></li><li><div>              if ( is_wp_error( $url ) )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( $source.' url error: '.$url-&gt;get_error_message() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// used by NgfbMedia get_content_images() and get_attachment_image_src().</span>&nbsp;</div></li><li><div>      public function fix_relative_url( $url ) {&nbsp;</div></li><li><div>          if ( empty( $url ) || &nbsp;</div></li><li><div>              strpos( $url, ':<span class="comment">//' ) !== false )</span>&nbsp;</div></li><li><div>                  return $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'relative url found = '.$url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $url, '<span class="comment"><span class="comment"><span class="comment">//' ) === 0 )</span></span></span>&nbsp;</div></li><li><div>              $url = self::get_prot().':'.$url;&nbsp;</div></li><li><div>          elseif ( strpos( $url, '/' ) === 0 ) &nbsp;</div></li><li><div>              $url = home_url( $url );&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $base = self::get_prot().':<span class="comment"><span class="comment">//'.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];</span></span>&nbsp;</div></li><li><div>              if ( strpos( $base, '?' ) !== false ) {&nbsp;</div></li><li><div>                  $base_parts = explode( '?', $base );&nbsp;</div></li><li><div>                  $base = reset( $base_parts );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $url = trailingslashit( $base, false ).$url;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'relative url fixed = '.$url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function clear_uniq_urls( $context = 'default' ) {&nbsp;</div></li><li><div>          $cleared = isset( $this-&gt;uniq_urls[$context] ) ?&nbsp;</div></li><li><div>              count( $this-&gt;uniq_urls[$context] ) : 0;&nbsp;</div></li><li><div>          $this-&gt;uniq_urls[$context] = array();&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'cleared uniq url cache for context '.$context ); &nbsp;</div></li><li><div>          return $cleared;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function is_dupe_url( $url, $context = 'default' ) {&nbsp;</div></li><li><div>          return $this-&gt;is_uniq_url( $url, $context ) ? false : true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function is_uniq_url( $url, $context = 'default' ) {&nbsp;</div></li><li><div>          if ( empty( $url ) ) &nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// complete the url with a protocol name</span>&nbsp;</div></li><li><div>          if ( strpos( $url, '<span class="comment"><span class="comment"><span class="comment">//' ) === 0 )</span></span></span>&nbsp;</div></li><li><div>              $url = self::get_prot().'<span class="comment">//'.$url;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled && &nbsp;</div></li><li><div>              strpos( $url, ':<span class="comment">//' ) === false )</span>&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'incomplete url given for context '.$context.': '.$url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;uniq_urls[$context][$url] ) ) {&nbsp;</div></li><li><div>              $this-&gt;uniq_urls[$context][$url] = 1;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                  $this-&gt;p-&gt;debug-&gt;log( 'duplicate url rejected for context '.$context.': '.$url ); &nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function is_maxed( &$arr, $num = 0 ) {&nbsp;</div></li><li><div>          if ( ! is_array( $arr ) ) &nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          if ( $num &gt; 0 && count( $arr ) &gt;= $num ) &nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function push_max( &$dst, &$src, $num = 0 ) {&nbsp;</div></li><li><div>          if ( ! is_array( $dst ) || &nbsp;</div></li><li><div>              ! is_array( $src ) ) &nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// if the array is not empty, or contains some non-empty values, then push it</span>&nbsp;</div></li><li><div>          if ( ! empty( $src ) && &nbsp;</div></li><li><div>              array_filter( $src ) ) &nbsp;</div></li><li><div>                  array_push( $dst, $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $this-&gt;slice_max( $dst, $num );    <span class="comment">// returns true or false</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function slice_max( &$arr, $num = 0 ) {&nbsp;</div></li><li><div>          if ( ! is_array( $arr ) )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $has = count( $arr );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $num &gt; 0 ) {&nbsp;</div></li><li><div>              if ( $has == $num ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'max values reached ('.$has.' == '.$num.')' );&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              } elseif ( $has &gt; $num ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'max values reached ('.$has.' &gt; '.$num.') - slicing array' );&nbsp;</div></li><li><div>                  $arr = array_slice( $arr, 0, $num );&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get maximum media values from custom meta or plugin settings</span>&nbsp;</div></li><li><div>      public function get_max_nums( array &$mod, $opt_pre = 'og' ) {&nbsp;</div></li><li><div>          $max = array();&nbsp;</div></li><li><div>          $opt_keys = array( $opt_pre.'_vid_max', $opt_pre.'_img_max' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $opt_keys as $max_key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $mod['id'] ) && ! empty( $mod['obj'] ) ) {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// get_options() returns null if an index key is not found</span></span></span></span>&nbsp;</div></li><li><div>                  $max_val = $mod['obj']-&gt;get_options( $mod['id'], $max_key );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $max_val = null;    <span class="comment">// default value if index key is missing</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// quick sanitation of returned value - ignore NGFB_UNDEF_INT values</span>&nbsp;</div></li><li><div>              if ( $max_val !== null & is_numeric( $max_val ) && $max_val &gt;= 0 ) {&nbsp;</div></li><li><div>                  $max[$max_key] = $max_val;&nbsp;</div></li><li><div>                  if ( $this-&gt;p-&gt;debug-&gt;enabled ) {&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;debug-&gt;log( 'found custom meta '.$max_key.' = '.$max_val );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $max[$max_key] = isset( $this-&gt;p-&gt;options[$max_key] ) ?    <span class="comment">// fallback to options</span>&nbsp;</div></li><li><div>                      $this-&gt;p-&gt;options[$max_key] : 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $max;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function get_admin_url( $menu_id = '', $link_text = '', $menu_lib = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $hash = '';&nbsp;</div></li><li><div>          $query = '';&nbsp;</div></li><li><div>          $admin_url = '';&nbsp;</div></li><li><div>          $lca = $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// $menu_id may start with a hash or query, so parse before checking its value</span>&nbsp;</div></li><li><div>          if ( strpos( $menu_id, '#' ) !== false )&nbsp;</div></li><li><div>              list( $menu_id, $hash ) = explode( '#', $menu_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $menu_id, '?' ) !== false )&nbsp;</div></li><li><div>              list( $menu_id, $query ) = explode( '?', $menu_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $menu_id ) ) {&nbsp;</div></li><li><div>              $current = $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>              if ( preg_match( '/^.*\?page='.$lca.'-([^&]*).*$/', $current, $match ) )&nbsp;</div></li><li><div>                  $menu_id = $match[1];&nbsp;</div></li><li><div>              else $menu_id = key( $this-&gt;p-&gt;cf['*']['lib']['submenu'] );    <span class="comment">// default to first submenu</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// find the menu_lib value for this menu_id</span>&nbsp;</div></li><li><div>          if ( empty( $menu_lib ) ) {&nbsp;</div></li><li><div>              foreach ( $this-&gt;p-&gt;cf['*']['lib'] as $menu_lib =&gt; $menu ) {&nbsp;</div></li><li><div>                  if ( isset( $menu[$menu_id] ) )&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  else $menu_lib = '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $menu_lib ) ||&nbsp;</div></li><li><div>              empty( $this-&gt;p-&gt;cf['wp']['admin'][$menu_lib]['page'] ) )&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parent_slug = $this-&gt;p-&gt;cf['wp']['admin'][$menu_lib]['page'].'?page='.$lca.'-'.$menu_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $menu_lib ) {&nbsp;</div></li><li><div>              case 'sitesubmenu':&nbsp;</div></li><li><div>                  $admin_url = network_admin_url( $parent_slug );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $admin_url = admin_url( $parent_slug );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $query ) ) &nbsp;</div></li><li><div>              $admin_url .= '&'.$query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $hash ) ) &nbsp;</div></li><li><div>              $admin_url .= '#'.$hash;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $link_text ) ) {&nbsp;</div></li><li><div>              return $admin_url;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return '&lt;a href=&quot;'.$admin_url.'&quot;&gt;'.$link_text.'&lt;/a&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function do_metabox_tabs( $metabox = '', $tabs = array(), $table_rows = array(), $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tab_keys = array_keys( $tabs );&nbsp;</div></li><li><div>          $default_tab = '_'.reset( $tab_keys );        <span class="comment"><span class="comment">// must start with an underscore</span></span>&nbsp;</div></li><li><div>          $class_metabox_tabs = 'sucom-metabox-tabs';&nbsp;</div></li><li><div>          $class_link = 'sucom-tablink';&nbsp;</div></li><li><div>          $class_tabset = 'sucom-tabset';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $metabox ) ) {&nbsp;</div></li><li><div>              $metabox = '_'.$metabox;        <span class="comment"><span class="comment">// must start with an underscore</span></span>&nbsp;</div></li><li><div>              $class_metabox_tabs .= ' '.$class_metabox_tabs.$metabox;&nbsp;</div></li><li><div>              $class_link .= ' '.$class_link.$metabox;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// allow a css ID to be passed as a query argument</span>&nbsp;</div></li><li><div>          extract( array_merge( array(&nbsp;</div></li><li><div>              'scroll_to' =&gt; isset( $_GET['scroll_to'] ) ? &nbsp;</div></li><li><div>                  '#'.self::sanitize_key( $_GET['scroll_to'] ) : '', &nbsp;</div></li><li><div> ), $args ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;\n&quot;.'&lt;script type=&quot;text/javascript&quot;&gt;jQuery(document).ready(function() { '.&nbsp;</div></li><li><div>              'sucomTabs(\''.$metabox.'\', \''.$default_tab.'\', \''.$scroll_to.'\'); });&lt;/script&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;'.$class_metabox_tabs.'&quot;&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          echo '&lt;ul class=&quot;'.$class_metabox_tabs.'&quot;&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          foreach ( $tabs as $tab =&gt; $title ) {&nbsp;</div></li><li><div>              $class_href_key = $class_tabset.$metabox.'-tab_'.$tab;&nbsp;</div></li><li><div>              echo '&lt;div class=&quot;tab_left&quot;&gt;&nbsp;&lt;/div&gt;&lt;li class=&quot;'.&nbsp;</div></li><li><div>                  $class_href_key.'&quot;&gt;&lt;a class=&quot;'.$class_link.'&quot; href=&quot;#'.&nbsp;</div></li><li><div>                  $class_href_key.'&quot;&gt;'.$title.'&lt;/a&gt;&lt;/li&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo '&lt;/ul&gt;&lt;!-- .'.$class_metabox_tabs.' --&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $tabs as $tab =&gt; $title ) {&nbsp;</div></li><li><div>              $class_href_key = $class_tabset.$metabox.'-tab_'.$tab;&nbsp;</div></li><li><div>              $this-&gt;do_table_rows( $table_rows[$tab], $class_href_key, ( empty( $metabox ) ?&nbsp;</div></li><li><div>                  '' : $class_tabset.$metabox ), $class_tabset );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo '&lt;/div&gt;&lt;!-- .'.$class_metabox_tabs.' --&gt;'.&quot;\n\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function do_table_rows( $table_rows, $class_href_key = '', $class_tabset_mb = '', $class_tabset = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_array( $table_rows ) )    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lca = empty( $this-&gt;p-&gt;cf['lca'] ) ? &nbsp;</div></li><li><div>              'sucom' : $this-&gt;p-&gt;cf['lca'];&nbsp;</div></li><li><div>          $total_rows = count( $table_rows );&nbsp;</div></li><li><div>          $count_rows = 0;&nbsp;</div></li><li><div>          $hidden_opts = 0;&nbsp;</div></li><li><div>          $hidden_rows = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// use call_user_func() instead of $classname::show_opts() for PHP 5.2</span>&nbsp;</div></li><li><div>          $show_opts = class_exists( $lca.'user' ) ? &nbsp;</div></li><li><div>              call_user_func( array( $lca.'user', 'show_opts' ) ) : 'basic';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $table_rows as $key =&gt; $row ) {&nbsp;</div></li><li><div>              if ( empty( $row ) )    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// default row class and id attribute values</span>&nbsp;</div></li><li><div>              $tr = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'sucom_alt'.( $count_rows % 2 ).&nbsp;</div></li><li><div>                      ( $count_rows === 0 ? ' first_row' : '' ).&nbsp;</div></li><li><div>                      ( $count_rows === ( $total_rows - 1 ) ? ' last_row' : '' ), &nbsp;</div></li><li><div>                  'id' =&gt; ( is_int( $key ) ? '' : 'tr_'.$key )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// if we don't already have a table row tag, then add one</span>&nbsp;</div></li><li><div>              if ( strpos( $row, '&lt;tr ' ) === false ) {&nbsp;</div></li><li><div>                  $row = '&lt;tr class=&quot;'.$tr['class'].'&quot;'.&nbsp;</div></li><li><div>                      ( empty( $tr['id'] ) ? '' : ' id=&quot;'.$tr['id'].'&quot;' ).'&gt;'.$row;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  foreach ( $tr as $att =&gt; $val ) {&nbsp;</div></li><li><div>                      if ( empty( $tr[$att] ) )&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// if we're here, then we have a table row tag already</span>&nbsp;</div></li><li><div>                      <span class="comment">// count the number of rows and options that are hidden</span>&nbsp;</div></li><li><div>                      if ( $att === 'class' && ! empty( $show_opts ) && &nbsp;</div></li><li><div>                          ( $matched = preg_match( '/&lt;tr [^&gt;]*class=&quot;[^&quot;]*hide(_row)?_in_'.$show_opts.'[&quot; ]/', $row, $m ) &gt; 0 ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( ! isset( $m[1] ) ) {&nbsp;</div></li><li><div>                              $hidden_opts += preg_match_all( '/(&lt;th|&lt;tr[^&gt;]*&gt;&lt;td)/', $row, $all_matches );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $hidden_rows += $matched;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// add the attribute value</span>&nbsp;</div></li><li><div>                      $row = preg_replace( '/(&lt;tr [^&gt;]*'.$att.'=&quot;)([^&quot;]*)(&quot;)/', '$1$2 '.$tr[$att].'$3', $row, -1, $cnt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// if one hasn't been added, then add both the attribute and its value</span>&nbsp;</div></li><li><div>                      if ( $cnt &lt; 1 ) {&nbsp;</div></li><li><div>                          $row = preg_replace( '/(&lt;tr )/', '$1'.$att.'=&quot;'.$tr[$att].'&quot; ', $row, -1, $cnt );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// add a closing table row tag if we don't already have one</span>&nbsp;</div></li><li><div>              if ( strpos( $row, '&lt;/tr&gt;' ) === false )&nbsp;</div></li><li><div>                  $row .= '&lt;/tr&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// update the table row array element with the new value</span>&nbsp;</div></li><li><div>              $table_rows[$key] = $row;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $count_rows++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $count_rows === 0 ) {&nbsp;</div></li><li><div>              $table_rows[] = '&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;p&gt;&lt;em&gt;'.&nbsp;</div></li><li><div>                  __( 'No options available.', 'nextgen-facebook' ).&nbsp;</div></li><li><div>                      '&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;';&nbsp;</div></li><li><div>              $count_rows++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;'.&nbsp;</div></li><li><div>              ( empty( $show_opts ) ? '' : 'sucom-show_'.$show_opts ).&nbsp;</div></li><li><div>              ( empty( $class_tabset ) ? '' : ' '.$class_tabset ).&nbsp;</div></li><li><div>              ( empty( $class_tabset_mb ) ? '' : ' '.$class_tabset_mb ).&nbsp;</div></li><li><div>              ( empty( $class_href_key ) ? '' : ' '.$class_href_key ).&nbsp;</div></li><li><div>          '&quot;&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;table class=&quot;sucom-settings '.$lca.&nbsp;</div></li><li><div>              ( empty( $class_href_key ) ? '' : ' '.$class_href_key ).&nbsp;</div></li><li><div>              ( $hidden_rows &gt; 0 && $hidden_rows === $count_rows ?    <span class="comment">// if all rows hidden, then hide the whole table</span>&nbsp;</div></li><li><div>                  ' hide_in_'.$show_opts : '' ).'&quot;&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $table_rows as $row )&nbsp;</div></li><li><div>              echo $row;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/table&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          echo '&lt;/div&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $show_opts_label = $this-&gt;p-&gt;cf['form']['show_options'][$show_opts];&nbsp;</div></li><li><div>          if ( $hidden_opts &gt; 0 ) {&nbsp;</div></li><li><div>              echo '&lt;div class=&quot;hidden_opts_msg '.$class_tabset.'-msg '.$class_tabset_mb.'-msg '.$class_href_key.'-msg&quot;&gt;'.&nbsp;</div></li><li><div>                  sprintf( _x( '%1$d additional options not shown in %2$s view', 'option comment', 'nextgen-facebook' ), &nbsp;</div></li><li><div>                      $hidden_opts, _x( $show_opts_label, 'option value', 'nextgen-facebook' ) ).&nbsp;</div></li><li><div>                  ' (&lt;a href=&quot;javascript:void(0);&quot;'.&nbsp;</div></li><li><div>                  ' onClick=&quot;sucomViewUnhideRows( \''.$class_href_key.'\', \''.$show_opts.'\' );&quot;&gt;'.&nbsp;</div></li><li><div>                  _x( 'unhide these options', 'option comment', 'nextgen-facebook' ).'&lt;/a&gt;)&lt;/div&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          } elseif ( $hidden_rows &gt; 0 ) {&nbsp;</div></li><li><div>              echo '&lt;div class=&quot;hidden_opts_msg '.$class_tabset.'-msg '.$class_tabset_mb.'-msg '.$class_href_key.'-msg&quot;&gt;'.&nbsp;</div></li><li><div>                  sprintf( _x( '%1$d additional rows not shown in %2$s view', 'option comment', 'nextgen-facebook' ), &nbsp;</div></li><li><div>                      $hidden_rows, _x( $show_opts_label, 'option value', 'nextgen-facebook' ) ).&nbsp;</div></li><li><div>                  ' (&lt;a href=&quot;javascript:void(0);&quot;'.&nbsp;</div></li><li><div>                  ' onClick=&quot;sucomViewUnhideRows( \''.$class_href_key.'\', \''.$show_opts.'\', \'hide_row_in\' );&quot;&gt;'.&nbsp;</div></li><li><div>                  _x( 'unhide these rows', 'option comment', 'nextgen-facebook' ).'&lt;/a&gt;)&lt;/div&gt;'.&quot;\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function shorten_html_href( $html ) {&nbsp;</div></li><li><div>          return preg_replace_callback( '/(href=[\'&quot;])([^\'&quot;]+)([\'&quot;])/', &nbsp;</div></li><li><div>              array( &$this, 'shorten_html_href_value' ), $html );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      private function shorten_html_href_value( $matches ) {&nbsp;</div></li><li><div>          if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>              $this-&gt;p-&gt;debug-&gt;log( 'shortening url '.$matches[2] );&nbsp;</div></li><li><div>          return $matches[1].apply_filters( $this-&gt;p-&gt;cf['lca'].'_shorten_url', &nbsp;</div></li><li><div>              $matches[2], $this-&gt;p-&gt;options['plugin_shortener'] ).$matches[3];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function rename_opts_by_ext( &$opts, $options_keys ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;p-&gt;cf['plugin'] as $ext =&gt; $info ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! isset( $options_keys[$ext] ) || is_array( $options_keys[$ext] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              } elseif ( ! isset( $info['opt_version'] ) ) {    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              } elseif ( empty( $opts['plugin_'.$ext.'_opt_version'] ) ) {    <span class="comment">// no upgrade required</span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              } &nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              foreach ( $options_keys[$ext] as $max_version =&gt; $keys ) {&nbsp;</div></li><li><div>                  if ( is_numeric( $max_version ) && is_array( $keys ) &&&nbsp;</div></li><li><div>                      $opts['plugin_'.$ext.'_opt_version'] &lt;= $max_version ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      SucomUtil::rename_keys( $opts, $keys, true );    <span class="comment">// rename $modifiers = true</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $opts['plugin_'.$ext.'_opt_version'] = $info['opt_version'];    <span class="comment"><span class="comment">// mark as current</span></span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $opts['options_version'] = $this-&gt;p-&gt;cf['opt']['version'];    <span class="comment"><span class="comment">// mark as current</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// limit_text_length() uses PHP's multibyte functions (mb_strlen and mb_substr) for UTF8</span>&nbsp;</div></li><li><div>      public function limit_text_length( $text, $maxlen = 300, $trailing = '', $cleanup_html = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $cleanup_html === true ) {&nbsp;</div></li><li><div>              $text = $this-&gt;cleanup_html_tags( $text );                <span class="comment">// remove any remaining html tags</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $charset = get_bloginfo( 'charset' );&nbsp;</div></li><li><div>          $text = html_entity_decode( self::decode_utf8( $text ), ENT_QUOTES, $charset );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $maxlen &gt; 0 ) {&nbsp;</div></li><li><div>              if ( mb_strlen( $trailing ) &gt; $maxlen )&nbsp;</div></li><li><div>                  $trailing = mb_substr( $trailing, 0, $maxlen );            <span class="comment">// trim the trailing string, if too long</span>&nbsp;</div></li><li><div>              if ( mb_strlen( $text ) &gt; $maxlen ) {&nbsp;</div></li><li><div>                  $text = mb_substr( $text, 0, $maxlen - mb_strlen( $trailing ) );&nbsp;</div></li><li><div>                  $text = trim( preg_replace( '/[^ ]*$/', '', $text ) );        <span class="comment">// remove trailing bits of words</span>&nbsp;</div></li><li><div>                  $text = preg_replace( '/[, \.]*$/', '', $text );            <span class="comment">// remove trailing puntuation</span>&nbsp;</div></li><li><div>              } else $trailing = '';                            <span class="comment">// truncate trailing string if text is less than maxlen</span>&nbsp;</div></li><li><div>              $text = $text.$trailing;                        <span class="comment">// trim and add trailing string (if provided)</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $text = preg_replace( '/&nbsp;/', ' ', $text);                    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// just in case</span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $text;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function cleanup_html_tags( $text, $strip_tags = true, $use_img_alt = false ) {&nbsp;</div></li><li><div>          $alt_text = '';&nbsp;</div></li><li><div>          $alt_prefix = isset( $this-&gt;p-&gt;options['plugin_img_alt_prefix'] ) ?&nbsp;</div></li><li><div>              $this-&gt;p-&gt;options['plugin_img_alt_prefix'] : 'Image:';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $text = self::strip_shortcodes( $text );                    <span class="comment">// remove any remaining shortcodes</span>&nbsp;</div></li><li><div>          $text = preg_replace( '/[\s\n\r]+/s', ' ', $text );                <span class="comment">// put everything on one line</span>&nbsp;</div></li><li><div>          $text = preg_replace( '/&lt;\?.*\?'.'&gt;/U', ' ', $text);                <span class="comment">// remove php</span>&nbsp;</div></li><li><div>          $text = preg_replace( '/&lt;script\b[^&gt;]*&gt;(.*)&lt;\/script&gt;/Ui', ' ', $text);        <span class="comment">// remove javascript</span>&nbsp;</div></li><li><div>          $text = preg_replace( '/&lt;style\b[^&gt;]*&gt;(.*)&lt;\/style&gt;/Ui', ' ', $text);        <span class="comment">// remove inline stylesheets</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $text = preg_replace( '/&lt;!--'.$this-&gt;p-&gt;cf['lca'].'-ignore--&gt;(.*?)&lt;!--\/'.&nbsp;</div></li><li><div>              $this-&gt;p-&gt;cf['lca'].'-ignore--&gt;/Ui', ' ', $text);            <span class="comment">// remove text between comment strings</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $strip_tags ) {&nbsp;</div></li><li><div>              $text = preg_replace( '/&lt;\/p&gt;/i', ' ', $text);                <span class="comment">// replace end of paragraph with a space</span>&nbsp;</div></li><li><div>              $text_stripped = trim( strip_tags( $text ) );                <span class="comment">// remove remaining html tags</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $text_stripped === '' && $use_img_alt ) {                <span class="comment">// possibly use img alt strings if no text</span>&nbsp;</div></li><li><div>                  if ( strpos( $text, '&lt;img ' ) !== false &&&nbsp;</div></li><li><div>                      preg_match_all( '/&lt;img [^&gt;]*alt=[&quot;\']([^&quot;\'&gt;]*)[&quot;\']/Ui', &nbsp;</div></li><li><div>                          $text, $all_matches, PREG_PATTERN_ORDER ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $all_matches[1] as $alt ) {&nbsp;</div></li><li><div>                          $alt = trim( $alt );&nbsp;</div></li><li><div>                          if ( ! empty( $alt ) ) {&nbsp;</div></li><li><div>                              $alt = empty( $alt_prefix ) ? &nbsp;</div></li><li><div>                                  $alt : $alt_prefix.' '.$alt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment">// add a period after the image alt text if missing</span>&nbsp;</div></li><li><div>                              $alt_text .= ( strpos( $alt, '.' ) + 1 ) === strlen( $alt ) ? &nbsp;</div></li><li><div>                                  $alt.' ' : $alt.'. ';&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ( $this-&gt;p-&gt;debug-&gt;enabled )&nbsp;</div></li><li><div>                          $this-&gt;p-&gt;debug-&gt;log( 'img alt text: '.$alt_text );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $text = $alt_text;&nbsp;</div></li><li><div>              } else $text = $text_stripped;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $text = preg_replace( '/(\xC2\xA0|\s)+/s', ' ', $text );    <span class="comment">// replace 1+ spaces to a single space</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return trim( $text );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>NextGEN Facebook (NGFB)</li><li><span></span>8.43.0</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>