<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.0.1.2" data-slug="membership-2" data-type="file" data-id="22373"><head xmlns="http://www.w3.org/1999/xhtml"><title> app-old-membershipincludes-includes-default-rules | file | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, membership-2, 4.0.1.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.19"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=83709bab44e552647ddc416cfae7da71' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.19' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/app-old-membershipincludes-includes-default-rules/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fapp-old-membershipincludes-includes-default-rules%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fapp-old-membershipincludes-includes-default-rules%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.2-file-app-old-membershipincludes-includes-default-rules","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="app-old-membershipincludes-includes-default-rules" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.2." href="http://hookr.io/plugins/membership-2/4.0.1.2/" class="H_VERSION"><span property="name">4.0.1.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/membership-2/4.0.1.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">app-old-membershipincludes-in&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2601"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/all/" title="All">All <span class="count badge">2601</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="1585"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/hooks/" title="Hooks">Hooks <span class="count badge">1585</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1061"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/filters/" title="Filters">Filters <span class="count badge">1061</span></a></li><li class="" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="206"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/functions/" title="Functions">Functions <span class="count badge">206</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/app_old/membershipincludes/includes/default.rules.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Posts extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'posts';&nbsp;</div></li><li><div>  var $label = 'Posts';&nbsp;</div></li><li><div>  var $description = 'Allows specific posts to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-posts'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Posts', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-posts' class='removelink' title='&lt;?php _e(&quot;Remove Posts from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the posts to be covered by this rule by checking the box next to the relevant posts title.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  $args = array(&nbsp;</div></li><li><div>                      'numberposts' =&gt; MEMBERSHIP_POST_COUNT, &nbsp;</div></li><li><div>                      'offset' =&gt; 0, &nbsp;</div></li><li><div>                      'orderby' =&gt; 'post_date', &nbsp;</div></li><li><div>                      'order' =&gt; 'DESC', &nbsp;</div></li><li><div>                      'post_type' =&gt; 'post', &nbsp;</div></li><li><div>                      'post_status' =&gt; 'publish'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $posts = get_posts($args);&nbsp;</div></li><li><div>                  if($posts) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                          &lt;thead&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Post title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-date&quot; id=&quot;date&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Post date', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tfoot&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Post title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-date&quot; id=&quot;date&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Post date', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      foreach($posts as $key =&gt; $post) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;post-&lt;?php echo $post-&gt;ID; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                              &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $post-&gt;ID; ?&gt;&quot; name=&quot;posts[]&quot; &lt;?php if(in_array($post-&gt;ID, $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                              &lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;strong&gt;&lt;?php echo esc_html($post-&gt;post_title); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-date&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                                      echo date(&quot;Y/m/d&quot;, strtotime($post-&gt;post_date));&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                          &lt;/tbody&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;p class='description'&gt;&lt;?php echo sprintf(__(&quot;Only the most recent %d posts are shown above, if you have more than that then you should consider using categories instead.&quot;, 'membership'), MEMBERSHIP_POST_COUNT); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      membership_redirect_to_protected();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_group() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT id FROM &quot; . membership_db_prefix($wpdb, 'urlgroups') . &quot; WHERE groupname = %s ORDER BY id DESC LIMIT 0, 1&quot;, '_posts-' . $this-&gt;level_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($results)) {&nbsp;</div></li><li><div>          return $results;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('pre_get_posts', array(&$this, 'add_viewable_posts'), 99 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_positive_posts'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('pre_get_posts', array(&$this, 'add_unviewable_posts'), 99 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_negative_posts'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_viewable_posts($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$wp_query-&gt;is_singular && empty($wp_query-&gt;query_vars['pagename']) && (!isset($wp_query-&gt;query_vars['post_type']) || in_array($wp_query-&gt;query_vars['post_type'], array('post', '')))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We are in a list rather than on a single post</span>&nbsp;</div></li><li><div>          foreach( (array) $this-&gt;data as $key =&gt; $value ) {&nbsp;</div></li><li><div>              $wp_query-&gt;query_vars['post__in'][] = $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wp_query-&gt;query_vars['post__in'] = array_unique($wp_query-&gt;query_vars['post__in']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// We are on a single post - wait until we get to the_posts</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_unviewable_posts($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$wp_query-&gt;is_singular && empty($wp_query-&gt;query_vars['pagename']) && (!isset($wp_query-&gt;query_vars['post_type']) || in_array($wp_query-&gt;query_vars['post_type'], array('post', '')))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We are on a list rather than on a single post</span>&nbsp;</div></li><li><div>          foreach( (array) $this-&gt;data as $key =&gt; $value ) {&nbsp;</div></li><li><div>              $wp_query-&gt;query_vars['post__not_in'][] = $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wp_query-&gt;query_vars['post__not_in'] = array_unique($wp_query-&gt;query_vars['post__not_in']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// We are on a single post - wait until we get to the_posts</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_negative_posts( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$wp_query-&gt;is_singular || count($posts) &gt; 1) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($posts) && count($posts) == 1) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// we may be on a restricted post so check the URL and redirect if needed</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect = false;&nbsp;</div></li><li><div>          $url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exclude = array();&nbsp;</div></li><li><div>          if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>              $exclude[] = $host;&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($posts as $post) {&nbsp;</div></li><li><div>              if($post-&gt;post_type != 'post') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!in_array(strtolower( get_permalink($post-&gt;ID) ), $exclude)) {&nbsp;</div></li><li><div>                  $url = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check if we have a url available to check</span></span></span></span>&nbsp;</div></li><li><div>          if(empty($url)) {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>          $group_id = $this-&gt;get_group();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group_id) {&nbsp;</div></li><li><div>              $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( !empty($url) && $group-&gt;url_matches( $url ) ) {&nbsp;</div></li><li><div>                  $redirect = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($redirect === true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $this-&gt;redirect();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_positive_posts( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$wp_query-&gt;is_singular || count($posts) &gt; 1) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($posts) && count($posts) == 1) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// we may be on a restricted post so check the URL and redirect if needed</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect = false;&nbsp;</div></li><li><div>          $found = false;&nbsp;</div></li><li><div>          $url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exclude = array();&nbsp;</div></li><li><div>          if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>              $exclude[] = $host;&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($posts as $post) {&nbsp;</div></li><li><div>              if($post-&gt;post_type != 'post') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!in_array(strtolower( get_permalink($post-&gt;ID) ), $exclude)) {&nbsp;</div></li><li><div>                  $url = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check if we have a url available to check</span></span></span></span>&nbsp;</div></li><li><div>          if(empty($url)) {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>          $group_id = $this-&gt;get_group();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group_id) {&nbsp;</div></li><li><div>              $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( $group-&gt;url_matches( $url ) ) {&nbsp;</div></li><li><div>                  $found = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($found !== true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $this-&gt;redirect();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Pages extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'pages';&nbsp;</div></li><li><div>  var $label = 'Pages';&nbsp;</div></li><li><div>  var $description = 'Allows specific pages to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-pages'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Pages', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-pages' class='removelink' title='&lt;?php _e(&quot;Remove Pages from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the Pages to be covered by this rule by checking the box next to the relevant pages title.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  $args = array(&nbsp;</div></li><li><div>                      'numberposts' =&gt; MEMBERSHIP_PAGE_COUNT, &nbsp;</div></li><li><div>                      'offset' =&gt; 0, &nbsp;</div></li><li><div>                      'orderby' =&gt; 'post_date', &nbsp;</div></li><li><div>                      'order' =&gt; 'DESC', &nbsp;</div></li><li><div>                      'post_type' =&gt; 'page', &nbsp;</div></li><li><div>                      'post_status' =&gt; 'publish'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $posts = get_posts($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// to remove bp specified pages - should be listed on the bp pages group</span>&nbsp;</div></li><li><div>                  $posts = apply_filters( 'staypress_hide_protectable_pages', $posts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($posts) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                          &lt;thead&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Page title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tfoot&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Page title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      foreach($posts as $key =&gt; $post) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;post-&lt;?php echo $post-&gt;ID; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                              &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $post-&gt;ID; ?&gt;&quot; name=&quot;pages[]&quot; &lt;?php if(in_array($post-&gt;ID, $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                              &lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;strong&gt;&lt;?php echo esc_html($post-&gt;post_title); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                          &lt;/tbody&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;p class='description'&gt;&lt;?php echo sprintf(__(&quot;Only the most recent %d pages are shown above.&quot;, 'membership'), MEMBERSHIP_PAGE_COUNT); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter('get_pages', array(&$this, 'add_viewable_pages_menu'), 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_positive_pages'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter('get_pages', array(&$this, 'add_unviewable_pages_menu'), 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_negative_pages'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      membership_redirect_to_protected();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_group() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT id FROM &quot; . membership_db_prefix($wpdb, 'urlgroups') . &quot; WHERE groupname = %s ORDER BY id DESC LIMIT 0, 1&quot;, '_pages-' . $this-&gt;level_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($results)) {&nbsp;</div></li><li><div>          return $results;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_viewable_pages($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      print_r($wp_query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!$wp_query-&gt;is_single && !empty($wp_query-&gt;query_vars['post__in'])) {&nbsp;</div></li><li><div>          <span class="comment">// We are not on a single page - so just limit the viewing</span>&nbsp;</div></li><li><div>          foreach( (array) $this-&gt;data as $key =&gt; $value ) {&nbsp;</div></li><li><div>              $wp_query-&gt;query_vars['post__in'][] = $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wp_query-&gt;query_vars['post__in'] = array_unique($wp_query-&gt;query_vars['post__in']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// We are on a single page - so check for restriction on the_posts</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_viewable_pages_menu($pages) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $override_pages = apply_filters( 'membership_override_viewable_pages_menu', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( (array) $pages as $key =&gt; $page ) {&nbsp;</div></li><li><div>          if(!in_array($page-&gt;ID, (array) $this-&gt;data) && !in_array($page-&gt;ID, (array) $override_pages)) {&nbsp;</div></li><li><div>              unset($pages[$key]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $pages;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_unviewable_pages($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_unviewable_pages_menu($pages) {&nbsp;</div></li><li><div>      foreach( (array) $pages as $key =&gt; $page ) {&nbsp;</div></li><li><div>          if(in_array($page-&gt;ID, (array) $this-&gt;data)) {&nbsp;</div></li><li><div>              unset($pages[$key]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $pages;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_negative_pages( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!$wp_query-&gt;is_singular || count($posts) &gt; 1) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($posts) && count($posts) == 1) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// we may be on a restricted post so check the URL and redirect if needed</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect = false;&nbsp;</div></li><li><div>          $url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exclude = array();&nbsp;</div></li><li><div>          if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>              $exclude[] = $host;&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($posts as $post) {&nbsp;</div></li><li><div>              if($post-&gt;post_type != 'page') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!in_array(strtolower( get_permalink($post-&gt;ID) ), $exclude)) {&nbsp;</div></li><li><div>                  $url = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check if we have a url available to check</span></span></span></span>&nbsp;</div></li><li><div>          if(empty($url)) {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>          $group_id = $this-&gt;get_group();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group_id) {&nbsp;</div></li><li><div>              $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( $group-&gt;url_matches( $url ) ) {&nbsp;</div></li><li><div>                  $redirect = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($redirect === true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $this-&gt;redirect();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_positive_pages( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!$wp_query-&gt;is_singular || count($posts) &gt; 1) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($posts) && count($posts) == 1) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// we may be on a restricted post so check the URL and redirect if needed</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect = false;&nbsp;</div></li><li><div>          $found = false;&nbsp;</div></li><li><div>          $url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exclude = array();&nbsp;</div></li><li><div>          if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>              $exclude[] = $host;&nbsp;</div></li><li><div>              $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($posts as $post) {&nbsp;</div></li><li><div>              if($post-&gt;post_type != 'page') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!in_array(strtolower( get_permalink($post-&gt;ID) ), $exclude)) {&nbsp;</div></li><li><div>                  $url = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Check if we have a url available to check</span></span></span></span>&nbsp;</div></li><li><div>          if(empty($url)) {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>          $group_id = $this-&gt;get_group();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group_id) {&nbsp;</div></li><li><div>              $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( $group-&gt;url_matches( $url ) ) {&nbsp;</div></li><li><div>                  $found = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($found !== true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $this-&gt;redirect();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Categories extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'categories';&nbsp;</div></li><li><div>  var $label = 'Categories';&nbsp;</div></li><li><div>  var $description = 'Allows posts to be protected based on their assigned categories.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div class='level-operation' id='main-categories'&gt;&nbsp;</div></li><li><div>              &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Categories', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' class='removelink' id='remove-categories' title='&lt;?php _e(&quot;Remove Categories from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>              &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>                  &lt;p&gt;&lt;?php _e('Select the Categories to be covered by this rule by checking the box next to the relevant categories name.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                      $categories = get_categories('get=all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if($categories) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                              &lt;thead&gt;&nbsp;</div></li><li><div>                                  &lt;tr&gt;&nbsp;</div></li><li><div>                                      &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                      &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Category name', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;tfoot&gt;&nbsp;</div></li><li><div>                                  &lt;tr&gt;&nbsp;</div></li><li><div>                                      &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                      &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Category name', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;tbody&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                                  foreach($categories as $key =&gt; $category) {&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                      &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;post-&lt;?php echo $category-&gt;term_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                              &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $category-&gt;term_id; ?&gt;&quot; name=&quot;categories[]&quot; &lt;?php if(in_array($category-&gt;term_id, $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                                          &lt;/th&gt;&nbsp;</div></li><li><div>                                          &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                              &lt;strong&gt;&lt;?php echo esc_html($category-&gt;name); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                          &lt;/td&gt;&nbsp;</div></li><li><div>                                     &lt;/tr&gt;&nbsp;</div></li><li><div>                                      &lt;?php&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                  &lt;/tbody&gt;&nbsp;</div></li><li><div>                              &lt;/table&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'pre_get_posts', array(&$this, 'add_viewable_posts'), 1 );&nbsp;</div></li><li><div>      add_filter( 'get_terms', array(&$this, 'add_viewable_categories'), 1, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_positive_posts'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('pre_get_posts', array(&$this, 'add_unviewable_posts'), 1 );&nbsp;</div></li><li><div>      add_filter( 'get_terms', array(&$this, 'add_unviewable_categories'), 1, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_posts', array(&$this, 'check_negative_posts'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      membership_redirect_to_protected();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_negative_posts( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_category() && count($posts) == 0 && MEMBERSHIP_REDIRECT_ON_EMPTY_CATEGORYPAGE === true) {&nbsp;</div></li><li><div>          $redirect = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((!$wp_query-&gt;is_singular || count($posts) &gt; 1) && $redirect != true) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($posts as $post) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// should only be one as otherwise the single check above didn't work very well.</span></span>&nbsp;</div></li><li><div>          if($post-&gt;post_type != 'post') {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Not a post so ignore</span></span>&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Check the categories</span></span>&nbsp;</div></li><li><div>              if(has_category( $this-&gt;data, $post )) {&nbsp;</div></li><li><div>                  $redirect = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($redirect === true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          $this-&gt;redirect();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_positive_posts( $posts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_query, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_category() && count($posts) == 0 && MEMBERSHIP_REDIRECT_ON_EMPTY_CATEGORYPAGE === true) {&nbsp;</div></li><li><div>          $redirect = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((!$wp_query-&gt;is_singular || count($posts) &gt; 1) && $redirect != true) {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($posts as $post) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// should only be one as otherwise the single check above didn't work very well.</span></span>&nbsp;</div></li><li><div>          if($post-&gt;post_type != 'post') {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Not a post so ignore</span></span>&nbsp;</div></li><li><div>              return $posts;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Check the categories</span></span>&nbsp;</div></li><li><div>              if(!has_category( $this-&gt;data, $post )) {&nbsp;</div></li><li><div>                  $redirect = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($redirect === true && !empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          $this-&gt;redirect();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $posts;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_viewable_posts($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//print_r($wp_query);</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((isset($wp_query-&gt;query_vars['post_type']) && !in_array($wp_query-&gt;query_vars['post_type'], array('post', ''))) || !empty($wp_query-&gt;query_vars['pagename'])) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( (array) $this-&gt;data as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $wp_query-&gt;query_vars['category__in'][] = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['category__in'] = array_unique($wp_query-&gt;query_vars['category__in']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_unviewable_posts($wp_query) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( (isset($wp_query-&gt;query_vars['post_type']) && !in_array($wp_query-&gt;query_vars['post_type'], array('post', ''))) || !empty($wp_query-&gt;query_vars['pagename'])) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( (array) $this-&gt;data as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $wp_query-&gt;query_vars['category__not_in'][] = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['category__not_in'] = array_unique($wp_query-&gt;query_vars['category__not_in']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_viewable_categories($terms, $taxonomies, $args) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( (array) $terms as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if($value-&gt;taxonomy == 'category') {&nbsp;</div></li><li><div>              if(!in_array($value-&gt;term_id, $this-&gt;data)) {&nbsp;</div></li><li><div>                  unset($terms[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $terms;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_unviewable_categories($terms, $taxonomies, $args) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( (array) $terms as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if($value-&gt;taxonomy == 'category') {&nbsp;</div></li><li><div>              if(in_array($value-&gt;term_id, $this-&gt;data)) {&nbsp;</div></li><li><div>                  unset($terms[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $terms;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_More extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'more';&nbsp;</div></li><li><div>  var $label = 'More tag';&nbsp;</div></li><li><div>  var $description = 'Allows content placed after the More tag to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-more'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('More tag', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' class='removelink' id='remove-more' title='&lt;?php _e(&quot;Remove More tag from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Positive : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User can read full post content beyond the More tag.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Negative : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User is unable to read full post content beyond the More tag.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;input type='hidden' name='more[]' value='yes' /&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options, $wp_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($M_options['moretagdefault']) && $M_options['moretagdefault'] == 'no' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// remove the filters - otherwise we don't need to do anything</span>&nbsp;</div></li><li><div>          if(isset($wp_filter['the_content_more_link'][99])) {&nbsp;</div></li><li><div>              foreach($wp_filter['the_content_more_link'][99] as $key =&gt; $value) {&nbsp;</div></li><li><div>                  if(strstr($key, 'show_moretag_protection') !== false) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content_more_link'][99][$key]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if(empty($wp_filter['the_content_more_link'][99])) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content_more_link'][99]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($wp_filter['the_content'][1])) {&nbsp;</div></li><li><div>              foreach($wp_filter['the_content'][1] as $key =&gt; $value) {&nbsp;</div></li><li><div>                  if(strstr($key, 'replace_moretag_content') !== false) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content'][1][$key]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if(empty($wp_filter['the_content'][1])) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content'][1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($wp_filter['the_content_feed'][1])) {&nbsp;</div></li><li><div>              foreach($wp_filter['the_content_feed'][1] as $key =&gt; $value) {&nbsp;</div></li><li><div>                  if(strstr($key, 'replace_moretag_content') !== false) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content_feed'][1][$key]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if(empty($wp_filter['the_content_feed'][1])) {&nbsp;</div></li><li><div>                      unset($wp_filter['the_content_feed'][1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($M_options['moretagdefault']) && $M_options['moretagdefault'] != 'no' ) {&nbsp;</div></li><li><div>          <span class="comment">// add the filters - otherwise we don't need to do anything</span>&nbsp;</div></li><li><div>          add_filter('the_content_more_link', array(&$this, 'show_moretag_protection'), 99, 2);&nbsp;</div></li><li><div>          add_filter('the_content', array(&$this, 'replace_moretag_content'), 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function show_moretag_protection($more_tag_link, $more_tag) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return stripslashes($M_options['moretagmessage']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function replace_moretag_content($the_content) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $morestartsat = strpos($the_content, '&lt;span id=&quot;more-');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($morestartsat !== false) {&nbsp;</div></li><li><div>          $the_content = substr($the_content, 0, $morestartsat);&nbsp;</div></li><li><div>          $the_content .= stripslashes($M_options['moretagmessage']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $the_content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Comments extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'comments';&nbsp;</div></li><li><div>  var $label = 'Comments';&nbsp;</div></li><li><div>  var $description = 'Allows the display of, or ability to comment on posts to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-comments'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Comments', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-comments' class='removelink' title='&lt;?php _e(&quot;Remove Comments from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Positive : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User gets read and make comments of posts.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Negative : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User can not read or comment on posts.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;input type='hidden' name='comments[]' value='yes' /&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter('comments_open', array(&$this, 'open_comments'), 99, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter('comments_open', array(&$this, 'close_comments'), 99, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(defined('MEMBERSHIP_VIEW_COMMENTS') && MEMBERSHIP_VIEW_COMMENTS == true) {&nbsp;</div></li><li><div>          <span class="comment">// We want users to be able to see the comments but not add to them</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          add_filter( 'comments_array', array(&$this, 'hide_comments'), 99, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function hide_comments($comments, $post_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function close_comments($open, $postid) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function open_comments($open, $postid) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $open;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Downloads extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'downloads';&nbsp;</div></li><li><div>  var $label = 'Downloads';&nbsp;</div></li><li><div>  var $description = 'Allows media uploaded to the WordPress media library to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-downloads'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Downloads', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-downloads' class='removelink' title='&lt;?php _e(&quot;Remove Downloads from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the Downloads / Media to be covered by this rule by checking the box next to the relevant group name.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  $mediasql = $wpdb-&gt;prepare( &quot;SELECT post_id FROM {$wpdb-&gt;postmeta} WHERE meta_key = %s&quot;, '_membership_protected_content' );&nbsp;</div></li><li><div>                  $mediaids = $wpdb-&gt;get_col( $mediasql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!empty($mediaids)) {&nbsp;</div></li><li><div>                      <span class="comment">// We have some ids so grab the information</span>&nbsp;</div></li><li><div>                      $attachmentsql = $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;posts WHERE post_type = %s AND post_status != %s AND ID IN(&quot; . implode(&quot;, &quot;, $mediaids) . &quot;)&quot;, 'attachment', 'trash' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $attachments = $wpdb-&gt;get_results( $attachmentsql );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                      &lt;thead&gt;&nbsp;</div></li><li><div>                      &lt;tr&gt;&nbsp;</div></li><li><div>                          &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Download / Group name', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                      &lt;/thead&gt;&nbsp;</div></li><li><div>                      &lt;tfoot&gt;&nbsp;</div></li><li><div>                      &lt;tr&gt;&nbsp;</div></li><li><div>                          &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Download / Group name', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                      &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;tbody&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      if(!empty($M_options['membershipdownloadgroups'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($M_options['membershipdownloadgroups'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                              if(!empty($value)) {&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;group-&lt;?php echo esc_attr(stripslashes(trim($value))); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr(stripslashes(trim($value))); ?&gt;&quot; name=&quot;downloads[]&quot; &lt;?php if(in_array(esc_attr(stripslashes(trim($value))), $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                                      &lt;/th&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;strong&gt;&lt;?php echo esc_html(stripslashes(trim($value))); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                      &lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;group-nogroup&quot;&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-name&quot; colspan='2'&gt;&nbsp;</div></li><li><div>                                  &lt;?php echo __('You have no download groups set, please visit the membership options page to set them up.', 'membership'); ?&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;/tbody&gt;&nbsp;</div></li><li><div>                  &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function can_view_download($area, $group) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch($area) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'positive':    if(in_array($group, (array) $this-&gt;data)) {&nbsp;</div></li><li><div>                                  return true;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'negative':    if(in_array($group, (array) $this-&gt;data)) {&nbsp;</div></li><li><div>                                  return false;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//shortcode_tags</span>&nbsp;</div></li><li><div>class M_Shortcodes extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'shortcodes';&nbsp;</div></li><li><div>  var $label = 'Shortcodes';&nbsp;</div></li><li><div>  var $description = 'Allows specific shortcodes and contained content to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-shortcodes'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Shortcodes', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-shortcodes' class='removelink' title='&lt;?php _e(&quot;Remove Shortcodes from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the Shortcodes to be covered by this rule by checking the box next to the relevant shortcode tag.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  if($shortcode_tags) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                          &lt;thead&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                  &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Shortcode tag', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tfoot&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                  &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Shortcode tag', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                              foreach($shortcode_tags as $key =&gt; $function) {&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;post-&lt;?php echo $key; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr(trim($key)); ?&gt;&quot; name=&quot;shortcodes[]&quot; &lt;?php if(in_array(trim($key), $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                                      &lt;/th&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;strong&gt;[&lt;?php echo esc_html(trim($key)); ?&gt;]&lt;/strong&gt;&nbsp;</div></li><li><div>                                      &lt;/td&gt;&nbsp;</div></li><li><div>                                 &lt;/tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                              &lt;/tbody&gt;&nbsp;</div></li><li><div>                          &lt;/table&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_creation() {&nbsp;</div></li><li><div>      <span class="comment">//add_filter('the_content', array(&$this, 'override_shortcodes'), 1);</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function override_shortcodes() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_shortcode_tags, $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $M_shortcode_tags = $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($shortcode_tags as $key =&gt; $function) {&nbsp;</div></li><li><div>          if($key != 'subscriptionform') {&nbsp;</div></li><li><div>              $shortcode_tags[$key] = array(&$this, 'do_protected_shortcode');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options, $M_shortcode_tags, $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($M_options['shortcodedefault'] == 'no' ) {&nbsp;</div></li><li><div>          <span class="comment">// Need to re-enable some shortcodes</span>&nbsp;</div></li><li><div>          foreach( (array) $data as $key =&gt; $code ) {&nbsp;</div></li><li><div>              if(isset($M_shortcode_tags[$code]) && isset($shortcode_tags[$code])) {&nbsp;</div></li><li><div>                  $shortcode_tags[$code] = $M_shortcode_tags[$code];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options, $M_shortcode_tags, $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $M_shortcode_tags = $shortcode_tags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($M_options['shortcodedefault'] != 'no' ) {&nbsp;</div></li><li><div>          <span class="comment">// Need to disable some shortcodes</span>&nbsp;</div></li><li><div>          foreach( (array) $data as $key =&gt; $code ) {&nbsp;</div></li><li><div>              if(isset($M_shortcode_tags[$code]) && isset($shortcode_tags[$code])) {&nbsp;</div></li><li><div>                  if($code != 'subscriptionform') {&nbsp;</div></li><li><div>                      $shortcode_tags[$code] = array(&$this, 'do_protected_shortcode');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Show the protected shortcode message</span>&nbsp;</div></li><li><div>  function do_protected_shortcode($atts, $content = null, $code = &quot;&quot;) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return stripslashes($M_options['shortcodemessage']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Menu extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'menu';&nbsp;</div></li><li><div>  var $label = 'Menu';&nbsp;</div></li><li><div>  var $description = 'Allows specific menu items to be protected.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-menu'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Menu', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-menu' class='removelink' title='&lt;?php _e(&quot;Remove Menu from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the Menu items to be covered by this rule by checking the box next to the relevant menu labels.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $navs = wp_get_nav_menus( array('orderby' =&gt; 'name') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!empty($navs)) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                          &lt;thead&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Menu / Item title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tfoot&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('Menu / Item title', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      foreach($navs as $key =&gt; $nav) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;menu-&lt;?php echo $nav-&gt;term_id; ?&gt;-0&quot;&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-name&quot; colspan='2'&gt;&nbsp;</div></li><li><div>                                  &lt;strong&gt;&lt;?php echo __('MENU', 'membership') . &quot; - &quot; . esc_html($nav-&gt;name); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                          $items = wp_get_nav_menu_items($nav-&gt;term_id);&nbsp;</div></li><li><div>                          if(!empty($items)) {&nbsp;</div></li><li><div>                              foreach($items as $ikey =&gt; $item) {&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;menu-&lt;?php <span class="comment">//echo $nav-&gt;term_id . '-'; ?&gt;&lt;?php echo $item-&gt;ID; ?&gt;&quot;&gt;</span>&nbsp;</div></li><li><div>                                      &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                          &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php <span class="comment">//echo $nav-&gt;term_id . '-'; ?&gt;&lt;?php echo $item-&gt;ID; ?&gt;&quot; name=&quot;menu[]&quot; &lt;?php if(in_array($item-&gt;ID, $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;</span>&nbsp;</div></li><li><div>                                      &lt;/th&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          &lt;strong&gt;&nbsp;&#8211;&nbsp;&lt;?php if($item-&gt;menu_item_parent != 0) echo &quot;&#8211;&nbsp;&quot;; ?&gt;&lt;?php echo esc_html($item-&gt;title); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                      &lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                          &lt;/tbody&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wp_get_nav_menu_items', array(&$this, 'filter_viewable_menus'), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wp_get_nav_menu_items', array(&$this, 'filter_unviewable_menus'), 10, 3 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_viewable_menus($items, $menu, $args) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($items)) {&nbsp;</div></li><li><div>          foreach($items as $key =&gt; $item) {&nbsp;</div></li><li><div>              if(!in_array($item-&gt;ID, $this-&gt;data) || ($item-&gt;menu_item_parent != 0 && !in_array($item-&gt;menu_item_parent, $this-&gt;data))) {&nbsp;</div></li><li><div>                  unset($items[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_unviewable_menus($items, $menu, $args) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($items)) {&nbsp;</div></li><li><div>          foreach($items as $key =&gt; $item) {&nbsp;</div></li><li><div>              if(in_array($item-&gt;ID, $this-&gt;data) || ($item-&gt;menu_item_parent != 0 && in_array($item-&gt;menu_item_parent, $this-&gt;data))) {&nbsp;</div></li><li><div>                  unset($items[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_Blogcreation extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'blogcreation';&nbsp;</div></li><li><div>  var $label = 'Blog Creation';&nbsp;</div></li><li><div>  var $description = 'Allows the creation of blogs to be limited to members.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'core';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-blogcreation'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('Blog Creation', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-blogcreation' class='removelink' title='&lt;?php _e(&quot;Remove Blog Creation from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  if(!isset($data['number'])) {&nbsp;</div></li><li><div>                      $data['number'] = '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Positive : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User can create ', 'membership'); ?&gt;&lt;input type='text' name='blogcreation[number]' value='&lt;?php echo esc_attr($data['number']); ?&gt;' /&gt;&lt;?php _e(' blogs.', 'membership'); ?&gt;&lt;br/&gt;&lt;em&gt;&lt;?php _e('Leave blank for unlimited blogs.', 'membership'); ?&gt;&lt;/em&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php _e('Negative : ', 'membership'); ?&gt;&lt;/strong&gt;&lt;?php _e('User is unable to create any blogs.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;input type='hidden' name='blogcreation[]' value='yes' /&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_creation() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'site_option_registration', array(&$this, 'pos_blog_creation'));&nbsp;</div></li><li><div>      add_filter( 'wpmu_active_signup', array(&$this, 'pos_blog_creation') );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'site_option_registration', array(&$this, 'neg_blog_creation'));&nbsp;</div></li><li><div>      add_filter( 'wpmu_active_signup', array(&$this, 'neg_blog_creation') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function neg_blog_creation( $active = 'all' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($active == 'user' || $active == 'none') {&nbsp;</div></li><li><div>          return $active;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return 'none';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function pos_blog_creation( $active = 'all' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($active == 'user' || $active == 'none') {&nbsp;</div></li><li><div>          return $active;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Check our count</span>&nbsp;</div></li><li><div>          if(empty($this-&gt;data['number'])) {&nbsp;</div></li><li><div>              <span class="comment">//  unlimited</span>&nbsp;</div></li><li><div>              return $active;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $thelimit = (int) $this-&gt;data['number'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( $thelimit &gt; (int) $this-&gt;current_blog_count() ) {&nbsp;</div></li><li><div>                  return $active;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return $this-&gt;neg_blog_creation( $active );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function current_blog_count() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $member, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($member) && method_exists($member, 'has_cap')) {&nbsp;</div></li><li><div>          <span class="comment">// We have a member and it is a correct object</span>&nbsp;</div></li><li><div>          $count = 0;&nbsp;</div></li><li><div>          $blogs = get_blogs_of_user( $member-&gt;ID );&nbsp;</div></li><li><div>          foreach( $blogs as $blog ) {&nbsp;</div></li><li><div>              if( $this-&gt;is_user_blog_admin( $member-&gt;ID, $blog-&gt;userblog_id ) ) {&nbsp;</div></li><li><div>                  $count++;&nbsp;</div></li><li><div>               }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return (int) $count;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_user_blog_admin( $user_id, $blog_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $meta_key = $wpdb-&gt;base_prefix . $blog_id . &quot;_capabilities&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $role_sql = $wpdb-&gt;prepare( &quot;SELECT user_id, meta_value FROM {$wpdb-&gt;usermeta} WHERE meta_key = %s&quot;, $meta_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $role = $wpdb-&gt;get_results( $role_sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//clean the role</span>&nbsp;</div></li><li><div>      foreach($role as $key =&gt; $r) {&nbsp;</div></li><li><div>          $role[$key]-&gt;meta_value = maybe_unserialize($r-&gt;meta_value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($role as $key =&gt; $r) {&nbsp;</div></li><li><div>          if( $r-&gt;meta_value['administrator'] == 1 && $r-&gt;user_id == $user_id ) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class M_URLGroups extends M_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $name = 'urlgroups';&nbsp;</div></li><li><div>  var $label = 'URL Groups';&nbsp;</div></li><li><div>  var $description = &quot;Allows specific URL's to be protected (includes ability to protect using regular expressions).&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $rulearea = 'core';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_groups() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM &quot; . membership_db_prefix($wpdb, 'urlgroups') . &quot; WHERE groupname NOT LIKE (%s) ORDER BY id ASC&quot;, '\_%' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($results)) {&nbsp;</div></li><li><div>          return $results;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_main($data) {&nbsp;</div></li><li><div>      if(!$data) $data = array();&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='level-operation' id='main-urlgroups'&gt;&nbsp;</div></li><li><div>          &lt;h2 class='sidebar-name'&gt;&lt;?php _e('URL Groups', 'membership');?&gt;&lt;span&gt;&lt;a href='#remove' id='remove-urlgroups' class='removelink' title='&lt;?php _e(&quot;Remove URL Groups from this rules area.&quot;, 'membership'); ?&gt;'&gt;&lt;?php _e('Remove', 'membership'); ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;div class='inner-operation'&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php _e('Select the URL Groups to be covered by this rule by checking the box next to the relevant URL Group name.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>                  $urlgroups = $this-&gt;get_groups();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!empty($urlgroups)) {&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                          &lt;thead&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('URL Group', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tfoot&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th style=&quot;&quot; class=&quot;manage-column column-name&quot; id=&quot;name&quot; scope=&quot;col&quot;&gt;&lt;?php _e('URL Group', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      foreach($urlgroups as $key =&gt; $urlgroup) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;urlgroup-&lt;?php echo $urlgroup-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                              &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $urlgroup-&gt;id; ?&gt;&quot; name=&quot;urlgroups[]&quot; &lt;?php if(in_array($urlgroup-&gt;id, $data)) echo 'checked=&quot;checked&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>                              &lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;strong&gt;&lt;?php echo esc_html($urlgroup-&gt;groupname); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                              &lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                          &lt;/tbody&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_positive($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'pre_get_posts', array(&$this, 'positive_check_request'), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function on_negative($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'pre_get_posts', array(&$this, 'negative_check_request'), 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function positive_check_request($wp) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $M_options, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect = false;&nbsp;</div></li><li><div>      $found = false;&nbsp;</div></li><li><div>      $host = '';&nbsp;</div></li><li><div>      if(is_ssl()) {&nbsp;</div></li><li><div>          $host = &quot;https:<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&quot;;</span></span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $host = &quot;http:<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&quot;;</span></span></span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $host .= $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $exclude = array();&nbsp;</div></li><li><div>      if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>          $exclude[] = $host;&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>      foreach((array) $this-&gt;data as $group_id) {&nbsp;</div></li><li><div>          $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group-&gt;url_matches( $host ) && !in_array(strtolower($host), $exclude)) {&nbsp;</div></li><li><div>              <span class="comment">// We've found a pge in the positive rules so can let the user see it</span>&nbsp;</div></li><li><div>              $found = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($found !== true) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          $this-&gt;redirect();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function negative_check_request($wp) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect = false;&nbsp;</div></li><li><div>      $host = '';&nbsp;</div></li><li><div>      if(is_ssl()) {&nbsp;</div></li><li><div>          $host = &quot;https:<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&quot;;</span></span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $host = &quot;http:<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&quot;;</span></span></span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $host .= $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $exclude = array();&nbsp;</div></li><li><div>      if(!empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['registration_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['registration_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($M_options['account_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['account_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['account_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>          $exclude[] = get_permalink( (int) $M_options['nocontent_page'] );&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit(get_permalink( (int) $M_options['nocontent_page'] ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($wp_query-&gt;query_vars['protectedfile']) && !$forceviewing) {&nbsp;</div></li><li><div>          $exclude[] = $host;&nbsp;</div></li><li><div>          $exclude[] = untrailingslashit($host);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we have the current page / url - get the groups selected</span></span></span></span></span></span>&nbsp;</div></li><li><div>      foreach((array) $this-&gt;data as $group_id) {&nbsp;</div></li><li><div>          $group = new M_Urlgroup( $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($group-&gt;url_matches( $host ) && !in_array(strtolower($host), $exclude)) {&nbsp;</div></li><li><div>              $redirect = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($redirect === true) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// we need to redirect</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          $this-&gt;redirect();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      membership_redirect_to_protected();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function M_setup_default_rules() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  M_register_rule('downloads', 'M_Downloads', 'content');&nbsp;</div></li><li><div>  M_register_rule('comments', 'M_Comments', 'main');&nbsp;</div></li><li><div>  M_register_rule('more', 'M_More', 'main');&nbsp;</div></li><li><div>  M_register_rule('categories', 'M_Categories', 'main');&nbsp;</div></li><li><div>  M_register_rule('pages', 'M_Pages', 'main');&nbsp;</div></li><li><div>  M_register_rule('posts', 'M_Posts', 'main');&nbsp;</div></li><li><div>  M_register_rule('shortcodes', 'M_Shortcodes', 'content');&nbsp;</div></li><li><div>  M_register_rule('menu', 'M_Menu', 'main');&nbsp;</div></li><li><div>  M_register_rule('urlgroups', 'M_URLGroups', 'main');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(is_multisite()) {&nbsp;</div></li><li><div>      M_register_rule('blogcreation', 'M_Blogcreation', 'admin');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('plugins_loaded', 'M_setup_default_rules', 99);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>