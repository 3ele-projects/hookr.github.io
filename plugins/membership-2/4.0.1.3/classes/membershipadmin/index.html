<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="4.0.1.3" data-slug="membership-2" data-type="class" data-id="23211"><head xmlns="http://www.w3.org/1999/xhtml"><title> membershipadmin | class | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="membershipadmin, class, plugin, membership-2, 4.0.1.3" /><meta name="description" content="The Membership 2 membershipadmin class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=e84c99ea8eaeef64f44b17d0574df443' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/membershipadmin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fmembershipadmin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fmembershipadmin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.3-class-membershipadmin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="membershipadmin" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.3." href="http://hookr.io/plugins/membership-2/4.0.1.3/" class="H_VERSION"><span property="name">4.0.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">membershipadmin</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2618"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/all/" title="All">All <span class="count badge">2618</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="1601"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/hooks/" title="Hooks">Hooks <span class="count badge">1601</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1077"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/filters/" title="Filters">Filters <span class="count badge">1077</span></a></li><li class="active" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="207"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/functions/" title="Functions">Functions <span class="count badge">207</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>membershipadmin</strong></h1><p>The Membership 2 <strong>membershipadmin</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/membership-2/4.0.1.3/files/app-old-membershipincludes-classes-membershipadmin/" class="file">/app_old/membershipincludes/classes/membershipadmin.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="4" class="block" start="4"><li><div>class membershipadmin {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $build = 14;&nbsp;</div></li><li><div>    var $db;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    var $showposts = 25;&nbsp;</div></li><li><div>    var $showpages = 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $tables = array('membership_levels', 'membership_rules', 'subscriptions', 'subscriptions_levels', 'membership_relationships', 'membermeta', 'communications', 'urlgroups', 'ping_history', 'pings', 'coupons');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $membership_levels;&nbsp;</div></li><li><div>    var $membership_rules;&nbsp;</div></li><li><div>    var $membership_relationships;&nbsp;</div></li><li><div>    var $subscriptions;&nbsp;</div></li><li><div>    var $subscriptions_levels;&nbsp;</div></li><li><div>    var $membermeta;&nbsp;</div></li><li><div>    var $communications;&nbsp;</div></li><li><div>    var $urlgroups;&nbsp;</div></li><li><div>    var $ping_history;&nbsp;</div></li><li><div>    var $pings;&nbsp;</div></li><li><div>    var $coupons;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Class variable to hold a link to the tooltips class&nbsp;</div></li><li><div>    var $_tips;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The Wizard&nbsp;</div></li><li><div>    var $potter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The tutorial&nbsp;</div></li><li><div>    var $tutorial;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Coupons&nbsp;</div></li><li><div>    var $_coupons;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // For the coupons datepicker&nbsp;</div></li><li><div>    var $language;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;db =& $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($this-&gt;tables as $table) {&nbsp;</div></li><li><div>            $this-&gt;$table = membership_db_prefix($this-&gt;db, $table);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Instantiate the tooltips class and set the icon&nbsp;</div></li><li><div>        $this-&gt;_tips = new WpmuDev_HelpTooltips();&nbsp;</div></li><li><div>        $this-&gt;_tips-&gt;set_icon_url(membership_url('membershipincludes/images/information.png'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initiate the wizard class&nbsp;</div></li><li><div>        $this-&gt;potter = new M_Wizard();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add administration actions&nbsp;</div></li><li><div>        add_action('init', array(&$this, 'initialise_plugin'), 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add in admin area membership levels&nbsp;</div></li><li><div>        add_action('init', array(&$this, 'initialise_membership_protection'), 999);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( (function_exists('is_plugin_active_for_network') && is_plugin_active_for_network('membership/membership.php')) && (defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true)) {&nbsp;</div></li><li><div>            add_action('network_admin_menu', array(&$this, 'add_admin_menu'));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            add_action('admin_menu', array(&$this, 'add_admin_menu'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'plugins_loaded', array(&$this, 'load_textdomain'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Header actions for users page&nbsp;</div></li><li><div>        add_action( 'load-users.php', array(&$this, 'add_header_users_page'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Custom header actions&nbsp;</div></li><li><div>        add_action('load-toplevel_page_membership', array(&$this, 'add_admin_header_membership'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipmembers', array(&$this, 'add_admin_header_members'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershiplevels', array(&$this, 'add_admin_header_membershiplevels'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipsubs', array(&$this, 'add_admin_header_membershipsubs'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipcoupons', array(&$this, 'add_admin_header_membershipcoupons'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipgateways', array(&$this, 'add_admin_header_membershipgateways'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipoptions', array(&$this, 'add_admin_header_membershipoptions'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipcommunication', array(&$this, 'add_admin_header_membershipcommunication'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershipurlgroups', array(&$this, 'add_admin_header_membershipurlgroups'));&nbsp;</div></li><li><div>        add_action('load-membership_page_membershippings', array(&$this, 'add_admin_header_membershippings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action('load-users_page_membershipuser', array(&$this, 'add_admin_header_membershipuser'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter('membership_level_sections', array(&$this, 'default_membership_sections'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Media management additional fields&nbsp;</div></li><li><div>        add_filter('attachment_fields_to_edit', array(&$this, 'add_media_protection_settings'), 99, 2);&nbsp;</div></li><li><div>        add_filter('attachment_fields_to_save', array(&$this, 'save_media_protection_settings'), 99, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // rewrites&nbsp;</div></li><li><div>        add_action('generate_rewrite_rules', array(&$this, 'add_rewrites'));&nbsp;</div></li><li><div>        add_filter('query_vars', array(&$this, 'add_queryvars') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // profile field for feeds&nbsp;</div></li><li><div>        add_action('show_user_profile', array(&$this, 'add_profile_feed_key') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Pings&nbsp;</div></li><li><div>        add_action('membership_subscription_form_after_levels', array(&$this, 'show_subscription_ping_information'));&nbsp;</div></li><li><div>        add_action('membership_subscription_add', array(&$this, 'update_subscription_ping_information'));&nbsp;</div></li><li><div>        add_action('membership_subscription_update', array(&$this, 'update_subscription_ping_information'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action('membership_level_form_after_rules', array(&$this, 'show_level_ping_information'));&nbsp;</div></li><li><div>        add_action('membership_level_add', array(&$this, 'update_level_ping_information'));&nbsp;</div></li><li><div>        add_action('membership_level_update', array(&$this, 'update_level_ping_information'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ajax calls have to go here because admin-ajax.php is an admin call even though we're calling it from the front end.&nbsp;</div></li><li><div>        add_action( 'wp_ajax_nopriv_buynow', array(&$this, 'popover_signup_form') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //login and register are no-priv only because, well they aren't logged in or registered&nbsp;</div></li><li><div>        add_action( 'wp_ajax_nopriv_register_user', array(&$this, 'popover_register_process') );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_nopriv_login_user', array(&$this, 'popover_login_process') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if logged in:&nbsp;</div></li><li><div>        add_action( 'wp_ajax_buynow', array(&$this, 'popover_sendpayment_form') );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_extra_form', array(&$this, 'popover_extraform_process') );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_register_user', array(&$this, 'popover_register_process') );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_login_user', array(&$this, 'popover_login_process') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Helper actions&nbsp;</div></li><li><div>        add_action( 'membership_activate_addon', array(&$this, 'activate_addon'), 10, 1 );&nbsp;</div></li><li><div>        add_action( 'membership_deactivate_addon', array(&$this, 'deactivate_addon'), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Level shortcodes filters&nbsp;</div></li><li><div>        add_filter( 'membership_level_shortcodes', array(&$this, 'build_level_shortcode_list' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'plugins_loaded', array(&$this, 'load_tutorial'), 11); //init tutorial after translation loaded&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove relationships when user gets deleted&nbsp;</div></li><li><div>        add_action( 'delete_user', array(&$this, 'remove_relationships_on_delete' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function membershipadmin() {&nbsp;</div></li><li><div>        $this-&gt;__construct();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function load_textdomain() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $locale = apply_filters( 'membership_locale', get_locale() );&nbsp;</div></li><li><div>        $mofile = membership_dir( &quot;membershipincludes/languages/membership-$locale.mo&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( file_exists( $mofile ) ) {&nbsp;</div></li><li><div>            load_textdomain( 'membership', $mofile );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //setup language code for jquery datepicker translation&nbsp;</div></li><li><div>        $temp_locales = explode('_', get_locale());&nbsp;</div></li><li><div>          $this-&gt;language = ($temp_locales[0]) ? $temp_locales[0] : 'en';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function load_tutorial() {&nbsp;</div></li><li><div>        // Add in pointer tutorial&nbsp;</div></li><li><div>        $this-&gt;tutorial = new M_Tutorial();&nbsp;</div></li><li><div>        $this-&gt;tutorial-&gt;serve();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function initialise_plugin() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $user, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $installed = get_option('M_Installed', false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($user) || !method_exists($user, 'has_cap')) {&nbsp;</div></li><li><div>            $user = wp_get_current_user();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($installed === false || $installed != $this-&gt;build) {&nbsp;</div></li><li><div>            include_once(membership_dir('membershipincludes/classes/upgrade.php') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            M_Upgrade($installed);&nbsp;</div></li><li><div>            update_option('M_Installed', $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add in our new capability&nbsp;</div></li><li><div>            if(!$user-&gt;has_cap('membershipadmin') && defined('MEMBERSHIP_SETACTIVATORAS_ADMIN') && MEMBERSHIP_SETACTIVATORAS_ADMIN == 'yes') {&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmin');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;create_defaults();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add in our new capability&nbsp;</div></li><li><div>        if($user-&gt;user_login == MEMBERSHIP_MASTER_ADMIN && !$user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>            $user-&gt;add_cap('membershipadmin');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update the membership capabillities for the new layout&nbsp;</div></li><li><div>        if($user-&gt;has_cap('membershipadmin') && !$user-&gt;has_cap('membershipadminupdatepermissions') ) {&nbsp;</div></li><li><div>            // We are here is the user has the old permissions but doesn't have the new default dashboard permissions&nbsp;</div></li><li><div>            // Which likely means that they have not been upgraded - so let's do that :)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $updated = get_user_meta( $user-&gt;ID, 'membership_permissions_updated', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($updated) || $updated != 'yes') {&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmindashboard');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminmembers');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminlevels');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminsubscriptions');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmincoupons');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminpurchases');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmincommunications');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmingroups');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminpings');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmingateways');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminoptions');&nbsp;</div></li><li><div>                // New permissions setting&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminupdatepermissions');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_user_meta( $user-&gt;ID, 'membership_permissions_updated', 'yes');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($user-&gt;has_cap('membershipadminupdatepermissions')) {&nbsp;</div></li><li><div>            // user permissions on the user form&nbsp;</div></li><li><div>            add_filter( 'manage_users_columns', array(&$this, 'add_user_permissions_column') );&nbsp;</div></li><li><div>            add_filter( 'wpmu_users_columns', array(&$this, 'add_user_permissions_column') );&nbsp;</div></li><li><div>            add_filter( 'manage_users_custom_column', array(&$this, 'show_user_permissions_column'), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_action( 'wp_ajax_editusermembershippermissions', array(&$this, 'edit_user_permissions') );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>            // If the user is a membershipadmin user then we can add in notices&nbsp;</div></li><li><div>            add_action('all_admin_notices', array(&$this, 'show_membership_status_notice'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>            if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                $M_options = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', array());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Short codes&nbsp;</div></li><li><div>        if(!empty($M_options['membershipshortcodes'])) {&nbsp;</div></li><li><div>            foreach($M_options['membershipshortcodes'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                if(!empty($value)) {&nbsp;</div></li><li><div>                    add_shortcode(stripslashes(trim($value)), array(&$this, 'do_fake_shortcode') );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Admin only Shortcodes setup&nbsp;</div></li><li><div>        if(!empty($M_options['membershipadminshortcodes'])) {&nbsp;</div></li><li><div>            foreach($M_options['membershipadminshortcodes'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                if(!empty($value)) {&nbsp;</div></li><li><div>                    add_shortcode(stripslashes(trim($value)), array(&$this, 'do_fake_shortcode') );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action('membership_register_shortcodes');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_ajax_m_set_coupon', array(&$this, 'set_membership_coupon_cookie'));&nbsp;</div></li><li><div>        add_action( 'wp_ajax_nopriv_m_set_coupon', array(&$this, 'set_membership_coupon_cookie'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_user_permissions_column( $columns ) {&nbsp;</div></li><li><div>        $columns['membershippermissions'] = __('Permissions', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $columns;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_user_permissions_column( $content, $column_name, $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($column_name == 'membershippermissions') {&nbsp;</div></li><li><div>            // We are on our column&nbsp;</div></li><li><div>            $theuser = get_user_by( 'id', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $perms = array();&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadmindashboard') ) {&nbsp;</div></li><li><div>                $perms[] = __('Dashboard', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminmembers') ) {&nbsp;</div></li><li><div>                $perms[] = __('Members', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminlevels') ) {&nbsp;</div></li><li><div>                $perms[] = __('Levels', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminsubscriptions') ) {&nbsp;</div></li><li><div>                $perms[] = __('Subscriptions', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadmincoupons') ) {&nbsp;</div></li><li><div>                $perms[] = __('Coupons', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminpurchases') ) {&nbsp;</div></li><li><div>                $perms[] = __('Purchases', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadmincommunications') ) {&nbsp;</div></li><li><div>                $perms[] = __('Communications', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadmingroups') ) {&nbsp;</div></li><li><div>                $perms[] = __('URL Groups', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminpings') ) {&nbsp;</div></li><li><div>                $perms[] = __('Pings', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadmingateways') ) {&nbsp;</div></li><li><div>                $perms[] = __('Gateways', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminoptions') ) {&nbsp;</div></li><li><div>                $perms[] = __('Options', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( $theuser-&gt;has_cap('membershipadminupdatepermissions') ) {&nbsp;</div></li><li><div>                $perms[] = __('Permissions', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($perms)) {&nbsp;</div></li><li><div>                $perms[] = __('None', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $content .= implode( ', ', $perms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $content .= '&lt;div class=&quot;row-actions&quot;&gt;';&nbsp;</div></li><li><div>            $content .= '&lt;span class=&quot;edit&quot;&gt;';&nbsp;</div></li><li><div>            $content .= '&lt;a class=&quot;membershipeditlink&quot; href=&quot;' . wp_nonce_url( admin_url(&quot;admin-ajax.php?action=editusermembershippermissions&amp;user_id=&quot; . $user_id . &quot;&quot;), 'edit_user_membership_' . $user_id) . '&quot;&gt;' . __('Edit', 'membership') . '&lt;/a&gt;';&nbsp;</div></li><li><div>            $content .= '&lt;/span&gt;';&nbsp;</div></li><li><div>            $content .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>            if($user-&gt;has_cap('membershipadmin') && !$user-&gt;has_cap('membershipadmincoupons') ) {&nbsp;</div></li><li><div>                // We are here is the user has the old permissions but doesn't have the new default dashboard permissions&nbsp;</div></li><li><div>                // Which likely means that they have not been upgraded - so let's do that :)&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmindashboard');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminmembers');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminlevels');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminsubscriptions');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmincoupons');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminpurchases');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmincommunications');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmingroups');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminpings');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadmingateways');&nbsp;</div></li><li><div>                $user-&gt;add_cap('membershipadminoptions');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Code from this function based on code from AJAX Media Upload function&nbsp;</div></li><li><div>    function edit_user_permissions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        _wp_admin_html_begin();&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;title&gt;&lt;?php _e('Post Indexer Settings', 'postindexer'); ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style( 'colors' );&nbsp;</div></li><li><div>        //wp_enqueue_style( 'media' );&nbsp;</div></li><li><div>        //wp_enqueue_style( 'ie' );&nbsp;</div></li><li><div>        wp_enqueue_script( 'jquery' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action('admin_print_styles');&nbsp;</div></li><li><div>        do_action('admin_print_scripts');&nbsp;</div></li><li><div>        do_action('admin_head');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;/head&gt;&nbsp;</div></li><li><div>        &lt;body&lt;?php if ( isset($GLOBALS['body_id']) ) echo ' id=&quot;' . $GLOBALS['body_id'] . '&quot;'; ?&gt; class=&quot;no-js&quot;&gt;&nbsp;</div></li><li><div>        &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>            document.body.className = document.body.className.replace('no-js', 'js');&nbsp;</div></li><li><div>        &lt;/script&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>            $this-&gt;edit_users_permissions_content();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action('admin_print_footer_scripts');&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;script type=&quot;text/javascript&quot;&gt;if(typeof wpOnload=='function')wpOnload();&lt;/script&gt;&nbsp;</div></li><li><div>        &lt;/body&gt;&nbsp;</div></li><li><div>        &lt;/html&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function edit_users_permissions_content() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( !isset($_GET['user_id'])) {&nbsp;</div></li><li><div>            wp_die( __( 'Cheatin&#8217; uh?' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user_id = $_GET['user_id'];&nbsp;</div></li><li><div>            check_admin_referer( 'edit_user_membership_' . $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>                &lt;form action=&quot;&quot; class=&quot;&quot; id=&quot;membership-form&quot; method='get'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;input type='hidden' name='action' value='updatemembershippermissionsesettings' /&gt;&nbsp;</div></li><li><div>                    &lt;input type='hidden' name='user_id' value='&lt;?php echo $user_id; ?&gt;' /&gt;&nbsp;</div></li><li><div>                    &lt;input type='hidden' name='comefrom' value='&lt;?php echo esc_attr( wp_get_referer() ); ?&gt;' /&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                        wp_nonce_field('membership_update_permissions_settings_' . $user_id);&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;media-title&quot;&gt;&lt;?php echo __(&quot;Membership Permissions&quot;, &quot;membership&quot;); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php _e('Select the areas you want this user to be able to administrate.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;table&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr&gt;&nbsp;</div></li><li><div>                                &lt;th style='min-width: 150px; vertical-align: top;'&gt;&lt;?php _e('Current Permissions', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $theuser = get_user_by( 'id', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $perms = array();&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadmindashboard') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'dashboard';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminmembers') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'members';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminlevels') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'levels';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminsubscriptions') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'subscriptions';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadmincoupons') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'coupons';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminpurchases') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'purchases';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadmincommunications') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'communications';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadmingroups') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'urlgroups';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminpings') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'pings';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadmingateways') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'gateways';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminoptions') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'options';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    if( $theuser-&gt;has_cap('membershipadminupdatepermissions') ) {&nbsp;</div></li><li><div>                                        $perms[] = 'permissions';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $headings = array();&nbsp;</div></li><li><div>                                    $headings['dashboard'] = __('Dashboard', 'membership');&nbsp;</div></li><li><div>                                    $headings['members'] = __('Members', 'membership');&nbsp;</div></li><li><div>                                    $headings['levels'] = __('Levels', 'membership');&nbsp;</div></li><li><div>                                    $headings['subscriptions'] = __('Subscriptions', 'membership');&nbsp;</div></li><li><div>                                    $headings['coupons'] = __('Coupons', 'membership');&nbsp;</div></li><li><div>                                    $headings['purchases'] = __('Purchases', 'membership');&nbsp;</div></li><li><div>                                    $headings['communications'] = __('Communications', 'membership');&nbsp;</div></li><li><div>                                    $headings['urlgroups'] = __('URL Groups', 'membership');&nbsp;</div></li><li><div>                                    $headings['pings'] = __('Pings', 'membership');&nbsp;</div></li><li><div>                                    $headings['gateways'] = __('Gateways', 'membership');&nbsp;</div></li><li><div>                                    $headings['options'] = __('Options', 'membership');&nbsp;</div></li><li><div>                                    $headings['permissions'] = __('Permissions', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;ul style='margin:0; padding:0;'&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    foreach($headings as $heading =&gt; $label) {&nbsp;</div></li><li><div>                                        ?&gt;&nbsp;</div></li><li><div>                                            &lt;li&gt;&lt;label&gt;&lt;input style='margin-top: 0; margin-right: 5px;' type='checkbox' name='membership_permission[]' value='&lt;?php echo $heading; ?&gt;' &lt;?php if(in_array($heading, $perms)) { echo &quot;checked='checked'&quot;; } ?&gt; /&gt;&nbsp;&lt;?php echo $label; ?&gt;&lt;/label&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                                        &lt;?php&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;/ul&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;/tbody&gt;&nbsp;</div></li><li><div>                &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;savebutton ml-submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input name=&quot;save&quot; id=&quot;save&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php _e('Save all changes', 'postindexer'); ?&gt;&quot; type=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_membership_status_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $user, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Membership active check&nbsp;</div></li><li><div>        $membershipactive = M_get_membership_active();&nbsp;</div></li><li><div>        if($membershipactive == 'no') {&nbsp;</div></li><li><div>            echo '&lt;div class=&quot;error fade&quot;&gt;&lt;p&gt;' . sprintf(__(&quot;The Membership plugin is not enabled. To ensure your content is protected you should &lt;a href='%s'&gt;enable it&lt;/a&gt;&quot;, 'membership'), wp_nonce_url(&quot;?page=membership&amp;action=activate&quot;, 'toggle-plugin')) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Membership admin check&nbsp;</div></li><li><div>        if(empty($user) || !method_exists($user, 'has_cap')) {&nbsp;</div></li><li><div>            $user = wp_get_current_user();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>            // Show a notice to say that they are logged in as the membership admin user and protection isn't enabled on the front end&nbsp;</div></li><li><div>            echo '&lt;div class=&quot;update-nag&quot;&gt;' . __(&quot;You are logged in as a &lt;strong&gt;Membership Admin&lt;/strong&gt; user, you will therefore see all protected content on this site.&quot;, 'membership') . '&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_menu() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $menu, $admin_page_hooks;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(current_user_can('membershipadmindashboard')) {&nbsp;</div></li><li><div>            // Add the menu page&nbsp;</div></li><li><div>            add_menu_page(__('Membership', 'membership'), __('Membership', 'membership'), 'membershipadmindashboard', 'membership', array(&$this, 'handle_membership_panel'), membership_url('membershipincludes/images/members.png'));&nbsp;</div></li><li><div>            //echo $hook;&nbsp;</div></li><li><div>            // Fix WP translation hook issue&nbsp;</div></li><li><div>            if(isset($admin_page_hooks['membership'])) {&nbsp;</div></li><li><div>                $admin_page_hooks['membership'] = 'membership';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_top');&nbsp;</div></li><li><div>            // Add the sub menu&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Members', 'membership'), __('All Members', 'membership'), 'membershipadminmembers', &quot;membershipmembers&quot;, array(&$this, 'handle_members_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_members');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership Levels', 'membership'), __('Access Levels', 'membership'), 'membershipadminlevels', &quot;membershiplevels&quot;, array(&$this, 'handle_levels_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_levels');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership Subscriptions', 'membership'), __('Subscription Plans', 'membership'), 'membershipadminsubscriptions', &quot;membershipsubs&quot;, array(&$this, 'handle_subs_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_subscriptions');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership URL Groups', 'membership'), __('URL Groups', 'membership'), 'membershipadmingroups', &quot;membershipurlgroups&quot;, array(&$this, 'handle_urlgroups_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_urlgroups');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership Pings', 'membership'), __('Remote Pings', 'membership'), 'membershipadminpings', &quot;membershippings&quot;, array(&$this, 'handle_pings_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_pings');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership Gateways', 'membership'), __('Payment Gateways', 'membership'), 'membershipadmingateways', &quot;membershipgateways&quot;, array(&$this, 'handle_gateways_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_gateways');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_submenu_page('membership', __('Membership Options', 'membership'), __('Options', 'membership'), 'membershipadminoptions', &quot;membershipoptions&quot;, array(&$this, 'handle_options_panel'));&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_after_options');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action('membership_add_menu_items_bottom');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Admin area protection&nbsp;</div></li><li><div>    function initialise_membership_protection() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $user, $member, $M_options, $M_Rules, $wp_query, $wp_rewrite, $M_active;&nbsp;</div></li><li><div>        // Set up some common defaults&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        static $initialised = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($initialised) {&nbsp;</div></li><li><div>            // ensure that this is only called once, so return if we've been here already.&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>        // Check if the membership plugin is active&nbsp;</div></li><li><div>        $M_active = get_option('membership_active', 'no');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($user) || !method_exists($user, 'has_cap')) {&nbsp;</div></li><li><div>            $user = wp_get_current_user();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!method_exists($user, 'has_cap') || $user-&gt;has_cap('membershipadmin') || $M_active == 'no') {&nbsp;</div></li><li><div>            // Admins can see everything&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Users&nbsp;</div></li><li><div>        $member = new M_Membership($user-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($user-&gt;ID &gt; 0 && $member-&gt;has_levels()) {&nbsp;</div></li><li><div>            // Load the levels for this member - and associated rules&nbsp;</div></li><li><div>            $member-&gt;load_admin_levels( true );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // need to grab the stranger settings&nbsp;</div></li><li><div>            if(isset($M_options['strangerlevel']) && $M_options['strangerlevel'] != 0) {&nbsp;</div></li><li><div>                $member-&gt;assign_admin_level($M_options['strangerlevel'], true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action('membership-admin-add-shortcodes');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set the initialisation status&nbsp;</div></li><li><div>        $initialised = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Add admin headers&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_core() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add in help pages&nbsp;</div></li><li><div>        $screen = get_current_screen();&nbsp;</div></li><li><div>        $help = new M_Help( $screen );&nbsp;</div></li><li><div>        $help-&gt;attach();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add in default style sheet with common styling elements&nbsp;</div></li><li><div>        wp_enqueue_style('defaultcss', membership_url('membershipincludes/css/default.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_header_users_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('thickbox');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_register_script('membership-users-js', membership_url('membershipincludes/js/users.js'), array('jquery', 'thickbox'));&nbsp;</div></li><li><div>        wp_enqueue_script('membership-users-js');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script('membership-users-js', 'membership', array( 'useredittitle' =&gt;    __('Membership Permissions', 'membership') ));&nbsp;</div></li><li><div>        wp_enqueue_style('thickbox');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;process_users_page();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function process_users_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( isset( $_GET['action'] ) ) {&nbsp;</div></li><li><div>            switch( $_GET['action'] ) {&nbsp;</div></li><li><div>                case 'updatemembershippermissionsesettings':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        $user_id = $_GET['user_id'];&nbsp;</div></li><li><div>                                                        //check_admin_referer( 'membership_update_permissions_settings_' . $user_id );&nbsp;</div></li><li><div>                                                        $theuser = get_user_by( 'id', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        if(!empty( $_GET['membership_permission'] )) {&nbsp;</div></li><li><div>                                                            $new = (array) $_GET['membership_permission'];&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $new = array();&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        if( in_array('dashboard', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadmindashboard');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadmindashboard');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('members', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminmembers');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminmembers');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('levels', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminlevels');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminlevels');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('subscriptions', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminsubscriptions');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminsubscriptions');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('coupons', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadmincoupons');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadmincoupons');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('purchases', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminpurchases');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminpurchases');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('communications', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadmincommunications');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadmincommunications');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('urlgroups', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadmingroups');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadmingroups');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('pings', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminpings');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminpings');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('gateways', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadmingateways');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadmingateways');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                        if( in_array('options', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminoptions');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminoptions');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        if( in_array('permissions', $new ) ) {&nbsp;</div></li><li><div>                                                            $theuser-&gt;add_cap('membershipadminupdatepermissions');&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                            $theuser-&gt;remove_cap('membershipadminupdatepermissions');&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        wp_safe_redirect( $_GET['comefrom'] );&nbsp;</div></li><li><div>                                                        break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membership() {&nbsp;</div></li><li><div>        // The dashboard - top level menu&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load the core first&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('dashjs', membership_url('membershipincludes/js/dashboard.js'), array( 'jquery' ), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(version_compare( preg_replace('/-.*$/', '', $wp_version), &quot;3.3&quot;, '&lt;')) {&nbsp;</div></li><li><div>            wp_enqueue_style('dashcss', membership_url('membershipincludes/css/dashboard.css'), array('widgets'), $this-&gt;build);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wp_enqueue_style('dashcss', membership_url('membershipincludes/css/dashboard.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Add localisation for the wizard&nbsp;</div></li><li><div>        wp_localize_script('dashjs', 'membershipwizard', array(    'ajaxurl' =&gt;    admin_url( 'admin-ajax.php' ), &nbsp;</div></li><li><div>                                                                'membershiploading' =&gt; __('Loading...', 'membership'), &nbsp;</div></li><li><div>                                                                'membershipnextstep' =&gt; __('Next Step &raquo;', 'membership'), &nbsp;</div></li><li><div>                                                                'membershipgonewrong' =&gt; __('Something has gone wrong with the Wizard, please try clicking the button again.', 'membership'), &nbsp;</div></li><li><div>                                                                'membershiplevel' =&gt; __('Level', 'membership'), &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_membership_dashboard_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershiplevels() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('levelsjs', membership_url('membershipincludes/js/levels.js'), array( 'jquery-ui-sortable', 'jquery-ui-draggable', 'jquery-ui-droppable' ), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(version_compare( preg_replace('/-.*$/', '', $wp_version), &quot;3.3&quot;, '&lt;')) {&nbsp;</div></li><li><div>            wp_enqueue_style('levelscss', membership_url('membershipincludes/css/levels.css'), array('widgets'), $this-&gt;build);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wp_enqueue_style('levelscss', membership_url('membershipincludes/css/levels.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script( 'levelsjs', 'membership', array(     'deletelevel' =&gt; __('Are you sure you want to delete this level?', 'membership'), &nbsp;</div></li><li><div>                                                                'deactivatelevel' =&gt; __('Are you sure you want to deactivate this level?', 'membership'), &nbsp;</div></li><li><div>                                                                'movetopositive' =&gt; __('Moving to the Positive area will remove any Negative rules you have set - is that ok?', 'membership'), &nbsp;</div></li><li><div>                                                                'movetonegative' =&gt; __('Moving to the Negative area will remove any Positive rules you have set - is that ok?', 'membership')&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_levels_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershipsubs() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        // Run the core header&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Queue scripts and localise&nbsp;</div></li><li><div>        wp_enqueue_script('subsjs', membership_url('membershipincludes/js/subscriptions.js'), array( 'jquery-ui-sortable', 'jquery-ui-draggable', 'jquery-ui-droppable' ), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(version_compare( preg_replace('/-.*$/', '', $wp_version), &quot;3.3&quot;, '&lt;')) {&nbsp;</div></li><li><div>            wp_enqueue_style('subscss', membership_url('membershipincludes/css/subscriptions.css'), array('widgets'), $this-&gt;build);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wp_enqueue_style('subscss', membership_url('membershipincludes/css/subscriptions.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script( 'subsjs', 'membership', array( 'deletesub' =&gt; __('Are you sure you want to delete this subscription?', 'membership'), 'deactivatesub' =&gt; __('Are you sure you want to deactivate this subscription?', 'membership') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_subscriptions_updates();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_members() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        // Run the core header&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('membersjs', membership_url('membershipincludes/js/members.js'), array(), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(version_compare( preg_replace('/-.*$/', '', $wp_version), &quot;3.3&quot;, '&lt;')) {&nbsp;</div></li><li><div>            // Using the level css file for now - maybe switch to a members specific one later&nbsp;</div></li><li><div>            wp_enqueue_style('memberscss', membership_url('membershipincludes/css/levels.css'), array('widgets'), $this-&gt;build);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Using the level css file for now - maybe switch to a members specific one later&nbsp;</div></li><li><div>            wp_enqueue_style('memberscss', membership_url('membershipincludes/css/levels.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script( 'membersjs', 'membership', array( 'deactivatemember' =&gt; __('Are you sure you want to deactivate this member?', 'membership') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_members_updates();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershipgateways() {&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_gateways_panel_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershipoptions() {&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style('optionscss', membership_url('membershipincludes/css/options.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_options_panel_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershipuser() {&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style('optionscss', membership_url('membershipincludes/css/options.css'), array(), $this-&gt;build);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershipurlgroups() {&nbsp;</div></li><li><div>        // Run the core header&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('groupsjs', membership_url('membershipincludes/js/urlgroup.js'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        wp_localize_script( 'groupsjs', 'membership', array( 'deletegroup' =&gt; __('Are you sure you want to delete this url group?', 'membership') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_urlgroups_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_admin_header_membershippings() {&nbsp;</div></li><li><div>        // Run the core header&nbsp;</div></li><li><div>        $this-&gt;add_admin_header_core();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('pingsjs', membership_url('membershipincludes/js/ping.js'), array(), $this-&gt;build);&nbsp;</div></li><li><div>        wp_localize_script( 'pingsjs', 'membership', array( 'deleteping' =&gt; __('Are you sure you want to delete this ping and the associated history?', 'membership') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;handle_ping_updates();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Panel handling functions&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function build_signup_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT YEAR(startdate) as year, MONTH(startdate)as month, DAY(startdate) as day, count(*) AS signedup FROM {$this-&gt;membership_relationships} WHERE startdate &gt; DATE_SUB(CURDATE(), INTERVAL %d DAY) GROUP BY YEAR(startdate), MONTH(startdate), DAY(startdate) ORDER BY startdate DESC&quot;, 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($results)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats = array();&nbsp;</div></li><li><div>            $ticks = array();&nbsp;</div></li><li><div>            $data = array();&nbsp;</div></li><li><div>            foreach($results as $key =&gt; $res) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $stats[strtotime($res-&gt;year . &quot;-&quot; . $res-&gt;month . &quot;-&quot; . $res-&gt;day)] = (int) $res-&gt;signedup;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $startat = time();&nbsp;</div></li><li><div>            for($n = 0; $n &lt; 11; $n++) {&nbsp;</div></li><li><div>                $switch = 10 - $n;&nbsp;</div></li><li><div>                $rdate = strtotime('-' . $switch . ' DAYS', $startat);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $ticks[$n] = '&quot;' . date('n', $rdate) . &quot;/&quot; . date('j', $rdate) . '&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if(isset($stats[strtotime(date(&quot;Y&quot;, $rdate) . &quot;-&quot; . date(&quot;n&quot;, $rdate) . &quot;-&quot; . date(&quot;j&quot;, $rdate))])) {&nbsp;</div></li><li><div>                    $data[$n] = $stats[strtotime(date(&quot;Y&quot;, $rdate) . &quot;-&quot; . date(&quot;n&quot;, $rdate) . &quot;-&quot; . date(&quot;j&quot;, $rdate))];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $data[$n] = 0;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return compact('stats', 'ticks');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function build_levels_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT l.id, l.level_title, count(m.rel_id) as users FROM {$this-&gt;membership_levels} as l, {$this-&gt;membership_relationships} as m WHERE l.id = m.level_id GROUP BY l.id, l.level_title ORDER BY users DESC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($results)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats = array();&nbsp;</div></li><li><div>            $ticks = array();&nbsp;</div></li><li><div>            foreach($results as $key =&gt; $res) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $stats[] = (int) $res-&gt;users;&nbsp;</div></li><li><div>                $ticks[] = '&quot;' . esc_html($res-&gt;level_title) . '&quot;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return compact('stats', 'ticks');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function build_subs_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT s.id, s.sub_name, count(m.rel_id) as users FROM {$this-&gt;subscriptions} as s, {$this-&gt;membership_relationships} as m WHERE s.id = m.sub_id GROUP BY s.id, s.sub_name ORDER BY users DESC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($results)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats = array();&nbsp;</div></li><li><div>            $ticks = array();&nbsp;</div></li><li><div>            foreach($results as $key =&gt; $res) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $stats[] = (int) $res-&gt;users;&nbsp;</div></li><li><div>                $ticks[] = '&quot;' . esc_html($res-&gt;sub_name) . '&quot;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return compact('stats', 'ticks');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_data($results) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( (array) $results as $key =&gt; $res) {&nbsp;</div></li><li><div>            $data[] = &quot;[ &quot; . $key . &quot;, &quot; . $res . &quot; ]&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &quot;[ &quot; . implode(&quot;, &quot;, $data) . &quot; ]&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_membership_dashboard_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page, $action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch($action) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'activate':    check_admin_referer('toggle-plugin');&nbsp;</div></li><li><div>                                update_option('membership_active', 'yes');&nbsp;</div></li><li><div>                                wp_safe_redirect( wp_get_referer() );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'deactivate':    check_admin_referer('toggle-plugin');&nbsp;</div></li><li><div>                                update_option('membership_active', 'no');&nbsp;</div></li><li><div>                                wp_safe_redirect( wp_get_referer() );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:            do_action('membership_dashboard_' . $action);&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script('flot_js', membership_url('membershipincludes/js/jquery.flot.min.js'), array('jquery'));&nbsp;</div></li><li><div>        wp_enqueue_script('mdash_js', membership_url('membershipincludes/js/dashboard.js'), array('jquery'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_localize_script( 'mdash_js', 'membership', array( 'signups' =&gt; __('Signups', 'membership'), 'members' =&gt; __('Members', 'membership') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action ('admin_head', array(&$this, 'dashboard_iehead'));&nbsp;</div></li><li><div>        add_action ('admin_head', array(&$this, 'dashboard_chartdata'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dashboard_chartdata() {&nbsp;</div></li><li><div>        $returned = $this-&gt;build_signup_stats();&nbsp;</div></li><li><div>        $levels = $this-&gt;build_levels_stats();&nbsp;</div></li><li><div>        $subs = $this-&gt;build_subs_stats();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;\n&quot; . '&lt;script type=&quot;text/javascript&quot;&gt;';&nbsp;</div></li><li><div>        echo &quot;\n&quot; . '/* &lt;![CDATA[ */ ' . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;var membershipdata = {\n&quot;;&nbsp;</div></li><li><div>            echo &quot;chartonestats : &quot; . $this-&gt;get_data($returned['stats']) . &quot;, \n&quot;;&nbsp;</div></li><li><div>            echo &quot;chartoneticks : &quot; . $this-&gt;get_data($returned['ticks']) . &quot;, \n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;charttwostats : &quot; . $this-&gt;get_data($levels['stats']) . &quot;, \n&quot;;&nbsp;</div></li><li><div>            echo &quot;charttwoticks : &quot; . $this-&gt;get_data($levels['ticks']) . &quot;, \n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;chartthreestats : &quot; . $this-&gt;get_data($subs['stats']) . &quot;, \n&quot;;&nbsp;</div></li><li><div>            echo &quot;chartthreeticks : &quot; . $this-&gt;get_data($subs['ticks']) . &quot;\n&quot;;&nbsp;</div></li><li><div>        echo &quot;};\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;\n&quot; . '/* ]]&gt; */ ';&nbsp;</div></li><li><div>        echo '&lt;/script&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dashboard_iehead() {&nbsp;</div></li><li><div>        echo '&lt;!--[if IE]&gt;&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;' . membership_url('membershipincludes/js/excanvas.min.js') . '&quot;&gt;&lt;/script&gt;&lt;![endif]--&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dashboard_members() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page, $action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugin = get_plugin_data(membership_dir('membership.php'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $membershipactive = M_get_membership_active();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo __('Membership protection ', 'membership');&nbsp;</div></li><li><div>        echo __(' is ', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Membership active toggle&nbsp;</div></li><li><div>        if($membershipactive == 'no') {&nbsp;</div></li><li><div>            echo '&lt;strong&gt;' . __('disabled', 'membership') . '&lt;/strong&gt; &lt;a id=&quot;enablemembership&quot; href=&quot;' . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=activate&quot;, 'toggle-plugin') . '&quot; title=&quot;' . __('Click here to enable the plugin', 'membership') . '&quot;&gt;' . __('[Enable it]', 'membership') . '&lt;/a&gt;';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            echo '&lt;strong&gt;' . __('enabled', 'membership') . '&lt;/strong&gt; &lt;a id=&quot;enablemembership&quot; href=&quot;' . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=deactivate&quot;, 'toggle-plugin') . '&quot; title=&quot;' . __('Click here to enable the plugin', 'membership') . '&quot;&gt;' . __('[Disable it]', 'membership') . '&lt;/a&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo '&lt;br/&gt;&lt;br/&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;strong&gt;&quot; . __('Member breakdown', 'membership') . &quot;&lt;/strong&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail = $this-&gt;get_subscriptions_and_levels(array('sub_status' =&gt; 'active'));&nbsp;</div></li><li><div>        $subs = $this-&gt;get_subscriptions(array('sub_status' =&gt; 'active'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $levels = $this-&gt;get_membership_levels(array('level_id' =&gt; 'active'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;table style='width: 100%;'&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;td style='width: 48%' valign='top'&gt;&quot;;&nbsp;</div></li><li><div>        if($levels) {&nbsp;</div></li><li><div>            $levelcount = 0;&nbsp;</div></li><li><div>            echo &quot;&lt;table style='width: 100%;'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;td colspan='2'&gt;&lt;strong&gt;&quot; . __('Levels', 'membership') . &quot;&lt;/strong&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                    echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                        echo &quot;&lt;td&gt;&lt;a href='&quot; . admin_url('admin.php?page=membershiplevels&action=edit&level_id=') . $level-&gt;id . &quot;'&gt;&quot; . esc_html($level-&gt;level_title) . &quot;&lt;/a&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                        // find out how many people are in this level&nbsp;</div></li><li><div>                        $thiscount = $this-&gt;count_on_level( $level-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        echo &quot;&lt;td style='text-align: right;'&gt;&quot; . (int) $thiscount . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                        $levelcount += (int) $thiscount;&nbsp;</div></li><li><div>                    echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            echo &quot;&lt;/tbody&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        echo &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;td style='width: 48%' valign='top'&gt;&quot;;&nbsp;</div></li><li><div>        if($subs) {&nbsp;</div></li><li><div>            $subcount = 0;&nbsp;</div></li><li><div>            echo &quot;&lt;table style='width: 100%;'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;td colspan='2'&gt;&lt;strong&gt;&quot; . __('Subscriptions', 'membership') . &quot;&lt;/strong&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                    echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                        echo &quot;&lt;td&gt;&lt;a href='&quot; . admin_url('admin.php?page=membershipsubs&action=edit&sub_id=') . $sub-&gt;id . &quot;'&gt;&quot; . $sub-&gt;sub_name . &quot;&lt;/a&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                        // find out how many people are in this sub&nbsp;</div></li><li><div>                        $thiscount = $this-&gt;count_on_sub( $sub-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        echo &quot;&lt;td style='text-align: right;'&gt;&quot; . (int) $thiscount . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                        $subcount += (int) $thiscount;&nbsp;</div></li><li><div>                    echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            echo &quot;&lt;/tbody&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        echo &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;/tbody&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;br/&gt;&lt;strong&gt;&quot; . __('Member counts', 'membership') . &quot;&lt;/strong&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;table style='width: 100%;'&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;td style='width: 48%' valign='top'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;table style='width: 100%;'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;tbody&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $usercount = $this-&gt;db-&gt;get_var( &quot;SELECT count(*) FROM {$this-&gt;db-&gt;users} INNER JOIN {$this-&gt;db-&gt;usermeta} ON {$this-&gt;db-&gt;users}.ID = {$this-&gt;db-&gt;usermeta}.user_id WHERE {$this-&gt;db-&gt;usermeta}.meta_key = '{$this-&gt;db-&gt;prefix}capabilities'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                    echo &quot;&lt;td&gt;&quot; . __('Total Members', 'membership') . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                    echo &quot;&lt;td style='text-align: right;'&gt;&quot; . $usercount . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $deactivecount = $this-&gt;db-&gt;get_var( $this-&gt;db-&gt;prepare(&quot;SELECT count(*) FROM {$this-&gt;db-&gt;usermeta} WHERE meta_key = %s AND meta_value = %s&quot;, $this-&gt;db-&gt;prefix . 'membership_active' , 'no') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>                    echo &quot;&lt;td&gt;&quot; . __('Deactivated Members', 'membership') . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                    echo &quot;&lt;td style='text-align: right;'&gt;&quot; . $deactivecount . &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>                echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;/tbody&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;td style='width: 48%' valign='top'&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;/tbody&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dashboard_statistics() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;div id='memchartone'&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;div id='memcharttwo'&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;div id='memchartthree'&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'membership_dashboard_statistics' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_membership_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-index&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Membership dashboard', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                $this-&gt;potter-&gt;conditional_show();&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div id=&quot;dashboard-widgets-wrap&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;metabox-holder&quot; id=&quot;dashboard-widgets&quot;&gt;&nbsp;</div></li><li><div>                &lt;div style=&quot;width: 49%;&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;meta-box-sortables ui-sortable&quot; id=&quot;normal-sortables&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;div class=&quot;postbox &quot; id=&quot;dashboard_right_now&quot;&gt;&nbsp;</div></li><li><div>                            &lt;h3 class=&quot;hndle&quot;&gt;&lt;span&gt;&lt;?php _e('Members', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                                &lt;?php $this-&gt;dashboard_members(); ?&gt;&nbsp;</div></li><li><div>                                &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        do_action( 'membership_dashboard_left' );&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div style=&quot;width: 49%;&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;meta-box-sortables ui-sortable&quot; id=&quot;side-sortables&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        do_action( 'membership_dashboard_right_top' );&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;div class=&quot;postbox &quot; id=&quot;dashboard_quick_press&quot;&gt;&nbsp;</div></li><li><div>                            &lt;h3 class=&quot;hndle&quot;&gt;&lt;span&gt;&lt;?php _e('Statistics', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                                &lt;?php $this-&gt;dashboard_statistics(); ?&gt;&nbsp;</div></li><li><div>                                &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        do_action( 'membership_dashboard_right' );&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div style=&quot;display: none; width: 49%;&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;meta-box-sortables ui-sortable&quot; id=&quot;column3-sortables&quot; style=&quot;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div style=&quot;display: none; width: 49%;&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;meta-box-sortables ui-sortable&quot; id=&quot;column4-sortables&quot; style=&quot;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_members_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'toggle' || addslashes($_GET['action2']) == 'toggle') {&nbsp;</div></li><li><div>                $action = 'bulk-toggle';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'removeheader':    $this-&gt;dismiss_user_help( $page );&nbsp;</div></li><li><div>                                    wp_safe_redirect( remove_query_arg( 'action' ) );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'toggle':    if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                $user_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('toggle-member_' . $user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $member = new M_Membership($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if( $member-&gt;toggle_activation() ) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 8, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-toggle':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                            foreach($_GET['users'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $user_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $member = new M_Membership($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $member-&gt;toggle_activation();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkaddlevel-level-complete':&nbsp;</div></li><li><div>            case 'addlevel-level-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $tolevel_id = (int) $_POST['tolevel_id'];&nbsp;</div></li><li><div>                                    if($tolevel_id) {&nbsp;</div></li><li><div>                                        $member-&gt;add_level($tolevel_id);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkdroplevel-level-complete':&nbsp;</div></li><li><div>            case 'droplevel-level-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $fromlevel_id = (int) $_POST['fromlevel_id'];&nbsp;</div></li><li><div>                                    if($fromlevel_id) {&nbsp;</div></li><li><div>                                        $member-&gt;drop_level($fromlevel_id);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkmovelevel-level-complete':&nbsp;</div></li><li><div>            case 'movelevel-level-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $fromlevel_id = (int) $_POST['fromlevel_id'];&nbsp;</div></li><li><div>                                    $tolevel_id = (int) $_POST['tolevel_id'];&nbsp;</div></li><li><div>                                    if($fromlevel_id && $tolevel_id) {&nbsp;</div></li><li><div>                                        $member-&gt;move_level($fromlevel_id, $tolevel_id);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkaddsub-sub-complete':&nbsp;</div></li><li><div>            case 'addsub-sub-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $tosub_id = $_POST['tosub_id'];&nbsp;</div></li><li><div>                                    if($tosub_id) {&nbsp;</div></li><li><div>                                        $subs = explode('-', $tosub_id);&nbsp;</div></li><li><div>                                        if(count($subs) == 3) {&nbsp;</div></li><li><div>                                            $member-&gt;add_subscription($subs[0], $subs[1], $subs[2]);&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>                            $this-&gt;update_subcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkdropsub-sub-complete':&nbsp;</div></li><li><div>            case 'dropsub-sub-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $fromsub_id = (int) $_POST['fromsub_id'];&nbsp;</div></li><li><div>                                    if($fromsub_id) {&nbsp;</div></li><li><div>                                        $member-&gt;drop_subscription($fromsub_id);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>                            $this-&gt;update_subcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkmovesub-sub-complete':&nbsp;</div></li><li><div>            case 'movesub-sub-complete':&nbsp;</div></li><li><div>                            check_admin_referer($action);&nbsp;</div></li><li><div>                            $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                            if($members) {&nbsp;</div></li><li><div>                                foreach($members as $member_id) {&nbsp;</div></li><li><div>                                    $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $fromsub_id = (int) $_POST['fromsub_id'];&nbsp;</div></li><li><div>                                    $tosub_id = $_POST['tosub_id'];&nbsp;</div></li><li><div>                                    if($fromsub_id && $tosub_id) {&nbsp;</div></li><li><div>                                        $subs = explode('-', $tosub_id);&nbsp;</div></li><li><div>                                        if(count($subs) == 3) {&nbsp;</div></li><li><div>                                            $member-&gt;move_subscription($fromsub_id, $subs[0], $subs[1], $subs[2]);&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $this-&gt;update_levelcounts();&nbsp;</div></li><li><div>                            $this-&gt;update_subcounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'bulkmovegateway-gateway-complete':&nbsp;</div></li><li><div>                case 'movegateway-gateway-complete':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer($action);&nbsp;</div></li><li><div>                                $members_id = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $members = explode(', ', $members_id);&nbsp;</div></li><li><div>                                if($members) {&nbsp;</div></li><li><div>                                    foreach($members as $member_id) {&nbsp;</div></li><li><div>                                        $member = new M_Membership($member_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $fromgateway = $_POST['fromgateway'];&nbsp;</div></li><li><div>                                        $togateway = $_POST['togateway'];&nbsp;</div></li><li><div>                                        if(!empty($fromgateway) && !empty($togateway)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            $relationships = $member-&gt;get_relationships();&nbsp;</div></li><li><div>                                            foreach($relationships as $rel) {&nbsp;</div></li><li><div>                                                if($rel-&gt;usinggateway == $fromgateway) {&nbsp;</div></li><li><div>                                                    $member-&gt;update_relationship_gateway( $rel-&gt;rel_id, $fromgateway, $togateway );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_original_referer() ) );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_edit_member() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_member_gateway_op( $operation = 'move', $member_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $action2, $M_Gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page', 'action2') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($action) && !empty($action2)) $action = $action2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gateways = apply_filters('M_gateways_list', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = get_option('membership_activated_gateways', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['fromgateway']) && !empty($_GET['fromgateway'])) {&nbsp;</div></li><li><div>            $fromgateway = stripslashes($_GET['fromgateway']);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $fromgateway = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch($operation) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'move':    $title = __('Move subscription to another gateway', 'membership');&nbsp;</div></li><li><div>                            $formdescription = __('A subscription gateway handles the payment and renewal forms displayed for a subscription. Changing this should not be undertaken lightly, it can seriously mess up the subscriptions of your members.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Gateway to move from for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='fromgateway' id='fromgateway' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the gateway to move from.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='admin'&gt;&quot; . esc_html('admin' . &quot; - &quot; . &quot;admin default gateway&quot;) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            if($gateways) {&nbsp;</div></li><li><div>                                foreach($gateways as $key =&gt; $gateway) {&nbsp;</div></li><li><div>                                    if(in_array($key, $active)) {&nbsp;</div></li><li><div>                                        $html .= &quot;&lt;option value='&quot; . esc_attr($key) . &quot;'&quot;;&nbsp;</div></li><li><div>                                        if( $fromgateway == $key ) {&nbsp;</div></li><li><div>                                            $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        $html .= &quot;&gt;&quot; . esc_html($key . &quot; - &quot; . $gateway) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html .= &quot;&lt;h3&gt;&quot; . __('Gateway to move to for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='togateway' id='togateway' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the gateway to move to.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='admin'&gt;&quot; . esc_html('admin' . &quot; - &quot; . &quot;admin default gateway&quot;) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            reset($gateways);&nbsp;</div></li><li><div>                            if($gateways) {&nbsp;</div></li><li><div>                                foreach($gateways as $key =&gt; $gateway) {&nbsp;</div></li><li><div>                                    if(in_array($key, $active)) {&nbsp;</div></li><li><div>                                        $html .= &quot;&lt;option value='&quot; . esc_attr($key) . &quot;'&gt;&quot; . esc_html($key . &quot; - &quot; . $gateway) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Move&quot;;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php echo $title; ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>            &lt;form action='admin.php?page=&lt;?php echo $page; ?&gt;' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class='level-liquid-left'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='level-left'&gt;&nbsp;</div></li><li><div>                        &lt;div id='edit-level' class='level-holder-wrap'&gt;&nbsp;</div></li><li><div>                            &lt;div class='sidebar-name no-movecursor'&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php echo esc_html($title); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;div class='level-holder'&gt;&nbsp;</div></li><li><div>                                &lt;br /&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php echo $formdescription;  ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    echo $html;&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div class='buttons'&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        wp_original_referer_field(true, 'previous'); wp_nonce_field($action . '-gateway-complete');&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel add'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e($button, 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='&lt;?php esc_attr_e($action . '-gateway-complete'); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(is_array($member_id)) {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e(implode(', ', $member_id)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e($member_id); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- level-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_member_level_op($operation = 'add', $member_id = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $action2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page', 'action2') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($action) && !empty($action2)) $action = $action2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['fromlevel']) && !empty($_GET['fromlevel'])) {&nbsp;</div></li><li><div>            $fromlevel = $_GET['fromlevel'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $fromlevel = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch($operation) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'add':        $title = __('Add member to a level', 'membership');&nbsp;</div></li><li><div>                            $formdescription = __('A membership level controls the amount of access to the sites content this member will have.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                            $formdescription .= __('By adding a membership level, you may actually be removing existing access to content.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Level to add for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='tolevel_id' id='tolevel_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the level to add.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $levels = $this-&gt;get_membership_levels(array('level_id' =&gt; 'active'));&nbsp;</div></li><li><div>                            if($levels) {&nbsp;</div></li><li><div>                                foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($level-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($level-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Add&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'move':    $title = __('Move member to another level', 'membership');&nbsp;</div></li><li><div>                            $formdescription = __('A membership level controls the amount of access to the sites content this member will have.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Level to move from for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='fromlevel_id' id='fromlevel_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the level to move from.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $levels = $this-&gt;get_membership_levels(array('level_id' =&gt; 'active'));&nbsp;</div></li><li><div>                            if($levels) {&nbsp;</div></li><li><div>                                foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($level-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    if($fromlevel == $level-&gt;id) $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($level-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html .= &quot;&lt;h3&gt;&quot; . __('Level to move to for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='tolevel_id' id='tolevel_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the level to move to.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            reset($levels);&nbsp;</div></li><li><div>                            if($levels) {&nbsp;</div></li><li><div>                                foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($level-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($level-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Move&quot;;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'drop':    $title = __('Drop member from level', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $formdescription = __('A membership level controls the amount of access to the sites content this member will have.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                            $formdescription .= __('By removing a membership level, you may actually be increasing existing access to content.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Level to drop for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='fromlevel_id' id='fromlevel_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value=''&gt;&quot; . __('Select the level to remove.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $levels = $this-&gt;get_membership_levels(array('level_id' =&gt; 'active'));&nbsp;</div></li><li><div>                            if($levels) {&nbsp;</div></li><li><div>                                foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($level-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    if($fromlevel == $level-&gt;id) $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($level-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Drop&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php echo $title; ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>            &lt;form action='admin.php?page=&lt;?php echo $page; ?&gt;' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class='level-liquid-left'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='level-left'&gt;&nbsp;</div></li><li><div>                        &lt;div id='edit-level' class='level-holder-wrap'&gt;&nbsp;</div></li><li><div>                            &lt;div class='sidebar-name no-movecursor'&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php echo esc_html($title); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;div class='level-holder'&gt;&nbsp;</div></li><li><div>                                &lt;br /&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php echo $formdescription;  ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    echo $html;&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div class='buttons'&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        wp_original_referer_field(true, 'previous'); wp_nonce_field($action . '-level-complete');&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel add'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e($button, 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='&lt;?php esc_attr_e($action . '-level-complete'); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(is_array($member_id)) {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e(implode(', ', $member_id)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e($member_id); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- level-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_member_subscription_op($operation = 'add', $member_id = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $action2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page', 'action2') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($action) && !empty($action2)) $action = $action2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['fromsub']) && !empty($_GET['fromsub'])) {&nbsp;</div></li><li><div>            $fromsub = $_GET['fromsub'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $fromsub = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch($operation) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'add':        $title = __('Add member to a subscription', 'membership');&nbsp;</div></li><li><div>                            $formdescription = __('A subscription controls the levels a site member has access to / passes through.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                            $formdescription .= __('Depending on your payment gateway, adding a subscription here may not set up a payment subscription.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Subscription and level to add for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='tosub_id' id='tosub_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the level to add.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $subs = $this-&gt;get_subscriptions_and_levels( array('sub_status' =&gt; 'active') );&nbsp;</div></li><li><div>                            if($subs) {&nbsp;</div></li><li><div>                                $sub_id = false;&nbsp;</div></li><li><div>                                foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                                    if($sub_id != $sub-&gt;sub_id) {&nbsp;</div></li><li><div>                                        $sub_id = $sub-&gt;sub_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $html .= &quot;&lt;optgroup label='&quot;;&nbsp;</div></li><li><div>                                        $html .= $sub-&gt;sub_name;&nbsp;</div></li><li><div>                                        $html .= &quot;'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($sub-&gt;sub_id) . &quot;-&quot; . esc_attr($sub-&gt;level_id) . &quot;-&quot; . esc_attr($sub-&gt;level_order) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . $sub-&gt;level_order . &quot; : &quot; . esc_html($sub-&gt;sub_name . &quot; - &quot; . $sub-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Add&quot;;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'move':    $title = __('Move member to another subscription level', 'membership');&nbsp;</div></li><li><div>                            $formdescription = __('A subscription controls the levels a site member has access to / passes through.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                            $formdescription .= __('Depending on your payment gateway, moving a subscription here may not alter a members existing payment subscription.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Subscription to move from for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='fromsub_id' id='fromsub_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the subscription to move from.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $subs = $this-&gt;get_subscriptions( array('sub_status' =&gt; 'active'));&nbsp;</div></li><li><div>                            if($subs) {&nbsp;</div></li><li><div>                                foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($sub-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    if($fromsub == $sub-&gt;id) $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($sub-&gt;sub_name) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html .= &quot;&lt;h3&gt;&quot; . __('Subscription and Level to move to for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='tosub_id' id='tosub_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value='0'&gt;&quot; . __('Select the level to move to.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $subs = $this-&gt;get_subscriptions_and_levels( array('sub_status' =&gt; 'active') );&nbsp;</div></li><li><div>                            if($subs) {&nbsp;</div></li><li><div>                                $sub_id = false;&nbsp;</div></li><li><div>                                foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                                    if($sub_id != $sub-&gt;sub_id) {&nbsp;</div></li><li><div>                                        $sub_id = $sub-&gt;sub_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $html .= &quot;&lt;optgroup label='&quot;;&nbsp;</div></li><li><div>                                        $html .= $sub-&gt;sub_name;&nbsp;</div></li><li><div>                                        $html .= &quot;'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($sub-&gt;sub_id) . &quot;-&quot; . esc_attr($sub-&gt;level_id) . &quot;-&quot; . esc_attr($sub-&gt;level_order) . &quot;'&gt;&quot; . $sub-&gt;level_order . &quot; : &quot; . esc_html($sub-&gt;sub_name . &quot; - &quot; . $sub-&gt;level_title) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Move&quot;;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'drop':    $title = __('Drop member from subscription', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $formdescription = __('A subscription controls the levels a site member has access to / passes through.', 'membership') . &quot;&lt;br/&gt;&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                            $formdescription .= __('Depending on the payment gateway, removing a subscription will not automatically cancel a payment subscription.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $html = &quot;&lt;h3&gt;&quot; . __('Subscription to drop for this / these member(s)', 'membership') . &quot;&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;div class='level-details'&gt;&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;select name='fromsub_id' id='fromsub_id' class='wide'&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;option value=''&gt;&quot; . __('Select the subscription to remove.', 'membership') . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                            $subs = $this-&gt;get_subscriptions( array('sub_status' =&gt; 'active'));&nbsp;</div></li><li><div>                            if($subs) {&nbsp;</div></li><li><div>                                foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                                    $html .= &quot;&lt;option value='&quot; . esc_attr($sub-&gt;id) . &quot;'&quot;;&nbsp;</div></li><li><div>                                    if($fromsub == $sub-&gt;id) $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                                    $html .= &quot;&gt;&quot; . esc_html($sub-&gt;sub_name) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                            $html .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $button = &quot;Drop&quot;;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php echo $title; ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>            &lt;form action='admin.php?page=&lt;?php echo $page; ?&gt;' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class='level-liquid-left'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='level-left'&gt;&nbsp;</div></li><li><div>                        &lt;div id='edit-level' class='level-holder-wrap'&gt;&nbsp;</div></li><li><div>                            &lt;div class='sidebar-name no-movecursor'&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php echo esc_html($title); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;div class='level-holder'&gt;&nbsp;</div></li><li><div>                                &lt;br /&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php echo $formdescription;  ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    echo $html;&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div class='buttons'&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        wp_original_referer_field(true, 'previous'); wp_nonce_field($action . '-sub-complete');&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel add'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e($button, 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='&lt;?php esc_attr_e($action . '-sub-complete'); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(is_array($member_id)) {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e(implode(', ', $member_id)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            ?&gt;&nbsp;</div></li><li><div>                                            &lt;input type='hidden' name='member_id' value='&lt;?php esc_attr_e($member_id); ?&gt;' /&gt;&nbsp;</div></li><li><div>                                            &lt;?php&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- level-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_members_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once('class.membersearch.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // bulk actions&nbsp;</div></li><li><div>        if(isset($_GET['doaction'])) {&nbsp;</div></li><li><div>            $action = $_GET['action'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif(isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            $action = $_GET['action2'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'addlevel':    if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('add', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'movelevel':    if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    check_admin_referer('movelevel-member-' . $member_id);&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('move', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'droplevel':    if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    check_admin_referer('droplevel-member-' . $member_id);&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('drop', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkaddlevel':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('add', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkmovelevel':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('move', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkdroplevel':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_level_op('drop', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'addsub':        if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('add', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'movesub':        if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    check_admin_referer('movesub-member-' . $member_id);&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('move', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'dropsub':        if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    check_admin_referer('dropsub-member-' . $member_id);&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('drop', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkaddsub':    if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('add', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>            case 'bulkmovesub':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('move', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>            case 'bulkdropsub':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_subscription_op('drop', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulkmovegateway':&nbsp;</div></li><li><div>                                if(isset($_GET['users'])) {&nbsp;</div></li><li><div>                                    check_admin_referer('bulk-members');&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_gateway_op('move', $_GET['users']);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'movegateway':&nbsp;</div></li><li><div>                                if(isset($_GET['member_id'])) {&nbsp;</div></li><li><div>                                    $member_id = (int) $_GET['member_id'];&nbsp;</div></li><li><div>                                    check_admin_referer('movegateway-member-' . $member_id);&nbsp;</div></li><li><div>                                    $this-&gt;handle_member_gateway_op('move', $member_id);&nbsp;</div></li><li><div>                                    return;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'edit':    if(isset($_GET['level_id'])) {&nbsp;</div></li><li><div>                                $level_id = (int) $_GET['level_id'];&nbsp;</div></li><li><div>                                $this-&gt;handle_level_edit_form($level_id);&nbsp;</div></li><li><div>                                return; // So we don't see the rest of this page&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['s'])) {&nbsp;</div></li><li><div>            $s = stripslashes($_GET['s']);&nbsp;</div></li><li><div>            $filter['s'] = $s;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $s = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sub_id = null; $level_id = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionsub'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['sub_op']) != '') {&nbsp;</div></li><li><div>                $sub_id = addslashes($_GET['sub_op']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionsub2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['sub_op2']) != '') {&nbsp;</div></li><li><div>                $sub_id = addslashes($_GET['sub_op2']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionlevel'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['level_op']) != '') {&nbsp;</div></li><li><div>                $level_id = addslashes($_GET['level_op']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionlevel2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['level_op2']) != '') {&nbsp;</div></li><li><div>                $level_id = addslashes($_GET['level_op2']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionactive'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['active_op']) != '') {&nbsp;</div></li><li><div>                $active_op = addslashes($_GET['active_op']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doactionactive2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['active_op2']) != '') {&nbsp;</div></li><li><div>                $active_op = addslashes($_GET['active_op2']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $usersearch = isset($_GET['s']) ? $_GET['s'] : null;&nbsp;</div></li><li><div>        $userspage = isset($_GET['userspage']) ? $_GET['userspage'] : null;&nbsp;</div></li><li><div>        $role = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($active_op)) $active_op = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Query the users&nbsp;</div></li><li><div>        $wp_user_search = new M_Member_Search($usersearch, $userspage, $sub_id, $level_id, $active_op);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Member added.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Member deleted.', 'membership');&nbsp;</div></li><li><div>        $messages[3] = __('Member updated.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Member not added.', 'membership');&nbsp;</div></li><li><div>        $messages[5] = __('Member not updated.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Member not deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Member activation toggled.', 'membership');&nbsp;</div></li><li><div>        $messages[8] = __('Member activation not toggled.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[9] = __('Members updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Edit Members', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('msg'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.members.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; class=&quot;search-form&quot;&gt;&nbsp;</div></li><li><div>            &lt;p class=&quot;search-box&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;label for=&quot;membership-search-input&quot; class=&quot;screen-reader-text&quot;&gt;&lt;?php _e('Search Members', 'membership'); ?&gt;:&lt;/label&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($s); ?&gt;&quot; name=&quot;s&quot; id=&quot;membership-search-input&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;submit&quot; class=&quot;button&quot; value=&quot;&lt;?php _e('Search Members', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class='clear' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;members-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php if ( $wp_user_search-&gt;results_are_paged() ) : ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;tablenav-pages&quot;&gt;&lt;?php $wp_user_search-&gt;page_links(); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Subscriptions', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkaddsub&quot;&gt;&lt;?php _e('Add subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovesub&quot;&gt;&lt;?php _e('Move subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkdropsub&quot;&gt;&lt;?php _e('Drop subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Levels', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkaddlevel&quot;&gt;&lt;?php _e('Add level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovelevel&quot;&gt;&lt;?php _e('Move level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkdroplevel&quot;&gt;&lt;?php _e('Drop level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Gateways', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovegateway&quot;&gt;&lt;?php _e('Move gateway', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;sub_op&quot; style='float:none;'&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    $subs = $this-&gt;get_subscriptions();&nbsp;</div></li><li><div>                    if($subs) {&nbsp;</div></li><li><div>                        foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php echo $sub-&gt;id; ?&gt;&quot; &lt;?php if(isset($_GET['sub_op']) && $_GET['sub_op'] == $sub-&gt;id) echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo esc_html($sub-&gt;sub_name); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionsub&quot; name=&quot;doactionsub&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;level_op&quot; style='float:none;'&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>                    if($levels) {&nbsp;</div></li><li><div>                        foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php echo $level-&gt;id; ?&gt;&quot; &lt;?php if(isset($_GET['level_op']) && $_GET['level_op'] == $level-&gt;id) echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo esc_html($level-&gt;level_title); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionlevel&quot; name=&quot;doactionlevel&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;active_op&quot; style='float:none;'&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by status', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;yes&quot; &lt;?php if(isset($_GET['active_op']) && $_GET['active_op'] == 'yes') echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php _e('Active', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;no&quot; &lt;?php if(isset($_GET['active_op']) && $_GET['active_op'] == 'no') echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php _e('Inactive', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionactive&quot; name=&quot;doactionactive&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>                &lt;!-- &lt;input type=&quot;button&quot; class=&quot;button-secondary addnewlevelbutton&quot; value=&quot;&lt;?php _e('Add New', 'membership'); ?&gt;&quot; name=&quot;addnewlevel&quot;&gt; --&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php if ( is_wp_error( $wp_user_search-&gt;search_errors ) ) : ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;error&quot;&gt;&nbsp;</div></li><li><div>                    &lt;ul&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                        foreach ( $wp_user_search-&gt;search_errors-&gt;get_error_messages() as $message )&nbsp;</div></li><li><div>                            echo &quot;&lt;li&gt;$message&lt;/li&gt;&quot;;&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;/ul&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php if ( $wp_user_search-&gt;is_search() ) : ?&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;a href=&quot;?page=&lt;?php echo $page; ?&gt;&quot;&gt;&lt;?php _e('&larr; Back to All Users', 'membership'); ?&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_nonce_field('bulk-members');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;username&quot; =&gt;     __('Username', 'membership'), &nbsp;</div></li><li><div>                                    &quot;name&quot; =&gt;     __('Name', 'membership'), &nbsp;</div></li><li><div>                                    &quot;email&quot; =&gt;     __('E-mail', 'membership'), &nbsp;</div></li><li><div>                                    &quot;active&quot; =&gt;    __('Active', 'membership'), &nbsp;</div></li><li><div>                                    &quot;sub&quot; =&gt;    __('Subscription', 'membership'), &nbsp;</div></li><li><div>                                    &quot;level&quot; =&gt;    __('Membership Level', 'membership'), &nbsp;</div></li><li><div>                                    &quot;expires&quot; =&gt;    __('Level Expires', 'membership'), &nbsp;</div></li><li><div>                                    &quot;gateway&quot; =&gt;    __('Gateway', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('members_columns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //$levels = $this-&gt;get_membership_levels($filter);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $style = '';&nbsp;</div></li><li><div>                    foreach ( $wp_user_search-&gt;get_results() as $userid ) {&nbsp;</div></li><li><div>                        $user_object = new M_Membership($userid);&nbsp;</div></li><li><div>                        $roles = $user_object-&gt;roles;&nbsp;</div></li><li><div>                        $role = array_shift($roles);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $style = ( ' class=&quot;alternate&quot;' == $style ) ? '' : ' class=&quot;alternate&quot;';&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr id='user-&lt;?php echo $user_object-&gt;ID; ?&gt;' &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                            &lt;th scope='row' class='check-column'&gt;&nbsp;</div></li><li><div>                                &lt;input type='checkbox' name='users[]' id='user_&lt;?php echo $user_object-&gt;ID; ?&gt;' class='$role' value='&lt;?php echo $user_object-&gt;ID; ?&gt;' /&gt;&nbsp;</div></li><li><div>                            &lt;/th&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;a href='&lt;?php echo admin_url('user-edit.php?user_id=' . $user_object-&gt;ID); ?&gt;' title='User ID: &lt;?php echo $user_object-&gt;ID;  ?&gt;'&gt;&lt;?php echo $user_object-&gt;user_login; ?&gt;&lt;/a&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $actions = array();&nbsp;</div></li><li><div>                                    //$actions['id'] = &quot;&lt;strong&gt;&quot; . __('ID : ', 'membership') . $user_object-&gt;ID . &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>                                    $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . admin_url('user-edit.php?user_id=' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Edit', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    if($user_object-&gt;active_member()) {&nbsp;</div></li><li><div>                                        $actions['activate'] = &quot;&lt;span class='edit deactivate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'toggle-member_' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Deactivate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $actions['activate'] = &quot;&lt;span class='edit activate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'toggle-member_' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Activate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    //$actions['history'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=history&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'history-member_' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('History', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&lt;?php echo $user_object-&gt;first_name . &quot; &quot; . $user_object-&gt;last_name; ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&lt;a href='mailto:&lt;?php echo $user_object-&gt;user_email; ?&gt;' title='&lt;?php echo sprintf( __('e-mail: %s', 'membership' ), $user_object-&gt;user_email ); ?&gt;'&gt;&lt;?php echo $user_object-&gt;user_email; ?&gt;&lt;/a&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php if($user_object-&gt;active_member()) {&nbsp;</div></li><li><div>                                    echo &quot;&lt;span class='membershipactivestatus'&gt;&quot; . __('Active', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    echo &quot;&lt;span class='membershipinactivestatus'&gt;&quot; . __('Inactive', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                $subs = $user_object-&gt;get_subscription_ids();&nbsp;</div></li><li><div>                                if(!empty($subs)) {&nbsp;</div></li><li><div>                                    $rows = array();&nbsp;</div></li><li><div>                                    foreach((array) $subs as $key) {&nbsp;</div></li><li><div>                                        $sub = new M_Subscription ( $key );&nbsp;</div></li><li><div>                                        if(!empty($sub)) {&nbsp;</div></li><li><div>                                            $rows[] = $sub-&gt;sub_name();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    echo implode(&quot;, &quot;, $rows);&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $actions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if(!$user_object-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                    $actions['add'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page={$page}&amp;action=addsub&amp;member_id={$user_object-&gt;ID}'&gt;&quot; . __('Add', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if(!empty($subs)) {&nbsp;</div></li><li><div>                                    if(count($subs) == 1) {&nbsp;</div></li><li><div>                                        $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movesub&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&amp;fromsub=&quot; . $subs[0], 'movesub-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['drop'] = &quot;&lt;span class='edit delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=dropsub&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&amp;fromsub=&quot; . $subs[0], 'dropsub-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Drop', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movesub&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'movesub-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['drop'] = &quot;&lt;span class='edit delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=dropsub&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'dropsub-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Drop', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                $levels = $user_object-&gt;get_level_ids();&nbsp;</div></li><li><div>                                if(!empty($levels)) {&nbsp;</div></li><li><div>                                    $rows = array();&nbsp;</div></li><li><div>                                    foreach((array) $levels as $key =&gt; $value) {&nbsp;</div></li><li><div>                                        $level = new M_Level ( $value-&gt;level_id );&nbsp;</div></li><li><div>                                        if(!empty($level)) {&nbsp;</div></li><li><div>                                            if((int) $value-&gt;sub_id != 0) {&nbsp;</div></li><li><div>                                                $rows[] = &quot;&lt;strong&gt;&quot; . $level-&gt;level_title() . &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $rows[] = $level-&gt;level_title();&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    echo implode(&quot;, &quot;, $rows);&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $actions = array();&nbsp;</div></li><li><div>                                if(!$user_object-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                    $actions['add'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page={$page}&amp;action=addlevel&amp;member_id={$user_object-&gt;ID}'&gt;&quot; . __('Add', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if(!empty($levels)) {&nbsp;</div></li><li><div>                                    if(count($levels) == 1) {&nbsp;</div></li><li><div>                                        $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movelevel&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&amp;fromlevel=&quot; . $levels[0]-&gt;level_id, 'movelevel-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['drop'] = &quot;&lt;span class='edit delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=droplevel&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&amp;fromlevel=&quot; . $levels[0]-&gt;level_id, 'droplevel-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Drop', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movelevel&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'movelevel-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['drop'] = &quot;&lt;span class='edit delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=droplevel&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'droplevel-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Drop', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $subs = $user_object-&gt;get_relationships();&nbsp;</div></li><li><div>                                    if($subs) {&nbsp;</div></li><li><div>                                        $exps = array();&nbsp;</div></li><li><div>                                        foreach($subs as $sub) {&nbsp;</div></li><li><div>                                            $exps[] = date(&quot;Y-m-d H:i&quot;, mysql2date(&quot;U&quot;, $sub-&gt;expirydate));&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        echo implode(&quot;, &quot;, $exps);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td &lt;?php echo $style; ?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $subs = $user_object-&gt;get_relationships();&nbsp;</div></li><li><div>                                    //print_r($subs);&nbsp;</div></li><li><div>                                    if($subs) {&nbsp;</div></li><li><div>                                        $gates = array();&nbsp;</div></li><li><div>                                        foreach($subs as $sub) {&nbsp;</div></li><li><div>                                            $gates[] = $sub-&gt;usinggateway;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        echo implode(&quot;, &quot;, $gates);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if($user_object-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                            $actions = array();&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $actions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            if(count($gates) == 1) {&nbsp;</div></li><li><div>                                                $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movegateway&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&amp;fromgateway=&quot; . $gates[0], 'movegateway-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $actions['move'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=movegateway&amp;member_id=&quot; . $user_object-&gt;ID . &quot;&quot;, 'movegateway-member-' . $user_object-&gt;ID) . &quot;'&gt;&quot; . __('Move', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        ?&gt;&nbsp;</div></li><li><div>                                        &lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                        &lt;?php&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Subscriptions', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkaddsub&quot;&gt;&lt;?php _e('Add subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovesub&quot;&gt;&lt;?php _e('Move subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkdropsub&quot;&gt;&lt;?php _e('Drop subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Levels', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkaddlevel&quot;&gt;&lt;?php _e('Add level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovelevel&quot;&gt;&lt;?php _e('Move level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkdroplevel&quot;&gt;&lt;?php _e('Drop level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php _e('Gateways', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;bulkmovegateway&quot;&gt;&lt;?php _e('Move gateway', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;Apply&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;sub_op2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by subscription', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    $subs = $this-&gt;get_subscriptions();&nbsp;</div></li><li><div>                    if($subs) {&nbsp;</div></li><li><div>                        foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php echo $sub-&gt;id; ?&gt;&quot; &lt;?php if(isset($_GET['sub_op2']) && $_GET['sub_op2'] == $sub-&gt;id) echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo esc_html($sub-&gt;sub_name); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionsub2&quot; name=&quot;doactionsub2&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;level_op2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by level', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>                    if($levels) {&nbsp;</div></li><li><div>                        foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php echo $level-&gt;id; ?&gt;&quot; &lt;?php if(isset($_GET['level_op2']) && $_GET['level_op2'] == $level-&gt;id) echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo esc_html($level-&gt;level_title); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionlevel2&quot; name=&quot;doactionlevel2&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;active_op2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;&quot;&gt;&lt;?php _e('Filter by status', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;yes&quot; &lt;?php if(isset($_GET['active_op2']) && $_GET['active_op2'] == 'yes') echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php _e('Active', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;no&quot; &lt;?php if(isset($_GET['active_op2']) && $_GET['active_op2'] == 'no') echo 'selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php _e('Inactive', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doactionactive2&quot; name=&quot;doactionactive2&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_options_panel_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $wp_rewrite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($action == 'updateoptions') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            check_admin_referer('update-membership-options');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($_GET['tab'])) {&nbsp;</div></li><li><div>                $tab = $_GET['tab'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $tab = 'general';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                    if(function_exists('switch_to_blog')) {&nbsp;</div></li><li><div>                        switch_to_blog(MEMBERSHIP_GLOBAL_MAINSITE);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $M_options = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', array());&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch($tab) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'general':            $M_options['strangerlevel'] = (isset($_POST['strangerlevel'])) ? (int) $_POST['strangerlevel'] : '';&nbsp;</div></li><li><div>                                        $M_options['freeusersubscription'] = (isset($_POST['freeusersubscription'])) ? (int) $_POST['freeusersubscription'] : '';&nbsp;</div></li><li><div>                                        $M_options['enableincompletesignups'] = (isset($_POST['enableincompletesignups'])) ? $_POST['enableincompletesignups'] : '';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'pages':            $M_options['nocontent_page'] = (isset($_POST['nocontent_page'])) ? $_POST['nocontent_page'] : '';&nbsp;</div></li><li><div>                                        $M_options['account_page'] = (isset($_POST['account_page'])) ? $_POST['account_page'] : '';&nbsp;</div></li><li><div>                                        $M_options['registration_page'] = (isset($_POST['registration_page'])) ? $_POST['registration_page'] : '';&nbsp;</div></li><li><div>                                        $M_options['registrationcompleted_page'] = (isset($_POST['registrationcompleted_page'])) ? $_POST['registrationcompleted_page'] : '';&nbsp;</div></li><li><div>                                        $M_options['subscriptions_page'] = (isset($_POST['subscriptions_page'])) ? $_POST['subscriptions_page'] : '';&nbsp;</div></li><li><div>                                        $M_options['formtype'] = (isset($_POST['formtype'])) ? $_POST['formtype'] : '';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'posts':            $M_options['membershipshortcodes'] = (isset($_POST['membershipshortcodes'])) ? explode(&quot;\n&quot;, $_POST['membershipshortcodes']) : array();&nbsp;</div></li><li><div>                                        $M_options['membershipadminshortcodes'] = (isset($_POST['membershipadminshortcodes'])) ? explode(&quot;\n&quot;, $_POST['membershipadminshortcodes']) : array();&nbsp;</div></li><li><div>                                        $M_options['shortcodemessage'] = (isset($_POST['shortcodemessage'])) ? $_POST['shortcodemessage'] : '';&nbsp;</div></li><li><div>                                        $M_options['moretagdefault'] = (isset($_POST['moretagdefault'])) ? $_POST['moretagdefault'] : '';&nbsp;</div></li><li><div>                                        $M_options['moretagmessage'] = (isset($_POST['moretagmessage'])) ? $_POST['moretagmessage'] : '';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'downloads':        $M_options['original_url'] = (isset($_POST['original_url'])) ? $_POST['original_url'] : '';&nbsp;</div></li><li><div>                                        $M_options['masked_url'] = (isset($_POST['masked_url'])) ? $_POST['masked_url'] : '';&nbsp;</div></li><li><div>                                        $M_options['membershipdownloadgroups'] = (isset($_POST['membershipdownloadgroups'])) ? explode(&quot;\n&quot;, $_POST['membershipdownloadgroups']) : array();&nbsp;</div></li><li><div>                                        $M_options['protection_type'] = (isset($_POST['protection_type'])) ? $_POST['protection_type'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        // Refresh the rewrite rules in case they've switched to hybrid from an earlier version&nbsp;</div></li><li><div>                                        flush_rewrite_rules();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'users':            $wp_user_search = new WP_User_Query( array( 'role' =&gt; 'administrator' ) );&nbsp;</div></li><li><div>                                        $admins = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>                                        $user_id = get_current_user_id();&nbsp;</div></li><li><div>                                        foreach($admins as $admin) {&nbsp;</div></li><li><div>                                            if($user_id == $admin-&gt;ID) {&nbsp;</div></li><li><div>                                                continue;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                if(in_array( $admin-&gt;ID, (array) $_POST['admincheck'])) {&nbsp;</div></li><li><div>                                                    $user = new WP_User( $admin-&gt;ID );&nbsp;</div></li><li><div>                                                    if(!$user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                                        $user-&gt;add_cap('membershipadmin');&nbsp;</div></li><li><div>                                                    }&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    $user = new WP_User( $admin-&gt;ID );&nbsp;</div></li><li><div>                                                    if($user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                                        $user-&gt;remove_cap('membershipadmin');&nbsp;</div></li><li><div>                                                    }&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'extras':            $M_options['paymentcurrency'] = (isset($_POST['paymentcurrency'])) ? $_POST['paymentcurrency'] : '';&nbsp;</div></li><li><div>                                        $M_options['upgradeperiod'] = (isset($_POST['upgradeperiod'])) ? $_POST['upgradeperiod'] : '';&nbsp;</div></li><li><div>                                        $M_options['renewalperiod'] = (isset($_POST['renewalperiod'])) ? $_POST['renewalperiod'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if(isset($_POST['membershipwizard']) && $_POST['membershipwizard'] == 'yes') {&nbsp;</div></li><li><div>                                            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                                                if(function_exists('update_blog_option')) {&nbsp;</div></li><li><div>                                                    update_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    update_option('membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                update_option('membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // included an action here so that it is processed for all tabs&nbsp;</div></li><li><div>            do_action('membership_option_menu_process_' . $tab);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // For future upgrades&nbsp;</div></li><li><div>            $M_options['registration_tos'] = (isset($_POST['registration_tos'])) ? $_POST['registration_tos'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                if(function_exists('update_blog_option')) {&nbsp;</div></li><li><div>                    update_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', $M_options);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    update_option('membership_options', $M_options);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                update_option('membership_options', $M_options);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'membership_options_page_process' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Always flush the rewrite rules&nbsp;</div></li><li><div>            $wp_rewrite-&gt;flush_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_safe_redirect( add_query_arg('msg', 1, wp_get_referer()) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif( !empty($action) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                    if(function_exists('switch_to_blog')) {&nbsp;</div></li><li><div>                        switch_to_blog(MEMBERSHIP_GLOBAL_MAINSITE);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $M_options = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', array());&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch($action) {&nbsp;</div></li><li><div>                case 'createregistrationpage':    check_admin_referer('create-registrationpage');&nbsp;</div></li><li><div>                                                $pagedetails = array('post_title' =&gt; __('Register', 'membership'), 'post_name' =&gt; 'register', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; '');&nbsp;</div></li><li><div>                                                $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>                                                $M_options['registration_page'] = $id;&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'createaccountpage':        check_admin_referer('create-accountpage');&nbsp;</div></li><li><div>                                                $pagedetails = array('post_title' =&gt; __('Account', 'membership'), 'post_name' =&gt; 'account', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; '');&nbsp;</div></li><li><div>                                                $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>                                                $M_options['account_page'] = $id;&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'createsubscriptionspage':    check_admin_referer('create-subscriptionspage');&nbsp;</div></li><li><div>                                                $pagedetails = array('post_title' =&gt; __('Subscriptions', 'membership'), 'post_name' =&gt; 'subscriptions', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; '');&nbsp;</div></li><li><div>                                                $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>                                                $M_options['subscriptions_page'] = $id;&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'createnoaccesspage':        check_admin_referer('create-noaccesspage');&nbsp;</div></li><li><div>                                                $content = '&lt;p&gt;' . __('The content you are trying to access is only available to members. Sorry.', 'membership') . '&lt;/p&gt;';&nbsp;</div></li><li><div>                                                $pagedetails = array('post_title' =&gt; __('Protected Content', 'membership'), 'post_name' =&gt; 'protected', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; $content);&nbsp;</div></li><li><div>                                                $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>                                                $M_options['nocontent_page'] = $id;&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'createregistrationcompletedpage':&nbsp;</div></li><li><div>                                                check_admin_referer('create-registrationcompletedpage');&nbsp;</div></li><li><div>                                                $content = '&lt;p&gt;' . __('Thank you for subscribing. We hope you enjoy the content.', 'membership') . '&lt;/p&gt;';&nbsp;</div></li><li><div>                                                $pagedetails = array('post_title' =&gt; __('Welcome', 'membership'), 'post_name' =&gt; 'welcome', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; $content);&nbsp;</div></li><li><div>                                                $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>                                                $M_options['registrationcompleted_page'] = $id;&nbsp;</div></li><li><div>                                                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                if(function_exists('update_blog_option')) {&nbsp;</div></li><li><div>                    update_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', $M_options);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    update_option('membership_options', $M_options);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                update_option('membership_options', $M_options);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'membership_options_pagecreation_process' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_safe_redirect( add_query_arg('msg', 2, wp_get_referer()) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_general_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Your options have been updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('General Options', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Stranger settings', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('A &quot;stranger&quot; is a visitor to your website who is either not logged in, or does not have an active membership or subscription to your website.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Use membership level', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name='strangerlevel' id='strangerlevel'&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;0&quot;&gt;&lt;?php _e('None - No access to content', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>                                        if($levels) {&nbsp;</div></li><li><div>                                            foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                                ?&gt;&nbsp;</div></li><li><div>                                                &lt;option value=&quot;&lt;?php echo $level-&gt;id; ?&gt;&quot; &lt;?php if(isset($M_options['strangerlevel']) && $M_options['strangerlevel'] == $level-&gt;id) echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php echo esc_html($level-&gt;level_title); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                                &lt;?php&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If the above is set to &quot;None&quot; then you can pick the page you want strangers directed to below in the &quot;Membership Pages&quot; options.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('User registration', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you have free user registration enabled on your site, select the subscription they will be assigned to initially.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you are using a paid subscription model - it is probably best to set this to &quot;none&quot;.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Use subscription', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name='freeusersubscription' id='freeusersubscription'&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;0&quot;&gt;&lt;?php _e('None', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $subs = $this-&gt;get_subscriptions( array('sub_status' =&gt; 'active'));&nbsp;</div></li><li><div>                                        if($subs) {&nbsp;</div></li><li><div>                                            foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                                                ?&gt;&nbsp;</div></li><li><div>                                                &lt;option value=&quot;&lt;?php echo $sub-&gt;id; ?&gt;&quot; &lt;?php if(isset($M_options['freeusersubscription']) && $M_options['freeusersubscription'] == $sub-&gt;id) echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php echo esc_html($sub-&gt;sub_name); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                                &lt;?php&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        /**&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('The default setting for the membership plugin is to disable user accounts that do not complete their subscription signup.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you want to change this, then use the option below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Enable incomplete signup accounts', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;/em&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(!isset($M_options['enableincompletesignups'])) {&nbsp;</div></li><li><div>                                            $M_options['enableincompletesignups'] = 'no';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;input type='checkbox' name='enableincompletesignups' id='enableincompletesignups' value='yes' &lt;?php checked('yes', $M_options['enableincompletesignups']); ?&gt; /&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                        */&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_generaloptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_page_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Your options have been updated.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Your page has been created.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Membership Page Options', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Registration page', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('This is the page a new user will be redirected to when they want to register on your site.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('You can include an introduction on the page, for more advanced content around the registration form then you &lt;strong&gt;should&lt;/strong&gt; include the [subscriptionform] shortcode in some location on that page. Alternatively leave the page blank for the standard Membership subscription forms.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Registration page', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Select a page to use for the registration form. If you do not have one already, then click on &lt;strong&gt;Create Page&lt;/strong&gt; to make one.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(!isset($M_options['registration_page'])) {&nbsp;</div></li><li><div>                                        $M_options['registration_page'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $pages = wp_dropdown_pages(array('post_type' =&gt; 'page', 'selected' =&gt; $M_options['registration_page'], 'name' =&gt; 'registration_page', 'show_option_none' =&gt; __('None', 'membership'), 'sort_column'=&gt; 'menu_order, post_title', 'echo' =&gt; 0));&nbsp;</div></li><li><div>                                    echo $pages;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &nbsp;&lt;a href='&lt;?php echo wp_nonce_url(&quot;admin.php?page=&quot; . $page. &quot;&amp;tab=pages&amp;action=createregistrationpage&quot;, 'create-registrationpage'); ?&gt;' class='button-primary' title='&lt;?php _e('Create a default page for the registration page and assign it here.', 'membership'); ?&gt;'&gt;&lt;?php _e('Create page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($M_options['registration_page'])) { ?&gt;&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;a href='&lt;?php echo get_permalink($M_options['registration_page']); ?&gt;'&gt;&lt;?php _e('view page', 'membership'); ?&gt;&lt;/a&gt; | &lt;a href='&lt;?php echo admin_url('post.php?post=' . $M_options['registration_page'] . '&action=edit'); ?&gt;'&gt;&lt;?php _e('edit page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('There are two forms of registration form available, select the one you would like to use on your site below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Form type', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Choose between the original multi-page or Pop up registration methods.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name='formtype' id='formtype'&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;original&quot; &lt;?php if(isset($M_options['formtype']) && $M_options['formtype'] == 'original') echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php _e('Original membership form', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;new&quot; &lt;?php if(isset($M_options['formtype']) && $M_options['formtype'] == 'new') echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php _e('Popup registration form', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Registration completed page', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('When a user has signed up for membership and completed any payments required, they will be redirected to this page.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('You should include a welcome message on this page and some details on what to do next.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Registration completed page', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Select a page to use for the Registration completed page. If you do not have one already, then click on &lt;strong&gt;Create Page&lt;/strong&gt; to make one.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(!isset($M_options['registrationcompleted_page'])) {&nbsp;</div></li><li><div>                                        $M_options['registrationcompleted_page'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $pages = wp_dropdown_pages(array('post_type' =&gt; 'page', 'selected' =&gt; $M_options['registrationcompleted_page'], 'name' =&gt; 'registrationcompleted_page', 'show_option_none' =&gt; __('Select a page', 'membership'), 'sort_column'=&gt; 'menu_order, post_title', 'echo' =&gt; 0));&nbsp;</div></li><li><div>                                    echo $pages;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &nbsp;&lt;a href='&lt;?php echo wp_nonce_url(&quot;admin.php?page=&quot; . $page. &quot;&amp;tab=pages&amp;action=createregistrationcompletedpage&quot;, 'create-registrationcompletedpage'); ?&gt;' class='button-primary' title='&lt;?php _e('Create a default page for the registration completed page and assign it here.', 'membership'); ?&gt;'&gt;&lt;?php _e('Create page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($M_options['registrationcompleted_page'])) { ?&gt;&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;a href='&lt;?php echo get_permalink($M_options['registrationcompleted_page']); ?&gt;'&gt;&lt;?php _e('view page', 'membership'); ?&gt;&lt;/a&gt; | &lt;a href='&lt;?php echo admin_url('post.php?post=' . $M_options['registrationcompleted_page'] . '&action=edit'); ?&gt;'&gt;&lt;?php _e('edit page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Account page', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('This is the page a user will be redirected to when they want to view their account or make a payment on their account.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('It can be left blank to use the standard Membership interface, otherwise it can contain any content you want but &lt;strong&gt;should&lt;/strong&gt; contain the [accountform] shortcode in some location.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Account page', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Select a page to use for the account form. If you do not have one already, then click on &lt;strong&gt;Create Page&lt;/strong&gt; to make one.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(!isset($M_options['account_page'])) {&nbsp;</div></li><li><div>                                        $M_options['account_page'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $pages = wp_dropdown_pages(array('post_type' =&gt; 'page', 'selected' =&gt; $M_options['account_page'], 'name' =&gt; 'account_page', 'show_option_none' =&gt; __('Select a page', 'membership'), 'sort_column'=&gt; 'menu_order, post_title', 'echo' =&gt; 0));&nbsp;</div></li><li><div>                                    echo $pages;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &nbsp;&lt;a href='&lt;?php echo wp_nonce_url(&quot;admin.php?page=&quot; . $page. &quot;&amp;tab=pages&amp;action=createaccountpage&quot;, 'create-accountpage'); ?&gt;' class='button-primary' title='&lt;?php _e('Create a default page for the account page and assign it here.', 'membership'); ?&gt;'&gt;&lt;?php _e('Create page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($M_options['account_page'])) { ?&gt;&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;a href='&lt;?php echo get_permalink($M_options['account_page']); ?&gt;'&gt;&lt;?php _e('view page', 'membership'); ?&gt;&lt;/a&gt; | &lt;a href='&lt;?php echo admin_url('post.php?post=' . $M_options['account_page'] . '&action=edit'); ?&gt;'&gt;&lt;?php _e('edit page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Subscriptions page', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('This is the page a user will be redirected to when they want to view their subscription details and upgrade / renew them.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('It can be left blank to use the standard Membership interface, otherwise it can contain any content you want but &lt;strong&gt;should&lt;/strong&gt; contain the [renewform] shortcode in some location.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Subscriptions page', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Select a page to use for the upgrade form. If you do not have one already, then click on &lt;strong&gt;Create Page&lt;/strong&gt; to make one.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(!isset($M_options['subscriptions_page'])) {&nbsp;</div></li><li><div>                                        $M_options['subscriptions_page'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $pages = wp_dropdown_pages(array('post_type' =&gt; 'page', 'selected' =&gt; $M_options['subscriptions_page'], 'name' =&gt; 'subscriptions_page', 'show_option_none' =&gt; __('Select a page', 'membership'), 'sort_column'=&gt; 'menu_order, post_title', 'echo' =&gt; 0));&nbsp;</div></li><li><div>                                    echo $pages;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &nbsp;&lt;a href='&lt;?php echo wp_nonce_url(&quot;admin.php?page=&quot; . $page. &quot;&amp;tab=pages&amp;action=createsubscriptionspage&quot;, 'create-subscriptionspage'); ?&gt;' class='button-primary' title='&lt;?php _e('Create a default page for the upgrade / renewal page and assign it here.', 'membership'); ?&gt;'&gt;&lt;?php _e('Create page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($M_options['subscriptions_page'])) { ?&gt;&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;a href='&lt;?php echo get_permalink($M_options['subscriptions_page']); ?&gt;'&gt;&lt;?php _e('view page', 'membership'); ?&gt;&lt;/a&gt; | &lt;a href='&lt;?php echo admin_url('post.php?post=' . $M_options['subscriptions_page'] . '&action=edit'); ?&gt;'&gt;&lt;?php _e('edit page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Protected content page', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If a post / page / content is not available to a user, this is the page that they user will be directed to.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('This page will only be displayed if the user has tried to access the post / page / content directly or via a link.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Protected content page', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Select a page to use for the Protected Content message. If you do not have one already, then click on &lt;strong&gt;Create Page&lt;/strong&gt; to make one.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(!isset($M_options['nocontent_page'])) {&nbsp;</div></li><li><div>                                        $M_options['nocontent_page'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $pages = wp_dropdown_pages(array('post_type' =&gt; 'page', 'selected' =&gt; $M_options['nocontent_page'], 'name' =&gt; 'nocontent_page', 'show_option_none' =&gt; __('Select a page', 'membership'), 'sort_column'=&gt; 'menu_order, post_title', 'echo' =&gt; 0));&nbsp;</div></li><li><div>                                    echo $pages;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &nbsp;&lt;a href='&lt;?php echo wp_nonce_url(&quot;admin.php?page=&quot; . $page. &quot;&amp;tab=pages&amp;action=createnoaccesspage&quot;, 'create-noaccesspage'); ?&gt;' class='button-primary' title='&lt;?php _e('Create a default page for the protected content page and assign it here.', 'membership'); ?&gt;'&gt;&lt;?php _e('Create page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($M_options['nocontent_page'])) { ?&gt;&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;a href='&lt;?php echo get_permalink($M_options['nocontent_page']); ?&gt;'&gt;&lt;?php _e('view page', 'membership'); ?&gt;&lt;/a&gt; | &lt;a href='&lt;?php echo admin_url('post.php?post=' . $M_options['nocontent_page'] . '&action=edit'); ?&gt;'&gt;&lt;?php _e('edit page', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_pageoptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_downloads_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Your options have been updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Download / Media Options', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Downloads / Media protection', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('Downloads and media files can be protected by remapping their perceived location.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('Note: If a user determines a files actual location on your server, there is very little we can do to prevent its download, so please be careful about giving out URLs.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Protection method', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('The method of protection can be changed depending on your needs. Membership offers three methods, &lt;strong&gt;Basic&lt;/strong&gt; masks your media directory but leaves any filenames the same, &lt;strong&gt;Complete&lt;/strong&gt; masks the media directory and changes the image filename as well and &lt;strong&gt;Hybrid&lt;/strong&gt; is for use if you are using a host or server that has a problem with the system (such as some installs of nginx).', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php if( empty($M_options['protection_type']) ) $M_options['protection_type'] = 'basic'; ?&gt;&nbsp;</div></li><li><div>                                    &lt;input type='radio' name='protection_type' value='basic' &lt;?php checked($M_options['protection_type'], 'basic'); ?&gt; /&gt;&nbsp;&nbsp;&lt;?php echo __('Basic protection', 'membership'); ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;input type='radio' name='protection_type' value='complete' &lt;?php checked($M_options['protection_type'], 'complete'); ?&gt;/&gt;&nbsp;&nbsp;&lt;?php echo __('Complete protection', 'membership'); ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;input type='radio' name='protection_type' value='hybrid' &lt;?php checked($M_options['protection_type'], 'hybrid'); ?&gt;/&gt;&nbsp;&nbsp;&lt;?php echo __('Hybrid protection', 'membership'); ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Your uploads location', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('This is where membership thinks you have your images stored, if this is not correct then download protection may not work correctly.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo membership_upload_url();  ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Masked download URL', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('This is the URL that the user will see. You can change the end part to something unique.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(!isset($M_options['masked_url'])) {&nbsp;</div></li><li><div>                                            $M_options['masked_url'] = '';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        esc_html_e(trailingslashit(get_option('home')));  ?&gt;&nbsp;&lt;input type='text' name='masked_url' id='masked_url' value='&lt;?php esc_attr_e($M_options['masked_url']);&nbsp;</div></li><li><div>                                    ?&gt;' /&gt;&nbsp;/&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Protected groups', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Place each download group name on a new line, removing used groups will leave content visible to all users/members.', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;textarea name='membershipdownloadgroups' id='membershipdownloadgroups' rows='10' cols='40'&gt;&lt;?php&nbsp;</div></li><li><div>                                    if(!empty($M_options['membershipdownloadgroups'])) {&nbsp;</div></li><li><div>                                        foreach($M_options['membershipdownloadgroups'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                                            if(!empty($value)) {&nbsp;</div></li><li><div>                                                esc_html_e(stripslashes($value)) . &quot;\n&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_downloadsoptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_posts_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Your options have been updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Content Protection Options', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Shortcode protected content', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('You can protect parts of a post or pages content by enclosing it in WordPress shortcodes.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e(&quot;Each level you create has it's own shortcode.&quot;, 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;?php if(!empty($M_options['membershipshortcodes'])) { ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Legacy Shortcodes', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __('Each shortcode can be used to wrap protected content such as [shortcode] Protected content [/shortcode]', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    $written = false;&nbsp;</div></li><li><div>                                    if(!empty($M_options['membershipshortcodes'])) {&nbsp;</div></li><li><div>                                        ?&gt;&nbsp;</div></li><li><div>                                        &lt;input name='membershipshortcodes' type='hidden' value='&lt;?php&nbsp;</div></li><li><div>                                        foreach($M_options['membershipshortcodes'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                                            if(!empty($value)) {&nbsp;</div></li><li><div>                                                $written = true;&nbsp;</div></li><li><div>                                                echo esc_html(stripslashes($value)) . &quot;\n&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        ?&gt;' /&gt;&nbsp;</div></li><li><div>                                        &lt;?php&nbsp;</div></li><li><div>                                        if($written == true) {&nbsp;</div></li><li><div>                                            foreach($M_options['membershipshortcodes'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                                                if(!empty($value)) {&nbsp;</div></li><li><div>                                                    echo &quot;[&quot; . esc_html(stripslashes($value)) . &quot;]&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // Bring in the level based shortcodes to the list here&nbsp;</div></li><li><div>                                        $shortcodes = apply_filters('membership_level_shortcodes', array() );&nbsp;</div></li><li><div>                                        if(!empty($shortcodes)) {&nbsp;</div></li><li><div>                                            foreach($shortcodes as $key =&gt; $value) {&nbsp;</div></li><li><div>                                                if(!empty($value)) {&nbsp;</div></li><li><div>                                                    $written = true;&nbsp;</div></li><li><div>                                                    echo &quot;[&quot; . esc_html(stripslashes($value)) . &quot;]&lt;br/&gt;&quot;;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if($written == false) {&nbsp;</div></li><li><div>                                        echo __('No shortcodes available.', 'membership');&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php } ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Protected content message', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __(&quot;This is the message that is displayed when the content protected by the shortcode can't be shown. Leave blank for no message. HTML allowed.&quot;, 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    $args = array(&quot;textarea_name&quot; =&gt; &quot;shortcodemessage&quot;);&nbsp;</div></li><li><div>                                    if(!isset($M_options['shortcodemessage'])) {&nbsp;</div></li><li><div>                                        $M_options['shortcodemessage'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    wp_editor( __(stripslashes($M_options['shortcodemessage']), 'membership'), &quot;shortcodemessage&quot;, $args );&nbsp;</div></li><li><div>                                    /**&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;textarea name='shortcodemessage' id='shortcodemessage' rows='10' cols='80'&gt;&lt;?php esc_html_e(stripslashes($M_options['shortcodemessage'])); ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    */&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Admin only shortcodes', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('Sometimes plugins create custom shortcodes but only register them in the public part of your site. This means that the Membership plugin admin interface will not be able to show them in the Shortcode rule.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you find that a shortcode you want to protect is missing from the shortcode rule, then you can add it here.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Admin Only Shortcodes', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo $this-&gt;_tips-&gt;add_tip( __(&quot;Place each shortcode text (without the square brackets) on a new line, removing used shortcodes could leave content visible to all users/members.&quot;, 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;textarea name='membershipadminshortcodes' id='membershipadminshortcodes' rows='10' cols='40'&gt;&lt;?php&nbsp;</div></li><li><div>                                    if(!empty($M_options['membershipadminshortcodes'])) {&nbsp;</div></li><li><div>                                        foreach($M_options['membershipadminshortcodes'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                                            if(!empty($value)) {&nbsp;</div></li><li><div>                                                esc_html_e(stripslashes($value)) . &quot;\n&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('More tag default', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('Content placed after the More tag in a post or page can be protected by setting the visibility below. This setting can be overridden within each individual level.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Show content after the More tag', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name='moretagdefault' id='moretagdefault'&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;yes&quot; &lt;?php if(isset($M_options['moretagdefault']) && $M_options['moretagdefault'] == 'yes') echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php _e('Yes - More tag content is visible', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                        &lt;option value=&quot;no&quot; &lt;?php if(isset($M_options['moretagdefault']) && $M_options['moretagdefault'] == 'no') echo &quot;selected='selected'&quot;; ?&gt;&gt;&lt;?php _e('No - More tag content not visible', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('No access message', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php echo $this-&gt;_tips-&gt;add_tip( __(&quot;This is the message that is displayed when the content protected by the moretag can't be shown. Leave blank for no message. HTML allowed.&quot;, 'membership') ); ?&gt;&nbsp;</div></li><li><div>                                &lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    $args = array(&quot;textarea_name&quot; =&gt; &quot;moretagmessage&quot;);&nbsp;</div></li><li><div>                                    if(!isset($M_options['moretagmessage'])) {&nbsp;</div></li><li><div>                                        $M_options['moretagmessage'] = '';&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    wp_editor( __(stripslashes($M_options['moretagmessage']), 'membership'), &quot;moretagmessage&quot;, $args );&nbsp;</div></li><li><div>                                    /**&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;textarea name='moretagmessage' id='moretagmessage' rows='5' cols='40'&gt;&lt;?php esc_html_e(stripslashes($M_options['moretagmessage'])); ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    */&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_postoptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_extras_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Your options have been updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Extra Options', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Payments currency', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('This is the currency that will be used across all gateways. Note: Some gateways have a limited number of currencies available.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Payment currencys', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name=&quot;paymentcurrency&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php&nbsp;</div></li><li><div>                                          $currency = $M_options['paymentcurrency'];&nbsp;</div></li><li><div>                                        $sel_currency = empty($currency) ? 'USD' : $currency;&nbsp;</div></li><li><div>                                        $currencies = array(&nbsp;</div></li><li><div>                                              'AUD' =&gt; __('AUD - Australian Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'BRL' =&gt; __('BRL - Brazilian Real', 'membership'), &nbsp;</div></li><li><div>                                              'CAD' =&gt; __('CAD - Canadian Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'CHF' =&gt; __('CHF - Swiss Franc', 'membership'), &nbsp;</div></li><li><div>                                              'CZK' =&gt; __('CZK - Czech Koruna', 'membership'), &nbsp;</div></li><li><div>                                              'DKK' =&gt; __('DKK - Danish Krone', 'membership'), &nbsp;</div></li><li><div>                                              'EUR' =&gt; __('EUR - Euro', 'membership'), &nbsp;</div></li><li><div>                                              'GBP' =&gt; __('GBP - Pound Sterling', 'membership'), &nbsp;</div></li><li><div>                                              'HKD' =&gt; __('HKD - Hong Kong Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'HUF' =&gt; __('HUF - Hungarian Forint', 'membership'), &nbsp;</div></li><li><div>                                              'ILS' =&gt; __('ILS - Israeli Shekel', 'membership'), &nbsp;</div></li><li><div>                                              'JPY' =&gt; __('JPY - Japanese Yen', 'membership'), &nbsp;</div></li><li><div>                                              'MYR' =&gt; __('MYR - Malaysian Ringgits', 'membership'), &nbsp;</div></li><li><div>                                              'MXN' =&gt; __('MXN - Mexican Peso', 'membership'), &nbsp;</div></li><li><div>                                              'NOK' =&gt; __('NOK - Norwegian Krone', 'membership'), &nbsp;</div></li><li><div>                                              'NZD' =&gt; __('NZD - New Zealand Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'PHP' =&gt; __('PHP - Philippine Pesos', 'membership'), &nbsp;</div></li><li><div>                                              'PLN' =&gt; __('PLN - Polish Zloty', 'membership'), &nbsp;</div></li><li><div>                                              'SEK' =&gt; __('SEK - Swedish Krona', 'membership'), &nbsp;</div></li><li><div>                                              'SGD' =&gt; __('SGD - Singapore Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'TWD' =&gt; __('TWD - Taiwan New Dollars', 'membership'), &nbsp;</div></li><li><div>                                              'THB' =&gt; __('THB - Thai Baht', 'membership'), &nbsp;</div></li><li><div>                                              'USD' =&gt; __('USD - U.S. Dollar', 'membership'), &nbsp;</div></li><li><div>                                              'ZAR' =&gt; __('ZAR - South African Rand')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            $currencies = apply_filters('membership_available_currencies', $currencies);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          foreach ($currencies as $key =&gt; $value) {&nbsp;</div></li><li><div>                                                echo '&lt;option value=&quot;' . esc_attr($key) . '&quot;';&nbsp;</div></li><li><div>                                                if($key == $sel_currency) echo 'selected=&quot;selected&quot;';&nbsp;</div></li><li><div>                                                echo '&gt;' . esc_html($value) . '&lt;/option&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>                                          }&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                      &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Membership renewal', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you are using single payment gateways, then you should set the number of days before expiry that the renewal form is displayed on the Account page.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Renewal period limit', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name=&quot;renewalperiod&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php&nbsp;</div></li><li><div>                                          $renewalperiod = $M_options['renewalperiod'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          for($n=1; $n &lt;= 365; $n++) {&nbsp;</div></li><li><div>                                                echo '&lt;option value=&quot;' . esc_attr($n) . '&quot;';&nbsp;</div></li><li><div>                                                if($n == $renewalperiod) echo 'selected=&quot;selected&quot;';&nbsp;</div></li><li><div>                                                echo '&gt;' . esc_html($n) . '&lt;/option&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>                                          }&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                      &lt;/select&gt;&nbsp;&lt;?php _e('day(s)', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Membership upgrades', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('You should limit the amount of time allowed between membership upgrades in order to prevent members abusing the upgrade process.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Upgrades period limit', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;select name=&quot;upgradeperiod&quot;&gt;&nbsp;</div></li><li><div>                                      &lt;?php&nbsp;</div></li><li><div>                                          $upgradeperiod = $M_options['upgradeperiod'];&nbsp;</div></li><li><div>                                        // Set a default of 1 day, but allow the selection of 0 days&nbsp;</div></li><li><div>                                        if(empty($upgradeperiod) && $upgradeperiod != 0) {&nbsp;</div></li><li><div>                                            $upgradeperiod = 1;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                          for($n=0; $n &lt;= 365; $n++) {&nbsp;</div></li><li><div>                                                echo '&lt;option value=&quot;' . esc_attr($n) . '&quot;';&nbsp;</div></li><li><div>                                                if($n == $upgradeperiod) echo 'selected=&quot;selected&quot;';&nbsp;</div></li><li><div>                                                echo '&gt;' . esc_html($n) . '&lt;/option&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>                                          }&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                      &lt;/select&gt;&nbsp;&lt;?php _e('day(s)', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Membership wizard', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('If you accidentally dismissed the membership wizard and would like to show it again, then check the box below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                        &lt;tbody&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Show membership wizard', 'membership'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                                        if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                                            if(function_exists('switch_to_blog')) {&nbsp;</div></li><li><div>                                                switch_to_blog(MEMBERSHIP_GLOBAL_MAINSITE);&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                            $wizard_visible = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                            if(function_exists('restore_current_blog')) {&nbsp;</div></li><li><div>                                                restore_current_blog();&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $wizard_visible = get_option('membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $wizard_visible = get_option('membership_wizard_visible', 'yes');&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;input type='checkbox' name='membershipwizard' value='yes' &lt;?php if($wizard_visible == 'yes') echo &quot;checked='checked'&quot;; ?&gt;/&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_extrasoptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_users_options() {&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Membership admins have been updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-options-general&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Membership Admin Users', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder m-settings&quot;&gt;&nbsp;</div></li><li><div>            &lt;form action='' method='post'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo $page; ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='action' value='updateoptions' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    wp_nonce_field('update-membership-options');&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Membership Admin Users', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p class='description'&gt;&lt;?php _e('You can add or remove the ability for specific admin user accounts to manage the Membership plugin by checking or unchecking the boxes next to the relevant username.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                            $columns = array(    &quot;name&quot; =&gt;     __('User Login', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $columns = apply_filters('membership_adminuserscolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $wp_user_search = new WP_User_Query( array( 'role' =&gt; 'administrator' ) );&nbsp;</div></li><li><div>                            $admins = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                            &lt;thead&gt;&nbsp;</div></li><li><div>                            &lt;tr&gt;&nbsp;</div></li><li><div>                            &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;tfoot&gt;&nbsp;</div></li><li><div>                            &lt;tr&gt;&nbsp;</div></li><li><div>                            &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                reset($columns);&nbsp;</div></li><li><div>                                foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;tbody&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                if(!empty($admins)) {&nbsp;</div></li><li><div>                                    $user_id = get_current_user_id();&nbsp;</div></li><li><div>                                    foreach($admins as $key =&gt; $admin) {&nbsp;</div></li><li><div>                                        ?&gt;&nbsp;</div></li><li><div>                                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;admin-&lt;?php echo $admin-&gt;ID; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                            &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&nbsp;</div></li><li><div>                                                &lt;?php if($user_id != $admin-&gt;ID) {&nbsp;</div></li><li><div>                                                        $user = new WP_User( $admin-&gt;ID );&nbsp;</div></li><li><div>                                                        if($user-&gt;has_cap('membershipadmin')) {&nbsp;</div></li><li><div>                                                        ?&gt;&nbsp;</div></li><li><div>                                                        &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr($admin-&gt;ID); ?&gt;&quot; name=&quot;admincheck[]&quot; checked='checked'&gt;&nbsp;</div></li><li><div>                                                        &lt;?php&nbsp;</div></li><li><div>                                                        } else {&nbsp;</div></li><li><div>                                                        ?&gt;&nbsp;</div></li><li><div>                                                        &lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr($admin-&gt;ID); ?&gt;&quot; name=&quot;admincheck[]&quot; &gt;&nbsp;</div></li><li><div>                                                        &lt;?php&nbsp;</div></li><li><div>                                                        }&nbsp;</div></li><li><div>                                                     } ?&gt;&nbsp;</div></li><li><div>                                            &lt;/th&gt;&nbsp;</div></li><li><div>                                            &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                                &lt;strong&gt;&lt;?php echo esc_html(stripslashes($admin-&gt;user_login)); ?&gt;&lt;/strong&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                                &lt;?php&nbsp;</div></li><li><div>                                                if($user_id == $admin-&gt;ID) {&nbsp;</div></li><li><div>                                                    _e('You can not remove your own permissions to manage the membership system whilst logged in.', 'membership');&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                                ?&gt;&nbsp;</div></li><li><div>                                            &lt;/td&gt;&nbsp;</div></li><li><div>                                        &lt;/tr&gt;&nbsp;</div></li><li><div>                                        &lt;?php&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                                        &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('There are no Admin users - something may have gone wrong.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                    &lt;/tr&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/tbody&gt;&nbsp;</div></li><li><div>                        &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    do_action( 'membership_adminusersoptions_page' );&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary&quot; value=&quot;&lt;?php esc_attr_e('Save Changes', 'membership'); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_options_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>            if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                if(function_exists('switch_to_blog')) {&nbsp;</div></li><li><div>                    switch_to_blog(MEMBERSHIP_GLOBAL_MAINSITE);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $M_options = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', array());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tab = (isset($_GET['tab'])) ? $_GET['tab'] : '';&nbsp;</div></li><li><div>        if(empty($tab)) {&nbsp;</div></li><li><div>            $tab = 'general';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                $menus = array();&nbsp;</div></li><li><div>                $menus['general'] = __('General', 'membership');&nbsp;</div></li><li><div>                $menus['pages'] = __('Membership Pages', 'membership');&nbsp;</div></li><li><div>                $menus['posts'] = __('Content Protection', 'membership');&nbsp;</div></li><li><div>                $menus['downloads'] = __('Downloads / Media', 'membership');&nbsp;</div></li><li><div>                $menus['users'] = __('Membership Admins', 'membership');&nbsp;</div></li><li><div>                $menus['extras'] = __('Extras', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $menus = apply_filters('membership_options_menus', $menus);&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                    if ( current_user_can('manage_options') && !get_option('permalink_structure') ) {&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;'.__('You must enable Pretty Permalinks for Membership to function correctly - &lt;a href=&quot;options-permalink.php&quot;&gt;Enable now &raquo;&lt;/a&gt;', 'membership').'&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;h3 class=&quot;nav-tab-wrapper&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($menus as $key =&gt; $menu) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;a class=&quot;nav-tab&lt;?php if($tab == $key) echo ' nav-tab-active'; ?&gt;&quot; href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;tab=&lt;?php echo $key; ?&gt;&quot;&gt;&lt;?php echo $menu; ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch($tab) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'general':            $this-&gt;show_general_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'pages':            $this-&gt;show_page_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'posts':            $this-&gt;show_posts_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'downloads':        $this-&gt;show_downloads_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'extras':            $this-&gt;show_extras_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'users':            $this-&gt;show_users_options();&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default:                do_action('membership_option_menu_' . $tab);&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>                if(function_exists('restore_current_blog')) {&nbsp;</div></li><li><div>                    restore_current_blog();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function default_membership_sections($sections) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sections['main'] = array(    &quot;title&quot; =&gt; __('Main rules', 'membership') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sections['content'] = array(    &quot;title&quot; =&gt; __('Content rules', 'membership') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sections;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_level_edit_form($level_id = false, $clone = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page, $M_Rules, $M_SectionRules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($level_id && !$clone) {&nbsp;</div></li><li><div>            $mlevel = new M_Level( $level_id );&nbsp;</div></li><li><div>            $level = $mlevel-&gt;get();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($clone) {&nbsp;</div></li><li><div>                $mlevel = new M_Level( $level_id );&nbsp;</div></li><li><div>                $level = $mlevel-&gt;get();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $level-&gt;level_title .= __(' clone', 'membership');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $level = new stdclass;&nbsp;</div></li><li><div>                $level-&gt;level_title = __('new level', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $level-&gt;id = time() * -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the relevant parts&nbsp;</div></li><li><div>        if(isset($mlevel)) {&nbsp;</div></li><li><div>            $positives = $mlevel-&gt;get_rules('positive');&nbsp;</div></li><li><div>            $negatives = $mlevel-&gt;get_rules('negative');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Re-arrange the rules&nbsp;</div></li><li><div>        $rules = array(); $p = array(); $n = array();&nbsp;</div></li><li><div>        if(!empty($positives)) {&nbsp;</div></li><li><div>            foreach($positives as $positive) {&nbsp;</div></li><li><div>                $rules[$positive-&gt;rule_area] = maybe_unserialize($positive-&gt;rule_value);&nbsp;</div></li><li><div>                $p[$positive-&gt;rule_area] = maybe_unserialize($positive-&gt;rule_value);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(!empty($negatives)) {&nbsp;</div></li><li><div>            foreach($negatives as $negative) {&nbsp;</div></li><li><div>                $rules[$negative-&gt;rule_area] = maybe_unserialize($negative-&gt;rule_value);&nbsp;</div></li><li><div>                $n[$negative-&gt;rule_area] = maybe_unserialize($negative-&gt;rule_value);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check which tab we should open the edit form with&nbsp;</div></li><li><div>        if(!empty($p) && !empty($n)) {&nbsp;</div></li><li><div>            // We have content in both areas - so start with advanced open&nbsp;</div></li><li><div>            $advancedtab = 'activetab';&nbsp;</div></li><li><div>            $negativetab = '';&nbsp;</div></li><li><div>            $positivetab = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $advancedcontent = 'activecontent';&nbsp;</div></li><li><div>            $negativecontent = 'activecontent';&nbsp;</div></li><li><div>            $positivecontent = 'activecontent';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if(!empty($n)) {&nbsp;</div></li><li><div>                // We have content in the negative area - so start with that&nbsp;</div></li><li><div>                $advancedtab = '';&nbsp;</div></li><li><div>                $negativetab = 'activetab';&nbsp;</div></li><li><div>                $positivetab = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $advancedcontent = 'inactivecontent';&nbsp;</div></li><li><div>                $negativecontent = 'activecontent';&nbsp;</div></li><li><div>                $positivecontent = 'inactivecontent';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Default to the positive area&nbsp;</div></li><li><div>                $advancedtab = '';&nbsp;</div></li><li><div>                $negativetab = '';&nbsp;</div></li><li><div>                $positivetab = 'activetab';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $advancedcontent = 'inactivecontent';&nbsp;</div></li><li><div>                $negativecontent = 'inactivecontent';&nbsp;</div></li><li><div>                $positivecontent = 'activecontent';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php echo __('Edit ', 'membership') . &quot; - &quot; . esc_html($level-&gt;level_title); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($usemsg) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[$usemsg] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='level-liquid-left'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div id='level-left'&gt;&nbsp;</div></li><li><div>                    &lt;form action='?page=&lt;?php echo $page; ?&gt;' name='leveledit' method='post'&gt;&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='level_id' id='level_id' value='&lt;?php echo $level-&gt;id; ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='ontab' id='ontab' value='positive' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='beingdragged' id='beingdragged' value='' /&gt;&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='in-positive-rules' id='in-positive-rules' value=', &lt;?php echo implode(', ', array_keys($p)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='in-negative-rules' id='in-negative-rules' value=', &lt;?php echo implode(', ', array_keys($n)); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='postive-rules-order' id='postive-rules-order' value='' /&gt;&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='negative-rules-order' id='negative-rules-order' value='' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='edit-level' class='level-holder-wrap'&gt;&nbsp;</div></li><li><div>                        &lt;div class='sidebar-name no-movecursor'&gt;&nbsp;</div></li><li><div>                            &lt;h3&gt;&lt;?php echo esc_html($level-&gt;level_title); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;div class='level-holder'&gt;&nbsp;</div></li><li><div>                            &lt;div class='level-details'&gt;&nbsp;</div></li><li><div>                            &lt;label for='level_title'&gt;&lt;?php _e('Level title', 'membership'); ?&gt;&lt;/label&gt;&lt;?php //echo $this-&gt;_tips-&gt;add_tip( __('This is the title used throughout the system to identify this level.', 'membership') ); ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                            &lt;input class='wide' type='text' name='level_title' id='level_title' value='&lt;?php echo esc_attr($level-&gt;level_title); ?&gt;' /&gt;&nbsp;</div></li><li><div>                            &lt;br/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                            &lt;label for='level_shortcode'&gt;&lt;?php _e('Level shortcode', 'membership'); ?&gt;&lt;/label&gt;&lt;?php echo $this-&gt;_tips-&gt;add_tip( __('The shortcode for this level is based on the title (above). It can be used to wrap content that you only want to be seen by members on this level e.g. [levelshortcode] protected content [/levelshortcode]', 'membership') ); ?&gt;&nbsp;</div></li><li><div>                            &lt;?php if($level-&gt;id &gt; 0) {&nbsp;</div></li><li><div>                                echo &quot;[&quot; . M_normalize_shortcode($level-&gt;level_title) . &quot;]&quot;;&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                _e('Save your level to create the shortcode', 'membership');&nbsp;</div></li><li><div>                            } ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php do_action('membership_level_form_before_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;ul class='leveltabs'&gt;&nbsp;</div></li><li><div>                                &lt;li class='positivetab &lt;?php echo $positivetab; ?&gt;'&gt;&lt;div class='downarrow'&gt;&lt;/div&gt;&lt;a href='#positive'&gt;&lt;div&gt;&lt;?php _e('Positive Rules', 'membership'); ?&gt;&lt;/div&gt;&lt;/a&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                                &lt;li class='negativetab &lt;?php echo $negativetab; ?&gt;'&gt;&lt;div class='downarrow'&gt;&lt;/div&gt;&lt;a href='#negative'&gt;&lt;div&gt;&lt;?php _e('Negative Rules', 'membership'); ?&gt;&lt;/div&gt;&lt;/a&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                                &lt;li class='advancedtab &lt;?php echo $advancedtab; ?&gt;'&gt;&lt;div class='downarrow'&gt;&lt;/div&gt;&lt;a href='#advanced'&gt;&lt;div&gt;&lt;?php _e('Advanced (both)', 'membership'); ?&gt;&lt;/div&gt;&lt;/a&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                            &lt;/ul&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='advancedtabwarning &lt;?php echo $advancedcontent; ?&gt;'&gt;&nbsp;</div></li><li><div>                                &lt;?php _e('&lt;strong&gt;Warning:&lt;/strong&gt; using both positive and negative rules on the same level can cause conflicts and unpredictable behaviour.', 'membership'); ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='positivecontent &lt;?php echo $positivecontent; ?&gt;'&gt;&nbsp;</div></li><li><div>                                &lt;h3 class='positive positivetitle &lt;?php echo $advancedcontent; ?&gt;'&gt;&lt;?php _e('Positive rules', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php _e('These are the areas / elements that a member of this level can access.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div id='positive-rules' class='level-droppable-rules levels-sortable'&gt;&nbsp;</div></li><li><div>                                    &lt;?php _e('Drop here', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div id='positive-rules-holder'&gt;&nbsp;</div></li><li><div>                                    &lt;?php do_action('membership_level_form_before_positive_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(!empty($p)) {&nbsp;</div></li><li><div>                                            foreach($p as $key =&gt; $value) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                if(isset($M_Rules[$key])) {&nbsp;</div></li><li><div>                                                        $rule = new $M_Rules[$key]();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        $rule-&gt;admin_main($value);&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;?php do_action('membership_level_form_after_positive_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='negativecontent &lt;?php echo $negativecontent; ?&gt;'&gt;&nbsp;</div></li><li><div>                                &lt;h3 class='negative negativetitle &lt;?php echo $advancedcontent; ?&gt;'&gt;&lt;?php _e('Negative rules', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php _e('These are the areas / elements that a member of this level doesn\'t have access to.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div id='negative-rules' class='level-droppable-rules levels-sortable'&gt;&nbsp;</div></li><li><div>                                    &lt;?php _e('Drop here', 'membership'); ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div id='negative-rules-holder'&gt;&nbsp;</div></li><li><div>                                    &lt;?php do_action('membership_level_form_before_negative_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(!empty($n)) {&nbsp;</div></li><li><div>                                            foreach($n as $key =&gt; $value) {&nbsp;</div></li><li><div>                                                if(isset($M_Rules[$key])) {&nbsp;</div></li><li><div>                                                        $rule = new $M_Rules[$key]();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                        $rule-&gt;admin_main($value);&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    &lt;?php do_action('membership_level_form_after_negative_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='advancedcontent &lt;?php echo $advancedcontent; ?&gt;'&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php _e('Custom shortcode protected content message', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                                &lt;p class='description'&gt;&lt;?php _e('If you want a protected content message to be displayed for this level then you can enter it here.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                $args = array(&quot;textarea_name&quot; =&gt; &quot;level_protectedcontent&quot;, &quot;textarea_rows&quot; =&gt; 20);&nbsp;</div></li><li><div>                                if(!empty($mlevel)) {&nbsp;</div></li><li><div>                                    $level_protectedcontent = $mlevel-&gt;get_meta( 'level_protectedcontent' );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if(empty($level_protectedcontent)) {&nbsp;</div></li><li><div>                                    $level_protectedcontent = '';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                wp_editor( stripslashes($level_protectedcontent), &quot;level_protectedcontent&quot;, $args );&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='advancedcontent &lt;?php echo $advancedcontent; ?&gt;'&gt;&nbsp;</div></li><li><div>                            &lt;?php do_action('membership_level_form_after_rules', $level-&gt;id); ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='buttons'&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                if($level-&gt;id &gt; 0) {&nbsp;</div></li><li><div>                                    wp_original_referer_field(true, 'previous'); wp_nonce_field('update-' . $level-&gt;id);&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel edit'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e('Update', 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='updated' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_original_referer_field(true, 'previous'); wp_nonce_field('add-' . $level-&gt;id);&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel add'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e('Add', 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='added' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/form&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div id='hiden-actions'&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sections = apply_filters('membership_level_sections', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach($sections as $key =&gt; $section) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if(isset($M_SectionRules[$key])) {&nbsp;</div></li><li><div>                            foreach($M_SectionRules[$key] as $mrule =&gt; $mclass) {&nbsp;</div></li><li><div>                                $rule = new $mclass();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if(!array_key_exists($mrule, $rules)) {&nbsp;</div></li><li><div>                                    $rule-&gt;admin_main(false);&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- hidden-actions --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt; &lt;!-- level-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='level-liquid-right'&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;level-holder-wrap&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        do_action( 'membership_sidebar_top_level' );&nbsp;</div></li><li><div>                        do_action( 'membership_sidebar_top', 'level' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $sections = apply_filters('membership_level_sections', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach($sections as $key =&gt; $section) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class=&quot;sidebar-name no-movecursor&quot;&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php echo $section['title']; ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;section-holder&quot; id=&quot;sidebar-&lt;?php echo $key; ?&gt;&quot; style=&quot;min-height: 98px;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;ul class='levels level-levels-draggable'&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if(isset($M_SectionRules[$key])) {&nbsp;</div></li><li><div>                                        foreach($M_SectionRules[$key] as $mrule =&gt; $mclass) {&nbsp;</div></li><li><div>                                            $rule = new $mclass();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            if(!array_key_exists($mrule, $rules)) {&nbsp;</div></li><li><div>                                                $rule-&gt;admin_sidebar(false);&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $rule-&gt;admin_sidebar(true);&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;/ul&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- level-holder-wrap --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt; &lt;!-- level-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_levels_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'delete' || addslashes($_GET['action2']) == 'delete') {&nbsp;</div></li><li><div>                $action = 'bulk-delete';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'toggle' || addslashes($_GET['action2']) == 'toggle') {&nbsp;</div></li><li><div>                $action = 'bulk-toggle';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'removeheader':    $this-&gt;dismiss_user_help( $page );&nbsp;</div></li><li><div>                                    wp_safe_redirect( remove_query_arg( 'action' ) );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'added':    $levels = $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>                            if(count($levels) &gt;= 3) {&nbsp;</div></li><li><div>                                wp_die( __( 'Cheatin&#8217; uh?' ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $id = (int) $_POST['level_id'];&nbsp;</div></li><li><div>                                check_admin_referer('add-' . $id);&nbsp;</div></li><li><div>                                if($id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $level = new M_Level($id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if($level-&gt;add()) {&nbsp;</div></li><li><div>                                        // Add in the meta information&nbsp;</div></li><li><div>                                        if(!empty($_POST['level_protectedcontent'])) {&nbsp;</div></li><li><div>                                            $level-&gt;update_meta( 'level_protectedcontent', $_POST['level_protectedcontent'] );&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // redirect&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 1, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>            case 'updated':    $id = (int) $_POST['level_id'];&nbsp;</div></li><li><div>                            check_admin_referer('update-' . $id);&nbsp;</div></li><li><div>                            if($id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $level = new M_Level($id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($level-&gt;update()) {&nbsp;</div></li><li><div>                                    // update the meta information&nbsp;</div></li><li><div>                                    if(!empty($_POST['level_protectedcontent'])) {&nbsp;</div></li><li><div>                                        $level-&gt;update_meta( 'level_protectedcontent', $_POST['level_protectedcontent'] );&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $level-&gt;delete_meta( 'level_protectedcontent' );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    // redirect&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 3, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 5, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 5, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'delete':    if(isset($_GET['level_id'])) {&nbsp;</div></li><li><div>                                $level_id = (int) $_GET['level_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('delete-level_' . $level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $level = new M_Level($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($level-&gt;delete($level_id)) {&nbsp;</div></li><li><div>                                    // delete the meta information&nbsp;</div></li><li><div>                                    $level-&gt;delete_meta( 'level_protectedcontent' );&nbsp;</div></li><li><div>                                    // redirect&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 2, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 6, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'toggle':    if(isset($_GET['level_id'])) {&nbsp;</div></li><li><div>                                $level_id = (int) $_GET['level_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('toggle-level_' . $level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $level = new M_Level($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if( $level-&gt;toggleactivation() ) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 8, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-delete':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-levels');&nbsp;</div></li><li><div>                            foreach($_GET['levelcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $level_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $level = new M_Level($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $level-&gt;delete();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 2, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-toggle':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-levels');&nbsp;</div></li><li><div>                            foreach($_GET['levelcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $level_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $level = new M_Level($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $level-&gt;toggleactivation();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_levels_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'edit':    if(isset($_GET['level_id'])) {&nbsp;</div></li><li><div>                                $level_id = (int) $_GET['level_id'];&nbsp;</div></li><li><div>                                $this-&gt;handle_level_edit_form($level_id);&nbsp;</div></li><li><div>                                return; // So we don't see the rest of this page&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'clone':    if(isset($_GET['clone_id'])) {&nbsp;</div></li><li><div>                                $level_id = (int) $_GET['clone_id'];&nbsp;</div></li><li><div>                                $this-&gt;handle_level_edit_form($level_id, true);&nbsp;</div></li><li><div>                                return; // So we don't see the rest of this page&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['s'])) {&nbsp;</div></li><li><div>            $s = stripslashes($_GET['s']);&nbsp;</div></li><li><div>            $filter['s'] = $s;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $s = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['level_id'])) {&nbsp;</div></li><li><div>            $filter['level_id'] = stripslashes($_GET['level_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['order_by'])) {&nbsp;</div></li><li><div>            $filter['order_by'] = stripslashes($_GET['order_by']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Membership Level added.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Membership Level deleted.', 'membership');&nbsp;</div></li><li><div>        $messages[3] = __('Membership Level updated.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Membership Level not added.', 'membership');&nbsp;</div></li><li><div>        $messages[5] = __('Membership Level not updated.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Membership Level not deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Membership Level activation toggled.', 'membership');&nbsp;</div></li><li><div>        $messages[8] = __('Membership Level activation not toggled.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[9] = __('Membership Levels updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $levels = $this-&gt;get_membership_levels($filter);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Access Levels', 'membership'); ?&gt;&lt;?php if(count($levels) &lt;= 3) { ?&gt;&lt;a class=&quot;add-new-h2&quot; href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;level_id=&quot;&gt;&lt;?php _e('Add New', 'membership'); ?&gt;&lt;/a&gt;&lt;&lt;?php } ?&gt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.levels.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; class=&quot;search-form&quot;&gt;&nbsp;</div></li><li><div>            &lt;p class=&quot;search-box&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;label for=&quot;membership-search-input&quot; class=&quot;screen-reader-text&quot;&gt;&lt;?php _e('Search Levels', 'membership'); ?&gt;:&lt;/label&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($s); ?&gt;&quot; name=&quot;s&quot; id=&quot;membership-search-input&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;submit&quot; class=&quot;button&quot; value=&quot;&lt;?php _e('Search Levels', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class='clear' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;posts-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>            &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;level_id&quot;&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['level_id']) && addslashes($_GET['level_id']) == 'all') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;all&quot;&gt;&lt;?php _e('View all Levels', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['level_id']) && addslashes($_GET['level_id']) == 'active') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;active&quot;&gt;&lt;?php _e('View active Levels', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['level_id']) && addslashes($_GET['level_id']) == 'inactive') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;inactive&quot;&gt;&lt;?php _e('View inactive Levels', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;order_by&quot;&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['order_by']) && addslashes($_GET['order_by']) == 'order_id') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;order_id&quot;&gt;&lt;?php _e('Order by Level ID', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['order_by']) && addslashes($_GET['order_by']) == 'order_name') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;order_name&quot;&gt;&lt;?php _e('Order by Level Name', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary&quot; value=&quot;&lt;?php _e('Filter'); ?&gt;&quot; id=&quot;post-query-submit&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_original_referer_field(true, 'previous'); wp_nonce_field('bulk-levels');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;name&quot; =&gt;     __('Level Name', 'membership'), &nbsp;</div></li><li><div>                                    &quot;active&quot; =&gt;    __('Active', 'membership'), &nbsp;</div></li><li><div>                                    &quot;users&quot; =&gt;    __('Users', 'membership'), &nbsp;</div></li><li><div>                                    &quot;shortcode&quot; =&gt;    __('Shortcode', 'membership') . $this-&gt;_tips-&gt;add_tip( __('The shortcode for this level is based on the title. It can be used to wrap content that you only want to be seen by members on this level e.g. [levelshortcode] protected content [/levelshortcode], use the [not-levelshortcode] shortcodes to wrap content that should be visible to people not on a particular level.', 'membership') )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('membership_levelcolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if($levels) {&nbsp;</div></li><li><div>                        $levelcount = 0;&nbsp;</div></li><li><div>                        foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                            $levelcount++; if($levelcount &gt;= 4) break;&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;level-&lt;?php echo $level-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $level-&gt;id; ?&gt;&quot; name=&quot;levelcheck[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;a title=&quot;&lt;?php _e('Level ID:', 'membership'); ?&gt; &lt;?php echo esc_attr($level-&gt;id); ?&gt;&quot; href=&quot;?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;level_id=&lt;?php echo $level-&gt;id; ?&gt;&quot; class=&quot;row-title&quot;&gt;&lt;?php echo esc_html($level-&gt;level_title); ?&gt;&lt;/a&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>                                        //$actions['id'] = &quot;&lt;strong&gt;&quot; . __('ID : ', 'membership') . $level-&gt;id . &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=edit&amp;level_id=&quot; . $level-&gt;id . &quot;'&gt;&quot; . __('Edit', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        if($level-&gt;level_active == 0) {&nbsp;</div></li><li><div>                                            $actions['toggle'] = &quot;&lt;span class='edit activate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;level_id=&quot; . $level-&gt;id . &quot;&quot;, 'toggle-level_' . $level-&gt;id) . &quot;'&gt;&quot; . __('Activate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $actions['toggle'] = &quot;&lt;span class='edit deactivate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;level_id=&quot; . $level-&gt;id . &quot;&quot;, 'toggle-level_' . $level-&gt;id) . &quot;'&gt;&quot; . __('Deactivate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        $actions['clone'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=clone&amp;clone_id=&quot; . $level-&gt;id . &quot;'&gt;&quot; . __('Clone', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $actions['delete'] = &quot;&lt;span class='delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=delete&amp;level_id=&quot; . $level-&gt;id . &quot;&quot;, 'delete-level_' . $level-&gt;id) . &quot;'&gt;&quot; . __('Delete', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-active&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        switch($level-&gt;level_active) {&nbsp;</div></li><li><div>                                            case 0:    echo &quot;&lt;span  class='membershipinactivestatus'&gt;&quot; . __('Inactive', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                            case 1:    echo &quot;&lt;span  class='membershipactivestatus'&gt;&quot; . __('Active', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-users&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&nbsp;</div></li><li><div>                                        &lt;?php echo $this-&gt;count_on_level( $level-&gt;id ); ?&gt;&nbsp;</div></li><li><div>                                    &lt;/strong&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-shortcode&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo &quot;[&quot; . M_normalize_shortcode($level-&gt;level_title) . &quot;]&quot;; ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;?php echo &quot;[not-&quot; . M_normalize_shortcode($level-&gt;level_title) . &quot;]&quot;; ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No Membership levels where found, click above to add one.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_sub_edit_form($sub_id = false, $clone = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $msub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>        if($sub_id && !$clone) {&nbsp;</div></li><li><div>            $sub = $msub-&gt;get();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if($clone) {&nbsp;</div></li><li><div>                $sub = $msub-&gt;get();&nbsp;</div></li><li><div>                $sub-&gt;sub_name .= __(' clone', 'membership');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $sub = new stdclass;&nbsp;</div></li><li><div>                $sub-&gt;sub_name = __('new subscription', 'membership');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $sub-&gt;id = time() * -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the relevant parts&nbsp;</div></li><li><div>        if(isset($msub)) {&nbsp;</div></li><li><div>            $levels = $msub-&gt;get_levels();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                if($sub-&gt;id &lt; 0) {&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;h2&gt;&lt;?php echo __('Add ', 'membership') . &quot; - &quot; . esc_html($sub-&gt;sub_name); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;h2&gt;&lt;?php echo __('Edit ', 'membership') . &quot; - &quot; . esc_html(stripslashes($sub-&gt;sub_name)); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($usemsg) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[$usemsg] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='sub-liquid-left'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div id='sub-left'&gt;&nbsp;</div></li><li><div>                    &lt;form action='?page=&lt;?php echo $page; ?&gt;' name='subedit' method='post'&gt;&nbsp;</div></li><li><div>                        &lt;input type='hidden' name='sub_id' id='sub_id' value='&lt;?php echo $sub-&gt;id; ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='edit-sub' class='sub-holder-wrap'&gt;&nbsp;</div></li><li><div>                        &lt;div class='sidebar-name no-movecursor'&gt;&nbsp;</div></li><li><div>                            &lt;h3&gt;&lt;?php echo esc_html(stripslashes($sub-&gt;sub_name)); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;div class='sub-holder'&gt;&nbsp;</div></li><li><div>                            &lt;div class='sub-details'&gt;&nbsp;</div></li><li><div>                            &lt;label for='sub_name'&gt;&lt;?php _e('Subscription name', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                            &lt;input class='wide' type='text' name='sub_name' id='sub_name' value='&lt;?php echo esc_attr(stripslashes($sub-&gt;sub_name)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                            &lt;br/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                            &lt;label for='sub_name'&gt;&lt;?php _e('Subscription description', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                            $args = array(&quot;textarea_name&quot; =&gt; &quot;sub_description&quot;, &quot;textarea_rows&quot; =&gt; 5);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if(!isset($sub-&gt;sub_description)) {&nbsp;</div></li><li><div>                                $sub-&gt;sub_description = '';&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_editor( stripslashes($sub-&gt;sub_description), &quot;sub_description&quot;, $args );&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;br/&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                            if(!isset($sub-&gt;sub_pricetext)) {&nbsp;</div></li><li><div>                                $sub-&gt;sub_pricetext = '';&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;label for='sub_pricetext'&gt;&lt;?php _e('Subscription price text', 'membership'); ?&gt;&lt;?php echo $this-&gt;_tips-&gt;add_tip( __('The text you want to show as the price on the subscription form. E.G. Only $25 per month.', 'membership') ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                            &lt;input class='wide' type='text' name='sub_pricetext' id='sub_pricetext' value='&lt;?php echo esc_attr(stripslashes($sub-&gt;sub_pricetext)); ?&gt;' /&gt;&nbsp;</div></li><li><div>                            &lt;?php do_action('membership_subscription_form_after_details', $sub-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php do_action('membership_subscription_form_before_levels', $sub-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;h3&gt;&lt;?php _e('Membership levels', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;p class='description'&gt;&lt;?php _e('These are the levels that are part of this subscription and the order a user will travel through them. Any levels highlighted in red will never be reached due to the settings of previous levels.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                            &lt;div id='membership-levels-start'&gt;&nbsp;</div></li><li><div>                                &lt;div id=&quot;main-start&quot; class=&quot;sub-operation&quot; style=&quot;display: block;&quot;&gt;&nbsp;</div></li><li><div>                                        &lt;h2 class=&quot;sidebar-name&quot;&gt;&lt;?php _e('Starting Point', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>                                        &lt;div class=&quot;inner-operation&quot;&gt;&nbsp;</div></li><li><div>                                            &lt;p class='description'&gt;&lt;?php _e('A new signup for this subscription will start here and immediately pass to the next membership level listed below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                        &lt;/div&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;ul id='membership-levels-holder'&gt;&nbsp;</div></li><li><div>                                &lt;?php do_action('membership_subscription_form_before_level_list', $sub-&gt;id); ?&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $msub-&gt;sub_details();&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;?php do_action('membership_subscription_form_after_level_list', $sub-&gt;id); ?&gt;&nbsp;</div></li><li><div>                            &lt;/ul&gt;&nbsp;</div></li><li><div>                            &lt;div id='membership-levels' class='droppable-levels levels-sortable'&gt;&nbsp;</div></li><li><div>                                &lt;?php _e('Drop here', 'membership'); ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                // Hidden fields&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;input type='hidden' name='beingdragged' id='beingdragged' value='' /&gt;&nbsp;</div></li><li><div>                            &lt;input type='hidden' name='level-order' id='level-order' value=', &lt;?php echo implode(', ', $msub-&gt;levelorder); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php do_action('membership_subscription_form_after_levels', $sub-&gt;id); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class='buttons'&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                if($sub-&gt;id &gt; 0) {&nbsp;</div></li><li><div>                                    wp_original_referer_field(true, 'previous'); wp_nonce_field('update-' . $sub-&gt;id);&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel edit'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e('Update', 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='updated' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_original_referer_field(true, 'previous'); wp_nonce_field('add-' . $sub-&gt;id);&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;a href='?page=&lt;?php echo $page; ?&gt;' class='cancellink' title='Cancel add'&gt;&lt;?php _e('Cancel', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;input type='submit' value='&lt;?php _e('Add', 'membership'); ?&gt;' class='button-primary' /&gt;&nbsp;</div></li><li><div>                                    &lt;input type='hidden' name='action' value='added' /&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/form&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div id='hiden-actions'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;div id='template-holder'&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                            $msub-&gt;sub_template();&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- hidden-actions --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt; &lt;!-- sub-liquid-left --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='sub-liquid-right'&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;sub-holder-wrap&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                do_action( 'membership_sidebar_top_subscription' );&nbsp;</div></li><li><div>                                do_action( 'membership_sidebar_top', 'subscription' );&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;div class=&quot;sidebar-name no-movecursor&quot;&gt;&nbsp;</div></li><li><div>                                &lt;h3&gt;&lt;?php _e('Membership levels', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;level-holder&quot; id=&quot;sidebar-levels&quot; style=&quot;min-height: 98px;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;ul class='subs subs-draggable'&gt;&nbsp;</div></li><li><div>                                &lt;?php&nbsp;</div></li><li><div>                                    $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>                                    foreach( (array) $levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                        &lt;li class='level-draggable' id='level-&lt;?php echo $level-&gt;id; ?&gt;'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            &lt;div class='action action-draggable'&gt;&nbsp;</div></li><li><div>                                                &lt;div class='action-top closed'&gt;&nbsp;</div></li><li><div>                                                &lt;a href=&quot;#available-actions&quot; class=&quot;action-button hide-if-no-js&quot;&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                                &lt;?php echo esc_html($level-&gt;level_title); ?&gt;&nbsp;</div></li><li><div>                                                &lt;/div&gt;&nbsp;</div></li><li><div>                                                &lt;div class='action-body closed'&gt;&nbsp;</div></li><li><div>                                                    &lt;p&gt;&nbsp;</div></li><li><div>                                                        &lt;a href='#addtosubscription' class='action-to-subscription' title=&quot;&lt;?php _e('Add this level to the bottom of the membership levels list.', 'membership'); ?&gt;&quot;&gt;&lt;?php _e('Add to Subscription', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                                    &lt;/p&gt;&nbsp;</div></li><li><div>                                                &lt;/div&gt;&nbsp;</div></li><li><div>                                            &lt;/div&gt;&nbsp;</div></li><li><div>                                        &lt;/li&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;/ul&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt; &lt;!-- sub-holder-wrap --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt; &lt;!-- sub-liquid-right --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_subscriptions_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'delete' || addslashes($_GET['action2']) == 'delete') {&nbsp;</div></li><li><div>                $action = 'bulk-delete';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'toggle' || addslashes($_GET['action2']) == 'toggle') {&nbsp;</div></li><li><div>                $action = 'bulk-toggle';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'togglepublic' || addslashes($_GET['action2']) == 'togglepublic') {&nbsp;</div></li><li><div>                $action = 'bulk-togglepublic';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'removeheader':    $this-&gt;dismiss_user_help( $page );&nbsp;</div></li><li><div>                                    wp_safe_redirect( remove_query_arg( 'action' ) );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'added':    $subs = $this-&gt;get_subscriptions();&nbsp;</div></li><li><div>                            if(count($subs) &gt;= 3) {&nbsp;</div></li><li><div>                                wp_die( __( 'Cheatin&#8217; uh?' ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $id = (int) $_POST['sub_id'];&nbsp;</div></li><li><div>                                check_admin_referer('add-' . $id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($id) {&nbsp;</div></li><li><div>                                    $sub = new M_Subscription( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if($sub-&gt;add()) {&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 1, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>            case 'updated':    $id = (int) $_POST['sub_id'];&nbsp;</div></li><li><div>                            check_admin_referer('update-' . $id);&nbsp;</div></li><li><div>                            if($id) {&nbsp;</div></li><li><div>                                $sub = new M_Subscription( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($sub-&gt;update()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 3, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 5, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 5, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'delete':    if(isset($_GET['sub_id'])) {&nbsp;</div></li><li><div>                                $sub_id = (int) $_GET['sub_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('delete-sub_' . $sub_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($sub-&gt;delete()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 2, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 6, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'togglemakepublic':&nbsp;</div></li><li><div>                            if(isset($_GET['sub_id'])) {&nbsp;</div></li><li><div>                                $sub_id = (int) $_GET['sub_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('togglemakepublic-sub_' . $sub_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $sub-&gt;toggleactivation();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($sub-&gt;togglepublic()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 8, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'toggle':    if(isset($_GET['sub_id'])) {&nbsp;</div></li><li><div>                                $sub_id = (int) $_GET['sub_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('toggle-sub_' . $sub_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($sub-&gt;toggleactivation()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 8, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'togglepublic':&nbsp;</div></li><li><div>                            if(isset($_GET['sub_id'])) {&nbsp;</div></li><li><div>                                $sub_id = (int) $_GET['sub_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('toggle-pubsub_' . $sub_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($sub-&gt;togglepublic()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 9, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 5, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-delete':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-subscriptions');&nbsp;</div></li><li><div>                            foreach($_GET['subcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $sub_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub-&gt;delete();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 2, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-toggle':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-subscriptions');&nbsp;</div></li><li><div>                            foreach($_GET['subcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $sub_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub-&gt;toggleactivation();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-togglepublic':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-subscriptions');&nbsp;</div></li><li><div>                            foreach($_GET['subcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $sub_id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $sub-&gt;togglepublic();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 9, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_subs_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Subscriptions panel&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($action == 'edit') {&nbsp;</div></li><li><div>            if(isset($_GET['sub_id'])) {&nbsp;</div></li><li><div>                $sub_id = (int) $_GET['sub_id'];&nbsp;</div></li><li><div>                $this-&gt;handle_sub_edit_form($sub_id);&nbsp;</div></li><li><div>                return; // So we don't see the rest of this page&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['s'])) {&nbsp;</div></li><li><div>            $s = stripslashes($_GET['s']);&nbsp;</div></li><li><div>            $filter['s'] = $s;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $s = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['sub_status'])) {&nbsp;</div></li><li><div>            $filter['sub_status'] = stripslashes($_GET['sub_status']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['order_by'])) {&nbsp;</div></li><li><div>            $filter['order_by'] = stripslashes($_GET['order_by']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Subscription added.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Subscription deleted.', 'membership');&nbsp;</div></li><li><div>        $messages[3] = __('Subscription updated.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Subscription not added.', 'membership');&nbsp;</div></li><li><div>        $messages[5] = __('Subscription not updated.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Subscription not deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Subscription activation toggled.', 'membership');&nbsp;</div></li><li><div>        $messages[8] = __('Subscription activation not toggled.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[9] = __('Subscriptions updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subs = $this-&gt;get_subscriptions($filter);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap nosubsub'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Subscription Plans', 'membership'); ?&gt;&lt;?php if(count($subs) &lt; 3) { ?&gt;&lt;a class=&quot;add-new-h2&quot; href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;sub_id=&quot;&gt;&lt;?php _e('Add New', 'membership'); ?&gt;&lt;/a&gt;&lt;?php } ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.subscriptions.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; class=&quot;search-form&quot;&gt;&nbsp;</div></li><li><div>            &lt;p class=&quot;search-box&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>                &lt;label for=&quot;subscription-search-input&quot; class=&quot;screen-reader-text&quot;&gt;&lt;?php _e('Search Memberships', 'membership'); ?&gt;:&lt;/label&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($s); ?&gt;&quot; name=&quot;s&quot; id=&quot;subscription-search-input&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;submit&quot; class=&quot;button&quot; value=&quot;&lt;?php _e('Search Subscriptions', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class='clear' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;posts-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>            &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;togglepublic&quot;&gt;&lt;?php _e('Toggle public status', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;sub_status&quot;&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['sub_status']) && addslashes($_GET['sub_id']) == 'all') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;all&quot;&gt;&lt;?php _e('View all subscriptions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['sub_status']) && addslashes($_GET['sub_id']) == 'active') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;active&quot;&gt;&lt;?php _e('View active subscriptions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['sub_status']) && addslashes($_GET['sub_id']) == 'inactive') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;inactive&quot;&gt;&lt;?php _e('View inactive subscriptions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['sub_status']) && addslashes($_GET['sub_id']) == 'public') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;public&quot;&gt;&lt;?php _e('View public subscriptions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['sub_status']) && addslashes($_GET['sub_id']) == 'private') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;private&quot;&gt;&lt;?php _e('View private subscriptions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;select name=&quot;order_by&quot;&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['order_by']) && addslashes($_GET['order_by']) == 'order_id') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;order_id&quot;&gt;&lt;?php _e('Order by subscription ID', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option &lt;?php if(isset($_GET['order_by']) && addslashes($_GET['order_by']) == 'order_name') echo &quot;selected='selected'&quot;; ?&gt; value=&quot;order_name&quot;&gt;&lt;?php _e('Order by subscription name', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary&quot; value=&quot;&lt;?php _e('Filter', 'membership'); ?&gt;&quot; id=&quot;post-query-submit&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_original_referer_field(true, 'previous'); wp_nonce_field('bulk-subscriptions');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;name&quot; =&gt;     __('Subscription Name', 'membership'), &nbsp;</div></li><li><div>                                    &quot;active&quot; =&gt;    __('Active', 'membership'), &nbsp;</div></li><li><div>                                    &quot;public&quot; =&gt;    __('Public', 'membership'), &nbsp;</div></li><li><div>                                    &quot;users&quot; =&gt;    __('Users', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('subscription_columns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if($subs) {&nbsp;</div></li><li><div>                        $subcount = 0;&nbsp;</div></li><li><div>                        foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                            $subcount++; if($subcount &gt;= 4) break;&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;sub-&lt;?php echo $sub-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo $sub-&gt;id; ?&gt;&quot; name=&quot;subcheck[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;a title=&quot;&lt;?php _e('Subscription ID:', 'membership'); ?&gt; &lt;?php echo esc_attr($sub-&gt;id); ?&gt;&quot; href=&quot;?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;sub_id=&lt;?php echo $sub-&gt;id; ?&gt;&quot; class=&quot;row-title&quot;&gt;&lt;?php echo esc_html(stripslashes($sub-&gt;sub_name)); ?&gt;&lt;/a&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>                                        //$actions['id'] = &quot;&lt;strong&gt;&quot; . __('ID : ', 'membership') . $sub-&gt;id . &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=edit&amp;sub_id=&quot; . $sub-&gt;id . &quot;'&gt;&quot; . __('Edit', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if($sub-&gt;sub_active == 0 && $sub-&gt;sub_public == 0) {&nbsp;</div></li><li><div>                                            $actions['toggle'] = &quot;&lt;span class='edit activate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=togglemakepublic&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'togglemakepublic-sub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Activate and Make Public', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            if($sub-&gt;sub_active == 0) {&nbsp;</div></li><li><div>                                                $actions['toggle'] = &quot;&lt;span class='edit activate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'toggle-sub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Activate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $actions['toggle'] = &quot;&lt;span class='edit deactivate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=toggle&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'toggle-sub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Deactivate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                            if($sub-&gt;sub_public == 0) {&nbsp;</div></li><li><div>                                                $actions['public'] = &quot;&lt;span class='edit makeprivate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=togglepublic&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'toggle-pubsub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Make public', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $actions['public'] = &quot;&lt;span class='edit makepublic'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=togglepublic&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'toggle-pubsub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Make private', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $actions['delete'] = &quot;&lt;span class='delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=delete&amp;sub_id=&quot; . $sub-&gt;id . &quot;&quot;, 'delete-sub_' . $sub-&gt;id) . &quot;'&gt;&quot; . __('Delete', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-active&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        switch($sub-&gt;sub_active) {&nbsp;</div></li><li><div>                                            case 0:    echo &quot;&lt;span  class='membershipinactivestatus'&gt;&quot; . __('Inactive', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                            case 1:    echo &quot;&lt;span  class='membershipactivestatus'&gt;&quot; . __('Active', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-public&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        switch($sub-&gt;sub_public) {&nbsp;</div></li><li><div>                                            case 0:    echo __('Private', 'membership');&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                            case 1:    echo &quot;&lt;strong&gt;&quot; . __('Public', 'membership') . &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-users&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&nbsp;</div></li><li><div>                                        &lt;?php echo $this-&gt;count_on_sub( $sub-&gt;id ); ?&gt;&nbsp;</div></li><li><div>                                    &lt;/strong&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No Subscriptions where found, click above to add one.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_urlgroups_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'delete' || addslashes($_GET['action2']) == 'delete') {&nbsp;</div></li><li><div>                $action = 'bulk-delete';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'removeheader':    $this-&gt;dismiss_user_help( $page );&nbsp;</div></li><li><div>                                    wp_safe_redirect( remove_query_arg( 'action' ) );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'added':    check_admin_referer('add-group');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $group = new M_Urlgroup( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if($group-&gt;add()) {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 3, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>            case 'updated':    $id = (int) $_POST['ID'];&nbsp;</div></li><li><div>                            check_admin_referer('update-group-' . $id);&nbsp;</div></li><li><div>                            if($id) {&nbsp;</div></li><li><div>                                $group = new M_Urlgroup( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($group-&gt;update()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 1, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 2, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 2, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'delete':    if(isset($_GET['group'])) {&nbsp;</div></li><li><div>                                $id = (int) $_GET['group'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('delete-group_' . $id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $group = new M_Urlgroup( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($group-&gt;delete()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 5, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 6, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-delete':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-groups');&nbsp;</div></li><li><div>                            foreach($_GET['groupcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $group = new M_Urlgroup( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $group-&gt;delete();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_urlgroups() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT * FROM {$this-&gt;urlgroups} WHERE groupname NOT LIKE (%s) ORDER BY id ASC&quot;, '\_%' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($results)) {&nbsp;</div></li><li><div>            return $results;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_urlgroup_edit( $group_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $group_id === false ) {&nbsp;</div></li><li><div>            $add = new M_Urlgroup( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;div class='wrap'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;h2&gt;&quot; . __('Add URL group', 'membership') . &quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder&quot;&gt;';&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Add URL group', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    echo '&lt;form method=&quot;post&quot; action=&quot;?page=' . $page . '&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input type=&quot;hidden&quot; name=&quot;ID&quot; value=&quot;&quot; /&gt;';&nbsp;</div></li><li><div>                    echo &quot;&lt;input type='hidden' name='action' value='added' /&gt;&quot;;&nbsp;</div></li><li><div>                    wp_nonce_field('add-group');&nbsp;</div></li><li><div>                    $add-&gt;addform();&nbsp;</div></li><li><div>                    echo '&lt;p class=&quot;submit&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input class=&quot;button-primary alignright&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;' . __('Add group', 'membership') . '&quot; /&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>                    echo '&lt;/form&gt;';&nbsp;</div></li><li><div>                    echo '&lt;br/&gt;';&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $edit = new M_Urlgroup( (int) $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;div class='wrap'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;h2&gt;&quot; . __('Edit URL group', 'membership') . &quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder&quot;&gt;';&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Edit URL group', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    echo '&lt;form method=&quot;post&quot; action=&quot;?page=' . $page . '&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input type=&quot;hidden&quot; name=&quot;ID&quot; value=&quot;' . $group_id . '&quot; /&gt;';&nbsp;</div></li><li><div>                    echo &quot;&lt;input type='hidden' name='action' value='updated' /&gt;&quot;;&nbsp;</div></li><li><div>                    wp_nonce_field('update-group-' . $group_id);&nbsp;</div></li><li><div>                    $edit-&gt;editform();&nbsp;</div></li><li><div>                    echo '&lt;p class=&quot;submit&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input class=&quot;button-primary alignright&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;' . __('Update group', 'membership') . '&quot; /&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>                    echo '&lt;/form&gt;';&nbsp;</div></li><li><div>                    echo '&lt;br/&gt;';&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_urlgroups_panel() {&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'edit':    if(!empty($_GET['group'])) {&nbsp;</div></li><li><div>                                // Make a communication&nbsp;</div></li><li><div>                                $this-&gt;show_urlgroup_edit( $_GET['group'] );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $this-&gt;show_urlgroup_edit( false );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            return; // so we don't show the list below&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Group updated.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Group not updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[3] = __('Group added.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Group not added.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[5] = __('Group deleted.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Group not deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Groups deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-edit-pages&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Edit URL Groups', 'membership'); ?&gt;&lt;a class=&quot;add-new-h2&quot; href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;group=&quot;&gt;&lt;?php _e('Add New', 'membership'); ?&gt;&lt;/a&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $groups = $this-&gt;get_urlgroups();&nbsp;</div></li><li><div>            $groups = apply_filters('M_urlgroups_list', $groups);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.urlgroups.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;posts-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>            &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_original_referer_field(true, 'previous'); wp_nonce_field('bulk-groups');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;name&quot; =&gt;     __('Group Name', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('membership_groupscolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if(!empty($groups)) {&nbsp;</div></li><li><div>                        foreach($groups as $key =&gt; $group) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;group-&lt;?php echo $group-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr($group-&gt;id); ?&gt;&quot; name=&quot;groupcheck[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;a title=&quot;&lt;?php _e('Edit', 'membership'); ?&gt; &lt;?php echo esc_attr(stripslashes($group-&gt;groupname)); ?&gt;&quot; href=&quot;?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;group=&lt;?php echo $group-&gt;id; ?&gt;&quot; class=&quot;row-title&quot;&gt;&lt;?php echo esc_html(stripslashes($group-&gt;groupname)); ?&gt;&lt;/a&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>                                        $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=edit&amp;group=&quot; . $group-&gt;id . &quot;'&gt;&quot; . __('Edit', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['delete'] = &quot;&lt;span class='delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=delete&amp;group=&quot; . $group-&gt;id . &quot;&quot;, 'delete-group_' . $group-&gt;id) . &quot;'&gt;&quot; . __('Delete', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No URL groups have been set up.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_ping_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'delete' || addslashes($_GET['action2']) == 'delete') {&nbsp;</div></li><li><div>                $action = 'bulk-delete';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'removeheader':    $this-&gt;dismiss_user_help( $page );&nbsp;</div></li><li><div>                                    wp_safe_redirect( remove_query_arg( 'action' ) );&nbsp;</div></li><li><div>                                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'added':    check_admin_referer('add-ping');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $ping = new M_Ping( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if($ping-&gt;add()) {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 3, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 4, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>            case 'updated':    $id = (int) $_POST['ID'];&nbsp;</div></li><li><div>                            check_admin_referer('update-ping-' . $id);&nbsp;</div></li><li><div>                            if($id) {&nbsp;</div></li><li><div>                                $ping = new M_Ping( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($ping-&gt;update()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 1, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 2, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 2, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'delete':    if(isset($_GET['ping'])) {&nbsp;</div></li><li><div>                                $id = (int) $_GET['ping'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                check_admin_referer('delete-ping_' . $id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $ping = new M_Ping( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($ping-&gt;delete()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 5, wp_get_referer() ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 6, wp_get_referer() ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-delete':&nbsp;</div></li><li><div>                            check_admin_referer('bulk-pings');&nbsp;</div></li><li><div>                            foreach($_GET['pingcheck'] AS $value) {&nbsp;</div></li><li><div>                                if(is_numeric($value)) {&nbsp;</div></li><li><div>                                    $id = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $ping = new M_Ping( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $ping-&gt;delete();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'history':&nbsp;</div></li><li><div>                            if(isset($_GET['history']) && isset($_GET['resend'])) {&nbsp;</div></li><li><div>                                $history = (int) $_GET['history'];&nbsp;</div></li><li><div>                                switch($_GET['resend']) {&nbsp;</div></li><li><div>                                    case 'new':        $ping = new M_Ping( false );&nbsp;</div></li><li><div>                                                    $ping-&gt;resend_historic_ping( $history, true );&nbsp;</div></li><li><div>                                                    wp_safe_redirect( add_query_arg( 'msg', 1, wp_get_referer() ) );&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                    case 'over':    $ping = new M_Ping( false );&nbsp;</div></li><li><div>                                                    $ping-&gt;resend_historic_ping( $history, false );&nbsp;</div></li><li><div>                                                    wp_safe_redirect( add_query_arg( 'msg', 1, wp_get_referer() ) );&nbsp;</div></li><li><div>                                                    break;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_ping_edit( $ping_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $ping_id === false ) {&nbsp;</div></li><li><div>            $add = new M_Ping( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;div class='wrap'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;h2&gt;&quot; . __('Add Ping details', 'membership') . &quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder&quot;&gt;';&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Add ping details', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    echo '&lt;form method=&quot;post&quot; action=&quot;?page=' . $page . '&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input type=&quot;hidden&quot; name=&quot;ID&quot; value=&quot;&quot; /&gt;';&nbsp;</div></li><li><div>                    echo &quot;&lt;input type='hidden' name='action' value='added' /&gt;&quot;;&nbsp;</div></li><li><div>                    wp_nonce_field('add-ping');&nbsp;</div></li><li><div>                    $add-&gt;addform();&nbsp;</div></li><li><div>                    echo '&lt;p class=&quot;submit&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input class=&quot;button-primary alignright&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;' . __('Add ping details', 'membership') . '&quot; /&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>                    echo '&lt;/form&gt;';&nbsp;</div></li><li><div>                    echo '&lt;br/&gt;';&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $edit = new M_Ping( (int) $ping_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;&lt;div class='wrap'&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;h2&gt;&quot; . __('Edit Ping details', 'membership') . &quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder&quot;&gt;';&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;postbox&quot;&gt;&nbsp;</div></li><li><div>                &lt;h3 class=&quot;hndle&quot; style='cursor:auto;'&gt;&lt;span&gt;&lt;?php _e('Edit ping details', 'membership'); ?&gt;&lt;/span&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;inside&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    echo '&lt;form method=&quot;post&quot; action=&quot;?page=' . $page . '&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input type=&quot;hidden&quot; name=&quot;ID&quot; value=&quot;' . $ping_id . '&quot; /&gt;';&nbsp;</div></li><li><div>                    echo &quot;&lt;input type='hidden' name='action' value='updated' /&gt;&quot;;&nbsp;</div></li><li><div>                    wp_nonce_field('update-ping-' . $ping_id);&nbsp;</div></li><li><div>                    $edit-&gt;editform();&nbsp;</div></li><li><div>                    echo '&lt;p class=&quot;submit&quot;&gt;';&nbsp;</div></li><li><div>                    echo '&lt;input class=&quot;button-primary alignright&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;' . __('Update ping details', 'membership') . '&quot; /&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>                    echo '&lt;/form&gt;';&nbsp;</div></li><li><div>                    echo '&lt;br/&gt;';&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_pings() {&nbsp;</div></li><li><div>        $sql = &quot;SELECT * FROM {$this-&gt;pings} ORDER BY id ASC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($results)) {&nbsp;</div></li><li><div>            return $results;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_ping_history_panel( $ping_id ) {&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Ping resent.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Ping not resent.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Pings History', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $ping = new M_Ping( $ping_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $history = $ping-&gt;get_history();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $columns = array(    &quot;name&quot; =&gt;     __('Ping Name', 'membership'), &nbsp;</div></li><li><div>                                &quot;url&quot; =&gt;    __('URL', 'membership'), &nbsp;</div></li><li><div>                                &quot;status&quot; =&gt;    __('Status', 'membership'), &nbsp;</div></li><li><div>                                &quot;date&quot; =&gt;    __('Date', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $columns = apply_filters('membership_pingscolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if(!empty($history)) {&nbsp;</div></li><li><div>                        foreach($history as $key =&gt; $h) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;history-&lt;?php echo $h-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php echo esc_html(stripslashes($ping-&gt;ping_name() )); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>                                        $actions['resendnew'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page . &quot;&amp;action=history&amp;resend=new&amp;history=&quot; . $h-&gt;id, 'membership_resend_ping_' . $h-&gt;id ) . &quot;'&gt;&quot; . __('Resend as new ping', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['resendover'] = &quot;&lt;span class='edit'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page . &quot;&amp;action=history&amp;resend=over&amp;history=&quot; . $h-&gt;id, 'membership_resend_ping_' . $h-&gt;id ) . &quot;'&gt;&quot; . __('Resend and overwrite', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    echo $ping-&gt;ping_url();&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    // Status&nbsp;</div></li><li><div>                                    $status = unserialize($h-&gt;ping_return);&nbsp;</div></li><li><div>                                    if(is_wp_error($status)) {&nbsp;</div></li><li><div>                                        // WP error&nbsp;</div></li><li><div>                                        echo &quot;&lt;span style='color: red;'&gt;&quot; . implode(&quot;&lt;br/&gt;&quot;, $status-&gt;get_error_messages() ) . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        if(!empty($status['response'])) {&nbsp;</div></li><li><div>                                            if($status['response']['code'] == '200') {&nbsp;</div></li><li><div>                                                echo &quot;&lt;span style='color: green;'&gt;&quot; . $status['response']['code'] . &quot; - &quot; . $status['response']['message'] . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                echo &quot;&lt;span style='color: red;'&gt;&quot; . $status['response']['code'] . &quot; - &quot; . $status['response']['message'] . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    //echo $ping-&gt;ping_url();&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                    echo mysql2date( &quot;Y-m-j H:i:s&quot;, $h-&gt;ping_sent );&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns);&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No History available for this ping.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_pings_panel() {&nbsp;</div></li><li><div>        global $action, $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'edit':    if(!empty($_GET['ping'])) {&nbsp;</div></li><li><div>                                // Make a communication&nbsp;</div></li><li><div>                                $this-&gt;show_ping_edit( (int) $_GET['ping'] );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $this-&gt;show_ping_edit( false );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            return; // so we don't show the list below&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'history':&nbsp;</div></li><li><div>                            if(!empty($_GET['ping'])) {&nbsp;</div></li><li><div>                                $this-&gt;handle_ping_history_panel( (int) $_GET['ping'] );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            return;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Ping details updated.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Ping details not updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[3] = __('Ping details added.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Ping details not added.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[5] = __('Ping details deleted.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Ping details not deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Ping details deleted.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-link-manager&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Edit Pings', 'membership'); ?&gt;&lt;a class=&quot;add-new-h2&quot; href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;ping=&quot;&gt;&lt;?php _e('Add New', 'membership'); ?&gt;&lt;/a&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $pings = $this-&gt;get_pings();&nbsp;</div></li><li><div>            $pings = apply_filters('M_pings_list', $pings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.pings.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;posts-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>            &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_original_referer_field(true, 'previous'); wp_nonce_field('bulk-pings');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;name&quot; =&gt;     __('Ping Name', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('membership_pingscolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if(!empty($pings)) {&nbsp;</div></li><li><div>                        foreach($pings as $key =&gt; $ping) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;ping-&lt;?php echo $ping-&gt;id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr($ping-&gt;id); ?&gt;&quot; name=&quot;pingcheck[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;a title=&quot;&lt;?php _e('Edit', 'membership'); ?&gt; &lt;?php echo esc_attr(stripslashes($ping-&gt;pingname)); ?&gt;&quot; href=&quot;?page=&lt;?php echo $page; ?&gt;&amp;action=edit&amp;ping=&lt;?php echo $ping-&gt;id; ?&gt;&quot; class=&quot;row-title&quot;&gt;&lt;?php echo esc_html(stripslashes($ping-&gt;pingname)); ?&gt;&lt;/a&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>                                        $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=edit&amp;ping=&quot; . $ping-&gt;id . &quot;'&gt;&quot; . __('Edit', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['trans'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=history&amp;ping=&quot; . $ping-&gt;id . &quot;'&gt;&quot; . __('History', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        $actions['delete'] = &quot;&lt;span class='delete'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=delete&amp;ping=&quot; . $ping-&gt;id . &quot;&quot;, 'delete-ping_' . $ping-&gt;id) . &quot;'&gt;&quot; . __('Delete', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No Pings have been set up.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_profile_member_page() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Membership details', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(!current_user_is_member()) {&nbsp;</div></li><li><div>                // Not a member so show the message and signup forms&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                    &lt;div class='nonmembermessage'&gt;&nbsp;</div></li><li><div>                    &lt;h3&gt;&lt;?php _e('Not called yet', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;?php _e('Not called yet', 'membership'); ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;div class='signups'&gt;&nbsp;</div></li><li><div>                    &lt;h3&gt;&lt;?php _e('Select a subscription', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&nbsp;</div></li><li><div>                        &lt;?php _e('Please select a subscription from the options below.', 'membership'); ?&gt;&nbsp;</div></li><li><div>                    &lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                        do_action( 'membership_subscription_form_before_subscriptions', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $subs = $this-&gt;get_subscriptions();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        do_action( 'membership_subscription_form_before_paid_subscriptions', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach((array) $subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $subscription = new M_Subscription($sub-&gt;id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;subscription&quot;&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;h3&gt;&lt;?php echo $subscription-&gt;sub_name(); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                                    &lt;p&gt;&lt;?php echo $subscription-&gt;sub_description(); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                $pricing = $subscription-&gt;get_pricingarray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if($pricing) {&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;div class='priceforms'&gt;&nbsp;</div></li><li><div>                                        &lt;?php do_action('membership_purchase_button', $subscription, $pricing, $user_id); ?&gt;&nbsp;</div></li><li><div>                                    &lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        do_action( 'membership_subscription_form_after_paid_subscriptions', $user_id );&nbsp;</div></li><li><div>                        do_action( 'membership_subscription_form_after_subscriptions', $user_id );&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(current_user_has_subscription()) {&nbsp;</div></li><li><div>                    // User has a subscription already. Display the details - and an action to enable upgrading / not upgrading to take place.&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                        &lt;div class='nonmembermessage'&gt;&nbsp;</div></li><li><div>                        &lt;h3&gt;&lt;?php _e('Not called yet', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                        &lt;?php _e('Not called yet', 'membership'); ?&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Media extension options&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    add_filter('attachment_fields_to_edit', array(&$this, 'add_media_protection_settings'), 99, 2);&nbsp;</div></li><li><div>    add_filter('attachment_fields_to_save', array(&$this, 'save_media_protection_settings'), 99, 2);&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function add_media_protection_settings($fields, $post) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $protected = get_post_meta($post-&gt;ID, '_membership_protected_content_group', true);&nbsp;</div></li><li><div>        if(empty($protected)) {&nbsp;</div></li><li><div>            $protected = 'no';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $html = &quot;&lt;select name='attachments[&quot; . $post-&gt;ID . &quot;][protected-content]'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $html .= &quot;&lt;option value='no'&quot;;&nbsp;</div></li><li><div>        $html .= &quot;&gt;&quot; . __('None', 'membership') . &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($M_options['membershipdownloadgroups'])) {&nbsp;</div></li><li><div>            foreach($M_options['membershipdownloadgroups'] as $key =&gt; $value) {&nbsp;</div></li><li><div>                if(!empty($value)) {&nbsp;</div></li><li><div>                    $html .= &quot;&lt;option value='&quot; . esc_attr(trim(stripslashes($value))) . &quot;'&quot;;&nbsp;</div></li><li><div>                    if($protected == esc_attr(trim(stripslashes($value)))) {&nbsp;</div></li><li><div>                        $html .= &quot; selected='selected'&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $html .= &quot;&gt;&quot; . esc_html(trim(stripslashes($value))) . &quot;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $html .= &quot;&lt;/select&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields['media-protected-content'] = array(&nbsp;</div></li><li><div>            'label' =&gt; __('Protected content group', 'membership'), &nbsp;</div></li><li><div>            'input' =&gt; 'html', &nbsp;</div></li><li><div>            'html' =&gt; $html, &nbsp;</div></li><li><div>            'helps' =&gt; __('Is this an item you may want to restrict access to?', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save_media_protection_settings($post, $attachment) {&nbsp;</div></li><li><div>        $key = &quot;protected-content&quot;;&nbsp;</div></li><li><div>        if ( empty( $attachment[$key] ) || addslashes( $attachment[$key] ) == 'no') {&nbsp;</div></li><li><div>            delete_post_meta($post['ID'], '_membership_protected_content_group'); // delete any residual metadata from a free-form field (as inserted below)&nbsp;</div></li><li><div>        } else // free-form text was entered, insert postmeta with credit&nbsp;</div></li><li><div>            update_post_meta($post['ID'], '_membership_protected_content_group', $attachment['protected-content']); // insert 'media-credit' metadata field for image with free-form text&nbsp;</div></li><li><div>        return $post;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Fake shortcode function for administration area - public class has the proper processing function&nbsp;</div></li><li><div>    function do_fake_shortcode($atts, $content = null, $code = &quot;&quot;) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $M_options['shortcodemessage'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    // Database actions&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function update_levelcounts() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT level_id, count(*) AS number FROM {$this-&gt;membership_relationships} WHERE level_id != %d GROUP BY level_id&quot;, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;db-&gt;query( $this-&gt;db-&gt;prepare( &quot;UPDATE {$this-&gt;membership_levels} SET level_count = %d&quot;, 0) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $levels = $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>        if($levels) {&nbsp;</div></li><li><div>            foreach($levels as $key =&gt; $level) {&nbsp;</div></li><li><div>                $this-&gt;db-&gt;update( $this-&gt;membership_levels, array('level_count' =&gt; $level-&gt;number), array('id' =&gt; $level-&gt;level_id) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function update_subcounts() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT sub_id, count(*) AS number FROM {$this-&gt;membership_relationships} WHERE sub_id != %d GROUP BY sub_id&quot;, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;db-&gt;query( $this-&gt;db-&gt;prepare( &quot;UPDATE {$this-&gt;subscriptions} SET sub_count = %d&quot;, 0) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subs = $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>        if($subs) {&nbsp;</div></li><li><div>            foreach($subs as $key =&gt; $sub) {&nbsp;</div></li><li><div>                $this-&gt;db-&gt;update( $this-&gt;subscriptions, array('sub_count' =&gt; $sub-&gt;number), array('id' =&gt; $sub-&gt;sub_id) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_membership_levels($filter = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($filter) {&nbsp;</div></li><li><div>            $where = array();&nbsp;</div></li><li><div>            $orderby = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['s'])) {&nbsp;</div></li><li><div>                $where[] = &quot;level_title LIKE '%&quot; . mysql_real_escape_string($filter['s']) . &quot;%'&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['level_id'])) {&nbsp;</div></li><li><div>                switch($filter['level_id']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'active':        $where[] = &quot;level_active = 1&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'inactive':    $where[] = &quot;level_active = 0&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['order_by'])) {&nbsp;</div></li><li><div>                switch($filter['order_by']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'order_id':    $orderby[] = 'id ASC';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'order_name':    $orderby[] = 'level_title ASC';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT * FROM {$this-&gt;membership_levels}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($where)) {&nbsp;</div></li><li><div>            $sql .= &quot; WHERE &quot; . implode(' AND ', $where);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($orderby)) {&nbsp;</div></li><li><div>            $sql .= &quot; ORDER BY &quot; . implode(', ', $orderby);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //subscriptions&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_public_subscriptions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = array();&nbsp;</div></li><li><div>        $orderby = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where[] = &quot;sub_public = 1&quot;;&nbsp;</div></li><li><div>        $where[] = &quot;sub_active = 1&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orderby[] = 'id ASC';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT * FROM {$this-&gt;subscriptions}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($where)) {&nbsp;</div></li><li><div>            $sql .= &quot; WHERE &quot; . implode(' AND ', $where);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($orderby)) {&nbsp;</div></li><li><div>            $sql .= &quot; ORDER BY &quot; . implode(', ', $orderby);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_subscriptions($filter = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($filter) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $where = array();&nbsp;</div></li><li><div>            $orderby = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['s'])) {&nbsp;</div></li><li><div>                $where[] = &quot;sub_name LIKE '%&quot; . mysql_real_escape_string($filter['s']) . &quot;%'&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['sub_status'])) {&nbsp;</div></li><li><div>                switch($filter['sub_status']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'active':        $where[] = &quot;sub_active = 1&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'inactive':    $where[] = &quot;sub_active = 0&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'public':        $where[] = &quot;sub_public = 1&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'private':        $where[] = &quot;sub_public = 0&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['order_by'])) {&nbsp;</div></li><li><div>                switch($filter['order_by']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'order_id':    $orderby[] = 'id ASC';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'order_name':    $orderby[] = 'sub_name ASC';&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT * FROM {$this-&gt;subscriptions}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($where)) {&nbsp;</div></li><li><div>            $sql .= &quot; WHERE &quot; . implode(' AND ', $where);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($orderby)) {&nbsp;</div></li><li><div>            $sql .= &quot; ORDER BY &quot; . implode(', ', $orderby);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_subscriptions_and_levels($filter = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($filter) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $where = array();&nbsp;</div></li><li><div>            $orderby = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['s'])) {&nbsp;</div></li><li><div>                $where[] = &quot;sub_name LIKE '%&quot; . mysql_real_escape_string($filter['s']) . &quot;%'&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($filter['sub_status'])) {&nbsp;</div></li><li><div>                switch($filter['sub_status']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'active':        $where[] = &quot;sub_active = 1&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'inactive':    $where[] = &quot;sub_active = 0&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'public':        $where[] = &quot;sub_public = 1&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>                    case 'private':        $where[] = &quot;sub_public = 0&quot;;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT s.id as sub_id, ml.id as level_id, s.*, ml.*, sl.level_order FROM {$this-&gt;subscriptions} AS s, {$this-&gt;subscriptions_levels} AS sl, {$this-&gt;membership_levels} AS ml&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($where)) {&nbsp;</div></li><li><div>            $sql .= &quot; WHERE &quot; . implode(' AND ', $where);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql .= &quot; AND s.id = sl.sub_id AND sl.level_id = ml.id ORDER BY s.id ASC, sl.level_order ASC &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_results($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function count_on_level( $level_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT count(*) as levelcount FROM {$this-&gt;membership_relationships} WHERE level_id = %d AND user_id &gt; 0&quot;, $level_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function count_on_sub( $sub_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $this-&gt;db-&gt;prepare( &quot;SELECT count(*) as levelcount FROM {$this-&gt;membership_relationships} WHERE sub_id = %d AND user_id &gt; 0&quot;, $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Rewrites&nbsp;</div></li><li><div>    function add_rewrites($wp_rewrite) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // This function adds in the api rewrite rules&nbsp;</div></li><li><div>        // Note the addition of the namespace variable so that we know these are vent based&nbsp;</div></li><li><div>        // calls&nbsp;</div></li><li><div>        $new_rules = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($M_options['masked_url'])) {&nbsp;</div></li><li><div>            $new_rules[trailingslashit($M_options['masked_url']) . '(.+)'] = 'index.php?protectedfile=' . $wp_rewrite-&gt;preg_index(1);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_rules['paymentreturn/(.+)'] = 'index.php?paymentgateway=' . $wp_rewrite-&gt;preg_index(1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_rules = apply_filters('M_rewrite_rules', $new_rules);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wp_rewrite-&gt;rules = array_merge($new_rules, $wp_rewrite-&gt;rules);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wp_rewrite;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_queryvars($vars) {&nbsp;</div></li><li><div>        if(!in_array('feedkey', $vars)) $vars[] = 'feedkey';&nbsp;</div></li><li><div>        if(!in_array('protectedfile', $vars)) $vars[] = 'protectedfile';&nbsp;</div></li><li><div>        if(!in_array('paymentgateway', $vars)) $vars[] = 'paymentgateway';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $vars;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Profile&nbsp;</div></li><li><div>    function add_profile_feed_key($profileuser) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $profileuser-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $member = new M_Membership($id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($member-&gt;is_member()) {&nbsp;</div></li><li><div>            $key = get_user_meta($id, '_membership_key', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(empty($key)) {&nbsp;</div></li><li><div>                $key = md5($id . $profileuser-&gt;user_pass . time());&nbsp;</div></li><li><div>                update_user_meta($id, '_membership_key', $key);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;h3&gt;&lt;?php _e('Membership key', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th&gt;&lt;label for=&quot;description&quot;&gt;&lt;?php _e('Membership key', 'membership'); ?&gt;&lt;/label&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php esc_html_e($key); ?&gt;&nbsp;</div></li><li><div>                    &lt;br /&gt;&nbsp;</div></li><li><div>                &lt;span class=&quot;description&quot;&gt;&lt;?php _e('This key is used to give you access the the members RSS feed, keep it safe and secret.', 'membership'); ?&gt;&lt;/span&gt;&lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function update_membershipadmin_capability($user_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = new WP_User( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_POST['membershipadmin']) && $_POST['membershipadmin'] == 'yes') {&nbsp;</div></li><li><div>            $user-&gt;add_cap('membershipadmin');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $user-&gt;remove_cap('membershipadmin');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_membershipadmin_capability($profileuser) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $profileuser-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;h3&gt;&lt;?php _e('Membership Administration', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>        &lt;tr&gt;&nbsp;</div></li><li><div>            &lt;th&gt;&lt;label for=&quot;description&quot;&gt;&lt;?php _e('Membership Administration', 'membership'); ?&gt;&lt;/label&gt;&lt;/th&gt;&nbsp;</div></li><li><div>            &lt;td&gt;&nbsp;</div></li><li><div>            &lt;input type='checkbox' name='membershipadmin' value='yes' &lt;?php if($profileuser-&gt;has_cap('membershipadmin')) echo &quot;checked='checked'&quot;; ?&gt;/&gt;&nbsp;</div></li><li><div>            &nbsp;&nbsp;</div></li><li><div>            &lt;span class=&quot;description&quot;&gt;&lt;?php _e('This user has access to administer the Membership system.', 'membership'); ?&gt;&lt;/span&gt;&lt;/td&gt;&nbsp;</div></li><li><div>        &lt;/tr&gt;&nbsp;</div></li><li><div>        &lt;/table&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Ping interface */&nbsp;</div></li><li><div>    function update_subscription_ping_information( $sub_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscription = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscription-&gt;update_meta( 'joining_ping', $_POST['joiningping'] );&nbsp;</div></li><li><div>        $subscription-&gt;update_meta( 'leaving_ping', $_POST['leavingping'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_subscription_ping_information( $sub_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get all the pings&nbsp;</div></li><li><div>        $pings = $this-&gt;get_pings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the currentlt set ping for each level&nbsp;</div></li><li><div>        $subscription = new M_Subscription( $sub_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $joinping = $subscription-&gt;get_meta( 'joining_ping', '' );&nbsp;</div></li><li><div>        $leaveping = $subscription-&gt;get_meta( 'leaving_ping', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;h3&gt;&lt;?php _e('Subscription Pings', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>            &lt;p class='description'&gt;&lt;?php _e('If you want any pings to be sent when a member joins and/or leaves this subscription then set them below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='sub-details'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;label for='joiningping'&gt;&lt;?php _e('Joining Ping', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>            &lt;select name='joiningping'&gt;&nbsp;</div></li><li><div>                &lt;option value='' &lt;?php selected($joinping, ''); ?&gt;&gt;&lt;?php _e('None', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    if(!empty($pings)) {&nbsp;</div></li><li><div>                        foreach($pings as $ping) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;option value='&lt;?php echo $ping-&gt;id; ?&gt;' &lt;?php selected($joinping, $ping-&gt;id); ?&gt;&gt;&lt;?php echo stripslashes($ping-&gt;pingname); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&lt;br/&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;label for='leavingping'&gt;&lt;?php _e('Leaving Ping', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>            &lt;select name='leavingping'&gt;&nbsp;</div></li><li><div>                &lt;option value='' &lt;?php selected($leaveping, ''); ?&gt;&gt;&lt;?php _e('None', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    if(!empty($pings)) {&nbsp;</div></li><li><div>                        foreach($pings as $ping) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;option value='&lt;?php echo $ping-&gt;id; ?&gt;' &lt;?php selected($leaveping, $ping-&gt;id); ?&gt;&gt;&lt;?php echo stripslashes($ping-&gt;pingname); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function update_level_ping_information( $level_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $level = new M_Level( $level_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $level-&gt;update_meta( 'joining_ping', $_POST['joiningping'] );&nbsp;</div></li><li><div>        $level-&gt;update_meta( 'leaving_ping', $_POST['leavingping'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function show_level_ping_information( $level_id ) {&nbsp;</div></li><li><div>        // Get all the pings&nbsp;</div></li><li><div>        $pings = $this-&gt;get_pings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the currentlt set ping for each level&nbsp;</div></li><li><div>        $level = new M_Level( $level_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $joinping = $level-&gt;get_meta( 'joining_ping', '' );&nbsp;</div></li><li><div>        $leaveping = $level-&gt;get_meta( 'leaving_ping', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>            &lt;h3&gt;&lt;?php _e('Level Pings', 'membership'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>            &lt;p class='description'&gt;&lt;?php _e('If you want any pings to be sent when a member joins and/or leaves this level then set them below.', 'membership'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class='level-details'&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;label for='joiningping'&gt;&lt;?php _e('Joining Ping', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>            &lt;select name='joiningping'&gt;&nbsp;</div></li><li><div>                &lt;option value='' &lt;?php selected($joinping, ''); ?&gt;&gt;&lt;?php _e('None', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    if(!empty($pings)) {&nbsp;</div></li><li><div>                        foreach($pings as $ping) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;option value='&lt;?php echo $ping-&gt;id; ?&gt;' &lt;?php selected($joinping, $ping-&gt;id); ?&gt;&gt;&lt;?php echo stripslashes($ping-&gt;pingname); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&lt;br/&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;label for='leavingping'&gt;&lt;?php _e('Leaving Ping', 'membership'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>            &lt;select name='leavingping'&gt;&nbsp;</div></li><li><div>                &lt;option value='' &lt;?php selected($leaveping, ''); ?&gt;&gt;&lt;?php _e('None', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    if(!empty($pings)) {&nbsp;</div></li><li><div>                        foreach($pings as $ping) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;option value='&lt;?php echo $ping-&gt;id; ?&gt;' &lt;?php selected($leaveping, $ping-&gt;id); ?&gt;&gt;&lt;?php echo stripslashes($ping-&gt;pingname); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_gateways_panel_updates() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $M_Gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_GET['doaction']) || isset($_GET['doaction2'])) {&nbsp;</div></li><li><div>            if(addslashes($_GET['action']) == 'toggle' || addslashes($_GET['action2']) == 'toggle') {&nbsp;</div></li><li><div>                $action = 'bulk-toggle';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = get_option('membership_activated_gateways', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'deactivate':    $key = addslashes($_GET['gateway']);&nbsp;</div></li><li><div>                                if(!empty($key)) {&nbsp;</div></li><li><div>                                    check_admin_referer('toggle-gateway-' . $key);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $found = array_search($key, $active);&nbsp;</div></li><li><div>                                    if($found !== false) {&nbsp;</div></li><li><div>                                        unset($active[$found]);&nbsp;</div></li><li><div>                                        update_option('membership_activated_gateways', array_unique($active));&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 5, wp_get_referer() ) );&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 6, wp_get_referer() ) );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'activate':    $key = addslashes($_GET['gateway']);&nbsp;</div></li><li><div>                                if(!empty($key)) {&nbsp;</div></li><li><div>                                    check_admin_referer('toggle-gateway-' . $key);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if(!in_array($key, $active)) {&nbsp;</div></li><li><div>                                        $active[] = $key;&nbsp;</div></li><li><div>                                        update_option('membership_activated_gateways', array_unique($active));&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 3, wp_get_referer() ) );&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        wp_safe_redirect( add_query_arg( 'msg', 4, wp_get_referer() ) );&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'bulk-toggle':&nbsp;</div></li><li><div>                                check_admin_referer('bulk-gateways');&nbsp;</div></li><li><div>                                foreach($_GET['gatewaycheck'] AS $key) {&nbsp;</div></li><li><div>                                    $found = array_search($key, $active);&nbsp;</div></li><li><div>                                    if($found !== false) {&nbsp;</div></li><li><div>                                        unset($active[$found]);&nbsp;</div></li><li><div>                                    } else {&nbsp;</div></li><li><div>                                        $active[] = $key;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                update_option('membership_activated_gateways', array_unique($active));&nbsp;</div></li><li><div>                                wp_safe_redirect( add_query_arg( 'msg', 7, wp_get_referer() ) );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'updated':        $gateway = addslashes($_POST['gateway']);&nbsp;</div></li><li><div>                                check_admin_referer('updated-' . $gateway);&nbsp;</div></li><li><div>                                if($M_Gateways[$gateway]-&gt;update()) {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 1, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    wp_safe_redirect( add_query_arg( 'msg', 2, 'admin.php?page=' . $page ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function handle_gateways_panel() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $action, $page, $M_Gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_reset_vars( array('action', 'page') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch(addslashes($action)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'edit':    if(isset($M_Gateways[addslashes($_GET['gateway'])])) {&nbsp;</div></li><li><div>                                $M_Gateways[addslashes($_GET['gateway'])]-&gt;settings();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            return; // so we don't show the list below&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'transactions':&nbsp;</div></li><li><div>                            if(isset($M_Gateways[addslashes($_GET['gateway'])])) {&nbsp;</div></li><li><div>                                $M_Gateways[addslashes($_GET['gateway'])]-&gt;transactions();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            return; // so we don't show the list below&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages = array();&nbsp;</div></li><li><div>        $messages[1] = __('Gateway updated.', 'membership');&nbsp;</div></li><li><div>        $messages[2] = __('Gateway not updated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[3] = __('Gateway activated.', 'membership');&nbsp;</div></li><li><div>        $messages[4] = __('Gateway not activated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[5] = __('Gateway deactivated.', 'membership');&nbsp;</div></li><li><div>        $messages[6] = __('Gateway not deactivated.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messages[7] = __('Gateway activation toggled.', 'membership');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;icon32&quot; id=&quot;icon-plugins&quot;&gt;&lt;br&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h2&gt;&lt;?php _e('Edit Gateways', 'membership'); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            if ( isset($_GET['msg']) ) {&nbsp;</div></li><li><div>                echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;' . $messages[(int) $_GET['msg']] . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>                $_SERVER['REQUEST_URI'] = remove_query_arg(array('message'), $_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($this-&gt;show_user_help( $page )) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;div class='screenhelpheader'&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;admin.php?page=&lt;?php echo $page; ?&gt;&amp;action=removeheader&quot; class=&quot;welcome-panel-close&quot;&gt;&lt;?php _e('Dismiss', 'membership'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    ob_start();&nbsp;</div></li><li><div>                    include_once(membership_dir('membershipincludes/help/header.gateways.php'));&nbsp;</div></li><li><div>                    echo ob_get_clean();&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;form method=&quot;get&quot; action=&quot;?page=&lt;?php echo esc_attr($page); ?&gt;&quot; id=&quot;posts-filter&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;input type='hidden' name='page' value='&lt;?php echo esc_attr($page); ?&gt;' /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action&quot;&gt;&nbsp;</div></li><li><div>            &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation', 'membership'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction&quot; name=&quot;doaction&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                wp_original_referer_field(true, 'previous'); wp_nonce_field('bulk-gateways');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = array(    &quot;name&quot; =&gt;    __('Gateway Name', 'membership'), &nbsp;</div></li><li><div>                                    &quot;active&quot; =&gt;    __('Active', 'membership')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $columns = apply_filters('membership_gatewaycolumns', $columns);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $gateways = get_membership_gateways();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $active = get_option('membership_activated_gateways', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed&quot;&gt;&nbsp;</div></li><li><div>                &lt;thead&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; id=&quot;cb&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/thead&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tfoot&gt;&nbsp;</div></li><li><div>                &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;th style=&quot;&quot; class=&quot;manage-column column-cb check-column&quot; scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                    reset($columns);&nbsp;</div></li><li><div>                    foreach($columns as $key =&gt; $col) {&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;th style=&quot;&quot; class=&quot;manage-column column-&lt;?php echo $key; ?&gt;&quot; id=&quot;&lt;?php echo $key; ?&gt;&quot; scope=&quot;col&quot;&gt;&lt;?php echo $col; ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    if($gateways) {&nbsp;</div></li><li><div>                        foreach($gateways as $key =&gt; $gateway) {&nbsp;</div></li><li><div>                            $default_headers = array(&nbsp;</div></li><li><div>                                                'Name' =&gt; 'Addon Name', &nbsp;</div></li><li><div>                                                'Author' =&gt; 'Author', &nbsp;</div></li><li><div>                                                'Description' =&gt;    'Description', &nbsp;</div></li><li><div>                                                'AuthorURI' =&gt; 'Author URI', &nbsp;</div></li><li><div>                                                'gateway_id' =&gt; 'Gateway ID'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $gateway_data = get_file_data( membership_dir('membershipincludes/gateways/' . $gateway), $default_headers, 'plugin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if(empty($gateway_data['Name'])) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; id=&quot;gateway-&lt;?php echo $gateway_data['gateway_id']; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                                &lt;th class=&quot;check-column&quot; scope=&quot;row&quot;&gt;&lt;input type=&quot;checkbox&quot; value=&quot;&lt;?php echo esc_attr($gateway_data['gateway_id']); ?&gt;&quot; name=&quot;gatewaycheck[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-name&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php echo esc_html($gateway_data['Name']) ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                    &lt;?php if(!empty($gateway_data['Description'])) {&nbsp;</div></li><li><div>                                        ?&gt;&lt;br/&gt;&lt;?php echo esc_html($gateway_data['Description']);&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $actions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if(in_array($gateway_data['gateway_id'], $active)) {&nbsp;</div></li><li><div>                                            $actions['edit'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=edit&amp;gateway=&quot; . $gateway_data['gateway_id'] . &quot;'&gt;&quot; . __('Settings', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            $actions['transactions'] = &quot;&lt;span class='edit'&gt;&lt;a href='?page=&quot; . $page . &quot;&amp;action=transactions&amp;gateway=&quot; . $gateway_data['gateway_id'] . &quot;'&gt;&quot; . __('View transactions', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                            $actions['toggle'] = &quot;&lt;span class='edit deactivate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=deactivate&amp;gateway=&quot; . $gateway_data['gateway_id'] . &quot;&quot;, 'toggle-gateway-' . $gateway_data['gateway_id']) . &quot;'&gt;&quot; . __('Deactivate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $actions['toggle'] = &quot;&lt;span class='edit activate'&gt;&lt;a href='&quot; . wp_nonce_url(&quot;?page=&quot; . $page. &quot;&amp;action=activate&amp;gateway=&quot; . $gateway_data['gateway_id'] . &quot;&quot;, 'toggle-gateway-' . $gateway_data['gateway_id']) . &quot;'&gt;&quot; . __('Activate', 'membership') . &quot;&lt;/a&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;br&gt;&lt;div class=&quot;row-actions&quot;&gt;&lt;?php echo implode(&quot; | &quot;, $actions); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                    &lt;/td&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;td class=&quot;column-active&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php&nbsp;</div></li><li><div>                                        if(in_array($gateway_data['gateway_id'], $active)) {&nbsp;</div></li><li><div>                                            echo &quot;&lt;span  class='membershipactivestatus'&gt;&quot; . __('Active', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            echo &quot;&lt;span  class='membershipinactivestatus'&gt;&quot; . __('Inactive', 'membership') . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;/tr&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $columncount = count($columns) + 1;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr valign=&quot;middle&quot; class=&quot;alternate&quot; &gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;&lt;?php echo $columncount; ?&gt;&quot; scope=&quot;row&quot;&gt;&lt;?php _e('No Gateways where found for this install.', 'membership'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>            &lt;select name=&quot;action2&quot;&gt;&nbsp;</div></li><li><div>                &lt;option selected=&quot;selected&quot; value=&quot;&quot;&gt;&lt;?php _e('Bulk Actions'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;option value=&quot;toggle&quot;&gt;&lt;?php _e('Toggle activation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;/select&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button-secondary action&quot; id=&quot;doaction2&quot; name=&quot;doaction2&quot; value=&quot;&lt;?php _e('Apply', 'membership'); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;alignright actions&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;br class=&quot;clear&quot;&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/div&gt; &lt;!-- wrap --&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_coupons( $filter = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT * FROM {$this-&gt;coupons}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_network_admin()) {&nbsp;</div></li><li><div>            // We are on a single site admin interface&nbsp;</div></li><li><div>            $sql .= $this-&gt;db-&gt;prepare( &quot; WHERE site_id = %d&quot;, $blog_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;db-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function activate_addon( $addon ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = get_option('membership_activated_addons', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!in_array($addon, $active)) {&nbsp;</div></li><li><div>            $active[] = $addon;&nbsp;</div></li><li><div>            update_option('membership_activated_addons', array_unique($active));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deactivate_addon( $addon ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = get_option('membership_activated_addons', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $found = array_search($addon, $active);&nbsp;</div></li><li><div>        if($found !== false) {&nbsp;</div></li><li><div>            unset($active[$found]);&nbsp;</div></li><li><div>            update_option('membership_activated_addons', array_unique($active));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The popover registration functions added to the bottom of this class until a new more suitable home can be found&nbsp;</div></li><li><div>    function popover_signup_form() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_signup_form_before_content', $content );&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        if( defined('MEMBERSHIP_POPOVER_SIGNUP_FORM') && file_exists( MEMBERSHIP_POPOVER_SIGNUP_FORM ) ) {&nbsp;</div></li><li><div>            include_once( MEMBERSHIP_POPOVER_SIGNUP_FORM );&nbsp;</div></li><li><div>        } elseif(file_exists( apply_filters('membership_override_popover_signup_form', membership_dir('membershipincludes/includes/popover_signup.form.php')) ) ) {&nbsp;</div></li><li><div>            include_once( apply_filters('membership_override_popover_signup_form', membership_dir('membershipincludes/includes/popover_signup.form.php')) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $content .= ob_get_contents();&nbsp;</div></li><li><div>        ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_signup_form_after_content', $content );&nbsp;</div></li><li><div>        echo $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function popover_register_process() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $M_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //include_once(ABSPATH . WPINC . '/registration.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!wp_verify_nonce( $_POST['nonce'], 'membership_register')) {&nbsp;</div></li><li><div>            $error-&gt;add('invalid', __('Invalid form submission.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!validate_username( $_POST['user_login'] )) {&nbsp;</div></li><li><div>            $error-&gt;add('usernamenotvalid', __('The username is not valid, sorry.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(username_exists(sanitize_user($_POST['user_login']))) {&nbsp;</div></li><li><div>            $error-&gt;add('usernameexists', __('That username is already taken, sorry.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_email($_POST['email'])) {&nbsp;</div></li><li><div>            $error-&gt;add('emailnotvalid', __('The email address is not valid, sorry.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(email_exists($_POST['email'])) {&nbsp;</div></li><li><div>            $error-&gt;add('emailexists', __('That email address is already taken, sorry.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error = apply_filters( 'membership_subscription_form_before_registration_process', $error );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_wp_error($error)) {&nbsp;</div></li><li><div>            $anyerrors = $error-&gt;get_error_messages();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $anyerrors = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty($anyerrors) ) {&nbsp;</div></li><li><div>            // Pre - error reporting check for final add user&nbsp;</div></li><li><div>            $user_id = wp_create_user( sanitize_user($_POST['user_login']), $_POST['password'], $_POST['email'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(is_wp_error($user_id) && method_exists($user_id, 'get_error_message')) {&nbsp;</div></li><li><div>                $error-&gt;add('userid', $user_id-&gt;get_error_message());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $member = new M_Membership( $user_id );&nbsp;</div></li><li><div>                if(defined('MEMBERSHIP_DEACTIVATE_USER_ON_REGISTRATION') && MEMBERSHIP_DEACTIVATE_USER_ON_REGISTRATION == true) {&nbsp;</div></li><li><div>                    $member-&gt;deactivate();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $creds = array(&nbsp;</div></li><li><div>                        'user_login' =&gt; $_POST['user_login'], &nbsp;</div></li><li><div>                        'user_password' =&gt; $_POST['password'], &nbsp;</div></li><li><div>                        'remember' =&gt; true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    $is_ssl = (isset($_SERVER['https']) && strtolower($_SERVER['https']) == 'on' ? true : false);&nbsp;</div></li><li><div>                    $user = wp_signon( $creds, $is_ssl );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error($user) && method_exists($user, 'get_error_message') ) {&nbsp;</div></li><li><div>                        $error-&gt;add('userlogin', $user-&gt;get_error_message());&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // Set the current user up&nbsp;</div></li><li><div>                        wp_set_current_user( $user_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if( has_action('membership_susbcription_form_registration_notification') ) {&nbsp;</div></li><li><div>                    do_action('membership_susbcription_form_registration_notification', $user_id, $_POST['password']);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    wp_new_user_notification($user_id, $_POST['password']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                do_action( 'membership_subscription_form_registration_process', $error, $user_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            do_action( 'membership_subscription_form_registration_process', $error, 0 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $anyerrors = $error-&gt;get_error_code();&nbsp;</div></li><li><div>        if(is_wp_error($error) && !empty($anyerrors)) {&nbsp;</div></li><li><div>            // we have an error - output&nbsp;</div></li><li><div>            $messages = $error-&gt;get_error_messages();&nbsp;</div></li><li><div>            //sendback error&nbsp;</div></li><li><div>            echo json_encode( array('errormsg' =&gt; $messages[0]) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // everything seems fine (so far), so we have our queued user so let's&nbsp;</div></li><li><div>            // move to picking a subscription - so send back the form.&nbsp;</div></li><li><div>            echo $this-&gt;popover_sendpayment_form( $user_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function popover_login_process() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!wp_verify_nonce( $_POST['nonce'], 'membership_login')) {&nbsp;</div></li><li><div>            $error-&gt;add('invalid', __('Invalid form submission.', 'membership'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $userbylogin = get_user_by( 'login', $_POST['user_login'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($userbylogin)) {&nbsp;</div></li><li><div>            $user = wp_authenticate( $userbylogin-&gt;user_login, $_POST['password'] );&nbsp;</div></li><li><div>            if(is_wp_error($user)) {&nbsp;</div></li><li><div>                $error-&gt;add('userlogin', $user-&gt;get_error_message());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_set_auth_cookie($user-&gt;ID);&nbsp;</div></li><li><div>                // Set the current user up&nbsp;</div></li><li><div>                wp_set_current_user( $user-&gt;ID );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $error-&gt;add('userlogin', __('User not found.', 'membership') );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $anyerrors = $error-&gt;get_error_code();&nbsp;</div></li><li><div>        if(is_wp_error($error) && !empty($anyerrors)) {&nbsp;</div></li><li><div>            // we have an error - output&nbsp;</div></li><li><div>            $messages = $error-&gt;get_error_messages();&nbsp;</div></li><li><div>            //sendback error&nbsp;</div></li><li><div>            echo json_encode( array('errormsg' =&gt; $messages[0]) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // everything seems fine (so far), so we have our queued user so let's&nbsp;</div></li><li><div>            // move to picking a subscription - so send back the form.&nbsp;</div></li><li><div>            echo $this-&gt;popover_sendpayment_form($user-&gt;ID);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    function popover_extraform_process() {&nbsp;</div></li><li><div>        echo $this-&gt;popover_extra_payment_form();&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    function popover_sendpayment_form( $user_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_sendpayment_form_before_content', $content );&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        if( defined('MEMBERSHIP_POPOVER_SENDPAYMENT_FORM') && file_exists( MEMBERSHIP_POPOVER_SENDPAYMENT_FORM ) ) {&nbsp;</div></li><li><div>            include_once( MEMBERSHIP_POPOVER_SENDPAYMENT_FORM );&nbsp;</div></li><li><div>        } elseif(file_exists( apply_filters('membership_override_popover_sendpayment_form', membership_dir('membershipincludes/includes/popover_payment.form.php')) ) ) {&nbsp;</div></li><li><div>            include_once( apply_filters('membership_override_popover_sendpayment_form', membership_dir('membershipincludes/includes/popover_payment.form.php')) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $content .= ob_get_contents();&nbsp;</div></li><li><div>        ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_sendpayment_form_after_content', $content );&nbsp;</div></li><li><div>        echo $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function popover_extra_payment_form( $user_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_extraform_before_content', $content );&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        if( defined('MEMBERSHIP_POPOVER_SENDPAYMENT_FORM') && file_exists( MEMBERSHIP_POPOVER_SENDPAYMENT_FORM ) ) {&nbsp;</div></li><li><div>            include_once( MEMBERSHIP_POPOVER_SENDPAYMENT_FORM );&nbsp;</div></li><li><div>        } elseif(file_exists( apply_filters('membership_override_popover_sendpayment_form', membership_dir('membershipincludes/includes/popover_payment.form.php')) ) ) {&nbsp;</div></li><li><div>            include_once( apply_filters('membership_override_popover_sendpayment_form', membership_dir('membershipincludes/includes/popover_payment.form.php')) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $content .= ob_get_contents();&nbsp;</div></li><li><div>        ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = apply_filters('membership_popover_extraform_after_content', $content );&nbsp;</div></li><li><div>        echo $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function create_defaults() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Function to create some defaults if they are not set&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>            if(function_exists('get_blog_option')) {&nbsp;</div></li><li><div>                if(function_exists('switch_to_blog')) {&nbsp;</div></li><li><div>                    switch_to_blog(MEMBERSHIP_GLOBAL_MAINSITE);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $M_options = get_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', array());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $M_options = get_option('membership_options', array());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make registration and associated pages&nbsp;</div></li><li><div>        if(empty($M_options['registration_page'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if the buddypress registration page is created or not&nbsp;</div></li><li><div>            if(defined('BP_VERSION') && version_compare( preg_replace('/-.*$/', '', BP_VERSION), &quot;1.5&quot;, '&gt;=')) {&nbsp;</div></li><li><div>                // Get the BP pages&nbsp;</div></li><li><div>                $bppages = get_option('bp-pages', array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $pagedetails = array('post_title' =&gt; __('Register', 'membership'), 'post_name' =&gt; 'register', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; '');&nbsp;</div></li><li><div>            $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>            $M_options['registration_page'] = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $pagedetails = array('post_title' =&gt; __('Account', 'membership'), 'post_name' =&gt; 'account', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; '');&nbsp;</div></li><li><div>            $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>            $M_options['account_page'] = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $content = '&lt;p&gt;' . __('The content you are trying to access is only available to members. Sorry.', 'membership') . '&lt;/p&gt;';&nbsp;</div></li><li><div>            $pagedetails = array('post_title' =&gt; __('Protected Content', 'membership'), 'post_name' =&gt; 'protected', 'post_status' =&gt; 'publish', 'post_type' =&gt; 'page', 'post_content' =&gt; $content);&nbsp;</div></li><li><div>            $id = wp_insert_post( $pagedetails );&nbsp;</div></li><li><div>            $M_options['nocontent_page'] = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Create relevant admin side shortcodes&nbsp;</div></li><li><div>        if(empty($M_options['membershipadminshortcodes'])) {&nbsp;</div></li><li><div>            if(!is_array($M_options['membershipadminshortcodes'])) {&nbsp;</div></li><li><div>                $M_options['membershipadminshortcodes'] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(class_exists('RGForms')) {&nbsp;</div></li><li><div>                // Gravity Forms exists&nbsp;</div></li><li><div>                $M_options['membershipadminshortcodes'][] = 'gravityform';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('WPCF7_VERSION')) {&nbsp;</div></li><li><div>                // Contact Form 7 exists&nbsp;</div></li><li><div>                $M_options['membershipadminshortcodes'][] = 'contact-form';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(defined('WPAUDIO_URL')) {&nbsp;</div></li><li><div>                // WPAudio exists&nbsp;</div></li><li><div>                $M_options['membershipadminshortcodes'][] = 'wpaudio';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Create a default download group&nbsp;</div></li><li><div>        if(empty($M_options['membershipdownloadgroups'])) {&nbsp;</div></li><li><div>            if(!is_array($M_options['membershipdownloadgroups'])) {&nbsp;</div></li><li><div>                $M_options['membershipdownloadgroups'] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $M_options['membershipdownloadgroups'][] = __('default', 'membership');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Create a hashed downloads url&nbsp;</div></li><li><div>        if(empty($M_options['masked_url'])) {&nbsp;</div></li><li><div>            $M_options['masked_url'] = __('downloads', 'membership');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update the options&nbsp;</div></li><li><div>        if(defined('MEMBERSHIP_GLOBAL_TABLES') && MEMBERSHIP_GLOBAL_TABLES === true) {&nbsp;</div></li><li><div>            if(function_exists('update_blog_option')) {&nbsp;</div></li><li><div>                update_blog_option(MEMBERSHIP_GLOBAL_MAINSITE, 'membership_options', $M_options);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                update_option('membership_options', $M_options);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            update_option('membership_options', $M_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Functions to determine whether to show user help on this screen and to disable it if not&nbsp;</div></li><li><div>    function show_user_help( $page ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_id = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helpscreens = get_user_meta($user_id, 'membership_show_help_headers', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_array($helpscreens)) {&nbsp;</div></li><li><div>            $helpscreens = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!isset($helpscreens[$page])) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dismiss_user_help( $page ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_id = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helpscreens = get_user_meta($user_id, 'membership_show_help_headers', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_array($helpscreens)) {&nbsp;</div></li><li><div>            $helpscreens = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!isset($helpscreens[$page])) {&nbsp;</div></li><li><div>            $helpscreens[$page] = 'no';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_user_meta( $user_id, 'membership_show_help_headers', $helpscreens );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Level shortcodes function&nbsp;</div></li><li><div>    function build_level_shortcode_list( $shortcodes = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!is_array($shortcodes)) {&nbsp;</div></li><li><div>            $shortcodes = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $levels = $this-&gt;get_membership_levels();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($levels)) {&nbsp;</div></li><li><div>            foreach($levels as $level) {&nbsp;</div></li><li><div>                $shortcodes[] = M_normalize_shortcode($level-&gt;level_title);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $shortcodes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function start_membership_session() {&nbsp;</div></li><li><div>        if (session_id() == &quot;&quot;)&nbsp;</div></li><li><div>              session_start();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Remove relationship when user is deleted&nbsp;</div></li><li><div>    function remove_relationships_on_delete( $user_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM &quot;.$wpdb-&gt;prefix.&quot;m_membership_relationships WHERE user_id = %d&quot;, $user_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 4.0.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/membershipadmin/" class="active">4.0.1.3</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.2/classes/membershipadmin/" class="">4.0.1.2</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.0/classes/membershipadmin/" class="">4.0.1.0</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.7/classes/membershipadmin/" class="">4.0.0.7</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.2/classes/membershipadmin/" class="">4.0.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>membershipadmin</li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>