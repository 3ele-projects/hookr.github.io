<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="4.0.1.3" data-slug="membership-2" data-type="class" data-id="23586"><head xmlns="http://www.w3.org/1999/xhtml"><title> ms_controller_member | class | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="MS_Controller_Member, class, plugin, membership-2, 4.0.1.3" /><meta name="description" content="Controller for managing Members and Membership relationships." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=0fb961afe3a90bec6280a872f78d5d89' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ms_controller_member/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_controller_member%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_controller_member%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.3-class-ms_controller_member","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ms_controller_member" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.3." href="http://hookr.io/plugins/membership-2/4.0.1.3/" class="H_VERSION"><span property="name">4.0.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ms_controller_member</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2618"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/all/" title="All">All <span class="count badge">2618</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="1601"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/hooks/" title="Hooks">Hooks <span class="count badge">1601</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1077"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/filters/" title="Filters">Filters <span class="count badge">1077</span></a></li><li class="active" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="207"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/functions/" title="Functions">Functions <span class="count badge">207</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>MS_Controller_Member</strong></h1><p>Controller for managing Members and Membership relationships.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/membership-2/4.0.1.3/files/app-controller-class-ms-controller-member/" class="file">/app/controller/class-ms-controller-member.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="12" class="block" start="12"><li><div>class MS_Controller_Member extends MS_Controller {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX action constant: Edit subscriptions of a single member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const AJAX_ACTION_CHANGE_MEMBERSHIPS = 'member_subscriptions';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX action constant: Validate a user field before creating the user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const AJAX_ACTION_VALIDATE_FIELD = 'member_validate_field';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX action constant: Search users via Ajax.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const AJAX_ACTION_SEARCH = 'member_search';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used on the Add Member screen to indicate that a new WP User should be&nbsp;</div></li><li><div>     * created and added to M2.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var   string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const ACTION_ADD_MEMBER = 'member_add';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used on the Add Member screen to indicate that the submitted form details&nbsp;</div></li><li><div>     * should update an existing user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var   string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const ACTION_UPDATE_MEMBER = 'member_update';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used on the Add Member screen to trigger a new subscription action for an&nbsp;</div></li><li><div>     * existing user (user subscribes to one or multiple memberships)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var   string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const ACTION_MODIFY_SUBSCRIPTIONS = 'member_subscription';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used on the Add Member screen to indicate that an existing WP User should&nbsp;</div></li><li><div>     * be added to M2.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var   string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const ACTION_SELECT_MEMBER = 'member_select';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepare the Member manager.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_action(&nbsp;</div></li><li><div>            'ms_controller_membership_setup_completed', &nbsp;</div></li><li><div>            'add_current_user'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_ajax_action(&nbsp;</div></li><li><div>            self::AJAX_ACTION_CHANGE_MEMBERSHIPS, &nbsp;</div></li><li><div>            'ajax_action_change_memberships'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_ajax_action(&nbsp;</div></li><li><div>            self::AJAX_ACTION_VALIDATE_FIELD, &nbsp;</div></li><li><div>            'ajax_action_validate_field'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_ajax_action(&nbsp;</div></li><li><div>            self::AJAX_ACTION_SEARCH, &nbsp;</div></li><li><div>            'ajax_action_search'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                &nbsp;</div></li><li><div>        $this-&gt;add_action(&nbsp;</div></li><li><div>            'delete_user', &nbsp;</div></li><li><div>            'remove_membership_from_user'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_filter( 'set-screen-option', array($this, 'members_admin_page_set_screen_option') , 10, 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Initialize the admin-side functions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function admin_init() {&nbsp;</div></li><li><div>        $hooks = array(&nbsp;</div></li><li><div>            'list' =&gt; MS_Controller_Plugin::admin_page_hook( 'members' ), &nbsp;</div></li><li><div>            'editor' =&gt; MS_Controller_Plugin::admin_page_hook( 'add-member' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_action( 'load-' . $hooks['list'], 'members_admin_page_screen_option' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $hooks as $key =&gt; $hook ) {&nbsp;</div></li><li><div>            $this-&gt;run_action( 'load-' . $hook, 'members_admin_page_process_' . $key );&nbsp;</div></li><li><div>            $this-&gt;run_action( 'admin_print_scripts-' . $hook, 'enqueue_scripts_' . $key );&nbsp;</div></li><li><div>            $this-&gt;run_action( 'admin_print_styles-' . $hook, 'enqueue_styles' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add the current user to the Members-List.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This does NOT assign any membership to the user, but ensures that the&nbsp;</div></li><li><div>     * admin user appears in the Members-List&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_current_user() {&nbsp;</div></li><li><div>        $member = MS_Factory::load(&nbsp;</div></li><li><div>            'MS_Model_Member', &nbsp;</div></li><li><div>            get_current_user_id()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $member-&gt;is_member = true;&nbsp;</div></li><li><div>        $member-&gt;save();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Remove membership for an user&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.0.3&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        public function remove_membership_from_user( $user_id )&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            $member = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>            $memberships_ids = (array) $member-&gt;get_membership_ids();&nbsp;</div></li><li><div>            &nbsp;</div></li><li><div>            if( ! empty( $memberships_ids ) )&nbsp;</div></li><li><div>            {&nbsp;</div></li><li><div>                foreach( $memberships_ids as $memberships_id )&nbsp;</div></li><li><div>                {&nbsp;</div></li><li><div>                    $member-&gt;drop_membership( $memberships_id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>        * Add pagination members screen option&nbsp;</div></li><li><div>        *&nbsp;</div></li><li><div>        * @since 1.0.3&nbsp;</div></li><li><div>        */&nbsp;</div></li><li><div>        function members_admin_page_screen_option() {&nbsp;</div></li><li><div>            $option = 'per_page';&nbsp;</div></li><li><div>            $args = array(&nbsp;</div></li><li><div>                'label' =&gt; 'Members', &nbsp;</div></li><li><div>                'default' =&gt; 20, &nbsp;</div></li><li><div>                'option' =&gt; 'members_per_page'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_screen_option( $option, $args );&nbsp;</div></li><li><div>        }    &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>        * Set pagination members screen option&nbsp;</div></li><li><div>        *&nbsp;</div></li><li><div>        * @since 1.0.3&nbsp;</div></li><li><div>        */&nbsp;</div></li><li><div>        public static function members_admin_page_set_screen_option( $status, $option, $value ) {&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        }    &nbsp;</div></li><li><div>            &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Manages membership actions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Verifies GET and POST requests to manage members&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function members_admin_page_process_list() {&nbsp;</div></li><li><div>        $msg = 0;&nbsp;</div></li><li><div>        $redirect = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            $fields_new = array( 'new_member', 'action' );&nbsp;</div></li><li><div>            $fields_edit = array( 'member_id', 'action' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Execute list table single action.&nbsp;</div></li><li><div>            if ( $this-&gt;verify_nonce( null, 'GET' )&nbsp;</div></li><li><div>                && self::validate_required( $fields_edit, 'GET' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $msg = $this-&gt;member_list_do_action(&nbsp;</div></li><li><div>                    $_GET['action'], &nbsp;</div></li><li><div>                    array( $_GET['member_id'] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $redirect = esc_url_raw(&nbsp;</div></li><li><div>                    add_query_arg(&nbsp;</div></li><li><div>                        array( 'msg' =&gt; $msg ), &nbsp;</div></li><li><div>                        remove_query_arg(&nbsp;</div></li><li><div>                            array( 'member_id', 'action', '_wpnonce' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Execute list table bulk actions.&nbsp;</div></li><li><div>            elseif ( $this-&gt;verify_nonce( 'bulk' ) ) {&nbsp;</div></li><li><div>                lib3()-&gt;array-&gt;equip_post( 'action', 'action2', 'member_id' );&nbsp;</div></li><li><div>                $action = $_POST['action'];&nbsp;</div></li><li><div>                if ( empty( $action ) || $action == '-1' ) {&nbsp;</div></li><li><div>                    $action = $_POST['action2'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $members = $_POST['member_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * The Bulk-Edit action is built like 'cmd-id'&nbsp;</div></li><li><div>                 * e.g. 'add-123' will add membership 123 to the selected items.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                if ( empty( $action ) ) {&nbsp;</div></li><li><div>                    $cmd = array();&nbsp;</div></li><li><div>                } elseif ( empty( $members ) ) {&nbsp;</div></li><li><div>                    $cmd = array();&nbsp;</div></li><li><div>                } elseif ( '-1' == $action ) {&nbsp;</div></li><li><div>                    $cmd = array();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $cmd = explode( '-', $action );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 2 == count( $cmd ) ) {&nbsp;</div></li><li><div>                    $action = $cmd[0];&nbsp;</div></li><li><div>                    $action_id = $cmd[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get a list of specified memberships...&nbsp;</div></li><li><div>                    if ( is_numeric( $action_id ) ) {&nbsp;</div></li><li><div>                        // ... either a single membership.&nbsp;</div></li><li><div>                        $memberships = array(&nbsp;</div></li><li><div>                            MS_Factory::load( 'MS_Model_Membership', $action_id ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } elseif ( 'all' == $action_id ) {&nbsp;</div></li><li><div>                        // ... or all memberships.&nbsp;</div></li><li><div>                        $memberships = MS_Model_Membership::get_memberships();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Loop defined memberships and add/remove members.&nbsp;</div></li><li><div>                    foreach ( $memberships as $membership ) {&nbsp;</div></li><li><div>                        $msg = $this-&gt;member_list_do_action(&nbsp;</div></li><li><div>                            $action, &nbsp;</div></li><li><div>                            $members, &nbsp;</div></li><li><div>                            $membership-&gt;id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $redirect = esc_url_raw(&nbsp;</div></li><li><div>                        add_query_arg( array( 'msg' =&gt; $msg ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Execute edit view page action submit.&nbsp;</div></li><li><div>            elseif ( isset( $_POST['submit'] )&nbsp;</div></li><li><div>                && $this-&gt;verify_nonce()&nbsp;</div></li><li><div>                && self::validate_required( $fields_edit, 'POST' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                if ( is_array( $_POST['member_id'] ) ) {&nbsp;</div></li><li><div>                    $member_ids = $_POST['member_id'];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $member_ids = explode( ', ', $_POST['member_id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $msg = $this-&gt;member_list_do_action(&nbsp;</div></li><li><div>                    $_POST['action'], &nbsp;</div></li><li><div>                    $member_ids, &nbsp;</div></li><li><div>                    $_POST['membership_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $redirect = esc_url_raw(&nbsp;</div></li><li><div>                    add_query_arg( array( 'msg' =&gt; $msg ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $redirect ) {&nbsp;</div></li><li><div>            wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Manages membership actions for the ADD/EDIT screen.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function members_admin_page_process_editor() {&nbsp;</div></li><li><div>        $msg = 0;&nbsp;</div></li><li><div>        $redirect = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            $fields_add = array( 'username', 'email' );&nbsp;</div></li><li><div>            $fields_select = array( 'user_id' );&nbsp;</div></li><li><div>            $fields_update = array( 'user_id', 'email' );&nbsp;</div></li><li><div>            $fields_modify = array( 'user_id', 'memberships' );&nbsp;</div></li><li><div>            $fields_subscribe = array( 'user_id', 'subscribe' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process Action: Create new user.&nbsp;</div></li><li><div>            if ( isset( $_POST['btn_create'] )&nbsp;</div></li><li><div>                && $this-&gt;verify_nonce()&nbsp;</div></li><li><div>                && self::validate_required( $fields_add, 'POST' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $data = array(&nbsp;</div></li><li><div>                    'user_login' =&gt; $_POST['username'], &nbsp;</div></li><li><div>                    'user_email' =&gt; $_POST['email'], &nbsp;</div></li><li><div>                    'first_name' =&gt; $_POST['first_name'], &nbsp;</div></li><li><div>                    'last_name' =&gt; $_POST['last_name'], &nbsp;</div></li><li><div>                    'user_pass' =&gt; $_POST['password'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $user_id = wp_insert_user( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>                    $redirect = esc_url_raw(&nbsp;</div></li><li><div>                        add_query_arg( array( 'user_id' =&gt; $user_id ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process Action: Select existing user.&nbsp;</div></li><li><div>            elseif ( isset( $_POST['btn_select'] )&nbsp;</div></li><li><div>                && $this-&gt;verify_nonce()&nbsp;</div></li><li><div>                && self::validate_required( $fields_select, 'POST' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $user_id = intval( $_POST['user_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $redirect = esc_url_raw(&nbsp;</div></li><li><div>                    add_query_arg( array( 'user_id' =&gt; $user_id ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process Action: Update existing user.&nbsp;</div></li><li><div>            elseif ( isset( $_POST['btn_save'] )&nbsp;</div></li><li><div>                && $this-&gt;verify_nonce()&nbsp;</div></li><li><div>                && self::validate_required( $fields_update, 'POST' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $data = array(&nbsp;</div></li><li><div>                    'ID' =&gt; intval( $_POST['user_id'] ), &nbsp;</div></li><li><div>                    'user_email' =&gt; $_POST['email'], &nbsp;</div></li><li><div>                    'first_name' =&gt; $_POST['first_name'], &nbsp;</div></li><li><div>                    'last_name' =&gt; $_POST['last_name'], &nbsp;</div></li><li><div>                    'display_name' =&gt; $_POST['displayname'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                wp_update_user( $data );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process Action: Subscribe to a new membership.&nbsp;</div></li><li><div>            elseif ( isset( $_POST['btn_modify'] )&nbsp;</div></li><li><div>                && $this-&gt;verify_nonce()&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                // REQUEST here: When editing a user the ID is sent in the URL.&nbsp;</div></li><li><div>                $user_id = intval( $_REQUEST['user_id'] );&nbsp;</div></li><li><div>                $user = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>                                // We don't need need user_id here as this is an user modification&nbsp;</div></li><li><div>                                $fields_modify = array( 'memberships' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Modify existing subscriptions.&nbsp;</div></li><li><div>                if ( self::validate_required( $fields_modify, 'POST' ) ) {&nbsp;</div></li><li><div>                    $memberships = lib3()-&gt;array-&gt;get( $_POST['memberships'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $memberships as $membership_id ) {&nbsp;</div></li><li><div>                        if ( empty( $_POST['mem_' . $membership_id] ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $subscription = $user-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>                        $data = $_POST['mem_' . $membership_id];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $subscription-&gt;start_date = $data['start'];&nbsp;</div></li><li><div>                        $subscription-&gt;expire_date = $data['expire'];&nbsp;</div></li><li><div>                        $subscription-&gt;status = $data['status'];&nbsp;</div></li><li><div>                        $subscription-&gt;save();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Add new subscriptions.&nbsp;</div></li><li><div>                if ( self::validate_required( $fields_subscribe, 'POST' ) ) {&nbsp;</div></li><li><div>                    $subscribe_to = $_POST['subscribe'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( MS_Model_Addon::is_enabled( MS_Model_Addon::ADDON_MULTI_MEMBERSHIPS ) ) {&nbsp;</div></li><li><div>                        // Memberships is an array.&nbsp;</div></li><li><div>                        foreach ( $subscribe_to as $membership_id ) {&nbsp;</div></li><li><div>                            $user-&gt;add_membership( $membership_id, 'admin' );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // Memberships is a single ID.&nbsp;</div></li><li><div>                        foreach ( $user-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>                            $subscription-&gt;deactivate_membership( false );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $user-&gt;add_membership( $subscribe_to, 'admin' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $user-&gt;save();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $redirect ) {&nbsp;</div></li><li><div>            wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Show member list.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Menu &quot;All Members&quot;, show all members available.&nbsp;</div></li><li><div>     * Called by MS_Controller_Plugin::route_submenu_request()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function admin_page() {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $view = MS_Factory::create( 'MS_View_Member_List' );&nbsp;</div></li><li><div>        $view-&gt;data = apply_filters( 'ms_view_member_list_data', $data );&nbsp;</div></li><li><div>        $view-&gt;render();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Show member editor.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Menu &quot;Add Member&quot;, add or edit a single member.&nbsp;</div></li><li><div>     * Called by MS_Controller_Plugin::route_submenu_request()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function admin_page_editor() {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_REQUEST['user_id'] ) && intval( $_REQUEST['user_id'] ) ) {&nbsp;</div></li><li><div>            $data['user_id'] = intval( $_REQUEST['user_id'] );&nbsp;</div></li><li><div>            $data['action'] = 'edit';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $data['user_id'] = 0;&nbsp;</div></li><li><div>            $data['action'] = 'add';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $view = MS_Factory::create( 'MS_View_Member_Editor' );&nbsp;</div></li><li><div>        $view-&gt;data = apply_filters( 'ms_view_member_editor_data', $data );&nbsp;</div></li><li><div>        $view-&gt;render();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle Ajax change-memberships action.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This action handler is only called by admin users via the Members admin&nbsp;</div></li><li><div>     * page, so all memberships added here have gateway_id 'admin'.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Related Action Hooks:&nbsp;</div></li><li><div>     * - wp_ajax_change_memberships&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function ajax_action_change_memberships() {&nbsp;</div></li><li><div>        $msg = 0;&nbsp;</div></li><li><div>        $this-&gt;_resp_reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $required = array( 'member' );&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() && ! $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'permission denied' );&nbsp;</div></li><li><div>        } elseif ( $this-&gt;_resp_ok() && ! $this-&gt;verify_nonce() ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'subscribe: nonce' );&nbsp;</div></li><li><div>        } elseif ( $this-&gt;_resp_ok() && ! self::validate_required( $required ) ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'subscribe: required' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() ) {&nbsp;</div></li><li><div>            $values = array();&nbsp;</div></li><li><div>            if ( isset( $_POST['values'] ) && is_array( $_POST['values'] ) ) {&nbsp;</div></li><li><div>                $values = $_POST['values'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $msg = $this-&gt;assign_memberships(&nbsp;</div></li><li><div>                $_POST['member'], &nbsp;</div></li><li><div>                $values&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $msg .= $this-&gt;_resp_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo $msg;&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle Ajax validate field action.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This function should validate the field value before the user is created&nbsp;</div></li><li><div>     * to make sure that the value is unique/valid.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Related Action Hooks:&nbsp;</div></li><li><div>     * - wp_ajax_validate_field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function ajax_action_validate_field() {&nbsp;</div></li><li><div>        $msg = 0;&nbsp;</div></li><li><div>        $this-&gt;_resp_reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $required = array( 'field', 'value' );&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() && ! $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'permission denied' );&nbsp;</div></li><li><div>        } elseif ( $this-&gt;_resp_ok() && ! self::validate_required( $required ) ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( __( 'This field is required.', 'membership2' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() ) {&nbsp;</div></li><li><div>            $field = $_POST['field'];&nbsp;</div></li><li><div>            $value = $_POST['value'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'email' == $field ) {&nbsp;</div></li><li><div>                if ( ! is_email( $value ) ) {&nbsp;</div></li><li><div>                    $msg = __( 'Invalid Email address', 'membership2' );&nbsp;</div></li><li><div>                } elseif ( email_exists( $value ) ) {&nbsp;</div></li><li><div>                    $msg = __( 'Email already taken', 'membership2' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $msg = 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( 'username' == $field ) {&nbsp;</div></li><li><div>                if ( username_exists( $value ) ) {&nbsp;</div></li><li><div>                    $msg = __( 'Username already taken', 'membership2' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $msg = 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $msg .= $this-&gt;_resp_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo $msg;&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle Ajax search users action.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Related Action Hooks:&nbsp;</div></li><li><div>     * - wp_ajax_search&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function ajax_action_search() {&nbsp;</div></li><li><div>        $res = (object) array(&nbsp;</div></li><li><div>            'items' =&gt; array(), &nbsp;</div></li><li><div>            'more' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;_resp_reset();&nbsp;</div></li><li><div>        $items_per_page = 20;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $required = array( 'q' );&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() && ! $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'permission denied' );&nbsp;</div></li><li><div>        } elseif ( $this-&gt;_resp_ok() && ! self::validate_required( $required, 'any' ) ) {&nbsp;</div></li><li><div>            $this-&gt;_resp_err( 'search: required' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( empty( $_REQUEST['p'] ) ) { $_REQUEST['p'] = 0; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;_resp_ok() ) {&nbsp;</div></li><li><div>            $term = $_REQUEST['q'];&nbsp;</div></li><li><div>            $page = max( intval( $_REQUEST['p'] ) - 1, 0 );&nbsp;</div></li><li><div>            $offset = $page * $items_per_page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = array(&nbsp;</div></li><li><div>                'search' =&gt; '*' . $term . '*', &nbsp;</div></li><li><div>                'offset' =&gt; $offset, &nbsp;</div></li><li><div>                'number' =&gt; $items_per_page + 1, &nbsp;</div></li><li><div>                'fields' =&gt; array(&nbsp;</div></li><li><div>                    'ID', &nbsp;</div></li><li><div>                    'user_login', &nbsp;</div></li><li><div>                    'display_name', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'orderby' =&gt; 'display_name', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $users = get_users( $args );&nbsp;</div></li><li><div>                        $admins = get_users( array( 'role' =&gt; 'administrator' ) );&nbsp;</div></li><li><div>                        $users = array_udiff( $users, $admins, array( $this, 'compare_objects' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( count( $users ) &gt; $items_per_page ) {&nbsp;</div></li><li><div>                $res-&gt;more = true;&nbsp;</div></li><li><div>                array_pop( $users );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $users as $user ) {&nbsp;</div></li><li><div>                $res-&gt;items[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>                    'text' =&gt; sprintf(&nbsp;</div></li><li><div>                        '%s (%s)', &nbsp;</div></li><li><div>                        $user-&gt;display_name, &nbsp;</div></li><li><div>                        $user-&gt;user_login&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo json_encode( $res );&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        public function compare_objects( $obj_a, $obj_b ) {&nbsp;</div></li><li><div>            return $obj_a-&gt;ID - $obj_b-&gt;ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Assigns (or removes) memberships to a Member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $user_id&nbsp;</div></li><li><div>     * @param  array $memberships Memberships that will be assigned to the&nbsp;</div></li><li><div>     *                rule-item. Memberships that are not mentioned are removed.&nbsp;</div></li><li><div>     * @return string [description]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function assign_memberships( $user_id, $memberships ) {&nbsp;</div></li><li><div>        $member = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $memberships = apply_filters(&nbsp;</div></li><li><div>            'ms_controller_member_assign_memberships', &nbsp;</div></li><li><div>            $memberships, &nbsp;</div></li><li><div>            $member, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Drop memberships that are not specified&nbsp;</div></li><li><div>        foreach ( $member-&gt;get_membership_ids() as $old_id ) {&nbsp;</div></li><li><div>            if ( in_array( $old_id, $memberships ) ) { continue; }&nbsp;</div></li><li><div>            $member-&gt;drop_membership( $old_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add new memberships&nbsp;</div></li><li><div>        foreach ( $memberships as $membership_id ) {&nbsp;</div></li><li><div>            $subscription = $member-&gt;add_membership( $membership_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $member-&gt;has_membership() ) {&nbsp;</div></li><li><div>            $member-&gt;is_member = true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $member-&gt;is_member = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $member-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_controller_member_assign_memberships_done', &nbsp;</div></li><li><div>            $member, &nbsp;</div></li><li><div>            $memberships, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return MS_Helper_Membership::MEMBERSHIP_MSG_UPDATED;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles Member list actions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $action The action to execute.&nbsp;</div></li><li><div>     * @param object[] $members Array of members.&nbsp;</div></li><li><div>     * @param int $membership_id The Membership to apply action to.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function member_list_do_action( $action, $members, $membership_id = null ) {&nbsp;</div></li><li><div>        $msg = MS_Helper_Member::MSG_MEMBER_NOT_UPDATED;&nbsp;</div></li><li><div>        if ( ! $this-&gt;is_admin_user() ) {&nbsp;</div></li><li><div>            return $msg;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $members as $member_id ) {&nbsp;</div></li><li><div>            // Member Model&nbsp;</div></li><li><div>            $member = MS_Factory::load( 'MS_Model_Member', $member_id );&nbsp;</div></li><li><div>            switch ( $action ) {&nbsp;</div></li><li><div>                case 'add':&nbsp;</div></li><li><div>                    $member-&gt;add_membership( $membership_id );&nbsp;</div></li><li><div>                    $msg = MS_Helper_Member::MSG_MEMBER_ADDED;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'drop':&nbsp;</div></li><li><div>                    $member-&gt;drop_membership( $membership_id );&nbsp;</div></li><li><div>                    $msg = MS_Helper_Member::MSG_MEMBER_DELETED;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'move':&nbsp;</div></li><li><div>                    if ( ! empty( $_POST['membership_move_from_id'] ) ) {&nbsp;</div></li><li><div>                        $member-&gt;move_membership(&nbsp;</div></li><li><div>                            $_POST['membership_move_from_id'], &nbsp;</div></li><li><div>                            $_POST['membership_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        $msg = MS_Helper_Member::MSG_MEMBER_UPDATED;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'edit_date':&nbsp;</div></li><li><div>                    if ( is_array( $membership_id ) ) {&nbsp;</div></li><li><div>                        foreach ( $membership_id as $id ) {&nbsp;</div></li><li><div>                            $subscription = $member-&gt;get_subscriptions( $id );&nbsp;</div></li><li><div>                            if ( ! empty( $_POST[ 'start_date_' . $id ] ) ) {&nbsp;</div></li><li><div>                                $subscription-&gt;start_date = $_POST[ 'start_date_' . $id ];&nbsp;</div></li><li><div>                                $subscription-&gt;set_trial_expire_date();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( ! empty( $_POST[ 'expire_date_' . $id ] ) ) {&nbsp;</div></li><li><div>                                $subscription-&gt;expire_date = $_POST[ 'expire_date_' . $id ];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $subscription-&gt;save();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $msg = MS_Helper_Member::MSG_MEMBER_UPDATED;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $member-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_controller_member_member_list_do_action', &nbsp;</div></li><li><div>            $msg, &nbsp;</div></li><li><div>            $action, &nbsp;</div></li><li><div>            $members, &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load Member manager specific styles.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function enqueue_styles() {&nbsp;</div></li><li><div>        lib3()-&gt;ui-&gt;add( 'jquery-ui' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load Member specific scripts for the LIST view.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function enqueue_scripts_list() {&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'ms_init' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        lib3()-&gt;array-&gt;equip_get( 'action' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'edit_date' == $_GET['action'] ) {&nbsp;</div></li><li><div>            // Start and expire date edit&nbsp;</div></li><li><div>            wp_enqueue_script( 'jquery-ui-datepicker' );&nbsp;</div></li><li><div>            $data['ms_init'][] = 'view_member_date';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Members list&nbsp;</div></li><li><div>            $data['ms_init'][] = 'view_member_list';&nbsp;</div></li><li><div>            $data['lang'] = array(&nbsp;</div></li><li><div>                'select_user' =&gt; __( 'Select an User', 'membership2' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        lib3()-&gt;ui-&gt;data( 'ms_data', $data );&nbsp;</div></li><li><div>        wp_enqueue_script( 'ms-admin' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load Member specific scripts for ADD/EDIT screen.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function enqueue_scripts_editor() {&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'ms_init' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data['ms_init'][] = 'view_member_editor';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        lib3()-&gt;ui-&gt;data( 'ms_data', $data );&nbsp;</div></li><li><div>        wp_enqueue_script( 'ms-admin' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.0.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/ms_controller_member/" class="active">4.0.1.3</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.2/classes/ms_controller_member/" class="">4.0.1.2</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.0/classes/ms_controller_member/" class="">4.0.1.0</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.7/classes/ms_controller_member/" class="">4.0.0.7</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.2/classes/ms_controller_member/" class="">4.0.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>MS_Controller_Member</li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>