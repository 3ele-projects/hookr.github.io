<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="4.0.1.3" data-slug="membership-2" data-type="class" data-id="24169"><head xmlns="http://www.w3.org/1999/xhtml"><title> ms_model_member | class | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="MS_Model_Member, class, plugin, membership-2, 4.0.1.3" /><meta name="description" content="Member model." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=4438f856af62c8984ddf6baa2164c606' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ms_model_member/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_model_member%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_model_member%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.3-class-ms_model_member","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ms_model_member" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.3." href="http://hookr.io/plugins/membership-2/4.0.1.3/" class="H_VERSION"><span property="name">4.0.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ms_model_member</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2618"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/all/" title="All">All <span class="count badge">2618</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="1601"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/hooks/" title="Hooks">Hooks <span class="count badge">1601</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1077"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/filters/" title="Filters">Filters <span class="count badge">1077</span></a></li><li class="active" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="207"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/functions/" title="Functions">Functions <span class="count badge">207</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>MS_Model_Member</strong></h1><p>Member model.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/membership-2/4.0.1.3/files/app-model-class-ms-model-member/" class="file">/app/model/class-ms-model-member.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class MS_Model_Member extends MS_Model {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Members search constants.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const SEARCH_ONLY_MEMBERS = 'only members'; //TODO: replace space with _ !!!!&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Members search constants.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const SEARCH_ALL_USERS = 'all_users';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cache for function is_admin_user()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var bool[]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static protected $_is_admin_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cache for function is_normal_admin()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var bool[]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static protected $_is_normal_admin = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cache for function is_simulated_user()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var bool[]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static protected $_is_simulated_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cache for function is_normal_user()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var bool[]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static protected $_is_normal_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's active subscriptions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note: This field is populated by MS_Factory when the Member instance is&nbsp;</div></li><li><div>     * created.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var array {&nbsp;</div></li><li><div>     *     @type int $membership_id The membership ID.&nbsp;</div></li><li><div>     *     @type MS_Model_Relationship The membership relationship model object.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $subscriptions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Indicator if the user is an active M2 Member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is a convenience/redudant flag to speed up SQL queries.&nbsp;</div></li><li><div>     * Actually everyone that has an active or trial status membership is&nbsp;</div></li><li><div>     * considered an active member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This flag is set when:&nbsp;</div></li><li><div>     * - In MS_Model_Relationship, when a payment is recorded&nbsp;</div></li><li><div>     *   via add_payment()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This flag is reset when:&nbsp;</div></li><li><div>     * - In MS_Model_Relationship, when a subscription is deactivated&nbsp;</div></li><li><div>     *   via check_membership_status()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $is_member = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's username.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Mapped from wordpress $wp_user object.&nbsp;</div></li><li><div>     * @see WP_User $user_login.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $username = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's email.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Mapped from wordpress $wp_user object.&nbsp;</div></li><li><div>     * @see WP_User $user_email.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $email = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's name.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Mapped from wordpress $wp_user object.&nbsp;</div></li><li><div>     * @see WP_User $user_nicename.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's first name.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Mapped from wordpress $wp_user object.&nbsp;</div></li><li><div>     * @see WP_User $first_name&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $first_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's last name.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Mapped from wordpress $wp_user object.&nbsp;</div></li><li><div>     * @see WP_User $last_name.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $last_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's password.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Used when registering.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $password = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's password confirmation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Used when registering.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $password2 = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Member's gateway profiles info.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Save gateway IDs.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @var array {&nbsp;</div></li><li><div>     *     Return structure: $gateway[ $field ] =&gt; $value;&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     @type string $gateway_id The gateway id.&nbsp;</div></li><li><div>     *     @type string $field The field to store.&nbsp;</div></li><li><div>     *     @type mixed $value The field value to store.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $gateway_profiles = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The associated WP_User object&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @var WP_User&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $wp_user = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Custom data can be used by other plugins via the set_custom_data() and&nbsp;</div></li><li><div>     * get_custom_data() functions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This can be used to store additional information on user-level, e.g.&nbsp;</div></li><li><div>     * settings needed by some Add-ons or even by other plugins.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $custom_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    // -------------------------------------------------------------- COLLECTION&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get current member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return MS_Model_Member The current member.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function get_current_member() {&nbsp;</div></li><li><div>        return MS_Factory::load( 'MS_Model_Member', get_current_user_id() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks if user-signup is enabled for this site or not.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function can_register() {&nbsp;</div></li><li><div>        static $Signup_Allowed = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( null === $Signup_Allowed ) {&nbsp;</div></li><li><div>            $Signup_Allowed = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_multisite() ) {&nbsp;</div></li><li><div>                $reg_option = get_site_option( 'registration', 'none' );&nbsp;</div></li><li><div>                if ( in_array( $reg_option, array( 'all', 'user' ) ) ) {&nbsp;</div></li><li><div>                    $Signup_Allowed = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( get_option( 'users_can_register' ) ) {&nbsp;</div></li><li><div>                    $Signup_Allowed = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_member_can_register', &nbsp;</div></li><li><div>            $Signup_Allowed&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Allows users to register for this site.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function allow_registration() {&nbsp;</div></li><li><div>        if ( self::can_register() ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            $reg_option = get_site_option( 'registration', 'none' );&nbsp;</div></li><li><div>            if ( 'blog' == $reg_option ) {&nbsp;</div></li><li><div>                // Creation of new blogs is allowd. Add User-Registration.&nbsp;</div></li><li><div>                update_site_option( 'registration', 'all' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Only enable user registration and keep blogs disabled.&nbsp;</div></li><li><div>                update_site_option( 'registration', 'user' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Simply enable registration on single sites.&nbsp;</div></li><li><div>            update_option( 'users_can_register', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get members total count.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $args The query user args&nbsp;</div></li><li><div>     *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query&nbsp;</div></li><li><div>     * @return int The count.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_members_count( $args = null ) {&nbsp;</div></li><li><div>        $args = self::get_query_args( $args, self::SEARCH_ALL_USERS );&nbsp;</div></li><li><div>        $args['number'] = 0;&nbsp;</div></li><li><div>        $args['count_total'] = true;&nbsp;</div></li><li><div>        $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_members_count', &nbsp;</div></li><li><div>            $wp_user_search-&gt;get_total()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get members IDs.&nbsp;</div></li><li><div>     * The IDs are cached and only fetched once for each set of $args.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  $args The query user args&nbsp;</div></li><li><div>     *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query&nbsp;</div></li><li><div>     * @return array List of member IDs&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_member_ids( $args = null, $search_option = self::SEARCH_ALL_USERS ) {&nbsp;</div></li><li><div>        static $Members = array();&nbsp;</div></li><li><div>        if ( ! isset( $args['number'] ) ) {&nbsp;</div></li><li><div>            $args['number'] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = json_encode( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $Members[$key] ) ) {&nbsp;</div></li><li><div>            $args = self::get_query_args( $args, $search_option );&nbsp;</div></li><li><div>            $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>            $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>            $members = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $users as $user_id ) {&nbsp;</div></li><li><div>                $members[] = $user_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $Members[$key] = apply_filters(&nbsp;</div></li><li><div>                'ms_model_member_get_member_ids', &nbsp;</div></li><li><div>                $members, &nbsp;</div></li><li><div>                $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $Members[$key];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get members.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  $args The query user args&nbsp;</div></li><li><div>     *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query&nbsp;</div></li><li><div>     * @return MS_Model_Member[] The selected members.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_members( $args = null, $search_option = self::SEARCH_ALL_USERS ) {&nbsp;</div></li><li><div>        $members = array();&nbsp;</div></li><li><div>        $ids = self::get_member_ids( $args, $search_option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $ids as $user_id ) {&nbsp;</div></li><li><div>            $members[] = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_members', &nbsp;</div></li><li><div>            $members, &nbsp;</div></li><li><div>            $ids, &nbsp;</div></li><li><div>            $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get usernames.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $args The query user args&nbsp;</div></li><li><div>     *                @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query&nbsp;</div></li><li><div>     * @param string $search_option The search options (only members, not members, all users).&nbsp;</div></li><li><div>     * @return array {&nbsp;</div></li><li><div>     *     @type int $id The user_id.&nbsp;</div></li><li><div>     *     @type string $username The username.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_usernames( $args = null, $search_option = self::SEARCH_ONLY_MEMBERS, $return_array = true ) {&nbsp;</div></li><li><div>        $members = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $return_array ) {&nbsp;</div></li><li><div>            $members[0] = __( 'Select a user', 'membership2' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['fields'] = array( 'ID', 'user_login' );&nbsp;</div></li><li><div>        $args['number'] = 0;&nbsp;</div></li><li><div>        $args = self::get_query_args( $args, $search_option );&nbsp;</div></li><li><div>        $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>        $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $users as $user ) {&nbsp;</div></li><li><div>            if ( ! self::is_admin_user( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>                if ( $return_array ) {&nbsp;</div></li><li><div>                    $members[ $user-&gt;ID ] = $user-&gt;user_login;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $members[] = array(&nbsp;</div></li><li><div>                        'id' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>                        'text' =&gt; $user-&gt;user_login, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_members_usernames', &nbsp;</div></li><li><div>            $members, &nbsp;</div></li><li><div>            $return_array&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get WP_Query object arguments.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Default search arguments for this model.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $args The query user args&nbsp;</div></li><li><div>     *                @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query&nbsp;</div></li><li><div>     * @param string $search_option The search options (only members, not members, all users).&nbsp;</div></li><li><div>     * @return array $args The parsed args.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_query_args( $args = null, $search_option = self::SEARCH_ONLY_MEMBERS ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_query_args_defaults', &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'order' =&gt; 'DESC', &nbsp;</div></li><li><div>                'orderby' =&gt; 'ID', &nbsp;</div></li><li><div>                'number' =&gt; 20, &nbsp;</div></li><li><div>                'offset' =&gt; 0, &nbsp;</div></li><li><div>                'fields' =&gt; 'ID', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = lib3()-&gt;array-&gt;get( $args );&nbsp;</div></li><li><div>        lib3()-&gt;array-&gt;equip( $args, 'meta_query', 'membership_id', 'subscription_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'none' !== $args['meta_query'] ) {&nbsp;</div></li><li><div>            $args['meta_query'] = lib3()-&gt;array-&gt;get( $args['meta_query'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $search_option ) {&nbsp;</div></li><li><div>                case self::SEARCH_ONLY_MEMBERS:&nbsp;</div></li><li><div>                    $args['meta_query'] = array(&nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'key' =&gt; 'ms_is_member', &nbsp;</div></li><li><div>                            'value' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case self::SEARCH_ALL_USERS:&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            unset( $args['meta_query'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // For performance reasons we execute a custom SQL to get relevant user_ids.&nbsp;</div></li><li><div>        if ( ! empty( $args['membership_id'] )&nbsp;</div></li><li><div>            || ! empty( $args['subscription_status'] )&nbsp;</div></li><li><div>            && 'all' != $args['subscription_status']&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            $membership_id = intval( $args['membership_id'] );&nbsp;</div></li><li><div>            $status = $args['subscription_status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $status ) {&nbsp;</div></li><li><div>                case 'expired':&nbsp;</div></li><li><div>                    $status_val = implode(&nbsp;</div></li><li><div>                        ', ', &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            &quot;'&quot; . MS_Model_Relationship::STATUS_TRIAL_EXPIRED . &quot;'&quot;, &nbsp;</div></li><li><div>                            &quot;'&quot; . MS_Model_Relationship::STATUS_EXPIRED . &quot;'&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $status_val = $wpdb-&gt;prepare( &quot; '%s' &quot;, $status );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $sql = &quot;&nbsp;</div></li><li><div>            SELECT DISTINCT usr.meta_value&nbsp;</div></li><li><div>            FROM {$wpdb-&gt;posts} p&nbsp;</div></li><li><div>            INNER JOIN {$wpdb-&gt;postmeta} mem ON mem.post_id=p.ID AND mem.meta_key='membership_id'&nbsp;</div></li><li><div>            INNER JOIN {$wpdb-&gt;postmeta} sta ON sta.post_id=p.ID AND sta.meta_key='status'&nbsp;</div></li><li><div>            INNER JOIN {$wpdb-&gt;postmeta} usr ON usr.post_id=p.ID AND usr.meta_key='user_id'&nbsp;</div></li><li><div>            WHERE&nbsp;</div></li><li><div>                p.post_type = %s&nbsp;</div></li><li><div>                AND ('0' = %s OR mem.meta_value = %s)&nbsp;</div></li><li><div>                AND ('' = %s OR sta.meta_value IN ({$status_val}))&nbsp;</div></li><li><div>            &quot;;&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                $sql, &nbsp;</div></li><li><div>                MS_Model_Relationship::get_post_type(), &nbsp;</div></li><li><div>                $membership_id, &nbsp;</div></li><li><div>                $membership_id, &nbsp;</div></li><li><div>                $status&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $ids = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>            if ( empty( $ids ) || ! is_array( $ids ) ) { $ids = array( 0 ); }&nbsp;</div></li><li><div>            $args['include'] = $ids;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( MS_Plugin::is_network_wide() ) {&nbsp;</div></li><li><div>            $defaults['blog_id'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_query_args', &nbsp;</div></li><li><div>            $args, &nbsp;</div></li><li><div>            $defaults&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the current user ID.&nbsp;</div></li><li><div>     * This function can be called before the init action hook.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Much of this logic is taken from wp-includes/pluggable.php&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @return int|false&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_user_id() {&nbsp;</div></li><li><div>        static $User_id = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $User_id ) {&nbsp;</div></li><li><div>            // We already found the user-id, no need to do it again.&nbsp;</div></li><li><div>            return $User_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( defined( 'DOING_CRON' ) && DOING_CRON ) {&nbsp;</div></li><li><div>            // A cron request has no user credentials...&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cookie = wp_parse_auth_cookie();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $cookie ) {&nbsp;</div></li><li><div>            // Missing, expired or corrupt cookie.&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $scheme = $cookie['scheme'];&nbsp;</div></li><li><div>        $username = $cookie['username'];&nbsp;</div></li><li><div>        $hmac = $cookie['hmac'];&nbsp;</div></li><li><div>        $token = $cookie['token'];&nbsp;</div></li><li><div>        $expiration = $cookie['expiration'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_user_by( 'login', $username );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $user ) {&nbsp;</div></li><li><div>            // Invalid username.&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $pass_frag = substr( $user-&gt;user_pass, 8, 4 );&nbsp;</div></li><li><div>        $key = wp_hash( $username . '|' . $pass_frag . '|' . $expiration . '|' . $token, $scheme );&nbsp;</div></li><li><div>        $algo = function_exists( 'hash' ) ? 'sha256' : 'sha1';&nbsp;</div></li><li><div>        $hash = hash_hmac( $algo, $username . '|' . $expiration . '|' . $token, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! hash_equals( $hash, $hmac ) ) {&nbsp;</div></li><li><div>            // Forged/expired cookie value.&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remember the user-ID so we don't have to validate everything again.&nbsp;</div></li><li><div>        $User_id = $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $User_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify is user is logged in.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean True if user is logged in.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_logged_in() {&nbsp;</div></li><li><div>        $logged = is_user_logged_in();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'ms_member_is_logged_in', $logged );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify is user is Admin user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int|false $user_id Optional. The user ID. Default to current user.&nbsp;</div></li><li><div>     * @param  bool $deprecated Do not use.&nbsp;</div></li><li><div>     * @return boolean True if user is admin.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function is_admin_user( $user_id = false ) {&nbsp;</div></li><li><div>        $cache_result = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( self::$_is_admin_user[ $user_id ] ) ) {&nbsp;</div></li><li><div>            $is_admin = false;&nbsp;</div></li><li><div>            $default_user_id = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                $default_user_id = $user_id;&nbsp;</div></li><li><div>                $user_id = self::get_user_id();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_super_admin( $user_id ) ) {&nbsp;</div></li><li><div>                // Superadmin always is considered admin user, no discussion...&nbsp;</div></li><li><div>                $is_admin = true;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Use the capability defined by the main plugin controller.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * This capability defines which user is considered admin user.&nbsp;</div></li><li><div>                 * An Admin user has full permissions to edit M2 settings.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * To modify the capability:&nbsp;</div></li><li><div>                 *   Use filter `ms_admin_user_capability`  or&nbsp;</div></li><li><div>                 *   define( 'MS_ADMIN_CAPABILITY', '...' )&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @var string|bool A WordPress capability or boolean false.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $controller = MS_Plugin::instance()-&gt;controller;&nbsp;</div></li><li><div>                if ( $controller ) {&nbsp;</div></li><li><div>                    $capability = $controller-&gt;capability;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // This is used in case the function is called too early.&nbsp;</div></li><li><div>                    $capability = 'manage_options';&nbsp;</div></li><li><div>                    $cache_result = false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $capability ) ) {&nbsp;</div></li><li><div>                    if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                        $is_admin = current_user_can( $capability );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $is_admin = user_can( $user_id, $capability );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $is_admin = apply_filters(&nbsp;</div></li><li><div>                    'ms_model_member_is_admin_user', &nbsp;</div></li><li><div>                    $is_admin, &nbsp;</div></li><li><div>                    $user_id, &nbsp;</div></li><li><div>                    $capability&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $cache_result ) {&nbsp;</div></li><li><div>                self::$_is_admin_user[ $user_id ] = $is_admin;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( null !== $default_user_id ) {&nbsp;</div></li><li><div>                    self::$_is_admin_user[ $default_user_id ] = $is_admin;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_admin = self::$_is_admin_user[ $user_id ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_admin;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify is user is Admin user and simulation mode is deactivated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|false $user_id Optional. The user ID. Default to current user.&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function is_normal_admin( $user_id = false ) {&nbsp;</div></li><li><div>        if ( ! isset( self::$_is_normal_admin[$user_id] ) ) {&nbsp;</div></li><li><div>            $res = self::is_admin_user( $user_id )&nbsp;</div></li><li><div>                && ! MS_Factory::load( 'MS_Model_Simulate' )-&gt;is_simulating();&nbsp;</div></li><li><div>            self::$_is_normal_admin[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                self::$_is_normal_admin[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$_is_normal_admin[$user_id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify is user is Admin user and simulation mode is active.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|false $user_id Optional. The user ID. Default to current user.&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function is_simulated_user( $user_id = false ) {&nbsp;</div></li><li><div>        if ( ! isset( self::$_is_simulated_user[$user_id] ) ) {&nbsp;</div></li><li><div>            $res = self::is_admin_user( $user_id )&nbsp;</div></li><li><div>                && MS_Factory::load( 'MS_Model_Simulate' )-&gt;is_simulating();&nbsp;</div></li><li><div>            self::$_is_simulated_user[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                self::$_is_simulated_user[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$_is_simulated_user[$user_id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify is user is not Admin user and simulation mode is deactivated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|false $user_id Optional. The user ID. Default to current user.&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function is_normal_user( $user_id = false ) {&nbsp;</div></li><li><div>        if ( ! isset( self::$_is_normal_user[$user_id] ) ) {&nbsp;</div></li><li><div>            // Simlation is only activated when the current user is an Admin.&nbsp;</div></li><li><div>            $res = ! self::is_admin_user( $user_id );&nbsp;</div></li><li><div>            self::$_is_normal_user[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                self::$_is_normal_user[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$_is_normal_user[$user_id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get email addresses of all admin users.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string[] The admin emails.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_admin_user_emails() {&nbsp;</div></li><li><div>        $admins = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'role' =&gt; 'administrator', &nbsp;</div></li><li><div>            'fields' =&gt; array( 'ID', 'user_email' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>        $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty ($users ) ) {&nbsp;</div></li><li><div>            foreach ( $users as $user ) {&nbsp;</div></li><li><div>                $admins[ $user-&gt;user_email ] = $user-&gt;user_email;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_admin_user_emails', &nbsp;</div></li><li><div>            $admins&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get username from user_id.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $user_id The user ID to get username.&nbsp;</div></li><li><div>     * @return string The username.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_username( $user_id ) {&nbsp;</div></li><li><div>        $member = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_username', &nbsp;</div></li><li><div>            $member-&gt;username, &nbsp;</div></li><li><div>            $user_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search for orphaned relationships and remove them.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * We write a custom SQL query for this, as solving it with a meta-query&nbsp;</div></li><li><div>     * structure is very performance intense and requires at least two queries&nbsp;</div></li><li><div>     * and a loop...&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * For additional performance we will only do this check once every hour.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note: We cannot use the hook 'delete_user' to do this, because in&nbsp;</div></li><li><div>     * Multisite users are deleted via the Main network admin; however, there&nbsp;</div></li><li><div>     * we do not have access to the site data; especially if Plugin is not&nbsp;</div></li><li><div>     * network enabled...&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo Change this to use WP-Cron instead of own implementation...&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function clean_db() {&nbsp;</div></li><li><div>        $timestamp = absint( MS_Factory::get_transient( 'ms_member_clean_db' ) );&nbsp;</div></li><li><div>        $elapsed = time() - $timestamp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $elapsed &gt; 3600 ) {&nbsp;</div></li><li><div>            // Last check is longer than 1 hour ago. Check again.&nbsp;</div></li><li><div>            MS_Factory::set_transient( 'ms_member_clean_db', time(), 3600 );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Last check was within past hour. Do nothing yet...&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Find all Relationships that have no post-author.&nbsp;</div></li><li><div>        $sql = &quot;&nbsp;</div></li><li><div>        SELECT p.ID&nbsp;</div></li><li><div>        FROM {$wpdb-&gt;posts} p&nbsp;</div></li><li><div>        WHERE p.post_type=%s&nbsp;</div></li><li><div>        AND NOT EXISTS (&nbsp;</div></li><li><div>            SELECT 1&nbsp;</div></li><li><div>            FROM {$wpdb-&gt;users} u&nbsp;</div></li><li><div>            WHERE u.ID = p.post_author&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            $sql, &nbsp;</div></li><li><div>            MS_Model_Relationship::get_post_type()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete these Relationships!&nbsp;</div></li><li><div>        $items = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>        foreach ( $items as $item ) {&nbsp;</div></li><li><div>            $junk = MS_Factory::load( 'MS_Model_Relationship', $item-&gt;ID );&nbsp;</div></li><li><div>            $junk-&gt;delete();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    // ------------------------------------------------------------- SINGLE ITEM&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of variables that should be included in serialization, &nbsp;</div></li><li><div>     * i.e. these values are the only ones that are stored in DB&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __sleep() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'id', &nbsp;</div></li><li><div>            'username', &nbsp;</div></li><li><div>            'email', &nbsp;</div></li><li><div>            'name', &nbsp;</div></li><li><div>            'first_name', &nbsp;</div></li><li><div>            'last_name', &nbsp;</div></li><li><div>            'subscriptions', &nbsp;</div></li><li><div>            'is_member', &nbsp;</div></li><li><div>            'gateway_profiles', &nbsp;</div></li><li><div>            'custom_data', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validates the object right after it was loaded/initialized.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * We ensure that the custom_data field is an array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function prepare_obj() {&nbsp;</div></li><li><div>        parent::prepare_obj();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $this-&gt;custom_data ) ) {&nbsp;</div></li><li><div>            $this-&gt;custom_data = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Create a new user is id is empty.&nbsp;</div></li><li><div>     * Save member fields to wp_user and wp_usermeta tables.&nbsp;</div></li><li><div>     * Set cache for further use in MS_Factory::load.&nbsp;</div></li><li><div>     * The usermeta are prefixed with 'ms_'.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return MS_Model_Member The saved member object.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function save() {&nbsp;</div></li><li><div>        $class = get_class( $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Tell WordPress core that we do NOT want to trigger the&nbsp;</div></li><li><div>         * Password-Reset email while updating the user now.&nbsp;</div></li><li><div>         * New since WordPress 4.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since  1.0.2.2&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_filter( 'send_password_change_email', '__return_false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;id ) ) {&nbsp;</div></li><li><div>            $this-&gt;create_new_user();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $this-&gt;username ) ) {&nbsp;</div></li><li><div>            $wp_user = new stdClass();&nbsp;</div></li><li><div>            $wp_user-&gt;ID = $this-&gt;id;&nbsp;</div></li><li><div>            $wp_user-&gt;nickname = $this-&gt;username;&nbsp;</div></li><li><div>            $wp_user-&gt;user_nicename = $this-&gt;username;&nbsp;</div></li><li><div>            $wp_user-&gt;first_name = $this-&gt;first_name;&nbsp;</div></li><li><div>            $wp_user-&gt;last_name = $this-&gt;last_name;&nbsp;</div></li><li><div>            $wp_user-&gt;user_email = $this-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $this-&gt;password )&nbsp;</div></li><li><div>                && $this-&gt;password == $this-&gt;password2&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $wp_user-&gt;user_pass = $this-&gt;password;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            wp_update_user( get_object_vars( $wp_user ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Serialize our plugin meta data&nbsp;</div></li><li><div>        $data = MS_Factory::serialize_model( $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Then update all meta fields that are inside the collection&nbsp;</div></li><li><div>        foreach ( $data as $field =&gt; $val ) {&nbsp;</div></li><li><div>            update_user_meta( $this-&gt;id, 'ms_' . $field, $val );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_set( $this-&gt;id, $this, $class );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove our &quot;mute-password-reset-email&quot; trigger again.&nbsp;</div></li><li><div>        remove_filter( 'send_password_change_email', '__return_false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'ms_model_member_save', $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create new WP user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function create_new_user() {&nbsp;</div></li><li><div>        // Check if the WordPress settings allow user registration.&nbsp;</div></li><li><div>        if ( ! MS_Model_Member::can_register() ) {&nbsp;</div></li><li><div>            throw new Exception( __( 'Registration is currently not allowed.', 'membership2' ), 1 );&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>            throw new Exception( __( 'You cannot register a new account, because you are already logged in.', 'membership2' ), 1 );&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $validation_errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $required = array(&nbsp;</div></li><li><div>            'username' =&gt; __( 'Username', 'membership2' ), &nbsp;</div></li><li><div>            'email' =&gt; __( 'Email address', 'membership2' ), &nbsp;</div></li><li><div>            'password' =&gt; __( 'Password', 'membership2' ), &nbsp;</div></li><li><div>            'password2' =&gt; __( 'Password confirmation', 'membership2' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the required field list to customize the fields that are&nbsp;</div></li><li><div>         * mandatory.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.0.1.0&nbsp;</div></li><li><div>         * @var   array&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $required = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_create_user_required_fields', &nbsp;</div></li><li><div>            $required&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $required as $field =&gt; $message ) {&nbsp;</div></li><li><div>            if ( empty( $this-&gt;$field ) && empty( $_POST[$field] ) ) {&nbsp;</div></li><li><div>                $validation_errors-&gt;add(&nbsp;</div></li><li><div>                    $field, &nbsp;</div></li><li><div>                    sprintf(&nbsp;</div></li><li><div>                        __( 'Please ensure that the &lt;span class=&quot;ms-bold&quot;&gt;%s&lt;/span&gt; information is completed.', 'membership2' ), &nbsp;</div></li><li><div>                        $message&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;password != $this-&gt;password2 ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'passmatch', &nbsp;</div></li><li><div>                __( 'Please ensure the passwords match.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! validate_username( $this-&gt;username ) ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'usernamenotvalid', &nbsp;</div></li><li><div>                __( 'The username is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( username_exists( $this-&gt;username ) ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'usernameexists', &nbsp;</div></li><li><div>                __( 'That username is already taken, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_email( $this-&gt;email ) ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'emailnotvalid', &nbsp;</div></li><li><div>                __( 'The email address is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( email_exists( $this-&gt;email ) ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'emailexists', &nbsp;</div></li><li><div>                __( 'That email address is already taken, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check the multisite Email-Domain limitation for new registrations.&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>            $limited_domains = get_site_option( 'limited_email_domains' );&nbsp;</div></li><li><div>            $banned_domains = get_site_option( 'banned_email_domains' );&nbsp;</div></li><li><div>            $email_domain = substr( strrchr( $this-&gt;email, '@' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $illegal_names && is_array( $illegal_names ) ) {&nbsp;</div></li><li><div>                if ( in_array( $this-&gt;username, $illegal_names ) ) {&nbsp;</div></li><li><div>                    $validation_errors-&gt;add(&nbsp;</div></li><li><div>                        'illegalname', &nbsp;</div></li><li><div>                        __( 'The username is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $limited_domains && is_array( $limited_domains ) ) {&nbsp;</div></li><li><div>                if ( ! in_array( $email_domain, $limited_domains ) ) {&nbsp;</div></li><li><div>                    $validation_errors-&gt;add(&nbsp;</div></li><li><div>                        'emaildomain', &nbsp;</div></li><li><div>                        __( 'That email domain is not allowed for registration, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $banned_domains && is_array( $banned_domains ) ) {&nbsp;</div></li><li><div>                if ( in_array( $email_domain, $banned_domains ) ) {&nbsp;</div></li><li><div>                    $validation_errors-&gt;add(&nbsp;</div></li><li><div>                        'emaildomain', &nbsp;</div></li><li><div>                        __( 'That email domain is not allowed for registration, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $validation_errors = apply_filters(&nbsp;</div></li><li><div>            'ms_model_membership_create_new_user_validation_errors', &nbsp;</div></li><li><div>            $validation_errors, &nbsp;</div></li><li><div>                        $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Compatibility with WangGuard&nbsp;</div></li><li><div>        $_POST['user_email'] = $this-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_data = array(&nbsp;</div></li><li><div>            'user_name' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>            'orig_username' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>            'user_email' =&gt; $this-&gt;email, &nbsp;</div></li><li><div>            'errors' =&gt; $validation_errors, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_data = apply_filters(&nbsp;</div></li><li><div>            'wpmu_validate_user_signup', &nbsp;</div></li><li><div>            $user_data&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $user_data ) ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Some plugins incorrectly return a WP_Error object as result of&nbsp;</div></li><li><div>             * the wpmu_validate_user_signup filter.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $validation_errors = $user_data;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $validation_errors = $user_data['errors'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errors = $validation_errors-&gt;get_error_messages();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $errors ) ) {&nbsp;</div></li><li><div>            throw new Exception( implode( '&lt;br/&gt;', $errors ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( ! $this-&gt;password ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * For some reason the user did not provide a password in the&nbsp;</div></li><li><div>                 * registration form. We help out here by creating a password&nbsp;</div></li><li><div>                 * for the little bugger and send him a password-reset email.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * So: Generate a STRONG password for the new user.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * Important: This password should be sent to the user via the&nbsp;</div></li><li><div>                 * Email template &quot;User Account Created&quot;&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $this-&gt;password = wp_generate_password( 24 );&nbsp;</div></li><li><div>                $this-&gt;password2 = $this-&gt;password;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>                        &nbsp;</div></li><li><div>            $user_id = wp_create_user(&nbsp;</div></li><li><div>                $this-&gt;username, &nbsp;</div></li><li><div>                $this-&gt;password, &nbsp;</div></li><li><div>                $this-&gt;email&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>                $validation_errors-&gt;add(&nbsp;</div></li><li><div>                    'userid', &nbsp;</div></li><li><div>                    $user_id-&gt;get_error_message()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                throw new Exception(&nbsp;</div></li><li><div>                    implode(&nbsp;</div></li><li><div>                        '&lt;br/&gt;', &nbsp;</div></li><li><div>                        $validation_errors-&gt;get_error_messages()&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>                        else&nbsp;</div></li><li><div>                        {&nbsp;</div></li><li><div>                            if( isset( $_POST['display_name'] ) && $_POST['display_name'] != '' )&nbsp;</div></li><li><div>                            {&nbsp;</div></li><li><div>                                wp_update_user( array( 'ID' =&gt; $user_id, 'display_name' =&gt; $_POST['display_name'] ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;id = $user_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'ms_model_member_create_new_user', $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Marks the current user as &quot;confirmed&quot;&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function confirm() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $auto_confirm = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_auto_confirm', &nbsp;</div></li><li><div>            true, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $auto_confirm ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;UPDATE $wpdb-&gt;users SET user_status = 0 WHERE ID = %d&quot;;&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( $sql, $this-&gt;id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sign on user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function signon_user() {&nbsp;</div></li><li><div>        $user = new WP_User( $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! headers_sent() ) {&nbsp;</div></li><li><div>            $user = @wp_signon(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'user_login' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>                    'user_password' =&gt; $this-&gt;password, &nbsp;</div></li><li><div>                    'remember' =&gt; true, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Stop here in case the login failed.&nbsp;</div></li><li><div>            if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>                return $user;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Also used in class-ms-controller-dialog.php (Ajax login)&nbsp;</div></li><li><div>        wp_set_current_user( $this-&gt;id );&nbsp;</div></li><li><div>        wp_set_auth_cookie( $this-&gt;id );&nbsp;</div></li><li><div>        do_action( 'wp_login', $this-&gt;username, $user );&nbsp;</div></li><li><div>        do_action( 'ms_model_member_signon_user', $user, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Either creates or updates the value of a custom data field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note: Remember to prefix the $key with a unique string to prevent&nbsp;</div></li><li><div>     * conflicts with other plugins that also use this function.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $key The field-key.&nbsp;</div></li><li><div>     * @param  mixed $value The new value to assign to the field.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_custom_data( $key, $value ) {&nbsp;</div></li><li><div>        $this-&gt;custom_data[ $key ] = $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Removes a custom data field from this object.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $key The field-key.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_custom_data( $key ) {&nbsp;</div></li><li><div>        unset( $this-&gt;custom_data[ $key ] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the value of a custom data field.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $key The field-key.&nbsp;</div></li><li><div>     * @return mixed The value that was previously assigned to the custom field&nbsp;</div></li><li><div>     *         or false if no value was set for the field.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_custom_data( $key ) {&nbsp;</div></li><li><div>        $res = false;&nbsp;</div></li><li><div>        if ( isset( $this-&gt;custom_data[ $key ] ) ) {&nbsp;</div></li><li><div>            $res = $this-&gt;custom_data[ $key ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of all membership IDs of the current user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_membership_ids() {&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>            $result[] = $subscription-&gt;membership_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add a new membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If multiple membership is disabled, may move existing membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Only add a membership if a user is not already a member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $membership_id The membership id to add to.&nbsp;</div></li><li><div>     * @param string $gateway_id Optional. The gateway used to add the membership.&nbsp;</div></li><li><div>     * @param int|string $move_from_id Optional. The membership id(s) to cancel.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return object|null $subscription&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_membership( $membership_id, $gateway_id = 'admin', $move_from_id = 0 ) {&nbsp;</div></li><li><div>        $subscription = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( MS_Model_Membership::is_valid_membership( $membership_id ) ) {&nbsp;</div></li><li><div>            if ( ! $this-&gt;get_subscription( $membership_id ) ) {&nbsp;</div></li><li><div>                $subscription = MS_Model_Relationship::create_ms_relationship(&nbsp;</div></li><li><div>                    $membership_id, &nbsp;</div></li><li><div>                    $this-&gt;id, &nbsp;</div></li><li><div>                    $gateway_id, &nbsp;</div></li><li><div>                    $move_from_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 'admin' != $gateway_id ) {&nbsp;</div></li><li><div>                    $subscription-&gt;get_current_invoice();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( MS_Model_Relationship::STATUS_PENDING !== $subscription-&gt;status ) {&nbsp;</div></li><li><div>                    $this-&gt;subscriptions[] = $subscription;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    usort(&nbsp;</div></li><li><div>                        $this-&gt;subscriptions, &nbsp;</div></li><li><div>                        array( 'MS_Model_Relationship', 'sort_by_priority' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Reset the status and start/expire dates when added by admin.&nbsp;</div></li><li><div>            if ( 'admin' == $gateway_id ) {&nbsp;</div></li><li><div>                $subscription-&gt;start_date = null; // Will calculate correct date.&nbsp;</div></li><li><div>                $subscription-&gt;trial_expire_date = null;&nbsp;</div></li><li><div>                $subscription-&gt;expire_date = null;&nbsp;</div></li><li><div>                $subscription-&gt;status = MS_Model_Relationship::STATUS_ACTIVE;&nbsp;</div></li><li><div>                $subscription-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;is_member = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_add_membership', &nbsp;</div></li><li><div>            $subscription, &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $gateway_id, &nbsp;</div></li><li><div>            $move_from_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Drop a membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Only update the status to deactivated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $membership_id The membership id to drop.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function drop_membership( $membership_id ) {&nbsp;</div></li><li><div>        $subscription = $this-&gt;get_subscription( $membership_id, $key );&nbsp;</div></li><li><div>        if ( $subscription ) {&nbsp;</div></li><li><div>            do_action(&nbsp;</div></li><li><div>                'ms_model_membership_drop_membership', &nbsp;</div></li><li><div>                $subscription, &nbsp;</div></li><li><div>                $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subscription-&gt;deactivate_membership();&nbsp;</div></li><li><div>            unset( $this-&gt;subscriptions[$key] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_member = false;&nbsp;</div></li><li><div>        foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>            if ( ! $subscription-&gt;is_system() ) {&nbsp;</div></li><li><div>                $is_member = true;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;is_member = $is_member;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_model_membership_drop_membership', &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cancel a membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * The membership remains valid until expiration date.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $membership_id The membership id to drop.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function cancel_membership( $membership_id ) {&nbsp;</div></li><li><div>        $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>        if ( $subscription ) {&nbsp;</div></li><li><div>            $subscription-&gt;cancel_membership();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // The membership might be on status &quot;PENDING&quot; which is not included&nbsp;</div></li><li><div>            // in $this-&gt;subscriptions.&nbsp;</div></li><li><div>            $subscription = MS_Model_Relationship::get_subscription(&nbsp;</div></li><li><div>                $this-&gt;id, &nbsp;</div></li><li><div>                $membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $subscription-&gt;user_id == $this-&gt;id ) {&nbsp;</div></li><li><div>                $subscription-&gt;cancel_membership();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_model_membership_cancel_membership', &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Move a membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $old_membership_id The membership id to move from.&nbsp;</div></li><li><div>     * @param int $mew_membership_id The membership id to move to.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function move_membership( $old_membership_id, $mew_membership_id ) {&nbsp;</div></li><li><div>        $old_subscription = $this-&gt;get_subscription( $old_membership_id );&nbsp;</div></li><li><div>        if ( $old_subscription ) {&nbsp;</div></li><li><div>            $new_subscription = MS_Model_Relationship::create_ms_relationship(&nbsp;</div></li><li><div>                $mew_membership_id, &nbsp;</div></li><li><div>                $this-&gt;id, &nbsp;</div></li><li><div>                $old_subscription-&gt;gateway_id, &nbsp;</div></li><li><div>                $old_membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;cancel_membership( $old_membership_id );&nbsp;</div></li><li><div>            $this-&gt;subscriptions[] = $new_subscription;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            MS_Model_Event::save_event(&nbsp;</div></li><li><div>                MS_Model_Event::TYPE_MS_MOVED, &nbsp;</div></li><li><div>                $new_subscription&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_model_membership_move_membership', &nbsp;</div></li><li><div>            $old_membership_id, &nbsp;</div></li><li><div>            $mew_membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check membership relationship status.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Canceled status is allowed until it expires.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $membership_id Optional. The specific membership to verify.&nbsp;</div></li><li><div>     *        If empty, verify against all memberships.&nbsp;</div></li><li><div>     * @return bool True if has a valid membership.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function has_membership( $membership_id = 0 ) {&nbsp;</div></li><li><div>        $has_membership = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allowed membership status to have access&nbsp;</div></li><li><div>        $allowed_status = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_allowed_status', &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                MS_Model_Relationship::STATUS_ACTIVE, &nbsp;</div></li><li><div>                MS_Model_Relationship::STATUS_TRIAL, &nbsp;</div></li><li><div>                MS_Model_Relationship::STATUS_CANCELED, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::is_normal_admin( $this-&gt;id ) ) {&nbsp;</div></li><li><div>            $has_membership = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $membership_id ) ) {&nbsp;</div></li><li><div>            $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>            // Membership-ID specified: Check if user has this membership&nbsp;</div></li><li><div>            if ( $subscription&nbsp;</div></li><li><div>                && in_array( $subscription-&gt;get_status(), $allowed_status )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $has_membership = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! empty ( $this-&gt;subscriptions ) ) {&nbsp;</div></li><li><div>            // No membership-ID: Check if user has *any* membership&nbsp;</div></li><li><div>            foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>                if ( $subscription-&gt;is_system() ) { continue; }&nbsp;</div></li><li><div>                if ( in_array( $subscription-&gt;get_status(), $allowed_status ) ) {&nbsp;</div></li><li><div>                    $has_membership = true;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_has_membership', &nbsp;</div></li><li><div>            $has_membership, &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return the subscription object for the specified membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int|string $membership_id The specific membership to return.&nbsp;</div></li><li><div>     *         Value 'priority' will return the subcription with lowest priority.&nbsp;</div></li><li><div>     * @return MS_Model_Relationship The subscription object.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_subscription( $membership_id, &$key = -1 ) {&nbsp;</div></li><li><div>        $subscription = null;&nbsp;</div></li><li><div>        $key = -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'priority' == $membership_id ) {&nbsp;</div></li><li><div>            // Find subscription with the lowest priority.&nbsp;</div></li><li><div>            $cur_priority = -1;&nbsp;</div></li><li><div>            foreach ( $this-&gt;subscriptions as $ind =&gt; $item ) {&nbsp;</div></li><li><div>                $membership = $item-&gt;get_membership();&nbsp;</div></li><li><div>                if ( ! $membership-&gt;active ) { continue; }&nbsp;</div></li><li><div>                if ( $cur_priority &lt; 0 || $membership-&gt;priority &lt; $cur_priority ) {&nbsp;</div></li><li><div>                    $subscription = $item;&nbsp;</div></li><li><div>                    $cur_priority = $membership-&gt;priority;&nbsp;</div></li><li><div>                    $key = $ind;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! empty( $membership_id ) ) {&nbsp;</div></li><li><div>            // Membership-ID specified: Check if user has this membership&nbsp;</div></li><li><div>            foreach ( $this-&gt;subscriptions as $ind =&gt; $item ) {&nbsp;</div></li><li><div>                if ( $item-&gt;membership_id == $membership_id ) {&nbsp;</div></li><li><div>                    $subscription = $item;&nbsp;</div></li><li><div>                    $key = $ind;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_get_subscription', &nbsp;</div></li><li><div>            $subscription, &nbsp;</div></li><li><div>            $membership_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of memberships for all active subscriptions of the member.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_active_memberships() {&nbsp;</div></li><li><div>        $active_memberships = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_status = array(&nbsp;</div></li><li><div>            MS_Model_Relationship::STATUS_ACTIVE, &nbsp;</div></li><li><div>            MS_Model_Relationship::STATUS_TRIAL, &nbsp;</div></li><li><div>            MS_Model_Relationship::STATUS_CANCELED, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;subscriptions as $sub ) {&nbsp;</div></li><li><div>            if ( $sub-&gt;is_base() ) { continue; }&nbsp;</div></li><li><div>            if ( ! in_array( $sub-&gt;status, $active_status ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $membership = $sub-&gt;get_membership();&nbsp;</div></li><li><div>            $active_memberships[$membership-&gt;id] = $membership;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $active_memberships;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks if the current user is allowed to subscribe to the specified&nbsp;</div></li><li><div>     * membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     * @param  int $membership_id A membership_id.&nbsp;</div></li><li><div>     * @return bool Whether subscription is allowed or not.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function can_subscribe_to( $membership_id ) {&nbsp;</div></li><li><div>        static $Access_Flags = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( null === $Access_Flags ) {&nbsp;</div></li><li><div>            $Access_Flags = array();&nbsp;</div></li><li><div>            $active_memberships = $this-&gt;get_active_memberships();&nbsp;</div></li><li><div>            $all_memberships = MS_Model_Membership::get_memberships();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Controls how to handle conflicts in upgrade path settings when a&nbsp;</div></li><li><div>             * member has multiple memberships.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * Default is true:&nbsp;</div></li><li><div>             *     If one membership forbids the upgrade, then that's it.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * Custom set to false:&nbsp;</div></li><li><div>             *     If one membership allows the upgrade, then allow it.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.0.1.0&nbsp;</div></li><li><div>             * @var   bool&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $prefer_forbidden = apply_filters(&nbsp;</div></li><li><div>                'ms_model_member_can_subscribe_to_prefer_forbidden', &nbsp;</div></li><li><div>                true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $active_memberships as $membership ) {&nbsp;</div></li><li><div>                $base_id = $membership-&gt;id;&nbsp;</div></li><li><div>                if ( $membership-&gt;is_guest() || $membership-&gt;is_user() ) {&nbsp;</div></li><li><div>                    $base_id = 'guest';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $all_memberships as $ms ) {&nbsp;</div></li><li><div>                    if ( isset( $active_memberships[$ms-&gt;id] ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $is_allowed = $ms-&gt;update_allowed( $base_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $Access_Flags[$ms-&gt;id] ) ) {&nbsp;</div></li><li><div>                        $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        if ( $prefer_forbidden && ! $is_allowed ) {&nbsp;</div></li><li><div>                            $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                        } elseif ( ! $prefer_forbidden && $is_allowed ) {&nbsp;</div></li><li><div>                            $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = true;&nbsp;</div></li><li><div>        if ( isset( $Access_Flags[$membership_id] ) ) {&nbsp;</div></li><li><div>            $result = $Access_Flags[$membership_id];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_can_subscribe_to', &nbsp;</div></li><li><div>            $result, &nbsp;</div></li><li><div>            $membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of existing subscriptions that should be cancelled when&nbsp;</div></li><li><div>     * the user signs up to the specified membership.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     * @param  int $membership_id A membership ID.&nbsp;</div></li><li><div>     * @return array Might be an empty array or a list of membership IDs.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function cancel_ids_on_subscription( $membership_id ) {&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $membership = MS_Factory::load( 'MS_Model_Membership', $membership_id );&nbsp;</div></li><li><div>        $active_memberships = $this-&gt;get_active_memberships();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $active_memberships as $ms ) {&nbsp;</div></li><li><div>            if ( $membership-&gt;update_replaces( $ms-&gt;id ) ) {&nbsp;</div></li><li><div>                $result[] = $ms-&gt;id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete member usermeta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Delete all plugin related usermeta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_all_membership_usermeta() {&nbsp;</div></li><li><div>        $this-&gt;subscriptions = array();&nbsp;</div></li><li><div>        $this-&gt;gateway_profiles = array();&nbsp;</div></li><li><div>        $this-&gt;is_member = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_model_membership_delete_all_membership_usermeta', &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the WP_User object that is linked to the current member&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return WP_User&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_user() {&nbsp;</div></li><li><div>        return $this-&gt;wp_user;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a value from the user-meta table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.1.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     * @param  string $key The meta-key.&nbsp;</div></li><li><div>     * @return mixed The meta-value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_meta( $key ) {&nbsp;</div></li><li><div>        return get_user_meta( $this-&gt;id, $key, true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates a value in the user-meta table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.0.1.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     * @param string $key The meta-key.&nbsp;</div></li><li><div>     * @param mixed $value The new meta-value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_meta( $key, $value ) {&nbsp;</div></li><li><div>        update_user_meta( $this-&gt;id, $key, $value );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify if current object is valid.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean True if is valid.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_valid() {&nbsp;</div></li><li><div>        $valid = ( $this-&gt;id &gt; 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'ms_model_member_is_valid', $valid, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get gateway profile.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $gateway The gateway ID.&nbsp;</div></li><li><div>     * @param string $field Optional. The field to retrive. Default to null, &nbsp;</div></li><li><div>     *     returning all profile info.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed The gateway profile info.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_gateway_profile( $gateway, $field = null ) {&nbsp;</div></li><li><div>        $profile = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;gateway_profiles[ $gateway ] ) ) {&nbsp;</div></li><li><div>            $this-&gt;gateway_profiles[ $gateway ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $field ) ) {&nbsp;</div></li><li><div>            $profile = $this-&gt;gateway_profiles[ $gateway ];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( ! isset( $this-&gt;gateway_profiles[ $gateway ][ $field ] ) ) {&nbsp;</div></li><li><div>                $this-&gt;gateway_profiles[ $gateway ][ $field ] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $profile = $this-&gt;gateway_profiles[ $gateway ][ $field ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'ms_model_member_get_gateway_profile', $profile );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set gateway profile.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @api&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $gateway The gateway ID.&nbsp;</div></li><li><div>     * @param string $field The field name to save.&nbsp;</div></li><li><div>     * @param mixed $value The field value to save.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_gateway_profile( $gateway, $field, $value ) {&nbsp;</div></li><li><div>        $this-&gt;gateway_profiles[ $gateway ][ $field ] = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_model_member_set_gateway_profile', &nbsp;</div></li><li><div>            $gateway, &nbsp;</div></li><li><div>            $field, &nbsp;</div></li><li><div>            $value, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate member info.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean True if validated.&nbsp;</div></li><li><div>     * @throws Exception if not validated.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function validate_member_info() {&nbsp;</div></li><li><div>        $validation_errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_email( $this-&gt;email ) ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'emailnotvalid', &nbsp;</div></li><li><div>                __( 'The email address is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;password != $this-&gt;password2 ) {&nbsp;</div></li><li><div>            $validation_errors-&gt;add(&nbsp;</div></li><li><div>                'passmatch', &nbsp;</div></li><li><div>                __( 'Please ensure the passwords match.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $validation_errors = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_validate_member_info_errors_obj', &nbsp;</div></li><li><div>            $validation_errors, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errors = apply_filters(&nbsp;</div></li><li><div>            'ms_model_member_validate_member_info_errors', &nbsp;</div></li><li><div>            $validation_errors-&gt;get_error_messages(), &nbsp;</div></li><li><div>            $validation_errors, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $errors ) ) {&nbsp;</div></li><li><div>            throw new Exception( implode( '&lt;br/&gt;', $errors ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates a new password-reset key and stores it in the DB.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.2.3&nbsp;</div></li><li><div>     * @return object {&nbsp;</div></li><li><div>     *         The reset-key that can be sent to the user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *         @var  key   The reset key&nbsp;</div></li><li><div>     *         @var  url   The full reset URL&nbsp;</div></li><li><div>     *  }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function new_password_reset_key() {&nbsp;</div></li><li><div>        global $wpdb, $wp_hasher;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Generate something random for a password reset key.&nbsp;</div></li><li><div>        $key = wp_generate_password( 20, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'retrieve_password_key', $this-&gt;username, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Now insert a hashed version of the key into the DB.&nbsp;</div></li><li><div>        // Important: The has needs to include the time() value!&nbsp;</div></li><li><div>        if ( empty( $wp_hasher ) ) {&nbsp;</div></li><li><div>            require_once ABSPATH . WPINC . '/class-phpass.php';&nbsp;</div></li><li><div>            $wp_hasher = new PasswordHash( 8, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $hashed = time() . ':' . $wp_hasher-&gt;HashPassword( $key );&nbsp;</div></li><li><div>        $wpdb-&gt;update(&nbsp;</div></li><li><div>            $wpdb-&gt;users, &nbsp;</div></li><li><div>            array( 'user_activation_key' =&gt; $hashed ), &nbsp;</div></li><li><div>            array( 'user_login' =&gt; $this-&gt;username )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        MS_Model_Pages::create_missing_pages();&nbsp;</div></li><li><div>        $reset_url = MS_Model_Pages::get_page_url( MS_Model_Pages::MS_PAGE_ACCOUNT );&nbsp;</div></li><li><div>        $reset_url = esc_url_raw(&nbsp;</div></li><li><div>            add_query_arg(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'action' =&gt; MS_Controller_Frontend::ACTION_VIEW_RESETPASS, &nbsp;</div></li><li><div>                    'key' =&gt; $key, &nbsp;</div></li><li><div>                    'login' =&gt; rawurlencode( $this-&gt;username ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                $reset_url&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return (object) array(&nbsp;</div></li><li><div>            'key' =&gt; $key, &nbsp;</div></li><li><div>            'url' =&gt; $reset_url, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get specific property.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name The name of a property to associate.&nbsp;</div></li><li><div>     * @return mixed The value of a property.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __get( $property ) {&nbsp;</div></li><li><div>        $value = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( property_exists( $this, $property ) ) {&nbsp;</div></li><li><div>            $value = $this-&gt;$property;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            switch ( $property ) {&nbsp;</div></li><li><div>                case 'full_name':&nbsp;</div></li><li><div>                    if ( ! empty( $this-&gt;first_name ) || ! empty( $this-&gt;last_name ) ) {&nbsp;</div></li><li><div>                        $value = trim( $this-&gt;first_name . ' ' . $this-&gt;last_name );&nbsp;</div></li><li><div>                    } elseif ( ! empty( $this-&gt;name ) ) {&nbsp;</div></li><li><div>                        $value = trim( $this-&gt;name );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $value = trim( $this-&gt;username );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                                    &nbsp;</div></li><li><div>                                case 'display_name':&nbsp;</div></li><li><div>                                        $user = get_userdata( $this-&gt;id );&nbsp;</div></li><li><div>                                        $value = $user-&gt;display_name;&nbsp;</div></li><li><div>                                        break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set specific property.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name The name of a property to associate.&nbsp;</div></li><li><div>     * @param mixed $value The value of a property.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __set( $property, $value ) {&nbsp;</div></li><li><div>        if ( property_exists( $this, $property ) ) {&nbsp;</div></li><li><div>            switch ( $property ) {&nbsp;</div></li><li><div>                case 'email':&nbsp;</div></li><li><div>                    if ( is_email( $value ) ) {&nbsp;</div></li><li><div>                        $this-&gt;$property = $value;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'username':&nbsp;</div></li><li><div>                    $this-&gt;$property = sanitize_user( $value );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'name':&nbsp;</div></li><li><div>                case 'first_name':&nbsp;</div></li><li><div>                case 'last_name':&nbsp;</div></li><li><div>                    $this-&gt;$property = sanitize_text_field( $value );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $this-&gt;$property = $value;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>                    if( $property == 'display_name' )&nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                        wp_update_user( array( 'ID' =&gt; $this-&gt;id, 'display_name' =&gt; $value ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    &nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if property isset.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @internal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $property The name of a property.&nbsp;</div></li><li><div>     * @return mixed Returns true/false.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __isset( $property ) {&nbsp;</div></li><li><div>        return isset($this-&gt;$property);&nbsp;</div></li><li><div>    }        &nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.0.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/ms_model_member/" class="active">4.0.1.3</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.2/classes/ms_model_member/" class="">4.0.1.2</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.0/classes/ms_model_member/" class="">4.0.1.0</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.7/classes/ms_model_member/" class="">4.0.0.7</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.2/classes/ms_model_member/" class="">4.0.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>MS_Model_Member</li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>