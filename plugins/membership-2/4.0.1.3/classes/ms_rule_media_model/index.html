<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="4.0.1.3" data-slug="membership-2" data-type="class" data-id="24455"><head xmlns="http://www.w3.org/1999/xhtml"><title> ms_rule_media_model | class | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="MS_Rule_Media_Model, class, plugin, membership-2, 4.0.1.3" /><meta name="description" content="Rule model." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=aa5a20e5a571b809374e3cd9d23e9a8a' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ms_rule_media_model/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_rule_media_model%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fms_rule_media_model%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.3-class-ms_rule_media_model","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ms_rule_media_model" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.3." href="http://hookr.io/plugins/membership-2/4.0.1.3/" class="H_VERSION"><span property="name">4.0.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ms_rule_media_model</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2618"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/all/" title="All">All <span class="count badge">2618</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="1601"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/hooks/" title="Hooks">Hooks <span class="count badge">1601</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1077"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/filters/" title="Filters">Filters <span class="count badge">1077</span></a></li><li class="active" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="207"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/functions/" title="Functions">Functions <span class="count badge">207</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>MS_Rule_Media_Model</strong></h1><p>Rule model.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/membership-2/4.0.1.3/files/app-rule-media-class-ms-rule-media-model/" class="file">/app/rule/media/class-ms-rule-media-model.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="16" class="block" start="16"><li><div>class MS_Rule_Media_Model extends MS_Rule {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Rule type.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string $rule_type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $rule_type = MS_Rule_Media::RULE_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Media protection type constants.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string $protection_type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const PROTECTION_TYPE_BASIC = 'protection_type_basic';&nbsp;</div></li><li><div>    const PROTECTION_TYPE_COMPLETE = 'protection_type_complete';&nbsp;</div></li><li><div>    const PROTECTION_TYPE_HYBRID = 'protection_type_hybrid';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Media protection file change prefix.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const FILE_PROTECTION_PREFIX = 'ms_';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Media protection file seed/token.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const FILE_PROTECTION_INCREMENT = 2771;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the active flag for a specific rule.&nbsp;</div></li><li><div>     * State depends on Add-on&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static public function is_active() {&nbsp;</div></li><li><div>        return MS_Model_Addon::is_enabled( MS_Model_Addon::ADDON_MEDIA );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verify access to the current content.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This rule will return NULL (not relevant), because the media-item is&nbsp;</div></li><li><div>     * protected via the download URL and not by protecting the current page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $id The content id to verify access.&nbsp;</div></li><li><div>     * @param  bool   $admin_has_access Used for post-meta box to get correct&nbsp;</div></li><li><div>     *         post permission: By default admin has access to all posts, if&nbsp;</div></li><li><div>     *         this flag is FALSE then the admin-check is skipped.&nbsp;</div></li><li><div>     * @return bool|null True if has access, false otherwise.&nbsp;</div></li><li><div>     *         Null means: Rule not relevant for current page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function has_access( $id, $admin_has_access = true ) {&nbsp;</div></li><li><div>        if ( MS_Model_Addon::is_enabled( MS_Addon_Mediafiles::ID )&nbsp;</div></li><li><div>            && 'attachment' == get_post_type( $id )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            return parent::has_access( $id, $admin_has_access );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the protection type available.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array {&nbsp;</div></li><li><div>     *     The protection type =&gt; Description.&nbsp;</div></li><li><div>     *     @type string $protection_type The media protection type.&nbsp;</div></li><li><div>     *     @type string $description The media protection description.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_protection_types() {&nbsp;</div></li><li><div>        $settings = MS_Factory::load( 'MS_Model_Settings' );&nbsp;</div></li><li><div>        $mask = $settings-&gt;downloads['masked_url'];&nbsp;</div></li><li><div>        $example1 = MS_Helper_Utility::home_url( $mask . date( '/Y/m/' ) . 'my-image.jpg' );&nbsp;</div></li><li><div>        $example2 = MS_Helper_Utility::home_url( $mask . '/ms_12345.jpg' );&nbsp;</div></li><li><div>        $example3 = MS_Helper_Utility::home_url( $mask . '/?ms_file=ms_12345.jpg' );&nbsp;</div></li><li><div>        $example1 = '&lt;br /&gt;&lt;small&gt;' . __( 'Example:', 'membership2' ) . ' ' . $example1 . '&lt;/small&gt;';&nbsp;</div></li><li><div>        $example2 = '&lt;br /&gt;&lt;small&gt;' . __( 'Example:', 'membership2' ) . ' ' . $example2 . '&lt;/small&gt;';&nbsp;</div></li><li><div>        $example3 = '&lt;br /&gt;&lt;small&gt;' . __( 'Example:', 'membership2' ) . ' ' . $example3 . '&lt;/small&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $protection_types = array(&nbsp;</div></li><li><div>            self::PROTECTION_TYPE_BASIC =&gt; __( 'Basic protection (default)', 'membership2' ) . $example1, &nbsp;</div></li><li><div>            self::PROTECTION_TYPE_COMPLETE =&gt; __( 'Complete protection', 'membership2' ) . $example2, &nbsp;</div></li><li><div>            self::PROTECTION_TYPE_HYBRID =&gt; __( 'Hybrid protection', 'membership2' ) . $example3, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_get_protection_types', &nbsp;</div></li><li><div>            $protection_types&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate protection type.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $type The protection type to validate.&nbsp;</div></li><li><div>     * @return boolean True if is valid.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_valid_protection_type( $type ) {&nbsp;</div></li><li><div>        $valid = false;&nbsp;</div></li><li><div>        $types = self::get_protection_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( array_key_exists( $type, $types ) ) {&nbsp;</div></li><li><div>            $valid = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_is_valid_protection_type', &nbsp;</div></li><li><div>            $valid&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Starts the output buffering to replace all links in the final HTML&nbsp;</div></li><li><div>     * document.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Related filter:&nbsp;</div></li><li><div>     * - init&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function buffer_start() {&nbsp;</div></li><li><div>        ob_start( array( $this, 'protect_download_content' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ends the output buffering and calls the output_callback function.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Related filter:&nbsp;</div></li><li><div>     * - shutdown&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function buffer_end() {&nbsp;</div></li><li><div>        if ( ob_get_level() ) {&nbsp;</div></li><li><div>            ob_end_flush();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set initial protection.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function initialize() {&nbsp;</div></li><li><div>        parent::protect_content();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( MS_Model_Addon::is_enabled( MS_Model_Addon::ADDON_MEDIA ) && ( ! is_admin() && ! is_customize_preview() ) ) {&nbsp;</div></li><li><div>            // Start buffering during init action, though output should only&nbsp;</div></li><li><div>            // happen a lot later... This way we're safe.&nbsp;</div></li><li><div>            $this-&gt;add_action( 'init', 'buffer_start', 9999 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process the buffer right in the end.&nbsp;</div></li><li><div>            $this-&gt;add_action( 'shutdown', 'buffer_end' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;add_action( 'parse_request', 'handle_download_protection', 3 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Protect media file.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Search content and mask media filename and path.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This function is called as output_callback for ob_start() - as a result&nbsp;</div></li><li><div>     * we cannot echo/output anything in this function! The return value of the&nbsp;</div></li><li><div>     * function will be displayed to the user.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $the_content The content before filter.&nbsp;</div></li><li><div>     * @return string The content with masked media url.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function protect_download_content( $the_content ) {&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_rule_media_model_protect_download_content_before', &nbsp;</div></li><li><div>            $the_content, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $download_settings = MS_Plugin::instance()-&gt;settings-&gt;downloads;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! MS_Model_Addon::is_enabled( MS_Model_Addon::ADDON_MEDIA ) ) {&nbsp;</div></li><li><div>            return $the_content;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>        $original_url = trailingslashit( $upload_dir['baseurl'] );&nbsp;</div></li><li><div>        $new_path = trailingslashit(&nbsp;</div></li><li><div>            trailingslashit( get_option( 'home' ) ) .&nbsp;</div></li><li><div>            $download_settings['masked_url']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Find all the urls in the post and then we'll check if they are protected&nbsp;</div></li><li><div>         * Regex from http://blog.mattheworiordan.com/post/13174566389/url-regular-expression-for-links-with-or-without-the&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $url_exp = implode(&nbsp;</div></li><li><div>            '', &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                '/((([A-Za-z]{3, 9}:(?:\/\/)?)', &nbsp;</div></li><li><div>                '(?:[-;:&=\+\$, \w]+@)?', &nbsp;</div></li><li><div>                '[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$, \w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?', &nbsp;</div></li><li><div>                '\??(?:[-\+=&;%@.\w_]*)#?(?:[.\!\/\\w]*))?)/', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $matches = array();&nbsp;</div></li><li><div>        if ( preg_match_all( $url_exp, $the_content, $matches ) ) {&nbsp;</div></li><li><div>            $home = untrailingslashit( get_option( 'home' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * $matches[0] .. Full link    'http://example.com/blog/img.png?ver=1'&nbsp;</div></li><li><div>             * $matches[1] .. Full link    'http://example.com/blog/img.png?ver=1'&nbsp;</div></li><li><div>             * $matches[2] .. Domain only  'http://example.com'&nbsp;</div></li><li><div>             * $matches[3] .. Protocol     'http://'&nbsp;</div></li><li><div>             * $matches[4] .. File path    '/blog/img.png?ver=1'&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            if ( ! empty( $matches ) && ! empty( $matches[2] ) ) {&nbsp;</div></li><li><div>                $links = (array) $matches[0];&nbsp;</div></li><li><div>                $paths = (array) $matches[4];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $links as $key =&gt; $link ) {&nbsp;</div></li><li><div>                    // Ignore all external links.&nbsp;</div></li><li><div>                    if ( 0 !== strpos( $link, $home ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // The file is on local site - is it a valid attachment?&nbsp;</div></li><li><div>                    $file = basename( $paths[ $key ] );&nbsp;</div></li><li><div>                    $post_id = $this-&gt;get_attachment_id( $link );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ignore links that have no relevant wp_posts entry.&nbsp;</div></li><li><div>                    if ( empty( $post_id ) ) { continue; }&nbsp;</div></li><li><div>                    $f_info = $this-&gt;extract_file_info( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // We have a protected file - so we'll mask it!&nbsp;</div></li><li><div>                    switch ( $download_settings['protection_type'] ) {&nbsp;</div></li><li><div>                        case self::PROTECTION_TYPE_COMPLETE:&nbsp;</div></li><li><div>                            $protected_filename = self::FILE_PROTECTION_PREFIX .&nbsp;</div></li><li><div>                                ( $post_id + (int) self::FILE_PROTECTION_INCREMENT ) .&nbsp;</div></li><li><div>                                $f_info-&gt;size_extension .&nbsp;</div></li><li><div>                                '.' . pathinfo( $f_info-&gt;filename, PATHINFO_EXTENSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $the_content = str_replace(&nbsp;</div></li><li><div>                                $link, &nbsp;</div></li><li><div>                                $new_path . $protected_filename, &nbsp;</div></li><li><div>                                $the_content&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        case self::PROTECTION_TYPE_HYBRID:&nbsp;</div></li><li><div>                            $protected_filename = self::FILE_PROTECTION_PREFIX .&nbsp;</div></li><li><div>                                ($post_id + (int) self::FILE_PROTECTION_INCREMENT ) .&nbsp;</div></li><li><div>                                $f_info-&gt;size_extension .&nbsp;</div></li><li><div>                                '.' . pathinfo( $f_info-&gt;filename, PATHINFO_EXTENSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $the_content = str_replace(&nbsp;</div></li><li><div>                                $link, &nbsp;</div></li><li><div>                                $new_path . '?ms_file=' . $protected_filename, &nbsp;</div></li><li><div>                                $the_content&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        case self::PROTECTION_TYPE_BASIC:&nbsp;</div></li><li><div>                        default:&nbsp;</div></li><li><div>                            $the_content = str_replace(&nbsp;</div></li><li><div>                                $link, &nbsp;</div></li><li><div>                                str_replace(&nbsp;</div></li><li><div>                                    $original_url, &nbsp;</div></li><li><div>                                    $new_path, &nbsp;</div></li><li><div>                                    $link&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                                $the_content&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_protect_download_content', &nbsp;</div></li><li><div>            $the_content, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Extract filename and size extension info.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $file The filename to extract info from.&nbsp;</div></li><li><div>     * @return array {&nbsp;</div></li><li><div>     *     @type string $filename The filename.&nbsp;</div></li><li><div>     *     @type string $size_extension The wordpress thumbnail size extension. Default empty.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function extract_file_info( $file ) {&nbsp;</div></li><li><div>        // See if the filename has a size extension and if so, strip it out.&nbsp;</div></li><li><div>        $filename_exp_full = '/(.+)\-(\d+[x]\d+)\.(.+)$/';&nbsp;</div></li><li><div>        $filename_exp_min = '/(.+)\.(.+)$/';&nbsp;</div></li><li><div>        $filematch = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( preg_match( $filename_exp_full, $file, $filematch ) ) {&nbsp;</div></li><li><div>            // Image with an image size attached.&nbsp;</div></li><li><div>            $type = strtolower( $filematch[3] );&nbsp;</div></li><li><div>            $filename = $filematch[1] . '.' . $type;&nbsp;</div></li><li><div>            $size_extension = '-' . $filematch[2];&nbsp;</div></li><li><div>        } elseif ( preg_match( $filename_exp_min, $file, $filematch ) ) {&nbsp;</div></li><li><div>            // Image without an image size definition.&nbsp;</div></li><li><div>            $type = strtolower( $filematch[2] );&nbsp;</div></li><li><div>            $filename = $filematch[1] . '.' . $type;&nbsp;</div></li><li><div>            $size_extension = '';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Image without an extension.&nbsp;</div></li><li><div>            $type = '';&nbsp;</div></li><li><div>            $filename = $file;&nbsp;</div></li><li><div>            $size_extension = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info = (object) array(&nbsp;</div></li><li><div>            'filename' =&gt; $filename, &nbsp;</div></li><li><div>            'size_extension' =&gt; $size_extension, &nbsp;</div></li><li><div>            'type' =&gt; $type, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_extract_file_info', &nbsp;</div></li><li><div>            $info, &nbsp;</div></li><li><div>            $file, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attachment post_id using the filename.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $url The URL to obtain the post_id.&nbsp;</div></li><li><div>     * @return int The post ID or 0 if not found.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_attachment_id( $url ) {&nbsp;</div></li><li><div>        static $Uploads_Url = null;&nbsp;</div></li><li><div>        static $Uploads_Url_Len = 0;&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // First let WordPress try to find the Attachment ID.&nbsp;</div></li><li><div>        $id = $this-&gt;thumbnail_url_to_id( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $id ) {&nbsp;</div></li><li><div>            // Make sure the result ID is a valid attachment ID.&nbsp;</div></li><li><div>            if ( 'attachment' != get_post_type( $id ) ) {&nbsp;</div></li><li><div>                $id = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Manual attempt: Get the filename from the URL and use a custom query.&nbsp;</div></li><li><div>            if ( null === $Uploads_Url ) {&nbsp;</div></li><li><div>                $uploads = wp_upload_dir();&nbsp;</div></li><li><div>                $Uploads_Url = trailingslashit( $uploads['baseurl'] );&nbsp;</div></li><li><div>                $Uploads_Url_Len = strlen( $Uploads_Url );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( false !== strpos( $url, $Uploads_Url ) ) {&nbsp;</div></li><li><div>                $url = substr( $url, $Uploads_Url_Len );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // See if we cached that URL already.&nbsp;</div></li><li><div>            $id = wp_cache_get( $url, 'ms_attachment_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                $sql = &quot;&nbsp;</div></li><li><div>                SELECT wposts.ID&nbsp;</div></li><li><div>                FROM $wpdb-&gt;posts as wposts&nbsp;</div></li><li><div>                    INNER JOIN $wpdb-&gt;postmeta as wpostmeta ON wposts.ID = wpostmeta.post_id&nbsp;</div></li><li><div>                WHERE&nbsp;</div></li><li><div>                    wposts.post_type = 'attachment'&nbsp;</div></li><li><div>                    AND wpostmeta.meta_key = '_wp_attached_file'&nbsp;</div></li><li><div>                    AND wpostmeta.meta_value = %s&nbsp;</div></li><li><div>                &quot;;&nbsp;</div></li><li><div>                $sql = $wpdb-&gt;prepare( $sql, $url );&nbsp;</div></li><li><div>                $id = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_cache_set( $url, $id, 'ms_attachment_id' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_get_attachment_id', &nbsp;</div></li><li><div>            absint( $id ), &nbsp;</div></li><li><div>            $url, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Fetch ID of an image from the image URL.&nbsp;</div></li><li><div>     * The URL can contain the size&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see http://stackoverflow.com/questions/10990808/wordpress-unique-scenario-get-attachment-id-by-url&nbsp;</div></li><li><div>     * @since  1.0.2.6&nbsp;</div></li><li><div>     * @param  string $file_url URL of an attachment.&nbsp;</div></li><li><div>     * @return int The post-ID or 0 if no post found.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function thumbnail_url_to_id( $file_url ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $filename = basename( $file_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // TODO: This is the same code as used in function `get_attachment_id` above??&nbsp;</div></li><li><div>        $rows = $wpdb-&gt;get_results(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT     p.ID, m.meta_value&nbsp;</div></li><li><div>                FROM       {$wpdb-&gt;posts} p&nbsp;</div></li><li><div>                INNER JOIN {$wpdb-&gt;postmeta} m ON p.ID = m.post_id&nbsp;</div></li><li><div>                    AND m.meta_key = '_wp_attachment_metadata'&nbsp;</div></li><li><div>                    AND m.meta_value LIKE %s&nbsp;</div></li><li><div>                &quot;, &nbsp;</div></li><li><div>                '%&quot;' . $filename . '&quot;%'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $rows as $row ) {&nbsp;</div></li><li><div>            $row-&gt;meta_value = maybe_unserialize( $row-&gt;meta_value );&nbsp;</div></li><li><div>            return $row-&gt;ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle protected media access.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Search for masked file and show the proper content, or no access image if don't have access.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Realted Action Hooks:&nbsp;</div></li><li><div>     * - parse_request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WP_Query $query The WP_Query object to filter.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function handle_download_protection( $query ) {&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_rule_media_model_handle_download_protection_before', &nbsp;</div></li><li><div>            $query, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $the_file = false;&nbsp;</div></li><li><div>        $requested_item = false;&nbsp;</div></li><li><div>        $download_settings = MS_Plugin::instance()-&gt;settings-&gt;downloads;&nbsp;</div></li><li><div>        $protection_type = $download_settings['protection_type'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! MS_Model_Addon::is_enabled( MS_Model_Addon::ADDON_MEDIA ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $query-&gt;query_vars['protectedfile'] ) && self::PROTECTION_TYPE_COMPLETE == $protection_type ) {&nbsp;</div></li><li><div>            $requested_item = explode( '/', $query-&gt;query_vars['protectedfile'] );&nbsp;</div></li><li><div>            $requested_item = array_pop( $requested_item );&nbsp;</div></li><li><div>        } elseif ( ! empty( $_GET['ms_file'] )&nbsp;</div></li><li><div>            && self::PROTECTION_TYPE_HYBRID == $protection_type&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            $requested_item = $_GET['ms_file'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $requested_item = MS_Helper_Utility::get_current_url();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $requested_item ) ) {&nbsp;</div></li><li><div>            // At this point we know that the requested post is an attachment.&nbsp;</div></li><li><div>            $f_info = $this-&gt;extract_file_info( $requested_item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $protection_type ) {&nbsp;</div></li><li><div>                case self::PROTECTION_TYPE_COMPLETE:&nbsp;</div></li><li><div>                case self::PROTECTION_TYPE_HYBRID:&nbsp;</div></li><li><div>                    // Work out the post_id again.&nbsp;</div></li><li><div>                    $attachment_id = preg_replace(&nbsp;</div></li><li><div>                        '/^' . self::FILE_PROTECTION_PREFIX . '/', &nbsp;</div></li><li><div>                        '', &nbsp;</div></li><li><div>                        $f_info-&gt;filename&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    &nbsp;</div></li><li><div>                    $request_name = basename($attachment_id); //Get the name of the requested file&nbsp;</div></li><li><div>                    $request_name = pathinfo($request_name); //Get the info the of the requested file&nbsp;</div></li><li><div>                    $attachment_id = str_replace(&quot;ms_&quot;, &quot;&quot;, $request_name['filename']); //Remove the prefix since we always have ms_ and get the attachment id&nbsp;</div></li><li><div>                    &nbsp;</div></li><li><div>                    $attachment_id = $attachment_id - (int) self::FILE_PROTECTION_INCREMENT; //I dont know why this was here&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $the_file = $this-&gt;restore_filename( $attachment_id, $f_info-&gt;size_extension );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                case self::PROTECTION_TYPE_BASIC:&nbsp;</div></li><li><div>                    $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>                    $original_url = $upload_dir['baseurl'];&nbsp;</div></li><li><div>                    $home = get_option( 'home' );&nbsp;</div></li><li><div>                    $original_url = explode( $home, $original_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $furl = untrailingslashit(&nbsp;</div></li><li><div>                        str_replace(&nbsp;</div></li><li><div>                            '/' . $download_settings['masked_url'], &nbsp;</div></li><li><div>                            $original_url[1], &nbsp;</div></li><li><div>                            $requested_item&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $home = untrailingslashit( get_option( 'home' ) );&nbsp;</div></li><li><div>                    $attachment_id = $this-&gt;get_attachment_id( $furl );&nbsp;</div></li><li><div>                    $the_file = $this-&gt;restore_filename( $attachment_id, $f_info-&gt;size_extension );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $the_file )&nbsp;</div></li><li><div>                && ! empty( $attachment_id )&nbsp;</div></li><li><div>                && is_numeric( $attachment_id )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                if ( $this-&gt;can_access_file( $attachment_id ) ) {&nbsp;</div></li><li><div>                    $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>                    $file = trailingslashit( $upload_dir['basedir'] ) . $the_file;&nbsp;</div></li><li><div>                    $this-&gt;output_file( $file );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;show_no_access_image();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action(&nbsp;</div></li><li><div>            'ms_rule_media_model_handle_download_protection_after', &nbsp;</div></li><li><div>            $query, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks if the current user can access the specified attachment.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @param  int $attachment_id The attachment post-ID.&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function can_access_file( $attachment_id ) {&nbsp;</div></li><li><div>        $access = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( MS_Model_Member::is_normal_admin() ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! MS_Model_Addon::is_enabled( MS_Addon_Mediafiles::ID ) ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Default protection mode:&nbsp;</div></li><li><div>             * Protect Attachments based on the parent post.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $parent_id = get_post_field( 'post_parent', $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $parent_id ) {&nbsp;</div></li><li><div>                $access = true;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $member = MS_Model_Member::get_current_member();&nbsp;</div></li><li><div>                foreach ( $member-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>                    $membership = $subscription-&gt;get_membership();&nbsp;</div></li><li><div>                    $access = $membership-&gt;has_access_to_post( $parent_id );&nbsp;</div></li><li><div>                    if ( $access ) { break; }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Advanced protection mode (via Add-on):&nbsp;</div></li><li><div>             * Each Attachment can be protected individually.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $member = MS_Model_Member::get_current_member();&nbsp;</div></li><li><div>            foreach ( $member-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>                $rule = $subscription-&gt;get_membership()-&gt;get_rule( MS_Rule_Media::RULE_ID );&nbsp;</div></li><li><div>                $access = $rule-&gt;has_access( $attachment_id );&nbsp;</div></li><li><div>                if ( $access ) { break; }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_can_access_file', &nbsp;</div></li><li><div>            $access, &nbsp;</div></li><li><div>            $attachment_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Restore filename from post_id.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo refactory hack to get extension.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int    $post_id The attachment post_id.&nbsp;</div></li><li><div>     * @param  string $size_extension The image size extension.&nbsp;</div></li><li><div>     * @return string The attachment filename.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function restore_filename( $post_id, $size_extension ) {&nbsp;</div></li><li><div>        $img_filename = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $post_id ) && is_numeric( $post_id ) ) {&nbsp;</div></li><li><div>            $img_filename = get_post_meta( $post_id, '_wp_attached_file', true );&nbsp;</div></li><li><div>            if ( ! empty( $size_extension ) ) {&nbsp;</div></li><li><div>                // Add back in a size extension if we need to.&nbsp;</div></li><li><div>                $img_filename = str_replace(&nbsp;</div></li><li><div>                    '.' . pathinfo( $img_filename, PATHINFO_EXTENSION ), &nbsp;</div></li><li><div>                    $size_extension . '.' . pathinfo( $img_filename, PATHINFO_EXTENSION ), &nbsp;</div></li><li><div>                    $img_filename&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Hack to remove any double extensions :/ need to change when work out a neater way.&nbsp;</div></li><li><div>                $img_filename = str_replace(&nbsp;</div></li><li><div>                    $size_extension . $size_extension, &nbsp;</div></li><li><div>                    $size_extension, &nbsp;</div></li><li><div>                    $img_filename&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_restore_filename', &nbsp;</div></li><li><div>            $img_filename, &nbsp;</div></li><li><div>            $post_id, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Output file to the browser.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $file The complete path to the file.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function output_file( $file ) {&nbsp;</div></li><li><div>        do_action( 'ms_rule_media_model_output_file_before', $file, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_file( $file ) ) {&nbsp;</div></li><li><div>            status_header( 404 );&nbsp;</div></li><li><div>            die( '404 &#8212; File not found.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $mime = wp_check_filetype( $file );&nbsp;</div></li><li><div>        if ( empty( $mime['type'] ) && function_exists( 'mime_content_type' ) ) {&nbsp;</div></li><li><div>            $mime['type'] = mime_content_type( $file );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $mime['type'] ) {&nbsp;</div></li><li><div>            $mimetype = $mime['type'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $mimetype = 'image/' . substr( $file, strrpos( $file, '.' ) + 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        header( 'Content-type: ' . $mimetype );&nbsp;</div></li><li><div>        if ( false === strpos( $_SERVER['SERVER_SOFTWARE'], 'Microsoft-IIS' ) ) {&nbsp;</div></li><li><div>            header( 'Content-Length: ' . filesize( $file ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>                &nbsp;</div></li><li><div>                if( ! defined( 'M2_MEDIA_ETAG_DISABLED' ) )&nbsp;</div></li><li><div>                {&nbsp;</div></li><li><div>                    if( ! defined( 'M2_MEDIA_ETAG' ) ) define( 'M2_MEDIA_ETAG', 'm2_media_addon_etag' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $last_modified = date_i18n( 'D, d M Y H:i:s', filemtime( $file ) );&nbsp;</div></li><li><div>                    $etag = '&quot;' . md5( $last_modified ) . '&quot;';&nbsp;</div></li><li><div>                    header( &quot;Last-Modified: $last_modified GMT&quot; );&nbsp;</div></li><li><div>                    header( 'ETag: ' . $etag );&nbsp;</div></li><li><div>                    header( 'Expires: ' . date_i18n( 'D, d M Y H:i:s', time() + 100000000 ) . ' GMT' );&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    // Support for Conditional GET.&nbsp;</div></li><li><div>                    if ( isset( $_SERVER['HTTP_IF_NONE_MATCH'] ) ) {&nbsp;</div></li><li><div>                            $client_etag = stripslashes( $_SERVER['HTTP_IF_NONE_MATCH'] );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                            $client_etag = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    if ( ! isset( $_SERVER['HTTP_IF_MODIFIED_SINCE'] ) ) {&nbsp;</div></li><li><div>                            $_SERVER['HTTP_IF_MODIFIED_SINCE'] = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    $client_last_modified = trim( $_SERVER['HTTP_IF_MODIFIED_SINCE'] );&nbsp;</div></li><li><div>                    // If string is empty, return 0. If not, attempt to parse into a timestamp.&nbsp;</div></li><li><div>                    $client_modified_timestamp = $client_last_modified ? strtotime( $client_last_modified ) : 0;&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    // Make a timestamp for our most recent modification...&nbsp;</div></li><li><div>                    $modified_timestamp = strtotime( $last_modified );&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    if ( $client_last_modified && $client_etag ) {&nbsp;</div></li><li><div>                            $valid_etag = ( $client_modified_timestamp &gt;= $modified_timestamp )&nbsp;</div></li><li><div>                                    && ( $client_etag === $etag );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                            $valid_etag = ( $client_modified_timestamp &gt;= $modified_timestamp )&nbsp;</div></li><li><div>                                    || ( $client_etag === $etag );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>                    /**if ( $valid_etag ) {&nbsp;</div></li><li><div>                            status_header( 304 );&nbsp;</div></li><li><div>                            exit;&nbsp;</div></li><li><div>                    }*/&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                &nbsp;</div></li><li><div>        // If we made it this far, just serve the file.&nbsp;</div></li><li><div>        readfile( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'ms_rule_media_model_output_file_after', $file, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Show no access image.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function show_no_access_image() {&nbsp;</div></li><li><div>        $no_access_file = apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_show_no_access_image_path', &nbsp;</div></li><li><div>            MS_Plugin::instance()-&gt;dir . 'app/assets/images/no-access.png'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;output_file( $no_access_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'ms_rule_show_no_access_image_after', $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get content to protect.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     * @param array $args The query post args.&nbsp;</div></li><li><div>     *        @see @link http://codex.wordpress.org/Class_Reference/WP_Query&nbsp;</div></li><li><div>     * @return array The contents array.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_contents( $args = null ) {&nbsp;</div></li><li><div>        $args = self::get_query_args( $args );&nbsp;</div></li><li><div>        $posts = get_posts( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $contents = array();&nbsp;</div></li><li><div>        foreach ( $posts as $content ) {&nbsp;</div></li><li><div>            $content-&gt;id = $content-&gt;ID;&nbsp;</div></li><li><div>            $content-&gt;type = MS_Rule_Media::RULE_ID;&nbsp;</div></li><li><div>            $content-&gt;name = $content-&gt;post_name;&nbsp;</div></li><li><div>            $content-&gt;access = $this-&gt;can_access_file( $content-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $contents[ $content-&gt;id ] = $content;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_get_contents', &nbsp;</div></li><li><div>            $contents, &nbsp;</div></li><li><div>            $args, &nbsp;</div></li><li><div>            $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total content count.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args The query post args.&nbsp;</div></li><li><div>     *        @see @link http://codex.wordpress.org/Class_Reference/WP_Query&nbsp;</div></li><li><div>     * @return int The total content count.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_content_count( $args = null ) {&nbsp;</div></li><li><div>        $args = self::get_query_args( $args );&nbsp;</div></li><li><div>        $query = new WP_Query( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = $query-&gt;found_posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters(&nbsp;</div></li><li><div>            'ms_rule_media_model_get_content_count', &nbsp;</div></li><li><div>            $count, &nbsp;</div></li><li><div>            $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the default query args.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  1.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $args The query post args.&nbsp;</div></li><li><div>     *        @see @link http://codex.wordpress.org/Class_Reference/WP_Query&nbsp;</div></li><li><div>     * @return array The parsed args.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_query_args( $args = null ) {&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'orderby' =&gt; 'post_date', &nbsp;</div></li><li><div>            'order' =&gt; 'DESC', &nbsp;</div></li><li><div>            'post_type' =&gt; 'attachment', &nbsp;</div></li><li><div>            'post_status' =&gt; 'any', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return parent::prepare_query_args( $args, 'get_posts' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 4.0.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/ms_rule_media_model/" class="active">4.0.1.3</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.2/classes/ms_rule_media_model/" class="">4.0.1.2</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.1.0/classes/ms_rule_media_model/" class="">4.0.1.0</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.7/classes/ms_rule_media_model/" class="">4.0.0.7</a></li><li><a href="http://hookr.io/plugins/membership-2/4.0.0.2/classes/ms_rule_media_model/" class="">4.0.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>MS_Rule_Media_Model</li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>