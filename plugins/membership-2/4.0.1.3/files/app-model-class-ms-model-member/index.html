<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.0.1.3" data-slug="membership-2" data-type="file" data-id="22279"><head xmlns="http://www.w3.org/1999/xhtml"><title> app-model-class-ms-model-member | file | Membership 2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, membership-2, 4.0.1.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=0e48e9433ff2449ce151c945a5d14eed' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/app-model-class-ms-model-member/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fapp-model-class-ms-model-member%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fapp-model-class-ms-model-member%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-membership-2-4.0.1.3-file-app-model-class-ms-model-member","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="app-model-class-ms-model-member" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to membership-2." href="http://hookr.io/plugins/membership-2/" class="plugin"><span property="name">membership-2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.0.1.3." href="http://hookr.io/plugins/membership-2/4.0.1.3/" class="H_VERSION"><span property="name">4.0.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/membership-2/4.0.1.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">app-model-class-ms-model-memb&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2618"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/all/" title="All">All <span class="count badge">2618</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="1601"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/hooks/" title="Hooks">Hooks <span class="count badge">1601</span></a></li><li class="" data-id="action" data-count="524"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/actions/" title="Actions">Actions <span class="count badge">524</span></a></li><li class="" data-id="filter" data-count="1077"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/filters/" title="Filters">Filters <span class="count badge">1077</span></a></li><li class="" data-id="class" data-count="738"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/classes/" title="Classes">Classes <span class="count badge">738</span></a></li><li class="" data-id="constant" data-count="34"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/constants/" title="Constants">Constants <span class="count badge">34</span></a></li><li class="" data-id="function" data-count="207"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/functions/" title="Functions">Functions <span class="count badge">207</span></a></li><li class="" data-id="shortcode" data-count="38"><a href="http://hookr.io/plugins/membership-2/4.0.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">38</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/app/model/class-ms-model-member.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Member model.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Defines several details about a WordPress user.</span>&nbsp;</div></li><li><div><span class="comment"> * The Member object allows us to quickly check if the user did subscribe to a</span>&nbsp;</div></li><li><div><span class="comment"> * certain membership, and other useful stuff.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that all properties are declared protected but they can be access</span>&nbsp;</div></li><li><div><span class="comment"> * directly (e.g. `$membership-&gt;type` to get the type value).</span>&nbsp;</div></li><li><div><span class="comment"> * There are magic methods \_\_get() and \_\_set() that do some validation before</span>&nbsp;</div></li><li><div><span class="comment"> * accessing the properties.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @package Membership2</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Model</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class MS_Model_Member extends MS_Model {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Members search constants.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  const SEARCH_ONLY_MEMBERS = 'only members'; <span class="comment">//TODO: replace space with _ !!!!</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Members search constants.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  const SEARCH_ALL_USERS = 'all_users';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cache for function is_admin_user()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool[]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static protected $_is_admin_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cache for function is_normal_admin()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool[]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static protected $_is_normal_admin = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cache for function is_simulated_user()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool[]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static protected $_is_simulated_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cache for function is_normal_user()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool[]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static protected $_is_normal_user = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's active subscriptions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: This field is populated by MS_Factory when the Member instance is</span>&nbsp;</div></li><li><div><span class="comment">   * created.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array {</span>&nbsp;</div></li><li><div><span class="comment">   *     @type int $membership_id The membership ID.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type MS_Model_Relationship The membership relationship model object.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $subscriptions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Indicator if the user is an active M2 Member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This is a convenience/redudant flag to speed up SQL queries.</span>&nbsp;</div></li><li><div><span class="comment">   * Actually everyone that has an active or trial status membership is</span>&nbsp;</div></li><li><div><span class="comment">   * considered an active member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This flag is set when:</span>&nbsp;</div></li><li><div><span class="comment">   * - In MS_Model_Relationship, when a payment is recorded</span>&nbsp;</div></li><li><div><span class="comment">   *   via add_payment()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This flag is reset when:</span>&nbsp;</div></li><li><div><span class="comment">   * - In MS_Model_Relationship, when a subscription is deactivated</span>&nbsp;</div></li><li><div><span class="comment">   *   via check_membership_status()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $is_member = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's username.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Mapped from wordpress $wp_user object.</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_User $user_login.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $username = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Mapped from wordpress $wp_user object.</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_User $user_email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $email = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Mapped from wordpress $wp_user object.</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_User $user_nicename.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's first name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Mapped from wordpress $wp_user object.</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_User $first_name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $first_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's last name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Mapped from wordpress $wp_user object.</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_User $last_name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $last_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's password.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Used when registering.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $password = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's password confirmation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Used when registering.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $password2 = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Member's gateway profiles info.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Save gateway IDs.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array {</span>&nbsp;</div></li><li><div><span class="comment">   *     Return structure: $gateway[ $field ] =&gt; $value;</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $gateway_id The gateway id.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $field The field to store.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type mixed $value The field value to store.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $gateway_profiles = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The associated WP_User object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @var WP_User</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $wp_user = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Custom data can be used by other plugins via the set_custom_data() and</span>&nbsp;</div></li><li><div><span class="comment">   * get_custom_data() functions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This can be used to store additional information on user-level, e.g.</span>&nbsp;</div></li><li><div><span class="comment">   * settings needed by some Add-ons or even by other plugins.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $custom_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  //</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  //</span> -------------------------------------------------------------- COLLECTION&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get current member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return MS_Model_Member The current member.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function get_current_member() {&nbsp;</div></li><li><div>      return MS_Factory::load( 'MS_Model_Member', get_current_user_id() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if user-signup is enabled for this site or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function can_register() {&nbsp;</div></li><li><div>      static $Signup_Allowed = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( null === $Signup_Allowed ) {&nbsp;</div></li><li><div>          $Signup_Allowed = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_multisite() ) {&nbsp;</div></li><li><div>              $reg_option = get_site_option( 'registration', 'none' );&nbsp;</div></li><li><div>              if ( in_array( $reg_option, array( 'all', 'user' ) ) ) {&nbsp;</div></li><li><div>                  $Signup_Allowed = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( get_option( 'users_can_register' ) ) {&nbsp;</div></li><li><div>                  $Signup_Allowed = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_member_can_register', &nbsp;</div></li><li><div>          $Signup_Allowed&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Allows users to register for this site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function allow_registration() {&nbsp;</div></li><li><div>      if ( self::can_register() ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $reg_option = get_site_option( 'registration', 'none' );&nbsp;</div></li><li><div>          if ( 'blog' == $reg_option ) {&nbsp;</div></li><li><div>              <span class="comment">// Creation of new blogs is allowd. Add User-Registration.</span>&nbsp;</div></li><li><div>              update_site_option( 'registration', 'all' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Only enable user registration and keep blogs disabled.</span>&nbsp;</div></li><li><div>              update_site_option( 'registration', 'user' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Simply enable registration on single sites.</span>&nbsp;</div></li><li><div>          update_option( 'users_can_register', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get members total count.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $args The query user args</span>&nbsp;</div></li><li><div><span class="comment">   *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @return int The count.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_members_count( $args = null ) {&nbsp;</div></li><li><div>      $args = self::get_query_args( $args, self::SEARCH_ALL_USERS );&nbsp;</div></li><li><div>      $args['number'] = 0;&nbsp;</div></li><li><div>      $args['count_total'] = true;&nbsp;</div></li><li><div>      $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_members_count', &nbsp;</div></li><li><div>          $wp_user_search-&gt;get_total()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get members IDs.</span>&nbsp;</div></li><li><div><span class="comment">   * The IDs are cached and only fetched once for each set of $args.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $args The query user args</span>&nbsp;</div></li><li><div><span class="comment">   *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @return array List of member IDs</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_member_ids( $args = null, $search_option = self::SEARCH_ALL_USERS ) {&nbsp;</div></li><li><div>      static $Members = array();&nbsp;</div></li><li><div>      if ( ! isset( $args['number'] ) ) {&nbsp;</div></li><li><div>          $args['number'] = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $key = json_encode( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $Members[$key] ) ) {&nbsp;</div></li><li><div>          $args = self::get_query_args( $args, $search_option );&nbsp;</div></li><li><div>          $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>          $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>          $members = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $users as $user_id ) {&nbsp;</div></li><li><div>              $members[] = $user_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $Members[$key] = apply_filters(&nbsp;</div></li><li><div>              'ms_model_member_get_member_ids', &nbsp;</div></li><li><div>              $members, &nbsp;</div></li><li><div>              $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $Members[$key];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get members.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $args The query user args</span>&nbsp;</div></li><li><div><span class="comment">   *         @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @return MS_Model_Member[] The selected members.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_members( $args = null, $search_option = self::SEARCH_ALL_USERS ) {&nbsp;</div></li><li><div>      $members = array();&nbsp;</div></li><li><div>      $ids = self::get_member_ids( $args, $search_option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $ids as $user_id ) {&nbsp;</div></li><li><div>          $members[] = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_members', &nbsp;</div></li><li><div>          $members, &nbsp;</div></li><li><div>          $ids, &nbsp;</div></li><li><div>          $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get usernames.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $args The query user args</span>&nbsp;</div></li><li><div><span class="comment">   *                @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $search_option The search options (only members, not members, all users).</span>&nbsp;</div></li><li><div><span class="comment">   * @return array {</span>&nbsp;</div></li><li><div><span class="comment">   *     @type int $id The user_id.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $username The username.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_usernames( $args = null, $search_option = self::SEARCH_ONLY_MEMBERS, $return_array = true ) {&nbsp;</div></li><li><div>      $members = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $return_array ) {&nbsp;</div></li><li><div>          $members[0] = __( 'Select a user', 'membership2' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['fields'] = array( 'ID', 'user_login' );&nbsp;</div></li><li><div>      $args['number'] = 0;&nbsp;</div></li><li><div>      $args = self::get_query_args( $args, $search_option );&nbsp;</div></li><li><div>      $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>      $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $users as $user ) {&nbsp;</div></li><li><div>          if ( ! self::is_admin_user( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>              if ( $return_array ) {&nbsp;</div></li><li><div>                  $members[ $user-&gt;ID ] = $user-&gt;user_login;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $members[] = array(&nbsp;</div></li><li><div>                      'id' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>                      'text' =&gt; $user-&gt;user_login, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_members_usernames', &nbsp;</div></li><li><div>          $members, &nbsp;</div></li><li><div>          $return_array&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get WP_Query object arguments.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Default search arguments for this model.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $args The query user args</span>&nbsp;</div></li><li><div><span class="comment">   *                @see @link http://codex.wordpress.org/Class_Reference/WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $search_option The search options (only members, not members, all users).</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $args The parsed args.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_query_args( $args = null, $search_option = self::SEARCH_ONLY_MEMBERS ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_query_args_defaults', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'order' =&gt; 'DESC', &nbsp;</div></li><li><div>              'orderby' =&gt; 'ID', &nbsp;</div></li><li><div>              'number' =&gt; 20, &nbsp;</div></li><li><div>              'offset' =&gt; 0, &nbsp;</div></li><li><div>              'fields' =&gt; 'ID', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = lib3()-&gt;array-&gt;get( $args );&nbsp;</div></li><li><div>      lib3()-&gt;array-&gt;equip( $args, 'meta_query', 'membership_id', 'subscription_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'none' !== $args['meta_query'] ) {&nbsp;</div></li><li><div>          $args['meta_query'] = lib3()-&gt;array-&gt;get( $args['meta_query'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $search_option ) {&nbsp;</div></li><li><div>              case self::SEARCH_ONLY_MEMBERS:&nbsp;</div></li><li><div>                  $args['meta_query'] = array(&nbsp;</div></li><li><div>                      array(&nbsp;</div></li><li><div>                          'key' =&gt; 'ms_is_member', &nbsp;</div></li><li><div>                          'value' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case self::SEARCH_ALL_USERS:&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          unset( $args['meta_query'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For performance reasons we execute a custom SQL to get relevant user_ids.</span>&nbsp;</div></li><li><div>      if ( ! empty( $args['membership_id'] )&nbsp;</div></li><li><div>          || ! empty( $args['subscription_status'] )&nbsp;</div></li><li><div>          && 'all' != $args['subscription_status']&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $membership_id = intval( $args['membership_id'] );&nbsp;</div></li><li><div>          $status = $args['subscription_status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $status ) {&nbsp;</div></li><li><div>              case 'expired':&nbsp;</div></li><li><div>                  $status_val = implode(&nbsp;</div></li><li><div>                      ', ', &nbsp;</div></li><li><div>                      array(&nbsp;</div></li><li><div>                          &quot;'&quot; . MS_Model_Relationship::STATUS_TRIAL_EXPIRED . &quot;'&quot;, &nbsp;</div></li><li><div>                          &quot;'&quot; . MS_Model_Relationship::STATUS_EXPIRED . &quot;'&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $status_val = $wpdb-&gt;prepare( &quot; '%s' &quot;, $status );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sql = &quot;&nbsp;</div></li><li><div>          SELECT DISTINCT usr.meta_value&nbsp;</div></li><li><div>          FROM {$wpdb-&gt;posts} p&nbsp;</div></li><li><div>          INNER JOIN {$wpdb-&gt;postmeta} mem ON mem.post_id=p.ID AND mem.meta_key='membership_id'&nbsp;</div></li><li><div>          INNER JOIN {$wpdb-&gt;postmeta} sta ON sta.post_id=p.ID AND sta.meta_key='status'&nbsp;</div></li><li><div>          INNER JOIN {$wpdb-&gt;postmeta} usr ON usr.post_id=p.ID AND usr.meta_key='user_id'&nbsp;</div></li><li><div>          WHERE&nbsp;</div></li><li><div>              p.post_type = %s&nbsp;</div></li><li><div>              AND ('0' = %s OR mem.meta_value = %s)&nbsp;</div></li><li><div>              AND ('' = %s OR sta.meta_value IN ({$status_val}))&nbsp;</div></li><li><div>          &quot;;&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>              $sql, &nbsp;</div></li><li><div>              MS_Model_Relationship::get_post_type(), &nbsp;</div></li><li><div>              $membership_id, &nbsp;</div></li><li><div>              $membership_id, &nbsp;</div></li><li><div>              $status&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $ids = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>          if ( empty( $ids ) || ! is_array( $ids ) ) { $ids = array( 0 ); }&nbsp;</div></li><li><div>          $args['include'] = $ids;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( MS_Plugin::is_network_wide() ) {&nbsp;</div></li><li><div>          $defaults['blog_id'] = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_query_args', &nbsp;</div></li><li><div>          $args, &nbsp;</div></li><li><div>          $defaults&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the current user ID.</span>&nbsp;</div></li><li><div><span class="comment">   * This function can be called before the init action hook.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Much of this logic is taken from wp-includes/pluggable.php</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_user_id() {&nbsp;</div></li><li><div>      static $User_id = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $User_id ) {&nbsp;</div></li><li><div>          <span class="comment">// We already found the user-id, no need to do it again.</span>&nbsp;</div></li><li><div>          return $User_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'DOING_CRON' ) && DOING_CRON ) {&nbsp;</div></li><li><div>          <span class="comment">// A cron request has no user credentials...</span>&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cookie = wp_parse_auth_cookie();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $cookie ) {&nbsp;</div></li><li><div>          <span class="comment">// Missing, expired or corrupt cookie.</span>&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $scheme = $cookie['scheme'];&nbsp;</div></li><li><div>      $username = $cookie['username'];&nbsp;</div></li><li><div>      $hmac = $cookie['hmac'];&nbsp;</div></li><li><div>      $token = $cookie['token'];&nbsp;</div></li><li><div>      $expiration = $cookie['expiration'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user = get_user_by( 'login', $username );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $user ) {&nbsp;</div></li><li><div>          <span class="comment">// Invalid username.</span>&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pass_frag = substr( $user-&gt;user_pass, 8, 4 );&nbsp;</div></li><li><div>      $key = wp_hash( $username . '|' . $pass_frag . '|' . $expiration . '|' . $token, $scheme );&nbsp;</div></li><li><div>      $algo = function_exists( 'hash' ) ? 'sha256' : 'sha1';&nbsp;</div></li><li><div>      $hash = hash_hmac( $algo, $username . '|' . $expiration . '|' . $token, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! hash_equals( $hash, $hmac ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Forged/expired cookie value.</span>&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remember the user-ID so we don't have to validate everything again.</span>&nbsp;</div></li><li><div>      $User_id = $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $User_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify is user is logged in.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if user is logged in.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_logged_in() {&nbsp;</div></li><li><div>      $logged = is_user_logged_in();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'ms_member_is_logged_in', $logged );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify is user is Admin user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int|false $user_id Optional. The user ID. Default to current user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $deprecated Do not use.</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if user is admin.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_admin_user( $user_id = false ) {&nbsp;</div></li><li><div>      $cache_result = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( self::$_is_admin_user[ $user_id ] ) ) {&nbsp;</div></li><li><div>          $is_admin = false;&nbsp;</div></li><li><div>          $default_user_id = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>              $default_user_id = $user_id;&nbsp;</div></li><li><div>              $user_id = self::get_user_id();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_super_admin( $user_id ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Superadmin always is considered admin user, no discussion...</span>&nbsp;</div></li><li><div>              $is_admin = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Use the capability defined by the main plugin controller.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * This capability defines which user is considered admin user.</span>&nbsp;</div></li><li><div><span class="comment">               * An Admin user has full permissions to edit M2 settings.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * To modify the capability:</span>&nbsp;</div></li><li><div><span class="comment">               *   Use filter `ms_admin_user_capability`  or</span>&nbsp;</div></li><li><div><span class="comment">               *   define( 'MS_ADMIN_CAPABILITY', '...' )</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @var string|bool A WordPress capability or boolean false.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $controller = MS_Plugin::instance()-&gt;controller;&nbsp;</div></li><li><div>              if ( $controller ) {&nbsp;</div></li><li><div>                  $capability = $controller-&gt;capability;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// This is used in case the function is called too early.</span>&nbsp;</div></li><li><div>                  $capability = 'manage_options';&nbsp;</div></li><li><div>                  $cache_result = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $capability ) ) {&nbsp;</div></li><li><div>                  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>                      $is_admin = current_user_can( $capability );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $is_admin = user_can( $user_id, $capability );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $is_admin = apply_filters(&nbsp;</div></li><li><div>                  'ms_model_member_is_admin_user', &nbsp;</div></li><li><div>                  $is_admin, &nbsp;</div></li><li><div>                  $user_id, &nbsp;</div></li><li><div>                  $capability&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $cache_result ) {&nbsp;</div></li><li><div>              self::$_is_admin_user[ $user_id ] = $is_admin;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( null !== $default_user_id ) {&nbsp;</div></li><li><div>                  self::$_is_admin_user[ $default_user_id ] = $is_admin;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $is_admin = self::$_is_admin_user[ $user_id ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is_admin;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify is user is Admin user and simulation mode is deactivated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|false $user_id Optional. The user ID. Default to current user.</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_normal_admin( $user_id = false ) {&nbsp;</div></li><li><div>      if ( ! isset( self::$_is_normal_admin[$user_id] ) ) {&nbsp;</div></li><li><div>          $res = self::is_admin_user( $user_id )&nbsp;</div></li><li><div>              && ! MS_Factory::load( 'MS_Model_Simulate' )-&gt;is_simulating();&nbsp;</div></li><li><div>          self::$_is_normal_admin[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>              self::$_is_normal_admin[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$_is_normal_admin[$user_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify is user is Admin user and simulation mode is active.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|false $user_id Optional. The user ID. Default to current user.</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_simulated_user( $user_id = false ) {&nbsp;</div></li><li><div>      if ( ! isset( self::$_is_simulated_user[$user_id] ) ) {&nbsp;</div></li><li><div>          $res = self::is_admin_user( $user_id )&nbsp;</div></li><li><div>              && MS_Factory::load( 'MS_Model_Simulate' )-&gt;is_simulating();&nbsp;</div></li><li><div>          self::$_is_simulated_user[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>              self::$_is_simulated_user[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$_is_simulated_user[$user_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify is user is not Admin user and simulation mode is deactivated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|false $user_id Optional. The user ID. Default to current user.</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_normal_user( $user_id = false ) {&nbsp;</div></li><li><div>      if ( ! isset( self::$_is_normal_user[$user_id] ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Simlation is only activated when the current user is an Admin.</span>&nbsp;</div></li><li><div>          $res = ! self::is_admin_user( $user_id );&nbsp;</div></li><li><div>          self::$_is_normal_user[$user_id] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>              self::$_is_normal_user[ get_current_user_id() ] = $res;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$_is_normal_user[$user_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get email addresses of all admin users.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string[] The admin emails.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_admin_user_emails() {&nbsp;</div></li><li><div>      $admins = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'role' =&gt; 'administrator', &nbsp;</div></li><li><div>          'fields' =&gt; array( 'ID', 'user_email' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wp_user_search = new WP_User_Query( $args );&nbsp;</div></li><li><div>      $users = $wp_user_search-&gt;get_results();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty ($users ) ) {&nbsp;</div></li><li><div>          foreach ( $users as $user ) {&nbsp;</div></li><li><div>              $admins[ $user-&gt;user_email ] = $user-&gt;user_email;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_admin_user_emails', &nbsp;</div></li><li><div>          $admins&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get username from user_id.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id The user ID to get username.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string The username.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_username( $user_id ) {&nbsp;</div></li><li><div>      $member = MS_Factory::load( 'MS_Model_Member', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_username', &nbsp;</div></li><li><div>          $member-&gt;username, &nbsp;</div></li><li><div>          $user_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Search for orphaned relationships and remove them.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We write a custom SQL query for this, as solving it with a meta-query</span>&nbsp;</div></li><li><div><span class="comment">   * structure is very performance intense and requires at least two queries</span>&nbsp;</div></li><li><div><span class="comment">   * and a loop...</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * For additional performance we will only do this check once every hour.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: We cannot use the hook 'delete_user' to do this, because in</span>&nbsp;</div></li><li><div><span class="comment">   * Multisite users are deleted via the Main network admin; however, there</span>&nbsp;</div></li><li><div><span class="comment">   * we do not have access to the site data; especially if Plugin is not</span>&nbsp;</div></li><li><div><span class="comment">   * network enabled...</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Change this to use WP-Cron instead of own implementation...</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function clean_db() {&nbsp;</div></li><li><div>      $timestamp = absint( MS_Factory::get_transient( 'ms_member_clean_db' ) );&nbsp;</div></li><li><div>      $elapsed = time() - $timestamp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $elapsed &gt; 3600 ) {&nbsp;</div></li><li><div>          <span class="comment">// Last check is longer than 1 hour ago. Check again.</span>&nbsp;</div></li><li><div>          MS_Factory::set_transient( 'ms_member_clean_db', time(), 3600 );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Last check was within past hour. Do nothing yet...</span>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Find all Relationships that have no post-author.</span>&nbsp;</div></li><li><div>      $sql = &quot;&nbsp;</div></li><li><div>      SELECT p.ID&nbsp;</div></li><li><div>      FROM {$wpdb-&gt;posts} p&nbsp;</div></li><li><div>      WHERE p.post_type=%s&nbsp;</div></li><li><div>      AND NOT EXISTS (&nbsp;</div></li><li><div>          SELECT 1&nbsp;</div></li><li><div>          FROM {$wpdb-&gt;users} u&nbsp;</div></li><li><div>          WHERE u.ID = p.post_author&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>          $sql, &nbsp;</div></li><li><div>          MS_Model_Relationship::get_post_type()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete these Relationships!</span>&nbsp;</div></li><li><div>      $items = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>      foreach ( $items as $item ) {&nbsp;</div></li><li><div>          $junk = MS_Factory::load( 'MS_Model_Relationship', $item-&gt;ID );&nbsp;</div></li><li><div>          $junk-&gt;delete();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  //</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  //</span> ------------------------------------------------------------- SINGLE ITEM&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a list of variables that should be included in serialization, </span>&nbsp;</div></li><li><div><span class="comment">   * i.e. these values are the only ones that are stored in DB</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __sleep() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'id', &nbsp;</div></li><li><div>          'username', &nbsp;</div></li><li><div>          'email', &nbsp;</div></li><li><div>          'name', &nbsp;</div></li><li><div>          'first_name', &nbsp;</div></li><li><div>          'last_name', &nbsp;</div></li><li><div>          'subscriptions', &nbsp;</div></li><li><div>          'is_member', &nbsp;</div></li><li><div>          'gateway_profiles', &nbsp;</div></li><li><div>          'custom_data', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Validates the object right after it was loaded/initialized.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We ensure that the custom_data field is an array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function prepare_obj() {&nbsp;</div></li><li><div>      parent::prepare_obj();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_array( $this-&gt;custom_data ) ) {&nbsp;</div></li><li><div>          $this-&gt;custom_data = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Save member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Create a new user is id is empty.</span>&nbsp;</div></li><li><div><span class="comment">   * Save member fields to wp_user and wp_usermeta tables.</span>&nbsp;</div></li><li><div><span class="comment">   * Set cache for further use in MS_Factory::load.</span>&nbsp;</div></li><li><div><span class="comment">   * The usermeta are prefixed with 'ms_'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return MS_Model_Member The saved member object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function save() {&nbsp;</div></li><li><div>      $class = get_class( $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Tell WordPress core that we do NOT want to trigger the</span>&nbsp;</div></li><li><div><span class="comment">       * Password-Reset email while updating the user now.</span>&nbsp;</div></li><li><div><span class="comment">       * New since WordPress 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since  1.0.2.2</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      add_filter( 'send_password_change_email', '__return_false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;id ) ) {&nbsp;</div></li><li><div>          $this-&gt;create_new_user();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;username ) ) {&nbsp;</div></li><li><div>          $wp_user = new stdClass();&nbsp;</div></li><li><div>          $wp_user-&gt;ID = $this-&gt;id;&nbsp;</div></li><li><div>          $wp_user-&gt;nickname = $this-&gt;username;&nbsp;</div></li><li><div>          $wp_user-&gt;user_nicename = $this-&gt;username;&nbsp;</div></li><li><div>          $wp_user-&gt;first_name = $this-&gt;first_name;&nbsp;</div></li><li><div>          $wp_user-&gt;last_name = $this-&gt;last_name;&nbsp;</div></li><li><div>          $wp_user-&gt;user_email = $this-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $this-&gt;password )&nbsp;</div></li><li><div>              && $this-&gt;password == $this-&gt;password2&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>              $wp_user-&gt;user_pass = $this-&gt;password;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_update_user( get_object_vars( $wp_user ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Serialize our plugin meta data</span>&nbsp;</div></li><li><div>      $data = MS_Factory::serialize_model( $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Then update all meta fields that are inside the collection</span>&nbsp;</div></li><li><div>      foreach ( $data as $field =&gt; $val ) {&nbsp;</div></li><li><div>          update_user_meta( $this-&gt;id, 'ms_' . $field, $val );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_cache_set( $this-&gt;id, $this, $class );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove our &quot;mute-password-reset-email&quot; trigger again.</span>&nbsp;</div></li><li><div>      remove_filter( 'send_password_change_email', '__return_false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'ms_model_member_save', $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create new WP user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   * @throws Exception</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function create_new_user() {&nbsp;</div></li><li><div>      <span class="comment">// Check if the WordPress settings allow user registration.</span>&nbsp;</div></li><li><div>      if ( ! MS_Model_Member::can_register() ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'Registration is currently not allowed.', 'membership2' ), 1 );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'You cannot register a new account, because you are already logged in.', 'membership2' ), 1 );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $validation_errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $required = array(&nbsp;</div></li><li><div>          'username' =&gt; __( 'Username', 'membership2' ), &nbsp;</div></li><li><div>          'email' =&gt; __( 'Email address', 'membership2' ), &nbsp;</div></li><li><div>          'password' =&gt; __( 'Password', 'membership2' ), &nbsp;</div></li><li><div>          'password2' =&gt; __( 'Password confirmation', 'membership2' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the required field list to customize the fields that are</span>&nbsp;</div></li><li><div><span class="comment">       * mandatory.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">       * @var   array</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $required = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_create_user_required_fields', &nbsp;</div></li><li><div>          $required&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $required as $field =&gt; $message ) {&nbsp;</div></li><li><div>          if ( empty( $this-&gt;$field ) && empty( $_POST[$field] ) ) {&nbsp;</div></li><li><div>              $validation_errors-&gt;add(&nbsp;</div></li><li><div>                  $field, &nbsp;</div></li><li><div>                  sprintf(&nbsp;</div></li><li><div>                      __( 'Please ensure that the &lt;span class=&quot;ms-bold&quot;&gt;%s&lt;/span&gt; information is completed.', 'membership2' ), &nbsp;</div></li><li><div>                      $message&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;password != $this-&gt;password2 ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'passmatch', &nbsp;</div></li><li><div>              __( 'Please ensure the passwords match.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! validate_username( $this-&gt;username ) ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'usernamenotvalid', &nbsp;</div></li><li><div>              __( 'The username is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( username_exists( $this-&gt;username ) ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'usernameexists', &nbsp;</div></li><li><div>              __( 'That username is already taken, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_email( $this-&gt;email ) ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'emailnotvalid', &nbsp;</div></li><li><div>              __( 'The email address is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( email_exists( $this-&gt;email ) ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'emailexists', &nbsp;</div></li><li><div>              __( 'That email address is already taken, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check the multisite Email-Domain limitation for new registrations.</span>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>          $limited_domains = get_site_option( 'limited_email_domains' );&nbsp;</div></li><li><div>          $banned_domains = get_site_option( 'banned_email_domains' );&nbsp;</div></li><li><div>          $email_domain = substr( strrchr( $this-&gt;email, '@' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $illegal_names && is_array( $illegal_names ) ) {&nbsp;</div></li><li><div>              if ( in_array( $this-&gt;username, $illegal_names ) ) {&nbsp;</div></li><li><div>                  $validation_errors-&gt;add(&nbsp;</div></li><li><div>                      'illegalname', &nbsp;</div></li><li><div>                      __( 'The username is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $limited_domains && is_array( $limited_domains ) ) {&nbsp;</div></li><li><div>              if ( ! in_array( $email_domain, $limited_domains ) ) {&nbsp;</div></li><li><div>                  $validation_errors-&gt;add(&nbsp;</div></li><li><div>                      'emaildomain', &nbsp;</div></li><li><div>                      __( 'That email domain is not allowed for registration, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $banned_domains && is_array( $banned_domains ) ) {&nbsp;</div></li><li><div>              if ( in_array( $email_domain, $banned_domains ) ) {&nbsp;</div></li><li><div>                  $validation_errors-&gt;add(&nbsp;</div></li><li><div>                      'emaildomain', &nbsp;</div></li><li><div>                      __( 'That email domain is not allowed for registration, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $validation_errors = apply_filters(&nbsp;</div></li><li><div>          'ms_model_membership_create_new_user_validation_errors', &nbsp;</div></li><li><div>          $validation_errors, &nbsp;</div></li><li><div>                      $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Compatibility with WangGuard</span>&nbsp;</div></li><li><div>      $_POST['user_email'] = $this-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_data = array(&nbsp;</div></li><li><div>          'user_name' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>          'orig_username' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>          'user_email' =&gt; $this-&gt;email, &nbsp;</div></li><li><div>          'errors' =&gt; $validation_errors, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_data = apply_filters(&nbsp;</div></li><li><div>          'wpmu_validate_user_signup', &nbsp;</div></li><li><div>          $user_data&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $user_data ) ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Some plugins incorrectly return a WP_Error object as result of</span>&nbsp;</div></li><li><div><span class="comment">           * the wpmu_validate_user_signup filter.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $validation_errors = $user_data;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $validation_errors = $user_data['errors'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $errors = $validation_errors-&gt;get_error_messages();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $errors ) ) {&nbsp;</div></li><li><div>          throw new Exception( implode( '&lt;br/&gt;', $errors ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( ! $this-&gt;password ) {&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * For some reason the user did not provide a password in the</span>&nbsp;</div></li><li><div><span class="comment">               * registration form. We help out here by creating a password</span>&nbsp;</div></li><li><div><span class="comment">               * for the little bugger and send him a password-reset email.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * So: Generate a STRONG password for the new user.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * Important: This password should be sent to the user via the</span>&nbsp;</div></li><li><div><span class="comment">               * Email template &quot;User Account Created&quot;</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $this-&gt;password = wp_generate_password( 24 );&nbsp;</div></li><li><div>              $this-&gt;password2 = $this-&gt;password;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>          $user_id = wp_create_user(&nbsp;</div></li><li><div>              $this-&gt;username, &nbsp;</div></li><li><div>              $this-&gt;password, &nbsp;</div></li><li><div>              $this-&gt;email&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>              $validation_errors-&gt;add(&nbsp;</div></li><li><div>                  'userid', &nbsp;</div></li><li><div>                  $user_id-&gt;get_error_message()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              throw new Exception(&nbsp;</div></li><li><div>                  implode(&nbsp;</div></li><li><div>                      '&lt;br/&gt;', &nbsp;</div></li><li><div>                      $validation_errors-&gt;get_error_messages()&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>                      else&nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                          if( isset( $_POST['display_name'] ) && $_POST['display_name'] != '' )&nbsp;</div></li><li><div>                          {&nbsp;</div></li><li><div>                              wp_update_user( array( 'ID' =&gt; $user_id, 'display_name' =&gt; $_POST['display_name'] ) );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;id = $user_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'ms_model_member_create_new_user', $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Marks the current user as &quot;confirmed&quot;</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function confirm() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $auto_confirm = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_auto_confirm', &nbsp;</div></li><li><div>          true, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $auto_confirm ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = &quot;UPDATE $wpdb-&gt;users SET user_status = 0 WHERE ID = %d&quot;;&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( $sql, $this-&gt;id );&nbsp;</div></li><li><div>      $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sign on user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signon_user() {&nbsp;</div></li><li><div>      $user = new WP_User( $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! headers_sent() ) {&nbsp;</div></li><li><div>          $user = @wp_signon(&nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'user_login' =&gt; $this-&gt;username, &nbsp;</div></li><li><div>                  'user_password' =&gt; $this-&gt;password, &nbsp;</div></li><li><div>                  'remember' =&gt; true, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Stop here in case the login failed.</span>&nbsp;</div></li><li><div>          if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>              return $user;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Also used in class-ms-controller-dialog.php (Ajax login)</span>&nbsp;</div></li><li><div>      wp_set_current_user( $this-&gt;id );&nbsp;</div></li><li><div>      wp_set_auth_cookie( $this-&gt;id );&nbsp;</div></li><li><div>      do_action( 'wp_login', $this-&gt;username, $user );&nbsp;</div></li><li><div>      do_action( 'ms_model_member_signon_user', $user, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Either creates or updates the value of a custom data field.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: Remember to prefix the $key with a unique string to prevent</span>&nbsp;</div></li><li><div><span class="comment">   * conflicts with other plugins that also use this function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $key The field-key.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  mixed $value The new value to assign to the field.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_custom_data( $key, $value ) {&nbsp;</div></li><li><div>      $this-&gt;custom_data[ $key ] = $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes a custom data field from this object.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $key The field-key.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function delete_custom_data( $key ) {&nbsp;</div></li><li><div>      unset( $this-&gt;custom_data[ $key ] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the value of a custom data field.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $key The field-key.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed The value that was previously assigned to the custom field</span>&nbsp;</div></li><li><div><span class="comment">   *         or false if no value was set for the field.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_custom_data( $key ) {&nbsp;</div></li><li><div>      $res = false;&nbsp;</div></li><li><div>      if ( isset( $this-&gt;custom_data[ $key ] ) ) {&nbsp;</div></li><li><div>          $res = $this-&gt;custom_data[ $key ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a list of all membership IDs of the current user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_membership_ids() {&nbsp;</div></li><li><div>      $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>          $result[] = $subscription-&gt;membership_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a new membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If multiple membership is disabled, may move existing membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Only add a membership if a user is not already a member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $membership_id The membership id to add to.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $gateway_id Optional. The gateway used to add the membership.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|string $move_from_id Optional. The membership id(s) to cancel.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return object|null $subscription</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_membership( $membership_id, $gateway_id = 'admin', $move_from_id = 0 ) {&nbsp;</div></li><li><div>      $subscription = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( MS_Model_Membership::is_valid_membership( $membership_id ) ) {&nbsp;</div></li><li><div>          if ( ! $this-&gt;get_subscription( $membership_id ) ) {&nbsp;</div></li><li><div>              $subscription = MS_Model_Relationship::create_ms_relationship(&nbsp;</div></li><li><div>                  $membership_id, &nbsp;</div></li><li><div>                  $this-&gt;id, &nbsp;</div></li><li><div>                  $gateway_id, &nbsp;</div></li><li><div>                  $move_from_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'admin' != $gateway_id ) {&nbsp;</div></li><li><div>                  $subscription-&gt;get_current_invoice();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( MS_Model_Relationship::STATUS_PENDING !== $subscription-&gt;status ) {&nbsp;</div></li><li><div>                  $this-&gt;subscriptions[] = $subscription;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  usort(&nbsp;</div></li><li><div>                      $this-&gt;subscriptions, &nbsp;</div></li><li><div>                      array( 'MS_Model_Relationship', 'sort_by_priority' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Reset the status and start/expire dates when added by admin.</span>&nbsp;</div></li><li><div>          if ( 'admin' == $gateway_id ) {&nbsp;</div></li><li><div>              $subscription-&gt;start_date = null; <span class="comment">// Will calculate correct date.</span>&nbsp;</div></li><li><div>              $subscription-&gt;trial_expire_date = null;&nbsp;</div></li><li><div>              $subscription-&gt;expire_date = null;&nbsp;</div></li><li><div>              $subscription-&gt;status = MS_Model_Relationship::STATUS_ACTIVE;&nbsp;</div></li><li><div>              $subscription-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;is_member = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_add_membership', &nbsp;</div></li><li><div>          $subscription, &nbsp;</div></li><li><div>          $membership_id, &nbsp;</div></li><li><div>          $gateway_id, &nbsp;</div></li><li><div>          $move_from_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Drop a membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Only update the status to deactivated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $membership_id The membership id to drop.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function drop_membership( $membership_id ) {&nbsp;</div></li><li><div>      $subscription = $this-&gt;get_subscription( $membership_id, $key );&nbsp;</div></li><li><div>      if ( $subscription ) {&nbsp;</div></li><li><div>          do_action(&nbsp;</div></li><li><div>              'ms_model_membership_drop_membership', &nbsp;</div></li><li><div>              $subscription, &nbsp;</div></li><li><div>              $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subscription-&gt;deactivate_membership();&nbsp;</div></li><li><div>          unset( $this-&gt;subscriptions[$key] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_member = false;&nbsp;</div></li><li><div>      foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>          if ( ! $subscription-&gt;is_system() ) {&nbsp;</div></li><li><div>              $is_member = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;is_member = $is_member;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action(&nbsp;</div></li><li><div>          'ms_model_membership_drop_membership', &nbsp;</div></li><li><div>          $membership_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cancel a membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The membership remains valid until expiration date.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $membership_id The membership id to drop.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cancel_membership( $membership_id ) {&nbsp;</div></li><li><div>      $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>      if ( $subscription ) {&nbsp;</div></li><li><div>          $subscription-&gt;cancel_membership();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// The membership might be on status &quot;PENDING&quot; which is not included</span>&nbsp;</div></li><li><div>          <span class="comment">// in $this-&gt;subscriptions.</span>&nbsp;</div></li><li><div>          $subscription = MS_Model_Relationship::get_subscription(&nbsp;</div></li><li><div>              $this-&gt;id, &nbsp;</div></li><li><div>              $membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $subscription-&gt;user_id == $this-&gt;id ) {&nbsp;</div></li><li><div>              $subscription-&gt;cancel_membership();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action(&nbsp;</div></li><li><div>          'ms_model_membership_cancel_membership', &nbsp;</div></li><li><div>          $membership_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Move a membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $old_membership_id The membership id to move from.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $mew_membership_id The membership id to move to.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function move_membership( $old_membership_id, $mew_membership_id ) {&nbsp;</div></li><li><div>      $old_subscription = $this-&gt;get_subscription( $old_membership_id );&nbsp;</div></li><li><div>      if ( $old_subscription ) {&nbsp;</div></li><li><div>          $new_subscription = MS_Model_Relationship::create_ms_relationship(&nbsp;</div></li><li><div>              $mew_membership_id, &nbsp;</div></li><li><div>              $this-&gt;id, &nbsp;</div></li><li><div>              $old_subscription-&gt;gateway_id, &nbsp;</div></li><li><div>              $old_membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;cancel_membership( $old_membership_id );&nbsp;</div></li><li><div>          $this-&gt;subscriptions[] = $new_subscription;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          MS_Model_Event::save_event(&nbsp;</div></li><li><div>              MS_Model_Event::TYPE_MS_MOVED, &nbsp;</div></li><li><div>              $new_subscription&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action(&nbsp;</div></li><li><div>          'ms_model_membership_move_membership', &nbsp;</div></li><li><div>          $old_membership_id, &nbsp;</div></li><li><div>          $mew_membership_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check membership relationship status.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Canceled status is allowed until it expires.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $membership_id Optional. The specific membership to verify.</span>&nbsp;</div></li><li><div><span class="comment">   *        If empty, verify against all memberships.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if has a valid membership.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_membership( $membership_id = 0 ) {&nbsp;</div></li><li><div>      $has_membership = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Allowed membership status to have access</span>&nbsp;</div></li><li><div>      $allowed_status = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_allowed_status', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              MS_Model_Relationship::STATUS_ACTIVE, &nbsp;</div></li><li><div>              MS_Model_Relationship::STATUS_TRIAL, &nbsp;</div></li><li><div>              MS_Model_Relationship::STATUS_CANCELED, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( self::is_normal_admin( $this-&gt;id ) ) {&nbsp;</div></li><li><div>          $has_membership = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $membership_id ) ) {&nbsp;</div></li><li><div>          $subscription = $this-&gt;get_subscription( $membership_id );&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Membership-ID specified: Check if user has this membership</span></span>&nbsp;</div></li><li><div>          if ( $subscription&nbsp;</div></li><li><div>              && in_array( $subscription-&gt;get_status(), $allowed_status )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>              $has_membership = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( ! empty ( $this-&gt;subscriptions ) ) {&nbsp;</div></li><li><div>          <span class="comment">// No membership-ID: Check if user has *any* membership</span>&nbsp;</div></li><li><div>          foreach ( $this-&gt;subscriptions as $subscription ) {&nbsp;</div></li><li><div>              if ( $subscription-&gt;is_system() ) { continue; }&nbsp;</div></li><li><div>              if ( in_array( $subscription-&gt;get_status(), $allowed_status ) ) {&nbsp;</div></li><li><div>                  $has_membership = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_has_membership', &nbsp;</div></li><li><div>          $has_membership, &nbsp;</div></li><li><div>          $membership_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the subscription object for the specified membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int|string $membership_id The specific membership to return.</span>&nbsp;</div></li><li><div><span class="comment">   *         Value 'priority' will return the subcription with lowest priority.</span>&nbsp;</div></li><li><div><span class="comment">   * @return MS_Model_Relationship The subscription object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_subscription( $membership_id, &$key = -1 ) {&nbsp;</div></li><li><div>      $subscription = null;&nbsp;</div></li><li><div>      $key = -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'priority' == $membership_id ) {&nbsp;</div></li><li><div>          <span class="comment">// Find subscription with the lowest priority.</span>&nbsp;</div></li><li><div>          $cur_priority = -1;&nbsp;</div></li><li><div>          foreach ( $this-&gt;subscriptions as $ind =&gt; $item ) {&nbsp;</div></li><li><div>              $membership = $item-&gt;get_membership();&nbsp;</div></li><li><div>              if ( ! $membership-&gt;active ) { continue; }&nbsp;</div></li><li><div>              if ( $cur_priority &lt; 0 || $membership-&gt;priority &lt; $cur_priority ) {&nbsp;</div></li><li><div>                  $subscription = $item;&nbsp;</div></li><li><div>                  $cur_priority = $membership-&gt;priority;&nbsp;</div></li><li><div>                  $key = $ind;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( ! empty( $membership_id ) ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Membership-ID specified: Check if user has this membership</span></span>&nbsp;</div></li><li><div>          foreach ( $this-&gt;subscriptions as $ind =&gt; $item ) {&nbsp;</div></li><li><div>              if ( $item-&gt;membership_id == $membership_id ) {&nbsp;</div></li><li><div>                  $subscription = $item;&nbsp;</div></li><li><div>                  $key = $ind;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_get_subscription', &nbsp;</div></li><li><div>          $subscription, &nbsp;</div></li><li><div>          $membership_id, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a list of memberships for all active subscriptions of the member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function get_active_memberships() {&nbsp;</div></li><li><div>      $active_memberships = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $active_status = array(&nbsp;</div></li><li><div>          MS_Model_Relationship::STATUS_ACTIVE, &nbsp;</div></li><li><div>          MS_Model_Relationship::STATUS_TRIAL, &nbsp;</div></li><li><div>          MS_Model_Relationship::STATUS_CANCELED, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;subscriptions as $sub ) {&nbsp;</div></li><li><div>          if ( $sub-&gt;is_base() ) { continue; }&nbsp;</div></li><li><div>          if ( ! in_array( $sub-&gt;status, $active_status ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $membership = $sub-&gt;get_membership();&nbsp;</div></li><li><div>          $active_memberships[$membership-&gt;id] = $membership;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $active_memberships;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if the current user is allowed to subscribe to the specified</span>&nbsp;</div></li><li><div><span class="comment">   * membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $membership_id A membership_id.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool Whether subscription is allowed or not.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function can_subscribe_to( $membership_id ) {&nbsp;</div></li><li><div>      static $Access_Flags = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( null === $Access_Flags ) {&nbsp;</div></li><li><div>          $Access_Flags = array();&nbsp;</div></li><li><div>          $active_memberships = $this-&gt;get_active_memberships();&nbsp;</div></li><li><div>          $all_memberships = MS_Model_Membership::get_memberships();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Controls how to handle conflicts in upgrade path settings when a</span>&nbsp;</div></li><li><div><span class="comment">           * member has multiple memberships.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Default is true:</span>&nbsp;</div></li><li><div><span class="comment">           *     If one membership forbids the upgrade, then that's it.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Custom set to false:</span>&nbsp;</div></li><li><div><span class="comment">           *     If one membership allows the upgrade, then allow it.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">           * @var   bool</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $prefer_forbidden = apply_filters(&nbsp;</div></li><li><div>              'ms_model_member_can_subscribe_to_prefer_forbidden', &nbsp;</div></li><li><div>              true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $active_memberships as $membership ) {&nbsp;</div></li><li><div>              $base_id = $membership-&gt;id;&nbsp;</div></li><li><div>              if ( $membership-&gt;is_guest() || $membership-&gt;is_user() ) {&nbsp;</div></li><li><div>                  $base_id = 'guest';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $all_memberships as $ms ) {&nbsp;</div></li><li><div>                  if ( isset( $active_memberships[$ms-&gt;id] ) ) { continue; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $is_allowed = $ms-&gt;update_allowed( $base_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! isset( $Access_Flags[$ms-&gt;id] ) ) {&nbsp;</div></li><li><div>                      $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ( $prefer_forbidden && ! $is_allowed ) {&nbsp;</div></li><li><div>                          $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                      } elseif ( ! $prefer_forbidden && $is_allowed ) {&nbsp;</div></li><li><div>                          $Access_Flags[$ms-&gt;id] = $is_allowed;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result = true;&nbsp;</div></li><li><div>      if ( isset( $Access_Flags[$membership_id] ) ) {&nbsp;</div></li><li><div>          $result = $Access_Flags[$membership_id];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_can_subscribe_to', &nbsp;</div></li><li><div>          $result, &nbsp;</div></li><li><div>          $membership_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an array of existing subscriptions that should be cancelled when</span>&nbsp;</div></li><li><div><span class="comment">   * the user signs up to the specified membership.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $membership_id A membership ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Might be an empty array or a list of membership IDs.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cancel_ids_on_subscription( $membership_id ) {&nbsp;</div></li><li><div>      $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $membership = MS_Factory::load( 'MS_Model_Membership', $membership_id );&nbsp;</div></li><li><div>      $active_memberships = $this-&gt;get_active_memberships();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $active_memberships as $ms ) {&nbsp;</div></li><li><div>          if ( $membership-&gt;update_replaces( $ms-&gt;id ) ) {&nbsp;</div></li><li><div>              $result[] = $ms-&gt;id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete member usermeta.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Delete all plugin related usermeta.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function delete_all_membership_usermeta() {&nbsp;</div></li><li><div>      $this-&gt;subscriptions = array();&nbsp;</div></li><li><div>      $this-&gt;gateway_profiles = array();&nbsp;</div></li><li><div>      $this-&gt;is_member = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action(&nbsp;</div></li><li><div>          'ms_model_membership_delete_all_membership_usermeta', &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the WP_User object that is linked to the current member</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return WP_User</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_user() {&nbsp;</div></li><li><div>      return $this-&gt;wp_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a value from the user-meta table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $key The meta-key.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed The meta-value.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_meta( $key ) {&nbsp;</div></li><li><div>      return get_user_meta( $this-&gt;id, $key, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Updates a value in the user-meta table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key The meta-key.</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $value The new meta-value.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_meta( $key, $value ) {&nbsp;</div></li><li><div>      update_user_meta( $this-&gt;id, $key, $value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify if current object is valid.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if is valid.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_valid() {&nbsp;</div></li><li><div>      $valid = ( $this-&gt;id &gt; 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'ms_model_member_is_valid', $valid, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get gateway profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $gateway The gateway ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $field Optional. The field to retrive. Default to null, </span>&nbsp;</div></li><li><div><span class="comment">   *     returning all profile info.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed The gateway profile info.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_gateway_profile( $gateway, $field = null ) {&nbsp;</div></li><li><div>      $profile = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $this-&gt;gateway_profiles[ $gateway ] ) ) {&nbsp;</div></li><li><div>          $this-&gt;gateway_profiles[ $gateway ] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $field ) ) {&nbsp;</div></li><li><div>          $profile = $this-&gt;gateway_profiles[ $gateway ];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;gateway_profiles[ $gateway ][ $field ] ) ) {&nbsp;</div></li><li><div>              $this-&gt;gateway_profiles[ $gateway ][ $field ] = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $profile = $this-&gt;gateway_profiles[ $gateway ][ $field ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'ms_model_member_get_gateway_profile', $profile );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set gateway profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $gateway The gateway ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $field The field name to save.</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $value The field value to save.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_gateway_profile( $gateway, $field, $value ) {&nbsp;</div></li><li><div>      $this-&gt;gateway_profiles[ $gateway ][ $field ] = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action(&nbsp;</div></li><li><div>          'ms_model_member_set_gateway_profile', &nbsp;</div></li><li><div>          $gateway, &nbsp;</div></li><li><div>          $field, &nbsp;</div></li><li><div>          $value, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Validate member info.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if validated.</span>&nbsp;</div></li><li><div><span class="comment">   * @throws Exception if not validated.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function validate_member_info() {&nbsp;</div></li><li><div>      $validation_errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_email( $this-&gt;email ) ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'emailnotvalid', &nbsp;</div></li><li><div>              __( 'The email address is not valid, sorry.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;password != $this-&gt;password2 ) {&nbsp;</div></li><li><div>          $validation_errors-&gt;add(&nbsp;</div></li><li><div>              'passmatch', &nbsp;</div></li><li><div>              __( 'Please ensure the passwords match.', 'membership2' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $validation_errors = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_validate_member_info_errors_obj', &nbsp;</div></li><li><div>          $validation_errors, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $errors = apply_filters(&nbsp;</div></li><li><div>          'ms_model_member_validate_member_info_errors', &nbsp;</div></li><li><div>          $validation_errors-&gt;get_error_messages(), &nbsp;</div></li><li><div>          $validation_errors, &nbsp;</div></li><li><div>          $this&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $errors ) ) {&nbsp;</div></li><li><div>          throw new Exception( implode( '&lt;br/&gt;', $errors ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates a new password-reset key and stores it in the DB.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.2.3</span>&nbsp;</div></li><li><div><span class="comment">   * @return object {</span>&nbsp;</div></li><li><div><span class="comment">   *         The reset-key that can be sent to the user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *         @var  key   The reset key</span>&nbsp;</div></li><li><div><span class="comment">   *         @var  url   The full reset URL</span>&nbsp;</div></li><li><div><span class="comment">   *  }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function new_password_reset_key() {&nbsp;</div></li><li><div>      global $wpdb, $wp_hasher;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Generate something random for a password reset key.</span>&nbsp;</div></li><li><div>      $key = wp_generate_password( 20, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'retrieve_password_key', $this-&gt;username, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now insert a hashed version of the key into the DB.</span>&nbsp;</div></li><li><div>      <span class="comment">// Important: The has needs to include the time() value!</span>&nbsp;</div></li><li><div>      if ( empty( $wp_hasher ) ) {&nbsp;</div></li><li><div>          require_once ABSPATH . WPINC . '/class-phpass.php';&nbsp;</div></li><li><div>          $wp_hasher = new PasswordHash( 8, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $hashed = time() . ':' . $wp_hasher-&gt;HashPassword( $key );&nbsp;</div></li><li><div>      $wpdb-&gt;update(&nbsp;</div></li><li><div>          $wpdb-&gt;users, &nbsp;</div></li><li><div>          array( 'user_activation_key' =&gt; $hashed ), &nbsp;</div></li><li><div>          array( 'user_login' =&gt; $this-&gt;username )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      MS_Model_Pages::create_missing_pages();&nbsp;</div></li><li><div>      $reset_url = MS_Model_Pages::get_page_url( MS_Model_Pages::MS_PAGE_ACCOUNT );&nbsp;</div></li><li><div>      $reset_url = esc_url_raw(&nbsp;</div></li><li><div>          add_query_arg(&nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'action' =&gt; MS_Controller_Frontend::ACTION_VIEW_RESETPASS, &nbsp;</div></li><li><div>                  'key' =&gt; $key, &nbsp;</div></li><li><div>                  'login' =&gt; rawurlencode( $this-&gt;username ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              $reset_url&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) array(&nbsp;</div></li><li><div>          'key' =&gt; $key, &nbsp;</div></li><li><div>          'url' =&gt; $reset_url, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get specific property.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name The name of a property to associate.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed The value of a property.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __get( $property ) {&nbsp;</div></li><li><div>      $value = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( property_exists( $this, $property ) ) {&nbsp;</div></li><li><div>          $value = $this-&gt;$property;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          switch ( $property ) {&nbsp;</div></li><li><div>              case 'full_name':&nbsp;</div></li><li><div>                  if ( ! empty( $this-&gt;first_name ) || ! empty( $this-&gt;last_name ) ) {&nbsp;</div></li><li><div>                      $value = trim( $this-&gt;first_name . ' ' . $this-&gt;last_name );&nbsp;</div></li><li><div>                  } elseif ( ! empty( $this-&gt;name ) ) {&nbsp;</div></li><li><div>                      $value = trim( $this-&gt;name );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $value = trim( $this-&gt;username );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                                  &nbsp;</div></li><li><div>                              case 'display_name':&nbsp;</div></li><li><div>                                      $user = get_userdata( $this-&gt;id );&nbsp;</div></li><li><div>                                      $value = $user-&gt;display_name;&nbsp;</div></li><li><div>                                      break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set specific property.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name The name of a property to associate.</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $value The value of a property.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __set( $property, $value ) {&nbsp;</div></li><li><div>      if ( property_exists( $this, $property ) ) {&nbsp;</div></li><li><div>          switch ( $property ) {&nbsp;</div></li><li><div>              case 'email':&nbsp;</div></li><li><div>                  if ( is_email( $value ) ) {&nbsp;</div></li><li><div>                      $this-&gt;$property = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'username':&nbsp;</div></li><li><div>                  $this-&gt;$property = sanitize_user( $value );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'name':&nbsp;</div></li><li><div>              case 'first_name':&nbsp;</div></li><li><div>              case 'last_name':&nbsp;</div></li><li><div>                  $this-&gt;$property = sanitize_text_field( $value );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $this-&gt;$property = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>                  if( $property == 'display_name' )&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      wp_update_user( array( 'ID' =&gt; $this-&gt;id, 'display_name' =&gt; $value ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if property isset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @internal</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $property The name of a property.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed Returns true/false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __isset( $property ) {&nbsp;</div></li><li><div>      return isset($this-&gt;$property);&nbsp;</div></li><li><div>  }        &nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Membership 2</li><li><span></span>4.0.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>