<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.87" data-slug="disqus-comment-system" data-type="file" data-id="47916"><head xmlns="http://www.w3.org/1999/xhtml"><title> disqus | file | Disqus Comment System | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, disqus-comment-system, 2.87" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.14"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d8ba03f5893a116dfb29903b97d7b8be' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.14' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/disqus/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fdisqus%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fdisqus%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-disqus-comment-system-2.87-file-disqus","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="disqus" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to disqus-comment-system." href="http://hookr.io/plugins/disqus-comment-system/" class="plugin"><span property="name">disqus-comment-system</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.87." href="http://hookr.io/plugins/disqus-comment-system/2.87/" class="H_VERSION"><span property="name">2.87</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/disqus-comment-system/2.87/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">disqus</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="130"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/all/" title="All">All <span class="count badge">130</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="7"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/hooks/" title="Hooks">Hooks <span class="count badge">7</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="7"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/filters/" title="Filters">Filters <span class="count badge">7</span></a></li><li class="" data-id="class" data-count="4"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/classes/" title="Classes">Classes <span class="count badge">4</span></a></li><li class="" data-id="constant" data-count="39"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/constants/" title="Constants">Constants <span class="count badge">39</span></a></li><li class="" data-id="function" data-count="80"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/functions/" title="Functions">Functions <span class="count badge">80</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/disqus-comment-system/2.87/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/disqus.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name: Disqus Comment System</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI: https://disqus.com/</span>&nbsp;</div></li><li><div><span class="comment">Description: The Disqus comment system replaces your WordPress comment system with your comments hosted and powered by Disqus. Head over to the Comments admin page to set up your Disqus Comment System.</span>&nbsp;</div></li><li><div><span class="comment">Author: Disqus &lt;team@disqus.com&gt;</span>&nbsp;</div></li><li><div><span class="comment">Version: 2.87</span>&nbsp;</div></li><li><div><span class="comment">Author URI: https://disqus.com/</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>require_once(dirname(__FILE__) . '/lib/wp-api.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>define('DISQUS_DOMAIN', 'disqus.com');&nbsp;</div></li><li><div>define('DISQUS_IMPORTER_URL', 'https:<span class="comment">//import.disqus.com/');</span>&nbsp;</div></li><li><div>define('DISQUS_API_URL', 'https:<span class="comment">//disqus.com/api/');</span>&nbsp;</div></li><li><div>define('DISQUS_RSS_PATH', '/latest.rss');&nbsp;</div></li><li><div>define('DISQUS_CAN_EXPORT', is_file(dirname(__FILE__) . '/export.php'));&nbsp;</div></li><li><div>if (!defined('DISQUS_DEBUG')) {&nbsp;</div></li><li><div>  define('DISQUS_DEBUG', false);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>define('DISQUS_VERSION', '2.87');&nbsp;</div></li><li><div>define('DISQUS_SYNC_TIMEOUT', 30);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns an array of all option identifiers used by Disqus.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array[int]string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_options() {&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      '_disqus_sync_lock', &nbsp;</div></li><li><div>      '_disqus_sync_post_ids', &nbsp;</div></li><li><div>      # render disqus in the embed&nbsp;</div></li><li><div>      'disqus_active', &nbsp;</div></li><li><div>      'disqus_forum_url', &nbsp;</div></li><li><div>      'disqus_api_key', &nbsp;</div></li><li><div>      'disqus_user_api_key', &nbsp;</div></li><li><div>      'disqus_replace', &nbsp;</div></li><li><div>      'disqus_cc_fix', &nbsp;</div></li><li><div>      'dsq_external_js', &nbsp;</div></li><li><div>      # SSO features&nbsp;</div></li><li><div>      'disqus_partner_key', &nbsp;</div></li><li><div>      'disqus_public_key', &nbsp;</div></li><li><div>      'disqus_secret_key', &nbsp;</div></li><li><div>      'disqus_sso_button', &nbsp;</div></li><li><div>      # disables automatic sync via cron&nbsp;</div></li><li><div>      'disqus_manual_sync', &nbsp;</div></li><li><div>      # disables server side rendering&nbsp;</div></li><li><div>      'disqus_disable_ssr', &nbsp;</div></li><li><div>      # the last sync comment id (from get_forum_posts)&nbsp;</div></li><li><div>      'disqus_last_comment_id', &nbsp;</div></li><li><div>      'disqus_version', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_plugin_basename($file) {&nbsp;</div></li><li><div>  $file = dirname($file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// From WP2.5 wp-includes/plugin.php:plugin_basename()</span>&nbsp;</div></li><li><div>  $file = str_replace('\\', '/', $file); <span class="comment">// sanitize for Win32 installs</span>&nbsp;</div></li><li><div>  $file = preg_replace('|/+|', '/', $file); <span class="comment">// remove any duplicate slash</span>&nbsp;</div></li><li><div>  $file = preg_replace('|^.*/' . PLUGINDIR . '/|', '', $file); <span class="comment">// get relative path from plugins dir</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strstr($file, '/') === false ) {&nbsp;</div></li><li><div>      return $file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pieces = explode('/', $file);&nbsp;</div></li><li><div>  return !empty($pieces[count($pieces)-1]) ? $pieces[count($pieces)-1] : $pieces[count($pieces)-2];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !defined('PLUGINDIR') ) {&nbsp;</div></li><li><div>  define('PLUGINDIR', 'wp-content/plugins'); <span class="comment">// Relative to ABSPATH.  For back compat.</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$mt_disqus_version = '2.01';&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Response from Disqus get_thread API call for comments template.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global    string    $dsq_response</span>&nbsp;</div></li><li><div><span class="comment"> * @since    1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$dsq_response = '';&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Disqus API instance.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global    string    $dsq_api</span>&nbsp;</div></li><li><div><span class="comment"> * @since    1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$dsq_api = new DisqusWordPressAPI(get_option('disqus_forum_url'), get_option('disqus_api_key'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Disqus currently unsupported dev toggle to output comments for this query.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global    bool    $DSQ_QUERY_COMMENTS</span>&nbsp;</div></li><li><div><span class="comment"> * @since    ?</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$DSQ_QUERY_COMMENTS = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Disqus array to store post_ids from WP_Query for comment JS output.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global    array    $DSQ_QUERY_POST_IDS</span>&nbsp;</div></li><li><div><span class="comment"> * @since    2.2</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$DSQ_QUERY_POST_IDS = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Admin scripts</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('wp_dashboard_setup', 'dsq_wp_dashboard_setup');&nbsp;</div></li><li><div>add_action( 'admin_enqueue_scripts', 'load_admin_scripts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function load_admin_scripts($hook) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only show the pointer when Disqus isn't already configured</span>&nbsp;</div></li><li><div>  if ( dsq_is_installed() === false ) {&nbsp;</div></li><li><div>      add_action( 'admin_print_footer_scripts', 'load_pointer_script_style' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only load these scripts on the Disqus admin page</span>&nbsp;</div></li><li><div>  if ( 'comments_page_disqus' != $hook ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admin_vars = array(&nbsp;</div></li><li><div>      'indexUrl' =&gt; admin_url('index.php'), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_register_script( 'admin_script', plugins_url( '/media/js/admin.js', __FILE__ ) );&nbsp;</div></li><li><div>  wp_localize_script( 'admin_script', 'adminVars', $admin_vars );&nbsp;</div></li><li><div>  wp_enqueue_script( 'admin_script', plugins_url( '/media/js/admin.js', __FILE__ ), array( 'jQuery') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_register_script( 'upload_script', plugins_url( '/media/js/upload.js', __FILE__) );&nbsp;</div></li><li><div>  wp_enqueue_script( 'upload_script', plugins_url( '/media/js/upload.js', __FILE__), array( 'jQuery') );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_wp_dashboard_setup() {&nbsp;</div></li><li><div>  add_action('admin_enqueue_scripts', 'load_dashboard_scripts');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function load_dashboard_scripts() {&nbsp;</div></li><li><div>  $stats = get_dash_comment_counts();&nbsp;</div></li><li><div>  $dashboard_vars = array(&nbsp;</div></li><li><div>      'stats' =&gt; array(&nbsp;</div></li><li><div>          'totalComments' =&gt; number_format($stats-&gt;total_comments), &nbsp;</div></li><li><div>          'approved' =&gt; number_format($stats-&gt;approved), &nbsp;</div></li><li><div>          'moderated' =&gt; number_format($stats-&gt;moderated), &nbsp;</div></li><li><div>          'spam' =&gt; number_format($stats-&gt;spam), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_register_script( 'dashboard_script', plugins_url( '/media/js/dashboard.js', __FILE__ ) );&nbsp;</div></li><li><div>  wp_localize_script( 'dashboard_script', 'dashboardVars', $dashboard_vars );&nbsp;</div></li><li><div>  wp_enqueue_script( 'dashboard_script', plugins_url( '/media/js/dashboard.js', __FILE__ ), array( 'jQuery') );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds a simple WordPress pointer to Comments menu, to remind the user to configure the plugin</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function load_pointer_script_style() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume pointer shouldn't be shown</span>&nbsp;</div></li><li><div>  $enqueue_pointer_script_style = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get array list of dismissed pointers for current user and convert it to array</span>&nbsp;</div></li><li><div>  $dismissed_pointers = explode( ', ', get_user_meta( get_current_user_id(), 'dismissed_wp_pointers', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if our pointer is not among dismissed ones</span>&nbsp;</div></li><li><div>  if( !in_array( 'disqus_settings_pointer', $dismissed_pointers ) ) {&nbsp;</div></li><li><div>      $enqueue_pointer_script_style = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add footer scripts using callback function</span>&nbsp;</div></li><li><div>      $pointer_content = '&lt;h3&gt;'.dsq_i('Disqus needs to be configured').'&lt;/h3&gt;';&nbsp;</div></li><li><div>      $pointer_content .= '&lt;p&gt;'.dsq_i('Configure Disqus by clicking Comments to the left.').'&lt;/p&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_register_script( 'pointer_script', plugins_url( '/media/js/pointer.js', __FILE__ ) );&nbsp;</div></li><li><div>      wp_localize_script( 'pointer_script', 'pointerContent', $pointer_content );&nbsp;</div></li><li><div>      wp_enqueue_script( 'pointer_script', plugins_url( '/media/js/pointer.js', __FILE__ ), array( 'jQuery') );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Enqueue pointer CSS and JS files, if needed</span>&nbsp;</div></li><li><div>  if( $enqueue_pointer_script_style ) {&nbsp;</div></li><li><div>      wp_enqueue_style( 'wp-pointer' );&nbsp;</div></li><li><div>      wp_enqueue_script( 'wp-pointer' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Helper functions.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Tests if site is running on WordPress VIP</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_wp_vip() {&nbsp;</div></li><li><div>  return defined( 'WPCOM_IS_VIP_ENV' ) && WPCOM_IS_VIP_ENV;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Tests if required options are configured to display the Disqus embed.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_is_installed() {&nbsp;</div></li><li><div>  $disqus_forum_url = get_option('disqus_forum_url');&nbsp;</div></li><li><div>  $disqus_api_key = get_option('disqus_api_key');&nbsp;</div></li><li><div>  if ( strlen( $disqus_forum_url ) &gt; 0 && strlen( $disqus_api_key ) &gt; 0 ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_can_replace() {&nbsp;</div></li><li><div>  global $id, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (get_option('disqus_active') === '0') { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $replace = get_option('disqus_replace');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_feed() )                       { return false; }&nbsp;</div></li><li><div>  if ( !isset($post) )                   { return false; }&nbsp;</div></li><li><div>  if ( 'draft' == $post-&gt;post_status )   { return false; }&nbsp;</div></li><li><div>  if ( !get_option('disqus_forum_url') ) { return false; }&nbsp;</div></li><li><div>  else if ( 'all' == $replace )          { return true; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset($post-&gt;comment_count) ) {&nbsp;</div></li><li><div>      $num_comments = 0;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( 'empty' == $replace ) {&nbsp;</div></li><li><div>          <span class="comment">// Only get count of comments, not including pings.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If there are comments, make sure there are comments (that are not track/pingbacks)</span>&nbsp;</div></li><li><div>          if ( $post-&gt;comment_count &gt; 0 ) {&nbsp;</div></li><li><div>              <span class="comment">// Yuck, this causes a DB query for each post.  This can be</span>&nbsp;</div></li><li><div>              <span class="comment">// replaced with a lighter query, but this is still not optimal.</span>&nbsp;</div></li><li><div>              $comments = get_approved_comments($post-&gt;ID);&nbsp;</div></li><li><div>              foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>                  if ( $comment-&gt;comment_type != 'trackback' && $comment-&gt;comment_type != 'pingback' ) {&nbsp;</div></li><li><div>                      $num_comments++;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $num_comments = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $num_comments = $post-&gt;comment_count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return ( ('empty' == $replace && 0 == $num_comments)&nbsp;</div></li><li><div>      || ('closed' == $replace && 'closed' == $post-&gt;comment_status) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_manage_dialog($message, $error = false) {&nbsp;</div></li><li><div>  global $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo '&lt;div '&nbsp;</div></li><li><div>      . ( $error ? 'id=&quot;disqus_warning&quot; ' : '')&nbsp;</div></li><li><div>      . 'class=&quot;updated fade'&nbsp;</div></li><li><div>      . ( (version_compare($wp_version, '2.5', '&lt;') && $error) ? '-ff0000' : '' )&nbsp;</div></li><li><div>      . '&quot;&gt;&lt;p&gt;&lt;strong&gt;'&nbsp;</div></li><li><div>      . esc_attr($message)&nbsp;</div></li><li><div>      . '&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_sync_comments($comments) {&nbsp;</div></li><li><div>  if ( count($comments) &lt; 1 ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// user MUST be logged out during this process</span>&nbsp;</div></li><li><div>  wp_set_current_user(0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// we need the thread_ids so we can map them to posts</span>&nbsp;</div></li><li><div>  $thread_map = array();&nbsp;</div></li><li><div>  foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>      $thread_map[$comment-&gt;thread-&gt;id] = null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thread_ids = array_keys($thread_map);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $threads_query = implode(', ', array_fill(0, count($thread_ids), '%s'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// add as many placeholders as needed</span></span>&nbsp;</div></li><li><div>  $sql = &quot;&nbsp;</div></li><li><div>      SELECT post_id, meta_value&nbsp;</div></li><li><div>      FROM $wpdb-&gt;postmeta&nbsp;</div></li><li><div>      WHERE meta_key = 'dsq_thread_id' AND meta_value IN (&quot; . $threads_query . &quot;)&nbsp;</div></li><li><div>  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Call $wpdb-&gt;prepare passing the values of the array as separate arguments</span></span>&nbsp;</div></li><li><div>  $query = call_user_func_array(array($wpdb, 'prepare'), array_merge(array($sql), $thread_ids));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $results as $result ) {&nbsp;</div></li><li><div>      $thread_map[$result-&gt;meta_value] = $result-&gt;post_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  unset($result);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>      $ts = strtotime($comment-&gt;created_at);&nbsp;</div></li><li><div>      if (!$thread_map[$comment-&gt;thread-&gt;id] && !empty($comment-&gt;thread-&gt;identifier)) {&nbsp;</div></li><li><div>          <span class="comment">// legacy threads dont already have their meta stored</span>&nbsp;</div></li><li><div>          foreach ( $comment-&gt;thread-&gt;identifier as $identifier ) {&nbsp;</div></li><li><div>              <span class="comment">// we know identifier starts with post_ID</span>&nbsp;</div></li><li><div>              if ($post_ID = (int)substr($identifier, 0, strpos($identifier, ' '))) {&nbsp;</div></li><li><div>                  $thread_map[$comment-&gt;thread-&gt;id] = $post_ID;&nbsp;</div></li><li><div>                  $cleaned_thread_id = sanitize_meta( 'dsq_thread_id', $comment-&gt;thread-&gt;id, 'post' );&nbsp;</div></li><li><div>                  update_post_meta($post_ID, 'dsq_thread_id', $cleaned_thread_id);&nbsp;</div></li><li><div>                  if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>                      echo &quot;updated post {$post_ID}: dsq_thread_id set to {$comment-&gt;thread-&gt;id}\n&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          unset($identifier);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$thread_map[$comment-&gt;thread-&gt;id]) {&nbsp;</div></li><li><div>          <span class="comment">// shouldn't ever happen, but we can't be certain</span>&nbsp;</div></li><li><div>          if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>              if (!empty($comment-&gt;thread-&gt;identifier)) {&nbsp;</div></li><li><div>                  $idents = implode(', ', $comment-&gt;thread-&gt;identifier);&nbsp;</div></li><li><div>                  echo &quot;skipped {$comment-&gt;id}: missing thread for identifiers ({$idents})\n&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  echo &quot;skipped {$comment-&gt;id}: missing thread (no identifier)\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT comment_id FROM $wpdb-&gt;commentmeta WHERE meta_key = 'dsq_post_id' AND meta_value = %s LIMIT 1&quot;, $comment-&gt;id));&nbsp;</div></li><li><div>      if (count($results)) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// already exists</span></span>&nbsp;</div></li><li><div>          if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>              echo &quot;skipped {$comment-&gt;id}: comment already exists\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (count($results) &gt; 1) {&nbsp;</div></li><li><div>              <span class="comment">// clean up duplicates -- fixes an issue where a race condition allowed comments to be synced multiple times</span>&nbsp;</div></li><li><div>              $results = array_slice($results, 1);&nbsp;</div></li><li><div>              foreach ($results as $result) {&nbsp;</div></li><li><div>                  $wpdb-&gt;prepare(&quot;DELETE FROM $wpdb-&gt;commentmeta WHERE comment_id = %s LIMIT 1&quot;, $result);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $commentdata = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// first lets check by the id we have stored</span>&nbsp;</div></li><li><div>      if ($comment-&gt;meta) {&nbsp;</div></li><li><div>          $meta = explode(';', $comment-&gt;meta);&nbsp;</div></li><li><div>          foreach ($meta as $value) {&nbsp;</div></li><li><div>              $value = explode('=', $value);&nbsp;</div></li><li><div>              $meta[$value[0]] = $value[1];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          unset($value);&nbsp;</div></li><li><div>          if ($meta['wp_id']) {&nbsp;</div></li><li><div>              $commentdata = $wpdb-&gt;get_row($wpdb-&gt;prepare( &quot;SELECT comment_ID, comment_parent FROM $wpdb-&gt;comments WHERE comment_ID = %s LIMIT 1&quot;, $meta['wp_id']), ARRAY_A);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// skip comments that were imported but are missing meta information</span>&nbsp;</div></li><li><div>      if (!$commentdata && $comment-&gt;imported) {&nbsp;</div></li><li><div>          if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>              echo &quot;skipped {$comment-&gt;id}: comment not found and marked as imported\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// and follow up using legacy Disqus agent</span>&nbsp;</div></li><li><div>      if (!$commentdata) {&nbsp;</div></li><li><div>          $commentdata = $wpdb-&gt;get_row($wpdb-&gt;prepare( &quot;SELECT comment_ID, comment_parent FROM $wpdb-&gt;comments WHERE comment_agent = %s LIMIT 1&quot;, 'Disqus/1.0:'.$comment-&gt;id), ARRAY_A);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$commentdata) {&nbsp;</div></li><li><div>          <span class="comment">// Comment doesnt exist yet, lets insert it</span>&nbsp;</div></li><li><div>          if ($comment-&gt;status == 'approved') {&nbsp;</div></li><li><div>              $approved = 1;&nbsp;</div></li><li><div>          } elseif ($comment-&gt;status == 'spam') {&nbsp;</div></li><li><div>              $approved = 'spam';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $approved = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $commentdata = array(&nbsp;</div></li><li><div>              'comment_post_ID' =&gt; $thread_map[$comment-&gt;thread-&gt;id], &nbsp;</div></li><li><div>              'comment_date' =&gt; date('Y-m-d\TH:i:s', strtotime($comment-&gt;created_at) + (get_option('gmt_offset') * 3600)), &nbsp;</div></li><li><div>              'comment_date_gmt' =&gt; $comment-&gt;created_at, &nbsp;</div></li><li><div>              'comment_content' =&gt; apply_filters('pre_comment_content', $comment-&gt;message), &nbsp;</div></li><li><div>              'comment_approved' =&gt; $approved, &nbsp;</div></li><li><div>              'comment_agent' =&gt; 'Disqus/1.1('.DISQUS_VERSION.'):'.intval($comment-&gt;id), &nbsp;</div></li><li><div>              'comment_type' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          if ($comment-&gt;is_anonymous) {&nbsp;</div></li><li><div>              $commentdata['comment_author'] = $comment-&gt;anonymous_author-&gt;name;&nbsp;</div></li><li><div>              $commentdata['comment_author_email'] = $comment-&gt;anonymous_author-&gt;email;&nbsp;</div></li><li><div>              $commentdata['comment_author_url'] = $comment-&gt;anonymous_author-&gt;url;&nbsp;</div></li><li><div>              $commentdata['comment_author_IP'] = $comment-&gt;ip_address;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if (!empty($comment-&gt;author-&gt;display_name)) {&nbsp;</div></li><li><div>                  $commentdata['comment_author'] = $comment-&gt;author-&gt;display_name;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $commentdata['comment_author'] = $comment-&gt;author-&gt;username;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $commentdata['comment_author_email'] = $comment-&gt;author-&gt;email;&nbsp;</div></li><li><div>              $commentdata['comment_author_url'] = $comment-&gt;author-&gt;url;&nbsp;</div></li><li><div>              $commentdata['comment_author_IP'] = $comment-&gt;ip_address;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $commentdata = wp_filter_comment($commentdata);&nbsp;</div></li><li><div>          if ($comment-&gt;parent_post) {&nbsp;</div></li><li><div>              $parent_id = $wpdb-&gt;get_var($wpdb-&gt;prepare( &quot;SELECT comment_id FROM $wpdb-&gt;commentmeta WHERE meta_key = 'dsq_post_id' AND meta_value = %s LIMIT 1&quot;, $comment-&gt;parent_post));&nbsp;</div></li><li><div>              if ($parent_id) {&nbsp;</div></li><li><div>                  $commentdata['comment_parent'] = $parent_id;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// due to a race condition we need to test again for coment existance</span>&nbsp;</div></li><li><div>          if ($wpdb-&gt;get_row($wpdb-&gt;prepare( &quot;SELECT comment_id FROM $wpdb-&gt;commentmeta WHERE meta_key = 'dsq_post_id' AND meta_value = %s LIMIT 1&quot;, $comment-&gt;id))) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// already exists</span></span>&nbsp;</div></li><li><div>              if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>                  echo &quot;skipped {$comment-&gt;id}: comment already exists (second check)\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $commentdata['comment_ID'] = wp_insert_comment($commentdata);&nbsp;</div></li><li><div>          if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>              echo &quot;inserted {$comment-&gt;id}: id is {$commentdata[comment_ID]}\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ((isset($commentdata['comment_parent']) && !$commentdata['comment_parent']) && $comment-&gt;parent_post) {&nbsp;</div></li><li><div>          $parent_id = $wpdb-&gt;get_var($wpdb-&gt;prepare( &quot;SELECT comment_id FROM $wpdb-&gt;commentmeta WHERE meta_key = 'dsq_post_id' AND meta_value = %s LIMIT 1&quot;, $comment-&gt;parent_post));&nbsp;</div></li><li><div>          if ($parent_id) {&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare( &quot;UPDATE $wpdb-&gt;comments SET comment_parent = %s WHERE comment_id = %s&quot;, $parent_id, $commentdata['comment_ID']));&nbsp;</div></li><li><div>              if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>                  echo &quot;updated {$comment-&gt;id}: comment_parent changed to {$parent_id}\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $comment_id = $commentdata['comment_ID'];&nbsp;</div></li><li><div>      update_comment_meta($comment_id, 'dsq_parent_post_id', $comment-&gt;parent_post);&nbsp;</div></li><li><div>      update_comment_meta($comment_id, 'dsq_post_id', $comment-&gt;id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  unset($comment);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( isset($_POST['dsq_api_key']) && $_POST['dsq_api_key'] == get_option('disqus_api_key') ) {&nbsp;</div></li><li><div>      if( isset($_GET['dsq_sync_action']) && isset($_GET['dsq_sync_comment_id']) ) {&nbsp;</div></li><li><div>          $comment_parts = explode('=', $_GET['dsq_sync_comment_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!($comment_id = intval($comment_parts[1])) &gt; 0) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( 'wp_id' != $comment_parts[0] ) {&nbsp;</div></li><li><div>              $comment_id = $wpdb-&gt;get_var($wpdb-&gt;prepare('SELECT comment_ID FROM ' . $wpdb-&gt;comments . ' WHERE comment_post_ID = %d AND comment_agent LIKE %s', intval($post-&gt;ID), 'Disqus/1.0:' . $comment_id));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch( $_GET['dsq_sync_action'] ) {&nbsp;</div></li><li><div>              case 'mark_spam':&nbsp;</div></li><li><div>                  wp_set_comment_status($comment_id, 'spam');&nbsp;</div></li><li><div>                  echo &quot;&lt;!-- dsq_sync: wp_set_comment_status($comment_id, 'spam') --&gt;&quot;;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'mark_approved':&nbsp;</div></li><li><div>                  wp_set_comment_status($comment_id, 'approve');&nbsp;</div></li><li><div>                  echo &quot;&lt;!-- dsq_sync: wp_set_comment_status($comment_id, 'approve') --&gt;&quot;;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'mark_killed':&nbsp;</div></li><li><div>                  wp_set_comment_status($comment_id, 'hold');&nbsp;</div></li><li><div>                  echo &quot;&lt;!-- dsq_sync: wp_set_comment_status($comment_id, 'hold') --&gt;&quot;;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_request_handler() {&nbsp;</div></li><li><div>  global $dsq_response;&nbsp;</div></li><li><div>  global $dsq_api;&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!empty($_GET['cf_action'])) {&nbsp;</div></li><li><div>      switch ($_GET['cf_action']) {&nbsp;</div></li><li><div>          case 'sync_comments':&nbsp;</div></li><li><div>              if( !( $post_id = $_GET['post_id'] ) ) {&nbsp;</div></li><li><div>                  header(&quot;HTTP/1.0 400 Bad Request&quot;);&nbsp;</div></li><li><div>                  die();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// schedule the event for 5 minutes from now in case they</span>&nbsp;</div></li><li><div>              <span class="comment">// happen to make a quick post</span>&nbsp;</div></li><li><div>              dsq_add_pending_post_id($post_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>                  $response = dsq_sync_forum();&nbsp;</div></li><li><div>                  if (!$response) {&nbsp;</div></li><li><div>                      die('<span class="comment">// error: '.$dsq_api-&gt;get_last_error());</span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      list($last_comment_id, $comments) = $response;&nbsp;</div></li><li><div>                      die('<span class="comment">// synced '.$comments.' comments');</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $ts = time() + 300;&nbsp;</div></li><li><div>                  $next_scheduled = wp_next_scheduled('dsq_sync_forum');&nbsp;</div></li><li><div>                  if($next_scheduled) {&nbsp;</div></li><li><div>                      <span class="comment">// error_log(&quot;Not scheduling dsq_sync_forum because it's already scheduled for &quot; . $next_scheduled);</span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment">// error_log(&quot;Scheduling for $ts because dsq_sync_forum is not currently scheduled.&quot;);</span>&nbsp;</div></li><li><div>                      wp_schedule_single_event($ts, 'dsq_sync_forum');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  die('<span class="comment">// sync scheduled');</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'export_comments':&nbsp;</div></li><li><div>              if (current_user_can('manage_options') && DISQUS_CAN_EXPORT) {&nbsp;</div></li><li><div>                  $msg = '';&nbsp;</div></li><li><div>                  $result = '';&nbsp;</div></li><li><div>                  $response = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $timestamp = intval($_GET['timestamp']);&nbsp;</div></li><li><div>                  $post_id = intval($_GET['post_id']);&nbsp;</div></li><li><div>                  if ( isset($_GET['_dsqexport_wpnonce']) === false ) {&nbsp;</div></li><li><div>                      $msg = dsq_i('Unable to export comments. Make sure you are accessing this page from the WordPress dashboard.');&nbsp;</div></li><li><div>                      $result = 'fail';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Check nonce</span></span>&nbsp;</div></li><li><div>                      check_admin_referer('dsq-wpnonce_export', '_dsqexport_wpnonce');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      global $wpdb, $dsq_api;&nbsp;</div></li><li><div>                      $post = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>                          SELECT *&nbsp;</div></li><li><div>                          FROM $wpdb-&gt;posts&nbsp;</div></li><li><div>                          WHERE post_type != 'revision'&nbsp;</div></li><li><div>                          AND post_status = 'publish'&nbsp;</div></li><li><div>                          AND comment_count &gt; 0&nbsp;</div></li><li><div>                          AND ID &gt; %d&nbsp;</div></li><li><div>                          ORDER BY ID ASC&nbsp;</div></li><li><div>                          LIMIT 1&nbsp;</div></li><li><div>                      &quot;, $post_id));&nbsp;</div></li><li><div>                      $post = $post[0];&nbsp;</div></li><li><div>                      $post_id = $post-&gt;ID;&nbsp;</div></li><li><div>                      $max_post_id = $wpdb-&gt;get_var(&quot;&nbsp;</div></li><li><div>                          SELECT MAX(Id)&nbsp;</div></li><li><div>                          FROM $wpdb-&gt;posts&nbsp;</div></li><li><div>                          WHERE post_type != 'revision'&nbsp;</div></li><li><div>                          AND post_status = 'publish'&nbsp;</div></li><li><div>                          AND comment_count &gt; 0&nbsp;</div></li><li><div>                      &quot;);&nbsp;</div></li><li><div>                      $eof = (int)($post_id == $max_post_id);&nbsp;</div></li><li><div>                      if ($eof) {&nbsp;</div></li><li><div>                          $status = 'complete';&nbsp;</div></li><li><div>                          $msg = dsq_i('Your comments have been sent to Disqus and queued for import!');&nbsp;</div></li><li><div>                          $msg .= '&lt;br/&gt;&lt;a href=&quot;'.DISQUS_IMPORTER_URL.'&quot; target=&quot;_blank&quot;&gt;';&nbsp;</div></li><li><div>                          $msg .= dsq_i('See the status of your import at Disqus') . '&lt;/a&gt;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else {&nbsp;</div></li><li><div>                          $status = 'partial';&nbsp;</div></li><li><div>                          $msg = dsq_i('Processed comments on post') . ' #'. $post_id . '&hellip;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $result = 'fail';&nbsp;</div></li><li><div>                      if ($post) {&nbsp;</div></li><li><div>                          require_once(dirname(__FILE__) . '/export.php');&nbsp;</div></li><li><div>                          $wxr = dsq_export_wp($post);&nbsp;</div></li><li><div>                          $response = $dsq_api-&gt;import_wordpress_comments($wxr, $timestamp, $eof);&nbsp;</div></li><li><div>                          if (!($response['group_id'] &gt; 0)) {&nbsp;</div></li><li><div>                              $result = 'fail';&nbsp;</div></li><li><div>                              $msg = '&lt;p class=&quot;status dsq-export-fail&quot;&gt;';&nbsp;</div></li><li><div>                              $msg .= dsq_i('Sorry, something unexpected happened with the export. Please try again.');&nbsp;</div></li><li><div>                              $msg .= '&lt;/p&gt;&lt;p&gt;';&nbsp;</div></li><li><div>                              $msg .= dsq_i('If your API key has changed, you may need to reinstall Disqus (deactivate the plugin and then reactivate it).');&nbsp;</div></li><li><div>                              $msg .= dsq_i('If you are still having issues, refer to the %s WordPress help page', &nbsp;</div></li><li><div>                                  '&lt;a href=&quot;https:<span class="comment">//help.disqus.com/customer/portal/articles/472005&quot; onclick=&quot;window.open(this.href); return false&quot;&gt;');</span>&nbsp;</div></li><li><div>                              $msg .= '&lt;/a&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>                              $response = $dsq_api-&gt;get_last_error();&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          else {&nbsp;</div></li><li><div>                              if ($eof) {&nbsp;</div></li><li><div>                                  $msg = dsq_i('Your comments have been sent to Disqus and queued for import!');&nbsp;</div></li><li><div>                                  $msg .= '&lt;br/&gt;&lt;a href=&quot;' . $response['link'] . '&quot; target=&quot;_blank&quot;&gt;';&nbsp;</div></li><li><div>                                  $msg .= dsq_i('See the status of your import at Disqus');&nbsp;</div></li><li><div>                                  $msg .= '&lt;/a&gt;';&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $result = 'success';&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// send AJAX response</span>&nbsp;</div></li><li><div>                  $response = compact('result', 'timestamp', 'status', 'post_id', 'msg', 'eof', 'response');&nbsp;</div></li><li><div>                  header('Content-type: text/javascript');&nbsp;</div></li><li><div>                  echo cf_json_encode($response);&nbsp;</div></li><li><div>                  die();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'import_comments':&nbsp;</div></li><li><div>              if (current_user_can('manage_options')) {&nbsp;</div></li><li><div>                  $msg = '';&nbsp;</div></li><li><div>                  $result = '';&nbsp;</div></li><li><div>                  $response = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( isset($_GET['_dsqimport_wpnonce']) === false ) {&nbsp;</div></li><li><div>                      $msg = dsq_i('Unable to import comments. Make sure you are accessing this page from the WordPress dashboard.');&nbsp;</div></li><li><div>                      $result = 'fail';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Check nonce</span></span>&nbsp;</div></li><li><div>                      check_admin_referer('dsq-wpnonce_import', '_dsqimport_wpnonce');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if (!isset($_GET['last_comment_id'])) $last_comment_id = false;&nbsp;</div></li><li><div>                      else $last_comment_id = $_GET['last_comment_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($_GET['wipe'] == '1') {&nbsp;</div></li><li><div>                          $wpdb-&gt;query(&quot;DELETE FROM `&quot;.$wpdb-&gt;prefix.&quot;commentmeta` WHERE meta_key IN ('dsq_post_id', 'dsq_parent_post_id')&quot;);&nbsp;</div></li><li><div>                          $wpdb-&gt;query(&quot;DELETE FROM `&quot;.$wpdb-&gt;prefix.&quot;comments` WHERE comment_agent LIKE 'Disqus/%%'&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      ob_start();&nbsp;</div></li><li><div>                      $response = dsq_sync_forum($last_comment_id, true);&nbsp;</div></li><li><div>                      $debug = ob_get_clean();&nbsp;</div></li><li><div>                      if (!$response) {&nbsp;</div></li><li><div>                          $status = 'error';&nbsp;</div></li><li><div>                          $result = 'fail';&nbsp;</div></li><li><div>                          $error = $dsq_api-&gt;get_last_error();&nbsp;</div></li><li><div>                          $msg = '&lt;p class=&quot;status dsq-export-fail&quot;&gt;'.dsq_i('There was an error downloading your comments from Disqus.').'&lt;br/&gt;'.esc_attr($error).'&lt;/p&gt;';&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          list($comments, $last_comment_id) = $response;&nbsp;</div></li><li><div>                          if (!$comments) {&nbsp;</div></li><li><div>                              $status = 'complete';&nbsp;</div></li><li><div>                              $msg = dsq_i('Your comments have been downloaded from Disqus and saved in your local database.');&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $status = 'partial';&nbsp;</div></li><li><div>                              $msg = dsq_i('Import in progress (last post id: %s)', $last_comment_id) . ' &hellip;';&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $result = 'success';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $debug = explode(&quot;\n&quot;, $debug);&nbsp;</div></li><li><div>                      $response = compact('result', 'status', 'comments', 'msg', 'last_comment_id', 'debug');&nbsp;</div></li><li><div>                      header('Content-type: text/javascript');&nbsp;</div></li><li><div>                      echo cf_json_encode($response);&nbsp;</div></li><li><div>                      die();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('init', 'dsq_request_handler');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option_name</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_image_upload_handler($option_name) {&nbsp;</div></li><li><div>  <span class="comment">// If the upload field has a file in it</span>&nbsp;</div></li><li><div>  if(isset($_FILES[$option_name]) && ($_FILES[$option_name]['size'] &gt; 0)) {&nbsp;</div></li><li><div>      <span class="comment">// Get the type of the uploaded file. This is returned as &quot;type/extension&quot;</span>&nbsp;</div></li><li><div>      $arr_file_type = wp_check_filetype(basename($_FILES[$option_name]['name']));&nbsp;</div></li><li><div>      $uploaded_file_type = $arr_file_type['type'];&nbsp;</div></li><li><div>      <span class="comment">// Set an array containing a list of acceptable formats</span>&nbsp;</div></li><li><div>      $allowed_file_types = array('image/jpg', 'image/jpeg', 'image/gif', 'image/png', 'image/x-icon');&nbsp;</div></li><li><div>      <span class="comment">// If the uploaded file is the right format</span>&nbsp;</div></li><li><div>      if(in_array($uploaded_file_type, $allowed_file_types)) {&nbsp;</div></li><li><div>          <span class="comment">// Options array for the wp_handle_upload function. 'test_upload' =&gt; false</span>&nbsp;</div></li><li><div>          $upload_overrides = array( 'test_form' =&gt; false );&nbsp;</div></li><li><div>          <span class="comment">// Handle the upload using WP's wp_handle_upload function. Takes the posted file and an options array</span>&nbsp;</div></li><li><div>          $uploaded_file = wp_handle_upload($_FILES[$option_name], $upload_overrides);&nbsp;</div></li><li><div>          <span class="comment">// If the wp_handle_upload call returned a local path for the image</span>&nbsp;</div></li><li><div>          if(isset($uploaded_file['url'])) {&nbsp;</div></li><li><div>              update_option($option_name, $uploaded_file['url']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_add_pending_post_id($post_id) {&nbsp;</div></li><li><div>  update_post_meta($post_id, 'dsq_needs_sync', '1', $unique=true);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_get_pending_post_ids() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results( &quot;SELECT post_id FROM {$wpdb-&gt;postmeta} WHERE meta_key = 'dsq_needs_sync'&quot;);&nbsp;</div></li><li><div>  $post_ids = array();&nbsp;</div></li><li><div>  foreach ($results as $result) {&nbsp;</div></li><li><div>      $post_ids[] = $result-&gt;post_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $post_ids;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_clear_pending_post_ids($post_ids) {&nbsp;</div></li><li><div>  if ( count($post_ids) &lt; 1 ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts_query = implode(', ', array_fill(0, count($post_ids), '%s'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// add as many placeholders as needed</span></span>&nbsp;</div></li><li><div>  $sql = &quot;&nbsp;</div></li><li><div>      DELETE FROM {$wpdb-&gt;postmeta}&nbsp;</div></li><li><div>      WHERE meta_key = 'dsq_needs_sync' AND post_id IN (&quot; . $posts_query . &quot;)&nbsp;</div></li><li><div>  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Call $wpdb-&gt;prepare passing the values of the array as separate arguments</span></span>&nbsp;</div></li><li><div>  $query = call_user_func_array(array($wpdb, 'prepare'), array_merge(array($sql), $post_ids));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_meta_cache('dsq_needs_sync', $post_ids);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_sync_post($post_id) {&nbsp;</div></li><li><div>  global $dsq_api, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post($post_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Call update_thread to ensure our permalink is up to date</span>&nbsp;</div></li><li><div>  dsq_update_permalink($post);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_sync_forum($last_comment_id=false, $force=false) {&nbsp;</div></li><li><div>  global $dsq_api, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  set_time_limit(DISQUS_SYNC_TIMEOUT);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($force) {&nbsp;</div></li><li><div>      $sync_time = null;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $sync_time = (int)get_option('_disqus_sync_lock');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// lock expires after 1 hour</span>&nbsp;</div></li><li><div>  if ($sync_time && $sync_time &gt; time() - 60*60) {&nbsp;</div></li><li><div>      $dsq_api-&gt;api-&gt;last_error = 'Sync already in progress (lock found)';&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      update_option('_disqus_sync_lock', time());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// sync all pending posts</span>&nbsp;</div></li><li><div>  $post_ids = dsq_get_pending_post_ids();&nbsp;</div></li><li><div>  dsq_clear_pending_post_ids($post_ids);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ($post_ids as $post_id) {&nbsp;</div></li><li><div>      dsq_sync_post($post_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($last_comment_id === false) {&nbsp;</div></li><li><div>      $last_comment_id = get_option('disqus_last_comment_id');&nbsp;</div></li><li><div>      if (!$last_comment_id) {&nbsp;</div></li><li><div>          $last_comment_id = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ($last_comment_id) {&nbsp;</div></li><li><div>      $last_comment_id++;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//$last_comment_id = 0;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Pull comments from API</span>&nbsp;</div></li><li><div>  $dsq_response = $dsq_api-&gt;get_forum_posts($last_comment_id);&nbsp;</div></li><li><div>  if( $dsq_response &lt; 0 || $dsq_response === false ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sync comments with database.</span>&nbsp;</div></li><li><div>  dsq_sync_comments($dsq_response);&nbsp;</div></li><li><div>  $total = 0;&nbsp;</div></li><li><div>  if ($dsq_response) {&nbsp;</div></li><li><div>      foreach ($dsq_response as $comment) {&nbsp;</div></li><li><div>          $total += 1;&nbsp;</div></li><li><div>          if ($comment-&gt;id &gt; $last_comment_id) $last_comment_id = $comment-&gt;id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($last_comment_id &gt; get_option('disqus_last_comment_id')) {&nbsp;</div></li><li><div>          update_option('disqus_last_comment_id', $last_comment_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  unset($comment);&nbsp;</div></li><li><div>  delete_option('_disqus_sync_lock');&nbsp;</div></li><li><div>  return array($total, $last_comment_id);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('dsq_sync_forum', 'dsq_sync_forum');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_update_permalink($post) {&nbsp;</div></li><li><div>  global $dsq_api;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (DISQUS_DEBUG) {&nbsp;</div></li><li><div>      echo &quot;updating post on disqus: {$post-&gt;ID}\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $response = $dsq_api-&gt;api-&gt;update_thread(null, array(&nbsp;</div></li><li><div>      'thread_identifier' =&gt; dsq_identifier_for_post($post), &nbsp;</div></li><li><div>      'title' =&gt; dsq_title_for_post($post), &nbsp;</div></li><li><div>      'url' =&gt; dsq_link_for_post($post)&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Make sure that response exists so that warnings are not thrown</span>&nbsp;</div></li><li><div>  if (! empty($response)) {&nbsp;</div></li><li><div>      $cleaned_thread_id = sanitize_meta( 'dsq_thread_id', $response-&gt;id, 'post' );&nbsp;</div></li><li><div>      update_post_meta($post-&gt;ID, 'dsq_thread_id', $cleaned_thread_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $response;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *  Compatibility</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if (!function_exists ( '_wp_specialchars' ) ) {&nbsp;</div></li><li><div>function _wp_specialchars( $string, $quote_style = ENT_NOQUOTES, $charset = false, $double_encode = false ) {&nbsp;</div></li><li><div>  $string = (string) $string;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 0 === strlen( $string ) ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't bother if there are no specialchars - saves some processing</span>&nbsp;</div></li><li><div>  if ( !preg_match( '/[&&lt;&gt;&quot;\']/', $string ) ) {&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Account for the previous behaviour of the function when the $quote_style is not an accepted value</span>&nbsp;</div></li><li><div>  if ( empty( $quote_style ) ) {&nbsp;</div></li><li><div>      $quote_style = ENT_NOQUOTES;&nbsp;</div></li><li><div>  } elseif ( !in_array( $quote_style, array( 0, 2, 3, 'single', 'double' ), true ) ) {&nbsp;</div></li><li><div>      $quote_style = ENT_QUOTES;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store the site charset as a static to avoid multiple calls to wp_load_alloptions()</span>&nbsp;</div></li><li><div>  if ( !$charset ) {&nbsp;</div></li><li><div>      static $_charset;&nbsp;</div></li><li><div>      if ( !isset( $_charset ) ) {&nbsp;</div></li><li><div>          $alloptions = wp_load_alloptions();&nbsp;</div></li><li><div>          $_charset = isset( $alloptions['blog_charset'] ) ? $alloptions['blog_charset'] : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $charset = $_charset;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( in_array( $charset, array( 'utf8', 'utf-8', 'UTF8' ) ) ) {&nbsp;</div></li><li><div>      $charset = 'UTF-8';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $_quote_style = $quote_style;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $quote_style === 'double' ) {&nbsp;</div></li><li><div>      $quote_style = ENT_COMPAT;&nbsp;</div></li><li><div>      $_quote_style = ENT_COMPAT;&nbsp;</div></li><li><div>  } elseif ( $quote_style === 'single' ) {&nbsp;</div></li><li><div>      $quote_style = ENT_NOQUOTES;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Handle double encoding ourselves</span></span>&nbsp;</div></li><li><div>  if ( !$double_encode ) {&nbsp;</div></li><li><div>      $string = wp_specialchars_decode( $string, $_quote_style );&nbsp;</div></li><li><div>      $string = preg_replace( '/&(#?x?[0-9a-z]+);/i', '|wp_entity|$1|/wp_entity|', $string );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $string = @esc_attr( $string, $quote_style, $charset );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Handle double encoding ourselves</span></span>&nbsp;</div></li><li><div>  if ( !$double_encode ) {&nbsp;</div></li><li><div>      $string = str_replace( array( '|wp_entity|', '|/wp_entity|' ), array( '&', ';' ), $string );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Backwards compatibility</span>&nbsp;</div></li><li><div>  if ( 'single' === $_quote_style ) {&nbsp;</div></li><li><div>      $string = str_replace( &quot;'&quot;, '&#039;', $string );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $string;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if (!function_exists ( 'wp_check_invalid_utf8' ) ) {&nbsp;</div></li><li><div>function wp_check_invalid_utf8( $string, $strip = false ) {&nbsp;</div></li><li><div>  $string = (string) $string;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 0 === strlen( $string ) ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store the site charset as a static to avoid multiple calls to get_option()</span>&nbsp;</div></li><li><div>  static $is_utf8;&nbsp;</div></li><li><div>  if ( !isset( $is_utf8 ) ) {&nbsp;</div></li><li><div>      $is_utf8 = in_array( get_option( 'blog_charset' ), array( 'utf8', 'utf-8', 'UTF8', 'UTF-8' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( !$is_utf8 ) {&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for support for utf8 in the installed PCRE library once and store the result in a static</span>&nbsp;</div></li><li><div>  static $utf8_pcre;&nbsp;</div></li><li><div>  if ( !isset( $utf8_pcre ) ) {&nbsp;</div></li><li><div>      $utf8_pcre = @preg_match( '/^./u', 'a' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// We can't demand utf8 in the PCRE installation, so just return the string in those cases</span>&nbsp;</div></li><li><div>  if ( !$utf8_pcre ) {&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// preg_match fails when it encounters invalid UTF8 in $string</span>&nbsp;</div></li><li><div>  if ( 1 === @preg_match( '/^./us', $string ) ) {&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Attempt to strip the bad chars if requested (not recommended)</span>&nbsp;</div></li><li><div>  if ( $strip && function_exists( 'iconv' ) ) {&nbsp;</div></li><li><div>      return iconv( 'utf-8', 'utf-8', $string );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if (!function_exists ( 'esc_html' ) ) {&nbsp;</div></li><li><div>function esc_html( $text ) {&nbsp;</div></li><li><div>  $safe_text = wp_check_invalid_utf8( $text );&nbsp;</div></li><li><div>  $safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );&nbsp;</div></li><li><div>  return apply_filters( 'esc_html', $safe_text, $text );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if (!function_exists ( 'esc_attr' ) ) {&nbsp;</div></li><li><div>function esc_attr( $text ) {&nbsp;</div></li><li><div>  $safe_text = wp_check_invalid_utf8( $text );&nbsp;</div></li><li><div>  $safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );&nbsp;</div></li><li><div>  return apply_filters( 'attribute_escape', $safe_text, $text );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *  Filters/Actions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// ugly global hack for comments closing</span>&nbsp;</div></li><li><div>$EMBED = false;&nbsp;</div></li><li><div>function dsq_comments_template($value) {&nbsp;</div></li><li><div>  global $EMBED;&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>  global $comments;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !( is_singular() && ( have_comments() || 'open' == $post-&gt;comment_status ) ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !dsq_is_installed() || !dsq_can_replace() ) {&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// TODO: If a disqus-comments.php is found in the current template's</span>&nbsp;</div></li><li><div>  <span class="comment">// path, use that instead of the default bundled comments.php</span>&nbsp;</div></li><li><div>  <span class="comment">//return TEMPLATEPATH . '/disqus-comments.php';</span>&nbsp;</div></li><li><div>  $EMBED = true;&nbsp;</div></li><li><div>  return dirname(__FILE__) . '/comments.php';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_comment( $comment, $args, $depth ) {&nbsp;</div></li><li><div>  $GLOBALS['comment'] = $comment;&nbsp;</div></li><li><div>  switch ($comment-&gt;comment_type):&nbsp;</div></li><li><div>      case '' :&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;li &lt;?php comment_class(); ?&gt; id=&quot;dsq-comment-&lt;?php echo comment_ID(); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;dsq-comment-header-&lt;?php echo comment_ID(); ?&gt;&quot; class=&quot;dsq-comment-header&quot;&gt;&nbsp;</div></li><li><div>          &lt;cite id=&quot;dsq-cite-&lt;?php echo comment_ID(); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&lt;?php if(get_comment_author_url()) : ?&gt;&nbsp;</div></li><li><div>              &lt;a id=&quot;dsq-author-user-&lt;?php echo comment_ID(); ?&gt;&quot; href=&quot;&lt;?php echo comment_author_url(); ?&gt;&quot; target=&quot;_blank&quot; rel=&quot;nofollow&quot;&gt;&lt;?php echo comment_author(); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&lt;?php else : ?&gt;&nbsp;</div></li><li><div>              &lt;span id=&quot;dsq-author-user-&lt;?php echo comment_ID(); ?&gt;&quot;&gt;&lt;?php echo comment_author(); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>          &lt;/cite&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;dsq-comment-body-&lt;?php echo comment_ID(); ?&gt;&quot; class=&quot;dsq-comment-body&quot;&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;dsq-comment-message-&lt;?php echo comment_ID(); ?&gt;&quot; class=&quot;dsq-comment-message&quot;&gt;&lt;?php echo wp_filter_kses(comment_text()); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'pingback'  :&nbsp;</div></li><li><div>      case 'trackback' :&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;li class=&quot;post pingback&quot;&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php echo dsq_i('Pingback:'); ?&gt; &lt;?php comment_author_link(); ?&gt;(&lt;?php edit_comment_link(dsq_i('Edit'), ' '); ?&gt;)&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/li&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  endswitch;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Mark entries in index to replace comments link.</span>&nbsp;</div></li><li><div><span class="comment">// As of WordPress 3.1 this is required to return a numerical value</span>&nbsp;</div></li><li><div>function dsq_comments_number($count) {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $count;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_comments_text($comment_text) {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( dsq_can_replace() ) {&nbsp;</div></li><li><div>      return '&lt;span class=&quot;dsq-postid&quot; data-dsqidentifier=&quot;'.esc_attr(dsq_identifier_for_post($post)).'&quot;&gt;'.$comment_text.'&lt;/span&gt;';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $comment_text;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_bloginfo_url($url) {&nbsp;</div></li><li><div>  if ( get_feed_link('comments_rss2') == $url && dsq_can_replace() ) {&nbsp;</div></li><li><div>      return 'https:<span class="comment">//' . strtolower(get_option('disqus_forum_url')) . '.disqus.com' . DISQUS_RSS_PATH;</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_plugin_action_links($links, $file) {&nbsp;</div></li><li><div>  $plugin_file = basename(__FILE__);&nbsp;</div></li><li><div>  if (basename($file) == $plugin_file) {&nbsp;</div></li><li><div>      if (!dsq_is_installed()) {&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;edit-comments.php?page=disqus&quot;&gt;'.dsq_i('Configure').'&lt;/a&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;edit-comments.php?page=disqus#adv&quot;&gt;'.dsq_i('Settings').'&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      array_unshift($links, $settings_link);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $links;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter('plugin_action_links', 'dsq_plugin_action_links', 10, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Hide the default comment form to stop spammers by marking all comments</span>&nbsp;</div></li><li><div><span class="comment"> * as closed.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_comments_open($open, $post_id=null) {&nbsp;</div></li><li><div>  global $EMBED;&nbsp;</div></li><li><div>  if ($EMBED) return false;&nbsp;</div></li><li><div>  return $open;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter('comments_open', 'dsq_comments_open');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Always add Disqus management page to the admin menu</span>&nbsp;</div></li><li><div>function dsq_add_pages() {&nbsp;</div></li><li><div>   add_submenu_page(&nbsp;</div></li><li><div>       'edit-comments.php', &nbsp;</div></li><li><div>       'Disqus', &nbsp;</div></li><li><div>       'Disqus', &nbsp;</div></li><li><div>       'moderate_comments', &nbsp;</div></li><li><div>       'disqus', &nbsp;</div></li><li><div>       'dsq_manage'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('admin_menu', 'dsq_add_pages', 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// only active on dashboard</span>&nbsp;</div></li><li><div>function get_dash_comment_counts() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div><span class="comment">// taken from wp-includes/comment.php - WP 2.8.5</span>&nbsp;</div></li><li><div>  $count = $wpdb-&gt;get_results(&quot;&nbsp;</div></li><li><div>      SELECT comment_approved, COUNT( * ) AS num_comments&nbsp;</div></li><li><div>      FROM {$wpdb-&gt;comments}&nbsp;</div></li><li><div>      WHERE comment_type != 'trackback'&nbsp;</div></li><li><div>      AND comment_type != 'pingback'&nbsp;</div></li><li><div>      GROUP BY comment_approved&nbsp;</div></li><li><div>  &quot;, ARRAY_A );&nbsp;</div></li><li><div>  $total = 0;&nbsp;</div></li><li><div>  $approved = array('0' =&gt; 'moderated', '1' =&gt; 'approved', 'spam' =&gt; 'spam');&nbsp;</div></li><li><div>  $known_types = array_keys( $approved );&nbsp;</div></li><li><div>  foreach( (array) $count as $row_num =&gt; $row ) {&nbsp;</div></li><li><div>      $total += $row['num_comments'];&nbsp;</div></li><li><div>      if ( in_array( $row['comment_approved'], $known_types ) && array_key_exists($row['comment_approved'], $approved) )&nbsp;</div></li><li><div>          $stats[$approved[$row['comment_approved']]] = $row['num_comments'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats['total_comments'] = $total;&nbsp;</div></li><li><div>  foreach ( $approved as $key ) {&nbsp;</div></li><li><div>      if ( empty($stats[$key]) )&nbsp;</div></li><li><div>          $stats[$key] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return (object) $stats;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_manage() {&nbsp;</div></li><li><div>  if (dsq_does_need_update() && isset($_POST['upgrade'])) {&nbsp;</div></li><li><div>      dsq_install();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (dsq_does_need_update() && !isset($_POST['reset'])) {&nbsp;</div></li><li><div>      include_once(dirname(__FILE__) . '/upgrade.php');&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      include_once(dirname(__FILE__) . '/manage.php');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_admin_head() {&nbsp;</div></li><li><div>  if (isset($_GET['page']) && $_GET['page'] == 'disqus') {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;link rel='stylesheet' href='&lt;?php echo esc_url( plugins_url( 'media/styles/manage.css', __FILE__ ) ); ?&gt;' type='text/css' /&gt;&nbsp;</div></li><li><div>&lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>.dsq-importing, .dsq-imported, .dsq-import-fail, .dsq-exporting, .dsq-exported, .dsq-export-fail {&nbsp;</div></li><li><div>  background: url(&lt;?php echo esc_url( admin_url('images/loading.gif') ); ?&gt;) left center no-repeat;&nbsp;</div></li><li><div>  line-height: 16px;&nbsp;</div></li><li><div>  padding-left: 20px;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>p.status {&nbsp;</div></li><li><div>  padding-top: 0;&nbsp;</div></li><li><div>  padding-bottom: 0;&nbsp;</div></li><li><div>  margin: 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>.dsq-imported, .dsq-exported {&nbsp;</div></li><li><div>  background: url(&lt;?php echo esc_url( admin_url('images/yes.png') ); ?&gt;) left center no-repeat;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>.dsq-import-fail, .dsq-export-fail {&nbsp;</div></li><li><div>  background: url(&lt;?php echo esc_url( admin_url('images/no.png') ); ?&gt;) left center no-repeat;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&lt;/style&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">// HACK: Our own styles for older versions of WordPress.</span>&nbsp;</div></li><li><div>      global $wp_version;&nbsp;</div></li><li><div>      if ( version_compare($wp_version, '2.5', '&lt;') ) {&nbsp;</div></li><li><div>          echo &quot;&lt;link rel='stylesheet' href='&quot; . esc_url( plugins_url( 'media/styles/manage-pre25.css', __FILE__ ) ) . &quot;' type='text/css' /&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('admin_head', 'dsq_admin_head');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Wrapper for built-in __() which pulls all text from</span>&nbsp;</div></li><li><div><span class="comment"> * the disqus domain and supports variable interpolation.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_i($text, $params=null) {&nbsp;</div></li><li><div>  if (!is_array($params))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $params = func_get_args();&nbsp;</div></li><li><div>      $params = array_slice($params, 1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return vsprintf(__($text, 'disqus'), $params);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// catch original query</span>&nbsp;</div></li><li><div>function dsq_parse_query($query) {&nbsp;</div></li><li><div>  add_action('the_posts', 'dsq_add_request_post_ids', 999);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('parse_request', 'dsq_parse_query');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// track the original request post_ids, only run once</span>&nbsp;</div></li><li><div>function dsq_add_request_post_ids($posts) {&nbsp;</div></li><li><div>  dsq_add_query_posts($posts);&nbsp;</div></li><li><div>  remove_action('the_posts', 'dsq_log_request_post_ids', 999);&nbsp;</div></li><li><div>  return $posts;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_maybe_add_post_ids($posts) {&nbsp;</div></li><li><div>  global $DSQ_QUERY_COMMENTS;&nbsp;</div></li><li><div>  if ($DSQ_QUERY_COMMENTS) {&nbsp;</div></li><li><div>      dsq_add_query_posts($posts);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $posts;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('the_posts', 'dsq_maybe_add_post_ids');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_add_query_posts($posts) {&nbsp;</div></li><li><div>  global $DSQ_QUERY_POST_IDS;&nbsp;</div></li><li><div>  if (count($posts)) {&nbsp;</div></li><li><div>      foreach ($posts as $post) {&nbsp;</div></li><li><div>          $post_ids[] = intval($post-&gt;ID);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $DSQ_QUERY_POST_IDS[md5(serialize($post_ids))] = $post_ids;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_output_count_js() {&nbsp;</div></li><li><div>  if ( get_option('dsq_external_js') == '1' ) {&nbsp;</div></li><li><div>      $count_vars = array(&nbsp;</div></li><li><div>          'disqusShortname' =&gt; strtolower( get_option( 'disqus_forum_url' ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_register_script( 'dsq_count_script', plugins_url( '/media/js/count.js', __FILE__ ) );&nbsp;</div></li><li><div>      wp_localize_script( 'dsq_count_script', 'countVars', $count_vars );&nbsp;</div></li><li><div>      wp_enqueue_script( 'dsq_count_script', plugins_url( '/media/js/count.js', __FILE__ ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>      <span class="comment">// &lt;![CDATA[</span>&nbsp;</div></li><li><div>      var disqus_shortname = '&lt;?php echo strtolower( get_option('disqus_forum_url') ); ?&gt;';&nbsp;</div></li><li><div>      (function () {&nbsp;</div></li><li><div>          var nodes = document.getElementsByTagName('span');&nbsp;</div></li><li><div>          for (var i = 0, url; i &lt; nodes.length; i++) {&nbsp;</div></li><li><div>              if (nodes[i].className.indexOf('dsq-postid') != -1 && nodes[i].parentNode.tagName == 'A') {&nbsp;</div></li><li><div>                  nodes[i].parentNode.setAttribute('data-disqus-identifier', nodes[i].getAttribute('data-dsqidentifier'));&nbsp;</div></li><li><div>                  url = nodes[i].parentNode.href.split('#', 1);&nbsp;</div></li><li><div>                  if (url.length == 1) { url = url[0]; }&nbsp;</div></li><li><div>                  else { url = url[1]; }&nbsp;</div></li><li><div>                  nodes[i].parentNode.href = url + '#disqus_thread';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          var s = document.createElement('script');&nbsp;</div></li><li><div>          s.async = true;&nbsp;</div></li><li><div>          s.type = 'text/javascript';&nbsp;</div></li><li><div>          s.src = '<span class="comment">//' + disqus_shortname + '.&lt;?php echo DISQUS_DOMAIN; ?&gt;/count.js';</span>&nbsp;</div></li><li><div>          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);&nbsp;</div></li><li><div>      }());&nbsp;</div></li><li><div>      <span class="comment">// ]]&gt;</span>&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_output_footer_comment_js() {&nbsp;</div></li><li><div>  if (!dsq_can_replace()) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  dsq_output_count_js();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('wp_footer', 'dsq_output_footer_comment_js');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// UPDATE DSQ when a permalink changes</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$dsq_prev_permalinks = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_prev_permalink($post_id) {&nbsp;</div></li><li><div>  $post = get_post($post_id);&nbsp;</div></li><li><div>  <span class="comment">// if post not published, return</span>&nbsp;</div></li><li><div>  if ($post-&gt;post_status != 'publish') {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  global $dsq_prev_permalinks;&nbsp;</div></li><li><div>  $dsq_prev_permalinks['post_'.$post_id] = get_permalink($post_id);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('pre_post_update', 'dsq_prev_permalink');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_check_permalink($post_id) {&nbsp;</div></li><li><div>  global $dsq_prev_permalinks;&nbsp;</div></li><li><div>  if (!empty($dsq_prev_permalinks['post_'.$post_id]) &&&nbsp;</div></li><li><div>      $dsq_prev_permalinks['post_'.$post_id] != get_permalink($post_id)&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>      $post = get_post($post_id);&nbsp;</div></li><li><div>      dsq_update_permalink($post);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('edit_post', 'dsq_check_permalink');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Only replace comments if the disqus_forum_url option is set.</span>&nbsp;</div></li><li><div>add_filter('comments_template', 'dsq_comments_template');&nbsp;</div></li><li><div>add_filter('comments_number', 'dsq_comments_text');&nbsp;</div></li><li><div>add_filter('get_comments_number', 'dsq_comments_number');&nbsp;</div></li><li><div>add_filter('bloginfo_url', 'dsq_bloginfo_url');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * JSON ENCODE for PHP &lt; 5.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * Checks if json_encode is not available and defines json_encode</span>&nbsp;</div></li><li><div><span class="comment"> * to use php_json_encode in its stead</span>&nbsp;</div></li><li><div><span class="comment"> * Works on iteratable objects as well - stdClass is iteratable, so all WP objects are gonna be iteratable</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if(!function_exists('cf_json_encode')) {&nbsp;</div></li><li><div>  function cf_json_encode($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// json_encode is sending an application/x-javascript header on Joyent servers</span>&nbsp;</div></li><li><div>      <span class="comment">// for some unknown reason.</span>&nbsp;</div></li><li><div>      return cfjson_encode($data);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function cfjson_encode_string($str) {&nbsp;</div></li><li><div>      if(is_bool($str)) {&nbsp;</div></li><li><div>          return $str ? 'true' : 'false';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return str_replace(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              '&quot;'&nbsp;</div></li><li><div> , '/'&nbsp;</div></li><li><div> , &quot;\n&quot;&nbsp;</div></li><li><div> , &quot;\r&quot;&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> , array(&nbsp;</div></li><li><div>              '\&quot;'&nbsp;</div></li><li><div> , '\/'&nbsp;</div></li><li><div> , '\n'&nbsp;</div></li><li><div> , '\r'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> , $str&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function cfjson_encode($arr) {&nbsp;</div></li><li><div>      $json_str = '';&nbsp;</div></li><li><div>      if (is_array($arr)) {&nbsp;</div></li><li><div>          $pure_array = true;&nbsp;</div></li><li><div>          $array_length = count($arr);&nbsp;</div></li><li><div>          for ( $i = 0; $i &lt; $array_length ; $i++) {&nbsp;</div></li><li><div>              if (!isset($arr[$i])) {&nbsp;</div></li><li><div>                  $pure_array = false;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($pure_array) {&nbsp;</div></li><li><div>              $json_str = '[';&nbsp;</div></li><li><div>              $temp = array();&nbsp;</div></li><li><div>              for ($i=0; $i &lt; $array_length; $i++) {&nbsp;</div></li><li><div>                  $temp[] = sprintf(&quot;%s&quot;, cfjson_encode($arr[$i]));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $json_str .= implode(', ', $temp);&nbsp;</div></li><li><div>              $json_str .=&quot;]&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $json_str = '{';&nbsp;</div></li><li><div>              $temp = array();&nbsp;</div></li><li><div>              foreach ($arr as $key =&gt; $value) {&nbsp;</div></li><li><div>                  $temp[] = sprintf(&quot;\&quot;%s\&quot;:%s&quot;, $key, cfjson_encode($value));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $json_str .= implode(', ', $temp);&nbsp;</div></li><li><div>              $json_str .= '}';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (is_object($arr)) {&nbsp;</div></li><li><div>          $json_str = '{';&nbsp;</div></li><li><div>          $temp = array();&nbsp;</div></li><li><div>          foreach ($arr as $k =&gt; $v) {&nbsp;</div></li><li><div>              $temp[] = '&quot;'.$k.'&quot;:'.cfjson_encode($v);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $json_str .= implode(', ', $temp);&nbsp;</div></li><li><div>          $json_str .= '}';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (is_string($arr)) {&nbsp;</div></li><li><div>          $json_str = '&quot;'. cfjson_encode_string($arr) . '&quot;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (is_numeric($arr)) {&nbsp;</div></li><li><div>          $json_str = $arr;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (is_bool($arr)) {&nbsp;</div></li><li><div>          $json_str = $arr ? 'true' : 'false';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $json_str = '&quot;'. cfjson_encode_string($arr) . '&quot;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $json_str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Single Sign-on Integration</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_sso_login() {&nbsp;</div></li><li><div>  global $current_site;&nbsp;</div></li><li><div>  $sitename = get_bloginfo('name');&nbsp;</div></li><li><div>  $siteurl = site_url();&nbsp;</div></li><li><div>  $button = get_option('disqus_sso_button');&nbsp;</div></li><li><div>  $sso_login_str = 'this.sso = {&nbsp;</div></li><li><div>        name: &quot;' . esc_js( $sitename ) . '&quot;, &nbsp;</div></li><li><div>        button: &quot;' . $button . '&quot;, &nbsp;</div></li><li><div>        url: &quot;' . $siteurl . '/wp-login.php&quot;, &nbsp;</div></li><li><div>        logout: &quot;' . $siteurl . '/wp-login.php?action=logout&quot;, &nbsp;</div></li><li><div>        width: &quot;800&quot;, &nbsp;</div></li><li><div>        height: &quot;700&quot;&nbsp;</div></li><li><div>  };';&nbsp;</div></li><li><div>  return $sso_login_str;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_sso() {&nbsp;</div></li><li><div>  if ($key = get_option('disqus_partner_key')) {&nbsp;</div></li><li><div>      <span class="comment">// use old style SSO</span>&nbsp;</div></li><li><div>      $new = false;&nbsp;</div></li><li><div>  } elseif (($key = get_option('disqus_secret_key')) && ($public = get_option('disqus_public_key'))) {&nbsp;</div></li><li><div>      <span class="comment">// use new style SSO</span>&nbsp;</div></li><li><div>      $new = true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// sso is not configured</span>&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  global $current_user, $dsq_api;&nbsp;</div></li><li><div>  get_currentuserinfo();&nbsp;</div></li><li><div>  if ($current_user-&gt;ID) {&nbsp;</div></li><li><div>      $avatar_tag = get_avatar($current_user-&gt;ID);&nbsp;</div></li><li><div>      $avatar_data = array();&nbsp;</div></li><li><div>      preg_match('/(src)=((\'|&quot;)[^(\'|&quot;)]*(\'|&quot;))/i', $avatar_tag, $avatar_data);&nbsp;</div></li><li><div>      $avatar = str_replace(array('&quot;', &quot;'&quot;), '', $avatar_data[2]);&nbsp;</div></li><li><div>      $user_data = array(&nbsp;</div></li><li><div>          'username' =&gt; $current_user-&gt;display_name, &nbsp;</div></li><li><div>          'id' =&gt; $current_user-&gt;ID, &nbsp;</div></li><li><div>          'avatar' =&gt; $avatar, &nbsp;</div></li><li><div>          'email' =&gt; $current_user-&gt;user_email, &nbsp;</div></li><li><div>          'url' =&gt; $current_user-&gt;user_url, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else {&nbsp;</div></li><li><div>      $user_data = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $user_data = base64_encode(cf_json_encode($user_data));&nbsp;</div></li><li><div>  $time = time();&nbsp;</div></li><li><div>  $hmac = dsq_hmacsha1($user_data.' '.$time, $key);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payload = $user_data.' '.$hmac.' '.$time;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($new) {&nbsp;</div></li><li><div>      return array('remote_auth_s3'=&gt;$payload, 'api_key'=&gt;$public);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return array('remote_auth_s2'=&gt;$payload);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// from: http://www.php.net/manual/en/function.sha1.php#39492</span>&nbsp;</div></li><li><div><span class="comment">// Calculate HMAC-SHA1 according to RFC2104</span>&nbsp;</div></li><li><div><span class="comment">// http://www.ietf.org/rfc/rfc2104.txt</span>&nbsp;</div></li><li><div>function dsq_hmacsha1($data, $key) {&nbsp;</div></li><li><div>  $blocksize=64;&nbsp;</div></li><li><div>  $hashfunc='sha1';&nbsp;</div></li><li><div>  if (strlen($key)&gt;$blocksize)&nbsp;</div></li><li><div>      $key=pack('H*', $hashfunc($key));&nbsp;</div></li><li><div>  $key=str_pad($key, $blocksize, chr(0x00));&nbsp;</div></li><li><div>  $ipad=str_repeat(chr(0x36), $blocksize);&nbsp;</div></li><li><div>  $opad=str_repeat(chr(0x5c), $blocksize);&nbsp;</div></li><li><div>  $hmac = pack(&nbsp;</div></li><li><div>              'H*', $hashfunc(&nbsp;</div></li><li><div>                  ($key^$opad).pack(&nbsp;</div></li><li><div>                      'H*', $hashfunc(&nbsp;</div></li><li><div>                          ($key^$ipad).$data&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  return bin2hex($hmac);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_identifier_for_post($post) {&nbsp;</div></li><li><div>  return $post-&gt;ID . ' ' . $post-&gt;guid;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_title_for_post($post) {&nbsp;</div></li><li><div>  $title = get_the_title($post);&nbsp;</div></li><li><div>  $title = strip_tags($title, DISQUS_ALLOWED_HTML);&nbsp;</div></li><li><div>  return $title;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_link_for_post($post) {&nbsp;</div></li><li><div>  return get_permalink($post);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_does_need_update() {&nbsp;</div></li><li><div>  $version = (string)get_option('disqus_version');&nbsp;</div></li><li><div>  if (empty($version)) {&nbsp;</div></li><li><div>      $version = '0';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (version_compare($version, '2.49', '&lt;')) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function dsq_install($allow_database_install=true) {&nbsp;</div></li><li><div>  global $wpdb, $userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $version = (string)get_option('disqus_version');&nbsp;</div></li><li><div>  if (!$version) {&nbsp;</div></li><li><div>      $version = '0';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($allow_database_install)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      dsq_install_database($version);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (version_compare($version, DISQUS_VERSION, '=')) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if this is a new install, we should not set disqus active</span>&nbsp;</div></li><li><div>  if ($version == '0') {&nbsp;</div></li><li><div>      add_option('disqus_active', '0');&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      add_option('disqus_active', '1');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option('disqus_version', DISQUS_VERSION);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Initializes the database if it's not already present.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dsq_install_database($version=0) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( version_compare($version, '2.49', '&lt;') && !is_wp_vip() ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;CREATE INDEX disqus_dupecheck ON `&quot;.$wpdb-&gt;prefix.&quot;commentmeta` (meta_key, meta_value(11));&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>function dsq_reset_database($version=0) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( version_compare($version, '2.49', '&gt;=') && !is_wp_vip() ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;DROP INDEX disqus_dupecheck ON `&quot;.$wpdb-&gt;prefix.&quot;commentmeta`;&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* Disable internal WordPress commenting if Disqus is enabled - this prevents spam bots from</span>&nbsp;</div></li><li><div><span class="comment">* commenting using POST requests to /wp-comments-post.php.</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @param int $comment_post_ID</span>&nbsp;</div></li><li><div><span class="comment">* @return int</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function dsq_pre_comment_on_post($comment_post_ID) {&nbsp;</div></li><li><div>  if (dsq_can_replace()) {&nbsp;</div></li><li><div>      wp_die( dsq_i('Sorry, the built-in commenting system is disabled because Disqus is active.') );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $comment_post_ID;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action('pre_comment_on_post', 'dsq_pre_comment_on_post');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Disqus Comment System</li><li><span></span>2.87</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>