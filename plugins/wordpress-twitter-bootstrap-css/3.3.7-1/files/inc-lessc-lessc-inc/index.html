<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.3.7-1" data-slug="wordpress-twitter-bootstrap-css" data-type="file" data-id="31873"><head xmlns="http://www.w3.org/1999/xhtml"><title> inc-lessc-lessc-inc | file | WordPress Twitter Bootstrap Css | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wordpress-twitter-bootstrap-css, 3.3.7-1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=1809244eeb255a56bc3dfefed3d1fea3' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/inc-lessc-lessc-inc/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-lessc-lessc-inc%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-lessc-lessc-inc%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wordpress-twitter-bootstrap-css-3.3.7-1-file-inc-lessc-lessc-inc","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="inc-lessc-lessc-inc" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wordpress-twitter-bootstrap-c&hellip;." href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/" class="plugin"><span property="name">wordpress-twitter-bootstrap-c&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.3.7-1." href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/" class="H_VERSION"><span property="name">3.3.7-1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">inc-lessc-lessc-inc</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="116"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/all/" title="All">All <span class="count badge">116</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="17"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/hooks/" title="Hooks">Hooks <span class="count badge">17</span></a></li><li class="" data-id="action" data-count="4"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/actions/" title="Actions">Actions <span class="count badge">4</span></a></li><li class="" data-id="filter" data-count="13"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/filters/" title="Filters">Filters <span class="count badge">13</span></a></li><li class="" data-id="class" data-count="88"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/classes/" title="Classes">Classes <span class="count badge">88</span></a></li><li class="" data-id="constant" data-count="1"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/constants/" title="Constants">Constants <span class="count badge">1</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="2"><a href="http://hookr.io/plugins/wordpress-twitter-bootstrap-css/3.3.7-1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">2</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/inc/lessc/lessc.inc.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * lessphp v0.4.0</span>&nbsp;</div></li><li><div><span class="comment"> * http://leafo.net/lessphp</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * LESS css compiler, adapted from http://lesscss.org</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Copyright 2012, Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> * Licensed under MIT or GPLv3, see LICENSE</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The less compiler and parser.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Converting LESS to CSS is a three stage process. The incoming file is parsed</span>&nbsp;</div></li><li><div><span class="comment"> * by `lessc_parser` into a syntax tree, then it is compiled into another tree</span>&nbsp;</div></li><li><div><span class="comment"> * representing the CSS structure by `lessc`. The CSS tree is fed into a</span>&nbsp;</div></li><li><div><span class="comment"> * formatter, like `lessc_formatter` which then outputs CSS as a string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * During the first compile, all values are *reduced*, which means that their</span>&nbsp;</div></li><li><div><span class="comment"> * types are brought to the lowest form before being dump as strings. This</span>&nbsp;</div></li><li><div><span class="comment"> * handles math equations, variable dereferences, and the like.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `parse` function of `lessc` is the entry point.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In summary:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `lessc` class creates an intstance of the parser, feeds it LESS code, </span>&nbsp;</div></li><li><div><span class="comment"> * then transforms the resulting tree to a CSS tree. This class also holds the</span>&nbsp;</div></li><li><div><span class="comment"> * evaluation context, such as all available mixins and variables at any given</span>&nbsp;</div></li><li><div><span class="comment"> * time.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `lessc_parser` class is only concerned with parsing its input.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `lessc_formatter` takes a CSS tree, and dumps it to a formatted string, </span>&nbsp;</div></li><li><div><span class="comment"> * handling things like indentation.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class lessc {&nbsp;</div></li><li><div>  static public $VERSION = &quot;v0.4.0&quot;;&nbsp;</div></li><li><div>  static protected $TRUE = array(&quot;keyword&quot;, &quot;true&quot;);&nbsp;</div></li><li><div>  static protected $FALSE = array(&quot;keyword&quot;, &quot;false&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $libFunctions = array();&nbsp;</div></li><li><div>  protected $registeredVars = array();&nbsp;</div></li><li><div>  protected $preserveComments = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $vPrefix = '@'; <span class="comment">// prefix of abstract properties</span>&nbsp;</div></li><li><div>  public $mPrefix = '$'; <span class="comment">// prefix of abstract blocks</span>&nbsp;</div></li><li><div>  public $parentSelector = '&';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $importDisabled = false;&nbsp;</div></li><li><div>  public $importDir = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $numberPrecision = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $allParsedFiles = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set to the parser that generated the current line when compiling</span>&nbsp;</div></li><li><div>  <span class="comment">// so we know how to create error messages</span>&nbsp;</div></li><li><div>  protected $sourceParser = null;&nbsp;</div></li><li><div>  protected $sourceLoc = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public $defaultValue = array(&quot;keyword&quot;, &quot;&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $nextImportId = 0; <span class="comment">// uniquely identify imports</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// attempts to find the path of an import url, returns null for css files</span>&nbsp;</div></li><li><div>  protected function findImport($url) {&nbsp;</div></li><li><div>      foreach ((array)$this-&gt;importDir as $dir) {&nbsp;</div></li><li><div>          $full = $dir.(substr($dir, -1) != '/' ? '/' : '').$url;&nbsp;</div></li><li><div>          if ($this-&gt;fileExists($file = $full.'.less') || $this-&gt;fileExists($file = $full)) {&nbsp;</div></li><li><div>              return $file;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function fileExists($name) {&nbsp;</div></li><li><div>      return is_file($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function compressList($items, $delim) {&nbsp;</div></li><li><div>      if (!isset($items[1]) && isset($items[0])) return $items[0];&nbsp;</div></li><li><div>      else return array('list', $delim, $items);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function preg_quote($what) {&nbsp;</div></li><li><div>      return preg_quote($what, '/');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function tryImport($importPath, $parentBlock, $out) {&nbsp;</div></li><li><div>      if ($importPath[0] == &quot;function&quot; && $importPath[1] == &quot;url&quot;) {&nbsp;</div></li><li><div>          $importPath = $this-&gt;flattenList($importPath[2]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $str = $this-&gt;coerceString($importPath);&nbsp;</div></li><li><div>      if ($str === null) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = $this-&gt;compileValue($this-&gt;lib_e($str));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// don't import if it ends in css</span>&nbsp;</div></li><li><div>      if (substr_compare($url, '.css', -4, 4) === 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $realPath = $this-&gt;findImport($url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($realPath === null) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;importDisabled) {&nbsp;</div></li><li><div>          return array(false, &quot;<span class="comment">/* import disabled */</span>&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($this-&gt;allParsedFiles[realpath($realPath)])) {&nbsp;</div></li><li><div>          return array(false, null);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;addParsedFile($realPath);&nbsp;</div></li><li><div>      $parser = $this-&gt;makeParser($realPath);&nbsp;</div></li><li><div>      $root = $parser-&gt;parse(file_get_contents($realPath));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// set the parents of all the block props</span>&nbsp;</div></li><li><div>      foreach ($root-&gt;props as $prop) {&nbsp;</div></li><li><div>          if ($prop[0] == &quot;block&quot;) {&nbsp;</div></li><li><div>              $prop[1]-&gt;parent = $parentBlock;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// copy mixins into scope, set their parents</span>&nbsp;</div></li><li><div>      <span class="comment">// bring blocks from import into current block</span>&nbsp;</div></li><li><div>      <span class="comment">// TODO: need to mark the source parser    these came from this file</span>&nbsp;</div></li><li><div>      foreach ($root-&gt;children as $childName =&gt; $child) {&nbsp;</div></li><li><div>          if (isset($parentBlock-&gt;children[$childName])) {&nbsp;</div></li><li><div>              $parentBlock-&gt;children[$childName] = array_merge(&nbsp;</div></li><li><div>                  $parentBlock-&gt;children[$childName], &nbsp;</div></li><li><div>                  $child);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $parentBlock-&gt;children[$childName] = $child;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pi = pathinfo($realPath);&nbsp;</div></li><li><div>      $dir = $pi[&quot;dirname&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($top, $bottom) = $this-&gt;sortProps($root-&gt;props, true);&nbsp;</div></li><li><div>      $this-&gt;compileImportedProps($top, $parentBlock, $out, $parser, $dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(true, $bottom, $parser, $dir);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileImportedProps($props, $block, $out, $sourceParser, $importDir) {&nbsp;</div></li><li><div>      $oldSourceParser = $this-&gt;sourceParser;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldImport = $this-&gt;importDir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// TODO: this is because the importDir api is stupid</span>&nbsp;</div></li><li><div>      $this-&gt;importDir = (array)$this-&gt;importDir;&nbsp;</div></li><li><div>      array_unshift($this-&gt;importDir, $importDir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($props as $prop) {&nbsp;</div></li><li><div>          $this-&gt;compileProp($prop, $block, $out);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;importDir = $oldImport;&nbsp;</div></li><li><div>      $this-&gt;sourceParser = $oldSourceParser;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recursively compiles a block.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * A block is analogous to a CSS block in most cases. A single LESS document</span>&nbsp;</div></li><li><div><span class="comment">   * is encapsulated in a block when parsed, but it does not have parent tags</span>&nbsp;</div></li><li><div><span class="comment">   * so all of it's children appear on the root level when compiled.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Blocks are made up of props and children.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Props are property instructions, array tuples which describe an action</span>&nbsp;</div></li><li><div><span class="comment">   * to be taken, eg. write a property, set a variable, mixin a block.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The children of a block are just all the blocks that are defined within.</span>&nbsp;</div></li><li><div><span class="comment">   * This is used to look up mixins when performing a mixin.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Compiling the block involves pushing a fresh environment on the stack, </span>&nbsp;</div></li><li><div><span class="comment">   * and iterating through the props, compiling each one.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * See lessc::compileProp()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function compileBlock($block) {&nbsp;</div></li><li><div>      switch ($block-&gt;type) {&nbsp;</div></li><li><div>      case &quot;root&quot;:&nbsp;</div></li><li><div>          $this-&gt;compileRoot($block);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case null:&nbsp;</div></li><li><div>          $this-&gt;compileCSSBlock($block);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;media&quot;:&nbsp;</div></li><li><div>          $this-&gt;compileMedia($block);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;directive&quot;:&nbsp;</div></li><li><div>          $name = &quot;@&quot; . $block-&gt;name;&nbsp;</div></li><li><div>          if (!empty($block-&gt;value)) {&nbsp;</div></li><li><div>              $name .= &quot; &quot; . $this-&gt;compileValue($this-&gt;reduce($block-&gt;value));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;compileNestedBlock($block, array($name));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;unknown block type: $block-&gt;type\n&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileCSSBlock($block) {&nbsp;</div></li><li><div>      $env = $this-&gt;pushEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $selectors = $this-&gt;compileSelectors($block-&gt;tags);&nbsp;</div></li><li><div>      $env-&gt;selectors = $this-&gt;multiplySelectors($selectors);&nbsp;</div></li><li><div>      $out = $this-&gt;makeOutputBlock(null, $env-&gt;selectors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope-&gt;children[] = $out;&nbsp;</div></li><li><div>      $this-&gt;compileProps($block, $out);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $block-&gt;scope = $env; <span class="comment"><span class="comment">// mixin</span>s carry scope with them!</span>&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileMedia($media) {&nbsp;</div></li><li><div>      $env = $this-&gt;pushEnv($media);&nbsp;</div></li><li><div>      $parentScope = $this-&gt;mediaParent($this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query = $this-&gt;compileMediaQuery($this-&gt;multiplyMedia($env));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;makeOutputBlock($media-&gt;type, array($query));&nbsp;</div></li><li><div>      $parentScope-&gt;children[] = $this-&gt;scope;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;compileProps($media, $this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($this-&gt;scope-&gt;lines) &gt; 0) {&nbsp;</div></li><li><div>          $orphanSelelectors = $this-&gt;findClosestSelectors();&nbsp;</div></li><li><div>          if (!is_null($orphanSelelectors)) {&nbsp;</div></li><li><div>              $orphan = $this-&gt;makeOutputBlock(null, $orphanSelelectors);&nbsp;</div></li><li><div>              $orphan-&gt;lines = $this-&gt;scope-&gt;lines;&nbsp;</div></li><li><div>              array_unshift($this-&gt;scope-&gt;children, $orphan);&nbsp;</div></li><li><div>              $this-&gt;scope-&gt;lines = array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;scope-&gt;parent;&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaParent($scope) {&nbsp;</div></li><li><div>      while (!empty($scope-&gt;parent)) {&nbsp;</div></li><li><div>          if (!empty($scope-&gt;type) && $scope-&gt;type != &quot;media&quot;) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $scope = $scope-&gt;parent;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $scope;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileNestedBlock($block, $selectors) {&nbsp;</div></li><li><div>      $this-&gt;pushEnv($block);&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;makeOutputBlock($block-&gt;type, $selectors);&nbsp;</div></li><li><div>      $this-&gt;scope-&gt;parent-&gt;children[] = $this-&gt;scope;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;compileProps($block, $this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;scope-&gt;parent;&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileRoot($root) {&nbsp;</div></li><li><div>      $this-&gt;pushEnv();&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;makeOutputBlock($root-&gt;type);&nbsp;</div></li><li><div>      $this-&gt;compileProps($root, $this-&gt;scope);&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileProps($block, $out) {&nbsp;</div></li><li><div>      foreach ($this-&gt;sortProps($block-&gt;props) as $prop) {&nbsp;</div></li><li><div>          $this-&gt;compileProp($prop, $block, $out);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out-&gt;lines = array_values(array_unique($out-&gt;lines));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function sortProps($props, $split = false) {&nbsp;</div></li><li><div>      $vars = array();&nbsp;</div></li><li><div>      $imports = array();&nbsp;</div></li><li><div>      $other = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($props as $prop) {&nbsp;</div></li><li><div>          switch ($prop[0]) {&nbsp;</div></li><li><div>          case &quot;assign&quot;:&nbsp;</div></li><li><div>              if (isset($prop[1][0]) && $prop[1][0] == $this-&gt;vPrefix) {&nbsp;</div></li><li><div>                  $vars[] = $prop;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $other[] = $prop;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;import&quot;:&nbsp;</div></li><li><div>              $id = self::$nextImportId++;&nbsp;</div></li><li><div>              $prop[] = $id;&nbsp;</div></li><li><div>              $imports[] = $prop;&nbsp;</div></li><li><div>              $other[] = array(&quot;import_mixin&quot;, $id);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $other[] = $prop;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($split) {&nbsp;</div></li><li><div>          return array(array_merge($vars, $imports), $other);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return array_merge($vars, $imports, $other);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileMediaQuery($queries) {&nbsp;</div></li><li><div>      $compiledQueries = array();&nbsp;</div></li><li><div>      foreach ($queries as $query) {&nbsp;</div></li><li><div>          $parts = array();&nbsp;</div></li><li><div>          foreach ($query as $q) {&nbsp;</div></li><li><div>              switch ($q[0]) {&nbsp;</div></li><li><div>              case &quot;mediaType&quot;:&nbsp;</div></li><li><div>                  $parts[] = implode(&quot; &quot;, array_slice($q, 1));&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;mediaExp&quot;:&nbsp;</div></li><li><div>                  if (isset($q[2])) {&nbsp;</div></li><li><div>                      $parts[] = &quot;($q[1]: &quot; .&nbsp;</div></li><li><div>                          $this-&gt;compileValue($this-&gt;reduce($q[2])) . &quot;)&quot;;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $parts[] = &quot;($q[1])&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;variable&quot;:&nbsp;</div></li><li><div>                  $parts[] = $this-&gt;compileValue($this-&gt;reduce($q));&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (count($parts) &gt; 0) {&nbsp;</div></li><li><div>              $compiledQueries[] =  implode(&quot; and &quot;, $parts);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = &quot;@media&quot;;&nbsp;</div></li><li><div>      if (!empty($parts)) {&nbsp;</div></li><li><div>          $out .= &quot; &quot; .&nbsp;</div></li><li><div>              implode($this-&gt;formatter-&gt;selectorSeparator, $compiledQueries);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function multiplyMedia($env, $childQueries = null) {&nbsp;</div></li><li><div>      if (is_null($env) ||&nbsp;</div></li><li><div>          !empty($env-&gt;block-&gt;type) && $env-&gt;block-&gt;type != &quot;media&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return $childQueries;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// plain old block, skip</span>&nbsp;</div></li><li><div>      if (empty($env-&gt;block-&gt;type)) {&nbsp;</div></li><li><div>          return $this-&gt;multiplyMedia($env-&gt;parent, $childQueries);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array();&nbsp;</div></li><li><div>      $queries = $env-&gt;block-&gt;queries;&nbsp;</div></li><li><div>      if (is_null($childQueries)) {&nbsp;</div></li><li><div>          $out = $queries;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          foreach ($queries as $parent) {&nbsp;</div></li><li><div>              foreach ($childQueries as $child) {&nbsp;</div></li><li><div>                  $out[] = array_merge($parent, $child);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;multiplyMedia($env-&gt;parent, $out);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function expandParentSelectors(&$tag, $replace) {&nbsp;</div></li><li><div>      $parts = explode(&quot;$&$&quot;, $tag);&nbsp;</div></li><li><div>      $count = 0;&nbsp;</div></li><li><div>      foreach ($parts as &$part) {&nbsp;</div></li><li><div>          $part = str_replace($this-&gt;parentSelector, $replace, $part, $c);&nbsp;</div></li><li><div>          $count += $c;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $tag = implode($this-&gt;parentSelector, $parts);&nbsp;</div></li><li><div>      return $count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function findClosestSelectors() {&nbsp;</div></li><li><div>      $env = $this-&gt;env;&nbsp;</div></li><li><div>      $selectors = null;&nbsp;</div></li><li><div>      while ($env !== null) {&nbsp;</div></li><li><div>          if (isset($env-&gt;selectors)) {&nbsp;</div></li><li><div>              $selectors = $env-&gt;selectors;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $env = $env-&gt;parent;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $selectors;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// multiply $selectors against the nearest selectors in env</span>&nbsp;</div></li><li><div>  protected function multiplySelectors($selectors) {&nbsp;</div></li><li><div>      <span class="comment">// find parent selectors</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parentSelectors = $this-&gt;findClosestSelectors();&nbsp;</div></li><li><div>      if (is_null($parentSelectors)) {&nbsp;</div></li><li><div>          <span class="comment">// kill parent reference in top level selector</span>&nbsp;</div></li><li><div>          foreach ($selectors as &$s) {&nbsp;</div></li><li><div>              $this-&gt;expandParentSelectors($s, &quot;&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $selectors;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array();&nbsp;</div></li><li><div>      foreach ($parentSelectors as $parent) {&nbsp;</div></li><li><div>          foreach ($selectors as $child) {&nbsp;</div></li><li><div>              $count = $this-&gt;expandParentSelectors($child, $parent);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// don't prepend the parent tag if & was used</span>&nbsp;</div></li><li><div>              if ($count &gt; 0) {&nbsp;</div></li><li><div>                  $out[] = trim($child);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $out[] = trim($parent . ' ' . $child);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// reduces selector expressions</span>&nbsp;</div></li><li><div>  protected function compileSelectors($selectors) {&nbsp;</div></li><li><div>      $out = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($selectors as $s) {&nbsp;</div></li><li><div>          if (is_array($s)) {&nbsp;</div></li><li><div>              list(, $value) = $s;&nbsp;</div></li><li><div>              $out[] = trim($this-&gt;compileValue($this-&gt;reduce($value)));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $out[] = $s;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function eq($left, $right) {&nbsp;</div></li><li><div>      return $left == $right;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function patternMatch($block, $orderedArgs, $keywordArgs) {&nbsp;</div></li><li><div>      <span class="comment">// match the guards if it has them</span>&nbsp;</div></li><li><div>      <span class="comment">// any one of the groups must have all its guards pass for a match</span>&nbsp;</div></li><li><div>      if (!empty($block-&gt;guards)) {&nbsp;</div></li><li><div>          $groupPassed = false;&nbsp;</div></li><li><div>          foreach ($block-&gt;guards as $guardGroup) {&nbsp;</div></li><li><div>              foreach ($guardGroup as $guard) {&nbsp;</div></li><li><div>                  $this-&gt;pushEnv();&nbsp;</div></li><li><div>                  $this-&gt;zipSetArgs($block-&gt;args, $orderedArgs, $keywordArgs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $negate = false;&nbsp;</div></li><li><div>                  if ($guard[0] == &quot;negate&quot;) {&nbsp;</div></li><li><div>                      $guard = $guard[1];&nbsp;</div></li><li><div>                      $negate = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $passed = $this-&gt;reduce($guard) == self::$TRUE;&nbsp;</div></li><li><div>                  if ($negate) $passed = !$passed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;popEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($passed) {&nbsp;</div></li><li><div>                      $groupPassed = true;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $groupPassed = false;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($groupPassed) break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$groupPassed) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($block-&gt;args)) {&nbsp;</div></li><li><div>          return $block-&gt;isVararg || empty($orderedArgs) && empty($keywordArgs);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $remainingArgs = $block-&gt;args;&nbsp;</div></li><li><div>      if ($keywordArgs) {&nbsp;</div></li><li><div>          $remainingArgs = array();&nbsp;</div></li><li><div>          foreach ($block-&gt;args as $arg) {&nbsp;</div></li><li><div>              if ($arg[0] == &quot;arg&quot; && isset($keywordArgs[$arg[1]])) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $remainingArgs[] = $arg;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $i = -1; <span class="comment">// no args</span>&nbsp;</div></li><li><div>      <span class="comment">// try to match by arity or by argument literal</span>&nbsp;</div></li><li><div>      foreach ($remainingArgs as $i =&gt; $arg) {&nbsp;</div></li><li><div>          switch ($arg[0]) {&nbsp;</div></li><li><div>          case &quot;lit&quot;:&nbsp;</div></li><li><div>              if (empty($orderedArgs[$i]) || !$this-&gt;eq($arg[1], $orderedArgs[$i])) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;arg&quot;:&nbsp;</div></li><li><div>              <span class="comment">// no arg and no default value</span>&nbsp;</div></li><li><div>              if (!isset($orderedArgs[$i]) && !isset($arg[2])) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;rest&quot;:&nbsp;</div></li><li><div>              $i--; <span class="comment">// rest can be empty</span>&nbsp;</div></li><li><div>              break 2;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($block-&gt;isVararg) {&nbsp;</div></li><li><div>          return true; <span class="comment">// not having enough is handled above</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $numMatched = $i + 1;&nbsp;</div></li><li><div>          <span class="comment">// greater than becuase default values always match</span>&nbsp;</div></li><li><div>          return $numMatched &gt;= count($orderedArgs);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function patternMatchAll($blocks, $orderedArgs, $keywordArgs, $skip=array()) {&nbsp;</div></li><li><div>      $matches = null;&nbsp;</div></li><li><div>      foreach ($blocks as $block) {&nbsp;</div></li><li><div>          <span class="comment">// skip seen blocks that don't have arguments</span>&nbsp;</div></li><li><div>          if (isset($skip[$block-&gt;id]) && !isset($block-&gt;args)) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;patternMatch($block, $orderedArgs, $keywordArgs)) {&nbsp;</div></li><li><div>              $matches[] = $block;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $matches;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// attempt to find blocks matched by path and args</span>&nbsp;</div></li><li><div>  protected function findBlocks($searchIn, $path, $orderedArgs, $keywordArgs, $seen=array()) {&nbsp;</div></li><li><div>      if ($searchIn == null) return null;&nbsp;</div></li><li><div>      if (isset($seen[$searchIn-&gt;id])) return null;&nbsp;</div></li><li><div>      $seen[$searchIn-&gt;id] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $name = $path[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($searchIn-&gt;children[$name])) {&nbsp;</div></li><li><div>          $blocks = $searchIn-&gt;children[$name];&nbsp;</div></li><li><div>          if (count($path) == 1) {&nbsp;</div></li><li><div>              $matches = $this-&gt;patternMatchAll($blocks, $orderedArgs, $keywordArgs, $seen);&nbsp;</div></li><li><div>              if (!empty($matches)) {&nbsp;</div></li><li><div>                  <span class="comment">// This will return all blocks that match in the closest</span>&nbsp;</div></li><li><div>                  <span class="comment">// scope that has any matching block, like lessjs</span>&nbsp;</div></li><li><div>                  return $matches;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $matches = array();&nbsp;</div></li><li><div>              foreach ($blocks as $subBlock) {&nbsp;</div></li><li><div>                  $subMatches = $this-&gt;findBlocks($subBlock, &nbsp;</div></li><li><div>                      array_slice($path, 1), $orderedArgs, $keywordArgs, $seen);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if (!is_null($subMatches)) {&nbsp;</div></li><li><div>                      foreach ($subMatches as $sm) {&nbsp;</div></li><li><div>                          $matches[] = $sm;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return count($matches) &gt; 0 ? $matches : null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($searchIn-&gt;parent === $searchIn) return null;&nbsp;</div></li><li><div>      return $this-&gt;findBlocks($searchIn-&gt;parent, $path, $orderedArgs, $keywordArgs, $seen);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// sets all argument names in $args to either the default value</span>&nbsp;</div></li><li><div>  <span class="comment">// or the one passed in through $values</span>&nbsp;</div></li><li><div>  protected function zipSetArgs($args, $orderedValues, $keywordValues) {&nbsp;</div></li><li><div>      $assignedValues = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $i = 0;&nbsp;</div></li><li><div>      foreach ($args as  $a) {&nbsp;</div></li><li><div>          if ($a[0] == &quot;arg&quot;) {&nbsp;</div></li><li><div>              if (isset($keywordValues[$a[1]])) {&nbsp;</div></li><li><div>                  <span class="comment">// has keyword arg</span>&nbsp;</div></li><li><div>                  $value = $keywordValues[$a[1]];&nbsp;</div></li><li><div>              } elseif (isset($orderedValues[$i])) {&nbsp;</div></li><li><div>                  <span class="comment">// has ordered arg</span>&nbsp;</div></li><li><div>                  $value = $orderedValues[$i];&nbsp;</div></li><li><div>                  $i++;&nbsp;</div></li><li><div>              } elseif (isset($a[2])) {&nbsp;</div></li><li><div>                  <span class="comment">// has default value</span>&nbsp;</div></li><li><div>                  $value = $a[2];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;throwError(&quot;Failed to assign arg &quot; . $a[1]);&nbsp;</div></li><li><div>                  $value = null; <span class="comment">// :(</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $value = $this-&gt;reduce($value);&nbsp;</div></li><li><div>              $this-&gt;set($a[1], $value);&nbsp;</div></li><li><div>              $assignedValues[] = $value;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// a lit</span>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check for a rest</span>&nbsp;</div></li><li><div>      $last = end($args);&nbsp;</div></li><li><div>      if ($last[0] == &quot;rest&quot;) {&nbsp;</div></li><li><div>          $rest = array_slice($orderedValues, count($args) - 1);&nbsp;</div></li><li><div>          $this-&gt;set($last[1], $this-&gt;reduce(array(&quot;list&quot;, &quot; &quot;, $rest)));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// wow is this the only true use of PHP's + operator for arrays?</span>&nbsp;</div></li><li><div>      $this-&gt;env-&gt;arguments = $assignedValues + $orderedValues;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// compile a prop and update $lines or $blocks appropriately</span>&nbsp;</div></li><li><div>  protected function compileProp($prop, $block, $out) {&nbsp;</div></li><li><div>      <span class="comment">// set error position context</span>&nbsp;</div></li><li><div>      $this-&gt;sourceLoc = isset($prop[-1]) ? $prop[-1] : -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ($prop[0]) {&nbsp;</div></li><li><div>      case 'assign':&nbsp;</div></li><li><div>          list(, $name, $value) = $prop;&nbsp;</div></li><li><div>          if ($name[0] == $this-&gt;vPrefix) {&nbsp;</div></li><li><div>              $this-&gt;set($name, $value);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $out-&gt;lines[] = $this-&gt;formatter-&gt;property($name, &nbsp;</div></li><li><div>                      $this-&gt;compileValue($this-&gt;reduce($value)));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'block':&nbsp;</div></li><li><div>          list(, $child) = $prop;&nbsp;</div></li><li><div>          $this-&gt;compileBlock($child);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'mixin':&nbsp;</div></li><li><div>          list(, $path, $args, $suffix) = $prop;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $orderedArgs = array();&nbsp;</div></li><li><div>          $keywordArgs = array();&nbsp;</div></li><li><div>          foreach ((array)$args as $arg) {&nbsp;</div></li><li><div>              $argval = null;&nbsp;</div></li><li><div>              switch ($arg[0]) {&nbsp;</div></li><li><div>              case &quot;arg&quot;:&nbsp;</div></li><li><div>                  if (!isset($arg[2])) {&nbsp;</div></li><li><div>                      $orderedArgs[] = $this-&gt;reduce(array(&quot;variable&quot;, $arg[1]));&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $keywordArgs[$arg[1]] = $this-&gt;reduce($arg[2]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case &quot;lit&quot;:&nbsp;</div></li><li><div>                  $orderedArgs[] = $this-&gt;reduce($arg[1]);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $this-&gt;throwError(&quot;Unknown arg type: &quot; . $arg[0]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mixins = $this-&gt;findBlocks($block, $path, $orderedArgs, $keywordArgs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($mixins === null) {&nbsp;</div></li><li><div>              <span class="comment">// fwrite(STDERR, &quot;failed to find block: &quot;.implode(&quot; &gt; &quot;, $path).&quot;\n&quot;);</span>&nbsp;</div></li><li><div>              break; <span class="comment">// throw error here??</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($mixins as $mixin) {&nbsp;</div></li><li><div>              if ($mixin === $block && !$orderedArgs) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $haveScope = false;&nbsp;</div></li><li><div>              if (isset($mixin-&gt;parent-&gt;scope)) {&nbsp;</div></li><li><div>                  $haveScope = true;&nbsp;</div></li><li><div>                  $mixinParentEnv = $this-&gt;pushEnv();&nbsp;</div></li><li><div>                  $mixinParentEnv-&gt;storeParent = $mixin-&gt;parent-&gt;scope;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $haveArgs = false;&nbsp;</div></li><li><div>              if (isset($mixin-&gt;args)) {&nbsp;</div></li><li><div>                  $haveArgs = true;&nbsp;</div></li><li><div>                  $this-&gt;pushEnv();&nbsp;</div></li><li><div>                  $this-&gt;zipSetArgs($mixin-&gt;args, $orderedArgs, $keywordArgs);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $oldParent = $mixin-&gt;parent;&nbsp;</div></li><li><div>              if ($mixin != $block) $mixin-&gt;parent = $block;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ($this-&gt;sortProps($mixin-&gt;props) as $subProp) {&nbsp;</div></li><li><div>                  if ($suffix !== null &&&nbsp;</div></li><li><div>                      $subProp[0] == &quot;assign&quot; &&&nbsp;</div></li><li><div>                      is_string($subProp[1]) &&&nbsp;</div></li><li><div>                      $subProp[1]{0} != $this-&gt;vPrefix)&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      $subProp[2] = array(&nbsp;</div></li><li><div>                          'list', ' ', &nbsp;</div></li><li><div>                          array($subProp[2], array('keyword', $suffix))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;compileProp($subProp, $mixin, $out);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $mixin-&gt;parent = $oldParent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($haveArgs) $this-&gt;popEnv();&nbsp;</div></li><li><div>              if ($haveScope) $this-&gt;popEnv();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'raw':&nbsp;</div></li><li><div>          $out-&gt;lines[] = $prop[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;directive&quot;:&nbsp;</div></li><li><div>          list(, $name, $value) = $prop;&nbsp;</div></li><li><div>          $out-&gt;lines[] = &quot;@$name &quot; . $this-&gt;compileValue($this-&gt;reduce($value)).';';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;comment&quot;:&nbsp;</div></li><li><div>          $out-&gt;lines[] = $prop[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;import&quot;;&nbsp;</div></li><li><div>          list(, $importPath, $importId) = $prop;&nbsp;</div></li><li><div>          $importPath = $this-&gt;reduce($importPath);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!isset($this-&gt;env-&gt;imports)) {&nbsp;</div></li><li><div>              $this-&gt;env-&gt;imports = array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $result = $this-&gt;tryImport($importPath, $block, $out);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;env-&gt;imports[$importId] = $result === false ?&nbsp;</div></li><li><div>              array(false, &quot;@import &quot; . $this-&gt;compileValue($importPath).&quot;;&quot;) :&nbsp;</div></li><li><div>              $result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;import_mixin&quot;:&nbsp;</div></li><li><div>          list(, $importId) = $prop;&nbsp;</div></li><li><div>          $import = $this-&gt;env-&gt;imports[$importId];&nbsp;</div></li><li><div>          if ($import[0] === false) {&nbsp;</div></li><li><div>              if (isset($import[1])) {&nbsp;</div></li><li><div>                  $out-&gt;lines[] = $import[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              list(, $bottom, $parser, $importDir) = $import;&nbsp;</div></li><li><div>              $this-&gt;compileImportedProps($bottom, $block, $out, $parser, $importDir);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;unknown op: {$prop[0]}\n&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compiles a primitive value into a CSS property value.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Values in lessphp are typed by being wrapped in arrays, their format is</span>&nbsp;</div></li><li><div><span class="comment">   * typically:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     array(type, contents [, additional_contents]*)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The input is expected to be reduced. This function will not work on</span>&nbsp;</div></li><li><div><span class="comment">   * things like expressions and variables.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function compileValue($value) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case 'list':&nbsp;</div></li><li><div>          <span class="comment">// [1] - delimiter</span>&nbsp;</div></li><li><div>          <span class="comment">// [2] - array of values</span>&nbsp;</div></li><li><div>          return implode($value[1], array_map(array($this, 'compileValue'), $value[2]));&nbsp;</div></li><li><div>      case 'raw_color':&nbsp;</div></li><li><div>          if (!empty($this-&gt;formatter-&gt;compressColors)) {&nbsp;</div></li><li><div>              return $this-&gt;compileValue($this-&gt;coerceColor($value));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $value[1];&nbsp;</div></li><li><div>      case 'keyword':&nbsp;</div></li><li><div>          <span class="comment">// [1] - the keyword</span>&nbsp;</div></li><li><div>          return $value[1];&nbsp;</div></li><li><div>      case 'number':&nbsp;</div></li><li><div>          list(, $num, $unit) = $value;&nbsp;</div></li><li><div>          <span class="comment">// [1] - the number</span>&nbsp;</div></li><li><div>          <span class="comment">// [2] - the unit</span>&nbsp;</div></li><li><div>          if ($this-&gt;numberPrecision !== null) {&nbsp;</div></li><li><div>              $num = round($num, $this-&gt;numberPrecision);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $num . $unit;&nbsp;</div></li><li><div>      case 'string':&nbsp;</div></li><li><div>          <span class="comment">// [1] - contents of string (includes quotes)</span>&nbsp;</div></li><li><div>          list(, $delim, $content) = $value;&nbsp;</div></li><li><div>          foreach ($content as &$part) {&nbsp;</div></li><li><div>              if (is_array($part)) {&nbsp;</div></li><li><div>                  $part = $this-&gt;compileValue($part);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $delim . implode($content) . $delim;&nbsp;</div></li><li><div>      case 'color':&nbsp;</div></li><li><div>          <span class="comment">// [1] - red component (either number or a %)</span>&nbsp;</div></li><li><div>          <span class="comment">// [2] - green component</span>&nbsp;</div></li><li><div>          <span class="comment">// [3] - blue component</span>&nbsp;</div></li><li><div>          <span class="comment">// [4] - optional alpha component</span>&nbsp;</div></li><li><div>          list(, $r, $g, $b) = $value;&nbsp;</div></li><li><div>          $r = round($r);&nbsp;</div></li><li><div>          $g = round($g);&nbsp;</div></li><li><div>          $b = round($b);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (count($value) == 5 && $value[4] != 1) { <span class="comment">// rgba</span>&nbsp;</div></li><li><div>              return 'rgba('.$r.', '.$g.', '.$b.', '.$value[4].')';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $h = sprintf(&quot;#%02x%02x%02x&quot;, $r, $g, $b);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!empty($this-&gt;formatter-&gt;compressColors)) {&nbsp;</div></li><li><div>              <span class="comment">// Converting hex color to short notation (e.g. #003399 to #039)</span>&nbsp;</div></li><li><div>              if ($h[1] === $h[2] && $h[3] === $h[4] && $h[5] === $h[6]) {&nbsp;</div></li><li><div>                  $h = '#' . $h[1] . $h[3] . $h[5];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $h;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'function':&nbsp;</div></li><li><div>          list(, $name, $args) = $value;&nbsp;</div></li><li><div>          return $name.'('.$this-&gt;compileValue($args).')';&nbsp;</div></li><li><div>      default: <span class="comment">// assumed to be unit</span>&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;unknown value type: $value[0]&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_pow($args) {&nbsp;</div></li><li><div>      list($base, $exp) = $this-&gt;assertArgs($args, 2, &quot;pow&quot;);&nbsp;</div></li><li><div>      return pow($this-&gt;assertNumber($base), $this-&gt;assertNumber($exp));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_pi() {&nbsp;</div></li><li><div>      return pi();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_mod($args) {&nbsp;</div></li><li><div>      list($a, $b) = $this-&gt;assertArgs($args, 2, &quot;mod&quot;);&nbsp;</div></li><li><div>      return $this-&gt;assertNumber($a) % $this-&gt;assertNumber($b);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_tan($num) {&nbsp;</div></li><li><div>      return tan($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_sin($num) {&nbsp;</div></li><li><div>      return sin($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_cos($num) {&nbsp;</div></li><li><div>      return cos($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_atan($num) {&nbsp;</div></li><li><div>      $num = atan($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $num, &quot;rad&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_asin($num) {&nbsp;</div></li><li><div>      $num = asin($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $num, &quot;rad&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_acos($num) {&nbsp;</div></li><li><div>      $num = acos($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $num, &quot;rad&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_sqrt($num) {&nbsp;</div></li><li><div>      return sqrt($this-&gt;assertNumber($num));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_extract($value) {&nbsp;</div></li><li><div>      list($list, $idx) = $this-&gt;assertArgs($value, 2, &quot;extract&quot;);&nbsp;</div></li><li><div>      $idx = $this-&gt;assertNumber($idx);&nbsp;</div></li><li><div>      <span class="comment">// 1 indexed</span>&nbsp;</div></li><li><div>      if ($list[0] == &quot;list&quot; && isset($list[2][$idx - 1])) {&nbsp;</div></li><li><div>          return $list[2][$idx - 1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_isnumber($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;number&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_isstring($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;string&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_iscolor($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($this-&gt;coerceColor($value));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_iskeyword($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;keyword&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_ispixel($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;number&quot; && $value[2] == &quot;px&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_ispercentage($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;number&quot; && $value[2] == &quot;%&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_isem($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;number&quot; && $value[2] == &quot;em&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_isrem($value) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($value[0] == &quot;number&quot; && $value[2] == &quot;rem&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_rgbahex($color) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($color);&nbsp;</div></li><li><div>      if (is_null($color))&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;color expected for rgbahex&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return sprintf(&quot;#%02x%02x%02x%02x&quot;, &nbsp;</div></li><li><div>          isset($color[4]) ? $color[4]*255 : 255, &nbsp;</div></li><li><div>          $color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_argb($color) {&nbsp;</div></li><li><div>      return $this-&gt;lib_rgbahex($color);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// utility func to unquote a string</span>&nbsp;</div></li><li><div>  protected function lib_e($arg) {&nbsp;</div></li><li><div>      switch ($arg[0]) {&nbsp;</div></li><li><div>          case &quot;list&quot;:&nbsp;</div></li><li><div>              $items = $arg[2];&nbsp;</div></li><li><div>              if (isset($items[0])) {&nbsp;</div></li><li><div>                  return $this-&gt;lib_e($items[0]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return self::$defaultValue;&nbsp;</div></li><li><div>          case &quot;string&quot;:&nbsp;</div></li><li><div>              $arg[1] = &quot;&quot;;&nbsp;</div></li><li><div>              return $arg;&nbsp;</div></li><li><div>          case &quot;keyword&quot;:&nbsp;</div></li><li><div>              return $arg;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return array(&quot;keyword&quot;, $this-&gt;compileValue($arg));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib__sprintf($args) {&nbsp;</div></li><li><div>      if ($args[0] != &quot;list&quot;) return $args;&nbsp;</div></li><li><div>      $values = $args[2];&nbsp;</div></li><li><div>      $string = array_shift($values);&nbsp;</div></li><li><div>      $template = $this-&gt;compileValue($this-&gt;lib_e($string));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $i = 0;&nbsp;</div></li><li><div>      if (preg_match_all('/%[dsa]/', $template, $m)) {&nbsp;</div></li><li><div>          foreach ($m[0] as $match) {&nbsp;</div></li><li><div>              $val = isset($values[$i]) ?&nbsp;</div></li><li><div>                  $this-&gt;reduce($values[$i]) : array('keyword', '');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// lessjs compat, renders fully expanded color, not raw color</span>&nbsp;</div></li><li><div>              if ($color = $this-&gt;coerceColor($val)) {&nbsp;</div></li><li><div>                  $val = $color;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>              $rep = $this-&gt;compileValue($this-&gt;lib_e($val));&nbsp;</div></li><li><div>              $template = preg_replace('/'.self::preg_quote($match).'/', &nbsp;</div></li><li><div>                  $rep, $template, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $d = $string[0] == &quot;string&quot; ? $string[1] : '&quot;';&nbsp;</div></li><li><div>      return array(&quot;string&quot;, $d, array($template));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_floor($arg) {&nbsp;</div></li><li><div>      $value = $this-&gt;assertNumber($arg);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, floor($value), $arg[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_ceil($arg) {&nbsp;</div></li><li><div>      $value = $this-&gt;assertNumber($arg);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, ceil($value), $arg[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_round($arg) {&nbsp;</div></li><li><div>      $value = $this-&gt;assertNumber($arg);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, round($value), $arg[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_unit($arg) {&nbsp;</div></li><li><div>      if ($arg[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>          list($number, $newUnit) = $arg[2];&nbsp;</div></li><li><div>          return array(&quot;number&quot;, $this-&gt;assertNumber($number), &nbsp;</div></li><li><div>              $this-&gt;compileValue($this-&gt;lib_e($newUnit)));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return array(&quot;number&quot;, $this-&gt;assertNumber($arg), &quot;&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Helper function to get arguments for color manipulation functions.</span>&nbsp;</div></li><li><div><span class="comment">   * takes a list that contains a color like thing and a percentage</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function colorArgs($args) {&nbsp;</div></li><li><div>      if ($args[0] != 'list' || count($args[2]) &lt; 2) {&nbsp;</div></li><li><div>          return array(array('color', 0, 0, 0), 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      list($color, $delta) = $args[2];&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($color);&nbsp;</div></li><li><div>      $delta = floatval($delta[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array($color, $delta);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_darken($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color);&nbsp;</div></li><li><div>      $hsl[3] = $this-&gt;clamp($hsl[3] - $delta, 100);&nbsp;</div></li><li><div>      return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_lighten($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color);&nbsp;</div></li><li><div>      $hsl[3] = $this-&gt;clamp($hsl[3] + $delta, 100);&nbsp;</div></li><li><div>      return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_saturate($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color);&nbsp;</div></li><li><div>      $hsl[2] = $this-&gt;clamp($hsl[2] + $delta, 100);&nbsp;</div></li><li><div>      return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_desaturate($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color);&nbsp;</div></li><li><div>      $hsl[2] = $this-&gt;clamp($hsl[2] - $delta, 100);&nbsp;</div></li><li><div>      return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_spin($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hsl[1] = $hsl[1] + $delta % 360;&nbsp;</div></li><li><div>      if ($hsl[1] &lt; 0) $hsl[1] += 360;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_fadeout($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>      $color[4] = $this-&gt;clamp((isset($color[4]) ? $color[4] : 1) - $delta/100);&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_fadein($args) {&nbsp;</div></li><li><div>      list($color, $delta) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>      $color[4] = $this-&gt;clamp((isset($color[4]) ? $color[4] : 1) + $delta/100);&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_hue($color) {&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($this-&gt;assertColor($color));&nbsp;</div></li><li><div>      return round($hsl[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_saturation($color) {&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($this-&gt;assertColor($color));&nbsp;</div></li><li><div>      return round($hsl[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_lightness($color) {&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($this-&gt;assertColor($color));&nbsp;</div></li><li><div>      return round($hsl[3]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get the alpha of a color</span>&nbsp;</div></li><li><div>  <span class="comment">// defaults to 1 for non-colors or colors without an alpha</span>&nbsp;</div></li><li><div>  protected function lib_alpha($value) {&nbsp;</div></li><li><div>      if (!is_null($color = $this-&gt;coerceColor($value))) {&nbsp;</div></li><li><div>          return isset($color[4]) ? $color[4] : 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set the alpha of the color</span>&nbsp;</div></li><li><div>  protected function lib_fade($args) {&nbsp;</div></li><li><div>      list($color, $alpha) = $this-&gt;colorArgs($args);&nbsp;</div></li><li><div>      $color[4] = $this-&gt;clamp($alpha / 100.0);&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_percentage($arg) {&nbsp;</div></li><li><div>      $num = $this-&gt;assertNumber($arg);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $num*100, &quot;%&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// mixes two colors by weight</span>&nbsp;</div></li><li><div>  <span class="comment">// mix(@color1, @color2, [@weight: 50%]);</span>&nbsp;</div></li><li><div>  <span class="comment">// http://sass-lang.com/docs/yardoc/Sass/Script/Functions.html#mix-instance_method</span>&nbsp;</div></li><li><div>  protected function lib_mix($args) {&nbsp;</div></li><li><div>      if ($args[0] != &quot;list&quot; || count($args[2]) &lt; 2)&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;mix expects (color1, color2, weight)&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($first, $second) = $args[2];&nbsp;</div></li><li><div>      $first = $this-&gt;assertColor($first);&nbsp;</div></li><li><div>      $second = $this-&gt;assertColor($second);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $first_a = $this-&gt;lib_alpha($first);&nbsp;</div></li><li><div>      $second_a = $this-&gt;lib_alpha($second);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($args[2][2])) {&nbsp;</div></li><li><div>          $weight = $args[2][2][1] / 100.0;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $weight = 0.5;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $w = $weight * 2 - 1;&nbsp;</div></li><li><div>      $a = $first_a - $second_a;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $w1 = (($w * $a == -1 ? $w : ($w + $a)/(1 + $w * $a)) + 1) / 2.0;&nbsp;</div></li><li><div>      $w2 = 1.0 - $w1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new = array('color', &nbsp;</div></li><li><div>          $w1 * $first[1] + $w2 * $second[1], &nbsp;</div></li><li><div>          $w1 * $first[2] + $w2 * $second[2], &nbsp;</div></li><li><div>          $w1 * $first[3] + $w2 * $second[3], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($first_a != 1.0 || $second_a != 1.0) {&nbsp;</div></li><li><div>          $new[] = $first_a * $weight + $second_a * ($weight - 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;fixColor($new);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_contrast($args) {&nbsp;</div></li><li><div>      if ($args[0] != 'list' || count($args[2]) &lt; 3) {&nbsp;</div></li><li><div>          return array(array('color', 0, 0, 0), 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($inputColor, $darkColor, $lightColor) = $args[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inputColor = $this-&gt;assertColor($inputColor);&nbsp;</div></li><li><div>      $darkColor = $this-&gt;assertColor($darkColor);&nbsp;</div></li><li><div>      $lightColor = $this-&gt;assertColor($lightColor);&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($inputColor);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($hsl[3] &gt; 50) {&nbsp;</div></li><li><div>          return $darkColor;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $lightColor;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function assertColor($value, $error = &quot;expected color value&quot;) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($value);&nbsp;</div></li><li><div>      if (is_null($color)) $this-&gt;throwError($error);&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function assertNumber($value, $error = &quot;expecting number&quot;) {&nbsp;</div></li><li><div>      if ($value[0] == &quot;number&quot;) return $value[1];&nbsp;</div></li><li><div>      $this-&gt;throwError($error);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function assertArgs($value, $expectedArgs, $name=&quot;&quot;) {&nbsp;</div></li><li><div>      if ($expectedArgs == 1) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ($value[0] !== &quot;list&quot; || $value[1] != &quot;, &quot;) $this-&gt;throwError(&quot;expecting list&quot;);&nbsp;</div></li><li><div>          $values = $value[2];&nbsp;</div></li><li><div>          $numValues = count($values);&nbsp;</div></li><li><div>          if ($expectedArgs != $numValues) {&nbsp;</div></li><li><div>              if ($name) {&nbsp;</div></li><li><div>                  $name = $name . &quot;: &quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;${name}expecting $expectedArgs arguments, got $numValues&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $values;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function toHSL($color) {&nbsp;</div></li><li><div>      if ($color[0] == 'hsl') return $color;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = $color[1] / 255;&nbsp;</div></li><li><div>      $g = $color[2] / 255;&nbsp;</div></li><li><div>      $b = $color[3] / 255;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $min = min($r, $g, $b);&nbsp;</div></li><li><div>      $max = max($r, $g, $b);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $L = ($min + $max) / 2;&nbsp;</div></li><li><div>      if ($min == $max) {&nbsp;</div></li><li><div>          $S = $H = 0;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ($L &lt; 0.5)&nbsp;</div></li><li><div>              $S = ($max - $min)/($max + $min);&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $S = ($max - $min)/(2.0 - $max - $min);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($r == $max) $H = ($g - $b)/($max - $min);&nbsp;</div></li><li><div>          elseif ($g == $max) $H = 2.0 + ($b - $r)/($max - $min);&nbsp;</div></li><li><div>          elseif ($b == $max) $H = 4.0 + ($r - $g)/($max - $min);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array('hsl', &nbsp;</div></li><li><div>          ($H &lt; 0 ? $H + 6 : $H)*60, &nbsp;</div></li><li><div>          $S*100, &nbsp;</div></li><li><div>          $L*100, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($color) &gt; 4) $out[] = $color[4]; <span class="comment"><span class="comment">// copy alpha</span></span>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function toRGB_helper($comp, $temp1, $temp2) {&nbsp;</div></li><li><div>      if ($comp &lt; 0) $comp += 1.0;&nbsp;</div></li><li><div>      elseif ($comp &gt; 1) $comp -= 1.0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (6 * $comp &lt; 1) return $temp1 + ($temp2 - $temp1) * 6 * $comp;&nbsp;</div></li><li><div>      if (2 * $comp &lt; 1) return $temp2;&nbsp;</div></li><li><div>      if (3 * $comp &lt; 2) return $temp1 + ($temp2 - $temp1)*((2/3) - $comp) * 6;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $temp1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converts a hsl array into a color value in rgb.</span>&nbsp;</div></li><li><div><span class="comment">   * Expects H to be in range of 0 to 360, S and L in 0 to 100</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function toRGB($color) {&nbsp;</div></li><li><div>      if ($color[0] == 'color') return $color;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $H = $color[1] / 360;&nbsp;</div></li><li><div>      $S = $color[2] / 100;&nbsp;</div></li><li><div>      $L = $color[3] / 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($S == 0) {&nbsp;</div></li><li><div>          $r = $g = $b = $L;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $temp2 = $L &lt; 0.5 ?&nbsp;</div></li><li><div>              $L*(1.0 + $S) :&nbsp;</div></li><li><div>              $L + $S - $L * $S;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $temp1 = 2.0 * $L - $temp2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $r = $this-&gt;toRGB_helper($H + 1/3, $temp1, $temp2);&nbsp;</div></li><li><div>          $g = $this-&gt;toRGB_helper($H, $temp1, $temp2);&nbsp;</div></li><li><div>          $b = $this-&gt;toRGB_helper($H - 1/3, $temp1, $temp2);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $out = array('color', round($r*255), round($g*255), round($b*255));</span>&nbsp;</div></li><li><div>      $out = array('color', $r*255, $g*255, $b*255);&nbsp;</div></li><li><div>      if (count($color) &gt; 4) $out[] = $color[4]; <span class="comment"><span class="comment">// copy alpha</span></span>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function clamp($v, $max = 1, $min = 0) {&nbsp;</div></li><li><div>      return min($max, max($min, $v));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Convert the rgb, rgba, hsl color literals of function type</span>&nbsp;</div></li><li><div><span class="comment">   * as returned by the parser into values of color type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function funcToColor($func) {&nbsp;</div></li><li><div>      $fname = $func[1];&nbsp;</div></li><li><div>      if ($func[2][0] != 'list') return false; <span class="comment">// need a list of arguments</span>&nbsp;</div></li><li><div>      $rawComponents = $func[2][2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($fname == 'hsl' || $fname == 'hsla') {&nbsp;</div></li><li><div>          $hsl = array('hsl');&nbsp;</div></li><li><div>          $i = 0;&nbsp;</div></li><li><div>          foreach ($rawComponents as $c) {&nbsp;</div></li><li><div>              $val = $this-&gt;reduce($c);&nbsp;</div></li><li><div>              $val = isset($val[1]) ? floatval($val[1]) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($i == 0) $clamp = 360;&nbsp;</div></li><li><div>              elseif ($i &lt; 3) $clamp = 100;&nbsp;</div></li><li><div>              else $clamp = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $hsl[] = $this-&gt;clamp($val, $clamp);&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          while (count($hsl) &lt; 4) $hsl[] = 0;&nbsp;</div></li><li><div>          return $this-&gt;toRGB($hsl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ($fname == 'rgb' || $fname == 'rgba') {&nbsp;</div></li><li><div>          $components = array();&nbsp;</div></li><li><div>          $i = 1;&nbsp;</div></li><li><div>          foreach    ($rawComponents as $c) {&nbsp;</div></li><li><div>              $c = $this-&gt;reduce($c);&nbsp;</div></li><li><div>              if ($i &lt; 4) {&nbsp;</div></li><li><div>                  if ($c[0] == &quot;number&quot; && $c[2] == &quot;%&quot;) {&nbsp;</div></li><li><div>                      $components[] = 255 * ($c[1] / 100);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $components[] = floatval($c[1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ($i == 4) {&nbsp;</div></li><li><div>                  if ($c[0] == &quot;number&quot; && $c[2] == &quot;%&quot;) {&nbsp;</div></li><li><div>                      $components[] = 1.0 * ($c[1] / 100);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $components[] = floatval($c[1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          while (count($components) &lt; 3) $components[] = 0;&nbsp;</div></li><li><div>          array_unshift($components, 'color');&nbsp;</div></li><li><div>          return $this-&gt;fixColor($components);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function reduce($value, $forExpression = false) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;interpolate&quot;:&nbsp;</div></li><li><div>          $reduced = $this-&gt;reduce($value[1]);&nbsp;</div></li><li><div>          $var = $this-&gt;compileValue($reduced);&nbsp;</div></li><li><div>          $res = $this-&gt;reduce(array(&quot;variable&quot;, $this-&gt;vPrefix . $var));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($res[0] == &quot;raw_color&quot;) {&nbsp;</div></li><li><div>              $res = $this-&gt;coerceColor($res);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (empty($value[2])) $res = $this-&gt;lib_e($res);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $res;&nbsp;</div></li><li><div>      case &quot;variable&quot;:&nbsp;</div></li><li><div>          $key = $value[1];&nbsp;</div></li><li><div>          if (is_array($key)) {&nbsp;</div></li><li><div>              $key = $this-&gt;reduce($key);&nbsp;</div></li><li><div>              $key = $this-&gt;vPrefix . $this-&gt;compileValue($this-&gt;lib_e($key));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $seen =& $this-&gt;env-&gt;seenNames;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!empty($seen[$key])) {&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;infinite loop detected: $key&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $seen[$key] = true;&nbsp;</div></li><li><div>          $out = $this-&gt;reduce($this-&gt;get($key, self::$defaultValue));&nbsp;</div></li><li><div>          $seen[$key] = false;&nbsp;</div></li><li><div>          return $out;&nbsp;</div></li><li><div>      case &quot;list&quot;:&nbsp;</div></li><li><div>          foreach ($value[2] as &$item) {&nbsp;</div></li><li><div>              $item = $this-&gt;reduce($item, $forExpression);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;expression&quot;:&nbsp;</div></li><li><div>          return $this-&gt;evaluate($value);&nbsp;</div></li><li><div>      case &quot;string&quot;:&nbsp;</div></li><li><div>          foreach ($value[2] as &$part) {&nbsp;</div></li><li><div>              if (is_array($part)) {&nbsp;</div></li><li><div>                  $strip = $part[0] == &quot;variable&quot;;&nbsp;</div></li><li><div>                  $part = $this-&gt;reduce($part);&nbsp;</div></li><li><div>                  if ($strip) $part = $this-&gt;lib_e($part);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;escape&quot;:&nbsp;</div></li><li><div>          list(, $inner) = $value;&nbsp;</div></li><li><div>          return $this-&gt;lib_e($this-&gt;reduce($inner));&nbsp;</div></li><li><div>      case &quot;function&quot;:&nbsp;</div></li><li><div>          $color = $this-&gt;funcToColor($value);&nbsp;</div></li><li><div>          if ($color) return $color;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          list(, $name, $args) = $value;&nbsp;</div></li><li><div>          if ($name == &quot;%&quot;) $name = &quot;_sprintf&quot;;&nbsp;</div></li><li><div>          $f = isset($this-&gt;libFunctions[$name]) ?&nbsp;</div></li><li><div>              $this-&gt;libFunctions[$name] : array($this, 'lib_'.$name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_callable($f)) {&nbsp;</div></li><li><div>              if ($args[0] == 'list')&nbsp;</div></li><li><div>                  $args = self::compressList($args[2], $args[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ret = call_user_func($f, $this-&gt;reduce($args, true), $this);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (is_null($ret)) {&nbsp;</div></li><li><div>                  return array(&quot;string&quot;, &quot;&quot;, array(&nbsp;</div></li><li><div>                      $name, &quot;(&quot;, $args, &quot;)&quot;&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// convert to a typed value if the result is a php primitive</span>&nbsp;</div></li><li><div>              if (is_numeric($ret)) $ret = array('number', $ret, &quot;&quot;);&nbsp;</div></li><li><div>              elseif (!is_array($ret)) $ret = array('keyword', $ret);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $ret;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// plain function, reduce args</span>&nbsp;</div></li><li><div>          $value[2] = $this-&gt;reduce($value[2]);&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;unary&quot;:&nbsp;</div></li><li><div>          list(, $op, $exp) = $value;&nbsp;</div></li><li><div>          $exp = $this-&gt;reduce($exp);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($exp[0] == &quot;number&quot;) {&nbsp;</div></li><li><div>              switch ($op) {&nbsp;</div></li><li><div>              case &quot;+&quot;:&nbsp;</div></li><li><div>                  return $exp;&nbsp;</div></li><li><div>              case &quot;-&quot;:&nbsp;</div></li><li><div>                  $exp[1] *= -1;&nbsp;</div></li><li><div>                  return $exp;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return array(&quot;string&quot;, &quot;&quot;, array($op, $exp));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($forExpression) {&nbsp;</div></li><li><div>          switch ($value[0]) {&nbsp;</div></li><li><div>          case &quot;keyword&quot;:&nbsp;</div></li><li><div>              if ($color = $this-&gt;coerceColor($value)) {&nbsp;</div></li><li><div>                  return $color;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;raw_color&quot;:&nbsp;</div></li><li><div>              return $this-&gt;coerceColor($value);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// coerce a value for use in color operation</span>&nbsp;</div></li><li><div>  protected function coerceColor($value) {&nbsp;</div></li><li><div>      switch($value[0]) {&nbsp;</div></li><li><div>          case 'color': return $value;&nbsp;</div></li><li><div>          case 'raw_color':&nbsp;</div></li><li><div>              $c = array(&quot;color&quot;, 0, 0, 0);&nbsp;</div></li><li><div>              $colorStr = substr($value[1], 1);&nbsp;</div></li><li><div>              $num = hexdec($colorStr);&nbsp;</div></li><li><div>              $width = strlen($colorStr) == 3 ? 16 : 256;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              for ($i = 3; $i &gt; 0; $i--) { <span class="comment">// 3 2 1</span>&nbsp;</div></li><li><div>                  $t = $num % $width;&nbsp;</div></li><li><div>                  $num /= $width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $c[$i] = $t * (256/$width) + $t * floor(16/$width);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $c;&nbsp;</div></li><li><div>          case 'keyword':&nbsp;</div></li><li><div>              $name = $value[1];&nbsp;</div></li><li><div>              if (isset(self::$cssColors[$name])) {&nbsp;</div></li><li><div>                  $rgba = explode(', ', self::$cssColors[$name]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(isset($rgba[3]))&nbsp;</div></li><li><div>                      return array('color', $rgba[0], $rgba[1], $rgba[2], $rgba[3]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return array('color', $rgba[0], $rgba[1], $rgba[2]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// make something string like into a string</span>&nbsp;</div></li><li><div>  protected function coerceString($value) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;string&quot;:&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;keyword&quot;:&nbsp;</div></li><li><div>          return array(&quot;string&quot;, &quot;&quot;, array($value[1]));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// turn list of length 1 into value type</span>&nbsp;</div></li><li><div>  protected function flattenList($value) {&nbsp;</div></li><li><div>      if ($value[0] == &quot;list&quot; && count($value[2]) == 1) {&nbsp;</div></li><li><div>          return $this-&gt;flattenList($value[2][0]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function toBool($a) {&nbsp;</div></li><li><div>      if ($a) return self::$TRUE;&nbsp;</div></li><li><div>      else return self::$FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// evaluate an expression</span>&nbsp;</div></li><li><div>  protected function evaluate($exp) {&nbsp;</div></li><li><div>      list(, $op, $left, $right, $whiteBefore, $whiteAfter) = $exp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $left = $this-&gt;reduce($left, true);&nbsp;</div></li><li><div>      $right = $this-&gt;reduce($right, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($leftColor = $this-&gt;coerceColor($left)) {&nbsp;</div></li><li><div>          $left = $leftColor;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($rightColor = $this-&gt;coerceColor($right)) {&nbsp;</div></li><li><div>          $right = $rightColor;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ltype = $left[0];&nbsp;</div></li><li><div>      $rtype = $right[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// operators that work on all types</span>&nbsp;</div></li><li><div>      if ($op == &quot;and&quot;) {&nbsp;</div></li><li><div>          return $this-&gt;toBool($left == self::$TRUE && $right == self::$TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($op == &quot;=&quot;) {&nbsp;</div></li><li><div>          return $this-&gt;toBool($this-&gt;eq($left, $right) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($op == &quot;+&quot; && !is_null($str = $this-&gt;stringConcatenate($left, $right))) {&nbsp;</div></li><li><div>          return $str;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// type based operators</span>&nbsp;</div></li><li><div>      $fname = &quot;op_${ltype}_${rtype}&quot;;&nbsp;</div></li><li><div>      if (is_callable(array($this, $fname))) {&nbsp;</div></li><li><div>          $out = $this-&gt;$fname($op, $left, $right);&nbsp;</div></li><li><div>          if (!is_null($out)) return $out;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// make the expression look it did before being parsed</span>&nbsp;</div></li><li><div>      $paddedOp = $op;&nbsp;</div></li><li><div>      if ($whiteBefore) $paddedOp = &quot; &quot; . $paddedOp;&nbsp;</div></li><li><div>      if ($whiteAfter) $paddedOp .= &quot; &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;string&quot;, &quot;&quot;, array($left, $paddedOp, $right));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function stringConcatenate($left, $right) {&nbsp;</div></li><li><div>      if ($strLeft = $this-&gt;coerceString($left)) {&nbsp;</div></li><li><div>          if ($right[0] == &quot;string&quot;) {&nbsp;</div></li><li><div>              $right[1] = &quot;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $strLeft[2][] = $right;&nbsp;</div></li><li><div>          return $strLeft;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($strRight = $this-&gt;coerceString($right)) {&nbsp;</div></li><li><div>          array_unshift($strRight[2], $left);&nbsp;</div></li><li><div>          return $strRight;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// make sure a color's components don't go out of bounds</span>&nbsp;</div></li><li><div>  protected function fixColor($c) {&nbsp;</div></li><li><div>      foreach (range(1, 3) as $i) {&nbsp;</div></li><li><div>          if ($c[$i] &lt; 0) $c[$i] = 0;&nbsp;</div></li><li><div>          if ($c[$i] &gt; 255) $c[$i] = 255;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $c;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_number_color($op, $lft, $rgt) {&nbsp;</div></li><li><div>      if ($op == '+' || $op == '*') {&nbsp;</div></li><li><div>          return $this-&gt;op_color_number($op, $rgt, $lft);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_color_number($op, $lft, $rgt) {&nbsp;</div></li><li><div>      if ($rgt[0] == '%') $rgt[1] /= 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;op_color_color($op, $lft, &nbsp;</div></li><li><div>          array_fill(1, count($lft) - 1, $rgt[1]));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_color_color($op, $left, $right) {&nbsp;</div></li><li><div>      $out = array('color');&nbsp;</div></li><li><div>      $max = count($left) &gt; count($right) ? count($left) : count($right);&nbsp;</div></li><li><div>      foreach (range(1, $max - 1) as $i) {&nbsp;</div></li><li><div>          $lval = isset($left[$i]) ? $left[$i] : 0;&nbsp;</div></li><li><div>          $rval = isset($right[$i]) ? $right[$i] : 0;&nbsp;</div></li><li><div>          switch ($op) {&nbsp;</div></li><li><div>          case '+':&nbsp;</div></li><li><div>              $out[] = $lval + $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '-':&nbsp;</div></li><li><div>              $out[] = $lval - $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '*':&nbsp;</div></li><li><div>              $out[] = $lval * $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '%':&nbsp;</div></li><li><div>              $out[] = $lval % $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '/':&nbsp;</div></li><li><div>              if ($rval == 0) $this-&gt;throwError(&quot;evaluate error: can't divide by zero&quot;);&nbsp;</div></li><li><div>              $out[] = $lval / $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $this-&gt;throwError('evaluate error: color op number failed on op '.$op);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;fixColor($out);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function lib_red($color) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($color);&nbsp;</div></li><li><div>      if (is_null($color)) {&nbsp;</div></li><li><div>          $this-&gt;throwError('color expected for red()');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $color[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function lib_green($color) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($color);&nbsp;</div></li><li><div>      if (is_null($color)) {&nbsp;</div></li><li><div>          $this-&gt;throwError('color expected for green()');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $color[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function lib_blue($color) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($color);&nbsp;</div></li><li><div>      if (is_null($color)) {&nbsp;</div></li><li><div>          $this-&gt;throwError('color expected for blue()');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $color[3];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// operator on two numbers</span>&nbsp;</div></li><li><div>  protected function op_number_number($op, $left, $right) {&nbsp;</div></li><li><div>      $unit = empty($left[2]) ? $right[2] : $left[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $value = 0;&nbsp;</div></li><li><div>      switch ($op) {&nbsp;</div></li><li><div>      case '+':&nbsp;</div></li><li><div>          $value = $left[1] + $right[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '*':&nbsp;</div></li><li><div>          $value = $left[1] * $right[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '-':&nbsp;</div></li><li><div>          $value = $left[1] - $right[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '%':&nbsp;</div></li><li><div>          $value = $left[1] % $right[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '/':&nbsp;</div></li><li><div>          if ($right[1] == 0) $this-&gt;throwError('parse error: divide by zero');&nbsp;</div></li><li><div>          $value = $left[1] / $right[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '&lt;':&nbsp;</div></li><li><div>          return $this-&gt;toBool($left[1] &lt; $right[1]);&nbsp;</div></li><li><div>      case '&gt;':&nbsp;</div></li><li><div>          return $this-&gt;toBool($left[1] &gt; $right[1]);&nbsp;</div></li><li><div>      case '&gt;=':&nbsp;</div></li><li><div>          return $this-&gt;toBool($left[1] &gt;= $right[1]);&nbsp;</div></li><li><div>      case '=&lt;':&nbsp;</div></li><li><div>          return $this-&gt;toBool($left[1] &lt;= $right[1]);&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $this-&gt;throwError('parse error: unknown number operator: '.$op);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $value, $unit);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** environment functions */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function makeOutputBlock($type, $selectors = null) {&nbsp;</div></li><li><div>      $b = new stdclass;&nbsp;</div></li><li><div>      $b-&gt;lines = array();&nbsp;</div></li><li><div>      $b-&gt;children = array();&nbsp;</div></li><li><div>      $b-&gt;selectors = $selectors;&nbsp;</div></li><li><div>      $b-&gt;type = $type;&nbsp;</div></li><li><div>      $b-&gt;parent = $this-&gt;scope;&nbsp;</div></li><li><div>      return $b;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// the state of execution</span>&nbsp;</div></li><li><div>  protected function pushEnv($block = null) {&nbsp;</div></li><li><div>      $e = new stdclass;&nbsp;</div></li><li><div>      $e-&gt;parent = $this-&gt;env;&nbsp;</div></li><li><div>      $e-&gt;store = array();&nbsp;</div></li><li><div>      $e-&gt;block = $block;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = $e;&nbsp;</div></li><li><div>      return $e;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// pop something off the stack</span></span>&nbsp;</div></li><li><div>  protected function popEnv() {&nbsp;</div></li><li><div>      $old = $this-&gt;env;&nbsp;</div></li><li><div>      $this-&gt;env = $this-&gt;env-&gt;parent;&nbsp;</div></li><li><div>      return $old;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set something in the current env</span>&nbsp;</div></li><li><div>  protected function set($name, $value) {&nbsp;</div></li><li><div>      $this-&gt;env-&gt;store[$name] = $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get the highest occurrence entry for a name</span>&nbsp;</div></li><li><div>  protected function get($name, $default=null) {&nbsp;</div></li><li><div>      $current = $this-&gt;env;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $isArguments = $name == $this-&gt;vPrefix . 'arguments';&nbsp;</div></li><li><div>      while ($current) {&nbsp;</div></li><li><div>          if ($isArguments && isset($current-&gt;arguments)) {&nbsp;</div></li><li><div>              return array('list', ' ', $current-&gt;arguments);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($current-&gt;store[$name]))&nbsp;</div></li><li><div>              return $current-&gt;store[$name];&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $current = isset($current-&gt;storeParent) ?&nbsp;</div></li><li><div>                  $current-&gt;storeParent : $current-&gt;parent;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $default;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// inject array of unparsed strings into environment as variables</span>&nbsp;</div></li><li><div>  protected function injectVariables($args) {&nbsp;</div></li><li><div>      $this-&gt;pushEnv();&nbsp;</div></li><li><div>      $parser = new lessc_parser($this, __METHOD__);&nbsp;</div></li><li><div>      foreach ($args as $name =&gt; $strValue) {&nbsp;</div></li><li><div>          if ($name{0} != '@') $name = '@'.$name;&nbsp;</div></li><li><div>          $parser-&gt;count = 0;&nbsp;</div></li><li><div>          $parser-&gt;buffer = (string)$strValue;&nbsp;</div></li><li><div>          if (!$parser-&gt;propertyValue($value)) {&nbsp;</div></li><li><div>              throw new Exception(&quot;failed to parse passed in variable $name: $strValue&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set($name, $value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize any static state, can initialize parser for a file</span>&nbsp;</div></li><li><div><span class="comment">   * $opts isn't used yet</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($fname = null) {&nbsp;</div></li><li><div>      if ($fname !== null) {&nbsp;</div></li><li><div>          <span class="comment">// used for deprecated parse method</span>&nbsp;</div></li><li><div>          $this-&gt;_parseFile = $fname;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function compile($string, $name = null) {&nbsp;</div></li><li><div>      $locale = setlocale(LC_NUMERIC, 0);&nbsp;</div></li><li><div>      setlocale(LC_NUMERIC, &quot;C&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;parser = $this-&gt;makeParser($name);&nbsp;</div></li><li><div>      $root = $this-&gt;parser-&gt;parse($string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = null;&nbsp;</div></li><li><div>      $this-&gt;scope = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;formatter = $this-&gt;newFormatter();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($this-&gt;registeredVars)) {&nbsp;</div></li><li><div>          $this-&gt;injectVariables($this-&gt;registeredVars);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;sourceParser = $this-&gt;parser; <span class="comment">// used for error messages</span>&nbsp;</div></li><li><div>      $this-&gt;compileBlock($root);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      $this-&gt;formatter-&gt;block($this-&gt;scope);&nbsp;</div></li><li><div>      $out = ob_get_clean();&nbsp;</div></li><li><div>      setlocale(LC_NUMERIC, $locale);&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function compileFile($fname, $outFname = null) {&nbsp;</div></li><li><div>      if (!is_readable($fname)) {&nbsp;</div></li><li><div>          throw new Exception('load error: failed to find '.$fname);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pi = pathinfo($fname);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldImport = $this-&gt;importDir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;importDir = (array)$this-&gt;importDir;&nbsp;</div></li><li><div>      $this-&gt;importDir[] = $pi['dirname'].'/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;addParsedFile($fname);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $this-&gt;compile(file_get_contents($fname), $fname);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;importDir = $oldImport;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($outFname !== null) {&nbsp;</div></li><li><div>          return file_put_contents($outFname, $out);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// compile only if changed input has changed or output doesn't exist</span>&nbsp;</div></li><li><div>  public function checkedCompile($in, $out) {&nbsp;</div></li><li><div>      if (!is_file($out) || filemtime($in) &gt; filemtime($out)) {&nbsp;</div></li><li><div>          $this-&gt;compileFile($in, $out);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Execute lessphp on a .less file or a lessphp cache structure</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The lessphp cache structure contains information about a specific</span>&nbsp;</div></li><li><div><span class="comment">   * less file having been parsed. It can be used as a hint for future</span>&nbsp;</div></li><li><div><span class="comment">   * calls to determine whether or not a rebuild is required.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The cache structure contains two important keys that may be used</span>&nbsp;</div></li><li><div><span class="comment">   * externally:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * compiled: The final compiled CSS</span>&nbsp;</div></li><li><div><span class="comment">   * updated: The time (in seconds) the CSS was last compiled</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The cache structure is a plain-ol' PHP associative array and can</span>&nbsp;</div></li><li><div><span class="comment">   * be serialized and unserialized without a hitch.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $in Input</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $force Force rebuild?</span>&nbsp;</div></li><li><div><span class="comment">   * @return array lessphp cache structure</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cachedCompile($in, $force = false) {&nbsp;</div></li><li><div>      <span class="comment">// assume no root</span>&nbsp;</div></li><li><div>      $root = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (is_string($in)) {&nbsp;</div></li><li><div>          $root = $in;&nbsp;</div></li><li><div>      } elseif (is_array($in) and isset($in['root'])) {&nbsp;</div></li><li><div>          if ($force or ! isset($in['files'])) {&nbsp;</div></li><li><div>              <span class="comment">// If we are forcing a recompile or if for some reason the</span>&nbsp;</div></li><li><div>              <span class="comment">// structure does not contain any file information we should</span>&nbsp;</div></li><li><div>              <span class="comment">// specify the root to trigger a rebuild.</span>&nbsp;</div></li><li><div>              $root = $in['root'];&nbsp;</div></li><li><div>          } elseif (isset($in['files']) and is_array($in['files'])) {&nbsp;</div></li><li><div>              foreach ($in['files'] as $fname =&gt; $ftime ) {&nbsp;</div></li><li><div>                  if (!file_exists($fname) or filemtime($fname) &gt; $ftime) {&nbsp;</div></li><li><div>                      <span class="comment">// One of the files we knew about previously has changed</span>&nbsp;</div></li><li><div>                      <span class="comment">// so we should look at our incoming root again.</span>&nbsp;</div></li><li><div>                      $root = $in['root'];&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// TODO: Throw an exception? We got neither a string nor something</span>&nbsp;</div></li><li><div>          <span class="comment">// that looks like a compatible lessphp cache structure.</span>&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($root !== null) {&nbsp;</div></li><li><div>          <span class="comment">// If we have a root value which means we should rebuild.</span>&nbsp;</div></li><li><div>          $out = array();&nbsp;</div></li><li><div>          $out['root'] = $root;&nbsp;</div></li><li><div>          $out['compiled'] = $this-&gt;compileFile($root);&nbsp;</div></li><li><div>          $out['files'] = $this-&gt;allParsedFiles();&nbsp;</div></li><li><div>          $out['updated'] = time();&nbsp;</div></li><li><div>          return $out;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// No changes, pass back the structure</span>&nbsp;</div></li><li><div>          <span class="comment">// we were given initially.</span>&nbsp;</div></li><li><div>          return $in;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// parse and compile buffer</span>&nbsp;</div></li><li><div>  <span class="comment">// This is deprecated</span>&nbsp;</div></li><li><div>  public function parse($str = null, $initialVariables = null) {&nbsp;</div></li><li><div>      if (is_array($str)) {&nbsp;</div></li><li><div>          $initialVariables = $str;&nbsp;</div></li><li><div>          $str = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldVars = $this-&gt;registeredVars;&nbsp;</div></li><li><div>      if ($initialVariables !== null) {&nbsp;</div></li><li><div>          $this-&gt;setVariables($initialVariables);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($str == null) {&nbsp;</div></li><li><div>          if (empty($this-&gt;_parseFile)) {&nbsp;</div></li><li><div>              throw new exception(&quot;nothing to parse&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $out = $this-&gt;compileFile($this-&gt;_parseFile);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $out = $this-&gt;compile($str);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;registeredVars = $oldVars;&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function makeParser($name) {&nbsp;</div></li><li><div>      $parser = new lessc_parser($this, $name);&nbsp;</div></li><li><div>      $parser-&gt;writeComments = $this-&gt;preserveComments;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $parser;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setFormatter($name) {&nbsp;</div></li><li><div>      $this-&gt;formatterName = $name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function newFormatter() {&nbsp;</div></li><li><div>      $className = &quot;lessc_formatter_lessjs&quot;;&nbsp;</div></li><li><div>      if (!empty($this-&gt;formatterName)) {&nbsp;</div></li><li><div>          if (!is_string($this-&gt;formatterName))&nbsp;</div></li><li><div>              return $this-&gt;formatterName;&nbsp;</div></li><li><div>          $className = &quot;lessc_formatter_$this-&gt;formatterName&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return new $className;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setPreserveComments($preserve) {&nbsp;</div></li><li><div>      $this-&gt;preserveComments = $preserve;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function registerFunction($name, $func) {&nbsp;</div></li><li><div>      $this-&gt;libFunctions[$name] = $func;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function unregisterFunction($name) {&nbsp;</div></li><li><div>      unset($this-&gt;libFunctions[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setVariables($variables) {&nbsp;</div></li><li><div>      $this-&gt;registeredVars = array_merge($this-&gt;registeredVars, $variables);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function unsetVariable($name) {&nbsp;</div></li><li><div>      unset($this-&gt;registeredVars[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setImportDir($dirs) {&nbsp;</div></li><li><div>      $this-&gt;importDir = (array)$dirs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function addImportDir($dir) {&nbsp;</div></li><li><div>      $this-&gt;importDir = (array)$this-&gt;importDir;&nbsp;</div></li><li><div>      $this-&gt;importDir[] = $dir;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function allParsedFiles() {&nbsp;</div></li><li><div>      return $this-&gt;allParsedFiles;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function addParsedFile($file) {&nbsp;</div></li><li><div>      $this-&gt;allParsedFiles[realpath($file)] = filemtime($file);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uses the current value of $this-&gt;count to show line and line number</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function throwError($msg = null) {&nbsp;</div></li><li><div>      if ($this-&gt;sourceLoc &gt;= 0) {&nbsp;</div></li><li><div>          $this-&gt;sourceParser-&gt;throwError($msg, $this-&gt;sourceLoc);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      throw new exception($msg);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// compile file $in to file $out if $in is newer than $out</span>&nbsp;</div></li><li><div>  <span class="comment">// returns true when it compiles, false otherwise</span>&nbsp;</div></li><li><div>  public static function ccompile($in, $out, $less = null) {&nbsp;</div></li><li><div>      if ($less === null) {&nbsp;</div></li><li><div>          $less = new self;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $less-&gt;checkedCompile($in, $out);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function cexecute($in, $force = false, $less = null) {&nbsp;</div></li><li><div>      if ($less === null) {&nbsp;</div></li><li><div>          $less = new self;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $less-&gt;cachedCompile($in, $force);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $cssColors = array(&nbsp;</div></li><li><div>      'aliceblue' =&gt; '240, 248, 255', &nbsp;</div></li><li><div>      'antiquewhite' =&gt; '250, 235, 215', &nbsp;</div></li><li><div>      'aqua' =&gt; '0, 255, 255', &nbsp;</div></li><li><div>      'aquamarine' =&gt; '127, 255, 212', &nbsp;</div></li><li><div>      'azure' =&gt; '240, 255, 255', &nbsp;</div></li><li><div>      'beige' =&gt; '245, 245, 220', &nbsp;</div></li><li><div>      'bisque' =&gt; '255, 228, 196', &nbsp;</div></li><li><div>      'black' =&gt; '0, 0, 0', &nbsp;</div></li><li><div>      'blanchedalmond' =&gt; '255, 235, 205', &nbsp;</div></li><li><div>      'blue' =&gt; '0, 0, 255', &nbsp;</div></li><li><div>      'blueviolet' =&gt; '138, 43, 226', &nbsp;</div></li><li><div>      'brown' =&gt; '165, 42, 42', &nbsp;</div></li><li><div>      'burlywood' =&gt; '222, 184, 135', &nbsp;</div></li><li><div>      'cadetblue' =&gt; '95, 158, 160', &nbsp;</div></li><li><div>      'chartreuse' =&gt; '127, 255, 0', &nbsp;</div></li><li><div>      'chocolate' =&gt; '210, 105, 30', &nbsp;</div></li><li><div>      'coral' =&gt; '255, 127, 80', &nbsp;</div></li><li><div>      'cornflowerblue' =&gt; '100, 149, 237', &nbsp;</div></li><li><div>      'cornsilk' =&gt; '255, 248, 220', &nbsp;</div></li><li><div>      'crimson' =&gt; '220, 20, 60', &nbsp;</div></li><li><div>      'cyan' =&gt; '0, 255, 255', &nbsp;</div></li><li><div>      'darkblue' =&gt; '0, 0, 139', &nbsp;</div></li><li><div>      'darkcyan' =&gt; '0, 139, 139', &nbsp;</div></li><li><div>      'darkgoldenrod' =&gt; '184, 134, 11', &nbsp;</div></li><li><div>      'darkgray' =&gt; '169, 169, 169', &nbsp;</div></li><li><div>      'darkgreen' =&gt; '0, 100, 0', &nbsp;</div></li><li><div>      'darkgrey' =&gt; '169, 169, 169', &nbsp;</div></li><li><div>      'darkkhaki' =&gt; '189, 183, 107', &nbsp;</div></li><li><div>      'darkmagenta' =&gt; '139, 0, 139', &nbsp;</div></li><li><div>      'darkolivegreen' =&gt; '85, 107, 47', &nbsp;</div></li><li><div>      'darkorange' =&gt; '255, 140, 0', &nbsp;</div></li><li><div>      'darkorchid' =&gt; '153, 50, 204', &nbsp;</div></li><li><div>      'darkred' =&gt; '139, 0, 0', &nbsp;</div></li><li><div>      'darksalmon' =&gt; '233, 150, 122', &nbsp;</div></li><li><div>      'darkseagreen' =&gt; '143, 188, 143', &nbsp;</div></li><li><div>      'darkslateblue' =&gt; '72, 61, 139', &nbsp;</div></li><li><div>      'darkslategray' =&gt; '47, 79, 79', &nbsp;</div></li><li><div>      'darkslategrey' =&gt; '47, 79, 79', &nbsp;</div></li><li><div>      'darkturquoise' =&gt; '0, 206, 209', &nbsp;</div></li><li><div>      'darkviolet' =&gt; '148, 0, 211', &nbsp;</div></li><li><div>      'deeppink' =&gt; '255, 20, 147', &nbsp;</div></li><li><div>      'deepskyblue' =&gt; '0, 191, 255', &nbsp;</div></li><li><div>      'dimgray' =&gt; '105, 105, 105', &nbsp;</div></li><li><div>      'dimgrey' =&gt; '105, 105, 105', &nbsp;</div></li><li><div>      'dodgerblue' =&gt; '30, 144, 255', &nbsp;</div></li><li><div>      'firebrick' =&gt; '178, 34, 34', &nbsp;</div></li><li><div>      'floralwhite' =&gt; '255, 250, 240', &nbsp;</div></li><li><div>      'forestgreen' =&gt; '34, 139, 34', &nbsp;</div></li><li><div>      'fuchsia' =&gt; '255, 0, 255', &nbsp;</div></li><li><div>      'gainsboro' =&gt; '220, 220, 220', &nbsp;</div></li><li><div>      'ghostwhite' =&gt; '248, 248, 255', &nbsp;</div></li><li><div>      'gold' =&gt; '255, 215, 0', &nbsp;</div></li><li><div>      'goldenrod' =&gt; '218, 165, 32', &nbsp;</div></li><li><div>      'gray' =&gt; '128, 128, 128', &nbsp;</div></li><li><div>      'green' =&gt; '0, 128, 0', &nbsp;</div></li><li><div>      'greenyellow' =&gt; '173, 255, 47', &nbsp;</div></li><li><div>      'grey' =&gt; '128, 128, 128', &nbsp;</div></li><li><div>      'honeydew' =&gt; '240, 255, 240', &nbsp;</div></li><li><div>      'hotpink' =&gt; '255, 105, 180', &nbsp;</div></li><li><div>      'indianred' =&gt; '205, 92, 92', &nbsp;</div></li><li><div>      'indigo' =&gt; '75, 0, 130', &nbsp;</div></li><li><div>      'ivory' =&gt; '255, 255, 240', &nbsp;</div></li><li><div>      'khaki' =&gt; '240, 230, 140', &nbsp;</div></li><li><div>      'lavender' =&gt; '230, 230, 250', &nbsp;</div></li><li><div>      'lavenderblush' =&gt; '255, 240, 245', &nbsp;</div></li><li><div>      'lawngreen' =&gt; '124, 252, 0', &nbsp;</div></li><li><div>      'lemonchiffon' =&gt; '255, 250, 205', &nbsp;</div></li><li><div>      'lightblue' =&gt; '173, 216, 230', &nbsp;</div></li><li><div>      'lightcoral' =&gt; '240, 128, 128', &nbsp;</div></li><li><div>      'lightcyan' =&gt; '224, 255, 255', &nbsp;</div></li><li><div>      'lightgoldenrodyellow' =&gt; '250, 250, 210', &nbsp;</div></li><li><div>      'lightgray' =&gt; '211, 211, 211', &nbsp;</div></li><li><div>      'lightgreen' =&gt; '144, 238, 144', &nbsp;</div></li><li><div>      'lightgrey' =&gt; '211, 211, 211', &nbsp;</div></li><li><div>      'lightpink' =&gt; '255, 182, 193', &nbsp;</div></li><li><div>      'lightsalmon' =&gt; '255, 160, 122', &nbsp;</div></li><li><div>      'lightseagreen' =&gt; '32, 178, 170', &nbsp;</div></li><li><div>      'lightskyblue' =&gt; '135, 206, 250', &nbsp;</div></li><li><div>      'lightslategray' =&gt; '119, 136, 153', &nbsp;</div></li><li><div>      'lightslategrey' =&gt; '119, 136, 153', &nbsp;</div></li><li><div>      'lightsteelblue' =&gt; '176, 196, 222', &nbsp;</div></li><li><div>      'lightyellow' =&gt; '255, 255, 224', &nbsp;</div></li><li><div>      'lime' =&gt; '0, 255, 0', &nbsp;</div></li><li><div>      'limegreen' =&gt; '50, 205, 50', &nbsp;</div></li><li><div>      'linen' =&gt; '250, 240, 230', &nbsp;</div></li><li><div>      'magenta' =&gt; '255, 0, 255', &nbsp;</div></li><li><div>      'maroon' =&gt; '128, 0, 0', &nbsp;</div></li><li><div>      'mediumaquamarine' =&gt; '102, 205, 170', &nbsp;</div></li><li><div>      'mediumblue' =&gt; '0, 0, 205', &nbsp;</div></li><li><div>      'mediumorchid' =&gt; '186, 85, 211', &nbsp;</div></li><li><div>      'mediumpurple' =&gt; '147, 112, 219', &nbsp;</div></li><li><div>      'mediumseagreen' =&gt; '60, 179, 113', &nbsp;</div></li><li><div>      'mediumslateblue' =&gt; '123, 104, 238', &nbsp;</div></li><li><div>      'mediumspringgreen' =&gt; '0, 250, 154', &nbsp;</div></li><li><div>      'mediumturquoise' =&gt; '72, 209, 204', &nbsp;</div></li><li><div>      'mediumvioletred' =&gt; '199, 21, 133', &nbsp;</div></li><li><div>      'midnightblue' =&gt; '25, 25, 112', &nbsp;</div></li><li><div>      'mintcream' =&gt; '245, 255, 250', &nbsp;</div></li><li><div>      'mistyrose' =&gt; '255, 228, 225', &nbsp;</div></li><li><div>      'moccasin' =&gt; '255, 228, 181', &nbsp;</div></li><li><div>      'navajowhite' =&gt; '255, 222, 173', &nbsp;</div></li><li><div>      'navy' =&gt; '0, 0, 128', &nbsp;</div></li><li><div>      'oldlace' =&gt; '253, 245, 230', &nbsp;</div></li><li><div>      'olive' =&gt; '128, 128, 0', &nbsp;</div></li><li><div>      'olivedrab' =&gt; '107, 142, 35', &nbsp;</div></li><li><div>      'orange' =&gt; '255, 165, 0', &nbsp;</div></li><li><div>      'orangered' =&gt; '255, 69, 0', &nbsp;</div></li><li><div>      'orchid' =&gt; '218, 112, 214', &nbsp;</div></li><li><div>      'palegoldenrod' =&gt; '238, 232, 170', &nbsp;</div></li><li><div>      'palegreen' =&gt; '152, 251, 152', &nbsp;</div></li><li><div>      'paleturquoise' =&gt; '175, 238, 238', &nbsp;</div></li><li><div>      'palevioletred' =&gt; '219, 112, 147', &nbsp;</div></li><li><div>      'papayawhip' =&gt; '255, 239, 213', &nbsp;</div></li><li><div>      'peachpuff' =&gt; '255, 218, 185', &nbsp;</div></li><li><div>      'peru' =&gt; '205, 133, 63', &nbsp;</div></li><li><div>      'pink' =&gt; '255, 192, 203', &nbsp;</div></li><li><div>      'plum' =&gt; '221, 160, 221', &nbsp;</div></li><li><div>      'powderblue' =&gt; '176, 224, 230', &nbsp;</div></li><li><div>      'purple' =&gt; '128, 0, 128', &nbsp;</div></li><li><div>      'red' =&gt; '255, 0, 0', &nbsp;</div></li><li><div>      'rosybrown' =&gt; '188, 143, 143', &nbsp;</div></li><li><div>      'royalblue' =&gt; '65, 105, 225', &nbsp;</div></li><li><div>      'saddlebrown' =&gt; '139, 69, 19', &nbsp;</div></li><li><div>      'salmon' =&gt; '250, 128, 114', &nbsp;</div></li><li><div>      'sandybrown' =&gt; '244, 164, 96', &nbsp;</div></li><li><div>      'seagreen' =&gt; '46, 139, 87', &nbsp;</div></li><li><div>      'seashell' =&gt; '255, 245, 238', &nbsp;</div></li><li><div>      'sienna' =&gt; '160, 82, 45', &nbsp;</div></li><li><div>      'silver' =&gt; '192, 192, 192', &nbsp;</div></li><li><div>      'skyblue' =&gt; '135, 206, 235', &nbsp;</div></li><li><div>      'slateblue' =&gt; '106, 90, 205', &nbsp;</div></li><li><div>      'slategray' =&gt; '112, 128, 144', &nbsp;</div></li><li><div>      'slategrey' =&gt; '112, 128, 144', &nbsp;</div></li><li><div>      'snow' =&gt; '255, 250, 250', &nbsp;</div></li><li><div>      'springgreen' =&gt; '0, 255, 127', &nbsp;</div></li><li><div>      'steelblue' =&gt; '70, 130, 180', &nbsp;</div></li><li><div>      'tan' =&gt; '210, 180, 140', &nbsp;</div></li><li><div>      'teal' =&gt; '0, 128, 128', &nbsp;</div></li><li><div>      'thistle' =&gt; '216, 191, 216', &nbsp;</div></li><li><div>      'tomato' =&gt; '255, 99, 71', &nbsp;</div></li><li><div>      'transparent' =&gt; '0, 0, 0, 0', &nbsp;</div></li><li><div>      'turquoise' =&gt; '64, 224, 208', &nbsp;</div></li><li><div>      'violet' =&gt; '238, 130, 238', &nbsp;</div></li><li><div>      'wheat' =&gt; '245, 222, 179', &nbsp;</div></li><li><div>      'white' =&gt; '255, 255, 255', &nbsp;</div></li><li><div>      'whitesmoke' =&gt; '245, 245, 245', &nbsp;</div></li><li><div>      'yellow' =&gt; '255, 255, 0', &nbsp;</div></li><li><div>      'yellowgreen' =&gt; '154, 205, 50'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// responsible for taking a string of LESS code and converting it into a</span>&nbsp;</div></li><li><div><span class="comment">// syntax tree</span>&nbsp;</div></li><li><div>class lessc_parser {&nbsp;</div></li><li><div>  static protected $nextBlockId = 0; <span class="comment">// used to uniquely identify blocks</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $precedence = array(&nbsp;</div></li><li><div>      '=&lt;' =&gt; 0, &nbsp;</div></li><li><div>      '&gt;=' =&gt; 0, &nbsp;</div></li><li><div>      '=' =&gt; 0, &nbsp;</div></li><li><div>      '&lt;' =&gt; 0, &nbsp;</div></li><li><div>      '&gt;' =&gt; 0, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      '+' =&gt; 1, &nbsp;</div></li><li><div>      '-' =&gt; 1, &nbsp;</div></li><li><div>      '*' =&gt; 2, &nbsp;</div></li><li><div>      '/' =&gt; 2, &nbsp;</div></li><li><div>      '%' =&gt; 2, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $whitePattern;&nbsp;</div></li><li><div>  static protected $commentMulti;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $commentSingle = &quot;<span class="comment">//&quot;;</span>&nbsp;</div></li><li><div>  static protected $commentMultiLeft = &quot;<span class="comment">/*&quot;;</span>&nbsp;</div></li><li><div><span class="comment">  static protected $commentMultiRight = &quot;*/</span>&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// regex string to match any of the operators</span>&nbsp;</div></li><li><div>  static protected $operatorString;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// these properties will supress division unless it's inside parenthases</span>&nbsp;</div></li><li><div>  static protected $supressDivisionProps =&nbsp;</div></li><li><div>      array('/border-radius$/i', '/^font$/i');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $blockDirectives = array(&quot;font-face&quot;, &quot;keyframes&quot;, &quot;page&quot;, &quot;-moz-document&quot;, &quot;viewport&quot;, &quot;-moz-viewport&quot;, &quot;-o-viewport&quot;, &quot;-ms-viewport&quot;);&nbsp;</div></li><li><div>  protected $lineDirectives = array(&quot;charset&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * if we are in parens we can be more liberal with whitespace around</span>&nbsp;</div></li><li><div><span class="comment">   * operators because it must evaluate to a single value and thus is less</span>&nbsp;</div></li><li><div><span class="comment">   * ambiguous.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Consider:</span>&nbsp;</div></li><li><div><span class="comment">   *     property1: 10 -5; // is two numbers, 10 and -5</span>&nbsp;</div></li><li><div><span class="comment">   *     property2: (10 -5); // should evaluate to 5</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $inParens = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// caches preg escaped literals</span>&nbsp;</div></li><li><div>  static protected $literalCache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct($lessc, $sourceName = null) {&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>      <span class="comment">// reference to less needed for vPrefix, mPrefix, and parentSelector</span>&nbsp;</div></li><li><div>      $this-&gt;lessc = $lessc;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;sourceName = $sourceName; <span class="comment">// name used for error messages</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;writeComments = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!self::$operatorString) {&nbsp;</div></li><li><div>          self::$operatorString =&nbsp;</div></li><li><div>              '('.implode('|', array_map(array('lessc', 'preg_quote'), &nbsp;</div></li><li><div>                  array_keys(self::$precedence))).')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $commentSingle = lessc::preg_quote(self::$commentSingle);&nbsp;</div></li><li><div>          $commentMultiLeft = lessc::preg_quote(self::$commentMultiLeft);&nbsp;</div></li><li><div>          $commentMultiRight = lessc::preg_quote(self::$commentMultiRight);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::$commentMulti = $commentMultiLeft.'.*?'.$commentMultiRight;&nbsp;</div></li><li><div>          self::$whitePattern = '/'.$commentSingle.'[^\n]*\s*|('.self::$commentMulti.')\s*|\s+/Ais';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function parse($buffer) {&nbsp;</div></li><li><div>      $this-&gt;count = 0;&nbsp;</div></li><li><div>      $this-&gt;line = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = null; <span class="comment">// block stack</span>&nbsp;</div></li><li><div>      $this-&gt;buffer = $this-&gt;writeComments ? $buffer : $this-&gt;removeComments($buffer);&nbsp;</div></li><li><div>      $this-&gt;pushSpecialBlock(&quot;root&quot;);&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>      $this-&gt;seenComments = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// trim whitespace on head</span>&nbsp;</div></li><li><div>      <span class="comment">// if (preg_match('/^\s+/', $this-&gt;buffer, $m)) {</span>&nbsp;</div></li><li><div>      <span class="comment">//     $this-&gt;line += substr_count($m[0], &quot;\n&quot;);</span>&nbsp;</div></li><li><div>      <span class="comment">//     $this-&gt;buffer = ltrim($this-&gt;buffer);</span>&nbsp;</div></li><li><div>      <span class="comment">// }</span>&nbsp;</div></li><li><div>      $this-&gt;whitespace();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// parse the entire file</span>&nbsp;</div></li><li><div>      $lastCount = $this-&gt;count;&nbsp;</div></li><li><div>      while (false !== $this-&gt;parseChunk());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;count != strlen($this-&gt;buffer))&nbsp;</div></li><li><div>          $this-&gt;throwError();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// TODO report where the block was opened</span>&nbsp;</div></li><li><div>      if (!is_null($this-&gt;env-&gt;parent))&nbsp;</div></li><li><div>          throw new exception('parse error: unclosed block');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;env;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parse a single chunk off the head of the buffer and append it to the</span>&nbsp;</div></li><li><div><span class="comment">   * current parse environment.</span>&nbsp;</div></li><li><div><span class="comment">   * Returns false when the buffer is empty, or when there is an error.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This function is called repeatedly until the entire document is</span>&nbsp;</div></li><li><div><span class="comment">   * parsed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This parser is most similar to a recursive descent parser. Single</span>&nbsp;</div></li><li><div><span class="comment">   * functions represent discrete grammatical rules for the language, and</span>&nbsp;</div></li><li><div><span class="comment">   * they are able to capture the text that represents those rules.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Consider the function lessc::keyword(). (all parse functions are</span>&nbsp;</div></li><li><div><span class="comment">   * structured the same)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The function takes a single reference argument. When calling the</span>&nbsp;</div></li><li><div><span class="comment">   * function it will attempt to match a keyword on the head of the buffer.</span>&nbsp;</div></li><li><div><span class="comment">   * If it is successful, it will place the keyword in the referenced</span>&nbsp;</div></li><li><div><span class="comment">   * argument, advance the position in the buffer, and return true. If it</span>&nbsp;</div></li><li><div><span class="comment">   * fails then it won't advance the buffer and it will return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * All of these parse functions are powered by lessc::match(), which behaves</span>&nbsp;</div></li><li><div><span class="comment">   * the same way, but takes a literal regular expression. Sometimes it is</span>&nbsp;</div></li><li><div><span class="comment">   * more convenient to use match instead of creating a new function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Because of the format of the functions, to parse an entire string of</span>&nbsp;</div></li><li><div><span class="comment">   * grammatical rules, you can chain them together using &&.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * But, if some of the rules in the chain succeed before one fails, then</span>&nbsp;</div></li><li><div><span class="comment">   * the buffer position will be left at an invalid state. In order to</span>&nbsp;</div></li><li><div><span class="comment">   * avoid this, lessc::seek() is used to remember and set buffer positions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Before parsing a chain, use $s = $this-&gt;seek() to remember the current</span>&nbsp;</div></li><li><div><span class="comment">   * position into $s. Then if a chain fails, use $this-&gt;seek($s) to</span>&nbsp;</div></li><li><div><span class="comment">   * go back where we started.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function parseChunk() {&nbsp;</div></li><li><div>      if (empty($this-&gt;buffer)) return false;&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// setting a property</span>&nbsp;</div></li><li><div>      if ($this-&gt;keyword($key) && $this-&gt;assign() &&&nbsp;</div></li><li><div>          $this-&gt;propertyValue($value, $key) && $this-&gt;end())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $this-&gt;append(array('assign', $key, $value), $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// look for special css blocks</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal('@', false)) {&nbsp;</div></li><li><div>          $this-&gt;count--;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// media</span>&nbsp;</div></li><li><div>          if ($this-&gt;literal('@media')) {&nbsp;</div></li><li><div>              if (($this-&gt;mediaQueryList($mediaQueries) || true)&nbsp;</div></li><li><div>                  && $this-&gt;literal('{'))&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $media = $this-&gt;pushSpecialBlock(&quot;media&quot;);&nbsp;</div></li><li><div>                  $media-&gt;queries = is_null($mediaQueries) ? array() : $mediaQueries;&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;seek($s);&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@&quot;, false) && $this-&gt;keyword($dirName)) {&nbsp;</div></li><li><div>              if ($this-&gt;isDirective($dirName, $this-&gt;blockDirectives)) {&nbsp;</div></li><li><div>                  if (($this-&gt;openString(&quot;{&quot;, $dirValue, null, array(&quot;;&quot;)) || true) &&&nbsp;</div></li><li><div>                      $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      $dir = $this-&gt;pushSpecialBlock(&quot;directive&quot;);&nbsp;</div></li><li><div>                      $dir-&gt;name = $dirName;&nbsp;</div></li><li><div>                      if (isset($dirValue)) $dir-&gt;value = $dirValue;&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ($this-&gt;isDirective($dirName, $this-&gt;lineDirectives)) {&nbsp;</div></li><li><div>                  if ($this-&gt;propertyValue($dirValue) && $this-&gt;end()) {&nbsp;</div></li><li><div>                      $this-&gt;append(array(&quot;directive&quot;, $dirName, $dirValue));&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// setting a variable</span>&nbsp;</div></li><li><div>      if ($this-&gt;variable($var) && $this-&gt;assign() &&&nbsp;</div></li><li><div>          $this-&gt;propertyValue($value) && $this-&gt;end())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $this-&gt;append(array('assign', $var, $value), $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;import($importValue)) {&nbsp;</div></li><li><div>          $this-&gt;append($importValue, $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// opening parametric mixin</span>&nbsp;</div></li><li><div>      if ($this-&gt;tag($tag, true) && $this-&gt;argumentDef($args, $isVararg) &&&nbsp;</div></li><li><div>          ($this-&gt;guards($guards) || true) &&&nbsp;</div></li><li><div>          $this-&gt;literal('{'))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $block = $this-&gt;pushBlock($this-&gt;fixTags(array($tag)));&nbsp;</div></li><li><div>          $block-&gt;args = $args;&nbsp;</div></li><li><div>          $block-&gt;isVararg = $isVararg;&nbsp;</div></li><li><div>          if (!empty($guards)) $block-&gt;guards = $guards;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// opening a simple block</span>&nbsp;</div></li><li><div>      if ($this-&gt;tags($tags) && $this-&gt;literal('{')) {&nbsp;</div></li><li><div>          $tags = $this-&gt;fixTags($tags);&nbsp;</div></li><li><div>          $this-&gt;pushBlock($tags);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// closing a block</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal('}', false)) {&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $block = $this-&gt;pop();&nbsp;</div></li><li><div>          } catch (exception $e) {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>              $this-&gt;throwError($e-&gt;getMessage());&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $hidden = false;&nbsp;</div></li><li><div>          if (is_null($block-&gt;type)) {&nbsp;</div></li><li><div>              $hidden = true;&nbsp;</div></li><li><div>              if (!isset($block-&gt;args)) {&nbsp;</div></li><li><div>                  foreach ($block-&gt;tags as $tag) {&nbsp;</div></li><li><div>                      if (!is_string($tag) || $tag{0} != $this-&gt;lessc-&gt;mPrefix) {&nbsp;</div></li><li><div>                          $hidden = false;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ($block-&gt;tags as $tag) {&nbsp;</div></li><li><div>                  if (is_string($tag)) {&nbsp;</div></li><li><div>                      $this-&gt;env-&gt;children[$tag][] = $block;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$hidden) {&nbsp;</div></li><li><div>              $this-&gt;append(array('block', $block), $s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// this is done here so comments aren't bundled into he block that</span>&nbsp;</div></li><li><div>          <span class="comment">// was just closed</span>&nbsp;</div></li><li><div>          $this-&gt;whitespace();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// mixin</span>&nbsp;</div></li><li><div>      if ($this-&gt;mixinTags($tags) &&&nbsp;</div></li><li><div>          ($this-&gt;argumentDef($argv, $isVararg) || true) &&&nbsp;</div></li><li><div>          ($this-&gt;keyword($suffix) || true) && $this-&gt;end())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $tags = $this-&gt;fixTags($tags);&nbsp;</div></li><li><div>          $this-&gt;append(array('mixin', $tags, $argv, $suffix), $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// spare ;</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(';')) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false; <span class="comment">// got nothing, throw error</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function isDirective($dirname, $directives) {&nbsp;</div></li><li><div>      <span class="comment">// TODO: cache pattern in parser</span>&nbsp;</div></li><li><div>      $pattern = implode(&quot;|&quot;, &nbsp;</div></li><li><div>          array_map(array(&quot;lessc&quot;, &quot;preg_quote&quot;), $directives));&nbsp;</div></li><li><div>      $pattern = '/^(-[a-z-]+-)?(' . $pattern . ')$/i';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return preg_match($pattern, $dirname);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function fixTags($tags) {&nbsp;</div></li><li><div>      <span class="comment">// move @ tags out of variable namespace</span>&nbsp;</div></li><li><div>      foreach ($tags as &$tag) {&nbsp;</div></li><li><div>          if ($tag{0} == $this-&gt;lessc-&gt;vPrefix)&nbsp;</div></li><li><div>              $tag[0] = $this-&gt;lessc-&gt;mPrefix;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $tags;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a list of expressions</span>&nbsp;</div></li><li><div>  protected function expressionList(&$exps) {&nbsp;</div></li><li><div>      $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ($this-&gt;expression($exp)) {&nbsp;</div></li><li><div>          $values[] = $exp;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($values) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $exps = lessc::compressList($values, ' ');&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Attempt to consume an expression.</span>&nbsp;</div></li><li><div><span class="comment">   * @link http://en.wikipedia.org/wiki/Operator-precedence_parser#Pseudo-code</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function expression(&$out) {&nbsp;</div></li><li><div>      if ($this-&gt;value($lhs)) {&nbsp;</div></li><li><div>          $out = $this-&gt;expHelper($lhs, 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// look for / shorthand</span>&nbsp;</div></li><li><div>          if (!empty($this-&gt;env-&gt;supressedDivision)) {&nbsp;</div></li><li><div>              unset($this-&gt;env-&gt;supressedDivision);&nbsp;</div></li><li><div>              $s = $this-&gt;seek();&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;/&quot;) && $this-&gt;value($rhs)) {&nbsp;</div></li><li><div>                  $out = array(&quot;list&quot;, &quot;&quot;, &nbsp;</div></li><li><div>                      array($out, array(&quot;keyword&quot;, &quot;/&quot;), $rhs));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;seek($s);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * recursively parse infix equation with $lhs at precedence $minP</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function expHelper($lhs, $minP) {&nbsp;</div></li><li><div>      $this-&gt;inExp = true;&nbsp;</div></li><li><div>      $ss = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          $whiteBefore = isset($this-&gt;buffer[$this-&gt;count - 1]) &&&nbsp;</div></li><li><div>              ctype_space($this-&gt;buffer[$this-&gt;count - 1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If there is whitespace before the operator, then we require</span>&nbsp;</div></li><li><div>          <span class="comment">// whitespace after the operator for it to be an expression</span>&nbsp;</div></li><li><div>          $needWhite = $whiteBefore && !$this-&gt;inParens;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;match(self::$operatorString.($needWhite ? '\s' : ''), $m) && self::$precedence[$m[1]] &gt;= $minP) {&nbsp;</div></li><li><div>              if (!$this-&gt;inParens && isset($this-&gt;env-&gt;currentProperty) && $m[1] == &quot;/&quot; && empty($this-&gt;env-&gt;supressedDivision)) {&nbsp;</div></li><li><div>                  foreach (self::$supressDivisionProps as $pattern) {&nbsp;</div></li><li><div>                      if (preg_match($pattern, $this-&gt;env-&gt;currentProperty)) {&nbsp;</div></li><li><div>                          $this-&gt;env-&gt;supressedDivision = true;&nbsp;</div></li><li><div>                          break 2;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $whiteAfter = isset($this-&gt;buffer[$this-&gt;count - 1]) &&&nbsp;</div></li><li><div>                  ctype_space($this-&gt;buffer[$this-&gt;count - 1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!$this-&gt;value($rhs)) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// peek for next operator to see what to do with rhs</span>&nbsp;</div></li><li><div>              if ($this-&gt;peek(self::$operatorString, $next) && self::$precedence[$next[1]] &gt; self::$precedence[$m[1]]) {&nbsp;</div></li><li><div>                  $rhs = $this-&gt;expHelper($rhs, self::$precedence[$next[1]]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $lhs = array('expression', $m[1], $lhs, $rhs, $whiteBefore, $whiteAfter);&nbsp;</div></li><li><div>              $ss = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($ss);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $lhs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume a list of values for a property</span>&nbsp;</div></li><li><div>  public function propertyValue(&$value, $keyName = null) {&nbsp;</div></li><li><div>      $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($keyName !== null) $this-&gt;env-&gt;currentProperty = $keyName;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $s = null;&nbsp;</div></li><li><div>      while ($this-&gt;expressionList($v)) {&nbsp;</div></li><li><div>          $values[] = $v;&nbsp;</div></li><li><div>          $s = $this-&gt;seek();&nbsp;</div></li><li><div>          if (!$this-&gt;literal(', ')) break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($s) $this-&gt;seek($s);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($keyName !== null) unset($this-&gt;env-&gt;currentProperty);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($values) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $value = lessc::compressList($values, ', ');&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function parenValue(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// speed shortcut</span></span></span></span>&nbsp;</div></li><li><div>      if (isset($this-&gt;buffer[$this-&gt;count]) && $this-&gt;buffer[$this-&gt;count] != &quot;(&quot;) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inParens = $this-&gt;inParens;&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>          ($this-&gt;inParens = true) && $this-&gt;expression($exp) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = $exp;&nbsp;</div></li><li><div>          $this-&gt;inParens = $inParens;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;inParens = $inParens;&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a single value</span>&nbsp;</div></li><li><div>  protected function value(&$value) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// speed shortcut</span></span></span></span>&nbsp;</div></li><li><div>      if (isset($this-&gt;buffer[$this-&gt;count]) && $this-&gt;buffer[$this-&gt;count] == &quot;-&quot;) {&nbsp;</div></li><li><div>          <span class="comment">// negation</span>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;-&quot;, false) &&&nbsp;</div></li><li><div>              (($this-&gt;variable($inner) && $inner = array(&quot;variable&quot;, $inner)) ||&nbsp;</div></li><li><div>              $this-&gt;unit($inner) ||&nbsp;</div></li><li><div>              $this-&gt;parenValue($inner)))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $value = array(&quot;unary&quot;, &quot;-&quot;, $inner);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;parenValue($value)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;unit($value)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;color($value)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;func($value)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;string($value)) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;keyword($word)) {&nbsp;</div></li><li><div>          $value = array('keyword', $word);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// try a variable</span>&nbsp;</div></li><li><div>      if ($this-&gt;variable($var)) {&nbsp;</div></li><li><div>          $value = array('variable', $var);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// unquote string (should this work on any type?</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;~&quot;) && $this-&gt;string($str)) {&nbsp;</div></li><li><div>          $value = array(&quot;escape&quot;, $str);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// css hack: \0</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal('\\') && $this-&gt;match('([0-9]+)', $m)) {&nbsp;</div></li><li><div>          $value = array('keyword', '\\'.$m[1]);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// an import statement</span>&nbsp;</div></li><li><div>  protected function import(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if (!$this-&gt;literal('@import')) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// @import &quot;something.css&quot; media;</span>&nbsp;</div></li><li><div>      <span class="comment">// @import url(&quot;something.css&quot;) media;</span>&nbsp;</div></li><li><div>      <span class="comment">// @import url(something.css) media;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;propertyValue($value)) {&nbsp;</div></li><li><div>          $out = array(&quot;import&quot;, $value);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaQueryList(&$out) {&nbsp;</div></li><li><div>      if ($this-&gt;genericList($list, &quot;mediaQuery&quot;, &quot;, &quot;, false)) {&nbsp;</div></li><li><div>          $out = $list[2];&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaQuery(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $expressions = null;&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($this-&gt;literal(&quot;only&quot;) && ($only = true) || $this-&gt;literal(&quot;not&quot;) && ($not = true) || true) && $this-&gt;keyword($mediaType)) {&nbsp;</div></li><li><div>          $prop = array(&quot;mediaType&quot;);&nbsp;</div></li><li><div>          if (isset($only)) $prop[] = &quot;only&quot;;&nbsp;</div></li><li><div>          if (isset($not)) $prop[] = &quot;not&quot;;&nbsp;</div></li><li><div>          $prop[] = $mediaType;&nbsp;</div></li><li><div>          $parts[] = $prop;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($mediaType) && !$this-&gt;literal(&quot;and&quot;)) {&nbsp;</div></li><li><div>          <span class="comment">// ~</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;genericList($expressions, &quot;mediaExpression&quot;, &quot;and&quot;, false);&nbsp;</div></li><li><div>          if (is_array($expressions)) $parts = array_merge($parts, $expressions[2]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($parts) == 0) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $parts;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaExpression(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $value = null;&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>          $this-&gt;keyword($feature) &&&nbsp;</div></li><li><div>          ($this-&gt;literal(&quot;:&quot;) && $this-&gt;expression($value) || true) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = array(&quot;mediaExp&quot;, $feature);&nbsp;</div></li><li><div>          if ($value) $out[] = $value;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ($this-&gt;variable($variable)) {&nbsp;</div></li><li><div>          $out = array('variable', $variable);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// an unbounded string stopped by $end</span>&nbsp;</div></li><li><div>  protected function openString($end, &$out, $nestingOpen=null, $rejectStrs = null) {&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stop = array(&quot;'&quot;, '&quot;', &quot;@{&quot;, $end);&nbsp;</div></li><li><div>      $stop = array_map(array(&quot;lessc&quot;, &quot;preg_quote&quot;), $stop);&nbsp;</div></li><li><div>      <span class="comment">// $stop[] = self::$commentMulti;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!is_null($rejectStrs)) {&nbsp;</div></li><li><div>          $stop = array_merge($stop, $rejectStrs);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $patt = '(.*?)('.implode(&quot;|&quot;, $stop).')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $nestingLevel = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = array();&nbsp;</div></li><li><div>      while ($this-&gt;match($patt, $m, false)) {&nbsp;</div></li><li><div>          if (!empty($m[1])) {&nbsp;</div></li><li><div>              $content[] = $m[1];&nbsp;</div></li><li><div>              if ($nestingOpen) {&nbsp;</div></li><li><div>                  $nestingLevel += substr_count($m[1], $nestingOpen);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tok = $m[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;count-= strlen($tok);&nbsp;</div></li><li><div>          if ($tok == $end) {&nbsp;</div></li><li><div>              if ($nestingLevel == 0) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $nestingLevel--;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($tok == &quot;'&quot; || $tok == '&quot;') && $this-&gt;string($str)) {&nbsp;</div></li><li><div>              $content[] = $str;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($tok == &quot;@{&quot; && $this-&gt;interpolation($inter)) {&nbsp;</div></li><li><div>              $content[] = $inter;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!empty($rejectStrs) && in_array($tok, $rejectStrs)) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $content[] = $tok;&nbsp;</div></li><li><div>          $this-&gt;count+= strlen($tok);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($content) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// trim the end</span>&nbsp;</div></li><li><div>      if (is_string(end($content))) {&nbsp;</div></li><li><div>          $content[count($content) - 1] = rtrim(end($content));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array(&quot;string&quot;, &quot;&quot;, $content);&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function string(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal('&quot;', false)) {&nbsp;</div></li><li><div>          $delim = '&quot;';&nbsp;</div></li><li><div>      } elseif ($this-&gt;literal(&quot;'&quot;, false)) {&nbsp;</div></li><li><div>          $delim = &quot;'&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// look for either ending delim , escape, or string interpolation</span>&nbsp;</div></li><li><div>      $patt = '([^\n]*?)(@\{|\\\\|' .&nbsp;</div></li><li><div>          lessc::preg_quote($delim).')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ($this-&gt;match($patt, $m, false)) {&nbsp;</div></li><li><div>          $content[] = $m[1];&nbsp;</div></li><li><div>          if ($m[2] == &quot;@{&quot;) {&nbsp;</div></li><li><div>              $this-&gt;count -= strlen($m[2]);&nbsp;</div></li><li><div>              if ($this-&gt;interpolation($inter, false)) {&nbsp;</div></li><li><div>                  $content[] = $inter;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;count += strlen($m[2]);&nbsp;</div></li><li><div>                  $content[] = &quot;@{&quot;; <span class="comment">// ignore it</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ($m[2] == '\\') {&nbsp;</div></li><li><div>              $content[] = $m[2];&nbsp;</div></li><li><div>              if ($this-&gt;literal($delim, false)) {&nbsp;</div></li><li><div>                  $content[] = $delim;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;count -= strlen($delim);&nbsp;</div></li><li><div>              break; <span class="comment">// delim</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal($delim)) {&nbsp;</div></li><li><div>          $out = array(&quot;string&quot;, $delim, $content);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function interpolation(&$out) {&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;@{&quot;) &&&nbsp;</div></li><li><div>          $this-&gt;openString(&quot;}&quot;, $interp, null, array(&quot;'&quot;, '&quot;', &quot;;&quot;)) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;}&quot;, false))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = array(&quot;interpolate&quot;, $interp);&nbsp;</div></li><li><div>          $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>          if ($this-&gt;eatWhiteDefault) $this-&gt;whitespace();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function unit(&$unit) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// speed shortcut</span></span></span></span>&nbsp;</div></li><li><div>      if (isset($this-&gt;buffer[$this-&gt;count])) {&nbsp;</div></li><li><div>          $char = $this-&gt;buffer[$this-&gt;count];&nbsp;</div></li><li><div>          if (!ctype_digit($char) && $char != &quot;.&quot;) return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;match('([0-9]+(?:\.[0-9]*)?|\.[0-9]+)([%a-zA-Z]+)?', $m)) {&nbsp;</div></li><li><div>          $unit = array(&quot;number&quot;, $m[1], empty($m[2]) ? &quot;&quot; : $m[2]);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a # color</span>&nbsp;</div></li><li><div>  protected function color(&$out) {&nbsp;</div></li><li><div>      if ($this-&gt;match('(#(?:[0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{3}))', $m)) {&nbsp;</div></li><li><div>          if (strlen($m[1]) &gt; 7) {&nbsp;</div></li><li><div>              $out = array(&quot;string&quot;, &quot;&quot;, array($m[1]));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $out = array(&quot;raw_color&quot;, $m[1]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume an argument definition list surrounded by ()</span>&nbsp;</div></li><li><div>  <span class="comment">// each argument is a variable name with optional value</span>&nbsp;</div></li><li><div>  <span class="comment">// or at the end a ... or a variable named followed by ...</span>&nbsp;</div></li><li><div>  <span class="comment">// arguments are separated by , unless a ; is in the list, then ; is the</span>&nbsp;</div></li><li><div>  <span class="comment">// delim</span>iter.&nbsp;</div></li><li><div>  protected function argumentDef(&$args, &$isVararg) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if (!$this-&gt;literal('(')) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $values = array();&nbsp;</div></li><li><div>      $delim = &quot;, &quot;;&nbsp;</div></li><li><div>      $method = &quot;expressionList&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $isVararg = false;&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;...&quot;)) {&nbsp;</div></li><li><div>              $isVararg = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;$method($value)) {&nbsp;</div></li><li><div>              if ($value[0] == &quot;variable&quot;) {&nbsp;</div></li><li><div>                  $arg = array(&quot;arg&quot;, $value[1]);&nbsp;</div></li><li><div>                  $ss = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($this-&gt;assign() && $this-&gt;$method($rhs)) {&nbsp;</div></li><li><div>                      $arg[] = $rhs;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this-&gt;seek($ss);&nbsp;</div></li><li><div>                      if ($this-&gt;literal(&quot;...&quot;)) {&nbsp;</div></li><li><div>                          $arg[0] = &quot;rest&quot;;&nbsp;</div></li><li><div>                          $isVararg = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $values[] = $arg;&nbsp;</div></li><li><div>                  if ($isVararg) break;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $values[] = array(&quot;lit&quot;, $value);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$this-&gt;literal($delim)) {&nbsp;</div></li><li><div>              if ($delim == &quot;, &quot; && $this-&gt;literal(&quot;;&quot;)) {&nbsp;</div></li><li><div>                  <span class="comment">// found new delim, convert existing args</span>&nbsp;</div></li><li><div>                  $delim = &quot;;&quot;;&nbsp;</div></li><li><div>                  $method = &quot;propertyValue&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// transform arg list</span>&nbsp;</div></li><li><div>                  if (isset($values[1])) { <span class="comment">// 2 items</span>&nbsp;</div></li><li><div>                      $newList = array();&nbsp;</div></li><li><div>                      foreach ($values as $i =&gt; $arg) {&nbsp;</div></li><li><div>                          switch($arg[0]) {&nbsp;</div></li><li><div>                          case &quot;arg&quot;:&nbsp;</div></li><li><div>                              if ($i) {&nbsp;</div></li><li><div>                                  $this-&gt;throwError(&quot;Cannot mix ; and , as delimiter types&quot;);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $newList[] = $arg[2];&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          case &quot;lit&quot;:&nbsp;</div></li><li><div>                              $newList[] = $arg[1];&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          case &quot;rest&quot;:&nbsp;</div></li><li><div>                              $this-&gt;throwError(&quot;Unexpected rest before semicolon&quot;);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $newList = array(&quot;list&quot;, &quot;, &quot;, $newList);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      switch ($values[0][0]) {&nbsp;</div></li><li><div>                      case &quot;arg&quot;:&nbsp;</div></li><li><div>                          $newArg = array(&quot;arg&quot;, $values[0][1], $newList);&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      case &quot;lit&quot;:&nbsp;</div></li><li><div>                          $newArg = array(&quot;lit&quot;, $newList);&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } elseif ($values) { <span class="comment">// 1 item</span>&nbsp;</div></li><li><div>                      $newArg = $values[0];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($newArg) {&nbsp;</div></li><li><div>                      $values = array($newArg);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;literal(')')) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = $values;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume a list of tags</span>&nbsp;</div></li><li><div>  <span class="comment">// this accepts a hanging delimiter</span>&nbsp;</div></li><li><div>  protected function tags(&$tags, $simple = false, $delim = ', ') {&nbsp;</div></li><li><div>      $tags = array();&nbsp;</div></li><li><div>      while ($this-&gt;tag($tt, $simple)) {&nbsp;</div></li><li><div>          $tags[] = $tt;&nbsp;</div></li><li><div>          if (!$this-&gt;literal($delim)) break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (count($tags) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// list of tags of specifying mixin path</span>&nbsp;</div></li><li><div>  <span class="comment">// optionally separated by &gt; (lazy, accepts extra &gt;)</span>&nbsp;</div></li><li><div>  protected function mixinTags(&$tags) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $tags = array();&nbsp;</div></li><li><div>      while ($this-&gt;tag($tt, true)) {&nbsp;</div></li><li><div>          $tags[] = $tt;&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;&gt;&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($tags) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a bracketed value (contained within in a tag definition)</span>&nbsp;</div></li><li><div>  protected function tagBracket(&$parts, &$hasExpression) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// speed shortcut</span></span></span></span>&nbsp;</div></li><li><div>      if (isset($this-&gt;buffer[$this-&gt;count]) && $this-&gt;buffer[$this-&gt;count] != &quot;[&quot;) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hasInterpolation = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;[&quot;, false)) {&nbsp;</div></li><li><div>          $attrParts = array(&quot;[&quot;);&nbsp;</div></li><li><div>          <span class="comment">// keyword, string, operator</span>&nbsp;</div></li><li><div>          while (true) {&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;]&quot;, false)) {&nbsp;</div></li><li><div>                  $this-&gt;count--;&nbsp;</div></li><li><div>                  break; <span class="comment">// get out early</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;match('\s+', $m)) {&nbsp;</div></li><li><div>                  $attrParts[] = &quot; &quot;;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($this-&gt;string($str)) {&nbsp;</div></li><li><div>                  <span class="comment">// escape parent selector, (yuck)</span>&nbsp;</div></li><li><div>                  foreach ($str[2] as &$chunk) {&nbsp;</div></li><li><div>                      $chunk = str_replace($this-&gt;lessc-&gt;parentSelector, &quot;$&$&quot;, $chunk);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $attrParts[] = $str;&nbsp;</div></li><li><div>                  $hasInterpolation = true;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;keyword($word)) {&nbsp;</div></li><li><div>                  $attrParts[] = $word;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;interpolation($inter, false)) {&nbsp;</div></li><li><div>                  $attrParts[] = $inter;&nbsp;</div></li><li><div>                  $hasInterpolation = true;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// operator, handles attr namespace too</span>&nbsp;</div></li><li><div>              if ($this-&gt;match('[|-~\$\*\^=]+', $m)) {&nbsp;</div></li><li><div>                  $attrParts[] = $m[0];&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;]&quot;, false)) {&nbsp;</div></li><li><div>              $attrParts[] = &quot;]&quot;;&nbsp;</div></li><li><div>              foreach ($attrParts as $part) {&nbsp;</div></li><li><div>                  $parts[] = $part;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $hasExpression = $hasExpression || $hasInterpolation;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a space separated list of selectors</span>&nbsp;</div></li><li><div>  protected function tag(&$tag, $simple = false) {&nbsp;</div></li><li><div>      if ($simple)&nbsp;</div></li><li><div>          $chars = '^@, :;{}\][&gt;\(\) &quot;\'';&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $chars = '^@, ;{}[&quot;\'';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hasExpression = false;&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>      while ($this-&gt;tagBracket($parts, $hasExpression));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          if ($this-&gt;match('(['.$chars.'0-9]['.$chars.']*)', $m)) {&nbsp;</div></li><li><div>              $parts[] = $m[1];&nbsp;</div></li><li><div>              if ($simple) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              while ($this-&gt;tagBracket($parts, $hasExpression));&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($this-&gt;buffer[$this-&gt;count]) && $this-&gt;buffer[$this-&gt;count] == &quot;@&quot;) {&nbsp;</div></li><li><div>              if ($this-&gt;interpolation($interp)) {&nbsp;</div></li><li><div>                  $hasExpression = true;&nbsp;</div></li><li><div>                  $interp[2] = true; <span class="comment">// don't unescape</span>&nbsp;</div></li><li><div>                  $parts[] = $interp;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;@&quot;)) {&nbsp;</div></li><li><div>                  $parts[] = &quot;@&quot;;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;unit($unit)) { <span class="comment">// for keyframes</span>&nbsp;</div></li><li><div>              $parts[] = $unit[1];&nbsp;</div></li><li><div>              $parts[] = $unit[2];&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>      if (!$parts) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($hasExpression) {&nbsp;</div></li><li><div>          $tag = array(&quot;exp&quot;, array(&quot;string&quot;, &quot;&quot;, $parts));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $tag = trim(implode($parts));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;whitespace();&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a css function</span>&nbsp;</div></li><li><div>  protected function func(&$func) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;match('(%|[\w\-_][\w\-_:\.]+|[\w_])', $m) && $this-&gt;literal('(')) {&nbsp;</div></li><li><div>          $fname = $m[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sPreArgs = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = array();&nbsp;</div></li><li><div>          while (true) {&nbsp;</div></li><li><div>              $ss = $this-&gt;seek();&nbsp;</div></li><li><div>              <span class="comment">// this ugly nonsense is for ie filter properties</span>&nbsp;</div></li><li><div>              if ($this-&gt;keyword($name) && $this-&gt;literal('=') && $this-&gt;expressionList($value)) {&nbsp;</div></li><li><div>                  $args[] = array(&quot;string&quot;, &quot;&quot;, array($name, &quot;=&quot;, $value));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;seek($ss);&nbsp;</div></li><li><div>                  if ($this-&gt;expressionList($value)) {&nbsp;</div></li><li><div>                      $args[] = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!$this-&gt;literal(', ')) break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $args = array('list', ', ', $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(')')) {&nbsp;</div></li><li><div>              $func = array('function', $fname, $args);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } elseif ($fname == 'url') {&nbsp;</div></li><li><div>              <span class="comment">// couldn't parse and in url? treat as string</span>&nbsp;</div></li><li><div>              $this-&gt;seek($sPreArgs);&nbsp;</div></li><li><div>              if ($this-&gt;openString(&quot;)&quot;, $string) && $this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>                  $func = array('function', $fname, $string);&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume a less variable</span>&nbsp;</div></li><li><div>  protected function variable(&$name) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal($this-&gt;lessc-&gt;vPrefix, false) &&&nbsp;</div></li><li><div>          ($this-&gt;variable($sub) || $this-&gt;keyword($name)))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if (!empty($sub)) {&nbsp;</div></li><li><div>              $name = array('variable', $sub);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $name = $this-&gt;lessc-&gt;vPrefix.$name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $name = null;&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Consume an assignment operator</span>&nbsp;</div></li><li><div><span class="comment">   * Can optionally take a name that will be set to the current property name</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function assign($name = null) {&nbsp;</div></li><li><div>      if ($name) $this-&gt;currentProperty = $name;&nbsp;</div></li><li><div>      return $this-&gt;literal(':') || $this-&gt;literal('=');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume a keyword</span>&nbsp;</div></li><li><div>  protected function keyword(&$word) {&nbsp;</div></li><li><div>      if ($this-&gt;match('([\w_\-\*!&quot;][\w\-_&quot;]*)', $m)) {&nbsp;</div></li><li><div>          $word = $m[1];&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume an end of statement delimiter</span>&nbsp;</div></li><li><div>  protected function end() {&nbsp;</div></li><li><div>      if ($this-&gt;literal(';')) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ($this-&gt;count == strlen($this-&gt;buffer) || $this-&gt;buffer[$this-&gt;count] == '}') {&nbsp;</div></li><li><div>          <span class="comment">// if there is end of file or a closing block next then we don't need a ;</span>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function guards(&$guards) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;literal(&quot;when&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $guards = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ($this-&gt;guardGroup($g)) {&nbsp;</div></li><li><div>          $guards[] = $g;&nbsp;</div></li><li><div>          if (!$this-&gt;literal(&quot;, &quot;)) break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($guards) == 0) {&nbsp;</div></li><li><div>          $guards = null;&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// a bunch of guards that are and'd together</span>&nbsp;</div></li><li><div>  <span class="comment">// TODO rename to guardGroup</span>&nbsp;</div></li><li><div>  protected function guardGroup(&$guardGroup) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $guardGroup = array();&nbsp;</div></li><li><div>      while ($this-&gt;guard($guard)) {&nbsp;</div></li><li><div>          $guardGroup[] = $guard;&nbsp;</div></li><li><div>          if (!$this-&gt;literal(&quot;and&quot;)) break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($guardGroup) == 0) {&nbsp;</div></li><li><div>          $guardGroup = null;&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function guard(&$guard) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $negate = $this-&gt;literal(&quot;not&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;) && $this-&gt;expression($exp) && $this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>          $guard = $exp;&nbsp;</div></li><li><div>          if ($negate) $guard = array(&quot;negate&quot;, $guard);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** raw parsing functions */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function literal($what, $eatWhitespace = null) {&nbsp;</div></li><li><div>      if ($eatWhitespace === null) $eatWhitespace = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// shortcut on single letter</span>&nbsp;</div></li><li><div>      if (!isset($what[1]) && isset($this-&gt;buffer[$this-&gt;count])) {&nbsp;</div></li><li><div>          if ($this-&gt;buffer[$this-&gt;count] == $what) {&nbsp;</div></li><li><div>              if (!$eatWhitespace) {&nbsp;</div></li><li><div>                  $this-&gt;count++;&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// goes below...</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset(self::$literalCache[$what])) {&nbsp;</div></li><li><div>          self::$literalCache[$what] = lessc::preg_quote($what);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;match(self::$literalCache[$what], $m, $eatWhitespace);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function genericList(&$out, $parseItem, $delim=&quot;&quot;, $flatten=true) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $items = array();&nbsp;</div></li><li><div>      while ($this-&gt;$parseItem($value)) {&nbsp;</div></li><li><div>          $items[] = $value;&nbsp;</div></li><li><div>          if ($delim) {&nbsp;</div></li><li><div>              if (!$this-&gt;literal($delim)) break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($items) == 0) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($flatten && count($items) == 1) {&nbsp;</div></li><li><div>          $out = $items[0];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $out = array(&quot;list&quot;, $delim, $items);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// advance counter to next occurrence of $what</span>&nbsp;</div></li><li><div>  <span class="comment">// $until - don't include $what in advance</span>&nbsp;</div></li><li><div>  <span class="comment">// $allowNewline, if string, will be used as valid char set</span>&nbsp;</div></li><li><div>  protected function to($what, &$out, $until = false, $allowNewline = false) {&nbsp;</div></li><li><div>      if (is_string($allowNewline)) {&nbsp;</div></li><li><div>          $validChars = $allowNewline;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $validChars = $allowNewline ? &quot;.&quot; : &quot;[^\n]&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$this-&gt;match('('.$validChars.'*?)'.lessc::preg_quote($what), $m, !$until)) return false;&nbsp;</div></li><li><div>      if ($until) $this-&gt;count -= strlen($what); <span class="comment">// give back $what</span>&nbsp;</div></li><li><div>      $out = $m[1];&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// try to match something on head of buffer</span>&nbsp;</div></li><li><div>  protected function match($regex, &$out, $eatWhitespace = null) {&nbsp;</div></li><li><div>      if ($eatWhitespace === null) $eatWhitespace = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = '/'.$regex.($eatWhitespace && !$this-&gt;writeComments ? '\s*' : '').'/Ais';&nbsp;</div></li><li><div>      if (preg_match($r, $this-&gt;buffer, $out, null, $this-&gt;count)) {&nbsp;</div></li><li><div>          $this-&gt;count += strlen($out[0]);&nbsp;</div></li><li><div>          if ($eatWhitespace && $this-&gt;writeComments) $this-&gt;whitespace();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// match some whitespace</span>&nbsp;</div></li><li><div>  protected function whitespace() {&nbsp;</div></li><li><div>      if ($this-&gt;writeComments) {&nbsp;</div></li><li><div>          $gotWhite = false;&nbsp;</div></li><li><div>          while (preg_match(self::$whitePattern, $this-&gt;buffer, $m, null, $this-&gt;count)) {&nbsp;</div></li><li><div>              if (isset($m[1]) && empty($this-&gt;commentsSeen[$this-&gt;count])) {&nbsp;</div></li><li><div>                  $this-&gt;append(array(&quot;comment&quot;, $m[1]));&nbsp;</div></li><li><div>                  $this-&gt;commentsSeen[$this-&gt;count] = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;count += strlen($m[0]);&nbsp;</div></li><li><div>              $gotWhite = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $gotWhite;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;match(&quot;&quot;, $m);&nbsp;</div></li><li><div>          return strlen($m[0]) &gt; 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// match something without consuming it</span>&nbsp;</div></li><li><div>  protected function peek($regex, &$out = null, $from=null) {&nbsp;</div></li><li><div>      if (is_null($from)) $from = $this-&gt;count;&nbsp;</div></li><li><div>      $r = '/'.$regex.'/Ais';&nbsp;</div></li><li><div>      $result = preg_match($r, $this-&gt;buffer, $out, null, $from);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// seek to a spot in the buffer or return where we are on no argument</span>&nbsp;</div></li><li><div>  protected function seek($where = null) {&nbsp;</div></li><li><div>      if ($where === null) return $this-&gt;count;&nbsp;</div></li><li><div>      else $this-&gt;count = $where;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** misc functions */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function throwError($msg = &quot;parse error&quot;, $count = null) {&nbsp;</div></li><li><div>      $count = is_null($count) ? $this-&gt;count : $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $line = $this-&gt;line +&nbsp;</div></li><li><div>          substr_count(substr($this-&gt;buffer, 0, $count), &quot;\n&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($this-&gt;sourceName)) {&nbsp;</div></li><li><div>          $loc = &quot;$this-&gt;sourceName on line $line&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $loc = &quot;line: $line&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// TODO this depends on $this-&gt;count</span>&nbsp;</div></li><li><div>      if ($this-&gt;peek(&quot;(.*?)(\n|$)&quot;, $m, $count)) {&nbsp;</div></li><li><div>          throw new exception(&quot;$msg: failed at `$m[1]` $loc&quot;);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          throw new exception(&quot;$msg: $loc&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function pushBlock($selectors=null, $type=null) {&nbsp;</div></li><li><div>      $b = new stdclass;&nbsp;</div></li><li><div>      $b-&gt;parent = $this-&gt;env;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $b-&gt;type = $type;&nbsp;</div></li><li><div>      $b-&gt;id = self::$nextBlockId++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $b-&gt;isVararg = false; <span class="comment">// TODO: kill me from here</span>&nbsp;</div></li><li><div>      $b-&gt;tags = $selectors;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $b-&gt;props = array();&nbsp;</div></li><li><div>      $b-&gt;children = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = $b;&nbsp;</div></li><li><div>      return $b;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// push a block that doesn't multiply tags</span>&nbsp;</div></li><li><div>  protected function pushSpecialBlock($type) {&nbsp;</div></li><li><div>      return $this-&gt;pushBlock(null, $type);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// append a property to the current block</span>&nbsp;</div></li><li><div>  protected function append($prop, $pos = null) {&nbsp;</div></li><li><div>      if ($pos !== null) $prop[-1] = $pos;&nbsp;</div></li><li><div>      $this-&gt;env-&gt;props[] = $prop;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// pop something off the stack</span></span>&nbsp;</div></li><li><div>  protected function pop() {&nbsp;</div></li><li><div>      $old = $this-&gt;env;&nbsp;</div></li><li><div>      $this-&gt;env = $this-&gt;env-&gt;parent;&nbsp;</div></li><li><div>      return $old;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove comments from $text</span>&nbsp;</div></li><li><div>  <span class="comment">// todo: make it work for all functions, not just url</span>&nbsp;</div></li><li><div>  protected function removeComments($text) {&nbsp;</div></li><li><div>      $look = array(&nbsp;</div></li><li><div>          'url(', '<span class="comment">//', '/*', '&quot;', &quot;'&quot;</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = '';&nbsp;</div></li><li><div>      $min = null;&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          <span class="comment">// find the next item</span>&nbsp;</div></li><li><div>          foreach ($look as $token) {&nbsp;</div></li><li><div>              $pos = strpos($text, $token);&nbsp;</div></li><li><div>              if ($pos !== false) {&nbsp;</div></li><li><div>                  if (!isset($min) || $pos &lt; $min[1]) $min = array($token, $pos);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_null($min)) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $count = $min[1];&nbsp;</div></li><li><div>          $skip = 0;&nbsp;</div></li><li><div>          $newlines = 0;&nbsp;</div></li><li><div>          switch ($min[0]) {&nbsp;</div></li><li><div>          case 'url(':&nbsp;</div></li><li><div>              if (preg_match('/url\(.*?\)/', $text, $m, 0, $count))&nbsp;</div></li><li><div>                  $count += strlen($m[0]) - strlen($min[0]);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '&quot;':&nbsp;</div></li><li><div>          case &quot;'&quot;:&nbsp;</div></li><li><div>              if (preg_match('/'.$min[0].'.*?(?&lt;!\\\\)'.$min[0].'/', $text, $m, 0, $count))&nbsp;</div></li><li><div>                  $count += strlen($m[0]) - 1;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '<span class="comment">//':</span>&nbsp;</div></li><li><div>              $skip = strpos($text, &quot;\n&quot;, $count);&nbsp;</div></li><li><div>              if ($skip === false) $skip = strlen($text) - $count;&nbsp;</div></li><li><div>              else $skip -= $count;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '/*':&nbsp;</div></li><li><div>              if (preg_match('/\/\*.*?\*\<span class="comment">//s', $text, $m, 0, $count)) {</span>&nbsp;</div></li><li><div>                  $skip = strlen($m[0]);&nbsp;</div></li><li><div>                  $newlines = substr_count($m[0], &quot;\n&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($skip == 0) $count += strlen($min[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $out .= substr($text, 0, $count).str_repeat(&quot;\n&quot;, $newlines);&nbsp;</div></li><li><div>          $text = substr($text, $count + $skip);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $min = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out.$text;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class lessc_formatter_classic {&nbsp;</div></li><li><div>  public $indentChar = &quot;  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $break = &quot;\n&quot;;&nbsp;</div></li><li><div>  public $open = &quot; {&quot;;&nbsp;</div></li><li><div>  public $close = &quot;}&quot;;&nbsp;</div></li><li><div>  public $selectorSeparator = &quot;, &quot;;&nbsp;</div></li><li><div>  public $assignSeparator = &quot;:&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $openSingle = &quot; { &quot;;&nbsp;</div></li><li><div>  public $closeSingle = &quot; }&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $disableSingle = false;&nbsp;</div></li><li><div>  public $breakSelectors = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $compressColors = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      $this-&gt;indentLevel = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function indentStr($n = 0) {&nbsp;</div></li><li><div>      return str_repeat($this-&gt;indentChar, max($this-&gt;indentLevel + $n, 0));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function property($name, $value) {&nbsp;</div></li><li><div>      return $name . $this-&gt;assignSeparator . $value . &quot;;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function isEmpty($block) {&nbsp;</div></li><li><div>      if (empty($block-&gt;lines)) {&nbsp;</div></li><li><div>          foreach ($block-&gt;children as $child) {&nbsp;</div></li><li><div>              if (!$this-&gt;isEmpty($child)) return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function block($block) {&nbsp;</div></li><li><div>      if ($this-&gt;isEmpty($block)) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inner = $pre = $this-&gt;indentStr();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $isSingle = !$this-&gt;disableSingle &&&nbsp;</div></li><li><div>          is_null($block-&gt;type) && count($block-&gt;lines) == 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          $this-&gt;indentLevel++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;breakSelectors) {&nbsp;</div></li><li><div>              $selectorSeparator = $this-&gt;selectorSeparator . $this-&gt;break . $pre;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $selectorSeparator = $this-&gt;selectorSeparator;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo $pre .&nbsp;</div></li><li><div>              implode($selectorSeparator, $block-&gt;selectors);&nbsp;</div></li><li><div>          if ($isSingle) {&nbsp;</div></li><li><div>              echo $this-&gt;openSingle;&nbsp;</div></li><li><div>              $inner = &quot;&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo $this-&gt;open . $this-&gt;break;&nbsp;</div></li><li><div>              $inner = $this-&gt;indentStr();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;lines)) {&nbsp;</div></li><li><div>          $glue = $this-&gt;break.$inner;&nbsp;</div></li><li><div>          echo $inner . implode($glue, $block-&gt;lines);&nbsp;</div></li><li><div>          if (!$isSingle && !empty($block-&gt;children)) {&nbsp;</div></li><li><div>              echo $this-&gt;break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $child) {&nbsp;</div></li><li><div>          $this-&gt;block($child);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          if (!$isSingle && empty($block-&gt;children)) echo $this-&gt;break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($isSingle) {&nbsp;</div></li><li><div>              echo $this-&gt;closeSingle . $this-&gt;break;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo $pre . $this-&gt;close . $this-&gt;break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;indentLevel--;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class lessc_formatter_compressed extends lessc_formatter_classic {&nbsp;</div></li><li><div>  public $disableSingle = true;&nbsp;</div></li><li><div>  public $open = &quot;{&quot;;&nbsp;</div></li><li><div>  public $selectorSeparator = &quot;, &quot;;&nbsp;</div></li><li><div>  public $assignSeparator = &quot;:&quot;;&nbsp;</div></li><li><div>  public $break = &quot;&quot;;&nbsp;</div></li><li><div>  public $compressColors = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function indentStr($n = 0) {&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class lessc_formatter_lessjs extends lessc_formatter_classic {&nbsp;</div></li><li><div>  public $disableSingle = true;&nbsp;</div></li><li><div>  public $breakSelectors = true;&nbsp;</div></li><li><div>  public $assignSeparator = &quot;: &quot;;&nbsp;</div></li><li><div>  public $selectorSeparator = &quot;, &quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WordPress Twitter Bootstrap CSS</li><li><span></span>3.3.7-1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>