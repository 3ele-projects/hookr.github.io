<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.9" data-slug="paid-memberships-pro" data-type="file" data-id="74688"><head xmlns="http://www.w3.org/1999/xhtml"><title> preheaders-checkout | file | Paid Memberships Pro | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paid-memberships-pro, 1.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=cae4fc9df95f40429ed7c5f035edb094' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/preheaders-checkout/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fpreheaders-checkout%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fpreheaders-checkout%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paid-memberships-pro-1.9-file-preheaders-checkout","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="preheaders-checkout" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paid-memberships-pro." href="http://hookr.io/plugins/paid-memberships-pro/" class="plugin"><span property="name">paid-memberships-pro</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9." href="http://hookr.io/plugins/paid-memberships-pro/1.9/" class="H_VERSION"><span property="name">1.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paid-memberships-pro/1.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">preheaders-checkout</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1062"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/all/" title="All">All <span class="count badge">1062</span></a></li><li class="" data-id="new" data-count="186"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/new/" title="New">New <span class="count badge">186</span></a></li><li class="" data-id="hooks" data-count="398"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/hooks/" title="Hooks">Hooks <span class="count badge">398</span></a></li><li class="" data-id="action" data-count="92"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/actions/" title="Actions">Actions <span class="count badge">92</span></a></li><li class="" data-id="filter" data-count="306"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/filters/" title="Filters">Filters <span class="count badge">306</span></a></li><li class="" data-id="class" data-count="346"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/classes/" title="Classes">Classes <span class="count badge">346</span></a></li><li class="" data-id="constant" data-count="29"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/constants/" title="Constants">Constants <span class="count badge">29</span></a></li><li class="" data-id="function" data-count="282"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/functions/" title="Functions">Functions <span class="count badge">282</span></a></li><li class="" data-id="shortcode" data-count="7"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">7</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/preheaders/checkout.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>global $post, $gateway, $wpdb, $besecure, $discount_code, $discount_code_id, $pmpro_level, $pmpro_levels, $pmpro_msg, $pmpro_msgt, $pmpro_review, $skip_account_fields, $pmpro_paypal_token, $pmpro_show_discount_code, $pmpro_error_fields, $pmpro_required_billing_fields, $pmpro_required_user_fields, $wp_version, $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//make sure we know current user's membership level</span>&nbsp;</div></li><li><div>if ( $current_user-&gt;ID ) {&nbsp;</div></li><li><div>  $current_user-&gt;membership_level = pmpro_getMembershipLevelForUser( $current_user-&gt;ID );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//this var stores fields with errors so we can make them red on the frontend</span>&nbsp;</div></li><li><div>$pmpro_error_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//blank array for required fields, set below</span>&nbsp;</div></li><li><div>$pmpro_required_billing_fields = array();&nbsp;</div></li><li><div>$pmpro_required_user_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//was a gateway passed?</span>&nbsp;</div></li><li><div>if ( ! empty( $_REQUEST['gateway'] ) ) {&nbsp;</div></li><li><div>  $gateway = $_REQUEST['gateway'];&nbsp;</div></li><li><div>} elseif ( ! empty( $_REQUEST['review'] ) ) {&nbsp;</div></li><li><div>  $gateway = &quot;paypalexpress&quot;;&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $gateway = pmpro_getOption( &quot;gateway&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//set valid gateways - the active gateway in the settings and any gateway added through the filter will be allowed</span>&nbsp;</div></li><li><div>if ( pmpro_getOption( &quot;gateway&quot;, true ) == &quot;paypal&quot; ) {&nbsp;</div></li><li><div>  $valid_gateways = apply_filters( &quot;pmpro_valid_gateways&quot;, array( &quot;paypal&quot;, &quot;paypalexpress&quot; ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $valid_gateways = apply_filters( &quot;pmpro_valid_gateways&quot;, array( pmpro_getOption( &quot;gateway&quot;, true ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//let's add an error now, if an invalid gateway is set</span>&nbsp;</div></li><li><div>if ( ! in_array( $gateway, $valid_gateways ) ) {&nbsp;</div></li><li><div>  $pmpro_msg = __( &quot;Invalid gateway.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>  $pmpro_msgt = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//what level are they purchasing? (discount code passed)</span>&nbsp;</div></li><li><div>$pmpro_level = pmpro_getLevelAtCheckout();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( empty( $pmpro_level-&gt;id ) ) {&nbsp;</div></li><li><div>  wp_redirect( pmpro_url( &quot;levels&quot; ) );&nbsp;</div></li><li><div>  exit( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//enqueue some scripts</span>&nbsp;</div></li><li><div>wp_enqueue_script( 'jquery.creditCardValidator', plugins_url( '/js/jquery.creditCardValidator.js', dirname( __FILE__ ) ), array( 'jquery' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>global $wpdb, $current_user, $pmpro_requirebilling;&nbsp;</div></li><li><div><span class="comment">//unless we're submitting a form, let's try to figure out if https should be used</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! pmpro_isLevelFree( $pmpro_level ) ) {&nbsp;</div></li><li><div>  <span class="comment">//require billing and ssl</span>&nbsp;</div></li><li><div>  $pagetitle = __( &quot;Checkout: Payment Information&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>  $pmpro_requirebilling = true;&nbsp;</div></li><li><div>  $besecure = pmpro_getOption( &quot;use_ssl&quot; );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  <span class="comment">//no payment so we don't need ssl</span>&nbsp;</div></li><li><div>  $pagetitle = __( &quot;Set Up Your Account&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>  $pmpro_requirebilling = false;&nbsp;</div></li><li><div>  $besecure = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//in case a discount code was used or something else made the level free, but we're already over ssl</span>&nbsp;</div></li><li><div>if ( ! $besecure && ! empty( $_REQUEST['submit-checkout'] ) && is_ssl() ) {&nbsp;</div></li><li><div>  $besecure = true;&nbsp;</div></li><li><div>}    <span class="comment">//be secure anyway since we're already checking out</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//action to run extra code for gateways/etc</span>&nbsp;</div></li><li><div>do_action( 'pmpro_checkout_preheader' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//get all levels in case we need them</span>&nbsp;</div></li><li><div>global $pmpro_levels;&nbsp;</div></li><li><div>$pmpro_levels = pmpro_getAllLevels();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//should we show the discount code field?</span>&nbsp;</div></li><li><div>if ( $wpdb-&gt;get_var( &quot;SELECT id FROM $wpdb-&gt;pmpro_discount_codes LIMIT 1&quot; ) ) {&nbsp;</div></li><li><div>  $pmpro_show_discount_code = true;&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $pmpro_show_discount_code = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>$pmpro_show_discount_code = apply_filters( &quot;pmpro_show_discount_code&quot;, $pmpro_show_discount_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//by default we show the account fields if the user isn't logged in</span>&nbsp;</div></li><li><div>if ( $current_user-&gt;ID ) {&nbsp;</div></li><li><div>  $skip_account_fields = true;&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $skip_account_fields = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">//in case people want to have an account created automatically</span>&nbsp;</div></li><li><div>$skip_account_fields = apply_filters( &quot;pmpro_skip_account_fields&quot;, $skip_account_fields, $current_user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//some options</span>&nbsp;</div></li><li><div>global $tospage;&nbsp;</div></li><li><div>$tospage = pmpro_getOption( &quot;tospage&quot; );&nbsp;</div></li><li><div>if ( $tospage ) {&nbsp;</div></li><li><div>  $tospage = get_post( $tospage );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//load em up (other fields)</span>&nbsp;</div></li><li><div>global $username, $password, $password2, $bfirstname, $blastname, $baddress1, $baddress2, $bcity, $bstate, $bzipcode, $bcountry, $bphone, $bemail, $bconfirmemail, $CardType, $AccountNumber, $ExpirationMonth, $ExpirationYear;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['order_id'] ) ) {&nbsp;</div></li><li><div>  $order_id = intval( $_REQUEST['order_id'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $order_id = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bfirstname'] ) ) {&nbsp;</div></li><li><div>  $bfirstname = sanitize_text_field( stripslashes( $_REQUEST['bfirstname'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bfirstname = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['blastname'] ) ) {&nbsp;</div></li><li><div>  $blastname = sanitize_text_field( stripslashes( $_REQUEST['blastname'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $blastname = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['fullname'] ) ) {&nbsp;</div></li><li><div>  $fullname = $_REQUEST['fullname'];&nbsp;</div></li><li><div>}        <span class="comment">//honeypot for spammers</span>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['baddress1'] ) ) {&nbsp;</div></li><li><div>  $baddress1 = sanitize_text_field( stripslashes( $_REQUEST['baddress1'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $baddress1 = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['baddress2'] ) ) {&nbsp;</div></li><li><div>  $baddress2 = sanitize_text_field( stripslashes( $_REQUEST['baddress2'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $baddress2 = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bcity'] ) ) {&nbsp;</div></li><li><div>  $bcity = sanitize_text_field( stripslashes( $_REQUEST['bcity'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bcity = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bstate'] ) ) {&nbsp;</div></li><li><div>  $bstate = sanitize_text_field( stripslashes( $_REQUEST['bstate'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bstate = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//convert long state names to abbreviations</span>&nbsp;</div></li><li><div>if ( ! empty( $bstate ) ) {&nbsp;</div></li><li><div>  global $pmpro_states;&nbsp;</div></li><li><div>  foreach ( $pmpro_states as $abbr =&gt; $state ) {&nbsp;</div></li><li><div>      if ( $bstate == $state ) {&nbsp;</div></li><li><div>          $bstate = $abbr;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bzipcode'] ) ) {&nbsp;</div></li><li><div>  $bzipcode = sanitize_text_field( stripslashes( $_REQUEST['bzipcode'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bzipcode = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bcountry'] ) ) {&nbsp;</div></li><li><div>  $bcountry = sanitize_text_field( stripslashes( $_REQUEST['bcountry'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bcountry = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bphone'] ) ) {&nbsp;</div></li><li><div>  $bphone = sanitize_text_field( stripslashes( $_REQUEST['bphone'] ) );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bphone = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset ( $_REQUEST['bemail'] ) ) {&nbsp;</div></li><li><div>  $bemail = sanitize_email( stripslashes( $_REQUEST['bemail'] ) );&nbsp;</div></li><li><div>} elseif ( is_user_logged_in() ) {&nbsp;</div></li><li><div>  $bemail = $current_user-&gt;user_email;&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bemail = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['bconfirmemail_copy'] ) ) {&nbsp;</div></li><li><div>  $bconfirmemail = $bemail;&nbsp;</div></li><li><div>} elseif ( isset( $_REQUEST['bconfirmemail'] ) ) {&nbsp;</div></li><li><div>  $bconfirmemail = sanitize_email( stripslashes( $_REQUEST['bconfirmemail'] ) );&nbsp;</div></li><li><div>} elseif ( is_user_logged_in() ) {&nbsp;</div></li><li><div>  $bconfirmemail = $current_user-&gt;user_email;&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $bconfirmemail = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['CardType'] ) && ! empty( $_REQUEST['AccountNumber'] ) ) {&nbsp;</div></li><li><div>  $CardType = sanitize_text_field( $_REQUEST['CardType'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $CardType = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['AccountNumber'] ) ) {&nbsp;</div></li><li><div>  $AccountNumber = sanitize_text_field( $_REQUEST['AccountNumber'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $AccountNumber = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['ExpirationMonth'] ) ) {&nbsp;</div></li><li><div>  $ExpirationMonth = sanitize_text_field( $_REQUEST['ExpirationMonth'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $ExpirationMonth = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['ExpirationYear'] ) ) {&nbsp;</div></li><li><div>  $ExpirationYear = sanitize_text_field( $_REQUEST['ExpirationYear'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $ExpirationYear = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['CVV'] ) ) {&nbsp;</div></li><li><div>  $CVV = sanitize_text_field( $_REQUEST['CVV'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $CVV = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['discount_code'] ) ) {&nbsp;</div></li><li><div>  $discount_code = preg_replace( &quot;/[^A-Za-z0-9\-]/&quot;, &quot;&quot;, $_REQUEST['discount_code'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $discount_code = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['username'] ) ) {&nbsp;</div></li><li><div>  $username = sanitize_user( $_REQUEST['username'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $username = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['password'] ) ) {&nbsp;</div></li><li><div>  $password = $_REQUEST['password'];&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $password = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['password2_copy'] ) ) {&nbsp;</div></li><li><div>  $password2 = $password;&nbsp;</div></li><li><div>} elseif ( isset( $_REQUEST['password2'] ) ) {&nbsp;</div></li><li><div>  $password2 = $_REQUEST['password2'];&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $password2 = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $_REQUEST['tos'] ) ) {&nbsp;</div></li><li><div>  $tos = intval( $_REQUEST['tos'] );&nbsp;</div></li><li><div>} else {&nbsp;</div></li><li><div>  $tos = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//_x stuff in case they clicked on the image button with their mouse</span>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['submit-checkout'] ) ) {&nbsp;</div></li><li><div>  $submit = $_REQUEST['submit-checkout'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( empty( $submit ) && isset( $_REQUEST['submit-checkout_x'] ) ) {&nbsp;</div></li><li><div>  $submit = $_REQUEST['submit-checkout_x'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( isset( $submit ) && $submit === &quot;0&quot; ) {&nbsp;</div></li><li><div>  $submit = true;&nbsp;</div></li><li><div>} elseif ( ! isset( $submit ) ) {&nbsp;</div></li><li><div>  $submit = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//require fields</span>&nbsp;</div></li><li><div>$pmpro_required_billing_fields = array(&nbsp;</div></li><li><div>  &quot;bfirstname&quot; =&gt; $bfirstname, &nbsp;</div></li><li><div>  &quot;blastname&quot; =&gt; $blastname, &nbsp;</div></li><li><div>  &quot;baddress1&quot; =&gt; $baddress1, &nbsp;</div></li><li><div>  &quot;bcity&quot; =&gt; $bcity, &nbsp;</div></li><li><div>  &quot;bstate&quot; =&gt; $bstate, &nbsp;</div></li><li><div>  &quot;bzipcode&quot; =&gt; $bzipcode, &nbsp;</div></li><li><div>  &quot;bphone&quot; =&gt; $bphone, &nbsp;</div></li><li><div>  &quot;bemail&quot; =&gt; $bemail, &nbsp;</div></li><li><div>  &quot;bcountry&quot; =&gt; $bcountry, &nbsp;</div></li><li><div>  &quot;CardType&quot; =&gt; $CardType, &nbsp;</div></li><li><div>  &quot;AccountNumber&quot; =&gt; $AccountNumber, &nbsp;</div></li><li><div>  &quot;ExpirationMonth&quot; =&gt; $ExpirationMonth, &nbsp;</div></li><li><div>  &quot;ExpirationYear&quot; =&gt; $ExpirationYear, &nbsp;</div></li><li><div>  &quot;CVV&quot; =&gt; $CVV&nbsp;</div></li><li><div>);&nbsp;</div></li><li><div>$pmpro_required_billing_fields = apply_filters( &quot;pmpro_required_billing_fields&quot;, $pmpro_required_billing_fields );&nbsp;</div></li><li><div>$pmpro_required_user_fields = array(&nbsp;</div></li><li><div>  &quot;username&quot; =&gt; $username, &nbsp;</div></li><li><div>  &quot;password&quot; =&gt; $password, &nbsp;</div></li><li><div>  &quot;password2&quot; =&gt; $password2, &nbsp;</div></li><li><div>  &quot;bemail&quot; =&gt; $bemail, &nbsp;</div></li><li><div>  &quot;bconfirmemail&quot; =&gt; $bconfirmemail&nbsp;</div></li><li><div>);&nbsp;</div></li><li><div>$pmpro_required_user_fields = apply_filters( &quot;pmpro_required_user_fields&quot;, $pmpro_required_user_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//pmpro_confirmed is set to true later if payment goes through</span>&nbsp;</div></li><li><div>$pmpro_confirmed = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//check their fields if they clicked continue</span>&nbsp;</div></li><li><div>if ( $submit && $pmpro_msgt != &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//make sure javascript is ok</span>&nbsp;</div></li><li><div>  if ( apply_filters( &quot;pmpro_require_javascript_for_checkout&quot;, true ) && ! empty( $_REQUEST['checkjavascript'] ) && empty( $_REQUEST['javascriptok'] ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;There are JavaScript errors on the page. Please contact the webmaster.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if we're skipping the account fields and there is no user, we need to create a username and password</span>&nbsp;</div></li><li><div>  if ( $skip_account_fields && ! $current_user-&gt;ID ) {&nbsp;</div></li><li><div>      $username = pmpro_generateUsername( $bfirstname, $blastname, $bemail );&nbsp;</div></li><li><div>      if ( empty( $username ) ) {&nbsp;</div></li><li><div>          $username = pmpro_getDiscountCode();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $password = pmpro_getDiscountCode() . pmpro_getDiscountCode();    <span class="comment">//using two random discount codes</span>&nbsp;</div></li><li><div>      $password2 = $password;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check billing fields</span>&nbsp;</div></li><li><div>  if ( $pmpro_requirebilling ) {&nbsp;</div></li><li><div>      <span class="comment">//filter</span>&nbsp;</div></li><li><div>      foreach ( $pmpro_required_billing_fields as $key =&gt; $field ) {&nbsp;</div></li><li><div>          if ( ! $field ) {&nbsp;</div></li><li><div>              $pmpro_error_fields[] = $key;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check user fields</span>&nbsp;</div></li><li><div>  if ( empty( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>      foreach ( $pmpro_required_user_fields as $key =&gt; $field ) {&nbsp;</div></li><li><div>          if ( ! $field ) {&nbsp;</div></li><li><div>              $pmpro_error_fields[] = $key;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $pmpro_error_fields ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;Please complete all required fields.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $password ) && $password != $password2 ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;Your passwords do not match. Please try again.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;password&quot;;&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;password2&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $bemail ) && $bemail != $bconfirmemail ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;Your email addresses do not match. Please try again.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;bemail&quot;;&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;bconfirmemail&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $bemail ) && ! is_email( $bemail ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;The email address entered is in an invalid format. Please try again.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;bemail&quot;;&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;bconfirmemail&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $tospage ) && empty( $tos ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( sprintf( __( &quot;Please check the box to agree to the %s.&quot;, 'paid-memberships-pro' ), $tospage-&gt;post_title ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>      $pmpro_error_fields[] = &quot;tospage&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! in_array( $gateway, $valid_gateways ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;Invalid gateway.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $fullname ) ) {&nbsp;</div></li><li><div>      pmpro_setMessage( __( &quot;Are you a spammer?&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $pmpro_msgt == &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>      $pmpro_continue_registration = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $pmpro_continue_registration = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $pmpro_continue_registration = apply_filters( &quot;pmpro_registration_checks&quot;, $pmpro_continue_registration );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $pmpro_continue_registration ) {&nbsp;</div></li><li><div>      <span class="comment">//if creating a new user, check that the email and username are available</span>&nbsp;</div></li><li><div>      if ( empty( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>          $ouser = get_user_by( 'login', $username );&nbsp;</div></li><li><div>          $oldem_user = get_user_by( 'email', $bemail );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//this hook can be used to allow multiple accounts with the same email address</span>&nbsp;</div></li><li><div>          $oldemail = apply_filters( &quot;pmpro_checkout_oldemail&quot;, ( false !== $oldem_user ? $oldem_user-&gt;user_email : null ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $ouser-&gt;user_login ) ) {&nbsp;</div></li><li><div>          pmpro_setMessage( __( &quot;That username is already taken. Please try another.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>          $pmpro_error_fields[] = &quot;username&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $oldemail ) ) {&nbsp;</div></li><li><div>          pmpro_setMessage( __( &quot;That email address is already taken. Please try another.&quot;, 'paid-memberships-pro' ), &quot;pmpro_error&quot; );&nbsp;</div></li><li><div>          $pmpro_error_fields[] = &quot;bemail&quot;;&nbsp;</div></li><li><div>          $pmpro_error_fields[] = &quot;bconfirmemail&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//only continue if there are no other errors yet</span>&nbsp;</div></li><li><div>      if ( $pmpro_msgt != &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>          <span class="comment">//check recaptcha first</span>&nbsp;</div></li><li><div>          global $recaptcha;&nbsp;</div></li><li><div>          if ( ! $skip_account_fields && ( $recaptcha == 2 || ( $recaptcha == 1 && pmpro_isLevelFree( $pmpro_level ) ) ) ) {&nbsp;</div></li><li><div>              global $recaptcha_privatekey;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_POST[&quot;recaptcha_challenge_field&quot;] ) ) {&nbsp;</div></li><li><div>                  <span class="comment">//using older recaptcha lib</span>&nbsp;</div></li><li><div>                  $resp = recaptcha_check_answer( $recaptcha_privatekey, &nbsp;</div></li><li><div>                      $_SERVER[&quot;REMOTE_ADDR&quot;], &nbsp;</div></li><li><div>                      $_POST[&quot;recaptcha_challenge_field&quot;], &nbsp;</div></li><li><div>                      $_POST[&quot;recaptcha_response_field&quot;] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $recaptcha_valid = $resp-&gt;is_valid;&nbsp;</div></li><li><div>                  $recaptcha_errors = $resp-&gt;error;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">//using newer recaptcha lib</span>&nbsp;</div></li><li><div>                  $reCaptcha = new pmpro_ReCaptcha( $recaptcha_privatekey );&nbsp;</div></li><li><div>                  $resp = $reCaptcha-&gt;verifyResponse( $_SERVER[&quot;REMOTE_ADDR&quot;], $_POST[&quot;g-recaptcha-response&quot;] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $recaptcha_valid = $resp-&gt;success;&nbsp;</div></li><li><div>                  $recaptcha_errors = $resp-&gt;errorCodes;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $recaptcha_valid ) {&nbsp;</div></li><li><div>                  $pmpro_msg = sprintf( __( &quot;reCAPTCHA failed. (%s) Please try again.&quot;, 'paid-memberships-pro' ), $recaptcha_errors );&nbsp;</div></li><li><div>                  $pmpro_msgt = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// Your code here to handle a successful verification</span>&nbsp;</div></li><li><div>                  if ( $pmpro_msgt != &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>                      $pmpro_msg = &quot;All good!&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $pmpro_msgt != &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>                  $pmpro_msg = &quot;All good!&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//no errors yet</span>&nbsp;</div></li><li><div>          if ( $pmpro_msgt != &quot;pmpro_error&quot; ) {&nbsp;</div></li><li><div>              do_action( 'pmpro_checkout_before_processing' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//process checkout if required</span>&nbsp;</div></li><li><div>              if ( $pmpro_requirebilling ) {&nbsp;</div></li><li><div>                  $morder = new MemberOrder();&nbsp;</div></li><li><div>                  $morder-&gt;membership_id = $pmpro_level-&gt;id;&nbsp;</div></li><li><div>                  $morder-&gt;membership_name = $pmpro_level-&gt;name;&nbsp;</div></li><li><div>                  $morder-&gt;discount_code = $discount_code;&nbsp;</div></li><li><div>                  $morder-&gt;InitialPayment = $pmpro_level-&gt;initial_payment;&nbsp;</div></li><li><div>                  $morder-&gt;PaymentAmount = $pmpro_level-&gt;billing_amount;&nbsp;</div></li><li><div>                  $morder-&gt;ProfileStartDate = date_i18n( &quot;Y-m-d&quot;, current_time( &quot;timestamp&quot; ) ) . &quot;T0:0:0&quot;;&nbsp;</div></li><li><div>                  $morder-&gt;BillingPeriod = $pmpro_level-&gt;cycle_period;&nbsp;</div></li><li><div>                  $morder-&gt;BillingFrequency = $pmpro_level-&gt;cycle_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $pmpro_level-&gt;billing_limit ) {&nbsp;</div></li><li><div>                      $morder-&gt;TotalBillingCycles = $pmpro_level-&gt;billing_limit;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( pmpro_isLevelTrial( $pmpro_level ) ) {&nbsp;</div></li><li><div>                      $morder-&gt;TrialBillingPeriod = $pmpro_level-&gt;cycle_period;&nbsp;</div></li><li><div>                      $morder-&gt;TrialBillingFrequency = $pmpro_level-&gt;cycle_number;&nbsp;</div></li><li><div>                      $morder-&gt;TrialBillingCycles = $pmpro_level-&gt;trial_limit;&nbsp;</div></li><li><div>                      $morder-&gt;TrialAmount = $pmpro_level-&gt;trial_amount;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//credit card values</span>&nbsp;</div></li><li><div>                  $morder-&gt;cardtype = $CardType;&nbsp;</div></li><li><div>                  $morder-&gt;accountnumber = $AccountNumber;&nbsp;</div></li><li><div>                  $morder-&gt;expirationmonth = $ExpirationMonth;&nbsp;</div></li><li><div>                  $morder-&gt;expirationyear = $ExpirationYear;&nbsp;</div></li><li><div>                  $morder-&gt;ExpirationDate = $ExpirationMonth . $ExpirationYear;&nbsp;</div></li><li><div>                  $morder-&gt;ExpirationDate_YdashM = $ExpirationYear . &quot;-&quot; . $ExpirationMonth;&nbsp;</div></li><li><div>                  $morder-&gt;CVV2 = $CVV;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//not saving email in order table, but the sites need it</span>&nbsp;</div></li><li><div>                  $morder-&gt;Email = $bemail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//sometimes we need these split up</span>&nbsp;</div></li><li><div>                  $morder-&gt;FirstName = $bfirstname;&nbsp;</div></li><li><div>                  $morder-&gt;LastName = $blastname;&nbsp;</div></li><li><div>                  $morder-&gt;Address1 = $baddress1;&nbsp;</div></li><li><div>                  $morder-&gt;Address2 = $baddress2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//other values</span>&nbsp;</div></li><li><div>                  $morder-&gt;billing = new stdClass();&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;name = $bfirstname . &quot; &quot; . $blastname;&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;street = trim( $baddress1 . &quot; &quot; . $baddress2 );&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;city = $bcity;&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;state = $bstate;&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;country = $bcountry;&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;zip = $bzipcode;&nbsp;</div></li><li><div>                  $morder-&gt;billing-&gt;phone = $bphone;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//$gateway = pmpro_getOption(&quot;gateway&quot;);</span>&nbsp;</div></li><li><div>                  $morder-&gt;gateway = $gateway;&nbsp;</div></li><li><div>                  $morder-&gt;setGateway();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//setup level var</span>&nbsp;</div></li><li><div>                  $morder-&gt;getMembershipLevel();&nbsp;</div></li><li><div>                  $morder-&gt;membership_level = apply_filters( &quot;pmpro_checkout_level&quot;, $morder-&gt;membership_level );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//tax</span>&nbsp;</div></li><li><div>                  $morder-&gt;subtotal = $morder-&gt;InitialPayment;&nbsp;</div></li><li><div>                  $morder-&gt;getTax();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//filter</span> for order, since v1.8&nbsp;</div></li><li><div>                  $morder = apply_filters( &quot;pmpro_checkout_order&quot;, $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $pmpro_processed = $morder-&gt;process();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $pmpro_processed ) ) {&nbsp;</div></li><li><div>                      $pmpro_msg = __( &quot;Payment accepted.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>                      $pmpro_msgt = &quot;pmpro_success&quot;;&nbsp;</div></li><li><div>                      $pmpro_confirmed = true;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $pmpro_msg = !empty( $morder-&gt;error ) ? $morder-&gt;error : null;&nbsp;</div></li><li><div>                      if ( empty( $pmpro_msg ) ) {&nbsp;</div></li><li><div>                          $pmpro_msg = __( &quot;Unknown error generating account. Please contact us to set up your membership.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $pmpro_msgt = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else <span class="comment">// !$pmpro_requirebilling</span>&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  <span class="comment">//must have been a free membership, continue</span>&nbsp;</div></li><li><div>                  $pmpro_confirmed = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }    <span class="comment">//endif ($pmpro_continue_registration)</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//make sure we have at least an empty morder here to avoid a warning</span>&nbsp;</div></li><li><div>if ( empty( $morder ) ) {&nbsp;</div></li><li><div>  $morder = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Hook to check payment confirmation or replace it. If we get an array back, pull the values (morder) out</span>&nbsp;</div></li><li><div>$pmpro_confirmed = apply_filters( 'pmpro_checkout_confirmed', $pmpro_confirmed, $morder );&nbsp;</div></li><li><div>if ( is_array( $pmpro_confirmed ) ) {&nbsp;</div></li><li><div>  extract( $pmpro_confirmed );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//if payment was confirmed create/update the user.</span>&nbsp;</div></li><li><div>if ( ! empty( $pmpro_confirmed ) ) {&nbsp;</div></li><li><div>  <span class="comment">//just in case this hasn't been set yet</span>&nbsp;</div></li><li><div>  $submit = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//do we need to create a user account?</span>&nbsp;</div></li><li><div>  if ( ! $current_user-&gt;ID ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">          create user</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      if ( version_compare( $wp_version, &quot;3.1&quot; ) &lt; 0 ) {&nbsp;</div></li><li><div>          require_once( ABSPATH . WPINC . '/registration.php' );&nbsp;</div></li><li><div>      }    <span class="comment">//need this for WP versions before 3.1</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//first name</span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['first_name'] ) ) {&nbsp;</div></li><li><div>          $first_name = $_REQUEST['first_name'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $first_name = $bfirstname;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//last name</span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['last_name'] ) ) {&nbsp;</div></li><li><div>          $last_name = $_REQUEST['last_name'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $last_name = $blastname;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//insert user</span>&nbsp;</div></li><li><div>      $new_user_array = apply_filters( 'pmpro_checkout_new_user_array', array(&nbsp;</div></li><li><div>              &quot;user_login&quot; =&gt; $username, &nbsp;</div></li><li><div>              &quot;user_pass&quot; =&gt; $password, &nbsp;</div></li><li><div>              &quot;user_email&quot; =&gt; $bemail, &nbsp;</div></li><li><div>              &quot;first_name&quot; =&gt; $first_name, &nbsp;</div></li><li><div>              &quot;last_name&quot; =&gt; $last_name&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_id = apply_filters( 'pmpro_new_user', '', $new_user_array );&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          $user_id = wp_insert_user( $new_user_array );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user_id ) || is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>          $e_msg = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>              $e_msg = $user_id-&gt;get_error_message();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pmpro_msg = __( &quot;Your payment was accepted, but there was an error setting up your account. Please contact us.&quot;, 'paid-memberships-pro' ) . sprintf( &quot; %s&quot;, $e_msg ); <span class="comment">// Dirty 'don't break translation hack.</span>&nbsp;</div></li><li><div>          $pmpro_msgt = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>      } elseif ( apply_filters( 'pmpro_setup_new_user', true, $user_id, $new_user_array, $pmpro_level ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//check pmpro_wp_new_user_notification filter before sending the default WP email</span>&nbsp;</div></li><li><div>          if ( apply_filters( &quot;pmpro_wp_new_user_notification&quot;, true, $user_id, $pmpro_level-&gt;id ) ) {&nbsp;</div></li><li><div>              if ( version_compare( $wp_version, &quot;4.3.0&quot; ) &gt;= 0 ) {&nbsp;</div></li><li><div>                  wp_new_user_notification( $user_id, null, 'both' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wp_new_user_notification( $user_id, $new_user_array['user_pass'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpuser = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//make the user a subscriber</span>&nbsp;</div></li><li><div>          $wpuser-&gt;set_role( get_option( 'default_role', 'subscriber' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//okay, log them in to WP</span>&nbsp;</div></li><li><div>          $creds = array();&nbsp;</div></li><li><div>          $creds['user_login'] = $new_user_array['user_login'];&nbsp;</div></li><li><div>          $creds['user_password'] = $new_user_array['user_pass'];&nbsp;</div></li><li><div>          $creds['remember'] = true;&nbsp;</div></li><li><div>          $user = wp_signon( $creds, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//setting some cookies</span>&nbsp;</div></li><li><div>          wp_set_current_user( $user_id, $username );&nbsp;</div></li><li><div>          wp_set_auth_cookie( $user_id, true, apply_filters( 'pmpro_checkout_signon_secure', force_ssl_admin() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $user_id ) && ! is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>      do_action( 'pmpro_checkout_before_change_membership_level', $user_id, $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//start date is NOW() but filterable below</span>&nbsp;</div></li><li><div>      $startdate = current_time( &quot;mysql&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the start date for the membership/subscription.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.8.9</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $startdate , datetime formatsted for MySQL (NOW() or YYYY-MM-DD)</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $user_id , ID of the user checking out</span>&nbsp;</div></li><li><div><span class="comment">       * @param object $pmpro_level , object of level being checked out for</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $startdate = apply_filters( &quot;pmpro_checkout_start_date&quot;, $startdate, $user_id, $pmpro_level );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//calculate the end date</span>&nbsp;</div></li><li><div>      if ( ! empty( $pmpro_level-&gt;expiration_number ) ) {&nbsp;</div></li><li><div>          $enddate =  date_i18n( &quot;Y-m-d&quot;, strtotime( &quot;+ &quot; . $pmpro_level-&gt;expiration_number . &quot; &quot; . $pmpro_level-&gt;expiration_period, current_time( &quot;timestamp&quot; ) ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $enddate = &quot;NULL&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the end date for the membership/subscription.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.8.9</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $enddate , datetime formatsted for MySQL (YYYY-MM-DD)</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $user_id , ID of the user checking out</span>&nbsp;</div></li><li><div><span class="comment">       * @param object $pmpro_level , object of level being checked out for</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $startdate , startdate calculated above</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $enddate = apply_filters( &quot;pmpro_checkout_end_date&quot;, $enddate, $user_id, $pmpro_level, $startdate );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//check code before adding it to the order</span>&nbsp;</div></li><li><div>      $code_check = pmpro_checkDiscountCode( $discount_code, $pmpro_level-&gt;id, true );&nbsp;</div></li><li><div>      if ( $code_check[0] == false ) {&nbsp;</div></li><li><div>          <span class="comment">//error</span>&nbsp;</div></li><li><div>          $pmpro_msg = $code_check[1];&nbsp;</div></li><li><div>          $pmpro_msgt = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//don't use this code</span>&nbsp;</div></li><li><div>          $use_discount_code = false;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">//all okay</span>&nbsp;</div></li><li><div>          $use_discount_code = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">//update membership_user table.        </span>&nbsp;</div></li><li><div>      if ( ! empty( $discount_code ) && ! empty( $use_discount_code ) ) {&nbsp;</div></li><li><div>          $discount_code_id = $wpdb-&gt;get_var( &quot;SELECT id FROM $wpdb-&gt;pmpro_discount_codes WHERE code = '&quot; . esc_sql( $discount_code ) . &quot;' LIMIT 1&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $discount_code_id = &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $custom_level = array(&nbsp;</div></li><li><div>          'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>          'membership_id' =&gt; $pmpro_level-&gt;id, &nbsp;</div></li><li><div>          'code_id' =&gt; $discount_code_id, &nbsp;</div></li><li><div>          'initial_payment' =&gt; $pmpro_level-&gt;initial_payment, &nbsp;</div></li><li><div>          'billing_amount' =&gt; $pmpro_level-&gt;billing_amount, &nbsp;</div></li><li><div>          'cycle_number' =&gt; $pmpro_level-&gt;cycle_number, &nbsp;</div></li><li><div>          'cycle_period' =&gt; $pmpro_level-&gt;cycle_period, &nbsp;</div></li><li><div>          'billing_limit' =&gt; $pmpro_level-&gt;billing_limit, &nbsp;</div></li><li><div>          'trial_amount' =&gt; $pmpro_level-&gt;trial_amount, &nbsp;</div></li><li><div>          'trial_limit' =&gt; $pmpro_level-&gt;trial_limit, &nbsp;</div></li><li><div>          'startdate' =&gt; $startdate, &nbsp;</div></li><li><div>          'enddate' =&gt; $enddate&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( pmpro_changeMembershipLevel( $custom_level, $user_id, 'changed' ) ) {&nbsp;</div></li><li><div>          <span class="comment">//we're good</span>&nbsp;</div></li><li><div>          <span class="comment">//blank order for free levels</span>&nbsp;</div></li><li><div>          if ( empty( $morder ) ) {&nbsp;</div></li><li><div>              $morder = new MemberOrder();&nbsp;</div></li><li><div>              $morder-&gt;InitialPayment = 0;&nbsp;</div></li><li><div>              $morder-&gt;Email = $bemail;&nbsp;</div></li><li><div>              $morder-&gt;gateway = &quot;free&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $morder = apply_filters( &quot;pmpro_checkout_order_free&quot;, $morder );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//add an item to the history table, cancel old subscriptions</span>&nbsp;</div></li><li><div>          if ( ! empty( $morder ) ) {&nbsp;</div></li><li><div>              $morder-&gt;user_id = $user_id;&nbsp;</div></li><li><div>              $morder-&gt;membership_id = $pmpro_level-&gt;id;&nbsp;</div></li><li><div>              $morder-&gt;saveOrder();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//update the current user</span>&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          if ( ! $current_user-&gt;ID && $user-&gt;ID ) {&nbsp;</div></li><li><div>              $current_user = $user;&nbsp;</div></li><li><div>          } <span class="comment">//in case the user just signed up</span>&nbsp;</div></li><li><div>          pmpro_set_current_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//add discount code use</span>&nbsp;</div></li><li><div>          if ( $discount_code && $use_discount_code ) {&nbsp;</div></li><li><div>              if ( ! empty( $morder-&gt;id ) ) {&nbsp;</div></li><li><div>                  $code_order_id = $morder-&gt;id;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $code_order_id = &quot;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wpdb-&gt;query( &quot;INSERT INTO $wpdb-&gt;pmpro_discount_codes_uses (code_id, user_id, order_id, timestamp) VALUES('&quot; . $discount_code_id . &quot;', '&quot; . $user_id . &quot;', '&quot; . intval( $code_order_id ) . &quot;', '&quot; . current_time( &quot;mysql&quot; ) . &quot;')&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//save billing info ect, as user meta</span>&nbsp;</div></li><li><div>          $meta_keys = array(&nbsp;</div></li><li><div>              &quot;pmpro_bfirstname&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_blastname&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_baddress1&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_baddress2&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bcity&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bstate&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bzipcode&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bcountry&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bphone&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_bemail&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_CardType&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_AccountNumber&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_ExpirationMonth&quot;, &nbsp;</div></li><li><div>              &quot;pmpro_ExpirationYear&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $meta_values = array(&nbsp;</div></li><li><div>              $bfirstname, &nbsp;</div></li><li><div>              $blastname, &nbsp;</div></li><li><div>              $baddress1, &nbsp;</div></li><li><div>              $baddress2, &nbsp;</div></li><li><div>              $bcity, &nbsp;</div></li><li><div>              $bstate, &nbsp;</div></li><li><div>              $bzipcode, &nbsp;</div></li><li><div>              $bcountry, &nbsp;</div></li><li><div>              $bphone, &nbsp;</div></li><li><div>              $bemail, &nbsp;</div></li><li><div>              $CardType, &nbsp;</div></li><li><div>              hideCardNumber( $AccountNumber ), &nbsp;</div></li><li><div>              $ExpirationMonth, &nbsp;</div></li><li><div>              $ExpirationYear&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          pmpro_replaceUserMeta( $user_id, $meta_keys, $meta_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//save first and last name fields</span>&nbsp;</div></li><li><div>          if ( ! empty( $bfirstname ) ) {&nbsp;</div></li><li><div>              $old_firstname = get_user_meta( $user_id, &quot;first_name&quot;, true );&nbsp;</div></li><li><div>              if ( empty( $old_firstname ) ) {&nbsp;</div></li><li><div>                  update_user_meta( $user_id, &quot;first_name&quot;, $bfirstname );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! empty( $blastname ) ) {&nbsp;</div></li><li><div>              $old_lastname = get_user_meta( $user_id, &quot;last_name&quot;, true );&nbsp;</div></li><li><div>              if ( empty( $old_lastname ) ) {&nbsp;</div></li><li><div>                  update_user_meta( $user_id, &quot;last_name&quot;, $blastname );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//show the confirmation</span>&nbsp;</div></li><li><div>          $ordersaved = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//hook</span>&nbsp;</div></li><li><div>          do_action( &quot;pmpro_after_checkout&quot;, $user_id, $morder );    <span class="comment">//added $morder param in v2.0</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sendemails = apply_filters( &quot;pmpro_send_checkout_emails&quot;, true);&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>          if($sendemails) { <span class="comment">// Send the e-mails only if the flag is set to true</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//setup some values for the emails</span>&nbsp;</div></li><li><div>              if ( ! empty( $morder ) ) {&nbsp;</div></li><li><div>                  $invoice = new MemberOrder( $morder-&gt;id );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $invoice = null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $current_user-&gt;membership_level = $pmpro_level; <span class="comment">//make sure they have the right level info</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//send email to member</span>&nbsp;</div></li><li><div>              $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>              $pmproemail-&gt;sendCheckoutEmail( $current_user, $invoice );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//send email to admin</span>&nbsp;</div></li><li><div>              $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>              $pmproemail-&gt;sendCheckoutAdminEmail( $current_user, $invoice );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//redirect to confirmation</span>&nbsp;</div></li><li><div>          $rurl = pmpro_url( &quot;confirmation&quot;, &quot;?level=&quot; . $pmpro_level-&gt;id );&nbsp;</div></li><li><div>          $rurl = apply_filters( &quot;pmpro_confirmation_url&quot;, $rurl, $user_id, $pmpro_level );&nbsp;</div></li><li><div>          wp_redirect( $rurl );&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//uh oh. we charged them then the membership creation failed</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// test that the order object contains data</span>&nbsp;</div></li><li><div>          $test = (array) $morder;&nbsp;</div></li><li><div>          if ( ! empty( $test ) && $morder-&gt;cancel() ) {&nbsp;</div></li><li><div>              $pmpro_msg = __( &quot;IMPORTANT: Something went wrong during membership creation. Your credit card authorized, but we cancelled the order immediately. You should not try to submit this form again. Please contact the site owner to fix this issue.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>              $morder = null;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $pmpro_msg = __( &quot;IMPORTANT: Something went wrong during membership creation. Your credit card was charged, but we couldn't assign your membership. You should not submit this form again. Please contact the site owner to fix this issue.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//default values</span>&nbsp;</div></li><li><div>if ( empty( $submit ) ) {&nbsp;</div></li><li><div>  <span class="comment">//show message if the payment gateway is not setup yet</span>&nbsp;</div></li><li><div>  if ( $pmpro_requirebilling && ! pmpro_getOption( &quot;gateway&quot;, true ) ) {&nbsp;</div></li><li><div>      if ( pmpro_isAdmin() ) {&nbsp;</div></li><li><div>          $pmpro_msg = sprintf( __( 'You must &lt;a href=&quot;%s&quot;&gt;set up a Payment Gateway&lt;/a&gt; before any payments will be processed.', 'paid-memberships-pro' ), get_admin_url( null, '/admin.php?page=pmpro-paymentsettings' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $pmpro_msg = __( &quot;A Payment Gateway must be set up before any payments will be processed.&quot;, 'paid-memberships-pro' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $pmpro_msgt = &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//default values</span> from DB&nbsp;</div></li><li><div>  if ( ! empty( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>      $bfirstname = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bfirstname&quot;, true );&nbsp;</div></li><li><div>      $blastname = get_user_meta( $current_user-&gt;ID, &quot;pmpro_blastname&quot;, true );&nbsp;</div></li><li><div>      $baddress1 = get_user_meta( $current_user-&gt;ID, &quot;pmpro_baddress1&quot;, true );&nbsp;</div></li><li><div>      $baddress2 = get_user_meta( $current_user-&gt;ID, &quot;pmpro_baddress2&quot;, true );&nbsp;</div></li><li><div>      $bcity = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bcity&quot;, true );&nbsp;</div></li><li><div>      $bstate = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bstate&quot;, true );&nbsp;</div></li><li><div>      $bzipcode = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bzipcode&quot;, true );&nbsp;</div></li><li><div>      $bcountry = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bcountry&quot;, true );&nbsp;</div></li><li><div>      $bphone = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bphone&quot;, true );&nbsp;</div></li><li><div>      $bemail = get_user_meta( $current_user-&gt;ID, &quot;pmpro_bemail&quot;, true );&nbsp;</div></li><li><div>      $bconfirmemail = $bemail;    <span class="comment">//as of 1.7.5, just setting to bemail</span>&nbsp;</div></li><li><div>      $CardType = get_user_meta( $current_user-&gt;ID, &quot;pmpro_CardType&quot;, true );&nbsp;</div></li><li><div>      <span class="comment">//$AccountNumber = hideCardNumber(get_user_meta($current_user-&gt;ID, &quot;pmpro_AccountNumber&quot;, true), false);</span>&nbsp;</div></li><li><div>      $ExpirationMonth = get_user_meta( $current_user-&gt;ID, &quot;pmpro_ExpirationMonth&quot;, true );&nbsp;</div></li><li><div>      $ExpirationYear = get_user_meta( $current_user-&gt;ID, &quot;pmpro_ExpirationYear&quot;, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//clear out XXXX numbers (e.g. with Stripe)</span>&nbsp;</div></li><li><div>if ( ! empty( $AccountNumber ) && strpos( $AccountNumber, &quot;XXXX&quot; ) === 0 ) {&nbsp;</div></li><li><div>  $AccountNumber = &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Paid Memberships Pro</li><li><span></span>1.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>