<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.9" data-slug="paid-memberships-pro" data-type="file" data-id="74709"><head xmlns="http://www.w3.org/1999/xhtml"><title> services-ipnhandler | file | Paid Memberships Pro | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paid-memberships-pro, 1.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=80fa99f8514f8c6ef2b39a4ab8d554d1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/services-ipnhandler/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fservices-ipnhandler%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fservices-ipnhandler%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paid-memberships-pro-1.9-file-services-ipnhandler","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="services-ipnhandler" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paid-memberships-pro." href="http://hookr.io/plugins/paid-memberships-pro/" class="plugin"><span property="name">paid-memberships-pro</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9." href="http://hookr.io/plugins/paid-memberships-pro/1.9/" class="H_VERSION"><span property="name">1.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paid-memberships-pro/1.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">services-ipnhandler</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1062"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/all/" title="All">All <span class="count badge">1062</span></a></li><li class="" data-id="new" data-count="186"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/new/" title="New">New <span class="count badge">186</span></a></li><li class="" data-id="hooks" data-count="398"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/hooks/" title="Hooks">Hooks <span class="count badge">398</span></a></li><li class="" data-id="action" data-count="92"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/actions/" title="Actions">Actions <span class="count badge">92</span></a></li><li class="" data-id="filter" data-count="306"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/filters/" title="Filters">Filters <span class="count badge">306</span></a></li><li class="" data-id="class" data-count="346"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/classes/" title="Classes">Classes <span class="count badge">346</span></a></li><li class="" data-id="constant" data-count="29"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/constants/" title="Constants">Constants <span class="count badge">29</span></a></li><li class="" data-id="function" data-count="282"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/functions/" title="Functions">Functions <span class="count badge">282</span></a></li><li class="" data-id="shortcode" data-count="7"><a href="http://hookr.io/plugins/paid-memberships-pro/1.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">7</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/services/ipnhandler.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">//in case the file is loaded directly</span>&nbsp;</div></li><li><div>if ( ! defined( &quot;ABSPATH&quot; ) ) {&nbsp;</div></li><li><div>  global $isapage;&nbsp;</div></li><li><div>  $isapage = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  define( 'WP_USE_THEMES', false );&nbsp;</div></li><li><div>  require_once( dirname( __FILE__ ) . '/../../../../wp-load.php' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//uncomment to log requests in logs/ipn.txt</span>&nbsp;</div></li><li><div><span class="comment">//define('PMPRO_IPN_DEBUG', true);</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//some globals</span>&nbsp;</div></li><li><div>global $wpdb, $gateway_environment, $logstr;&nbsp;</div></li><li><div>$logstr = &quot;&quot;;    <span class="comment">//will put debug info here and write to ipnlog.txt</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//validate?</span>&nbsp;</div></li><li><div>if ( ! pmpro_ipnValidate() ) {&nbsp;</div></li><li><div>  <span class="comment">//validation failed</span>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//assign posted variables to local variables</span>&nbsp;</div></li><li><div>$txn_type = pmpro_getParam( &quot;txn_type&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$subscr_id = pmpro_getParam( &quot;subscr_id&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$txn_id = pmpro_getParam( &quot;txn_id&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$item_name = pmpro_getParam( &quot;item_name&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$item_number = pmpro_getParam( &quot;item_number&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$initial_payment_status = pmpro_getParam( &quot;initial_payment_status&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$payment_status = pmpro_getParam( &quot;payment_status&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$payment_amount = pmpro_getParam( &quot;payment_amount&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$payment_currency = pmpro_getParam( &quot;payment_currency&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$receiver_email = pmpro_getParam( &quot;receiver_email&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$business_email = pmpro_getParam( &quot;business&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$payer_email = pmpro_getParam( &quot;payer_email&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$recurring_payment_id = pmpro_getParam( &quot;recurring_payment_id&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>$profile_status = strtolower( pmpro_getParam( &quot;profile_status&quot;, &quot;POST&quot; ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( empty( $subscr_id ) ) {&nbsp;</div></li><li><div>  $subscr_id = $recurring_payment_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//check the receiver_email</span>&nbsp;</div></li><li><div>if ( ! pmpro_ipnCheckReceiverEmail( array( strtolower( $receiver_email ), strtolower( $business_email ) ) ) ) {&nbsp;</div></li><li><div>  <span class="comment">//not our request</span>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  PayPal Standard</span>&nbsp;</div></li><li><div><span class="comment">  - we will get txn_type subscr_signup and subscr_payment (or subscr_eot or subscr_failed)</span>&nbsp;</div></li><li><div><span class="comment">  - subscr_signup (if amount1 = 0, then we need to update membership, else ignore and wait for payment. create invoice for $0 with just subscr_id)</span>&nbsp;</div></li><li><div><span class="comment">  - subscr_payment (check if we should update membership, add invoice for amount with subscr_id and payment_id)</span>&nbsp;</div></li><li><div><span class="comment">  - web_accept for 1-time payment only</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  PayPal Express</span>&nbsp;</div></li><li><div><span class="comment">  - we will get txn_type express_checkout, or recurring_payment_profile_created, or recurring_payment (or recurring_payment_expired, or recurring_payment_skipped)</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//PayPal Standard Sign Up</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;subscr_signup&quot; ) {&nbsp;</div></li><li><div>  <span class="comment">//if there is no amount1, this membership has a trial, and we need to update membership/etc</span>&nbsp;</div></li><li><div>  $amount = pmpro_getParam( &quot;amount1&quot;, &quot;POST&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( (float) $amount &lt;= 0 ) {&nbsp;</div></li><li><div>      <span class="comment">//trial, get the order</span>&nbsp;</div></li><li><div>      $morder = new MemberOrder( $item_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//No order?</span></span></span>&nbsp;</div></li><li><div>      if ( empty( $morder ) || empty( $morder-&gt;id ) ) {&nbsp;</div></li><li><div>          ipnlog( &quot;ERROR: No order found item_number/code = &quot; . $item_number . &quot;.&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">//get some more order info</span></span></span>&nbsp;</div></li><li><div>          $morder-&gt;getMembershipLevel();&nbsp;</div></li><li><div>          $morder-&gt;getUser();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//no txn_id on these, so let's use the subscr_id</span>&nbsp;</div></li><li><div>          if ( empty( $txn_id ) ) {&nbsp;</div></li><li><div>              $txn_id = $subscr_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Check that the corresponding order has a $0 initial payment as well</span>&nbsp;</div></li><li><div>          if ( (float) $amount != (float) $morder-&gt;total ) {&nbsp;</div></li><li><div>              ipnlog( &quot;ERROR: PayPal subscription #&quot; . $_POST['subscr_id'] . &quot; initial payment amount (&quot; . $amount . &quot;) is not the same as the PMPro order #&quot; . $morder-&gt;code . &quot; (&quot; . $morder-&gt;total . &quot;).&quot; );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">//update membership</span></span></span>&nbsp;</div></li><li><div>              if ( pmpro_ipnChangeMembershipLevel( $txn_id, $morder ) ) {&nbsp;</div></li><li><div>                  ipnlog( &quot;Checkout processed (&quot; . $morder-&gt;code . &quot;) success!&quot; );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  ipnlog( &quot;ERROR: Couldn't change level for order (&quot; . $morder-&gt;code . &quot;).&quot; );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">//we're ignoring this. we will get a payment notice from IPN and process that</span>&nbsp;</div></li><li><div>      ipnlog( &quot;Going to wait for the first payment to go through.&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//PayPal Standard Subscription Payment</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;subscr_payment&quot; ) {&nbsp;</div></li><li><div>  <span class="comment">//is this a first payment?</span>&nbsp;</div></li><li><div>  $last_subscr_order = new MemberOrder();&nbsp;</div></li><li><div>  if ( $last_subscr_order-&gt;getLastMemberOrderBySubscriptionTransactionID( $subscr_id ) == false ) {&nbsp;</div></li><li><div>      <span class="comment">//first payment, get order</span>&nbsp;</div></li><li><div>      $morder = new MemberOrder( $_POST['item_number'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//No order?</span></span></span>&nbsp;</div></li><li><div>      if ( empty( $morder ) || empty( $morder-&gt;id ) ) {&nbsp;</div></li><li><div>          ipnlog( &quot;ERROR: No order found item_number/code = &quot; . $item_number . &quot;.&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">//get some more order info</span></span></span>&nbsp;</div></li><li><div>          $morder-&gt;getMembershipLevel();&nbsp;</div></li><li><div>          $morder-&gt;getUser();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//Check that the corresponding order has the same amount</span> as what we're getting from PayPal</span>&nbsp;</div></li><li><div>          $amount = $_POST['mc_gross'];&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//Adjust gross for tax if provided</span></span>&nbsp;</div></li><li><div>          if( !empty($_POST['tax']) ) {&nbsp;</div></li><li><div>              $amount = (float)$amount - (float)$_POST['tax'];&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//TODO: We should maybe update the order to reflect the tax amount and new total</span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( (float) $amount != (float) $morder-&gt;total ) {&nbsp;</div></li><li><div>              ipnlog( &quot;ERROR: PayPal transaction #&quot; . $_POST['tnx_id'] . &quot; amount (&quot; . $amount . &quot;) is not the same as the PMPro order #&quot; . $morder-&gt;code . &quot; (&quot; . $morder-&gt;total . &quot;).&quot; );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">//update membership</span></span></span>&nbsp;</div></li><li><div>              if ( pmpro_ipnChangeMembershipLevel( $txn_id, $morder ) ) {&nbsp;</div></li><li><div>                  ipnlog( &quot;Checkout processed (&quot; . $morder-&gt;code . &quot;) success!&quot; );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  ipnlog( &quot;ERROR: Couldn't change level for order (&quot; . $morder-&gt;code . &quot;).&quot; );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//subscription payment, completed or failure?</span></span>&nbsp;</div></li><li><div>      if ( $_POST['payment_status'] == &quot;Completed&quot; ) {&nbsp;</div></li><li><div>          pmpro_ipnSaveOrder( $txn_id, $last_subscr_order );&nbsp;</div></li><li><div>      } elseif ( $_POST['payment_status'] == &quot;Failed&quot; ) {&nbsp;</div></li><li><div>          pmpro_ipnFailedPayment( $last_subscr_order );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          ipnlog( 'Payment status is ' . $_POST['payment_status'] . '.' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//PayPal Standard Single Payment</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;web_accept&quot; && ! empty( $item_number ) ) {&nbsp;</div></li><li><div>  <span class="comment">//initial payment, get the order</span>&nbsp;</div></li><li><div>  $morder = new MemberOrder( $item_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//No order?</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $morder ) || empty( $morder-&gt;id ) ) {&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: No order found item_number/code = &quot; . $item_number . &quot;.&quot; );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//get some more order info</span></span></span>&nbsp;</div></li><li><div>      $morder-&gt;getMembershipLevel();&nbsp;</div></li><li><div>      $morder-&gt;getUser();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Check that the corresponding order has the same amount</span>&nbsp;</div></li><li><div>      $amount = $_POST['mc_gross'];&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//Adjust gross for tax if provided</span></span>&nbsp;</div></li><li><div>      if(!empty($_POST['tax']) ) {&nbsp;</div></li><li><div>          $amount = (float)$amount - (float)$_POST['tax'];&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//TODO: We should maybe update the order to reflect the tax amount and new total</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>      if ( (float) $amount != (float) $morder-&gt;total ) {&nbsp;</div></li><li><div>          ipnlog( &quot;ERROR: PayPal transaction #&quot; . $_POST['txn_id'] . &quot; amount (&quot; . $amount . &quot;) is not the same as the PMPro order #&quot; . $morder-&gt;code . &quot; (&quot; . $morder-&gt;total . &quot;).&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">//update membership</span></span></span>&nbsp;</div></li><li><div>          if ( pmpro_ipnChangeMembershipLevel( $txn_id, $morder ) ) {&nbsp;</div></li><li><div>              ipnlog( &quot;Checkout processed (&quot; . $morder-&gt;code . &quot;) success!&quot; );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              ipnlog( &quot;ERROR: Couldn't change level for order (&quot; . $morder-&gt;code . &quot;).&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//PayPal Express Recurring Payments</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;recurring_payment&quot; ) {&nbsp;</div></li><li><div>  $last_subscr_order = new MemberOrder();&nbsp;</div></li><li><div>  if ( $last_subscr_order-&gt;getLastMemberOrderBySubscriptionTransactionID( $subscr_id ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//subscription payment, completed or failure?</span></span>&nbsp;</div></li><li><div>      if ( $_POST['payment_status'] == &quot;Completed&quot; ) {&nbsp;</div></li><li><div>          pmpro_ipnSaveOrder( $txn_id, $last_subscr_order );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          pmpro_ipnFailedPayment( $last_subscr_order );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: Couldn't find last order for this recurring payment (&quot; . $subscr_id . &quot;).&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( $txn_type == &quot;recurring_payment_suspended_due_to_max_failed_payment&quot; && 'suspended' == $profile_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $last_subscr_order = new MemberOrder();&nbsp;</div></li><li><div>  if ( $last_subscr_order-&gt;getLastMemberOrderBySubscriptionTransactionID( $subscr_id ) ) {&nbsp;</div></li><li><div>      <span class="comment">// the payment failed</span>&nbsp;</div></li><li><div>      pmpro_ipnFailedPayment( $last_subscr_order );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: Couldn't find last order for this recurring payment (&quot; . $subscr_id . &quot;).&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  pmpro_ipnExit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Recurring Payment Profile Cancelled (PayPal Express)</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;recurring_payment_profile_cancel&quot; ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//find last order</span></span>&nbsp;</div></li><li><div>  $last_subscr_order = new MemberOrder();&nbsp;</div></li><li><div>  if ( $last_subscr_order-&gt;getLastMemberOrderBySubscriptionTransactionID( $recurring_payment_id ) == false ) {&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: Couldn't find this order to cancel (subscription_transaction_id=&quot; . $recurring_payment_id . &quot;).&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//found order, let's cancel the membership</span></span>&nbsp;</div></li><li><div>      $user = get_userdata( $last_subscr_order-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user ) || empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          ipnlog( &quot;ERROR: Could not cancel membership. No user attached to order #&quot; . $last_subscr_order-&gt;id . &quot; with subscription transaction id = &quot; . $recurring_payment_id . &quot;.&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">              We want to make sure this is a cancel originating from PayPal and not one already handled by PMPro.</span>&nbsp;</div></li><li><div><span class="comment">              For example, if a user cancels on WP/PMPro side, we've already cancelled the membership.</span>&nbsp;</div></li><li><div><span class="comment">              Also, if a user is changing levels, we don't want to cancel their new membership, just the old subscription at PayPal.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">              So we check 2 things and don't cancel if:</span>&nbsp;</div></li><li><div><span class="comment">              (1) This order already has &quot;cancelled&quot; status.</span>&nbsp;</div></li><li><div><span class="comment">              (2) The user doesn't currently have the level attached to this order.</span>&nbsp;</div></li><li><div><span class="comment">          */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $last_subscr_order-&gt;status == &quot;cancelled&quot; ) {&nbsp;</div></li><li><div>              ipnlog( &quot;We've already processed this cancellation. Probably originated from WP/PMPro. (Order #&quot; . $last_subscr_order-&gt;id . &quot;, Subscription Transaction ID #&quot; . $recurring_payment_id . &quot;)&quot; );&nbsp;</div></li><li><div>          } elseif ( ! pmpro_hasMembershipLevel( $last_subsc_order-&gt;membership_id, $user-&gt;ID ) ) {&nbsp;</div></li><li><div>              ipnlog( &quot;This user has a different level than the one associated with this order. Their membership was probably changed by an admin or through an upgrade/downgrade. (Order #&quot; . $last_subscr_order-&gt;id . &quot;, Subscription Transaction ID #&quot; . $recurring_payment_id . &quot;)&quot; );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">//if the initial payment failed, cancel with status error instead of cancelled</span>&nbsp;</div></li><li><div>              if ( $initial_payment_status === &quot;Failed&quot; ) {&nbsp;</div></li><li><div>                  pmpro_cancelMembershipLevel( $last_subscr_order-&gt;membership_id, $last_subscr_order-&gt;user_id, 'error' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  pmpro_cancelMembershipLevel( $last_subscr_order-&gt;membership_id, $last_subscr_order-&gt;user_id, 'cancelled' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ipnlog( &quot;Cancelled membership for user with id = &quot; . $last_subscr_order-&gt;user_id . &quot;. Subscription transaction id = &quot; . $recurring_payment_id . &quot;.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//send an email to the member</span></span>&nbsp;</div></li><li><div>              $myemail = new PMProEmail();&nbsp;</div></li><li><div>              $myemail-&gt;sendCancelEmail( $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//send an email to the admin</span></span>&nbsp;</div></li><li><div>              $myemail = new PMProEmail();&nbsp;</div></li><li><div>              $myemail-&gt;sendCancelAdminEmail( $user, $last_subscr_order-&gt;membership_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Subscription Cancelled (PayPal Standard)</span>&nbsp;</div></li><li><div>if ( $txn_type == &quot;subscr_cancel&quot; ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//find last order</span></span>&nbsp;</div></li><li><div>  $last_subscr_order = new MemberOrder();&nbsp;</div></li><li><div>  if ( $last_subscr_order-&gt;getLastMemberOrderBySubscriptionTransactionID( $subscr_id ) == false ) {&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: Couldn't find this order to cancel (subscription_transaction_id=&quot; . $subscr_id . &quot;).&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//found order, let's cancel the membership</span></span>&nbsp;</div></li><li><div>      $user = get_userdata( $last_subscr_order-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user ) || empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          ipnlog( &quot;ERROR: Could not cancel membership. No user attached to order #&quot; . $last_subscr_order-&gt;id . &quot; with subscription transaction id = &quot; . $subscr_id . &quot;.&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">              We want to make sure this is a cancel originating from PayPal and not one already handled by PMPro.</span>&nbsp;</div></li><li><div><span class="comment">              For example, if a user cancels on WP/PMPro side, we've already cancelled the membership.</span>&nbsp;</div></li><li><div><span class="comment">              Also, if a user is changing levels, we don't want to cancel their new membership, just the old subscription at PayPal.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">              So we check 2 things and don't cancel if:</span>&nbsp;</div></li><li><div><span class="comment">              (1) This order already has &quot;cancelled&quot; status.</span>&nbsp;</div></li><li><div><span class="comment">              (2) The user doesn't currently have the level attached to this order.</span>&nbsp;</div></li><li><div><span class="comment">          */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset($last_subsc_order-&gt;membership_id) && $last_subscr_order-&gt;status == &quot;cancelled&quot; ) {&nbsp;</div></li><li><div>              ipnlog( &quot;We've already processed this cancellation. Probably originated from WP/PMPro. (Order #&quot; . $last_subscr_order-&gt;id . &quot;, Subscription Transaction ID #&quot; . $subscr_id . &quot;)&quot; );&nbsp;</div></li><li><div>          } elseif ( isset($last_subsc_order-&gt;membership_id) && ! pmpro_hasMembershipLevel( $last_subsc_order-&gt;membership_id, $user-&gt;ID ) ) {&nbsp;</div></li><li><div>              ipnlog( &quot;This user has a different level than the one associated with this order. Their membership was probably changed by an admin or through an upgrade/downgrade. (Order #&quot; . $last_subscr_order-&gt;id . &quot;, Subscription Transaction ID #&quot; . $subscr_id . &quot;)&quot; );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              pmpro_changeMembershipLevel( 0, $last_subscr_order-&gt;user_id, 'cancelled' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ipnlog( &quot;Canceled membership for user with id = &quot; . $last_subscr_order-&gt;user_id . &quot;. Subscription transaction id = &quot; . $subscr_id . &quot;.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//send an email to the member</span></span>&nbsp;</div></li><li><div>              $myemail = new PMProEmail();&nbsp;</div></li><li><div>              $myemail-&gt;sendCancelEmail( $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//send an email to the admin</span></span>&nbsp;</div></li><li><div>              $myemail = new PMProEmail();&nbsp;</div></li><li><div>              $myemail-&gt;sendCancelAdminEmail( $user, $last_subscr_order-&gt;membership_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      pmpro_ipnExit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Other</span>&nbsp;</div></li><li><div><span class="comment">//if we got here, this is a different kind of txn</span>&nbsp;</div></li><li><div>ipnlog( &quot;No recurring payment id or item number. txn_type = &quot; . $txn_type );&nbsp;</div></li><li><div>pmpro_ipnExit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Add message to ipnlog string</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function ipnlog( $s ) {&nbsp;</div></li><li><div>  global $logstr;&nbsp;</div></li><li><div>  $logstr .= &quot;\t&quot; . $s . &quot;\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Output ipnlog and exit;</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnExit() {&nbsp;</div></li><li><div>  global $logstr;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//for log</span>&nbsp;</div></li><li><div>  if ( $logstr ) {&nbsp;</div></li><li><div>      $logstr = &quot;Logged On: &quot; . date_i18n( &quot;m/d/Y H:i:s&quot; ) . &quot;\n&quot; . $logstr . &quot;\n-------------\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo $logstr;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//log in file or email?</span>&nbsp;</div></li><li><div>      if ( defined( 'PMPRO_IPN_DEBUG' ) && PMPRO_IPN_DEBUG === &quot;log&quot; ) {&nbsp;</div></li><li><div>          <span class="comment">//file</span>&nbsp;</div></li><li><div>          $loghandle = fopen( dirname( __FILE__ ) . &quot;/../logs/ipn.txt&quot;, &quot;a+&quot; );&nbsp;</div></li><li><div>          fwrite( $loghandle, $logstr );&nbsp;</div></li><li><div>          fclose( $loghandle );&nbsp;</div></li><li><div>      } elseif ( defined( 'PMPRO_IPN_DEBUG' ) ) {&nbsp;</div></li><li><div>          <span class="comment">//email</span>&nbsp;</div></li><li><div>          if ( strpos( PMPRO_IPN_DEBUG, &quot;@&quot; ) ) {&nbsp;</div></li><li><div>              $log_email = PMPRO_IPN_DEBUG;&nbsp;</div></li><li><div>          }    <span class="comment">//constant defines a specific email address</span>&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $log_email = get_option( &quot;admin_email&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          wp_mail( $log_email, get_option( &quot;blogname&quot; ) . &quot; IPN Log&quot;, nl2br( $logstr ) );            &nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Validate the $_POST with PayPal</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnValidate() {&nbsp;</div></li><li><div>  <span class="comment">//read the post from PayPal system and add 'cmd'</span>&nbsp;</div></li><li><div>  $req = 'cmd=_notify-validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//generate string to check with PayPal</span>&nbsp;</div></li><li><div>  foreach ( $_POST as $key =&gt; $value ) {&nbsp;</div></li><li><div>      $value = urlencode( stripslashes( $value ) );&nbsp;</div></li><li><div>      $req .= &quot;&$key=$value&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//post back to PayPal system to validate</span>&nbsp;</div></li><li><div>  $gateway_environment = pmpro_getOption( &quot;gateway_environment&quot; );&nbsp;</div></li><li><div>  if ( $gateway_environment == &quot;sandbox&quot; ) {&nbsp;</div></li><li><div>      $paypal_url = 'https:<span class="comment">//www.' . $gateway_environment . '.paypal.com/cgi-bin/webscr';</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $paypal_url = 'https:<span class="comment">//www.paypal.com/cgi-bin/webscr';</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $paypal_params = array(&nbsp;</div></li><li><div>      &quot;body&quot; =&gt; $req, &nbsp;</div></li><li><div>      &quot;httpversion&quot; =&gt; &quot;1.1&quot;, &nbsp;</div></li><li><div>      &quot;Host&quot; =&gt; &quot;www.paypal.com&quot;, &nbsp;</div></li><li><div>      &quot;Connection&quot; =&gt; &quot;Close&quot;, &nbsp;</div></li><li><div>      &quot;user-agent&quot; =&gt; PMPRO_USER_AGENT&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $fp = wp_remote_post( $paypal_url, $paypal_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//log post vars</span>&nbsp;</div></li><li><div>  ipnlog( print_r( $_POST, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//assume invalid</span>&nbsp;</div></li><li><div>  $r = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $fp ) ) {&nbsp;</div></li><li><div>      <span class="comment">//HTTP ERROR</span>&nbsp;</div></li><li><div>      ipnlog( &quot;HTTP ERROR&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>  } elseif ( ! empty( $fp-&gt;errors ) ) {&nbsp;</div></li><li><div>      <span class="comment">//error from PayPal</span>&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR&quot; );&nbsp;</div></li><li><div>      ipnlog( &quot;Error Info: &quot; . print_r( $fp-&gt;errors, true ) . &quot;\n&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//log fb object</span></span>&nbsp;</div></li><li><div>      ipnlog( print_r( $fp, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      ipnlog( &quot;FP!&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//log fb object</span></span>&nbsp;</div></li><li><div>      ipnlog( print_r( $fp, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res = wp_remote_retrieve_body( $fp );&nbsp;</div></li><li><div>      ipnlog( print_r( $res, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strcmp( $res, &quot;VERIFIED&quot; ) == 0 ) {&nbsp;</div></li><li><div>          <span class="comment">//all good so far</span>&nbsp;</div></li><li><div>          ipnlog( &quot;VERIFIED&quot; );&nbsp;</div></li><li><div>          $r = true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">//log for manual investigation</span>&nbsp;</div></li><li><div>          ipnlog( &quot;INAVLID&quot; );&nbsp;</div></li><li><div>          $r = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter if an ipn request is valid or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.6.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $r true or false if the request is valid</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $fp remote post object from request to PayPal</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $r = apply_filters( 'pmpro_ipn_validate', $r, $fp );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Check that the email sent by PayPal matches our settings.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnCheckReceiverEmail( $email ) {&nbsp;</div></li><li><div>  if ( ! is_array( $email ) ) {&nbsp;</div></li><li><div>      $email = array( $email );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! in_array( strtolower( pmpro_getOption( 'gateway_email' ) ), $email ) ) {&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $r = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = apply_filters( 'pmpro_ipn_check_receiver_email', $r, $email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $r ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( ! empty( $_POST['receiver_email'] ) ) {&nbsp;</div></li><li><div>          $receiver_email = $_POST['receiver_email'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $receiver_email = &quot;N/A&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['business'] ) ) {&nbsp;</div></li><li><div>          $business = $_POST['business'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $business = &quot;N/A&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//not yours</span>&nbsp;</div></li><li><div>      ipnlog( &quot;ERROR: receiver_email (&quot; . $receiver_email . &quot;) and business email (&quot; . $business . &quot;) did not match (&quot; . pmpro_getOption( 'gateway_email' ) . &quot;)&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Change the membership level. We also update the membership order to include filtered valus.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnChangeMembershipLevel( $txn_id, &$morder ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//filter for level</span>&nbsp;</div></li><li><div>  $morder-&gt;membership_level = apply_filters( &quot;pmpro_ipnhandler_level&quot;, $morder-&gt;membership_level, $morder-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//set the start date to current_time('timestamp') but allow filters  (documented in preheaders/checkout.php)</span>&nbsp;</div></li><li><div>  $startdate = apply_filters( &quot;pmpro_checkout_start_date&quot;, &quot;'&quot; . current_time( 'mysql' ) . &quot;'&quot;, $morder-&gt;user_id, $morder-&gt;membership_level );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//fix expiration date</span>&nbsp;</div></li><li><div>  if ( ! empty( $morder-&gt;membership_level-&gt;expiration_number ) ) {&nbsp;</div></li><li><div>      $enddate = &quot;'&quot; . date_i18n( &quot;Y-m-d&quot;, strtotime( &quot;+ &quot; . $morder-&gt;membership_level-&gt;expiration_number . &quot; &quot; . $morder-&gt;membership_level-&gt;expiration_period, current_time( &quot;timestamp&quot; ) ) ) . &quot;'&quot;;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $enddate = &quot;NULL&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//filter the enddate (documented in preheaders/checkout.php)</span>&nbsp;</div></li><li><div>  $enddate = apply_filters( &quot;pmpro_checkout_end_date&quot;, $enddate, $morder-&gt;user_id, $morder-&gt;membership_level, $startdate );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//get discount code</span>&nbsp;</div></li><li><div>  $morder-&gt;getDiscountCode();&nbsp;</div></li><li><div>  if ( ! empty( $morder-&gt;discount_code ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//update membership</span></span></span> level&nbsp;</div></li><li><div>      $morder-&gt;getMembershipLevel( true );&nbsp;</div></li><li><div>      $discount_code_id = $morder-&gt;discount_code-&gt;id;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $discount_code_id = &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//custom level to change user to</span>&nbsp;</div></li><li><div>  $custom_level = array(&nbsp;</div></li><li><div>      'user_id' =&gt; $morder-&gt;user_id, &nbsp;</div></li><li><div>      'membership_id' =&gt; $morder-&gt;membership_level-&gt;id, &nbsp;</div></li><li><div>      'code_id' =&gt; $discount_code_id, &nbsp;</div></li><li><div>      'initial_payment' =&gt; $morder-&gt;membership_level-&gt;initial_payment, &nbsp;</div></li><li><div>      'billing_amount' =&gt; $morder-&gt;membership_level-&gt;billing_amount, &nbsp;</div></li><li><div>      'cycle_number' =&gt; $morder-&gt;membership_level-&gt;cycle_number, &nbsp;</div></li><li><div>      'cycle_period' =&gt; $morder-&gt;membership_level-&gt;cycle_period, &nbsp;</div></li><li><div>      'billing_limit' =&gt; $morder-&gt;membership_level-&gt;billing_limit, &nbsp;</div></li><li><div>      'trial_amount' =&gt; $morder-&gt;membership_level-&gt;trial_amount, &nbsp;</div></li><li><div>      'trial_limit' =&gt; $morder-&gt;membership_level-&gt;trial_limit, &nbsp;</div></li><li><div>      'startdate' =&gt; $startdate, &nbsp;</div></li><li><div>      'enddate' =&gt; $enddate&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $pmpro_error;&nbsp;</div></li><li><div>  if ( ! empty( $pmpro_error ) ) {&nbsp;</div></li><li><div>      echo $pmpro_error;&nbsp;</div></li><li><div>      ipnlog( $pmpro_error );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//change level and continue &quot;checkout&quot;</span>&nbsp;</div></li><li><div>  if ( pmpro_changeMembershipLevel( $custom_level, $morder-&gt;user_id ) !== false ) {&nbsp;</div></li><li><div>      <span class="comment">//update order status and transaction ids</span>&nbsp;</div></li><li><div>      $morder-&gt;status = &quot;success&quot;;&nbsp;</div></li><li><div>      $morder-&gt;payment_transaction_id = $txn_id;&nbsp;</div></li><li><div>      if ( ! empty( $_POST['subscr_id'] ) ) {&nbsp;</div></li><li><div>          $morder-&gt;subscription_transaction_id = $_POST['subscr_id'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $morder-&gt;subscription_transaction_id = &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $morder-&gt;saveOrder();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//add discount code use</span>&nbsp;</div></li><li><div>      if ( ! empty( $discount_code ) && ! empty( $use_discount_code ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;query(&nbsp;</div></li><li><div>              $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                  &quot;INSERT INTO {$wpdb-&gt;pmpro_discount_codes_uses} &nbsp;</div></li><li><div>                      ( code_id, user_id, order_id, timestamp ) &nbsp;</div></li><li><div>                      VALUES( %d, %d, %s, %s )&quot;, &nbsp;</div></li><li><div>                  $discount_code_id), &nbsp;</div></li><li><div>                  $morder-&gt;user_id, &nbsp;</div></li><li><div>                  $morder-&gt;id, &nbsp;</div></li><li><div>                  current_time( 'mysql' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//save</span> first and last name fields</span>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['first_name'] ) ) {&nbsp;</div></li><li><div>          $old_firstname = get_user_meta( $morder-&gt;user_id, &quot;first_name&quot;, true );&nbsp;</div></li><li><div>          if ( empty( $old_firstname ) ) {&nbsp;</div></li><li><div>              update_user_meta( $morder-&gt;user_id, &quot;first_name&quot;, $_POST['first_name'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $_POST['last_name'] ) ) {&nbsp;</div></li><li><div>          $old_lastname = get_user_meta( $morder-&gt;user_id, &quot;last_name&quot;, true );&nbsp;</div></li><li><div>          if ( empty( $old_lastname ) ) {&nbsp;</div></li><li><div>              update_user_meta( $morder-&gt;user_id, &quot;last_name&quot;, $_POST['last_name'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//hook</span>&nbsp;</div></li><li><div>      do_action( &quot;pmpro_after_checkout&quot;, $morder-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//setup some values for the emails</span>&nbsp;</div></li><li><div>      if ( ! empty( $morder ) ) {&nbsp;</div></li><li><div>          $invoice = new MemberOrder( $morder-&gt;id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $invoice = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user = get_userdata( $morder-&gt;user_id );&nbsp;</div></li><li><div>      $user-&gt;membership_level = $morder-&gt;membership_level;        <span class="comment">//make sure they have the right level info</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//send email to member</span>&nbsp;</div></li><li><div>      $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>      $pmproemail-&gt;sendCheckoutEmail( $user, $invoice );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//send email to admin</span>&nbsp;</div></li><li><div>      $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>      $pmproemail-&gt;sendCheckoutAdminEmail( $user, $invoice );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Send an email RE a failed payment.</span>&nbsp;</div></li><li><div><span class="comment">  $last_order passed in is the previous order for this subscription.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnFailedPayment( $last_order ) {&nbsp;</div></li><li><div>  <span class="comment">//hook</span> to do other stuff when payments fail&nbsp;</div></li><li><div>  do_action( &quot;pmpro_subscription_payment_failed&quot;, $last_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//create a blank order for the email</span>&nbsp;</div></li><li><div>  $morder = new MemberOrder();&nbsp;</div></li><li><div>  $morder-&gt;user_id = $last_order-&gt;user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = new WP_User( $last_order-&gt;user_id );&nbsp;</div></li><li><div>  $user-&gt;membership_level = pmpro_getMembershipLevelForUser( $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//add billing information if appropriate</span>&nbsp;</div></li><li><div>  if ( $last_order-&gt;gateway == &quot;paypal&quot; )        <span class="comment"><span class="comment">//website payments pro</span></span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;name = $_POST['address_name'];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;street = $_POST['address_street'];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;city = $_POST['address_city '];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;state = $_POST['address_state'];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;zip = $_POST['address_zip'];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;country = $_POST['address_country_code'];&nbsp;</div></li><li><div>      $morder-&gt;billing-&gt;phone = get_user_meta( $morder-&gt;user_id, &quot;pmpro_bphone&quot;, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//get CC info that is on file</span></span>&nbsp;</div></li><li><div>      $morder-&gt;cardtype = get_user_meta( $morder-&gt;user_id, &quot;pmpro_CardType&quot;, true );&nbsp;</div></li><li><div>      $morder-&gt;accountnumber = hideCardNumber( get_user_meta( $morder-&gt;user_id, &quot;pmpro_AccountNumber&quot;, true ), false );&nbsp;</div></li><li><div>      $morder-&gt;expirationmonth = get_user_meta( $morder-&gt;user_id, &quot;pmpro_ExpirationMonth&quot;, true );&nbsp;</div></li><li><div>      $morder-&gt;expirationyear = get_user_meta( $morder-&gt;user_id, &quot;pmpro_ExpirationYear&quot;, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Email the user and ask them to update their credit card information</span>&nbsp;</div></li><li><div>  $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>  $pmproemail-&gt;sendBillingFailureEmail( $user, $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Email admin so they are aware of the failure</span>&nbsp;</div></li><li><div>  $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>  $pmproemail-&gt;sendBillingFailureAdminEmail( get_bloginfo( &quot;admin_email&quot; ), $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ipnlog( &quot;Payment failed. Emails sent to &quot; . $user-&gt;user_email . &quot; and &quot; . get_bloginfo( &quot;admin_email&quot; ) . &quot;.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Save a new order from IPN info.</span>&nbsp;</div></li><li><div><span class="comment">  $last_order passed in is the previous order for this subscription.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_ipnSaveOrder( $txn_id, $last_order ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check that txn_id has not been previously processed</span>&nbsp;</div></li><li><div>  $old_txn = $wpdb-&gt;get_var( &quot;SELECT payment_transaction_id FROM $wpdb-&gt;pmpro_membership_orders WHERE payment_transaction_id = '&quot; . $txn_id . &quot;' LIMIT 1&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $old_txn ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//save</span> order</span>&nbsp;</div></li><li><div>      $morder = new MemberOrder();&nbsp;</div></li><li><div>      $morder-&gt;user_id = $last_order-&gt;user_id;&nbsp;</div></li><li><div>      $morder-&gt;membership_id = $last_order-&gt;membership_id;&nbsp;</div></li><li><div>      $morder-&gt;payment_transaction_id = $txn_id;&nbsp;</div></li><li><div>      $morder-&gt;subscription_transaction_id = $last_order-&gt;subscription_transaction_id;&nbsp;</div></li><li><div>      $morder-&gt;gateway = $last_order-&gt;gateway;&nbsp;</div></li><li><div>      $morder-&gt;gateway_environment = $last_order-&gt;gateway_environment;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Payment Status</span>&nbsp;</div></li><li><div>      $morder-&gt;status = 'success'; <span class="comment">// We have confirmed that and thats the reason we are here.</span>&nbsp;</div></li><li><div>      <span class="comment">// Payment Type.</span>&nbsp;</div></li><li><div>      $morder-&gt;payment_type = $last_order-&gt;payment_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//set amount based on which PayPal type</span>&nbsp;</div></li><li><div>      if ( false !== stripos( $last_order-&gt;gateway, &quot;paypal&quot; ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $_POST['amount'] ) && ! empty( $_POST['amount'] ) ) {&nbsp;</div></li><li><div>              $morder-&gt;InitialPayment = $_POST['amount'];    <span class="comment"><span class="comment"><span class="comment">//not the initial payment, but the class is expecting that</span></span></span>&nbsp;</div></li><li><div>              $morder-&gt;PaymentAmount = $_POST['amount'];&nbsp;</div></li><li><div>          } elseif ( isset( $_POST['mc_gross'] ) && ! empty( $_POST['mc_gross'] ) ) {&nbsp;</div></li><li><div>              $morder-&gt;InitialPayment = $_POST['mc_gross'];    <span class="comment"><span class="comment"><span class="comment">//not the initial payment, but the class is expecting that</span></span></span>&nbsp;</div></li><li><div>              $morder-&gt;PaymentAmount = $_POST['mc_gross'];&nbsp;</div></li><li><div>          } elseif ( isset( $_POST['payment_gross'] )  && ! empty( $_POST['payment_gross' ] ) ) {&nbsp;</div></li><li><div>              $morder-&gt;InitialPayment = $_POST['payment_gross'];    <span class="comment"><span class="comment"><span class="comment">//not the initial payment, but the class is expecting that</span></span></span>&nbsp;</div></li><li><div>              $morder-&gt;PaymentAmount = $_POST['payment_gross'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $morder-&gt;FirstName = $_POST['first_name'];&nbsp;</div></li><li><div>      $morder-&gt;LastName = $_POST['last_name'];&nbsp;</div></li><li><div>      $morder-&gt;Email = $_POST['payer_email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//get address info if appropriate</span>&nbsp;</div></li><li><div>      if ( $last_order-&gt;gateway == &quot;paypal&quot; )    <span class="comment"><span class="comment">//website payments pro</span></span>&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $morder-&gt;Address1 = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_baddress1&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;City = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bcity&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;State = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bstate&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;CountryCode = &quot;US&quot;;&nbsp;</div></li><li><div>          $morder-&gt;Zip = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bzip&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;PhoneNumber = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bphone&quot;, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;name = $_POST['first_name'] . &quot; &quot; . $_POST['last_name'];&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;street = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_baddress1&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;city = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bcity&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;state = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bstate&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;zip = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bzip&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;country = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bcountry&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;billing-&gt;phone = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_bphone&quot;, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//get CC info that is on file</span></span>&nbsp;</div></li><li><div>          $morder-&gt;cardtype = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_CardType&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;accountnumber = hideCardNumber( get_user_meta( $last_order-&gt;user_id, &quot;pmpro_AccountNumber&quot;, true ), false );&nbsp;</div></li><li><div>          $morder-&gt;expirationmonth = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_ExpirationMonth&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;expirationyear = get_user_meta( $last_order-&gt;user_id, &quot;pmpro_ExpirationYear&quot;, true );&nbsp;</div></li><li><div>          $morder-&gt;ExpirationDate = $morder-&gt;expirationmonth . $morder-&gt;expirationyear;&nbsp;</div></li><li><div>          $morder-&gt;ExpirationDate_YdashM = $morder-&gt;expirationyear . &quot;-&quot; . $morder-&gt;expirationmonth;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//figure out timestamp or default to none (today)</span>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['payment_date'] ) ) {&nbsp;</div></li><li><div>          $morder-&gt;timestamp = strtotime( $_POST['payment_date'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save the event ID for the last processed user/IPN (in case we want to be able to replay IPN requests)</span>&nbsp;</div></li><li><div>      $ipn_id = isset($_POST['ipn_track_id']) ? sanitize_text_field( $_POST['ipn_track_id'] ) : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Allow extraction of the IPN Track ID from the order notes (if needed)</span>&nbsp;</div></li><li><div>      $morder-&gt;notes = &quot;{$morder-&gt;notes} [IPN_ID]{$ipn_id}[/IPN_ID]&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Post processing for a specific subscription related IPN event ID</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param       string      $ipn_id     - The ipn_track_id from the PayPal IPN request</span>&nbsp;</div></li><li><div><span class="comment">       * @param       MemberOrder $morder     - The completed Member Order object for the IPN request</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action('pmpro_subscription_ipn_event_processed', $ipn_id, $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_null( $ipn_id ) ) {&nbsp;</div></li><li><div>          if ( false === update_user_meta( $morder-&gt;user_id, &quot;pmpro_last_{$morder-&gt;gateway}_ipn_id&quot;, $ipn_id )) {&nbsp;</div></li><li><div>              ipnlog( &quot;Unable to save the IPN event ID ({$ipn_id}) to usermeta for {$morder-&gt;user_id} &quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//save</span>&nbsp;</div></li><li><div>      $morder-&gt;saveOrder();&nbsp;</div></li><li><div>      $morder-&gt;getMemberOrderByID( $morder-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//email</span> the user their invoice&nbsp;</div></li><li><div>      $pmproemail = new PMProEmail();&nbsp;</div></li><li><div>      $pmproemail-&gt;sendInvoiceEmail( get_userdata( $last_order-&gt;user_id ), $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//hook</span> for successful subscription payments&nbsp;</div></li><li><div>      do_action( &quot;pmpro_subscription_payment_completed&quot;, $morder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ipnlog( &quot;New order (&quot; . $morder-&gt;code . &quot;) created.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      ipnlog( &quot;Duplicate Transaction ID: &quot; . $txn_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Paid Memberships Pro</li><li><span></span>1.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>