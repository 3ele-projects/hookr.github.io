<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.8.9.3" data-slug="paid-memberships-pro" data-type="file" data-id="15163"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-functions | file | Paid Memberships Pro | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paid-memberships-pro, 1.8.9.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5bb7845e92e743a8bbf18b9a9d5a01db' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paid-memberships-pro-1.8.9.3-file-includes-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paid-memberships-pro." href="http://hookr.io/plugins/paid-memberships-pro/" class="plugin"><span property="name">paid-memberships-pro</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.8.9.3." href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/" class="H_VERSION"><span property="name">1.8.9.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="795"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/all/" title="All">All <span class="count badge">795</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="359"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/hooks/" title="Hooks">Hooks <span class="count badge">359</span></a></li><li class="" data-id="action" data-count="89"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/actions/" title="Actions">Actions <span class="count badge">89</span></a></li><li class="" data-id="filter" data-count="270"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/filters/" title="Filters">Filters <span class="count badge">270</span></a></li><li class="" data-id="class" data-count="130"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/classes/" title="Classes">Classes <span class="count badge">130</span></a></li><li class="" data-id="constant" data-count="26"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/constants/" title="Constants">Constants <span class="count badge">26</span></a></li><li class="" data-id="function" data-count="275"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/functions/" title="Functions">Functions <span class="count badge">275</span></a></li><li class="" data-id="shortcode" data-count="5"><a href="http://hookr.io/plugins/paid-memberships-pro/1.8.9.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">5</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/****************************************************************</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">IMPORTANT. PLEASE READ.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">DO NOT EDIT THIS FILE or any other file in the /wp-content/plugins/paid-memberships-pro/ directory.</span>&nbsp;</div></li><li><div><span class="comment">Doing so could break the PMPro plugin and/or keep you from upgrading this plugin in the future.</span>&nbsp;</div></li><li><div><span class="comment">We regularly release updates to the plugin, including important security fixes and new features.</span>&nbsp;</div></li><li><div><span class="comment">You want to be able to upgrade.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">If you were asked to insert code into &quot;your functions.php file&quot;, it was meant that you edit the functions.php</span>&nbsp;</div></li><li><div><span class="comment">in the root folder of your active theme. e.g. /wp-content/themes/twentytwelve/functions.php</span>&nbsp;</div></li><li><div><span class="comment">You can also create a custom plugin to place customization code into. Instructions are here:</span>&nbsp;</div></li><li><div><span class="comment">http://www.paidmembershipspro.com/2012/08/create-a-plugin-for-pmpro-customizations/</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">Further documentation for customizing Paid Memberships Pro can be found here:</span>&nbsp;</div></li><li><div><span class="comment">http://www.paidmembershipspro.com/documentation/</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment"> ****************************************************************/</span>&nbsp;</div></li><li><div>if(!function_exists(&quot;sornot&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function sornot($t, $n)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($n == 1)&nbsp;</div></li><li><div>          return $t;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $t . &quot;s&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//set up wpdb for the tables we need</span>&nbsp;</div></li><li><div>function pmpro_setDBTables()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_membership_levels = $wpdb-&gt;prefix . 'pmpro_membership_levels';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_memberships_users = $wpdb-&gt;prefix . 'pmpro_memberships_users';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_memberships_categories = $wpdb-&gt;prefix . 'pmpro_memberships_categories';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_memberships_pages = $wpdb-&gt;prefix . 'pmpro_memberships_pages';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_membership_orders = $wpdb-&gt;prefix . 'pmpro_membership_orders';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_discount_codes = $wpdb-&gt;prefix . 'pmpro_discount_codes';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_discount_codes_levels = $wpdb-&gt;prefix . 'pmpro_discount_codes_levels';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_discount_codes_uses = $wpdb-&gt;prefix . 'pmpro_discount_codes_uses';&nbsp;</div></li><li><div>  $wpdb-&gt;pmpro_membership_levelmeta = $wpdb-&gt;prefix . 'pmpro_membership_levelmeta';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>pmpro_setDBTables();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//from: http://stackoverflow.com/questions/5266945/wordpress-how-detect-if-current-page-is-the-login-page/5892694#5892694</span>&nbsp;</div></li><li><div>function pmpro_is_login_page() {&nbsp;</div></li><li><div>  return (in_array($GLOBALS['pagenow'], array('wp-login.php', 'wp-register.php')) || is_page(&quot;login&quot;));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//thanks: http://wordpress.org/support/topic/is_plugin_active</span>&nbsp;</div></li><li><div>function pmpro_is_plugin_active( $plugin ) {&nbsp;</div></li><li><div>  return in_array( $plugin, (array) get_option( 'active_plugins', array() ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//scraping - override n if you have more than 1 group of matches and don't want the first group</span>&nbsp;</div></li><li><div>function pmpro_getMatches($p, $s, $firstvalue = FALSE, $n = 1)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $ok = preg_match_all($p, $s, $matches);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$ok)&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($firstvalue)&nbsp;</div></li><li><div>          return $matches[$n][0];&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $matches[$n];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_br2nl($text, $tags = &quot;br&quot;)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(!is_array($tags))&nbsp;</div></li><li><div>      $tags = explode(&quot; &quot;, $tags);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach($tags as $tag)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $text = eregi_replace(&quot;&lt;&quot; . $tag . &quot;[^&gt;]*&gt;&quot;, &quot;\n&quot;, $text);&nbsp;</div></li><li><div>      $text = eregi_replace(&quot;&lt;/&quot; . $tag . &quot;[^&gt;]*&gt;&quot;, &quot;\n&quot;, $text);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return($text);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_getOption($s, $force = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(get_option(&quot;pmpro_&quot; . $s))&nbsp;</div></li><li><div>      return get_option(&quot;pmpro_&quot; . $s);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_setOption($s, $v = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//no value is given, set v to the p var</span>&nbsp;</div></li><li><div>  if($v === NULL && isset($_POST[$s]))&nbsp;</div></li><li><div>      $v = $_POST[$s];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(is_array($v))&nbsp;</div></li><li><div>      $v = implode(&quot;, &quot;, $v);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $v = trim($v);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return update_option(&quot;pmpro_&quot; . $s, $v);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_get_slug($post_id)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_slugs, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//make sure post id is int for security</span>&nbsp;</div></li><li><div>  $post_id = intval($post_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$pmpro_slugs[$post_id])&nbsp;</div></li><li><div>      $pmpro_slugs[$post_id] = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE ID = '&quot; . $post_id . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $pmpro_slugs[$post_id];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_url($page = NULL, $querystring = &quot;&quot;, $scheme = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $besecure;&nbsp;</div></li><li><div>  $besecure = apply_filters(&quot;besecure&quot;, $besecure);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$scheme && $besecure)&nbsp;</div></li><li><div>      $scheme = &quot;https&quot;;&nbsp;</div></li><li><div>  elseif(!$scheme)&nbsp;</div></li><li><div>      $scheme = &quot;http&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$page)&nbsp;</div></li><li><div>      $page = &quot;levels&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $pmpro_pages;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//start with the permalink</span>&nbsp;</div></li><li><div>  $url = get_permalink($pmpro_pages[$page]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//WPML/etc support</span>&nbsp;</div></li><li><div>  if(function_exists(&quot;icl_object_id&quot;) && defined(&quot;ICL_LANGUAGE_CODE&quot;))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $trans_id = icl_object_id($pmpro_pages[$page], &quot;page&quot;, false, ICL_LANGUAGE_CODE);&nbsp;</div></li><li><div>      if(!empty($trans_id))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $url = get_permalink($trans_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//figure out querystring</span>&nbsp;</div></li><li><div>  if(strpos($url, &quot;?&quot;))&nbsp;</div></li><li><div>      $querystring = str_replace(&quot;?&quot;, &quot;&&quot;, $querystring);&nbsp;</div></li><li><div>  $url .= $querystring;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//figure out scheme</span>&nbsp;</div></li><li><div>  if(is_ssl())&nbsp;</div></li><li><div>      $url = str_replace(&quot;http:&quot;, &quot;https:&quot;, $url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $url;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_isLevelFree(&$level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(!empty($level) && $level-&gt;initial_payment &lt;= 0 && $level-&gt;billing_amount &lt;= 0 && $level-&gt;trial_amount &lt;= 0)&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_isLevelRecurring(&$level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(!empty($level) && ($level-&gt;billing_amount &gt; 0 || $level-&gt;trial_amount &gt; 0))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_isLevelTrial(&$level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(!empty($level) && !empty($level-&gt;trial_limit) && $level-&gt;trial_limit &gt; 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_isLevelExpiring(&$level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(!empty($level) && (!empty($level-&gt;expiration_number) && $level-&gt;expiration_number &gt; 0) || !empty($level-&gt;enddate))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Is this level expiring within one pay period</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.6.3</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $level PMPro Level Object to test</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_isLevelExpiringSoon( &$level ) {&nbsp;</div></li><li><div>  if( !pmpro_isLevelExpiring( $level ) || empty( $level-&gt;enddate ) )&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>  else {&nbsp;</div></li><li><div>      <span class="comment">//days til expiration for the standard level</span>&nbsp;</div></li><li><div>      $standard = pmpro_getLevel( $level-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !empty( $standard-&gt;expiration_number ) ) {&nbsp;</div></li><li><div>          if( $standard-&gt;expiration_period == 'Day' )&nbsp;</div></li><li><div>              $days = $level-&gt;expiration_number;&nbsp;</div></li><li><div>          elseif( $standard-&gt;expiration_period == 'Week' )&nbsp;</div></li><li><div>              $days = $level-&gt;expiration_number * 7;&nbsp;</div></li><li><div>          elseif( $standard-&gt;expiration_period == 'Month' )&nbsp;</div></li><li><div>              $days = $level-&gt;expiration_number * 30;&nbsp;</div></li><li><div>          elseif( $standard-&gt;expiration_period == 'Year' )&nbsp;</div></li><li><div>              $days = $level-&gt;expiration_number * 365;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $days = 30;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//are we within the days til expiration?</span>&nbsp;</div></li><li><div>      $now = current_time('timestamp');&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if( $now + ($days*3600*24) &gt;= $level-&gt;enddate )&nbsp;</div></li><li><div>          $r = true;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $r = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//filter</span></span>&nbsp;</div></li><li><div>  $r = apply_filters('pmpro_is_level_expiring_soon', $r, $level);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Loads a template from one of the default paths (PMPro plugin or theme), or from filtered path</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param null $page_name - Name of the page/template</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $where - `local` or `url` (whether to load from FS or over http)</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type - Type of template (valid: 'email' or 'pages', 'adminpages', 'preheader')</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $ext - File extension ('php', 'html', 'htm', etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - The HTML for the template.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * TODO - Allow localized template files to be loaded?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.9</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_loadTemplate($page_name = null, $where = 'local', $type = 'pages', $ext = 'php' )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// called from page handler shortcode</span>&nbsp;</div></li><li><div>  if (is_null($page_name))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $pmpro_page_name;&nbsp;</div></li><li><div>      $page_name = $pmpro_page_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($where == 'local') {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// template paths in order of priority (array gets reversed)</span></span>&nbsp;</div></li><li><div>      $default_templates = array(&nbsp;</div></li><li><div>          PMPRO_DIR . &quot;/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// default plugin path</span></span>&nbsp;</div></li><li><div>          get_template_directory() . &quot;/paid-memberships-pro/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// parent theme</span></span>&nbsp;</div></li><li><div>          get_stylesheet_directory() . &quot;/paid-memberships-pro/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// child / active theme</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  } elseif( $where == 'url' ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// template paths in order of priority (array gets reversed)</span></span>&nbsp;</div></li><li><div>      $default_templates = array(&nbsp;</div></li><li><div>          PMPRO_URL . &quot;/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// default plugin path</span></span>&nbsp;</div></li><li><div>          get_template_directory_uri() . &quot;/paid-memberships-pro/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// parent theme</span></span>&nbsp;</div></li><li><div>          get_stylesheet_directory_uri() . &quot;/paid-memberships-pro/{$type}/{$page_name}.{$ext}&quot;, <span class="comment"><span class="comment">// child / active theme</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Valid types: 'email', 'pages'</span>&nbsp;</div></li><li><div>  $templates = apply_filters(&quot;pmpro_{$type}_custom_template_path&quot;, $default_templates, $page_name, $type, $where, $ext);&nbsp;</div></li><li><div>  $user_templates = array_diff($templates, $default_templates);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//user specified a custom template path, so it has priority.</span>&nbsp;</div></li><li><div>  if (!empty($user_templates))&nbsp;</div></li><li><div>      $templates = $user_templates;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//last element included in the array is the most first one we try to load</span>&nbsp;</div></li><li><div>  $templates = array_reverse($templates);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// look for template file to include</span>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  foreach($templates as $template_path)&nbsp;</div></li><li><div>  {        &nbsp;</div></li><li><div>      <span class="comment">// If loading a local file, check if it exists first</span>&nbsp;</div></li><li><div>      if($where == 'url' || file_exists($template_path))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          include $template_path;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $template = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// return template content</span>&nbsp;</div></li><li><div>  return $template;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_getLevelCost(&$level, $tags = true, $short = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//initial payment</span>&nbsp;</div></li><li><div>  if(!$short)&nbsp;</div></li><li><div>      $r = sprintf(__('The price for membership is &lt;strong&gt;%s&lt;/strong&gt; now', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment));&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $r = sprintf(__('&lt;strong&gt;%s&lt;/strong&gt; now', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//recurring part</span>&nbsp;</div></li><li><div>  if($level-&gt;billing_amount != '0.00')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($level-&gt;billing_limit &gt; 1)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if($level-&gt;cycle_number == '1')&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= sprintf(__(' and then &lt;strong&gt;%s per %s for %d more %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;billing_amount), pmpro_translate_billing_period($level-&gt;cycle_period), $level-&gt;billing_limit, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;billing_limit));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= sprintf(__(' and then &lt;strong&gt;%s every %d %s for %d more payments&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;billing_amount), $level-&gt;cycle_number, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;cycle_number), $level-&gt;billing_limit);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($level-&gt;billing_limit == 1)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $r .= sprintf(__(' and then &lt;strong&gt;%s after %d %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;billing_amount), $level-&gt;cycle_number, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;cycle_number));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if( $level-&gt;billing_amount === $level-&gt;initial_payment ) {&nbsp;</div></li><li><div>              if($level-&gt;cycle_number == '1')&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if(!$short)&nbsp;</div></li><li><div>                      $r = sprintf(__('The price for membership is &lt;strong&gt;%s per %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment), pmpro_translate_billing_period($level-&gt;cycle_period) );&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $r = sprintf(__('&lt;strong&gt;%s per %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment), pmpro_translate_billing_period($level-&gt;cycle_period) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if(!$short)&nbsp;</div></li><li><div>                      $r = sprintf(__('The price for membership is &lt;strong&gt;%s every %d %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment), $level-&gt;cycle_number, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;cycle_number) );&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $r = sprintf(__('&lt;strong&gt;%s every %d %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;initial_payment), $level-&gt;cycle_number, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;cycle_number) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if($level-&gt;cycle_number == '1')&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $r .= sprintf(__(' and then &lt;strong&gt;%s per %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;billing_amount), pmpro_translate_billing_period($level-&gt;cycle_period));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $r .= sprintf(__(' and then &lt;strong&gt;%s every %d %s&lt;/strong&gt;.', 'pmpro'), pmpro_formatPrice($level-&gt;billing_amount), $level-&gt;cycle_number, pmpro_translate_billing_period($level-&gt;cycle_period, $level-&gt;cycle_number));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $r .= '.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//add a space</span>&nbsp;</div></li><li><div>  $r .= ' ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//trial part</span>&nbsp;</div></li><li><div>  if($level-&gt;trial_limit)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($level-&gt;trial_amount == '0.00')&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if($level-&gt;trial_limit == '1')&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= ' ' . __('After your initial payment, your first payment is Free.', 'pmpro');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= ' ' . sprintf(__('After your initial payment, your first %d payments are Free.', 'pmpro'), $level-&gt;trial_limit);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if($level-&gt;trial_limit == '1')&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= ' ' . sprintf(__('After your initial payment, your first payment will cost %s.', 'pmpro'), pmpro_formatPrice($level-&gt;trial_amount));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $r .= ' ' . sprintf(__('After your initial payment, your first %d payments will cost %s.', 'pmpro'), $level-&gt;trial_limit, pmpro_formatPrice($level-&gt;trial_amount));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//taxes part</span>&nbsp;</div></li><li><div>  $tax_state = pmpro_getOption(&quot;tax_state&quot;);&nbsp;</div></li><li><div>  $tax_rate = pmpro_getOption(&quot;tax_rate&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if($tax_state && $tax_rate && !pmpro_isLevelFree($level))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $r .= sprintf(__('Customers in %s will be charged %s%% tax.', 'pmpro'), $tax_state, round($tax_rate * 100, 2));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$tags)&nbsp;</div></li><li><div>      $r = strip_tags($r);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = apply_filters(&quot;pmpro_level_cost_text&quot;, $r, $level, $tags, $short);    <span class="comment">//passing $tags and $short since v1.8</span>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_getLevelExpiration(&$level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if($level-&gt;expiration_number)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $expiration_text = sprintf(__(&quot;Membership expires after %d %s.&quot;, &quot;pmpro&quot;), $level-&gt;expiration_number, pmpro_translate_billing_period($level-&gt;expiration_period, $level-&gt;expiration_number));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $expiration_text = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $expiration_text = apply_filters(&quot;pmpro_level_expiration_text&quot;, $expiration_text, $level);&nbsp;</div></li><li><div>  return $expiration_text;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * pmpro_membership_level Meta Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ssince 1.8.6.5</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function add_pmpro_membership_level_meta($level_id, $meta_key, $meta_value, $unique = false) {    &nbsp;</div></li><li><div>  return add_metadata('pmpro_membership_level', $level_id, $meta_key, $meta_value, $unique);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function get_pmpro_membership_level_meta($level_id, $key, $single = false) {&nbsp;</div></li><li><div>  return get_metadata('pmpro_membership_level', $level_id, $key, $single);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function update_pmpro_membership_level_meta($level_id, $meta_key, $meta_value, $prev_value = '') {        &nbsp;</div></li><li><div>  return update_metadata('pmpro_membership_level', $level_id, $meta_key, $meta_value, $prev_value);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function delete_pmpro_membership_level_meta($level_id, $meta_key, $meta_value = '') {        &nbsp;</div></li><li><div>  return delete_metadata('pmpro_membership_level', $level_id, $meta_key, $meta_value);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_hideAds()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_display_ads;&nbsp;</div></li><li><div>  return !$pmpro_display_ads;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_displayAds()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_display_ads;&nbsp;</div></li><li><div>  return $pmpro_display_ads;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_next_payment($user_id = NULL, $order_status = &quot;success&quot;, $format = &quot;timestamp&quot;)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb, $current_user;&nbsp;</div></li><li><div>  if(!$user_id)&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$user_id)&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//get last order</span>&nbsp;</div></li><li><div>      $order = new MemberOrder();&nbsp;</div></li><li><div>      $order-&gt;getLastMemberOrder($user_id, $order_status);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//get current membership level</span>&nbsp;</div></li><li><div>      $level = pmpro_getMembershipLevelForUser($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($order) && !empty($order-&gt;id) && !empty($level) && !empty($level-&gt;id) && !empty($level-&gt;cycle_number))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//last payment date</span>&nbsp;</div></li><li><div>          $lastdate = date(&quot;Y-m-d&quot;, $order-&gt;timestamp);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//next payment date</span>&nbsp;</div></li><li><div>          $nextdate = $wpdb-&gt;get_var(&quot;SELECT UNIX_TIMESTAMP('&quot; . $lastdate . &quot;' + INTERVAL &quot; . $level-&gt;cycle_number . &quot; &quot; . $level-&gt;cycle_period . &quot;)&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $r = $nextdate;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//no order or level found, or level was not recurring</span>&nbsp;</div></li><li><div>          $r = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the next payment date.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $r false or the next payment date timestamp</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id The user id to get the next payment date for</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $order_status Status or array of statuses to find the last order based on.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $r = apply_filters('pmpro_next_payment', $r, $user_id, $order_status);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//return</span> in desired format</span>&nbsp;</div></li><li><div>  if($r === false)&nbsp;</div></li><li><div>      return false;                <span class="comment">//always return false when no date found</span>&nbsp;</div></li><li><div>  elseif($format == &quot;timestamp&quot;)&nbsp;</div></li><li><div>      return $r;&nbsp;</div></li><li><div>  elseif($format == &quot;date_format&quot;)&nbsp;</div></li><li><div>      return date(get_option('date_format'), $r);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return date($format, $r);    <span class="comment">//assume a PHP date format    </span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if(!function_exists(&quot;last4&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function last4($t)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return substr($t, strlen($t) - 4, 4);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if(!function_exists(&quot;hideCardNumber&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function hideCardNumber($c, $dashes = true)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($c)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if($dashes)&nbsp;</div></li><li><div>              return &quot;XXXX-XXXX-XXXX-&quot; . substr($c, strlen($c) - 4, 4);&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return &quot;XXXXXXXXXXXX&quot; . substr($c, strlen($c) - 4, 4);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//check for existing functions since we didn't use a prefix for this function</span></span>&nbsp;</div></li><li><div>if(!function_exists(&quot;cleanPhone&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function to remove special characters from a phone number.</span>&nbsp;</div></li><li><div><span class="comment">   * NOTE: Could probably replace with preg_replace(&quot;[^0-9]&quot;, &quot;&quot;, $phone)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $phone The phone number to clean.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cleanPhone($phone)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//if a + is passed, just pass it along</span>&nbsp;</div></li><li><div>      if(strpos($phone, &quot;+&quot;) !== false)&nbsp;</div></li><li><div>          return $phone;&nbsp;</div></li><li><div>      <span class="comment">//clean the phone</span>&nbsp;</div></li><li><div>      $phone = str_replace(&quot;-&quot;, &quot;&quot;, $phone);&nbsp;</div></li><li><div>      $phone = str_replace(&quot;.&quot;, &quot;&quot;, $phone);&nbsp;</div></li><li><div>      $phone = str_replace(&quot;(&quot;, &quot;&quot;, $phone);&nbsp;</div></li><li><div>      $phone = str_replace(&quot;)&quot;, &quot;&quot;, $phone);&nbsp;</div></li><li><div>      $phone = str_replace(&quot; &quot;, &quot;&quot;, $phone);&nbsp;</div></li><li><div>      return $phone;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//check for existing functions since we didn't use a prefix for this function</span></span>&nbsp;</div></li><li><div>if(!function_exists(&quot;formatPhone&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function to format a phone number.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $phone The phone number to format.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function formatPhone($phone)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $r = cleanPhone($phone);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(strlen($r) == 11)&nbsp;</div></li><li><div>          $r = substr($r, 0, 1) . &quot; (&quot; . substr($r, 1, 3) . &quot;) &quot; . substr($r, 4, 3) . &quot;-&quot; . substr($r, 7, 4);&nbsp;</div></li><li><div>      elseif(strlen($r) == 10)&nbsp;</div></li><li><div>          $r = &quot;(&quot; . substr($r, 0, 3) . &quot;) &quot; . substr($r, 3, 3) . &quot;-&quot; . substr($r, 6, 4);&nbsp;</div></li><li><div>      elseif(strlen($r) == 7)&nbsp;</div></li><li><div>          $r = substr($r, 0, 3) . &quot;-&quot; . substr($r, 3, 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter to do more or less cleaning of phone numbers.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.8.4.4</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $r The formatted phone number.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $phone The original phone number.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters('pmpro_format_phone', $r, $phone);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_showRequiresMembershipMessage()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//TODO $current_user $post_membership_levels_names are undefined variables</span>&nbsp;</div></li><li><div>  <span class="comment">//get the correct message</span>&nbsp;</div></li><li><div>  if(is_feed())&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $content = pmpro_getOption(&quot;rsstext&quot;);&nbsp;</div></li><li><div>      $content = str_replace(&quot;!!levels!!&quot;, implode(&quot;, &quot;, $post_membership_levels_names), $content);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif($current_user-&gt;ID)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//not a member</span>&nbsp;</div></li><li><div>      $content = pmpro_getOption(&quot;nonmembertext&quot;);&nbsp;</div></li><li><div>      $content = str_replace(&quot;!!levels!!&quot;, implode(&quot;, &quot;, $post_membership_levels_names), $content);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//not logged in!</span>&nbsp;</div></li><li><div>      $content = pmpro_getOption(&quot;notloggedintext&quot;);&nbsp;</div></li><li><div>      $content = str_replace(&quot;!!levels!!&quot;, implode(&quot;, &quot;, $post_membership_levels_names), $content);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Function to check if a user has specified membership levels.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * pmpro_hasMembershipLevel() checks if the passed user is a member of the passed level</span>&nbsp;</div></li><li><div><span class="comment"> * $level may either be the ID or name of the desired membership_level. (or an array of such)</span>&nbsp;</div></li><li><div><span class="comment"> * If $user_id is omitted, the value will be retrieved from $current_user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *  Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *     * Success returns boolean true.</span>&nbsp;</div></li><li><div><span class="comment"> *     * Failure returns a string containing the error message.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.5 Added 'e' option for expired members.</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $levels The levels to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Result of membership query.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_hasMembershipLevel($levels = NULL, $user_id = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $current_user, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($user_id)) <span class="comment">//no user_id passed, check the current user</span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>      $membership_levels = $current_user-&gt;membership_levels;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif(is_numeric($user_id)) <span class="comment">//get membership levels for given user</span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $membership_levels = pmpro_getMembershipLevelsForUser($user_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;    <span class="comment">//invalid user_id</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if($levels === &quot;0&quot; || $levels === 0) <span class="comment">//if 0 was passed, return true if they have no level and false if they have any</span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $return = empty($membership_levels);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif(empty($levels)) <span class="comment">//if no level var was passed, we're just checking if they have any level</span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $return = !empty($membership_levels);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!is_array($levels)) <span class="comment">//make an array out of a single element so we can use the same code</span>&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $levels = array($levels);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($membership_levels))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//user has no levels just check if 0, L, -1, or e was sent in one of the levels</span>&nbsp;</div></li><li><div>          if(in_array(0, $levels, true) || in_array(&quot;0&quot;, $levels))&nbsp;</div></li><li><div>              $return = true;&nbsp;</div></li><li><div>          elseif(in_array(&quot;L&quot;, $levels) || in_array(&quot;l&quot;, $levels))&nbsp;</div></li><li><div>              $return = (!empty($user_id) && $user_id == $current_user-&gt;ID);&nbsp;</div></li><li><div>          elseif(in_array(&quot;-L&quot;, $levels) || in_array(&quot;-l&quot;, $levels))&nbsp;</div></li><li><div>              $return = (empty($user_id) || $user_id != $current_user-&gt;ID);&nbsp;</div></li><li><div>          elseif(in_array(&quot;E&quot;, $levels) || in_array(&quot;e&quot;, $levels)) {&nbsp;</div></li><li><div>              $sql = &quot;SELECT id FROM $wpdb-&gt;pmpro_memberships_users WHERE user_id=$user_id AND status='expired' LIMIT 1&quot;;&nbsp;</div></li><li><div>              $expired = $wpdb-&gt;get_var($sql);&nbsp;</div></li><li><div>              $return = !empty($expired);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          foreach($levels as $level)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              if(strtoupper($level) == &quot;L&quot;)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  <span class="comment">//checking if user is logged in</span>&nbsp;</div></li><li><div>                  if(!empty($user_id) && $user_id == $current_user-&gt;ID)&nbsp;</div></li><li><div>                      $return = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              elseif(strtoupper($level) == &quot;-L&quot;)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  <span class="comment">//checking if user is logged out</span>&nbsp;</div></li><li><div>                  if(empty($user_id) || $user_id != $current_user-&gt;ID)&nbsp;</div></li><li><div>                      $return = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              elseif($level == &quot;0&quot; || strtoupper($level) == &quot;E&quot;)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  continue;    <span class="comment">//user with levels so not a &quot;non-member&quot; or expired</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  <span class="comment">//checking a level id</span>&nbsp;</div></li><li><div>                  $level_obj = pmpro_getLevel(is_numeric($level) ? abs(intval($level)) : $level); <span class="comment">//make sure our level is in a proper format</span>&nbsp;</div></li><li><div>                  if(empty($level_obj)) {continue;} <span class="comment">//invalid level</span>&nbsp;</div></li><li><div>                  $found_level = false;&nbsp;</div></li><li><div>                  foreach($membership_levels as $membership_level)&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      if($membership_level-&gt;id == $level_obj-&gt;id) <span class="comment">//found a match</span>&nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                          $found_level = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(is_numeric($level) && intval($level) &lt; 0 && !$found_level) <span class="comment">//checking for the absence of this level and they don't have it</span>&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      $return = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  elseif(is_numeric($level) && intval($level) &gt; 0 && $found_level) <span class="comment">//checking for the presence of this level and they have it</span>&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      $return = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  elseif(!is_numeric($level))    <span class="comment">//if a level name was passed</span>&nbsp;</div></li><li><div>                      $return = $found_level;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = apply_filters(&quot;pmpro_has_membership_level&quot;, $return, $user_id, $levels);&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_changeMembershipLevel() creates or updates the membership level of the given user to the given level.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $level may either be the ID or name of the desired membership_level.</span>&nbsp;</div></li><li><div><span class="comment"> * If $user_id is omitted, the value will be retrieved from $current_user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *        Success returns boolean true.</span>&nbsp;</div></li><li><div><span class="comment"> *        Failure returns boolean false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_changeMembershipLevel($level, $user_id = NULL, $old_level_status = 'inactive')&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  global $current_user, $pmpro_error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $pmpro_error = __(&quot;User ID not found.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//make sure user id is int for security</span></span></span>&nbsp;</div></li><li><div>  $user_id = intval($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($level)) <span class="comment">//cancelling membership</span>&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $level = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else if(is_array($level))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//custom level</span></span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $level_obj = pmpro_getLevel($level);&nbsp;</div></li><li><div>      if(empty($level_obj))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $pmpro_error = __(&quot;Invalid level.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $level = $level_obj-&gt;id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if it's a custom level, they're changing</span>&nbsp;</div></li><li><div>  if(!is_array($level))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//are they even changing?</span>&nbsp;</div></li><li><div>      if(pmpro_hasMembershipLevel($level, $user_id)) {&nbsp;</div></li><li><div>          $pmpro_error = __(&quot;not changing?&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>          return false; <span class="comment">//not changing</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//get all active membershipships for this user</span>&nbsp;</div></li><li><div>  $old_levels = pmpro_getMembershipLevelsForUser($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//deactivate old memberships based on the old_level_status passed in (updates pmpro_memberships_users table)</span>&nbsp;</div></li><li><div>  if($old_levels)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      foreach($old_levels as $old_level) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sql = &quot;UPDATE $wpdb-&gt;pmpro_memberships_users SET `status`='$old_level_status', `enddate`='&quot; . current_time('mysql') . &quot;' WHERE `id`=&quot;.$old_level-&gt;subscription_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!$wpdb-&gt;query($sql))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $pmpro_error = __(&quot;Error interacting with database&quot;, &quot;pmpro&quot;) . &quot;: &quot;.($wpdb-&gt;last_error?$wpdb-&gt;last_error:'unavailable');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//get level</span> id</span>&nbsp;</div></li><li><div>  if(is_array($level))&nbsp;</div></li><li><div>      $level_id = $level['membership_id'];    <span class="comment"><span class="comment">//custom level</span></span>&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $level_id = $level;    <span class="comment">//just id</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Action to run before the membership level changes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $level_id ID of the level changed to.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user changed.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action(&quot;pmpro_before_change_membership_level&quot;, $level_id, $user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//should we cancel their gateway subscriptions?</span>&nbsp;</div></li><li><div>  $pmpro_cancel_previous_subscriptions = true;&nbsp;</div></li><li><div>  if(isset($_REQUEST['cancel_membership']) && $_REQUEST['cancel_membership'] == false)&nbsp;</div></li><li><div>      $pmpro_cancel_previous_subscriptions = false;&nbsp;</div></li><li><div>  $pmpro_cancel_previous_subscriptions = apply_filters(&quot;pmpro_cancel_previous_subscriptions&quot;, $pmpro_cancel_previous_subscriptions);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//cancel any other subscriptions they have (updates pmpro_membership_orders table)</span>&nbsp;</div></li><li><div>  if($pmpro_cancel_previous_subscriptions)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $other_order_ids = $wpdb-&gt;get_col(&quot;SELECT id FROM $wpdb-&gt;pmpro_membership_orders WHERE user_id = '&quot; . $user_id . &quot;' AND status = 'success' ORDER BY id DESC&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($other_order_ids as $order_id)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $c_order = new MemberOrder($order_id);&nbsp;</div></li><li><div>          $c_order-&gt;cancel();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($c_order-&gt;error))&nbsp;</div></li><li><div>              $pmpro_error = $c_order-&gt;error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//insert current membership</span>&nbsp;</div></li><li><div>  if(!empty($level)) <span class="comment">//are we getting a new one or just cancelling the old ones</span>&nbsp;</div></li><li><div>  {        &nbsp;</div></li><li><div>      <span class="comment">//make sure the dates are in good formats</span>&nbsp;</div></li><li><div>      if(is_array($level))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//Better support mySQL Strict Mode by passing  a proper enum value for cycle_period</span>&nbsp;</div></li><li><div>          if ($level['cycle_period'] == '') { $level['cycle_period'] = 0; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// clean up date formatting (string/not string)</span>&nbsp;</div></li><li><div>          $level['startdate'] = preg_replace('/\'/', '', $level['startdate']);&nbsp;</div></li><li><div>          $level['enddate'] = preg_replace('/\'/', '', $level['enddate']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>                  INSERT INTO {$wpdb-&gt;pmpro_memberships_users}&nbsp;</div></li><li><div>                  (`user_id`, `membership_id`, `code_id`, `initial_payment`, `billing_amount`, `cycle_number`, `cycle_period`, `billing_limit`, `trial_amount`, `trial_limit`, `startdate`, `enddate`)&nbsp;</div></li><li><div>                  VALUES&nbsp;</div></li><li><div>                  ( %d, %d, %d, %s, %s, %d, %s, %d, %s, %d, %s, %s )&quot;, &nbsp;</div></li><li><div>              $level['user_id'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['membership_id'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['code_id'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['initial_payment'], <span class="comment"><span class="comment"><span class="comment">// float (string)</span></span></span>&nbsp;</div></li><li><div>              $level['billing_amount'], <span class="comment"><span class="comment"><span class="comment">// float (string)</span></span></span>&nbsp;</div></li><li><div>              $level['cycle_number'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['cycle_period'], <span class="comment">// string (enum)</span>&nbsp;</div></li><li><div>              $level['billing_limit'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['trial_amount'], <span class="comment"><span class="comment"><span class="comment">// float (string)</span></span></span>&nbsp;</div></li><li><div>              $level['trial_limit'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// integer</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $level['startdate'], <span class="comment"><span class="comment">// string (date)</span></span>&nbsp;</div></li><li><div>              $level['enddate'] <span class="comment"><span class="comment">// string (date)</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>              INSERT INTO {$wpdb-&gt;pmpro_memberships_users}&nbsp;</div></li><li><div>              ( `user_id`, `membership_id`, `code_id`, `initial_payment`, `billing_amount`, `cycle_number`, `cycle_period`, `billing_limit`, `trial_amount`, `trial_limit`, `startdate`, `enddate`)&nbsp;</div></li><li><div>                  VALUES &nbsp;</div></li><li><div>                  ( %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %s, %s )&quot;, &nbsp;</div></li><li><div>              $user_id, &nbsp;</div></li><li><div>              $level_id, &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              '0', &nbsp;</div></li><li><div>              current_time('mysql'), &nbsp;</div></li><li><div>              '0000-00-00 00:00:00'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( false === $wpdb-&gt;query($sql) )&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $pmpro_error = sprintf( __(&quot;Error interacting with database: %s&quot;, &quot;pmpro&quot;), (!empty($wpdb-&gt;last_error)  ? $wpdb-&gt;last_error : 'unavailable' ));&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }        &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//remove cached level</span>&nbsp;</div></li><li><div>  global $all_membership_levels;&nbsp;</div></li><li><div>  unset($all_membership_levels[$user_id]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//update user data and call action</span>&nbsp;</div></li><li><div>  pmpro_set_current_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Action to run after the membership level changes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $level_id ID of the level changed to.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user changed.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action(&quot;pmpro_after_change_membership_level&quot;, $level_id, $user_id);&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_toggleMembershipCategory() creates or deletes a linking entry between the membership level and post category tables.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $level may either be the ID or name of the desired membership_level.</span>&nbsp;</div></li><li><div><span class="comment"> * $category must be a valid post category ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *        Success returns boolean true.</span>&nbsp;</div></li><li><div><span class="comment"> *        Failure returns a string containing the error message.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_toggleMembershipCategory( $level, $category, $value )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $category = intval($category);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ($level = intval($level)) &lt;= 0 )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $safe = addslashes($level);&nbsp;</div></li><li><div>      if ( ($level = intval($wpdb-&gt;get_var(&quot;SELECT id FROM {$wpdb-&gt;pmpro_membership_levels} WHERE name = '$safe' LIMIT 1&quot;))) &lt;= 0 )&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return __(&quot;Membership level not found.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $value )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $sql = &quot;REPLACE INTO {$wpdb-&gt;pmpro_memberships_categories} (`membership_id`, `category_id`) VALUES ('$level', '$category')&quot;;&nbsp;</div></li><li><div>      $wpdb-&gt;query($sql);&nbsp;</div></li><li><div>      if($wpdb-&gt;last_error) return $wpdb-&gt;last_error;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $sql = &quot;DELETE FROM {$wpdb-&gt;pmpro_memberships_categories} WHERE `membership_id` = '$level' AND `category_id` = '$category' LIMIT 1&quot;;&nbsp;</div></li><li><div>      $wpdb-&gt;query($sql);&nbsp;</div></li><li><div>      if($wpdb-&gt;last_error) return $wpdb-&gt;last_error;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_updateMembershipCategories() ensures that all those and only those categories given</span>&nbsp;</div></li><li><div><span class="comment">* are associated with the given membership level.</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* $level is a valid membership level ID or name</span>&nbsp;</div></li><li><div><span class="comment">* $categories is an array of post category IDs</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* Return values:</span>&nbsp;</div></li><li><div><span class="comment">*        Success returns boolean true.</span>&nbsp;</div></li><li><div><span class="comment">*        Failure returns a string containing the error message.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_updateMembershipCategories($level, $categories)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!is_numeric($level))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $level = $wpdb-&gt;get_var(&quot;SELECT id FROM $wpdb-&gt;pmpro_membership_levels WHERE name = '&quot; . esc_sql($level) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>      if(empty($level))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return __(&quot;Membership level not found.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove all existing links...</span>&nbsp;</div></li><li><div>  $sqlQuery = &quot;DELETE FROM $wpdb-&gt;pmpro_memberships_categories WHERE `membership_id` = '&quot; . esc_sql($level) . &quot;'&quot;;&nbsp;</div></li><li><div>  $wpdb-&gt;query($sqlQuery);&nbsp;</div></li><li><div>  if($wpdb-&gt;last_error) return $wpdb-&gt;last_error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// add the given links [back?] in...</span>&nbsp;</div></li><li><div>  foreach($categories as $cat)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(is_string($r = pmpro_toggleMembershipCategory( $level, $cat, true)))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//uh oh, error</span>&nbsp;</div></li><li><div>          return $r;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//all good</span>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_getMembershipCategories() returns the categories for a given level</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* $level_id is a valid membership level ID</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* Return values:</span>&nbsp;</div></li><li><div><span class="comment">*        Success returns boolean true.</span>&nbsp;</div></li><li><div><span class="comment">*        Failure returns boolean false.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_getMembershipCategories($level_id)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $level_id = intval($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $categories = $wpdb-&gt;get_col(&quot;SELECT c.category_id&nbsp;</div></li><li><div>                                      FROM {$wpdb-&gt;pmpro_memberships_categories} AS c&nbsp;</div></li><li><div>                                      WHERE c.membership_id = '&quot; . $level_id . &quot;'&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $categories;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_isAdmin($user_id = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $current_user, $wpdb;&nbsp;</div></li><li><div>  if(!$user_id)&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$user_id)&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admincap = user_can($user_id, &quot;manage_options&quot;);&nbsp;</div></li><li><div>  if($admincap)&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_replaceUserMeta($user_id, $meta_keys, $meta_values, $prev_values = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//expects all arrays for last 3 params or all strings</span>&nbsp;</div></li><li><div>  if(!is_array($meta_keys))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $meta_keys = array($meta_keys);&nbsp;</div></li><li><div>      $meta_values = array($meta_values);&nbsp;</div></li><li><div>      $prev_values = array($prev_values);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  for($i = 0; $i &lt; count($meta_values); $i++)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($prev_values[$i])&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          update_user_meta($user_id, $meta_keys[$i], $meta_values[$i], $prev_values[$i]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $old_value = get_user_meta($user_id, $meta_keys[$i], true);&nbsp;</div></li><li><div>          if($old_value)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              update_user_meta($user_id, $meta_keys[$i], $meta_values[$i], $old_value);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              update_user_meta($user_id, $meta_keys[$i], $meta_values[$i]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $i;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_getMetavalues($query)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>  $r = new stdClass();&nbsp;</div></li><li><div>  foreach($results as $result)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($r) && !empty($result-&gt;key))&nbsp;</div></li><li><div>          $r-&gt;{$result-&gt;key} = $result-&gt;value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//function to return the pagination string</span>&nbsp;</div></li><li><div>function pmpro_getPaginationString($page = 1, $totalitems, $limit = 15, $adjacents = 1, $targetpage = &quot;/&quot;, $pagestring = &quot;&pn=&quot;)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//defaults</span>&nbsp;</div></li><li><div>  if(!$adjacents) $adjacents = 1;&nbsp;</div></li><li><div>  if(!$limit) $limit = 15;&nbsp;</div></li><li><div>  if(!$page) $page = 1;&nbsp;</div></li><li><div>  if(!$targetpage) $targetpage = &quot;/&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//other vars</span>&nbsp;</div></li><li><div>  $prev = $page - 1;                                    <span class="comment">//previous page is page - 1</span>&nbsp;</div></li><li><div>  $next = $page + 1;                                    <span class="comment">//next page is page + 1</span>&nbsp;</div></li><li><div>  $lastpage = ceil($totalitems / $limit);                <span class="comment">//lastpage is = total items / items per page, rounded up.</span>&nbsp;</div></li><li><div>  $lpm1 = $lastpage - 1;                                <span class="comment">//last page minus 1</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      Now we apply our rules and draw the pagination object.</span>&nbsp;</div></li><li><div><span class="comment">      We're actually saving the code to a variable in case we want to draw it more than once.</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  $pagination = &quot;&quot;;&nbsp;</div></li><li><div>  if($lastpage &gt; 1)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $pagination .= &quot;&lt;div class=\&quot;pmpro_pagination\&quot;&quot;;&nbsp;</div></li><li><div>      if(!empty($margin) || !empty($padding))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $pagination .= &quot; style=\&quot;&quot;;&nbsp;</div></li><li><div>          if($margin)&nbsp;</div></li><li><div>              $pagination .= &quot;margin: $margin;&quot;;&nbsp;</div></li><li><div>          if($padding)&nbsp;</div></li><li><div>              $pagination .= &quot;padding: $padding;&quot;;&nbsp;</div></li><li><div>          $pagination .= &quot;\&quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $pagination .= &quot;&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//previous button</span>&nbsp;</div></li><li><div>      if ($page &gt; 1)&nbsp;</div></li><li><div>          $pagination .= &quot;&lt;a href=\&quot;$targetpage$pagestring$prev\&quot;&gt;&laquo; prev&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $pagination .= &quot;&lt;span class=\&quot;disabled\&quot;&gt;&laquo; prev&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//pages</span>&nbsp;</div></li><li><div>      if ($lastpage &lt; 7 + ($adjacents * 2))    <span class="comment">//not enough pages to bother breaking it up</span>&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          for ($counter = 1; $counter &lt;= $lastpage; $counter++)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              if ($counter == $page)&nbsp;</div></li><li><div>                  $pagination .= &quot;&lt;span class=\&quot;current\&quot;&gt;$counter&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $counter . &quot;\&quot;&gt;$counter&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($lastpage &gt;= 7 + ($adjacents * 2))    <span class="comment">//enough pages to hide some</span>&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//close to beginning; only hide later pages</span>&nbsp;</div></li><li><div>          if($page &lt; 1 + ($adjacents * 3))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              for ($counter = 1; $counter &lt; 4 + ($adjacents * 2); $counter++)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if ($counter == $page)&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;span class=\&quot;current\&quot;&gt;$counter&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $counter . &quot;\&quot;&gt;$counter&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $pagination .= &quot;...&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $lpm1 . &quot;\&quot;&gt;$lpm1&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $lastpage . &quot;\&quot;&gt;$lastpage&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//in middle; hide some front and some back</span>&nbsp;</div></li><li><div>          elseif($lastpage - ($adjacents * 2) &gt; $page && $page &gt; ($adjacents * 2))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . &quot;1\&quot;&gt;1&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . &quot;2\&quot;&gt;2&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;...&quot;;&nbsp;</div></li><li><div>              for ($counter = $page - $adjacents; $counter &lt;= $page + $adjacents; $counter++)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if ($counter == $page)&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;span class=\&quot;current\&quot;&gt;$counter&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $counter . &quot;\&quot;&gt;$counter&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $pagination .= &quot;...&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $lpm1 . &quot;\&quot;&gt;$lpm1&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $lastpage . &quot;\&quot;&gt;$lastpage&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//close to end; only hide early pages</span>&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . &quot;1\&quot;&gt;1&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . &quot;2\&quot;&gt;2&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $pagination .= &quot;...&quot;;&nbsp;</div></li><li><div>              for ($counter = $lastpage - (1 + ($adjacents * 3)); $counter &lt;= $lastpage; $counter++)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  if ($counter == $page)&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;span class=\&quot;current\&quot;&gt;$counter&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $counter . &quot;\&quot;&gt;$counter&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//next button</span>&nbsp;</div></li><li><div>      if ($page &lt; $counter - 1)&nbsp;</div></li><li><div>          $pagination .= &quot;&lt;a href=\&quot;&quot; . $targetpage . $pagestring . $next . &quot;\&quot;&gt;next &raquo;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $pagination .= &quot;&lt;span class=\&quot;disabled\&quot;&gt;next &raquo;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      $pagination .= &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $pagination;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_calculateInitialPaymentRevenue($s = NULL, $l = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//if we're limiting users by search</span></span>&nbsp;</div></li><li><div>  if($s || $l)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $user_ids_query = &quot;SELECT u.ID FROM $wpdb-&gt;users u LEFT JOIN $wpdb-&gt;usermeta um  ON u.ID = um.user_id LEFT JOIN $wpdb-&gt;pmpro_memberships_users mu ON u.ID = mu.user_id WHERE mu.status = 'active' &quot;;&nbsp;</div></li><li><div>      if($s)&nbsp;</div></li><li><div>          $user_ids_query .= &quot;AND (u.user_login LIKE '%&quot; . esc_sql($s) . &quot;%' OR u.user_email LIKE '%&quot; . esc_sql($s) . &quot;%' OR um.meta_value LIKE '%$&quot; . esc_sql(s) . &quot;%') &quot;;&nbsp;</div></li><li><div>      if($l)&nbsp;</div></li><li><div>          $user_ids_query .= &quot;AND mu.membership_id = '&quot; . esc_sql($l) . &quot;' &quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//query to sum initial payments</span>&nbsp;</div></li><li><div>  $sqlQuery = &quot;SELECT SUM(initial_payment) FROM $wpdb-&gt;pmpro_memberships_users WHERE `status` = 'active' &quot;;&nbsp;</div></li><li><div>  if(!empty($user_ids_query))&nbsp;</div></li><li><div>      $sqlQuery .= &quot;AND user_id IN(&quot; . $user_ids_query . &quot;) &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total = $wpdb-&gt;get_var($sqlQuery);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (double)$total;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_calculateRecurringRevenue($s, $l)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//if we're limiting users by search</span></span>&nbsp;</div></li><li><div>  if($s || $l)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $user_ids_query = &quot;AND user_id IN(SELECT u.ID FROM $wpdb-&gt;users u LEFT JOIN $wpdb-&gt;usermeta um  ON u.ID = um.user_id LEFT JOIN $wpdb-&gt;pmpro_memberships_users mu ON u.ID = mu.user_id WHERE mu.status = 'active' &quot;;&nbsp;</div></li><li><div>      if($s)&nbsp;</div></li><li><div>          $user_ids_query .= &quot;AND (u.user_login LIKE '%&quot; . esc_sql($s) . &quot;%' OR u.user_email LIKE '%&quot; . esc_sql($s) . &quot;%' OR um.meta_value LIKE '%&quot; . esc_sql($s) . &quot;%') &quot;;&nbsp;</div></li><li><div>      if($l)&nbsp;</div></li><li><div>          $user_ids_query .= &quot;AND mu.membership_id = '&quot; . esc_sql($l) . &quot;' &quot;;&nbsp;</div></li><li><div>      $user_ids_query .= &quot;)&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $user_ids_query = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//4 queries to get annual earnings for each cycle period. currently ignoring trial periods and billing limits.</span>&nbsp;</div></li><li><div>  $sqlQuery = &quot;&nbsp;</div></li><li><div>      SELECT SUM((12/cycle_number)*billing_amount) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND cycle_period = 'Month' AND cycle_number &lt;&gt; 12 $user_ids_query&nbsp;</div></li><li><div>          UNION&nbsp;</div></li><li><div>      SELECT SUM((365/cycle_number)*billing_amount) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND cycle_period = 'Day' AND cycle_number &lt;&gt; 365 $user_ids_query&nbsp;</div></li><li><div>          UNION&nbsp;</div></li><li><div>      SELECT SUM((52/cycle_number)*billing_amount) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND cycle_period = 'Week' AND cycle_number &lt;&gt; 52 $user_ids_query&nbsp;</div></li><li><div>          UNION&nbsp;</div></li><li><div>      SELECT SUM(billing_amount) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND cycle_period = 'Year' $user_ids_query&nbsp;</div></li><li><div>  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $annual_revenues = $wpdb-&gt;get_col($sqlQuery);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total = 0;&nbsp;</div></li><li><div>  foreach($annual_revenues as $r)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $total += $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $total;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_generateUsername($firstname = &quot;&quot;, $lastname = &quot;&quot;, $email = &quot;&quot;)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//try first initial + last name, firstname, lastname</span>&nbsp;</div></li><li><div>  $firstname = preg_replace(&quot;/[^A-Za-z]/&quot;, &quot;&quot;, $firstname);&nbsp;</div></li><li><div>  $lastname = preg_replace(&quot;/[^A-Za-z]/&quot;, &quot;&quot;, $lastname);&nbsp;</div></li><li><div>  if($firstname && $lastname)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $username = substr($firstname, 0, 1) . $lastname;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif($firstname)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $username = $firstname;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif($lastname)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $username = $lastname;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//is it taken?</span>&nbsp;</div></li><li><div>  $taken = $wpdb-&gt;get_var(&quot;SELECT user_login FROM $wpdb-&gt;users WHERE user_login = '&quot; . esc_sql($username) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!$taken)&nbsp;</div></li><li><div>      return $username;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//try the beginning of the email address</span>&nbsp;</div></li><li><div>  $emailparts = explode(&quot;@&quot;, $email);&nbsp;</div></li><li><div>  if(is_array($emailparts))&nbsp;</div></li><li><div>      $email = preg_replace(&quot;/[^A-Za-z]/&quot;, &quot;&quot;, $emailparts[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($email))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $username = $email;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//is this taken? if not, add numbers until it works</span>&nbsp;</div></li><li><div>  $taken = true;&nbsp;</div></li><li><div>  $count = 0;&nbsp;</div></li><li><div>  while($taken)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//add a # to the end</span>&nbsp;</div></li><li><div>      if($count)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $username = preg_replace(&quot;/[0-9]/&quot;, &quot;&quot;, $username) . $count;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//taken?</span>&nbsp;</div></li><li><div>      $taken = $wpdb-&gt;get_var(&quot;SELECT user_login FROM $wpdb-&gt;users WHERE user_login = '&quot; . esc_sql($username) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//increment the number</span>&nbsp;</div></li><li><div>      $count++;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//must have a good username now</span>&nbsp;</div></li><li><div>  return $username;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//get a new random code for discount codes</span>&nbsp;</div></li><li><div>function pmpro_getDiscountCode($seed = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  while(empty($code))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $scramble = md5(AUTH_KEY . current_time('timestamp') . $seed . SECURE_AUTH_KEY);&nbsp;</div></li><li><div>      $code = substr($scramble, 0, 10);&nbsp;</div></li><li><div>      $check = $wpdb-&gt;get_var(&quot;SELECT code FROM $wpdb-&gt;pmpro_discount_codes WHERE code = '&quot; . esc_sql($code) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>      if($check || is_numeric($code))&nbsp;</div></li><li><div>          $code = NULL;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return strtoupper($code);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//is a discount code valid</span>&nbsp;</div></li><li><div>function pmpro_checkDiscountCode($code, $level_id = NULL, $return_errors = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $error = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//make sure level id is int for security</span>&nbsp;</div></li><li><div>  $level_id = intval($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//no code, no code</span>&nbsp;</div></li><li><div>  if(empty($code))&nbsp;</div></li><li><div>      $error = __(&quot;No code was given to check.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//get code from db</span>&nbsp;</div></li><li><div>  if(!$error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $dbcode = $wpdb-&gt;get_row(&quot;SELECT *, UNIX_TIMESTAMP(starts) as starts, UNIX_TIMESTAMP(expires) as expires FROM $wpdb-&gt;pmpro_discount_codes WHERE code ='&quot; . esc_sql($code) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//did we find it?</span>&nbsp;</div></li><li><div>      if(empty($dbcode-&gt;id))&nbsp;</div></li><li><div>          $error = __(&quot;The discount code could not be found.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check if the code has started</span>&nbsp;</div></li><li><div>  if(!$error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//fix the date timestamps</span>&nbsp;</div></li><li><div>      $dbcode-&gt;starts = strtotime(date(&quot;m/d/Y&quot;, $dbcode-&gt;starts));&nbsp;</div></li><li><div>      $dbcode-&gt;expires = strtotime(date(&quot;m/d/Y&quot;, $dbcode-&gt;expires));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//today</span>&nbsp;</div></li><li><div>      $today = strtotime(date(&quot;m/d/Y 00:00:00&quot;, current_time(&quot;timestamp&quot;)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//has this code started yet?</span>&nbsp;</div></li><li><div>      if(!empty($dbcode-&gt;starts) && $dbcode-&gt;starts &gt; $today)&nbsp;</div></li><li><div>          $error = sprintf(__(&quot;This discount code goes into effect on %s.&quot;, &quot;pmpro&quot;), date(get_option('date_format'), $dbcode-&gt;starts));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check if the code is expired</span>&nbsp;</div></li><li><div>  if(!$error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($dbcode-&gt;expires) && $dbcode-&gt;expires &lt; $today)&nbsp;</div></li><li><div>          $error = sprintf(__(&quot;This discount code expired on %s.&quot;, &quot;pmpro&quot;), date(get_option('date_format'), $dbcode-&gt;expires));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//have we run out of uses?</span>&nbsp;</div></li><li><div>  if(!$error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if($dbcode-&gt;uses &gt; 0)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $used = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;pmpro_discount_codes_uses WHERE code_id = '&quot; . $dbcode-&gt;id . &quot;'&quot;);&nbsp;</div></li><li><div>          if($used &gt;= $dbcode-&gt;uses)&nbsp;</div></li><li><div>              $error = __(&quot;This discount code is no longer valid.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if a level was passed check if this code applies</span>&nbsp;</div></li><li><div>  if(!$error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $pmpro_check_discount_code_levels = apply_filters(&quot;pmpro_check_discount_code_levels&quot;, true, $dbcode-&gt;id);&nbsp;</div></li><li><div>      if(!empty($level_id) && $pmpro_check_discount_code_levels)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $code_level = $wpdb-&gt;get_row(&quot;SELECT l.id, cl.*, l.name, l.description, l.allow_signups FROM $wpdb-&gt;pmpro_discount_codes_levels cl LEFT JOIN $wpdb-&gt;pmpro_membership_levels l ON cl.level_id = l.id WHERE cl.code_id = '&quot; . $dbcode-&gt;id . &quot;' AND cl.level_id = '&quot; . $level_id . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(empty($code_level))&nbsp;</div></li><li><div>              $error = __(&quot;This discount code does not apply to this membership level.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//allow filter</span>&nbsp;</div></li><li><div>  $pmpro_check_discount_code = apply_filters(&quot;pmpro_check_discount_code&quot;, !$error, $dbcode, $level_id, $code);&nbsp;</div></li><li><div>  if(is_string($pmpro_check_discount_code))&nbsp;</div></li><li><div>      $error = $pmpro_check_discount_code;    <span class="comment">//string returned, this is an error</span>&nbsp;</div></li><li><div>  elseif(!$pmpro_check_discount_code && !$error)&nbsp;</div></li><li><div>      $error = true;                            <span class="comment">//no error before, but filter returned error</span>&nbsp;</div></li><li><div>  elseif($pmpro_check_discount_code)&nbsp;</div></li><li><div>      $error = false;                            <span class="comment"><span class="comment">//filter</span></span> is true, so error false&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//return</span>&nbsp;</div></li><li><div>  if($error)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//there was an error</span>&nbsp;</div></li><li><div>      if(!empty($return_errors))&nbsp;</div></li><li><div>          return array(false, $error);&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//guess we're all good</span>&nbsp;</div></li><li><div>      if(!empty($return_errors))&nbsp;</div></li><li><div>          return array(true, __(&quot;This discount code is okay.&quot;, &quot;pmpro&quot;));&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_no_quotes($s, $quotes = array(&quot;'&quot;, '&quot;'))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  return str_replace($quotes, &quot;&quot;, $s);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//from: http://www.php.net/manual/en/function.implode.php#86845</span>&nbsp;</div></li><li><div>function pmpro_implodeToEnglish($array, $conjunction = 'and')&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// sanity check</span>&nbsp;</div></li><li><div>  if (!$array || !count ($array))&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get last element</span>&nbsp;</div></li><li><div>  $last = array_pop ($array);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if it was the only element - return it</span>&nbsp;</div></li><li><div>  if (!count ($array))&nbsp;</div></li><li><div>      return $last;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//possibly translate the conjunction</span>&nbsp;</div></li><li><div>  if($conjunction == 'and')&nbsp;</div></li><li><div>      $conjunction = __('and', 'pmpro');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return implode (', ', $array).' ' . $conjunction . ' '.$last;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//from yoast wordpress seo</span>&nbsp;</div></li><li><div>function pmpro_text_limit( $text, $limit, $finish = '&hellip;')&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if( strlen( $text ) &gt; $limit ) {&nbsp;</div></li><li><div>      $text = substr( $text, 0, $limit );&nbsp;</div></li><li><div>      $text = substr( $text, 0, - ( strlen( strrchr( $text, ' ') ) ) );&nbsp;</div></li><li><div>      $text .= $finish;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $text;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_getMembershipLevelForUser() returns the first active membership level for a user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If $user_id is omitted, the value will be retrieved from $current_user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *        Success returns the level object.</span>&nbsp;</div></li><li><div><span class="comment"> *        Failure returns false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getMembershipLevelForUser($user_id = NULL, $force = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//make sure user id is int for security</span></span></span>&nbsp;</div></li><li><div>  $user_id = intval($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $all_membership_levels;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($all_membership_levels[$user_id]) && !$force)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $all_membership_levels[$user_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $all_membership_levels[$user_id] = $wpdb-&gt;get_row(&quot;SELECT&nbsp;</div></li><li><div>                                                          l.id AS ID, &nbsp;</div></li><li><div>                                                          l.id as id, &nbsp;</div></li><li><div>                                                          mu.id as subscription_id, &nbsp;</div></li><li><div>                                                          l.name AS name, &nbsp;</div></li><li><div>                                                          l.description, &nbsp;</div></li><li><div>                                                          l.expiration_number, &nbsp;</div></li><li><div>                                                          l.expiration_period, &nbsp;</div></li><li><div>                                                          l.allow_signups, &nbsp;</div></li><li><div>                                                          mu.initial_payment, &nbsp;</div></li><li><div>                                                          mu.billing_amount, &nbsp;</div></li><li><div>                                                          mu.cycle_number, &nbsp;</div></li><li><div>                                                          mu.cycle_period, &nbsp;</div></li><li><div>                                                          mu.billing_limit, &nbsp;</div></li><li><div>                                                          mu.trial_amount, &nbsp;</div></li><li><div>                                                          mu.trial_limit, &nbsp;</div></li><li><div>                                                          mu.code_id as code_id, &nbsp;</div></li><li><div>                                                          UNIX_TIMESTAMP(startdate) as startdate, &nbsp;</div></li><li><div>                                                          UNIX_TIMESTAMP(enddate) as enddate&nbsp;</div></li><li><div>                                                      FROM {$wpdb-&gt;pmpro_membership_levels} AS l&nbsp;</div></li><li><div>                                                      JOIN {$wpdb-&gt;pmpro_memberships_users} AS mu ON (l.id = mu.membership_id)&nbsp;</div></li><li><div>                                                      WHERE mu.user_id = $user_id AND mu.status = 'active'&nbsp;</div></li><li><div>                                                      LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * pmpro_get_membership_level_for_user filter.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the returned level.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.8.5.4</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param object $level Level object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $all_membership_levels[$user_id] = apply_filters('pmpro_get_membership_level_for_user', $all_membership_levels[$user_id]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $all_membership_levels[$user_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_getMembershipLevelsForUser() returns the membership levels for a user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If $user_id is omitted, the value will be retrieved from $current_user.</span>&nbsp;</div></li><li><div><span class="comment"> * By default it only includes actvie memberships.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *        Success returns an array of level objects.</span>&nbsp;</div></li><li><div><span class="comment"> *        Failure returns false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getMembershipLevelsForUser($user_id = NULL, $include_inactive = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>      $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($user_id))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//make sure user id is int for security</span></span></span>&nbsp;</div></li><li><div>  $user_id = intval($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $levels = $wpdb-&gt;get_results(&quot;SELECT&nbsp;</div></li><li><div>                              l.id AS ID, &nbsp;</div></li><li><div>                              l.id as id, &nbsp;</div></li><li><div>                              mu.id as subscription_id, &nbsp;</div></li><li><div>                              l.name, &nbsp;</div></li><li><div>                              l.description, &nbsp;</div></li><li><div>                              l.expiration_number, &nbsp;</div></li><li><div>                              l.expiration_period, &nbsp;</div></li><li><div>                              mu.initial_payment, &nbsp;</div></li><li><div>                              mu.billing_amount, &nbsp;</div></li><li><div>                              mu.cycle_number, &nbsp;</div></li><li><div>                              mu.cycle_period, &nbsp;</div></li><li><div>                              mu.billing_limit, &nbsp;</div></li><li><div>                              mu.trial_amount, &nbsp;</div></li><li><div>                              mu.trial_limit, &nbsp;</div></li><li><div>                              mu.code_id as code_id, &nbsp;</div></li><li><div>                              UNIX_TIMESTAMP(startdate) as startdate, &nbsp;</div></li><li><div>                              UNIX_TIMESTAMP(enddate) as enddate&nbsp;</div></li><li><div>                          FROM {$wpdb-&gt;pmpro_membership_levels} AS l&nbsp;</div></li><li><div>                          JOIN {$wpdb-&gt;pmpro_memberships_users} AS mu ON (l.id = mu.membership_id)&nbsp;</div></li><li><div>                          WHERE mu.user_id = $user_id&quot;.($include_inactive?&quot;&quot;:&quot; AND mu.status = 'active'&quot;));&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * pmpro_get_membership_levels_for_user filter.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the returned levels.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.5.4</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $levels Array of level objects.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $levels = apply_filters('pmpro_get_membership_levels_for_user', $levels);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $levels;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** pmpro_getLevel() returns the level object for a level</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $level may be the level id or name</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Return values:</span>&nbsp;</div></li><li><div><span class="comment"> *        Success returns the level object.</span>&nbsp;</div></li><li><div><span class="comment"> *        Failure returns false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getLevel($level)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_levels;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(is_object($level) && !empty($level-&gt;id))&nbsp;</div></li><li><div>      $level = $level-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//was a name passed? (Todo: make sure level names have at least one non-numeric character.</span>&nbsp;</div></li><li><div>  if(is_numeric($level))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $level_id = intval($level);&nbsp;</div></li><li><div>      if(isset($pmpro_levels[$level_id]))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return $pmpro_levels[$level_id];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          $pmpro_levels[$level_id] = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;pmpro_membership_levels WHERE id = '&quot; . $level_id . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>          return $pmpro_levels[$level_id];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $level_obj = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;pmpro_membership_levels WHERE name = '&quot; . esc_sql($level) . &quot;' LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($level_obj))&nbsp;</div></li><li><div>          $level_id = $level_obj-&gt;id;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pmpro_levels[$level_id] = $level_obj;&nbsp;</div></li><li><div>      return $pmpro_levels[$level_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Function to populate pmpro_levels with all levels. We query the DB every time just to be sure we have the latest.</span>&nbsp;</div></li><li><div><span class="comment">  This should be called if you want to be sure you get all levels as $pmpro_levels may only have a subset of levels.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_getAllLevels($include_hidden = false, $force = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_levels, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//just use what's cached (doesn't take into account include_hidden setting)</span>&nbsp;</div></li><li><div>  if(!empty($pmpro_levels) && !$force)&nbsp;</div></li><li><div>      return $pmpro_levels;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//build query</span>&nbsp;</div></li><li><div>  $sqlQuery = &quot;SELECT * FROM $wpdb-&gt;pmpro_membership_levels &quot;;&nbsp;</div></li><li><div>  if(!$include_hidden)&nbsp;</div></li><li><div>      $sqlQuery .= &quot; WHERE allow_signups = 1 ORDER BY id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//get level</span>s from the DB</span>&nbsp;</div></li><li><div>  $raw_levels = $wpdb-&gt;get_results($sqlQuery);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//lets put them into an array where the key is the id of the level</span>&nbsp;</div></li><li><div>  $pmpro_levels = array();&nbsp;</div></li><li><div>  foreach($raw_levels as $raw_level)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $pmpro_levels[$raw_level-&gt;id] = $raw_level;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $pmpro_levels;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function pmpro_getCheckoutButton($level_id, $button_text = NULL, $classes = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if(empty($button_text))&nbsp;</div></li><li><div>      $button_text = __(&quot;Sign Up for !!name!! Now&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($classes))&nbsp;</div></li><li><div>      $classes = &quot;pmpro_btn&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($level_id))&nbsp;</div></li><li><div>      $r = __(&quot;Please specify a level id.&quot;, &quot;pmpro&quot;);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//get level</span>&nbsp;</div></li><li><div>      $level = pmpro_getLevel($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//replace vars</span>&nbsp;</div></li><li><div>      $replacements = array(&nbsp;</div></li><li><div>          &quot;!!id!!&quot; =&gt; $level-&gt;id, &nbsp;</div></li><li><div>          &quot;!!name!!&quot; =&gt; $level-&gt;name, &nbsp;</div></li><li><div>          &quot;!!description!!&quot; =&gt; $level-&gt;description, &nbsp;</div></li><li><div>          &quot;!!confirmation!!&quot; =&gt; $level-&gt;confirmation, &nbsp;</div></li><li><div>          &quot;!!initial_payment!!&quot; =&gt; $level-&gt;initial_payment, &nbsp;</div></li><li><div>          &quot;!!billing_amount!!&quot; =&gt; $level-&gt;billing_amount, &nbsp;</div></li><li><div>          &quot;!!cycle_number!!&quot; =&gt; $level-&gt;cycle_number, &nbsp;</div></li><li><div>          &quot;!!cycle_period!!&quot; =&gt; $level-&gt;cycle_period, &nbsp;</div></li><li><div>          &quot;!!billing_limit!!&quot; =&gt; $level-&gt;billing_limit, &nbsp;</div></li><li><div>          &quot;!!trial_amount!!&quot; =&gt; $level-&gt;trial_amount, &nbsp;</div></li><li><div>          &quot;!!trial_limit!!&quot; =&gt; $level-&gt;trial_limit, &nbsp;</div></li><li><div>          &quot;!!expiration_number!!&quot; =&gt; $level-&gt;expiration_number, &nbsp;</div></li><li><div>          &quot;!!expiration_period!!&quot; =&gt; $level-&gt;expiration_period&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $button_text = str_replace(array_keys($replacements), $replacements, $button_text);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//button text</span>&nbsp;</div></li><li><div>      $r = &quot;&lt;a href=\&quot;&quot; . pmpro_url(&quot;checkout&quot;, &quot;?level=&quot; . $level_id) . &quot;\&quot; class=\&quot;&quot; . $classes . &quot;\&quot;&gt;&quot; . $button_text . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the &quot;domain&quot; from a URL. By domain, we mean the host name, minus any subdomains. So just the domain and TLD.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url The URL to parse. (generally pass site_url() in WP)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The domain.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getDomainFromURL($url = NULL)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $domainparts = parse_url($url);&nbsp;</div></li><li><div>  $domainparts = explode(&quot;.&quot;, $domainparts['host']);&nbsp;</div></li><li><div>  if(count($domainparts) &gt; 1)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//check for ips</span>&nbsp;</div></li><li><div>      $isip = true;&nbsp;</div></li><li><div>      foreach($domainparts as $part)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(!is_numeric($part))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $isip = false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($isip)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//ip, e.g. 127.1.1.1</span>&nbsp;</div></li><li><div>          $domain = implode(&quot;.&quot;, $domainparts);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">//www.something.com, etc.</span>&nbsp;</div></li><li><div>          $domain = $domainparts[count($domainparts)-2] . &quot;.&quot; . $domainparts[count($domainparts)-1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//localhost or another single word domain</span>&nbsp;</div></li><li><div>      $domain = $domainparts[0];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $domain;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Get a member's start date... either in general or for a specific level_id.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>if(!function_exists(&quot;pmpro_getMemberStartdate&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function pmpro_getMemberStartdate($user_id = NULL, $level_id = 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(empty($user_id))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//make sure user and level id are int for security</span>&nbsp;</div></li><li><div>      $user_id = intval($user_id);&nbsp;</div></li><li><div>      $level_id = intval($level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $pmpro_startdates;    <span class="comment">//for cache</span>&nbsp;</div></li><li><div>      if(empty($pmpro_startdates[$user_id][$level_id]))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($level_id))&nbsp;</div></li><li><div>              $sqlQuery = &quot;SELECT UNIX_TIMESTAMP(startdate) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND membership_id IN(&quot; . esc_sql($level_id) . &quot;) AND user_id = '&quot; . $user_id . &quot;' ORDER BY id LIMIT 1&quot;;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $sqlQuery = &quot;SELECT UNIX_TIMESTAMP(startdate) FROM $wpdb-&gt;pmpro_memberships_users WHERE status = 'active' AND user_id = '&quot; . $user_id . &quot;' ORDER BY id LIMIT 1&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $startdate = apply_filters(&quot;pmpro_member_startdate&quot;, $wpdb-&gt;get_var($sqlQuery), $user_id, $level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pmpro_startdates[$user_id][$level_id] = $startdate;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $pmpro_startdates[$user_id][$level_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  How long has this member been a member</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>if(!function_exists(&quot;pmpro_getMemberDays&quot;))&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function pmpro_getMemberDays($user_id = NULL, $level_id = 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(empty($user_id))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          $user_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $pmpro_member_days;&nbsp;</div></li><li><div>      if(empty($pmpro_member_days[$user_id][$level_id]))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $startdate = pmpro_getMemberStartdate($user_id, $level_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//check that there was a startdate at all</span>&nbsp;</div></li><li><div>          if(empty($startdate))&nbsp;</div></li><li><div>              $pmpro_member_days[$user_id][$level_id] = 0;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $now = current_time('timestamp');&nbsp;</div></li><li><div>              $days = ($now - $startdate)/3600/24;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $pmpro_member_days[$user_id][$level_id] = $days;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $pmpro_member_days[$user_id][$level_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//the start of a message handling script</span>&nbsp;</div></li><li><div>function pmpro_setMessage($message, $type, $force = false)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_msg, $pmpro_msgt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//for now, we only show the first message generated</span>&nbsp;</div></li><li><div>  if($force || empty($pmpro_msg))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $pmpro_msg = $message;&nbsp;</div></li><li><div>      $pmpro_msgt = $type;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Show a a PMPro message set via pmpro_setMessage</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.5</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_showMessage()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_msg, $pmpro_msgt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($pmpro_msg))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;&lt;?php echo $pmpro_msgt;?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php echo $pmpro_msg;?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//used in class definitions for input fields to see if there was an error</span>&nbsp;</div></li><li><div>function pmpro_getClassForField($field)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_error_fields, $pmpro_required_billing_fields, $pmpro_required_user_fields;&nbsp;</div></li><li><div>  $classes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//error on this field?</span>&nbsp;</div></li><li><div>  if(!empty($pmpro_error_fields) && in_array($field, $pmpro_error_fields))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $classes[] = &quot;pmpro_error&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(is_array($pmpro_required_billing_fields) && is_array($pmpro_required_user_fields))&nbsp;</div></li><li><div>      $required_fields = array_merge(array_keys($pmpro_required_billing_fields), array_keys($pmpro_required_user_fields));&nbsp;</div></li><li><div>  elseif(is_array($pmpro_required_billing_fields))&nbsp;</div></li><li><div>      $required_fields = array_keys($pmpro_required_billing_fields);&nbsp;</div></li><li><div>  elseif(is_array($pmpro_required_user_fields))&nbsp;</div></li><li><div>      $required_fields = array_keys($pmpro_required_user_fields);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $required_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//required?</span>&nbsp;</div></li><li><div>  if(in_array($field, $required_fields))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $classes[] = &quot;pmpro_required&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $classes = apply_filters(&quot;pmpro_field_classes&quot;, $classes, $field);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($classes))&nbsp;</div></li><li><div>      return implode(&quot; &quot;, $classes);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//get a var from $_GET or $_POST</span>&nbsp;</div></li><li><div>function pmpro_getParam($index, $method = &quot;REQUEST&quot;, $default = &quot;&quot;)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if($method == &quot;REQUEST&quot;)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($_REQUEST[$index]))&nbsp;</div></li><li><div>          return $_REQUEST[$index];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif($method == &quot;POST&quot;)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($_POST[$index]))&nbsp;</div></li><li><div>          return $_POST[$index];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  elseif($method == &quot;GET&quot;)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(!empty($_GET[$index]))&nbsp;</div></li><li><div>          return $_GET[$index];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $default;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Format an address from address, city, state, zip, country, and phone</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_formatAddress($name, $address1, $address2, $city, $state, $zip, $country, $phone, $nl2br = true)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $address = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($name))&nbsp;</div></li><li><div>      $address .= $name . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($address1))&nbsp;</div></li><li><div>      $address .= $address1 . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($address2))&nbsp;</div></li><li><div>      $address .= $address2 . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($city) && !empty($state))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $address .= $city . &quot;, &quot; . $state;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($zip))&nbsp;</div></li><li><div>          $address .= &quot; &quot; . $zip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $address .= &quot;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($country))&nbsp;</div></li><li><div>      $address .= $country . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($phone))&nbsp;</div></li><li><div>      $address .= formatPhone($phone);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if($nl2br)&nbsp;</div></li><li><div>      $address = nl2br($address);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $address;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Checks if all required settings are set.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function pmpro_is_ready()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $wpdb, $pmpro_pages, $pmpro_level_ready, $pmpro_gateway_ready, $pmpro_pages_ready;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check if there is at least one level</span>&nbsp;</div></li><li><div>  $pmpro_level_ready = (bool)$wpdb-&gt;get_var(&quot;SELECT id FROM $wpdb-&gt;pmpro_membership_levels LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check if the gateway settings are good. first check if it's needed (is there paid membership level)</span>&nbsp;</div></li><li><div>  $paid_membership_level = $wpdb-&gt;get_var(&quot;SELECT id FROM $wpdb-&gt;pmpro_membership_levels WHERE allow_signups = 1 AND (initial_payment &gt; 0 OR billing_amount &gt; 0 OR trial_amount &gt; 0) LIMIT 1&quot;);&nbsp;</div></li><li><div>  $paid_user_subscription = $wpdb-&gt;get_var(&quot;SELECT user_id FROM $wpdb-&gt;pmpro_memberships_users WHERE initial_payment &gt; 0 OR billing_amount &gt; 0 OR trial_amount &gt; 0 LIMIT 1&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($paid_membership_level) && empty($paid_user_subscription))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//no paid membership level now or attached to a user. we don't need the gateway setup</span>&nbsp;</div></li><li><div>      $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $gateway = pmpro_getOption(&quot;gateway&quot;);&nbsp;</div></li><li><div>      if($gateway == &quot;authorizenet&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;loginname&quot;) && pmpro_getOption(&quot;transactionkey&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;paypal&quot; || $gateway == &quot;paypalexpress&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;gateway_email&quot;) && pmpro_getOption(&quot;apiusername&quot;) && pmpro_getOption(&quot;apipassword&quot;) && pmpro_getOption(&quot;apisignature&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;paypalstandard&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;gateway_email&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;payflowpro&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;payflow_partner&quot;) && pmpro_getOption(&quot;payflow_vendor&quot;) && pmpro_getOption(&quot;payflow_user&quot;) && pmpro_getOption(&quot;payflow_pwd&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;stripe&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;stripe_secretkey&quot;) && pmpro_getOption(&quot;stripe_publishablekey&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;braintree&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;braintree_merchantid&quot;) && pmpro_getOption(&quot;braintree_publickey&quot;) && pmpro_getOption(&quot;braintree_privatekey&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;twocheckout&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;twocheckout_apiusername&quot;) && pmpro_getOption(&quot;twocheckout_apipassword&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;cybersource&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if(pmpro_getOption(&quot;gateway_environment&quot;) && pmpro_getOption(&quot;cybersource_merchantid&quot;) && pmpro_getOption(&quot;cybersource_securitykey&quot;))&nbsp;</div></li><li><div>              $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif($gateway == &quot;check&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $pmpro_gateway_ready = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $pmpro_gateway_ready = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//check if we have all pages</span>&nbsp;</div></li><li><div>  if($pmpro_pages[&quot;account&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;billing&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;cancel&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;checkout&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;confirmation&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;invoice&quot;] &&&nbsp;</div></li><li><div>     $pmpro_pages[&quot;levels&quot;])&nbsp;</div></li><li><div>      $pmpro_pages_ready = true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $pmpro_pages_ready = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//now check both</span>&nbsp;</div></li><li><div>  if($pmpro_gateway_ready && $pmpro_pages_ready)&nbsp;</div></li><li><div>      $r = true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $r = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter to determine if PMPro setup is complete or</span>&nbsp;</div></li><li><div><span class="comment">   * if notices or warnings need to be shown in the PMPro settings.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: The filter should return true or false and also set</span>&nbsp;</div></li><li><div><span class="comment">   * the $pmpro_level_ready, $pmpro_gateway_ready, $pmpro_pages_ready global variabls.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.4.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $r ready?</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $r = apply_filters('pmpro_is_ready', $r);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Format a price per the currency settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.7.15</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_formatPrice($price)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_currency, $pmpro_currency_symbol, $pmpro_currencies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//start with the price formatted with two decimals</span>&nbsp;</div></li><li><div>  $formatted = number_format($price, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//settings stored in array?</span>&nbsp;</div></li><li><div>  if(!empty($pmpro_currencies[$pmpro_currency]) && is_array($pmpro_currencies[$pmpro_currency]))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//format number do decimals, with decimal_separator and thousands_separator</span>&nbsp;</div></li><li><div>      $formatted = number_format($price, &nbsp;</div></li><li><div>          (isset($pmpro_currencies[$pmpro_currency]['decimals']) ? (int)$pmpro_currencies[$pmpro_currency]['decimals'] : 2), &nbsp;</div></li><li><div>          (isset($pmpro_currencies[$pmpro_currency]['decimal_separator']) ? $pmpro_currencies[$pmpro_currency]['decimal_separator'] : '.'), &nbsp;</div></li><li><div>          (isset($pmpro_currencies[$pmpro_currency]['thousands_separator']) ? $pmpro_currencies[$pmpro_currency]['thousands_separator'] : ', ')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//which side is the symbol on?</span>&nbsp;</div></li><li><div>      if(!empty($pmpro_currencies[$pmpro_currency]['position']) && $pmpro_currencies[$pmpro_currency]['position']== 'left')&nbsp;</div></li><li><div>          $formatted = $pmpro_currency_symbol . $formatted;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $formatted = $formatted . $pmpro_currency_symbol;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $formatted = $pmpro_currency_symbol . $formatted;    <span class="comment">//default to symbol on the left</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//filter</span></span>&nbsp;</div></li><li><div>  return apply_filters('pmpro_format_price', $formatted, $price, $pmpro_currency, $pmpro_currency_symbol);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Which side does the currency symbol go on?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.7.15</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getCurrencyPosition()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $pmpro_currency, $pmpro_currencies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($pmpro_currencies[$pmpro_currency]) && is_array($pmpro_currencies[$pmpro_currency]) && !empty($pmpro_currencies[$pmpro_currency]['position']))&nbsp;</div></li><li><div>      return $pmpro_currencies[$pmpro_currency]['position'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return &quot;left&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * What gateway should we be using?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_getGateway()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//grab from param or options</span>&nbsp;</div></li><li><div>  if (!empty($_REQUEST['gateway']))&nbsp;</div></li><li><div>      $gateway = $_REQUEST['gateway'];        <span class="comment">//gateway passed as param</span>&nbsp;</div></li><li><div>  elseif (!empty($_REQUEST['review']))&nbsp;</div></li><li><div>      $gateway = &quot;paypalexpress&quot;;                <span class="comment">//if review param assume paypalexpress</span>&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $gateway = pmpro_getOption(&quot;gateway&quot;);  <span class="comment">//get from options</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//set valid gateways - the active gateway in the settings and any gateway added through the filter will be allowed</span>&nbsp;</div></li><li><div>  if(pmpro_getOption(&quot;gateway&quot;, true) == &quot;paypal&quot;)&nbsp;</div></li><li><div>      $valid_gateways = apply_filters(&quot;pmpro_valid_gateways&quot;, array(&quot;paypal&quot;, &quot;paypalexpress&quot;));&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $valid_gateways = apply_filters(&quot;pmpro_valid_gateways&quot;, array(pmpro_getOption(&quot;gateway&quot;, true)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//make sure it's valid</span>&nbsp;</div></li><li><div>  if(!in_array($gateway, $valid_gateways))&nbsp;</div></li><li><div>      $gateway = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//filter</span></span> for good measure&nbsp;</div></li><li><div>  $gateway = apply_filters('pmpro_get_gateway', $gateway, $valid_gateways);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $gateway;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Does the date provided fall in this month.</span>&nbsp;</div></li><li><div><span class="comment"> * Used in logins/visits/views report.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.3</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_isDateThisMonth($str)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $now = current_time('timestamp');&nbsp;</div></li><li><div>  $this_month = intval(date(&quot;n&quot;, $now));&nbsp;</div></li><li><div>  $this_year = intval(date(&quot;Y&quot;, $now));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $date = strtotime($str, $now);&nbsp;</div></li><li><div>  $date_month = intval(date(&quot;n&quot;, $date));&nbsp;</div></li><li><div>  $date_year = intval(date(&quot;Y&quot;, $date));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if($date_month === $this_month && $date_year === $this_year)&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Function to generate PMPro front end pages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $pages {</span>&nbsp;</div></li><li><div><span class="comment"> *     Formatted as array($name =&gt; $title) or array(array('title'=&gt;'The Title', 'content'=&gt;'The Content'))</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $name Page name. (Letters, numbers, and underscores only.)</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $title Page title.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $created_pages Created page IDs.</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.5</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pmpro_generatePages($pages) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $pmpro_pages;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pages_created = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($pages)) {&nbsp;</div></li><li><div>      foreach($pages as $name =&gt; $page) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//does it already exist?</span>&nbsp;</div></li><li><div>          if(!empty($pmpro_pages[$name]))&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//no id set. create an array to store the page info</span>&nbsp;</div></li><li><div>          if(is_array($page)) {&nbsp;</div></li><li><div>              $title = $page['title'];&nbsp;</div></li><li><div>              $content = $page['content'];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $title = $page;&nbsp;</div></li><li><div>              $content = '[pmpro_' . $name . ']';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $insert = array(&nbsp;</div></li><li><div>              'post_title' =&gt; $title, &nbsp;</div></li><li><div>              'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>              'post_type' =&gt; 'page', &nbsp;</div></li><li><div>              'post_content' =&gt; $content, &nbsp;</div></li><li><div>              'comment_status' =&gt; 'closed', &nbsp;</div></li><li><div>              'ping_status' =&gt; 'closed'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//make non-account pages a subpage of account</span>&nbsp;</div></li><li><div>          if ($name != &quot;account&quot;) {&nbsp;</div></li><li><div>              $insert['post_parent'] = $pmpro_pages['account'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//create the page</span>&nbsp;</div></li><li><div>          $pmpro_pages[$name] = wp_insert_post($insert);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//update the option too</span>&nbsp;</div></li><li><div>          pmpro_setOption($name . &quot;_page_id&quot;, $pmpro_pages[$name]);&nbsp;</div></li><li><div>          $pages_created[] = $pmpro_pages[$name];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $pages_created;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Schedule a periodic event unless one with the same hook is already scheduled.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $timestamp Timestamp for when to run the event.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $recurrence How often the event should recur.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $hook Action hook to execute when cron is run.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args Optional. Arguments to pass to the hook's callback function.</span>&nbsp;</div></li><li><div><span class="comment"> * @return false|void False when an event is not scheduled.</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.7.3</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div> function pmpro_maybe_schedule_event( $timestamp, $recurrence, $hook, $args = array()) {&nbsp;</div></li><li><div>  $next = wp_next_scheduled($hook, $args);&nbsp;</div></li><li><div>  if(empty($next))&nbsp;</div></li><li><div>      return wp_schedule_event($timestamp, $recurrence, $hook, $args);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div> }&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Paid Memberships Pro</li><li><span></span>1.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>