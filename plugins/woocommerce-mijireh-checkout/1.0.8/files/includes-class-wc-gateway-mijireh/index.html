<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.0.8" data-slug="woocommerce-mijireh-checkout" data-type="file" data-id="90949"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-class-wc-gateway-mijireh | file | Woocommerce Mijireh Checkout | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-mijireh-checkout, 1.0.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=70e6acf187950a50db0a35569b1d9fc5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-class-wc-gateway-mijireh/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-gateway-mijireh%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-gateway-mijireh%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-mijireh-checkout-1.0.8-file-includes-class-wc-gateway-mijireh","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-class-wc-gateway-mijireh" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-mijireh-checkout." href="http://hookr.io/plugins/woocommerce-mijireh-checkout/" class="plugin"><span property="name">woocommerce-mijireh-checkout</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.0.8." href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/" class="H_VERSION"><span property="name">1.0.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-class-wc-gateway-mij&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="32"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/all/" title="All">All <span class="count badge">32</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="4"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/hooks/" title="Hooks">Hooks <span class="count badge">4</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="4"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/filters/" title="Filters">Filters <span class="count badge">4</span></a></li><li class="" data-id="class" data-count="28"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/classes/" title="Classes">Classes <span class="count badge">28</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-mijireh-checkout/1.0.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/class-wc-gateway-mijireh.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) {&nbsp;</div></li><li><div>  exit; <span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mijireh Checkout Gateway</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Provides WooCommerce with Mijireh Checkout integration.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @class   WC_Gateway_Mijireh</span>&nbsp;</div></li><li><div><span class="comment"> * @extends WC_Payment_Gateway</span>&nbsp;</div></li><li><div><span class="comment"> * @version 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @package WooCommerce/Classes/Payment</span>&nbsp;</div></li><li><div><span class="comment"> * @author  Mijireh</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_Gateway_Mijireh extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Access key for mijireh.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $access_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor for the gateway.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      $this-&gt;id = 'mijireh_checkout';&nbsp;</div></li><li><div>      $this-&gt;method_title = __( 'Mijireh Checkout', 'woocommerce-gateway-mijireh-checkout' );&nbsp;</div></li><li><div>      $this-&gt;icon = apply_filters( 'woocommerce_mijireh_checkout_icon', plugins_url( 'assets/images/credit_cards.png', plugin_dir_path( __FILE__ ) ) );&nbsp;</div></li><li><div>      $this-&gt;has_fields = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>      $this-&gt;init_form_fields();&nbsp;</div></li><li><div>      $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Define user set variables.</span>&nbsp;</div></li><li><div>      $this-&gt;access_key = $this-&gt;get_option( 'access_key' );&nbsp;</div></li><li><div>      $this-&gt;title = $this-&gt;get_option( 'title' );&nbsp;</div></li><li><div>      $this-&gt;description = $this-&gt;get_option( 'description' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;enabled && is_admin() ) {&nbsp;</div></li><li><div>          $this-&gt;install_slurp_page();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save options.</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Payment listener/API hook.</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_api_wc_gateway_mijireh', array( $this, 'mijireh_notification' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Install slurp page.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function install_slurp_page() {&nbsp;</div></li><li><div>      $slurp_page_installed = get_option( 'slurp_page_installed', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 1 != $slurp_page_installed ) {&nbsp;</div></li><li><div>          if ( ! get_page_by_path( 'mijireh-secure-checkout' ) ) {&nbsp;</div></li><li><div>              $page = array(&nbsp;</div></li><li><div>                  'post_title' =&gt; __( 'Mijireh Secure Checkout', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>                  'post_name' =&gt; 'mijireh-secure-checkout', &nbsp;</div></li><li><div>                  'post_parent' =&gt; 0, &nbsp;</div></li><li><div>                  'post_status' =&gt; 'private', &nbsp;</div></li><li><div>                  'post_type' =&gt; 'page', &nbsp;</div></li><li><div>                  'comment_status' =&gt; 'closed', &nbsp;</div></li><li><div>                  'ping_status' =&gt; 'closed', &nbsp;</div></li><li><div>                  'post_content' =&gt; '&lt;h1&gt;' . __( 'Checkout', 'woocommerce-gateway-mijireh-checkout' ) . '&lt;/h1&gt;' . &quot;\n\n&quot; . '{{mj-checkout-form}}', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_insert_post( $page );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_option( 'slurp_page_installed', 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Notification.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function mijireh_notification() {&nbsp;</div></li><li><div>      if ( isset( $_GET['order_number'] ) ) {&nbsp;</div></li><li><div>          self::init_mijireh();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $mj_order_id = esc_attr( $_GET['order_number'] );&nbsp;</div></li><li><div>              $mj_order = new Mijireh_Order( $mj_order_id );&nbsp;</div></li><li><div>              $wc_order_id = $mj_order-&gt;get_meta_value( 'wc_order_id' );&nbsp;</div></li><li><div>              $wc_order = wc_get_order( absint( $wc_order_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Mark order complete.</span>&nbsp;</div></li><li><div>              $wc_order-&gt;payment_complete( $mj_order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Empty cart and clear session.</span>&nbsp;</div></li><li><div>              WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_redirect( $this-&gt;get_return_url( $wc_order ) );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } catch ( Mijireh_Exception $e ) {&nbsp;</div></li><li><div>              wc_add_notice( __( 'Mijireh error:', 'woocommerce-gateway-mijireh-checkout' ) . $e-&gt;getMessage(), 'error' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( isset( $_POST['page_id'] ) ) {&nbsp;</div></li><li><div>          if ( isset( $_POST['access_key'] ) && $_POST['access_key'] == $this-&gt;access_key ) {&nbsp;</div></li><li><div>              wp_update_post( array( 'ID' =&gt; $_POST['page_id'], 'post_status' =&gt; 'private' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init_form_fields() {&nbsp;</div></li><li><div>      $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Enable/Disable', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable Mijireh Checkout', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'access_key' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Access Key', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'The Mijireh access key for your store.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Title', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'default' =&gt; __( 'Credit Card', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Description', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'type' =&gt; 'textarea', &nbsp;</div></li><li><div>              'default' =&gt; __( 'Pay securely with your credit card.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>              'description' =&gt; __( 'This controls the description which the user sees during checkout.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Admin Panel Options</span>&nbsp;</div></li><li><div><span class="comment">   * - Options for bits like 'title' and availability on a country-by-country basis</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_options() {&nbsp;</div></li><li><div>      include_once( 'views/html-admin-options.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment and return the result.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_payment( $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::init_mijireh();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $mj_order = new Mijireh_Order();&nbsp;</div></li><li><div>      $wc_order = wc_get_order( $order_id );&nbsp;</div></li><li><div>      $send_as_lump = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Avoid rounding issues altogether by sending the order as one lump.</span>&nbsp;</div></li><li><div>      if ( 'yes' !== get_option( 'woocommerce_prices_include_tax' ) ) {&nbsp;</div></li><li><div>          $calculated_total = 0;&nbsp;</div></li><li><div>          $items = $wc_order-&gt;get_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $items as $item ) {&nbsp;</div></li><li><div>              $product = $wc_order-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>              $mj_order-&gt;add_item( $item['name'], $wc_order-&gt;get_item_subtotal( $item, false, true ), $item['qty'], $product-&gt;get_sku() );&nbsp;</div></li><li><div>              $calculated_total += $wc_order-&gt;get_item_subtotal( $item, false ) * $item['qty'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Handle fees</span>&nbsp;</div></li><li><div>          $items = $wc_order-&gt;get_fees();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $items as $item ) {&nbsp;</div></li><li><div>              $mj_order-&gt;add_item( $item['name'], number_format( $item['line_total'], 2, '.', ', ' ), 1, '' );&nbsp;</div></li><li><div>              $calculated_total += $item['line_total'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Check for mismatched totals</span>&nbsp;</div></li><li><div>          if ( wc_format_decimal( $calculated_total + $wc_order-&gt;get_total_tax() + round( $wc_order-&gt;get_total_shipping(), 2 ) - round( $wc_order-&gt;get_total_discount(), 2 ), 2 ) != wc_format_decimal( $wc_order-&gt;get_total(), 2 ) ) {&nbsp;</div></li><li><div>              $send_as_lump = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mj_order-&gt;shipping = number_format( $wc_order-&gt;get_total_shipping(), 2, '.', '' );&nbsp;</div></li><li><div>              $mj_order-&gt;tax = number_format( $wc_order-&gt;get_total_tax(), 2, '.', '' );&nbsp;</div></li><li><div>              $mj_order-&gt;discount = number_format( $wc_order-&gt;get_total_discount(), 2, '.', '' );&nbsp;</div></li><li><div>              $mj_order-&gt;total = number_format( $wc_order-&gt;get_total(), 2, '.', '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $send_as_lump = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( true === $send_as_lump ) {&nbsp;</div></li><li><div>          <span class="comment">// Reset order items and tax  in case we went through the block above</span>&nbsp;</div></li><li><div>          $mj_order-&gt;clear_items();&nbsp;</div></li><li><div>          $mj_order-&gt;tax = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Don't pass items - Pass 1 item for the order items overall.</span>&nbsp;</div></li><li><div>          $item_names = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( sizeof( $wc_order-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>              foreach ( $wc_order-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>                  if ( $item['qty'] ) {&nbsp;</div></li><li><div>                      $item_names[] = $item['name'] . ' x ' . $item['qty'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( version_compare( WC_VERSION, '2.3', '&gt;=' ) ) {&nbsp;</div></li><li><div>              $mj_order-&gt;discount = $discount = number_format( $wc_order-&gt;get_total_discount(), 2, '.', '' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mj_order-&gt;discount = $discount = number_format( $wc_order-&gt;get_order_discount(), 2, '.', '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// this filter is added to circumvent character limit issues with certain gateways causing payment failure</span>&nbsp;</div></li><li><div>          $item_desc = apply_filters( 'woocommerce_mijireh_checkout_consolidated_char_limit', sprintf( __( 'Order %s' , 'woocommerce-gateway-mijireh-checkout' ), $wc_order-&gt;get_order_number() ) . ' - ' . implode( ', ', $item_names ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mj_order-&gt;add_item( $item_desc, number_format( $wc_order-&gt;get_total() - round( $wc_order-&gt;get_total_shipping() + $wc_order-&gt;get_shipping_tax(), 2 ) + $discount, 2, '.', '' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ( $wc_order-&gt;get_total_shipping() + $wc_order-&gt;get_shipping_tax() ) &gt; 0 ) {&nbsp;</div></li><li><div>              $mj_order-&gt;shipping = number_format( $wc_order-&gt;get_total_shipping() + $wc_order-&gt;get_shipping_tax(), 2, '.', '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mj_order-&gt;show_tax = false;&nbsp;</div></li><li><div>          $mj_order-&gt;total = number_format( $wc_order-&gt;get_total(), 2, '.', '' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add billing address to order</span>&nbsp;</div></li><li><div>      $billing = new Mijireh_Address();&nbsp;</div></li><li><div>      $billing-&gt;first_name = $wc_order-&gt;billing_first_name;&nbsp;</div></li><li><div>      $billing-&gt;last_name = $wc_order-&gt;billing_last_name;&nbsp;</div></li><li><div>      $billing-&gt;street = $wc_order-&gt;billing_address_1;&nbsp;</div></li><li><div>      $billing-&gt;apt_suite = $wc_order-&gt;billing_address_2;&nbsp;</div></li><li><div>      $billing-&gt;city = $wc_order-&gt;billing_city;&nbsp;</div></li><li><div>      $billing-&gt;state_province = $wc_order-&gt;billing_state;&nbsp;</div></li><li><div>      $billing-&gt;zip_code = $wc_order-&gt;billing_postcode;&nbsp;</div></li><li><div>      $billing-&gt;country = $wc_order-&gt;billing_country;&nbsp;</div></li><li><div>      $billing-&gt;company = $wc_order-&gt;billing_company;&nbsp;</div></li><li><div>      $billing-&gt;phone = $wc_order-&gt;billing_phone;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $billing-&gt;validate() ) {&nbsp;</div></li><li><div>          $mj_order-&gt;set_billing_address( $billing );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add shipping address to order</span>&nbsp;</div></li><li><div>      $shipping = new Mijireh_Address();&nbsp;</div></li><li><div>      $shipping-&gt;first_name = $wc_order-&gt;shipping_first_name;&nbsp;</div></li><li><div>      $shipping-&gt;last_name = $wc_order-&gt;shipping_last_name;&nbsp;</div></li><li><div>      $shipping-&gt;street = $wc_order-&gt;shipping_address_1;&nbsp;</div></li><li><div>      $shipping-&gt;apt_suite = $wc_order-&gt;shipping_address_2;&nbsp;</div></li><li><div>      $shipping-&gt;city = $wc_order-&gt;shipping_city;&nbsp;</div></li><li><div>      $shipping-&gt;state_province = $wc_order-&gt;shipping_state;&nbsp;</div></li><li><div>      $shipping-&gt;zip_code = $wc_order-&gt;shipping_postcode;&nbsp;</div></li><li><div>      $shipping-&gt;country = $wc_order-&gt;shipping_country;&nbsp;</div></li><li><div>      $shipping-&gt;company = $wc_order-&gt;shipping_company;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $shipping-&gt;validate() ) {&nbsp;</div></li><li><div>          $mj_order-&gt;set_shipping_address( $shipping );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// set order name</span>&nbsp;</div></li><li><div>      $mj_order-&gt;first_name = $wc_order-&gt;billing_first_name;&nbsp;</div></li><li><div>      $mj_order-&gt;last_name = $wc_order-&gt;billing_last_name;&nbsp;</div></li><li><div>      $mj_order-&gt;email = $wc_order-&gt;billing_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add meta data to identify woocommerce order</span>&nbsp;</div></li><li><div>      $mj_order-&gt;add_meta_data( 'wc_order_id', $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set URL for mijireh payment notificatoin - use WC API</span>&nbsp;</div></li><li><div>      $mj_order-&gt;return_url = WC()-&gt;api_request_url( 'WC_Gateway_Mijireh' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Identify woocommerce</span>&nbsp;</div></li><li><div>      $mj_order-&gt;partner_id = 'woo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $mj_order = apply_filters( 'woocommerce_mijireh_checkout_mj_order', $mj_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          $mj_order-&gt;create();&nbsp;</div></li><li><div>          $result = array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; $mj_order-&gt;checkout_url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $result;&nbsp;</div></li><li><div>      } catch ( Mijireh_Exception $e ) {&nbsp;</div></li><li><div>          wc_add_notice( __( 'Mijireh error:', 'woocommerce-gateway-mijireh-checkout' ) . $e-&gt;getMessage() . print_r( $mj_order, true ), 'error' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Init Mijireh.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function init_mijireh() {&nbsp;</div></li><li><div>      if ( ! class_exists( 'Mijireh' ) ) {&nbsp;</div></li><li><div>          require_once 'libs/Mijireh.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $this ) ) {&nbsp;</div></li><li><div>              $settings = get_option( 'woocommerce_mijireh_checkout_settings', null );&nbsp;</div></li><li><div>              $key = ! empty( $settings['access_key'] ) ? $settings['access_key'] : '';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $key = $this-&gt;access_key;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          Mijireh::$access_key = $key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Page slurp.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function page_slurp() {&nbsp;</div></li><li><div>      self::init_mijireh();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $page = get_page( absint( $_POST['page_id'] ) );&nbsp;</div></li><li><div>      $url = get_permalink( $page-&gt;ID );&nbsp;</div></li><li><div>      $job_id = $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wp_update_post( array( 'ID' =&gt; $page-&gt;ID, 'post_status' =&gt; 'publish' ) ) ) {&nbsp;</div></li><li><div>          $job_id = Mijireh::slurp( $url, $page-&gt;ID, str_replace( 'https:', 'http:', add_query_arg( 'wc-api', 'WC_Gateway_Mijireh', home_url( '/' ) ) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo $job_id;&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add page slurp meta.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function add_page_slurp_meta() {&nbsp;</div></li><li><div>      if ( self::is_slurp_page() ) {&nbsp;</div></li><li><div>          $suffix = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_style( 'mijireh_css', plugins_url( 'assets/css/mijireh' . $suffix . '.css', plugin_dir_path( __FILE__ ) ), array(), WC_Mijireh_Checkout::VERSION );&nbsp;</div></li><li><div>          wp_enqueue_script( 'pusher', 'https:<span class="comment">//d3dy5gmtp8yhk7.cloudfront.net/1.11/pusher.min.js', array(), false, true );</span>&nbsp;</div></li><li><div>          wp_enqueue_script( 'page_slurp', plugins_url( 'assets/js/page-slurp' . $suffix . '.js', plugin_dir_path( __FILE__ ) ), array( 'jquery', 'pusher' ), WC_Mijireh_Checkout::VERSION, true );&nbsp;</div></li><li><div>          wp_localize_script(&nbsp;</div></li><li><div>              'page_slurp', &nbsp;</div></li><li><div>              'wc_mijireh_checkout_page_slurp', &nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'starting_up' =&gt; __( 'Starting up', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>                  'wrong_php_config_message' =&gt; __( 'Your PHP configuration does not allow for Page Slurp from within WordPress. Please log into your Mijireh account and Slurp the page by pasting in the URL to this page as shown below.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>                  'set_slurp_page_message' =&gt; __( 'Please set this page to be publicly accessible during the Slurp then set it back to private after the Slurp is complete.', 'woocommerce-gateway-mijireh-checkout' ), &nbsp;</div></li><li><div>                  'access_key_message' =&gt; __( 'Please make sure your Mijireh access key is correct', 'woocommerce-gateway-mijireh-checkout' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_meta_box(&nbsp;</div></li><li><div>              'slurp_meta_box', &nbsp;</div></li><li><div>              'Mijireh Page Slurp', &nbsp;</div></li><li><div>              array( 'WC_Gateway_Mijireh', 'draw_page_slurp_meta_box' ), &nbsp;</div></li><li><div>              'page', &nbsp;</div></li><li><div>              'normal', &nbsp;</div></li><li><div>              'high'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if is slurp page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_slurp_page() {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_slurp = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $post ) && is_object( $post ) ) {&nbsp;</div></li><li><div>          $content = $post-&gt;post_content;&nbsp;</div></li><li><div>          if ( false !== strpos( $content, '{{mj-checkout-form}}' ) ) {&nbsp;</div></li><li><div>              $is_slurp = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is_slurp;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Draw page slurp meta box.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function draw_page_slurp_meta_box( $post ) {&nbsp;</div></li><li><div>      self::init_mijireh();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      include_once( 'views/html-slurp-meta-box.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Mijireh Checkout</li><li><span></span>1.0.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>