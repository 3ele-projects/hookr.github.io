<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.9.9" data-slug="contact-form-db" data-type="file" data-id="44971"><head xmlns="http://www.w3.org/1999/xhtml"><title> cf7dbplugin | file | Contact Form Db | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, contact-form-db, 2.9.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=80b125fb3377055539de26607de0e131' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/cf7dbplugin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcf7dbplugin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcf7dbplugin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-contact-form-db-2.9.9-file-cf7dbplugin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="cf7dbplugin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to contact-form-db." href="http://hookr.io/plugins/contact-form-db/" class="plugin"><span property="name">contact-form-db</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.9.9." href="http://hookr.io/plugins/contact-form-db/2.9.9/" class="H_VERSION"><span property="name">2.9.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/contact-form-db/2.9.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">cf7dbplugin</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="157"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/all/" title="All">All <span class="count badge">157</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="9"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/hooks/" title="Hooks">Hooks <span class="count badge">9</span></a></li><li class="" data-id="action" data-count="7"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/actions/" title="Actions">Actions <span class="count badge">7</span></a></li><li class="" data-id="filter" data-count="2"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/filters/" title="Filters">Filters <span class="count badge">2</span></a></li><li class="" data-id="class" data-count="115"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/classes/" title="Classes">Classes <span class="count badge">115</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="31"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/functions/" title="Functions">Functions <span class="count badge">31</span></a></li><li class="" data-id="shortcode" data-count="2"><a href="http://hookr.io/plugins/contact-form-db/2.9.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">2</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/CF7DBPlugin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  &quot;Contact Form to Database&quot; Copyright (C) 2011-2014 Michael Simpson  (email : michael.d.simpson@gmail.com)</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  This file is part of Contact Form to Database.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  Contact Form to Database is free software: you can redistribute it and/or modify</span>&nbsp;</div></li><li><div><span class="comment">  it under the terms of the GNU General Public License as published by</span>&nbsp;</div></li><li><div><span class="comment">  the Free Software Foundation, either version 3 of the License, or</span>&nbsp;</div></li><li><div><span class="comment">  (at your option) any later version.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  Contact Form to Database is distributed in the hope that it will be useful, </span>&nbsp;</div></li><li><div><span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>&nbsp;</div></li><li><div><span class="comment">  GNU General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  You should have received a copy of the GNU General Public License</span>&nbsp;</div></li><li><div><span class="comment">  along with Contact Form to Database.</span>&nbsp;</div></li><li><div><span class="comment">  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>require_once('CF7DBPluginLifeCycle.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeTable.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeDataTable.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeValue.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeCount.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeJson.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeHtml.php');&nbsp;</div></li><li><div>require_once('CFDBShortcodeExportUrl.php');&nbsp;</div></li><li><div>require_once('CFDBShortCodeSavePostData.php');&nbsp;</div></li><li><div>require_once('CFDBShortCodeSaveFormMakerSubmission.php');&nbsp;</div></li><li><div>require_once('CFDBDeobfuscate.php');&nbsp;</div></li><li><div>require_once('CFDBDateFormatter.php');&nbsp;</div></li><li><div>require_once('CFDBErrorLog.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Implementation for CF7DBPluginLifeCycle.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class CF7DBPlugin extends CF7DBPluginLifeCycle implements CFDBDateFormatter {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getPluginDisplayName() {&nbsp;</div></li><li><div>      return 'Contact Form to DB Extension';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function getMainPluginFileName() {&nbsp;</div></li><li><div>      return 'contact-form-7-db.php';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getOptionMetaData() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          <span class="comment">//'_version' =&gt; array('Installed Version'), // For testing upgrades</span>&nbsp;</div></li><li><div>          <span class="comment">//'Donated' =&gt; array(__('I have donated to this plugin', 'contact-form-7-to-database-extension'), 'false', 'true'), </span>&nbsp;</div></li><li><div>          'IntegrateWithCF7' =&gt; array(__('Capture form submissions from Contact Form 7 Plugin', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithFSCF' =&gt; array(__('Capture form submissions from Fast Secure Contact Form Plugin', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithJetPackContactForm' =&gt; array(__('Capture form submissions from JetPack Contact Form', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithGravityForms' =&gt; array(__('Capture form submissions from Gravity Forms', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithWrContactForms' =&gt; array(__('Capture form submissions from WR ContactForm', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithQuform' =&gt; array(__('Capture form submissions from Quform', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithNinjaForms' =&gt; array(__('Capture form submissions from Ninja Forms', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithCalderaForms' =&gt; array(__('Capture form submissions from Caldera Forms', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'IntegrateWithEnfoldThemForms' =&gt; array(__('Capture form submissions from Enfold Theme', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'CanSeeSubmitData' =&gt; array(__('Can See Submission data', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                                      'Administrator', 'Editor', 'Author', 'Contributor', 'Subscriber', 'Anyone'), &nbsp;</div></li><li><div>          'HideAdminPanelFromNonAdmins' =&gt; array(__('Allow only Administrators to see CFDB administration screens', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          'CanSeeSubmitDataViaShortcode' =&gt; array(__('Can See Submission when using shortcodes', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                                                  'Administrator', 'Editor', 'Author', 'Contributor', 'Subscriber', 'Anyone'), &nbsp;</div></li><li><div>          'CanChangeSubmitData' =&gt; array(__('Can Edit/Delete Submission data', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                                         'Administrator', 'Editor', 'Author', 'Contributor', 'Subscriber', 'Anyone'), &nbsp;</div></li><li><div>          'GenerateSubmitTimeInCF7Email' =&gt; array(__('Generate [submit_time] tag for Contact Form 7 email', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          'FunctionsInShortCodes' =&gt; array(__('Allow Any Function in Short Codes', 'contact-form-7-to-database-extension') .&nbsp;</div></li><li><div>                  ' &lt;a target=&quot;_blank&quot; href=&quot;http:<span class="comment">//cfdbplugin.com/?page_id=1073&quot;&gt;' . __('(Creates a security hole)', 'contact-form-7-to-database-extension') . '&lt;/a&gt;', 'false', 'true'), </span>&nbsp;</div></li><li><div>          'AllowRSS' =&gt; array(__('Allow RSS URLs', 'contact-form-7-to-database-extension') .&nbsp;</div></li><li><div>                  ' &lt;a target=&quot;_blank&quot; href=&quot;http:<span class="comment">//cfdbplugin.com/?p=918&quot;&gt;' . __('(Creates a security hole)', 'contact-form-7-to-database-extension') . '&lt;/a&gt;', 'false', 'true'), </span>&nbsp;</div></li><li><div>          'Timezone' =&gt; array(__('Timezone to capture Submit Time. Blank will use WordPress Timezone setting. &lt;a target=&quot;_blank&quot; href=&quot;http:<span class="comment">//www.php.net/manual/en/timezones.php&quot;&gt;Options&lt;/a&gt;', 'contact-form-7-to-database-extension')), </span>&nbsp;</div></li><li><div>          'MaxRows' =&gt; array(__('Maximum number of rows to retrieve from the DB for the Admin display', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'MaxVisibleRows' =&gt; array(__('#Rows (of maximum above) visible in the Admin datatable', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'HorizontalScroll' =&gt; array(__('Use fixed width in Admin datatable', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'UseDataTablesJS' =&gt; array(__('Use Javascript-enabled tables in Admin Database page', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'ShowLineBreaksInDataTable' =&gt; array(__('Show line breaks in submitted data table', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'UseCustomDateTimeFormat' =&gt; array(__('Use Custom Date-Time Display Format (below)', 'contact-form-7-to-database-extension'), 'true', 'false'), &nbsp;</div></li><li><div>          'SubmitDateTimeFormat' =&gt; array('&lt;a target=&quot;_blank&quot; href=&quot;http:<span class="comment">//php.net/manual/en/function.date.php&quot;&gt;' . __('Date-Time Display Format', 'contact-form-7-to-database-extension') . '&lt;/a&gt;'), </span>&nbsp;</div></li><li><div>          'ShowFileUrlsInExport' =&gt; array(__('Export URLs instead of file names for uploaded files', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          'NoSaveFields' =&gt; array(__('Do not save &lt;u&gt;fields&lt;/u&gt; in DB named (comma-separated list, no spaces)', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'NoSaveForms' =&gt; array(__('Do not save &lt;u&gt;forms&lt;/u&gt; in DB named (comma-separated list, no spaces)', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'SaveCookieData' =&gt; array(__('Save Cookie Data with Form Submissions', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          'SaveCookieNames' =&gt; array(__('Save only cookies in DB named (comma-separated list, no spaces, and above option must be set to true)', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'ShowQuery' =&gt; array(__('Show the query used to display results', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          'ErrorOutput' =&gt; array(__('Error output file (full path) or email address', 'contact-form-7-to-database-extension')), &nbsp;</div></li><li><div>          'DropOnUninstall' =&gt; array(__('Drop this plugin\'s Database table on uninstall', 'contact-form-7-to-database-extension'), 'false', 'true'), &nbsp;</div></li><li><div>          <span class="comment">//'SubmitTableNameOverride' =&gt; array(__('Use this table to store submission data rather than the default (leave blank for default)', 'contact-form-7-to-database-extension'))</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function getOptionValueI18nString($optionValue) {&nbsp;</div></li><li><div>      switch ($optionValue) {&nbsp;</div></li><li><div>          case 'true':&nbsp;</div></li><li><div>              return __('true', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'false':&nbsp;</div></li><li><div>              return __('false', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'Administrator':&nbsp;</div></li><li><div>              return __('Administrator', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'Editor':&nbsp;</div></li><li><div>              return __('Editor', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'Author':&nbsp;</div></li><li><div>              return __('Author', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'Contributor':&nbsp;</div></li><li><div>              return __('Contributor', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'Subscriber':&nbsp;</div></li><li><div>              return __('Subscriber', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>          case 'Anyone':&nbsp;</div></li><li><div>              return __('Anyone', 'contact-form-7-to-database-extension');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $optionValue;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function upgrade() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $upgradeOk = true;&nbsp;</div></li><li><div>      $savedVersion = $this-&gt;getVersionSaved();&nbsp;</div></li><li><div>      if (!$savedVersion) {&nbsp;</div></li><li><div>          <span class="comment">// Was some code here from pre-version 1.2 that I removed b/c it is very old and not relevant.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// A user reported an issue where the saved version in the DB would get cleared out</span>&nbsp;</div></li><li><div>          <span class="comment">// after using the plugin for a week or so. Weird and not reproducible. But the problem is that</span>&nbsp;</div></li><li><div>          <span class="comment">// it would make it re-run through the upgrades below even though they need not be applied.</span>&nbsp;</div></li><li><div>          <span class="comment">// the ALTER TABLE statements would fail and product errors on the page.</span>&nbsp;</div></li><li><div>          <span class="comment">// Without solving the underlying problem, I'm going to have upgrade actions be skipped</span>&nbsp;</div></li><li><div>          <span class="comment">// in the case where no version is recorded in the DB.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ($this-&gt;isVersionLessThan($savedVersion, '2.8.29')) {&nbsp;</div></li><li><div>              if ($this-&gt;isVersionLessThan($savedVersion, '2.8.25')) {&nbsp;</div></li><li><div>                  if ($this-&gt;isVersionLessThan($savedVersion, '2.4.1')) {&nbsp;</div></li><li><div>                      if ($this-&gt;isVersionLessThan($savedVersion, '2.2')) {&nbsp;</div></li><li><div>                          if ($this-&gt;isVersionLessThan($savedVersion, '2.0')) {&nbsp;</div></li><li><div>                              if ($this-&gt;isVersionLessThan($savedVersion, '1.8')) {&nbsp;</div></li><li><div>                                  if ($this-&gt;isVersionLessThan($savedVersion, '1.4.5')) {&nbsp;</div></li><li><div>                                      if ($this-&gt;isVersionLessThan($savedVersion, '1.3.1')) {&nbsp;</div></li><li><div>                                          <span class="comment">// Version 1.3.1 update</span>&nbsp;</div></li><li><div>                                          $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>                                          $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>                                          $upgradeOk &= false !== $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD COLUMN `field_order` INTEGER&quot;);&nbsp;</div></li><li><div>                                          $upgradeOk &= false !== $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD COLUMN `file` LONGBLOB&quot;);&nbsp;</div></li><li><div>                                          $upgradeOk &= false !== $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `submit_time_idx` ( `submit_time` )&quot;);&nbsp;</div></li><li><div>                                          $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      <span class="comment">// Version 1.4.5 update</span>&nbsp;</div></li><li><div>                                      if (!$this-&gt;getOption('CanSeeSubmitDataViaShortcode')) {&nbsp;</div></li><li><div>                                          $this-&gt;addOption('CanSeeSubmitDataViaShortcode', 'Anyone');&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      <span class="comment">// Misc</span>&nbsp;</div></li><li><div>                                      $submitDateTimeFormat = $this-&gt;getOption('SubmitDateTimeFormat');&nbsp;</div></li><li><div>                                      if (!$submitDateTimeFormat || $submitDateTimeFormat == '') {&nbsp;</div></li><li><div>                                          $this-&gt;addOption('SubmitDateTimeFormat', 'Y-m-d H:i:s P');&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  <span class="comment">// Version 1.8 update</span>&nbsp;</div></li><li><div>                                  if (!$this-&gt;getOption('MaxRows')) {&nbsp;</div></li><li><div>                                      $this-&gt;addOption('MaxRows', '100');&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>                                  $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment"><span class="comment">/** $upgradeOk &= false !== */</span></span></span>&nbsp;</div></li><li><div>                                  $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` MODIFY COLUMN submit_time DECIMAL(16, 4) NOT NULL&quot;);&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment"><span class="comment">/** $upgradeOk &= false !== */</span></span></span>&nbsp;</div></li><li><div>                                  $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `form_name_idx` ( `form_name` )&quot;);&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment"><span class="comment">/** $upgradeOk &= false !== */</span></span></span>&nbsp;</div></li><li><div>                                  $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `form_name_field_name_idx` ( `form_name`, `field_name` )&quot;);&nbsp;</div></li><li><div>                                  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment">// Version 2.0 upgrade</span>&nbsp;</div></li><li><div>                              $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>                              $oldTableName = $this-&gt;prefixTableName('SUBMITS');&nbsp;</div></li><li><div>                              @$wpdb-&gt;query(&quot;RENAME TABLE `$oldTableName` TO `$tableName`&quot;);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// Version 2.2 upgrade</span>&nbsp;</div></li><li><div>                          $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>                          $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` DROP INDEX `form_name_field_name_idx`&quot;);&nbsp;</div></li><li><div>                          $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `field_name_idx` ( `field_name` )&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Version 2.4.1 upgrade</span>&nbsp;</div></li><li><div>                      $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>                      $oldTableName = strtolower($tableName);&nbsp;</div></li><li><div>                      $wpdb-&gt;query(&quot;RENAME TABLE '$oldTableName' TO '$tableName'&quot;);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment">// Version 2.8.25 update</span>&nbsp;</div></li><li><div>                  $tableName = $this-&gt;getSTTableName();&nbsp;</div></li><li><div>                  $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>                  $wpdb-&gt;query(&quot;CREATE TABLE IF NOT EXISTS `$tableName` (`submit_time` DECIMAL(16, 4) NOT NULL, PRIMARY KEY (submit_time))&quot;);&nbsp;</div></li><li><div>                  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Version 2.8.29 update</span>&nbsp;</div></li><li><div>              <span class="comment">// tyring this again b/c was not put into new installs</span>&nbsp;</div></li><li><div>              $tableName = $this-&gt;getSTTableName();&nbsp;</div></li><li><div>              $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>              $wpdb-&gt;query(&quot;CREATE TABLE IF NOT EXISTS `$tableName` (`submit_time` DECIMAL(16, 4) NOT NULL, PRIMARY KEY (submit_time))&quot;);&nbsp;</div></li><li><div>              $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Post-upgrade, set the current version in the options</span>&nbsp;</div></li><li><div>      $codeVersion = $this-&gt;getVersion();&nbsp;</div></li><li><div>      if ($upgradeOk && $codeVersion && $savedVersion != $codeVersion) {&nbsp;</div></li><li><div>          $this-&gt;saveInstalledVersion($codeVersion);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Called by install()</span>&nbsp;</div></li><li><div><span class="comment">   * You should: Prefix all table names with $wpdb-&gt;prefix</span>&nbsp;</div></li><li><div><span class="comment">   * Also good: additionally use the prefix for this plugin:</span>&nbsp;</div></li><li><div><span class="comment">   * $table_name = $wpdb-&gt;prefix . $this-&gt;prefix('MY_TABLE');</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function installDatabaseTables() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>      $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;CREATE TABLE IF NOT EXISTS `$tableName` (&nbsp;</div></li><li><div>          `submit_time` DECIMAL(16, 4) NOT NULL, &nbsp;</div></li><li><div>          `form_name` VARCHAR(127) CHARACTER SET utf8, &nbsp;</div></li><li><div>          `field_name` VARCHAR(127) CHARACTER SET utf8, &nbsp;</div></li><li><div>          `field_value` LONGTEXT CHARACTER SET utf8, &nbsp;</div></li><li><div>          `field_order` INTEGER, &nbsp;</div></li><li><div>          `file` LONGBLOB)&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `submit_time_idx` ( `submit_time` )&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `form_name_idx` ( `form_name` )&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE `$tableName` ADD INDEX `field_name_idx` ( `field_name` )&quot;);&nbsp;</div></li><li><div>      $tableName = $this-&gt;getSTTableName();&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;CREATE TABLE IF NOT EXISTS `$tableName` (`submit_time` DECIMAL(16, 4) NOT NULL, PRIMARY KEY (submit_time))&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Called by uninstall()</span>&nbsp;</div></li><li><div><span class="comment">   * You should: Prefix all table names with $wpdb-&gt;prefix</span>&nbsp;</div></li><li><div><span class="comment">   * Also good: additionally use the prefix for this plugin:</span>&nbsp;</div></li><li><div><span class="comment">   * $table_name = $wpdb-&gt;prefix . $this-&gt;prefix('MY_TABLE');</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function unInstallDatabaseTables() {&nbsp;</div></li><li><div>      if ('true' == $this-&gt;getOption('DropOnUninstall', 'false')) {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>          $wpdb-&gt;query(&quot;DROP TABLE IF EXISTS `$tableName`&quot;);&nbsp;</div></li><li><div>          <span class="comment">//        $tables = array('SUBMITS');</span>&nbsp;</div></li><li><div>          <span class="comment">//        foreach ($tables as $aTable) {</span>&nbsp;</div></li><li><div>          <span class="comment">//            $tableName = $this-&gt;prefixTableName($aTable);</span>&nbsp;</div></li><li><div>          <span class="comment">//            $wpdb-&gt;query(&quot;DROP TABLE IF EXISTS `$tableName`&quot;);</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//        }</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function initOptions() {&nbsp;</div></li><li><div>      <span class="comment">// By default ignore CF7 metadata fields</span>&nbsp;</div></li><li><div>      $this-&gt;addOption('NoSaveFields', '/.*wpcf7.*/, _wpnonce');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_wpcf7_noSaveFields() {&nbsp;</div></li><li><div>      $nsfArray = explode(', ', $this-&gt;getOption('NoSaveFields', ''));&nbsp;</div></li><li><div>      $wpcf7Fields = array('/.*wpcf7.*/', '_wpnonce');&nbsp;</div></li><li><div>      foreach ($wpcf7Fields as $aWpcf7) {&nbsp;</div></li><li><div>         if (!in_array($aWpcf7, $nsfArray)) {&nbsp;</div></li><li><div>             $nsfArray[] = $aWpcf7;&nbsp;</div></li><li><div>         }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;updateOption('NoSaveFields', implode(', ', $nsfArray));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function delete_wpcf7_fields($formName) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $wpdb-&gt;query($wpdb-&gt;prepare(&nbsp;</div></li><li><div>          'delete from `' . $this-&gt;getSubmitsTableName() .&nbsp;</div></li><li><div>                  &quot;` where `form_name` = '%s' and `field_name` in ('_wpcf7', '_wpcf7_version', '_wpcf7_unit_tag', '_wpnonce', '_wpcf7_is_ajax_call', '_wpcf7_captcha_challenge_captcha')&quot;, &nbsp;</div></li><li><div>          $formName));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function addActionsAndFilters() {&nbsp;</div></li><li><div>      <span class="comment">// Admin notices</span>&nbsp;</div></li><li><div>      add_action('admin_notices', array(&$this, 'addAdminNotices'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the Admin Config page for this plugin</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add Config page as a top-level menu item on the Admin page</span>&nbsp;</div></li><li><div>      add_action('admin_menu', array(&$this, 'createAdminMenu'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add Database Options page</span>&nbsp;</div></li><li><div>      add_action('admin_menu', array(&$this, 'addSettingsSubMenuPage'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook into Contact Form 7 when a form post is made to save the data to the DB</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithCF7', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationContactForm7.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationContactForm7($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook into Fast Secure Contact Form</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithFSCF', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationFSCF.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationFSCF($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook into JetPack Contact Form</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithJetPackContactForm', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationJetPack.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationJetPack($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook into Gravity Forms</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithGravityForms', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationGravityForms.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationGravityForms($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook to work with WR ContactForms</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithWrContactForms', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationWRContactForm.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationWRContactForm($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook to work with Quform</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithQuform', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationQuform.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationQuform($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook to work with Ninja Forms</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithNinjaForms', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationNinjaForms.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationNinjaForms($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook to work with Caldera Forms Forms</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithCalderaForms', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationCalderaForms.php');&nbsp;</div></li><li><div>          $integration = new CFDBIntegrationCalderaForms($this);&nbsp;</div></li><li><div>          $integration-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Enfold theme forms</span>&nbsp;</div></li><li><div>      if ($this-&gt;getOption('IntegrateWithEnfoldThemForms', 'true') == 'true') {&nbsp;</div></li><li><div>          require_once('CFDBIntegrationEnfoldTheme.php');&nbsp;</div></li><li><div>          $enfold = new CFDBIntegrationEnfoldTheme($this);&nbsp;</div></li><li><div>          $enfold-&gt;registerHooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Have our own hook to receive form submissions independent of other plugins</span>&nbsp;</div></li><li><div>      add_action('cfdb_submit', array(&$this, 'saveFormData'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register Export URL</span>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-export', array(&$this, 'ajaxExport'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-export', array(&$this, 'ajaxExport'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register Get File URL</span>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-file', array(&$this, 'ajaxFile'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-file', array(&$this, 'ajaxFile'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register Get Form Fields URL</span>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-getFormFields', array(&$this, 'ajaxGetFormFields'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-getFormFields', array(&$this, 'ajaxGetFormFields'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register Validate submit_time value (used in short code builder page)</span>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-validate-submit_time', array(&$this, 'ajaxValidateSubmitTime'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-validate-submit_time', array(&$this, 'ajaxValidateSubmitTime'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Login via Ajax instead of login form</span>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-login', array(&$this, 'ajaxLogin'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-login', array(&$this, 'ajaxLogin'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('wp_ajax_nopriv_cfdb-cleanup', array(&$this, 'ajaxCleanup'));&nbsp;</div></li><li><div>      add_action('wp_ajax_cfdb-cleanup', array(&$this, 'ajaxCleanup'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add a table to a page</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeTable();&nbsp;</div></li><li><div>      $sc-&gt;register(array('cf7db-table', 'cfdb-table')); <span class="comment">// cf7db-table is deprecated</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add a DataTable</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeDataTable();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-datatable');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add a JSON to a page</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeJson();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-json');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add a value (just text) to a page</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeValue();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-value');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add entry count to a page</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeCount();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-count');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to add values wrapped in user-defined html</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeHtml();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-html');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to generate Export URLs</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortcodeExportUrl();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-export-link');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to save data from non-CF7/FSCF forms</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortCodeSavePostData();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-save-form-post');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Shortcode to save data Form Maker submissions</span>&nbsp;</div></li><li><div>      $sc = new CFDBShortCodeSaveFormMakerSubmission();&nbsp;</div></li><li><div>      $sc-&gt;register('cfdb-save-form-maker-post');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxLogin() {&nbsp;</div></li><li><div>      <span class="comment">// Login the user</span>&nbsp;</div></li><li><div>      $key = 'kx82XcPjq8q8S!xafx%$&7p6';&nbsp;</div></li><li><div>      $creds = array();&nbsp;</div></li><li><div>      $user = null;&nbsp;</div></li><li><div>      $password = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($_REQUEST['l'])) {&nbsp;</div></li><li><div>          $userPass = CFDBDeobfuscate::deobfuscateHexString($_REQUEST['l'], $key);&nbsp;</div></li><li><div>          $userPass = explode('/', $userPass, 2);&nbsp;</div></li><li><div>          $count = count($userPass);&nbsp;</div></li><li><div>          if ($count &gt;= 1) {&nbsp;</div></li><li><div>              $user = $userPass[0];&nbsp;</div></li><li><div>              if ($count &gt; 1) {&nbsp;</div></li><li><div>                  $password = $userPass[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$user) {&nbsp;</div></li><li><div>          $user = !empty($_REQUEST['username']) ? $_REQUEST['username'] : null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$user) {&nbsp;</div></li><li><div>          $user = !empty($_REQUEST['user_login']) ? $_REQUEST['user_login'] : null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$password) {&nbsp;</div></li><li><div>          $password = !empty($_REQUEST['password']) ? $_REQUEST['password'] : null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$password) {&nbsp;</div></li><li><div>          $password = !empty($_REQUEST['user_password']) ? $_REQUEST['user_password'] : null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $creds['user_login'] = $user;&nbsp;</div></li><li><div>      $creds['user_password'] = $password;&nbsp;</div></li><li><div>      $creds['remember'] = !empty($_REQUEST['rememberme']) ? $_REQUEST['rememberme'] : null;&nbsp;</div></li><li><div>      $user = wp_signon($creds, false);&nbsp;</div></li><li><div>      if (is_wp_error($user)) {&nbsp;</div></li><li><div>          echo $user-&gt;get_error_message();&nbsp;</div></li><li><div>          die;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_set_current_user($user-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User is logged in. Now do the requested action</span>&nbsp;</div></li><li><div>      if (!empty($_REQUEST['cfdb-action'])) {&nbsp;</div></li><li><div>          switch ($_REQUEST['cfdb-action']) {&nbsp;</div></li><li><div>              case 'cfdb-export':&nbsp;</div></li><li><div>                  if (!$this-&gt;canUserDoRoleOption('CanSeeSubmitData')) {&nbsp;</div></li><li><div>                      echo '&lt;strong&gt;ERROR&lt;/strong&gt;: user ' . $creds['user_login'] . ' is not authorized to export CFDB data';&nbsp;</div></li><li><div>                      die;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $this-&gt;ajaxExport();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxExport() {&nbsp;</div></li><li><div>      require_once('CF7DBPluginExporter.php');&nbsp;</div></li><li><div>      CF7DBPluginExporter::doExportFromPost();&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxFile() {&nbsp;</div></li><li><div>      require_once('CFDBDie.php');&nbsp;</div></li><li><div>      if (!$this-&gt;canUserDoRoleOption('CanSeeSubmitData') &&&nbsp;</div></li><li><div>          !$this-&gt;canUserDoRoleOption('CanSeeSubmitDataViaShortcode')) {&nbsp;</div></li><li><div>          CFDBDie::wp_die(__('You do not have sufficient permissions to access this page.', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $submitTime = $_REQUEST['s'];&nbsp;</div></li><li><div>      $formName = $_REQUEST['form'];&nbsp;</div></li><li><div>      $fieldName = $_REQUEST['field'];&nbsp;</div></li><li><div>      if (!$submitTime || !$formName || !$fieldName) {&nbsp;</div></li><li><div>          CFDBDie::wp_die(__('Missing form parameters', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $fileInfo = (array)$this-&gt;getFileFromDB($submitTime, $formName, $fieldName);&nbsp;</div></li><li><div>      if ($fileInfo == null) {&nbsp;</div></li><li><div>          CFDBDie::wp_die(__('No such file.', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once('CFDBMimeTypeExtensions.php');&nbsp;</div></li><li><div>      $mimeMap = new CFDBMimeTypeExtensions();&nbsp;</div></li><li><div>      $mimeType = $mimeMap-&gt;get_type_by_filename($fileInfo[0]);&nbsp;</div></li><li><div>      if ($mimeType) {&nbsp;</div></li><li><div>          header('Content-Type: ' . $mimeType);&nbsp;</div></li><li><div>          header(&quot;Content-Disposition: inline; filename=\&quot;$fileInfo[0]\&quot;&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          header(&quot;Content-Disposition: attachment; filename=\&quot;$fileInfo[0]\&quot;&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo($fileInfo[1]);&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxGetFormFields() {&nbsp;</div></li><li><div>      if (!$this-&gt;canUserDoRoleOption('CanSeeSubmitData') || !isset($_REQUEST['form'])) {&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      header('Content-Type: application/json; charset=UTF-8');&nbsp;</div></li><li><div>      header(&quot;Pragma: no-cache&quot;);&nbsp;</div></li><li><div>      header(&quot;Expires: Thu, 01 Jan 1970 00:00:00 GMT&quot;);&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>      $formName = $_REQUEST['form'];&nbsp;</div></li><li><div>      $rows = $wpdb-&gt;get_results(&quot;SELECT DISTINCT `field_name` FROM `$tableName` WHERE `form_name` = '$formName' ORDER BY field_order&quot;);&nbsp;</div></li><li><div>      $fields = array();&nbsp;</div></li><li><div>      if (!empty($rows)) {&nbsp;</div></li><li><div>          $fields[] = 'Submitted';&nbsp;</div></li><li><div>          foreach ($rows as $aRow) {&nbsp;</div></li><li><div>              $fields[] = $aRow-&gt;field_name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $fields[] = 'submit_time';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo json_encode($fields);&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxValidateSubmitTime() {&nbsp;</div></li><li><div>      header('Content-Type: text/plain; charset=UTF-8');&nbsp;</div></li><li><div>      header(&quot;Pragma: no-cache&quot;);&nbsp;</div></li><li><div>      header(&quot;Expires: Thu, 01 Jan 1970 00:00:00 GMT&quot;);&nbsp;</div></li><li><div>      $submitTime = $_REQUEST['submit_time'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $invalid = false;&nbsp;</div></li><li><div>      $time = $submitTime;&nbsp;</div></li><li><div>      if (!is_numeric($submitTime)) {&nbsp;</div></li><li><div>          if (version_compare(phpversion(), '5.1.0') == -1) {&nbsp;</div></li><li><div>              $invalid = -1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;setTimezone();&nbsp;</div></li><li><div>          $time = strtotime($submitTime);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($invalid === $time) {&nbsp;</div></li><li><div>          echo htmlspecialchars(__('Invalid: ', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          echo htmlspecialchars(__('Valid: ', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;'$submitTime' = $time&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($invalid !== $time) {&nbsp;</div></li><li><div>          echo &quot; = &quot; . $this-&gt;formatDate($time);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ajaxCleanup() {&nbsp;</div></li><li><div>      if (!$this-&gt;canUserDoRoleOption('CanChangeSubmitData')) {&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      header('Content-Type: text/plain; charset=UTF-8');&nbsp;</div></li><li><div>      header(&quot;Pragma: no-cache&quot;);&nbsp;</div></li><li><div>      header(&quot;Expires: Thu, 01 Jan 1970 00:00:00 GMT&quot;);&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Checking for conflicting entries. This may take a few minutes.', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      echo &quot;\n&quot;;&nbsp;</div></li><li><div>      require_once('CFDBCleanupData.php');&nbsp;</div></li><li><div>      $cleanup = new CFDBCleanupData($this);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Phase 1 of 3...', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      $count = $cleanup-&gt;cleanupForms();&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Database entries fixed: ', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      echo ($count);&nbsp;</div></li><li><div>      echo &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Phase 2 of 3...', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      $count = $cleanup-&gt;deleteEmptyEntries();&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Database entries fixed: ', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      echo ($count);&nbsp;</div></li><li><div>      echo &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Phase 3 of 3...', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      $count = $cleanup-&gt;cleanupEntries();&nbsp;</div></li><li><div>      echo htmlspecialchars(__('Database entries fixed: ', 'contact-form-7-to-database-extension'));&nbsp;</div></li><li><div>      echo ($count);&nbsp;</div></li><li><div>      echo &quot;\n&quot;;&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function addSettingsSubMenuPage() {&nbsp;</div></li><li><div><span class="comment">//        $this-&gt;requireExtraPluginFiles();</span>&nbsp;</div></li><li><div><span class="comment">//        $displayName = $this-&gt;getPluginDisplayName();</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//        add_submenu_page('wpcf7', </span></span><span class="comment">//$this-&gt;getDBPageSlug(), </span></span>&nbsp;</div></li><li><div><span class="comment">//                         $displayName . ' Options', </span>&nbsp;</div></li><li><div><span class="comment">//                         __('Database Options', 'contact-form-7-to-database-extension'), </span>&nbsp;</div></li><li><div><span class="comment">//                         'manage_options', </span>&nbsp;</div></li><li><div><span class="comment">//                         get_class($this) . 'Settings', </span>&nbsp;</div></li><li><div><span class="comment">//                         array(&$this, 'settingsPage'));</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function generateSubmitTime() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $table = $this-&gt;getSTTableName();&nbsp;</div></li><li><div>      $time = 0;&nbsp;</div></li><li><div>      $noDuplicate = false;&nbsp;</div></li><li><div>      $tries = 0;&nbsp;</div></li><li><div>      $wpdb-&gt;hide_errors(); <span class="comment">// avoid submission page from hanging on DB error like table not exists</span>&nbsp;</div></li><li><div>      while (!$noDuplicate && ++$tries &lt;= 20) {&nbsp;</div></li><li><div>          <span class="comment">// $tries breaks out of loop which would be infinite when table to insert into does not exist</span>&nbsp;</div></li><li><div>          $time = function_exists('microtime') ? microtime(true) : time();&nbsp;</div></li><li><div>          <span class="comment">// Bug fix: on some systems microtime is in scientific notation when converted to string</span>&nbsp;</div></li><li><div>          $time = number_format($time, 4, '.', '');&nbsp;</div></li><li><div>          <span class="comment">// Avoid duplicate submission with the same submit_time in the DB</span>&nbsp;</div></li><li><div>          $noDuplicate = $wpdb-&gt;query($wpdb-&gt;prepare(&quot;INSERT INTO $table VALUES (%s)&quot;, $time));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $time;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Callback for saving form data. Originally based on Contact Form 7's callback object</span>&nbsp;</div></li><li><div><span class="comment">   * with submission data in $cf7-&gt;posted_data. However that has changed over time.</span>&nbsp;</div></li><li><div><span class="comment">   * FSCF sends an object matching this data structure. Other form plugins have their data</span>&nbsp;</div></li><li><div><span class="comment">   * transformed into the expected data structure via other callbacks in this class</span>&nbsp;</div></li><li><div><span class="comment">   * @param $cf7 object containing posted data</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function saveFormData($cf7) {&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          if (!empty($cf7-&gt;posted_data['submit_time']) && is_numeric($cf7-&gt;posted_data['submit_time'])) {&nbsp;</div></li><li><div>              $time = $cf7-&gt;posted_data['submit_time'];&nbsp;</div></li><li><div>              unset($cf7-&gt;posted_data['submit_time']);&nbsp;</div></li><li><div>              unset($cf7-&gt;posted_data['submit_url']);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $time = $this-&gt;generateSubmitTime();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $cf7-&gt;submit_time = $time;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ip = (isset($_SERVER['X_FORWARDED_FOR'])) ? $_SERVER['X_FORWARDED_FOR'] : $_SERVER['REMOTE_ADDR'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set up to allow all this data to be filtered</span>&nbsp;</div></li><li><div>          $cf7-&gt;ip = $ip;&nbsp;</div></li><li><div>          $user = null;&nbsp;</div></li><li><div>          if (function_exists('is_user_logged_in') && is_user_logged_in()) {&nbsp;</div></li><li><div>              $current_user = wp_get_current_user(); <span class="comment">// WP_User</span>&nbsp;</div></li><li><div>              $user = $current_user-&gt;user_login;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $cf7-&gt;user = $user;&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $newCf7 = apply_filters('cfdb_form_data', $cf7);&nbsp;</div></li><li><div>              if ($newCf7 && is_object($newCf7)) {&nbsp;</div></li><li><div>                  $cf7 = $newCf7;&nbsp;</div></li><li><div>                  $time = $cf7-&gt;submit_time;&nbsp;</div></li><li><div>                  $ip = $cf7-&gt;ip;&nbsp;</div></li><li><div>                  $user = $cf7-&gt;user;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else {&nbsp;</div></li><li><div>                  <span class="comment">//$this-&gt;getErrorLog()-&gt;log('CFDB Error: No or invalid value returned from &quot;cfdb_form_data&quot; filter: ' .</span>&nbsp;</div></li><li><div>                  <span class="comment">//        print_r($newCf7, true));</span>&nbsp;</div></li><li><div>                  <span class="comment">// Returning null from cfdb_form_data is a way to stop from saving the form</span>&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          catch (Exception $ex) {&nbsp;</div></li><li><div>              $this-&gt;getErrorLog()-&gt;logException($ex);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get title after applying filter</span>&nbsp;</div></li><li><div>          if (isset($cf7-&gt;title)) {&nbsp;</div></li><li><div>              $title = $cf7-&gt;title;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $title = 'Unknown';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $title = stripslashes($title);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;fieldMatches($title, $this-&gt;getNoSaveForms())) {&nbsp;</div></li><li><div>              return true; <span class="comment"><span class="comment">// Don't save in DB</span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>          $parametrizedQuery = &quot;INSERT INTO `$tableName` (`submit_time`, `form_name`, `field_name`, `field_value`, `field_order`) VALUES (%s, %s, %s, %s, %s)&quot;;&nbsp;</div></li><li><div>          $parametrizedFileQuery = &quot;INSERT INTO `$tableName` (`submit_time`, `form_name`, `field_name`, `field_value`, `field_order`, `file`) VALUES (%s, %s, %s, %s, %s, %s)&quot;;&nbsp;</div></li><li><div>          $order = 0;&nbsp;</div></li><li><div>          $noSaveFields = $this-&gt;getNoSaveFields();&nbsp;</div></li><li><div>          $foundUploadFiles = array();&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//            $hasDropBox = $this-&gt;getOption('dropbox');</span>&nbsp;</div></li><li><div><span class="comment">//            if ($hasDropBox) {</span>&nbsp;</div></li><li><div><span class="comment">//                require_once('CFDBShortCodeSavePostData.php');</span>&nbsp;</div></li><li><div><span class="comment">//            }</span>&nbsp;</div></li><li><div>          foreach ($cf7-&gt;posted_data as $name =&gt; $value) {&nbsp;</div></li><li><div>              $nameClean = stripslashes($name);&nbsp;</div></li><li><div>              if ($this-&gt;fieldMatches($nameClean, $noSaveFields)) {&nbsp;</div></li><li><div>                  continue; <span class="comment"><span class="comment">// Don't save in DB</span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $value = is_array($value) ? implode($value, ', ') : $value;&nbsp;</div></li><li><div>              $valueClean = stripslashes($value);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Check if this is a file upload field</span>&nbsp;</div></li><li><div>              $didSaveFile = false;&nbsp;</div></li><li><div>              if ($cf7-&gt;uploaded_files && isset($cf7-&gt;uploaded_files[$nameClean])) {&nbsp;</div></li><li><div>                  $foundUploadFiles[] = $nameClean;&nbsp;</div></li><li><div>                  $filePath = $cf7-&gt;uploaded_files[$nameClean];&nbsp;</div></li><li><div>                  if ($filePath) {&nbsp;</div></li><li><div>                      $content = file_get_contents($filePath);&nbsp;</div></li><li><div>                      $didSaveFile = $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedFileQuery, &nbsp;</div></li><li><div>                          $time, &nbsp;</div></li><li><div>                          $title, &nbsp;</div></li><li><div>                          $nameClean, &nbsp;</div></li><li><div>                          $valueClean, &nbsp;</div></li><li><div>                          $order++, &nbsp;</div></li><li><div>                          $content));&nbsp;</div></li><li><div>                      if (!$didSaveFile) {&nbsp;</div></li><li><div>                          $this-&gt;getErrorLog()-&gt;log(&quot;CFDB Error: could not save uploaded file, field=$nameClean, file=$filePath&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!$didSaveFile) {&nbsp;</div></li><li><div>                  $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedQuery, &nbsp;</div></li><li><div>                      $time, &nbsp;</div></li><li><div>                      $title, &nbsp;</div></li><li><div>                      $nameClean, &nbsp;</div></li><li><div>                      $valueClean, &nbsp;</div></li><li><div>                      $order++));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Since Contact Form 7 version 3.1, it no longer puts the names of the files in $cf7-&gt;posted_data</span>&nbsp;</div></li><li><div>          <span class="comment">// So check for them only only in $cf7-&gt;uploaded_files</span>&nbsp;</div></li><li><div>          <span class="comment">// Update: This seems to have been reversed back to the original in Contact Form 7 3.2 or 3.3</span>&nbsp;</div></li><li><div>          if ($cf7-&gt;uploaded_files && is_array($cf7-&gt;uploaded_files)) {&nbsp;</div></li><li><div>              foreach ($cf7-&gt;uploaded_files as $field =&gt; $filePath) {&nbsp;</div></li><li><div>                  if (!in_array($field, $foundUploadFiles) &&&nbsp;</div></li><li><div>                          $filePath &&&nbsp;</div></li><li><div>                          !$this-&gt;fieldMatches($field, $noSaveFields)) {&nbsp;</div></li><li><div>                      $fileName = basename($filePath);&nbsp;</div></li><li><div>                      $content = file_get_contents($filePath);&nbsp;</div></li><li><div>                      $didSaveFile = $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedFileQuery, &nbsp;</div></li><li><div>                          $time, &nbsp;</div></li><li><div>                          $title, &nbsp;</div></li><li><div>                          $field, &nbsp;</div></li><li><div>                          $fileName, &nbsp;</div></li><li><div>                          $order++, &nbsp;</div></li><li><div>                          $content));&nbsp;</div></li><li><div>                      if (!$didSaveFile) {&nbsp;</div></li><li><div>                          $this-&gt;getErrorLog()-&gt;log(&quot;CFDB Error: could not save uploaded file, field=$field, file=$filePath&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Save Cookie data if that option is true</span>&nbsp;</div></li><li><div>          if ($this-&gt;getOption('SaveCookieData', 'false') == 'true' && is_array($_COOKIE)) {&nbsp;</div></li><li><div>              $saveCookies = $this-&gt;getSaveCookies();&nbsp;</div></li><li><div>              foreach ($_COOKIE as $cookieName =&gt; $cookieValue) {&nbsp;</div></li><li><div>                  if (empty($saveCookies) || $this-&gt;fieldMatches($cookieName, $saveCookies)) {&nbsp;</div></li><li><div>                      $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedQuery, &nbsp;</div></li><li><div>                          $time, &nbsp;</div></li><li><div>                          $title, &nbsp;</div></li><li><div>                          'Cookie ' . $cookieName, &nbsp;</div></li><li><div>                          $cookieValue, &nbsp;</div></li><li><div>                          $order++));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If the submitter is logged in, capture his id</span>&nbsp;</div></li><li><div>          if ($user) {&nbsp;</div></li><li><div>              $order = ($order &lt; 9999) ? 9999 : $order + 1; <span class="comment">// large order num to try to make it always next-to-last</span>&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedQuery, &nbsp;</div></li><li><div>                                          $time, &nbsp;</div></li><li><div>                                          $title, &nbsp;</div></li><li><div>                                          'Submitted Login', &nbsp;</div></li><li><div>                                          $user, &nbsp;</div></li><li><div>                                          $order));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Capture the IP Address of the submitter</span>&nbsp;</div></li><li><div>          $order = ($order &lt; 10000) ? 10000 : $order + 1; <span class="comment">// large order num to try to make it always last</span>&nbsp;</div></li><li><div>          $wpdb-&gt;query($wpdb-&gt;prepare($parametrizedQuery, &nbsp;</div></li><li><div>                                      $time, &nbsp;</div></li><li><div>                                      $title, &nbsp;</div></li><li><div>                                      'Submitted From', &nbsp;</div></li><li><div>                                      $ip, &nbsp;</div></li><li><div>                                      $order));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      catch (Exception $ex) {&nbsp;</div></li><li><div>          $this-&gt;getErrorLog()-&gt;logException($ex);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Indicate success to WordPress so it continues processing other unrelated hooks.</span>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param $fieldName string</span>&nbsp;</div></li><li><div><span class="comment">   * @param $patternsArray array</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true if $fieldName is in $patternsArray or matches any element of it that is a regex</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function fieldMatches($fieldName, $patternsArray) {&nbsp;</div></li><li><div>      if (is_array($patternsArray)) {&nbsp;</div></li><li><div>          foreach($patternsArray as $pattern) {&nbsp;</div></li><li><div>              if ($fieldName == $pattern) {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (strncmp($pattern, '/', 1) == 0) {&nbsp;</div></li><li><div>                  if (@preg_match($pattern , $fieldName)) {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $time string form submit time</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $formName string form name</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $fieldName string field name (should be an upload file field)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of (file-name, file-contents) or null if not found</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getFileFromDB($time, $formName, $fieldName) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>      $parametrizedQuery = &quot;SELECT `field_value`, `file` FROM `$tableName` WHERE `submit_time` = %F AND `form_name` = %s AND `field_name` = '%s'&quot;;&nbsp;</div></li><li><div>      $rows = $wpdb-&gt;get_results($wpdb-&gt;prepare($parametrizedQuery, $time, $formName, $fieldName));&nbsp;</div></li><li><div>      if ($rows == null || count($rows) == 0) {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array($rows[0]-&gt;field_value, $rows[0]-&gt;file);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Install page for this plugin in WP Admin</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function createAdminMenu() {&nbsp;</div></li><li><div>      $roleAllowed = 'Administrator';&nbsp;</div></li><li><div>      $displayName = $this-&gt;getPluginDisplayName();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hideFromNonAdmins = $this-&gt;getOption('HideAdminPanelFromNonAdmins', 'false') != 'false';&nbsp;</div></li><li><div>      if ($hideFromNonAdmins) {&nbsp;</div></li><li><div>          $roleAllowed = 'Administrator';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $roleAllowed = $this-&gt;getRoleOption('CanSeeSubmitData');&nbsp;</div></li><li><div>          if (!$roleAllowed) {&nbsp;</div></li><li><div>              $roleAllowed = 'Administrator';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (! $this-&gt;isUserRoleEqualOrBetterThan($roleAllowed)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $menuSlug = $this-&gt;getDBPageSlug();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//create new top-level menu</span>&nbsp;</div></li><li><div>      add_menu_page($displayName, &nbsp;</div></li><li><div>                      __('Contact Form DB', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                    $this-&gt;roleToCapability($roleAllowed), &nbsp;</div></li><li><div>                    $menuSlug, <span class="comment">//$this-&gt;getDBPageSlug(), </span>&nbsp;</div></li><li><div>                    array(&$this, 'whatsInTheDBPage'), &nbsp;</div></li><li><div>                    $this-&gt;getPluginFileUrl('img/icon-bw-20x20.png'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Needed for dialog in whatsInTheDBPage</span>&nbsp;</div></li><li><div>      if (strpos($_SERVER['REQUEST_URI'], $this-&gt;getDBPageSlug()) !== false) {&nbsp;</div></li><li><div>          $pluginUrl = $this-&gt;getPluginFileUrl() . '/';&nbsp;</div></li><li><div>          wp_enqueue_script('jquery');&nbsp;</div></li><li><div>          wp_enqueue_script('jquery-ui-core');&nbsp;</div></li><li><div>          wp_enqueue_script('jquery-ui-dialog');&nbsp;</div></li><li><div>          wp_enqueue_script('CF7DBdes', $pluginUrl . 'des.js');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_style('jquery-ui.css', $pluginUrl . 'jquery-ui/jquery-ui-1.8.21.custom.css');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Datatables http://www.datatables.net</span>&nbsp;</div></li><li><div>          if ($this-&gt;getOption('UseDataTablesJS', 'true') == 'true') {&nbsp;</div></li><li><div><span class="comment">//                wp_enqueue_style('datatables-demo', 'http://www.datatables.net/release-datatables/media/css/demo_table.css');</span>&nbsp;</div></li><li><div><span class="comment">//                wp_enqueue_script('datatables', 'http://www.datatables.net/release-datatables/media/js/jquery.dataTables.js', array('jquery'));</span>&nbsp;</div></li><li><div>              wp_enqueue_style('datatables-demo', $pluginUrl .'DataTables/media/css/demo_table.css');&nbsp;</div></li><li><div>              wp_enqueue_script('datatables', $pluginUrl . 'DataTables/media/js/jquery.dataTables.min.js', array('jquery'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;canUserDoRoleOption('CanChangeSubmitData')) {&nbsp;</div></li><li><div>                  do_action_ref_array('cfdb_edit_enqueue', array());&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Would like to add ColReorder but it causes slowness and display issues with DataTable footer</span>&nbsp;</div></li><li><div>              <span class="comment">//wp_enqueue_style('datatables-ColReorder', $pluginUrl .'DataTables/extras/ColReorder/media/css/ColReorder.css');</span>&nbsp;</div></li><li><div>              <span class="comment">//wp_enqueue_script('datatables-ColReorder', $pluginUrl . 'DataTables/extras/ColReorder/media/js/ColReorder.min.js', array('datatables', 'jquery'));</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (strpos($_SERVER['REQUEST_URI'], $this-&gt;getShortCodeBuilderPageSlug()) !== false) {&nbsp;</div></li><li><div>          wp_enqueue_script('jquery');&nbsp;</div></li><li><div>          $pluginUrl = $this-&gt;getPluginFileUrl() . '/';&nbsp;</div></li><li><div>          wp_enqueue_script('CF7DBdes', $pluginUrl . 'des.js');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        // Put page under CF7's &quot;Contact&quot; page</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        add_submenu_page('wpcf7', </span></span>&nbsp;</div></li><li><div><span class="comment">//                         $displayName . ' Submissions', </span>&nbsp;</div></li><li><div><span class="comment">//                         __('Database', 'contact-form-7-to-database-extension'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                         $this-&gt;roleToCapability($roleAllowed), </span></span>&nbsp;</div></li><li><div><span class="comment">//                         $this-&gt;getDBPageSlug(), </span>&nbsp;</div></li><li><div><span class="comment">//                         array(&$this, 'whatsInTheDBPage'));</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_submenu_page($menuSlug, &nbsp;</div></li><li><div>                       $displayName . ' Short Code Builder', &nbsp;</div></li><li><div>                       __('Short Code', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                       $this-&gt;roleToCapability($roleAllowed), &nbsp;</div></li><li><div>                       $this-&gt;getShortCodeBuilderPageSlug(), &nbsp;</div></li><li><div>                       array(&$this, 'showShortCodeBuilderPage'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;isEditorActive() && $this-&gt;canUserDoRoleOption('CanSeeSubmitData')) {&nbsp;</div></li><li><div>          add_submenu_page($menuSlug, &nbsp;</div></li><li><div>                  $displayName . ' Import', &nbsp;</div></li><li><div>              __('Import', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>              $this-&gt;roleToCapability($this-&gt;getRoleOption('CanChangeSubmitData')), &nbsp;</div></li><li><div>                  get_class($this) . 'Import', &nbsp;</div></li><li><div>              array(&$this, 'showShortImportCsvPage'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_submenu_page($menuSlug, &nbsp;</div></li><li><div>                       $displayName . ' Options', &nbsp;</div></li><li><div>                       __('Options', 'contact-form-7-to-database-extension'), &nbsp;</div></li><li><div>                       'manage_options', &nbsp;</div></li><li><div>                       get_class($this) . 'Settings', &nbsp;</div></li><li><div>                       array(&$this, 'settingsPage'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        // Put page under CF7's &quot;Contact&quot; page</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//        add_submenu_page('wpcf7', </span></span>&nbsp;</div></li><li><div><span class="comment">//                         $displayName . ' Short Code Builder', </span>&nbsp;</div></li><li><div><span class="comment">//                         __('Database Short Code', 'contact-form-7-to-database-extension'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                         $this-&gt;roleToCapability($roleAllowed), </span></span>&nbsp;</div></li><li><div><span class="comment">//                         $this-&gt;getSortCodeBuilderPageSlug(), </span>&nbsp;</div></li><li><div><span class="comment">//                         array(&$this, 'showShortCodeBuilderPage'));</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return string WP Admin slug for page to view DB data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getDBPageSlug() {&nbsp;</div></li><li><div>      return get_class($this) . 'Submissions';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getShortCodeBuilderPageSlug() {&nbsp;</div></li><li><div>      return get_class($this) . 'ShortCodeBuilder';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function showShortCodeBuilderPage() {&nbsp;</div></li><li><div>      require_once('CFDBViewShortCodeBuilder.php');&nbsp;</div></li><li><div>      $view = new CFDBViewShortCodeBuilder;&nbsp;</div></li><li><div>      $view-&gt;display($this);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function showShortImportCsvPage() {&nbsp;</div></li><li><div>      require_once('CFDBViewImportCsv.php');&nbsp;</div></li><li><div>      $view = new CFDBViewImportCsv;&nbsp;</div></li><li><div>      $view-&gt;display($this);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the Admin page for this Plugin that show the form data saved in the database</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function whatsInTheDBPage() {&nbsp;</div></li><li><div>      if (isset($_REQUEST['submit_time'])) {&nbsp;</div></li><li><div>          $submitTime = $_REQUEST['submit_time'];&nbsp;</div></li><li><div>          require_once('ExportEntry.php');&nbsp;</div></li><li><div>          $exp = new ExportEntry();&nbsp;</div></li><li><div>          if (isset($_REQUEST['form_name']) && !empty($_REQUEST['form_name'])) {&nbsp;</div></li><li><div>              $form = stripslashes($_REQUEST['form_name']);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              global $wpdb;&nbsp;</div></li><li><div>              $table = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>              $form = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT form_name from $table where submit_time = %s LIMIT 1&quot;, &nbsp;</div></li><li><div>                      $submitTime));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;form action=&quot;&lt;?php echo get_admin_url() . 'admin.php?page=' . $this-&gt;getDBPageSlug() . &quot;&form_name=&quot; . urlencode($form) ?&gt;&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;form_name&quot; type=&quot;hidden&quot; value=&quot;&lt;?php echo htmlspecialchars($form) ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;&lt;?php echo htmlspecialchars($submitTime) ?&gt;&quot; type=&quot;hidden&quot; value=&quot;row&quot;/&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field(); ?&gt;&nbsp;</div></li><li><div>              &lt;button id=&quot;delete&quot; name=&quot;delete&quot; onclick=&quot;this.form.submit();&quot;&gt;&lt;?php echo htmlspecialchars(__('Delete', 'contact-form-7-to-database-extension')); ?&gt;&lt;/button&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          $exp-&gt;export($form, array('submit_time' =&gt; $submitTime));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          require_once('CFDBViewWhatsInDB.php');&nbsp;</div></li><li><div>          $view = new CFDBViewWhatsInDB;&nbsp;</div></li><li><div>          $view-&gt;display($this);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static $checkForCustomDateFormat = true;&nbsp;</div></li><li><div>  static $customDateFormat = null;&nbsp;</div></li><li><div>  static $dateFormat = null;&nbsp;</div></li><li><div>  static $timeFormat = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Format input date string</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $time int same as returned from PHP time()</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted date according to saved options</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function formatDate($time) {&nbsp;</div></li><li><div>      <span class="comment">// This method gets executed in a loop. Cache some variable to avoid</span>&nbsp;</div></li><li><div>      <span class="comment">// repeated get_option calls to the database</span>&nbsp;</div></li><li><div>      if (CF7DBPlugin::$checkForCustomDateFormat) {&nbsp;</div></li><li><div>          if ($this-&gt;getOption('UseCustomDateTimeFormat', 'true') == 'true') {&nbsp;</div></li><li><div>              CF7DBPlugin::$customDateFormat = $this-&gt;getOption('SubmitDateTimeFormat', 'Y-m-d H:i:s P');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>             CF7DBPlugin::$dateFormat = get_option('date_format');&nbsp;</div></li><li><div>             CF7DBPlugin::$timeFormat = get_option('time_format');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;setTimezone();&nbsp;</div></li><li><div>          CF7DBPlugin::$checkForCustomDateFormat = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Support Shamsi(Jalali) dates by looking for a plugin that can produce the correct text for the date</span>&nbsp;</div></li><li><div>      if (!function_exists('is_plugin_active') && @file_exists(ABSPATH . 'wp-admin/includes/plugin.php')) {&nbsp;</div></li><li><div>          include_once(ABSPATH . 'wp-admin/includes/plugin.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (function_exists('is_plugin_active')) {&nbsp;</div></li><li><div>          <span class="comment">// See if wp-parsidate is active and if so, have it convert the date</span>&nbsp;</div></li><li><div>          <span class="comment">// using its 'parsidate' function</span>&nbsp;</div></li><li><div>          if (is_plugin_active('wp-parsidate/wp-parsidate.php')) {&nbsp;</div></li><li><div>              if (function_exists('parsidate')) {&nbsp;</div></li><li><div>                  if (CF7DBPlugin::$customDateFormat) {&nbsp;</div></li><li><div>                      return parsidate(CF7DBPlugin::$customDateFormat, $time);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  else {&nbsp;</div></li><li><div>                      return parsidate(CF7DBPlugin::$dateFormat . ' ' . CF7DBPlugin::$timeFormat, $time);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// See if wp-jalali is active and if so, have it convert the date</span>&nbsp;</div></li><li><div>          <span class="comment">// using its 'jdate' function</span>&nbsp;</div></li><li><div>          else if (is_plugin_active('wp-jalali/wp-jalali.php')) {&nbsp;</div></li><li><div>              $jDateFile = WP_PLUGIN_DIR . '/wp-jalali/inc/jalali-core.php';&nbsp;</div></li><li><div>              if(@file_exists($jDateFile)) {&nbsp;</div></li><li><div>                  include_once($jDateFile);&nbsp;</div></li><li><div>                  if (function_exists('jdate')) {&nbsp;</div></li><li><div>                      <span class="comment">//return jdate('l, F j, Y');</span>&nbsp;</div></li><li><div>                      if (CF7DBPlugin::$customDateFormat) {&nbsp;</div></li><li><div>                          return jdate(CF7DBPlugin::$customDateFormat, $time);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else {&nbsp;</div></li><li><div>                          return jdate(CF7DBPlugin::$dateFormat . ' ' . CF7DBPlugin::$timeFormat, $time);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (CF7DBPlugin::$customDateFormat) {&nbsp;</div></li><li><div>          return date(CF7DBPlugin::$customDateFormat, $time);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          return date_i18n(CF7DBPlugin::$dateFormat . ' ' . CF7DBPlugin::$timeFormat, $time);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $submitTime string PK for form submission</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $formName string</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $fieldName string</span>&nbsp;</div></li><li><div><span class="comment">   * @return string URL to download file</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getFileUrl($submitTime, $formName, $fieldName) {&nbsp;</div></li><li><div>      return sprintf('%s?action=cfdb-file&s=%s&form=%s&field=%s', &nbsp;</div></li><li><div>                     admin_url('admin-ajax.php'), &nbsp;</div></li><li><div>                     $submitTime, &nbsp;</div></li><li><div>                     urlencode($formName), &nbsp;</div></li><li><div>                     urlencode($fieldName));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getFormFieldsAjaxUrlBase() {&nbsp;</div></li><li><div>      return admin_url('admin-ajax.php') . '?action=cfdb-getFormFields&form=';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getValidateSubmitTimeAjaxUrlBase() {&nbsp;</div></li><li><div>      return admin_url('admin-ajax.php') . '?action=cfdb-validate-submit_time&submit_time=';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getNoSaveFields() {&nbsp;</div></li><li><div>      return preg_split('/, |;/', $this-&gt;getOption('NoSaveFields'), -1, PREG_SPLIT_NO_EMPTY);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getNoSaveForms() {&nbsp;</div></li><li><div>      return preg_split('/, |;/', $this-&gt;getOption('NoSaveForms'), -1, PREG_SPLIT_NO_EMPTY);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getSaveCookies() {&nbsp;</div></li><li><div>      return preg_split('/, |;/', $this-&gt;getOption('SaveCookieNames'), -1, PREG_SPLIT_NO_EMPTY);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getSubmitsTableName() {&nbsp;</div></li><li><div>      <span class="comment">//        $overrideTable = $this-&gt;getOption('SubmitTableNameOverride');</span>&nbsp;</div></li><li><div>      <span class="comment">//        if ($overrideTable && &quot;&quot; != $overrideTable) {</span>&nbsp;</div></li><li><div>      <span class="comment">//            return $overrideTable;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        }</span></span>&nbsp;</div></li><li><div>      <span class="comment">//return strtolower($this-&gt;prefixTableName('SUBMITS'));</span>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      return $wpdb-&gt;prefix . strtolower($this-&gt;prefix('SUBMITS'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getSTTableName() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      return $wpdb-&gt;prefix . strtolower($this-&gt;prefix('ST'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return string URL to the Plugin directory. Includes ending &quot;/&quot;</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getPluginDirUrl() {&nbsp;</div></li><li><div>      <span class="comment">//return WP_PLUGIN_URL . '/' . str_replace(basename(__FILE__), '', plugin_basename(__FILE__));</span>&nbsp;</div></li><li><div>      return $this-&gt;getPluginFileUrl('/');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $pathRelativeToThisPluginRoot points to a file with relative path from</span>&nbsp;</div></li><li><div><span class="comment">   * this plugin's root dir. I.e. file &quot;des.js&quot; in the root of this plugin has</span>&nbsp;</div></li><li><div><span class="comment">   * url = $this-&gt;getPluginFileUrl('des.js');</span>&nbsp;</div></li><li><div><span class="comment">   * If it was in a sub-folder &quot;js&quot; then you would use</span>&nbsp;</div></li><li><div><span class="comment">   *    $this-&gt;getPluginFileUrl('js/des.js');</span>&nbsp;</div></li><li><div><span class="comment">   * @return string full url to input file</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getPluginFileUrl($pathRelativeToThisPluginRoot = '') {&nbsp;</div></li><li><div>      return plugins_url($pathRelativeToThisPluginRoot, __FILE__);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return string URL of the language translation file for DataTables oLanguage.sUrl parameter</span>&nbsp;</div></li><li><div><span class="comment">   * or null if it does not exist.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getDataTableTranslationUrl() {&nbsp;</div></li><li><div>      $url = null;&nbsp;</div></li><li><div>      $locale = get_locale();&nbsp;</div></li><li><div>      $i18nDir = dirname(__FILE__) . '/dt_i18n/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// See if there is a local file</span>&nbsp;</div></li><li><div>      if (is_readable($i18nDir . $locale . '.json')) {&nbsp;</div></li><li><div>          $url = $this-&gt;getPluginFileUrl() . &quot;/dt_i18n/$locale.json&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          <span class="comment">// Pull the language code from the $local string</span>&nbsp;</div></li><li><div>          <span class="comment">// which is expected to look like &quot;en_US&quot;</span>&nbsp;</div></li><li><div>          <span class="comment">// where the first 2 or 3 letters are for lang followed by '_'</span>&nbsp;</div></li><li><div>          $lang = null;&nbsp;</div></li><li><div>          if (substr($locale, 2, 1) == '_') {&nbsp;</div></li><li><div>              <span class="comment">// 2-letter language codes</span>&nbsp;</div></li><li><div>              $lang = substr($locale, 0, 2);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else if (substr($locale, 3, 1) == '_') {&nbsp;</div></li><li><div>              <span class="comment">// 3-letter language codes</span>&nbsp;</div></li><li><div>              $lang = substr($locale, 0, 3);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($lang && is_readable($i18nDir . $lang . '.json')) {&nbsp;</div></li><li><div>              $url = $this-&gt;getPluginFileUrl() . &quot;/dt_i18n/$lang.json&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setTimezone() {&nbsp;</div></li><li><div>      $timezone = trim($this-&gt;getOption('Timezone'));&nbsp;</div></li><li><div>      if (empty($timezone)) {&nbsp;</div></li><li><div>          $timezone = get_option('timezone_string');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!empty($timezone)) {&nbsp;</div></li><li><div>          date_default_timezone_set($timezone);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean Is the CFDB Editor extension installed?</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function isEditorInstalled() {&nbsp;</div></li><li><div>      return get_option('CFDBEditPlugin__installed', false) == true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return string|null get the CFDB Editor extension version string.</span>&nbsp;</div></li><li><div><span class="comment">   * return null if not installed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getEditorSavedVersion() {&nbsp;</div></li><li><div>      return get_option('CFDBEditPlugin__version', null);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of CFDB Editor plugin data, see: http://codex.wordpress.org/Function_Reference/get_plugin_data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getEditorPluginData() {&nbsp;</div></li><li><div>          $editPluginFile = WP_PLUGIN_DIR .&nbsp;</div></li><li><div>                  '/contact-form-to-database-extension-edit/contact-form-to-database-extension-edit.php';&nbsp;</div></li><li><div>          if(@file_exists($editPluginFile)) {&nbsp;</div></li><li><div>              $pluginData = get_plugin_data($editPluginFile);&nbsp;</div></li><li><div>              if (is_array($pluginData)) {&nbsp;</div></li><li><div>                  return $pluginData;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool if CFDB Editor extension plugin is activated</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function isEditorActive() {&nbsp;</div></li><li><div>      $editPluginFile = 'contact-form-to-database-extension-edit/contact-form-to-database-extension-edit.php';&nbsp;</div></li><li><div>      return function_exists('is_plugin_active') && is_plugin_active($editPluginFile);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function addAdminNotices() {&nbsp;</div></li><li><div>      if (!$this-&gt;isEditorActive()) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $requiredEditorVersion = '1.4.1';&nbsp;</div></li><li><div>      $editorData = $this-&gt;getEditorPluginData();&nbsp;</div></li><li><div>      if (isset($editorData['Version'])) {&nbsp;</div></li><li><div>          if (version_compare($editorData['Version'], $requiredEditorVersion) == -1) {&nbsp;</div></li><li><div>              $editorPluginName = version_compare($editorData['Version'], '1.4', '&lt;') ? 'Contact Form to DB Extension Edit' : 'Contact Form DB Editor';&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;message&quot; class=&quot;error&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php echo htmlentities(__('Plugin should be updated: ', 'contact-form-7-to-database-extension')); ?&gt;&lt;strong&gt;&lt;?php echo $editorPluginName ?&gt;&lt;/strong&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                  &lt;?php echo htmlentities(__('Current version: ', 'contact-form-7-to-database-extension')); echo $editorData['Version']; ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                  &lt;?php echo htmlentities(__('Minimum required version: ', 'contact-form-7-to-database-extension')); echo $requiredEditorVersion; ?&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                  &lt;a target=&quot;_cfdbeditupgrade&quot; href=&quot;http:<span class="comment">//cfdbplugin.com/?page_id=939&quot;&gt;&lt;?php echo htmlentities(__('Download the latest version', 'contact-form-7-to-database-extension')); ?&gt;&lt;/a&gt;</span>&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of form names that have data in the DB</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getForms() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $forms = array();&nbsp;</div></li><li><div>      $tableName = $this-&gt;getSubmitsTableName();&nbsp;</div></li><li><div>      $formsFromQuery = $wpdb-&gt;get_results(&quot;select distinct `form_name` from `$tableName` order by `form_name`&quot;);&nbsp;</div></li><li><div>      foreach ($formsFromQuery as $aRow) {&nbsp;</div></li><li><div>          $forms[] = $aRow-&gt;form_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $forms;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * return CFDBErrorLog</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getErrorLog() {&nbsp;</div></li><li><div>      $destination = trim($this-&gt;getOption('ErrorOutput', ''));&nbsp;</div></li><li><div>      return new CFDBErrorLog($this, $destination);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Contact Form DB</li><li><span></span>2.9.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>