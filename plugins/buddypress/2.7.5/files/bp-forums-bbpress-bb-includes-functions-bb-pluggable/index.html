<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.5" data-slug="buddypress" data-type="file" data-id="49194"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-forums-bbpress-bb-includes-functions-bb-pluggable | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.7.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=153d172cef2f6e0f2facd93099c3b452' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-forums-bbpress-bb-includes-functions-bb-pluggable/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-includes-functions-bb-pluggable%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-includes-functions-bb-pluggable%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.7.5-file-bp-forums-bbpress-bb-includes-functions-bb-pluggable","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-forums-bbpress-bb-includes-functions-bb-pluggable" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.5." href="http://hookr.io/plugins/buddypress/2.7.5/" class="H_VERSION"><span property="name">2.7.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.7.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-forums-bbpress-bb-includes&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7768"><a href="http://hookr.io/plugins/buddypress/2.7.5/all/" title="All">All <span class="count badge">7768</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.7.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3600"><a href="http://hookr.io/plugins/buddypress/2.7.5/hooks/" title="Hooks">Hooks <span class="count badge">3600</span></a></li><li class="" data-id="action" data-count="1718"><a href="http://hookr.io/plugins/buddypress/2.7.5/actions/" title="Actions">Actions <span class="count badge">1718</span></a></li><li class="" data-id="filter" data-count="1882"><a href="http://hookr.io/plugins/buddypress/2.7.5/filters/" title="Filters">Filters <span class="count badge">1882</span></a></li><li class="" data-id="class" data-count="178"><a href="http://hookr.io/plugins/buddypress/2.7.5/classes/" title="Classes">Classes <span class="count badge">178</span></a></li><li class="" data-id="constant" data-count="160"><a href="http://hookr.io/plugins/buddypress/2.7.5/constants/" title="Constants">Constants <span class="count badge">160</span></a></li><li class="" data-id="function" data-count="3830"><a href="http://hookr.io/plugins/buddypress/2.7.5/functions/" title="Functions">Functions <span class="count badge">3830</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.7.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-forums/bbpress/bb-includes/functions.bb-pluggable.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_auth' ) ) :&nbsp;</div></li><li><div>function bb_auth( $scheme = 'auth' ) { <span class="comment">// Checks if a user has a valid cookie, if not redirects them to the main page</span>&nbsp;</div></li><li><div>  if ( !bb_validate_auth_cookie( '', $scheme ) ) {&nbsp;</div></li><li><div>      nocache_headers();&nbsp;</div></li><li><div>      if ( 'auth' === $scheme && !bb_is_user_logged_in() ) {&nbsp;</div></li><li><div>          $protocol = 'http:<span class="comment"><span class="comment">//';</span></span>&nbsp;</div></li><li><div>          if ( is_ssl() ) {&nbsp;</div></li><li><div>              $protocol = 'https:<span class="comment"><span class="comment">//';</span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_redirect( bb_get_uri( 'bb-login.php', array( 'redirect_to' =&gt; $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] ), BB_URI_CONTEXT_HEADER + BB_URI_CONTEXT_BB_USER_FORMS ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_redirect( bb_get_uri( null, null, BB_URI_CONTEXT_HEADER ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// $already_md5 variable is deprecated</span>&nbsp;</div></li><li><div>if ( !function_exists('bb_check_login') ) :&nbsp;</div></li><li><div>function bb_check_login($user, $pass, $already_md5 = false) {&nbsp;</div></li><li><div>  global $wp_users_object;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bb_get_option( 'email_login' ) || false === strpos( $user, '@' ) ) { <span class="comment">// user_login</span>&nbsp;</div></li><li><div>      $user = $wp_users_object-&gt;get_user( $user, array( 'by' =&gt; 'login' ) );&nbsp;</div></li><li><div>  } else { <span class="comment">// maybe an email</span>&nbsp;</div></li><li><div>      $email_user = $wp_users_object-&gt;get_user( $user, array( 'by' =&gt; 'email' ) );&nbsp;</div></li><li><div>      $user = $wp_users_object-&gt;get_user( $user, array( 'by' =&gt; 'login' ) );&nbsp;</div></li><li><div>      <span class="comment">// 9 cases.  each can be FALSE, USER, or WP_ERROR</span>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          ( !$email_user && $user ) <span class="comment">// FALSE && USER, FALSE && WP_ERROR</span>&nbsp;</div></li><li><div>      ||&nbsp;</div></li><li><div>          ( is_wp_error( $email_user ) && $user && !is_wp_error( $user ) ) <span class="comment">// WP_ERROR && USER</span>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          <span class="comment">// nope: it really was a user_login</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// [sic]: use $user</span></span></span>&nbsp;</div></li><li><div>      } elseif (&nbsp;</div></li><li><div>          ( $email_user && !$user ) <span class="comment">// USER && FALSE, WP_ERROR && FALSE</span>&nbsp;</div></li><li><div>      ||&nbsp;</div></li><li><div>          ( $email_user && !is_wp_error( $email_user ) && is_wp_error( $user ) ) <span class="comment">// USER && WP_ERROR</span>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          <span class="comment">// yup: it was an email</span>&nbsp;</div></li><li><div>          $user =& $email_user;&nbsp;</div></li><li><div>      } elseif ( !$email_user && !$user ) { <span class="comment">// FALSE && FALSE</span>&nbsp;</div></li><li><div>          <span class="comment">// Doesn't matter what it was: neither worked</span>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } elseif ( is_wp_error( $email_user ) && is_wp_error( $user ) ) { <span class="comment">// WP_ERROR && WP_ERROR</span>&nbsp;</div></li><li><div>          <span class="comment">// This can't happen.  If it does, let's use the email error.  It's probably &quot;multiple matches&quot;, so maybe logging in with a username will work</span>&nbsp;</div></li><li><div>          $user =& $email_user;&nbsp;</div></li><li><div>      } elseif ( $email_user && $user ) { <span class="comment">// USER && USER</span>&nbsp;</div></li><li><div>          <span class="comment">// both are user objects</span>&nbsp;</div></li><li><div>          if ( $email_user-&gt;ID == $user-&gt;ID ); <span class="comment">// [sic]: they are the same, use $user</span>&nbsp;</div></li><li><div>          elseif ( bb_check_password($pass, $user-&gt;user_pass, $user-&gt;ID) ); <span class="comment"><span class="comment"><span class="comment">// [sic]: use $user</span></span></span>&nbsp;</div></li><li><div>          elseif ( bb_check_password($pass, $email_user-&gt;user_pass, $email_user-&gt;ID) )&nbsp;</div></li><li><div>              $user =& $email_user;&nbsp;</div></li><li><div>      } else { <span class="comment">// This can't happen, that's all 9 cases.</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// [sic]: use $user</span></span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$user )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error($user) )&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ( !bb_check_password($pass, $user-&gt;user_pass, $user-&gt;ID) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is logging in for the first time, update their user_status to normal</span>&nbsp;</div></li><li><div>  if ( 1 == $user-&gt;user_status )&nbsp;</div></li><li><div>      bb_update_user_status( $user-&gt;ID, 0 );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_get_current_user') ) :&nbsp;</div></li><li><div>function bb_get_current_user() {&nbsp;</div></li><li><div>  global $wp_auth_object;&nbsp;</div></li><li><div>  return $wp_auth_object-&gt;get_current_user();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_set_current_user') ) :&nbsp;</div></li><li><div>function bb_set_current_user( $id ) {&nbsp;</div></li><li><div>  global $wp_auth_object;&nbsp;</div></li><li><div>  $current_user = $wp_auth_object-&gt;set_current_user( $id );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  do_action('bb_set_current_user', isset($current_user-&gt;ID) ? $current_user-&gt;ID : 0 );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return $current_user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_current_user') ) :&nbsp;</div></li><li><div><span class="comment">//This is only used at initialization.  Use bb_get_current_user_info() (or $bb_current_user global if really needed) to grab user info.</span>&nbsp;</div></li><li><div>function bb_current_user() {&nbsp;</div></li><li><div>  if (BB_INSTALLING)&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return bb_get_current_user();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_is_user_authorized') ) :&nbsp;</div></li><li><div>function bb_is_user_authorized() {&nbsp;</div></li><li><div>  return bb_is_user_logged_in();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_is_user_logged_in') ) :&nbsp;</div></li><li><div>function bb_is_user_logged_in() {&nbsp;</div></li><li><div>  $current_user = bb_get_current_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($current_user) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_login') ) :&nbsp;</div></li><li><div>function bb_login( $login, $password, $remember = false ) {&nbsp;</div></li><li><div>  $user = bb_check_login( $login, $password );&nbsp;</div></li><li><div>  if ( $user && !is_wp_error( $user ) ) {&nbsp;</div></li><li><div>      bb_set_auth_cookie( $user-&gt;ID, $remember );&nbsp;</div></li><li><div>      do_action('bb_user_login', (int) $user-&gt;ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_logout') ) :&nbsp;</div></li><li><div>function bb_logout() {&nbsp;</div></li><li><div>  bb_clear_auth_cookie();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  do_action('bb_user_logout');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_validate_auth_cookie' ) ) :&nbsp;</div></li><li><div>function bb_validate_auth_cookie( $cookie = '', $scheme = 'auth' ) {&nbsp;</div></li><li><div>  global $wp_auth_object;&nbsp;</div></li><li><div>  if ( empty($cookie) && $scheme == 'auth' ) {&nbsp;</div></li><li><div>      if ( is_ssl() ) {&nbsp;</div></li><li><div>          $scheme = 'secure_auth';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $scheme = 'auth';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $wp_auth_object-&gt;validate_auth_cookie( $cookie, $scheme );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_set_auth_cookie' ) ) :&nbsp;</div></li><li><div>function bb_set_auth_cookie( $user_id, $remember = false, $schemes = false ) {&nbsp;</div></li><li><div>  global $wp_auth_object;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $remember ) {&nbsp;</div></li><li><div>      $expiration = $expire = time() + 1209600;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $expiration = time() + 172800;&nbsp;</div></li><li><div>      $expire = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( true === $schemes ) {&nbsp;</div></li><li><div>      $schemes = array( 'secure_auth', 'logged_in' );&nbsp;</div></li><li><div>  } elseif ( !is_array( $schemes ) ) {&nbsp;</div></li><li><div>      $schemes = array();&nbsp;</div></li><li><div>      if ( force_ssl_login() || force_ssl_admin() ) {&nbsp;</div></li><li><div>          $schemes[] = 'secure_auth';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !( force_ssl_login() && force_ssl_admin() ) ) {&nbsp;</div></li><li><div>          $schemes[] = 'auth';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $schemes[] = 'logged_in';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $schemes = array_unique( $schemes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $schemes as $scheme ) {&nbsp;</div></li><li><div>      $wp_auth_object-&gt;set_auth_cookie( $user_id, $expiration, $expire, $scheme );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_clear_auth_cookie') ) :&nbsp;</div></li><li><div>function bb_clear_auth_cookie() {&nbsp;</div></li><li><div>  global $bb, $wp_auth_object;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $wp_auth_object-&gt;clear_auth_cookie();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Old cookies</span>&nbsp;</div></li><li><div>  setcookie($bb-&gt;authcookie, ' ', time() - 31536000, $bb-&gt;cookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>  setcookie($bb-&gt;authcookie, ' ', time() - 31536000, $bb-&gt;sitecookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Even older cookies</span>&nbsp;</div></li><li><div>  setcookie($bb-&gt;usercookie, ' ', time() - 31536000, $bb-&gt;cookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>  setcookie($bb-&gt;usercookie, ' ', time() - 31536000, $bb-&gt;sitecookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>  setcookie($bb-&gt;passcookie, ' ', time() - 31536000, $bb-&gt;cookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>  setcookie($bb-&gt;passcookie, ' ', time() - 31536000, $bb-&gt;sitecookiepath, $bb-&gt;cookiedomain);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_redirect') ) : <span class="comment"><span class="comment">// [WP11537]</span></span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirects to another page, with a workaround for the IIS Set-Cookie bug.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @link http://support.microsoft.com/kb/q176113/</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'wp_redirect' hook on $location and $status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $location The path to redirect to</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $status Status code to use</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool False if $location is not set</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_redirect($location, $status = 302) {&nbsp;</div></li><li><div>  global $is_IIS;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $location = apply_filters('wp_redirect', $location, $status);&nbsp;</div></li><li><div>  $status = apply_filters('wp_redirect_status', $status, $location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$location ) <span class="comment">// allows the wp_redirect filter to cancel a redirect</span>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $location = wp_sanitize_redirect($location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_IIS ) {&nbsp;</div></li><li><div>      header(&quot;Refresh: 0;url=$location&quot;);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( php_sapi_name() != 'cgi-fcgi' )&nbsp;</div></li><li><div>          status_header($status); <span class="comment">// This causes problems on IIS and some FastCGI setups</span>&nbsp;</div></li><li><div>      header(&quot;Location: $location&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_sanitize_redirect') ) : <span class="comment"><span class="comment">// [WP11537]</span></span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sanitizes a URL for use in a redirect.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string redirect-sanitized URL</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function wp_sanitize_redirect($location) {&nbsp;</div></li><li><div>  $location = preg_replace('|[^a-z0-9-~+_.?#=&;, /:%!]|i', '', $location);&nbsp;</div></li><li><div>  $location = wp_kses_no_null($location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove %0d and %0a from location</span>&nbsp;</div></li><li><div>  $strip = array('%0d', '%0a');&nbsp;</div></li><li><div>  $found = true;&nbsp;</div></li><li><div>  while($found) {&nbsp;</div></li><li><div>      $found = false;&nbsp;</div></li><li><div>      foreach( (array) $strip as $val ) {&nbsp;</div></li><li><div>          while(strpos($location, $val) !== false) {&nbsp;</div></li><li><div>              $found = true;&nbsp;</div></li><li><div>              $location = str_replace($val, '', $location);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $location;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_safe_redirect') ) : <span class="comment">// based on [WP6145] (home is different)</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Performs a safe (local) redirect, using wp_redirect().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether the $location is using an allowed host, if it has an absolute</span>&nbsp;</div></li><li><div><span class="comment"> * path. A plugin can therefore set or remove allowed host(s) to or from the</span>&nbsp;</div></li><li><div><span class="comment"> * list.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the host is not allowed, then the redirect is to the site url</span>&nbsp;</div></li><li><div><span class="comment"> * instead. This prevents malicious redirects which redirect to another host, </span>&nbsp;</div></li><li><div><span class="comment"> * but only used in a few places.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'allowed_redirect_hosts' on an array containing</span>&nbsp;</div></li><li><div><span class="comment"> *        bbPress host string and $location host string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void Does not return anything</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function bb_safe_redirect( $location, $status = 302 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Need to look at the URL the way it will end up in wp_redirect()</span>&nbsp;</div></li><li><div>  $location = wp_sanitize_redirect($location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// browsers will assume 'http' is your protocol, and will obey a redirect to a URL starting with '//'</span>&nbsp;</div></li><li><div>  if ( substr($location, 0, 2) == '<span class="comment">//' )</span>&nbsp;</div></li><li><div>      $location = 'http:' . $location;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// In php 5 parse_url may fail if the URL query part contains http://, bug #38143</span>&nbsp;</div></li><li><div>  $test = ( $cut = strpos($location, '?') ) ? substr( $location, 0, $cut ) : $location;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $lp = parse_url($test);&nbsp;</div></li><li><div>  $bp = parse_url(bb_get_uri());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allowed_hosts = (array) apply_filters('allowed_redirect_hosts', array($bp['host']), isset($lp['host']) ? $lp['host'] : '');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($lp['host']) && ( !in_array($lp['host'], $allowed_hosts) && $lp['host'] != strtolower($bp['host'])) )&nbsp;</div></li><li><div>      $location = bb_get_uri(null, null, BB_URI_CONTEXT_HEADER);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return wp_redirect($location, $status);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_nonce_tick') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the time-dependent variable for nonce creation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * A nonce has a lifespan of two ticks. Nonces in their second tick may be</span>&nbsp;</div></li><li><div><span class="comment"> * updated, e.g. by autosave.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_nonce_tick() {&nbsp;</div></li><li><div>  $nonce_life = apply_filters('bb_nonce_life', 86400);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return ceil(time() / ( $nonce_life / 2 ));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_verify_nonce') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Verify that correct nonce was used with time limit.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The user is given an amount of time to use the token, so therefore, since the</span>&nbsp;</div></li><li><div><span class="comment"> * UID and $action remain the same, the independent variable is the time.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $nonce Nonce that was used in the form to verify</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|int $action Should give context to what is taking place and be the same when nonce was created.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether the nonce check passed or failed.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_verify_nonce($nonce, $action = -1) {&nbsp;</div></li><li><div>  $user = bb_get_current_user();&nbsp;</div></li><li><div>  $uid = (int) $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = bb_nonce_tick();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Nonce generated 0-12 hours ago</span>&nbsp;</div></li><li><div>  if ( substr(bb_hash($i . $action . $uid, 'nonce'), -12, 10) == $nonce )&nbsp;</div></li><li><div>      return 1;&nbsp;</div></li><li><div>  <span class="comment">// Nonce generated 12-24 hours ago</span>&nbsp;</div></li><li><div>  if ( substr(bb_hash(($i - 1) . $action . $uid, 'nonce'), -12, 10) == $nonce )&nbsp;</div></li><li><div>      return 2;&nbsp;</div></li><li><div>  <span class="comment">// Invalid nonce</span>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_create_nonce') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a random, one time use token.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|int $action Scalar value to add context to the nonce.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The one use form token</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_create_nonce($action = -1) {&nbsp;</div></li><li><div>  $user = bb_get_current_user();&nbsp;</div></li><li><div>  $uid = (int) $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = bb_nonce_tick();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return substr(bb_hash($i . $action . $uid, 'nonce'), -12, 10);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _bb_get_key( $key, $default_key = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_default_secret_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined( $key ) && '' != constant( $key ) && $bb_default_secret_key != constant( $key ) ) {&nbsp;</div></li><li><div>      return constant( $key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _bb_get_salt( $constants, $option = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( !is_array( $constants ) ) {&nbsp;</div></li><li><div>      $constants = array( $constants );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ($constants as $constant ) {&nbsp;</div></li><li><div>      if ( defined( $constant ) ) {&nbsp;</div></li><li><div>          return constant( $constant );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BB_INSTALLING' ) || !BB_INSTALLING ) {&nbsp;</div></li><li><div>      if ( !$option ) {&nbsp;</div></li><li><div>          $option = strtolower( $constants[0] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $salt = bb_get_option( $option );&nbsp;</div></li><li><div>      if ( empty( $salt ) ) {&nbsp;</div></li><li><div>          $salt = bb_generate_password( 64 );&nbsp;</div></li><li><div>          bb_update_option( $option, $salt );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $salt;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Not verbatim WP, constants have different names, uses helper functions.</span>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_salt' ) ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get salt to add to hashes to help prevent attacks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 0.9</span>&nbsp;</div></li><li><div><span class="comment"> * @link http://api.wordpress.org/secret-key/1.1/bbpress/ Create a set of keys for bb-config.php</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _bb_get_key()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _bb_get_salt()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Salt value for the given scheme</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_salt( $scheme = 'auth' )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// Deprecated</span>&nbsp;</div></li><li><div>  $secret_key = _bb_get_key( 'BB_SECRET_KEY' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ($scheme) {&nbsp;</div></li><li><div>      case 'auth':&nbsp;</div></li><li><div>          $secret_key = _bb_get_key( 'BB_AUTH_KEY' );&nbsp;</div></li><li><div>          $salt = _bb_get_salt( array( 'BB_AUTH_SALT', 'BB_SECRET_SALT' ) );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'secure_auth':&nbsp;</div></li><li><div>          $secret_key = _bb_get_key( 'BB_SECURE_AUTH_KEY' );&nbsp;</div></li><li><div>          $salt = _bb_get_salt( 'BB_SECURE_AUTH_SALT' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'logged_in':&nbsp;</div></li><li><div>          $secret_key = _bb_get_key( 'BB_LOGGED_IN_KEY' );&nbsp;</div></li><li><div>          $salt = _bb_get_salt( 'BB_LOGGED_IN_SALT' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'nonce':&nbsp;</div></li><li><div>          $secret_key = _bb_get_key( 'BB_NONCE_KEY' );&nbsp;</div></li><li><div>          $salt = _bb_get_salt( 'BB_NONCE_SALT' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          <span class="comment">// ensure each auth scheme has its own unique salt</span>&nbsp;</div></li><li><div>          $salt = hash_hmac( 'md5', $scheme, $secret_key );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'salt', $secret_key . $salt, $scheme );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_hash' ) ) :&nbsp;</div></li><li><div>function bb_hash( $data, $scheme = 'auth' ) { &nbsp;</div></li><li><div>  $salt = bb_salt( $scheme );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return hash_hmac( 'md5', $data, $salt );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_hash_password' ) ) :&nbsp;</div></li><li><div>function bb_hash_password( $password ) {&nbsp;</div></li><li><div>  return WP_Pass::hash_password( $password );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_check_password') ) :&nbsp;</div></li><li><div>function bb_check_password( $password, $hash, $user_id = '' ) {&nbsp;</div></li><li><div>  return WP_Pass::check_password( $password, $hash, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_generate_password' ) ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generates a random password drawn from the defined set of characters</span>&nbsp;</div></li><li><div><span class="comment"> * @return string the password</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_generate_password( $length = 12, $special_chars = true ) {&nbsp;</div></li><li><div>  return WP_Pass::generate_password( $length, $special_chars );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_check_admin_referer') ) :&nbsp;</div></li><li><div>function bb_check_admin_referer( $action = -1, $query_arg = '_wpnonce' ) {&nbsp;</div></li><li><div>  $nonce = '';&nbsp;</div></li><li><div>  if ( isset( $_POST[$query_arg] ) && $_POST[$query_arg] ) {&nbsp;</div></li><li><div>      $nonce = $_POST[$query_arg];&nbsp;</div></li><li><div>  } elseif ( isset( $_GET[$query_arg] ) && $_GET[$query_arg] ) {&nbsp;</div></li><li><div>      $nonce = $_GET[$query_arg];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( !bb_verify_nonce($nonce, $action) ) {&nbsp;</div></li><li><div>      bb_nonce_ays($action);&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  do_action('bb_check_admin_referer', $action);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_check_ajax_referer') ) :&nbsp;</div></li><li><div>function bb_check_ajax_referer( $action = -1, $query_arg = false, $die = true ) {&nbsp;</div></li><li><div>  $requests = array();&nbsp;</div></li><li><div>  if ( $query_arg ) {&nbsp;</div></li><li><div>      $requests[] = $query_arg;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $requests[] = '_ajax_nonce';&nbsp;</div></li><li><div>  $requests[] = '_wpnonce';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $nonce = '';&nbsp;</div></li><li><div>  foreach ( $requests as $request ) {&nbsp;</div></li><li><div>      if ( isset( $_POST[$request] ) && $_POST[$request] ) {&nbsp;</div></li><li><div>          $nonce = $_POST[$request];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      } elseif ( isset( $_GET[$request] ) && $_GET[$request] ) {&nbsp;</div></li><li><div>          $nonce = $_GET[$request];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = bb_verify_nonce( $nonce, $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $die && false == $result )&nbsp;</div></li><li><div>      die('-1');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action('bb_check_ajax_referer', $action, $result);&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_break_password') ) :&nbsp;</div></li><li><div>function bb_break_password( $user_id ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>  if ( !$user = bb_get_user( $user_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  $secret = substr(bb_hash( 'bb_break_password' ), 0, 13);&nbsp;</div></li><li><div>  if ( false === strpos( $user-&gt;user_pass, '---' ) )&nbsp;</div></li><li><div>      return $bbdb-&gt;query( $bbdb-&gt;prepare(&nbsp;</div></li><li><div>          &quot;UPDATE $bbdb-&gt;users SET user_pass = CONCAT(user_pass, '---', %s) WHERE ID = %d&quot;, &nbsp;</div></li><li><div>          $secret, $user_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_fix_password') ) :&nbsp;</div></li><li><div>function bb_fix_password( $user_id ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>  if ( !$user = bb_get_user( $user_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  if ( false === strpos( $user-&gt;user_pass, '---' ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return $bbdb-&gt;query( $bbdb-&gt;prepare(&nbsp;</div></li><li><div>          &quot;UPDATE $bbdb-&gt;users SET user_pass = SUBSTRING_INDEX(user_pass, '---', 1) WHERE ID = %d&quot;, &nbsp;</div></li><li><div>          $user_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_has_broken_pass') ) :&nbsp;</div></li><li><div>function bb_has_broken_pass( $user_id = 0 ) {&nbsp;</div></li><li><div>  global $bb_current_user;&nbsp;</div></li><li><div>  if ( !$user_id )&nbsp;</div></li><li><div>      $user =& $bb_current_user-&gt;data;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $user = bb_get_user( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return ( false !== strpos($user-&gt;user_pass, '---' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('bb_new_user') ) :&nbsp;</div></li><li><div>function bb_new_user( $user_login, $user_email, $user_url, $user_status = 1 ) {&nbsp;</div></li><li><div>  global $wp_users_object, $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// is_email check + dns</span>&nbsp;</div></li><li><div>  if ( !$user_email = is_email( $user_email ) )&nbsp;</div></li><li><div>      return new WP_Error( 'user_email', __( 'Invalid email address' ), $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$user_login = sanitize_user( $user_login, true ) )&nbsp;</div></li><li><div>      return new WP_Error( 'user_login', __( 'Invalid username' ), $user_login );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// user_status = 1 means the user has not yet been verified</span>&nbsp;</div></li><li><div>  $user_status = is_numeric($user_status) ? (int) $user_status : 1;&nbsp;</div></li><li><div>  if ( defined( 'BB_INSTALLING' ) )&nbsp;</div></li><li><div>      $user_status = 0;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $user_nicename = $_user_nicename = bb_user_nicename_sanitize( $user_login );&nbsp;</div></li><li><div>  if ( strlen( $_user_nicename ) &lt; 1 )&nbsp;</div></li><li><div>      return new WP_Error( 'user_login', __( 'Invalid username' ), $user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  while ( is_numeric($user_nicename) || $existing_user = bb_get_user_by_nicename( $user_nicename ) )&nbsp;</div></li><li><div>      $user_nicename = bb_slug_increment($_user_nicename, $existing_user-&gt;user_nicename, 50);&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $user_url = $user_url ? bb_fix_link( $user_url ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_pass = bb_generate_password();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = $wp_users_object-&gt;new_user( compact( 'user_login', 'user_email', 'user_url', 'user_nicename', 'user_status', 'user_pass' ) );&nbsp;</div></li><li><div>  if ( is_wp_error($user) ) {&nbsp;</div></li><li><div>      if ( 'user_nicename' == $user-&gt;get_error_code() )&nbsp;</div></li><li><div>          return new WP_Error( 'user_login', $user-&gt;get_error_message() );&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (BB_INSTALLING) {&nbsp;</div></li><li><div>      bb_update_usermeta( $user['ID'], $bbdb-&gt;prefix . 'capabilities', array('keymaster' =&gt; true) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bb_update_usermeta( $user['ID'], $bbdb-&gt;prefix . 'capabilities', array('member' =&gt; true) );&nbsp;</div></li><li><div>      bb_send_pass( $user['ID'], $user['plain_pass'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action('bb_new_user', $user['ID'], $user['plain_pass']);&nbsp;</div></li><li><div>  return $user['ID'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_mail' ) ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send mail, similar to PHP's mail</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * A true return value does not automatically mean that the user received the</span>&nbsp;</div></li><li><div><span class="comment"> * email successfully. It just only means that the method used was able to</span>&nbsp;</div></li><li><div><span class="comment"> * process the request without any errors.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Using the two 'bb_mail_from' and 'bb_mail_from_name' hooks allow from</span>&nbsp;</div></li><li><div><span class="comment"> * creating a from address like 'Name &lt;email@address.com&gt;' when both are set. If</span>&nbsp;</div></li><li><div><span class="comment"> * just 'bb_mail_from' is set, then just the email address will be used with no</span>&nbsp;</div></li><li><div><span class="comment"> * name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The default content type is 'text/plain' which does not allow using HTML.</span>&nbsp;</div></li><li><div><span class="comment"> * However, you can set the content type of the email by using the</span>&nbsp;</div></li><li><div><span class="comment"> * 'bb_mail_content_type' filter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The default charset is based on the charset used on the blog. The charset can</span>&nbsp;</div></li><li><div><span class="comment"> * be set using the 'bb_mail_charset' filter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bb_mail' hook on an array of all of the parameters.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bb_mail_from' hook to get the from email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bb_mail_from_name' hook to get the from address name.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bb_mail_content_type' hook to get the email content type.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Calls 'bb_mail_charset' hook to get the email charset</span>&nbsp;</div></li><li><div><span class="comment"> * @uses do_action_ref_array() Calls 'bb_phpmailer_init' hook on the reference to</span>&nbsp;</div></li><li><div><span class="comment"> *        phpmailer object.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses PHPMailer</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $to Email address to send message</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $subject Email subject</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $message Message contents</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $headers Optional. Additional headers.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $attachments Optional. Files to attach.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether the email contents were sent successfully.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_mail( $to, $subject, $message, $headers = '', $attachments = array() ) {&nbsp;</div></li><li><div>  <span class="comment">// Compact the input, apply the filters, and extract them back out</span>&nbsp;</div></li><li><div>  extract( apply_filters( 'bb_mail', compact( 'to', 'subject', 'message', 'headers', 'attachments' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_array($attachments) )&nbsp;</div></li><li><div>      $attachments = explode( &quot;\n&quot;, $attachments );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $bb_phpmailer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// (Re)create it, if it's gone missing</span>&nbsp;</div></li><li><div>  if ( !is_object( $bb_phpmailer ) || !is_a( $bb_phpmailer, 'PHPMailer' ) ) {&nbsp;</div></li><li><div>      require_once BACKPRESS_PATH . 'class.mailer.php';&nbsp;</div></li><li><div>      require_once BACKPRESS_PATH . 'class.mailer-smtp.php';&nbsp;</div></li><li><div>      $bb_phpmailer = new PHPMailer();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Headers</span>&nbsp;</div></li><li><div>  if ( empty( $headers ) ) {&nbsp;</div></li><li><div>      $headers = array();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( !is_array( $headers ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Explode the headers out, so this function can take both</span>&nbsp;</div></li><li><div>          <span class="comment">// string headers and an array of headers.</span>&nbsp;</div></li><li><div>          $tempheaders = (array) explode( &quot;\n&quot;, $headers );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $tempheaders = $headers;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $headers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If it's actually got contents</span>&nbsp;</div></li><li><div>      if ( !empty( $tempheaders ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Iterate through the raw headers</span>&nbsp;</div></li><li><div>          foreach ( (array) $tempheaders as $header ) {&nbsp;</div></li><li><div>              if ( strpos($header, ':') === false ) {&nbsp;</div></li><li><div>                  if ( false !== stripos( $header, 'boundary=' ) ) {&nbsp;</div></li><li><div>                      $parts = preg_split('/boundary=/i', trim( $header ) );&nbsp;</div></li><li><div>                      $boundary = trim( str_replace( array( &quot;'&quot;, '&quot;' ), '', $parts[1] ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Explode them out</span>&nbsp;</div></li><li><div>              list( $name, $content ) = explode( ':', trim( $header ), 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Cleanup crew</span>&nbsp;</div></li><li><div>              $name = trim( $name );&nbsp;</div></li><li><div>              $content = trim( $content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Mainly for legacy -- process a From: header if it's there</span>&nbsp;</div></li><li><div>              if ( 'from' == strtolower($name) ) {&nbsp;</div></li><li><div>                  if ( strpos($content, '&lt;' ) !== false ) {&nbsp;</div></li><li><div>                      <span class="comment">// So... making my life hard again?</span>&nbsp;</div></li><li><div>                      $from_name = substr( $content, 0, strpos( $content, '&lt;' ) - 1 );&nbsp;</div></li><li><div>                      $from_name = str_replace( '&quot;', '', $from_name );&nbsp;</div></li><li><div>                      $from_name = trim( $from_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $from_email = substr( $content, strpos( $content, '&lt;' ) + 1 );&nbsp;</div></li><li><div>                      $from_email = str_replace( '&gt;', '', $from_email );&nbsp;</div></li><li><div>                      $from_email = trim( $from_email );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $from_email = trim( $content );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( 'content-type' == strtolower($name) ) {&nbsp;</div></li><li><div>                  if ( strpos( $content, ';' ) !== false ) {&nbsp;</div></li><li><div>                      list( $type, $charset ) = explode( ';', $content );&nbsp;</div></li><li><div>                      $content_type = trim( $type );&nbsp;</div></li><li><div>                      if ( false !== stripos( $charset, 'charset=' ) ) {&nbsp;</div></li><li><div>                          $charset = trim( str_replace( array( 'charset=', '&quot;' ), '', $charset ) );&nbsp;</div></li><li><div>                      } elseif ( false !== stripos( $charset, 'boundary=' ) ) {&nbsp;</div></li><li><div>                          $boundary = trim( str_replace( array( 'BOUNDARY=', 'boundary=', '&quot;' ), '', $charset ) );&nbsp;</div></li><li><div>                          $charset = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $content_type = trim( $content );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( 'cc' == strtolower($name) ) {&nbsp;</div></li><li><div>                  $cc = explode(&quot;, &quot;, $content);&nbsp;</div></li><li><div>              } elseif ( 'bcc' == strtolower($name) ) {&nbsp;</div></li><li><div>                  $bcc = explode(&quot;, &quot;, $content);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// Add it to our grand headers array</span>&nbsp;</div></li><li><div>                  $headers[trim( $name )] = trim( $content );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Empty out the values that may be set</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearAddresses();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearAllRecipients();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearAttachments();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearBCCs();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearCCs();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearCustomHeaders();&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ClearReplyTos();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// From email and name</span>&nbsp;</div></li><li><div>  <span class="comment">// If we don't have a name from the input headers</span>&nbsp;</div></li><li><div>  if ( !isset( $from_name ) ) {&nbsp;</div></li><li><div>      $from_name = bb_get_option('name');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we don't have an email from the input headers</span>&nbsp;</div></li><li><div>  if ( !isset( $from_email ) ) {&nbsp;</div></li><li><div>      $from_email = bb_get_option('from_email');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If there is still no email address</span>&nbsp;</div></li><li><div>  if ( !$from_email ) {&nbsp;</div></li><li><div>      <span class="comment">// Get the site domain and get rid of www.</span>&nbsp;</div></li><li><div>      $sitename = strtolower( $_SERVER['SERVER_NAME'] );&nbsp;</div></li><li><div>      if ( substr( $sitename, 0, 4 ) == 'www.' ) {&nbsp;</div></li><li><div>          $sitename = substr( $sitename, 4 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $from_email = 'bbpress@' . $sitename;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Plugin authors can override the potentially troublesome default</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;From = apply_filters( 'bb_mail_from', $from_email );&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;FromName = apply_filters( 'bb_mail_from_name', $from_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set destination address</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;AddAddress( $to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set mail's subject and body</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;Subject = $subject;&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;Body = $message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add any CC and BCC recipients</span>&nbsp;</div></li><li><div>  if ( !empty($cc) ) {&nbsp;</div></li><li><div>      foreach ( (array) $cc as $recipient ) {&nbsp;</div></li><li><div>          $bb_phpmailer-&gt;AddCc( trim($recipient) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( !empty($bcc) ) {&nbsp;</div></li><li><div>      foreach ( (array) $bcc as $recipient) {&nbsp;</div></li><li><div>          $bb_phpmailer-&gt;AddBcc( trim($recipient) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set to use PHP's mail()</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;IsMail();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set Content-Type and charset</span>&nbsp;</div></li><li><div>  <span class="comment">// If we don't have a content-type from the input headers</span>&nbsp;</div></li><li><div>  if ( !isset( $content_type ) ) {&nbsp;</div></li><li><div>      $content_type = 'text/plain';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $content_type = apply_filters( 'bb_mail_content_type', $content_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;ContentType = $content_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set whether it's plaintext or not, depending on $content_type</span>&nbsp;</div></li><li><div>  if ( $content_type == 'text/html' ) {&nbsp;</div></li><li><div>      $bb_phpmailer-&gt;IsHTML( true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we don't have a charset from the input headers</span>&nbsp;</div></li><li><div>  if ( !isset( $charset ) ) {&nbsp;</div></li><li><div>      $charset = bb_get_option( 'charset' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the content-type and charset</span>&nbsp;</div></li><li><div>  $bb_phpmailer-&gt;CharSet = apply_filters( 'bb_mail_charset', $charset );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set custom headers</span>&nbsp;</div></li><li><div>  if ( !empty( $headers ) ) {&nbsp;</div></li><li><div>      foreach( (array) $headers as $name =&gt; $content ) {&nbsp;</div></li><li><div>          $bb_phpmailer-&gt;AddCustomHeader( sprintf( '%1$s: %2$s', $name, $content ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( false !== stripos( $content_type, 'multipart' ) && ! empty($boundary) ) {&nbsp;</div></li><li><div>          $bb_phpmailer-&gt;AddCustomHeader( sprintf( &quot;Content-Type: %s;\n\t boundary=\&quot;%s\&quot;&quot;, $content_type, $boundary ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $attachments ) ) {&nbsp;</div></li><li><div>      foreach ( $attachments as $attachment ) {&nbsp;</div></li><li><div>          $bb_phpmailer-&gt;AddAttachment($attachment);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action_ref_array( 'bb_phpmailer_init', array( &$bb_phpmailer ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Send!</span>&nbsp;</div></li><li><div>  $result = @$bb_phpmailer-&gt;Send();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'bb_get_avatar' ) ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the avatar for a user provided a user ID or email address</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 0.9</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string $id_or_email A user ID or email address</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $size Size of the avatar image</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $default URL to a default image to use if no avatar is available</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $alt Alternate text to use in image tag. Defaults to blank</span>&nbsp;</div></li><li><div><span class="comment"> * @return string &lt;img&gt; tag for the user's avatar</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function bb_get_avatar( $id_or_email, $size = 80, $default = '', $alt = false ) {&nbsp;</div></li><li><div>  if ( !bb_get_option('avatars_show') )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $alt)&nbsp;</div></li><li><div>      $safe_alt = '';&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $safe_alt = esc_attr( $alt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_numeric($size) )&nbsp;</div></li><li><div>      $size = 80;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $email = bb_get_user_email($id_or_email) ) {&nbsp;</div></li><li><div>      $class = 'photo ';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $class = '';&nbsp;</div></li><li><div>      $email = $id_or_email;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$email )&nbsp;</div></li><li><div>      $email = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($default) )&nbsp;</div></li><li><div>      $default = bb_get_option('avatars_default');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   if ( is_ssl() )&nbsp;</div></li><li><div>      $host = 'https:<span class="comment">//secure.gravatar.com';</span>&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $host = 'http:<span class="comment">//www.gravatar.com';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ($default) {&nbsp;</div></li><li><div>      case 'logo':&nbsp;</div></li><li><div>          $default = '';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'blank':&nbsp;</div></li><li><div>          $default = bb_get_uri( 'bb-admin/images/blank.gif', null, BB_URI_CONTEXT_IMG_SRC );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'monsterid':&nbsp;</div></li><li><div>      case 'wavatar':&nbsp;</div></li><li><div>      case 'identicon':&nbsp;</div></li><li><div>      case 'retro':&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'default':&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $default = $host . '/avatar/ad516503a11cd5ca435acc9bb6523536?s=' . $size;&nbsp;</div></li><li><div>          <span class="comment">// ad516503a11cd5ca435acc9bb6523536 == md5('unknown@gravatar.com')</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $src = $host . '/avatar/';&nbsp;</div></li><li><div>  $class .= 'avatar avatar-' . $size;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($email) ) {&nbsp;</div></li><li><div>      $src .= md5( strtolower( $email ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $src .= 'd41d8cd98f00b204e9800998ecf8427e';&nbsp;</div></li><li><div>      <span class="comment">// d41d8cd98f00b204e9800998ecf8427e == md5('')</span>&nbsp;</div></li><li><div>      $class .= ' avatar-noemail';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $src .= '?s=' . $size;&nbsp;</div></li><li><div>  $src .= '&amp;d=' . urlencode( $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $rating = bb_get_option('avatars_rating');&nbsp;</div></li><li><div>  if ( !empty( $rating ) )&nbsp;</div></li><li><div>      $src .= '&amp;r=' . $rating;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar = '&lt;img alt=&quot;' . $safe_alt . '&quot; src=&quot;' . $src . '&quot; class=&quot;' . $class . '&quot; style=&quot;height:' . $size . 'px; width:' . $size . 'px;&quot; /&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters('bb_get_avatar', $avatar, $id_or_email, $size, $default, $alt);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>