<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.0" data-slug="buddypress" data-type="file" data-id="49188"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-forums-bbpress-bb-includes-functions-bb-core | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=43ada640bd3c1eb5c4c53dd330a6d298' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-forums-bbpress-bb-includes-functions-bb-core/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-includes-functions-bb-core%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-includes-functions-bb-core%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.0-file-bp-forums-bbpress-bb-includes-functions-bb-core","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-forums-bbpress-bb-includes-functions-bb-core" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.0." href="http://hookr.io/plugins/buddypress/2.8.0/" class="H_VERSION"><span property="name">2.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-forums-bbpress-bb-includes&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.0/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="66"><a href="http://hookr.io/plugins/buddypress/2.8.0/new/" title="New">New <span class="count badge">66</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.0/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.0/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.0/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.0/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.0/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.0/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-forums/bbpress/bb-includes/functions.bb-core.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Core bbPress functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Initialization functions mostly called in bb-settings.php</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Marks things as deprecated and informs when they have been used.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 0.9</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type The type of thing that was attempted: function, class::function, constant, variable or page.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $name The thing that was called.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $replacement Optional. The thing that should have been called.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $bb_log BP_Log logging object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_log_deprecated( $type, $name, $replacement = 'none' ) {&nbsp;</div></li><li><div>  global $bb_log;&nbsp;</div></li><li><div>  $bb_log-&gt;notice( sprintf( __( 'Using deprecated bbPress %1$s - %2$s - replace with - %3$s' ), $type, $name, $replacement ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $bb_log-&gt;level & BP_LOG_DEBUG && $bb_log-&gt;level & BP_LOG_NOTICE ) { <span class="comment">// Only compute the location if we're going to log it.</span>&nbsp;</div></li><li><div>      $backtrace = debug_backtrace();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file = $backtrace[2]['file'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( substr( $file, 0, strlen( BB_PATH ) - 1 ) == rtrim( BB_PATH, '\\/') )&nbsp;</div></li><li><div>          $file = substr( $file, strlen( BB_PATH ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file = str_replace( '\\', '/', $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// 0 = this function, 1 = the deprecated function</span>&nbsp;</div></li><li><div>      $bb_log-&gt;notice( '    ' . sprintf( __( 'on line %1$d of file %2$s' ), $backtrace[2]['line'], $file ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sanitizes user input en-masse.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $array The array of values or a single value to sanitize, usually a global variable like $_GET or $_POST.</span>&nbsp;</div></li><li><div><span class="comment"> * @param boolean $trim Optional. Whether to trim the value or not. Default is true.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed The sanitized data.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_global_sanitize( $array, $trim = true )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  foreach ( $array as $k =&gt; $v ) {&nbsp;</div></li><li><div>      if ( is_array( $v ) ) {&nbsp;</div></li><li><div>          $array[$k] = bb_global_sanitize( $v );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( !get_magic_quotes_gpc() ) {&nbsp;</div></li><li><div>              $array[$k] = addslashes( $v );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $trim ) {&nbsp;</div></li><li><div>              $array[$k] = trim( $array[$k] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $array;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Reports whether bbPress is installed by getting forums.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean True if there are forums, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_is_installed()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// Maybe grab all the forums and cache them</span>&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  $bbdb-&gt;suppress_errors();&nbsp;</div></li><li><div>  $forums = (array) @bb_get_forums();&nbsp;</div></li><li><div>  $bbdb-&gt;suppress_errors(false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$forums ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets the required variables to connect to custom user tables.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean Always returns true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_set_custom_user_tables()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for older style custom user table</span>&nbsp;</div></li><li><div>  if ( !isset( $bb-&gt;custom_tables['users'] ) ) { <span class="comment"><span class="comment"><span class="comment">// Don't stomp new setting style</span></span></span>&nbsp;</div></li><li><div>      if ( $bb-&gt;custom_user_table = bb_get_option( 'custom_user_table' ) ) {&nbsp;</div></li><li><div>          if ( !isset( $bb-&gt;custom_tables ) ) {&nbsp;</div></li><li><div>              $bb-&gt;custom_tables = array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $bb-&gt;custom_tables['users'] = $bb-&gt;custom_user_table;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for older style custom user meta table</span>&nbsp;</div></li><li><div>  if ( !isset( $bb-&gt;custom_tables['usermeta'] ) ) { <span class="comment"><span class="comment"><span class="comment">// Don't stomp new setting style</span></span></span>&nbsp;</div></li><li><div>      if ( $bb-&gt;custom_user_meta_table = bb_get_option( 'custom_user_meta_table' ) ) {&nbsp;</div></li><li><div>          if ( !isset( $bb-&gt;custom_tables ) ) {&nbsp;</div></li><li><div>              $bb-&gt;custom_tables = array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $bb-&gt;custom_tables['usermeta'] = $bb-&gt;custom_user_meta_table;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for older style wp_table_prefix</span>&nbsp;</div></li><li><div>  if ( $bb-&gt;wp_table_prefix = bb_get_option( 'wp_table_prefix' ) ) { <span class="comment">// User has set old constant</span>&nbsp;</div></li><li><div>      if ( !isset( $bb-&gt;custom_tables ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_tables = array(&nbsp;</div></li><li><div>              'users' =&gt; $bb-&gt;wp_table_prefix . 'users', &nbsp;</div></li><li><div>              'usermeta' =&gt; $bb-&gt;wp_table_prefix . 'usermeta'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( !isset( $bb-&gt;custom_tables['users'] ) ) { <span class="comment"><span class="comment"><span class="comment">// Don't stomp new setting style</span></span></span>&nbsp;</div></li><li><div>              $bb-&gt;custom_tables['users'] = $bb-&gt;wp_table_prefix . 'users';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( !isset( $bb-&gt;custom_tables['usermeta'] ) ) {&nbsp;</div></li><li><div>              $bb-&gt;custom_tables['usermeta'] = $bb-&gt;wp_table_prefix . 'usermeta';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bb_get_option( 'wordpress_mu_primary_blog_id' ) ) {&nbsp;</div></li><li><div>      $bb-&gt;wordpress_mu_primary_blog_id = bb_get_option( 'wordpress_mu_primary_blog_id' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for older style user database</span>&nbsp;</div></li><li><div>  if ( !isset( $bb-&gt;custom_databases ) ) {&nbsp;</div></li><li><div>      $bb-&gt;custom_databases = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( !isset( $bb-&gt;custom_databases['user'] ) ) {&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_name = bb_get_option( 'user_bbdb_name' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['name'] = $bb-&gt;user_bbdb_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_user = bb_get_option( 'user_bbdb_user' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['user'] = $bb-&gt;user_bbdb_user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_password = bb_get_option( 'user_bbdb_password' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['password'] = $bb-&gt;user_bbdb_password;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_host = bb_get_option( 'user_bbdb_host' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['host'] = $bb-&gt;user_bbdb_host;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_charset = bb_get_option( 'user_bbdb_charset' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['charset'] = $bb-&gt;user_bbdb_charset;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb-&gt;user_bbdb_collate = bb_get_option( 'user_bbdb_collate' ) ) {&nbsp;</div></li><li><div>          $bb-&gt;custom_databases['user']['collate'] = $bb-&gt;user_bbdb_collate;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( isset( $bb-&gt;custom_databases['user'] ) ) {&nbsp;</div></li><li><div>          if ( isset( $bb-&gt;custom_tables['users'] ) ) {&nbsp;</div></li><li><div>              $bb-&gt;custom_tables['users'] = array( 'user', $bb-&gt;custom_tables['users'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( isset( $bb-&gt;custom_tables['usermeta'] ) ) {&nbsp;</div></li><li><div>              $bb-&gt;custom_tables['usermeta'] = array( 'user', $bb-&gt;custom_tables['usermeta'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Pagination */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve paginated links for pages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Technically, the function can be used to create paginated link list for any</span>&nbsp;</div></li><li><div><span class="comment"> * area. The 'base' argument is used to reference the url, which will be used to</span>&nbsp;</div></li><li><div><span class="comment"> * create the paginated links. The 'format' argument is then used for replacing</span>&nbsp;</div></li><li><div><span class="comment"> * the page number. It is however, most likely and by default, to be used on the</span>&nbsp;</div></li><li><div><span class="comment"> * archive post pages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The 'type' argument controls format of the returned value. The default is</span>&nbsp;</div></li><li><div><span class="comment"> * 'plain', which is just a string with the links separated by a newline</span>&nbsp;</div></li><li><div><span class="comment"> * character. The other possible values are either 'array' or 'list'. The</span>&nbsp;</div></li><li><div><span class="comment"> * 'array' value will return an array of the paginated link list to offer full</span>&nbsp;</div></li><li><div><span class="comment"> * control of display. The 'list' value will place all of the paginated links in</span>&nbsp;</div></li><li><div><span class="comment"> * an unordered HTML list.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The 'total' argument is the total amount of pages and is an integer. The</span>&nbsp;</div></li><li><div><span class="comment"> * 'current' argument is the current page number and is also an integer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * An example of the 'base' argument is &quot;http://example.com/all_posts.php%_%&quot;</span>&nbsp;</div></li><li><div><span class="comment"> * and the '%_%' is required. The '%_%' will be replaced by the contents of in</span>&nbsp;</div></li><li><div><span class="comment"> * the 'format' argument. An example for the 'format' argument is &quot;?page=%#%&quot;</span>&nbsp;</div></li><li><div><span class="comment"> * and the '%#%' is also required. The '%#%' will be replaced with the page</span>&nbsp;</div></li><li><div><span class="comment"> * number.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You can include the previous and next links in the list by setting the</span>&nbsp;</div></li><li><div><span class="comment"> * 'prev_next' argument to true, which it is by default. You can set the</span>&nbsp;</div></li><li><div><span class="comment"> * previous text, by using the 'prev_text' argument. You can set the next text</span>&nbsp;</div></li><li><div><span class="comment"> * by setting the 'next_text' argument.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the 'show_all' argument is set to true, then it will show all of the pages</span>&nbsp;</div></li><li><div><span class="comment"> * instead of a short list of the pages near the current page. By default, the</span>&nbsp;</div></li><li><div><span class="comment"> * 'show_all' is set to false and controlled by the 'end_size' and 'mid_size'</span>&nbsp;</div></li><li><div><span class="comment"> * arguments. The 'end_size' argument is how many numbers on either the start</span>&nbsp;</div></li><li><div><span class="comment"> * and the end list edges, by default is 1. The 'mid_size' argument is how many</span>&nbsp;</div></li><li><div><span class="comment"> * numbers to either side of current page, but not including current page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * It is possible to add query vars to the link by using the 'add_args' argument</span>&nbsp;</div></li><li><div><span class="comment"> * and see {@link add_query_arg()} for more information.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $args Optional. Override defaults.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|string String of page links or array of page links.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_paginate_links( $args = '' ) {&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'base' =&gt; '%_%', <span class="comment">// http://example.com/all_posts.php%_% : %_% is replaced by format (below)</span>&nbsp;</div></li><li><div>      'format' =&gt; '?page=%#%', <span class="comment">// ?page=%#% : %#% is replaced by the page number</span>&nbsp;</div></li><li><div>      'total' =&gt; 1, &nbsp;</div></li><li><div>      'current' =&gt; 0, &nbsp;</div></li><li><div>      'show_all' =&gt; false, &nbsp;</div></li><li><div>      'prev_next' =&gt; true, &nbsp;</div></li><li><div>      'prev_text' =&gt; __( '&laquo; Previous' ), &nbsp;</div></li><li><div>      'next_text' =&gt; __( 'Next &raquo;' ), &nbsp;</div></li><li><div>      'end_size' =&gt; 1, <span class="comment">// How many numbers on either end including the end</span>&nbsp;</div></li><li><div>      'mid_size' =&gt; 2, <span class="comment">// How many numbers to either side of current not including current</span>&nbsp;</div></li><li><div>      'type' =&gt; 'plain', &nbsp;</div></li><li><div>      'add_args' =&gt; false, <span class="comment">// array of query args to add</span>&nbsp;</div></li><li><div>      'add_fragment' =&gt; '', &nbsp;</div></li><li><div>      'n_title' =&gt; __( 'Page %d' ), <span class="comment"><span class="comment"><span class="comment">// Not from WP version</span></span></span>&nbsp;</div></li><li><div>      'prev_title' =&gt; __( 'Previous page' ), <span class="comment"><span class="comment"><span class="comment">// Not from WP version</span></span></span>&nbsp;</div></li><li><div>      'next_title' =&gt; __( 'Next page' ) <span class="comment"><span class="comment"><span class="comment">// Not from WP version</span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Who knows what else people pass in $args</span>&nbsp;</div></li><li><div>  $total = (int) $total;&nbsp;</div></li><li><div>  if ( $total &lt; 2 )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  $current = (int) $current;&nbsp;</div></li><li><div>  $end_size = 0 &lt; (int) $end_size ? (int) $end_size : 1; <span class="comment">// Out of bounds?  Make it the default.</span>&nbsp;</div></li><li><div>  $mid_size = 0 &lt;= (int) $mid_size ? (int) $mid_size : 2;&nbsp;</div></li><li><div>  $add_args = is_array($add_args) ? $add_args : false;&nbsp;</div></li><li><div>  $r = '';&nbsp;</div></li><li><div>  $page_links = array();&nbsp;</div></li><li><div>  $n = 0;&nbsp;</div></li><li><div>  $dots = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $empty_format = '';&nbsp;</div></li><li><div>  if ( strpos( $format, '?' ) === 0 ) {&nbsp;</div></li><li><div>      $empty_format = '?';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $prev_next && $current && 1 &lt; $current ) {&nbsp;</div></li><li><div>      $link = str_replace( '%_%', 2 == $current ? $empty_format : $format, $base );&nbsp;</div></li><li><div>      $link = str_replace( '%#%', $current - 1, $link );&nbsp;</div></li><li><div>      $link = str_replace( '?&', '?', $link );&nbsp;</div></li><li><div>      if ( $add_args )&nbsp;</div></li><li><div>          $link = add_query_arg( $add_args, $link );&nbsp;</div></li><li><div>      $link .= $add_fragment;&nbsp;</div></li><li><div>      $page_links[] = '&lt;a class=&quot;prev page-numbers&quot; href=&quot;' . esc_url( $link ) . '&quot; title=&quot;' . esc_attr( $prev_title ) . '&quot;&gt;' . $prev_text . '&lt;/a&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  for ( $n = 1; $n &lt;= $total; $n++ ) {&nbsp;</div></li><li><div>      if ( $n == $current ) {&nbsp;</div></li><li><div>          $n_display = bb_number_format_i18n( $n );&nbsp;</div></li><li><div>          $n_display_title =  esc_attr( sprintf( $n_title, $n ) );&nbsp;</div></li><li><div>          $page_links[] = '&lt;span class=&quot;page-numbers current&quot; title=&quot;' . $n_display_title . '&quot;&gt;' . $n_display . '&lt;/span&gt;';&nbsp;</div></li><li><div>          $dots = true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $show_all || ( $n &lt;= $end_size || ( $current && $n &gt;= $current - $mid_size && $n &lt;= $current + $mid_size ) || $n &gt; $total - $end_size ) ) {&nbsp;</div></li><li><div>              $n_display = bb_number_format_i18n( $n );&nbsp;</div></li><li><div>              $n_display_title =  esc_attr( sprintf( $n_title, $n ) );&nbsp;</div></li><li><div>              $link = str_replace( '%_%', 1 == $n ? $empty_format : $format, $base );&nbsp;</div></li><li><div>              $link = str_replace( '%#%', $n, $link );&nbsp;</div></li><li><div>              $link = str_replace( '?&', '?', $link );&nbsp;</div></li><li><div>              if ( $add_args )&nbsp;</div></li><li><div>                  $link = add_query_arg( $add_args, $link );&nbsp;</div></li><li><div>              $link .= $add_fragment;&nbsp;</div></li><li><div>              $page_links[] = '&lt;a class=&quot;page-numbers&quot; href=&quot;' . esc_url( $link ) . '&quot; title=&quot;' . $n_display_title . '&quot;&gt;' . $n_display . '&lt;/a&gt;';&nbsp;</div></li><li><div>              $dots = true;&nbsp;</div></li><li><div>          } elseif ( $dots && !$show_all ) {&nbsp;</div></li><li><div>              $page_links[] = '&lt;span class=&quot;page-numbers dots&quot;&gt;&hellip;&lt;/span&gt;';&nbsp;</div></li><li><div>              $dots = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( $prev_next && $current && ( $current &lt; $total || -1 == $total ) ) {&nbsp;</div></li><li><div>      $link = str_replace( '%_%', $format, $base );&nbsp;</div></li><li><div>      $link = str_replace( '%#%', $current + 1, $link );&nbsp;</div></li><li><div>      if ( $add_args )&nbsp;</div></li><li><div>          $link = add_query_arg( $add_args, $link );&nbsp;</div></li><li><div>      $link .= $add_fragment;&nbsp;</div></li><li><div>      $page_links[] = '&lt;a class=&quot;next page-numbers&quot; href=&quot;' . esc_url( $link ) . '&quot; title=&quot;' . esc_attr( $next_title ) . '&quot;&gt;' . $next_text . '&lt;/a&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  switch ( $type ) {&nbsp;</div></li><li><div>      case 'array':&nbsp;</div></li><li><div>          return $page_links;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'list':&nbsp;</div></li><li><div>          $r .= '&lt;ul class=&quot;page-numbers&quot;&gt;' . &quot;\n\t&quot; . '&lt;li&gt;';&nbsp;</div></li><li><div>          $r .= join( '&lt;/li&gt;' . &quot;\n\t&quot; . '&lt;li&gt;', $page_links );&nbsp;</div></li><li><div>          $r .= '&lt;/li&gt;' . &quot;\n&quot; . '&lt;/ul&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $r = join( &quot;\n&quot;, $page_links );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_uri_page() {&nbsp;</div></li><li><div>  if ( isset($_GET['page']) && is_numeric($_GET['page']) && 1 &lt; (int) $_GET['page'] )&nbsp;</div></li><li><div>      return (int) $_GET['page'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_SERVER['PATH_INFO']) )&nbsp;</div></li><li><div>      $path = $_SERVER['PATH_INFO'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      if ( !$path = strtok($_SERVER['REQUEST_URI'], '?') )&nbsp;</div></li><li><div>          return 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( '/^\/([0-9]+)\/?$/', $path, $matches ) ) {&nbsp;</div></li><li><div>      $page = (int) $matches[1];&nbsp;</div></li><li><div>      if ( 1 &lt; $page ) {&nbsp;</div></li><li><div>          return $page;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page = strstr($path, '/page/') ) {&nbsp;</div></li><li><div>      $page = (int) substr($page, 6);&nbsp;</div></li><li><div>      if ( 1 &lt; $page )&nbsp;</div></li><li><div>          return $page;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return 1;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//expects $item = 1 to be the first, not 0</span>&nbsp;</div></li><li><div>function bb_get_page_number( $item, $per_page = 0 ) {&nbsp;</div></li><li><div>  if ( !$per_page )&nbsp;</div></li><li><div>      $per_page = bb_get_option('page_topics');&nbsp;</div></li><li><div>  return intval( ceil( $item / $per_page ) ); <span class="comment">// page 1 is the first page</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Time */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_timer_stop($display = 0, $precision = 3) { <span class="comment">//if called like bb_timer_stop(1), will echo $timetotal</span>&nbsp;</div></li><li><div>  global $bb_timestart, $timeend;&nbsp;</div></li><li><div>  $mtime = explode(' ', microtime());&nbsp;</div></li><li><div>  $timeend = $mtime[1] + $mtime[0];&nbsp;</div></li><li><div>  $timetotal = $timeend - $bb_timestart;&nbsp;</div></li><li><div>  if ($display)&nbsp;</div></li><li><div>      echo bb_number_format_i18n($timetotal, $precision);&nbsp;</div></li><li><div>  return bb_number_format_i18n($timetotal, $precision);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// GMT -&gt; so many minutes ago</span>&nbsp;</div></li><li><div>function bb_since( $original, $args = '' )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'levels' =&gt; 1, &nbsp;</div></li><li><div>      'separator' =&gt; ', '&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// $args used to be $do_more</span>&nbsp;</div></li><li><div>  <span class="comment">// $do_more = 0 is equivalent to $args['levels'] = 1</span>&nbsp;</div></li><li><div>  <span class="comment">// $do_more = 1 is equivalent to $args['levels'] = 2</span>&nbsp;</div></li><li><div>  if ( !is_array( $args ) ) {&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'levels' =&gt; abs( (integer) $args ) + 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $today = (integer) time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_numeric( $original ) ) {&nbsp;</div></li><li><div>      if ( $today &lt; $_original = bb_gmtstrtotime( str_replace( ', ', ' ', $original ) ) ) { <span class="comment">// Looks like bb_since was called twice</span>&nbsp;</div></li><li><div>          return $original;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $original = $_original;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $seconds = $today - ( (integer) $original );&nbsp;</div></li><li><div>  if ( 0 === $seconds ) {&nbsp;</div></li><li><div>      return sprintf( _n( '%d second', '%d seconds', 0 ), 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $levels = abs( (integer) $levels );&nbsp;</div></li><li><div>  if ( 0 === $levels ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// array of time period chunks</span>&nbsp;</div></li><li><div>  $chunks = array(&nbsp;</div></li><li><div>      ( 60 * 60 * 24 * 365 ), <span class="comment">// years</span>&nbsp;</div></li><li><div>      ( 60 * 60 * 24 * 30 ), <span class="comment">// months</span>&nbsp;</div></li><li><div>      ( 60 * 60 * 24 * 7 ), <span class="comment">// weeks</span>&nbsp;</div></li><li><div>      ( 60 * 60 * 24 ), <span class="comment">// days</span>&nbsp;</div></li><li><div>      ( 60 * 60 ), <span class="comment">// hours</span>&nbsp;</div></li><li><div>      ( 60 ), <span class="comment">// minutes</span>&nbsp;</div></li><li><div>      ( 1 )                   <span class="comment">// seconds</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $caught = 0;&nbsp;</div></li><li><div>  $parts = array();&nbsp;</div></li><li><div>  for ( $i = 0; $i &lt; count( $chunks ); $i++ ) {&nbsp;</div></li><li><div>      if ( ( $count = floor( $seconds / $chunks[$i] ) ) || $caught ) {&nbsp;</div></li><li><div>          if ( $count ) {&nbsp;</div></li><li><div>              $trans = array(&nbsp;</div></li><li><div>                  _n( '%d year', '%d years', $count ), &nbsp;</div></li><li><div>                  _n( '%d month', '%d months', $count ), &nbsp;</div></li><li><div>                  _n( '%d week', '%d weeks', $count ), &nbsp;</div></li><li><div>                  _n( '%d day', '%d days', $count ), &nbsp;</div></li><li><div>                  _n( '%d hour', '%d hours', $count ), &nbsp;</div></li><li><div>                  _n( '%d minute', '%d minutes', $count ), &nbsp;</div></li><li><div>                  _n( '%d second', '%d seconds', $count )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $parts[] = sprintf( $trans[$i], $count );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $caught++;&nbsp;</div></li><li><div>          $seconds = $seconds - ( $count * $chunks[$i] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $caught === $levels ) {&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $parts ) ) {&nbsp;</div></li><li><div>      return sprintf( _n( '%d second', '%d seconds', 0 ), 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return join( $separator, $parts );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_current_time( $type = 'timestamp' ) {&nbsp;</div></li><li><div>  return current_time( $type, true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// GMT -&gt; Local</span>&nbsp;</div></li><li><div><span class="comment">// in future versions this could eaily become a user option.</span>&nbsp;</div></li><li><div>function bb_offset_time( $time, $args = null ) {&nbsp;</div></li><li><div>  if ( isset($args['format']) && 'since' == $args['format'] )&nbsp;</div></li><li><div>      return $time;&nbsp;</div></li><li><div>  if ( !is_numeric($time) ) {&nbsp;</div></li><li><div>      if ( -1 !== $_time = bb_gmtstrtotime( $time ) )&nbsp;</div></li><li><div>          return gmdate('Y-m-d H:i:s', $_time + bb_get_option( 'gmt_offset' ) * 3600);&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $time; <span class="comment">// Perhaps should return -1 here</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $time + bb_get_option( 'gmt_offset' ) * 3600;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Permalinking / URLs / Paths */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BB_URI_CONTEXT_* - Bitwise definitions for bb_uri() and bb_get_uri() contexts</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_NONE', 0 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_HEADER', 1 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_TEXT', 2 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_A_HREF', 4 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_FORM_ACTION', 8 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_IMG_SRC', 16 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_LINK_STYLESHEET_HREF', 32 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_LINK_ALTERNATE_HREF', 64 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_LINK_OTHER', 128 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_SCRIPT_SRC', 256 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_IFRAME_SRC', 512 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_BB_FEED', 1024 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_BB_USER_FORMS', 2048 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_BB_ADMIN', 4096 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_BB_XMLRPC', 8192 );&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_WP_HTTP_REQUEST', 16384 );&nbsp;</div></li><li><div><span class="comment">//define( 'BB_URI_CONTEXT_*', 32768 );  // Reserved for future definitions</span>&nbsp;</div></li><li><div><span class="comment">//define( 'BB_URI_CONTEXT_*', 65536 );  // Reserved for future definitions</span>&nbsp;</div></li><li><div><span class="comment">//define( 'BB_URI_CONTEXT_*', 131072 ); // Reserved for future definitions</span>&nbsp;</div></li><li><div><span class="comment">//define( 'BB_URI_CONTEXT_*', 262144 ); // Reserved for future definitions</span>&nbsp;</div></li><li><div>define( 'BB_URI_CONTEXT_AKISMET', 524288 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Echo a URI based on the URI setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param $resource string The directory, may include a querystring</span>&nbsp;</div></li><li><div><span class="comment"> * @param $query mixed The query arguments as a querystring or an associative array</span>&nbsp;</div></li><li><div><span class="comment"> * @param $context integer The context of the URI, use BB_URI_CONTEXT_*</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_uri( $resource = null, $query = null, $context = BB_URI_CONTEXT_A_HREF )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  echo apply_filters( 'bb_uri', bb_get_uri( $resource, $query, $context ), $resource, $query, $context );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return a URI based on the URI setting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param $resource string The directory, may include a querystring</span>&nbsp;</div></li><li><div><span class="comment"> * @param $query mixed The query arguments as a querystring or an associative array</span>&nbsp;</div></li><li><div><span class="comment"> * @param $context integer The context of the URI, use BB_URI_CONTEXT_*</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The complete URI</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_get_uri( $resource = null, $query = null, $context = BB_URI_CONTEXT_A_HREF )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// If there is a querystring in the resource then extract it</span>&nbsp;</div></li><li><div>  if ( $resource && strpos( $resource, '?' ) !== false ) {&nbsp;</div></li><li><div>      list( $_resource, $_query ) = explode( '?', trim( $resource ), 2 );&nbsp;</div></li><li><div>      $resource = $_resource;&nbsp;</div></li><li><div>      $_query = wp_parse_args( $_query );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Make sure $_query is an array for array_merge()</span>&nbsp;</div></li><li><div>      $_query = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// $query can be an array as well as a string</span>&nbsp;</div></li><li><div>  if ( $query ) {&nbsp;</div></li><li><div>      if ( is_string( $query ) ) {&nbsp;</div></li><li><div>          $query = ltrim( trim( $query ), '?' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $query = wp_parse_args( $query );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure $query is an array for array_merge()</span>&nbsp;</div></li><li><div>  if ( !$query ) {&nbsp;</div></li><li><div>      $query = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge the queries into a single array</span>&nbsp;</div></li><li><div>  $query = array_merge( $_query, $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure context is an integer</span>&nbsp;</div></li><li><div>  if ( !$context || !is_integer( $context ) ) {&nbsp;</div></li><li><div>      $context = BB_URI_CONTEXT_A_HREF;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the base URI</span>&nbsp;</div></li><li><div>  static $_uri;&nbsp;</div></li><li><div>  if( !isset( $_uri ) ) {&nbsp;</div></li><li><div>      $_uri = bb_get_option( 'uri' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $uri = $_uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use https?</span>&nbsp;</div></li><li><div>  if (&nbsp;</div></li><li><div>      ( ( $context & BB_URI_CONTEXT_BB_USER_FORMS ) && force_ssl_login() ) <span class="comment">// Force https when required on user forms</span>&nbsp;</div></li><li><div>  ||&nbsp;</div></li><li><div>      ( ( $context & BB_URI_CONTEXT_BB_ADMIN ) && force_ssl_admin() ) <span class="comment">// Force https when required in admin</span>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>      static $_uri_ssl;&nbsp;</div></li><li><div>      if( !isset( $_uri_ssl ) ) {&nbsp;</div></li><li><div>          $_uri_ssl = bb_get_option( 'uri_ssl' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $uri = $_uri_ssl;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the directory</span>&nbsp;</div></li><li><div>  $uri .= ltrim( $resource, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the query string to the URI</span>&nbsp;</div></li><li><div>  $uri = add_query_arg( $query, $uri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bb_get_uri', $uri, $resource, $context );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Forces redirection to an SSL page when required</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_ssl_redirect()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $page = bb_get_location();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bb_ssl_redirect' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( BB_IS_ADMIN ) {&nbsp;</div></li><li><div>      if ( !force_ssl_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      switch ( $page ) {&nbsp;</div></li><li><div>          case 'login-page':&nbsp;</div></li><li><div>          case 'register-page':&nbsp;</div></li><li><div>              if ( !force_ssl_login() ) {&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'profile-page':&nbsp;</div></li><li><div>              global $self;&nbsp;</div></li><li><div>              if ( $self == 'profile-edit.php' ) {&nbsp;</div></li><li><div>                  if ( !force_ssl_login() ) {&nbsp;</div></li><li><div>                      return;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_ssl() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $uri_ssl = parse_url( bb_get_option( 'uri_ssl' ) );&nbsp;</div></li><li><div>  $uri = $uri_ssl['scheme'] . ':<span class="comment">//' . $uri_ssl['host'] . $_SERVER['REQUEST_URI'];</span>&nbsp;</div></li><li><div>  bb_safe_redirect( $uri );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_path( $level = 1, $base = false, $request = false ) {&nbsp;</div></li><li><div>  if ( !$request )&nbsp;</div></li><li><div>      $request = $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>  if ( is_string($request) )&nbsp;</div></li><li><div>      $request = parse_url($request);&nbsp;</div></li><li><div>  if ( !is_array($request) || !isset($request['path']) )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $path = rtrim($request['path'], &quot; \t\n\r\0\x0B/&quot;);&nbsp;</div></li><li><div>  if ( !$base )&nbsp;</div></li><li><div>      $base = rtrim(bb_get_option('path'), &quot; \t\n\r\0\x0B/&quot;);&nbsp;</div></li><li><div>  $path = preg_replace('|' . preg_quote($base, '|') . '/?|', '', $path, 1);&nbsp;</div></li><li><div>  if ( !$path )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  if ( strpos($path, '/') === false )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = explode('/', $path);&nbsp;</div></li><li><div>  if ( !isset($url[$level]) )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return urldecode($url[$level]);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_find_filename( $text ) {&nbsp;</div></li><li><div>  if ( preg_match('|.*?/([a-z\-]+\.php)/?.*|', $text, $matches) )&nbsp;</div></li><li><div>      return $matches[1];&nbsp;</div></li><li><div>  else {&nbsp;</div></li><li><div>      $path = bb_get_option( 'path' );&nbsp;</div></li><li><div>      $text = preg_replace(&quot;#^$path#&quot;, '', $text);&nbsp;</div></li><li><div>      $text = preg_replace('#/.+$#', '', $text);&nbsp;</div></li><li><div>      return $text . '.php';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_send_headers() {&nbsp;</div></li><li><div>  if ( bb_is_user_logged_in() )&nbsp;</div></li><li><div>      nocache_headers();&nbsp;</div></li><li><div>  @header('Content-Type: ' . bb_get_option( 'html_type' ) . '; charset=' . bb_get_option( 'charset' ));&nbsp;</div></li><li><div>  do_action( 'bb_send_headers' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_pingback_header() {&nbsp;</div></li><li><div>  if (bb_get_option('enable_pingback'))&nbsp;</div></li><li><div>      @header('X-Pingback: '. bb_get_uri('xmlrpc.php', null, BB_URI_CONTEXT_HEADER + BB_URI_CONTEXT_BB_XMLRPC));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Inspired by and adapted from Yung-Lung Scott YANG's http://scott.yang.id.au/2005/05/permalink-redirect/ (GPL)</span>&nbsp;</div></li><li><div>function bb_repermalink() {&nbsp;</div></li><li><div>  global $page;&nbsp;</div></li><li><div>  $location = bb_get_location();&nbsp;</div></li><li><div>  $uri = $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>  if ( isset($_GET['id']) )&nbsp;</div></li><li><div>      $id = $_GET['id'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = bb_get_path();&nbsp;</div></li><li><div>  $_original_id = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'pre_permalink', $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = apply_filters( 'bb_repermalink', $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ($location) {&nbsp;</div></li><li><div>      case 'front-page':&nbsp;</div></li><li><div>          $path = null;&nbsp;</div></li><li><div>          $querystring = null;&nbsp;</div></li><li><div>          if ($page &gt; 1) {&nbsp;</div></li><li><div>              if (bb_get_option( 'mod_rewrite' )) {&nbsp;</div></li><li><div>                  $path = 'page/' . $page;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $querystring = array('page' =&gt; $page);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $permalink = bb_get_uri($path, $querystring, BB_URI_CONTEXT_HEADER);&nbsp;</div></li><li><div>          $issue_404 = true;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'forum-page':&nbsp;</div></li><li><div>          if (empty($id)) {&nbsp;</div></li><li><div>              $permalink = bb_get_uri(null, null, BB_URI_CONTEXT_HEADER);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          global $forum_id, $forum;&nbsp;</div></li><li><div>          $forum = bb_get_forum( $id );&nbsp;</div></li><li><div>          $forum_id = $forum-&gt;forum_id;&nbsp;</div></li><li><div>          $permalink = get_forum_link( $forum-&gt;forum_id, $page );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'topic-edit-page':&nbsp;</div></li><li><div>      case 'topic-page':&nbsp;</div></li><li><div>          if (empty($id)) {&nbsp;</div></li><li><div>              $permalink = bb_get_uri(null, null, BB_URI_CONTEXT_HEADER);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          global $topic_id, $topic;&nbsp;</div></li><li><div>          $topic = get_topic( $id );&nbsp;</div></li><li><div>          $topic_id = $topic-&gt;topic_id;&nbsp;</div></li><li><div>          $permalink = get_topic_link( $topic-&gt;topic_id, $page );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'profile-page': <span class="comment">// This handles the admin side of the profile as well.</span>&nbsp;</div></li><li><div>          global $user_id, $user, $profile_hooks, $self;&nbsp;</div></li><li><div>          if ( isset($_GET['id']) )&nbsp;</div></li><li><div>              $id = $_GET['id'];&nbsp;</div></li><li><div>          elseif ( isset($_GET['username']) )&nbsp;</div></li><li><div>              $id = $_GET['username'];&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $id = bb_get_path();&nbsp;</div></li><li><div>          $_original_id = $id;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( !$id ) {&nbsp;</div></li><li><div>              $user = bb_get_current_user(); <span class="comment">// Attempt to go to the current users profile</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( bb_get_option( 'mod_rewrite' ) === 'slugs') {&nbsp;</div></li><li><div>                  if ( !$user = bb_get_user_by_nicename( $id ) ) {&nbsp;</div></li><li><div>                      $user = bb_get_user( $id );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ( !$user = bb_get_user( $id ) ) {&nbsp;</div></li><li><div>                      $user = bb_get_user_by_nicename( $id );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$user || ( 1 == $user-&gt;user_status && !bb_current_user_can( 'moderate' ) ) )&nbsp;</div></li><li><div>              bb_die(__('User not found.'), '', 404);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $user_id = $user-&gt;ID;&nbsp;</div></li><li><div>          bb_global_profile_menu_structure();&nbsp;</div></li><li><div>          $valid = false;&nbsp;</div></li><li><div>          if ( $tab = isset($_GET['tab']) ? $_GET['tab'] : bb_get_path(2) ) {&nbsp;</div></li><li><div>              foreach ( $profile_hooks as $valid_tab =&gt; $valid_file ) {&nbsp;</div></li><li><div>                  if ( $tab == $valid_tab ) {&nbsp;</div></li><li><div>                      $valid = true;&nbsp;</div></li><li><div>                      $self = $valid_file;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $valid ) {&nbsp;</div></li><li><div>              $permalink = get_profile_tab_link( $user-&gt;ID, $tab, $page );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $permalink = get_user_profile_link( $user-&gt;ID, $page );&nbsp;</div></li><li><div>              unset($self, $tab);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'favorites-page':&nbsp;</div></li><li><div>          $permalink = get_favorites_link();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'tag-page': <span class="comment">// It's not an integer and tags.php pulls double duty.</span>&nbsp;</div></li><li><div>          $id = ( isset($_GET['tag']) ) ? $_GET['tag'] : false;&nbsp;</div></li><li><div>          if ( ! $id || ! bb_get_tag( (string) $id ) )&nbsp;</div></li><li><div>              $permalink = bb_get_tag_page_link();&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              global $tag, $tag_name;&nbsp;</div></li><li><div>              $tag_name = $id;&nbsp;</div></li><li><div>              $tag = bb_get_tag( (string) $id );&nbsp;</div></li><li><div>              $permalink = bb_get_tag_link( 0, $page ); <span class="comment">// 0 =&gt; grabs $tag from global.</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'view-page': <span class="comment">// Not an integer</span>&nbsp;</div></li><li><div>          if ( isset($_GET['view']) )&nbsp;</div></li><li><div>              $id = $_GET['view'];&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $id = bb_get_path();&nbsp;</div></li><li><div>          $_original_id = $id;&nbsp;</div></li><li><div>          global $view;&nbsp;</div></li><li><div>          $view = $id;&nbsp;</div></li><li><div>          $permalink = get_view_link( $view, $page );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  wp_parse_str($_SERVER['QUERY_STRING'], $args);&nbsp;</div></li><li><div>  $args = urlencode_deep($args);&nbsp;</div></li><li><div>  if ( $args ) {&nbsp;</div></li><li><div>      $permalink = add_query_arg($args, $permalink);&nbsp;</div></li><li><div>      if ( bb_get_option('mod_rewrite') ) {&nbsp;</div></li><li><div>          $pretty_args = array('id', 'page', 'tag', 'tab', 'username'); <span class="comment">// these are already specified in the path</span>&nbsp;</div></li><li><div>          if ( $location == 'view-page' )&nbsp;</div></li><li><div>              $pretty_args[] = 'view';&nbsp;</div></li><li><div>          foreach ( $pretty_args as $pretty_arg )&nbsp;</div></li><li><div>              $permalink = remove_query_arg( $pretty_arg, $permalink );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $permalink = apply_filters( 'bb_repermalink_result', $permalink, $location );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $domain = bb_get_option('domain');&nbsp;</div></li><li><div>  $domain = preg_replace('/^https?/', '', $domain);&nbsp;</div></li><li><div>  $check = preg_replace( '|^.*' . trim($domain, ' /' ) . '|', '', $permalink, 1 );&nbsp;</div></li><li><div>  $uri = rtrim( $uri, &quot; \t\n\r\0\x0B?&quot; );&nbsp;</div></li><li><div>  $uri = str_replace( '/index.php', '/', $uri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $bb_log;&nbsp;</div></li><li><div>  $bb_log-&gt;debug($uri, 'bb_repermalink() ' . __('REQUEST_URI'));&nbsp;</div></li><li><div>  $bb_log-&gt;debug($check, 'bb_repermalink() ' . __('should be'));&nbsp;</div></li><li><div>  $bb_log-&gt;debug($permalink, 'bb_repermalink() ' . __('full permalink'));&nbsp;</div></li><li><div>  $bb_log-&gt;debug(isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : null, 'bb_repermalink() ' . __('PATH_INFO'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $check != $uri && $check != str_replace(urlencode($_original_id), $_original_id, $uri) ) {&nbsp;</div></li><li><div>      if ( $issue_404 && rtrim( $check, &quot; \t\n\r\0\x0B/&quot; ) !== rtrim( $uri, &quot; \t\n\r\0\x0B/&quot; ) ) {&nbsp;</div></li><li><div>          status_header( 404 );&nbsp;</div></li><li><div>          bb_load_template( '404.php' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_redirect( $permalink );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'post_permalink', $permalink );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Profile/Admin */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_global_profile_menu_structure() {&nbsp;</div></li><li><div>  global $user_id, $profile_menu, $profile_hooks;&nbsp;</div></li><li><div>  <span class="comment">// Menu item name</span>&nbsp;</div></li><li><div>  <span class="comment">// The capability required for own user to view the tab ('' to allow non logged in access)</span>&nbsp;</div></li><li><div>  <span class="comment">// The capability required for other users to view the tab ('' to allow non logged in access)</span>&nbsp;</div></li><li><div>  <span class="comment">// The URL of the item's file</span>&nbsp;</div></li><li><div>  <span class="comment">// Item name for URL (nontranslated)</span>&nbsp;</div></li><li><div>  $profile_menu[0] = array(__('Edit'), 'edit_profile', 'edit_users', 'profile-edit.php', 'edit');&nbsp;</div></li><li><div>  $profile_menu[5] = array(__('Favorites'), '', '', 'favorites.php', 'favorites');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create list of page plugin hook names the current user can access</span>&nbsp;</div></li><li><div>  $profile_hooks = array();&nbsp;</div></li><li><div>  foreach ($profile_menu as $profile_tab)&nbsp;</div></li><li><div>      if ( bb_can_access_tab( $profile_tab, bb_get_current_user_info( 'id' ), $user_id ) )&nbsp;</div></li><li><div>          $profile_hooks[bb_sanitize_with_dashes($profile_tab[4])] = $profile_tab[3];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action('bb_profile_menu');&nbsp;</div></li><li><div>  ksort($profile_menu);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_add_profile_tab($tab_title, $users_cap, $others_cap, $file, $arg = false) {&nbsp;</div></li><li><div>  global $profile_menu, $profile_hooks, $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $arg = $arg ? $arg : $tab_title;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $profile_tab = array($tab_title, $users_cap, $others_cap, $file, $arg);&nbsp;</div></li><li><div>  $profile_menu[] = $profile_tab;&nbsp;</div></li><li><div>  if ( bb_can_access_tab( $profile_tab, bb_get_current_user_info( 'id' ), $user_id ) )&nbsp;</div></li><li><div>      $profile_hooks[bb_sanitize_with_dashes($arg)] = $file;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_can_access_tab( $profile_tab, $viewer_id, $owner_id ) {&nbsp;</div></li><li><div>  global $bb_current_user;&nbsp;</div></li><li><div>  $viewer_id = (int) $viewer_id;&nbsp;</div></li><li><div>  $owner_id = (int) $owner_id;&nbsp;</div></li><li><div>  if ( $viewer_id == bb_get_current_user_info( 'id' ) )&nbsp;</div></li><li><div>      $viewer =& $bb_current_user;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $viewer = new BP_User( $viewer_id );&nbsp;</div></li><li><div>  if ( !$viewer )&nbsp;</div></li><li><div>      return '' === $profile_tab[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $owner_id == $viewer_id ) {&nbsp;</div></li><li><div>      if ( '' === $profile_tab[1] )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $viewer-&gt;has_cap($profile_tab[1]);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( '' === $profile_tab[2] )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $viewer-&gt;has_cap($profile_tab[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//meta_key =&gt; (required?, Label, hCard property).  Don't use user_{anything} as the name of your meta_key.</span>&nbsp;</div></li><li><div>function bb_get_profile_info_keys( $context = null ) {&nbsp;</div></li><li><div>  return apply_filters( 'get_profile_info_keys', array(&nbsp;</div></li><li><div>      'first_name' =&gt; array(0, __('First name')), &nbsp;</div></li><li><div>      'last_name' =&gt; array(0, __('Last name')), &nbsp;</div></li><li><div>      'display_name' =&gt; array(1, __('Display name as')), &nbsp;</div></li><li><div>      'user_email' =&gt; array(1, __('Email'), 'email'), &nbsp;</div></li><li><div>      'user_url' =&gt; array(0, __('Website'), 'url'), &nbsp;</div></li><li><div>      'from' =&gt; array(0, __('Location')), &nbsp;</div></li><li><div>      'occ' =&gt; array(0, __('Occupation'), 'role'), &nbsp;</div></li><li><div>      'interest' =&gt; array(0, __('Interests')), &nbsp;</div></li><li><div> ), $context );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_profile_admin_keys( $context = null ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  return apply_filters( 'get_profile_admin_keys', array(&nbsp;</div></li><li><div>      $bbdb-&gt;prefix . 'title' =&gt; array(0, __('Custom Title'))&nbsp;</div></li><li><div> ), $context );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_assignable_caps() {&nbsp;</div></li><li><div>  $caps = array();&nbsp;</div></li><li><div>  if ( $throttle_time = bb_get_option( 'throttle_time' ) )&nbsp;</div></li><li><div>      $caps['throttle'] = sprintf( __('Ignore the %d second post throttling limit'), $throttle_time );&nbsp;</div></li><li><div>  return apply_filters( 'get_assignable_caps', $caps );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Views */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_views() {&nbsp;</div></li><li><div>  global $bb_views;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $views = array();&nbsp;</div></li><li><div>  foreach ( (array) $bb_views as $view =&gt; $array )&nbsp;</div></li><li><div>      $views[$view] = $array['title'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $views;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_view( $view, $title, $query_args = '', $feed = TRUE ) {&nbsp;</div></li><li><div>  global $bb_views;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $view = bb_slug_sanitize( $view );&nbsp;</div></li><li><div>  $title = esc_html( $title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$view || !$title )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query_args = wp_parse_args( $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$sticky_set = isset($query_args['sticky']) )&nbsp;</div></li><li><div>      $query_args['sticky'] = 'no';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_views[$view]['title'] = $title;&nbsp;</div></li><li><div>  $bb_views[$view]['query'] = $query_args;&nbsp;</div></li><li><div>  $bb_views[$view]['sticky'] = !$sticky_set; <span class="comment">// No sticky set =&gt; split into stickies and not</span>&nbsp;</div></li><li><div>  $bb_views[$view]['feed'] = $feed;&nbsp;</div></li><li><div>  return $bb_views[$view];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_deregister_view( $view ) {&nbsp;</div></li><li><div>  global $bb_views;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $view = bb_slug_sanitize( $view );&nbsp;</div></li><li><div>  if ( !isset($bb_views[$view]) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset($GLOBALS['bb_views'][$view]);&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_view_query( $view, $new_args = '' ) {&nbsp;</div></li><li><div>  global $bb_views;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $view = bb_slug_sanitize( $view );&nbsp;</div></li><li><div>  if ( !isset($bb_views[$view]) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $new_args ) {&nbsp;</div></li><li><div>      $new_args = wp_parse_args( $new_args );&nbsp;</div></li><li><div>      $query_args = array_merge( $bb_views[$view]['query'], $new_args );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $query_args = $bb_views[$view]['query'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return new BB_Query( 'topic', $query_args, &quot;bb_view_$view&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_view_query_args( $view ) {&nbsp;</div></li><li><div>  global $bb_views;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $view = bb_slug_sanitize( $view );&nbsp;</div></li><li><div>  if ( !isset($bb_views[$view]) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $bb_views[$view]['query'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_default_views() {&nbsp;</div></li><li><div>  <span class="comment">// no posts (besides the first one), older than 2 hours</span>&nbsp;</div></li><li><div>  bb_register_view( 'no-replies', __('Topics with no replies'), array( 'post_count' =&gt; 1, 'started' =&gt; '&lt;' . gmdate( 'YmdH', time() - 7200 ) ) );&nbsp;</div></li><li><div>  bb_register_view( 'untagged' , __('Topics with no tags') , array( 'tag_count' =&gt; 0 ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Feeds */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send status headers for clients supporting Conditional Get</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The function sends the Last-Modified and ETag headers for all clients. It</span>&nbsp;</div></li><li><div><span class="comment"> * then checks both the If-None-Match and If-Modified-Since headers to see if</span>&nbsp;</div></li><li><div><span class="comment"> * the client has used them. If so, and the ETag does matches the client ETag</span>&nbsp;</div></li><li><div><span class="comment"> * or the last modified date sent by the client is newer or the same as the</span>&nbsp;</div></li><li><div><span class="comment"> * generated last modified, the function sends a 304 Not Modified and exits.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @link http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $bb_last_modified Last modified time. Must be a HTTP-date</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_send_304( $bb_last_modified ) {&nbsp;</div></li><li><div>  $bb_etag = '&quot;' . md5($bb_last_modified) . '&quot;';&nbsp;</div></li><li><div>  @header(&quot;Last-Modified: $bb_last_modified&quot;);&nbsp;</div></li><li><div>  @header(&quot;ETag: $bb_etag&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Support for Conditional GET</span>&nbsp;</div></li><li><div>  if (isset($_SERVER['HTTP_IF_NONE_MATCH'])) $client_etag = stripslashes($_SERVER['HTTP_IF_NONE_MATCH']);&nbsp;</div></li><li><div>  else $client_etag = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $client_last_modified = trim( $_SERVER['HTTP_IF_MODIFIED_SINCE']);&nbsp;</div></li><li><div>  <span class="comment">// If string is empty, return 0. If not, attempt to parse into a timestamp</span>&nbsp;</div></li><li><div>  $client_modified_timestamp = $client_last_modified ? bb_gmtstrtotime($client_last_modified) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make a timestamp for our most recent modification...    </span>&nbsp;</div></li><li><div>  $bb_modified_timestamp = bb_gmtstrtotime($bb_last_modified);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ($client_last_modified && $client_etag) ?&nbsp;</div></li><li><div>       (($client_modified_timestamp &gt;= $bb_modified_timestamp) && ($client_etag == $bb_etag)) :&nbsp;</div></li><li><div>       (($client_modified_timestamp &gt;= $bb_modified_timestamp) || ($client_etag == $bb_etag)) ) {&nbsp;</div></li><li><div>      status_header( 304 );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Nonce */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve URL with nonce added to URL query.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Security</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $actionurl URL to add nonce action</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Optional. Nonce action name</span>&nbsp;</div></li><li><div><span class="comment"> * @return string URL with nonce action added.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_nonce_url( $actionurl, $action = -1 ) {&nbsp;</div></li><li><div>  $actionurl = str_replace( '&amp;', '&', $actionurl );&nbsp;</div></li><li><div>  $nonce = bb_create_nonce( $action );&nbsp;</div></li><li><div>  return esc_html( add_query_arg( '_wpnonce', $nonce, $actionurl ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve or display nonce hidden field for forms.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The nonce field is used to validate that the contents of the form came from</span>&nbsp;</div></li><li><div><span class="comment"> * the location on the current site and not somewhere else. The nonce does not</span>&nbsp;</div></li><li><div><span class="comment"> * offer absolute protection, but should protect against most cases. It is very</span>&nbsp;</div></li><li><div><span class="comment"> * important to use nonce field in forms.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If you set $echo to true and set $referer to true, then you will need to</span>&nbsp;</div></li><li><div><span class="comment"> * retrieve the {@link wp_referer_field() wp referer field}. If you have the</span>&nbsp;</div></li><li><div><span class="comment"> * $referer set to true and are echoing the nonce field, it will also echo the</span>&nbsp;</div></li><li><div><span class="comment"> * referer field.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The $action and $name are optional, but if you want to have better security, </span>&nbsp;</div></li><li><div><span class="comment"> * it is strongly suggested to set those two parameters. It is easier to just</span>&nbsp;</div></li><li><div><span class="comment"> * call the function without any parameters, because validation of the nonce</span>&nbsp;</div></li><li><div><span class="comment"> * doesn't require any parameters, but since crackers know what the default is</span>&nbsp;</div></li><li><div><span class="comment"> * it won't be difficult for them to find a way around your nonce and cause</span>&nbsp;</div></li><li><div><span class="comment"> * damage.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The input name will be whatever $name value you gave. The input value will be</span>&nbsp;</div></li><li><div><span class="comment"> * the nonce creation value.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package bbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Security</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Optional. Action name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $name Optional. Nonce name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $referer Optional, default true. Whether to set the referer field for validation.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $echo Optional, default true. Whether to display or return hidden form field.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Nonce field.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_nonce_field( $action = -1, $name = &quot;_wpnonce&quot;, $referer = true , $echo = true ) {&nbsp;</div></li><li><div>  $name = esc_attr( $name );&nbsp;</div></li><li><div>  $nonce = bb_create_nonce( $action );&nbsp;</div></li><li><div>  $nonce_field = '&lt;input type=&quot;hidden&quot; id=&quot;' . $name . '&quot; name=&quot;' . $name . '&quot; value=&quot;' . $nonce . '&quot; /&gt;';&nbsp;</div></li><li><div>  if ( $echo )&nbsp;</div></li><li><div>      echo $nonce_field;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $referer )&nbsp;</div></li><li><div>      wp_referer_field( $echo, 'previous' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $nonce_field;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_nonce_ays( $action )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $title = __( 'bbPress Failure Notice' );&nbsp;</div></li><li><div>  $html .= &quot;\t&lt;div id='message' class='updated fade'&gt;\n\t&lt;p&gt;&quot; . esc_html( bb_explain_nonce( $action ) ) . &quot;&lt;/p&gt;\n\t&lt;p&gt;&quot;;&nbsp;</div></li><li><div>  if ( wp_get_referer() )&nbsp;</div></li><li><div>      $html .= &quot;&lt;a href='&quot; . remove_query_arg( 'updated', esc_url( wp_get_referer() ) ) . &quot;'&gt;&quot; . __( 'Please try again.' ) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>  $html .= &quot;&lt;/p&gt;\n\t&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  $html .= &quot;&lt;/body&gt;\n&lt;/html&gt;&quot;;&nbsp;</div></li><li><div>  bb_die( $html, $title );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_install_header( $title = '', $header = false, $logo = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( empty($title) )&nbsp;</div></li><li><div>      if ( function_exists('__') )&nbsp;</div></li><li><div>          $title = __('bbPress');&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $title = 'bbPress';&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $uri = false;&nbsp;</div></li><li><div>      if ( function_exists('bb_get_uri') && !BB_INSTALLING ) {&nbsp;</div></li><li><div>          $uri = bb_get_uri();&nbsp;</div></li><li><div>          $uri_stylesheet = bb_get_uri('bb-admin/install.css', null, BB_URI_CONTEXT_LINK_STYLESHEET_HREF + BB_URI_CONTEXT_BB_INSTALLER);&nbsp;</div></li><li><div>          $uri_stylesheet_rtl = bb_get_uri('bb-admin/install-rtl.css', null, BB_URI_CONTEXT_LINK_STYLESHEET_HREF + BB_URI_CONTEXT_BB_INSTALLER);&nbsp;</div></li><li><div>          $uri_logo = bb_get_uri('bb-admin/images/bbpress-logo.png', null, BB_URI_CONTEXT_IMG_SRC + BB_URI_CONTEXT_BB_INSTALLER);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if (!$uri) {&nbsp;</div></li><li><div>          $uri = preg_replace('|(/bb-admin)?/[^/]+?$|', '/', $_SERVER['PHP_SELF']);&nbsp;</div></li><li><div>          $uri_stylesheet = $uri . 'bb-admin/install.css';&nbsp;</div></li><li><div>          $uri_stylesheet_rtl = $uri . 'bb-admin/install-rtl.css';&nbsp;</div></li><li><div>          $uri_logo = $uri . 'bb-admin/images/bbpress-logo.png';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  header('Content-Type: text/html; charset=utf-8');&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;!DOCTYPE html PUBLIC &quot;-<span class="comment">//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>&nbsp;</div></li><li><div>&lt;html xmlns=&quot;http:<span class="comment">//www.w3.org/1999/xhtml&quot;&lt;?php if ( function_exists( 'bb_language_attributes' ) ) bb_language_attributes(); ?&gt;&gt;</span>&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&nbsp;</div></li><li><div>  &lt;title&gt;&lt;?php echo $title; ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>  &lt;meta name=&quot;robots&quot; content=&quot;noindex, nofollow&quot; /&gt;&nbsp;</div></li><li><div>  &lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php echo $uri_stylesheet; ?&gt;&quot; type=&quot;text/css&quot; /&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  if ( function_exists( 'bb_get_option' ) && 'rtl' == bb_get_option( 'text_direction' ) ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php echo $uri_stylesheet_rtl; ?&gt;&quot; type=&quot;text/css&quot; /&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;container&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  if ( $logo ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;logo&quot;&gt;&nbsp;</div></li><li><div>          &lt;img src=&quot;&lt;?php echo $uri_logo; ?&gt;&quot; alt=&quot;bbPress&quot; /&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($header) ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>      &lt;h1&gt;&nbsp;</div></li><li><div>          &lt;?php echo $header; ?&gt;&nbsp;</div></li><li><div>      &lt;/h1&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_install_footer() {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_die( $message, $title = '', $header = 0 ) {&nbsp;</div></li><li><div>  global $bb_locale;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $header && !headers_sent() )&nbsp;</div></li><li><div>      status_header( $header );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( function_exists( 'is_wp_error' ) && is_wp_error( $message ) ) {&nbsp;</div></li><li><div>      if ( empty( $title ) ) {&nbsp;</div></li><li><div>          $error_data = $message-&gt;get_error_data();&nbsp;</div></li><li><div>          if ( is_array( $error_data ) && isset( $error_data['title'] ) )&nbsp;</div></li><li><div>              $title = $error_data['title'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $errors = $message-&gt;get_error_messages();&nbsp;</div></li><li><div>      switch ( count( $errors ) ) :&nbsp;</div></li><li><div>      case 0 :&nbsp;</div></li><li><div>          $message = '';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 1 :&nbsp;</div></li><li><div>          $message = &quot;&lt;p&gt;{$errors[0]}&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          $message = &quot;&lt;ul&gt;\n\t\t&lt;li&gt;&quot; . join( &quot;&lt;/li&gt;\n\t\t&lt;li&gt;&quot;, $errors ) . &quot;&lt;/li&gt;\n\t&lt;/ul&gt;&quot;;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      endswitch;&nbsp;</div></li><li><div>  } elseif ( is_string( $message ) ) {&nbsp;</div></li><li><div>      $message = bb_autop( $message );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($title) )&nbsp;</div></li><li><div>      $title = __('bbPress &rsaquo; Error');&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  bb_install_header( $title );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;?php echo $message; ?&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  if ($uri = bb_get_uri()) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;last&quot;&gt;&lt;?php printf( __('Back to &lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;.'), $uri, bb_get_option( 'name' ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  bb_install_footer();&nbsp;</div></li><li><div>  die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_explain_nonce($action) {&nbsp;</div></li><li><div>  if ( $action !== -1 && preg_match('/([a-z]+)-([a-z]+)(_(.+))?/', $action, $matches) ) {&nbsp;</div></li><li><div>      $verb = $matches[1];&nbsp;</div></li><li><div>      $noun = $matches[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans = array();&nbsp;</div></li><li><div>      $trans['create']['post'] = array(__('Your attempt to submit this post has failed.'), false);&nbsp;</div></li><li><div>      $trans['edit']['post'] = array(__('Your attempt to edit this post has failed.'), false);&nbsp;</div></li><li><div>      $trans['delete']['post'] = array(__('Your attempt to delete this post has failed.'), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['create']['topic'] = array(__('Your attempt to create this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['resolve']['topic'] = array(__('Your attempt to change the resolution status of this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['delete']['topic'] = array(__('Your attempt to delete this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['close']['topic'] = array(__('Your attempt to change the status of this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['stick']['topic'] = array(__('Your attempt to change the sticky status of this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['move']['topic'] = array(__('Your attempt to move this topic has failed.'), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['add']['tag'] = array(__('Your attempt to add this tag to this topic has failed.'), false);&nbsp;</div></li><li><div>      $trans['rename']['tag'] = array(__('Your attempt to rename this tag has failed.'), false);&nbsp;</div></li><li><div>      $trans['merge']['tag'] = array(__('Your attempt to submit these tags has failed.'), false);&nbsp;</div></li><li><div>      $trans['destroy']['tag'] = array(__('Your attempt to destroy this tag has failed.'), false);&nbsp;</div></li><li><div>      $trans['remove']['tag'] = array(__('Your attempt to remove this tag from this topic has failed.'), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['toggle']['favorite'] = array(__('Your attempt to toggle your favorite status for this topic has failed.'), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['edit']['profile'] = array(__(&quot;Your attempt to edit this user's profile has failed.&quot;), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['add']['forum'] = array(__(&quot;Your attempt to add this forum has failed.&quot;), false);&nbsp;</div></li><li><div>      $trans['update']['forums'] = array(__(&quot;Your attempt to update your forums has failed.&quot;), false);&nbsp;</div></li><li><div>      $trans['delete']['forums'] = array(__(&quot;Your attempt to delete that forum has failed.&quot;), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['do']['counts'] = array(__(&quot;Your attempt to recount these items has failed.&quot;), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trans['switch']['theme'] = array(__(&quot;Your attempt to switch themes has failed.&quot;), false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($trans[$verb][$noun]) ) {&nbsp;</div></li><li><div>          if ( !empty($trans[$verb][$noun][1]) ) {&nbsp;</div></li><li><div>              $lookup = $trans[$verb][$noun][1];&nbsp;</div></li><li><div>              $object = $matches[4];&nbsp;</div></li><li><div>              if ( 'use_id' != $lookup )&nbsp;</div></li><li><div>                  $object = call_user_func($lookup, $object);&nbsp;</div></li><li><div>              return sprintf($trans[$verb][$noun][0], esc_html( $object ));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $trans[$verb][$noun][0];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bb_explain_nonce_' . $verb . '-' . $noun, __('Your attempt to do this has failed.'), $matches[4] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** DB Helpers */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_count_last_query( $query = '' ) {&nbsp;</div></li><li><div>  global $bbdb, $bb_last_countable_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $query )&nbsp;</div></li><li><div>      $q = $query;&nbsp;</div></li><li><div>  elseif ( $bb_last_countable_query )&nbsp;</div></li><li><div>      $q = $bb_last_countable_query;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $q = $bbdb-&gt;last_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === strpos($q, 'SELECT') )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== strpos($q, 'SQL_CALC_FOUND_ROWS') )&nbsp;</div></li><li><div>      return (int) $bbdb-&gt;get_var( &quot;SELECT FOUND_ROWS()&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $q_original = $q;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $q = preg_replace(&nbsp;</div></li><li><div>      array('/SELECT.*?\s+FROM/', '/LIMIT [0-9]+(\s*, \s*[0-9]+)?/', '/ORDER BY\s+.*$/', '/DESC/', '/ASC/'), &nbsp;</div></li><li><div>      array('SELECT COUNT(*) FROM', ''), &nbsp;</div></li><li><div>      $q&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( '/GROUP BY\s+(\S+)/', $q, $matches ) )&nbsp;</div></li><li><div>      $q = str_replace( array( 'COUNT(*)', $matches[0] ), array( &quot;COUNT(DISTINCT $matches[1])&quot;, '' ), $q );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$query )&nbsp;</div></li><li><div>      $bb_last_countable_query = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $q = apply_filters( 'bb_count_last_query', $q, $q_original );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) $bbdb-&gt;get_var($q);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_no_where( $where ) {&nbsp;</div></li><li><div>  return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Plugins/Themes utility */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_basename( $file, $directories )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( strpos( $file, '#' ) !== false ) {&nbsp;</div></li><li><div>      return $file; <span class="comment">// It's already a basename</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $directories as $type =&gt; $directory ) {&nbsp;</div></li><li><div>      if ( strpos( $file, $directory ) !== false ) {&nbsp;</div></li><li><div>          break; <span class="comment">// Keep the $file and $directory set and use them below, nifty huh?</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  list( $file, $directory ) = str_replace( '\\', '/', array( $file, $directory ) );&nbsp;</div></li><li><div>  list( $file, $directory ) = preg_replace( '|/+|', '/', array( $file, $directory ) );&nbsp;</div></li><li><div>  $file = preg_replace( '|^.*' . preg_quote( $directory, '|' ) . '|', $type . '#', $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $file;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Plugins */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_plugin_basename( $file )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  $directories = array();&nbsp;</div></li><li><div>  foreach ( $bb-&gt;plugin_locations as $_name =&gt; $_data ) {&nbsp;</div></li><li><div>      $directories[$_name] = $_data['dir'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return bb_basename( $file, $directories );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_plugin_activation_hook( $file, $function )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $file = bb_plugin_basename( $file );&nbsp;</div></li><li><div>  add_action( 'bb_activate_plugin_' . $file, $function );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_plugin_deactivation_hook( $file, $function )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $file = bb_plugin_basename( $file );&nbsp;</div></li><li><div>  add_action( 'bb_deactivate_plugin_' . $file, $function );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_plugin_uri( $plugin = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  if ( preg_match( '/^([a-z0-9_-]+)#((?:[a-z0-9\/\\_-]+.)+)(php)$/i', $plugin, $_matches ) ) {&nbsp;</div></li><li><div>      $plugin_uri = $bb-&gt;plugin_locations[$_matches[1]]['url'] . $_matches[2] . $_matches[3];&nbsp;</div></li><li><div>      $plugin_uri = dirname( $plugin_uri ) . '/';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $plugin_uri = $bb-&gt;plugin_locations['core']['url'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return apply_filters( 'bb_get_plugin_uri', $plugin_uri, $plugin );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_plugin_directory( $plugin = false, $path = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  if ( preg_match( '/^([a-z0-9_-]+)#((?:[a-z0-9\/\\_-]+.)+)(php)$/i', $plugin, $_matches ) ) {&nbsp;</div></li><li><div>      $plugin_directory = $bb-&gt;plugin_locations[$_matches[1]]['dir'] . $_matches[2] . $_matches[3];&nbsp;</div></li><li><div>      if ( !$path ) {&nbsp;</div></li><li><div>          $plugin_directory = dirname( $plugin_directory ) . '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $plugin_directory = $bb-&gt;plugin_locations['core']['dir'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return apply_filters( 'bb_get_plugin_directory', $plugin_directory, $plugin, $path );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_plugin_path( $plugin = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $plugin_path = bb_get_plugin_directory( $plugin, true );&nbsp;</div></li><li><div>  return apply_filters( 'bb_get_plugin_path', $plugin_path, $plugin );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Themes / Templates */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_active_theme_directory()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  return apply_filters( 'bb_get_active_theme_directory', bb_get_theme_directory() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_theme_directory( $theme = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  if ( !$theme ) {&nbsp;</div></li><li><div>      $theme = bb_get_option( 'bb_active_theme' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( preg_match( '/^([a-z0-9_-]+)#([\.a-z0-9_-]+)$/i', $theme, $_matches ) ) {&nbsp;</div></li><li><div>      $theme_directory = $bb-&gt;theme_locations[$_matches[1]]['dir'] . $_matches[2] . '/';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $theme_directory = BB_DEFAULT_THEME_DIR;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $theme_directory;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_themes()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $r = array();&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  foreach ( $bb-&gt;theme_locations as $_name =&gt; $_data ) {&nbsp;</div></li><li><div>      if ( $themes_dir = @dir( $_data['dir'] ) ) {&nbsp;</div></li><li><div>          while( ( $theme_dir = $themes_dir-&gt;read() ) !== false ) {&nbsp;</div></li><li><div>              if ( is_file( $_data['dir'] . $theme_dir . '/style.css' ) && is_readable( $_data['dir'] . $theme_dir . '/style.css' ) && '.' != $theme_dir{0} ) {&nbsp;</div></li><li><div>                  $r[$_name . '#' . $theme_dir] = $_name . '#' . $theme_dir;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  ksort( $r );&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_theme_basename( $file )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>  $directories = array();&nbsp;</div></li><li><div>  foreach ( $bb-&gt;theme_locations as $_name =&gt; $_data ) {&nbsp;</div></li><li><div>      $directories[$_name] = $_data['dir'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $file = bb_basename( $file, $directories );&nbsp;</div></li><li><div>  $file = preg_replace( '|/+.*|', '', $file );&nbsp;</div></li><li><div>  return $file;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_theme_activation_hook( $file, $function )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $file = bb_theme_basename( $file );&nbsp;</div></li><li><div>  add_action( 'bb_activate_theme_' . $file, $function );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_register_theme_deactivation_hook( $file, $function )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $file = bb_theme_basename( $file );&nbsp;</div></li><li><div>  add_action( 'bb_deactivate_theme_' . $file, $function );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Search Functions */</span>&nbsp;</div></li><li><div><span class="comment">// NOT bbdb::prepared</span>&nbsp;</div></li><li><div>function bb_user_search( $args = '' ) {&nbsp;</div></li><li><div>  global $bbdb, $bb_last_countable_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $args && is_string( $args ) && false === strpos( $args, '=' ) ) {&nbsp;</div></li><li><div>      $args = array( 'query' =&gt; $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'query' =&gt; '', &nbsp;</div></li><li><div>      'append_meta' =&gt; true, &nbsp;</div></li><li><div>      'user_login' =&gt; true, &nbsp;</div></li><li><div>      'display_name' =&gt; true, &nbsp;</div></li><li><div>      'user_nicename' =&gt; false, &nbsp;</div></li><li><div>      'user_url' =&gt; true, &nbsp;</div></li><li><div>      'user_email' =&gt; false, &nbsp;</div></li><li><div>      'user_meta' =&gt; false, &nbsp;</div></li><li><div>      'users_per_page' =&gt; false, &nbsp;</div></li><li><div>      'page' =&gt; false, &nbsp;</div></li><li><div>      'roles' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = trim( $query );&nbsp;</div></li><li><div>  if ( $query && strlen( preg_replace( '/[^a-z0-9]/i', '', $query ) ) &lt; 3 ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid-query', __('Your search term was too short') );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $query = $bbdb-&gt;escape( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$page ) {&nbsp;</div></li><li><div>      $page = $GLOBALS['page'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $page = (int) $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $limit = 0 &lt; (int) $users_per_page ? (int) $users_per_page : bb_get_option( 'page_topics' );&nbsp;</div></li><li><div>  if ( 1 &lt; $page ) {&nbsp;</div></li><li><div>      $limit = ($limit * ($page - 1)) . &quot;, $limit&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $likeit = preg_replace( '/\s+/', '%', like_escape( $query ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $fields = array();&nbsp;</div></li><li><div>  foreach ( array( 'user_login', 'display_name', 'user_nicename', 'user_url', 'user_email' ) as $field ) {&nbsp;</div></li><li><div>      if ( $$field ) {&nbsp;</div></li><li><div>          $fields[] = $field;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $roles ) {&nbsp;</div></li><li><div>      $roles = (array) $roles;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $roles && !empty( $roles ) && false === $role_user_ids = apply_filters( 'bb_user_search_role_user_ids', false, $roles, $args ) ) {&nbsp;</div></li><li><div>      $role_meta_key = $bbdb-&gt;escape( $bbdb-&gt;prefix . 'capabilities' );&nbsp;</div></li><li><div>      $role_sql_terms = array();&nbsp;</div></li><li><div>      foreach ( $roles as $role ) {&nbsp;</div></li><li><div>          $role_sql_terms[] = &quot;`meta_value` LIKE '%&quot; . $bbdb-&gt;escape( like_escape( $role ) ) . &quot;%'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $role_sql_terms = join( ' OR ', $role_sql_terms );&nbsp;</div></li><li><div>      $role_sql = &quot;SELECT `user_id` FROM `$bbdb-&gt;usermeta` WHERE `meta_key` = '$role_meta_key' AND ($role_sql_terms);&quot;;&nbsp;</div></li><li><div>      $role_user_ids = $bbdb-&gt;get_col( $role_sql, 0 );&nbsp;</div></li><li><div>      if ( is_wp_error( $role_user_ids ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array( $role_user_ids ) && empty( $role_user_ids ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $query && $user_meta && false === $meta_user_ids = apply_filters( 'bb_user_search_meta_user_ids', false, $args ) ) {&nbsp;</div></li><li><div>      $meta_sql = &quot;SELECT `user_id` FROM `$bbdb-&gt;usermeta` WHERE `meta_value` LIKE ('%$likeit%')&quot;;&nbsp;</div></li><li><div>      if ( empty( $fields ) ) {&nbsp;</div></li><li><div>          $meta_sql .= &quot; LIMIT $limit&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $meta_user_ids = $bbdb-&gt;get_col( $meta_sql, 0 );&nbsp;</div></li><li><div>      if ( is_wp_error( $meta_user_ids ) ) {&nbsp;</div></li><li><div>          $meta_user_ids = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_ids = array();&nbsp;</div></li><li><div>  if ( $role_user_ids && $meta_user_ids ) {&nbsp;</div></li><li><div>      $user_ids = array_intersect( (array) $role_user_ids, (array) $meta_user_ids );&nbsp;</div></li><li><div>  } elseif ( $role_user_ids ) {&nbsp;</div></li><li><div>      $user_ids = (array) $role_user_ids;&nbsp;</div></li><li><div>  } elseif ( $meta_user_ids ) {&nbsp;</div></li><li><div>      $user_ids = (array) $meta_user_ids;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;SELECT * FROM $bbdb-&gt;users&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql_terms = array();&nbsp;</div></li><li><div>  if ( $query && count( $fields ) ) {&nbsp;</div></li><li><div>      foreach ( $fields as $field ) {&nbsp;</div></li><li><div>          $sql_terms[] = &quot;$field LIKE ('%$likeit%')&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_ids_sql = '';&nbsp;</div></li><li><div>  if ( $user_ids ) {&nbsp;</div></li><li><div>      $user_ids_sql = &quot;AND ID IN (&quot;. join(', ', $user_ids) . &quot;)&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $query && empty( $sql_terms ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid-query', __( 'Your query parameters are invalid' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $sql_terms ) || count( $user_ids ) ) {&nbsp;</div></li><li><div>      $sql .= ' WHERE ';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $sql_terms ) ) {&nbsp;</div></li><li><div>      $sql .= '(' . implode( ' OR ', $sql_terms ) . ')';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $sql_terms ) && count( $user_ids ) ) {&nbsp;</div></li><li><div>      $sql .= ' AND ';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( count( $user_ids ) ) {&nbsp;</div></li><li><div>      $sql .= '`ID` IN (' . join( ', ', $user_ids ) . ')';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql .= &quot; ORDER BY user_login LIMIT $limit&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_last_countable_query = $sql;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bb_user_search', $sql, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( $users = $bbdb-&gt;get_results( $sql ) ) && $append_meta ) {&nbsp;</div></li><li><div>      return bb_append_meta( $users, 'user' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $users ? $users : false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_tag_search( $args = '' ) {&nbsp;</div></li><li><div>  global $page, $wp_taxonomy_object;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $args && is_string($args) && false === strpos($args, '=') )&nbsp;</div></li><li><div>      $args = array( 'search' =&gt; $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array( 'search' =&gt; '', 'number' =&gt; false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args );&nbsp;</div></li><li><div>  if ( isset( $args['query'] ) )&nbsp;</div></li><li><div>      $args['search'] = $args['query'];&nbsp;</div></li><li><div>  if ( isset( $args['tags_per_page'] ) )&nbsp;</div></li><li><div>      $args['number'] = $args['tags_per_page'];&nbsp;</div></li><li><div>  unset($args['query'], $args['tags_per_page']);&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $number = (int) $number;&nbsp;</div></li><li><div>  $search = trim( $search );&nbsp;</div></li><li><div>  if ( strlen( $search ) &lt; 3 )&nbsp;</div></li><li><div>      return new WP_Error( 'invalid-query', __('Your search term was too short') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $number = 0 &lt; $number ? $number : bb_get_option( 'page_topics' );&nbsp;</div></li><li><div>  if ( 1 &lt; $page )&nbsp;</div></li><li><div>      $offset = ( intval($page) - 1 ) * $number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array_merge( $args, compact( 'number', 'offset', 'search' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $terms = $wp_taxonomy_object-&gt;get_terms( 'bb_topic_tag', $args );&nbsp;</div></li><li><div>  if ( is_wp_error( $terms ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  for ( $i = 0; isset($terms[$i]); $i++ )&nbsp;</div></li><li><div>      _bb_make_tag_compat( $terms[$i] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $terms;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Slugs */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_slug_increment( $slug, $existing_slug, $slug_length = 255 ) {&nbsp;</div></li><li><div>  if ( preg_match('/^.*-([0-9]+)$/', $existing_slug, $m) )&nbsp;</div></li><li><div>      $number = (int) $m[1] + 1;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $number = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bb_encoded_utf8_cut( $slug, $slug_length - 1 - strlen($number) );&nbsp;</div></li><li><div>  return apply_filters( 'bb_slug_increment', &quot;$r-$number&quot;, $slug, $existing_slug, $slug_length );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_id_from_slug( $table, $slug, $slug_length = 255 ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  $tablename = $table . 's';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  list($_slug, $sql) = bb_get_sql_from_slug( $table, $slug, $slug_length );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$_slug || !$sql )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (int) $bbdb-&gt;get_var( &quot;SELECT ${table}_id FROM {$bbdb-&gt;$tablename} WHERE $sql&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_sql_from_slug( $table, $slug, $slug_length = 255 ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Look for new style equiv of old style slug</span>&nbsp;</div></li><li><div>  $_slug = bb_slug_sanitize( (string) $slug );&nbsp;</div></li><li><div>  if ( strlen( $_slug ) &lt; 1 )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen($_slug) &gt; $slug_length && preg_match('/^.*-([0-9]+)$/', $_slug, $m) ) {&nbsp;</div></li><li><div>      $_slug = bb_encoded_utf8_cut( $_slug, $slug_length - 1 - strlen($number) );&nbsp;</div></li><li><div>      $number = (int) $m[1];&nbsp;</div></li><li><div>      $_slug =  &quot;$_slug-$number&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( $_slug, $bbdb-&gt;prepare( &quot;${table}_slug = %s&quot;, $_slug ) );&nbsp;</div></li><li><div>}    &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Utility */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_flatten_array( $array, $cut_branch = 0, $keep_child_array_keys = true ) {&nbsp;</div></li><li><div>  if ( !is_array($array) )&nbsp;</div></li><li><div>      return $array;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ( empty($array) )&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $temp = array();&nbsp;</div></li><li><div>  foreach ( $array as $k =&gt; $v ) {&nbsp;</div></li><li><div>      if ( $cut_branch && $k == $cut_branch )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( is_array($v) ) {&nbsp;</div></li><li><div>          if ( $keep_child_array_keys ) {&nbsp;</div></li><li><div>              $temp[$k] = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $temp += bb_flatten_array($v, $cut_branch, $keep_child_array_keys);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $temp[$k] = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $temp;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_common_parts($string1 = false, $string2 = false, $delimiter = '', $reverse = false) {&nbsp;</div></li><li><div>  if (!$string1 || !$string2) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ($string1 === $string2) {&nbsp;</div></li><li><div>      return $string1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $string1_parts = explode( $delimiter, (string) $string1 );&nbsp;</div></li><li><div>  $string2_parts = explode( $delimiter, (string) $string2 );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ($reverse) {&nbsp;</div></li><li><div>      $string1_parts = array_reverse( $string1_parts );&nbsp;</div></li><li><div>      $string2_parts = array_reverse( $string2_parts );&nbsp;</div></li><li><div>      ksort( $string1_parts );&nbsp;</div></li><li><div>      ksort( $string2_parts );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $common_parts = array();&nbsp;</div></li><li><div>  foreach ( $string1_parts as $index =&gt; $part ) {&nbsp;</div></li><li><div>      if ( isset( $string2_parts[$index] ) && $string2_parts[$index] == $part ) {&nbsp;</div></li><li><div>          $common_parts[] = $part;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!count($common_parts)) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ($reverse) {&nbsp;</div></li><li><div>      $common_parts = array_reverse( $common_parts );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return join( $delimiter, $common_parts );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_common_domains($domain1 = false, $domain2 = false) {&nbsp;</div></li><li><div>  if (!$domain1 || !$domain2) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $domain1 = strtolower( preg_replace( '@^https?:<span class="comment"><span class="comment">//([^/]+).*$@i', '$1', $domain1 ) );</span></span>&nbsp;</div></li><li><div>  $domain2 = strtolower( preg_replace( '@^https?:<span class="comment"><span class="comment">//([^/]+).*$@i', '$1', $domain2 ) );</span></span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return bb_get_common_parts( $domain1, $domain2, '.', true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_common_paths($path1 = false, $path2 = false) {&nbsp;</div></li><li><div>  if (!$path1 || !$path2) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $path1 = preg_replace('@^https?:<span class="comment">//[^/]+(.*)$@i', '$1', $path1);</span>&nbsp;</div></li><li><div>  $path2 = preg_replace('@^https?:<span class="comment">//[^/]+(.*)$@i', '$1', $path2);</span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ($path1 === $path2) {&nbsp;</div></li><li><div>      return $path1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $path1 = trim( $path1, '/' );&nbsp;</div></li><li><div>  $path2 = trim( $path2, '/' );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $common_path = bb_get_common_parts( $path1, $path2, '/' );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ($common_path) {&nbsp;</div></li><li><div>      return '/' . $common_path . '/';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return '/';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_match_domains($domain1 = false, $domain2 = false) {&nbsp;</div></li><li><div>  if (!$domain1 || !$domain2) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $domain1 = strtolower( preg_replace( '@^https?:<span class="comment"><span class="comment">//([^/]+).*$@i', '$1', $domain1 ) );</span></span>&nbsp;</div></li><li><div>  $domain2 = strtolower( preg_replace( '@^https?:<span class="comment"><span class="comment">//([^/]+).*$@i', '$1', $domain2 ) );</span></span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ( (string) $domain1 === (string) $domain2 ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_glob($pattern) {&nbsp;</div></li><li><div>  <span class="comment">// On fail return an empty array so that loops don't explode</span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!$pattern)&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// May break if pattern contains forward slashes</span>&nbsp;</div></li><li><div>  $directory = dirname( $pattern );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!$directory)&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!file_exists($directory))&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!is_dir($directory))&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!function_exists('glob'))&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!is_callable('glob'))&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $glob = glob($pattern);&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (!is_array($glob))&nbsp;</div></li><li><div>      $glob = array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return $glob;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>