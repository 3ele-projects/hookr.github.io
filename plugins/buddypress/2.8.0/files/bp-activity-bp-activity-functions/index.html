<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.0" data-slug="buddypress" data-type="file" data-id="48983"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-activity-bp-activity-functions | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=ca285ec7b0a736006b8d97cd48f2bdd2' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-activity-bp-activity-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-bp-activity-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-bp-activity-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.0-file-bp-activity-bp-activity-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-activity-bp-activity-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.0." href="http://hookr.io/plugins/buddypress/2.8.0/" class="H_VERSION"><span property="name">2.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-activity-bp-activity-funct&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.0/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="66"><a href="http://hookr.io/plugins/buddypress/2.8.0/new/" title="New">New <span class="count badge">66</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.0/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.0/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.0/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.0/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.0/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.0/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-activity/bp-activity-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Activity Functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Functions for the Activity Streams component.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage ActivityFunctions</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether the $bp global lists an activity directory page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if activity directory page is found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_has_directory() {&nbsp;</div></li><li><div>  return (bool) !empty( buddypress()-&gt;pages-&gt;activity-&gt;id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Are mentions enabled or disabled?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The Mentions feature does a number of things, all of which will be turned</span>&nbsp;</div></li><li><div><span class="comment"> * off if you disable mentions:</span>&nbsp;</div></li><li><div><span class="comment"> *   - Detecting and auto-linking @username in all BP/WP content.</span>&nbsp;</div></li><li><div><span class="comment"> *   - Sending BP notifications and emails to users when they are mentioned</span>&nbsp;</div></li><li><div><span class="comment"> *     using the @username syntax.</span>&nbsp;</div></li><li><div><span class="comment"> *   - The Public Message button on user profiles.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Mentions are enabled by default. To disable, put the following line in</span>&nbsp;</div></li><li><div><span class="comment"> * bp-custom.php or your theme's functions.php file:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *   add_filter( 'bp_activity_do_mentions', '__return_false' );</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool $retval True to enable mentions, false to disable.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_do_mentions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not mentions are enabled.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $enabled True to enable mentions, false to disable.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_activity_do_mentions', true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Should BuddyPress load the mentions scripts and related assets, including results to prime the</span>&nbsp;</div></li><li><div><span class="comment"> * mentions suggestions?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if mentions scripts should be loaded.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_maybe_load_mentions_scripts() {&nbsp;</div></li><li><div>  $mentions_enabled = bp_activity_do_mentions() && bp_is_user_active();&nbsp;</div></li><li><div>  $load_mentions = $mentions_enabled && ( bp_is_activity_component() || is_admin() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not BuddyPress should load mentions scripts and assets.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $load_mentions    True to load mentions assets, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $mentions_enabled True if mentions are enabled.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_activity_maybe_load_mentions_scripts', $load_mentions, $mentions_enabled );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Locate usernames in an activity content string, as designated by an @ sign.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The content of the activity, usually found in</span>&nbsp;</div></li><li><div><span class="comment"> *                        $activity-&gt;content.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|bool Associative array with user ID as key and username as</span>&nbsp;</div></li><li><div><span class="comment"> *                    value. Boolean false if no mentions found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_find_mentions( $content ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pattern = '/[@]+([A-Za-z0-9-_\.@]+)\b/';&nbsp;</div></li><li><div>  preg_match_all( $pattern, $content, $usernames );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure there's only one instance of each username.</span>&nbsp;</div></li><li><div>  $usernames = array_unique( $usernames[1] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no usernames.</span>&nbsp;</div></li><li><div>  if ( empty( $usernames ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $mentioned_users = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We've found some mentions! Check to see if users exist.</span>&nbsp;</div></li><li><div>  foreach( (array) array_values( $usernames ) as $username ) {&nbsp;</div></li><li><div>      $user_id = bp_activity_get_userid_from_mentionname( $username );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The user ID exists, so let's add it to our array.</span>&nbsp;</div></li><li><div>      if ( ! empty( $user_id ) ) {&nbsp;</div></li><li><div>          $mentioned_users[ $user_id ] = $username;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $mentioned_users ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the mentioned users.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $mentioned_users Associative array with user IDs as keys and usernames as values.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_mentioned_users', $mentioned_users );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Reset a user's unread mentions list and count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The id of the user whose unread mentions are being reset.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_clear_new_mentions( $user_id ) {&nbsp;</div></li><li><div>  bp_delete_user_meta( $user_id, 'bp_new_mention_count' );&nbsp;</div></li><li><div>  bp_delete_user_meta( $user_id, 'bp_new_mentions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires once mentions has been reset for a given user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $user_id The id of the user whose unread mentions are being reset.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_clear_new_mentions', $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adjusts mention count for mentioned users in activity items.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is useful if you only have the activity ID handy and you</span>&nbsp;</div></li><li><div><span class="comment"> * haven't parsed an activity item for @mentions yet.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Currently, only used in {@link bp_activity_delete()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id The unique id for the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action      Can be 'delete' or 'add'. Defaults to 'add'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_adjust_mention_count( $activity_id = 0, $action = 'add' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no activity ID passed.</span>&nbsp;</div></li><li><div>  if ( empty( $activity_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get activity object.</span>&nbsp;</div></li><li><div>  $activity = new BP_Activity_Activity( $activity_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to find mentions.</span>&nbsp;</div></li><li><div>  $usernames = bp_activity_find_mentions( strip_tags( $activity-&gt;content ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Still empty? Stop now.</span>&nbsp;</div></li><li><div>  if ( empty( $usernames ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Increment mention count foreach mentioned user.</span>&nbsp;</div></li><li><div>  foreach( (array) array_keys( $usernames ) as $user_id ) {&nbsp;</div></li><li><div>      bp_activity_update_mention_count_for_user( $user_id, $activity_id, $action );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the mention count for a given user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function should be used when you've already parsed your activity item</span>&nbsp;</div></li><li><div><span class="comment"> * for @mentions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     The user ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id The unique ID for the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action      'delete' or 'add'. Default: 'add'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_update_mention_count_for_user( $user_id, $activity_id, $action = 'add' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) || empty( $activity_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Adjust the mention list and count for the member.</span>&nbsp;</div></li><li><div>  $new_mention_count = (int) bp_get_user_meta( $user_id, 'bp_new_mention_count', true );&nbsp;</div></li><li><div>  $new_mentions =       bp_get_user_meta( $user_id, 'bp_new_mentions', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure new mentions is an array.</span>&nbsp;</div></li><li><div>  if ( empty( $new_mentions ) ) {&nbsp;</div></li><li><div>      $new_mentions = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $action ) {&nbsp;</div></li><li><div>      case 'delete' :&nbsp;</div></li><li><div>          $key = array_search( $activity_id, $new_mentions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $key !== false ) {&nbsp;</div></li><li><div>              unset( $new_mentions[$key] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'add' :&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          if ( !in_array( $activity_id, $new_mentions ) ) {&nbsp;</div></li><li><div>              $new_mentions[] = (int) $activity_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get an updated mention count.</span>&nbsp;</div></li><li><div>  $new_mention_count = count( $new_mentions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Resave the user_meta.</span>&nbsp;</div></li><li><div>  bp_update_user_meta( $user_id, 'bp_new_mention_count', $new_mention_count );&nbsp;</div></li><li><div>  bp_update_user_meta( $user_id, 'bp_new_mentions', $new_mentions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine a user's &quot;mentionname&quot;, the name used for that user in @-mentions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string $user_id ID of the user to get @-mention name for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $mentionname User name appropriate for @-mentions.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_user_mentionname( $user_id ) {&nbsp;</div></li><li><div>  $mentionname = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $userdata = bp_core_get_core_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $userdata ) {&nbsp;</div></li><li><div>      if ( bp_is_username_compatibility_mode() ) {&nbsp;</div></li><li><div>          $mentionname = str_replace( ' ', '-', $userdata-&gt;user_login );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $mentionname = $userdata-&gt;user_nicename;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $mentionname;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a user ID from a &quot;mentionname&quot;, the name used for a user in @-mentions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $mentionname Username of user in @-mentions.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool ID of the user, if one is found. Otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_userid_from_mentionname( $mentionname ) {&nbsp;</div></li><li><div>  $user_id = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * In username compatibility mode, hyphens are ambiguous between</span>&nbsp;</div></li><li><div><span class="comment">   * actual hyphens and converted spaces.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo There is the potential for username clashes between 'foo bar'</span>&nbsp;</div></li><li><div><span class="comment">   * and 'foo-bar' in compatibility mode. Come up with a system for</span>&nbsp;</div></li><li><div><span class="comment">   * unique mentionnames.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( bp_is_username_compatibility_mode() ) {&nbsp;</div></li><li><div>      <span class="comment">// First, try the raw username.</span>&nbsp;</div></li><li><div>      $userdata = get_user_by( 'login', $mentionname );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Doing a direct query to use proper regex. Necessary to</span>&nbsp;</div></li><li><div>      <span class="comment">// account for hyphens + spaces in the same user_login.</span>&nbsp;</div></li><li><div>      if ( empty( $userdata ) || ! is_a( $userdata, 'WP_User' ) ) {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          $regex = esc_sql( str_replace( '-', '[ \-]', $mentionname ) );&nbsp;</div></li><li><div>          $user_id = $wpdb-&gt;get_var( &quot;SELECT ID FROM {$wpdb-&gt;users} WHERE user_login REGEXP '{$regex}'&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $user_id = $userdata-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// When username compatibility mode is disabled, the mentionname is</span>&nbsp;</div></li><li><div>  <span class="comment">// the same as the nicename.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user_id = bp_core_get_userid_from_nicename( $mentionname );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Actions ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register an activity 'type' and its action description/callback.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Activity actions are strings used to describe items in the activity stream, </span>&nbsp;</div></li><li><div><span class="comment"> * such as 'Joe became a registered member' or 'Bill and Susie are now</span>&nbsp;</div></li><li><div><span class="comment"> * friends'. Each activity type (such as 'new_member' or 'friendship_created')</span>&nbsp;</div></li><li><div><span class="comment"> * used by a component should be registered using this function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * While it's possible to post items to the activity stream whose types are</span>&nbsp;</div></li><li><div><span class="comment"> * not registered using bp_activity_set_action(), it is not recommended;</span>&nbsp;</div></li><li><div><span class="comment"> * unregistered types will not be displayed properly in the activity admin</span>&nbsp;</div></li><li><div><span class="comment"> * panel, and dynamic action generation (which is essential for multilingual</span>&nbsp;</div></li><li><div><span class="comment"> * sites, etc) will not work.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string        $component_id    The unique string ID of the component.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string        $type            The action type.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string        $description     The action description.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  callable|bool $format_callback Callback for formatting the action string.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string|bool   $label           String to describe this action in the activity stream filter dropdown.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array         $context         Optional. Activity stream contexts where the filter should appear.</span>&nbsp;</div></li><li><div><span class="comment"> *                                        Values: 'activity', 'member', 'member_groups', 'group'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int           $position        Optional. The position of the action when listed in dropdowns.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool False if any param is empty, otherwise true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_set_action( $component_id, $type, $description, $format_callback = false, $label = false, $context = array(), $position = 0 ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Return false if any of the above values are not set.</span></span>&nbsp;</div></li><li><div>  if ( empty( $component_id ) || empty( $type ) || empty( $description ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set activity action.</span>&nbsp;</div></li><li><div>  if ( ! isset( $bp-&gt;activity-&gt;actions ) || ! is_object( $bp-&gt;activity-&gt;actions ) ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;actions = new stdClass;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify callback.</span>&nbsp;</div></li><li><div>  if ( ! is_callable( $format_callback ) ) {&nbsp;</div></li><li><div>      $format_callback = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $bp-&gt;activity-&gt;actions-&gt;{$component_id} ) || ! is_object( $bp-&gt;activity-&gt;actions-&gt;{$component_id} ) ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;actions-&gt;{$component_id} = new stdClass;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the action type being set for the current activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array    $array           Array of arguments for action type being set.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $component_id    ID of the current component being set.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $type            Action type being set.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $description     Action description for action being set.</span>&nbsp;</div></li><li><div><span class="comment">   * @param callable $format_callback Callback for formatting the action string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $label           String to describe this action in the activity stream filter dropdown.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array    $context         Activity stream contexts where the filter should appear. 'activity', 'member', </span>&nbsp;</div></li><li><div><span class="comment">   *                                  'member_groups', 'group'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $bp-&gt;activity-&gt;actions-&gt;{$component_id}-&gt;{$type} = apply_filters( 'bp_activity_set_action', array(&nbsp;</div></li><li><div>      'key' =&gt; $type, &nbsp;</div></li><li><div>      'value' =&gt; $description, &nbsp;</div></li><li><div>      'format_callback' =&gt; $format_callback, &nbsp;</div></li><li><div>      'label' =&gt; $label, &nbsp;</div></li><li><div>      'context' =&gt; $context, &nbsp;</div></li><li><div>      'position' =&gt; $position, &nbsp;</div></li><li><div> ), $component_id, $type, $description, $format_callback, $label, $context );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sort the actions of the affected component.</span>&nbsp;</div></li><li><div>  $action_array = (array) $bp-&gt;activity-&gt;actions-&gt;{$component_id};&nbsp;</div></li><li><div>  $action_array = bp_sort_by_key( $action_array, 'position', 'num' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Restore keys.</span>&nbsp;</div></li><li><div>  $bp-&gt;activity-&gt;actions-&gt;{$component_id} = new stdClass;&nbsp;</div></li><li><div>  foreach ( $action_array as $key_ordered ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;actions-&gt;{$component_id}-&gt;{$key_ordered['key']} = $key_ordered;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set tracking arguments for a given post type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global $wp_post_types</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type The name of the post type, as registered with WordPress. Eg 'post' or 'page'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     An associative array of tracking parameters. All items are optional.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $bp_activity_admin_filter String to use in the Dashboard &gt; Activity dropdown.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $bp_activity_front_filter String to use in the front-end dropdown.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $bp_activity_new_post     String format to use for generating the activity action. Should be a</span>&nbsp;</div></li><li><div><span class="comment"> *                                              translatable string where %1$s is replaced by a user link and %2$s is</span>&nbsp;</div></li><li><div><span class="comment"> *                                              the URL of the newly created post.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $bp_activity_new_post_ms  String format to use for generating the activity action on Multisite.</span>&nbsp;</div></li><li><div><span class="comment"> *                                              Should be a translatable string where %1$s is replaced by a user link, </span>&nbsp;</div></li><li><div><span class="comment"> *                                              %2$s is the URL of the newly created post, and %3$s is a link to</span>&nbsp;</div></li><li><div><span class="comment"> *                                              the site.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $component_id             ID of the BuddyPress component to associate the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $action_id                Value for the 'type' param of the new activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type callable $format_callback          Callback for formatting the activity action string.</span>&nbsp;</div></li><li><div><span class="comment"> *                                              Default: 'bp_activity_format_activity_action_custom_post_type_post'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array    $contexts                 The directory contexts in which the filter will show.</span>&nbsp;</div></li><li><div><span class="comment"> *                                              Default: array( 'activity' ).</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array    $position                 Position of the item in filter dropdowns.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $singular                 Singular, translatable name of the post type item. If no value is</span>&nbsp;</div></li><li><div><span class="comment"> *                                              provided, it's pulled from the 'singular_name' of the post type.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool     $activity_comment         Whether to allow comments on the activity items. Defaults to true if</span>&nbsp;</div></li><li><div><span class="comment"> *                                              the post type does not natively support comments, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_set_post_type_tracking_args( $post_type = '', $args = array() ) {&nbsp;</div></li><li><div>  global $wp_post_types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $wp_post_types[ $post_type ] ) || ! post_type_supports( $post_type, 'buddypress-activity' ) || ! is_array( $args ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_labels = array(&nbsp;</div></li><li><div>      <span class="comment">/** Post labels */</span>&nbsp;</div></li><li><div>      'bp_activity_admin_filter', &nbsp;</div></li><li><div>      'bp_activity_front_filter', &nbsp;</div></li><li><div>      'bp_activity_new_post', &nbsp;</div></li><li><div>      'bp_activity_new_post_ms', &nbsp;</div></li><li><div>      <span class="comment">/** Comment labels */</span>&nbsp;</div></li><li><div>      'bp_activity_comments_admin_filter', &nbsp;</div></li><li><div>      'bp_activity_comments_front_filter', &nbsp;</div></li><li><div>      'bp_activity_new_comment', &nbsp;</div></li><li><div>      'bp_activity_new_comment_ms'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Labels are loaded into the post type object.</span>&nbsp;</div></li><li><div>  foreach ( $activity_labels as $label_type ) {&nbsp;</div></li><li><div>      if ( ! empty( $args[ $label_type ] ) ) {&nbsp;</div></li><li><div>          $wp_post_types[ $post_type ]-&gt;labels-&gt;{$label_type} = $args[ $label_type ];&nbsp;</div></li><li><div>          unset( $args[ $label_type ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If there are any additional args, put them in the bp_activity attribute of the post type.</span>&nbsp;</div></li><li><div>  if ( ! empty( $args ) ) {&nbsp;</div></li><li><div>      $wp_post_types[ $post_type ]-&gt;bp_activity = $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get tracking arguments for a specific post type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0 Add post type comments tracking args</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $post_type Name of the post type.</span>&nbsp;</div></li><li><div><span class="comment"> * @return object The tracking arguments of the post type.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_post_type_tracking_args( $post_type ) {&nbsp;</div></li><li><div>  if ( ! post_type_supports( $post_type, 'buddypress-activity' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_type_object = get_post_type_object( $post_type );&nbsp;</div></li><li><div>  $post_type_support_comments = post_type_supports( $post_type, 'comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_type_activity = array(&nbsp;</div></li><li><div>      'component_id' =&gt; buddypress()-&gt;activity-&gt;id, &nbsp;</div></li><li><div>      'action_id' =&gt; 'new_' . $post_type, &nbsp;</div></li><li><div>      'format_callback' =&gt; 'bp_activity_format_activity_action_custom_post_type_post', &nbsp;</div></li><li><div>      'front_filter' =&gt; $post_type_object-&gt;labels-&gt;name, &nbsp;</div></li><li><div>      'contexts' =&gt; array( 'activity' ), &nbsp;</div></li><li><div>      'position' =&gt; 0, &nbsp;</div></li><li><div>      'singular' =&gt; strtolower( $post_type_object-&gt;labels-&gt;singular_name ), &nbsp;</div></li><li><div>      'activity_comment' =&gt; ! $post_type_support_comments, &nbsp;</div></li><li><div>      'comment_action_id' =&gt; false, &nbsp;</div></li><li><div>      'comment_format_callback' =&gt; 'bp_activity_format_activity_action_custom_post_type_comment', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $post_type_object-&gt;bp_activity ) ) {&nbsp;</div></li><li><div>      $post_type_activity = bp_parse_args( (array) $post_type_object-&gt;bp_activity, $post_type_activity, $post_type . '_tracking_args' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_type_activity = (object) $post_type_activity;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to get the admin filter from the post type labels.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_admin_filter ) ) {&nbsp;</div></li><li><div>      $post_type_activity-&gt;admin_filter = $post_type_object-&gt;labels-&gt;bp_activity_admin_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Fall back to a generic name.</span></span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_type_activity-&gt;admin_filter = _x( 'New item published', 'Post Type generic activity post admin filter', 'buddypress' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for the front filter in the post type labels.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_front_filter ) ) {&nbsp;</div></li><li><div>      $post_type_activity-&gt;front_filter = $post_type_object-&gt;labels-&gt;bp_activity_front_filter;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to get the action for new post type action on non-multisite installations.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_new_post ) ) {&nbsp;</div></li><li><div>      $post_type_activity-&gt;new_post_type_action = $post_type_object-&gt;labels-&gt;bp_activity_new_post;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to get the action for new post type action on multisite installations.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_new_post_ms ) ) {&nbsp;</div></li><li><div>      $post_type_activity-&gt;new_post_type_action_ms = $post_type_object-&gt;labels-&gt;bp_activity_new_post_ms;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the post type supports comments and has a comment action id, build the comments tracking args</span>&nbsp;</div></li><li><div>  if ( $post_type_support_comments && ! empty( $post_type_activity-&gt;comment_action_id ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Init a new container for the activity type for comments</span>&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking = new stdClass();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Build the activity type for comments</span>&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking-&gt;component_id = $post_type_activity-&gt;component_id;&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking-&gt;action_id = $post_type_activity-&gt;comment_action_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Try to get the comments admin filter from the post type labels.</span>&nbsp;</div></li><li><div>      if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_comments_admin_filter ) ) {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;admin_filter = $post_type_object-&gt;labels-&gt;bp_activity_comments_admin_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Fall back to a generic name.</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;admin_filter = _x( 'New item comment posted', 'Post Type generic comments activity admin filter', 'buddypress' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking-&gt;format_callback = $post_type_activity-&gt;comment_format_callback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check for the comments front filter in the post type labels.</span>&nbsp;</div></li><li><div>      if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_comments_front_filter ) ) {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;front_filter = $post_type_object-&gt;labels-&gt;bp_activity_comments_front_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Fall back to a generic name.</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;front_filter = _x( 'Item comments', 'Post Type generic comments activity front filter', 'buddypress' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking-&gt;contexts = $post_type_activity-&gt;contexts;&nbsp;</div></li><li><div>      $post_type_activity-&gt;comments_tracking-&gt;position = (int) $post_type_activity-&gt;position + 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Try to get the action for new post type comment action on non-multisite installations.</span>&nbsp;</div></li><li><div>      if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_new_comment ) ) {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;new_post_type_comment_action = $post_type_object-&gt;labels-&gt;bp_activity_new_comment;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Try to get the action for new post type comment action on multisite installations.</span>&nbsp;</div></li><li><div>      if ( ! empty( $post_type_object-&gt;labels-&gt;bp_activity_new_comment_ms ) ) {&nbsp;</div></li><li><div>          $post_type_activity-&gt;comments_tracking-&gt;new_post_type_comment_action_ms = $post_type_object-&gt;labels-&gt;bp_activity_new_comment_ms;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally make sure we'll be able to find the post type this activity type is associated to.</span>&nbsp;</div></li><li><div>  $post_type_activity-&gt;post_type = $post_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters tracking arguments for a specific post type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $post_type_activity The tracking arguments of the post type.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_type          Name of the post type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_post_type_tracking_args', $post_type_activity, $post_type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get tracking arguments for all post types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0 Include post type comments tracking args if needed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of post types with their tracking arguments.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_post_types_tracking_args() {&nbsp;</div></li><li><div>  <span class="comment">// Fetch all public post types.</span>&nbsp;</div></li><li><div>  $post_types = get_post_types( array( 'public' =&gt; true ), 'names' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_types_tracking_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $post_types as $post_type ) {&nbsp;</div></li><li><div>      $track_post_type = bp_activity_get_post_type_tracking_args( $post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $track_post_type ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Set the post type comments tracking args</span>&nbsp;</div></li><li><div>          if ( ! empty( $track_post_type-&gt;comments_tracking-&gt;action_id ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Used to check support for comment tracking by activity type (new_post_type_comment)</span>&nbsp;</div></li><li><div>              $track_post_type-&gt;comments_tracking-&gt;comments_tracking = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Used to be able to find the post type this activity type is associated to.</span>&nbsp;</div></li><li><div>              $track_post_type-&gt;comments_tracking-&gt;post_type = $post_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $post_types_tracking_args[ $track_post_type-&gt;comments_tracking-&gt;action_id ] = $track_post_type-&gt;comments_tracking;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Used to check support for comment tracking by activity type (new_post_type)</span>&nbsp;</div></li><li><div>              $track_post_type-&gt;comments_tracking = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post_types_tracking_args[ $track_post_type-&gt;action_id ] = $track_post_type;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters tracking arguments for all post types.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $post_types_tracking_args Array of post types with</span>&nbsp;</div></li><li><div><span class="comment">   *                                        their tracking arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_post_types_tracking_args', $post_types_tracking_args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if the *Post Type* activity supports a specific feature.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $activity_type The activity type to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $feature       The feature to check. Currently supports:</span>&nbsp;</div></li><li><div><span class="comment"> *                               'post-type-comment-tracking', 'post-type-comment-reply' & 'comment-reply'.</span>&nbsp;</div></li><li><div><span class="comment"> *                               See inline doc for more info.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_type_supports( $activity_type = '', $feature = '' ) {&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $feature ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Does this activity type support comment tracking?</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * eg. 'new_blog_post' and 'new_blog_comment' will both return true.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      case 'post-type-comment-tracking' :&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Set the activity track global if not set yet</span></span>&nbsp;</div></li><li><div>          if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>              $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;comments_tracking ) ) {&nbsp;</div></li><li><div>              $retval = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Is this a parent activity type that support post comments?</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * eg. 'new_blog_post' will return true; 'new_blog_comment' will return false.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      case 'post-type-comment-reply' :&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Set the activity track global if not set yet</span></span>.&nbsp;</div></li><li><div>          if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>              $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;comments_tracking ) && ! empty( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;comment_action_id ) ) {&nbsp;</div></li><li><div>              $retval = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Does this activity type support comment & reply?</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      case 'comment-reply' :&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Set the activity track global if not set yet</span></span>.&nbsp;</div></li><li><div>          if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>              $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Post Type activities</span>&nbsp;</div></li><li><div>          if ( ! empty( $bp-&gt;activity-&gt;track[ $activity_type ] ) ) {&nbsp;</div></li><li><div>              if ( isset( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;activity_comment ) ) {&nbsp;</div></li><li><div>                  $retval = $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;activity_comment;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Eventually override with comment synchronization feature.</span>&nbsp;</div></li><li><div>              if ( isset( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;comments_tracking ) ) {&nbsp;</div></li><li><div>                  $retval = $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;comments_tracking && ! bp_disable_blogforum_comments();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Retired Forums component</span>&nbsp;</div></li><li><div>          } elseif ( 'new_forum_topic' === $activity_type || 'new_forum_post' === $activity_type ) {&nbsp;</div></li><li><div>              $retval = ! bp_disable_blogforum_comments();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// By Default, all other activity types are supporting comments.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $retval = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a specific tracking argument for a given activity type</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string       $activity_type the activity type.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string       $arg           the key of the tracking argument.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed        the value of the tracking arg, false if not found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_get_tracking_arg( $activity_type, $arg = '' ) {&nbsp;</div></li><li><div>  if ( empty( $activity_type ) || empty( $arg ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set the activity track global if not set yet</span></span>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;{$arg} ) ) {&nbsp;</div></li><li><div>      return $bp-&gt;activity-&gt;track[ $activity_type ]-&gt;{$arg};&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all components' activity actions, sorted by their position attribute.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return object Actions ordered by their position.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_actions() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_types = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create the actions for the post types, if they haven't already been created.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post_types ) ) {&nbsp;</div></li><li><div>      foreach ( $post_types as $post_type ) {&nbsp;</div></li><li><div>          if ( isset( $bp-&gt;activity-&gt;actions-&gt;{$post_type-&gt;component_id}-&gt;{$post_type-&gt;action_id} ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_activity_set_action(&nbsp;</div></li><li><div>              $post_type-&gt;component_id, &nbsp;</div></li><li><div>              $post_type-&gt;action_id, &nbsp;</div></li><li><div>              $post_type-&gt;admin_filter, &nbsp;</div></li><li><div>              $post_type-&gt;format_callback, &nbsp;</div></li><li><div>              $post_type-&gt;front_filter, &nbsp;</div></li><li><div>              $post_type-&gt;contexts, &nbsp;</div></li><li><div>              $post_type-&gt;position&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $bp-&gt;activity-&gt;actions;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the current action from a component and key.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $component_id The unique string ID of the component.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key          The action key.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool Action value if found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_action( $component_id, $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Return false if any of the above values are not set.</span></span>&nbsp;</div></li><li><div>  if ( empty( $component_id ) || empty( $key ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $actions = bp_activity_get_actions();&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $actions-&gt;{$component_id}-&gt;{$key} ) ) {&nbsp;</div></li><li><div>      $retval = $actions-&gt;{$component_id}-&gt;{$key};&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the current action by component and key.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|bool $retval       The action key.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $component_id The unique string ID of the component.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $key          The action key.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_action', $retval, $component_id, $key );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch details of all registered activity types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array array( type =&gt; description ), ...</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_types() {&nbsp;</div></li><li><div>  $actions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Walk through the registered actions, and build an array of actions/values.</span>&nbsp;</div></li><li><div>  foreach ( bp_activity_get_actions() as $action ) {&nbsp;</div></li><li><div>      $action = array_values( (array) $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      for ( $i = 0, $i_count = count( $action ); $i &lt; $i_count; $i++ ) {&nbsp;</div></li><li><div>          $actions[ $action[$i]['key'] ] = $action[$i]['value'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// This was a mis-named activity type from before BP 1.6.</span>&nbsp;</div></li><li><div>  unset( $actions['friends_register_activity_action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the available activity types.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $actions Array of registered activity types.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_types', $actions );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the current activity context.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The &quot;context&quot; is the current view type, corresponding roughly to the</span>&nbsp;</div></li><li><div><span class="comment"> * current component. Use this context to determine which activity actions</span>&nbsp;</div></li><li><div><span class="comment"> * should be whitelisted for the filter dropdown.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Activity context. 'member', 'member_groups', 'group', 'activity'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_current_context() {&nbsp;</div></li><li><div>  <span class="comment">// On member pages, default to 'member', unless this is a user's Groups activity.</span>&nbsp;</div></li><li><div>  if ( bp_is_user() ) {&nbsp;</div></li><li><div>      if ( bp_is_active( 'groups' ) && bp_is_current_action( bp_get_groups_slug() ) ) {&nbsp;</div></li><li><div>          $context = 'member_groups';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $context = 'member';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// On individual group pages, default to 'group'.</span>&nbsp;</div></li><li><div>  } elseif ( bp_is_active( 'groups' ) && bp_is_group() ) {&nbsp;</div></li><li><div>      $context = 'group';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 'activity' everywhere else.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $context = 'activity';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $context;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets a flat list of activity actions compatible with a given context.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $context Optional. Name of the context. Defaults to the current context.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_actions_for_context( $context = '' ) {&nbsp;</div></li><li><div>  if ( ! $context ) {&nbsp;</div></li><li><div>      $context = bp_activity_get_current_context();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $actions = array();&nbsp;</div></li><li><div>  foreach ( bp_activity_get_actions() as $component_actions ) {&nbsp;</div></li><li><div>      foreach ( $component_actions as $component_action ) {&nbsp;</div></li><li><div>          if ( in_array( $context, (array) $component_action['context'], true ) ) {&nbsp;</div></li><li><div>              $actions[] = $component_action;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $actions;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Favorites ****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a users favorite activity stream items.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose favorites are being queried.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array IDs of the user's favorite activity items.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_user_favorites( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Fallback to logged in user if no user_id is passed.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get favorites for user.</span>&nbsp;</div></li><li><div>  $favs = bp_get_user_meta( $user_id, 'bp_favorite_activities', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the favorited activity items for a specified user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $favs Array of user's favorited activity items.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_user_favorites', $favs );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add an activity stream item as a favorite for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $activity_id ID of the activity item being favorited.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id     ID of the user favoriting the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_add_user_favorite( $activity_id, $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Favorite activity stream items are for logged in users only.</span></span>&nbsp;</div></li><li><div>  if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Fallback to logged in user if no user_id is passed.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $my_favs = bp_get_user_meta( $user_id, 'bp_favorite_activities', true );&nbsp;</div></li><li><div>  if ( empty( $my_favs ) || ! is_array( $my_favs ) ) {&nbsp;</div></li><li><div>      $my_favs = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if the user has already favorited this activity item.</span>&nbsp;</div></li><li><div>  if ( in_array( $activity_id, $my_favs ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add to user's favorites.</span>&nbsp;</div></li><li><div>  $my_favs[] = $activity_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the total number of users who have favorited this activity.</span></span>&nbsp;</div></li><li><div>  $fav_count = bp_activity_get_meta( $activity_id, 'favorite_count' );&nbsp;</div></li><li><div>  $fav_count = !empty( $fav_count ) ? (int) $fav_count + 1 : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update user meta.</span>&nbsp;</div></li><li><div>  bp_update_user_meta( $user_id, 'bp_favorite_activities', $my_favs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update activity meta counts.</span>&nbsp;</div></li><li><div>  if ( bp_activity_update_meta( $activity_id, 'favorite_count', $fav_count ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires if bp_activity_update_meta() for favorite_count is successful and before returning a true value for success.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.2.1</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $activity_id ID of the activity item being favorited.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $user_id     ID of the user doing the favoriting.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_add_user_favorite', $activity_id, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Success.</span></span>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Saving meta was unsuccessful for an unknown reason.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires if bp_activity_update_meta() for favorite_count is unsuccessful and before returning a false value for failure.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $activity_id ID of the activity item being favorited.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $user_id     ID of the user doing the favoriting.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_add_user_favorite_fail', $activity_id, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove an activity stream item as a favorite for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $activity_id ID of the activity item being unfavorited.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id     ID of the user unfavoriting the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_remove_user_favorite( $activity_id, $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Favorite activity stream items are for logged in users only.</span></span>&nbsp;</div></li><li><div>  if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Fallback to logged in user if no user_id is passed.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $my_favs = bp_get_user_meta( $user_id, 'bp_favorite_activities', true );&nbsp;</div></li><li><div>  $my_favs = array_flip( (array) $my_favs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if the user has not previously favorited the item.</span>&nbsp;</div></li><li><div>  if ( ! isset( $my_favs[ $activity_id ] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the fav from the user's favs.</span>&nbsp;</div></li><li><div>  unset( $my_favs[$activity_id] );&nbsp;</div></li><li><div>  $my_favs = array_unique( array_flip( $my_favs ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Update the total number of users who have favorited this activity.</span></span>&nbsp;</div></li><li><div>  $fav_count = bp_activity_get_meta( $activity_id, 'favorite_count' );&nbsp;</div></li><li><div>  if ( ! empty( $fav_count ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Deduct from total favorites.</span>&nbsp;</div></li><li><div>      if ( bp_activity_update_meta( $activity_id, 'favorite_count', (int) $fav_count - 1 ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update users favorites.</span>&nbsp;</div></li><li><div>          if ( bp_update_user_meta( $user_id, 'bp_favorite_activities', $my_favs ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Fires if bp_update_user_meta() is successful and before returning a true value for success.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 1.2.1</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param int $activity_id ID of the activity item being unfavorited.</span>&nbsp;</div></li><li><div><span class="comment">               * @param int $user_id     ID of the user doing the unfavoriting.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              do_action( 'bp_activity_remove_user_favorite', $activity_id, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Success.</span></span>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Error updating.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Error updating favorite count.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Error getting favorite count.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether an activity item exists with a given content string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The content to filter by.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|null The ID of the located activity item. Null if none is found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_check_exists_by_content( $content ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the results of the check for whether an activity item exists by specified content.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $value ID of the activity if found, else null.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_check_exists_by_content', BP_Activity_Activity::check_exists_by_content( $content ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the last time activity was updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Date last updated.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_last_updated() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the value for the last updated time for an activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $last_updated Date last updated.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_last_updated', BP_Activity_Activity::get_last_updated() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the number of favorite activity stream items a user has.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose favorite count is being requested.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Total favorite count for the user.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_total_favorites_for_user( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fallback on displayed user, and then logged in user.</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = ( bp_displayed_user_id() ) ? bp_displayed_user_id() : bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return BP_Activity_Activity::total_favorite_count( $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Meta *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete a meta entry from the DB for an activity stream item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $wpdb WordPress database access object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id ID of the activity item whose metadata is being deleted.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key    Optional. The key of the metadata being deleted. If</span>&nbsp;</div></li><li><div><span class="comment"> *                            omitted, all metadata associated with the activity</span>&nbsp;</div></li><li><div><span class="comment"> *                            item will be deleted.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_value  Optional. If present, the metadata will only be</span>&nbsp;</div></li><li><div><span class="comment"> *                            deleted if the meta_value matches this parameter.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $delete_all  Optional. If true, delete matching metadata entries</span>&nbsp;</div></li><li><div><span class="comment"> *                            for all objects, ignoring the specified object_id. Otherwise, </span>&nbsp;</div></li><li><div><span class="comment"> *                            only delete matching metadata entries for the specified</span>&nbsp;</div></li><li><div><span class="comment"> *                            activity item. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_delete_meta( $activity_id, $meta_key = '', $meta_value = '', $delete_all = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Legacy - if no meta_key is passed, delete all for the item.</span>&nbsp;</div></li><li><div>  if ( empty( $meta_key ) ) {&nbsp;</div></li><li><div>      $all_meta = bp_activity_get_meta( $activity_id );&nbsp;</div></li><li><div>      $keys = ! empty( $all_meta ) ? array_keys( $all_meta ) : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// With no meta_key, ignore $delete_all.</span>&nbsp;</div></li><li><div>      $delete_all = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $keys = array( $meta_key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>  foreach ( $keys as $key ) {&nbsp;</div></li><li><div>      $retval = delete_metadata( 'activity', $activity_id, $key, $meta_value, $delete_all );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  remove_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get metadata for a given activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id ID of the activity item whose metadata is being requested.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key    Optional. If present, only the metadata matching</span>&nbsp;</div></li><li><div><span class="comment"> *                            that meta key will be returned. Otherwise, all metadata for the</span>&nbsp;</div></li><li><div><span class="comment"> *                            activity item will be fetched.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $single      Optional. If true, return only the first value of the</span>&nbsp;</div></li><li><div><span class="comment"> *                            specified meta_key. This parameter has no effect if meta_key is not</span>&nbsp;</div></li><li><div><span class="comment"> *                            specified. Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed The meta value(s) being requested.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_meta( $activity_id = 0, $meta_key = '', $single = true ) {&nbsp;</div></li><li><div>  add_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>  $retval = get_metadata( 'activity', $activity_id, $meta_key, $single );&nbsp;</div></li><li><div>  remove_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the metadata for a specified activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed  $retval      The meta values for the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $activity_id ID of the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $meta_key    Meta key for the value being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $single      Whether to return one matched meta key row or all.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_meta', $retval, $activity_id, $meta_key, $single );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update a piece of activity meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id ID of the activity item whose metadata is being updated.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key    Key of the metadata being updated.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $meta_value  Value to be set.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $prev_value  Optional. If specified, only update existing metadata entries</span>&nbsp;</div></li><li><div><span class="comment"> *                            with the specified value. Otherwise, update all entries.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|int Returns false on failure. On successful update of existing</span>&nbsp;</div></li><li><div><span class="comment"> *                  metadata, returns true. On successful creation of new metadata, </span>&nbsp;</div></li><li><div><span class="comment"> *                  returns the integer ID of the new metadata row.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_update_meta( $activity_id, $meta_key, $meta_value, $prev_value = '' ) {&nbsp;</div></li><li><div>  add_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>  $retval = update_metadata( 'activity', $activity_id, $meta_key, $meta_value, $prev_value );&nbsp;</div></li><li><div>  remove_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a piece of activity metadata.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $activity_id ID of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key    Metadata key.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $meta_value  Metadata value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $unique      Optional. Whether to enforce a single metadata value for the</span>&nbsp;</div></li><li><div><span class="comment"> *                            given key. If true, and the object already has a value for</span>&nbsp;</div></li><li><div><span class="comment"> *                            the key, no change will be made. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool The meta ID on successful update, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_add_meta( $activity_id, $meta_key, $meta_value, $unique = false ) {&nbsp;</div></li><li><div>  add_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>  $retval = add_metadata( 'activity', $activity_id, $meta_key, $meta_value, $unique );&nbsp;</div></li><li><div>  remove_filter( 'query', 'bp_filter_metaid_column_name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Clean up *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Completely remove a user's activity data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose activity is being deleted.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_remove_all_user_data( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Do not delete user data unless a logged in user says so.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) || ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Clear the user's activity from the sitewide stream and clear their activity tables.</span>&nbsp;</div></li><li><div>  bp_activity_delete( array( 'user_id' =&gt; $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove any usermeta.</span>&nbsp;</div></li><li><div>  bp_delete_user_meta( $user_id, 'bp_latest_update' );&nbsp;</div></li><li><div>  bp_delete_user_meta( $user_id, 'bp_favorite_activities' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Execute additional code</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_remove_data', $user_id ); <span class="comment">// Deprecated! Do not use!</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the removal of all of a user's activity data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user being deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_remove_all_user_data', $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpmu_delete_user', 'bp_activity_remove_all_user_data' );&nbsp;</div></li><li><div>add_action( 'delete_user', 'bp_activity_remove_all_user_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mark all of the user's activity as spam.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $wpdb WordPress database access object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose activity is being spammed.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_spam_all_user_data( $user_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Do not delete user data unless a logged in user says so.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) || ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get all the user's activities.</span></span>&nbsp;</div></li><li><div>  $activities = bp_activity_get( array(&nbsp;</div></li><li><div>      'display_comments' =&gt; 'stream', &nbsp;</div></li><li><div>      'filter' =&gt; array( 'user_id' =&gt; $user_id ), &nbsp;</div></li><li><div>      'show_hidden' =&gt; true&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Mark each as spam.</span>&nbsp;</div></li><li><div>  foreach ( (array) $activities['activities'] as $activity ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Create an activity object.</span></span>&nbsp;</div></li><li><div>      $activity_obj = new BP_Activity_Activity;&nbsp;</div></li><li><div>      foreach ( $activity as $k =&gt; $v ) {&nbsp;</div></li><li><div>          $activity_obj-&gt;$k = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Mark as spam.</span>&nbsp;</div></li><li><div>      bp_activity_mark_as_spam( $activity_obj );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If Akismet is present, update the activity history meta.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * This is usually taken care of when BP_Activity_Activity::save() happens, but</span>&nbsp;</div></li><li><div><span class="comment">       * as we're going to be updating all the activity statuses directly, for efficiency, </span>&nbsp;</div></li><li><div><span class="comment">       * we need to update manually.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;akismet ) ) {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;akismet-&gt;update_activity_spam_meta( $activity_obj );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Tidy up.</span></span>&nbsp;</div></li><li><div>      unset( $activity_obj );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Mark all of this user's activities as spam.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$bp-&gt;activity-&gt;table_name} SET is_spam = 1 WHERE user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after all activity data from a user has been marked as spam.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int   $user_id    ID of the user whose activity is being marked as spam.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $activities Array of activity items being marked as spam.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_spam_all_user_data', $user_id, $activities['activities'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_make_spam_user', 'bp_activity_spam_all_user_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mark all of the user's activity as ham (not spam).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $wpdb WordPress database access object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose activity is being hammed.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_ham_all_user_data( $user_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Do not delete user data unless a logged in user says so.</span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) || ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get all the user's activities.</span></span>&nbsp;</div></li><li><div>  $activities = bp_activity_get( array(&nbsp;</div></li><li><div>      'display_comments' =&gt; 'stream', &nbsp;</div></li><li><div>      'filter' =&gt; array( 'user_id' =&gt; $user_id ), &nbsp;</div></li><li><div>      'show_hidden' =&gt; true, &nbsp;</div></li><li><div>      'spam' =&gt; 'all'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Mark each as not spam.</span>&nbsp;</div></li><li><div>  foreach ( (array) $activities['activities'] as $activity ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Create an activity object.</span></span>&nbsp;</div></li><li><div>      $activity_obj = new BP_Activity_Activity;&nbsp;</div></li><li><div>      foreach ( $activity as $k =&gt; $v ) {&nbsp;</div></li><li><div>          $activity_obj-&gt;$k = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Mark as not spam.</span>&nbsp;</div></li><li><div>      bp_activity_mark_as_ham( $activity_obj );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If Akismet is present, update the activity history meta.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * This is usually taken care of when BP_Activity_Activity::save() happens, but</span>&nbsp;</div></li><li><div><span class="comment">       * as we're going to be updating all the activity statuses directly, for efficiency, </span>&nbsp;</div></li><li><div><span class="comment">       * we need to update manually.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;akismet ) ) {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;akismet-&gt;update_activity_ham_meta( $activity_obj );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Tidy up.</span></span>&nbsp;</div></li><li><div>      unset( $activity_obj );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Mark all of this user's activities as not spam.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$bp-&gt;activity-&gt;table_name} SET is_spam = 0 WHERE user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after all activity data from a user has been marked as ham.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int   $user_id    ID of the user whose activity is being marked as ham.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $activities Array of activity items being marked as ham.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_ham_all_user_data', $user_id, $activities['activities'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_make_ham_user', 'bp_activity_ham_all_user_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register the activity stream actions for updates.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_register_activity_actions() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_activity_set_action(&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;id, &nbsp;</div></li><li><div>      'activity_update', &nbsp;</div></li><li><div>      __( 'Posted a status update', 'buddypress' ), &nbsp;</div></li><li><div>      'bp_activity_format_activity_action_activity_update', &nbsp;</div></li><li><div>      __( 'Updates', 'buddypress' ), &nbsp;</div></li><li><div>      array( 'activity', 'group', 'member', 'member_groups' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_activity_set_action(&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;id, &nbsp;</div></li><li><div>      'activity_comment', &nbsp;</div></li><li><div>      __( 'Replied to a status update', 'buddypress' ), &nbsp;</div></li><li><div>      'bp_activity_format_activity_action_activity_comment', &nbsp;</div></li><li><div>      __( 'Activity Comments', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the activity actions registration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Allows plugin authors to add their own activity actions alongside the core actions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_register_activity_actions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Backpat.</span></span></span> Don't use this.</span>&nbsp;</div></li><li><div>  do_action( 'updates_register_activity_actions' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_register_activity_actions', 'bp_activity_register_activity_actions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate an activity action string for an activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity Activity data object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool Returns false if no callback is found, otherwise returns</span>&nbsp;</div></li><li><div><span class="comment"> *                     the formatted action string.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_generate_action_string( $activity ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for valid input.</span>&nbsp;</div></li><li><div>  if ( empty( $activity-&gt;component ) || empty( $activity-&gt;type ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for registered format callback.</span>&nbsp;</div></li><li><div>  $actions = bp_activity_get_actions();&nbsp;</div></li><li><div>  if ( empty( $actions-&gt;{$activity-&gt;component}-&gt;{$activity-&gt;type}['format_callback'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We apply the format_callback as a filter.</span>&nbsp;</div></li><li><div>  add_filter( 'bp_activity_generate_action_string', $actions-&gt;{$activity-&gt;component}-&gt;{$activity-&gt;type}['format_callback'], 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the string for the activity action being returned.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $action   Action string being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $action = apply_filters( 'bp_activity_generate_action_string', $activity-&gt;action, $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the filter for future activity items.</span>&nbsp;</div></li><li><div>  remove_filter( 'bp_activity_generate_action_string', $actions-&gt;{$activity-&gt;component}-&gt;{$activity-&gt;type}['format_callback'], 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $action;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Format 'activity_update' activity actions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action   Static activity action.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity Activity data object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $action</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_format_activity_action_activity_update( $action, $activity ) {&nbsp;</div></li><li><div>  $action = sprintf( __( '%s posted an update', 'buddypress' ), bp_core_get_userlink( $activity-&gt;user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the formatted activity action update string.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $action   Activity action string value.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_new_update_action', $action, $activity );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Format 'activity_comment' activity actions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action   Static activity action.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity Activity data object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $action</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_format_activity_action_activity_comment( $action, $activity ) {&nbsp;</div></li><li><div>  $action = sprintf( __( '%s posted a new activity comment', 'buddypress' ), bp_core_get_userlink( $activity-&gt;user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the formatted activity action comment string.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $action   Activity action string value.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_comment_action', $action, $activity );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Format activity action strings for custom post types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action   Static activity action.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity Activity data object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $action</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_format_activity_action_custom_post_type_post( $action, $activity ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Fetch all the tracked post types once.</span></span>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity-&gt;type ) || empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ] ) ) {&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_link = bp_core_get_userlink( $activity-&gt;user_id );&nbsp;</div></li><li><div>  $blog_url = get_home_url( $activity-&gt;item_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity-&gt;post_url ) ) {&nbsp;</div></li><li><div>      $post_url = add_query_arg( 'p', $activity-&gt;secondary_item_id, trailingslashit( $blog_url ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_url = $activity-&gt;post_url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $blog_link = '&lt;a href=&quot;' . esc_url( $blog_url ) . '&quot;&gt;' . get_blog_option( $activity-&gt;item_id, 'blogname' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_action_ms ) ) {&nbsp;</div></li><li><div>          $action = sprintf( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_action_ms, $user_link, $post_url, $blog_link );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $action = sprintf( _x( '%1$s wrote a new &lt;a href=&quot;%2$s&quot;&gt;item&lt;/a&gt;, on the site %3$s', 'Activity Custom Post Type post action', 'buddypress' ), $user_link, esc_url( $post_url ), $blog_link );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_action ) ) {&nbsp;</div></li><li><div>          $action = sprintf( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_action, $user_link, $post_url );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $action = sprintf( _x( '%1$s wrote a new &lt;a href=&quot;%2$s&quot;&gt;item&lt;/a&gt;', 'Activity Custom Post Type post action', 'buddypress' ), $user_link, esc_url( $post_url ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the formatted custom post type activity post action string.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $action   Activity action string value.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_custom_post_type_post_action', $action, $activity );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Format activity action strings for custom post types comments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action   Static activity action.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity Activity data object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_format_activity_action_custom_post_type_comment( $action, $activity ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Fetch all the tracked post types once.</span></span>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>      $bp-&gt;activity-&gt;track = bp_activity_get_post_types_tracking_args();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity-&gt;type ) || empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ] ) ) {&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_link = bp_core_get_userlink( $activity-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $blog_link = '&lt;a href=&quot;' . esc_url( get_home_url( $activity-&gt;item_id ) ) . '&quot;&gt;' . get_blog_option( $activity-&gt;item_id, 'blogname' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_comment_action_ms ) ) {&nbsp;</div></li><li><div>          $action = sprintf( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_comment_action_ms, $user_link, $activity-&gt;primary_link, $blog_link );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $action = sprintf( _x( '%1$s commented on the &lt;a href=&quot;%2$s&quot;&gt;item&lt;/a&gt;, on the site %3$s', 'Activity Custom Post Type comment action', 'buddypress' ), $user_link, $activity-&gt;primary_link, $blog_link );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( ! empty( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_comment_action ) ) {&nbsp;</div></li><li><div>          $action = sprintf( $bp-&gt;activity-&gt;track[ $activity-&gt;type ]-&gt;new_post_type_comment_action, $user_link, $activity-&gt;primary_link );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $action = sprintf( _x( '%1$s commented on the &lt;a href=&quot;%2$s&quot;&gt;item&lt;/a&gt;', 'Activity Custom Post Type post comment action', 'buddypress' ), $user_link, $activity-&gt;primary_link );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the formatted custom post type activity comment action string.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $action   Activity action string value.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_custom_post_type_comment_action', $action, $activity );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Business functions are where all the magic happens in BuddyPress. They will</span>&nbsp;</div></li><li><div><span class="comment"> * handle the actual saving or manipulation of information. Usually they will</span>&nbsp;</div></li><li><div><span class="comment"> * hand off to a database class for data access, then return</span>&nbsp;</div></li><li><div><span class="comment"> * true or false on success or failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve an activity or activities.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The bp_activity_get() function shares all arguments with BP_Activity_Activity::get().</span>&nbsp;</div></li><li><div><span class="comment"> * The following is a list of bp_activity_get() parameters that have different</span>&nbsp;</div></li><li><div><span class="comment"> * default values from BP_Activity_Activity::get() (value in parentheses is</span>&nbsp;</div></li><li><div><span class="comment"> * the default for the bp_activity_get()).</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'per_page' (false)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0 Introduced the `$fields` parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Activity_Activity::get() For more information on accepted arguments</span>&nbsp;</div></li><li><div><span class="comment"> *      and the format of the returned value.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args See BP_Activity_Activity::get() for description.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $activity See BP_Activity_Activity::get() for description.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'max' =&gt; false, <span class="comment"><span class="comment">// Maximum number of results to return.</span></span>&nbsp;</div></li><li><div>      'fields' =&gt; 'all', &nbsp;</div></li><li><div>      'page' =&gt; 1, <span class="comment"><span class="comment">// Page 1 without a per_page will result in no pagination.</span></span>&nbsp;</div></li><li><div>      'per_page' =&gt; false, <span class="comment">// results per page</span>&nbsp;</div></li><li><div>      'sort' =&gt; 'DESC', <span class="comment">// sort ASC or DESC</span>&nbsp;</div></li><li><div>      'display_comments' =&gt; false, <span class="comment">// False for no comments. 'stream' for within stream display, 'threaded' for below each activity item.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      'search_terms' =&gt; false, <span class="comment">// Pass search terms as a string</span>&nbsp;</div></li><li><div>      'meta_query' =&gt; false, <span class="comment">// Filter by activity meta. See WP_Meta_Query for format</span>&nbsp;</div></li><li><div>      'date_query' =&gt; false, <span class="comment">// Filter by date. See first parameter of WP_Date_Query for format.</span>&nbsp;</div></li><li><div>      'filter_query' =&gt; false, &nbsp;</div></li><li><div>      'show_hidden' =&gt; false, <span class="comment">// Show activity items that are hidden site-wide?</span>&nbsp;</div></li><li><div>      'exclude' =&gt; false, <span class="comment">// Comma-separated list of activity IDs to exclude.</span>&nbsp;</div></li><li><div>      'in' =&gt; false, <span class="comment">// Comma-separated list or array of activity IDs to which you</span>&nbsp;</div></li><li><div>                                           <span class="comment">// want to limit the query.</span>&nbsp;</div></li><li><div>      'spam' =&gt; 'ham_only', <span class="comment">// 'ham_only' (default), 'spam_only' or 'all'.</span>&nbsp;</div></li><li><div>      'update_meta_cache' =&gt; true, &nbsp;</div></li><li><div>      'count_total' =&gt; false, &nbsp;</div></li><li><div>      'scope' =&gt; false, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Pass filters as an array -- all filter items can be multiple values comma separated:</span>&nbsp;</div></li><li><div><span class="comment">       * array(</span>&nbsp;</div></li><li><div><span class="comment">       *     'user_id' =&gt; false, // User ID to filter on.</span>&nbsp;</div></li><li><div><span class="comment">       *     'object' =&gt; false, // Object to filter on e.g. groups, profile, status, friends.</span>&nbsp;</div></li><li><div><span class="comment">       *     'action' =&gt; false, // Action to filter on e.g. activity_update, profile_updated.</span>&nbsp;</div></li><li><div><span class="comment">       *     'primary_id' =&gt; false, // Object ID to filter on e.g. a group_id or forum_id or blog_id etc.</span>&nbsp;</div></li><li><div><span class="comment">       *     'secondary_id' =&gt; false, // Secondary object ID to filter on e.g. a post_id.</span>&nbsp;</div></li><li><div><span class="comment">       * );</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      'filter' =&gt; array()&nbsp;</div></li><li><div> ), 'activity_get' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity = BP_Activity_Activity::get( array(&nbsp;</div></li><li><div>      'page' =&gt; $r['page'], &nbsp;</div></li><li><div>      'per_page' =&gt; $r['per_page'], &nbsp;</div></li><li><div>      'max' =&gt; $r['max'], &nbsp;</div></li><li><div>      'sort' =&gt; $r['sort'], &nbsp;</div></li><li><div>      'search_terms' =&gt; $r['search_terms'], &nbsp;</div></li><li><div>      'meta_query' =&gt; $r['meta_query'], &nbsp;</div></li><li><div>      'date_query' =&gt; $r['date_query'], &nbsp;</div></li><li><div>      'filter_query' =&gt; $r['filter_query'], &nbsp;</div></li><li><div>      'filter' =&gt; $r['filter'], &nbsp;</div></li><li><div>      'scope' =&gt; $r['scope'], &nbsp;</div></li><li><div>      'display_comments' =&gt; $r['display_comments'], &nbsp;</div></li><li><div>      'show_hidden' =&gt; $r['show_hidden'], &nbsp;</div></li><li><div>      'exclude' =&gt; $r['exclude'], &nbsp;</div></li><li><div>      'in' =&gt; $r['in'], &nbsp;</div></li><li><div>      'spam' =&gt; $r['spam'], &nbsp;</div></li><li><div>      'update_meta_cache' =&gt; $r['update_meta_cache'], &nbsp;</div></li><li><div>      'count_total' =&gt; $r['count_total'], &nbsp;</div></li><li><div>      'fields' =&gt; $r['fields'], &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the requested activity item(s).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Requested activity object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                $r        Arguments used for the activity query.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters_ref_array( 'bp_activity_get', array( &$activity, &$r ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch specific activity items.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Activity_Activity::get() For more information on accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     All arguments and defaults are shared with BP_Activity_Activity::get(), </span>&nbsp;</div></li><li><div><span class="comment"> *     except for the following:</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|int|array Single activity ID, comma-separated list of IDs, </span>&nbsp;</div></li><li><div><span class="comment"> *                            or array of IDs.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $activity See BP_Activity_Activity::get() for description.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_specific( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'activity_ids' =&gt; false, <span class="comment">// A single activity_id or array of IDs.</span>&nbsp;</div></li><li><div>      'display_comments' =&gt; false, <span class="comment">// True or false to display threaded comments for these specific activity items.</span>&nbsp;</div></li><li><div>      'max' =&gt; false, <span class="comment"><span class="comment">// Maximum number of results to return.</span></span>&nbsp;</div></li><li><div>      'page' =&gt; 1, <span class="comment"><span class="comment">// Page 1 without a per_page will result in no pagination.</span></span>&nbsp;</div></li><li><div>      'per_page' =&gt; false, <span class="comment">// Results per page.</span>&nbsp;</div></li><li><div>      'show_hidden' =&gt; true, <span class="comment">// When fetching specific items, show all.</span>&nbsp;</div></li><li><div>      'sort' =&gt; 'DESC', <span class="comment">// Sort ASC or DESC</span>&nbsp;</div></li><li><div>      'spam' =&gt; 'ham_only', <span class="comment">// Retrieve items marked as spam.</span>&nbsp;</div></li><li><div>      'update_meta_cache' =&gt; true, &nbsp;</div></li><li><div> ), 'activity_get_specific' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $get_args = array(&nbsp;</div></li><li><div>      'display_comments' =&gt; $r['display_comments'], &nbsp;</div></li><li><div>      'in' =&gt; $r['activity_ids'], &nbsp;</div></li><li><div>      'max' =&gt; $r['max'], &nbsp;</div></li><li><div>      'page' =&gt; $r['page'], &nbsp;</div></li><li><div>      'per_page' =&gt; $r['per_page'], &nbsp;</div></li><li><div>      'show_hidden' =&gt; $r['show_hidden'], &nbsp;</div></li><li><div>      'sort' =&gt; $r['sort'], &nbsp;</div></li><li><div>      'spam' =&gt; $r['spam'], &nbsp;</div></li><li><div>      'update_meta_cache' =&gt; $r['update_meta_cache'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the requested specific activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Requested activity object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                $args     Original passed in arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                $get_args Constructed arguments used with request.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_specific', BP_Activity_Activity::get( $get_args ), $args, $get_args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add an activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 Added 'error_type' parameter to $args.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     An array of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool $id                Pass an activity ID to update an existing item, or</span>&nbsp;</div></li><li><div><span class="comment"> *                                       false to create a new item. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $action            Optional. The activity action/description, typically</span>&nbsp;</div></li><li><div><span class="comment"> *                                       something like &quot;Joe posted an update&quot;. Values passed to this param</span>&nbsp;</div></li><li><div><span class="comment"> *                                       will be stored in the database and used as a fallback for when the</span>&nbsp;</div></li><li><div><span class="comment"> *                                       activity item's format_callback cannot be found (eg, when the</span>&nbsp;</div></li><li><div><span class="comment"> *                                       component is disabled). As long as you have registered a</span>&nbsp;</div></li><li><div><span class="comment"> *                                       format_callback for your $type, it is unnecessary to include this</span>&nbsp;</div></li><li><div><span class="comment"> *                                       argument - BP will generate it automatically.</span>&nbsp;</div></li><li><div><span class="comment"> *                                       See {@link bp_activity_set_action()}.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $content           Optional. The content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $component         The unique name of the component associated with</span>&nbsp;</div></li><li><div><span class="comment"> *                                       the activity item - 'groups', 'profile', etc.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $type              The specific activity type, used for directory</span>&nbsp;</div></li><li><div><span class="comment"> *                                       filtering. 'new_blog_post', 'activity_update', etc.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $primary_link      Optional. The URL for this item, as used in</span>&nbsp;</div></li><li><div><span class="comment"> *                                       RSS feeds. Defaults to the URL for this activity</span>&nbsp;</div></li><li><div><span class="comment"> *                                       item's permalink page.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool $user_id           Optional. The ID of the user associated with the activity</span>&nbsp;</div></li><li><div><span class="comment"> *                                       item. May be set to false or 0 if the item is not related</span>&nbsp;</div></li><li><div><span class="comment"> *                                       to any user. Default: the ID of the currently logged-in user.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int      $item_id           Optional. The ID of the associated item.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int      $secondary_item_id Optional. The ID of a secondary associated item.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $date_recorded     Optional. The GMT time, in Y-m-d h:i:s format, when</span>&nbsp;</div></li><li><div><span class="comment"> *                                       the item was recorded. Defaults to the current time.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool     $hide_sitewide     Should the item be hidden on sitewide streams?</span>&nbsp;</div></li><li><div><span class="comment"> *                                       Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool     $is_spam           Should the item be marked as spam? Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string   $error_type        Optional. Error type. Either 'bool' or 'wp_error'. Default: 'bool'.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool The ID of the activity on success. False on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_add( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'id' =&gt; false, <span class="comment">// Pass an existing activity ID to update an existing entry.</span>&nbsp;</div></li><li><div>      'action' =&gt; '', <span class="comment">// The activity action - e.g. &quot;Jon Doe posted an update&quot;</span>&nbsp;</div></li><li><div>      'content' =&gt; '', <span class="comment">// Optional: The content of the activity item e.g. &quot;BuddyPress is awesome guys!&quot;</span>&nbsp;</div></li><li><div>      'component' =&gt; false, <span class="comment">// The name/ID of the component e.g. groups, profile, mycomponent.</span>&nbsp;</div></li><li><div>      'type' =&gt; false, <span class="comment">// The activity type e.g. activity_update, profile_updated.</span>&nbsp;</div></li><li><div>      'primary_link' =&gt; '', <span class="comment">// Optional: The primary URL for this item in RSS feeds (defaults to activity permalink).</span>&nbsp;</div></li><li><div>      'user_id' =&gt; bp_loggedin_user_id(), <span class="comment">// Optional: The user to record the activity for, can be false if this activity is not for a user.</span>&nbsp;</div></li><li><div>      'item_id' =&gt; false, <span class="comment">// Optional: The ID of the specific item being recorded, e.g. a blog_id.</span>&nbsp;</div></li><li><div>      'secondary_item_id' =&gt; false, <span class="comment">// Optional: A second ID used to further filter e.g. a comment_id.</span>&nbsp;</div></li><li><div>      'recorded_time' =&gt; bp_core_current_time(), <span class="comment">// The GMT time that this activity was recorded.</span>&nbsp;</div></li><li><div>      'hide_sitewide' =&gt; false, <span class="comment">// Should this be hidden on the sitewide activity stream?</span>&nbsp;</div></li><li><div>      'is_spam' =&gt; false, <span class="comment">// Is this activity item to be marked as spam?</span>&nbsp;</div></li><li><div>      'error_type' =&gt; 'bool'&nbsp;</div></li><li><div> ), 'activity_add' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure we are backwards compatible.</span>&nbsp;</div></li><li><div>  if ( empty( $r['component'] ) && !empty( $r['component_name'] ) ) {&nbsp;</div></li><li><div>      $r['component'] = $r['component_name'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $r['type'] ) && !empty( $r['component_action'] ) ) {&nbsp;</div></li><li><div>      $r['type'] = $r['component_action'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup activity to be added.</span>&nbsp;</div></li><li><div>  $activity = new BP_Activity_Activity( $r['id'] );&nbsp;</div></li><li><div>  $activity-&gt;user_id = $r['user_id'];&nbsp;</div></li><li><div>  $activity-&gt;component = $r['component'];&nbsp;</div></li><li><div>  $activity-&gt;type = $r['type'];&nbsp;</div></li><li><div>  $activity-&gt;content = $r['content'];&nbsp;</div></li><li><div>  $activity-&gt;primary_link = $r['primary_link'];&nbsp;</div></li><li><div>  $activity-&gt;item_id = $r['item_id'];&nbsp;</div></li><li><div>  $activity-&gt;secondary_item_id = $r['secondary_item_id'];&nbsp;</div></li><li><div>  $activity-&gt;date_recorded = $r['recorded_time'];&nbsp;</div></li><li><div>  $activity-&gt;hide_sitewide = $r['hide_sitewide'];&nbsp;</div></li><li><div>  $activity-&gt;is_spam = $r['is_spam'];&nbsp;</div></li><li><div>  $activity-&gt;error_type = $r['error_type'];&nbsp;</div></li><li><div>  $activity-&gt;action = ! empty( $r['action'] )&nbsp;</div></li><li><div>                      ? $r['action']&nbsp;</div></li><li><div>                      : bp_activity_generate_action_string( $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $save = $activity-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'wp_error' === $r['error_type'] && is_wp_error( $save ) ) {&nbsp;</div></li><li><div>      return $save;&nbsp;</div></li><li><div>  } elseif ('bool' === $r['error_type'] && false === $save ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If this is an activity comment, rebuild the tree.</span>&nbsp;</div></li><li><div>  if ( 'activity_comment' === $activity-&gt;type ) {&nbsp;</div></li><li><div>      <span class="comment">// Also clear the comment cache for the parent activity ID.</span>&nbsp;</div></li><li><div>      wp_cache_delete( $activity-&gt;item_id, 'bp_activity_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      BP_Activity_Activity::rebuild_activity_comment_tree( $activity-&gt;item_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( 'bp_activity_sitewide_front', 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the execution of adding a new activity item, before returning the new activity item ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $r Array of parsed arguments for the activity item being added.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_add', $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $activity-&gt;id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Post an activity update.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $content    The content of the activity update.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $user_id    Optional. Defaults to the logged-in user.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $error_type Optional. Error type to return. Either 'bool' or 'wp_error'. Defaults to</span>&nbsp;</div></li><li><div><span class="comment"> *                              'bool' for boolean. 'wp_error' will return a WP_Error object.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool|WP_Error $activity_id The activity id on success. On failure, either boolean false or WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> *                                        object depending on the 'error_type' $args parameter.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_update( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'content' =&gt; false, &nbsp;</div></li><li><div>      'user_id' =&gt; bp_loggedin_user_id(), &nbsp;</div></li><li><div>      'error_type' =&gt; 'bool', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $r['content'] ) || !strlen( trim( $r['content'] ) ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_user_inactive( $r['user_id'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Record this on the user's profile.</span>&nbsp;</div></li><li><div>  $activity_content = $r['content'];&nbsp;</div></li><li><div>  $primary_link = bp_core_get_userlink( $r['user_id'], false, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the new activity content for current activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $activity_content Activity content posted by user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $add_content = apply_filters( 'bp_activity_new_update_content', $activity_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the activity primary link for current activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $primary_link Link to the profile for the user who posted the activity.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $add_primary_link = apply_filters( 'bp_activity_new_update_primary_link', $primary_link );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Now write the values.</span>&nbsp;</div></li><li><div>  $activity_id = bp_activity_add( array(&nbsp;</div></li><li><div>      'user_id' =&gt; $r['user_id'], &nbsp;</div></li><li><div>      'content' =&gt; $add_content, &nbsp;</div></li><li><div>      'primary_link' =&gt; $add_primary_link, &nbsp;</div></li><li><div>      'component' =&gt; buddypress()-&gt;activity-&gt;id, &nbsp;</div></li><li><div>      'type' =&gt; 'activity_update', &nbsp;</div></li><li><div>      'error_type' =&gt; $r['error_type']&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail on failure.</span></span>&nbsp;</div></li><li><div>  if ( false === $activity_id || is_wp_error( $activity_id ) ) {&nbsp;</div></li><li><div>      return $activity_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the latest update content for the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $r                Content of the activity update.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $activity_content Content of the activity update.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $activity_content = apply_filters( 'bp_activity_latest_update_content', $r['content'], $activity_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add this update to the &quot;latest update&quot; usermeta so it can be fetched anywhere.</span>&nbsp;</div></li><li><div>  bp_update_user_meta( bp_loggedin_user_id(), 'bp_latest_update', array(&nbsp;</div></li><li><div>      'id' =&gt; $activity_id, &nbsp;</div></li><li><div>      'content' =&gt; $activity_content&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of an activity post update, before returning the updated activity item ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content     Content of the activity post update.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id     ID of the user posting the activity update.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $activity_id ID of the activity item being updated.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_posted_update', $r['content'], $r['user_id'], $activity_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $activity_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create an activity item for a newly published post type post.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int          $post_id ID of the new post.</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post|null $post    Post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int          $user_id ID of the post author.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool The ID of the activity on success. False on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_publish( $post_id = 0, $post = null, $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_a( $post, 'WP_Post' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the post</span> type tracking args.</span></span></span>&nbsp;</div></li><li><div>  $activity_post_object = bp_activity_get_post_type_tracking_args( $post-&gt;post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'publish' != $post-&gt;post_status || ! empty( $post-&gt;post_password ) || empty( $activity_post_object-&gt;action_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_id ) ) {&nbsp;</div></li><li><div>      $post_id = $post-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = (int) $post-&gt;post_author;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if an activity item already exists for this post.</span>&nbsp;</div></li><li><div>  $existing = bp_activity_get( array(&nbsp;</div></li><li><div>      'filter' =&gt; array(&nbsp;</div></li><li><div>          'action' =&gt; $activity_post_object-&gt;action_id, &nbsp;</div></li><li><div>          'primary_id' =&gt; $blog_id, &nbsp;</div></li><li><div>          'secondary_id' =&gt; $post_id, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $existing['activities'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to post the activity.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This is a variable filter, dependent on the post type, </span>&nbsp;</div></li><li><div><span class="comment">   * that lets components or plugins bail early if needed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $value   Whether or not to continue.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $blog_id ID of the current site.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $post_id ID of the current post being published.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $user_id ID of the current user or post author.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( false === apply_filters( &quot;bp_activity_{$post-&gt;post_type}_pre_publish&quot;, true, $blog_id, $post_id, $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Record this in activity streams.</span></span>&nbsp;</div></li><li><div>  $blog_url = get_home_url( $blog_id );&nbsp;</div></li><li><div>  $post_url = add_query_arg(&nbsp;</div></li><li><div>      'p', &nbsp;</div></li><li><div>      $post_id, &nbsp;</div></li><li><div>      trailingslashit( $blog_url )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Backward compatibility filters for the 'blogs' component.</span></span>&nbsp;</div></li><li><div>  if ( 'blogs' == $activity_post_object-&gt;component_id )  {&nbsp;</div></li><li><div>      $activity_content = apply_filters( 'bp_blogs_activity_new_post_content', $post-&gt;post_content, $post, $post_url, $post-&gt;post_type );&nbsp;</div></li><li><div>      $activity_primary_link = apply_filters( 'bp_blogs_activity_new_post_primary_link', $post_url, $post_id, $post-&gt;post_type );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $activity_content = $post-&gt;post_content;&nbsp;</div></li><li><div>      $activity_primary_link = $post_url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_args = array(&nbsp;</div></li><li><div>      'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>      'content' =&gt; $activity_content, &nbsp;</div></li><li><div>      'primary_link' =&gt; $activity_primary_link, &nbsp;</div></li><li><div>      'component' =&gt; $activity_post_object-&gt;component_id, &nbsp;</div></li><li><div>      'type' =&gt; $activity_post_object-&gt;action_id, &nbsp;</div></li><li><div>      'item_id' =&gt; $blog_id, &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; $post_id, &nbsp;</div></li><li><div>      'recorded_time' =&gt; $post-&gt;post_date_gmt, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $activity_args['content'] ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Create the excerpt.</span></span>&nbsp;</div></li><li><div>      $activity_summary = bp_activity_create_summary( $activity_args['content'], $activity_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backward compatibility filter for blog posts.</span>&nbsp;</div></li><li><div>      if ( 'blogs' == $activity_post_object-&gt;component_id )  {&nbsp;</div></li><li><div>          $activity_args['content'] = apply_filters( 'bp_blogs_record_activity_content', $activity_summary, $activity_args['content'], $activity_args, $post-&gt;post_type );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $activity_args['content'] = $activity_summary;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set up the action by using the format functions.</span></span>&nbsp;</div></li><li><div>  $action_args = array_merge( $activity_args, array(&nbsp;</div></li><li><div>      'post_title' =&gt; $post-&gt;post_title, &nbsp;</div></li><li><div>      'post_url' =&gt; $post_url, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_args['action'] = call_user_func_array( $activity_post_object-&gt;format_callback, array( '', (object) $action_args ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Make sure the action is set.</span></span>&nbsp;</div></li><li><div>  if ( empty( $activity_args['action'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Backward compatibility filter for the blogs component.</span></span></span>&nbsp;</div></li><li><div>      if ( 'blogs' == $activity_post_object-&gt;component_id )  {&nbsp;</div></li><li><div>          $activity_args['action'] = apply_filters( 'bp_blogs_record_activity_action', $activity_args['action'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_id = bp_activity_add( $activity_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the publishing of an activity item for a newly published post type post.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $activity_id   ID of the newly published activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post          Post object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $activity_args Array of activity arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_post_type_published', $activity_id, $post, $activity_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $activity_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the activity item for a custom post type entry.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post|null $post Post item.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_update( $post = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_a( $post, 'WP_Post' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the post</span> type tracking args.</span></span></span>&nbsp;</div></li><li><div>  $activity_post_object = bp_activity_get_post_type_tracking_args( $post-&gt;post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity_post_object-&gt;action_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_id = bp_activity_get_activity_id( array(&nbsp;</div></li><li><div>      'component' =&gt; $activity_post_object-&gt;component_id, &nbsp;</div></li><li><div>      'item_id' =&gt; get_current_blog_id(), &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>      'type' =&gt; $activity_post_object-&gt;action_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Activity ID doesn't exist, so stop!</span>&nbsp;</div></li><li><div>  if ( empty( $activity_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete the activity if the post was updated with a password.</span>&nbsp;</div></li><li><div>  if ( ! empty( $post-&gt;post_password ) ) {&nbsp;</div></li><li><div>      bp_activity_delete( array( 'id' =&gt; $activity_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the activity entry.</span>&nbsp;</div></li><li><div>  $activity = new BP_Activity_Activity( $activity_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $post-&gt;post_content ) ) {&nbsp;</div></li><li><div>      $activity_summary = bp_activity_create_summary( $post-&gt;post_content, (array) $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Backward compatibility filter for the blogs component.</span></span></span>&nbsp;</div></li><li><div>      if ( 'blogs' == $activity_post_object-&gt;component_id ) {&nbsp;</div></li><li><div>          $activity-&gt;content = apply_filters( 'bp_blogs_record_activity_content', $activity_summary, $post-&gt;post_content, (array) $activity, $post-&gt;post_type );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $activity-&gt;content = $activity_summary;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Save the updated activity.</span>&nbsp;</div></li><li><div>  $updated = $activity-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the updating of an activity item for a custom post type entry.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0 Add the post type tracking args parameter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post              $post                 Post object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity             Activity object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param object               $activity_post_object The post type tracking args object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_post_type_updated', $post, $activity, $activity_post_object );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $updated;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Unpublish an activity for the custom post type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int          $post_id ID of the post being unpublished.</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post|null $post    Post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_unpublish( $post_id = 0, $post = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_a( $post, 'WP_Post' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the post</span> type tracking args.</span></span></span>&nbsp;</div></li><li><div>  $activity_post_object = bp_activity_get_post_type_tracking_args( $post-&gt;post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity_post_object-&gt;action_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_id ) ) {&nbsp;</div></li><li><div>      $post_id = $post-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $delete_activity_args = array(&nbsp;</div></li><li><div>      'item_id' =&gt; get_current_blog_id(), &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; $post_id, &nbsp;</div></li><li><div>      'component' =&gt; $activity_post_object-&gt;component_id, &nbsp;</div></li><li><div>      'type' =&gt; $activity_post_object-&gt;action_id, &nbsp;</div></li><li><div>      'user_id' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $deleted = bp_activity_delete_by_item_id( $delete_activity_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the unpublishing for the custom post type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $delete_activity_args Array of arguments for activity deletion.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post                 Post object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool    $activity             Whether or not the activity was successfully deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_post_type_unpublished', $delete_activity_args, $post, $deleted );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $deleted;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create an activity item for a newly posted post type comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int         $comment_id           ID of the comment.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  bool        $is_approved          Whether the comment is approved or not.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  object|null $activity_post_object The post type tracking args object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool The ID of the activity on success. False on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_comment( $comment_id = 0, $is_approved = true, $activity_post_object = null ) {&nbsp;</div></li><li><div>  <span class="comment">// Get the users comment</span>&nbsp;</div></li><li><div>  $post_type_comment = get_comment( $comment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't record activity if the comment hasn't been approved</span>&nbsp;</div></li><li><div>  if ( empty( $is_approved ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't record activity if no email address has been included</span>&nbsp;</div></li><li><div>  if ( empty( $post_type_comment-&gt;comment_author_email ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't record activity if the comment has already been marked as spam</span>&nbsp;</div></li><li><div>  if ( 'spam' === $is_approved ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the user by the comment author email.</span>&nbsp;</div></li><li><div>  $user = get_user_by( 'email', $post_type_comment-&gt;comment_author_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If user isn't registered, don't record activity</span>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the user_id</span>&nbsp;</div></li><li><div>  $user_id = (int) $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get blog and post data</span>&nbsp;</div></li><li><div>  $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the post</span>&nbsp;</div></li><li><div>  $post_type_comment-&gt;post = get_post( $post_type_comment-&gt;comment_post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_a( $post_type_comment-&gt;post, 'WP_Post' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to publish activities about the comment regarding the post status</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool true to bail, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $is_post_status_not_allowed = (bool) apply_filters( 'bp_activity_post_type_is_post_status_allowed', 'publish' !== $post_type_comment-&gt;post-&gt;post_status || ! empty( $post_type_comment-&gt;post-&gt;post_password ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If this is a password protected post, or not a public post don't record the comment</span>&nbsp;</div></li><li><div>  if ( $is_post_status_not_allowed ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set post type</span>&nbsp;</div></li><li><div>  $post_type = $post_type_comment-&gt;post-&gt;post_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity_post_object ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the post</span> type tracking args.</span></span></span>&nbsp;</div></li><li><div>      $activity_post_object = bp_activity_get_post_type_tracking_args( $post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Bail if the activity type does not exist</span></span>&nbsp;</div></li><li><div>      if ( empty( $activity_post_object-&gt;comments_tracking-&gt;action_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set the $activity_comment_object</span></span>&nbsp;</div></li><li><div>  $activity_comment_object = $activity_post_object-&gt;comments_tracking;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to post the activity about the comment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This is a variable filter, dependent on the post type, </span>&nbsp;</div></li><li><div><span class="comment">   * that lets components or plugins bail early if needed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $value      Whether or not to continue.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $blog_id    ID of the current site.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $post_id    ID of the current post being commented.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $user_id    ID of the current user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $comment_id ID of the current comment being posted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( false === apply_filters( &quot;bp_activity_{$post_type}_pre_comment&quot;, true, $blog_id, $post_type_comment-&gt;post-&gt;ID, $user_id, $comment_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is this an update ?</span>&nbsp;</div></li><li><div>  $activity_id = bp_activity_get_activity_id( array(&nbsp;</div></li><li><div>      'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>      'component' =&gt; $activity_comment_object-&gt;component_id, &nbsp;</div></li><li><div>      'type' =&gt; $activity_comment_object-&gt;action_id, &nbsp;</div></li><li><div>      'item_id' =&gt; $blog_id, &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; $comment_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Record this in activity streams.</span></span>&nbsp;</div></li><li><div>  $comment_link = get_comment_link( $post_type_comment-&gt;comment_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Backward compatibility filters for the 'blogs' component.</span></span>&nbsp;</div></li><li><div>  if ( 'blogs' == $activity_comment_object-&gt;component_id )  {&nbsp;</div></li><li><div>      $activity_content = apply_filters_ref_array( 'bp_blogs_activity_new_comment_content', array( $post_type_comment-&gt;comment_content, &$post_type_comment, $comment_link ) );&nbsp;</div></li><li><div>      $activity_primary_link = apply_filters_ref_array( 'bp_blogs_activity_new_comment_primary_link', array( $comment_link, &$post_type_comment ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $activity_content = $post_type_comment-&gt;comment_content;&nbsp;</div></li><li><div>      $activity_primary_link = $comment_link;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_args = array(&nbsp;</div></li><li><div>      'id' =&gt; $activity_id, &nbsp;</div></li><li><div>      'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>      'content' =&gt; $activity_content, &nbsp;</div></li><li><div>      'primary_link' =&gt; $activity_primary_link, &nbsp;</div></li><li><div>      'component' =&gt; $activity_comment_object-&gt;component_id, &nbsp;</div></li><li><div>      'recorded_time' =&gt; $post_type_comment-&gt;comment_date_gmt, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_disable_blogforum_comments() ) {&nbsp;</div></li><li><div>      $blog_url = get_home_url( $blog_id );&nbsp;</div></li><li><div>      $post_url = add_query_arg(&nbsp;</div></li><li><div>          'p', &nbsp;</div></li><li><div>          $post_type_comment-&gt;post-&gt;ID, &nbsp;</div></li><li><div>          trailingslashit( $blog_url )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $activity_args['type'] = $activity_comment_object-&gt;action_id;&nbsp;</div></li><li><div>      $activity_args['item_id'] = $blog_id;&nbsp;</div></li><li><div>      $activity_args['secondary_item_id'] = $post_type_comment-&gt;comment_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $activity_args['content'] ) ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Create the excerpt.</span></span>&nbsp;</div></li><li><div>          $activity_summary = bp_activity_create_summary( $activity_args['content'], $activity_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Backward compatibility filter for blog comments.</span>&nbsp;</div></li><li><div>          if ( 'blogs' == $activity_post_object-&gt;component_id )  {&nbsp;</div></li><li><div>              $activity_args['content'] = apply_filters( 'bp_blogs_record_activity_content', $activity_summary, $activity_args['content'], $activity_args, $post_type );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $activity_args['content'] = $activity_summary;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Set up the action by using the format functions.</span></span>&nbsp;</div></li><li><div>      $action_args = array_merge( $activity_args, array(&nbsp;</div></li><li><div>          'post_title' =&gt; $post_type_comment-&gt;post-&gt;post_title, &nbsp;</div></li><li><div>          'post_url' =&gt; $post_url, &nbsp;</div></li><li><div>          'blog_url' =&gt; $blog_url, &nbsp;</div></li><li><div>          'blog_name' =&gt; get_blog_option( $blog_id, 'blogname' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $activity_args['action'] = call_user_func_array( $activity_comment_object-&gt;format_callback, array( '', (object) $action_args ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Make sure the action is set.</span></span>&nbsp;</div></li><li><div>      if ( empty( $activity_args['action'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Backward compatibility filter for the blogs component.</span></span></span>&nbsp;</div></li><li><div>          if ( 'blogs' === $activity_post_object-&gt;component_id )  {&nbsp;</div></li><li><div>              $activity_args['action'] = apply_filters( 'bp_blogs_record_activity_action', $activity_args['action'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $activity_id = bp_activity_add( $activity_args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the publishing of an activity item for a newly published post type post.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int        $activity_id          ID of the newly published activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Comment $post_type_comment    Comment object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array      $activity_args        Array of activity arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @param object     $activity_post_object the post type tracking args object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action_ref_array( 'bp_activity_post_type_comment', array( &$activity_id, $post_type_comment, $activity_args, $activity_post_object ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $activity_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'comment_post', 'bp_activity_post_type_comment', 10, 2 );&nbsp;</div></li><li><div>add_action( 'edit_comment', 'bp_activity_post_type_comment', 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove an activity item when a comment about a post type is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int         $comment_id           ID of the comment.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  object|null $activity_post_object The post type tracking args object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success. False on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_post_type_remove_comment( $comment_id = 0, $activity_post_object = null ) {&nbsp;</div></li><li><div>  if ( empty( $activity_post_object ) ) {&nbsp;</div></li><li><div>      $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>      if ( ! $comment ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_type = get_post_type( $comment-&gt;comment_post_ID );&nbsp;</div></li><li><div>      if ( ! $post_type ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Get the post</span> type tracking args.</span></span></span>&nbsp;</div></li><li><div>      $activity_post_object = bp_activity_get_post_type_tracking_args( $post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Bail if the activity type does not exist</span></span>&nbsp;</div></li><li><div>      if ( empty( $activity_post_object-&gt;comments_tracking-&gt;action_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set the $activity_comment_object</span></span>&nbsp;</div></li><li><div>  $activity_comment_object = $activity_post_object-&gt;comments_tracking;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity_comment_object-&gt;action_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $deleted = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_disable_blogforum_comments() ) {&nbsp;</div></li><li><div>      $deleted = bp_activity_delete_by_item_id( array(&nbsp;</div></li><li><div>          'item_id' =&gt; get_current_blog_id(), &nbsp;</div></li><li><div>          'secondary_item_id' =&gt; $comment_id, &nbsp;</div></li><li><div>          'component' =&gt; $activity_comment_object-&gt;component_id, &nbsp;</div></li><li><div>          'type' =&gt; $activity_comment_object-&gt;action_id, &nbsp;</div></li><li><div>          'user_id' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the custom post type comment activity was removed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool       $deleted              True if the activity was deleted false otherwise</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Comment $comment              Comment object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param object     $activity_post_object The post type tracking args object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string     $value                The post type comment activity type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_post_type_remove_comment', $deleted, $comment_id, $activity_post_object, $activity_comment_object-&gt;action_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $deleted;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'delete_comment', 'bp_activity_post_type_remove_comment', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add an activity comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0 Add a new possible parameter $skip_notification for the array of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *              Add the $primary_link parameter for the array of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 Added 'error_type' parameter to $args.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     An array of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $id                Optional. Pass an ID to update an existing comment.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $content           The content of the comment.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $user_id           Optional. The ID of the user making the comment.</span>&nbsp;</div></li><li><div><span class="comment"> *                                     Defaults to the ID of the logged-in user.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $activity_id       The ID of the &quot;root&quot; activity item, ie the oldest</span>&nbsp;</div></li><li><div><span class="comment"> *                                     ancestor of the comment.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $parent_id         Optional. The ID of the parent activity item, ie the item to</span>&nbsp;</div></li><li><div><span class="comment"> *                                     which the comment is an immediate reply. If not provided, </span>&nbsp;</div></li><li><div><span class="comment"> *                                     this value defaults to the $activity_id.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $primary_link      Optional. the primary link for the comment.</span>&nbsp;</div></li><li><div><span class="comment"> *                                     Defaults to an empty string.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool   $skip_notification Optional. false to send a comment notification, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> *                                     Defaults to false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $error_type        Optional. Error type. Either 'bool' or 'wp_error'. Default: 'bool'.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool The ID of the comment on success, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_new_comment( $args = '' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'id' =&gt; false, &nbsp;</div></li><li><div>      'content' =&gt; false, &nbsp;</div></li><li><div>      'user_id' =&gt; bp_loggedin_user_id(), &nbsp;</div></li><li><div>      'activity_id' =&gt; false, <span class="comment">// ID of the root activity item.</span>&nbsp;</div></li><li><div>      'parent_id' =&gt; false, <span class="comment">// ID of a parent comment (optional).</span>&nbsp;</div></li><li><div>      'primary_link' =&gt; '', &nbsp;</div></li><li><div>      'skip_notification' =&gt; false, &nbsp;</div></li><li><div>      'error_type' =&gt; 'bool'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Error type is boolean; need to initialize some variables for backpat.</span>&nbsp;</div></li><li><div>  if ( 'bool' === $r['error_type'] ) {&nbsp;</div></li><li><div>      if ( empty( $bp-&gt;activity-&gt;errors ) ) {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;errors = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default error message.</span>&nbsp;</div></li><li><div>  $feedback = __( 'There was an error posting your reply. Please try again.', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if missing necessary data.</span>&nbsp;</div></li><li><div>  if ( empty( $r['content'] ) || empty( $r['user_id'] ) || empty( $r['activity_id'] ) ) {&nbsp;</div></li><li><div>      $error = new WP_Error( 'missing_data', $feedback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'wp_error' === $r['error_type'] ) {&nbsp;</div></li><li><div>          return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Backpat.</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;errors['new_comment'] = $error;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Maybe set current activity ID as the parent.</span>&nbsp;</div></li><li><div>  if ( empty( $r['parent_id'] ) ) {&nbsp;</div></li><li><div>      $r['parent_id'] = $r['activity_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_id = $r['activity_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the parent activity.</span>&nbsp;</div></li><li><div>  $activity = new BP_Activity_Activity( $activity_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if the parent activity does not exist.</span>&nbsp;</div></li><li><div>  if ( empty( $activity-&gt;date_recorded ) ) {&nbsp;</div></li><li><div>      $error = new WP_Error( 'missing_activity', __( 'The item you were replying to no longer exists.', 'buddypress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'wp_error' === $r['error_type'] ) {&nbsp;</div></li><li><div>          return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Backpat.</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;errors['new_comment'] = $error;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check to see if the parent activity is hidden, and if so, hide this comment publicly.</span>&nbsp;</div></li><li><div>  $is_hidden = $activity-&gt;hide_sitewide ? 1 : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the content of a new comment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $r Content for the newly posted comment.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $comment_content = apply_filters( 'bp_activity_comment_content', $r['content'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Insert the activity comment.</span>&nbsp;</div></li><li><div>  $comment_id = bp_activity_add( array(&nbsp;</div></li><li><div>      'id' =&gt; $r['id'], &nbsp;</div></li><li><div>      'content' =&gt; $comment_content, &nbsp;</div></li><li><div>      'component' =&gt; buddypress()-&gt;activity-&gt;id, &nbsp;</div></li><li><div>      'type' =&gt; 'activity_comment', &nbsp;</div></li><li><div>      'primary_link' =&gt; $r['primary_link'], &nbsp;</div></li><li><div>      'user_id' =&gt; $r['user_id'], &nbsp;</div></li><li><div>      'item_id' =&gt; $activity_id, &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; $r['parent_id'], &nbsp;</div></li><li><div>      'hide_sitewide' =&gt; $is_hidden, &nbsp;</div></li><li><div>      'error_type' =&gt; $r['error_type']&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail on failure.</span></span>&nbsp;</div></li><li><div>  if ( false === $comment_id || is_wp_error( $comment_id ) ) {&nbsp;</div></li><li><div>      return $comment_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Comment caches are stored only with the top-level item.</span>&nbsp;</div></li><li><div>  wp_cache_delete( $activity_id, 'bp_activity_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Walk the tree to clear caches for all parent items.</span>&nbsp;</div></li><li><div>  $clear_id = $r['parent_id'];&nbsp;</div></li><li><div>  while ( $clear_id != $activity_id ) {&nbsp;</div></li><li><div>      $clear_object = new BP_Activity_Activity( $clear_id );&nbsp;</div></li><li><div>      wp_cache_delete( $clear_id, 'bp_activity' );&nbsp;</div></li><li><div>      $clear_id = intval( $clear_object-&gt;secondary_item_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_cache_delete( $activity_id, 'bp_activity' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $r[ 'skip_notification' ] ) ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires near the end of an activity comment posting, before the returning of the comment ID.</span>&nbsp;</div></li><li><div><span class="comment">       * Sends a notification to the user @see bp_activity_new_comment_notification_helper().</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $comment_id ID of the newly posted activity comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array                $r          Array of parsed comment arguments.</span>&nbsp;</div></li><li><div><span class="comment">       * @param BP_Activity_Activity $activity   Activity item being commented on.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_comment_posted', $comment_id, $r, $activity );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires near the end of an activity comment posting, before the returning of the comment ID.</span>&nbsp;</div></li><li><div><span class="comment">       * without sending a notification to the user</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $comment_id ID of the newly posted activity comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array                $r          Array of parsed comment arguments.</span>&nbsp;</div></li><li><div><span class="comment">       * @param BP_Activity_Activity $activity   Activity item being commented on.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_comment_posted_notification_skipped', $comment_id, $r, $activity );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $comment_id ) ) {&nbsp;</div></li><li><div>      $error = new WP_Error( 'comment_failed', $feedback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'wp_error' === $r['error_type'] ) {&nbsp;</div></li><li><div>          return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Backpat.</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $bp-&gt;activity-&gt;errors['new_comment'] = $error;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $comment_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch the activity_id for an existing activity entry in the DB.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Activity_Activity::get() For more information on accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args See BP_Activity_Activity::get() for description.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int $activity_id The ID of the activity item found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_activity_id( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'user_id' =&gt; false, &nbsp;</div></li><li><div>      'component' =&gt; false, &nbsp;</div></li><li><div>      'type' =&gt; false, &nbsp;</div></li><li><div>      'item_id' =&gt; false, &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; false, &nbsp;</div></li><li><div>      'action' =&gt; false, &nbsp;</div></li><li><div>      'content' =&gt; false, &nbsp;</div></li><li><div>      'date_recorded' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the activity ID being requested.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0 Added the `$r` and `$args` parameters.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $value ID returned by BP_Activity_Activity get_id() method with provided arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                $r     Parsed function arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                $args  Arguments passed to the function.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_get_activity_id', BP_Activity_Activity::get_id(&nbsp;</div></li><li><div>      $r['user_id'], &nbsp;</div></li><li><div>      $r['component'], &nbsp;</div></li><li><div>      $r['type'], &nbsp;</div></li><li><div>      $r['item_id'], &nbsp;</div></li><li><div>      $r['secondary_item_id'], &nbsp;</div></li><li><div>      $r['action'], &nbsp;</div></li><li><div>      $r['content'], &nbsp;</div></li><li><div>      $r['date_recorded']&nbsp;</div></li><li><div> ), $r, $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete activity item(s).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If you're looking to hook into one action that provides the ID(s) of</span>&nbsp;</div></li><li><div><span class="comment"> * the activity/activities deleted, then use:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * add_action( 'bp_activity_deleted_activities', 'my_function' );</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The action passes one parameter that is a single activity ID or an</span>&nbsp;</div></li><li><div><span class="comment"> * array of activity IDs depending on the number deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If you are deleting an activity comment please use bp_activity_delete_comment();</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Activity_Activity::get() For more information on accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args To delete specific activity items, use</span>&nbsp;</div></li><li><div><span class="comment"> *                           $args = array( 'id' =&gt; $ids ); Otherwise, to use</span>&nbsp;</div></li><li><div><span class="comment"> *                           filters for item deletion, the argument format is</span>&nbsp;</div></li><li><div><span class="comment"> *                           the same as BP_Activity_Activity::get().</span>&nbsp;</div></li><li><div><span class="comment"> *                           See that method for a description.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_delete( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Pass one or more the of following variables to delete by those variables.</span>&nbsp;</div></li><li><div>  $args = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'id' =&gt; false, &nbsp;</div></li><li><div>      'action' =&gt; false, &nbsp;</div></li><li><div>      'content' =&gt; false, &nbsp;</div></li><li><div>      'component' =&gt; false, &nbsp;</div></li><li><div>      'type' =&gt; false, &nbsp;</div></li><li><div>      'primary_link' =&gt; false, &nbsp;</div></li><li><div>      'user_id' =&gt; false, &nbsp;</div></li><li><div>      'item_id' =&gt; false, &nbsp;</div></li><li><div>      'secondary_item_id' =&gt; false, &nbsp;</div></li><li><div>      'date_recorded' =&gt; false, &nbsp;</div></li><li><div>      'hide_sitewide' =&gt; false&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before an activity item proceeds to be deleted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args Array of arguments to be used with the activity deletion.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_before_activity_delete', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Adjust the new mention count of any mentioned member.</span>&nbsp;</div></li><li><div>  bp_activity_adjust_mention_count( $args['id'], 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_ids_deleted = BP_Activity_Activity::delete( $args );&nbsp;</div></li><li><div>  if ( empty( $activity_ids_deleted ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the user's latest update has been deleted.</span>&nbsp;</div></li><li><div>  $user_id = empty( $args['user_id'] )&nbsp;</div></li><li><div>      ? bp_loggedin_user_id()&nbsp;</div></li><li><div>      : $args['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $latest_update = bp_get_user_meta( $user_id, 'bp_latest_update', true );&nbsp;</div></li><li><div>  if ( !empty( $latest_update ) ) {&nbsp;</div></li><li><div>      if ( in_array( (int) $latest_update['id'], (array) $activity_ids_deleted ) ) {&nbsp;</div></li><li><div>          bp_delete_user_meta( $user_id, 'bp_latest_update' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the activity item has been deleted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args Array of arguments used with the activity deletion.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_delete', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the activity item has been deleted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $activity_ids_deleted Array of affected activity item IDs.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_deleted_activities', $activity_ids_deleted );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( 'bp_activity_sitewide_front', 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete an activity item by activity id.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * You should use bp_activity_delete() instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|string $args See BP_Activity_Activity::get for a</span>&nbsp;</div></li><li><div><span class="comment">   *                           description of accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_activity_delete_by_item_id( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>          'item_id' =&gt; false, &nbsp;</div></li><li><div>          'component' =&gt; false, &nbsp;</div></li><li><div>          'type' =&gt; false, &nbsp;</div></li><li><div>          'user_id' =&gt; false, &nbsp;</div></li><li><div>          'secondary_item_id' =&gt; false&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return bp_activity_delete( $r );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete an activity item by activity id.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $activity_id ID of the activity item to be deleted.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_activity_delete_by_activity_id( $activity_id ) {&nbsp;</div></li><li><div>      return bp_activity_delete( array( 'id' =&gt; $activity_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete an activity item by its content.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * You should use bp_activity_delete() instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id   The user id.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content   The activity id.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $component The activity component.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type      The activity type.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_activity_delete_by_content( $user_id, $content, $component, $type ) {&nbsp;</div></li><li><div>      return bp_activity_delete( array(&nbsp;</div></li><li><div>          'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>          'content' =&gt; $content, &nbsp;</div></li><li><div>          'component' =&gt; $component, &nbsp;</div></li><li><div>          'type' =&gt; $type&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete a user's activity for a component.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * You should use bp_activity_delete() instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id   The user id.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $component The activity component.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_activity_delete_for_user_by_component( $user_id, $component ) {&nbsp;</div></li><li><div>      return bp_activity_delete( array(&nbsp;</div></li><li><div>          'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>          'component' =&gt; $component&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete an activity comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Why is an activity id required? We could look this up.</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Why do we encourage users to call this function directly? We could just</span>&nbsp;</div></li><li><div><span class="comment"> *       as easily examine the activity type in bp_activity_delete() and then</span>&nbsp;</div></li><li><div><span class="comment"> *       call this function with the proper arguments if necessary.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $activity_id The ID of the &quot;root&quot; activity, ie the comment's</span>&nbsp;</div></li><li><div><span class="comment"> *                         oldest ancestor.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $comment_id  The ID of the comment to be deleted.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_delete_comment( $activity_id, $comment_id ) {&nbsp;</div></li><li><div>  $deleted = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether BuddyPress should delete an activity comment or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * You may want to hook into this filter if you want to override this function and</span>&nbsp;</div></li><li><div><span class="comment">   * handle the deletion of child comments differently. Make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0 Add the deleted parameter (passed by reference)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $value       Whether BuddyPress should continue or not.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $activity_id ID of the root activity item being deleted.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $comment_id  ID of the comment being deleted.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $deleted     Whether the activity comment has been deleted or not.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters_ref_array( 'bp_activity_delete_comment_pre', array( true, $activity_id, $comment_id, &$deleted ) ) ) {&nbsp;</div></li><li><div>      return $deleted;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete any children of this comment.</span>&nbsp;</div></li><li><div>  bp_activity_delete_children( $activity_id, $comment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete the actual comment.</span>&nbsp;</div></li><li><div>  if ( ! bp_activity_delete( array( 'id' =&gt; $comment_id, 'type' =&gt; 'activity_comment' ) ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $deleted = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Purge comment cache for the root activity update.</span>&nbsp;</div></li><li><div>  wp_cache_delete( $activity_id, 'bp_activity_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Recalculate the comment tree.</span>&nbsp;</div></li><li><div>  BP_Activity_Activity::rebuild_activity_comment_tree( $activity_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the deletion of an activity comment, before returning success.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $activity_id ID of the activity that has had a comment deleted from.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $comment_id  ID of the comment that was deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_delete_comment', $activity_id, $comment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $deleted;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete an activity comment's children.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $activity_id The ID of the &quot;root&quot; activity, ie the</span>&nbsp;</div></li><li><div><span class="comment">   *                         comment's oldest ancestor.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $comment_id  The ID of the comment to be deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_activity_delete_children( $activity_id, $comment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get activity children to delete.</span>&nbsp;</div></li><li><div>      $children = BP_Activity_Activity::get_child_comments( $comment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Recursively delete all children of this comment.</span>&nbsp;</div></li><li><div>      if ( ! empty( $children ) ) {&nbsp;</div></li><li><div>          foreach( (array) $children as $child ) {&nbsp;</div></li><li><div>              bp_activity_delete_children( $activity_id, $child-&gt;id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete the comment itself.</span>&nbsp;</div></li><li><div>      bp_activity_delete( array(&nbsp;</div></li><li><div>          'secondary_item_id' =&gt; $comment_id, &nbsp;</div></li><li><div>          'type' =&gt; 'activity_comment', &nbsp;</div></li><li><div>          'item_id' =&gt; $activity_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the permalink for a single activity item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When only the $activity_id param is passed, BP has to instantiate a new</span>&nbsp;</div></li><li><div><span class="comment"> * BP_Activity_Activity object. To save yourself some processing overhead, </span>&nbsp;</div></li><li><div><span class="comment"> * be sure to pass the full $activity_obj parameter as well, if you already</span>&nbsp;</div></li><li><div><span class="comment"> * have it available.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int         $activity_id  The unique id of the activity object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object|bool $activity_obj Optional. The activity object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $link Permalink for the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_permalink( $activity_id, $activity_obj = false ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $activity_obj ) ) {&nbsp;</div></li><li><div>      $activity_obj = new BP_Activity_Activity( $activity_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $activity_obj-&gt;current_comment ) ) {&nbsp;</div></li><li><div>      $activity_obj = $activity_obj-&gt;current_comment;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $use_primary_links = array(&nbsp;</div></li><li><div>      'new_blog_post', &nbsp;</div></li><li><div>      'new_blog_comment', &nbsp;</div></li><li><div>      'new_forum_topic', &nbsp;</div></li><li><div>      'new_forum_post', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $bp-&gt;activity-&gt;track ) ) {&nbsp;</div></li><li><div>      $use_primary_links = array_merge( $use_primary_links, array_keys( $bp-&gt;activity-&gt;track ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== array_search( $activity_obj-&gt;type, $use_primary_links ) ) {&nbsp;</div></li><li><div>      $link = $activity_obj-&gt;primary_link;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( 'activity_comment' == $activity_obj-&gt;type ) {&nbsp;</div></li><li><div>          $link = bp_get_root_domain() . '/' . bp_get_activity_root_slug() . '/p/' . $activity_obj-&gt;item_id . '/#acomment-' . $activity_obj-&gt;id;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $link = bp_get_root_domain() . '/' . bp_get_activity_root_slug() . '/p/' . $activity_obj-&gt;id . '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the activity permalink for the specified activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $array Array holding activity permalink and activity item object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters_ref_array( 'bp_activity_get_permalink', array( $link, &$activity_obj ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Hide a user's activity.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The ID of the user whose activity is being hidden.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_hide_user_activity( $user_id ) {&nbsp;</div></li><li><div>  return BP_Activity_Activity::hide_all_for_user( $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Take content, remove images, and replace them with a single thumbnail image.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The format of items in the activity stream is such that we do not want to</span>&nbsp;</div></li><li><div><span class="comment"> * allow an arbitrary number of arbitrarily large images to be rendered.</span>&nbsp;</div></li><li><div><span class="comment"> * However, the activity stream is built to elegantly display a single</span>&nbsp;</div></li><li><div><span class="comment"> * thumbnail corresponding to the activity comment. This function looks</span>&nbsp;</div></li><li><div><span class="comment"> * through the content, grabs the first image and converts it to a thumbnail, </span>&nbsp;</div></li><li><div><span class="comment"> * and removes the rest of the images from the string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * As of BuddyPress 2.3, this function is no longer in use.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string      $content The content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $link    Optional. The unescaped URL that the image should link</span>&nbsp;</div></li><li><div><span class="comment"> *                             to. If absent, the image will not be a link.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|bool  $args    Optional. The args passed to the activity</span>&nbsp;</div></li><li><div><span class="comment"> *                             creation function (eg bp_blogs_record_activity()).</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $content The content with images stripped and replaced with a</span>&nbsp;</div></li><li><div><span class="comment"> *                         single thumb.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_thumbnail_content_images( $content, $link = false, $args = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  preg_match_all( '/&lt;img[^&gt;]*&gt;/Ui', $content, $matches );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove &lt;img&gt; tags. Also remove caption shortcodes and caption text if present.</span>&nbsp;</div></li><li><div>  $content = preg_replace('|(\[caption(.*?)\])?&lt;img[^&gt;]*&gt;([^\[\[]*\[\/caption\])?|', '', $content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $matches ) && !empty( $matches[0] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the SRC value.</span>&nbsp;</div></li><li><div>      preg_match( '/&lt;img.*?(src\=[\'|&quot;]{0, 1}.*?[\'|&quot;]{0, 1})[\s|&gt;]{1}/i', $matches[0][0], $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the width and height.</span>&nbsp;</div></li><li><div>      preg_match( '/&lt;img.*?(height\=[\'|&quot;]{0, 1}.*?[\'|&quot;]{0, 1})[\s|&gt;]{1}/i', $matches[0][0], $height );&nbsp;</div></li><li><div>      preg_match( '/&lt;img.*?(width\=[\'|&quot;]{0, 1}.*?[\'|&quot;]{0, 1})[\s|&gt;]{1}/i', $matches[0][0], $width );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $src ) ) {&nbsp;</div></li><li><div>          $src = substr( substr( str_replace( 'src=', '', $src[1] ), 0, -1 ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $width[1] ) ) {&nbsp;</div></li><li><div>              $width = substr( substr( str_replace( 'width=', '', $width[1] ), 0, -1 ), 1 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $height[1] ) ) {&nbsp;</div></li><li><div>              $height = substr( substr( str_replace( 'height=', '', $height[1] ), 0, -1 ), 1 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $width ) || empty( $height ) ) {&nbsp;</div></li><li><div>              $width = 100;&nbsp;</div></li><li><div>              $height = 100;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ratio = (int) $width / (int) $height;&nbsp;</div></li><li><div>          $new_height = (int) $height &gt;= 100 ? 100 : $height;&nbsp;</div></li><li><div>          $new_width = $new_height * $ratio;&nbsp;</div></li><li><div>          $image = '&lt;img src=&quot;' . esc_url( $src ) . '&quot; width=&quot;' . absint( $new_width ) . '&quot; height=&quot;' . absint( $new_height ) . '&quot; alt=&quot;' . __( 'Thumbnail', 'buddypress' ) . '&quot; class=&quot;align-left thumbnail&quot; /&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $link ) ) {&nbsp;</div></li><li><div>              $image = '&lt;a href=&quot;' . esc_url( $link ) . '&quot;&gt;' . $image . '&lt;/a&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $content = $image . $content;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the activity content that had a thumbnail replace images.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content Activity content that had images replaced in.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $matches Array of all image tags found in the posted content.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $args    Arguments passed into function creating the activity update.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_thumbnail_content_images', $content, $matches, $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the excerpt length for activity items.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Character length for activity excerpts.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_get_excerpt_length() {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the excerpt length for the activity excerpt.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int Character length for activity excerpts.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return (int) apply_filters( 'bp_activity_excerpt_length', 358 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a rich summary of an activity item for the activity stream.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * More than just a simple excerpt, the summary could contain oEmbeds and other types of media.</span>&nbsp;</div></li><li><div><span class="comment"> * Currently, it's only used for blog post items, but it will probably be used for all types of</span>&nbsp;</div></li><li><div><span class="comment"> * activity in the future.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content  The content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $activity The data passed to bp_activity_add() or the values</span>&nbsp;</div></li><li><div><span class="comment"> *                         from an Activity obj.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $summary</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_create_summary( $content, $activity ) {&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'width' =&gt; isset( $GLOBALS['content_width'] ) ? (int) $GLOBALS['content_width'] : 'medium', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the WP_Post object if this activity type is a blog post.</span>&nbsp;</div></li><li><div>  if ( $activity['type'] === 'new_blog_post' ) {&nbsp;</div></li><li><div>      $content = get_post( $activity['secondary_item_id'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the class name of the media extractor when creating an Activity summary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Use this filter to change the media extractor used to extract media info for the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $extractor Class name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content   The content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $activity  The data passed to bp_activity_add() or the values from an Activity obj.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $extractor = apply_filters( 'bp_activity_create_summary_extractor_class', 'BP_Media_Extractor', $content, $activity );&nbsp;</div></li><li><div>  $extractor = new $extractor;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the arguments passed to the media extractor when creating an Activity summary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array              $args      Array of bespoke data for the media extractor.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string             $content   The content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array              $activity  The data passed to bp_activity_add() or the values from an Activity obj.</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Media_Extractor $extractor The media extractor object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $args = apply_filters( 'bp_activity_create_summary_extractor_args', $args, $content, $activity, $extractor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Extract media information from the $content.</span>&nbsp;</div></li><li><div>  $media = $extractor-&gt;extract( $content, BP_Media_Extractor::ALL, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we converted $content to an object earlier, flip it back to a string.</span>&nbsp;</div></li><li><div>  if ( is_a( $content, 'WP_Post' ) ) {&nbsp;</div></li><li><div>      $content = $content-&gt;post_content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $para_count = substr_count( strtolower( wpautop( $content ) ), '&lt;p&gt;' );&nbsp;</div></li><li><div>  $has_audio = ! empty( $media['has']['audio'] )           && $media['has']['audio'];&nbsp;</div></li><li><div>  $has_videos = ! empty( $media['has']['videos'] )          && $media['has']['videos'];&nbsp;</div></li><li><div>  $has_feat_image = ! empty( $media['has']['featured_images'] ) && $media['has']['featured_images'];&nbsp;</div></li><li><div>  $has_galleries = ! empty( $media['has']['galleries'] )       && $media['has']['galleries'];&nbsp;</div></li><li><div>  $has_images = ! empty( $media['has']['images'] )          && $media['has']['images'];&nbsp;</div></li><li><div>  $has_embeds = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Embeds must be subtracted from the paragraph count.</span>&nbsp;</div></li><li><div>  if ( ! empty( $media['has']['embeds'] ) ) {&nbsp;</div></li><li><div>      $has_embeds = $media['has']['embeds'] &gt; 0;&nbsp;</div></li><li><div>      $para_count -= count( $media['has']['embeds'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $extracted_media = array();&nbsp;</div></li><li><div>  $use_media_type = '';&nbsp;</div></li><li><div>  $image_source = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If it's a short article and there's an embed/audio/video, use it.</span>&nbsp;</div></li><li><div>  if ( $para_count &lt;= 3 ) {&nbsp;</div></li><li><div>      if ( $has_embeds ) {&nbsp;</div></li><li><div>          $use_media_type = 'embeds';&nbsp;</div></li><li><div>      } elseif ( $has_audio ) {&nbsp;</div></li><li><div>          $use_media_type = 'audio';&nbsp;</div></li><li><div>      } elseif ( $has_videos ) {&nbsp;</div></li><li><div>          $use_media_type = 'videos';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If not, or in any other situation, try to use an image.</span>&nbsp;</div></li><li><div>  if ( ! $use_media_type && $has_images ) {&nbsp;</div></li><li><div>      $use_media_type = 'images';&nbsp;</div></li><li><div>      $image_source = 'html';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Featured Image &gt; Galleries &gt; inline &lt;img&gt;.</span>&nbsp;</div></li><li><div>      if ( $has_feat_image ) {&nbsp;</div></li><li><div>          $image_source = 'featured_images';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( $has_galleries ) {&nbsp;</div></li><li><div>          $image_source = 'galleries';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Extract an item from the $media results.</span>&nbsp;</div></li><li><div>  if ( $use_media_type ) {&nbsp;</div></li><li><div>      if ( $use_media_type === 'images' ) {&nbsp;</div></li><li><div>          $extracted_media = wp_list_filter( $media[ $use_media_type ], array( 'source' =&gt; $image_source ) );&nbsp;</div></li><li><div>          $extracted_media = array_shift( $extracted_media );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $extracted_media = array_shift( $media[ $use_media_type ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the results of the media extractor when creating an Activity summary.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $extracted_media Extracted media item. See {@link BP_Media_Extractor::extract()} for format.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $content         Content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $activity        The data passed to bp_activity_add() or the values from an Activity obj.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $media           All results from the media extraction.</span>&nbsp;</div></li><li><div><span class="comment">       *                                See {@link BP_Media_Extractor::extract()} for format.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $use_media_type  The kind of media item that was preferentially extracted.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $image_source    If $use_media_type was &quot;images&quot;, the preferential source of the image.</span>&nbsp;</div></li><li><div><span class="comment">       *                                Otherwise empty.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $extracted_media = apply_filters(&nbsp;</div></li><li><div>          'bp_activity_create_summary_extractor_result', &nbsp;</div></li><li><div>          $extracted_media, &nbsp;</div></li><li><div>          $content, &nbsp;</div></li><li><div>          $activity, &nbsp;</div></li><li><div>          $media, &nbsp;</div></li><li><div>          $use_media_type, &nbsp;</div></li><li><div>          $image_source&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Generate a text excerpt for this activity item (and remove any oEmbeds URLs).</span>&nbsp;</div></li><li><div>  $summary = bp_create_excerpt( html_entity_decode( $content ), 225, array(&nbsp;</div></li><li><div>      'html' =&gt; false, &nbsp;</div></li><li><div>      'filter_shortcodes' =&gt; true, &nbsp;</div></li><li><div>      'strip_tags' =&gt; true, &nbsp;</div></li><li><div>      'remove_links' =&gt; true&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $use_media_type === 'embeds' ) {&nbsp;</div></li><li><div>      $summary .= PHP_EOL . PHP_EOL . $extracted_media['url'];&nbsp;</div></li><li><div>  } elseif ( $use_media_type === 'images' ) {&nbsp;</div></li><li><div>      $summary .= sprintf( ' &lt;img src=&quot;%s&quot;&gt;', esc_url( $extracted_media['url'] ) );&nbsp;</div></li><li><div>  } elseif ( in_array( $use_media_type, array( 'audio', 'videos' ), true ) ) {&nbsp;</div></li><li><div>      $summary .= PHP_EOL . PHP_EOL . $extracted_media['original'];  <span class="comment">// Full shortcode.</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the newly-generated summary for the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $summary         Activity summary HTML.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content         Content of the activity item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $activity        The data passed to bp_activity_add() or the values from an Activity obj.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $extracted_media Media item extracted. See {@link BP_Media_Extractor::extract()} for format.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_create_summary', $summary, $content, $activity, $extracted_media );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch whether the current user is allowed to mark items as spam.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if user is allowed to mark activity items as spam.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_user_can_mark_spam() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether the current user should be able to mark items as spam.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $moderate Whether or not the current user has bp_moderate capability.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_activity_user_can_mark_spam', bp_current_user_can( 'bp_moderate' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mark an activity item as spam.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo We should probably save $source to activity meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param BP_Activity_Activity $activity The activity item to be spammed.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string               $source   Optional. Default is &quot;by_a_person&quot; (ie, a person has</span>&nbsp;</div></li><li><div><span class="comment"> *                                       manually marked the activity as spam). BP core also</span>&nbsp;</div></li><li><div><span class="comment"> *                                       accepts 'by_akismet'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_mark_as_spam( &$activity, $source = 'by_a_person' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity-&gt;is_spam = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear the activity stream first page cache.</span></span>&nbsp;</div></li><li><div>  wp_cache_delete( 'bp_activity_sitewide_front', 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear the activity comment cache for this activity item.</span></span>&nbsp;</div></li><li><div>  wp_cache_delete( $activity-&gt;id, 'bp_activity_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If Akismet is active, and this was a manual spam/ham request, stop Akismet checking the activity.</span></span>&nbsp;</div></li><li><div>  if ( 'by_a_person' == $source && !empty( $bp-&gt;activity-&gt;akismet ) ) {&nbsp;</div></li><li><div>      remove_action( 'bp_activity_before_save', array( $bp-&gt;activity-&gt;akismet, 'check_activity' ), 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Build data package for Akismet.</span></span>&nbsp;</div></li><li><div>      $activity_data = BP_Akismet::build_akismet_data_package( $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Tell Akismet this is spam.</span></span>&nbsp;</div></li><li><div>      $activity_data = $bp-&gt;activity-&gt;akismet-&gt;send_akismet_request( $activity_data, 'submit', 'spam' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Update meta.</span></span>&nbsp;</div></li><li><div>      add_action( 'bp_activity_after_save', array( $bp-&gt;activity-&gt;akismet, 'update_activity_spam_meta' ), 1, 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the process to mark an activity item as spam.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item being marked as spam.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $source   Source of determination of spam status. For example</span>&nbsp;</div></li><li><div><span class="comment">   *                                       &quot;by_a_person&quot; or &quot;by_akismet&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_mark_as_spam', $activity, $source );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mark an activity item as ham.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param BP_Activity_Activity $activity The activity item to be hammed. Passed by reference.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string               $source   Optional. Default is &quot;by_a_person&quot; (ie, a person has</span>&nbsp;</div></li><li><div><span class="comment"> *                                       manually marked the activity as spam). BP core also accepts</span>&nbsp;</div></li><li><div><span class="comment"> *                                       'by_akismet'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_mark_as_ham( &$activity, $source = 'by_a_person' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity-&gt;is_spam = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear the activity stream first page cache.</span></span>&nbsp;</div></li><li><div>  wp_cache_delete( 'bp_activity_sitewide_front', 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear the activity comment cache for this activity item.</span></span>&nbsp;</div></li><li><div>  wp_cache_delete( $activity-&gt;id, 'bp_activity_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If Akismet is active, and this was a manual spam/ham request, stop Akismet checking the activity.</span></span>&nbsp;</div></li><li><div>  if ( 'by_a_person' == $source && !empty( $bp-&gt;activity-&gt;akismet ) ) {&nbsp;</div></li><li><div>      remove_action( 'bp_activity_before_save', array( $bp-&gt;activity-&gt;akismet, 'check_activity' ), 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Build data package for Akismet.</span></span>&nbsp;</div></li><li><div>      $activity_data = BP_Akismet::build_akismet_data_package( $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Tell Akismet this is spam.</span></span>&nbsp;</div></li><li><div>      $activity_data = $bp-&gt;activity-&gt;akismet-&gt;send_akismet_request( $activity_data, 'submit', 'ham' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Update meta.</span></span>&nbsp;</div></li><li><div>      add_action( 'bp_activity_after_save', array( $bp-&gt;activity-&gt;akismet, 'update_activity_ham_meta' ), 1, 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the process to mark an activity item as ham.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity Activity item being marked as ham.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $source   Source of determination of ham status. For example</span>&nbsp;</div></li><li><div><span class="comment">   *                                       &quot;by_a_person&quot; or &quot;by_akismet&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_mark_as_ham', $activity, $source );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Emails *********************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send email and BP notifications when a user is mentioned in an update.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $activity_id      The ID of the activity update.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $receiver_user_id The ID of the user who is receiving the update.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_at_message_notification( $activity_id, $receiver_user_id ) {&nbsp;</div></li><li><div>  $notifications = BP_Core_Notification::get_all_for_user( $receiver_user_id, 'all' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't leave multiple notifications for the same activity item.</span>&nbsp;</div></li><li><div>  foreach( $notifications as $notification ) {&nbsp;</div></li><li><div>      if ( $activity_id == $notification-&gt;item_id ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity = new BP_Activity_Activity( $activity_id );&nbsp;</div></li><li><div>  $email_type = 'activity-at-message';&nbsp;</div></li><li><div>  $group_name = '';&nbsp;</div></li><li><div>  $message_link = bp_activity_get_permalink( $activity_id );&nbsp;</div></li><li><div>  $poster_name = bp_core_get_user_displayname( $activity-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'convert_smilies' );&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'wpautop' );&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'bp_activity_truncate_entry', 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in bp-activity/bp-activity-template.php */</span></span>&nbsp;</div></li><li><div>  $content = apply_filters_ref_array( 'bp_get_activity_content_body', array( $activity-&gt;content, &$activity ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'convert_smilies' );&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'wpautop' );&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'bp_activity_truncate_entry', 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Now email the user with the contents of the message (if they have enabled email notifications).</span>&nbsp;</div></li><li><div>  if ( 'no' != bp_get_user_meta( $receiver_user_id, 'notification_activity_new_mention', true ) ) {&nbsp;</div></li><li><div>      if ( bp_is_active( 'groups' ) && bp_is_group() ) {&nbsp;</div></li><li><div>          $email_type = 'groups-at-message';&nbsp;</div></li><li><div>          $group_name = bp_get_current_group_name();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $unsubscribe_args = array(&nbsp;</div></li><li><div>          'user_id' =&gt; $receiver_user_id, &nbsp;</div></li><li><div>          'notification_type' =&gt; $email_type, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'tokens' =&gt; array(&nbsp;</div></li><li><div>              'activity' =&gt; $activity, &nbsp;</div></li><li><div>              'usermessage' =&gt; wp_strip_all_tags( $content ), &nbsp;</div></li><li><div>              'group.name' =&gt; $group_name, &nbsp;</div></li><li><div>              'mentioned.url' =&gt; $message_link, &nbsp;</div></li><li><div>              'poster.name' =&gt; $poster_name, &nbsp;</div></li><li><div>              'receiver-user.id' =&gt; $receiver_user_id, &nbsp;</div></li><li><div>              'unsubscribe' =&gt; esc_url( bp_email_get_unsubscribe_link( $unsubscribe_args ) ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      bp_send_email( $email_type, $receiver_user_id, $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the sending of an @mention email notification.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0 $subject, $message, $content arguments unset and deprecated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param BP_Activity_Activity $activity         Activity Item object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $deprecated       Removed in 2.5; now an empty string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $deprecated       Removed in 2.5; now an empty string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string               $deprecated       Removed in 2.5; now an empty string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int                  $receiver_user_id The ID of the user who is receiving the update.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_activity_sent_mention_email', $activity, '', '', '', $receiver_user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send email and BP notifications when an activity item receives a comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0 Updated to use new email APIs.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $comment_id   The comment id.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $commenter_id The ID of the user who posted the comment.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $params       {@link bp_activity_new_comment()}.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_new_comment_notification( $comment_id = 0, $commenter_id = 0, $params = array() ) {&nbsp;</div></li><li><div>  $original_activity = new BP_Activity_Activity( $params['activity_id'] );&nbsp;</div></li><li><div>  $poster_name = bp_core_get_user_displayname( $commenter_id );&nbsp;</div></li><li><div>  $thread_link = bp_activity_get_permalink( $params['activity_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'convert_smilies' );&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'wpautop' );&nbsp;</div></li><li><div>  remove_filter( 'bp_get_activity_content_body', 'bp_activity_truncate_entry', 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in bp-activity/bp-activity-template.php */</span></span>&nbsp;</div></li><li><div>  $content = apply_filters_ref_array( 'bp_get_activity_content_body', array( $params['content'], &$original_activity ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'convert_smilies' );&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'wpautop' );&nbsp;</div></li><li><div>  add_filter( 'bp_get_activity_content_body', 'bp_activity_truncate_entry', 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $original_activity-&gt;user_id != $commenter_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Send an email if the user hasn't opted-out.</span></span>&nbsp;</div></li><li><div>      if ( 'no' != bp_get_user_meta( $original_activity-&gt;user_id, 'notification_activity_new_reply', true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $unsubscribe_args = array(&nbsp;</div></li><li><div>              'user_id' =&gt; $original_activity-&gt;user_id, &nbsp;</div></li><li><div>              'notification_type' =&gt; 'activity-comment', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = array(&nbsp;</div></li><li><div>              'tokens' =&gt; array(&nbsp;</div></li><li><div>                  'comment.id' =&gt; $comment_id, &nbsp;</div></li><li><div>                  'commenter.id' =&gt; $commenter_id, &nbsp;</div></li><li><div>                  'usermessage' =&gt; wp_strip_all_tags( $content ), &nbsp;</div></li><li><div>                  'original_activity.user_id' =&gt; $original_activity-&gt;user_id, &nbsp;</div></li><li><div>                  'poster.name' =&gt; $poster_name, &nbsp;</div></li><li><div>                  'thread.url' =&gt; esc_url( $thread_link ), &nbsp;</div></li><li><div>                  'unsubscribe' =&gt; esc_url( bp_email_get_unsubscribe_link( $unsubscribe_args ) ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_send_email( 'activity-comment', $original_activity-&gt;user_id, $args );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the point that notifications should be sent for activity comments.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param BP_Activity_Activity $original_activity The original activity.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $comment_id        ID for the newly received comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $commenter_id      ID of the user who made the comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array                $params            Arguments used with the original activity comment.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_sent_reply_to_update_notification', $original_activity, $comment_id, $commenter_id, $params );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If this is a reply to another comment, send an email notification to the</span>&nbsp;</div></li><li><div><span class="comment">   * author of the immediate parent comment.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( empty( $params['parent_id'] ) || ( $params['activity_id'] == $params['parent_id'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parent_comment = new BP_Activity_Activity( $params['parent_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $parent_comment-&gt;user_id != $commenter_id && $original_activity-&gt;user_id != $parent_comment-&gt;user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Send an email if the user hasn't opted-out.</span></span>&nbsp;</div></li><li><div>      if ( 'no' != bp_get_user_meta( $parent_comment-&gt;user_id, 'notification_activity_new_reply', true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $unsubscribe_args = array(&nbsp;</div></li><li><div>              'user_id' =&gt; $parent_comment-&gt;user_id, &nbsp;</div></li><li><div>              'notification_type' =&gt; 'activity-comment-author', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = array(&nbsp;</div></li><li><div>              'tokens' =&gt; array(&nbsp;</div></li><li><div>                  'comment.id' =&gt; $comment_id, &nbsp;</div></li><li><div>                  'commenter.id' =&gt; $commenter_id, &nbsp;</div></li><li><div>                  'usermessage' =&gt; wp_strip_all_tags( $content ), &nbsp;</div></li><li><div>                  'parent-comment-user.id' =&gt; $parent_comment-&gt;user_id, &nbsp;</div></li><li><div>                  'poster.name' =&gt; $poster_name, &nbsp;</div></li><li><div>                  'thread.url' =&gt; esc_url( $thread_link ), &nbsp;</div></li><li><div>                  'unsubscribe' =&gt; esc_url( bp_email_get_unsubscribe_link( $unsubscribe_args ) ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_send_email( 'activity-comment-author', $parent_comment-&gt;user_id, $args );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the point that notifications should be sent for comments on activity replies.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param BP_Activity_Activity $parent_comment The parent activity.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $comment_id     ID for the newly received comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int                  $commenter_id   ID of the user who made the comment.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array                $params         Arguments used with the original activity comment.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_activity_sent_reply_to_reply_notification', $parent_comment, $comment_id, $commenter_id, $params );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Helper method to map action arguments to function parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $comment_id ID of the comment being notified about.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $params     Parameters to use with notification.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_new_comment_notification_helper( $comment_id, $params ) {&nbsp;</div></li><li><div>  bp_activity_new_comment_notification( $comment_id, $params['user_id'], $params );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_activity_comment_posted', 'bp_activity_new_comment_notification_helper', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Embeds *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up activity oEmbed cache during the activity loop.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * During an activity loop, this function sets up the hooks necessary to grab</span>&nbsp;</div></li><li><div><span class="comment"> * each item's embeds from the cache, or put them in the cache if they are</span>&nbsp;</div></li><li><div><span class="comment"> * not there yet.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This does not cover recursive activity comments, as they do not use a real loop.</span>&nbsp;</div></li><li><div><span class="comment"> * For that, see {@link bp_activity_comment_embed()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Embed</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_embed_activity_cache()</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_embed_activity_save_cache()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_embed() {&nbsp;</div></li><li><div>  add_filter( 'embed_post_id', 'bp_get_activity_id' );&nbsp;</div></li><li><div>  add_filter( 'oembed_dataparse', 'bp_activity_oembed_dataparse', 10, 2 );&nbsp;</div></li><li><div>  add_filter( 'bp_embed_get_cache', 'bp_embed_activity_cache', 10, 3 );&nbsp;</div></li><li><div>  add_action( 'bp_embed_update_cache', 'bp_embed_activity_save_cache', 10, 3 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'activity_loop_start', 'bp_activity_embed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Cache full oEmbed response from oEmbed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $retval Current oEmbed result.</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $data   Full oEmbed response.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url    URL used for the oEmbed request.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_oembed_dataparse( $retval, $data ) {&nbsp;</div></li><li><div>  buddypress()-&gt;activity-&gt;oembed_response = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up activity oEmbed cache while recursing through activity comments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * While crawling through an activity comment tree</span>&nbsp;</div></li><li><div><span class="comment"> * ({@link bp_activity_recurse_comments}), this function sets up the hooks</span>&nbsp;</div></li><li><div><span class="comment"> * necessary to grab each comment's embeds from the cache, or put them in</span>&nbsp;</div></li><li><div><span class="comment"> * the cache if they are not there yet.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Embed</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_embed_activity_cache()</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_embed_activity_save_cache()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_comment_embed() {&nbsp;</div></li><li><div>  add_filter( 'embed_post_id', 'bp_get_activity_comment_id' );&nbsp;</div></li><li><div>  add_filter( 'bp_embed_get_cache', 'bp_embed_activity_cache', 10, 3 );&nbsp;</div></li><li><div>  add_action( 'bp_embed_update_cache', 'bp_embed_activity_save_cache', 10, 3 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_before_activity_comment', 'bp_activity_comment_embed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * When a user clicks on a &quot;Read More&quot; item, make sure embeds are correctly parsed and shown for the expanded content.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Embed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $activity The activity that is being expanded.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_dtheme_embed_read_more( $activity ) {&nbsp;</div></li><li><div>  buddypress()-&gt;activity-&gt;read_more_id = $activity-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'embed_post_id', function() { return buddypress()-&gt;activity-&gt;read_more_id; } );&nbsp;</div></li><li><div>  add_filter( 'bp_embed_get_cache', 'bp_embed_activity_cache', 10, 3 );&nbsp;</div></li><li><div>  add_action( 'bp_embed_update_cache', 'bp_embed_activity_save_cache', 10, 3 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_dtheme_get_single_activity_content', 'bp_dtheme_embed_read_more' );&nbsp;</div></li><li><div>add_action( 'bp_legacy_theme_get_single_activity_content', 'bp_dtheme_embed_read_more' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean up 'embed_post_id' filter after comment recursion.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This filter must be removed so that the non-comment filters take over again</span>&nbsp;</div></li><li><div><span class="comment"> * once the comments are done being processed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_activity_comment_embed()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_comment_embed_after_recurse() {&nbsp;</div></li><li><div>  remove_filter( 'embed_post_id', 'bp_get_activity_comment_id' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_after_activity_comment', 'bp_activity_comment_embed_after_recurse' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch an activity item's cached embeds.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used during {@link BP_Embed::parse_oembed()} via {@link bp_activity_embed()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Embed::parse_oembed()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $cache    An empty string passed by BP_Embed::parse_oembed() for</span>&nbsp;</div></li><li><div><span class="comment"> *                         functions like this one to filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id       The ID of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $cachekey The cache key generated in BP_Embed::parse_oembed().</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed The cached embeds for this activity item.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_embed_activity_cache( $cache, $id, $cachekey ) {&nbsp;</div></li><li><div>  return bp_activity_get_meta( $id, $cachekey );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set an activity item's embed cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used during {@link BP_Embed::parse_oembed()} via {@link bp_activity_embed()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Embed::parse_oembed()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $cache    An empty string passed by BP_Embed::parse_oembed() for</span>&nbsp;</div></li><li><div><span class="comment"> *                         functions like this one to filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $cachekey The cache key generated in BP_Embed::parse_oembed().</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id       The ID of the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_embed_activity_save_cache( $cache, $cachekey, $id ) {&nbsp;</div></li><li><div>  bp_activity_update_meta( $id, $cachekey, $cache );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cache full oEmbed response.</span>&nbsp;</div></li><li><div>  if ( true === isset( buddypress()-&gt;activity-&gt;oembed_response ) ) {&nbsp;</div></li><li><div>      $cachekey = str_replace( '_oembed', '_oembed_response', $cachekey );&nbsp;</div></li><li><div>      bp_activity_update_meta( $id, $cachekey, buddypress()-&gt;activity-&gt;oembed_response );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Should we use Heartbeat to refresh activities?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if activity heartbeat is enabled, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_activity_do_heartbeat() {&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_activity_heartbeat_active() && ( bp_is_activity_directory() || bp_is_group_activity() ) ) {&nbsp;</div></li><li><div>      $retval = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether the heartbeat feature in the activity stream should be active.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $retval Whether or not activity heartbeat is active.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_activity_do_heartbeat', $retval );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>