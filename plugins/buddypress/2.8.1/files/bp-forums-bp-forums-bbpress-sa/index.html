<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.1" data-slug="buddypress" data-type="file" data-id="49261"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-forums-bp-forums-bbpress-sa | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=07eafb3136e7321645d101c94a289924' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-forums-bp-forums-bbpress-sa/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bp-forums-bbpress-sa%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bp-forums-bbpress-sa%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.1-file-bp-forums-bp-forums-bbpress-sa","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-forums-bp-forums-bbpress-sa" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.1." href="http://hookr.io/plugins/buddypress/2.8.1/" class="H_VERSION"><span property="name">2.8.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-forums-bp-forums-bbpress-sa</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.1/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.1/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.1/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.1/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.1/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.1/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.1/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-forums/bp-forums-bbpress-sa.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress bbPress 1.x integration.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage ForumsbbPress</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Bootstrap bbPress 1.x, and manipulate globals to integrate with BuddyPress.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|null Returns false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_forums_load_bbpress() {&nbsp;</div></li><li><div>  global $wpdb, $wp_roles, $current_user, $wp_users_object;&nbsp;</div></li><li><div>  global $bb, $bbdb, $bb_table_prefix, $bb_current_user;&nbsp;</div></li><li><div>  global $bb_roles, $wp_taxonomy_object, $bb_queries;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return if we've already run this function.</span>&nbsp;</div></li><li><div>  if ( is_object( $bbdb ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !bp_forums_is_installed_correctly() )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  define( 'BB_PATH', $bp-&gt;plugin_dir . '/bp-forums/bbpress/' );&nbsp;</div></li><li><div>  define( 'BACKPRESS_PATH', $bp-&gt;plugin_dir . '/bp-forums/bbpress/bb-includes/backpress/' );&nbsp;</div></li><li><div>  define( 'BB_URL', $bp-&gt;plugin_url . 'bp-forums/bbpress/' );&nbsp;</div></li><li><div>  define( 'BB_INC', 'bb-includes/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'class.bb-query.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'class.bb-walker.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-core.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-forums.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-topics.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-posts.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-topic-tags.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-capabilities.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-meta.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-pluggable.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-formatting.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'functions.bb-template.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require( BACKPRESS_PATH . 'class.wp-taxonomy.php' );&nbsp;</div></li><li><div>  require( BB_PATH . BB_INC . 'class.bb-taxonomy.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require( BB_PATH . 'bb-admin/includes/functions.bb-admin.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb = new stdClass();&nbsp;</div></li><li><div>  require( bp_get_option(    'bb-config-location' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup the global database connection.</span>&nbsp;</div></li><li><div>  $bbdb = new BPDB ( BBDB_USER, BBDB_PASSWORD, BBDB_NAME, BBDB_HOST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the table names.</span>&nbsp;</div></li><li><div>  $bbdb-&gt;forums = $bb_table_prefix . 'forums';&nbsp;</div></li><li><div>  $bbdb-&gt;meta = $bb_table_prefix . 'meta';&nbsp;</div></li><li><div>  $bbdb-&gt;posts = $bb_table_prefix . 'posts';&nbsp;</div></li><li><div>  $bbdb-&gt;terms = $bb_table_prefix . 'terms';&nbsp;</div></li><li><div>  $bbdb-&gt;term_relationships = $bb_table_prefix . 'term_relationships';&nbsp;</div></li><li><div>  $bbdb-&gt;term_taxonomy = $bb_table_prefix . 'term_taxonomy';&nbsp;</div></li><li><div>  $bbdb-&gt;topics = $bb_table_prefix . 'topics';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $bb-&gt;custom_user_table ) )&nbsp;</div></li><li><div>      $bbdb-&gt;users = $bb-&gt;custom_user_table;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $bbdb-&gt;users = $wpdb-&gt;users;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $bb-&gt;custom_user_meta_table ) )&nbsp;</div></li><li><div>      $bbdb-&gt;usermeta = $bb-&gt;custom_user_meta_table;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $bbdb-&gt;usermeta = $wpdb-&gt;usermeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bbdb-&gt;prefix = $bb_table_prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  define( 'BB_INSTALLING', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_object( $wp_roles ) ) {&nbsp;</div></li><li><div>      $bb_roles = $wp_roles;&nbsp;</div></li><li><div>      bb_init_roles( $bb_roles );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires during the bootstrap setup for bbPress 1.x.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bb_got_roles' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires during the bootstrap setup for bbPress 1.x.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bb_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires during the bootstrap setup for bbPress 1.x.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'init_roles' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_current_user = $current_user;&nbsp;</div></li><li><div>  $wp_users_object = new BP_Forums_BB_Auth;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset( $wp_taxonomy_object ) )&nbsp;</div></li><li><div>      $wp_taxonomy_object = new BB_Taxonomy( $bbdb );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_taxonomy_object-&gt;register_taxonomy( 'bb_topic_tag', 'bb_topic' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set a site id if there isn't one already.</span>&nbsp;</div></li><li><div>  if ( !isset( $bb-&gt;site_id ) )&nbsp;</div></li><li><div>      $bb-&gt;site_id = bp_get_root_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the tables are installed, if not, install them.</span>&nbsp;</div></li><li><div>  if ( !$tables_installed = (boolean) $bbdb-&gt;get_results( 'DESCRIBE `' . $bbdb-&gt;forums . '`;', ARRAY_A ) ) {&nbsp;</div></li><li><div>      require( BB_PATH . 'bb-admin/includes/defaults.bb-schema.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backticks and &quot;IF NOT EXISTS&quot; break the dbDelta function.</span>&nbsp;</div></li><li><div>      bp_bb_dbDelta( str_replace( ' IF NOT EXISTS', '', str_replace( '`', '', $bb_queries ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require( BB_PATH . 'bb-admin/includes/functions.bb-upgrade.php' );&nbsp;</div></li><li><div>      bb_update_db_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the site admins as the keymasters.</span>&nbsp;</div></li><li><div>      $site_admins = get_site_option( 'site_admins', array('admin') );&nbsp;</div></li><li><div>      foreach ( (array) $site_admins as $site_admin )&nbsp;</div></li><li><div>          bp_update_user_meta( bp_core_get_userid( $site_admin ), $bb_table_prefix . 'capabilities', array( 'keymaster' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Create the first forum.</span>&nbsp;</div></li><li><div>      bb_new_forum( array( 'forum_name' =&gt; 'Default Forum' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the site URI.</span>&nbsp;</div></li><li><div>      bb_update_option( 'uri', BB_URL );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires inside an anonymous function that is run on bbPress shutdown.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  register_shutdown_function( function() { do_action( 'bb_shutdown' ); } );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bbpress_init', 'bp_forums_load_bbpress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** WP to bbPress wrapper functions ******************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the current bbPress user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return object $current_user Current user object from WordPress.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_get_current_user() { global $current_user; return $current_user; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get userdata for a bbPress user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @return object User data from WordPress.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_get_user( $user_id ) { return get_userdata( $user_id ); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Cache users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Noop.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $users Array of users.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bb_cache_users( $users ) {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The bbPress plugin needs this class for its usermeta manipulation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class BP_Forums_BB_Auth {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update usermeta data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $args Array of arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function update_meta( $args = '' ) {&nbsp;</div></li><li><div>      $defaults = array( 'id' =&gt; 0, 'meta_key' =&gt; null, 'meta_value' =&gt; null, 'meta_table' =&gt; 'usermeta', 'meta_field' =&gt; 'user_id', 'cache_group' =&gt; 'users' );&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>      extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return bp_update_user_meta( $id, $meta_key, $meta_value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The bbPress plugin needs the DB class to be BPDB, but we want to use WPDB, so we can extend it and use this.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The class is pluggable, so that plugins that swap out WPDB with a custom</span>&nbsp;</div></li><li><div><span class="comment"> * database class (such as HyperDB and ShareDB) can provide their own versions</span>&nbsp;</div></li><li><div><span class="comment"> * of BPDB which extend the appropriate base class.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if ( ! class_exists( 'BPDB' ) ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * WPDB class extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  class BPDB extends WPDB {&nbsp;</div></li><li><div>      var $db_servers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Constructor.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see WPDB::__construct() for description of parameters.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      function __construct( $dbuser, $dbpassword, $dbname, $dbhost ) {&nbsp;</div></li><li><div>          parent::__construct( $dbuser, $dbpassword, $dbname, $dbhost );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = call_user_func_array( array( &$this, 'init' ), func_get_args() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $args['host'] )&nbsp;</div></li><li><div>              $this-&gt;db_servers['dbh_global'] = $args;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Determine if a database supports a particular feature.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Overridden here to work around differences between bbPress's</span>&nbsp;</div></li><li><div><span class="comment">       * and WordPress's implementations. In particular, when</span>&nbsp;</div></li><li><div><span class="comment">       * BuddyPress tries to run bbPress' SQL installation script, </span>&nbsp;</div></li><li><div><span class="comment">       * the collation check always failed. The capability is long</span>&nbsp;</div></li><li><div><span class="comment">       * supported by WordPress' minimum required MySQL version, so</span>&nbsp;</div></li><li><div><span class="comment">       * this is safe.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see WPDB::has_cap() for a description of parameters and</span>&nbsp;</div></li><li><div><span class="comment">       *      return values.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $db_cap See {@link WPDB::has_cap()}.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $_table_name See {@link WPDB::has_cap()}.</span>&nbsp;</div></li><li><div><span class="comment">       * @return bool See {@link WPDB::has_cap()}.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      function has_cap( $db_cap, $_table_name='' ) {&nbsp;</div></li><li><div>          if ( 'collation' == $db_cap )&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return parent::has_cap( $db_cap );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Initialize the class variables based on provided arguments.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Based on, and taken from, the BackPress class in turn taken</span>&nbsp;</div></li><li><div><span class="comment">       * from the 1.0 branch of bbPress.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see BBDB::__construct() for a description of params.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args Array of args to parse.</span>&nbsp;</div></li><li><div><span class="comment">       * @return array $args.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      function init( $args ) {&nbsp;</div></li><li><div>          if ( 4 == func_num_args() ) {&nbsp;</div></li><li><div>              $args = array(&nbsp;</div></li><li><div>                  'user' =&gt; $args, &nbsp;</div></li><li><div>                  'password' =&gt; func_get_arg( 1 ), &nbsp;</div></li><li><div>                  'name' =&gt; func_get_arg( 2 ), &nbsp;</div></li><li><div>                  'host' =&gt; func_get_arg( 3 ), &nbsp;</div></li><li><div>                  'charset' =&gt; defined( 'BBDB_CHARSET' ) ? BBDB_CHARSET : false, &nbsp;</div></li><li><div>                  'collate' =&gt; defined( 'BBDB_COLLATE' ) ? BBDB_COLLATE : false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $defaults = array(&nbsp;</div></li><li><div>                  'user' =&gt; false, &nbsp;</div></li><li><div>                  'password' =&gt; false, &nbsp;</div></li><li><div>                  'name' =&gt; false, &nbsp;</div></li><li><div>                  'host' =&gt; 'localhost', &nbsp;</div></li><li><div>                  'charset' =&gt; false, &nbsp;</div></li><li><div>                  'collate' =&gt; false, &nbsp;</div></li><li><div>                  'errors' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Stub for escape_deep() compatibility.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param mixed $data See {@link WPDB::escape_deep()}.</span>&nbsp;</div></li><li><div><span class="comment">       * @return mixed $data See {@link WPDB::escape_deep()}.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      function escape_deep( $data ) {&nbsp;</div></li><li><div>          return esc_sql( $data );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>endif; <span class="comment">// End class_exists( 'BPDB' ).</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Convert object to given output format.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The bbPress plugin needs this to convert vars.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $object Object to convert.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $output Type of object to return. OBJECT, ARRAY_A, or ARRAY_N.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function backpress_convert_object( &$object, $output ) {&nbsp;</div></li><li><div>  if ( is_array( $object ) ) {&nbsp;</div></li><li><div>      foreach ( array_keys( $object ) as $key )&nbsp;</div></li><li><div>          backpress_convert_object( $object[$key], $output );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      switch ( $output ) {&nbsp;</div></li><li><div>          case OBJECT  : break;&nbsp;</div></li><li><div>          case ARRAY_A : $object = get_object_vars($object); break;&nbsp;</div></li><li><div>          case ARRAY_N : $object = array_values(get_object_vars($object)); break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Parse and execute queries for updating a set of database tables.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Copied from wp-admin/includes/upgrade.php, this will take care of creating</span>&nbsp;</div></li><li><div><span class="comment"> * the bbPress stand-alone tables without loading a conflicting WP Admin.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see dbDelta() for a description of parameters and return value.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $queries See {@link dbDelta()}.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool  $execute See {@link dbDelta()}.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array See {@link dbDelta()}.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_bb_dbDelta($queries, $execute = true) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Separate individual queries into an array.</span>&nbsp;</div></li><li><div>  if ( !is_array($queries) ) {&nbsp;</div></li><li><div>      $queries = explode( ';', $queries );&nbsp;</div></li><li><div>      if ('' == $queries[count($queries) - 1]) array_pop($queries);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cqueries = array(); <span class="comment">// Creation Queries.</span>&nbsp;</div></li><li><div>  $iqueries = array(); <span class="comment">// Insertion Queries.</span>&nbsp;</div></li><li><div>  $for_update = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create a tablename index for an array ($cqueries) of queries.</span>&nbsp;</div></li><li><div>  foreach($queries as $qry) {&nbsp;</div></li><li><div>      if (preg_match(&quot;|CREATE TABLE ([^ ]*)|&quot;, $qry, $matches)) {&nbsp;</div></li><li><div>          $cqueries[trim( strtolower($matches[1]), '`' )] = $qry;&nbsp;</div></li><li><div>          $for_update[$matches[1]] = 'Created table '.$matches[1];&nbsp;</div></li><li><div>      } else if (preg_match(&quot;|CREATE DATABASE ([^ ]*)|&quot;, $qry, $matches)) {&nbsp;</div></li><li><div>          array_unshift($cqueries, $qry);&nbsp;</div></li><li><div>      } else if (preg_match(&quot;|INSERT INTO ([^ ]*)|&quot;, $qry, $matches)) {&nbsp;</div></li><li><div>          $iqueries[] = $qry;&nbsp;</div></li><li><div>      } else if (preg_match(&quot;|UPDATE ([^ ]*)|&quot;, $qry, $matches)) {&nbsp;</div></li><li><div>          $iqueries[] = $qry;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Unrecognized query type.</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check to see which tables and fields exist.</span>&nbsp;</div></li><li><div>  if ($tables = $wpdb-&gt;get_col('SHOW TABLES;')) {&nbsp;</div></li><li><div>      <span class="comment">// For every table in the database.</span>&nbsp;</div></li><li><div>      foreach ($tables as $table) {&nbsp;</div></li><li><div>          <span class="comment">// Upgrade global tables only for the main site. Don't upgrade at all if DO_NOT_UPGRADE_GLOBAL_TABLES is defined.</span>&nbsp;</div></li><li><div>          if ( in_array($table, $wpdb-&gt;tables('global')) && ( !is_main_site() || defined('DO_NOT_UPGRADE_GLOBAL_TABLES') ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If a table query exists for the database table...</span>&nbsp;</div></li><li><div>          if ( array_key_exists(strtolower($table), $cqueries) ) {&nbsp;</div></li><li><div>              <span class="comment">// Clear the field and index arrays.</span>&nbsp;</div></li><li><div>              $cfields = $indices = array();&nbsp;</div></li><li><div>              <span class="comment">// Get all of the field names in the query from between the parents.</span>&nbsp;</div></li><li><div>              preg_match(&quot;|\((.*)\)|ms&quot;, $cqueries[strtolower($table)], $match2);&nbsp;</div></li><li><div>              $qryline = trim($match2[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Separate field lines into an array.</span>&nbsp;</div></li><li><div>              $flds = explode(&quot;\n&quot;, $qryline);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//echo &quot;&lt;hr/&gt;&lt;pre&gt;\n&quot;.print_r(strtolower($table), true).&quot;:\n&quot;.print_r($cqueries, true).&quot;&lt;/pre&gt;&lt;hr/&gt;&quot;;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// For every field line specified in the query.</span>&nbsp;</div></li><li><div>              foreach ($flds as $fld) {&nbsp;</div></li><li><div>                  <span class="comment">// Extract the field name.</span>&nbsp;</div></li><li><div>                  preg_match(&quot;|^([^ ]*)|&quot;, trim($fld), $fvals);&nbsp;</div></li><li><div>                  $fieldname = trim( $fvals[1], '`' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Verify the found field name.</span>&nbsp;</div></li><li><div>                  $validfield = true;&nbsp;</div></li><li><div>                  switch (strtolower($fieldname)) {&nbsp;</div></li><li><div>                  case '':&nbsp;</div></li><li><div>                  case 'primary':&nbsp;</div></li><li><div>                  case 'index':&nbsp;</div></li><li><div>                  case 'fulltext':&nbsp;</div></li><li><div>                  case 'unique':&nbsp;</div></li><li><div>                  case 'key':&nbsp;</div></li><li><div>                      $validfield = false;&nbsp;</div></li><li><div>                      $indices[] = trim(trim($fld), &quot;, \n&quot;);&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $fld = trim($fld);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// If it's a valid field, add it to the field array.</span>&nbsp;</div></li><li><div>                  if ($validfield) {&nbsp;</div></li><li><div>                      $cfields[strtolower($fieldname)] = trim($fld, &quot;, \n&quot;);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Fetch the table column structure from the database.</span>&nbsp;</div></li><li><div>              $tablefields = $wpdb-&gt;get_results(&quot;DESCRIBE {$table};&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// For every field in the table.</span>&nbsp;</div></li><li><div>              foreach ($tablefields as $tablefield) {&nbsp;</div></li><li><div>                  <span class="comment">// If the table field exists in the field array...</span>&nbsp;</div></li><li><div>                  if (array_key_exists(strtolower($tablefield-&gt;Field), $cfields)) {&nbsp;</div></li><li><div>                      <span class="comment">// Get the field type from the query.</span>&nbsp;</div></li><li><div>                      preg_match(&quot;|&quot;.$tablefield-&gt;Field.&quot; ([^ ]*( unsigned)?)|i&quot;, $cfields[strtolower($tablefield-&gt;Field)], $matches);&nbsp;</div></li><li><div>                      $fieldtype = $matches[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Is actual field type different from the field type in query?</span>&nbsp;</div></li><li><div>                      if ($tablefield-&gt;Type != $fieldtype) {&nbsp;</div></li><li><div>                          <span class="comment">// Add a query to change the column type.</span>&nbsp;</div></li><li><div>                          $cqueries[] = &quot;ALTER TABLE {$table} CHANGE COLUMN {$tablefield-&gt;Field} &quot; . $cfields[strtolower($tablefield-&gt;Field)];&nbsp;</div></li><li><div>                          $for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed type of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Type} to {$fieldtype}&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Get the default value from the array.</span>&nbsp;</div></li><li><div>                          <span class="comment">//echo &quot;{$cfields[strtolower($tablefield-&gt;Field)]}&lt;br&gt;&quot;;</span>&nbsp;</div></li><li><div>                      if (preg_match(&quot;| DEFAULT '(.*)'|i&quot;, $cfields[strtolower($tablefield-&gt;Field)], $matches)) {&nbsp;</div></li><li><div>                          $default_value = $matches[1];&nbsp;</div></li><li><div>                          if ($tablefield-&gt;Default != $default_value) {&nbsp;</div></li><li><div>                              <span class="comment">// Add a query to change the column's default value.</span>&nbsp;</div></li><li><div>                              $cqueries[] = &quot;ALTER TABLE {$table} ALTER COLUMN {$tablefield-&gt;Field} SET DEFAULT '{$default_value}'&quot;;&nbsp;</div></li><li><div>                              $for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed default value of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Default} to {$default_value}&quot;;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Remove the field from the array (so it's not added).</span>&nbsp;</div></li><li><div>                      unset($cfields[strtolower($tablefield-&gt;Field)]);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment">// This field exists in the table, but not in the creation queries?</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// For every remaining field specified for the table.</span>&nbsp;</div></li><li><div>              foreach ($cfields as $fieldname =&gt; $fielddef) {&nbsp;</div></li><li><div>                  <span class="comment">// Push a query line into $cqueries that adds the field to that table.</span>&nbsp;</div></li><li><div>                  $cqueries[] = &quot;ALTER TABLE {$table} ADD COLUMN $fielddef&quot;;&nbsp;</div></li><li><div>                  $for_update[$table.'.'.$fieldname] = 'Added column '.$table.'.'.$fieldname;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Index stuff goes here</span>&nbsp;</div></li><li><div>              <span class="comment">// Fetch the table index structure from the database.</span>&nbsp;</div></li><li><div>              $tableindices = $wpdb-&gt;get_results(&quot;SHOW INDEX FROM {$table};&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($tableindices) {&nbsp;</div></li><li><div>                  <span class="comment">// Clear the index array.</span>&nbsp;</div></li><li><div>                  unset($index_ary);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// For every index in the table.</span>&nbsp;</div></li><li><div>                  foreach ($tableindices as $tableindex) {&nbsp;</div></li><li><div>                      <span class="comment">// Add the index to the index data array.</span>&nbsp;</div></li><li><div>                      $keyname = $tableindex-&gt;Key_name;&nbsp;</div></li><li><div>                      $index_ary[$keyname]['columns'][] = array('fieldname' =&gt; $tableindex-&gt;Column_name, 'subpart' =&gt; $tableindex-&gt;Sub_part);&nbsp;</div></li><li><div>                      $index_ary[$keyname]['unique'] = ($tableindex-&gt;Non_unique == 0)?true:false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// For each actual index in the index array.</span>&nbsp;</div></li><li><div>                  foreach ($index_ary as $index_name =&gt; $index_data) {&nbsp;</div></li><li><div>                      <span class="comment">// Build a create string to compare to the query.</span>&nbsp;</div></li><li><div>                      $index_string = '';&nbsp;</div></li><li><div>                      if ($index_name == 'PRIMARY') {&nbsp;</div></li><li><div>                          $index_string .= 'PRIMARY ';&nbsp;</div></li><li><div>                      } else if($index_data['unique']) {&nbsp;</div></li><li><div>                          $index_string .= 'UNIQUE ';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $index_string .= 'KEY ';&nbsp;</div></li><li><div>                      if ($index_name != 'PRIMARY') {&nbsp;</div></li><li><div>                          $index_string .= $index_name;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $index_columns = '';&nbsp;</div></li><li><div>                      <span class="comment">// For each column in the index.</span>&nbsp;</div></li><li><div>                      foreach ($index_data['columns'] as $column_data) {&nbsp;</div></li><li><div>                          if ($index_columns != '') $index_columns .= ', ';&nbsp;</div></li><li><div>                          <span class="comment">// Add the field to the column list string.</span>&nbsp;</div></li><li><div>                          $index_columns .= $column_data['fieldname'];&nbsp;</div></li><li><div>                          if ($column_data['subpart'] != '') {&nbsp;</div></li><li><div>                              $index_columns .= '('.$column_data['subpart'].')';&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      <span class="comment">// Add the column list to the index create string.</span>&nbsp;</div></li><li><div>                      $index_string .= ' ('.$index_columns.')';&nbsp;</div></li><li><div>                      if (!(($aindex = array_search($index_string, $indices)) === false)) {&nbsp;</div></li><li><div>                          unset($indices[$aindex]);&nbsp;</div></li><li><div>                          <span class="comment">//echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;{$table}:&lt;br /&gt;Found index:&quot;.$index_string.&quot;&lt;/pre&gt;\n&quot;;</span>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      <span class="comment">//else echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;{$table}:&lt;br /&gt;&lt;b&gt;Did not find index:&lt;/b&gt;&quot;.$index_string.&quot;&lt;br /&gt;&quot;.print_r($indices, true).&quot;&lt;/pre&gt;\n&quot;;</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// For every remaining index specified for the table.</span>&nbsp;</div></li><li><div>              foreach ( (array) $indices as $index ) {&nbsp;</div></li><li><div>                  <span class="comment">// Push a query line into $cqueries that adds the index to that table.</span>&nbsp;</div></li><li><div>                  $cqueries[] = &quot;ALTER TABLE {$table} ADD $index&quot;;&nbsp;</div></li><li><div>                  $for_update[$table.'.'.$fieldname] = 'Added index '.$table.' '.$index;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Remove the original table creation query from processing.</span>&nbsp;</div></li><li><div>              unset($cqueries[strtolower($table)]);&nbsp;</div></li><li><div>              unset($for_update[strtolower($table)]);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// This table exists in the database, but not in the creation queries?</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allqueries = array_merge($cqueries, $iqueries);&nbsp;</div></li><li><div>  if ($execute) {&nbsp;</div></li><li><div>      foreach ($allqueries as $query) {&nbsp;</div></li><li><div>          <span class="comment">//echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;&quot;.print_r($query, true).&quot;&lt;/pre&gt;\n&quot;;</span>&nbsp;</div></li><li><div>          $wpdb-&gt;query($query);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $for_update;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>