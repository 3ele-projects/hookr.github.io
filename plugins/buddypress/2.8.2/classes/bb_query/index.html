<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="class" data-id="48681"><head xmlns="http://www.w3.org/1999/xhtml"><title> bb_query | class | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="BB_Query, class, plugin, buddypress, 2.8.2" /><meta name="description" content="The BuddyPress BB Query class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.24"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=2dd48732a32f8d6c09c2bdd6e32c6f50' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.24' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/bb_query/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbb_query%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbb_query%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-class-bb_query","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bb_query" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/buddypress/2.8.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bb_query</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="active" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>BB_Query</strong></h1><p>The BuddyPress <strong>BB Query</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/buddypress/2.8.2/files/bp-forums-bbpress-bb-includes-class-bb-query/" class="file">/bp-forums/bbpress/bb-includes/class.bb-query.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class BB_Query {&nbsp;</div></li><li><div>    var $type;&nbsp;</div></li><li><div>    var $query;&nbsp;</div></li><li><div>    var $query_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $query_vars = array();&nbsp;</div></li><li><div>    var $not_set = array();&nbsp;</div></li><li><div>    var $request;&nbsp;</div></li><li><div>    var $match_query = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $results;&nbsp;</div></li><li><div>    var $errors;&nbsp;</div></li><li><div>    var $count = 0;&nbsp;</div></li><li><div>    var $found_rows = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Can optionally pass unique id string to help out filters&nbsp;</div></li><li><div>    function __construct( $type = 'topic', $query = '', $id = '' ) {&nbsp;</div></li><li><div>        $this-&gt;init( $type, $query, $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty($this-&gt;query) )&nbsp;</div></li><li><div>            $this-&gt;query();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function BB_Query( $type = 'topic', $query = '', $id = '' ) {&nbsp;</div></li><li><div>        $this-&gt;__construct( $type, $query, $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function init( $type = null, $query = null, $id = null ) {&nbsp;</div></li><li><div>        if ( !is_null($type) || !isset($this-&gt;type) )&nbsp;</div></li><li><div>            $this-&gt;type = is_null($type) ? 'topic' : $type;&nbsp;</div></li><li><div>        if ( !is_null($query) || !isset($this-&gt;query) )&nbsp;</div></li><li><div>            $this-&gt;query = $query;&nbsp;</div></li><li><div>        if ( !is_null($id) || !isset($this-&gt;query_id) )&nbsp;</div></li><li><div>            $this-&gt;query_id = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;query_vars = array();&nbsp;</div></li><li><div>        $this-&gt;not_set = array();&nbsp;</div></li><li><div>        unset($this-&gt;request);&nbsp;</div></li><li><div>        $this-&gt;match_query = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset($this-&gt;results, $this-&gt;errors);&nbsp;</div></li><li><div>        $this-&gt;count = 0;&nbsp;</div></li><li><div>        $this-&gt;found_rows = false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function &query() {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args = func_get_args() )&nbsp;</div></li><li><div>            call_user_func_array( array(&$this, 'init'), $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$this-&gt;generate_query() )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action_ref_array( 'bb_query', array(&$this) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = md5( $this-&gt;request );&nbsp;</div></li><li><div>        if ( false === $cached_ids = wp_cache_get( $key, 'bb_query' ) ) {&nbsp;</div></li><li><div>            if ( 'post' == $this-&gt;type ) {&nbsp;</div></li><li><div>                $this-&gt;results = bb_cache_posts( $this-&gt;request, $this-&gt;query_vars['post_id_only'] ); // This always appends meta&nbsp;</div></li><li><div>                $_the_id = 'post_id';&nbsp;</div></li><li><div>                $this-&gt;query_vars['append_meta'] = false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;results = $bbdb-&gt;get_results( $this-&gt;request );&nbsp;</div></li><li><div>                $_the_id = 'topic_id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cached_ids = array();&nbsp;</div></li><li><div>            if ( is_array($this-&gt;results) )&nbsp;</div></li><li><div>                foreach ( $this-&gt;results as $object )&nbsp;</div></li><li><div>                    $cached_ids[] = $object-&gt;$_the_id;&nbsp;</div></li><li><div>            wp_cache_set( $key, $cached_ids, 'bb_query' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( 'post' == $this-&gt;type ) {&nbsp;</div></li><li><div>                $_query_ids = array();&nbsp;</div></li><li><div>                $_cached_posts = array();&nbsp;</div></li><li><div>                foreach ( $cached_ids as $_cached_id ) {&nbsp;</div></li><li><div>                    if ( false !== $_post = wp_cache_get( $_cached_id, 'bb_post' ) ) {&nbsp;</div></li><li><div>                        $_cached_posts[$_post-&gt;post_id] = $_post;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $_query_ids[] = $_cached_id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( count( $_query_ids ) ) {&nbsp;</div></li><li><div>                    $_query_ids = join( ', ', array_map( 'intval', $_query_ids ) );&nbsp;</div></li><li><div>                    $results = $bbdb-&gt;get_results( &quot;SELECT * FROM $bbdb-&gt;posts WHERE post_id IN($_query_ids)&quot; );&nbsp;</div></li><li><div>                    $results = array_merge( $results, $_cached_posts );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $results = $_cached_posts;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $_the_id = 'post_id';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $_query_ids = array();&nbsp;</div></li><li><div>                $_cached_topics = array();&nbsp;</div></li><li><div>                foreach ( $cached_ids as $_cached_id ) {&nbsp;</div></li><li><div>                    if ( false !== $_topic = wp_cache_get( $_cached_id, 'bb_topic' ) ) {&nbsp;</div></li><li><div>                        $_cached_topics[$_topic-&gt;topic_id] = $_topic;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $_query_ids[] = $_cached_id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( count( $_query_ids ) ) {&nbsp;</div></li><li><div>                    $_query_ids = join( ', ', array_map( 'intval', $_query_ids ) );&nbsp;</div></li><li><div>                    $results = $bbdb-&gt;get_results( &quot;SELECT * FROM $bbdb-&gt;topics WHERE topic_id IN($_query_ids)&quot; );&nbsp;</div></li><li><div>                    $results = array_merge( $results, $_cached_topics );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $results = $_cached_topics;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $_the_id = 'topic_id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;results = array();&nbsp;</div></li><li><div>            $trans = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $results as $object )&nbsp;</div></li><li><div>                $trans[$object-&gt;$_the_id] = $object;&nbsp;</div></li><li><div>            foreach ( $cached_ids as $cached_id )&nbsp;</div></li><li><div>                $this-&gt;results[] = $trans[$cached_id];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;count = count( $this-&gt;results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false === $this-&gt;found_rows && $this-&gt;query_vars['count'] ) // handles FOUND_ROWS() or COUNT(*)&nbsp;</div></li><li><div>            $this-&gt;found_rows = bb_count_last_query( $this-&gt;request );&nbsp;</div></li><li><div>        if ( 'post' == $this-&gt;type ) {&nbsp;</div></li><li><div>            if ( $this-&gt;query_vars['append_meta'] )&nbsp;</div></li><li><div>                $this-&gt;results = bb_append_meta( $this-&gt;results, 'post' );&nbsp;</div></li><li><div>            if ( $this-&gt;query_vars['cache_users'] )&nbsp;</div></li><li><div>                bb_post_author_cache( $this-&gt;results );&nbsp;</div></li><li><div>            if ( $this-&gt;query_vars['cache_topics'] )&nbsp;</div></li><li><div>                bb_cache_post_topics( $this-&gt;results );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $this-&gt;query_vars['append_meta'] )&nbsp;</div></li><li><div>                $this-&gt;results = bb_append_meta( $this-&gt;results, 'topic' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;results;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_query() {&nbsp;</div></li><li><div>        if ( $args = func_get_args() )&nbsp;</div></li><li><div>            call_user_func_array( array(&$this, 'init'), $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;parse_query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow filter to abort query&nbsp;</div></li><li><div>        if ( false === $this-&gt;query_vars )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'post' == $this-&gt;type )&nbsp;</div></li><li><div>            $this-&gt;generate_post_sql();&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;generate_topic_sql();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;request;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // $defaults = vars to use if not set in GET, POST or allowed&nbsp;</div></li><li><div>    // $allowed = array( key_name =&gt; value, key_name, key_name, key_name =&gt; value );&nbsp;</div></li><li><div>    //     key_name =&gt; value pairs override anything from defaults, GET, POST&nbsp;</div></li><li><div>    //    Lone key_names are a whitelist.  Only those can be set by defaults, GET, POST&nbsp;</div></li><li><div>    //    If there are no lone key_names, allow everything but still override with key_name =&gt; value pairs&nbsp;</div></li><li><div>    //    Ex: $allowed = array( 'topic_status' =&gt; 0, 'post_status' =&gt; 0, 'topic_author', 'started' );&nbsp;</div></li><li><div>    //        Will only take topic_author and started values from defaults, GET, POST and will query with topic_status = 0 and post_status = 0&nbsp;</div></li><li><div>    function &query_from_env( $type = 'topic', $defaults = null, $allowed = null, $id = '' ) {&nbsp;</div></li><li><div>        $this-&gt;init_from_env( $type, $defaults, $allowed, $id );&nbsp;</div></li><li><div>        return $this-&gt;query();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function init_from_env( $type = 'topic', $defaults = null, $allowed = null, $id = '' ) {&nbsp;</div></li><li><div>        $vars = $this-&gt;fill_query_vars( array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = wp_parse_args($defaults);&nbsp;</div></li><li><div>        $get_vars = stripslashes_deep( $_GET );&nbsp;</div></li><li><div>        $post_vars = stripslashes_deep( $_POST );&nbsp;</div></li><li><div>        $allowed = wp_parse_args($allowed);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $_allowed = array();&nbsp;</div></li><li><div>        foreach ( array_keys($allowed) as $k ) {&nbsp;</div></li><li><div>            if ( is_numeric($k) ) {&nbsp;</div></li><li><div>                $_allowed[] = $allowed[$k];&nbsp;</div></li><li><div>                unset($allowed[$k]);&nbsp;</div></li><li><div>            } elseif ( !isset($$k) ) {&nbsp;</div></li><li><div>                $$k = $allowed[$k];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        extract($post_vars, EXTR_SKIP);&nbsp;</div></li><li><div>        extract($get_vars, EXTR_SKIP);&nbsp;</div></li><li><div>        extract($defaults, EXTR_SKIP);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $vars = $_allowed ? compact($_allowed, array_keys($allowed)) : compact(array_keys($vars));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;init( $type, $vars, $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function fill_query_vars( $array ) {&nbsp;</div></li><li><div>        // Should use 0, '' for empty values&nbsp;</div></li><li><div>        // Function should return false iff not set&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // parameters commented out are handled farther down&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ints = array(&nbsp;</div></li><li><div>//            'page', // Defaults to global or number in URI&nbsp;</div></li><li><div>//            'per_page', // Defaults to page_topics&nbsp;</div></li><li><div>            'tag_id', // one tag ID&nbsp;</div></li><li><div>            'favorites', // one user ID, &nbsp;</div></li><li><div>            'offset', // first item to query&nbsp;</div></li><li><div>            'number'     // number of items to retrieve&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $parse_ints = array(&nbsp;</div></li><li><div>            // Both&nbsp;</div></li><li><div>            'post_id', &nbsp;</div></li><li><div>            'topic_id', &nbsp;</div></li><li><div>            'forum_id', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Topics&nbsp;</div></li><li><div>            'topic_author_id', &nbsp;</div></li><li><div>            'post_count', &nbsp;</div></li><li><div>            'tag_count', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Posts&nbsp;</div></li><li><div>            'post_author_id', &nbsp;</div></li><li><div>            'position'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dates = array(&nbsp;</div></li><li><div>            'started', // topic&nbsp;</div></li><li><div>            'updated', // topic&nbsp;</div></li><li><div>            'posted'    // post&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $others = array(&nbsp;</div></li><li><div>            // Both&nbsp;</div></li><li><div>            'topic', // one topic name&nbsp;</div></li><li><div>            'forum', // one forum name&nbsp;</div></li><li><div>            'tag', // one tag name&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Topics&nbsp;</div></li><li><div>            'topic_author', // one username&nbsp;</div></li><li><div>            'topic_status', // *normal, deleted, all, parse_int ( and - )&nbsp;</div></li><li><div>            'open', // *all, yes = open, no = closed, parse_int ( and - )&nbsp;</div></li><li><div>            'sticky', // *all, no = normal, forum, super = front, parse_int ( and - )&nbsp;</div></li><li><div>            'meta_key', // one meta_key ( and - )&nbsp;</div></li><li><div>            'meta_value', // range&nbsp;</div></li><li><div>            'topic_title', // LIKE search.  Understands &quot;doublequoted strings&quot;&nbsp;</div></li><li><div>            'search', // generic search: topic_title OR post_text&nbsp;</div></li><li><div>                            // Can ONLY be used in a topic query&nbsp;</div></li><li><div>                            // Returns additional search_score and (concatenated) post_text columns&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Posts&nbsp;</div></li><li><div>            'post_author', // one username&nbsp;</div></li><li><div>            'post_status', // *noraml, deleted, all, parse_int ( and - )&nbsp;</div></li><li><div>            'post_text', // FULLTEXT search&nbsp;</div></li><li><div>                            // Returns additional search_score column (and (concatenated) post_text column if topic query)&nbsp;</div></li><li><div>            'poster_ip', // one IPv4 address&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // SQL&nbsp;</div></li><li><div>            'index_hint', // A full index hint using valid index hint syntax, can be multiple hints an array&nbsp;</div></li><li><div>            'order_by', // fieldname&nbsp;</div></li><li><div>            'order', // *DESC, ASC&nbsp;</div></li><li><div>            'count', // *false = none, true = COUNT(*), found_rows = FOUND_ROWS()&nbsp;</div></li><li><div>            '_join_type', // not implemented: For benchmarking only.  Will disappear. join (1 query), in (2 queries)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Utility&nbsp;</div></li><li><div>//            'append_meta', // *true, false: topics only&nbsp;</div></li><li><div>//            'cache_users', // *true, false&nbsp;</div></li><li><div>//            'cache_topics, // *true, false: posts only&nbsp;</div></li><li><div>//            'post_id_only', // true, *false: this query is only returning post IDs&nbsp;</div></li><li><div>            'cache_posts'     // not implemented: none, first, last&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $ints as $key )&nbsp;</div></li><li><div>            if ( ( false === $array[$key] = isset($array[$key]) ? (int) $array[$key] : false ) && isset($this) )&nbsp;</div></li><li><div>                $this-&gt;not_set[] = $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $parse_ints as $key )&nbsp;</div></li><li><div>            if ( ( false === $array[$key] = isset($array[$key]) ? preg_replace( '/[^&lt;=&gt;0-9, -]/', '', $array[$key] ) : false ) && isset($this) )&nbsp;</div></li><li><div>                $this-&gt;not_set[] = $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $dates as $key )&nbsp;</div></li><li><div>            if ( ( false === $array[$key] = isset($array[$key]) ? preg_replace( '/[^&lt;&gt;0-9-]/', '', $array[$key] ) : false ) && isset($this) )&nbsp;</div></li><li><div>                $this-&gt;not_set[] = $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $others as $key ) {&nbsp;</div></li><li><div>            if ( !isset($array[$key]) )&nbsp;</div></li><li><div>                $array[$key] = false;&nbsp;</div></li><li><div>            if ( isset($this) && false === $array[$key] )&nbsp;</div></li><li><div>                $this-&gt;not_set[] = $key;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Both&nbsp;</div></li><li><div>        if ( isset($array['page']) )&nbsp;</div></li><li><div>            $array['page'] = (int) $array['page'];&nbsp;</div></li><li><div>        elseif ( isset($GLOBALS['page']) )&nbsp;</div></li><li><div>            $array['page'] = (int) $GLOBALS['page'];&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $array['page'] = bb_get_uri_page();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $array['page'] &lt; 1 )&nbsp;</div></li><li><div>            $array['page'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $array['per_page'] = isset($array['per_page']) ? (int) $array['per_page'] : 0;&nbsp;</div></li><li><div>        if ( $array['per_page'] &lt; -1 )&nbsp;</div></li><li><div>            $array['per_page'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Posts&nbsp;</div></li><li><div>        if ( ( !$array['poster_ip'] = isset($array['poster_ip']) ? preg_replace(&quot;@[^0-9a-f:.]@i&quot;, '', $array['poster_ip']) : false ) && isset($this) ) {&nbsp;</div></li><li><div>            $this-&gt;not_set[] = 'poster_ip';&nbsp;</div></li><li><div>            $array['poster_ip'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Utility&nbsp;</div></li><li><div>        $array['append_meta'] = isset($array['append_meta'])  ? (int) (bool) $array['append_meta']  : 1;&nbsp;</div></li><li><div>        $array['cache_users'] = isset($array['cache_users'])  ? (int) (bool) $array['cache_users']  : 1;&nbsp;</div></li><li><div>        $array['cache_topics'] = isset($array['cache_topics']) ? (int) (bool) $array['cache_topics'] : 1;&nbsp;</div></li><li><div>        $array['post_id_only'] = isset($array['post_id_only']) ? (int) (bool) $array['post_id_only'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only one FULLTEXT search per query please&nbsp;</div></li><li><div>        if ( $array['search'] )&nbsp;</div></li><li><div>            $array['post_text'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $array;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Parse a query string and set query flag booleans.&nbsp;</div></li><li><div>    function parse_query() {&nbsp;</div></li><li><div>        if ( $args = func_get_args() )&nbsp;</div></li><li><div>            call_user_func_array( array(&$this, 'init'), $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array($this-&gt;query) )&nbsp;</div></li><li><div>            $this-&gt;query_vars = $this-&gt;query;&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            wp_parse_str($this-&gt;query, $this-&gt;query_vars);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action_ref_array('bb_parse_query', array(&$this));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false === $this-&gt;query_vars )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;query_vars = $this-&gt;fill_query_vars($this-&gt;query_vars);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get($query_var) {&nbsp;</div></li><li><div>        return isset($this-&gt;query_vars[$query_var]) ? $this-&gt;query_vars[$query_var] : null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function set($query_var, $value) {&nbsp;</div></li><li><div>        $this-&gt;query_vars[$query_var] = $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_topic_sql( $_part_of_post_query = false ) {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $q =& $this-&gt;query_vars;&nbsp;</div></li><li><div>        $distinct = '';&nbsp;</div></li><li><div>        $sql_calc_found_rows = 'found_rows' === $q['count'] ? 'SQL_CALC_FOUND_ROWS' : ''; // unfiltered&nbsp;</div></li><li><div>        $fields = 't.*';&nbsp;</div></li><li><div>        $index_hint = '';&nbsp;</div></li><li><div>        $join = '';&nbsp;</div></li><li><div>        $where = '';&nbsp;</div></li><li><div>        $group_by = '';&nbsp;</div></li><li><div>        $having = '';&nbsp;</div></li><li><div>        $order_by = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_where = '';&nbsp;</div></li><li><div>        $post_queries = array('post_author_id', 'post_author', 'posted', 'post_status', 'position', 'post_text', 'poster_ip');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$_part_of_post_query && ( $q['search'] || array_diff($post_queries, $this-&gt;not_set) ) ) :&nbsp;</div></li><li><div>            $join .= &quot; JOIN $bbdb-&gt;posts as p ON ( t.topic_id = p.topic_id )&quot;;&nbsp;</div></li><li><div>            $post_where = $this-&gt;generate_post_sql( true );&nbsp;</div></li><li><div>            if ( $q['search'] ) {&nbsp;</div></li><li><div>                $post_where .= ' AND ( ';&nbsp;</div></li><li><div>                $post_where .= $this-&gt;generate_topic_title_sql( $q['search'] );&nbsp;</div></li><li><div>                $post_where .= ' OR ';&nbsp;</div></li><li><div>                $post_where .= $this-&gt;generate_post_text_sql( $q['search'] );&nbsp;</div></li><li><div>                $post_where .= ' )';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $group_by = 't.topic_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fields .= &quot;, MIN(p.post_id) as post_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $bbdb-&gt;has_cap( 'GROUP_CONCAT', $bbdb-&gt;posts ) )&nbsp;</div></li><li><div>                $fields .= &quot;, GROUP_CONCAT(p.post_text SEPARATOR ' ') AS post_text&quot;;&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                $fields .= &quot;, p.post_text&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;match_query ) {&nbsp;</div></li><li><div>                $fields .= &quot;, AVG($this-&gt;match_query) AS search_score&quot;;&nbsp;</div></li><li><div>                if ( !$q['order_by'] )&nbsp;</div></li><li><div>                    $q['order_by'] = 'search_score';&nbsp;</div></li><li><div>            } elseif ( $q['search'] || $q['post_text'] ) {&nbsp;</div></li><li><div>                $fields .= &quot;, 0 AS search_score&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$_part_of_post_query ) :&nbsp;</div></li><li><div>            if ( $q['post_id'] ) :&nbsp;</div></li><li><div>                $post_topics = $post_topics_no = array();&nbsp;</div></li><li><div>                $op = substr($q['post_id'], 0, 1);&nbsp;</div></li><li><div>                if ( in_array($op, array('&gt;', '&lt;')) ) :&nbsp;</div></li><li><div>                    $post_topics = $bbdb-&gt;get_col( &quot;SELECT DISTINCT topic_id FROM $bbdb-&gt;posts WHERE post_id $op '&quot; . (int) substr($q['post_id'], 1) . &quot;'&quot; );&nbsp;</div></li><li><div>                else :&nbsp;</div></li><li><div>                    $posts = explode(', ', $q['post_id']);&nbsp;</div></li><li><div>                    $get_posts = array();&nbsp;</div></li><li><div>                    foreach ( $posts as $post_id ) {&nbsp;</div></li><li><div>                        $post_id = (int) $post_id;&nbsp;</div></li><li><div>                        $_post_id = abs($post_id);&nbsp;</div></li><li><div>                        $get_posts[] = $_post_id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    bb_cache_posts( $get_posts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $posts as $post_id ) :&nbsp;</div></li><li><div>                        $post = bb_get_post( abs($post_id) );&nbsp;</div></li><li><div>                        if ( $post_id &lt; 0 )&nbsp;</div></li><li><div>                            $post_topics_no[] = $post-&gt;topic_id;&nbsp;</div></li><li><div>                        else&nbsp;</div></li><li><div>                            $post_topics[] = $post-&gt;topic_id;&nbsp;</div></li><li><div>                    endforeach;&nbsp;</div></li><li><div>                endif;&nbsp;</div></li><li><div>                if ( $post_topics )&nbsp;</div></li><li><div>                    $where .= &quot; AND t.topic_id IN (&quot; . join(', ', $post_topics) . &quot;)&quot;;&nbsp;</div></li><li><div>                if ( $post_topics_no )&nbsp;</div></li><li><div>                    $where .= &quot; AND t.topic_id NOT IN (&quot; . join(', ', $post_topics_no) . &quot;)&quot;;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['topic_id'] ) :&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 't.topic_id', $q['topic_id'] );&nbsp;</div></li><li><div>            elseif ( $q['topic'] ) :&nbsp;</div></li><li><div>                $q['topic'] = bb_slug_sanitize( $q['topic'] );&nbsp;</div></li><li><div>                $where .= &quot; AND t.topic_slug = '$q[topic]'&quot;;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['forum_id'] ) :&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 't.forum_id', $q['forum_id'] );&nbsp;</div></li><li><div>            elseif ( $q['forum'] ) :&nbsp;</div></li><li><div>                if ( !$q['forum_id'] = bb_get_id_from_slug( 'forum', $q['forum'] ) )&nbsp;</div></li><li><div>                    $this-&gt;error( 'query_var:forum', 'No forum by that name' );&nbsp;</div></li><li><div>                $where .= &quot; AND t.forum_id = $q[forum_id]&quot;;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['tag'] && !is_int($q['tag_id']) )&nbsp;</div></li><li><div>                $q['tag_id'] = (int) bb_get_tag_id( $q['tag'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric($q['tag_id']) ) :&nbsp;</div></li><li><div>                $join .= &quot; JOIN `$bbdb-&gt;term_relationships` AS tr ON ( t.`topic_id` = tr.`object_id` AND tr.`term_taxonomy_id` = $q[tag_id] )&quot;;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric($q['favorites']) && $f_user = bb_get_user( $q['favorites'] ) )&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 't.topic_id', $f_user-&gt;favorites );&nbsp;</div></li><li><div>        endif; // !_part_of_post_query&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['topic_title'] )&nbsp;</div></li><li><div>            $where .= ' AND ' . $this-&gt;generate_topic_title_sql( $q['topic_title'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['started'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;date( 't.topic_start_time', $q['started'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['updated'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;date( 't.topic_time', $q['updated'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['topic_author_id'] ) :&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.topic_poster', $q['topic_author_id'] );&nbsp;</div></li><li><div>        elseif ( $q['topic_author'] ) :&nbsp;</div></li><li><div>            $user = bb_get_user( $q['topic_author'], array( 'by' =&gt; 'login' ) );&nbsp;</div></li><li><div>            if ( !$q['topic_author_id'] = (int) $user-&gt;ID )&nbsp;</div></li><li><div>                $this-&gt;error( 'query_var:user', 'No user by that name' );&nbsp;</div></li><li><div>            $where .= &quot; AND t.topic_poster = $q[topic_author_id]&quot;;&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$q['topic_status'] ) :&nbsp;</div></li><li><div>            $where .= &quot; AND t.topic_status = '0'&quot;;&nbsp;</div></li><li><div>        elseif ( false === strpos($q['topic_status'], 'all') ) :&nbsp;</div></li><li><div>            $stati = array( 'normal' =&gt; 0, 'deleted' =&gt; 1 );&nbsp;</div></li><li><div>            $q['topic_status'] = str_replace(array_keys($stati), array_values($stati), $q['topic_status']);&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.topic_status', $q['topic_status'] );&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['open'] && false === strpos($q['open'], 'all') ) :&nbsp;</div></li><li><div>            $stati = array( 'no' =&gt; 0, 'closed' =&gt; 0, 'yes' =&gt; 1, 'open' =&gt; 1 );&nbsp;</div></li><li><div>            $q['open'] = str_replace(array_keys($stati), array_values($stati), $q['open']);&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.topic_open', $q['open'] );&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['sticky'] && false === strpos($q['sticky'], 'all') ) :&nbsp;</div></li><li><div>            $stickies = array( 'no' =&gt; 0, 'normal' =&gt; 0, 'forum' =&gt; 1, 'super' =&gt; 2, 'front' =&gt; 2, 'sticky' =&gt; '-0' );&nbsp;</div></li><li><div>            $q['sticky'] = str_replace(array_keys($stickies), array_values($stickies), $q['sticky']);&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.topic_sticky', $q['sticky'] );&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['post_count'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.topic_posts', $q['post_count'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['tag_count'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 't.tag_count', $q['tag_count'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['meta_key'] && $q['meta_key'] = preg_replace('|[^a-z0-9_-]|i', '', $q['meta_key']) ) :&nbsp;</div></li><li><div>            if ( '-' == substr($q['meta_key'], 0, 1) ) :&nbsp;</div></li><li><div>                $join  .= &quot; LEFT JOIN $bbdb-&gt;meta AS tm ON ( tm.object_type = 'bb_topic' AND t.topic_id = tm.object_id AND tm.meta_key = '&quot; . substr( $q['meta_key'], 1 ) . &quot;' )&quot;;&nbsp;</div></li><li><div>                $where .= &quot; AND tm.meta_key IS NULL&quot;;&nbsp;</div></li><li><div>            else :&nbsp;</div></li><li><div>                $join  .= &quot; JOIN $bbdb-&gt;meta AS tm ON ( tm.object_type = 'bb_topic' AND t.topic_id = tm.object_id AND tm.meta_key = '$q[meta_key]' )&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $q['meta_value'] ) :&nbsp;</div></li><li><div>                    $q['meta_value'] = maybe_serialize( $q['meta_value'] );&nbsp;</div></li><li><div>                    if ( strpos( $q['meta_value'], 'NULL' ) !== false )&nbsp;</div></li><li><div>                        $join = ' LEFT' . $join;&nbsp;</div></li><li><div>                    $where .= $this-&gt;parse_value( 'tm.meta_value', $q['meta_value'] );&nbsp;</div></li><li><div>                endif;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Just getting topic part for inclusion in post query&nbsp;</div></li><li><div>        if ( $_part_of_post_query )&nbsp;</div></li><li><div>            return $where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where .= $post_where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $where ) // Get rid of initial &quot; AND &quot; (this is pre-filters)&nbsp;</div></li><li><div>            $where = substr($where, 5);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['index_hint'] )&nbsp;</div></li><li><div>            $index_hint = $q['index_hint'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['order_by'] )&nbsp;</div></li><li><div>            $order_by = $q['order_by'];&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $order_by = 't.topic_time';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $bits = compact( array('distinct', 'sql_calc_found_rows', 'fields', 'index_hint', 'join', 'where', 'group_by', 'having', 'order_by') );&nbsp;</div></li><li><div>        $this-&gt;request = $this-&gt;_filter_sql( $bits, &quot;$bbdb-&gt;topics AS t&quot; );&nbsp;</div></li><li><div>        return $this-&gt;request;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_post_sql( $_part_of_topic_query = false ) {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $q =& $this-&gt;query_vars;&nbsp;</div></li><li><div>        $distinct = '';&nbsp;</div></li><li><div>        $sql_calc_found_rows = 'found_rows' === $q['count'] ? 'SQL_CALC_FOUND_ROWS' : ''; // unfiltered&nbsp;</div></li><li><div>        $fields = 'p.*';&nbsp;</div></li><li><div>        $index_hint = '';&nbsp;</div></li><li><div>        $join = '';&nbsp;</div></li><li><div>        $where = '';&nbsp;</div></li><li><div>        $group_by = '';&nbsp;</div></li><li><div>        $having = '';&nbsp;</div></li><li><div>        $order_by = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $topic_where = '';&nbsp;</div></li><li><div>        $topic_queries = array( 'topic_author_id', 'topic_author', 'topic_status', 'post_count', 'tag_count', 'started', 'updated', 'open', 'sticky', 'meta_key', 'meta_value', 'topic_title' );&nbsp;</div></li><li><div>        if ( !$_part_of_topic_query && array_diff($topic_queries, $this-&gt;not_set) ) :&nbsp;</div></li><li><div>            $join .= &quot; JOIN $bbdb-&gt;topics as t ON ( t.topic_id = p.topic_id )&quot;;&nbsp;</div></li><li><div>            $topic_where = $this-&gt;generate_topic_sql( true );&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        if ( !$_part_of_topic_query ) :&nbsp;</div></li><li><div>            if ( $q['post_id'] )&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 'p.post_id', $q['post_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['topic_id'] ) :&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 'p.topic_id', $q['topic_id'] );&nbsp;</div></li><li><div>            elseif ( $q['topic'] ) :&nbsp;</div></li><li><div>                if ( !$q['topic_id'] = bb_get_id_from_slug( 'topic', $q['topic'] ) )&nbsp;</div></li><li><div>                    $this-&gt;error( 'query_var:topic', 'No topic by that name' );&nbsp;</div></li><li><div>                $where .= &quot; AND p.topic_id = &quot; . $q['topic_id'];&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['forum_id'] ) :&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 'p.forum_id', $q['forum_id'] );&nbsp;</div></li><li><div>            elseif ( $q['forum'] ) :&nbsp;</div></li><li><div>                if ( !$q['forum_id'] = bb_get_id_from_slug( 'forum', $q['forum'] ) )&nbsp;</div></li><li><div>                    $this-&gt;error( 'query_var:forum', 'No forum by that name' );&nbsp;</div></li><li><div>                $where .= &quot; AND p.forum_id = &quot; . $q['forum_id'];&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $q['tag'] && !is_int($q['tag_id']) )&nbsp;</div></li><li><div>                $q['tag_id'] = (int) bb_get_tag_id( $q['tag'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric($q['tag_id']) ) :&nbsp;</div></li><li><div>                $join .= &quot; JOIN `$bbdb-&gt;term_relationships` AS tr ON ( p.`topic_id` = tr.`object_id` AND tr.`term_taxonomy_id` = $q[tag_id] )&quot;;&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric($q['favorites']) && $f_user = bb_get_user( $q['favorites'] ) )&nbsp;</div></li><li><div>                $where .= $this-&gt;parse_value( 'p.topic_id', $f_user-&gt;favorites );&nbsp;</div></li><li><div>        endif; // !_part_of_topic_query&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['post_text'] ) :&nbsp;</div></li><li><div>            $where  .= ' AND ' . $this-&gt;generate_post_text_sql( $q['post_text'] );&nbsp;</div></li><li><div>            if ( $this-&gt;match_query ) {&nbsp;</div></li><li><div>                $fields .= &quot;, $this-&gt;match_query AS search_score&quot;;&nbsp;</div></li><li><div>                if ( !$q['order_by'] )&nbsp;</div></li><li><div>                    $q['order_by'] = 'search_score';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $fields .= ', 0 AS search_score';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['posted'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;date( 'p.post_time', $q['posted'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['post_author_id'] ) :&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 'p.poster_id', $q['post_author_id'] );&nbsp;</div></li><li><div>        elseif ( $q['post_author'] ) :&nbsp;</div></li><li><div>            $user = bb_get_user( $q['post_author'], array( 'by' =&gt; 'login' ) );&nbsp;</div></li><li><div>            if ( !$q['post_author_id'] = (int) $user-&gt;ID )&nbsp;</div></li><li><div>                $this-&gt;error( 'query_var:user', 'No user by that name' );&nbsp;</div></li><li><div>            $where .= &quot; AND p.poster_id = $q[post_author_id]&quot;;&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$q['post_status'] ) :&nbsp;</div></li><li><div>            $where .= &quot; AND p.post_status = '0'&quot;;&nbsp;</div></li><li><div>        elseif ( false === strpos($q['post_status'], 'all') ) :&nbsp;</div></li><li><div>            $stati = array( 'normal' =&gt; 0, 'deleted' =&gt; 1 );&nbsp;</div></li><li><div>            $q['post_status'] = str_replace(array_keys($stati), array_values($stati), $q['post_status']);&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 'p.post_status', $q['post_status'] );&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['position'] )&nbsp;</div></li><li><div>            $where .= $this-&gt;parse_value( 'p.post_position', $q['position'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $q['poster_ip'] )&nbsp;</div></li><li><div>            $where .= &quot; AND poster_ip = '&quot; . $q['poster_ip'] . &quot;'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Just getting post part for inclusion in topic query&nbsp;</div></li><li><div>        if ( $_part_of_topic_query )&nbsp;</div></li><li><div>            return $where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where .= $topic_where;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $where ) // Get rid of initial &quot; AND &quot; (this is pre-filters)&nbsp;</div></li><li><div>            $where = substr($where, 5);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['index_hint'] )&nbsp;</div></li><li><div>            $index_hint = $q['index_hint'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $q['order_by'] )&nbsp;</div></li><li><div>            $order_by = $q['order_by'];&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $order_by = 'p.post_time';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $bits = compact( array('distinct', 'sql_calc_found_rows', 'fields', 'index_hint', 'join', 'where', 'group_by', 'having', 'order_by') );&nbsp;</div></li><li><div>        $this-&gt;request = $this-&gt;_filter_sql( $bits, &quot;$bbdb-&gt;posts AS p&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;request;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_topic_title_sql( $string ) {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>        $string = trim($string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !preg_match_all('/&quot;.*?(&quot;|$)|((?&lt;=[\s&quot;, +])|^)[^\s&quot;, +]+/', $string, $matches) ) {&nbsp;</div></li><li><div>            $string = $bbdb-&gt;escape($string);&nbsp;</div></li><li><div>            return &quot;(t.topic_title LIKE '%$string%')&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $matches[0] as $match ) {&nbsp;</div></li><li><div>            $term = trim($match, &quot;\&quot;\n\r &quot;);&nbsp;</div></li><li><div>            $term = $bbdb-&gt;escape($term);&nbsp;</div></li><li><div>            $where .= &quot; AND t.topic_title LIKE '%$term%'&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( count($matches[0]) &gt; 1 && $string != $matches[0][0] ) {&nbsp;</div></li><li><div>            $string = $bbdb-&gt;escape($string);&nbsp;</div></li><li><div>            $where .= &quot; OR t.topic_title LIKE '%$string%'&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return '(' . substr($where, 5) . ')';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function generate_post_text_sql( $string ) {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>        $string = trim($string);&nbsp;</div></li><li><div>        $_string = $bbdb-&gt;escape( $string );&nbsp;</div></li><li><div>        if ( strlen($string) &lt; 5 )&nbsp;</div></li><li><div>            return &quot;p.post_text LIKE '%$_string%'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;match_query = &quot;MATCH(p.post_text) AGAINST('$_string')&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _filter_sql( $bits, $from ) {&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $q =& $this-&gt;query_vars;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // MySQL 5.1 allows multiple index hints per query - earlier versions only get the first hint&nbsp;</div></li><li><div>        if ( $bits['index_hint'] ) {&nbsp;</div></li><li><div>            if ( !is_array( $bits['index_hint'] ) ) {&nbsp;</div></li><li><div>                $bits['index_hint'] = array( (string) $bits['index_hint'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $bbdb-&gt;has_cap( 'index_hint_for_any' ) ) {&nbsp;</div></li><li><div>                // 5.1 &lt;= MySQL&nbsp;</div></li><li><div>                $_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+(FOR\s+(JOIN|ORDER\s+BY|GROUP\s+BY)\s+)?\(\s*`?[a-z0-9_]+`?(\s*, \s*`?[a-z0-9_]+`?)*\s*\)\s*/i';&nbsp;</div></li><li><div>            } elseif ( $bbdb-&gt;has_cap( 'index_hint_for_join' ) ) {&nbsp;</div></li><li><div>                // 5.0 &lt;= MySQL &lt; 5.1&nbsp;</div></li><li><div>                $_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+(FOR\s+JOIN\s+)?\(\s*`?[a-z0-9_]+`?(\s*, \s*`?[a-z0-9_]+`?)*\s*\)\s*/i';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // MySQL &lt; 5.0&nbsp;</div></li><li><div>                $_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+\(\s*`?[a-z0-9_]+`?(\s*, \s*`?[a-z0-9_]+`?)*\s*\)\s*/i';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $_index_hint = array();&nbsp;</div></li><li><div>            foreach ( $bits['index_hint'] as $_hint ) {&nbsp;</div></li><li><div>                if ( preg_match( $_regex, $_hint ) ) {&nbsp;</div></li><li><div>                    $_index_hint[] = trim( $_hint );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset( $_regex, $_hint );&nbsp;</div></li><li><div>            if ( $bbdb-&gt;has_cap( 'index_hint_lists' ) ) {&nbsp;</div></li><li><div>                // 5.1 &lt;= MySQL&nbsp;</div></li><li><div>                $bits['index_hint'] = join( ' ', $_index_hint );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // MySQL &lt; 5.1&nbsp;</div></li><li><div>                $bits['index_hint'] = isset( $_index_hint[0] ) ? $_index_hint[0] : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset( $_index_hint );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $q['order'] = strtoupper($q['order']);&nbsp;</div></li><li><div>        if ( $q['order'] && in_array($q['order'], array('ASC', 'DESC')) )&nbsp;</div></li><li><div>            $bits['order_by'] .= &quot; $q[order]&quot;;&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $bits['order_by'] .= &quot; DESC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $bits['limit'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // When offset and number are provided, skip per_page and limit checks&nbsp;</div></li><li><div>        if ( !empty( $q['offset'] ) && !empty( $q['number'] ) ) {&nbsp;</div></li><li><div>            $bits['limit'] .= $q['offset'] . &quot;, &quot; . $q['number'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Else proceed as normal&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( !$q['per_page'] ) {&nbsp;</div></li><li><div>                $q['per_page'] = (int) bb_get_option( 'page_topics' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>            if ( $q['per_page'] &gt; 0 ) {&nbsp;</div></li><li><div>                if ( $q['page'] &gt; 1 ) {&nbsp;</div></li><li><div>                    $bits['limit'] .= $q['per_page'] * ( $q['page'] - 1 ) . &quot;, &quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $bits['limit'] .= $q['per_page'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $name = &quot;get_{$this-&gt;type}s_&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unfiltered&nbsp;</div></li><li><div>        $sql_calc_found_rows = $bits['sql_calc_found_rows'];&nbsp;</div></li><li><div>        unset($bits['sql_calc_found_rows']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $bits as $bit =&gt; $value ) {&nbsp;</div></li><li><div>            if ( $this-&gt;query_id )&nbsp;</div></li><li><div>                $value = apply_filters( &quot;{$this-&gt;query_id}_$bit&quot;, $value );&nbsp;</div></li><li><div>            $$bit = apply_filters( &quot;$name$bit&quot;, $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $where )&nbsp;</div></li><li><div>            $where = &quot;WHERE $where&quot;;&nbsp;</div></li><li><div>        if ( $group_by )&nbsp;</div></li><li><div>            $group_by = &quot;GROUP BY $group_by&quot;;&nbsp;</div></li><li><div>        if ( $having )&nbsp;</div></li><li><div>            $having = &quot;HAVING $having&quot;;&nbsp;</div></li><li><div>        if ( $order_by )&nbsp;</div></li><li><div>            $order_by = &quot;ORDER BY $order_by&quot;;&nbsp;</div></li><li><div>        if ( $limit )&nbsp;</div></li><li><div>            $limit = &quot;LIMIT $limit&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &quot;SELECT $distinct $sql_calc_found_rows $fields FROM $from $index_hint $join $where $group_by $having $order_by $limit&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function parse_value( $field, $value = '' ) {&nbsp;</div></li><li><div>        if ( !$value && !is_numeric($value) )&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $op = substr($value, 0, 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // #, =whatever, &lt;#, &gt;#.  Cannot do &lt; and &gt; at same time&nbsp;</div></li><li><div>        if ( in_array($op, array('&lt;', '=', '&gt;')) ) :&nbsp;</div></li><li><div>            $value = substr($value, 1);&nbsp;</div></li><li><div>            $value = is_numeric($value) ? (float) $value : $bbdb-&gt;escape( $value );&nbsp;</div></li><li><div>            return &quot; AND $field $op '$value'&quot;;&nbsp;</div></li><li><div>        elseif ( false === strpos($value, ', ') && 'NULL' !== $value && '-NULL' !== $value ) :&nbsp;</div></li><li><div>            $value = is_numeric($value) ? (float) $value : $bbdb-&gt;escape( $value );&nbsp;</div></li><li><div>            return '-' == $op ? &quot; AND $field != '&quot; . substr($value, 1) . &quot;'&quot; : &quot; AND $field = '$value'&quot;;&nbsp;</div></li><li><div>        endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $y = $n = array();&nbsp;</div></li><li><div>        foreach ( explode(', ', $value) as $v ) {&nbsp;</div></li><li><div>            $v = is_numeric($v) ? (int) $v : $bbdb-&gt;escape( $v );&nbsp;</div></li><li><div>            if ( '-' == substr($v, 0, 1) )&nbsp;</div></li><li><div>                if ( $v === '-NULL' )&nbsp;</div></li><li><div>                    $not_null_flag = true;&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $n[] = substr($v, 1);&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                if ( $v === 'NULL' )&nbsp;</div></li><li><div>                    $null_flag = true;&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $y[] = $v;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = '';&nbsp;</div></li><li><div>        if ( $y ) {&nbsp;</div></li><li><div>            $r .= &quot; AND &quot;;&nbsp;</div></li><li><div>            if ( $null_flag )&nbsp;</div></li><li><div>                $r .= &quot;(&quot;;&nbsp;</div></li><li><div>            $r .= &quot;$field IN ('&quot; . join(&quot;', '&quot;, $y) . &quot;')&quot;;&nbsp;</div></li><li><div>            if ( $null_flag )&nbsp;</div></li><li><div>                $r .= &quot; OR $field IS NULL)&quot;;&nbsp;</div></li><li><div>        } elseif ( $null_flag ) {&nbsp;</div></li><li><div>            $r .= &quot; AND $field IS NULL&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        if ( $n ) {&nbsp;</div></li><li><div>            $r .= &quot; AND &quot;;&nbsp;</div></li><li><div>            if ( $not_null_flag )&nbsp;</div></li><li><div>                $r .= &quot;(&quot;;&nbsp;</div></li><li><div>            $r .= &quot;$field NOT IN ('&quot; . join(&quot;', '&quot;, $n) . &quot;')&quot;;&nbsp;</div></li><li><div>            if ( $not_null_flag )&nbsp;</div></li><li><div>                $r .= &quot; AND $field IS NOT NULL)&quot;;&nbsp;</div></li><li><div>        } elseif ( $not_null_flag ) {&nbsp;</div></li><li><div>            $r .= &quot; AND $field IS NOT NULL&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $r;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function date( $field, $date ) {&nbsp;</div></li><li><div>        if ( !$date && !is_int($date) )&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_range = false !== strpos( $date, '--' ) )&nbsp;</div></li><li><div>            $dates = explode( '--', $date, 2 );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $dates = array( $date );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $op = false;&nbsp;</div></li><li><div>        $r = '';&nbsp;</div></li><li><div>        foreach ( $dates as $date ) {&nbsp;</div></li><li><div>            if ( $is_range ) {&nbsp;</div></li><li><div>                $op = $op ? '&lt;' : '&gt;';&nbsp;</div></li><li><div>                $date = (int) substr($date, 0, 14);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $op = substr($date, 0, 1);&nbsp;</div></li><li><div>                if ( !in_array($op, array('&gt;', '&lt;')) )&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                $date = (int) substr($date, 1, 14);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strlen($date) &lt; 14 )&nbsp;</div></li><li><div>                $date .= str_repeat('0', 14 - strlen($date));&nbsp;</div></li><li><div>            $r .= &quot; AND $field $op $date&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $r )&nbsp;</div></li><li><div>            return $r;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $date = (int) $date;&nbsp;</div></li><li><div>        $r = &quot; AND YEAR($field) = &quot; . substr($date, 0, 4);&nbsp;</div></li><li><div>        if ( strlen($date) &gt; 5 )&nbsp;</div></li><li><div>            $r .= &quot; AND MONTH($field) = &quot; . substr($date, 4, 2);&nbsp;</div></li><li><div>        if ( strlen($date) &gt; 7 )&nbsp;</div></li><li><div>            $r .= &quot; AND DAYOFMONTH($field) = &quot; . substr($date, 6, 2);&nbsp;</div></li><li><div>        if ( strlen($date) &gt; 9 )&nbsp;</div></li><li><div>            $r .= &quot; AND HOUR($field) = &quot; . substr($date, 8, 2);&nbsp;</div></li><li><div>        if ( strlen($date) &gt; 11 )&nbsp;</div></li><li><div>            $r .= &quot; AND MINUTE($field) = &quot; . substr($date, 10, 2);&nbsp;</div></li><li><div>        if ( strlen($date) &gt; 13 )&nbsp;</div></li><li><div>            $r .= &quot; AND SECOND($field) = &quot; . substr($date, 12, 2);&nbsp;</div></li><li><div>        return $r;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function error( $code, $message ) {&nbsp;</div></li><li><div>        if ( is_wp_error($this-&gt;errors) )&nbsp;</div></li><li><div>            $this-&gt;errors-&gt;add( $code, $message );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;errors = new WP_Error( $code, $message );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.4</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/bb_query/" class="active">2.8.2</a></li><li><a href="http://hookr.io/plugins/buddypress/2.8.1/classes/bb_query/" class="">2.8.1</a></li><li><a href="http://hookr.io/plugins/buddypress/2.8.0/classes/bb_query/" class="">2.8.0</a></li><li><a href="http://hookr.io/plugins/buddypress/2.7.5/classes/bb_query/" class="">2.7.5</a></li><li><a href="http://hookr.io/plugins/buddypress/2.7.4/classes/bb_query/" class="">2.7.4</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>BB_Query</li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>