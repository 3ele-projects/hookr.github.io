<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="class" data-id="50249"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp_attachment | class | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="BP_Attachment, class, plugin, buddypress, 2.8.2" /><meta name="description" content="BP Attachment class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=4b4bcca4fa9ebfd98e5321dc68cd1a2e' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/bp_attachment/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_attachment%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_attachment%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-class-bp_attachment","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp_attachment" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/buddypress/2.8.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp_attachment</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="active" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>BP_Attachment</strong></h1><p>BP Attachment class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/buddypress/2.8.2/files/bp-core-classes-class-bp-attachment/" class="file">/bp-core/classes/class-bp-attachment.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="20" class="block" start="20"><li><div>abstract class BP_Attachment {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Upload properties *****************************************************/&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The file being uploaded.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $attachment = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The default args to be merged with the&nbsp;</div></li><li><div>     * ones passed by the child class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $default_args = array(&nbsp;</div></li><li><div>        'original_max_filesize' =&gt; 0, &nbsp;</div></li><li><div>        'allowed_mime_types' =&gt; array(), &nbsp;</div></li><li><div>        'base_dir' =&gt; '', &nbsp;</div></li><li><div>        'action' =&gt; '', &nbsp;</div></li><li><div>        'file_input' =&gt; '', &nbsp;</div></li><li><div>        'upload_error_strings' =&gt; array(), &nbsp;</div></li><li><div>        'required_wp_files' =&gt; array( 'file' ), &nbsp;</div></li><li><div>        'upload_dir_filter_args' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Construct Upload parameters.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @since 2.4.0 Add the $upload_dir_filter_args argument to the $arguments array&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array|string $args {&nbsp;</div></li><li><div>     *     @type int    $original_max_filesize  Maximum file size in kilobytes. Defaults to php.ini settings.&nbsp;</div></li><li><div>     *     @type array  $allowed_mime_types     List of allowed file extensions (eg: array( 'jpg', 'gif', 'png' ) ).&nbsp;</div></li><li><div>     *                                          Defaults to WordPress allowed mime types.&nbsp;</div></li><li><div>     *     @type string $base_dir               Component's upload base directory. Defaults to WordPress 'uploads'.&nbsp;</div></li><li><div>     *     @type string $action                 The upload action used when uploading a file, $_POST['action'] must be set&nbsp;</div></li><li><div>     *                                          and its value must equal $action {@link wp_handle_upload()} (required).&nbsp;</div></li><li><div>     *     @type string $file_input             The name attribute used in the file input. (required).&nbsp;</div></li><li><div>     *     @type array  $upload_error_strings   A list of specific error messages (optional).&nbsp;</div></li><li><div>     *     @type array  $required_wp_files      The list of required WordPress core files. Default: array( 'file' ).&nbsp;</div></li><li><div>     *     @type int    $upload_dir_filter_args 1 to receive the original Upload dir array in the Upload dir filter, 0 otherwise.&nbsp;</div></li><li><div>     *                                          Defaults to 0 (optional).&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct( $args = '' ) {&nbsp;</div></li><li><div>        // Upload action and the file input name are required parameters.&nbsp;</div></li><li><div>        if ( empty( $args['action'] ) || empty( $args['file_input'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sanitize the action ID and the file input name.&nbsp;</div></li><li><div>        $this-&gt;action = sanitize_key( $args['action'] );&nbsp;</div></li><li><div>        $this-&gt;file_input = sanitize_key( $args['file_input'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Max file size defaults to php ini settings or, in the case of&nbsp;</div></li><li><div>         * a multisite config, the root site fileupload_maxk option&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $this-&gt;default_args['original_max_filesize'] = (int) wp_max_upload_size();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $params = bp_parse_args( $args, $this-&gt;default_args, $this-&gt;action . '_upload_params' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $params as $key =&gt; $param ) {&nbsp;</div></li><li><div>            if ( 'upload_error_strings' === $key ) {&nbsp;</div></li><li><div>                $this-&gt;{$key} = $this-&gt;set_upload_error_strings( $param );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sanitize the base dir.&nbsp;</div></li><li><div>            } elseif ( 'base_dir' === $key ) {&nbsp;</div></li><li><div>                $this-&gt;{$key} = sanitize_title( $param );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sanitize the upload dir filter arg to pass.&nbsp;</div></li><li><div>            } elseif ( 'upload_dir_filter_args' === $key ) {&nbsp;</div></li><li><div>                $this-&gt;{$key} = (int) $param;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Action & File input are already set and sanitized.&nbsp;</div></li><li><div>            } elseif ( 'action' !== $key && 'file_input' !== $key ) {&nbsp;</div></li><li><div>                $this-&gt;{$key} = $param;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set the path/url and base dir for uploads.&nbsp;</div></li><li><div>        $this-&gt;set_upload_dir();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set upload path and url for the component.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_upload_dir() {&nbsp;</div></li><li><div>        // Set the directory, path, & url variables.&nbsp;</div></li><li><div>        $this-&gt;upload_dir = bp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;upload_dir ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;upload_path = $this-&gt;upload_dir['basedir'];&nbsp;</div></li><li><div>        $this-&gt;url = $this-&gt;upload_dir['baseurl'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure URL is https if SSL is set/forced.&nbsp;</div></li><li><div>        if ( is_ssl() ) {&nbsp;</div></li><li><div>            $this-&gt;url = str_replace( 'http://', 'https://', $this-&gt;url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Custom base dir.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * If the component set this property, set the specific path, url and create the dir&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;base_dir ) ) {&nbsp;</div></li><li><div>            $this-&gt;upload_path = trailingslashit( $this-&gt;upload_path ) . $this-&gt;base_dir;&nbsp;</div></li><li><div>            $this-&gt;url = trailingslashit( $this-&gt;url ) . $this-&gt;base_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Finally create the base dir.&nbsp;</div></li><li><div>            $this-&gt;create_dir();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set Upload error messages.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Used into the $overrides argument of BP_Attachment-&gt;upload()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $param A list of error messages to add to BuddyPress core ones.&nbsp;</div></li><li><div>     * @return array $upload_errors The list of upload errors.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_upload_error_strings( $param = array() ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Index of the array is the error code&nbsp;</div></li><li><div>         * Custom errors will start at 9 code&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $upload_errors = array(&nbsp;</div></li><li><div>            0 =&gt; __( 'The file was uploaded successfully', 'buddypress' ), &nbsp;</div></li><li><div>            1 =&gt; __( 'The uploaded file exceeds the maximum allowed file size for this site', 'buddypress' ), &nbsp;</div></li><li><div>            2 =&gt; sprintf( __( 'The uploaded file exceeds the maximum allowed file size of: %s', 'buddypress' ), size_format( $this-&gt;original_max_filesize ) ), &nbsp;</div></li><li><div>            3 =&gt; __( 'The uploaded file was only partially uploaded.', 'buddypress' ), &nbsp;</div></li><li><div>            4 =&gt; __( 'No file was uploaded.', 'buddypress' ), &nbsp;</div></li><li><div>            5 =&gt; '', &nbsp;</div></li><li><div>            6 =&gt; __( 'Missing a temporary folder.', 'buddypress' ), &nbsp;</div></li><li><div>            7 =&gt; __( 'Failed to write file to disk.', 'buddypress' ), &nbsp;</div></li><li><div>            8 =&gt; __( 'File upload stopped by extension.', 'buddypress' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! array_intersect_key( $upload_errors, (array) $param ) ) {&nbsp;</div></li><li><div>            foreach ( $param as $key_error =&gt; $error_message ) {&nbsp;</div></li><li><div>                $upload_errors[ $key_error ] = $error_message;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $upload_errors;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Include the WordPress core needed files.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function includes() {&nbsp;</div></li><li><div>        foreach ( array_unique( $this-&gt;required_wp_files ) as $wp_file ) {&nbsp;</div></li><li><div>            if ( ! file_exists( ABSPATH . &quot;/wp-admin/includes/{$wp_file}.php&quot; ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            require_once( ABSPATH . &quot;/wp-admin/includes/{$wp_file}.php&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Upload the attachment.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array       $file              The appropriate entry the from $_FILES superglobal.&nbsp;</div></li><li><div>     * @param string      $upload_dir_filter A specific filter to be applied to 'upload_dir' (optional).&nbsp;</div></li><li><div>     * @param string|null $time              Optional. Time formatted in 'yyyy/mm'. Default null.&nbsp;</div></li><li><div>     * @return array On success, returns an associative array of file attributes.&nbsp;</div></li><li><div>     *               On failure, returns an array containing the error message&nbsp;</div></li><li><div>     *               (eg: array( 'error' =&gt; $message ) )&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function upload( $file, $upload_dir_filter = '', $time = null ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Upload action and the file input name are required parameters.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @see BP_Attachment:__construct()&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( empty( $this-&gt;action ) || empty( $this-&gt;file_input ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Add custom rules before enabling the file upload&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_filter( &quot;{$this-&gt;action}_prefilter&quot;, array( $this, 'validate_upload' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * The above dynamic filter was introduced in WordPress 4.0, as we support WordPress&nbsp;</div></li><li><div>         * back to 3.6, we need to also use the pre 4.0 static filter and remove it after&nbsp;</div></li><li><div>         * the upload was processed.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_filter( 'wp_handle_upload_prefilter', array( $this, 'validate_upload' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set Default overrides.&nbsp;</div></li><li><div>        $overrides = array(&nbsp;</div></li><li><div>            'action' =&gt; $this-&gt;action, &nbsp;</div></li><li><div>            'upload_error_strings' =&gt; $this-&gt;upload_error_strings, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Add a mime override if needed&nbsp;</div></li><li><div>         * Used to restrict uploads by extensions&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;allowed_mime_types ) ) {&nbsp;</div></li><li><div>            $mime_types = $this-&gt;validate_mime_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $mime_types ) ) {&nbsp;</div></li><li><div>                $overrides['mimes'] = $mime_types;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * If you need to add some overrides we haven't thought of.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $overrides The wp_handle_upload overrides&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $overrides = apply_filters( 'bp_attachment_upload_overrides', $overrides );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;includes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * If the $base_dir was set when constructing the class, &nbsp;</div></li><li><div>         * and no specific filter has been requested, use a default&nbsp;</div></li><li><div>         * filter to create the specific $base dir&nbsp;</div></li><li><div>         * @see  BP_Attachment-&gt;upload_dir_filter()&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( empty( $upload_dir_filter ) && ! empty( $this-&gt;base_dir ) ) {&nbsp;</div></li><li><div>            $upload_dir_filter = array( $this, 'upload_dir_filter' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure the file will be uploaded in the attachment directory.&nbsp;</div></li><li><div>        if ( ! empty( $upload_dir_filter ) ) {&nbsp;</div></li><li><div>            add_filter( 'upload_dir', $upload_dir_filter, 10, $this-&gt;upload_dir_filter_args );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upload the attachment.&nbsp;</div></li><li><div>        $this-&gt;attachment = wp_handle_upload( $file[ $this-&gt;file_input ], $overrides, $time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Restore WordPress Uploads data.&nbsp;</div></li><li><div>        if ( ! empty( $upload_dir_filter ) ) {&nbsp;</div></li><li><div>            remove_filter( 'upload_dir', $upload_dir_filter, 10 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove the pre WordPress 4.0 static filter.&nbsp;</div></li><li><div>        remove_filter( 'wp_handle_upload_prefilter', array( $this, 'validate_upload' ), 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Finally return the uploaded file or the error.&nbsp;</div></li><li><div>        return $this-&gt;attachment;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate the allowed mime types using WordPress allowed mime types.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * In case of a multisite, the mime types are already restricted by&nbsp;</div></li><li><div>     * the 'upload_filetypes' setting. BuddyPress will respect this setting.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see check_upload_mimes()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_mime_types() {&nbsp;</div></li><li><div>        $wp_mimes = get_allowed_mime_types();&nbsp;</div></li><li><div>        $valid_mimes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set the allowed mimes for the upload.&nbsp;</div></li><li><div>        foreach ( (array) $this-&gt;allowed_mime_types as $ext ) {&nbsp;</div></li><li><div>            foreach ( $wp_mimes as $ext_pattern =&gt; $mime ) {&nbsp;</div></li><li><div>                if ( $ext !== '' && strpos( $ext_pattern, $ext ) !== false ) {&nbsp;</div></li><li><div>                    $valid_mimes[$ext_pattern] = $mime;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $valid_mimes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Specific upload rules.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Override this function from your child class to build your specific rules&nbsp;</div></li><li><div>     * By default, if an original_max_filesize is provided, a check will be done&nbsp;</div></li><li><div>     * on the file size.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see BP_Attachment_Avatar-&gt;validate_upload() for an example of use&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $file The temporary file attributes (before it has been moved).&nbsp;</div></li><li><div>     * @return array The file.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function validate_upload( $file = array() ) {&nbsp;</div></li><li><div>        // Bail if already an error.&nbsp;</div></li><li><div>        if ( ! empty( $file['error'] ) ) {&nbsp;</div></li><li><div>            return $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;original_max_filesize ) && $file['size'] &gt; $this-&gt;original_max_filesize ) {&nbsp;</div></li><li><div>            $file['error'] = 2;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return the file.&nbsp;</div></li><li><div>        return $file;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Default filter to save the attachments.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @since 2.4.0 Add the $upload_dir parameter to the method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *       regarding to context&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $upload_dir The original Uploads dir.&nbsp;</div></li><li><div>     * @return array The upload directory data.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function upload_dir_filter( $upload_dir = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the component's upload directory.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.3.0&nbsp;</div></li><li><div>         * @since 2.4.0 Include the original Upload directory as the second parameter of the filter.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $value          Array containing the path, URL, and other helpful settings.&nbsp;</div></li><li><div>         * @param array $upload_dir     The original Uploads dir.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'bp_attachment_upload_dir', array(&nbsp;</div></li><li><div>            'path' =&gt; $this-&gt;upload_path, &nbsp;</div></li><li><div>            'url' =&gt; $this-&gt;url, &nbsp;</div></li><li><div>            'subdir' =&gt; false, &nbsp;</div></li><li><div>            'basedir' =&gt; $this-&gt;upload_path, &nbsp;</div></li><li><div>            'baseurl' =&gt; $this-&gt;url, &nbsp;</div></li><li><div>            'error' =&gt; false&nbsp;</div></li><li><div> ), $upload_dir );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create the custom base directory for the component uploads.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Override this function in your child class to run specific actions.&nbsp;</div></li><li><div>     * (eg: add an .htaccess file)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_dir() {&nbsp;</div></li><li><div>        // Bail if no specific base dir is set.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;base_dir ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check if upload path already exists.&nbsp;</div></li><li><div>        if ( ! is_dir( $this-&gt;upload_path ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If path does not exist, attempt to create it.&nbsp;</div></li><li><div>            if ( ! wp_mkdir_p( $this-&gt;upload_path ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Directory exists.&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Crop an image file.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args {&nbsp;</div></li><li><div>     *     @type string $original_file The source file (absolute path) for the Attachment.&nbsp;</div></li><li><div>     *     @type int    $crop_x        The start x position to crop from.&nbsp;</div></li><li><div>     *     @type int    $crop_y        The start y position to crop from.&nbsp;</div></li><li><div>     *     @type int    $crop_w        The width to crop.&nbsp;</div></li><li><div>     *     @type int    $crop_h        The height to crop.&nbsp;</div></li><li><div>     *     @type int    $dst_w         The destination width.&nbsp;</div></li><li><div>     *     @type int    $dst_h         The destination height.&nbsp;</div></li><li><div>     *     @type int    $src_abs       Optional. If the source crop points are absolute.&nbsp;</div></li><li><div>     *     @type string $dst_file      Optional. The destination file to write to.&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string|WP_Error New filepath on success, WP_Error on failure.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function crop( $args = array() ) {&nbsp;</div></li><li><div>        $wp_error = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>            'original_file' =&gt; '', &nbsp;</div></li><li><div>            'crop_x' =&gt; 0, &nbsp;</div></li><li><div>            'crop_y' =&gt; 0, &nbsp;</div></li><li><div>            'crop_w' =&gt; 0, &nbsp;</div></li><li><div>            'crop_h' =&gt; 0, &nbsp;</div></li><li><div>            'dst_w' =&gt; 0, &nbsp;</div></li><li><div>            'dst_h' =&gt; 0, &nbsp;</div></li><li><div>            'src_abs' =&gt; false, &nbsp;</div></li><li><div>            'dst_file' =&gt; false, &nbsp;</div></li><li><div> ), 'bp_attachment_crop_args' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $r['original_file'] ) || ! file_exists( $r['original_file'] ) ) {&nbsp;</div></li><li><div>            $wp_error-&gt;add( 'crop_error', __( 'Cropping the file failed: missing source file.', 'buddypress' ) );&nbsp;</div></li><li><div>            return $wp_error;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check image file pathes.&nbsp;</div></li><li><div>        $path_error = __( 'Cropping the file failed: the file path is not allowed.', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure it's coming from an uploaded file.&nbsp;</div></li><li><div>        if ( false === strpos( $r['original_file'], $this-&gt;upload_path ) ) {&nbsp;</div></li><li><div>            $wp_error-&gt;add( 'crop_error', $path_error );&nbsp;</div></li><li><div>            return $wp_error;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * If no destination file is provided, WordPress will use a default name&nbsp;</div></li><li><div>         * and will write the file in the source file's folder.&nbsp;</div></li><li><div>         * If a destination file is provided, we need to make sure it's going into uploads.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( ! empty( $r['dst_file'] ) && false === strpos( $r['dst_file'], $this-&gt;upload_path ) ) {&nbsp;</div></li><li><div>            $wp_error-&gt;add( 'crop_error', $path_error );&nbsp;</div></li><li><div>            return $wp_error;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check image file types.&nbsp;</div></li><li><div>        $check_types = array( 'src_file' =&gt; array( 'file' =&gt; $r['original_file'], 'error' =&gt; _x( 'source file', 'Attachment source file', 'buddypress' ) ) );&nbsp;</div></li><li><div>        if ( ! empty( $r['dst_file'] ) ) {&nbsp;</div></li><li><div>            $check_types['dst_file'] = array( 'file' =&gt; $r['dst_file'], 'error' =&gt; _x( 'destination file', 'Attachment destination file', 'buddypress' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * WordPress image supported types.&nbsp;</div></li><li><div>         * @see wp_attachment_is()&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $supported_image_types = array(&nbsp;</div></li><li><div>            'jpg' =&gt; 1, &nbsp;</div></li><li><div>            'jpeg' =&gt; 1, &nbsp;</div></li><li><div>            'jpe' =&gt; 1, &nbsp;</div></li><li><div>            'gif' =&gt; 1, &nbsp;</div></li><li><div>            'png' =&gt; 1, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $check_types as $file ) {&nbsp;</div></li><li><div>            $is_image = wp_check_filetype( $file['file'] );&nbsp;</div></li><li><div>            $ext = $is_image['ext'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $ext ) || empty( $supported_image_types[ $ext ] ) ) {&nbsp;</div></li><li><div>                $wp_error-&gt;add( 'crop_error', sprintf( __( 'Cropping the file failed: %s is not a supported image file.', 'buddypress' ), $file['error'] ) );&nbsp;</div></li><li><div>                return $wp_error;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add the image.php to the required WordPress files, if it's not already the case.&nbsp;</div></li><li><div>        $required_files = array_flip( $this-&gt;required_wp_files );&nbsp;</div></li><li><div>        if ( ! isset( $required_files['image'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;required_wp_files[] = 'image';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load the files.&nbsp;</div></li><li><div>        $this-&gt;includes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Finally crop the image.&nbsp;</div></li><li><div>        return wp_crop_image( $r['original_file'], (int) $r['crop_x'], (int) $r['crop_y'], (int) $r['crop_w'], (int) $r['crop_h'], (int) $r['dst_w'], (int) $r['dst_h'], $r['src_abs'], $r['dst_file'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Build script datas for the Uploader UI.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Override this method from your child class to build the script datas.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array The javascript localization data.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function script_data() {&nbsp;</div></li><li><div>        $script_data = array(&nbsp;</div></li><li><div>            'action' =&gt; $this-&gt;action, &nbsp;</div></li><li><div>            'file_data_name' =&gt; $this-&gt;file_input, &nbsp;</div></li><li><div>            'max_file_size' =&gt; $this-&gt;original_max_filesize, &nbsp;</div></li><li><div>            'feedback_messages' =&gt; array(&nbsp;</div></li><li><div>                1 =&gt; __( 'Sorry, uploading the file failed.', 'buddypress' ), &nbsp;</div></li><li><div>                2 =&gt; __( 'File successfully uploaded.', 'buddypress' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get full data for an image&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $file Absolute path to the uploaded image.&nbsp;</div></li><li><div>     * @return bool|array   An associate array containing the width, height and metadatas.&nbsp;</div></li><li><div>     *                      False in case an important image attribute is missing.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_image_data( $file ) {&nbsp;</div></li><li><div>        // Try to get image basic data.&nbsp;</div></li><li><div>        list( $width, $height, $sourceImageType ) = @getimagesize( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No need to carry on if we couldn't get image's basic data.&nbsp;</div></li><li><div>        if ( is_null( $width ) || is_null( $height ) || is_null( $sourceImageType ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initialize the image data.&nbsp;</div></li><li><div>        $image_data = array(&nbsp;</div></li><li><div>            'width' =&gt; $width, &nbsp;</div></li><li><div>            'height' =&gt; $height, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Make sure the wp_read_image_metadata function is reachable for the old Avatar UI&nbsp;</div></li><li><div>         * or if WordPress &lt; 3.9 (New Avatar UI is not available in this case)&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( ! function_exists( 'wp_read_image_metadata' ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/image.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Now try to get image's meta data.&nbsp;</div></li><li><div>        $meta = wp_read_image_metadata( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $meta ) ) {&nbsp;</div></li><li><div>            // Before 4.0 the Orientation wasn't included.&nbsp;</div></li><li><div>            if ( ! isset( $meta['orientation'] ) &&&nbsp;</div></li><li><div>                is_callable( 'exif_read_data' ) &&&nbsp;</div></li><li><div>                in_array( $sourceImageType, apply_filters( 'wp_read_image_metadata_types', array( IMAGETYPE_JPEG, IMAGETYPE_TIFF_II, IMAGETYPE_TIFF_MM ) ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $exif = exif_read_data( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $exif['Orientation'] ) ) {&nbsp;</div></li><li><div>                    $meta['orientation'] = $exif['Orientation'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Now add the metas to image data.&nbsp;</div></li><li><div>            $image_data['meta'] = $meta;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter here to add/remove/edit data to the image full data&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.4.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $image_data An associate array containing the width, height and metadatas.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'bp_attachments_get_image_data', $image_data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an image file to resize it or rotate it&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $attachment_type The attachment type (eg: avatar or cover_image). Required.&nbsp;</div></li><li><div>     * @param array  $args {&nbsp;</div></li><li><div>     *     @type string $file     Absolute path to the image file (required).&nbsp;</div></li><li><div>     *     @type int    $max_w    Max width attribute for the editor's resize method (optional).&nbsp;</div></li><li><div>     *     @type int    $max_h    Max height attribute for the editor's resize method (optional).&nbsp;</div></li><li><div>     *     @type bool   $crop     Crop attribute for the editor's resize method (optional).&nbsp;</div></li><li><div>     *     @type float  $rotate   Angle for the editor's rotate method (optional).&nbsp;</div></li><li><div>     *     @type int    $quality  Compression quality on a 1-100% scale (optional).&nbsp;</div></li><li><div>     *     @type bool   $save     Whether to use the editor's save method or not (optional).&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     * @return string|WP_Image_Editor|WP_Error The edited image path or the WP_Image_Editor object in case of success, &nbsp;</div></li><li><div>     *                                         an WP_Error object otherwise.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function edit_image( $attachment_type, $args = array() ) {&nbsp;</div></li><li><div>        if ( empty( $attachment_type ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'missing_parameter' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>            'file' =&gt; '', &nbsp;</div></li><li><div>            'max_w' =&gt; 0, &nbsp;</div></li><li><div>            'max_h' =&gt; 0, &nbsp;</div></li><li><div>            'crop' =&gt; false, &nbsp;</div></li><li><div>            'rotate' =&gt; 0, &nbsp;</div></li><li><div>            'quality' =&gt; 90, &nbsp;</div></li><li><div>            'save' =&gt; true, &nbsp;</div></li><li><div> ), 'attachment_' . $attachment_type . '_edit_image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure we have to edit the image.&nbsp;</div></li><li><div>        if ( empty( $r['max_w'] ) && empty( $r['max_h'] ) && empty( $r['rotate'] ) && empty( $r['file'] ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'missing_parameter' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the image editor.&nbsp;</div></li><li><div>        $editor = wp_get_image_editor( $r['file'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $editor ) ) {&nbsp;</div></li><li><div>            return $editor;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $editor-&gt;set_quality( $r['quality'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $r['rotate'] ) ) {&nbsp;</div></li><li><div>            $rotated = $editor-&gt;rotate( $r['rotate'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Stop in case of error.&nbsp;</div></li><li><div>            if ( is_wp_error( $rotated ) ) {&nbsp;</div></li><li><div>                return $rotated;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $r['max_w'] ) || ! empty( $r['max_h'] ) ) {&nbsp;</div></li><li><div>            $resized = $editor-&gt;resize( $r['max_w'], $r['max_h'], $r['crop'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Stop in case of error.&nbsp;</div></li><li><div>            if ( is_wp_error( $resized ) ) {&nbsp;</div></li><li><div>                return $resized;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Use the editor save method to get a path to the edited image.&nbsp;</div></li><li><div>        if ( true === $r['save'] ) {&nbsp;</div></li><li><div>            return $editor-&gt;save( $editor-&gt;generate_filename() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Need to do some other edit actions or use a specific method to save file.&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $editor;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.3.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/bp_attachment/" class="active">2.8.2</a></li><li><a href="http://hookr.io/plugins/buddypress/2.8.1/classes/bp_attachment/" class="">2.8.1</a></li><li><a href="http://hookr.io/plugins/buddypress/2.8.0/classes/bp_attachment/" class="">2.8.0</a></li><li><a href="http://hookr.io/plugins/buddypress/2.7.5/classes/bp_attachment/" class="">2.7.5</a></li><li><a href="http://hookr.io/plugins/buddypress/2.7.4/classes/bp_attachment/" class="">2.7.4</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>BP_Attachment</li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>