<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49104"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-forums-bbpress-bb-admin-includes-functions-bb-admin | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.24"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=1064269d074c74e0ea210c8ba8e20dfa' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.24' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-forums-bbpress-bb-admin-includes-functions-bb-admin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-admin-includes-functions-bb-admin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-forums-bbpress-bb-admin-includes-functions-bb-admin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-forums-bbpress-bb-admin-includes-functions-bb-admin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-forums-bbpress-bb-admin-includes-functions-bb-admin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-forums-bbpress-bb-admin-in&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-forums/bbpress/bb-admin/includes/functions.bb-admin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_admin_header()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  do_action( 'bb_admin-header.php' );&nbsp;</div></li><li><div>  include( 'admin-header.php' );&nbsp;</div></li><li><div>  do_action( 'bb_get_admin_header' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_admin_footer()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  do_action( 'bb_admin-footer.php' );&nbsp;</div></li><li><div>  include( 'admin-footer.php' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_notice( $message, $class = false )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( is_string( $message ) ) {&nbsp;</div></li><li><div>      $message = '&lt;p&gt;' . $message . '&lt;/p&gt;';&nbsp;</div></li><li><div>      $class = $class ? $class : 'updated';&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $message ) ) {&nbsp;</div></li><li><div>      $errors = $message-&gt;get_error_messages();&nbsp;</div></li><li><div>      switch ( count( $errors ) ) {&nbsp;</div></li><li><div>          case 0:&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 1:&nbsp;</div></li><li><div>              $message = '&lt;p&gt;' . $errors[0] . '&lt;/p&gt;';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $message = '&lt;ul&gt;' . &quot;\n\t&quot; . '&lt;li&gt;' . join( '&lt;/li&gt;' . &quot;\n\t&quot; . '&lt;li&gt;', $errors ) . '&lt;/li&gt;' . &quot;\n&quot; . '&lt;/ul&gt;';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $class = $class ? $class : 'error';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = '&lt;div id=&quot;message&quot; class=&quot;' . esc_attr( $class ) . '&quot;&gt;' . $message . '&lt;/div&gt;';&nbsp;</div></li><li><div>  $message = str_replace( &quot;'&quot;, &quot;\'&quot;, $message );&nbsp;</div></li><li><div>  $lambda = create_function( '', &quot;echo '$message';&quot; );&nbsp;</div></li><li><div>  add_action( 'bb_admin_notices', $lambda );&nbsp;</div></li><li><div>  return $lambda;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Menu */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_menu_generator()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_menu, $bb_submenu;&nbsp;</div></li><li><div>  $bb_menu = array();&nbsp;</div></li><li><div>  $bb_submenu = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Dashboard menu items &lt; 50</span>&nbsp;</div></li><li><div>  $bb_menu[0] = array( __( 'Dashboard' ), 'moderate', 'index.php', '', 'bb-menu-dashboard' );&nbsp;</div></li><li><div>      $bb_submenu['index.php'][5] = array( __( 'Dashboard' ), 'moderate', 'index.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 50 &lt; Plugin added menu items &lt; 100</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_menu[100] = array( '', 'read', 'separator' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 100 &lt; Plugin added menu items &lt; 150</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 150 &lt; First menu items &lt; 200</span>&nbsp;</div></li><li><div>  $bb_menu[150] = array( __( 'Forums' ), 'manage_forums', 'forums.php', '', 'bb-menu-forums' );&nbsp;</div></li><li><div>      $bb_submenu['forums.php'][5] = array( __( 'Forums' ), 'manage_forums', 'forums.php' );&nbsp;</div></li><li><div>  $bb_menu[155] = array( __( 'Topics' ), 'moderate', 'topics.php', '', 'bb-menu-topics' );&nbsp;</div></li><li><div>      $bb_submenu['topics.php'][5] = array( __( 'Topics' ), 'moderate', 'topics.php' );&nbsp;</div></li><li><div>  $bb_menu[160] = array( __( 'Posts' ), 'moderate', 'posts.php', '', 'bb-menu-posts' );&nbsp;</div></li><li><div>      $bb_submenu['posts.php'][5] = array( __( 'Posts' ), 'moderate', 'posts.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 200 &lt; Plugin added menu items &lt; 250</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bb_menu[250] = array( '', 'read', 'separator' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 250 &lt; Plugin added menu items &lt; 300</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 300 &lt; Second menu items &lt; 350</span>&nbsp;</div></li><li><div>  $bb_menu[300] = array( __( 'Appearance' ), 'manage_themes', 'themes.php', '', 'bb-menu-appearance' );&nbsp;</div></li><li><div>      $bb_submenu['themes.php'][5] = array(__('Themes'), 'manage_themes', 'themes.php');&nbsp;</div></li><li><div>  $bb_menu[305] = array( __( 'Plugins' ), 'use_keys', 'plugins.php', '', 'bb-menu-plugins' );&nbsp;</div></li><li><div>      $bb_submenu['plugins.php'][5] = array( __( 'Installed' ), 'manage_plugins', 'plugins.php' );&nbsp;</div></li><li><div>  $bb_menu[310] = array( __( 'Users' ), 'moderate', 'users.php', '', 'bb-menu-users' );&nbsp;</div></li><li><div>      $bb_submenu['users.php'][5] = array( __( 'Users' ), 'moderate', 'users.php' );&nbsp;</div></li><li><div>      $bb_submenu['users.php'][10] = array( __( 'Add New' ), 'manage_options', 'user-add-new.php' );&nbsp;</div></li><li><div>  $bb_menu[315] = array( __( 'Tools' ), 'recount', 'tools-recount.php', '', 'bb-menu-tools' );&nbsp;</div></li><li><div>      $bb_submenu['tools-recount.php'][5] = array( __( 'Re-count' ), 'recount', 'tools-recount.php' );&nbsp;</div></li><li><div>  $bb_menu[320] = array( __( 'Settings' ), 'manage_options', 'options-general.php', '', 'bb-menu-settings' );&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][5] = array( __( 'General' ), 'manage_options', 'options-general.php' );&nbsp;</div></li><li><div>      <span class="comment">//$bb_submenu['options-general.php'][10] = array( __( 'Date and Time' ), 'manage_options', 'options-time.php' );</span>&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][15] = array( __( 'Writing' ), 'manage_options', 'options-writing.php' );&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][20] = array( __( 'Reading' ), 'manage_options', 'options-reading.php' );&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][25] = array( __( 'Discussion' ), 'manage_options', 'options-discussion.php' );&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][30] = array( __( 'Permalinks' ), 'manage_options', 'options-permalinks.php' );&nbsp;</div></li><li><div>      $bb_submenu['options-general.php'][35] = array( __( 'WordPress Integration' ), 'manage_options', 'options-wordpress.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 350 &lt; Plugin added menu items</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'bb_admin_menu_generator' );&nbsp;</div></li><li><div>  ksort( $bb_menu );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $last_key = false;&nbsp;</div></li><li><div>  foreach ( $bb_menu as $key =&gt; $m ) {&nbsp;</div></li><li><div>      if ( $last_key === false || $bb_menu[$last_key][2] === 'separator' ) {&nbsp;</div></li><li><div>          $bb_menu[$key][3] .= ' bb-menu-first';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $bb_menu[$key][2] === 'separator' ) {&nbsp;</div></li><li><div>          $bb_menu[$last_key][3] .= ' bb-menu-last';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $last_key = $key;&nbsp;</div></li><li><div>      if ( isset( $bb_submenu[$m[2]] ) ) {&nbsp;</div></li><li><div>          ksort( $bb_submenu[$m[2]] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $bb_menu[$last_key][3] .= ' bb-menu-last';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_add_menu( $display_name, $capability, $file_name, $menu_position = false, $class = '', $id = '' )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_menu;&nbsp;</div></li><li><div>  global $bb_registered_plugin_callbacks;&nbsp;</div></li><li><div>  if ( empty( $bb_registered_plugin_callbacks ) ) {&nbsp;</div></li><li><div>      $bb_registered_plugin_callbacks = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $display_name && $capability && $file_name ) {&nbsp;</div></li><li><div>      <span class="comment">// Get an array of the keys</span>&nbsp;</div></li><li><div>      $menu_keys = array_keys( $bb_menu );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $menu_position ) {&nbsp;</div></li><li><div>          if ( is_numeric( $menu_position ) ) {&nbsp;</div></li><li><div>              if ( !isset( $bb_menu[$menu_position] ) ) {&nbsp;</div></li><li><div>                  $plugin_menu_next = $menu_position;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return bb_admin_add_menu( $display_name, $capability, $file_name, ( $menu_position + 1 ), $class, $id );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Set the bounds for different menu groups (main or side)</span>&nbsp;</div></li><li><div>              switch ( $menu_position ) {&nbsp;</div></li><li><div>                  case 'dash':&nbsp;</div></li><li><div>                      $lower = 50;&nbsp;</div></li><li><div>                      $upper = 100;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'main':&nbsp;</div></li><li><div>                      $lower = 200;&nbsp;</div></li><li><div>                      $upper = 250;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  default:&nbsp;</div></li><li><div>                      $lower = 350;&nbsp;</div></li><li><div>                      $upper = 500;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get an array of all plugin added keys</span>&nbsp;</div></li><li><div>              $plugin_menu_keys = array_filter( $menu_keys, create_function( '$v', 'if ($v &gt;= ' . $lower . ' && $v &lt; ' . $upper . ') { return $v; }' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If there is an array of keys</span>&nbsp;</div></li><li><div>              if ( is_array( $plugin_menu_keys ) && count( $plugin_menu_keys ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// Get the highest key value and add one</span>&nbsp;</div></li><li><div>                  $plugin_menu_next = max( $plugin_menu_keys ) + 1;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// It's the first one</span>&nbsp;</div></li><li><div>                  $plugin_menu_next = $lower;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $plugin_menu_next = max( array_keys( $bb_menu ) ) + 1;&nbsp;</div></li><li><div>          $bb_menu[$plugin_menu_next] = array( '', 'read', 'separator' );&nbsp;</div></li><li><div>          $plugin_menu_next++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strpos( $file_name, '.php' ) === false ) {&nbsp;</div></li><li><div>          $bb_registered_plugin_callbacks[] = $file_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the menu item at the given key</span>&nbsp;</div></li><li><div>      $bb_menu[$plugin_menu_next] = array( $display_name, $capability, $file_name, $class, $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ksort( $bb_menu );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $plugin_menu_next;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_add_submenu( $display_name, $capability, $file_name, $parent = 'plugins.php' )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_submenu;&nbsp;</div></li><li><div>  global $bb_registered_plugin_callbacks;&nbsp;</div></li><li><div>  if ( empty( $bb_registered_plugin_callbacks ) ) {&nbsp;</div></li><li><div>      $bb_registered_plugin_callbacks = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $display_name && $capability && $file_name ) {&nbsp;</div></li><li><div>      if ( strpos( $file_name, '.php' ) === false ) {&nbsp;</div></li><li><div>          $bb_registered_plugin_callbacks[] = $file_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $bb_submenu[$parent][] = array( $display_name, $capability, $file_name );&nbsp;</div></li><li><div>      ksort( $bb_submenu );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_current_admin_menu()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_menu, $bb_submenu, $bb_admin_page, $bb_current_menu, $bb_current_submenu;&nbsp;</div></li><li><div>  foreach ( $bb_submenu as $m =&gt; $b ) {&nbsp;</div></li><li><div>      foreach ( $b as $s ) {&nbsp;</div></li><li><div>          if ( $s[2] == $bb_admin_page ) {&nbsp;</div></li><li><div>              $bb_current_submenu = $s;&nbsp;</div></li><li><div>              $bb_current_menu = $m;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( !isset($bb_current_menu) ) {&nbsp;</div></li><li><div>      $bb_current_menu = $bb_menu[0];&nbsp;</div></li><li><div>      $bb_current_submenu = $bb_submenu['index.php'][5];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      foreach ( $bb_menu as $m ) {&nbsp;</div></li><li><div>          if ( $m[2] == $bb_current_menu ) {&nbsp;</div></li><li><div>              $bb_current_menu = $m;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( $bb_current_submenu && !bb_current_user_can( $bb_current_submenu[1] ) || !bb_current_user_can( $bb_current_menu[1] ) ) {&nbsp;</div></li><li><div>      wp_redirect( bb_get_uri(null, null, BB_URI_CONTEXT_HEADER) );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_title()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_current_menu, $bb_current_submenu;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $title = $bb_current_menu[0] . ' &lsaquo; ' . bb_get_option( 'name' ) . ' &#8212; ' . __( 'bbPress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $bb_current_submenu && $bb_current_submenu[0] !== $bb_current_menu[0] ) {&nbsp;</div></li><li><div>      $title = $bb_current_submenu[0] . ' &lsaquo; ' . $title;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo esc_html( $title );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_menu()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $bb_menu, $bb_submenu, $bb_current_menu, $bb_current_submenu;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_array( $bb_menu ) || !count( $bb_menu ) ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = &quot;\t\t\t&quot; . '&lt;ul id=&quot;bbAdminMenu&quot;&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $bb_menu as $key =&gt; $m ) {&nbsp;</div></li><li><div>      if ( !bb_current_user_can( $m[1] ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $class = 'bb-menu';&nbsp;</div></li><li><div>      if ( isset( $m[3] ) ) {&nbsp;</div></li><li><div>          $class .= ' ' . $m[3];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $id = '';&nbsp;</div></li><li><div>      if ( isset( $m[4] ) ) {&nbsp;</div></li><li><div>          $id .= ' id=&quot;' . $m[4] . '&quot;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $m[0] = esc_html( $m[0] );&nbsp;</div></li><li><div>      if ( $m[2] === 'separator' ) {&nbsp;</div></li><li><div>          if ( 'f' == bb_get_user_setting( 'fm' ) ) {&nbsp;</div></li><li><div>              $href = '?foldmenu=0';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $href = '?foldmenu=1';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $m[0] = '&lt;br /&gt;';&nbsp;</div></li><li><div>          $class .= ' bb-menu-separator';&nbsp;</div></li><li><div>      } elseif ( strpos( $m[2], 'http:<span class="comment">//' ) === 0 || strpos( $m[2], 'https://' ) === 0 ) {</span>&nbsp;</div></li><li><div>          $href = esc_url( $m[2] );&nbsp;</div></li><li><div>          $class .= ' bb-menu-external';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $href = esc_url( bb_get_option( 'path' ) . 'bb-admin/' . bb_get_admin_tab_link( $m[2] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $m[2] == $bb_current_menu[2] ) {&nbsp;</div></li><li><div>          $class .= ' bb-menu-current';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sr = '';&nbsp;</div></li><li><div>      if ( $m[2] !== 'separator' && isset( $bb_submenu[$m[2]] ) && is_array( $bb_submenu[$m[2]] ) && count( $bb_submenu[$m[2]] ) ) {&nbsp;</div></li><li><div>          $sr .= &quot;\t\t\t\t\t&quot; . '&lt;div class=&quot;bb-menu-sub-wrap&quot;&gt;&lt;span&gt;' . $m[0] . '&lt;/span&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          $sr .= &quot;\t\t\t\t\t\t&quot; . '&lt;ul&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          $sc = 0;&nbsp;</div></li><li><div>          foreach ( $bb_submenu[$m[2]] as $skey =&gt; $sm ) {&nbsp;</div></li><li><div>              if ( !bb_current_user_can( $sm[1] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $sc === 0 && $sm[2] === $m[2] ) {&nbsp;</div></li><li><div>                  $no_submenu = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $sc &gt; 0 ) {&nbsp;</div></li><li><div>                  $no_submenu = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $sc++;&nbsp;</div></li><li><div>              $sclass = 'bb-menu-sub';&nbsp;</div></li><li><div>              if ( isset( $sm[3] ) ) {&nbsp;</div></li><li><div>                  $sclass .= ' ' . $sm[3];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( strpos( $sm[2], 'http:<span class="comment">//' ) === 0 || strpos( $sm[2], 'https://' ) === 0 ) {</span>&nbsp;</div></li><li><div>                  $shref = $sm[2];&nbsp;</div></li><li><div>                  $sclass .= ' bb-menu-external';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $shref = bb_get_option( 'path' ) . 'bb-admin/' . bb_get_admin_tab_link( $sm[2] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $sm[2] == $bb_current_submenu[2] ) {&nbsp;</div></li><li><div>                  $sclass .= ' bb-menu-sub-current';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $sr .= &quot;\t\t\t\t\t\t\t&quot; . '&lt;li class=&quot;' . esc_attr( trim( $sclass ) ) . '&quot;&gt;&lt;a href=&quot;' . esc_url( $shref ) . '&quot;&gt;' . esc_html( $sm[0] ) . '&lt;/a&gt;&lt;/li&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $sr .= &quot;\t\t\t\t\t\t&quot; . '&lt;/ul&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          $sr .= &quot;\t\t\t\t\t&quot; . '&lt;/div&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $sr && !$no_submenu ) {&nbsp;</div></li><li><div>          $class .= ' bb-menu-has-submenu';&nbsp;</div></li><li><div>          if ( $m[2] == $bb_current_menu[2] ) {&nbsp;</div></li><li><div>              $class .= ' bb-menu-open';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t\t&quot; . '&lt;li' . $id . ' class=&quot;' . esc_attr( trim( $class ) ) . '&quot;&gt;&lt;a href=&quot;' . $href . '&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $m[2] !== 'separator' ) {&nbsp;</div></li><li><div>          $r .= '&lt;div class=&quot;bb-menu-icon&quot;&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r .= '&lt;span&gt;' . $m[0] . '&lt;/span&gt;&lt;/a&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $sr && !$no_submenu ) {&nbsp;</div></li><li><div>          $r .= '&lt;div class=&quot;bb-menu-toggle&quot;&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>          $r .= $sr;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t\t&quot; . '&lt;/li&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r .= &quot;\t\t\t&quot; . '&lt;/ul&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_admin_tab_link( $tab )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( is_array( $tab ) ) {&nbsp;</div></li><li><div>      $tab = $tab[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( strpos( $tab, '.php' ) !== false ) {&nbsp;</div></li><li><div>      return $tab;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return 'admin-base.php?plugin=' . $tab;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Stats */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_recently_moderated_objects( $num = 5 ) {&nbsp;</div></li><li><div>  $post_query = new BB_Query( 'post', array( 'per_page' =&gt; $num, 'post_status' =&gt; '-normal', 'topic_status' =&gt; 0 ) ); <span class="comment">// post_time != moderation_time;</span>&nbsp;</div></li><li><div>  $topic_query = new BB_Query( 'topic', array( 'per_page' =&gt; $num, 'topic_status' =&gt; '-normal' ) ); <span class="comment">// topic_time == topic_start_time != moderation_time;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $objects = array();&nbsp;</div></li><li><div>  if ( $post_query-&gt;results )&nbsp;</div></li><li><div>      foreach ( array_keys($post_query-&gt;results) as $key )&nbsp;</div></li><li><div>          $objects[bb_gmtstrtotime($post_query-&gt;results[$key]-&gt;post_time)] = array('type' =&gt; 'post', 'data' =&gt; $post_query-&gt;results[$key]);&nbsp;</div></li><li><div>  if ( $topic_query-&gt;results )&nbsp;</div></li><li><div>      foreach ( array_keys($topic_query-&gt;results) as $key )&nbsp;</div></li><li><div>          $objects[bb_gmtstrtotime($topic_query-&gt;results[$key]-&gt;topic_time)] = array('type' =&gt; 'topic', 'data' =&gt; $topic_query-&gt;results[$key]);&nbsp;</div></li><li><div>  krsort($objects);&nbsp;</div></li><li><div>  return array_slice($objects, 0, $num);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Users */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_manage_user_fields( $edit_user = '' ) {&nbsp;</div></li><li><div>  global $wp_roles, $wp_users_object, $bbdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cap checks</span>&nbsp;</div></li><li><div>  $user_roles = $wp_roles-&gt;role_names;&nbsp;</div></li><li><div>  $can_keep_gate = bb_current_user_can( 'keep_gate' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'post' == strtolower( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      bb_check_admin_referer( 'user-manage' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Instantiate required vars</span></span>&nbsp;</div></li><li><div>      $_POST = stripslashes_deep( $_POST );&nbsp;</div></li><li><div>      $create_user_errors = new WP_Error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User login</span>&nbsp;</div></li><li><div>      $trimmed_user_login = str_replace( ' ', '', $_POST['user_login'] );&nbsp;</div></li><li><div>      $user_login = sanitize_user( $_POST['user_login'], true );&nbsp;</div></li><li><div>      $user_meta['first_name'] = $_POST['first_name'];&nbsp;</div></li><li><div>      $user_meta['last_name'] = $_POST['last_name'];&nbsp;</div></li><li><div>      $user_display_name = $_POST['display_name'];&nbsp;</div></li><li><div>      $user_email = $_POST['user_email'];&nbsp;</div></li><li><div>      $user_url = $_POST['user_url'];&nbsp;</div></li><li><div>      $user_meta['from'] = $_POST['from'];&nbsp;</div></li><li><div>      $user_meta['occ'] = $_POST['occ'];&nbsp;</div></li><li><div>      $user_meta['interest'] = $_POST['interest'];&nbsp;</div></li><li><div>      $user_role = $_POST['userrole'];&nbsp;</div></li><li><div>      $user_meta['throttle'] = $_POST['throttle'];&nbsp;</div></li><li><div>      $user_pass1 = $_POST['pass1'];&nbsp;</div></li><li><div>      $user_pass2 = $_POST['pass2'];&nbsp;</div></li><li><div>      $user_status = 0;&nbsp;</div></li><li><div>      $user_pass = false;&nbsp;</div></li><li><div>      $user_url = $user_url ? bb_fix_link( $user_url ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check user_login</span>&nbsp;</div></li><li><div>      if ( !isset( $_GET['action'] ) && empty( $user_login ) ) {&nbsp;</div></li><li><div>          $create_user_errors-&gt;add( 'user_login', __( 'Username is a required field.' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $user_login !== $trimmed_user_login ) {&nbsp;</div></li><li><div>              $create_user_errors-&gt;add( 'user_login', sprintf( __( '%s is an invalid username. How\'s this one?' ), esc_html( $_POST['user_login'] ) ) );&nbsp;</div></li><li><div>              $user_login = $trimmed_user_login;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check email</span>&nbsp;</div></li><li><div>      if ( isset( $user_email ) && empty( $user_email ) )&nbsp;</div></li><li><div>          $create_user_errors-&gt;add( 'user_email', __( 'Email address is a required field.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Password Sanity Check</span>&nbsp;</div></li><li><div>      if ( ( !empty( $user_pass1 ) || !empty( $user_pass2 ) ) && $user_pass1 !== $user_pass2 )&nbsp;</div></li><li><div>          $create_user_errors-&gt;add( 'pass', __( 'You must enter the same password twice.' ) );&nbsp;</div></li><li><div>      elseif ( !isset( $_GET['action'] ) && ( empty( $user_pass1 ) && empty( $user_pass2 ) ) )&nbsp;</div></li><li><div>          $create_user_errors-&gt;add( 'pass', __( 'You must enter a password.' ) );&nbsp;</div></li><li><div>      elseif ( isset( $_GET['action'] ) && ( empty( $user_pass1 ) && empty( $user_pass2 ) ) )&nbsp;</div></li><li><div>          $user_pass = '';&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $user_pass = $user_pass1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No errors</span>&nbsp;</div></li><li><div>      if ( !$create_user_errors-&gt;get_error_messages() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Create or udpate</span>&nbsp;</div></li><li><div>          switch ( $_POST['action'] ) {&nbsp;</div></li><li><div>              case 'create' :&nbsp;</div></li><li><div>                  $goback = bb_get_uri( 'bb-admin/users.php', array( 'created' =&gt; 'true' ), BB_URI_CONTEXT_FORM_ACTION + BB_URI_CONTEXT_BB_ADMIN );&nbsp;</div></li><li><div>                  $user = $wp_users_object-&gt;new_user( compact( 'user_login', 'user_email', 'user_url', 'user_nicename', 'user_status', 'user_pass' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Error handler</span></span></span>&nbsp;</div></li><li><div>                  if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>                      bb_admin_notice( $user );&nbsp;</div></li><li><div>                      unset( $goback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Update additional user data</span></span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Update caps</span></span>&nbsp;</div></li><li><div>                      bb_update_usermeta( $user['ID'], $bbdb-&gt;prefix . 'capabilities', array( $user_role =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Update all user meta</span></span>&nbsp;</div></li><li><div>                      foreach ( $user_meta as $key =&gt; $value )&nbsp;</div></li><li><div>                          bb_update_usermeta( $user['ID'], $key, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Don't send email if empty</span></span>&nbsp;</div></li><li><div>                      if ( !empty( $user_pass ) )&nbsp;</div></li><li><div>                          bb_send_pass( $user['ID'], $user_pass );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      do_action( 'bb_new_user', $user['ID'], $user_pass );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'update' :&nbsp;</div></li><li><div>                  $goback = bb_get_uri( 'bb-admin/users.php', array( 'updated' =&gt; 'true' ), BB_URI_CONTEXT_FORM_ACTION + BB_URI_CONTEXT_BB_ADMIN );&nbsp;</div></li><li><div>                  $user = $wp_users_object-&gt;get_user( $_GET['user_id'], array( 'output' =&gt; ARRAY_A ) );&nbsp;</div></li><li><div>                  bb_update_user( $user['ID'], $user_email, $user_url, $user_display_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Don't change PW if empty</span>&nbsp;</div></li><li><div>                  if ( !empty( $user_pass ) )&nbsp;</div></li><li><div>                      bb_update_user_password( $user['ID'], $user_pass );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Error handler</span></span></span>&nbsp;</div></li><li><div>                  if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>                      bb_admin_notice( $user );&nbsp;</div></li><li><div>                      unset( $goback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Update additional user data</span></span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Update caps</span></span>&nbsp;</div></li><li><div>                      bb_update_usermeta( $user['ID'], $bbdb-&gt;prefix . 'capabilities', array( $user_role =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Update all user meta</span></span>&nbsp;</div></li><li><div>                      foreach ( $user_meta as $key =&gt; $value )&nbsp;</div></li><li><div>                          bb_update_usermeta( $user['ID'], $key, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Don't send email if empty</span></span>&nbsp;</div></li><li><div>                      if ( !empty( $user_pass ) )&nbsp;</div></li><li><div>                          bb_send_pass( $user['ID'], $user_pass );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      do_action( 'bb_update_user', $user['ID'], $user_pass );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Redirect</span>&nbsp;</div></li><li><div>          if ( isset( $goback ) && !empty( $goback ) )&nbsp;</div></li><li><div>              bb_safe_redirect( $goback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Error handler</span></span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          bb_admin_notice( $create_user_errors );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( isset( $_GET['action'] ) && $_GET['action'] == 'edit' ) {&nbsp;</div></li><li><div>      if ( isset( $_GET['user_id'] ) && is_numeric( $_GET['user_id'] ) ) {&nbsp;</div></li><li><div>          $disabled = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the user</span>&nbsp;</div></li><li><div>          if ( empty( $edit_user ) )&nbsp;</div></li><li><div>              $edit_user = bb_get_user( bb_get_user_id( $_GET['user_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Instantiate required vars</span></span>&nbsp;</div></li><li><div>          $user_login = $edit_user-&gt;user_login;&nbsp;</div></li><li><div>          $user_meta['first_name'] = $edit_user-&gt;first_name;&nbsp;</div></li><li><div>          $user_meta['last_name'] = $edit_user-&gt;last_name;&nbsp;</div></li><li><div>          $user_display_name = $edit_user-&gt;display_name;&nbsp;</div></li><li><div>          $user_email = $edit_user-&gt;user_email;&nbsp;</div></li><li><div>          $user_url = $edit_user-&gt;user_url;&nbsp;</div></li><li><div>          $user_meta['from'] = $edit_user-&gt;from;&nbsp;</div></li><li><div>          $user_meta['occ'] = $edit_user-&gt;occ;&nbsp;</div></li><li><div>          $user_meta['interest'] = $edit_user-&gt;interest;&nbsp;</div></li><li><div>          $user_role = array_search( 'true', $edit_user-&gt;capabilities );&nbsp;</div></li><li><div>          $user_meta['throttle'] = $edit_user-&gt;throttle;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Keymasters can't demote themselves</span>&nbsp;</div></li><li><div>          if ( ( $edit_user-&gt;ID == bb_get_current_user_info( 'id' ) && $can_keep_gate ) || ( isset( $edit_user-&gt;capabilities ) && is_array( $edit_user-&gt;capabilities ) && array_key_exists( 'keymaster', $edit_user-&gt;capabilities ) && !$can_keep_gate ) )&nbsp;</div></li><li><div>              $user_roles = array( 'keymaster' =&gt; $user_roles['keymaster'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// only keymasters can promote others to keymaster status</span>&nbsp;</div></li><li><div>          elseif ( !$can_keep_gate )&nbsp;</div></li><li><div>              unset( $user_roles['keymaster'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load password strength checker</span>&nbsp;</div></li><li><div>  wp_enqueue_script( 'password-strength-meter' );&nbsp;</div></li><li><div>  wp_enqueue_script( 'profile-edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Generate a few PW hints</span>&nbsp;</div></li><li><div>  $some_pass_hints = '';&nbsp;</div></li><li><div>  for ( $l = 3; $l != 0; $l-- )&nbsp;</div></li><li><div>      $some_pass_hints .= '&lt;p&gt;' . bb_generate_password() . '&lt;/p&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create  the user fields</span>&nbsp;</div></li><li><div>  $user_fields = array(&nbsp;</div></li><li><div>      'user_login' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Username' ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'Required! Unique identifier for new user.' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_login, &nbsp;</div></li><li><div>          'disabled' =&gt; $disabled&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'first_name' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'First Name' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_meta['first_name']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'last_name' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Last Name' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_meta['last_name']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'display_name' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Display Name' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_display_name&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'user_email' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Email' ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'Required! Will be used for notifications and profile settings changes.' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_email&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'user_url' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Website' ), &nbsp;</div></li><li><div>          'class' =&gt; array( 'long', 'code' ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'The full URL of user\'s homepage or blog.' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_url&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'from' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Location' ), &nbsp;</div></li><li><div>          'class' =&gt; array( 'long' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_meta['from']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'occ' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Occupation' ), &nbsp;</div></li><li><div>          'class' =&gt; array( 'long' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_meta['occ']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'interest' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Interests' ), &nbsp;</div></li><li><div>          'class' =&gt; array( 'long' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_meta['interest']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'userrole' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'User Role' ), &nbsp;</div></li><li><div>          'type' =&gt; 'select', &nbsp;</div></li><li><div>          'options' =&gt; $user_roles, &nbsp;</div></li><li><div>          'note' =&gt; __( 'Allow user the above privileges.' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_role, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'pass1' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'New Password' ), &nbsp;</div></li><li><div>          'type' =&gt; 'password', &nbsp;</div></li><li><div>          'class' =&gt; array( 'short', 'text', 'code' ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'Hints: ' ) . $some_pass_hints, &nbsp;</div></li><li><div>          'value' =&gt; $user_pass1, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'pass2' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Repeat New Password' ), &nbsp;</div></li><li><div>          'type' =&gt; 'password', &nbsp;</div></li><li><div>          'class' =&gt; array( 'short', 'text', 'code' ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'If you ignore hints, remember: the password should be at least seven characters long. To make it stronger, use upper and lower case letters, numbers and symbols like ! &quot; ? $ % ^ &amp; ).' ), &nbsp;</div></li><li><div>          'value' =&gt; $user_pass2, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'email_pass' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; '', &nbsp;</div></li><li><div>          'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>          'options' =&gt; array(&nbsp;</div></li><li><div>              '1' =&gt; array(&nbsp;</div></li><li><div>                  'label' =&gt; __( 'Email the new password.' ), &nbsp;</div></li><li><div>                  'attributes' =&gt; array( 'checked' =&gt; true )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'pass-strength-fake-input' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Password Strength' ), &nbsp;</div></li><li><div>          'type' =&gt; 'hidden', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bb_manage_user_fields', $user_fields );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Not bbdb::prepared</span>&nbsp;</div></li><li><div>function bb_get_ids_by_role( $role = 'moderator', $sort = 0, $page = 1, $limit = 50 ) {&nbsp;</div></li><li><div>  global $bbdb, $bb_last_countable_query;&nbsp;</div></li><li><div>  $sort = $sort ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>  $key = $bbdb-&gt;escape( $bbdb-&gt;prefix . 'capabilities' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$page = abs( (int) $page ) )&nbsp;</div></li><li><div>      $page = 1;&nbsp;</div></li><li><div>  $limit = abs( (int) $limit );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $limit = ($limit * ($page - 1)) . &quot;, $limit&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $role = $bbdb-&gt;escape_deep($role);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array($role) )&nbsp;</div></li><li><div>      $and_where = &quot;( meta_value LIKE '%&quot; . join(&quot;%' OR meta_value LIKE '%&quot;, $role) . &quot;%' )&quot;;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $and_where = &quot;meta_value LIKE '%$role%'&quot;;&nbsp;</div></li><li><div>  $bb_last_countable_query = &quot;SELECT user_id FROM $bbdb-&gt;usermeta WHERE meta_key = '$key' AND $and_where ORDER BY user_id $sort LIMIT $limit&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ids = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $_tuple = compact( 'ids', 'role', 'sort', 'page', 'key', 'limit', 'bb_last_countable_query' );&nbsp;</div></li><li><div>  $_tuple = apply_filters( 'bb_get_ids_by_role', $_tuple );&nbsp;</div></li><li><div>  extract( $_tuple, EXTR_OVERWRITE );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$ids ) {&nbsp;</div></li><li><div>      $ids = (array) $bbdb-&gt;get_col( $bb_last_countable_query );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $ids ) {&nbsp;</div></li><li><div>      bb_cache_users( $ids );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $ids;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_user_row( $user, $role = '', $email = false ) {&nbsp;</div></li><li><div>  $actions = &quot;&lt;a href='&quot; . esc_attr( get_user_profile_link( $user-&gt;ID ) ) . &quot;'&gt;&quot; . __('View') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>  $title = '';&nbsp;</div></li><li><div>  if ( bb_current_user_can( 'edit_user', $user_id ) ) {&nbsp;</div></li><li><div>      $actions .= &quot; | &lt;a href='&quot; . esc_attr( bb_get_user_admin_link( $user-&gt;ID ) ) . &quot;'&gt;&quot; . __('Edit') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      $title = &quot; title='&quot; . esc_attr( sprintf( __( 'User ID: %d' ), $user-&gt;ID ) ) . &quot;'&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $r = &quot;\t&lt;tr id='user-$user-&gt;ID'&quot; . get_alt_class(&quot;user-$role&quot;) . &quot;&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;td class=\&quot;user\&quot;&gt;&quot; . bb_get_avatar( $user-&gt;ID, 32 ) . &quot;&lt;span class=\&quot;row-title\&quot;&gt;&lt;a href='&quot; . get_user_profile_link( $user-&gt;ID ) . &quot;'&quot; . $title . &quot;&gt;&quot; . get_user_name( $user-&gt;ID ) . &quot;&lt;/a&gt;&lt;/span&gt;&lt;div&gt;&lt;span class=\&quot;row-actions\&quot;&gt;$actions&lt;/span&gt;&nbsp;&lt;/div&gt;&lt;/td&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;td&gt;&lt;a href='&quot; . get_user_profile_link( $user-&gt;ID ) . &quot;'&gt;&quot; . get_user_display_name( $user-&gt;ID ) . &quot;&lt;/a&gt;&lt;/td&gt;\n&quot;;&nbsp;</div></li><li><div>  if ( $email ) {&nbsp;</div></li><li><div>      $email = bb_get_user_email( $user-&gt;ID );&nbsp;</div></li><li><div>      $r .= &quot;\t\t&lt;td&gt;&lt;a href='mailto:$email'&gt;$email&lt;/a&gt;&lt;/td&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $registered_time = bb_gmtstrtotime( $user-&gt;user_registered );&nbsp;</div></li><li><div>  if ( $registered_time &lt; ( time() - 86400 ) ) {&nbsp;</div></li><li><div>      $time = date( 'Y/m/d\&lt;\b\r \/\&gt;H:i:s', bb_offset_time( $registered_time ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $time = sprintf( __( '%s ago' ), bb_since( $registered_time ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;td&gt;&quot; . $time . &quot;&lt;/td&gt;\n&quot;;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (&nbsp;</div></li><li><div>      !isset($user-&gt;capabilities) ||&nbsp;</div></li><li><div>      !is_array($user-&gt;capabilities) ||&nbsp;</div></li><li><div>      empty($user-&gt;capabilities)&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>      $role = array( __('Inactive (no role)') );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      global $wp_roles;&nbsp;</div></li><li><div>      $_roles = $wp_roles-&gt;get_names();&nbsp;</div></li><li><div>      $role = array();&nbsp;</div></li><li><div>      foreach ( $user-&gt;capabilities as $cap =&gt; $cap_set ) {&nbsp;</div></li><li><div>          if (!$cap_set) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $role[] = $_roles[$cap];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !count( $role ) ) {&nbsp;</div></li><li><div>          $role[] = __('None');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;td&gt;&quot; . join(', ', $role) . &quot;&lt;/td&gt;\n\t&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// BB_User_Search class</span>&nbsp;</div></li><li><div><span class="comment">// by Mark Jaquith</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class BB_User_Search {&nbsp;</div></li><li><div>  var $results;&nbsp;</div></li><li><div>  var $search_term;&nbsp;</div></li><li><div>  var $page;&nbsp;</div></li><li><div>  var $raw_page;&nbsp;</div></li><li><div>  var $users_per_page = 50;&nbsp;</div></li><li><div>  var $first_user;&nbsp;</div></li><li><div>  var $last_user;&nbsp;</div></li><li><div>  var $query_limit;&nbsp;</div></li><li><div>  var $total_users_for_query = 0;&nbsp;</div></li><li><div>  var $search_errors;&nbsp;</div></li><li><div>  var $paging_text;&nbsp;</div></li><li><div>  var $paging_text_bottom;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct($search_term = false, $page = 1, $roles = false ) { <span class="comment"><span class="comment">// constructor</span></span>&nbsp;</div></li><li><div>      $this-&gt;search_term = $search_term ? stripslashes($search_term) : false;&nbsp;</div></li><li><div>      $this-&gt;raw_page = ( '' == $page ) ? false : (int) $page;&nbsp;</div></li><li><div>      $page = (int) $page;&nbsp;</div></li><li><div>      $this-&gt;page = $page &lt; 2 ? 1 : $page;&nbsp;</div></li><li><div>      $roles = (array) $roles;&nbsp;</div></li><li><div>      $_roles = array();&nbsp;</div></li><li><div>      foreach ( $roles as $role ) {&nbsp;</div></li><li><div>          if ( false !== $role ) {&nbsp;</div></li><li><div>              $_roles[] = stripslashes( $role );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;roles = empty( $_roles ) ? false : $_roles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;prepare_query();&nbsp;</div></li><li><div>      $this-&gt;query();&nbsp;</div></li><li><div>      $this-&gt;prepare_vars_for_template_usage();&nbsp;</div></li><li><div>      $this-&gt;do_paging();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function BB_User_Search( $search_term = false, $page = 1, $roles = false ) {&nbsp;</div></li><li><div>      $this-&gt;__construct( $search_term, $page, $roles );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function prepare_query() {&nbsp;</div></li><li><div>      $this-&gt;first_user = ($this-&gt;page - 1) * $this-&gt;users_per_page;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function query() {&nbsp;</div></li><li><div>      $users = bb_user_search( array(&nbsp;</div></li><li><div>              'query' =&gt; $this-&gt;search_term, &nbsp;</div></li><li><div>              'user_email' =&gt; true, &nbsp;</div></li><li><div>              'users_per_page' =&gt; $this-&gt;users_per_page, &nbsp;</div></li><li><div>              'page' =&gt; $this-&gt;page, &nbsp;</div></li><li><div>              'roles' =&gt; $this-&gt;roles&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error($users) )&nbsp;</div></li><li><div>          $this-&gt;search_errors = $users;&nbsp;</div></li><li><div>      else if ( $users )&nbsp;</div></li><li><div>          $this-&gt;results = $users;&nbsp;</div></li><li><div>      <span class="comment">//    foreach ( (array) $users as $user )</span>&nbsp;</div></li><li><div>      <span class="comment">//        $this-&gt;results[] = $user-&gt;ID;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;results )&nbsp;</div></li><li><div>          $this-&gt;total_users_for_query = bb_count_last_query();&nbsp;</div></li><li><div>      elseif ( !is_wp_error($this-&gt;search_errors) )&nbsp;</div></li><li><div>          $this-&gt;search_errors = new WP_Error( 'no_matching_users_found', __( '&lt;strong&gt;No matching users were found!&lt;/strong&gt;' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $this-&gt;search_errors ) )&nbsp;</div></li><li><div>          bb_admin_notice( $this-&gt;search_errors );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function prepare_vars_for_template_usage() {&nbsp;</div></li><li><div>      $this-&gt;search_term = stripslashes($this-&gt;search_term); <span class="comment">// done with DB, from now on we want slashes gone</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function do_paging() {&nbsp;</div></li><li><div>      global $bb_current_submenu;&nbsp;</div></li><li><div>      $displaying_num = sprintf(&nbsp;</div></li><li><div>          __( '%1$s to %2$s of %3$s' ), &nbsp;</div></li><li><div>          bb_number_format_i18n( ( $this-&gt;page - 1 ) * $this-&gt;users_per_page + 1 ), &nbsp;</div></li><li><div>          $this-&gt;page * $this-&gt;users_per_page &lt; $this-&gt;total_users_for_query ? bb_number_format_i18n( $this-&gt;page * $this-&gt;users_per_page ) : '&lt;span class=&quot;total-type-count&quot;&gt;' . bb_number_format_i18n( $this-&gt;total_users_for_query ) . '&lt;/span&gt;', &nbsp;</div></li><li><div>          '&lt;span class=&quot;total-type-count&quot;&gt;' . bb_number_format_i18n( $this-&gt;total_users_for_query ) . '&lt;/span&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $page_number_links = $this-&gt;total_users_for_query &gt; $this-&gt;users_per_page ? get_page_number_links( $this-&gt;page, $this-&gt;total_users_for_query, $this-&gt;users_per_page, false ) : '';&nbsp;</div></li><li><div>      $this-&gt;paging_text = &quot;&lt;div class='tablenav-pages'&gt;&lt;span class='displaying-num'&gt;$displaying_num&lt;/span&gt;&lt;span class=\&quot;displaying-pages\&quot;&gt;$page_number_links&lt;/span&gt;&lt;div class=\&quot;clear\&quot;&gt;&lt;/div&gt;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>      $this-&gt;paging_text_bottom = &quot;&lt;div class='tablenav-pages'&gt;&lt;span class=\&quot;displaying-pages\&quot;&gt;$page_number_links&lt;/span&gt;&lt;div class=\&quot;clear\&quot;&gt;&lt;/div&gt;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_results() {&nbsp;</div></li><li><div>      return (array) $this-&gt;results;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function page_links() {&nbsp;</div></li><li><div>      echo $this-&gt;paging_text;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function results_are_paged() {&nbsp;</div></li><li><div>      if ( isset($this-&gt;paging_text) && $this-&gt;paging_text )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_search() {&nbsp;</div></li><li><div>      if ( $this-&gt;search_term )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function display( $show_search = true, $show_email = false ) {&nbsp;</div></li><li><div>      global $wp_roles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($this-&gt;title) )&nbsp;</div></li><li><div>          $title = $this-&gt;title;&nbsp;</div></li><li><div>      elseif ( $this-&gt;is_search() )&nbsp;</div></li><li><div>          $title = sprintf(__('Users Matching &quot;%s&quot; by Role'), esc_html( $this-&gt;search_term ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $h2_search = $this-&gt;search_term;&nbsp;</div></li><li><div>      $h2_role = $this-&gt;roles[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $roles = $wp_roles-&gt;get_names();&nbsp;</div></li><li><div>      if ( in_array( $h2_role, array_keys( $roles ) ) ) {&nbsp;</div></li><li><div>          $h2_role = $roles[$h2_role];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $h2_search = $h2_search ? ' ' . sprintf( __('containing &#8220;%s&#8221;'), esc_html( $h2_search ) ) : '';&nbsp;</div></li><li><div>      $h2_role = $h2_role  ? ' ' . sprintf( __('with role &#8220;%s&#8221;'), esc_html( $h2_role ) ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $h2_span = '&lt;span class=&quot;subtitle&quot;&gt;';&nbsp;</div></li><li><div>      $h2_span .= apply_filters( 'bb_user_search_description', sprintf( __( '%1$s%2$s' ), $h2_search, $h2_role ), $h2_search, $h2_role, $this );&nbsp;</div></li><li><div>      $h2_span .= '&lt;/span&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;&lt;h2 class=\&quot;first\&quot;&gt;&quot; . apply_filters( 'bb_user_search_title', __('Users') ) . $h2_span . &quot;&lt;/h2&gt;\n&quot;;&nbsp;</div></li><li><div>      do_action( 'bb_admin_notices' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $show_search ) {&nbsp;</div></li><li><div>          $roles = apply_filters( 'bb_user_search_form_roles', $wp_roles-&gt;get_names() );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $r .= &quot;&lt;form action='' method='get' id='search' class='search-form'&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;fieldset&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;label for='usersearch'&gt;&quot; . __('Search term') . &quot;&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;div&gt;&lt;input type='text' name='usersearch' id='usersearch' class='text-input' value='&quot; . esc_html( $this-&gt;search_term, 1) . &quot;' /&gt;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;label for='userrole'&gt;&quot; . __('Role') . &quot;&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;div&gt;&lt;select name='userrole[]' id='userrole'&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t\t&lt;option value=''&gt;&quot; . _x( 'All', 'user roles' ) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          foreach ( $roles as $role =&gt; $display ) {&nbsp;</div></li><li><div>              $selected = '';&nbsp;</div></li><li><div>              if ( is_array( $this-&gt;roles ) && in_array( $role, $this-&gt;roles ) ) {&nbsp;</div></li><li><div>                  $selected = ' selected=&quot;selected&quot;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $value = esc_attr($role);&nbsp;</div></li><li><div>              $display = esc_html(translate($display));&nbsp;</div></li><li><div>              $r .= &quot;\t\t\t&lt;option value='$value'$selected&gt;$display&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;/select&gt;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $r = apply_filters( 'bb_user_search_form_inputs', $r, $this );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $r .= &quot;&lt;div class=\&quot;submit\&quot;&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;label class='hidden' for='submit'&gt;&quot; . __('Search') . &quot;&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>          $r .= &quot;\t\t&lt;div&gt;&lt;input type='submit' id='submit' class='button submit-input' value='&quot; . __('Filter') . &quot;' /&gt;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;/fieldset&gt;\n&quot;;&nbsp;</div></li><li><div>          $r .= &quot;&lt;/form&gt;\n\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;get_results() ) {&nbsp;</div></li><li><div>          if ( $this-&gt;results_are_paged() )&nbsp;</div></li><li><div>              $r .= &quot;&lt;div class='tablenav'&gt;\n&quot; . $this-&gt;paging_text . &quot;&lt;/div&gt;&lt;div class=\&quot;clear\&quot;&gt;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//foreach($roleclasses as $role =&gt; $roleclass) {</span>&nbsp;</div></li><li><div>              <span class="comment">//ksort($roleclass);</span>&nbsp;</div></li><li><div>              <span class="comment">//if ( !empty($role) )</span>&nbsp;</div></li><li><div>              <span class="comment">//    $r .= &quot;\t\t&lt;h3&gt;{$wp_roles-&gt;role_names[$role]}&lt;/h3&gt;\n&quot;;</span>&nbsp;</div></li><li><div>              <span class="comment">//else</span>&nbsp;</div></li><li><div>              <span class="comment">//    $r .= &quot;\t\t&lt;h3&gt;&lt;em&gt;&quot; . __('Users with no role in these forums') . &quot;&lt;/h3&gt;\n&quot;;</span>&nbsp;</div></li><li><div>              $r .= &quot;&lt;table class='widefat'&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;&lt;thead&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t&lt;tr&gt;\n&quot;;&nbsp;</div></li><li><div>              if ( $show_email ) {&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:30%;'&gt;&quot; . __('Username') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:20%;'&gt;&quot; . __('Name') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:20%;'&gt;&quot; . __('E-mail') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:40%;'&gt;&quot; . __('Username') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:30%;'&gt;&quot; . __('Name') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $r .= &quot;\t\t&lt;th style='width:15%;'&gt;&quot; . __('Registered') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t\t&lt;th style='width:15%;'&gt;&quot; . __('Role') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;&lt;/thead&gt;\n\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;&lt;tfoot&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t&lt;tr&gt;\n&quot;;&nbsp;</div></li><li><div>              if ( $show_email ) {&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:30%;'&gt;&quot; . __('Username') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:20%;'&gt;&quot; . __('Name') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:20%;'&gt;&quot; . __('E-mail') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:40%;'&gt;&quot; . __('Username') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>                  $r .= &quot;\t\t&lt;th style='width:30%;'&gt;&quot; . __('Name') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $r .= &quot;\t\t&lt;th style='width:15%;'&gt;&quot; . __('Registered') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t\t&lt;th style='width:15%;'&gt;&quot; . __('Role') . &quot;&lt;/th&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;\t&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;&lt;/tfoot&gt;\n\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $r .= &quot;&lt;tbody id='role-$role'&gt;\n&quot;;&nbsp;</div></li><li><div>              foreach ( (array) $this-&gt;get_results() as $user_object )&nbsp;</div></li><li><div>                  $r .= bb_user_row($user_object, $role, $show_email);&nbsp;</div></li><li><div>              $r .= &quot;&lt;/tbody&gt;\n&quot;;&nbsp;</div></li><li><div>              $r .= &quot;&lt;/table&gt;\n\n&quot;;&nbsp;</div></li><li><div>          <span class="comment">//}</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;results_are_paged() )&nbsp;</div></li><li><div>              $r .= &quot;&lt;div class='tablenav bottom'&gt;\n&quot; . $this-&gt;paging_text_bottom . &quot;&lt;/div&gt;&lt;div class=\&quot;clear\&quot;&gt;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class BB_Users_By_Role extends BB_User_Search {&nbsp;</div></li><li><div>  var $role = '';&nbsp;</div></li><li><div>  var $title = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct($role = '', $page = '') { <span class="comment"><span class="comment">// constructor</span></span>&nbsp;</div></li><li><div>      $this-&gt;role = $role ? $role : 'member';&nbsp;</div></li><li><div>      $this-&gt;raw_page = ( '' == $page ) ? false : (int) $page;&nbsp;</div></li><li><div>      $this-&gt;page = (int) ( '' == $page ) ? 1 : $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;prepare_query();&nbsp;</div></li><li><div>      $this-&gt;query();&nbsp;</div></li><li><div>      $this-&gt;do_paging();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function BB_Users_By_Role($role = '', $page = '') {&nbsp;</div></li><li><div>      $this-&gt;__construct($role, $page);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function query() {&nbsp;</div></li><li><div>      if ( $_results = bb_get_ids_by_role( $this-&gt;role, 0, $this-&gt;page, $this-&gt;users_per_page ) ) {&nbsp;</div></li><li><div>          $this-&gt;results = bb_get_user($_results);&nbsp;</div></li><li><div>          $this-&gt;total_users_for_query = bb_count_last_query();&nbsp;</div></li><li><div>      } else&nbsp;</div></li><li><div>          $this-&gt;search_errors = new WP_Error( 'no_matching_users_found', __( '&lt;strong&gt;No matching users were found!&lt;/strong&gt;' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $this-&gt;search_errors ) )&nbsp;</div></li><li><div>          bb_admin_notice( $this-&gt;search_errors );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Forums */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">// Expects forum_name, forum_desc to be pre-escaped</span></span>&nbsp;</div></li><li><div>function bb_new_forum( $args ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  if ( !bb_current_user_can( 'manage_forums' ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $func_args = func_get_args();&nbsp;</div></li><li><div>  $defaults = array( 'forum_name' =&gt; '', 'forum_desc' =&gt; '', 'forum_parent' =&gt; 0, 'forum_order' =&gt; false, 'forum_is_category' =&gt; 0 );&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  if ( 1 &lt; func_num_args() ) : <span class="comment"><span class="comment">// For back compat</span></span>&nbsp;</div></li><li><div>      $args['forum_name'] = $func_args[0];&nbsp;</div></li><li><div>      $args['forum_desc'] = $func_args[1];&nbsp;</div></li><li><div>      $args['forum_order'] = 2 &lt; func_num_args() ? $func_args[2] : 0;&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  extract($args, EXTR_SKIP);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_numeric($forum_order) )&nbsp;</div></li><li><div>      $forum_order = (int) $bbdb-&gt;get_var(&quot;SELECT MAX(forum_order) FROM $bbdb-&gt;forums&quot;) + 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_order = (int) $forum_order;&nbsp;</div></li><li><div>  $forum_parent = (int) $forum_parent;&nbsp;</div></li><li><div>  $forum_is_category = (int) $forum_is_category;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_name = apply_filters( 'bb_pre_forum_name', stripslashes( wp_specialchars_decode( $forum_name, ENT_QUOTES ) ) );&nbsp;</div></li><li><div>  $forum_desc = apply_filters( 'bb_pre_forum_desc', stripslashes($forum_desc) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen($forum_name) &lt; 1 )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_sql = &quot;SELECT forum_slug FROM $bbdb-&gt;forums WHERE forum_slug = %s&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_slug = $_forum_slug = bb_slug_sanitize($forum_name);&nbsp;</div></li><li><div>  if ( strlen($_forum_slug) &lt; 1 )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  while ( is_numeric($forum_slug) || $existing_slug = $bbdb-&gt;get_var( $bbdb-&gt;prepare( $forum_sql, $forum_slug ) ) )&nbsp;</div></li><li><div>      $forum_slug = bb_slug_increment($_forum_slug, $existing_slug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bbdb-&gt;insert( $bbdb-&gt;forums, compact( 'forum_name', 'forum_slug', 'forum_desc', 'forum_parent', 'forum_order' ) );&nbsp;</div></li><li><div>  $forum_id = $bbdb-&gt;insert_id;&nbsp;</div></li><li><div>  if ($forum_id && $forum_is_category)&nbsp;</div></li><li><div>      bb_update_forummeta($forum_id, 'forum_is_category', $forum_is_category);&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_forums' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $forum_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">// Expects forum_name, forum_desc to be pre-escaped</span></span>&nbsp;</div></li><li><div>function bb_update_forum( $args ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  if ( !bb_current_user_can( 'manage_forums' ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $func_args = func_get_args();&nbsp;</div></li><li><div>  $defaults = array( 'forum_id' =&gt; 0, 'forum_name' =&gt; '', 'forum_slug' =&gt; '', 'forum_desc' =&gt; '', 'forum_parent' =&gt; 0, 'forum_order' =&gt; 0, 'forum_is_category' =&gt; 0 );&nbsp;</div></li><li><div>  $fields = array( 'forum_name', 'forum_desc', 'forum_parent', 'forum_order' );&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  if ( 1 &lt; func_num_args() ) : <span class="comment"><span class="comment">// For back compat</span></span>&nbsp;</div></li><li><div>      $args['forum_id'] = $func_args[0];&nbsp;</div></li><li><div>      $args['forum_name'] = $func_args[1];&nbsp;</div></li><li><div>      $args['forum_desc'] = 2 &lt; func_num_args() ? $func_args[2] : '';&nbsp;</div></li><li><div>      $args['forum_order'] = 3 &lt; func_num_args() && is_numeric($func_args[3]) ? $func_args[3] : 0;&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  extract($args, EXTR_SKIP);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$forum_id = (int) $forum_id )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  if ( !$forum = bb_get_forum( $forum_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  $forum_order = (int) $forum_order;&nbsp;</div></li><li><div>  $forum_parent = (int) $forum_parent;&nbsp;</div></li><li><div>  $forum_is_category = (int) $forum_is_category;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_name = apply_filters( 'bb_pre_forum_name', stripslashes( wp_specialchars_decode( $forum_name, ENT_QUOTES ) ), $forum_id );&nbsp;</div></li><li><div>  $forum_desc = apply_filters( 'bb_pre_forum_desc', stripslashes($forum_desc), $forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen($forum_name) &lt; 1 )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Slug is not changing, don't update it</span>&nbsp;</div></li><li><div>  if ( !$forum_slug || $forum_slug == $forum-&gt;forum_slug ) {&nbsp;</div></li><li><div>      <span class="comment">// [sic]</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $forum_slug = $_forum_slug = bb_slug_sanitize($forum_slug);&nbsp;</div></li><li><div>      if ( strlen($_forum_slug) &lt; 1 )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $forum_sql = &quot;SELECT forum_slug FROM $bbdb-&gt;forums WHERE forum_slug = %s&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ( is_numeric($forum_slug) || $existing_slug = $bbdb-&gt;get_var( $bbdb-&gt;prepare( $forum_sql, $forum_slug ) ) )&nbsp;</div></li><li><div>          $forum_slug = bb_slug_increment($_forum_slug, $existing_slug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $fields[] = 'forum_slug';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $forum_id, 'bb_forum' );&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_forums' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $update_result = $bbdb-&gt;update( $bbdb-&gt;forums, compact( $fields ), compact( 'forum_id' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($forum_is_category)&nbsp;</div></li><li><div>      bb_update_forummeta($forum_id, 'forum_is_category', $forum_is_category);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      bb_delete_forummeta($forum_id, 'forum_is_category');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $update_result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// When you delete a forum, you delete *everything*</span>&nbsp;</div></li><li><div><span class="comment">// NOT bbdb::prepared</span>&nbsp;</div></li><li><div>function bb_delete_forum( $forum_id ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  if ( !bb_current_user_can( 'delete_forum', $forum_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  if ( !$forum_id = (int) $forum_id )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$forum = bb_get_forum( $forum_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $topic_ids = $bbdb-&gt;get_col( $bbdb-&gt;prepare( &quot;SELECT topic_id FROM $bbdb-&gt;topics WHERE forum_id = %d&quot;, $forum_id ) ) ) {&nbsp;</div></li><li><div>      foreach ($topic_ids as $topic_id) {&nbsp;</div></li><li><div>          bb_remove_topic_tags( $topic_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $_topic_ids = join(', ', array_map('intval', $topic_ids));&nbsp;</div></li><li><div>      $bbdb-&gt;query(&quot;DELETE FROM $bbdb-&gt;posts WHERE topic_id IN ($_topic_ids) AND topic_id != 0&quot;);&nbsp;</div></li><li><div>      $bbdb-&gt;query(&quot;DELETE FROM $bbdb-&gt;meta WHERE object_type = 'bb_topic' AND object_id IN ($_topic_ids)&quot;);&nbsp;</div></li><li><div>      $bbdb-&gt;query( $bbdb-&gt;prepare( &quot;DELETE FROM $bbdb-&gt;topics WHERE forum_id = %d&quot;, $forum_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $bbdb-&gt;update( $bbdb-&gt;forums, array( 'forum_parent' =&gt; $forum-&gt;forum_parent ), array( 'forum_parent' =&gt; $forum_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = $bbdb-&gt;query( $bbdb-&gt;prepare( &quot;DELETE FROM $bbdb-&gt;forums WHERE forum_id = %d&quot;, $forum_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $topic_ids )&nbsp;</div></li><li><div>      foreach ( $topic_ids as $topic_id ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// should maybe just flush these groups</span> instead</span>&nbsp;</div></li><li><div>          wp_cache_delete( $topic_id, 'bb_topic' );&nbsp;</div></li><li><div>          wp_cache_delete( $topic_id, 'bb_thread' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $forum_id, 'bb_forum' );&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_forums' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_forum_row( $forum_id = 0, $echo = true, $close = false ) {&nbsp;</div></li><li><div>  global $forum, $forums_count;&nbsp;</div></li><li><div>  if ( $forum_id )&nbsp;</div></li><li><div>      $_forum = bb_get_forum( $forum_id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $_forum =& $forum;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$_forum )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $description = get_forum_description( $_forum-&gt;forum_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = '';&nbsp;</div></li><li><div>  if ( $close )&nbsp;</div></li><li><div>      $r .= &quot;\t&lt;li id='forum-$_forum-&gt;forum_id'&quot; . get_alt_class( 'forum', 'forum clear list-block' ) . &quot;&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;div class='list-block posrel'&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t\t&lt;div class=\&quot;row-title\&quot;&gt;&quot; . get_forum_name( $_forum-&gt;forum_id ) . &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  if ( $description )&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t&lt;p class=\&quot;row-description\&quot;&gt;&quot; . get_forum_description( $_forum-&gt;forum_id ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t\t&lt;div class=\&quot;row-actions\&quot;&gt;&lt;span&gt;\n&quot;;&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t\t&lt;a class='edit' href='&quot; . get_forum_link() . &quot;'&gt;&quot; . __('View') . &quot;&lt;/a&gt;\n&quot;;&nbsp;</div></li><li><div>  if ( bb_current_user_can( 'manage_forums' ) )&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t\t| &lt;a class='edit' href='&quot; . esc_attr( bb_get_uri('bb-admin/forums.php', array('action' =&gt; 'edit', 'id' =&gt; $_forum-&gt;forum_id), BB_URI_CONTEXT_A_HREF + BB_URI_CONTEXT_BB_ADMIN) ) . &quot;'&gt;&quot; . __('Edit') . &quot;&lt;/a&gt;\n&quot;;&nbsp;</div></li><li><div>  if ( bb_current_user_can( 'delete_forum', $_forum-&gt;forum_id ) && 1 &lt; $forums_count )&nbsp;</div></li><li><div>      $r .= &quot;\t\t\t\t| &lt;a class='delete' href='&quot; . esc_attr( bb_get_uri('bb-admin/forums.php', array('action' =&gt; 'delete', 'id' =&gt; $_forum-&gt;forum_id), BB_URI_CONTEXT_A_HREF + BB_URI_CONTEXT_BB_ADMIN) ) . &quot;'&gt;&quot; . __('Delete') . &quot;&lt;/a&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t\t&lt;/span&gt;&nbsp;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  $r .= &quot;\t\t&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  if ( $close )&nbsp;</div></li><li><div>      $r .= &quot;\t&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $echo )&nbsp;</div></li><li><div>      echo $r;&nbsp;</div></li><li><div>  return $r;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_forum_form( $forum_id = 0 ) {&nbsp;</div></li><li><div>  $forum_id = (int) $forum_id;&nbsp;</div></li><li><div>  if ( $forum_id && !$forum = bb_get_forum( $forum_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_name = '';&nbsp;</div></li><li><div>  $forum_slug = '';&nbsp;</div></li><li><div>  $forum_description = '';&nbsp;</div></li><li><div>  $forum_position = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $forum_id ) {&nbsp;</div></li><li><div>      $forum_name = get_forum_name( $forum_id );&nbsp;</div></li><li><div>          $forum_slug = apply_filters('editable_slug', $forum-&gt;forum_slug); &nbsp;</div></li><li><div>      $forum_description = get_forum_description( $forum_id );&nbsp;</div></li><li><div>      $forum_position = get_forum_position( $forum_id );&nbsp;</div></li><li><div>      $legend = __( 'Edit Forum' );&nbsp;</div></li><li><div>      $submit = __( 'Save Changes' );&nbsp;</div></li><li><div>      $action = 'update';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $legend = __( 'Add Forum' );&nbsp;</div></li><li><div>      $submit = __( 'Add Forum' );&nbsp;</div></li><li><div>      $action = 'add';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $forum_options = array(&nbsp;</div></li><li><div>      'forum_name' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Name' ), &nbsp;</div></li><li><div>          'value' =&gt; $forum_name&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'forum_slug' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Slug' ), &nbsp;</div></li><li><div>          'value' =&gt; $forum_slug&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'forum_desc' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Description' ), &nbsp;</div></li><li><div>          'value' =&gt; $forum_description, &nbsp;</div></li><li><div>          'class' =&gt; 'long'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'forum_parent' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Parent' ), &nbsp;</div></li><li><div>          'type' =&gt; 'select', &nbsp;</div></li><li><div>          'options' =&gt; bb_get_forum_dropdown( array(&nbsp;</div></li><li><div>              'cut_branch' =&gt; $forum_id, &nbsp;</div></li><li><div>              'id' =&gt; 'forum_parent', &nbsp;</div></li><li><div>              'none' =&gt; true, &nbsp;</div></li><li><div>              'selected' =&gt; $forum_id ? get_forum_parent( $forum_id ) : 0, &nbsp;</div></li><li><div>              'disable_categories' =&gt; 0, &nbsp;</div></li><li><div>              'options_only' =&gt; true&nbsp;</div></li><li><div> ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'forum_order' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Position' ), &nbsp;</div></li><li><div>          'value' =&gt; $forum_position, &nbsp;</div></li><li><div>          'class' =&gt; 'short'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'forum_is_category' =&gt; array(&nbsp;</div></li><li><div>          'title' =&gt; __( 'Category' ), &nbsp;</div></li><li><div>          'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>          'options' =&gt; array(&nbsp;</div></li><li><div>              1 =&gt; array(&nbsp;</div></li><li><div>                  'label' =&gt; __( 'Make this forum a category' ), &nbsp;</div></li><li><div>                  'value' =&gt; bb_get_forum_is_category( $forum_id ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'note' =&gt; __( 'Categories are forums where new topics cannot be created. Categories usually contain a group of sub-forums.' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ( !$forum_id ) {&nbsp;</div></li><li><div>      unset( $forum_options['forum_slug'] );&nbsp;</div></li><li><div>      unset( $forum_options['forum_order'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;form class=&quot;settings&quot; method=&quot;post&quot; id=&quot;&lt;?php echo $action; ?&gt;-forum&quot; action=&quot;&lt;?php bb_uri('bb-admin/bb-forum.php', null, BB_URI_CONTEXT_FORM_ACTION + BB_URI_CONTEXT_BB_ADMIN); ?&gt;&quot; class=&quot;add:forum-list: forum-form&quot;&gt;&nbsp;</div></li><li><div>  &lt;fieldset&gt;&nbsp;</div></li><li><div>      &lt;legend&gt;&lt;?php echo $legend; ?&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>foreach ( $forum_options as $option =&gt; $args ) {&nbsp;</div></li><li><div>  bb_option_form_element( $option, $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>      &lt;fieldset class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>&lt;?php if ( $forum_id ) : ?&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;hidden&quot; name=&quot;forum_id&quot; value=&quot;&lt;?php echo $forum_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>          &lt;?php bb_nonce_field( 'order-forums', 'order-nonce' ); ?&gt;&nbsp;</div></li><li><div>          &lt;?php bb_nonce_field( $action . '-forum' ); ?&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;&lt;?php echo $action; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>          &lt;input class=&quot;submit&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $submit; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>      &lt;/fieldset&gt;&nbsp;</div></li><li><div>  &lt;/fieldset&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class BB_Walker_ForumAdminlistitems extends BB_Walker {&nbsp;</div></li><li><div>  var $tree_type = 'forum';&nbsp;</div></li><li><div>  var $db_fields = array ('parent' =&gt; 'forum_parent', 'id' =&gt; 'forum_id'); <span class="comment">//TODO: decouple this</span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function start_lvl($output, $depth) {&nbsp;</div></li><li><div>      $indent = str_repeat(&quot;\t&quot;, $depth) . '    ';&nbsp;</div></li><li><div>      $output .= $indent . &quot;&lt;ul id='forum-root-$this-&gt;forum_id' class='list-block holder'&gt;\n&quot;;&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function end_lvl($output, $depth) {&nbsp;</div></li><li><div>      $indent = str_repeat(&quot;\t&quot;, $depth) . '    ';&nbsp;</div></li><li><div>      $output .= $indent . &quot;&lt;/ul&gt;\n&quot;;&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function start_el($output, $forum, $depth) {&nbsp;</div></li><li><div>      $this-&gt;forum_id = $forum-&gt;forum_id;&nbsp;</div></li><li><div>      $indent = str_repeat(&quot;\t&quot;, $depth + 1);&nbsp;</div></li><li><div>      $output .= $indent . &quot;&lt;li id='forum-$this-&gt;forum_id'&quot; . get_alt_class( 'forum', 'forum clear list-block' ) . &quot;&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function end_el($output, $forum, $depth) {&nbsp;</div></li><li><div>      $indent = str_repeat(&quot;\t&quot;, $depth + 1);&nbsp;</div></li><li><div>      $output .= $indent . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Topics */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_move_forum_topics( $from_forum_id, $to_forum_id ) {&nbsp;</div></li><li><div>  global $bbdb;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $from_forum_id = (int) $from_forum_id ;&nbsp;</div></li><li><div>  $to_forum_id = (int) $to_forum_id;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  add_filter('get_forum_where', 'bb_no_where'); <span class="comment">// Just in case</span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $from_forum = bb_get_forum( $from_forum_id );&nbsp;</div></li><li><div>  if ( !$to_forum = bb_get_forum( $to_forum_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts = $to_forum-&gt;posts + ( $from_forum ? $from_forum-&gt;posts : 0 );&nbsp;</div></li><li><div>  $topics = $to_forum-&gt;topics + ( $from_forum ? $from_forum-&gt;topics : 0 );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $bbdb-&gt;update( $bbdb-&gt;forums, compact( 'topics', 'posts' ), array( 'forum_id' =&gt; $to_forum_id ) );&nbsp;</div></li><li><div>  $bbdb-&gt;update( $bbdb-&gt;forums, array( 'topics' =&gt; 0, 'posts' =&gt; 0 ), array( 'forum_id' =&gt; $from_forum_id ) );&nbsp;</div></li><li><div>  $bbdb-&gt;update( $bbdb-&gt;posts, array( 'forum_id' =&gt; $to_forum_id ), array( 'forum_id' =&gt; $from_forum_id ) );&nbsp;</div></li><li><div>  $topic_ids = $bbdb-&gt;get_col( $bbdb-&gt;prepare( &quot;SELECT topic_id FROM $bbdb-&gt;topics WHERE forum_id = %d&quot;, $from_forum_id ) );&nbsp;</div></li><li><div>  $return = $bbdb-&gt;update( $bbdb-&gt;topics, array( 'forum_id' =&gt; $to_forum_id ), array( 'forum_id' =&gt; $from_forum_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $topic_ids )&nbsp;</div></li><li><div>      foreach ( $topic_ids as $topic_id ) {&nbsp;</div></li><li><div>          <span class="comment">// should maybe just flush these groups</span>&nbsp;</div></li><li><div>          wp_cache_delete( $topic_id, 'bb_topic' );&nbsp;</div></li><li><div>          wp_cache_delete( $topic_id, 'bb_thread' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $from_forum_id, 'bb_forum' );&nbsp;</div></li><li><div>  wp_cache_delete( $to_forum_id, 'bb_forum' );&nbsp;</div></li><li><div>  wp_cache_flush( 'bb_forums' );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Posts */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_admin_list_posts() {&nbsp;</div></li><li><div>  global $bb_posts, $bb_post;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ( !$bb_posts ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;p class=&quot;no-results&quot;&gt;&lt;?php _e('No posts found.'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;table id=&quot;posts-list&quot; class=&quot;widefat&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&nbsp;</div></li><li><div>&lt;thead&gt;&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot; class=&quot;check-column&quot;&gt;&lt;input type=&quot;checkbox&quot; /&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Post' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Author' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Topic' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Date' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/thead&gt;&nbsp;</div></li><li><div>&lt;tfoot&gt;&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot; class=&quot;check-column&quot;&gt;&lt;input type=&quot;checkbox&quot; /&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Post' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Author' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Topic' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;col&quot;&gt;&lt;?php _e( 'Date' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/tfoot&gt;&nbsp;</div></li><li><div>&lt;tbody&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>      foreach ( $bb_posts as $bb_post ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;tr id=&quot;post-&lt;?php post_id(); ?&gt;&quot;&lt;?php alt_class('post', post_del_class()); ?&gt;&gt;&nbsp;</div></li><li><div>      &lt;td class=&quot;check-column&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;post[]&quot; value=&quot;&lt;?php post_id(); ?&gt;&quot; /&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;td class=&quot;post&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php post_text(); ?&gt;&nbsp;</div></li><li><div>          &lt;div&gt;&nbsp;</div></li><li><div>              &lt;span class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                  &lt;a href=&quot;&lt;?php echo esc_url( get_post_link() ); ?&gt;&quot;&gt;&lt;?php _e( 'View' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  bb_post_admin( array(&nbsp;</div></li><li><div>      'before_each' =&gt; ' | ', &nbsp;</div></li><li><div>      'each' =&gt; array(&nbsp;</div></li><li><div>          'undelete' =&gt; array(&nbsp;</div></li><li><div>              'before' =&gt; ' '&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'last_each' =&gt; array(&nbsp;</div></li><li><div>          'before' =&gt; ' | '&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>              &lt;/span&gt;&nbsp;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/td&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;td class=&quot;author&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php if ( get_post_author_id() ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;a href=&quot;&lt;?php user_profile_link( get_post_author_id() ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php post_author_avatar( '16' ); ?&gt;&nbsp;</div></li><li><div>                  &lt;?php post_author(); ?&gt;&nbsp;</div></li><li><div>              &lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php else : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;span&gt;&nbsp;</div></li><li><div>                  &lt;?php post_author_avatar( '16' ); ?&gt;&nbsp;</div></li><li><div>                  &lt;?php post_author(); ?&gt;&nbsp;</div></li><li><div>              &lt;/span&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>      &lt;/td&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;td class=&quot;topic&quot;&gt;&nbsp;</div></li><li><div>          &lt;a href=&quot;&lt;?php topic_link( $bb_post-&gt;topic_id ); ?&gt;&quot;&gt;&lt;?php topic_title( $bb_post-&gt;topic_id ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/td&gt;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      &lt;td class=&quot;date&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  if ( bb_get_post_time( 'U' ) &lt; ( time() - 86400 ) ) {&nbsp;</div></li><li><div>      bb_post_time( 'Y/m/d\&lt;\b\r \/\&gt;H:i:s' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      printf( __( '%s ago' ), bb_get_post_time( 'since' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>      &lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;?php &nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Recounts */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_recount_list()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $recount_list;&nbsp;</div></li><li><div>  $recount_list = array(&nbsp;</div></li><li><div>      5 =&gt; array( 'topic-posts', __( 'Count posts of every topic' ) ), &nbsp;</div></li><li><div>      6 =&gt; array( 'topic-voices', __( 'Count voices of every topic' ) ), &nbsp;</div></li><li><div>      10 =&gt; array( 'topic-deleted-posts', __( 'Count deleted posts on every topic' ) ), &nbsp;</div></li><li><div>      15 =&gt; array( 'forums', __( 'Count topics and posts in every forum' ) ), &nbsp;</div></li><li><div>      20 =&gt; array( 'topics-replied', __( 'Count topics to which each user has replied' ) ), &nbsp;</div></li><li><div>      25 =&gt; array( 'topic-tag-count', __( 'Count tags for every topic' ) ), &nbsp;</div></li><li><div>      30 =&gt; array( 'tags-tag-count', __( 'Count topics for every tag' ) ), &nbsp;</div></li><li><div>      35 =&gt; array( 'tags-delete-empty', __( 'Delete tags with no topics' ) ), &nbsp;</div></li><li><div>      40 =&gt; array( 'clean-favorites', __( 'Remove deleted topics from users\' favorites' ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  do_action( 'bb_recount_list' );&nbsp;</div></li><li><div>  ksort( $recount_list );&nbsp;</div></li><li><div>  return $recount_list;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Themes */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_get_current_theme_data( $property = 'all' ) {&nbsp;</div></li><li><div>  if (!$property) {&nbsp;</div></li><li><div>      $property = 'all';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $directory = bb_get_active_theme_directory();&nbsp;</div></li><li><div>  $stylesheet = $directory . 'style.css';&nbsp;</div></li><li><div>  if (file_exists($stylesheet)) {&nbsp;</div></li><li><div>      $data = bb_get_theme_data($stylesheet);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ($property == 'all') {&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  } elseif (isset($data[$property])) {&nbsp;</div></li><li><div>      return $data[$property];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Output sanitized for display</span>&nbsp;</div></li><li><div>function bb_get_theme_data( $theme_file )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  if ( strpos($theme_file, '#') !== false ) {&nbsp;</div></li><li><div>      $theme_file = bb_get_theme_directory( $theme_file ) . 'style.css';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $theme_code = implode( '', file( $theme_file ) );&nbsp;</div></li><li><div>  $theme_code = str_replace ( '\r', '\n', $theme_code );&nbsp;</div></li><li><div>  <span class="comment">// Grab just the first commented area from the file</span>&nbsp;</div></li><li><div>  preg_match( '|/\*(.*)\*/|msU', $theme_code, $theme_block );&nbsp;</div></li><li><div>  $theme_data = trim( $theme_block[1] );&nbsp;</div></li><li><div>  preg_match( '|Theme Name:(.*)|i', $theme_data, $theme_name );&nbsp;</div></li><li><div>  preg_match( '|Theme URI:(.*)|i', $theme_data, $theme_uri );&nbsp;</div></li><li><div>  preg_match( '|Description:(.*)|i', $theme_data, $description );&nbsp;</div></li><li><div>  preg_match( '|Author:(.*)|i', $theme_data, $author_name );&nbsp;</div></li><li><div>  preg_match( '|Author URI:(.*)|i', $theme_data, $author_uri );&nbsp;</div></li><li><div>  preg_match( '|Ported By:(.*)|i', $theme_data, $porter_name );&nbsp;</div></li><li><div>  preg_match( '|Porter URI:(.*)|i', $theme_data, $porter_uri );&nbsp;</div></li><li><div><span class="comment">//    preg_match( '|Template:(.*)|i', $theme_data, $template );</span>&nbsp;</div></li><li><div>  if ( preg_match( '|Version:(.*)|i', $theme_data, $version ) )&nbsp;</div></li><li><div>      $version = esc_html( trim( $version[1] ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $version ='';&nbsp;</div></li><li><div>  if ( preg_match('|Status:(.*)|i', $theme_data, $status) )&nbsp;</div></li><li><div>      $status = esc_html( trim($status[1]) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $status = 'publish';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $description = trim($description[1]);&nbsp;</div></li><li><div>  $description = bb_encode_bad( $description );&nbsp;</div></li><li><div>  $description = bb_code_trick( $description );&nbsp;</div></li><li><div>  $description = force_balance_tags( $description );&nbsp;</div></li><li><div>  $description = bb_filter_kses( $description );&nbsp;</div></li><li><div>  $description = bb_autop( $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $name = $theme_name[1];&nbsp;</div></li><li><div>  $name = esc_html( trim($name) );&nbsp;</div></li><li><div>  $theme = $name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $author_name || $author_uri ) {&nbsp;</div></li><li><div>      if ( empty($author_uri[1]) ) {&nbsp;</div></li><li><div>          $author = bb_filter_kses( trim($author_name[1]) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $author = '&lt;a href=&quot;' . esc_url( trim($author_uri[1]) ) . '&quot; title=&quot;' . esc_attr__( 'Visit author homepage' ) . '&quot;&gt;' . bb_filter_kses( trim($author_name[1]) ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $author = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $porter_name || $porter_uri ) {&nbsp;</div></li><li><div>      if ( empty($porter_uri[1]) ) {&nbsp;</div></li><li><div>          $porter = bb_filter_kses( trim($porter_name[1]) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $porter = '&lt;a href=&quot;' . esc_url( trim($porter_uri[1]) ) . '&quot; title=&quot;' . esc_attr__( 'Visit porter homepage' ) . '&quot;&gt;' . bb_filter_kses( trim($porter_name[1]) ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $porter = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $bb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Normalise the path to the theme</span>&nbsp;</div></li><li><div>  $theme_file = str_replace( '\\', '/', $theme_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $bb-&gt;theme_locations as $_name =&gt; $_data ) {&nbsp;</div></li><li><div>      $_directory = str_replace( '\\', '/', $_data['dir'] );&nbsp;</div></li><li><div>      if ( 0 === strpos( $theme_file, $_directory ) ) {&nbsp;</div></li><li><div>          $location = $_name;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'Location' =&gt; $location, &nbsp;</div></li><li><div>      'Name' =&gt; $name, &nbsp;</div></li><li><div>      'Title' =&gt; $theme, &nbsp;</div></li><li><div>      'Description' =&gt; $description, &nbsp;</div></li><li><div>      'Author' =&gt; $author, &nbsp;</div></li><li><div>      'Porter' =&gt; $porter, &nbsp;</div></li><li><div>      'Version' =&gt; $version, &nbsp;</div></li><li><div><span class="comment">//        'Template' =&gt; $template[1], </span>&nbsp;</div></li><li><div>      'Status' =&gt; $status, &nbsp;</div></li><li><div>      'URI' =&gt; esc_url( $theme_uri[1] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'checked' ) ) :&nbsp;</div></li><li><div>function checked( $checked, $current) {&nbsp;</div></li><li><div>  if ( $checked == $current)&nbsp;</div></li><li><div>      echo ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists( 'selected' ) ) :&nbsp;</div></li><li><div>function selected( $selected, $current) {&nbsp;</div></li><li><div>  if ( $selected === $current)&nbsp;</div></li><li><div>      echo ' selected=&quot;selected&quot;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Options */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function bb_option_form_element( $name = 'name', $args = null ) {&nbsp;</div></li><li><div>  global $bb_hardcoded;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'title' =&gt; 'title', &nbsp;</div></li><li><div>      'type' =&gt; 'text', &nbsp;</div></li><li><div>      'value' =&gt; false, &nbsp;</div></li><li><div>      'options' =&gt; false, &nbsp;</div></li><li><div>      'message' =&gt; false, &nbsp;</div></li><li><div>      'class' =&gt; false, &nbsp;</div></li><li><div>      'default' =&gt; false, &nbsp;</div></li><li><div>      'before' =&gt; '', &nbsp;</div></li><li><div>      'after' =&gt; '', &nbsp;</div></li><li><div>      'note' =&gt; false, &nbsp;</div></li><li><div>      'attributes' =&gt; false, &nbsp;</div></li><li><div>      'disabled' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = str_replace( array( '_', '[', ']' ), array( '-', '-', '' ), $name );&nbsp;</div></li><li><div>  if ( false !== strpos( $name, '[' ) ) {&nbsp;</div></li><li><div>      list( $option_name, $option_key ) = preg_split( '/[\[\]]/', $name, -1, PREG_SPLIT_NO_EMPTY );&nbsp;</div></li><li><div>      $option = bb_get_option( $option_name );&nbsp;</div></li><li><div>      $value = false === $args['value'] ? esc_attr( $option[$option_key] ) : esc_attr( $args['value'] );&nbsp;</div></li><li><div>      $hardcoded = isset( $bb_hardcoded[$option_name][$option_key] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $value = false === $args['value'] ? bb_get_form_option( $name ) : esc_attr( $args['value'] );&nbsp;</div></li><li><div>      $hardcoded = isset( $bb_hardcoded[$name] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $class = $args['class'] ? (array) $args['class'] : array();&nbsp;</div></li><li><div>  array_unshift( $class, $args['type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $hardcoded || $args['disabled'] )&nbsp;</div></li><li><div>      $disabled = ' disabled=&quot;disabled&quot;';&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $disabled = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $args['attributes'] ) {&nbsp;</div></li><li><div>      $attributes = array();&nbsp;</div></li><li><div>      foreach ( $args['attributes'] as $k =&gt; $v )&nbsp;</div></li><li><div>          $attributes[] = &quot;$k='$v'&quot;;&nbsp;</div></li><li><div>      $attributes = ' ' . join( ' ', $attributes );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $attributes = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div id=&quot;option-&lt;?php echo $id; ?&gt;&quot;&lt;?php if ( !empty( $disabled ) ) echo ' class=&quot;disabled&quot;'; ?&gt;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>          switch ( $args['type'] ) {&nbsp;</div></li><li><div>              case 'radio' :&nbsp;</div></li><li><div>              case 'checkbox' :&nbsp;</div></li><li><div>              case 'message' :&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php echo $args['title']; ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'select' :&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>          &lt;label for=&quot;&lt;?php echo $id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php echo $args['title']; ?&gt;&nbsp;</div></li><li><div>          &lt;/label&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;inputs&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>          if ( $args['before'] ) {&nbsp;</div></li><li><div>              echo '&lt;span class=&quot;before&quot;&gt;' . $args['before'] . '&lt;/span&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          switch ( $args['type'] ) {&nbsp;</div></li><li><div>              case 'select' :&nbsp;</div></li><li><div>                  echo &quot;&lt;select$disabled class='&quot; . join( ' ', $class ) . &quot;' name='$name' id='$id'$attributes&gt;\n&quot;;&nbsp;</div></li><li><div>                  if ( is_array( $args['options'] ) ) {&nbsp;</div></li><li><div>                      foreach ( $args['options'] as $option =&gt; $label )&nbsp;</div></li><li><div>                          echo &quot;\t&lt;option value='$option'&quot; . ( $value == $option ? &quot; selected='selected'&quot; : '' ) . &quot;&gt;$label&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>                  } elseif ( is_string( $args['options'] ) ) {&nbsp;</div></li><li><div>                      echo $args['options'] . &quot;\n&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  echo &quot;&lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'radio' :&nbsp;</div></li><li><div>              case 'checkbox' :&nbsp;</div></li><li><div>                  if ( is_array( $args['options'] ) ) {&nbsp;</div></li><li><div>                      $_id = 0;&nbsp;</div></li><li><div>                      if ( 'radio' === $args['type'] && !in_array( $value, array_keys( $args['options'] ) ) && empty( $value ) ) {&nbsp;</div></li><li><div>                          $use_first_value = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $type = $args['type'];&nbsp;</div></li><li><div>                      foreach ( $args['options'] as $option =&gt; $label ) {&nbsp;</div></li><li><div>                          if ( $use_first_value ) {&nbsp;</div></li><li><div>                              $use_first_value = false;&nbsp;</div></li><li><div>                              $value = $option;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          if ( is_array( $label ) ) {&nbsp;</div></li><li><div>                              if ( isset( $label['attributes'] ) ) {&nbsp;</div></li><li><div>                                  $attributes = array();&nbsp;</div></li><li><div>                                  foreach ( $label['attributes'] as $k =&gt; $v )&nbsp;</div></li><li><div>                                      $attributes[] = &quot;$k='$v'&quot;;&nbsp;</div></li><li><div>                                  $attributes = ' ' . join( ' ', $attributes );&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $attributes = '';&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ( isset( $label['name'] ) ) {&nbsp;</div></li><li><div>                                  $name = $label['name'];&nbsp;</div></li><li><div>                                  $id = str_replace( array( '_', '[', ']' ), array( '-', '-', '' ), $name );&nbsp;</div></li><li><div>                                  $hardcoded = isset( $bb_hardcoded[$name] );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ( isset( $label['value'] ) ) {&nbsp;</div></li><li><div>                                  $_value = $label['value'];&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $_value = $args['value'];&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $value = false === $_value ? bb_get_form_option( $name ) : esc_attr( $_value );&nbsp;</div></li><li><div>                              $label = $label['label'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          echo &quot;&lt;label class=\&quot;{$type}s\&quot;&gt;&lt;input$disabled type='$type' class='&quot; . join( ' ', $class ) . &quot;' name='$name' id='$id-$_id' value='$option'&quot; . ( $value == $option ? &quot; checked='checked'&quot; : '' ) . &quot;{$attributes} /&gt; $label&lt;/label&gt;\n&quot;;&nbsp;</div></li><li><div>                          $_id++;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } elseif ( is_string( $args['options'] ) ) {&nbsp;</div></li><li><div>                      echo $args['options'] . &quot;\n&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'message' :&nbsp;</div></li><li><div>                  if ( $args['message'] ) {&nbsp;</div></li><li><div>                      echo $args['message'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>                  echo &quot;&lt;input$disabled type='$args[type]' class='&quot; . join( ' ', $class ) . &quot;' name='$name' id='$id' value='$value'$attributes /&gt;\n&quot;;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $args['after'] ) {&nbsp;</div></li><li><div>              echo '&lt;span class=&quot;after&quot;&gt;' . $args['after'] . '&lt;/span&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $args['note'] ) {&nbsp;</div></li><li><div>              foreach ( (array) $args['note'] as $note ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php echo $note; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>