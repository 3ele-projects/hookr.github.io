<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49295"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-groups-classes-class-bp-group-extension | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=ba5df153b79b710da53ad16e47df1e87' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-groups-classes-class-bp-group-extension/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-groups-classes-class-bp-group-extension%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-groups-classes-class-bp-group-extension%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-groups-classes-class-bp-group-extension","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-groups-classes-class-bp-group-extension" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-groups-classes-class-bp-gr&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-groups/classes/class-bp-group-extension.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Groups Classes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage GroupsClasses</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * API for creating group extensions without having to hardcode the content into</span>&nbsp;</div></li><li><div><span class="comment"> * the theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * To implement, extend this class. In your constructor, pass an optional array</span>&nbsp;</div></li><li><div><span class="comment"> * of arguments to parent::init() to configure your widget. The config array</span>&nbsp;</div></li><li><div><span class="comment"> * supports the following values:</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'slug' A unique identifier for your extension. This value will be used</span>&nbsp;</div></li><li><div><span class="comment"> *     to build URLs, so make it URL-safe.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'name' A translatable name for your extension. This value is used to</span>&nbsp;</div></li><li><div><span class="comment"> *     populate the navigation tab, as well as the default titles for admin/</span>&nbsp;</div></li><li><div><span class="comment"> *     edit/create tabs.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'visibility' Set to 'public' (default) for your extension (the main tab</span>&nbsp;</div></li><li><div><span class="comment"> *     as well as the widget) to be available to anyone who can access the</span>&nbsp;</div></li><li><div><span class="comment"> *     group, 'private' otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'nav_item_position' An integer explaining where the nav item should</span>&nbsp;</div></li><li><div><span class="comment"> *     appear in the tab list.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'enable_nav_item' Set to true for your extension's main tab to be</span>&nbsp;</div></li><li><div><span class="comment"> *     available to anyone who can access the group.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'nav_item_name' The translatable text you want to appear in the nav tab.</span>&nbsp;</div></li><li><div><span class="comment"> *     Defaults to the value of 'name'.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'display_hook' The WordPress action that the widget_display() method is</span>&nbsp;</div></li><li><div><span class="comment"> *     hooked to.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'template_file' The template file that will be used to load the content</span>&nbsp;</div></li><li><div><span class="comment"> *     of your main extension tab. Defaults to 'groups/single/plugins.php'.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'screens' A multi-dimensional array, described below.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'access' Which users can visit the plugin's tab.</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'show_tab' Which users can see the plugin's navigation tab.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * BP_Group_Extension uses the concept of &quot;settings screens&quot;. There are three</span>&nbsp;</div></li><li><div><span class="comment"> * contexts for settings screens:</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'create', which inserts a new step into the group creation process</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'edit', which adds a tab for your extension into the Admin section of</span>&nbsp;</div></li><li><div><span class="comment"> *     a group</span>&nbsp;</div></li><li><div><span class="comment"> *   - 'admin', which adds a metabox to the Groups administration panel in the</span>&nbsp;</div></li><li><div><span class="comment"> *     WordPress Dashboard</span>&nbsp;</div></li><li><div><span class="comment"> * Each of these settings screens is populated by a pair of methods: one that</span>&nbsp;</div></li><li><div><span class="comment"> * creates the markup for the screen, and one that processes form data</span>&nbsp;</div></li><li><div><span class="comment"> * submitted from the screen. If your plugin needs screens in all three</span>&nbsp;</div></li><li><div><span class="comment"> * contexts, and if the markup and form processing logic will be the same in</span>&nbsp;</div></li><li><div><span class="comment"> * each case, you can define two methods to handle all of the screens:</span>&nbsp;</div></li><li><div><span class="comment"> *   function settings_screen() {}</span>&nbsp;</div></li><li><div><span class="comment"> *   function settings_screen_save() {}</span>&nbsp;</div></li><li><div><span class="comment"> * If one or more of your settings screen needs separate logic, you may define</span>&nbsp;</div></li><li><div><span class="comment"> * context-specific methods, for example:</span>&nbsp;</div></li><li><div><span class="comment"> *   function edit_screen() {}</span>&nbsp;</div></li><li><div><span class="comment"> *   function edit_screen_save() {}</span>&nbsp;</div></li><li><div><span class="comment"> * BP_Group_Extension will use the more specific methods if they are available.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You can further customize the settings screens (tab names, etc) by passing</span>&nbsp;</div></li><li><div><span class="comment"> * an optional 'screens' parameter to the init array. The format is as follows:</span>&nbsp;</div></li><li><div><span class="comment"> *   'screens' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment"> *       'create' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment"> *       'slug' =&gt; 'foo', </span>&nbsp;</div></li><li><div><span class="comment"> *       'name' =&gt; 'Foo', </span>&nbsp;</div></li><li><div><span class="comment"> *       'position' =&gt; 55, </span>&nbsp;</div></li><li><div><span class="comment"> *       'screen_callback' =&gt; 'my_create_screen_callback', </span>&nbsp;</div></li><li><div><span class="comment"> *       'screen_save_callback' =&gt; 'my_create_screen_save_callback', </span>&nbsp;</div></li><li><div><span class="comment"> * ), </span>&nbsp;</div></li><li><div><span class="comment"> *   'edit' =&gt; array( // ...</span>&nbsp;</div></li><li><div><span class="comment"> * ), </span>&nbsp;</div></li><li><div><span class="comment"> * Only provide those arguments that you actually want to change from the</span>&nbsp;</div></li><li><div><span class="comment"> * default configuration. BP_Group_Extension will do the rest.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that the 'edit' screen accepts an additional parameter: 'submit_text', </span>&nbsp;</div></li><li><div><span class="comment"> * which defines the text of the Submit button automatically added to the Edit</span>&nbsp;</div></li><li><div><span class="comment"> * screen of the extension (defaults to 'Save Changes'). Also, the 'admin'</span>&nbsp;</div></li><li><div><span class="comment"> * screen accepts two additional parameters: 'metabox_priority' and</span>&nbsp;</div></li><li><div><span class="comment"> * 'metabox_context'. See the docs for add_meta_box() for more details on these</span>&nbsp;</div></li><li><div><span class="comment"> * arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Prior to BuddyPress 1.7, group extension configurations were set slightly</span>&nbsp;</div></li><li><div><span class="comment"> * differently. The legacy method is still supported, though deprecated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class BP_Group_Extension {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Public ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Information about this extension's screens.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $screens = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The name of the extending class.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $class_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * A ReflectionClass object of the current extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var ReflectionClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $class_reflection = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parsed configuration parameters for the extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Raw config params, as passed by the extending class.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $params_raw = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The ID of the current group.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $group_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The slug of the current extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $slug = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The translatable name of the current extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The visibility of the extension tab. 'public' or 'private'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $visibility = 'public';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The numeric position of the main nav item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $nav_item_position = 81;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether to show the nav item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $enable_nav_item = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether the current user should see the navigation item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $user_can_see_nav_item;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether the current user can visit the tab.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $user_can_visit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The text of the nav item. Defaults to self::name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $nav_item_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The WP action that self::widget_display() is attached to.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Default: 'groups_custom_group_boxes'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $display_hook = 'groups_custom_group_boxes';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The template file used to load the plugin content.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Default: 'groups/single/plugins'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $template_file = 'groups/single/plugins';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Protected *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Has the extension been initialized?</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $initialized = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Extension properties as set by legacy extensions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $legacy_properties = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converted legacy parameters.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * These are the extension properties as set by legacy extensions, but</span>&nbsp;</div></li><li><div><span class="comment">   * then converted to match the new format for params.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $legacy_properties_converted = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Redirect location as defined by post-edit save callback.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $post_save_redirect;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Miscellaneous data as set by the __set() magic method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Screen Overrides **************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Screen override methods are how your extension will display content</span>&nbsp;</div></li><li><div><span class="comment">   * and handle form submits. Your extension should only override those</span>&nbsp;</div></li><li><div><span class="comment">   * methods that it needs for its purposes.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The content of the group tab.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|null $group_id ID of the group to display.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function display( $group_id = null ) {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Content displayed in a widget sidebar, if applicable.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function widget_display() {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * *_screen() displays the settings form for the given context</span>&nbsp;</div></li><li><div><span class="comment">   * *_screen_save() processes data submitted via the settings form</span>&nbsp;</div></li><li><div><span class="comment">   * The settings_* methods are generic fallbacks, which can optionally</span>&nbsp;</div></li><li><div><span class="comment">   * be overridden by the more specific edit_*, create_*, and admin_*</span>&nbsp;</div></li><li><div><span class="comment">   * versions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function settings_screen( $group_id = null ) {}&nbsp;</div></li><li><div>  public function settings_screen_save( $group_id = null ) {}&nbsp;</div></li><li><div>  public function edit_screen( $group_id = null ) {}&nbsp;</div></li><li><div>  public function edit_screen_save( $group_id = null ) {}&nbsp;</div></li><li><div>  public function create_screen( $group_id = null ) {}&nbsp;</div></li><li><div>  public function create_screen_save( $group_id = null ) {}&nbsp;</div></li><li><div>  public function admin_screen( $group_id = null ) {}&nbsp;</div></li><li><div>  public function admin_screen_save( $group_id = null ) {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Setup *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize the extension, using your config settings.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Your plugin should call this method at the very end of its</span>&nbsp;</div></li><li><div><span class="comment">   * constructor, like so:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *   public function __construct() {</span>&nbsp;</div></li><li><div><span class="comment">   *       $args = array(</span>&nbsp;</div></li><li><div><span class="comment">   *           'slug' =&gt; 'my-group-extension', </span>&nbsp;</div></li><li><div><span class="comment">   *           'name' =&gt; 'My Group Extension', </span>&nbsp;</div></li><li><div><span class="comment">   *           // ...</span>&nbsp;</div></li><li><div><span class="comment">   * );</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *       parent::init( $args );</span>&nbsp;</div></li><li><div><span class="comment">   *   }</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0 Added 'access' and 'show_tab' arguments to `$args`.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args {</span>&nbsp;</div></li><li><div><span class="comment">   *     Array of initialization arguments.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $slug              Unique, URL-safe identifier for your extension.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $name              Translatable name for your extension. Used to populate</span>&nbsp;</div></li><li><div><span class="comment">   *                                           navigation items.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $visibility        Optional. Set to 'public' for your extension (the main tab as well</span>&nbsp;</div></li><li><div><span class="comment">   *                                           as the widget) to be available to anyone who can access the group;</span>&nbsp;</div></li><li><div><span class="comment">   *                                           set to 'private' otherwise. Default: 'public'.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type int          $nav_item_position Optional. Location of the nav item in the tab list.</span>&nbsp;</div></li><li><div><span class="comment">   *                                           Default: 81.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool         $enable_nav_item   Optional. Whether the extension's tab should be accessible to</span>&nbsp;</div></li><li><div><span class="comment">   *                                           anyone who can view the group. Default: true.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $nav_item_name     Optional. The translatable text you want to appear in the nav tab.</span>&nbsp;</div></li><li><div><span class="comment">   *                                           Default: the value of `$name`.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $display_hook      Optional. The WordPress action that the widget_display() method is</span>&nbsp;</div></li><li><div><span class="comment">   *                                           hooked to. Default: 'groups_custom_group_boxes'.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string       $template_file     Optional. Theme-relative path to the template file BP should use</span>&nbsp;</div></li><li><div><span class="comment">   *                                           to load the content of your main extension tab.</span>&nbsp;</div></li><li><div><span class="comment">   *                                           Default: 'groups/single/plugins.php'.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type array        $screens           A multi-dimensional array of configuration information for the</span>&nbsp;</div></li><li><div><span class="comment">   *                                           extension screens. See docblock of {@link BP_Group_Extension}</span>&nbsp;</div></li><li><div><span class="comment">   *                                           for more details.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string|array $access            Which users can visit the plugin's tab. Possible values: 'anyone', </span>&nbsp;</div></li><li><div><span class="comment">   *                                           'loggedin', 'member', 'mod', 'admin' or 'noone'. ('member', 'mod', </span>&nbsp;</div></li><li><div><span class="comment">   *                                           'admin' refer to user's role in group.) Note that 'mod' targets</span>&nbsp;</div></li><li><div><span class="comment">   *                                           only group moderators. If you want to allow access to group moderators</span>&nbsp;</div></li><li><div><span class="comment">   *                                           and admins, specify `array( 'mod', 'admin' )`. Defaults to 'anyone'</span>&nbsp;</div></li><li><div><span class="comment">   *                                           for public groups and 'member' for private groups.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string|array $show_tab          Which users can see the plugin's navigation tab. Possible values:</span>&nbsp;</div></li><li><div><span class="comment">   *                                           'anyone', 'loggedin', 'member', 'mod', 'admin' or 'noone'.</span>&nbsp;</div></li><li><div><span class="comment">   *                                           ('member', 'mod', 'admin' refer to user's role in group.) Note</span>&nbsp;</div></li><li><div><span class="comment">   *                                           that 'mod' targets only group moderators. If you want to show the</span>&nbsp;</div></li><li><div><span class="comment">   *                                           tab to group moderators and admins, specify</span>&nbsp;</div></li><li><div><span class="comment">   *                                           `array( 'mod', 'admin' )`. Defaults to 'anyone' for public groups</span>&nbsp;</div></li><li><div><span class="comment">   *                                           and 'member' for private groups.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init( $args = array() ) {&nbsp;</div></li><li><div>      <span class="comment">// Store the raw arguments.</span>&nbsp;</div></li><li><div>      $this-&gt;params_raw = $args;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Before this init() method was introduced, plugins were</span>&nbsp;</div></li><li><div>      <span class="comment">// encouraged to set their config directly. For backward</span>&nbsp;</div></li><li><div>      <span class="comment">// compatibility with these plugins, we detect whether this is</span>&nbsp;</div></li><li><div>      <span class="comment">// one of those legacy plugins, and parse any legacy arguments</span>&nbsp;</div></li><li><div>      <span class="comment">// with those passed to init().</span>&nbsp;</div></li><li><div>      $this-&gt;parse_legacy_properties();&nbsp;</div></li><li><div>      $args = $this-&gt;parse_args_r( $args, $this-&gt;legacy_properties_converted );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Parse with defaults.</span>&nbsp;</div></li><li><div>      $this-&gt;params = $this-&gt;parse_args_r( $args, array(&nbsp;</div></li><li><div>          'slug' =&gt; $this-&gt;slug, &nbsp;</div></li><li><div>          'name' =&gt; $this-&gt;name, &nbsp;</div></li><li><div>          'visibility' =&gt; $this-&gt;visibility, &nbsp;</div></li><li><div>          'nav_item_position' =&gt; $this-&gt;nav_item_position, &nbsp;</div></li><li><div>          'enable_nav_item' =&gt; (bool) $this-&gt;enable_nav_item, &nbsp;</div></li><li><div>          'nav_item_name' =&gt; $this-&gt;nav_item_name, &nbsp;</div></li><li><div>          'display_hook' =&gt; $this-&gt;display_hook, &nbsp;</div></li><li><div>          'template_file' =&gt; $this-&gt;template_file, &nbsp;</div></li><li><div>          'screens' =&gt; $this-&gt;get_default_screens(), &nbsp;</div></li><li><div>          'access' =&gt; null, &nbsp;</div></li><li><div>          'show_tab' =&gt; null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;initialized = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The main setup routine for the extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method contains the primary logic for setting up an extension's</span>&nbsp;</div></li><li><div><span class="comment">   * configuration, setting up backward compatibility for legacy plugins, </span>&nbsp;</div></li><li><div><span class="comment">   * and hooking the extension's screen functions into WP and BP.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Marked 'public' because it must be accessible to add_action().</span>&nbsp;</div></li><li><div><span class="comment">   * However, you should never need to invoke this method yourself - it</span>&nbsp;</div></li><li><div><span class="comment">   * is called automatically at the right point in the load order by</span>&nbsp;</div></li><li><div><span class="comment">   * bp_register_group_extension().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function _register() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Detect and parse properties set by legacy extensions.</span>&nbsp;</div></li><li><div>      $this-&gt;parse_legacy_properties();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Initialize, if necessary. This should only happen for</span>&nbsp;</div></li><li><div>      <span class="comment">// legacy extensions that don't call parent::init() themselves.</span>&nbsp;</div></li><li><div>      if ( true !== $this-&gt;initialized ) {&nbsp;</div></li><li><div>          $this-&gt;init();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set some config values, based on the parsed params.</span>&nbsp;</div></li><li><div>      $this-&gt;group_id = $this-&gt;get_group_id();&nbsp;</div></li><li><div>      $this-&gt;slug = $this-&gt;params['slug'];&nbsp;</div></li><li><div>      $this-&gt;name = $this-&gt;params['name'];&nbsp;</div></li><li><div>      $this-&gt;visibility = $this-&gt;params['visibility'];&nbsp;</div></li><li><div>      $this-&gt;nav_item_position = $this-&gt;params['nav_item_position'];&nbsp;</div></li><li><div>      $this-&gt;nav_item_name = $this-&gt;params['nav_item_name'];&nbsp;</div></li><li><div>      $this-&gt;display_hook = $this-&gt;params['display_hook'];&nbsp;</div></li><li><div>      $this-&gt;template_file = $this-&gt;params['template_file'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Configure 'screens': create, admin, and edit contexts.</span>&nbsp;</div></li><li><div>      $this-&gt;setup_screens();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Configure access-related settings.</span>&nbsp;</div></li><li><div>      $this-&gt;setup_access_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Mirror configuration data so it's accessible to plugins</span>&nbsp;</div></li><li><div>      <span class="comment">// that look for it in its old locations.</span>&nbsp;</div></li><li><div>      $this-&gt;setup_legacy_properties();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook the extension into BuddyPress.</span>&nbsp;</div></li><li><div>      $this-&gt;setup_display_hooks();&nbsp;</div></li><li><div>      $this-&gt;setup_create_hooks();&nbsp;</div></li><li><div>      $this-&gt;setup_edit_hooks();&nbsp;</div></li><li><div>      $this-&gt;setup_admin_hooks();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up some basic info about the Extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Here we collect the name of the extending class, as well as a</span>&nbsp;</div></li><li><div><span class="comment">   * ReflectionClass that is used in get_screen_callback() to determine</span>&nbsp;</div></li><li><div><span class="comment">   * whether your extension overrides certain callback methods.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_class_info() {&nbsp;</div></li><li><div>      if ( empty( $this-&gt;class_name ) ) {&nbsp;</div></li><li><div>          $this-&gt;class_name = get_class( $this );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $this-&gt;class_reflection ) ) {&nbsp;</div></li><li><div>          $this-&gt;class_reflection = new ReflectionClass( $this-&gt;class_name );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the current group ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Check for:</span>&nbsp;</div></li><li><div><span class="comment">   *   - current group</span>&nbsp;</div></li><li><div><span class="comment">   *   - new group</span>&nbsp;</div></li><li><div><span class="comment">   *   - group admin</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_group_id() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Usually this will work.</span>&nbsp;</div></li><li><div>      $group_id = bp_get_current_group_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// On the admin, get the group id out of the $_GET params.</span>&nbsp;</div></li><li><div>      if ( empty( $group_id ) && is_admin() && ( isset( $_GET['page'] ) && ( 'bp-groups' === $_GET['page'] ) ) && ! empty( $_GET['gid'] ) ) {&nbsp;</div></li><li><div>          $group_id = (int) $_GET['gid'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This fallback will only be hit when the create step is very</span>&nbsp;</div></li><li><div>      <span class="comment">// early.</span>&nbsp;</div></li><li><div>      if ( empty( $group_id ) && bp_get_new_group_id() ) {&nbsp;</div></li><li><div>          $group_id = bp_get_new_group_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// On some setups, the group id has to be fetched out of the</span>&nbsp;</div></li><li><div>      <span class="comment">// $_POST array</span>&nbsp;</div></li><li><div>      <span class="comment">// @todo Figure out why this is happening during group creation.</span>&nbsp;</div></li><li><div>      if ( empty( $group_id ) && isset( $_POST['group_id'] ) ) {&nbsp;</div></li><li><div>          $group_id = (int) $_POST['group_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $group_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gather configuration data about your screens.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function get_default_screens() {&nbsp;</div></li><li><div>      $this-&gt;setup_class_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $screens = array(&nbsp;</div></li><li><div>          'create' =&gt; array(&nbsp;</div></li><li><div>              'position' =&gt; 81, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'edit' =&gt; array(&nbsp;</div></li><li><div>              'submit_text' =&gt; __( 'Save Changes', 'buddypress' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'admin' =&gt; array(&nbsp;</div></li><li><div>              'metabox_context' =&gt; 'normal', &nbsp;</div></li><li><div>              'metabox_priority' =&gt; 'core', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $screens as $context =&gt; &$screen ) {&nbsp;</div></li><li><div>          $screen['enabled'] = true;&nbsp;</div></li><li><div>          $screen['name'] = $this-&gt;name;&nbsp;</div></li><li><div>          $screen['slug'] = $this-&gt;slug;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $screen['screen_callback'] = $this-&gt;get_screen_callback( $context, 'screen' );&nbsp;</div></li><li><div>          $screen['screen_save_callback'] = $this-&gt;get_screen_callback( $context, 'screen_save' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $screens;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up screens array based on params.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_screens() {&nbsp;</div></li><li><div>      foreach ( (array) $this-&gt;params['screens'] as $context =&gt; $screen ) {&nbsp;</div></li><li><div>          if ( empty( $screen['slug'] ) ) {&nbsp;</div></li><li><div>              $screen['slug'] = $this-&gt;slug;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $screen['name'] ) ) {&nbsp;</div></li><li><div>              $screen['name'] = $this-&gt;name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;screens[ $context ] = $screen;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up access-related settings for this extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_access_settings() {&nbsp;</div></li><li><div>      <span class="comment">// Bail if no group ID is available.</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;group_id ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backward compatibility.</span>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;params['enable_nav_item'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;enable_nav_item = (bool) $this-&gt;params['enable_nav_item'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Tab Access.</span>&nbsp;</div></li><li><div>      $this-&gt;user_can_visit = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Backward compatibility for components that do not provide</span></span>&nbsp;</div></li><li><div>      <span class="comment">// explicit 'access' parameter.</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;params['access'] ) ) {&nbsp;</div></li><li><div>          if ( false === $this-&gt;enable_nav_item ) {&nbsp;</div></li><li><div>              $this-&gt;params['access'] = 'noone';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $group = groups_get_group( $this-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $group-&gt;status ) && 'public' === $group-&gt;status ) {&nbsp;</div></li><li><div>                  <span class="comment">// Tabs in public groups are accessible to anyone by default.</span>&nbsp;</div></li><li><div>                  $this-&gt;params['access'] = 'anyone';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// All other groups have members-only as the default.</span>&nbsp;</div></li><li><div>                  $this-&gt;params['access'] = 'member';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Parse multiple access conditions into an array.</span></span>&nbsp;</div></li><li><div>      $access_conditions = $this-&gt;params['access'];&nbsp;</div></li><li><div>      if ( ! is_array( $access_conditions ) ) {&nbsp;</div></li><li><div>          $access_conditions = explode( ', ', $access_conditions );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If the current user meets at least one condition, the</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// get access.</span></span>&nbsp;</div></li><li><div>      foreach ( $access_conditions as $access_condition ) {&nbsp;</div></li><li><div>          if ( $this-&gt;user_meets_access_condition( $access_condition ) ) {&nbsp;</div></li><li><div>              $this-&gt;user_can_visit = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Tab Visibility.</span>&nbsp;</div></li><li><div>      $this-&gt;user_can_see_nav_item = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Backward compatibility for components that do not provide</span></span>&nbsp;</div></li><li><div>      <span class="comment">// explicit 'show_tab' parameter.</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;params['show_tab'] ) ) {&nbsp;</div></li><li><div>          if ( false === $this-&gt;params['enable_nav_item'] ) {&nbsp;</div></li><li><div>              <span class="comment">// The enable_nav_item index is only false if it's been</span>&nbsp;</div></li><li><div>              <span class="comment">// defined explicitly as such in the</span>&nbsp;</div></li><li><div>              <span class="comment">// constructor. So we always trust this value.</span>&nbsp;</div></li><li><div>              $this-&gt;params['show_tab'] = 'noone';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif ( isset( $this-&gt;params_raw['enable_nav_item'] ) || isset( $this-&gt;params_raw['visibility'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">// If enable_nav_item or visibility is passed, </span>&nbsp;</div></li><li><div>              <span class="comment">// we assume this  is a legacy extension.</span>&nbsp;</div></li><li><div>              <span class="comment">// Legacy behavior is that enable_nav_item=true +</span>&nbsp;</div></li><li><div>              <span class="comment">// visibility=private implies members-only.</span>&nbsp;</div></li><li><div>              if ( 'public' !== $this-&gt;visibility ) {&nbsp;</div></li><li><div>                  $this-&gt;params['show_tab'] = 'member';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;params['show_tab'] = 'anyone';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// No show_tab or enable_nav_item value is</span>&nbsp;</div></li><li><div>              <span class="comment">// available, so match the value of 'access'.</span>&nbsp;</div></li><li><div>              $this-&gt;params['show_tab'] = $this-&gt;params['access'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Parse multiple access conditions into an array.</span></span>&nbsp;</div></li><li><div>      $access_conditions = $this-&gt;params['show_tab'];&nbsp;</div></li><li><div>      if ( ! is_array( $access_conditions ) ) {&nbsp;</div></li><li><div>          $access_conditions = explode( ', ', $access_conditions );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If the current user meets at least one condition, the</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// get access.</span></span>&nbsp;</div></li><li><div>      foreach ( $access_conditions as $access_condition ) {&nbsp;</div></li><li><div>          if ( $this-&gt;user_meets_access_condition( $access_condition ) ) {&nbsp;</div></li><li><div>              $this-&gt;user_can_see_nav_item = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check whether the current user meets an access condition.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $access_condition 'anyone', 'loggedin', 'member', </span>&nbsp;</div></li><li><div><span class="comment">   *                                 'mod', 'admin' or 'noone'.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function user_meets_access_condition( $access_condition ) {&nbsp;</div></li><li><div>      $group = groups_get_group( $this-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $access_condition ) {&nbsp;</div></li><li><div>          case 'admin' :&nbsp;</div></li><li><div>              $meets_condition = groups_is_user_admin( bp_loggedin_user_id(), $this-&gt;group_id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'mod' :&nbsp;</div></li><li><div>              $meets_condition = groups_is_user_mod( bp_loggedin_user_id(), $this-&gt;group_id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'member' :&nbsp;</div></li><li><div>              $meets_condition = groups_is_user_member( bp_loggedin_user_id(), $this-&gt;group_id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'loggedin' :&nbsp;</div></li><li><div>              $meets_condition = is_user_logged_in();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'noone' :&nbsp;</div></li><li><div>              $meets_condition = false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'anyone' :&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $meets_condition = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $meets_condition;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Display ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook this extension's group tab into BuddyPress, if necessary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_display_hooks() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if not a group.</span>&nbsp;</div></li><li><div>      if ( ! bp_is_group() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backward compatibility only.</span>&nbsp;</div></li><li><div>      if ( ( 'public' !== $this-&gt;visibility ) && ! buddypress()-&gt;groups-&gt;current_group-&gt;user_has_access ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the user can see the nav item, we create it.</span>&nbsp;</div></li><li><div>      $user_can_see_nav_item = $this-&gt;user_can_see_nav_item();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $user_can_see_nav_item ) {&nbsp;</div></li><li><div>          $group_permalink = bp_get_group_permalink( groups_get_current_group() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_create_subnav_link( array(&nbsp;</div></li><li><div>              'name' =&gt; ! $this-&gt;nav_item_name ? $this-&gt;name : $this-&gt;nav_item_name, &nbsp;</div></li><li><div>              'slug' =&gt; $this-&gt;slug, &nbsp;</div></li><li><div>              'parent_slug' =&gt; bp_get_current_group_slug(), &nbsp;</div></li><li><div>              'parent_url' =&gt; $group_permalink, &nbsp;</div></li><li><div>              'position' =&gt; $this-&gt;nav_item_position, &nbsp;</div></li><li><div>              'item_css_id' =&gt; 'nav-' . $this-&gt;slug, &nbsp;</div></li><li><div>              'screen_function' =&gt; array( &$this, '_display_hook' ), &nbsp;</div></li><li><div>              'user_has_access' =&gt; $user_can_see_nav_item, &nbsp;</div></li><li><div>              'no_access_url' =&gt; $group_permalink, &nbsp;</div></li><li><div> ), 'groups' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the user can visit the screen, we register it.</span>&nbsp;</div></li><li><div>      $user_can_visit = $this-&gt;user_can_visit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $user_can_visit ) {&nbsp;</div></li><li><div>          $group_permalink = bp_get_group_permalink( groups_get_current_group() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_register_subnav_screen_function( array(&nbsp;</div></li><li><div>              'slug' =&gt; $this-&gt;slug, &nbsp;</div></li><li><div>              'parent_slug' =&gt; bp_get_current_group_slug(), &nbsp;</div></li><li><div>              'screen_function' =&gt; array( &$this, '_display_hook' ), &nbsp;</div></li><li><div>              'user_has_access' =&gt; $user_can_visit, &nbsp;</div></li><li><div>              'no_access_url' =&gt; $group_permalink, &nbsp;</div></li><li><div> ), 'groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// When we are viewing the extension display page, set the title and options title.</span>&nbsp;</div></li><li><div>          if ( bp_is_current_action( $this-&gt;slug ) ) {&nbsp;</div></li><li><div>              add_filter( 'bp_group_user_has_access', array( $this, 'group_access_protection' ), 10, 2 );&nbsp;</div></li><li><div>              add_action( 'bp_template_content_header', create_function( '', 'echo &quot;' . esc_attr( $this-&gt;name ) . '&quot;;' ) );&nbsp;</div></li><li><div>              add_action( 'bp_template_title', create_function( '', 'echo &quot;' . esc_attr( $this-&gt;name ) . '&quot;;' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook the group home widget.</span>&nbsp;</div></li><li><div>      if ( bp_is_group_home() ) {&nbsp;</div></li><li><div>          add_action( $this-&gt;display_hook, array( &$this, 'widget_display' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook the main display method, and loads the template file.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function _display_hook() {&nbsp;</div></li><li><div>      add_action( 'bp_template_content', array( &$this, 'call_display' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the template to load for the main display method.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $template_file Path to the template to load.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      bp_core_load_template( apply_filters( 'bp_core_template_plugin', $this-&gt;template_file ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Call the display() method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We use this wrapper so that we can pass the group_id to the</span>&nbsp;</div></li><li><div><span class="comment">   * display() callback.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_display() {&nbsp;</div></li><li><div>      $this-&gt;display( $this-&gt;group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determine whether the current user should see this nav tab.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note that this controls only the display of the navigation item.</span>&nbsp;</div></li><li><div><span class="comment">   * Access to the tab is controlled by the user_can_visit() check.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $user_can_see_nav_item Whether or not the user can see the nav item.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_can_see_nav_item( $user_can_see_nav_item = false ) {&nbsp;</div></li><li><div>      if ( 'noone' !== $this-&gt;params['show_tab'] && current_user_can( 'bp_moderate' ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;user_can_see_nav_item;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determine whether the current user has access to visit this tab.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $user_can_visit Whether or not the user can visit the tab.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_can_visit( $user_can_visit = false ) {&nbsp;</div></li><li><div>      if ( 'noone' !== $this-&gt;params['access'] && current_user_can( 'bp_moderate' ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;user_can_visit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the access check in bp_groups_group_access_protection() for this extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note that $no_access_args is passed by reference, as there are some</span>&nbsp;</div></li><li><div><span class="comment">   * circumstances where the bp_core_no_access() arguments need to be</span>&nbsp;</div></li><li><div><span class="comment">   * modified before the redirect takes place.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $user_can_visit Whether or not the user can visit the tab.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $no_access_args Array of args to help determine access.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function group_access_protection( $user_can_visit, &$no_access_args ) {&nbsp;</div></li><li><div>      $user_can_visit = $this-&gt;user_can_visit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $user_can_visit && is_user_logged_in() ) {&nbsp;</div></li><li><div>          $current_group = groups_get_group( $this-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $no_access_args['message'] = __( 'You do not have access to this content.', 'buddypress' );&nbsp;</div></li><li><div>          $no_access_args['root'] = bp_get_group_permalink( $current_group ) . 'home/';&nbsp;</div></li><li><div>          $no_access_args['redirect'] = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $user_can_visit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Create ************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook this extension's Create step into BuddyPress, if necessary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_create_hooks() {&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_screen_enabled( 'create' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $screen = $this-&gt;screens['create'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Insert the group creation step for the new group extension.</span>&nbsp;</div></li><li><div>      buddypress()-&gt;groups-&gt;group_creation_steps[ $screen['slug'] ] = array(&nbsp;</div></li><li><div>          'name' =&gt; $screen['name'], &nbsp;</div></li><li><div>          'slug' =&gt; $screen['slug'], &nbsp;</div></li><li><div>          'position' =&gt; $screen['position'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The maybe_ methods check to see whether the create_*</span>&nbsp;</div></li><li><div>      <span class="comment">// callbacks should be invoked (ie, are we on the</span>&nbsp;</div></li><li><div>      <span class="comment">// correct group creation step). Hooked in separate</span>&nbsp;</div></li><li><div>      <span class="comment">// methods because current creation step info not yet</span>&nbsp;</div></li><li><div>      <span class="comment">// available at this point.</span>&nbsp;</div></li><li><div>      add_action( 'groups_custom_create_steps', array( $this, 'maybe_create_screen' ) );&nbsp;</div></li><li><div>      add_action( 'groups_create_group_step_save_' . $screen['slug'], array( $this, 'maybe_create_screen_save' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Call the create_screen() method, if we're on the right page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_create_screen() {&nbsp;</div></li><li><div>      if ( ! bp_is_group_creation_step( $this-&gt;screens['create']['slug'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['create']['screen_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>      $this-&gt;nonce_field( 'create' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The create screen requires an additional nonce field</span>&nbsp;</div></li><li><div>      <span class="comment">// due to a quirk in the way the templates are built.</span>&nbsp;</div></li><li><div>      wp_nonce_field( 'groups_create_save_' . bp_get_groups_current_create_step(), '_wpnonce', false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Call the create_screen_save() method, if we're on the right page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_create_screen_save() {&nbsp;</div></li><li><div>      if ( ! bp_is_group_creation_step( $this-&gt;screens['create']['slug'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_nonce( 'create' );&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['create']['screen_save_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Edit **************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook this extension's Edit panel into BuddyPress, if necessary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_edit_hooks() {&nbsp;</div></li><li><div>      <span class="comment">// Bail if not in a group.</span>&nbsp;</div></li><li><div>      if ( ! bp_is_group() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if not an edit screen.</span>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_screen_enabled( 'edit' ) || ! bp_is_item_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $screen = $this-&gt;screens['edit'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $position = isset( $screen['position'] ) ? (int) $screen['position'] : 10;&nbsp;</div></li><li><div>      $position += 40;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_group = groups_get_current_group();&nbsp;</div></li><li><div>      $admin_link = trailingslashit( bp_get_group_permalink( $current_group ) . 'admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subnav_args = array(&nbsp;</div></li><li><div>          'name' =&gt; $screen['name'], &nbsp;</div></li><li><div>          'slug' =&gt; $screen['slug'], &nbsp;</div></li><li><div>          'parent_slug' =&gt; $current_group-&gt;slug . '_manage', &nbsp;</div></li><li><div>          'parent_url' =&gt; trailingslashit( bp_get_group_permalink( $current_group ) . 'admin' ), &nbsp;</div></li><li><div>          'user_has_access' =&gt; bp_is_item_admin(), &nbsp;</div></li><li><div>          'position' =&gt; $position, &nbsp;</div></li><li><div>          'screen_function' =&gt; 'groups_screen_group_admin', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Should we add a menu to the Group's WP Admin Bar.</span>&nbsp;</div></li><li><div>      if ( ! empty( $screen['show_in_admin_bar'] ) ) {&nbsp;</div></li><li><div>          $subnav_args['show_in_admin_bar'] = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the tab to the manage navigation.</span>&nbsp;</div></li><li><div>      bp_core_new_subnav_item( $subnav_args, 'groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Catch the edit screen and forward it to the plugin template.</span>&nbsp;</div></li><li><div>      if ( bp_is_groups_component() && bp_is_current_action( 'admin' ) && bp_is_action_variable( $screen['slug'], 0 ) ) {&nbsp;</div></li><li><div>          $this-&gt;call_edit_screen_save( $this-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'groups_custom_edit_steps', array( &$this, 'call_edit_screen' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Determine the proper template and save for later</span>&nbsp;</div></li><li><div>          <span class="comment">// loading.</span>&nbsp;</div></li><li><div>          if ( '' !== bp_locate_template( array( 'groups/single/home.php' ), false ) ) {&nbsp;</div></li><li><div>              $this-&gt;edit_screen_template = '/groups/single/home';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              add_action( 'bp_template_content_header', function() {&nbsp;</div></li><li><div>                  echo '&lt;ul class=&quot;content-header-nav&quot;&gt;';&nbsp;</div></li><li><div>                  bp_group_admin_tabs();&nbsp;</div></li><li><div>                  echo '&lt;/ul&gt;';&nbsp;</div></li><li><div>              } );&nbsp;</div></li><li><div>              add_action( 'bp_template_content', array( &$this, 'call_edit_screen' ) );&nbsp;</div></li><li><div>              $this-&gt;edit_screen_template = '/groups/single/plugins';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We load the template at bp_screens, to give all</span>&nbsp;</div></li><li><div>          <span class="comment">// extensions a chance to load.</span>&nbsp;</div></li><li><div>          add_action( 'bp_screens', array( $this, 'call_edit_screen_template_loader' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Call the edit_screen() method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Previous versions of BP_Group_Extension required plugins to provide</span>&nbsp;</div></li><li><div><span class="comment">   * their own Submit button and nonce fields when building markup. In</span>&nbsp;</div></li><li><div><span class="comment">   * BP 1.8, this requirement was lifted - BP_Group_Extension now handles</span>&nbsp;</div></li><li><div><span class="comment">   * all required submit buttons and nonces.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We put the edit screen markup into an output buffer before echoing.</span>&nbsp;</div></li><li><div><span class="comment">   * This is so that we can check for the presence of a hardcoded submit</span>&nbsp;</div></li><li><div><span class="comment">   * button, as would be present in legacy plugins; if one is found, we</span>&nbsp;</div></li><li><div><span class="comment">   * do not auto-add our own button.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_edit_screen() {&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['edit']['screen_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>      $screen = ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo $this-&gt;maybe_add_submit_button( $screen );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;nonce_field( 'edit' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the nonce, and call the edit_screen_save() method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_edit_screen_save() {&nbsp;</div></li><li><div>      if ( empty( $_POST ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// When DOING_AJAX, the POST global will be populated, but we</span>&nbsp;</div></li><li><div>      <span class="comment">// should assume it's a save.</span>&nbsp;</div></li><li><div>      if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_nonce( 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Detect whether the screen_save_callback is performing a</span>&nbsp;</div></li><li><div>      <span class="comment">// redirect, so that we don't do one of our own.</span>&nbsp;</div></li><li><div>      add_filter( 'wp_redirect', array( $this, 'detect_post_save_redirect' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Call the extension's save routine.</span>&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['edit']['screen_save_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clean up detection filters.</span>&nbsp;</div></li><li><div>      remove_filter( 'wp_redirect', array( $this, 'detect_post_save_redirect' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Perform a redirect only if one has not already taken place.</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;post_save_redirect ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the URL to redirect to after group edit screen save.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Only runs if a redirect has not already occurred.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $value URL to redirect to.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $redirect_to = apply_filters( 'bp_group_extension_edit_screen_save_redirect', bp_get_requested_url( ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_redirect( $redirect_to );&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Load the template that houses the Edit screen.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Separated out into a callback so that it can run after all other</span>&nbsp;</div></li><li><div><span class="comment">   * Group Extensions have had a chance to register their navigation, to</span>&nbsp;</div></li><li><div><span class="comment">   * avoid missing tabs.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Hooked to 'bp_screens'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see BP_Group_Extension::setup_edit_hooks()</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_edit_screen_template_loader() {&nbsp;</div></li><li><div>      bp_core_load_template( $this-&gt;edit_screen_template );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a submit button to the edit form, if it needs one.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * There's an inconsistency in the way that the group Edit and Create</span>&nbsp;</div></li><li><div><span class="comment">   * screens are rendered: the Create screen has a submit button built</span>&nbsp;</div></li><li><div><span class="comment">   * in, but the Edit screen does not. This function allows plugin</span>&nbsp;</div></li><li><div><span class="comment">   * authors to write markup that does not contain the submit button for</span>&nbsp;</div></li><li><div><span class="comment">   * use on both the Create and Edit screens - BP will provide the button</span>&nbsp;</div></li><li><div><span class="comment">   * if one is not found.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $screen The screen markup, captured in the output</span>&nbsp;</div></li><li><div><span class="comment">   *                       buffer.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $screen The same markup, with a submit button added.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function maybe_add_submit_button( $screen = '' ) {&nbsp;</div></li><li><div>      if ( $this-&gt;has_submit_button( $screen ) ) {&nbsp;</div></li><li><div>          return $screen;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $screen . sprintf(&nbsp;</div></li><li><div>          '&lt;div id=&quot;%s&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;save&quot; value=&quot;%s&quot; id=&quot;%s&quot;&gt;&lt;/div&gt;', &nbsp;</div></li><li><div>          'bp-group-edit-' . $this-&gt;slug . '-submit-wrapper', &nbsp;</div></li><li><div>          $this-&gt;screens['edit']['submit_text'], &nbsp;</div></li><li><div>          'bp-group-edit-' . $this-&gt;slug . '-submit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Does the given markup have a submit button?</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $screen The markup to check.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if a Submit button is found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function has_submit_button( $screen = '' ) {&nbsp;</div></li><li><div>      $pattern = &quot;/&lt;input[^&gt;]+type=[\'\&quot;]submit[\'\&quot;]/&quot;;&nbsp;</div></li><li><div>      preg_match( $pattern, $screen, $matches );&nbsp;</div></li><li><div>      return ! empty( $matches[0] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Detect redirects hardcoded into edit_screen_save() callbacks.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $redirect Redirect string.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function detect_post_save_redirect( $redirect = '' ) {&nbsp;</div></li><li><div>      if ( ! empty( $redirect ) ) {&nbsp;</div></li><li><div>          $this-&gt;post_save_redirect = $redirect;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $redirect;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Admin *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook this extension's Admin metabox into BuddyPress, if necessary.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_admin_hooks() {&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_screen_enabled( 'admin' ) || ! is_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hook the admin screen markup function to the content hook.</span>&nbsp;</div></li><li><div>      add_action( 'bp_groups_admin_meta_box_content_' . $this-&gt;slug, array( $this, 'call_admin_screen' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Initialize the metabox.</span>&nbsp;</div></li><li><div>      add_action( 'bp_groups_admin_meta_boxes', array( $this, '_meta_box_display_callback' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Catch the metabox save.</span>&nbsp;</div></li><li><div>      add_action( 'bp_group_admin_edit_after', array( $this, 'call_admin_screen_save' ), 10 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Call the admin_screen() method, and add a nonce field.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_admin_screen() {&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['admin']['screen_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>      $this-&gt;nonce_field( 'admin' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the nonce, and call the admin_screen_save() method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function call_admin_screen_save() {&nbsp;</div></li><li><div>      $this-&gt;check_nonce( 'admin' );&nbsp;</div></li><li><div>      call_user_func( $this-&gt;screens['admin']['screen_save_callback'], $this-&gt;group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create the Dashboard meta box for this extension.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function _meta_box_display_callback() {&nbsp;</div></li><li><div>      $group_id = isset( $_GET['gid'] ) ? (int) $_GET['gid'] : 0;&nbsp;</div></li><li><div>      $screen = $this-&gt;screens['admin'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_meta_box(&nbsp;</div></li><li><div>          $screen['slug'], &nbsp;</div></li><li><div>          $screen['name'], &nbsp;</div></li><li><div>          create_function( '', 'do_action( &quot;bp_groups_admin_meta_box_content_' . $this-&gt;slug . '&quot;, ' . $group_id . ' );' ), &nbsp;</div></li><li><div>          get_current_screen()-&gt;id, &nbsp;</div></li><li><div>          $screen['metabox_context'], &nbsp;</div></li><li><div>          $screen['metabox_priority']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Utilities *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate the nonce fields for a settings form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The nonce field name (the second param passed to wp_nonce_field)</span>&nbsp;</div></li><li><div><span class="comment">   * contains this extension's slug and is thus unique to this extension.</span>&nbsp;</div></li><li><div><span class="comment">   * This is necessary because in some cases (namely, the Dashboard), </span>&nbsp;</div></li><li><div><span class="comment">   * more than one extension may generate nonces on the same page, and we</span>&nbsp;</div></li><li><div><span class="comment">   * must avoid name clashes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context Screen context. 'create', 'edit', or 'admin'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function nonce_field( $context = '' ) {&nbsp;</div></li><li><div>      wp_nonce_field( 'bp_group_extension_' . $this-&gt;slug . '_' . $context, '_bp_group_' . $context . '_nonce_' . $this-&gt;slug );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the nonce on a submitted settings form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context Screen context. 'create', 'edit', or 'admin'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_nonce( $context = '' ) {&nbsp;</div></li><li><div>      check_admin_referer( 'bp_group_extension_' . $this-&gt;slug . '_' . $context, '_bp_group_' . $context . '_nonce_' . $this-&gt;slug );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Is the specified screen enabled?</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To be enabled, a screen must both have the 'enabled' key set to true</span>&nbsp;</div></li><li><div><span class="comment">   * (legacy: $this-&gt;enable_create_step, etc), and its screen_callback</span>&nbsp;</div></li><li><div><span class="comment">   * must also exist and be callable.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context Screen context. 'create', 'edit', or 'admin'.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if the screen is enabled, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_screen_enabled( $context = '' ) {&nbsp;</div></li><li><div>      $enabled = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;screens[ $context ] ) ) {&nbsp;</div></li><li><div>          $enabled = $this-&gt;screens[ $context ]['enabled'] && is_callable( $this-&gt;screens[ $context ]['screen_callback'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (bool) $enabled;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the appropriate screen callback for the specified context/type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * BP Group Extensions have three special &quot;screen contexts&quot;: create, </span>&nbsp;</div></li><li><div><span class="comment">   * admin, and edit. Each of these contexts has a corresponding</span>&nbsp;</div></li><li><div><span class="comment">   * _screen() and _screen_save() method, which allow group extension</span>&nbsp;</div></li><li><div><span class="comment">   * plugins to define different markup and logic for each context.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * BP also supports fallback settings_screen() and</span>&nbsp;</div></li><li><div><span class="comment">   * settings_screen_save() methods, which can be used to define markup</span>&nbsp;</div></li><li><div><span class="comment">   * and logic that is shared between context. For each context, you may</span>&nbsp;</div></li><li><div><span class="comment">   * either provide context-specific methods, or you can let BP fall back</span>&nbsp;</div></li><li><div><span class="comment">   * on the shared settings_* callbacks.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * For example, consider a BP_Group_Extension implementation that looks</span>&nbsp;</div></li><li><div><span class="comment">   * like this:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *   // ...</span>&nbsp;</div></li><li><div><span class="comment">   *   function create_screen( $group_id ) { ... }</span>&nbsp;</div></li><li><div><span class="comment">   *   function create_screen_save( $group_id ) { ... }</span>&nbsp;</div></li><li><div><span class="comment">   *   function settings_screen( $group_id ) { ... }</span>&nbsp;</div></li><li><div><span class="comment">   *   function settings_screen_save( $group_id ) { ... }</span>&nbsp;</div></li><li><div><span class="comment">   *   // ...</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * BP_Group_Extension will use your create_* methods for the Create</span>&nbsp;</div></li><li><div><span class="comment">   * steps, and will use your generic settings_* methods for the Edit</span>&nbsp;</div></li><li><div><span class="comment">   * and Admin contexts. This schema allows plugin authors maximum</span>&nbsp;</div></li><li><div><span class="comment">   * flexibility without having to repeat themselves.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The get_screen_callback() method uses a ReflectionClass object to</span>&nbsp;</div></li><li><div><span class="comment">   * determine whether your extension has provided a given callback.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context Screen context. 'create', 'edit', or 'admin'.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type    Screen type. 'screen' or 'screen_save'. Default:</span>&nbsp;</div></li><li><div><span class="comment">   *                        'screen'.</span>&nbsp;</div></li><li><div><span class="comment">   * @return callable A callable function handle.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_screen_callback( $context = '', $type = 'screen' ) {&nbsp;</div></li><li><div>      $callback = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Try the context-specific callback first.</span>&nbsp;</div></li><li><div>      $method = $context . '_' . $type;&nbsp;</div></li><li><div>      $rmethod = $this-&gt;class_reflection-&gt;getMethod( $method );&nbsp;</div></li><li><div>      if ( isset( $rmethod-&gt;class ) && $this-&gt;class_name === $rmethod-&gt;class ) {&nbsp;</div></li><li><div>          $callback = array( $this, $method );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $callback ) ) {&nbsp;</div></li><li><div>          $fallback_method = 'settings_' . $type;&nbsp;</div></li><li><div>          $rfallback_method = $this-&gt;class_reflection-&gt;getMethod( $fallback_method );&nbsp;</div></li><li><div>          if ( isset( $rfallback_method-&gt;class ) && $this-&gt;class_name === $rfallback_method-&gt;class ) {&nbsp;</div></li><li><div>              $callback = array( $this, $fallback_method );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $callback;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recursive argument parsing.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This acts like a multi-dimensional version of wp_parse_args() (minus</span>&nbsp;</div></li><li><div><span class="comment">   * the querystring parsing - you must pass arrays).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Values from $a override those from $b; keys in $b that don't exist</span>&nbsp;</div></li><li><div><span class="comment">   * in $a are passed through.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This is different from array_merge_recursive(), both because of the</span>&nbsp;</div></li><li><div><span class="comment">   * order of preference ($a overrides $b) and because of the fact that</span>&nbsp;</div></li><li><div><span class="comment">   * array_merge_recursive() combines arrays deep in the tree, rather</span>&nbsp;</div></li><li><div><span class="comment">   * than overwriting the b array with the a array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The implementation of this function is specific to the needs of</span>&nbsp;</div></li><li><div><span class="comment">   * BP_Group_Extension, where we know that arrays will always be</span>&nbsp;</div></li><li><div><span class="comment">   * associative, and that an argument under a given key in one array</span>&nbsp;</div></li><li><div><span class="comment">   * will be matched by a value of identical depth in the other one. The</span>&nbsp;</div></li><li><div><span class="comment">   * function is NOT designed for general use, and will probably result</span>&nbsp;</div></li><li><div><span class="comment">   * in unexpected results when used with data in the wild. See, eg, </span>&nbsp;</div></li><li><div><span class="comment">   * https://core.trac.wordpress.org/ticket/19888</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $a First set of arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $b Second set of arguments.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Parsed arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function parse_args_r( &$a, $b ) {&nbsp;</div></li><li><div>      $a = (array) $a;&nbsp;</div></li><li><div>      $b = (array) $b;&nbsp;</div></li><li><div>      $r = $b;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $a as $k =&gt; &$v ) {&nbsp;</div></li><li><div>          if ( is_array( $v ) && isset( $r[ $k ] ) ) {&nbsp;</div></li><li><div>              $r[ $k ] = self::parse_args_r( $v, $r[ $k ] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $r[ $k ] = $v;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Legacy Support ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * In BuddyPress 1.8, the recommended technique for configuring</span>&nbsp;</div></li><li><div><span class="comment">   * extensions changed from directly setting various object properties</span>&nbsp;</div></li><li><div><span class="comment">   * in the class constructor, to passing a configuration array to</span>&nbsp;</div></li><li><div><span class="comment">   * parent::init(). The following methods ensure that extensions created</span>&nbsp;</div></li><li><div><span class="comment">   * in the old way continue to work, by converting legacy configuration</span>&nbsp;</div></li><li><div><span class="comment">   * data to the new format.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Provide access to otherwise unavailable object properties.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This magic method is here for backward compatibility with plugins</span>&nbsp;</div></li><li><div><span class="comment">   * that refer to config properties that have moved to a different</span>&nbsp;</div></li><li><div><span class="comment">   * location (such as enable_create_step, which is now at</span>&nbsp;</div></li><li><div><span class="comment">   * $this-&gt;screens['create']['enabled']</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The legacy_properties array is set up in</span>&nbsp;</div></li><li><div><span class="comment">   * self::setup_legacy_properties().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key Property name.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed The value if found, otherwise null.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __get( $key ) {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;legacy_properties[ $key ] ) ) {&nbsp;</div></li><li><div>          return $this-&gt;legacy_properties[ $key ];&nbsp;</div></li><li><div>      } elseif ( isset( $this-&gt;data[ $key ] ) ) {&nbsp;</div></li><li><div>          return $this-&gt;data[ $key ];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Provide a fallback for isset( $this-&gt;foo ) when foo is unavailable.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This magic method is here for backward compatibility with plugins</span>&nbsp;</div></li><li><div><span class="comment">   * that have set their class config options directly in the class</span>&nbsp;</div></li><li><div><span class="comment">   * constructor. The parse_legacy_properties() method of the current</span>&nbsp;</div></li><li><div><span class="comment">   * class needs to check whether any legacy keys have been put into the</span>&nbsp;</div></li><li><div><span class="comment">   * $this-&gt;data array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key Property name.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if the value is set, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __isset( $key ) {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;legacy_properties[ $key ] ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ( isset( $this-&gt;data[ $key ] ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Allow plugins to set otherwise unavailable object properties.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This magic method is here for backward compatibility with plugins</span>&nbsp;</div></li><li><div><span class="comment">   * that may attempt to modify the group extension by manually assigning</span>&nbsp;</div></li><li><div><span class="comment">   * a value to an object property that no longer exists, such as</span>&nbsp;</div></li><li><div><span class="comment">   * $this-&gt;enable_create_step.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key Property name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed  $value Property value.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __set( $key, $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;initialized ) ) {&nbsp;</div></li><li><div>          $this-&gt;data[ $key ] = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $key ) {&nbsp;</div></li><li><div>          case 'enable_create_step' :&nbsp;</div></li><li><div>              $this-&gt;screens['create']['enabled'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'enable_edit_item' :&nbsp;</div></li><li><div>              $this-&gt;screens['edit']['enabled'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'enable_admin_item' :&nbsp;</div></li><li><div>              $this-&gt;screens['admin']['enabled'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'create_step_position' :&nbsp;</div></li><li><div>              $this-&gt;screens['create']['position'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Note: 'admin' becomes 'edit' to distinguish from Dashboard 'admin'.</span></span></span>&nbsp;</div></li><li><div>          case 'admin_name' :&nbsp;</div></li><li><div>              $this-&gt;screens['edit']['name'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'admin_slug' :&nbsp;</div></li><li><div>              $this-&gt;screens['edit']['slug'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'create_name' :&nbsp;</div></li><li><div>              $this-&gt;screens['create']['name'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'create_slug' :&nbsp;</div></li><li><div>              $this-&gt;screens['create']['slug'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'admin_metabox_context' :&nbsp;</div></li><li><div>              $this-&gt;screens['admin']['metabox_context'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'admin_metabox_priority' :&nbsp;</div></li><li><div>              $this-&gt;screens['admin']['metabox_priority'] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $this-&gt;data[ $key ] = $value;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return a list of legacy properties.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The legacy implementation of BP_Group_Extension used all of these</span>&nbsp;</div></li><li><div><span class="comment">   * object properties for configuration. Some have been moved.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array List of legacy property keys.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function get_legacy_property_list() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'name', &nbsp;</div></li><li><div>          'slug', &nbsp;</div></li><li><div>          'admin_name', &nbsp;</div></li><li><div>          'admin_slug', &nbsp;</div></li><li><div>          'create_name', &nbsp;</div></li><li><div>          'create_slug', &nbsp;</div></li><li><div>          'visibility', &nbsp;</div></li><li><div>          'create_step_position', &nbsp;</div></li><li><div>          'nav_item_position', &nbsp;</div></li><li><div>          'admin_metabox_context', &nbsp;</div></li><li><div>          'admin_metabox_priority', &nbsp;</div></li><li><div>          'enable_create_step', &nbsp;</div></li><li><div>          'enable_nav_item', &nbsp;</div></li><li><div>          'enable_edit_item', &nbsp;</div></li><li><div>          'enable_admin_item', &nbsp;</div></li><li><div>          'nav_item_name', &nbsp;</div></li><li><div>          'display_hook', &nbsp;</div></li><li><div>          'template_file', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parse legacy properties.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The old standard for BP_Group_Extension was for plugins to register</span>&nbsp;</div></li><li><div><span class="comment">   * their settings as properties in their constructor. The new method is</span>&nbsp;</div></li><li><div><span class="comment">   * to pass a config array to the init() method. In order to support</span>&nbsp;</div></li><li><div><span class="comment">   * legacy plugins, we slurp up legacy properties, and later on we'll</span>&nbsp;</div></li><li><div><span class="comment">   * parse them into the new init() array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function parse_legacy_properties() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Only run this one time.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;legacy_properties_converted ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $properties = $this-&gt;get_legacy_property_list();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// By-reference variable for convenience.</span>&nbsp;</div></li><li><div>      $lpc =& $this-&gt;legacy_properties_converted;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $properties as $property ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// No legacy config exists for this key.</span>&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;{$property} ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Grab the value and record it as appropriate.</span>&nbsp;</div></li><li><div>          $value = $this-&gt;{$property};&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $property ) {&nbsp;</div></li><li><div>              case 'enable_create_step' :&nbsp;</div></li><li><div>                  $lpc['screens']['create']['enabled'] = (bool) $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'enable_edit_item' :&nbsp;</div></li><li><div>                  $lpc['screens']['edit']['enabled'] = (bool) $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'enable_admin_item' :&nbsp;</div></li><li><div>                  $lpc['screens']['admin']['enabled'] = (bool) $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_step_position' :&nbsp;</div></li><li><div>                  $lpc['screens']['create']['position'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Note: 'admin' becomes 'edit' to distinguish from Dashboard 'admin'.</span></span></span>&nbsp;</div></li><li><div>              case 'admin_name' :&nbsp;</div></li><li><div>                  $lpc['screens']['edit']['name'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_slug' :&nbsp;</div></li><li><div>                  $lpc['screens']['edit']['slug'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_name' :&nbsp;</div></li><li><div>                  $lpc['screens']['create']['name'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_slug' :&nbsp;</div></li><li><div>                  $lpc['screens']['create']['slug'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_metabox_context' :&nbsp;</div></li><li><div>                  $lpc['screens']['admin']['metabox_context'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_metabox_priority' :&nbsp;</div></li><li><div>                  $lpc['screens']['admin']['metabox_priority'] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>                  $lpc[ $property ] = $value;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up legacy properties.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method is responsible for ensuring that all legacy config</span>&nbsp;</div></li><li><div><span class="comment">   * properties are stored in an array $this-&gt;legacy_properties, so that</span>&nbsp;</div></li><li><div><span class="comment">   * they remain available to plugins that reference the variables at</span>&nbsp;</div></li><li><div><span class="comment">   * their old locations.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see BP_Group_Extension::__get()</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setup_legacy_properties() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Only run this one time.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;legacy_properties ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $properties = $this-&gt;get_legacy_property_list();&nbsp;</div></li><li><div>      $params = $this-&gt;params;&nbsp;</div></li><li><div>      $lp =& $this-&gt;legacy_properties;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $properties as $property ) {&nbsp;</div></li><li><div>          switch ( $property ) {&nbsp;</div></li><li><div>              case 'enable_create_step' :&nbsp;</div></li><li><div>                  $lp['enable_create_step'] = $params['screens']['create']['enabled'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'enable_edit_item' :&nbsp;</div></li><li><div>                  $lp['enable_edit_item'] = $params['screens']['edit']['enabled'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'enable_admin_item' :&nbsp;</div></li><li><div>                  $lp['enable_admin_item'] = $params['screens']['admin']['enabled'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_step_position' :&nbsp;</div></li><li><div>                  $lp['create_step_position'] = $params['screens']['create']['position'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Note: 'admin' becomes 'edit' to distinguish from Dashboard 'admin'.</span></span></span>&nbsp;</div></li><li><div>              case 'admin_name' :&nbsp;</div></li><li><div>                  $lp['admin_name'] = $params['screens']['edit']['name'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_slug' :&nbsp;</div></li><li><div>                  $lp['admin_slug'] = $params['screens']['edit']['slug'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_name' :&nbsp;</div></li><li><div>                  $lp['create_name'] = $params['screens']['create']['name'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'create_slug' :&nbsp;</div></li><li><div>                  $lp['create_slug'] = $params['screens']['create']['slug'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_metabox_context' :&nbsp;</div></li><li><div>                  $lp['admin_metabox_context'] = $params['screens']['admin']['metabox_context'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'admin_metabox_priority' :&nbsp;</div></li><li><div>                  $lp['admin_metabox_priority'] = $params['screens']['admin']['metabox_priority'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>                  <span class="comment">// All other items get moved over.</span>&nbsp;</div></li><li><div>                  $lp[ $property ] = $params[ $property ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Also reapply to the object, for backpat.</span>&nbsp;</div></li><li><div>                  $this-&gt;{$property} = $params[ $property ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register a new Group Extension.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $group_extension_class Name of the Extension class.</span>&nbsp;</div></li><li><div><span class="comment"> * @return false|null Returns false on failure, otherwise null.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_register_group_extension( $group_extension_class = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! class_exists( $group_extension_class ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Register the group extension on the bp_init action so we have access</span>&nbsp;</div></li><li><div>  <span class="comment">// to all plugins.</span>&nbsp;</div></li><li><div>  add_action( 'bp_init', function() use ( $group_extension_class ) {&nbsp;</div></li><li><div>      $extension = new $group_extension_class;&nbsp;</div></li><li><div>      add_action( 'bp_actions', array( &$extension, '_register' ), 8 );&nbsp;</div></li><li><div>      add_action( 'admin_init', array( &$extension, '_register' ) );&nbsp;</div></li><li><div>  }, 11 );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>