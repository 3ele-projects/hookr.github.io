<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49021"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-core-bp-core-attachments | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=c2ee3ca3225b51290cb4fc68789e8df5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-core-bp-core-attachments/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-core-bp-core-attachments%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-core-bp-core-attachments%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-core-bp-core-attachments","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-core-bp-core-attachments" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-core-bp-core-attachments</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-core/bp-core-attachments.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Attachments functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Attachments</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if the current WordPress version is using Plupload 2.1.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Plupload 2.1.1 was introduced in WordPress 3.9. Our bp-plupload.js</span>&nbsp;</div></li><li><div><span class="comment"> * script requires it. So we need to make sure the current WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * match with our needs.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if WordPress is 3.9+, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_is_wp_version_supported() {&nbsp;</div></li><li><div>  return (bool) version_compare( bp_get_major_wp_version(), '3.9', '&gt;=' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the Attachments Uploads dir data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $data The data to get. Possible values are: 'dir', 'basedir' & 'baseurl'.</span>&nbsp;</div></li><li><div><span class="comment"> *                     Leave empty to get all datas.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|array The needed Upload dir data.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_uploads_dir_get( $data = '' ) {&nbsp;</div></li><li><div>  $attachments_dir = 'buddypress';&nbsp;</div></li><li><div>  $retval = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'dir' === $data ) {&nbsp;</div></li><li><div>      $retval = $attachments_dir;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $upload_data = bp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Return empty string, if Uploads data are not available.</span>&nbsp;</div></li><li><div>      if ( ! $upload_data ) {&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Build the Upload data array for BuddyPress attachments.</span>&nbsp;</div></li><li><div>      foreach ( $upload_data as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( 'basedir' === $key || 'baseurl' === $key ) {&nbsp;</div></li><li><div>              $upload_data[ $key ] = trailingslashit( $value ) . $attachments_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Fix for HTTPS.</span>&nbsp;</div></li><li><div>              if ( 'baseurl' === $key && is_ssl() ) {&nbsp;</div></li><li><div>                  $upload_data[ $key ] = str_replace( 'http:<span class="comment">//', 'https://', $upload_data[ $key ] );</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              unset( $upload_data[ $key ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the dir to the array.</span>&nbsp;</div></li><li><div>      $upload_data['dir'] = $attachments_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $data ) ) {&nbsp;</div></li><li><div>          $retval = $upload_data;&nbsp;</div></li><li><div>      } elseif ( isset( $upload_data[ $data ] ) ) {&nbsp;</div></li><li><div>          $retval = $upload_data[ $data ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter here to edit the Attachments upload dir data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $retval The needed Upload dir data or the full array of data</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $data   The data requested</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_uploads_dir_get', $retval, $data );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the max upload file size for any attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type A string to inform about the type of attachment</span>&nbsp;</div></li><li><div><span class="comment"> *                     we wish to get the max upload file size for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Max upload file size for any attachment.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_max_upload_file_size( $type = '' ) {&nbsp;</div></li><li><div>  $fileupload_maxk = bp_core_get_root_option( 'fileupload_maxk' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' === $fileupload_maxk ) {&nbsp;</div></li><li><div>      $fileupload_maxk = 5120000; <span class="comment">// 5mb;</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $fileupload_maxk = $fileupload_maxk * 1024;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter here to edit the max upload file size.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $fileupload_maxk Max upload file size for any attachment.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type            The attachment type (eg: 'avatar' or 'cover_image').</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_get_max_upload_file_size', $fileupload_maxk, $type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get allowed types for any attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type The extension types to get.</span>&nbsp;</div></li><li><div><span class="comment"> *                     Default: 'avatar'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The list of allowed extensions for attachments.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_allowed_types( $type = 'avatar' ) {&nbsp;</div></li><li><div>  <span class="comment">// Defaults to BuddyPress supported image extensions.</span>&nbsp;</div></li><li><div>  $exts = array( 'jpeg', 'gif', 'png' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * It's not a BuddyPress feature, get the allowed extensions</span>&nbsp;</div></li><li><div><span class="comment">   * matching the $type requested.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( 'avatar' !== $type && 'cover_image' !== $type ) {&nbsp;</div></li><li><div>      <span class="comment">// Reset the default exts.</span>&nbsp;</div></li><li><div>      $exts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $type ) {&nbsp;</div></li><li><div>          case 'video' :&nbsp;</div></li><li><div>              $exts = wp_get_video_extensions();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'audio' :&nbsp;</div></li><li><div>              $exts = wp_get_video_extensions();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $allowed_mimes = get_allowed_mime_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Search for allowed mimes matching the type.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * Eg: using 'application/vnd.oasis' as the $type</span>&nbsp;</div></li><li><div><span class="comment">               * parameter will get all OpenOffice extensions supported</span>&nbsp;</div></li><li><div><span class="comment">               * by WordPress and allowed for the current user.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if ( '' !== $type ) {&nbsp;</div></li><li><div>                  $allowed_mimes = preg_grep( '/' . addcslashes( $type, '/.+-' ) . '/', $allowed_mimes );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $allowed_types = array_keys( $allowed_mimes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Loop to explode keys using '|'.</span>&nbsp;</div></li><li><div>              foreach ( $allowed_types as $allowed_type ) {&nbsp;</div></li><li><div>                  $t = explode( '|', $allowed_type );&nbsp;</div></li><li><div>                  $exts = array_merge( $exts, (array) $t );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter here to edit the allowed extensions by attachment type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $exts List of allowed extensions.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type The requested file type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_get_allowed_types', $exts, $type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get allowed attachment mime types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type          The extension types to get (Optional).</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $allowed_types List of allowed extensions.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of allowed mime types.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_allowed_mimes( $type = '', $allowed_types = array() ) {&nbsp;</div></li><li><div>  if ( empty( $allowed_types ) ) {&nbsp;</div></li><li><div>      $allowed_types = bp_attachments_get_allowed_types( $type );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $validate_mimes = wp_match_mime_types( join( ', ', $allowed_types ), wp_get_mime_types() );&nbsp;</div></li><li><div>  $allowed_mimes = array_map( 'implode', $validate_mimes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Include jpg type if jpeg is set</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( isset( $allowed_mimes['jpeg'] ) && ! isset( $allowed_mimes['jpg'] ) ) {&nbsp;</div></li><li><div>      $allowed_mimes['jpg'] = $allowed_mimes['jpeg'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $allowed_mimes;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check the uploaded attachment type is allowed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file          Full path to the file.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $filename      The name of the file (may differ from $file due to $file being</span>&nbsp;</div></li><li><div><span class="comment"> *                              in a tmp directory).</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $allowed_mimes The attachment allowed mimes (Required).</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the attachment type is allowed. False otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_check_filetype( $file, $filename, $allowed_mimes ) {&nbsp;</div></li><li><div>  $filetype = wp_check_filetype_and_ext( $file, $filename, $allowed_mimes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $filetype['ext'] ) && ! empty( $filetype['type'] ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Use the absolute path to an image to set an attachment type for a given item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type The attachment type to create (avatar or cover_image). Default: avatar.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $item_id   The ID of the object (Required). Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $object    The object type (eg: group, user, blog) (Required). Default: 'user'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $component The component for the object (eg: groups, xprofile, blogs). Default: ''.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $image     The absolute path to the image (Required). Default: ''.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $crop_w    Crop width. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $crop_h    Crop height. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $crop_x    The horizontal starting point of the crop. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $crop_y    The vertical starting point of the crop. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_create_item_type( $type = 'avatar', $args = array() ) {&nbsp;</div></li><li><div>  if ( empty( $type ) || ( $type !== 'avatar' && $type !== 'cover_image' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'item_id' =&gt; 0, &nbsp;</div></li><li><div>      'object' =&gt; 'user', &nbsp;</div></li><li><div>      'component' =&gt; '', &nbsp;</div></li><li><div>      'image' =&gt; '', &nbsp;</div></li><li><div>      'crop_w' =&gt; 0, &nbsp;</div></li><li><div>      'crop_h' =&gt; 0, &nbsp;</div></li><li><div>      'crop_x' =&gt; 0, &nbsp;</div></li><li><div>      'crop_y' =&gt; 0&nbsp;</div></li><li><div> ), 'create_item_' . $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $r['item_id'] ) || empty( $r['object'] ) || ! file_exists( $r['image'] ) || ! @getimagesize( $r['image'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure the file path is safe.</span>&nbsp;</div></li><li><div>  if ( 0 !== validate_file( $r['image'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the component if not already done.</span>&nbsp;</div></li><li><div>  if ( empty( $r['component'] ) ) {&nbsp;</div></li><li><div>      if ( 'user' === $r['object'] ) {&nbsp;</div></li><li><div>          $r['component'] = 'xprofile';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $r['component'] = $r['object'] . 's';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get allowed mimes for the Attachment type and check the image one is.</span>&nbsp;</div></li><li><div>  $allowed_mimes = bp_attachments_get_allowed_mimes( $type );&nbsp;</div></li><li><div>  $is_allowed = wp_check_filetype( $r['image'], $allowed_mimes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It's not an image.</span>&nbsp;</div></li><li><div>  if ( ! $is_allowed['ext'] ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init the Attachment data.</span>&nbsp;</div></li><li><div>  $attachment_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'avatar' === $type ) {&nbsp;</div></li><li><div>      <span class="comment">// Set crop width for the avatar if not given.</span>&nbsp;</div></li><li><div>      if ( empty( $r['crop_w'] ) ) {&nbsp;</div></li><li><div>          $r['crop_w'] = bp_core_avatar_full_width();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set crop height for the avatar if not given.</span>&nbsp;</div></li><li><div>      if ( empty( $r['crop_h'] ) ) {&nbsp;</div></li><li><div>          $r['crop_h'] = bp_core_avatar_full_height();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_callable( $r['component'] . '_avatar_upload_dir' ) ) {&nbsp;</div></li><li><div>          $dir_args = array( $r['item_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// In case  of xprofile, we need an extra argument.</span>&nbsp;</div></li><li><div>          if ( 'xprofile' === $r['component'] ) {&nbsp;</div></li><li><div>              $dir_args = array( false, $r['item_id'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $attachment_data = call_user_func_array( $r['component'] . '_avatar_upload_dir', $dir_args );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'cover_image' === $type ) {&nbsp;</div></li><li><div>      $attachment_data = bp_attachments_uploads_dir_get();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// The BP Attachments Uploads Dir is not set, stop.</span></span></span>&nbsp;</div></li><li><div>      if ( ! $attachment_data ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Default to members for xProfile.</span>&nbsp;</div></li><li><div>      $object_subdir = 'members';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'xprofile' !== $r['component'] ) {&nbsp;</div></li><li><div>          $object_subdir = sanitize_key( $r['component'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set Subdir.</span>&nbsp;</div></li><li><div>      $attachment_data['subdir'] = $object_subdir . '/' . $r['item_id'] . '/cover-image';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set Path.</span>&nbsp;</div></li><li><div>      $attachment_data['path'] = trailingslashit( $attachment_data['basedir'] ) . $attachment_data['subdir'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $attachment_data['path'] ) || ! isset( $attachment_data['subdir'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It's not a regular upload, we may need to create some folders.</span>&nbsp;</div></li><li><div>  if ( ! is_dir( $attachment_data['path'] ) ) {&nbsp;</div></li><li><div>      if ( ! wp_mkdir_p( $attachment_data['path'] ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the image name and path.</span>&nbsp;</div></li><li><div>  $image_file_name = wp_unique_filename( $attachment_data['path'], basename( $r['image'] ) );&nbsp;</div></li><li><div>  $image_file_path = $attachment_data['path'] . '/' . $image_file_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the image file into the avatar dir.</span>&nbsp;</div></li><li><div>  if ( ! copy( $r['image'], $image_file_path ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init the response.</span>&nbsp;</div></li><li><div>  $created = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It's an avatar, we need to crop it.</span>&nbsp;</div></li><li><div>  if ( 'avatar' === $type ) {&nbsp;</div></li><li><div>      $created = bp_core_avatar_handle_crop( array(&nbsp;</div></li><li><div>          'object' =&gt; $r['object'], &nbsp;</div></li><li><div>          'avatar_dir' =&gt; trim( dirname( $attachment_data['subdir'] ), '/' ), &nbsp;</div></li><li><div>          'item_id' =&gt; (int) $r['item_id'], &nbsp;</div></li><li><div>          'original_file' =&gt; trailingslashit( $attachment_data['subdir'] ) . $image_file_name, &nbsp;</div></li><li><div>          'crop_w' =&gt; $r['crop_w'], &nbsp;</div></li><li><div>          'crop_h' =&gt; $r['crop_h'], &nbsp;</div></li><li><div>          'crop_x' =&gt; $r['crop_x'], &nbsp;</div></li><li><div>          'crop_y' =&gt; $r['crop_y']&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It's a cover image we need to fit it to feature's dimensions.</span>&nbsp;</div></li><li><div>  } elseif ( 'cover_image' === $type ) {&nbsp;</div></li><li><div>      $cover_image = bp_attachments_cover_image_generate_file( array(&nbsp;</div></li><li><div>          'file' =&gt; $image_file_path, &nbsp;</div></li><li><div>          'component' =&gt; $r['component'], &nbsp;</div></li><li><div>          'cover_image_dir' =&gt; $attachment_data['path']&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $created = ! empty( $cover_image['cover_file'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove copied file if it fails.</span>&nbsp;</div></li><li><div>  if ( ! $created ) {&nbsp;</div></li><li><div>      @unlink( $image_file_path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return the response.</span>&nbsp;</div></li><li><div>  return $created;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the url or the path for a type of attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $data whether to get the url or the path.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $object_dir  The object dir (eg: members/groups). Defaults to members.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int    $item_id     The object id (eg: a user or a group id). Defaults to current user.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $type        The type of the attachment which is also the subdir where files are saved.</span>&nbsp;</div></li><li><div><span class="comment"> *                               Defaults to 'cover-image'</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $file        The name of the file.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The url or the path to the attachment, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_attachment( $data = 'url', $args = array() ) {&nbsp;</div></li><li><div>  <span class="comment">// Default value.</span>&nbsp;</div></li><li><div>  $attachment_data = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'object_dir' =&gt; 'members', &nbsp;</div></li><li><div>      'item_id' =&gt; bp_loggedin_user_id(), &nbsp;</div></li><li><div>      'type' =&gt; 'cover-image', &nbsp;</div></li><li><div>      'file' =&gt; '', &nbsp;</div></li><li><div> ), 'attachments_get_attachment_src' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle fetching a BuddyPress image attachment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param null|string $value If null is returned, proceed with default behaviour. Otherwise, value returned verbatim.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $r {</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $object_dir The object dir (eg: members/groups). Defaults to members.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type int    $item_id    The object id (eg: a user or a group id). Defaults to current user.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $type       The type of the attachment which is also the subdir where files are saved.</span>&nbsp;</div></li><li><div><span class="comment">   *                              Defaults to 'cover-image'</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string $file       The name of the file.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $pre_filter = apply_filters( 'bp_attachments_pre_get_attachment', null, $r );&nbsp;</div></li><li><div>  if ( $pre_filter !== null ) {&nbsp;</div></li><li><div>      return $pre_filter;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get BuddyPress Attachments Uploads Dir datas.</span></span>&nbsp;</div></li><li><div>  $bp_attachments_uploads_dir = bp_attachments_uploads_dir_get();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// The BP Attachments Uploads Dir is not set, stop.</span></span></span>&nbsp;</div></li><li><div>  if ( ! $bp_attachments_uploads_dir ) {&nbsp;</div></li><li><div>      return $attachment_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $type_subdir = $r['object_dir'] . '/' . $r['item_id'] . '/' . $r['type'];&nbsp;</div></li><li><div>  $type_dir = trailingslashit( $bp_attachments_uploads_dir['basedir'] ) . $type_subdir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_dir( $type_dir ) ) {&nbsp;</div></li><li><div>      return $attachment_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $r['file'] ) ) {&nbsp;</div></li><li><div>      if ( ! file_exists( trailingslashit( $type_dir ) . $r['file'] ) ) {&nbsp;</div></li><li><div>          return $attachment_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'url' === $data ) {&nbsp;</div></li><li><div>          $attachment_data = trailingslashit( $bp_attachments_uploads_dir['baseurl'] ) . $type_subdir . '/' . $r['file'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $attachment_data = trailingslashit( $type_dir ) . $r['file'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $file = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Open the directory and get the first file.</span>&nbsp;</div></li><li><div>      if ( $att_dir = opendir( $type_dir ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          while ( false !== ( $attachment_file = readdir( $att_dir ) ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Look for the first file having the type in its name.</span>&nbsp;</div></li><li><div>              if ( false !== strpos( $attachment_file, $r['type'] ) && empty( $file ) ) {&nbsp;</div></li><li><div>                  $file = $attachment_file;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $file ) ) {&nbsp;</div></li><li><div>          return $attachment_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'url' === $data ) {&nbsp;</div></li><li><div>          $attachment_data = trailingslashit( $bp_attachments_uploads_dir['baseurl'] ) . $type_subdir . '/' . $file;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $attachment_data = trailingslashit( $type_dir ) . $file;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $attachment_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete an attachment for the given arguments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_attachments_get_attachment() For more information on accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args Array of arguments for the attachment deletion.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the attachment was deleted, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_delete_file( $args = array() ) {&nbsp;</div></li><li><div>  $attachment_path = bp_attachments_get_attachment( 'path', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle deleting an existing BuddyPress attachment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $value Whether or not to delete the BuddyPress attachment.</span>&nbsp;</div></li><li><div><span class="comment">`     * @param array $args Array of arguments for the attachment deletion.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_attachments_pre_delete_file', true, $args ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $attachment_path ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  @unlink( $attachment_path );&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the BuddyPress Plupload settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of BuddyPress Plupload settings.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_plupload_default_settings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $max_upload_size = wp_max_upload_size();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $max_upload_size ) {&nbsp;</div></li><li><div>      $max_upload_size = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'runtimes' =&gt; 'html5, flash, silverlight, html4', &nbsp;</div></li><li><div>      'file_data_name' =&gt; 'file', &nbsp;</div></li><li><div>      'multipart_params' =&gt; array(&nbsp;</div></li><li><div>          'action' =&gt; 'bp_upload_attachment', &nbsp;</div></li><li><div>          '_wpnonce' =&gt; wp_create_nonce( 'bp-uploader' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'url' =&gt; admin_url( 'admin-ajax.php', 'relative' ), &nbsp;</div></li><li><div>      'flash_swf_url' =&gt; includes_url( 'js/plupload/plupload.flash.swf' ), &nbsp;</div></li><li><div>      'silverlight_xap_url' =&gt; includes_url( 'js/plupload/plupload.silverlight.xap' ), &nbsp;</div></li><li><div>      'filters' =&gt; array(&nbsp;</div></li><li><div>          'max_file_size' =&gt; $max_upload_size . 'b', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'multipart' =&gt; true, &nbsp;</div></li><li><div>      'urlstream_upload' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// WordPress is not allowing multi selection for iOs 7 device.. See #29602.</span>&nbsp;</div></li><li><div>  if ( wp_is_mobile() && strpos( $_SERVER['HTTP_USER_AGENT'], 'OS 7_' ) !== false &&&nbsp;</div></li><li><div>      strpos( $_SERVER['HTTP_USER_AGENT'], 'like Mac OS X' ) !== false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults['multi_selection'] = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $settings = array(&nbsp;</div></li><li><div>      'defaults' =&gt; $defaults, &nbsp;</div></li><li><div>      'browser' =&gt; array(&nbsp;</div></li><li><div>          'mobile' =&gt; wp_is_mobile(), &nbsp;</div></li><li><div>          'supported' =&gt; _device_can_upload(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'limitExceeded' =&gt; is_multisite() && ! is_upload_space_available(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the BuddyPress Plupload default settings.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $settings Default Plupload parameters array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_get_plupload_default_settings', $settings );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Builds localization strings for the BuddyPress Uploader scripts.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Plupload default localization strings.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_plupload_l10n() {&nbsp;</div></li><li><div>  <span class="comment">// Localization strings.</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_get_plupload_l10n', array(&nbsp;</div></li><li><div>          'queue_limit_exceeded' =&gt; __( 'You have attempted to queue too many files.', 'buddypress' ), &nbsp;</div></li><li><div>          'file_exceeds_size_limit' =&gt; __( '%s exceeds the maximum upload size for this site.', 'buddypress' ), &nbsp;</div></li><li><div>          'zero_byte_file' =&gt; __( 'This file is empty. Please try another.', 'buddypress' ), &nbsp;</div></li><li><div>          'invalid_filetype' =&gt; __( 'This file type is not allowed. Please try another.', 'buddypress' ), &nbsp;</div></li><li><div>          'not_an_image' =&gt; __( 'This file is not an image. Please try another.', 'buddypress' ), &nbsp;</div></li><li><div>          'image_memory_exceeded' =&gt; __( 'Memory exceeded. Please try another smaller file.', 'buddypress' ), &nbsp;</div></li><li><div>          'image_dimensions_exceeded' =&gt; __( 'This is larger than the maximum size. Please try another.', 'buddypress' ), &nbsp;</div></li><li><div>          'default_error' =&gt; __( 'An error occurred. Please try again later.', 'buddypress' ), &nbsp;</div></li><li><div>          'missing_upload_url' =&gt; __( 'There was a configuration error. Please contact the server administrator.', 'buddypress' ), &nbsp;</div></li><li><div>          'upload_limit_exceeded' =&gt; __( 'You may only upload 1 file.', 'buddypress' ), &nbsp;</div></li><li><div>          'http_error' =&gt; __( 'HTTP error.', 'buddypress' ), &nbsp;</div></li><li><div>          'upload_failed' =&gt; __( 'Upload failed.', 'buddypress' ), &nbsp;</div></li><li><div>          'big_upload_failed' =&gt; __( 'Please try uploading this file with the %1$sbrowser uploader%2$s.', 'buddypress' ), &nbsp;</div></li><li><div>          'big_upload_queued' =&gt; __( '%s exceeds the maximum upload size for the multi-file uploader when used in your browser.', 'buddypress' ), &nbsp;</div></li><li><div>          'io_error' =&gt; __( 'IO error.', 'buddypress' ), &nbsp;</div></li><li><div>          'security_error' =&gt; __( 'Security error.', 'buddypress' ), &nbsp;</div></li><li><div>          'file_cancelled' =&gt; __( 'File canceled.', 'buddypress' ), &nbsp;</div></li><li><div>          'upload_stopped' =&gt; __( 'Upload stopped.', 'buddypress' ), &nbsp;</div></li><li><div>          'dismiss' =&gt; __( 'Dismiss', 'buddypress' ), &nbsp;</div></li><li><div>          'crunching' =&gt; __( 'Crunching&hellip;', 'buddypress' ), &nbsp;</div></li><li><div>          'unique_file_warning' =&gt; __( 'Make sure to upload a unique file', 'buddypress' ), &nbsp;</div></li><li><div>          'error_uploading' =&gt; __( '&#8220;%s&#8221; has failed to upload.', 'buddypress' ), &nbsp;</div></li><li><div>          'has_avatar_warning' =&gt; __( 'If you&#39;d like to delete the existing profile photo but not upload a new one, please use the delete tab.', 'buddypress' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Enqueues the script needed for the Uploader UI.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Attachment::script_data() && BP_Attachment_Avatar::script_data() for examples showing how</span>&nbsp;</div></li><li><div><span class="comment"> * to set specific script data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $class Name of the class extending BP_Attachment (eg: BP_Attachment_Avatar).</span>&nbsp;</div></li><li><div><span class="comment"> * @return null|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_enqueue_scripts( $class = '' ) {&nbsp;</div></li><li><div>  <span class="comment">// Enqueue me just once per page, please.</span>&nbsp;</div></li><li><div>  if ( did_action( 'bp_attachments_enqueue_scripts' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $class || ! class_exists( $class ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'missing_parameter' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get an instance of the class and get the script data.</span>&nbsp;</div></li><li><div>  $attachment = new $class;&nbsp;</div></li><li><div>  $script_data = $attachment-&gt;script_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = bp_parse_args( $script_data, array(&nbsp;</div></li><li><div>      'action' =&gt; '', &nbsp;</div></li><li><div>      'file_data_name' =&gt; '', &nbsp;</div></li><li><div>      'max_file_size' =&gt; 0, &nbsp;</div></li><li><div>      'browse_button' =&gt; 'bp-browse-button', &nbsp;</div></li><li><div>      'container' =&gt; 'bp-upload-ui', &nbsp;</div></li><li><div>      'drop_element' =&gt; 'drag-drop-area', &nbsp;</div></li><li><div>      'bp_params' =&gt; array(), &nbsp;</div></li><li><div>      'extra_css' =&gt; array(), &nbsp;</div></li><li><div>      'extra_js' =&gt; array(), &nbsp;</div></li><li><div>      'feedback_messages' =&gt; array(), &nbsp;</div></li><li><div> ), 'attachments_enqueue_scripts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $args['action'] ) || empty( $args['file_data_name'] ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'missing_parameter' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the BuddyPress uploader strings.</span>&nbsp;</div></li><li><div>  $strings = bp_attachments_get_plupload_l10n();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the BuddyPress uploader settings.</span>&nbsp;</div></li><li><div>  $settings = bp_attachments_get_plupload_default_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set feedback messages.</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['feedback_messages'] ) ) {&nbsp;</div></li><li><div>      $strings['feedback_messages'] = $args['feedback_messages'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use a temporary var to ease manipulation.</span>&nbsp;</div></li><li><div>  $defaults = $settings['defaults'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the upload action.</span>&nbsp;</div></li><li><div>  $defaults['multipart_params']['action'] = $args['action'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set BuddyPress upload parameters if provided.</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['bp_params'] ) ) {&nbsp;</div></li><li><div>      $defaults['multipart_params']['bp_params'] = $args['bp_params'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge other arguments.</span>&nbsp;</div></li><li><div>  $ui_args = array_intersect_key( $args, array(&nbsp;</div></li><li><div>      'file_data_name' =&gt; true, &nbsp;</div></li><li><div>      'browse_button' =&gt; true, &nbsp;</div></li><li><div>      'container' =&gt; true, &nbsp;</div></li><li><div>      'drop_element' =&gt; true, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array_merge( $defaults, $ui_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $args['max_file_size'] ) ) {&nbsp;</div></li><li><div>      $defaults['filters']['max_file_size'] = $args['max_file_size'] . 'b';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Specific to BuddyPress Avatars.</span>&nbsp;</div></li><li><div>  if ( 'bp_avatar_upload' === $defaults['multipart_params']['action'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Include the cropping informations for avatars.</span>&nbsp;</div></li><li><div>      $settings['crop'] = array(&nbsp;</div></li><li><div>          'full_h' =&gt; bp_core_avatar_full_height(), &nbsp;</div></li><li><div>          'full_w' =&gt; bp_core_avatar_full_width(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Avatar only need 1 file and 1 only!</span>&nbsp;</div></li><li><div>      $defaults['multi_selection'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Does the object already has an avatar set.</span>&nbsp;</div></li><li><div>      $has_avatar = $defaults['multipart_params']['bp_params']['has_avatar'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// What is the object the avatar belongs to.</span>&nbsp;</div></li><li><div>      $object = $defaults['multipart_params']['bp_params']['object'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Init the Avatar nav.</span>&nbsp;</div></li><li><div>      $avatar_nav = array(&nbsp;</div></li><li><div>          'upload' =&gt; array( 'id' =&gt; 'upload', 'caption' =&gt; __( 'Upload', 'buddypress' ), 'order' =&gt; 0 ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The delete view will only show if the object has an avatar.</span>&nbsp;</div></li><li><div>          'delete' =&gt; array( 'id' =&gt; 'delete', 'caption' =&gt; __( 'Delete', 'buddypress' ), 'order' =&gt; 100, 'hide' =&gt; (int) ! $has_avatar ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Create the Camera Nav if the WebCam capture feature is enabled.</span>&nbsp;</div></li><li><div>      if ( bp_avatar_use_webcam() && 'user' === $object ) {&nbsp;</div></li><li><div>          $avatar_nav['camera'] = array( 'id' =&gt; 'camera', 'caption' =&gt; __( 'Take Photo', 'buddypress' ), 'order' =&gt; 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Set warning messages.</span></span>&nbsp;</div></li><li><div>          $strings['camera_warnings'] = array(&nbsp;</div></li><li><div>              'requesting' =&gt; __( 'Please allow us to access to your camera.', 'buddypress'), &nbsp;</div></li><li><div>              'loading' =&gt; __( 'Please wait as we access your camera.', 'buddypress' ), &nbsp;</div></li><li><div>              'loaded' =&gt; __( 'Camera loaded. Click on the &quot;Capture&quot; button to take your photo.', 'buddypress' ), &nbsp;</div></li><li><div>              'noaccess' =&gt; __( 'It looks like you do not have a webcam or we were unable to get permission to use your webcam. Please upload a photo instead.', 'buddypress' ), &nbsp;</div></li><li><div>              'errormsg' =&gt; __( 'Your browser is not supported. Please upload a photo instead.', 'buddypress' ), &nbsp;</div></li><li><div>              'videoerror' =&gt; __( 'Video error. Please upload a photo instead.', 'buddypress' ), &nbsp;</div></li><li><div>              'ready' =&gt; __( 'Your profile photo is ready. Click on the &quot;Save&quot; button to use this photo.', 'buddypress' ), &nbsp;</div></li><li><div>              'nocapture' =&gt; __( 'No photo was captured. Click on the &quot;Capture&quot; button to take your photo.', 'buddypress' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Use this filter to add a navigation to a custom tool to set the object's avatar.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $avatar_nav {</span>&nbsp;</div></li><li><div><span class="comment">       *     An associative array of available nav items where each item is an array organized this way:</span>&nbsp;</div></li><li><div><span class="comment">       *     $avatar_nav[ $nav_item_id ].</span>&nbsp;</div></li><li><div><span class="comment">       *     @type string $nav_item_id The nav item id in lower case without special characters or space.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type string $caption     The name of the item nav that will be displayed in the nav.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type int    $order       An integer to specify the priority of the item nav, choose one.</span>&nbsp;</div></li><li><div><span class="comment">       *                               between 1 and 99 to be after the uploader nav item and before the delete nav item.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type int    $hide        If set to 1 the item nav will be hidden</span>&nbsp;</div></li><li><div><span class="comment">       *                               (only used for the delete nav item).</span>&nbsp;</div></li><li><div><span class="comment">       * }</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $object The object the avatar belongs to (eg: user or group).</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $settings['nav'] = bp_sort_by_key( apply_filters( 'bp_attachments_avatar_nav', $avatar_nav, $object ), 'order', 'num' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Specific to BuddyPress cover images.</span>&nbsp;</div></li><li><div>  } elseif ( 'bp_cover_image_upload' === $defaults['multipart_params']['action'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cover images only need 1 file and 1 only!</span>&nbsp;</div></li><li><div>      $defaults['multi_selection'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Default cover component is xprofile.</span>&nbsp;</div></li><li><div>      $cover_component = 'xprofile';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the object we're editing the cover image of.</span>&nbsp;</div></li><li><div>      $object = $defaults['multipart_params']['bp_params']['object'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the cover component according to the object.</span>&nbsp;</div></li><li><div>      if ( 'group' === $object ) {&nbsp;</div></li><li><div>          $cover_component = 'groups';&nbsp;</div></li><li><div>      } elseif ( 'user' !== $object ) {&nbsp;</div></li><li><div>          $cover_component = apply_filters( 'bp_attachments_cover_image_ui_component', $cover_component );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Get cover image advised dimensions.</span>&nbsp;</div></li><li><div>      $cover_dimensions = bp_attachments_get_cover_image_dimensions( $cover_component );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Set warning messages.</span></span>&nbsp;</div></li><li><div>      $strings['cover_image_warnings'] = apply_filters( 'bp_attachments_cover_image_ui_warnings', array(&nbsp;</div></li><li><div>          'dimensions' =&gt; sprintf(&nbsp;</div></li><li><div>                  __( 'For better results, make sure to upload an image that is larger than %1$spx wide, and %2$spx tall.', 'buddypress' ), &nbsp;</div></li><li><div>                  (int) $cover_dimensions['width'], &nbsp;</div></li><li><div>                  (int) $cover_dimensions['height']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set Plupload settings.</span>&nbsp;</div></li><li><div>  $settings['defaults'] = $defaults;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enqueue some extra styles if required</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Extra styles need to be registered.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['extra_css'] ) ) {&nbsp;</div></li><li><div>      foreach ( (array) $args['extra_css'] as $css ) {&nbsp;</div></li><li><div>          if ( empty( $css ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_style( $css );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_enqueue_script ( 'bp-plupload' );&nbsp;</div></li><li><div>  wp_localize_script( 'bp-plupload', 'BP_Uploader', array( 'strings' =&gt; $strings, 'settings' =&gt; $settings ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enqueue some extra scripts if required</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Extra scripts need to be registered.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['extra_js'] ) ) {&nbsp;</div></li><li><div>      foreach ( (array) $args['extra_js'] as $js ) {&nbsp;</div></li><li><div>          if ( empty( $js ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script( $js );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the conclusion of bp_attachments_enqueue_scripts()</span>&nbsp;</div></li><li><div><span class="comment">   * to avoid the scripts to be loaded more than once.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_attachments_enqueue_scripts' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check the current user's capability to edit an avatar for a given object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $capability The capability to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $args       An array containing the item_id and the object to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_current_user_can( $capability, $args = array() ) {&nbsp;</div></li><li><div>  $can = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'edit_avatar' === $capability || 'edit_cover_image' === $capability ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Needed avatar arguments are set.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( isset( $args['item_id'] ) && isset( $args['object'] ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Group profile photo.</span>&nbsp;</div></li><li><div>          if ( bp_is_active( 'groups' ) && 'group' === $args['object'] ) {&nbsp;</div></li><li><div>              if ( bp_is_group_create() ) {&nbsp;</div></li><li><div>                  $can = (bool) groups_is_user_creator( bp_loggedin_user_id(), $args['item_id'] ) || bp_current_user_can( 'bp_moderate' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $can = (bool) groups_is_user_admin( bp_loggedin_user_id(), $args['item_id'] ) || bp_current_user_can( 'bp_moderate' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          <span class="comment">// User profile photo.</span>&nbsp;</div></li><li><div>          } elseif ( bp_is_active( 'xprofile' ) && 'user' === $args['object'] ) {&nbsp;</div></li><li><div>              $can = bp_loggedin_user_id() === (int) $args['item_id'] || bp_current_user_can( 'bp_moderate' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * No avatar arguments, fallback to bp_user_can_create_groups()</span>&nbsp;</div></li><li><div><span class="comment">       * or bp_is_item_admin()</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( bp_is_group_create() ) {&nbsp;</div></li><li><div>              $can = bp_user_can_create_groups();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $can = bp_is_item_admin();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_current_user_can', $can, $capability, $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send a JSON response back to an Ajax upload request.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool  $success  True for a success, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool  $is_html4 True if the Plupload runtime used is html4, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $data     Data to encode as JSON, then print and die.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_json_response( $success, $is_html4 = false, $data = null ) {&nbsp;</div></li><li><div>  $response = array( 'success' =&gt; $success );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $data ) ) {&nbsp;</div></li><li><div>      $response['data'] = $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Send regular json response.</span>&nbsp;</div></li><li><div>  if ( ! $is_html4 ) {&nbsp;</div></li><li><div>      wp_send_json( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Send specific json response</span>&nbsp;</div></li><li><div><span class="comment">   * the html4 Plupload handler requires a text/html content-type for older IE.</span>&nbsp;</div></li><li><div><span class="comment">   * See https://core.trac.wordpress.org/ticket/31037</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      echo wp_json_encode( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get an Attachment template part.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $slug Template part slug. eg 'uploader' for 'uploader.php'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_template_part( $slug ) {&nbsp;</div></li><li><div>  $attachment_template_part = 'assets/_attachments/' . $slug;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load the attachment template in WP Administration screens.</span>&nbsp;</div></li><li><div>  if ( is_admin() && ( ! defined( 'DOING_AJAX' ) || ! DOING_AJAX ) ) {&nbsp;</div></li><li><div>      $attachment_admin_template_part = buddypress()-&gt;themes_dir . '/bp-legacy/buddypress/' . $attachment_template_part . '.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check whether the template part exists.</span>&nbsp;</div></li><li><div>      if ( ! file_exists( $attachment_admin_template_part ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the template part.</span>&nbsp;</div></li><li><div>      require( $attachment_admin_template_part );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load the attachment template in WP_USE_THEMES env.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bp_get_template_part( $attachment_template_part );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Cover Image ***************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the cover image settings</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $component The component to get the settings for (&quot;xprofile&quot; for user or &quot;groups&quot;).</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|bool The cover image settings in array, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_cover_image_settings( $component = 'xprofile' ) {&nbsp;</div></li><li><div>  <span class="comment">// Default parameters.</span>&nbsp;</div></li><li><div>  $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// First look in BP Theme Compat.</span>&nbsp;</div></li><li><div>  $cover_image = bp_get_theme_compat_feature( 'cover_image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $cover_image ) ) {&nbsp;</div></li><li><div>      $args = (array) $cover_image;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Then let people override/set the feature using this dynamic filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Eg: for the user's profile cover image use:</span>&nbsp;</div></li><li><div><span class="comment">   * add_filter( 'bp_before_xprofile_cover_image_settings_parse_args', 'your_filter', 10, 1 );</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $settings The cover image settings</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $settings = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'components' =&gt; array(), &nbsp;</div></li><li><div>      'width' =&gt; 1300, &nbsp;</div></li><li><div>      'height' =&gt; 225, &nbsp;</div></li><li><div>      'callback' =&gt; '', &nbsp;</div></li><li><div>      'theme_handle' =&gt; '', &nbsp;</div></li><li><div>      'default_cover' =&gt; '', &nbsp;</div></li><li><div> ), $component . '_cover_image_settings' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $settings['components'] ) || empty( $settings['callback'] ) || empty( $settings['theme_handle'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Current component is not supported.</span>&nbsp;</div></li><li><div>  if ( ! in_array( $component, $settings['components'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally return the settings.</span>&nbsp;</div></li><li><div>  return $settings;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get cover image Width and Height.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $component The BuddyPress component concerned (&quot;xprofile&quot; for user or &quot;groups&quot;).</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|bool An associative array containing the advised width and height for the cover image. False if settings are empty.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_cover_image_dimensions( $component = 'xprofile' ) {&nbsp;</div></li><li><div>  <span class="comment">// Let's prevent notices when setting the warning strings.</span>&nbsp;</div></li><li><div>  $default = array( 'width' =&gt; 0, 'height' =&gt; 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $settings = bp_attachments_get_cover_image_settings( $component );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $settings ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get width and height.</span>&nbsp;</div></li><li><div>  $wh = array_intersect_key( $settings, $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter here to edit the cover image dimensions if needed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $wh       An associative array containing the width and height values.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $settings An associative array containing all the feature settings.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $compnent The requested component.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_get_cover_image_dimensions', $wh, $settings, $component );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Are we on a page to edit a cover image?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if on a page to edit a cover image, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_cover_image_is_edit() {&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_component = bp_current_component();&nbsp;</div></li><li><div>  if ( bp_is_active( 'xprofile' ) && bp_is_current_component( 'xprofile' ) ) {&nbsp;</div></li><li><div>      $current_component = 'xprofile';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! bp_is_active( $current_component, 'cover_image' ) ) {&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_user_change_cover_image() ) {&nbsp;</div></li><li><div>      $retval = ! bp_disable_cover_image_uploads();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( bp_is_group_admin_page() && 'group-cover-image' == bp_get_group_current_admin_tab() )&nbsp;</div></li><li><div>      || ( bp_is_group_create() && bp_is_group_creation_step( 'group-cover-image' ) ) ) {&nbsp;</div></li><li><div>      $retval = ! bp_disable_group_cover_image_uploads();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bp_attachments_cover_image_is_edit', $retval, $current_component );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Does the user has a cover image?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id User ID to retrieve cover image for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the user has a cover image, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_user_has_cover_image( $user_id = 0 ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cover_src = bp_attachments_get_attachment( 'url', array(&nbsp;</div></li><li><div>      'item_id' =&gt; $user_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_attachments_get_user_has_cover_image', $cover_src, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Does the group has a cover image?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $group_id Group ID to check cover image existence for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the group has a cover image, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_get_group_has_cover_image( $group_id = 0 ) {&nbsp;</div></li><li><div>  if ( empty( $group_id ) ) {&nbsp;</div></li><li><div>      $group_id = bp_get_current_group_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cover_src = bp_attachments_get_attachment( 'url', array(&nbsp;</div></li><li><div>      'object_dir' =&gt; 'groups', &nbsp;</div></li><li><div>      'item_id' =&gt; $group_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_attachments_get_user_has_cover_image', $cover_src, $group_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate the cover image file.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array                          $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $file            The absolute path to the image. Required.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $component       The component for the object (eg: groups, xprofile). Required.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $cover_image_dir The Cover image dir to write the image into. Required.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @param BP_Attachment_Cover_Image|null $cover_image_class The class to use to fit the cover image.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|array An array containing cover image data on success, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_cover_image_generate_file( $args = array(), $cover_image_class = null ) {&nbsp;</div></li><li><div>  <span class="comment">// Bail if an argument is missing.</span>&nbsp;</div></li><li><div>  if ( empty( $args['file'] ) || empty( $args['component'] ) || empty( $args['cover_image_dir'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get advised dimensions for the cover image.</span>&nbsp;</div></li><li><div>  $dimensions = bp_attachments_get_cover_image_dimensions( $args['component'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No dimensions or the file does not match with the cover image dir, stop!</span>&nbsp;</div></li><li><div>  if ( false === $dimensions || $args['file'] !== $args['cover_image_dir'] . '/' . wp_basename( $args['file'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_a( $cover_image_class, 'BP_Attachment_Cover_Image' ) ) {&nbsp;</div></li><li><div>      $cover_image_class = new BP_Attachment_Cover_Image();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure the file is inside the Cover Image Upload path.</span>&nbsp;</div></li><li><div>  if ( false === strpos( $args['file'], $cover_image_class-&gt;upload_path ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Resize the image so that it fit with the cover image dimensions.</span>&nbsp;</div></li><li><div>  $cover_image = $cover_image_class-&gt;fit( $args['file'], $dimensions );&nbsp;</div></li><li><div>  $is_too_small = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Image is too small in width and height.</span>&nbsp;</div></li><li><div>  if ( empty( $cover_image ) ) {&nbsp;</div></li><li><div>      $cover_file = $cover_image_class-&gt;generate_filename( $args['file'] );&nbsp;</div></li><li><div>      @rename( $args['file'], $cover_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// It's too small!</span>&nbsp;</div></li><li><div>      $is_too_small = true;&nbsp;</div></li><li><div>  } elseif ( ! empty( $cover_image['path'] ) ) {&nbsp;</div></li><li><div>      $cover_file = $cover_image['path'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Image is too small in width or height.</span>&nbsp;</div></li><li><div>      if ( $cover_image['width'] &lt; $dimensions['width'] || $cover_image['height'] &lt; $dimensions['height'] ) {&nbsp;</div></li><li><div>          $is_too_small = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We were not able to generate the cover image file.</span>&nbsp;</div></li><li><div>  if ( empty( $cover_file ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do some clean up with old cover image, now a new one is set.</span>&nbsp;</div></li><li><div>  $cover_basename = wp_basename( $cover_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $att_dir = opendir( $args['cover_image_dir'] ) ) {&nbsp;</div></li><li><div>      while ( false !== ( $attachment_file = readdir( $att_dir ) ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Skip directories and the new cover image.</span>&nbsp;</div></li><li><div>          if ( 2 &lt; strlen( $attachment_file ) && 0 !== strpos( $attachment_file, '.' ) && $cover_basename !== $attachment_file ) {&nbsp;</div></li><li><div>              @unlink( $args['cover_image_dir'] . '/' . $attachment_file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally return needed data.</span>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'cover_file' =&gt; $cover_file, &nbsp;</div></li><li><div>      'cover_basename' =&gt; $cover_basename, &nbsp;</div></li><li><div>      'is_too_small' =&gt; $is_too_small&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax Upload and set a cover image</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null A json object containing success data if the upload succeeded, </span>&nbsp;</div></li><li><div><span class="comment"> *                     error message otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_cover_image_ajax_upload() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if not a POST action.</span></span>&nbsp;</div></li><li><div>  if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sending the json response will be different if</span>&nbsp;</div></li><li><div><span class="comment">   * the current Plupload runtime is html4</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $is_html4 = false;&nbsp;</div></li><li><div>  if ( ! empty( $_POST['html4' ] ) ) {&nbsp;</div></li><li><div>      $is_html4 = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check the nonce.</span></span>&nbsp;</div></li><li><div>  check_admin_referer( 'bp-uploader' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init the BuddyPress parameters.</span>&nbsp;</div></li><li><div>  $bp_params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need it to carry on.</span>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['bp_params'] ) ) {&nbsp;</div></li><li><div>      $bp_params = bp_parse_args( $_POST['bp_params'], array(&nbsp;</div></li><li><div>          'object' =&gt; 'user', &nbsp;</div></li><li><div>          'item_id' =&gt; bp_loggedin_user_id(), &nbsp;</div></li><li><div> ), 'attachments_cover_image_ajax_upload' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need the object to set the uploads dir filter.</span>&nbsp;</div></li><li><div>  if ( empty( $bp_params['object'] ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Capability check.</span></span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_current_user_can( 'edit_cover_image', $bp_params ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>  $needs_reset = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Member's cover image.</span>&nbsp;</div></li><li><div>  if ( 'user' === $bp_params['object'] ) {&nbsp;</div></li><li><div>      $object_data = array( 'dir' =&gt; 'members', 'component' =&gt; 'xprofile' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_displayed_user_id() && ! empty( $bp_params['item_id'] ) ) {&nbsp;</div></li><li><div>          $needs_reset = array( 'key' =&gt; 'displayed_user', 'value' =&gt; $bp-&gt;displayed_user );&nbsp;</div></li><li><div>          $bp-&gt;displayed_user-&gt;id = $bp_params['item_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Group's cover image.</span>&nbsp;</div></li><li><div>  } elseif ( 'group' === $bp_params['object'] ) {&nbsp;</div></li><li><div>      $object_data = array( 'dir' =&gt; 'groups', 'component' =&gt; 'groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_get_current_group_id() && ! empty( $bp_params['item_id'] ) ) {&nbsp;</div></li><li><div>          $needs_reset = array( 'component' =&gt; 'groups', 'key' =&gt; 'current_group', 'value' =&gt; $bp-&gt;groups-&gt;current_group );&nbsp;</div></li><li><div>          $bp-&gt;groups-&gt;current_group = groups_get_group( $bp_params['item_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Other object's cover image.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $object_data = apply_filters( 'bp_attachments_cover_image_object_dir', array(), $bp_params['object'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stop here in case of a missing parameter for the object.</span>&nbsp;</div></li><li><div>  if ( empty( $object_data['dir'] ) || empty( $object_data['component'] ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle cover image uploading.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return an array with the 'result' key set.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $bp_params</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $needs_reset Stores original value of certain globals we need to revert to later.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $object_data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $pre_filter = apply_filters( 'bp_attachments_pre_cover_image_ajax_upload', array(), $bp_params, $needs_reset, $object_data );&nbsp;</div></li><li><div>  if ( isset( $pre_filter['result'] ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( $pre_filter['result'], $is_html4, $pre_filter );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cover_image_attachment = new BP_Attachment_Cover_Image();&nbsp;</div></li><li><div>  $uploaded = $cover_image_attachment-&gt;upload( $_FILES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reset objects.</span>&nbsp;</div></li><li><div>  if ( ! empty( $needs_reset ) ) {&nbsp;</div></li><li><div>      if ( ! empty( $needs_reset['component'] ) ) {&nbsp;</div></li><li><div>          $bp-&gt;{$needs_reset['component']}-&gt;{$needs_reset['key']} = $needs_reset['value'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $bp-&gt;{$needs_reset['key']} = $needs_reset['value'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $uploaded['error'] ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Upload error response.</span></span></span>&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4, array(&nbsp;</div></li><li><div>          'type' =&gt; 'upload_error', &nbsp;</div></li><li><div>          'message' =&gt; sprintf( __( 'Upload Failed! Error was: %s', 'buddypress' ), $uploaded['error'] ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default error message.</span>&nbsp;</div></li><li><div>  $error_message = __( 'There was a problem uploading the cover image.', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get BuddyPress Attachments Uploads Dir datas.</span></span>&nbsp;</div></li><li><div>  $bp_attachments_uploads_dir = bp_attachments_uploads_dir_get();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// The BP Attachments Uploads Dir is not set, stop.</span></span></span>&nbsp;</div></li><li><div>  if ( ! $bp_attachments_uploads_dir ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4, array(&nbsp;</div></li><li><div>          'type' =&gt; 'upload_error', &nbsp;</div></li><li><div>          'message' =&gt; $error_message, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cover_subdir = $object_data['dir'] . '/' . $bp_params['item_id'] . '/cover-image';&nbsp;</div></li><li><div>  $cover_dir = trailingslashit( $bp_attachments_uploads_dir['basedir'] ) . $cover_subdir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_dir( $cover_dir ) ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Upload error response.</span></span></span>&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4, array(&nbsp;</div></li><li><div>          'type' =&gt; 'upload_error', &nbsp;</div></li><li><div>          'message' =&gt; $error_message, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate the cover image so that it fit to feature's dimensions</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Unlike the Avatar, Uploading and generating the cover image is happening during</span>&nbsp;</div></li><li><div><span class="comment">   * the same Ajax request, as we already instantiated the BP_Attachment_Cover_Image</span>&nbsp;</div></li><li><div><span class="comment">   * class, let's use it.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $cover = bp_attachments_cover_image_generate_file( array(&nbsp;</div></li><li><div>      'file' =&gt; $uploaded['file'], &nbsp;</div></li><li><div>      'component' =&gt; $object_data['component'], &nbsp;</div></li><li><div>      'cover_image_dir' =&gt; $cover_dir&nbsp;</div></li><li><div> ), $cover_image_attachment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $cover ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Upload error response.</span></span></span>&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4, array(&nbsp;</div></li><li><div>          'type' =&gt; 'upload_error', &nbsp;</div></li><li><div>          'message' =&gt; $error_message, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Build the url to the file.</span>&nbsp;</div></li><li><div>  $cover_url = trailingslashit( $bp_attachments_uploads_dir['baseurl'] ) . $cover_subdir . '/' . $cover['cover_basename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init Feedback code, 1 is success.</span>&nbsp;</div></li><li><div>  $feedback_code = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 0 is the size warning.</span>&nbsp;</div></li><li><div>  if ( $cover['is_too_small'] ) {&nbsp;</div></li><li><div>      $feedback_code = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the name of the file.</span>&nbsp;</div></li><li><div>  $name = $_FILES['file']['name'];&nbsp;</div></li><li><div>  $name_parts = pathinfo( $name );&nbsp;</div></li><li><div>  $name = trim( substr( $name, 0, - ( 1 + strlen( $name_parts['extension'] ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires if the new cover image was successfully uploaded.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook will be xprofile in case of a user's</span>&nbsp;</div></li><li><div><span class="comment">   * cover image, groups in case of a group's cover image. For instance:</span>&nbsp;</div></li><li><div><span class="comment">   * Use add_action( 'xprofile_cover_image_uploaded' ) to run your specific</span>&nbsp;</div></li><li><div><span class="comment">   * code once the user has set his cover image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $item_id Inform about the item id the cover image was set for.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( $object_data['component'] . '_cover_image_uploaded', (int) $bp_params['item_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally return the cover image url to the UI.</span>&nbsp;</div></li><li><div>  bp_attachments_json_response( true, $is_html4, array(&nbsp;</div></li><li><div>      'name' =&gt; $name, &nbsp;</div></li><li><div>      'url' =&gt; $cover_url, &nbsp;</div></li><li><div>      'feedback_code' =&gt; $feedback_code, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_bp_cover_image_upload', 'bp_attachments_cover_image_ajax_upload' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax delete a cover image for a given object and item id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null A json object containing success data if the cover image was deleted</span>&nbsp;</div></li><li><div><span class="comment"> *                     error message otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_attachments_cover_image_ajax_delete() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if not a POST action.</span></span>&nbsp;</div></li><li><div>  if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cover_image_data = $_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $cover_image_data['object'] ) || empty( $cover_image_data['item_id'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Check the nonce.</span></span>&nbsp;</div></li><li><div>  check_admin_referer( 'bp_delete_cover_image', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Capability check.</span></span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_current_user_can( 'edit_cover_image', $cover_image_data ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set object for the user's case.</span>&nbsp;</div></li><li><div>  if ( 'user' === $cover_image_data['object'] ) {&nbsp;</div></li><li><div>      $component = 'xprofile';&nbsp;</div></li><li><div>      $dir = 'members';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set it for any other cases.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $component = $cover_image_data['object'] . 's';&nbsp;</div></li><li><div>      $dir = $component;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle delete.</span>&nbsp;</div></li><li><div>  if ( bp_attachments_delete_file( array( 'item_id' =&gt; $cover_image_data['item_id'], 'object_dir' =&gt; $dir, 'type' =&gt; 'cover-image' ) ) ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires if the cover image was successfully deleted.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The dynamic portion of the hook will be xprofile in case of a user's</span>&nbsp;</div></li><li><div><span class="comment">       * cover image, groups in case of a group's cover image. For instance:</span>&nbsp;</div></li><li><div><span class="comment">       * Use add_action( 'xprofile_cover_image_deleted' ) to run your specific</span>&nbsp;</div></li><li><div><span class="comment">       * code once the user has deleted his cover image.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $item_id Inform about the item id the cover image was deleted for.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( &quot;{$component}_cover_image_deleted&quot;, (int) $cover_image_data['item_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Defaults no cover image.</span>&nbsp;</div></li><li><div>      $response = array(&nbsp;</div></li><li><div>          'reset_url' =&gt; '', &nbsp;</div></li><li><div>          'feedback_code' =&gt; 3 , &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get cover image settings in case there's a default header.</span>&nbsp;</div></li><li><div>      $cover_params = bp_attachments_get_cover_image_settings( $component );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if there's a default cover.</span>&nbsp;</div></li><li><div>      if ( ! empty( $cover_params['default_cover'] ) ) {&nbsp;</div></li><li><div>          $response['reset_url'] = $cover_params['default_cover'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Finally send the reset url.</span>&nbsp;</div></li><li><div>      wp_send_json_success( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'feedback_code' =&gt; 2, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_bp_cover_image_delete', 'bp_attachments_cover_image_ajax_delete' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>