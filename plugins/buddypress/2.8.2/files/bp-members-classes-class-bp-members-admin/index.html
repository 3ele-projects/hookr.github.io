<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49325"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-members-classes-class-bp-members-admin | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5789fc54e540cc06326ce06705b2d811' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-members-classes-class-bp-members-admin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-members-classes-class-bp-members-admin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-members-classes-class-bp-members-admin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-members-classes-class-bp-members-admin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-members-classes-class-bp-members-admin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-members-classes-class-bp-m&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-members/classes/class-bp-members-admin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Members Admin</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage MembersAdmin</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !class_exists( 'BP_Members_Admin' ) ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Load Members admin area.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class BP_Members_Admin {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Directory *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Path to the BP Members Admin directory.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string $admin_dir</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $admin_dir = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** URLs ******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * URL to the BP Members Admin directory.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string $admin_url</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $admin_url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * URL to the BP Members Admin CSS directory.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string $css_url</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $css_url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * URL to the BP Members Admin JS directory.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $js_url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Other *****************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Screen id for edit user's profile page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $user_page = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Setup BP Members Admin.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function register_members_admin() {&nbsp;</div></li><li><div>      if ( ! is_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $bp-&gt;members-&gt;admin ) ) {&nbsp;</div></li><li><div>          $bp-&gt;members-&gt;admin = new self;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $bp-&gt;members-&gt;admin;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      $this-&gt;setup_globals();&nbsp;</div></li><li><div>      $this-&gt;setup_actions();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set admin-related globals.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function setup_globals() {&nbsp;</div></li><li><div>      $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Paths and URLs</span>&nbsp;</div></li><li><div>      $this-&gt;admin_dir = trailingslashit( $bp-&gt;plugin_dir  . 'bp-members/admin' ); <span class="comment">// Admin path.</span>&nbsp;</div></li><li><div>      $this-&gt;admin_url = trailingslashit( $bp-&gt;plugin_url  . 'bp-members/admin' ); <span class="comment">// Admin URL.</span>&nbsp;</div></li><li><div>      $this-&gt;css_url = trailingslashit( $this-&gt;admin_url . 'css' ); <span class="comment"><span class="comment">// Admin CSS URL.</span></span>&nbsp;</div></li><li><div>      $this-&gt;js_url = trailingslashit( $this-&gt;admin_url . 'js' ); <span class="comment"><span class="comment">// Admin CSS URL.</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Capability depends on config.</span>&nbsp;</div></li><li><div>      $this-&gt;capability = bp_core_do_network_admin() ? 'manage_network_users' : 'edit_users';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The Edit Profile Screen id.</span>&nbsp;</div></li><li><div>      $this-&gt;user_page = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The Show Profile Screen id.</span>&nbsp;</div></li><li><div>      $this-&gt;user_profile = is_network_admin() ? 'users' : 'profile';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The current user id.</span>&nbsp;</div></li><li><div>      $this-&gt;current_user_id = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The user id being edited.</span>&nbsp;</div></li><li><div>      $this-&gt;user_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is a member editing their own profile.</span>&nbsp;</div></li><li><div>      $this-&gt;is_self_profile = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The screen ids to load specific css for.</span>&nbsp;</div></li><li><div>      $this-&gt;screen_id = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The stats metabox default position.</span>&nbsp;</div></li><li><div>      $this-&gt;stats_metabox = new StdClass();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// BuddyPress edit user's profile args.</span>&nbsp;</div></li><li><div>      $this-&gt;edit_profile_args = array( 'page' =&gt; 'bp-profile-edit' );&nbsp;</div></li><li><div>      $this-&gt;edit_profile_url = '';&nbsp;</div></li><li><div>      $this-&gt;edit_url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Data specific to signups.</span>&nbsp;</div></li><li><div>      $this-&gt;users_page = '';&nbsp;</div></li><li><div>      $this-&gt;signups_page = '';&nbsp;</div></li><li><div>      $this-&gt;users_url = bp_get_admin_url( 'users.php' );&nbsp;</div></li><li><div>      $this-&gt;users_screen = bp_core_do_network_admin() ? 'users-network' : 'users';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Specific config: BuddyPress is not network activated.</span>&nbsp;</div></li><li><div>      $this-&gt;subsite_activated = (bool) is_multisite() && ! bp_is_network_activated();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// When BuddyPress is not network activated, only Super Admin can moderate signups.</span>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;subsite_activated ) ) {&nbsp;</div></li><li><div>          $this-&gt;capability = 'manage_network_users';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set admin-related actions and filters.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function setup_actions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Extended Profile *************************************************</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Enqueue all admin JS and CSS.</span>&nbsp;</div></li><li><div>      add_action( 'bp_admin_enqueue_scripts', array( $this, 'enqueue_scripts' )        );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add some page specific output to the &lt;head&gt;.</span>&nbsp;</div></li><li><div>      add_action( 'bp_admin_head', array( $this, 'admin_head' ), 999 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add menu item to all users menu.</span>&nbsp;</div></li><li><div>      add_action( 'admin_menu', array( $this, 'admin_menus' ), 5 );&nbsp;</div></li><li><div>      add_action( 'network_admin_menu', array( $this, 'admin_menus' ), 5 );&nbsp;</div></li><li><div>      add_action( 'user_admin_menu', array( $this, 'user_profile_menu' ), 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Create the Profile Navigation (Profile/Extended Profile).</span>&nbsp;</div></li><li><div>      add_action( 'edit_user_profile', array( $this, 'profile_nav' ), 99, 1 );&nbsp;</div></li><li><div>      add_action( 'show_user_profile', array( $this, 'profile_nav' ), 99, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Editing users of a specific site.</span>&nbsp;</div></li><li><div>      add_action( &quot;admin_head-site-users.php&quot;, array( $this, 'profile_admin_head' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add a row action to users listing.</span>&nbsp;</div></li><li><div>      if ( bp_core_do_network_admin() ) {&nbsp;</div></li><li><div>          add_filter( 'ms_user_row_actions', array( $this, 'row_actions' ), 10, 2 );&nbsp;</div></li><li><div>          add_action( 'admin_init', array( $this, 'add_edit_profile_url_filter' )        );&nbsp;</div></li><li><div>          add_action( 'wp_after_admin_bar_render', array( $this, 'remove_edit_profile_url_filter' )        );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add user row actions for single site.</span>&nbsp;</div></li><li><div>      add_filter( 'user_row_actions', array( $this, 'row_actions' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Process changes to member type.</span>&nbsp;</div></li><li><div>      add_action( 'bp_members_admin_load', array( $this, 'process_member_type_update' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Signups **********************************************************</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Filter non multisite user query to remove sign-up users.</span>&nbsp;</div></li><li><div>          if ( ! is_multisite() ) {&nbsp;</div></li><li><div>              add_action( 'pre_user_query', array( $this, 'remove_signups_from_user_query' ), 10, 1 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Reorganise the views navigation in users.php and signups page.</span>&nbsp;</div></li><li><div>          if ( current_user_can( $this-&gt;capability ) ) {&nbsp;</div></li><li><div>              $user_screen = $this-&gt;users_screen;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Users screen on multiblog is users, but signups</span>&nbsp;</div></li><li><div><span class="comment">               * need to be managed in the network for this case</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if ( bp_is_network_activated() && bp_is_multiblog_mode() && false === strpos( $user_screen, '-network' ) ) {&nbsp;</div></li><li><div>                  $user_screen .= '-network';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              add_filter( &quot;views_{$user_screen}&quot;, array( $this, 'signup_filter_view' ), 10, 1 );&nbsp;</div></li><li><div>              add_filter( 'set-screen-option', array( $this, 'signup_screen_options' ), 10, 3 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Registration is turned on.</span>&nbsp;</div></li><li><div>          add_action( 'update_site_option_registration', array( $this, 'multisite_registration_on' ), 10, 2 );&nbsp;</div></li><li><div>          add_action( 'update_option_users_can_register', array( $this, 'single_site_registration_on' ), 10, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Users List - Members Types ***************************************</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() && bp_get_member_types() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add &quot;Change type&quot; &lt;select&gt; to WP admin users list table and process bulk members type changes.</span>&nbsp;</div></li><li><div>          add_action( 'restrict_manage_users', array( $this, 'users_table_output_type_change_select' ) );&nbsp;</div></li><li><div>          add_action( 'load-users.php', array( $this, 'users_table_process_bulk_type_change' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add the member type column to the WP admin users list table.</span>&nbsp;</div></li><li><div>          add_filter( 'manage_users_columns', array( $this, 'users_table_add_type_column' )        );&nbsp;</div></li><li><div>          add_filter( 'manage_users_custom_column', array( $this, 'users_table_populate_type_cell' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Filter WP admin users list table to include users of the specified type.</span>&nbsp;</div></li><li><div>          add_filter( 'pre_get_users', array( $this, 'users_table_filter_by_type' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create registration pages when multisite user registration is turned on.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $option_name Current option name; value is always 'registration'.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function multisite_registration_on( $option_name, $value ) {&nbsp;</div></li><li><div>      if ( 'user' === $value || 'all' === $value ) {&nbsp;</div></li><li><div>          bp_core_add_page_mappings( array(&nbsp;</div></li><li><div>              'register' =&gt; 1, &nbsp;</div></li><li><div>              'activate' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create registration pages when single site registration is turned on.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $old_value</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function single_site_registration_on( $old_value, $value ) {&nbsp;</div></li><li><div>      <span class="comment">// Single site.</span>&nbsp;</div></li><li><div>      if ( ! is_multisite() && ! empty( $value ) ) {&nbsp;</div></li><li><div>          bp_core_add_page_mappings( array(&nbsp;</div></li><li><div>              'register' =&gt; 1, &nbsp;</div></li><li><div>              'activate' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the user ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Look for $_GET['user_id']. If anything else, force the user ID to the</span>&nbsp;</div></li><li><div><span class="comment">   * current user's ID so they aren't left without a user to edit.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_user_id() {&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;user_id ) ) {&nbsp;</div></li><li><div>          return $this-&gt;user_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;user_id = (int) get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We'll need a user ID when not on self profile.</span>&nbsp;</div></li><li><div>      if ( ! empty( $_GET['user_id'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;user_id = (int) $_GET['user_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;user_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Can the current user edit the one displayed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Self profile editing / or bp_moderate check.</span>&nbsp;</div></li><li><div><span class="comment">   * This might be replaced by more granular capabilities</span>&nbsp;</div></li><li><div><span class="comment">   * in the future.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user being checked for edit ability.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function member_can_edit( $user_id = 0 ) {&nbsp;</div></li><li><div>      $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if no user ID was passed.</span>&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Member can edit if they are viewing their own profile.</span>&nbsp;</div></li><li><div>      if ( $this-&gt;current_user_id === $user_id ) {&nbsp;</div></li><li><div>          $retval = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Trust the 'bp_moderate' capability.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval = bp_current_user_can( 'bp_moderate' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get admin notice when saving a user or member profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_user_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup empty notice for return value.</span></span>&nbsp;</div></li><li><div>      $notice = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Updates.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['updated'] ) ) {&nbsp;</div></li><li><div>          switch ( $_REQUEST['updated'] ) {&nbsp;</div></li><li><div>          case 'avatar':&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'updated', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'Profile photo was deleted.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'ham' :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'updated', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'User removed as spammer.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'spam' :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'updated', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'User marked as spammer. Spam users are visible only to site admins.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 1 :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'updated', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'Profile updated.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Errors.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['error'] ) ) {&nbsp;</div></li><li><div>          switch ( $_REQUEST['error'] ) {&nbsp;</div></li><li><div>          case 'avatar':&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'There was a problem deleting that profile photo. Please try again.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'ham' :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'User could not be removed as spammer.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'spam' :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'User could not be marked as spammer.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 1 :&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'An error occurred while trying to update the profile.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 2:&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'Please make sure you fill in all required fields in this profile field group before saving.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 3:&nbsp;</div></li><li><div>              $notice = array(&nbsp;</div></li><li><div>                  'class' =&gt; 'error', &nbsp;</div></li><li><div>                  'message' =&gt; __( 'There was a problem updating some of your profile information. Please try again.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $notice;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create the /user/ admin Profile submenus for all members.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_profile_menu() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup the hooks array.</span></span>&nbsp;</div></li><li><div>      $hooks = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the faux &quot;Edit Profile&quot; submenu page.</span>&nbsp;</div></li><li><div>      $hooks['user'] = $this-&gt;user_page = add_submenu_page(&nbsp;</div></li><li><div>          'profile.php', &nbsp;</div></li><li><div>          __( 'Edit Profile', 'buddypress' ), &nbsp;</div></li><li><div>          __( 'Edit Profile', 'buddypress' ), &nbsp;</div></li><li><div>          'exist', &nbsp;</div></li><li><div>          'bp-profile-edit', &nbsp;</div></li><li><div>          array( $this, 'user_admin' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup the screen ID's.</span></span>&nbsp;</div></li><li><div>      $this-&gt;screen_id = array(&nbsp;</div></li><li><div>          $this-&gt;user_page    . '-user', &nbsp;</div></li><li><div>          $this-&gt;user_profile . '-user'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through new hooks and add method actions.</span></span>&nbsp;</div></li><li><div>      foreach ( $hooks as $key =&gt; $hook ) {&nbsp;</div></li><li><div>          add_action( &quot;load-{$hook}&quot;, array( $this, $key . '_admin_load' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add the profile_admin_head method to proper admin_head actions.</span></span>&nbsp;</div></li><li><div>      add_action( &quot;admin_head-{$this-&gt;user_page}&quot;, array( $this, 'profile_admin_head' ) );&nbsp;</div></li><li><div>      add_action( &quot;admin_head-profile.php&quot;, array( $this, 'profile_admin_head' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create the All Users / Profile &gt; Edit Profile and All Users Signups submenus.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_menus() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup the hooks array.</span></span>&nbsp;</div></li><li><div>      $hooks = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Manage user's profile.</span>&nbsp;</div></li><li><div>      $hooks['user'] = $this-&gt;user_page = add_submenu_page(&nbsp;</div></li><li><div>          $this-&gt;user_profile . '.php', &nbsp;</div></li><li><div>          __( 'Edit Profile', 'buddypress' ), &nbsp;</div></li><li><div>          __( 'Edit Profile', 'buddypress' ), &nbsp;</div></li><li><div>          'read', &nbsp;</div></li><li><div>          'bp-profile-edit', &nbsp;</div></li><li><div>          array( $this, 'user_admin' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only show sign-ups where they belong.</span>&nbsp;</div></li><li><div>      if ( ( ! bp_is_network_activated() && ! is_network_admin() ) || ( is_network_admin() && bp_is_network_activated() ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Manage signups.</span>&nbsp;</div></li><li><div>          $hooks['signups'] = $this-&gt;signups_page = add_users_page(&nbsp;</div></li><li><div>              __( 'Manage Signups', 'buddypress' ), &nbsp;</div></li><li><div>              __( 'Manage Signups', 'buddypress' ), &nbsp;</div></li><li><div>              $this-&gt;capability, &nbsp;</div></li><li><div>              'bp-signups', &nbsp;</div></li><li><div>              array( $this, 'signups_admin' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $edit_page = 'user-edit';&nbsp;</div></li><li><div>      $profile_page = 'profile';&nbsp;</div></li><li><div>      $this-&gt;users_page = 'users';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Self profile check is needed for this pages.</span>&nbsp;</div></li><li><div>      $page_head = array(&nbsp;</div></li><li><div>          $edit_page        . '.php', &nbsp;</div></li><li><div>          $profile_page     . '.php', &nbsp;</div></li><li><div>          $this-&gt;user_page, &nbsp;</div></li><li><div>          $this-&gt;users_page . '.php', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Append '-network' to each array item if in network admin.</span>&nbsp;</div></li><li><div>      if ( is_network_admin() ) {&nbsp;</div></li><li><div>          $edit_page          .= '-network';&nbsp;</div></li><li><div>          $profile_page       .= '-network';&nbsp;</div></li><li><div>          $this-&gt;user_page    .= '-network';&nbsp;</div></li><li><div>          $this-&gt;users_page   .= '-network';&nbsp;</div></li><li><div>          $this-&gt;signups_page .= '-network';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup the screen ID's.</span></span>&nbsp;</div></li><li><div>      $this-&gt;screen_id = array(&nbsp;</div></li><li><div>          $edit_page, &nbsp;</div></li><li><div>          $this-&gt;user_page, &nbsp;</div></li><li><div>          $profile_page&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Loop through new hooks and add method actions.</span></span>&nbsp;</div></li><li><div>      foreach ( $hooks as $key =&gt; $hook ) {&nbsp;</div></li><li><div>          add_action( &quot;load-{$hook}&quot;, array( $this, $key . '_admin_load' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Add the profile_admin_head method to proper admin_head actions.</span></span>&nbsp;</div></li><li><div>      foreach ( $page_head as $head ) {&nbsp;</div></li><li><div>          add_action( &quot;admin_head-{$head}&quot;, array( $this, 'profile_admin_head' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Highlight the Users menu if on Edit Profile and check if on the user's admin profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function profile_admin_head() {&nbsp;</div></li><li><div>      global $submenu_file, $parent_file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is the user editing their own profile?</span>&nbsp;</div></li><li><div>      if ( is_user_admin() || ( defined( 'IS_PROFILE_PAGE' ) && IS_PROFILE_PAGE ) ) {&nbsp;</div></li><li><div>          $this-&gt;is_self_profile = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is the user attempting to edit their own profile.</span>&nbsp;</div></li><li><div>      } elseif ( isset( $_GET['user_id' ] ) || ( isset( $_GET['page'] ) && ( 'bp-profile-edit' === $_GET['page'] ) ) ) {&nbsp;</div></li><li><div>          $this-&gt;is_self_profile = (bool) ( $this-&gt;get_user_id() === $this-&gt;current_user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Force the parent file to users.php to open the correct top level menu</span>&nbsp;</div></li><li><div>      <span class="comment">// but only if not editing a site via the network site editing page.</span>&nbsp;</div></li><li><div>      if ( 'sites.php' !== $parent_file ) {&nbsp;</div></li><li><div>          $parent_file = 'users.php';&nbsp;</div></li><li><div>          $submenu_file = 'users.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Editing your own profile, so recheck some vars.</span>&nbsp;</div></li><li><div>      if ( true === $this-&gt;is_self_profile ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Use profile.php as the edit page.</span>&nbsp;</div></li><li><div>          $edit_page = 'profile.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set profile.php as the parent & sub files to correct the menu nav.</span>&nbsp;</div></li><li><div>          if ( is_blog_admin() || is_user_admin() ) {&nbsp;</div></li><li><div>              $parent_file = 'profile.php';&nbsp;</div></li><li><div>              $submenu_file = 'profile.php';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Not editing yourself, so use user-edit.php.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $edit_page = 'user-edit.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_user_admin() ) {&nbsp;</div></li><li><div>          $this-&gt;edit_profile_url = add_query_arg( $this-&gt;edit_profile_args, user_admin_url( 'profile.php' ) );&nbsp;</div></li><li><div>          $this-&gt;edit_url = user_admin_url( 'profile.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( is_blog_admin() ) {&nbsp;</div></li><li><div>          $this-&gt;edit_profile_url = add_query_arg( $this-&gt;edit_profile_args, admin_url( 'users.php' ) );&nbsp;</div></li><li><div>          $this-&gt;edit_url = admin_url( $edit_page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( is_network_admin() ) {&nbsp;</div></li><li><div>          $this-&gt;edit_profile_url = add_query_arg( $this-&gt;edit_profile_args, network_admin_url( 'users.php' ) );&nbsp;</div></li><li><div>          $this-&gt;edit_url = network_admin_url( $edit_page );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove the Edit Profile page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We add these pages in order to integrate with WP's Users panel, but</span>&nbsp;</div></li><li><div><span class="comment">   * we want them to show up as a row action of the WP panel, not as separate</span>&nbsp;</div></li><li><div><span class="comment">   * subnav items under the Users menu.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_head() {&nbsp;</div></li><li><div>      remove_submenu_page( 'users.php', 'bp-profile-edit' );&nbsp;</div></li><li><div>      remove_submenu_page( 'profile.php', 'bp-profile-edit' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Community Profile *****************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add some specific styling to the Edit User and Edit User's Profile page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function enqueue_scripts() {&nbsp;</div></li><li><div>      if ( ! in_array( get_current_screen()-&gt;id, $this-&gt;screen_id ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $min = bp_core_get_minified_asset_suffix();&nbsp;</div></li><li><div>      $css = $this-&gt;css_url . &quot;admin{$min}.css&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the CSS URL to enqueue in the Members admin area.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $css URL to the CSS admin file to load.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $css = apply_filters( 'bp_members_admin_css', $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_style( 'bp-members-css', $css, array(), bp_get_version() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_style_add_data( 'bp-members-css', 'rtl', true );&nbsp;</div></li><li><div>      if ( $min ) {&nbsp;</div></li><li><div>          wp_style_add_data( 'bp-members-css', 'suffix', $min );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only load JavaScript for BuddyPress profile.</span>&nbsp;</div></li><li><div>      if ( get_current_screen()-&gt;id == $this-&gt;user_page ) {&nbsp;</div></li><li><div>          $js = $this-&gt;js_url . &quot;admin{$min}.js&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the JS URL to enqueue in the Members admin area.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $js URL to the JavaScript admin file to load.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $js = apply_filters( 'bp_members_admin_js', $js );&nbsp;</div></li><li><div>          wp_enqueue_script( 'bp-members-js', $js, array( 'jquery' ), bp_get_version(), true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires after all of the members JavaScript and CSS are enqueued.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $id        ID of the current screen.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $screen_id Array of allowed screens to add scripts and styles to.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_members_admin_enqueue_scripts', get_current_screen()-&gt;id, $this-&gt;screen_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create the Profile navigation in Edit User & Edit Profile pages.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object|null $user   User to create profile navigation for.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $active Which profile to highlight.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function profile_nav( $user = null, $active = 'WordPress' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if no user ID exists here.</span>&nbsp;</div></li><li><div>      if ( empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the user ID to query arguments when not editing yourself.</span>&nbsp;</div></li><li><div>      if ( false === $this-&gt;is_self_profile ) {&nbsp;</div></li><li><div>          $query_args = array( 'user_id' =&gt; $user-&gt;ID );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $query_args = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Conditionally add a referer if it exists in the existing request.</span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['wp_http_referer'] ) ) {&nbsp;</div></li><li><div>          $query_args['wp_http_referer'] = urlencode( stripslashes_deep( $_REQUEST['wp_http_referer'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup the two distinct &quot;edit&quot; URL's.</span>&nbsp;</div></li><li><div>      $community_url = add_query_arg( $query_args, $this-&gt;edit_profile_url );&nbsp;</div></li><li><div>      $wordpress_url = add_query_arg( $query_args, $this-&gt;edit_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $bp_active = false;&nbsp;</div></li><li><div>      $wp_active = ' nav-tab-active';&nbsp;</div></li><li><div>      if ( 'BuddyPress' === $active ) {&nbsp;</div></li><li><div>          $bp_active = ' nav-tab-active';&nbsp;</div></li><li><div>          $wp_active = false;&nbsp;</div></li><li><div>      } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;h2 id=&quot;profile-nav&quot; class=&quot;nav-tab-wrapper&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * In configs where BuddyPress is not network activated, as regular</span>&nbsp;</div></li><li><div><span class="comment">           * admins do not have the capacity to edit other users, we must add</span>&nbsp;</div></li><li><div><span class="comment">           * this check.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( current_user_can( 'edit_user', $user-&gt;ID ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;a class=&quot;nav-tab&lt;?php echo esc_attr( $wp_active ); ?&gt;&quot; href=&quot;&lt;?php echo esc_url( $wordpress_url );?&gt;&quot;&gt;&lt;?php _e( 'Profile', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;a class=&quot;nav-tab&lt;?php echo esc_attr( $bp_active ); ?&gt;&quot; href=&quot;&lt;?php echo esc_url( $community_url );?&gt;&quot;&gt;&lt;?php _e( 'Extended Profile', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the user's profile admin page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Loaded before the page is rendered, this function does all initial</span>&nbsp;</div></li><li><div><span class="comment">   * setup, including: processing form requests, registering contextual</span>&nbsp;</div></li><li><div><span class="comment">   * help, and setting up screen options.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin_load() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get the user ID.</span></span>&nbsp;</div></li><li><div>      $user_id = $this-&gt;get_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Can current user edit this profile?</span>&nbsp;</div></li><li><div>      if ( ! $this-&gt;member_can_edit( $user_id ) ) {&nbsp;</div></li><li><div>          wp_die( __( 'You cannot edit the requested user.', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Build redirection URL.</span></span>&nbsp;</div></li><li><div>      $redirect_to = remove_query_arg( array( 'action', 'error', 'updated', 'spam', 'ham', 'delete_avatar' ), $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>      $doaction = ! empty( $_REQUEST['action'] ) ? $_REQUEST['action'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['user_status'] ) ) {&nbsp;</div></li><li><div>          $spam = (bool) ( 'spam' === $_REQUEST['user_status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $spam !== bp_is_user_spammer( $user_id ) ) {&nbsp;</div></li><li><div>              $doaction = $_REQUEST['user_status'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the start of the signups admin load.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $doaction Current bulk action being processed.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $_REQUEST Current $_REQUEST global.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action_ref_array( 'bp_members_admin_load', array( $doaction, $_REQUEST ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the allowed actions for use in the user admin page.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $value Array of allowed actions to use.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $allowed_actions = apply_filters( 'bp_members_admin_allowed_actions', array( 'update', 'delete_avatar', 'spam', 'ham' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Prepare the display of the Community Profile screen.</span></span>&nbsp;</div></li><li><div>      if ( ! in_array( $doaction, $allowed_actions ) ) {&nbsp;</div></li><li><div>          add_screen_option( 'layout_columns', array( 'default' =&gt; 2, 'max' =&gt; 2, ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>              'id' =&gt; 'bp-profile-edit-overview', &nbsp;</div></li><li><div>              'title' =&gt; __( 'Overview', 'buddypress' ), &nbsp;</div></li><li><div>              'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'This is the admin view of a user&#39;s profile.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'In the main column, you can edit the fields of the user&#39;s extended profile.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'In the right-hand column, you can update the user&#39;s status, delete the user&#39;s avatar, and view recent statistics.', 'buddypress' ) . '&lt;/p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Help panel - sidebar links.</span></span>&nbsp;</div></li><li><div>          get_current_screen()-&gt;set_help_sidebar(&nbsp;</div></li><li><div>              '&lt;p&gt;&lt;strong&gt;' . __( 'For more information:', 'buddypress' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( '&lt;a href=&quot;https:<span class="comment">//codex.buddypress.org/administrator-guide/extended-profiles/&quot;&gt;Managing Profiles&lt;/a&gt;', 'buddypress' ) . '&lt;/p&gt;' .</span>&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( '&lt;a href=&quot;https:<span class="comment"><span class="comment">//buddypress.org/support/&quot;&gt;Support Forums&lt;/a&gt;', 'buddypress' ) . '&lt;/p&gt;'</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Register metaboxes for the edit screen.</span>&nbsp;</div></li><li><div>          add_meta_box(&nbsp;</div></li><li><div>              'submitdiv', &nbsp;</div></li><li><div>              _x( 'Status', 'members user-admin edit screen', 'buddypress' ), &nbsp;</div></li><li><div>              array( $this, 'user_admin_status_metabox' ), &nbsp;</div></li><li><div>              get_current_screen()-&gt;id, &nbsp;</div></li><li><div>              'side', &nbsp;</div></li><li><div>              'core'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// In case xprofile is not active.</span>&nbsp;</div></li><li><div>          $this-&gt;stats_metabox-&gt;context = 'normal';&nbsp;</div></li><li><div>          $this-&gt;stats_metabox-&gt;priority = 'core';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before loading the profile fields if component is active.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Plugins should not use this hook, please use 'bp_members_admin_user_metaboxes' instead.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $user_id       Current user ID for the screen.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $id            Current screen ID.</span>&nbsp;</div></li><li><div><span class="comment">           * @param object $stats_metabox Object holding position data for use with the stats metabox.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action_ref_array( 'bp_members_admin_xprofile_metabox', array( $user_id, get_current_screen()-&gt;id, $this-&gt;stats_metabox ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If xProfile is inactive, difficult to know what's profile we're on.</span>&nbsp;</div></li><li><div>          if ( 'normal' === $this-&gt;stats_metabox-&gt;context ) {&nbsp;</div></li><li><div>              $display_name = bp_core_get_user_displayname( $user_id );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $display_name = __( 'Member', 'buddypress' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// User Stat metabox.</span>&nbsp;</div></li><li><div>          add_meta_box(&nbsp;</div></li><li><div>              'bp_members_admin_user_stats', &nbsp;</div></li><li><div>              sprintf( _x( &quot;%s's Stats&quot;, 'members user-admin edit screen', 'buddypress' ), $display_name ), &nbsp;</div></li><li><div>              array( $this, 'user_admin_stats_metabox' ), &nbsp;</div></li><li><div>              get_current_screen()-&gt;id, &nbsp;</div></li><li><div>              sanitize_key( $this-&gt;stats_metabox-&gt;context ), &nbsp;</div></li><li><div>              sanitize_key( $this-&gt;stats_metabox-&gt;priority )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Member Type metabox. Only added if member types have been registered.</span>&nbsp;</div></li><li><div>          $member_types = bp_get_member_types();&nbsp;</div></li><li><div>          if ( ! empty( $member_types ) ) {&nbsp;</div></li><li><div>              add_meta_box(&nbsp;</div></li><li><div>                  'bp_members_admin_member_type', &nbsp;</div></li><li><div>                  _x( 'Member Type', 'members user-admin edit screen', 'buddypress' ), &nbsp;</div></li><li><div>                  array( $this, 'user_admin_member_type_metabox' ), &nbsp;</div></li><li><div>                  get_current_screen()-&gt;id, &nbsp;</div></li><li><div>                  'side', &nbsp;</div></li><li><div>                  'core'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires at the end of the Community Profile screen.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Plugins can restrict metabox to &quot;bp_moderate&quot; admins by checking if</span>&nbsp;</div></li><li><div><span class="comment">           * the first argument ($this-&gt;is_self_profile) is false in their callback.</span>&nbsp;</div></li><li><div><span class="comment">           * They can also restrict their metabox to self profile editing</span>&nbsp;</div></li><li><div><span class="comment">           * by setting it to true.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool $is_self_profile Whether or not it is the current user's profile.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int  $user_id         Current user ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'bp_members_admin_user_metaboxes', $this-&gt;is_self_profile, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Enqueue JavaScript files.</span>&nbsp;</div></li><li><div>          wp_enqueue_script( 'postbox' );&nbsp;</div></li><li><div>          wp_enqueue_script( 'dashboard' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Spam or Ham user.</span>&nbsp;</div></li><li><div>      } elseif ( in_array( $doaction, array( 'spam', 'ham' ) ) && empty( $this-&gt;is_self_profile ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          check_admin_referer( 'edit-bp-profile_' . $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( bp_core_process_spammer_status( $user_id, $doaction ) ) {&nbsp;</div></li><li><div>              $redirect_to = add_query_arg( 'updated', $doaction, $redirect_to );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $redirect_to = add_query_arg( 'error', $doaction, $redirect_to );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_redirect( $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update other stuff once above ones are done.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;redirect = $redirect_to;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires at end of user profile admin load if doaction does not match any available actions.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $doaction Current bulk action being processed.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $user_id  Current user ID.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array  $_REQUEST Current $_REQUEST global.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $redirect Determined redirect url to send user to.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action_ref_array( 'bp_members_admin_update_user', array( $doaction, $user_id, $_REQUEST, $this-&gt;redirect ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_redirect( $this-&gt;redirect );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the user's profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_current_user_can( 'bp_moderate' ) && empty( $this-&gt;is_self_profile ) ) {&nbsp;</div></li><li><div>          die( '-1' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get the user ID.</span></span>&nbsp;</div></li><li><div>      $user_id = $this-&gt;get_user_id();&nbsp;</div></li><li><div>      $user = get_user_to_edit( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Construct title.</span>&nbsp;</div></li><li><div>      if ( true === $this-&gt;is_self_profile ) {&nbsp;</div></li><li><div>          $title = __( 'Profile', 'buddypress' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $title = __( 'Edit User', 'buddypress' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Construct URL for form.</span>&nbsp;</div></li><li><div>      $request_url = remove_query_arg( array( 'action', 'error', 'updated', 'spam', 'ham' ), $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>      $form_action_url = add_query_arg( 'action', 'update', $request_url );&nbsp;</div></li><li><div>      $wp_http_referer = false;&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['wp_http_referer'] ) ) {&nbsp;</div></li><li><div>          $wp_http_referer = remove_query_arg( array( 'action', 'updated' ), $_REQUEST['wp_http_referer'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prepare notice for admin.</span>&nbsp;</div></li><li><div>      $notice = $this-&gt;get_user_notice();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $notice ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;div &lt;?php if ( 'updated' === $notice['class'] ) : ?&gt;id=&quot;message&quot; &lt;?php endif; ?&gt;class=&quot;&lt;?php echo esc_attr( $notice['class'] ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php echo esc_html( $notice['message'] ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php if ( !empty( $wp_http_referer ) && ( 'updated' === $notice['class'] ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;p&gt;&lt;a href=&quot;&lt;?php echo esc_url( $wp_http_referer ); ?&gt;&quot;&gt;&lt;?php esc_html_e( '&larr; Back to Users', 'buddypress' ); ?&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot; id=&quot;community-profile-page&quot;&gt;&nbsp;</div></li><li><div>          &lt;h1&gt;&lt;?php echo esc_html( $title ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php if ( empty( $this-&gt;is_self_profile ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php if ( current_user_can( 'create_users' ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;a href=&quot;user-new.php&quot; class=&quot;add-new-h2&quot;&gt;&lt;?php echo esc_html_x( 'Add New', 'user', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php elseif ( is_multisite() && current_user_can( 'promote_users' ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;a href=&quot;user-new.php&quot; class=&quot;add-new-h2&quot;&gt;&lt;?php echo esc_html_x( 'Add Existing', 'user', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>          &lt;/h1&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php if ( ! empty( $user ) ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;profile_nav( $user, 'BuddyPress' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;form action=&quot;&lt;?php echo esc_url( $form_action_url ); ?&gt;&quot; id=&quot;your-profile&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;poststuff&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;div id=&quot;post-body&quot; class=&quot;metabox-holder columns-&lt;?php echo 1 == get_current_screen()-&gt;get_columns() ? '1' : '2'; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;div id=&quot;postbox-container-1&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                              &lt;?php do_meta_boxes( get_current_screen()-&gt;id, 'side', $user ); ?&gt;&nbsp;</div></li><li><div>                          &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;div id=&quot;postbox-container-2&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                              &lt;?php do_meta_boxes( get_current_screen()-&gt;id, 'normal', $user ); ?&gt;&nbsp;</div></li><li><div>                              &lt;?php do_meta_boxes( get_current_screen()-&gt;id, 'advanced', $user ); ?&gt;&nbsp;</div></li><li><div>                          &lt;/div&gt;&nbsp;</div></li><li><div>                      &lt;/div&gt;&lt;!-- #post-body --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;/div&gt;&lt;!-- #poststuff --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php wp_nonce_field( 'closedpostboxes', 'closedpostboxesnonce', false ); ?&gt;&nbsp;</div></li><li><div>                  &lt;?php wp_nonce_field( 'meta-box-order', 'meta-box-order-nonce', false ); ?&gt;&nbsp;</div></li><li><div>                  &lt;?php wp_nonce_field( 'edit-bp-profile_' . $user-&gt;ID ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php else : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php&nbsp;</div></li><li><div>                  printf(&nbsp;</div></li><li><div>                      '%1$s &lt;a href=&quot;%2$s&quot;&gt;%3$s&lt;/a&gt;', &nbsp;</div></li><li><div>                      __( 'No user found with this ID.', 'buddypress' ), &nbsp;</div></li><li><div>                      esc_url( bp_get_admin_url( 'users.php' ) ), &nbsp;</div></li><li><div>                      __( 'Go back and try again.', 'buddypress' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/div&gt;&lt;!-- .wrap --&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render the Status metabox for user's profile screen.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Actions are:</span>&nbsp;</div></li><li><div><span class="comment">   * - Update profile fields if xProfile component is active</span>&nbsp;</div></li><li><div><span class="comment">   * - Spam/Unspam user</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User|null $user The WP_User object to be edited.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin_status_metabox( $user = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if no user id or if the user has not activated their account yet.</span>&nbsp;</div></li><li><div>      if ( empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if user has not been activated yet (how did you get here?).</span>&nbsp;</div></li><li><div>      if ( isset( $user-&gt;user_status ) && ( 2 == $user-&gt;user_status ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;p class=&quot;not-activated&quot;&gt;&lt;?php esc_html_e( 'User account has not yet been activated', 'buddypress' ); ?&gt;&lt;/p&gt;&lt;br/&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;submitbox&quot; id=&quot;submitcomment&quot;&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;minor-publishing&quot;&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;misc-publishing-actions&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Get the spam status once here to compare against below.</span>&nbsp;</div></li><li><div>                  $is_spammer = bp_is_user_spammer( $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                   * In configs where BuddyPress is not network activated, </span>&nbsp;</div></li><li><div><span class="comment">                   * regular admins cannot mark a user as a spammer on front</span>&nbsp;</div></li><li><div><span class="comment">                   * end. This prevent them to do it in the back end.</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * Also prevent admins from marking themselves or other</span>&nbsp;</div></li><li><div><span class="comment">                   * admins as spammers.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>                  if ( ( empty( $this-&gt;is_self_profile ) && ( ! in_array( $user-&gt;user_login, get_super_admins() ) ) && empty( $this-&gt;subsite_activated ) ) || ( ! empty( $this-&gt;subsite_activated ) && current_user_can( 'manage_network_users' ) ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;div class=&quot;misc-pub-section&quot; id=&quot;comment-status-radio&quot;&gt;&nbsp;</div></li><li><div>                          &lt;label class=&quot;approved&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_status&quot; value=&quot;ham&quot; &lt;?php checked( $is_spammer, false ); ?&gt;&gt;&lt;?php esc_html_e( 'Active', 'buddypress' ); ?&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;label class=&quot;spam&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_status&quot; value=&quot;spam&quot; &lt;?php checked( $is_spammer, true ); ?&gt;&gt;&lt;?php esc_html_e( 'Spammer', 'buddypress' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php endif ;?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;div class=&quot;misc-pub-section curtime misc-pub-section-last&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Translators: Publish box date format, see http://php.net/date.</span>&nbsp;</div></li><li><div>                      $datef = __( 'M j, Y @ G:i', 'buddypress' );&nbsp;</div></li><li><div>                      $date = date_i18n( $datef, strtotime( $user-&gt;user_registered ) );&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;span id=&quot;timestamp&quot;&gt;&lt;?php printf( __( 'Registered on: %s', 'buddypress' ), '&lt;strong&gt;' . $date . '&lt;/strong&gt;' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt; &lt;!-- #misc-publishing-actions --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&lt;!-- #minor-publishing --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;div id=&quot;major-publishing-actions&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div id=&quot;publishing-action&quot;&gt;&nbsp;</div></li><li><div>                  &lt;a class=&quot;button bp-view-profile&quot; href=&quot;&lt;?php echo esc_url( bp_core_get_user_domain( $user-&gt;ID ) ); ?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php esc_html_e( 'View Profile', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                  &lt;?php submit_button( esc_html__( 'Update Profile', 'buddypress' ), 'primary', 'save', false ); ?&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&lt;!-- #major-publishing-actions --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/div&gt;&lt;!-- #submitcomment --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render the fallback metabox in case a user has been marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User|null $user The WP_User object to be edited.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin_spammer_metabox( $user = null ) {&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php printf( __( '%s has been marked as a spammer. All BuddyPress data associated with the user has been removed', 'buddypress' ), esc_html( bp_core_get_user_displayname( $user-&gt;ID ) ) ) ;?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render the Stats metabox to moderate inappropriate images.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User|null $user The WP_User object to be edited.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin_stats_metabox( $user = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Bail if no user ID.</span></span></span>&nbsp;</div></li><li><div>      if ( empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If account is not activated last activity is the time user registered.</span>&nbsp;</div></li><li><div>      if ( isset( $user-&gt;user_status ) && 2 == $user-&gt;user_status ) {&nbsp;</div></li><li><div>          $last_active = $user-&gt;user_registered;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Account is activated, getting user's last activity.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $last_active = bp_get_user_last_activity( $user-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $datef = __( 'M j, Y @ G:i', 'buddypress' );&nbsp;</div></li><li><div>      $date = date_i18n( $datef, strtotime( $last_active ) ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;ul&gt;&nbsp;</div></li><li><div>          &lt;li class=&quot;bp-members-profile-stats&quot;&gt;&lt;?php printf( __( 'Last active: %1$s', 'buddypress' ), '&lt;strong&gt;' . $date . '&lt;/strong&gt;' ); ?&gt;&lt;/li&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          <span class="comment">// Loading other stats only if user has activated their account.</span>&nbsp;</div></li><li><div>          if ( empty( $user-&gt;user_status ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Fires in the user stats metabox if the user has activated their account.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param array  $value Array holding the user ID.</span>&nbsp;</div></li><li><div><span class="comment">               * @param object $user  Current displayed user object.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              do_action( 'bp_members_admin_user_stats', array( 'user_id' =&gt; $user-&gt;ID ), $user );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>      &lt;/ul&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render the Member Type metabox.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User|null $user The WP_User object to be edited.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function user_admin_member_type_metabox( $user = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Bail if no user ID.</span></span></span>&nbsp;</div></li><li><div>      if ( empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $types = bp_get_member_types( array(), 'objects' );&nbsp;</div></li><li><div>      $current_type = bp_get_member_type( $user-&gt;ID );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;label for=&quot;bp-members-profile-member-type&quot; class=&quot;screen-reader-text&quot;&gt;&lt;?php&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: accessibility text */</span></span></span></span>&nbsp;</div></li><li><div>          esc_html_e( 'Select member type', 'buddypress' );&nbsp;</div></li><li><div>      ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>      &lt;select name=&quot;bp-members-profile-member-type&quot; id=&quot;bp-members-profile-member-type&quot;&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;&quot; &lt;?php selected( '', $current_type ); ?&gt;&gt;&lt;?php&nbsp;</div></li><li><div>              <span class="comment">/** translators: no option picked in select box */</span>&nbsp;</div></li><li><div>              esc_attr_e( '----', 'buddypress' );&nbsp;</div></li><li><div>          ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;?php foreach ( $types as $type ) : ?&gt;&nbsp;</div></li><li><div>              &lt;option value=&quot;&lt;?php echo esc_attr( $type-&gt;name ) ?&gt;&quot; &lt;?php selected( $type-&gt;name, $current_type ) ?&gt;&gt;&lt;?php echo esc_html( $type-&gt;labels['singular_name'] ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>      &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_nonce_field( 'bp-member-type-change-' . $user-&gt;ID, 'bp-member-type-nonce' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process changes from the Member Type metabox.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_member_type_update() {&nbsp;</div></li><li><div>      if ( ! isset( $_POST['bp-member-type-nonce'] ) || ! isset( $_POST['bp-members-profile-member-type'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_id = $this-&gt;get_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      check_admin_referer( 'bp-member-type-change-' . $user_id, 'bp-member-type-nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Permission check.</span>&nbsp;</div></li><li><div>      if ( ! current_user_can( 'bp_moderate' ) && $user_id != bp_loggedin_user_id() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Member type string must either reference a valid member type, or be empty.</span>&nbsp;</div></li><li><div>      $member_type = stripslashes( $_POST['bp-members-profile-member-type'] );&nbsp;</div></li><li><div>      if ( ! empty( $member_type ) && ! bp_get_member_type_object( $member_type ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If an invalid member type is passed, someone's doing something</span>&nbsp;</div></li><li><div><span class="comment">       * fishy with the POST request, so we can fail silently.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( bp_set_member_type( $user_id, $member_type ) ) {&nbsp;</div></li><li><div>          <span class="comment">// @todo Success messages can't be posted because other stuff happens on the page load.</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a link to Profile in Users listing row actions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|string $actions WordPress row actions (edit, delete).</span>&nbsp;</div></li><li><div><span class="comment">   * @param object|null  $user    The object for the user row.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Merged actions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function row_actions( $actions = '', $user = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Bail if no user ID.</span></span></span>&nbsp;</div></li><li><div>      if ( empty( $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup args array.</span>&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the user ID if it's not for the current user.</span>&nbsp;</div></li><li><div>      if ( $user-&gt;ID !== $this-&gt;current_user_id ) {&nbsp;</div></li><li><div>          $args['user_id'] = $user-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the referer.</span>&nbsp;</div></li><li><div>      $args['wp_http_referer'] = urlencode( wp_unslash( $_SERVER['REQUEST_URI'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the &quot;Extended&quot; link if the current user can edit this user.</span>&nbsp;</div></li><li><div>      if ( current_user_can( 'edit_user', $user-&gt;ID ) || bp_current_user_can( 'bp_moderate' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add query args and setup the Extended link.</span>&nbsp;</div></li><li><div>          $edit_profile = add_query_arg( $args, $this-&gt;edit_profile_url );&nbsp;</div></li><li><div>          $edit_profile_link = sprintf( '&lt;a href=&quot;%1$s&quot;&gt;%2$s&lt;/a&gt;', esc_url( $edit_profile ), esc_html__( 'Extended', 'buddypress' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Check the edit action is available</span>&nbsp;</div></li><li><div><span class="comment">           * and preserve the order edit | profile | remove/delete.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! empty( $actions['edit'] ) ) {&nbsp;</div></li><li><div>              $edit_action = $actions['edit'];&nbsp;</div></li><li><div>              unset( $actions['edit'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $new_edit_actions = array(&nbsp;</div></li><li><div>                  'edit' =&gt; $edit_action, &nbsp;</div></li><li><div>                  'edit-profile' =&gt; $edit_profile_link, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If not available simply add the edit profile action.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $new_edit_actions = array( 'edit-profile' =&gt; $edit_profile_link );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $actions = array_merge( $new_edit_actions, $actions );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $actions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a filter to edit profile url in WP Admin Bar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_edit_profile_url_filter() {&nbsp;</div></li><li><div>      add_filter( 'bp_members_edit_profile_url', array( $this, 'filter_adminbar_profile_link' ), 10, 3 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the profile url.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $profile_link Profile Link for admin bar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $url          Profile URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id      User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function filter_adminbar_profile_link( $profile_link = '', $url = '', $user_id = 0 ) {&nbsp;</div></li><li><div>      if ( ! is_super_admin( $user_id ) && is_admin() ) {&nbsp;</div></li><li><div>          $profile_link = user_admin_url( 'profile.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $profile_link;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove the filter to edit profile url in WP Admin Bar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_edit_profile_url_filter() {&nbsp;</div></li><li><div>      remove_filter( 'bp_members_edit_profile_url', array( $this, 'filter_adminbar_profile_link' ), 10 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Signups Management ****************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the admin preferences about signups pagination.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $value     Value for signup option.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $option    Value for the option key.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $new_value Value for the saved option.</span>&nbsp;</div></li><li><div><span class="comment">   * @return int The pagination preferences.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signup_screen_options( $value = 0, $option = '', $new_value = 0 ) {&nbsp;</div></li><li><div>      if ( 'users_page_bp_signups_network_per_page' != $option && 'users_page_bp_signups_per_page' != $option ) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Per page.</span>&nbsp;</div></li><li><div>      $new_value = (int) $new_value;&nbsp;</div></li><li><div>      if ( $new_value &lt; 1 || $new_value &gt; 999 ) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $new_value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Make sure no signups will show in users list.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This is needed to handle signups that may have not been activated</span>&nbsp;</div></li><li><div><span class="comment">   * before the 2.0.0 upgrade.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User_Query|null $query The users query.</span>&nbsp;</div></li><li><div><span class="comment">   * @return WP_User_Query The users query without the signups.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_signups_from_user_query( $query = null ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if this is an ajax request.</span>&nbsp;</div></li><li><div>      if ( defined( 'DOING_AJAX' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if updating BuddyPress.</span>&nbsp;</div></li><li><div>      if ( bp_is_update() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if there is no current admin screen.</span>&nbsp;</div></li><li><div>      if ( ! function_exists( 'get_current_screen' ) || ! get_current_screen() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get current screen.</span>&nbsp;</div></li><li><div>      $current_screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if not on a users page.</span>&nbsp;</div></li><li><div>      if ( ! isset( $current_screen-&gt;id ) || $this-&gt;users_page !== $current_screen-&gt;id ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if already querying by an existing role.</span>&nbsp;</div></li><li><div>      if ( ! empty( $query-&gt;query_vars['role'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query-&gt;query_where .= &quot; AND {$wpdb-&gt;users}.user_status != 2&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter the WP Users List Table views to include 'bp-signups'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $views WP List Table views.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array The views with the signup view added.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signup_filter_view( $views = array() ) {&nbsp;</div></li><li><div>      global $role;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove the 'current' class from All if we're on the signups view.</span>&nbsp;</div></li><li><div>      if ( 'registered' === $role ) {&nbsp;</div></li><li><div>          $views['all'] = str_replace( 'class=&quot;current&quot;', '', $views['all'] );&nbsp;</div></li><li><div>          $class = 'current';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $class = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $signups = BP_Signup::count_signups();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_network_admin() ) {&nbsp;</div></li><li><div>          $base_url = network_admin_url( 'users.php' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $base_url = bp_get_admin_url( 'users.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg( 'page', 'bp-signups', $base_url );&nbsp;</div></li><li><div>      $text = sprintf( _x( 'Pending %s', 'signup users', 'buddypress' ), '&lt;span class=&quot;count&quot;&gt;(' . number_format_i18n( $signups ) . ')&lt;/span&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $views['registered'] = sprintf( '&lt;a href=&quot;%1$s&quot; class=&quot;%2$s&quot;&gt;%3$s&lt;/a&gt;', esc_url( $url ), $class, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $views;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Load the Signup WP Users List table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $class    The name of the class to use.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $required The parent class.</span>&nbsp;</div></li><li><div><span class="comment">   * @return WP_List_Table The List table.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_list_table_class( $class = '', $required = '' ) {&nbsp;</div></li><li><div>      if ( empty( $class ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $required ) ) {&nbsp;</div></li><li><div>          require_once( ABSPATH . 'wp-admin/includes/class-wp-' . $required . '-list-table.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return new $class();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the signups admin page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Loaded before the page is rendered, this function does all initial</span>&nbsp;</div></li><li><div><span class="comment">   * setup, including: processing form requests, registering contextual</span>&nbsp;</div></li><li><div><span class="comment">   * help, and setting up screen options.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global $bp_members_signup_list_table</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signups_admin_load() {&nbsp;</div></li><li><div>      global $bp_members_signup_list_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Build redirection URL.</span></span>&nbsp;</div></li><li><div>      $redirect_to = remove_query_arg( array( 'action', 'error', 'updated', 'activated', 'notactivated', 'deleted', 'notdeleted', 'resent', 'notresent', 'do_delete', 'do_resend', 'do_activate', '_wpnonce', 'signup_ids' ), $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>      $doaction = bp_admin_list_table_current_bulk_action();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the start of the signups admin load.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $doaction Current bulk action being processed.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $_REQUEST Current $_REQUEST global.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_signups_admin_load', $doaction, $_REQUEST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the allowed actions for use in the user signups admin page.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $value Array of allowed actions to use.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $allowed_actions = apply_filters( 'bp_signups_admin_allowed_actions', array( 'do_delete', 'do_activate', 'do_resend' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Prepare the display of the Community Profile screen.</span></span>&nbsp;</div></li><li><div>      if ( ! in_array( $doaction, $allowed_actions ) || ( -1 == $doaction ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_network_admin() ) {&nbsp;</div></li><li><div>              $bp_members_signup_list_table = self::get_list_table_class( 'BP_Members_MS_List_Table', 'ms-users' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $bp_members_signup_list_table = self::get_list_table_class( 'BP_Members_List_Table', 'users' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The per_page screen option.</span>&nbsp;</div></li><li><div>          add_screen_option( 'per_page', array( 'label' =&gt; _x( 'Pending Accounts', 'Pending Accounts per page (screen options)', 'buddypress' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>              'id' =&gt; 'bp-signups-overview', &nbsp;</div></li><li><div>              'title' =&gt; __( 'Overview', 'buddypress' ), &nbsp;</div></li><li><div>              'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'This is the administration screen for pending accounts on your site.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'From the screen options, you can customize the displayed columns and the pagination of this screen.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'You can reorder the list of your pending accounts by clicking on the Username, Email or Registered column headers.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'Using the search form, you can find pending accounts more easily. The Username and Email fields will be included in the search.', 'buddypress' ) . '&lt;/p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>              'id' =&gt; 'bp-signups-actions', &nbsp;</div></li><li><div>              'title' =&gt; __( 'Actions', 'buddypress' ), &nbsp;</div></li><li><div>              'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'Hovering over a row in the pending accounts list will display action links that allow you to manage pending accounts. You can perform the following actions:', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;ul&gt;&lt;li&gt;' . __( '&quot;Email&quot; takes you to the confirmation screen before being able to send the activation link to the desired pending account. You can only send the activation email once per day.', 'buddypress' ) . '&lt;/li&gt;' .&nbsp;</div></li><li><div>              '&lt;li&gt;' . __( '&quot;Delete&quot; allows you to delete a pending account from your site. You will be asked to confirm this deletion.', 'buddypress' ) . '&lt;/li&gt;&lt;/ul&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'By clicking on a Username you will be able to activate a pending account from the confirmation screen.', 'buddypress' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'Bulk actions allow you to perform these 3 actions for the selected rows.', 'buddypress' ) . '&lt;/p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Help panel - sidebar links.</span></span>&nbsp;</div></li><li><div>          get_current_screen()-&gt;set_help_sidebar(&nbsp;</div></li><li><div>              '&lt;p&gt;&lt;strong&gt;' . __( 'For more information:', 'buddypress' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( '&lt;a href=&quot;https:<span class="comment"><span class="comment">//buddypress.org/support/&quot;&gt;Support Forums&lt;/a&gt;', 'buddypress' ) . '&lt;/p&gt;'</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add accessible hidden headings and text for the Pending Users screen.</span>&nbsp;</div></li><li><div>          if ( bp_get_major_wp_version() &gt;= 4.4 ) {&nbsp;</div></li><li><div>              get_current_screen()-&gt;set_screen_reader_content( array(&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: accessibility text */</span></span></span></span>&nbsp;</div></li><li><div>                  'heading_views' =&gt; __( 'Filter users list', 'buddypress' ), &nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: accessibility text */</span></span></span></span>&nbsp;</div></li><li><div>                  'heading_pagination' =&gt; __( 'Pending users list navigation', 'buddypress' ), &nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: accessibility text */</span></span></span></span>&nbsp;</div></li><li><div>                  'heading_list' =&gt; __( 'Pending users list', 'buddypress' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( ! empty( $_REQUEST['signup_ids' ] ) ) {&nbsp;</div></li><li><div>              $signups = wp_parse_id_list( $_REQUEST['signup_ids' ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Handle resent activation links.</span>&nbsp;</div></li><li><div>          if ( 'do_resend' == $doaction ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Nonce check.</span></span></span>&nbsp;</div></li><li><div>              check_admin_referer( 'signups_resend' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $resent = BP_Signup::resend( $signups );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( empty( $resent ) ) {&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( 'error', $doaction, $redirect_to );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $query_arg = array( 'updated' =&gt; 'resent' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $resent['resent'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['resent'] = count( $resent['resent'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $resent['errors'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['notsent'] = count( $resent['errors'] );&nbsp;</div></li><li><div>                      set_transient( '_bp_admin_signups_errors', $resent['errors'], 30 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( $query_arg, $redirect_to );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              bp_core_redirect( $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Handle activated accounts.</span>&nbsp;</div></li><li><div>          } elseif ( 'do_activate' == $doaction ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Nonce check.</span></span></span>&nbsp;</div></li><li><div>              check_admin_referer( 'signups_activate' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $activated = BP_Signup::activate( $signups );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( empty( $activated ) ) {&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( 'error', $doaction, $redirect_to );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $query_arg = array( 'updated' =&gt; 'activated' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $activated['activated'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['activated'] = count( $activated['activated'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $activated['errors'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['notactivated'] = count( $activated['errors'] );&nbsp;</div></li><li><div>                      set_transient( '_bp_admin_signups_errors', $activated['errors'], 30 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( $query_arg, $redirect_to );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              bp_core_redirect( $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Handle sign-ups delete.</span>&nbsp;</div></li><li><div>          } elseif ( 'do_delete' == $doaction ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Nonce check.</span></span></span>&nbsp;</div></li><li><div>              check_admin_referer( 'signups_delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $deleted = BP_Signup::delete( $signups );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( empty( $deleted ) ) {&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( 'error', $doaction, $redirect_to );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $query_arg = array( 'updated' =&gt; 'deleted' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $deleted['deleted'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['deleted'] = count( $deleted['deleted'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $deleted['errors'] ) ) {&nbsp;</div></li><li><div>                      $query_arg['notdeleted'] = count( $deleted['errors'] );&nbsp;</div></li><li><div>                      set_transient( '_bp_admin_signups_errors', $deleted['errors'], 30 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $redirect_to = add_query_arg( $query_arg, $redirect_to );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              bp_core_redirect( $redirect_to );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Plugins can update other stuff from here.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;redirect = $redirect_to;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Fires at end of signups admin load if doaction does not match any actions.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $doaction Current bulk action being processed.</span>&nbsp;</div></li><li><div><span class="comment">               * @param array  $_REQUEST Current $_REQUEST global.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $redirect Determined redirect url to send user to.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              do_action( 'bp_members_admin_update_signups', $doaction, $_REQUEST, $this-&gt;redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              bp_core_redirect( $this-&gt;redirect );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display any activation errors.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signups_display_errors() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Look for sign-up errors.</span>&nbsp;</div></li><li><div>      $errors = get_transient( '_bp_admin_signups_errors' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if no activation errors.</span>&nbsp;</div></li><li><div>      if ( empty( $errors ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through errors and display them.</span>&nbsp;</div></li><li><div>      foreach ( $errors as $error ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;li&gt;&lt;?php echo esc_html( $error[0] );?&gt;: &lt;?php echo esc_html( $error[1] );?&gt;&lt;/li&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php endforeach;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete the redirect transient.</span>&nbsp;</div></li><li><div>      delete_transient( '_bp_admin_signups_errors' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get admin notice when viewing the sign-up page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_signup_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Setup empty notice for return value.</span></span>&nbsp;</div></li><li><div>      $notice = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Updates.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['updated'] ) ) {&nbsp;</div></li><li><div>          switch ( $_REQUEST['updated'] ) {&nbsp;</div></li><li><div>              case 'resent':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'updated', &nbsp;</div></li><li><div>                      'message' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['resent'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s activation email successfully sent! ', '%s activation emails successfully sent! ', &nbsp;</div></li><li><div>                           absint( $_REQUEST['resent'] ), &nbsp;</div></li><li><div>                           'signup resent', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['resent'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['notsent'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s activation email was not sent.', '%s activation emails were not sent.', &nbsp;</div></li><li><div>                           absint( $_REQUEST['notsent'] ), &nbsp;</div></li><li><div>                           'signup notsent', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['notsent'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( empty( $_REQUEST['resent'] ) ) {&nbsp;</div></li><li><div>                          $notice['class'] = 'error';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'activated':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'updated', &nbsp;</div></li><li><div>                      'message' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['activated'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s account successfully activated! ', '%s accounts successfully activated! ', &nbsp;</div></li><li><div>                           absint( $_REQUEST['activated'] ), &nbsp;</div></li><li><div>                           'signup resent', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['activated'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['notactivated'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s account was not activated.', '%s accounts were not activated.', &nbsp;</div></li><li><div>                           absint( $_REQUEST['notactivated'] ), &nbsp;</div></li><li><div>                           'signup notsent', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['notactivated'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( empty( $_REQUEST['activated'] ) ) {&nbsp;</div></li><li><div>                          $notice['class'] = 'error';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'deleted':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'updated', &nbsp;</div></li><li><div>                      'message' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['deleted'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s sign-up successfully deleted!', '%s sign-ups successfully deleted!', &nbsp;</div></li><li><div>                           absint( $_REQUEST['deleted'] ), &nbsp;</div></li><li><div>                           'signup deleted', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['deleted'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $_REQUEST['notdeleted'] ) ) {&nbsp;</div></li><li><div>                      $notice['message'] .= sprintf(&nbsp;</div></li><li><div>                          _nx( '%s sign-up was not deleted.', '%s sign-ups were not deleted.', &nbsp;</div></li><li><div>                           absint( $_REQUEST['notdeleted'] ), &nbsp;</div></li><li><div>                           'signup notdeleted', &nbsp;</div></li><li><div>                           'buddypress'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                          number_format_i18n( absint( $_REQUEST['notdeleted'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( empty( $_REQUEST['deleted'] ) ) {&nbsp;</div></li><li><div>                          $notice['class'] = 'error';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Errors.</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['error'] ) ) {&nbsp;</div></li><li><div>          switch ( $_REQUEST['error'] ) {&nbsp;</div></li><li><div>              case 'do_resend':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'error', &nbsp;</div></li><li><div>                      'message' =&gt; esc_html__( 'There was a problem sending the activation emails. Please try again.', 'buddypress' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'do_activate':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'error', &nbsp;</div></li><li><div>                      'message' =&gt; esc_html__( 'There was a problem activating accounts. Please try again.', 'buddypress' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'do_delete':&nbsp;</div></li><li><div>                  $notice = array(&nbsp;</div></li><li><div>                      'class' =&gt; 'error', &nbsp;</div></li><li><div>                      'message' =&gt; esc_html__( 'There was a problem deleting sign-ups. Please try again.', 'buddypress' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $notice;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Signups admin page router.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Depending on the context, display</span>&nbsp;</div></li><li><div><span class="comment">   * - the list of signups, </span>&nbsp;</div></li><li><div><span class="comment">   * - or the delete confirmation screen, </span>&nbsp;</div></li><li><div><span class="comment">   * - or the activate confirmation screen, </span>&nbsp;</div></li><li><div><span class="comment">   * - or the &quot;resend&quot; email confirmation screen.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Also prepare the admin notices.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signups_admin() {&nbsp;</div></li><li><div>      $doaction = bp_admin_list_table_current_bulk_action();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prepare notices for admin.</span>&nbsp;</div></li><li><div>      $notice = $this-&gt;get_signup_notice();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display notices.</span>&nbsp;</div></li><li><div>      if ( ! empty( $notice ) ) :&nbsp;</div></li><li><div>          if ( 'updated' === $notice['class'] ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div id=&quot;message&quot; class=&quot;&lt;?php echo esc_attr( $notice['class'] ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php else: ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div class=&quot;&lt;?php echo esc_attr( $notice['class'] ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php echo $notice['message']; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php if ( ! empty( $_REQUEST['notactivated'] ) || ! empty( $_REQUEST['notdeleted'] ) || ! empty( $_REQUEST['notsent'] ) ) :?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;ul&gt;&lt;?php $this-&gt;signups_display_errors();?&gt;&lt;/ul&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endif ;?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Show the proper screen.</span>&nbsp;</div></li><li><div>      switch ( $doaction ) {&nbsp;</div></li><li><div>          case 'activate' :&nbsp;</div></li><li><div>          case 'delete' :&nbsp;</div></li><li><div>          case 'resend' :&nbsp;</div></li><li><div>              $this-&gt;signups_admin_manage( $doaction );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $this-&gt;signups_admin_index();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This is the list of the Pending accounts (signups).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global $plugin_page</span>&nbsp;</div></li><li><div><span class="comment">   * @global $bp_members_signup_list_table</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signups_admin_index() {&nbsp;</div></li><li><div>      global $plugin_page, $bp_members_signup_list_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $usersearch = ! empty( $_REQUEST['s'] ) ? stripslashes( $_REQUEST['s'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prepare the group items for display.</span>&nbsp;</div></li><li><div>      $bp_members_signup_list_table-&gt;prepare_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_network_admin() ) {&nbsp;</div></li><li><div>          $form_url = network_admin_url( 'users.php' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $form_url = bp_get_admin_url( 'users.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_url = add_query_arg(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'page' =&gt; 'bp-signups', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          $form_url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $search_form_url = remove_query_arg(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'action', &nbsp;</div></li><li><div>              'deleted', &nbsp;</div></li><li><div>              'notdeleted', &nbsp;</div></li><li><div>              'error', &nbsp;</div></li><li><div>              'updated', &nbsp;</div></li><li><div>              'delete', &nbsp;</div></li><li><div>              'activate', &nbsp;</div></li><li><div>              'activated', &nbsp;</div></li><li><div>              'notactivated', &nbsp;</div></li><li><div>              'resend', &nbsp;</div></li><li><div>              'resent', &nbsp;</div></li><li><div>              'notresent', &nbsp;</div></li><li><div>              'do_delete', &nbsp;</div></li><li><div>              'do_activate', &nbsp;</div></li><li><div>              'do_resend', &nbsp;</div></li><li><div>              'action2', &nbsp;</div></li><li><div>              '_wpnonce', &nbsp;</div></li><li><div>              'signup_ids'&nbsp;</div></li><li><div> ), $_SERVER['REQUEST_URI']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;h1&gt;&lt;?php _e( 'Users', 'buddypress' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php if ( current_user_can( 'create_users' ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;a href=&quot;user-new.php&quot; class=&quot;add-new-h2&quot;&gt;&lt;?php echo esc_html_x( 'Add New', 'user', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php elseif ( is_multisite() && current_user_can( 'promote_users' ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;a href=&quot;user-new.php&quot; class=&quot;add-new-h2&quot;&gt;&lt;?php echo esc_html_x( 'Add Existing', 'user', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $usersearch ) {&nbsp;</div></li><li><div>                  printf( '&lt;span class=&quot;subtitle&quot;&gt;' . __( 'Search results for &#8220;%s&#8221;', 'buddypress' ) . '&lt;/span&gt;', esc_html( $usersearch ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/h1&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php <span class="comment">// Display each signups on its own row. ?&gt;</span>&nbsp;</div></li><li><div>          &lt;?php $bp_members_signup_list_table-&gt;views(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;form id=&quot;bp-signups-search-form&quot; action=&quot;&lt;?php echo esc_url( $search_form_url ) ;?&gt;&quot;&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;page&quot; value=&quot;&lt;?php echo esc_attr( $plugin_page ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;?php $bp_members_signup_list_table-&gt;search_box( __( 'Search Pending Users', 'buddypress' ), 'bp-signups' ); ?&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;form id=&quot;bp-signups-form&quot; action=&quot;&lt;?php echo esc_url( $form_url );?&gt;&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php $bp_members_signup_list_table-&gt;display(); ?&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This is the confirmation screen for actions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $action Delete, activate, or resend activation link.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signups_admin_manage( $action = '' ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( $this-&gt;capability ) || empty( $action ) ) {&nbsp;</div></li><li><div>          die( '-1' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the user IDs from the URL.</span>&nbsp;</div></li><li><div>      $ids = false;&nbsp;</div></li><li><div>      if ( ! empty( $_POST['allsignups'] ) ) {&nbsp;</div></li><li><div>          $ids = wp_parse_id_list( $_POST['allsignups'] );&nbsp;</div></li><li><div>      } elseif ( ! empty( $_GET['signup_id'] ) ) {&nbsp;</div></li><li><div>          $ids = absint( $_GET['signup_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $ids ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Query for signups, and filter out those IDs that don't</span>&nbsp;</div></li><li><div>      <span class="comment">// correspond to an actual signup.</span>&nbsp;</div></li><li><div>      $signups_query = BP_Signup::get( array(&nbsp;</div></li><li><div>          'include' =&gt; $ids, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $signups = $signups_query['signups'];&nbsp;</div></li><li><div>      $signup_ids = wp_list_pluck( $signups, 'signup_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set up strings.</span>&nbsp;</div></li><li><div>      switch ( $action ) {&nbsp;</div></li><li><div>          case 'delete' :&nbsp;</div></li><li><div>              $header_text = __( 'Delete Pending Accounts', 'buddypress' );&nbsp;</div></li><li><div>              if ( 1 == count( $signup_ids ) ) {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to delete the following account:', 'buddypress' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to delete the following accounts:', 'buddypress' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'activate' :&nbsp;</div></li><li><div>              $header_text = __( 'Activate Pending Accounts', 'buddypress' );&nbsp;</div></li><li><div>              if ( 1 == count( $signup_ids ) ) {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to activate the following account:', 'buddypress' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to activate the following accounts:', 'buddypress' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'resend' :&nbsp;</div></li><li><div>              $header_text = __( 'Resend Activation Emails', 'buddypress' );&nbsp;</div></li><li><div>              if ( 1 == count( $signup_ids ) ) {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to resend an activation email to the following account:', 'buddypress' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $helper_text = __( 'You are about to resend an activation email to the following accounts:', 'buddypress' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// These arguments are added to all URLs.</span>&nbsp;</div></li><li><div>      $url_args = array( 'page' =&gt; 'bp-signups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// These arguments are only added when performing an action.</span>&nbsp;</div></li><li><div>      $action_args = array(&nbsp;</div></li><li><div>          'action' =&gt; 'do_' . $action, &nbsp;</div></li><li><div>          'signup_ids' =&gt; implode( ', ', $signup_ids )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_network_admin() ) {&nbsp;</div></li><li><div>          $base_url = network_admin_url( 'users.php' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $base_url = bp_get_admin_url( 'users.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cancel_url = add_query_arg( $url_args, $base_url );&nbsp;</div></li><li><div>      $action_url = wp_nonce_url(&nbsp;</div></li><li><div>          add_query_arg(&nbsp;</div></li><li><div>              array_merge( $url_args, $action_args ), &nbsp;</div></li><li><div>              $base_url&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'signups_' . $action&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prefetch registration field data.</span>&nbsp;</div></li><li><div>      $fdata = array();&nbsp;</div></li><li><div>      if ( 'activate' === $action && bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>          $fields = bp_xprofile_get_groups( array(&nbsp;</div></li><li><div>              'profile_group_id' =&gt; 1, &nbsp;</div></li><li><div>              'exclude_fields' =&gt; 1, &nbsp;</div></li><li><div>              'update_meta_cache' =&gt; false, &nbsp;</div></li><li><div>              'fetch_fields' =&gt; true, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          $fields = $fields[0]-&gt;fields;&nbsp;</div></li><li><div>          foreach( $fields as $f ) {&nbsp;</div></li><li><div>              $fdata[ $f-&gt;id ] = $f-&gt;name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;h1&gt;&lt;?php echo esc_html( $header_text ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php echo esc_html( $helper_text ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;ol class=&quot;bp-signups-list&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php foreach ( $signups as $signup ) :&nbsp;</div></li><li><div>              $last_notified = mysql2date( 'Y/m/d g:i:s a', $signup-&gt;date_sent );&nbsp;</div></li><li><div>              $profile_field_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get all xprofile field IDs except field 1.</span>&nbsp;</div></li><li><div>              if ( ! empty( $signup-&gt;meta['profile_field_ids'] ) ) {&nbsp;</div></li><li><div>                  $profile_field_ids = array_flip( explode( ', ', $signup-&gt;meta['profile_field_ids'] ) );&nbsp;</div></li><li><div>                  unset( $profile_field_ids[1] );&nbsp;</div></li><li><div>              } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;li&gt;&nbsp;</div></li><li><div>                  &lt;strong&gt;&lt;?php echo esc_html( $signup-&gt;user_login ) ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php if ( 'activate' == $action ) : ?&gt;&nbsp;</div></li><li><div>                      &lt;table class=&quot;wp-list-table widefat fixed striped&quot;&gt;&nbsp;</div></li><li><div>                          &lt;tbody&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;column-fields&quot;&gt;&lt;?php esc_html_e( 'Display Name', 'buddypress' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;td&gt;&lt;?php echo esc_html( $signup-&gt;user_name ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;column-fields&quot;&gt;&lt;?php esc_html_e( 'Email', 'buddypress' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;td&gt;&lt;?php echo sanitize_email( $signup-&gt;user_email ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;?php if ( bp_is_active( 'xprofile' ) && ! empty( $profile_field_ids ) ) : ?&gt;&nbsp;</div></li><li><div>                                  &lt;?php foreach ( $profile_field_ids as $pid =&gt; $noop ) :&nbsp;</div></li><li><div>                                      $field_value = isset( $signup-&gt;meta[ &quot;field_{$pid}&quot; ] ) ? $signup-&gt;meta[ &quot;field_{$pid}&quot; ] : ''; ?&gt;&nbsp;</div></li><li><div>                                      &lt;tr&gt;&nbsp;</div></li><li><div>                                          &lt;td class=&quot;column-fields&quot;&gt;&lt;?php echo esc_html( $fdata[ $pid ] ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                          &lt;td&gt;&lt;?php echo $this-&gt;format_xprofile_field_for_display( $field_value ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  &lt;?php endforeach;  ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;/tbody&gt;&nbsp;</div></li><li><div>                      &lt;/table&gt;&nbsp;</div></li><li><div>                  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php if ( 'resend' == $action ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;p class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>                          &lt;?php printf( esc_html__( 'Last notified: %s', 'buddypress'), $last_notified ) ;?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;?php if ( ! empty( $signup-&gt;recently_sent ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              &lt;span class=&quot;attention wp-ui-text-notification&quot;&gt; &lt;?php esc_html_e( '(less than 24 hours ago)', 'buddypress' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>                      &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;/li&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>          &lt;/ol&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php if ( 'delete' === $action ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;strong&gt;&lt;?php esc_html_e( 'This action cannot be undone.', 'buddypress' ) ?&gt;&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif ; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;a class=&quot;button-primary&quot; href=&quot;&lt;?php echo esc_url( $action_url ); ?&gt;&quot;&gt;&lt;?php esc_html_e( 'Confirm', 'buddypress' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;a class=&quot;button&quot; href=&quot;&lt;?php echo esc_url( $cancel_url ); ?&gt;&quot;&gt;&lt;?php esc_html_e( 'Cancel', 'buddypress' ) ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Users List Management ****************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display a dropdown to bulk change the member type of selected user(s).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $which Where this dropdown is displayed - top or bottom.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_table_output_type_change_select( $which = 'top' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Bail if current user cannot promote users.</span></span>&nbsp;</div></li><li><div>      if ( ! bp_current_user_can( 'promote_users' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// `$which` is only passed in WordPress 4.6+. Avoid duplicating controls in earlier versions.</span>&nbsp;</div></li><li><div>      static $displayed = false;&nbsp;</div></li><li><div>      if ( version_compare( bp_get_major_wp_version(), '4.6', '&lt;' ) && $displayed ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $displayed = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id_name = 'bottom' === $which ? 'bp_change_type2' : 'bp_change_type';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $types = bp_get_member_types( array(), 'objects' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;label class=&quot;screen-reader-text&quot; for=&quot;&lt;?php echo $id_name; ?&gt;&quot;&gt;&lt;?php _e( 'Change member type to&hellip;', 'buddypress' ) ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>      &lt;select name=&quot;&lt;?php echo $id_name; ?&gt;&quot; id=&quot;&lt;?php echo $id_name; ?&gt;&quot; style=&quot;display:inline-block;float:none;&quot;&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;&quot;&gt;&lt;?php _e( 'Change member type to&hellip;', 'buddypress' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php foreach( $types as $type ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;option value=&quot;&lt;?php echo esc_attr( $type-&gt;name ); ?&gt;&quot;&gt;&lt;?php echo esc_html( $type-&gt;labels['singular_name'] ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;option value=&quot;remove_member_type&quot;&gt;&lt;?php _e( 'No Member Type', 'buddypress' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/select&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      wp_nonce_field( 'bp-bulk-users-change-type-' . bp_loggedin_user_id(), 'bp-bulk-users-change-type-nonce' );&nbsp;</div></li><li><div>      submit_button( __( 'Change', 'buddypress' ), 'button', 'bp_change_member_type', false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process bulk member type change submission from the WP admin users list table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_table_process_bulk_type_change() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Output the</span> admin notice.</span>&nbsp;</div></li><li><div>      $this-&gt;users_type_change_notice();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if no users are specified or if this isn't a BuddyPress action.</span>&nbsp;</div></li><li><div>      if ( empty( $_REQUEST['users'] )&nbsp;</div></li><li><div>          || ( empty( $_REQUEST['bp_change_type'] ) && empty( $_REQUEST['bp_change_type2'] ) )&nbsp;</div></li><li><div>          || empty( $_REQUEST['bp_change_member_type'] )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if nonce check fails.</span>&nbsp;</div></li><li><div>      check_admin_referer( 'bp-bulk-users-change-type-' . bp_loggedin_user_id(), 'bp-bulk-users-change-type-nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Bail if current user cannot promote users.</span></span>&nbsp;</div></li><li><div>      if ( ! bp_current_user_can( 'promote_users' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_type = '';&nbsp;</div></li><li><div>      if ( ! empty( $_REQUEST['bp_change_type2'] ) ) {&nbsp;</div></li><li><div>          $new_type = sanitize_text_field( $_REQUEST['bp_change_type2'] );&nbsp;</div></li><li><div>      } elseif ( ! empty( $_REQUEST['bp_change_type'] ) ) {&nbsp;</div></li><li><div>          $new_type = sanitize_text_field( $_REQUEST['bp_change_type'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check that the selected type actually exists.</span>&nbsp;</div></li><li><div>      if ( 'remove_member_type' != $new_type && null === bp_get_member_type_object( $new_type ) ) {&nbsp;</div></li><li><div>          $error = true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Run through user ids.</span>&nbsp;</div></li><li><div>          $error = false;&nbsp;</div></li><li><div>          foreach ( (array) $_REQUEST['users'] as $user_id ) {&nbsp;</div></li><li><div>              $user_id = (int) $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the old member type to check against.</span>&nbsp;</div></li><li><div>              $member_type = bp_get_member_type( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'remove_member_type' === $new_type ) {&nbsp;</div></li><li><div>                  <span class="comment">// Remove the current member type, if there's one to remove.</span>&nbsp;</div></li><li><div>                  if ( $member_type ) {&nbsp;</div></li><li><div>                      $removed = bp_remove_member_type( $user_id, $member_type );&nbsp;</div></li><li><div>                      if ( false === $removed || is_wp_error( $removed ) ) {&nbsp;</div></li><li><div>                          $error = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// Set the new member type.</span>&nbsp;</div></li><li><div>                  if ( $new_type !== $member_type ) {&nbsp;</div></li><li><div>                      $set = bp_set_member_type( $user_id, $new_type );&nbsp;</div></li><li><div>                      if ( false === $set || is_wp_error( $set ) ) {&nbsp;</div></li><li><div>                          $error = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If there were any errors, show the error message.</span>&nbsp;</div></li><li><div>      if ( $error ) {&nbsp;</div></li><li><div>          $redirect = add_query_arg( array( 'updated' =&gt; 'member-type-change-error' ), wp_get_referer() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $redirect = add_query_arg( array( 'updated' =&gt; 'member-type-change-success' ), wp_get_referer() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_redirect( $redirect );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display an admin notice upon member type bulk update.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_type_change_notice() {&nbsp;</div></li><li><div>      $updated = isset( $_REQUEST['updated'] ) ? $_REQUEST['updated'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display feedback.</span>&nbsp;</div></li><li><div>      if ( $updated && in_array( $updated, array( 'member-type-change-error', 'member-type-change-success' ), true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'member-type-change-error' === $updated ) {&nbsp;</div></li><li><div>              $notice = __( 'There was an error while changing member type. Please try again.', 'buddypress' );&nbsp;</div></li><li><div>              $type = 'error';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $notice = __( 'Member type was changed successfully.', 'buddypress' );&nbsp;</div></li><li><div>              $type = 'updated';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_core_add_admin_notice( $notice, $type );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add member type column to the WordPress admin users list table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $columns Users table columns.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $columns</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_table_add_type_column( $columns = array() ) {&nbsp;</div></li><li><div>      $columns[ bp_get_member_type_tax_name() ] = _x( 'Member Type', 'Label for the WP users table member type column', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $columns;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return member's type for display in the WP admin users list table.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $retval</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $column_name</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Member type as a link to filter all users.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_table_populate_type_cell( $retval = '', $column_name = '', $user_id = 0 ) {&nbsp;</div></li><li><div>      <span class="comment">// Only looking for member type column.</span>&nbsp;</div></li><li><div>      if ( bp_get_member_type_tax_name() !== $column_name ) {&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the member type.</span>&nbsp;</div></li><li><div>      $type = bp_get_member_type( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Output the</span>&nbsp;</div></li><li><div>      if ( $type_obj = bp_get_member_type_object( $type ) ) {&nbsp;</div></li><li><div>          $url = add_query_arg( array( 'bp-member-type' =&gt; urlencode( $type ) ) );&nbsp;</div></li><li><div>          $retval = '&lt;a href=&quot;' . esc_url( $url ) . '&quot;&gt;' . esc_html( $type_obj-&gt;labels['singular_name'] ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter WP Admin users list table to include users of the specified type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Query $query</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function users_table_filter_by_type( $query ) {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() && 'users.php' === $pagenow && ! empty( $_REQUEST['bp-member-type'] ) ) {&nbsp;</div></li><li><div>          $type_slug = sanitize_text_field( $_REQUEST['bp-member-type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Check that the type is registered.</span>&nbsp;</div></li><li><div>          if ( null == bp_get_member_type_object( $type_slug ) ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the list of users that are assigned to this member type.</span>&nbsp;</div></li><li><div>          $type = bp_get_term_by( 'slug', $type_slug, bp_get_member_type_tax_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $type-&gt;term_id ) ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $user_ids = bp_get_objects_in_term( $type-&gt;term_id, bp_get_member_type_tax_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $user_ids && ! is_wp_error( $user_ids ) ) {&nbsp;</div></li><li><div>              $query-&gt;set( 'include', (array) $user_ids );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Formats a signup's xprofile field data for display.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Operates recursively on arrays, which are then imploded with commas.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $value Field value.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function format_xprofile_field_for_display( $value ) {&nbsp;</div></li><li><div>      if ( is_array( $value ) ) {&nbsp;</div></li><li><div>          $value = array_map( array( $this, 'format_xprofile_field_for_display' ), $value );&nbsp;</div></li><li><div>          $value = implode( ', ', $value );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $value = stripslashes( $value );&nbsp;</div></li><li><div>          $value = esc_html( $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif; <span class="comment">// End class_exists check.</span>&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>