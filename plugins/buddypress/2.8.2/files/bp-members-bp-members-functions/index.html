<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49316"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-members-bp-members-functions | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=6e0097b3298a3d5aec8d408b0487a3fa' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-members-bp-members-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-members-bp-members-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-members-bp-members-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-members-bp-members-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-members-bp-members-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-members-bp-members-functio&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-members/bp-members-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Member Functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Functions specific to the members component.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage MembersFunctions</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check for the existence of a Members directory page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_members_has_directory() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) !empty( $bp-&gt;pages-&gt;members-&gt;id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Define the slug constants for the Members component.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the three slug constants used in the Members component -</span>&nbsp;</div></li><li><div><span class="comment"> * BP_MEMBERS_SLUG, BP_REGISTER_SLUG, and BP_ACTIVATION_SLUG. If these</span>&nbsp;</div></li><li><div><span class="comment"> * constants are not overridden in wp-config.php or bp-custom.php, they are</span>&nbsp;</div></li><li><div><span class="comment"> * defined here to match the slug of the corresponding WP pages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In general, fallback values are only used during initial BP page creation, </span>&nbsp;</div></li><li><div><span class="comment"> * when no slugs have been explicitly defined.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_define_slugs() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No custom members slug.</span>&nbsp;</div></li><li><div>  if ( !defined( 'BP_MEMBERS_SLUG' ) ) {&nbsp;</div></li><li><div>      if ( !empty( $bp-&gt;pages-&gt;members ) ) {&nbsp;</div></li><li><div>          define( 'BP_MEMBERS_SLUG', $bp-&gt;pages-&gt;members-&gt;slug );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          define( 'BP_MEMBERS_SLUG', 'members' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No custom registration slug.</span>&nbsp;</div></li><li><div>  if ( !defined( 'BP_REGISTER_SLUG' ) ) {&nbsp;</div></li><li><div>      if ( !empty( $bp-&gt;pages-&gt;register ) ) {&nbsp;</div></li><li><div>          define( 'BP_REGISTER_SLUG', $bp-&gt;pages-&gt;register-&gt;slug );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          define( 'BP_REGISTER_SLUG', 'register' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No custom activation slug.</span>&nbsp;</div></li><li><div>  if ( !defined( 'BP_ACTIVATION_SLUG' ) ) {&nbsp;</div></li><li><div>      if ( !empty( $bp-&gt;pages-&gt;activate ) ) {&nbsp;</div></li><li><div>          define( 'BP_ACTIVATION_SLUG', $bp-&gt;pages-&gt;activate-&gt;slug );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          define( 'BP_ACTIVATION_SLUG', 'activate' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_setup_globals', 'bp_core_define_slugs', 11 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch an array of users based on the parameters passed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Since BuddyPress 1.7, bp_core_get_users() uses BP_User_Query. If you</span>&nbsp;</div></li><li><div><span class="comment"> * need backward compatibility with BP_Core_User::get_users(), filter the</span>&nbsp;</div></li><li><div><span class="comment"> * bp_use_legacy_user_query value, returning true.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Array of arguments. All are optional. See {@link BP_User_Query} for</span>&nbsp;</div></li><li><div><span class="comment"> *     a more complete description of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $type                Sort order. Default: 'active'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $user_id             Limit results to friends of a user. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type mixed        $exclude             IDs to exclude from results. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $search_terms        Limit to users matching search terms. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $meta_key            Limit to users with a meta_key. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $meta_value          Limit to users with a meta_value (with meta_key). Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array|string $member_type         Array or comma-separated string of member types.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array|string $member_type__in     Array or comma-separated string of member types.</span>&nbsp;</div></li><li><div><span class="comment"> *                                             `$member_type` takes precedence over this parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array|string $member_type__not_in Array or comma-separated string of member types to be excluded.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type mixed        $include             Limit results by user IDs. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $per_page            Results per page. Default: 20.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $page                Page of results. Default: 1.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool         $populate_extras     Fetch optional extras. Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool  $count_total         How to do total user count. Default: 'count_query'.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_users( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Parse the user query arguments.</span>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'type' =&gt; 'active', <span class="comment">// Active, newest, alphabetical, random or popular.</span>&nbsp;</div></li><li><div>      'user_id' =&gt; false, <span class="comment">// Pass a user_id to limit to only friend connections for this user.</span>&nbsp;</div></li><li><div>      'exclude' =&gt; false, <span class="comment">// Users to exclude from results.</span>&nbsp;</div></li><li><div>      'search_terms' =&gt; false, <span class="comment">// Limit to users that match these search terms.</span>&nbsp;</div></li><li><div>      'meta_key' =&gt; false, <span class="comment">// Limit to users who have this piece of usermeta.</span>&nbsp;</div></li><li><div>      'meta_value' =&gt; false, <span class="comment">// With meta_key, limit to users where usermeta matches this value.</span>&nbsp;</div></li><li><div>      'member_type' =&gt; '', &nbsp;</div></li><li><div>      'member_type__in' =&gt; '', &nbsp;</div></li><li><div>      'member_type__not_in' =&gt; '', &nbsp;</div></li><li><div>      'include' =&gt; false, <span class="comment">// Pass comma separated list of user_ids to limit to only these users.</span>&nbsp;</div></li><li><div>      'per_page' =&gt; 20, <span class="comment">// The number of results to return per page.</span>&nbsp;</div></li><li><div>      'page' =&gt; 1, <span class="comment">// The page to return if limiting per page.</span>&nbsp;</div></li><li><div>      'populate_extras' =&gt; true, <span class="comment">// Fetch the last active, where the user is a friend, total friend count, latest update.</span>&nbsp;</div></li><li><div>      'count_total' =&gt; 'count_query' <span class="comment">// What kind of total user count to do, if any. 'count_query', 'sql_calc_found_rows', or false.</span>&nbsp;</div></li><li><div> ), 'core_get_users' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For legacy users. Use of BP_Core_User::get_users() is deprecated.</span>&nbsp;</div></li><li><div>  if ( apply_filters( 'bp_use_legacy_user_query', false, __FUNCTION__, $r ) ) {&nbsp;</div></li><li><div>      $retval = BP_Core_User::get_users(&nbsp;</div></li><li><div>          $r['type'], &nbsp;</div></li><li><div>          $r['per_page'], &nbsp;</div></li><li><div>          $r['page'], &nbsp;</div></li><li><div>          $r['user_id'], &nbsp;</div></li><li><div>          $r['include'], &nbsp;</div></li><li><div>          $r['search_terms'], &nbsp;</div></li><li><div>          $r['populate_extras'], &nbsp;</div></li><li><div>          $r['exclude'], &nbsp;</div></li><li><div>          $r['meta_key'], &nbsp;</div></li><li><div>          $r['meta_value']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default behavior as of BuddyPress 1.7.0.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get users like we were asked to do...</span>&nbsp;</div></li><li><div>      $users = new BP_User_Query( $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// ...but reformat the results to match bp_core_get_users() behavior.</span>&nbsp;</div></li><li><div>      $retval = array(&nbsp;</div></li><li><div>          'users' =&gt; array_values( $users-&gt;results ), &nbsp;</div></li><li><div>          'total' =&gt; $users-&gt;total_users&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the results of the user query.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $retval Array of users for the current query.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $r      Array of parsed query arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_users', $retval, $r );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the domain for the passed user: e.g. http://example.com/members/andy/.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int         $user_id       The ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $user_nicename Optional. user_nicename of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $user_login    Optional. user_login of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_user_domain( $user_id = 0, $user_nicename = false, $user_login = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $username = bp_core_get_username( $user_id, $user_nicename, $user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_username_compatibility_mode() ) {&nbsp;</div></li><li><div>      $username = rawurlencode( $username );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $after_domain = bp_core_enable_root_profiles() ? $username : bp_get_members_root_slug() . '/' . $username;&nbsp;</div></li><li><div>  $domain = trailingslashit( bp_get_root_domain() . '/' . $after_domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't use this filter.  Subject to removal in a future release.</span>&nbsp;</div></li><li><div>  <span class="comment">// Use the 'bp_core_get_user_domain' filter instead.</span>&nbsp;</div></li><li><div>  $domain = apply_filters( 'bp_core_get_user_domain_pre_cache', $domain, $user_id, $user_nicename, $user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the domain for the passed user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $domain        Domain for the passed user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id       ID of the passed user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_nicename User nicename of the passed user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login    User login of the passed user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_user_domain', $domain, $user_id, $user_nicename, $user_login );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch everything in the wp_users table for a user, without any usermeta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_core_userdata( $user_id = 0 ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$userdata = wp_cache_get( 'bp_core_userdata_' . $user_id, 'bp' ) ) {&nbsp;</div></li><li><div>      $userdata = BP_Core_User::get_core_userdata( $user_id );&nbsp;</div></li><li><div>      wp_cache_set( 'bp_core_userdata_' . $user_id, $userdata, 'bp' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the userdata for a passed user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $userdata Array of user data for a passed user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_core_userdata', $userdata );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the ID of a user, based on user_login.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * No longer used.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Deprecate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login user_login of the user being queried.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_displayed_userid( $user_login ) {&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_displayed_userid', bp_core_get_userid( $user_login ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the user ID based on a user's user_login.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $username user_login to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|null The ID of the matched user on success, null on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_userid( $username = '' ) {&nbsp;</div></li><li><div>  if ( empty( $username ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by( 'login', $username );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the ID of a user, based on user_login.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|null $value    ID of the user or null.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $username User login to check.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_userid', ! empty( $user-&gt;ID ) ? $user-&gt;ID : NULL, $username );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the user ID based on a user's user_nicename.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.3</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_nicename user_nicename to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|null The ID of the matched user on success, null on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_userid_from_nicename( $user_nicename = '' ) {&nbsp;</div></li><li><div>  if ( empty( $user_nicename ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by( 'slug', $user_nicename );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user ID based on user_nicename.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|null $value         ID of the user or null.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $user_nicename User nicename to check.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_userid_from_nicename', ! empty( $user-&gt;ID ) ? $user-&gt;ID : NULL, $user_nicename );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the username for a user based on their user id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is sensitive to the BP_ENABLE_USERNAME_COMPATIBILITY_MODE, </span>&nbsp;</div></li><li><div><span class="comment"> * so it will return the user_login or user_nicename as appropriate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int         $user_id       User ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $user_nicename Optional. user_nicename of user being checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $user_login    Optional. user_login of user being checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The username of the matched user, or false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_username( $user_id = 0, $user_nicename = false, $user_login = false ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check cache for user nicename.</span>&nbsp;</div></li><li><div>  $username = wp_cache_get( 'bp_user_username_' . $user_id, 'bp' );&nbsp;</div></li><li><div>  if ( false === $username ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cache not found so prepare to update it.</span>&nbsp;</div></li><li><div>      $update_cache = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Nicename and login were not passed.</span>&nbsp;</div></li><li><div>      if ( empty( $user_nicename ) && empty( $user_login ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// User ID matches logged in user.</span></span>&nbsp;</div></li><li><div>          if ( bp_loggedin_user_id() == $user_id ) {&nbsp;</div></li><li><div>              $userdata = &$bp-&gt;loggedin_user-&gt;userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// User ID matches displayed in user.</span></span>&nbsp;</div></li><li><div>          } elseif ( bp_displayed_user_id() == $user_id ) {&nbsp;</div></li><li><div>              $userdata = &$bp-&gt;displayed_user-&gt;userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// No user ID match.</span></span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $userdata = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// No match so go dig.</span></span>&nbsp;</div></li><li><div>          if ( empty( $userdata ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// User not found so return false.</span></span>&nbsp;</div></li><li><div>              if ( !$userdata = bp_core_get_core_userdata( $user_id ) ) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update the $user_id for later.</span>&nbsp;</div></li><li><div>          $user_id = $userdata-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Two possible options.</span>&nbsp;</div></li><li><div>          $user_nicename = $userdata-&gt;user_nicename;&nbsp;</div></li><li><div>          $user_login = $userdata-&gt;user_login;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Pull an audible and maybe use the login over the nicename.</span>&nbsp;</div></li><li><div>      $username = bp_is_username_compatibility_mode() ? $user_login : $user_nicename;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Username found in cache so don't update it again.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $update_cache = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add this to cache.</span></span>&nbsp;</div></li><li><div>  if ( ( true === $update_cache ) && !empty( $username ) ) {&nbsp;</div></li><li><div>      wp_cache_set( 'bp_user_username_' . $user_id, $username, 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// @todo bust this cache if no $username found?</span>&nbsp;</div></li><li><div>  <span class="comment">// } else {</span>&nbsp;</div></li><li><div>  <span class="comment">// wp_cache_delete( 'bp_user_username_' . $user_id );</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the username based on originally provided user ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $username Username determined by user ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_username', $username );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the user_nicename for a user based on their user_id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This should be used for linking to user profiles and anywhere else a</span>&nbsp;</div></li><li><div><span class="comment"> * sanitized and unique slug to a user is needed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Refactor to use a WP core function, if possible.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id User ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The username of the matched user, or false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_members_get_user_nicename( $user_id ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$user_nicename = wp_cache_get( 'bp_members_user_nicename_' . $user_id, 'bp' ) ) {&nbsp;</div></li><li><div>      $update_cache = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// User ID matches logged in user.</span></span>&nbsp;</div></li><li><div>      if ( bp_loggedin_user_id() == $user_id ) {&nbsp;</div></li><li><div>          $userdata = &$bp-&gt;loggedin_user-&gt;userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// User ID matches displayed in user.</span></span>&nbsp;</div></li><li><div>      } elseif ( bp_displayed_user_id() == $user_id ) {&nbsp;</div></li><li><div>          $userdata = &$bp-&gt;displayed_user-&gt;userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// No user ID match.</span></span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $userdata = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// No match so go dig.</span></span>&nbsp;</div></li><li><div>      if ( empty( $userdata ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// User not found so return false.</span></span>&nbsp;</div></li><li><div>          if ( !$userdata = bp_core_get_core_userdata( $user_id ) ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User nicename found.</span>&nbsp;</div></li><li><div>      $user_nicename = $userdata-&gt;user_nicename;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Nicename found in cache so don't update it again.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $update_cache = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Add this to cache.</span></span>&nbsp;</div></li><li><div>  if ( true == $update_cache && !empty( $user_nicename ) ) {&nbsp;</div></li><li><div>      wp_cache_set( 'bp_members_user_nicename_' . $user_id, $user_nicename, 'bp' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user_nicename based on originally provided user ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $username User nice name determined by user ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_members_get_user_nicename', $user_nicename );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the email address for the user based on user ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $uid User ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The email for the matched user. Empty string if no user</span>&nbsp;</div></li><li><div><span class="comment"> *                matched the $uid.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_user_email( $uid ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$email = wp_cache_get( 'bp_user_email_' . $uid, 'bp' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User exists.</span>&nbsp;</div></li><li><div>      $ud = bp_core_get_core_userdata( $uid );&nbsp;</div></li><li><div>      if ( ! empty( $ud ) ) {&nbsp;</div></li><li><div>          $email = $ud-&gt;user_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User was deleted.</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $email = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_cache_set( 'bp_user_email_' . $uid, $email, 'bp' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user email for user based on user ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $email Email determined for the user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_user_email', $email );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return a HTML formatted link for a user with the user's full name as the link text.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Eg: &lt;a href=&quot;http://andy.example.com/&quot;&gt;Andy Peatling&lt;/a&gt;</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Optional parameters will return just the name or just the URL.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int  $user_id   User ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $no_anchor Disable URL and HTML and just return full name.</span>&nbsp;</div></li><li><div><span class="comment"> *                        Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $just_link Disable full name and HTML and just return the URL</span>&nbsp;</div></li><li><div><span class="comment"> *                        text. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The link text based on passed parameters, or false on</span>&nbsp;</div></li><li><div><span class="comment"> *                     no match.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_userlink( $user_id, $no_anchor = false, $just_link = false ) {&nbsp;</div></li><li><div>  $display_name = bp_core_get_user_displayname( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $display_name ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $no_anchor ) ) {&nbsp;</div></li><li><div>      return $display_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$url = bp_core_get_user_domain( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $just_link ) ) {&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the link text for the passed in user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value   Link text based on passed parameters.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id ID of the user to check.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_userlink', '&lt;a href=&quot;' . $url . '&quot;&gt;' . $display_name . '&lt;/a&gt;', $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch the display name for a group of users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Uses the 'Name' field in xprofile if available. Falls back on WP</span>&nbsp;</div></li><li><div><span class="comment"> * display_name, and then user_nicename.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $user_ids Array of user IDs to get display names for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_user_displaynames( $user_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sanitize.</span>&nbsp;</div></li><li><div>  $user_ids = wp_parse_id_list( $user_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove dupes and empties.</span>&nbsp;</div></li><li><div>  $user_ids = array_unique( array_filter( $user_ids ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_ids ) ) {&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $uncached_ids = array();&nbsp;</div></li><li><div>  foreach ( $user_ids as $user_id ) {&nbsp;</div></li><li><div>      if ( false === wp_cache_get( 'bp_user_fullname_' . $user_id, 'bp' ) ) {&nbsp;</div></li><li><div>          $uncached_ids[] = $user_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prime caches.</span>&nbsp;</div></li><li><div>  if ( ! empty( $uncached_ids ) ) {&nbsp;</div></li><li><div>      if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>          $fullname_data = BP_XProfile_ProfileData::get_value_byid( 1, $uncached_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Key by user_id.</span>&nbsp;</div></li><li><div>          $fullnames = array();&nbsp;</div></li><li><div>          foreach ( $fullname_data as $fd ) {&nbsp;</div></li><li><div>              if ( ! empty( $fd-&gt;value ) ) {&nbsp;</div></li><li><div>                  $fullnames[ intval( $fd-&gt;user_id ) ] = $fd-&gt;value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If xprofiledata is not found for any users, we'll look</span>&nbsp;</div></li><li><div>          <span class="comment">// them up separately.</span>&nbsp;</div></li><li><div>          $no_xprofile_ids = array_diff( $uncached_ids, array_keys( $fullnames ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $fullnames = array();&nbsp;</div></li><li><div>          $no_xprofile_ids = $user_ids;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $no_xprofile_ids ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Use WP_User_Query because we don't need BP information.</span>&nbsp;</div></li><li><div>          $query = new WP_User_Query( array(&nbsp;</div></li><li><div>              'include' =&gt; $no_xprofile_ids, &nbsp;</div></li><li><div>              'fields' =&gt; array( 'ID', 'user_nicename', 'display_name', ), &nbsp;</div></li><li><div>              'count_total' =&gt; false, &nbsp;</div></li><li><div>              'blog_id' =&gt; 0, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $query-&gt;results as $qr ) {&nbsp;</div></li><li><div>              $fullnames[ $qr-&gt;ID ] = ! empty( $qr-&gt;display_name ) ? $qr-&gt;display_name : $qr-&gt;user_nicename;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If xprofile is active, set this value as the</span>&nbsp;</div></li><li><div>              <span class="comment">// xprofile display name as well.</span>&nbsp;</div></li><li><div>              if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>                  xprofile_set_field_data( 1, $qr-&gt;ID, $fullnames[ $qr-&gt;ID ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $fullnames as $fuser_id =&gt; $fname ) {&nbsp;</div></li><li><div>          wp_cache_set( 'bp_user_fullname_' . $fuser_id, $fname, 'bp' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = array();&nbsp;</div></li><li><div>  foreach ( $user_ids as $user_id ) {&nbsp;</div></li><li><div>      $retval[ $user_id ] = wp_cache_get( 'bp_user_fullname_' . $user_id, 'bp' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch the display name for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string|bool $user_id_or_username User ID or username.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The display name for the user in question, or false if</span>&nbsp;</div></li><li><div><span class="comment"> *                     user not found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_user_displayname( $user_id_or_username ) {&nbsp;</div></li><li><div>  if ( empty( $user_id_or_username ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_numeric( $user_id_or_username ) ) {&nbsp;</div></li><li><div>      $user_id = bp_core_get_userid( $user_id_or_username );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user_id = $user_id_or_username;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $display_names = bp_core_get_user_displaynames( array( $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $display_names[ $user_id ] ) ) {&nbsp;</div></li><li><div>      $fullname = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $fullname = $display_names[ $user_id ];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the display name for the passed in user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $fullname Display name for the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id  ID of the user to check.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_user_displayname', $fullname, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'bp_core_get_user_displayname', 'strip_tags', 1 );&nbsp;</div></li><li><div>add_filter( 'bp_core_get_user_displayname', 'trim' );&nbsp;</div></li><li><div>add_filter( 'bp_core_get_user_displayname', 'stripslashes' );&nbsp;</div></li><li><div>add_filter( 'bp_core_get_user_displayname', 'esc_html' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the user link for the user based on user email address.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $email The email address for the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The link to the users home base. False on no match.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_userlink_by_email( $email ) {&nbsp;</div></li><li><div>  $user = get_user_by( 'email', $email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user link for the user based on user email address.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|bool $value URL for the user if found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_userlink_by_email', bp_core_get_userlink( $user-&gt;ID, false, false, true ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the user link for the user based on the supplied identifier.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $username If BP_ENABLE_USERNAME_COMPATIBILITY_MODE is set, </span>&nbsp;</div></li><li><div><span class="comment"> *                         this should be user_login, otherwise it should</span>&nbsp;</div></li><li><div><span class="comment"> *                         be user_nicename.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool The link to the user's domain, false on no match.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_userlink_by_username( $username ) {&nbsp;</div></li><li><div>  if ( bp_is_username_compatibility_mode() ) {&nbsp;</div></li><li><div>      $user_id = bp_core_get_userid( $username );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user_id = bp_core_get_userid_from_nicename( $username );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user link for the user based on username.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|bool $value URL for the user if found, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_userlink_by_username', bp_core_get_userlink( $user_id, false, false, true ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the total number of members for the installation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that this is a raw count of non-spam, activated users. It does not</span>&nbsp;</div></li><li><div><span class="comment"> * account for users who have logged activity (last_active). See</span>&nbsp;</div></li><li><div><span class="comment"> * {@link bp_core_get_active_member_count()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The total number of members.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_total_member_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = wp_cache_get( 'bp_total_member_count', 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $count ) {&nbsp;</div></li><li><div>      $status_sql = bp_core_get_status_sql();&nbsp;</div></li><li><div>      $count = $wpdb-&gt;get_var( &quot;SELECT COUNT(ID) FROM {$wpdb-&gt;users} WHERE {$status_sql}&quot; );&nbsp;</div></li><li><div>      wp_cache_set( 'bp_total_member_count', $count, 'bp' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the total number of members for the installation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $count Total number of members.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_total_member_count', $count );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the total number of members, limited to those members with last_activity.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The number of active members.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_active_member_count() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = get_transient( 'bp_active_member_count' );&nbsp;</div></li><li><div>  if ( false === $count ) {&nbsp;</div></li><li><div>      $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Avoid a costly join by splitting the lookup.</span>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $sql = &quot;SELECT ID FROM {$wpdb-&gt;users} WHERE (user_status != 0 OR deleted != 0 OR user_status != 0)&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $sql = &quot;SELECT ID FROM {$wpdb-&gt;users} WHERE user_status != 0&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $exclude_users = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>      $exclude_users_sql = !empty( $exclude_users ) ? &quot;AND user_id NOT IN (&quot; . implode( ', ', wp_parse_id_list( $exclude_users ) ) . &quot;)&quot; : '';&nbsp;</div></li><li><div>      $count = (int) $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT(user_id) FROM {$bp-&gt;members-&gt;table_name_last_activity} WHERE component = %s AND type = 'last_activity' {$exclude_users_sql}&quot;, $bp-&gt;members-&gt;id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_transient( 'bp_active_member_count', $count );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the total number of members for the installation limited to those with last_activity.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $count Total number of active members.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_active_member_count', $count );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process a spammed or unspammed user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is called from three places:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * - in bp_settings_action_capabilities() (from the front-end)</span>&nbsp;</div></li><li><div><span class="comment"> * - by bp_core_mark_user_spam_admin()    (from wp-admin)</span>&nbsp;</div></li><li><div><span class="comment"> * - bp_core_mark_user_ham_admin()        (from wp-admin)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id       The ID of the user being spammed/hammed.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $status        'spam' if being marked as spam, 'ham' otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $do_wp_cleanup True to force the cleanup of WordPress content</span>&nbsp;</div></li><li><div><span class="comment"> *                              and status, otherwise false. Generally, this should</span>&nbsp;</div></li><li><div><span class="comment"> *                              only be false if WordPress is expected to have</span>&nbsp;</div></li><li><div><span class="comment"> *                              performed this cleanup independently, as when hooked</span>&nbsp;</div></li><li><div><span class="comment"> *                              to 'make_spam_user'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_process_spammer_status( $user_id, $status, $do_wp_cleanup = true ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if no user ID.</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if user ID is super admin.</span>&nbsp;</div></li><li><div>  if ( is_super_admin( $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the functions file.</span>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      require_once( ABSPATH . 'wp-admin/includes/ms.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_spam = ( 'spam' == $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only you can prevent infinite loops.</span>&nbsp;</div></li><li><div>  remove_action( 'make_spam_user', 'bp_core_mark_user_spam_admin' );&nbsp;</div></li><li><div>  remove_action( 'make_ham_user', 'bp_core_mark_user_ham_admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Force the cleanup of WordPress content and status for multisite configs.</span>&nbsp;</div></li><li><div>  if ( $do_wp_cleanup ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the blogs for the user.</span>&nbsp;</div></li><li><div>      $blogs = get_blogs_of_user( $user_id, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( (array) array_values( $blogs ) as $details ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Do not mark the main or current root blog as spam.</span>&nbsp;</div></li><li><div>          if ( 1 == $details-&gt;userblog_id || bp_get_root_blog_id() == $details-&gt;userblog_id ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update the blog status.</span>&nbsp;</div></li><li><div>          update_blog_status( $details-&gt;userblog_id, 'spam', $is_spam );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Finally, mark this user as a spammer.</span>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          update_user_status( $user_id, 'spam', $is_spam );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the user status.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;update( $wpdb-&gt;users, array( 'user_status' =&gt; $is_spam ), array( 'ID' =&gt; $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Clean user cache.</span>&nbsp;</div></li><li><div>  clean_user_cache( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_multisite() ) {&nbsp;</div></li><li><div>      <span class="comment">// Call multisite actions in single site mode for good measure.</span>&nbsp;</div></li><li><div>      if ( true === $is_spam ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires at end of processing spammer in Dashboard if not multisite and user is spam.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $value user ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_spam_user', $user_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires at end of processing spammer in Dashboard if not multisite and user is not spam.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $value user ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_ham_user', $user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hide this user's activity.</span>&nbsp;</div></li><li><div>  if ( ( true === $is_spam ) && bp_is_active( 'activity' ) ) {&nbsp;</div></li><li><div>      bp_activity_hide_user_activity( $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need a special hook for is_spam so that components can delete data at spam time.</span>&nbsp;</div></li><li><div>  if ( true === $is_spam ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the end of the process spammer process if the user is spam.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $value Displayed user ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_make_spam_user', $user_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires at the end of the process spammer process if the user is not spam.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $value Displayed user ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_make_ham_user', $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the process for hanlding spammer status.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $user_id ID of the processed user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_spam The determined spam status of processed user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_process_spammer_status', $user_id, $is_spam );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Put things back how we found them.</span>&nbsp;</div></li><li><div>  add_action( 'make_spam_user', 'bp_core_mark_user_spam_admin' );&nbsp;</div></li><li><div>  add_action( 'make_ham_user', 'bp_core_mark_user_ham_admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Hook to WP's make_spam_user and run our custom BP spam functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID passed from the make_spam_user hook.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_mark_user_spam_admin( $user_id ) {&nbsp;</div></li><li><div>  bp_core_process_spammer_status( $user_id, 'spam', false );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'make_spam_user', 'bp_core_mark_user_spam_admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Hook to WP's make_ham_user and run our custom BP spam functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID passed from the make_ham_user hook.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_mark_user_ham_admin( $user_id ) {&nbsp;</div></li><li><div>  bp_core_process_spammer_status( $user_id, 'ham', false );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'make_ham_user', 'bp_core_mark_user_ham_admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether a user has been marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The ID for the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if spammer, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_is_user_spammer( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No user to check.</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume user is not spam.</span>&nbsp;</div></li><li><div>  $is_spammer = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup our user.</span></span>&nbsp;</div></li><li><div>  $user = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get locally-cached data if available.</span></span>&nbsp;</div></li><li><div>  switch ( $user_id ) {&nbsp;</div></li><li><div>      case bp_loggedin_user_id() :&nbsp;</div></li><li><div>          $user = ! empty( $bp-&gt;loggedin_user-&gt;userdata ) ? $bp-&gt;loggedin_user-&gt;userdata : false;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case bp_displayed_user_id() :&nbsp;</div></li><li><div>          $user = ! empty( $bp-&gt;displayed_user-&gt;userdata ) ? $bp-&gt;displayed_user-&gt;userdata : false;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Manually get userdata if still empty.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $user = get_userdata( $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No user found.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $is_spammer = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// User found.</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if spam.</span>&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;spam ) ) {&nbsp;</div></li><li><div>          $is_spammer = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 1 == $user-&gt;user_status ) {&nbsp;</div></li><li><div>          $is_spammer = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether a user is marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_spammer Whether or not user is marked as spammer.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_is_user_spammer', (bool) $is_spammer );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether a user has been marked as deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The ID for the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if deleted, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_is_user_deleted( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No user to check.</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume user is not deleted.</span>&nbsp;</div></li><li><div>  $is_deleted = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Setup our user.</span></span>&nbsp;</div></li><li><div>  $user = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Get locally-cached data if available.</span></span>&nbsp;</div></li><li><div>  switch ( $user_id ) {&nbsp;</div></li><li><div>      case bp_loggedin_user_id() :&nbsp;</div></li><li><div>          $user = ! empty( $bp-&gt;loggedin_user-&gt;userdata ) ? $bp-&gt;loggedin_user-&gt;userdata : false;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case bp_displayed_user_id() :&nbsp;</div></li><li><div>          $user = ! empty( $bp-&gt;displayed_user-&gt;userdata ) ? $bp-&gt;displayed_user-&gt;userdata : false;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Manually get userdata if still empty.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $user = get_userdata( $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// No user found.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $is_deleted = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// User found.</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if deleted.</span>&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;deleted ) ) {&nbsp;</div></li><li><div>          $is_deleted = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 2 == $user-&gt;user_status ) {&nbsp;</div></li><li><div>          $is_deleted = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether a user is marked as deleted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_deleted Whether or not user is marked as deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_is_user_deleted', (bool) $is_deleted );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether a user is &quot;active&quot;, ie neither deleted nor spammer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if active, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_is_user_active( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Default to current user.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) && is_user_logged_in() ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No user to check.</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check spam.</span>&nbsp;</div></li><li><div>  if ( bp_is_user_spammer( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check deleted.</span>&nbsp;</div></li><li><div>  if ( bp_is_user_deleted( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume true if not spam or deleted.</span>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether user is not active.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo No need for the user fallback checks, since they're done in</span>&nbsp;</div></li><li><div><span class="comment"> *       bp_is_user_active().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if inactive, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_is_user_inactive( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Default to current user.</span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) && is_user_logged_in() ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// No user to check.</span></span></span></span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return the inverse of active.</span>&nbsp;</div></li><li><div>  return !bp_is_user_active( $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update a user's last activity.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id ID of the user being updated.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $time    Time of last activity, in 'Y-m-d H:i:s' format.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_update_user_last_activity( $user_id = 0, $time = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fall back on current user.</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if the user id is 0, as there's nothing to update.</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fall back on current time.</span>&nbsp;</div></li><li><div>  if ( empty( $time ) ) {&nbsp;</div></li><li><div>      $time = bp_core_current_time();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// As of BuddyPress 2.0, last_activity is no longer stored in usermeta.</span>&nbsp;</div></li><li><div>  <span class="comment">// However, we mirror it there for backward compatibility. Do not use!</span>&nbsp;</div></li><li><div>  <span class="comment">// Remove our warning and re-add.</span>&nbsp;</div></li><li><div>  remove_filter( 'update_user_metadata', '_bp_update_user_meta_last_activity_warning', 10 );&nbsp;</div></li><li><div>  remove_filter( 'get_user_metadata', '_bp_get_user_meta_last_activity_warning', 10 );&nbsp;</div></li><li><div>  bp_update_user_meta( $user_id, 'last_activity', $time );&nbsp;</div></li><li><div>  add_filter( 'update_user_metadata', '_bp_update_user_meta_last_activity_warning', 10, 4 );&nbsp;</div></li><li><div>  add_filter( 'get_user_metadata', '_bp_get_user_meta_last_activity_warning', 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return BP_Core_User::update_last_activity( $user_id, $time );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Backward compatibility for 'last_activity' usermeta fetching.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In BuddyPress 2.0, user last_activity data was moved out of usermeta. For</span>&nbsp;</div></li><li><div><span class="comment"> * backward compatibility, we continue to mirror the data there. This function</span>&nbsp;</div></li><li><div><span class="comment"> * serves two purposes: it warns plugin authors of the change, and it returns</span>&nbsp;</div></li><li><div><span class="comment"> * the data from the proper location.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private For internal use only.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param null   $retval Null retval value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $object_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key  Meta key being fetched.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _bp_get_user_meta_last_activity_warning( $retval, $object_id, $meta_key ) {&nbsp;</div></li><li><div>  static $warned = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'last_activity' === $meta_key ) {&nbsp;</div></li><li><div>      <span class="comment">// Don't send the warning more than once per pageload.</span>&nbsp;</div></li><li><div>      if ( false === $warned ) {&nbsp;</div></li><li><div>          _doing_it_wrong( 'get_user_meta( $user_id, \'last_activity\' )', __( 'User last_activity data is no longer stored in usermeta. Use bp_get_user_last_activity() instead.', 'buddypress' ), '2.0.0' );&nbsp;</div></li><li><div>          $warned = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return bp_get_user_last_activity( $object_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'get_user_metadata', '_bp_get_user_meta_last_activity_warning', 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Backward compatibility for 'last_activity' usermeta setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In BuddyPress 2.0, user last_activity data was moved out of usermeta. For</span>&nbsp;</div></li><li><div><span class="comment"> * backward compatibility, we continue to mirror the data there. This function</span>&nbsp;</div></li><li><div><span class="comment"> * serves two purposes: it warns plugin authors of the change, and it updates</span>&nbsp;</div></li><li><div><span class="comment"> * the data in the proper location.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private For internal use only.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $meta_id    ID of the just-set usermeta row.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $object_id  ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key   Meta key being fetched.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_value Active time.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _bp_update_user_meta_last_activity_warning( $meta_id, $object_id, $meta_key, $meta_value ) {&nbsp;</div></li><li><div>  if ( 'last_activity' === $meta_key ) {&nbsp;</div></li><li><div>      _doing_it_wrong( 'update_user_meta( $user_id, \'last_activity\' )', __( 'User last_activity data is no longer stored in usermeta. Use bp_update_user_last_activity() instead.', 'buddypress' ), '2.0.0' );&nbsp;</div></li><li><div>      bp_update_user_last_activity( $object_id, $meta_value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'update_user_metadata', '_bp_update_user_meta_last_activity_warning', 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the last activity for a given user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Time of last activity, in 'Y-m-d H:i:s' format, or an empty</span>&nbsp;</div></li><li><div><span class="comment"> *                string if none is found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_user_last_activity( $user_id = 0 ) {&nbsp;</div></li><li><div>  $activity = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $last_activity = BP_Core_User::get_last_activity( $user_id );&nbsp;</div></li><li><div>  if ( ! empty( $last_activity[ $user_id ] ) ) {&nbsp;</div></li><li><div>      $activity = $last_activity[ $user_id ]['date_recorded'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the last activity for a given user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $activity Time of last activity, in 'Y-m-d H:i:s' format or</span>&nbsp;</div></li><li><div><span class="comment">   *                         an empty string if none found.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id  ID of the user being checked.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_get_user_last_activity', $activity, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Migrate last_activity data from the usermeta table to the activity table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Generally, this function is only run when BP is upgraded to 2.0. It can also</span>&nbsp;</div></li><li><div><span class="comment"> * be called directly from the BuddyPress Tools panel.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_last_activity_migrate() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Wipe out existing last_activity data in the activity table -</span>&nbsp;</div></li><li><div>  <span class="comment">// this helps to prevent duplicates when pulling from the usermeta</span>&nbsp;</div></li><li><div>  <span class="comment">// table.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM {$bp-&gt;members-&gt;table_name_last_activity} WHERE component = %s AND type = 'last_activity'&quot;, $bp-&gt;members-&gt;id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;INSERT INTO {$bp-&gt;members-&gt;table_name_last_activity} (`user_id`, `component`, `type`, `action`, `content`, `primary_link`, `item_id`, `date_recorded` ) (&nbsp;</div></li><li><div>        SELECT user_id, '{$bp-&gt;members-&gt;id}' as component, 'last_activity' as type, '' as action, '' as content, '' as primary_link, 0 as item_id, meta_value AS date_recorded&nbsp;</div></li><li><div>        FROM {$wpdb-&gt;usermeta}&nbsp;</div></li><li><div>        WHERE&nbsp;</div></li><li><div>          meta_key = 'last_activity'&nbsp;</div></li><li><div> );&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch every post that is authored by the given user for the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * No longer used in BuddyPress.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Deprecate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user being queried.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Post IDs.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_all_posts_for_user( $user_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_all_posts_for_user', $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_author = %d AND post_status = 'publish' AND post_type = 'post'&quot;, $user_id ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process account deletion requests.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Primarily used for self-deletions, as requested through Settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id Optional. ID of the user to be deleted. Default: the</span>&nbsp;</div></li><li><div><span class="comment"> *                     logged-in user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_delete_account( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use logged in user ID if none is passed.</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Site admins cannot be deleted.</span>&nbsp;</div></li><li><div>  if ( is_super_admin( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Extra checks if user is not deleting themselves.</span>&nbsp;</div></li><li><div>  if ( bp_loggedin_user_id() !== absint( $user_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if current user cannot delete any users.</span>&nbsp;</div></li><li><div>      if ( ! bp_current_user_can( 'delete_users' ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Bail if current user cannot delete this user.</span>&nbsp;</div></li><li><div>      if ( ! current_user_can_for_blog( bp_get_root_blog_id(), 'delete_user', $user_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before the processing of an account deletion.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user account being deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_pre_delete_account', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Specifically handle multi-site environment.</span>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      require_once( ABSPATH . '/wp-admin/includes/ms.php' );&nbsp;</div></li><li><div>      require_once( ABSPATH . '/wp-admin/includes/user.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $retval = wpmu_delete_user( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Single site user deletion.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      require_once( ABSPATH . '/wp-admin/includes/user.php' );&nbsp;</div></li><li><div>      $retval = wp_delete_user( $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the deletion of an account.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the user account that was deleted.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_deleted_account', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete a user's avatar when the user is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user who is about to be deleted.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_delete_avatar_on_user_delete( $user_id ) {&nbsp;</div></li><li><div>  return bp_core_delete_existing_avatar( array(&nbsp;</div></li><li><div>      'item_id' =&gt; $user_id, &nbsp;</div></li><li><div>      'object' =&gt; 'user', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpmu_delete_user', 'bp_core_delete_avatar_on_user_delete' );&nbsp;</div></li><li><div>add_action( 'delete_user', 'bp_core_delete_avatar_on_user_delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Multibyte-safe ucfirst() support.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Uses multibyte functions when available on the PHP build.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $str String to be upper-cased.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_ucfirst( $str ) {&nbsp;</div></li><li><div>  if ( function_exists( 'mb_strtoupper' ) && function_exists( 'mb_substr' ) ) {&nbsp;</div></li><li><div>      $fc = mb_strtoupper( mb_substr( $str, 0, 1 ) );&nbsp;</div></li><li><div>      return $fc.mb_substr( $str, 1 );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return ucfirst( $str );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Prevent spammers from logging in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When a user logs in, check if they have been marked as a spammer. If yes</span>&nbsp;</div></li><li><div><span class="comment"> * then simply redirect them to the home page and stop them from logging in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error $user Either the WP_User object or the WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> *                               object, as passed to the 'authenticate' filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error If the user is not a spammer, return the WP_User</span>&nbsp;</div></li><li><div><span class="comment"> *                          object. Otherwise a new WP_Error object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_boot_spammer( $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check to see if the $user has already failed logging in, if so return $user as-is.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $user ) || empty( $user ) ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The user exists; now do a check to see if the user is a spammer</span>&nbsp;</div></li><li><div>  <span class="comment">// if the user is a spammer, stop them in their tracks!</span>&nbsp;</div></li><li><div>  if ( is_a( $user, 'WP_User' ) && ( ( is_multisite() && (int) $user-&gt;spam ) || 1 == $user-&gt;user_status ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_username', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your account has been marked as a spammer.', 'buddypress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User is good to go!</span>&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'authenticate', 'bp_core_boot_spammer', 30 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete last_activity data for the user when the user is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID for the user to delete usermeta for.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_remove_data( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove last_activity data.</span>&nbsp;</div></li><li><div>  BP_Core_User::delete_last_activity( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Flush the cache to remove the user from all cached objects.</span>&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpmu_delete_user', 'bp_core_remove_data' );&nbsp;</div></li><li><div>add_action( 'delete_user', 'bp_core_remove_data' );&nbsp;</div></li><li><div>add_action( 'bp_make_spam_user', 'bp_core_remove_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether the logged-in user can edit settings for the displayed user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if editing is allowed, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_can_edit_settings() {&nbsp;</div></li><li><div>  $status = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_my_profile() ) {&nbsp;</div></li><li><div>      $status = true;&nbsp;</div></li><li><div>  } elseif ( is_super_admin( bp_displayed_user_id() ) && ! is_super_admin() ) {&nbsp;</div></li><li><div>      $status = false;&nbsp;</div></li><li><div>  } elseif ( bp_current_user_can( 'bp_moderate' ) || current_user_can( 'edit_users' ) ) {&nbsp;</div></li><li><div>      $status = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the status of whether the logged-in user can edit settings for the displayed user or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool True if editing is allowed, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_can_edit_settings', $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Sign-up *******************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Flush illegal names by getting and setting 'illegal_names' site option.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.5</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_flush_illegal_names() {&nbsp;</div></li><li><div>  $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>  update_site_option( 'illegal_names', $illegal_names );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add BuddyPress-specific items to the illegal_names array.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.7</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $value    Illegal names as being saved defined in</span>&nbsp;</div></li><li><div><span class="comment"> *                               Multisite settings.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $oldvalue The old value of the option.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Merged and unique array of illegal names.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_illegal_names( $value = '', $oldvalue = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure $value is array.</span>&nbsp;</div></li><li><div>  if ( empty( $value ) ) {&nbsp;</div></li><li><div>      $db_illegal_names = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array( $value ) ) {&nbsp;</div></li><li><div>      $db_illegal_names = $value;&nbsp;</div></li><li><div>  } elseif ( is_string( $value ) ) {&nbsp;</div></li><li><div>      $db_illegal_names = explode( ' ', $value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the core components' slugs to the banned list even if their components aren't active.</span>&nbsp;</div></li><li><div>  $bp_component_slugs = array(&nbsp;</div></li><li><div>      'groups', &nbsp;</div></li><li><div>      'members', &nbsp;</div></li><li><div>      'forums', &nbsp;</div></li><li><div>      'blogs', &nbsp;</div></li><li><div>      'activity', &nbsp;</div></li><li><div>      'profile', &nbsp;</div></li><li><div>      'friends', &nbsp;</div></li><li><div>      'search', &nbsp;</div></li><li><div>      'settings', &nbsp;</div></li><li><div>      'notifications', &nbsp;</div></li><li><div>      'register', &nbsp;</div></li><li><div>      'activate'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Core constants.</span>&nbsp;</div></li><li><div>  $slug_constants = array(&nbsp;</div></li><li><div>      'BP_GROUPS_SLUG', &nbsp;</div></li><li><div>      'BP_MEMBERS_SLUG', &nbsp;</div></li><li><div>      'BP_FORUMS_SLUG', &nbsp;</div></li><li><div>      'BP_BLOGS_SLUG', &nbsp;</div></li><li><div>      'BP_ACTIVITY_SLUG', &nbsp;</div></li><li><div>      'BP_XPROFILE_SLUG', &nbsp;</div></li><li><div>      'BP_FRIENDS_SLUG', &nbsp;</div></li><li><div>      'BP_SEARCH_SLUG', &nbsp;</div></li><li><div>      'BP_SETTINGS_SLUG', &nbsp;</div></li><li><div>      'BP_NOTIFICATIONS_SLUG', &nbsp;</div></li><li><div>      'BP_REGISTER_SLUG', &nbsp;</div></li><li><div>      'BP_ACTIVATION_SLUG', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  foreach( $slug_constants as $constant ) {&nbsp;</div></li><li><div>      if ( defined( $constant ) ) {&nbsp;</div></li><li><div>          $bp_component_slugs[] = constant( $constant );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the array of default illegal usernames.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value Merged and unique array of illegal usernames.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $filtered_illegal_names = apply_filters( 'bp_core_illegal_usernames', array_merge( array( 'www', 'web', 'root', 'admin', 'main', 'invite', 'administrator' ), $bp_component_slugs ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge the arrays together.</span>&nbsp;</div></li><li><div>  $merged_names = array_merge( (array) $filtered_illegal_names, (array) $db_illegal_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove duplicates.</span>&nbsp;</div></li><li><div>  $illegal_names = array_unique( (array) $merged_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the array of default illegal names.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value Merged and unique array of illegal names.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_illegal_names', $illegal_names );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'pre_update_site_option_illegal_names', 'bp_core_get_illegal_names', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check that an email address is valid for use.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Performs the following checks:</span>&nbsp;</div></li><li><div><span class="comment"> *   - Is the email address well-formed?</span>&nbsp;</div></li><li><div><span class="comment"> *   - Is the email address already used?</span>&nbsp;</div></li><li><div><span class="comment"> *   - If there's an email domain blacklist, is the current domain on it?</span>&nbsp;</div></li><li><div><span class="comment"> *   - If there's an email domain whitelest, is the current domain on it?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The email being checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|array True if the address passes all checks; otherwise an array</span>&nbsp;</div></li><li><div><span class="comment"> *                    of error codes.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_validate_email_address( $user_email ) {&nbsp;</div></li><li><div>  $errors = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_email = sanitize_email( $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is the email well-formed?</span>&nbsp;</div></li><li><div>  if ( ! is_email( $user_email ) ) {&nbsp;</div></li><li><div>      $errors['invalid'] = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is the email on the Banned Email Domains list?</span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Note: This check only works on Multisite.</span></span>&nbsp;</div></li><li><div>  if ( function_exists( 'is_email_address_unsafe' ) && is_email_address_unsafe( $user_email ) ) {&nbsp;</div></li><li><div>      $errors['domain_banned'] = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is the email on the Limited Email Domains list?</span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Note: This check only works on Multisite.</span></span>&nbsp;</div></li><li><div>  $limited_email_domains = get_site_option( 'limited_email_domains' );&nbsp;</div></li><li><div>  if ( is_array( $limited_email_domains ) && empty( $limited_email_domains ) == false ) {&nbsp;</div></li><li><div>      $emaildomain = substr( $user_email, 1 + strpos( $user_email, '@' ) );&nbsp;</div></li><li><div>      if ( ! in_array( $emaildomain, $limited_email_domains ) ) {&nbsp;</div></li><li><div>          $errors['domain_not_allowed'] = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is the email alreday in use?</span>&nbsp;</div></li><li><div>  if ( email_exists( $user_email ) ) {&nbsp;</div></li><li><div>      $errors['in_use'] = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = ! empty( $errors ) ? $errors : true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add the appropriate errors to a WP_Error object, given results of a validation test.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Functions like bp_core_validate_email_address() return a structured array</span>&nbsp;</div></li><li><div><span class="comment"> * of error codes. bp_core_add_validation_error_messages() takes this array and</span>&nbsp;</div></li><li><div><span class="comment"> * parses, adding the appropriate error messages to the WP_Error object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_core_validate_email_address()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Error $errors             WP_Error object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array    $validation_results The return value of a validation function</span>&nbsp;</div></li><li><div><span class="comment"> *                                     like bp_core_validate_email_address().</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_add_validation_error_messages( WP_Error $errors, $validation_results ) {&nbsp;</div></li><li><div>  if ( ! empty( $validation_results['invalid'] ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_email', __( 'Please check your email address.', 'buddypress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $validation_results['domain_banned'] ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_email', __( 'Sorry, that email address is not allowed!', 'buddypress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $validation_results['domain_not_allowed'] ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_email', __( 'Sorry, that email address is not allowed!', 'buddypress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $validation_results['in_use'] ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_email', __( 'Sorry, that email address is already used!', 'buddypress' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate a user name and email address when creating a new user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_name  Username to validate.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email Email address to validate.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Results of user validation including errors, if any.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_validate_user_signup( $user_name, $user_email ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure illegal names include BuddyPress slugs and values.</span>&nbsp;</div></li><li><div>  bp_core_flush_illegal_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// WordPress Multisite has its own validation. Use it, so that we</span>&nbsp;</div></li><li><div>  <span class="comment">// properly mirror restrictions on username, etc.</span>&nbsp;</div></li><li><div>  if ( function_exists( 'wpmu_validate_user_signup' ) ) {&nbsp;</div></li><li><div>      $result = wpmu_validate_user_signup( $user_name, $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// When not running Multisite, we perform our own validation. What</span>&nbsp;</div></li><li><div>  <span class="comment">// follows reproduces much of the logic of wpmu_validate_user_signup(), </span>&nbsp;</div></li><li><div>  <span class="comment">// minus the multisite-specific restrictions on user_login.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the username before being validated.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.5</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_name Username to validate.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $user_name = apply_filters( 'pre_user_login', $user_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User name can't be empty.</span>&nbsp;</div></li><li><div>      if ( empty( $user_name ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Please enter a username', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User name can't be on the blacklist.</span>&nbsp;</div></li><li><div>      $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>      if ( in_array( $user_name, (array) $illegal_names ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'That username is not allowed', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User name must pass WP's validity check.</span>&nbsp;</div></li><li><div>      if ( ! validate_username( $user_name ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Usernames can contain only letters, numbers, ., -, and @', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Minimum of 4 characters.</span>&nbsp;</div></li><li><div>      if ( strlen( $user_name ) &lt; 4 ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Username must be at least 4 characters', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No underscores. @todo Why not?</span>&nbsp;</div></li><li><div>      if ( false !== strpos( ' ' . $user_name, '_' ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Sorry, usernames may not contain the character &quot;_&quot;!', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No usernames that are all numeric. @todo Why?</span>&nbsp;</div></li><li><div>      $match = array();&nbsp;</div></li><li><div>      preg_match( '/[0-9]*/', $user_name, $match );&nbsp;</div></li><li><div>      if ( $match[0] == $user_name ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Sorry, usernames must have letters too!', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check into signups.</span>&nbsp;</div></li><li><div>      $signups = BP_Signup::get( array(&nbsp;</div></li><li><div>          'user_login' =&gt; $user_name, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $signup = isset( $signups['signups'] ) && ! empty( $signups['signups'][0] ) ? $signups['signups'][0] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if the username has been used already.</span>&nbsp;</div></li><li><div>      if ( username_exists( $user_name ) || ! empty( $signup ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'user_name', __( 'Sorry, that username already exists!', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Validate the email address and process the validation results into</span>&nbsp;</div></li><li><div>      <span class="comment">// error messages.</span>&nbsp;</div></li><li><div>      $validate_email = bp_core_validate_email_address( $user_email );&nbsp;</div></li><li><div>      bp_core_add_validation_error_messages( $errors, $validate_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Assemble the return array.</span>&nbsp;</div></li><li><div>      $result = array(&nbsp;</div></li><li><div>          'user_name' =&gt; $user_name, &nbsp;</div></li><li><div>          'user_email' =&gt; $user_email, &nbsp;</div></li><li><div>          'errors' =&gt; $errors, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Apply WPMU legacy filter.</span>&nbsp;</div></li><li><div>      $result = apply_filters( 'wpmu_validate_user_signup', $result );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the result of the user signup validation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $result Results of user validation including errors, if any.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_validate_user_signup', $result );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate blog URL and title provided at signup.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Why do we have this wrapper?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_url   Blog URL requested during registration.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_title Blog title requested during registration.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_validate_blog_signup( $blog_url, $blog_title ) {&nbsp;</div></li><li><div>  if ( ! is_multisite() || ! function_exists( 'wpmu_validate_blog_signup' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the validated blog url and title provided at signup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value Array with the new site data and error messages.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_validate_blog_signup', wpmu_validate_blog_signup( $blog_url, $blog_title ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process data submitted at user registration and convert to a signup object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo There appears to be a bug in the return value on success.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login    Login name requested by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_password Password requested by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email    Email address entered by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $usermeta      Miscellaneous metadata about the user (blog-specific</span>&nbsp;</div></li><li><div><span class="comment"> *                              signup data, xprofile data, etc).</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|WP_Error True on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_signup_user( $user_login, $user_password, $user_email, $usermeta ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need to cast $user_id to pass to the filters.</span>&nbsp;</div></li><li><div>  $user_id = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Multisite installs have their own install procedure.</span>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      wpmu_signup_user( $user_login, $user_email, $usermeta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Format data.</span>&nbsp;</div></li><li><div>      $user_login = preg_replace( '/\s+/', '', sanitize_user( $user_login, true ) );&nbsp;</div></li><li><div>      $user_email = sanitize_email( $user_email );&nbsp;</div></li><li><div>      $activation_key = wp_generate_password( 32, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * WordPress's default behavior is to create user accounts</span>&nbsp;</div></li><li><div><span class="comment">       * immediately at registration time. BuddyPress uses a system</span>&nbsp;</div></li><li><div><span class="comment">       * borrowed from WordPress Multisite, where signups are stored</span>&nbsp;</div></li><li><div><span class="comment">       * separately and accounts are only created at the time of</span>&nbsp;</div></li><li><div><span class="comment">       * activation. For backward compatibility with plugins that may</span>&nbsp;</div></li><li><div><span class="comment">       * be anticipating WP's default behavior, BP silently creates</span>&nbsp;</div></li><li><div><span class="comment">       * accounts for registrations (though it does not use them). If</span>&nbsp;</div></li><li><div><span class="comment">       * you know that you are not running any plugins dependent on</span>&nbsp;</div></li><li><div><span class="comment">       * these pending accounts, you may want to save a little DB</span>&nbsp;</div></li><li><div><span class="comment">       * clutter by defining setting the BP_SIGNUPS_SKIP_USER_CREATION</span>&nbsp;</div></li><li><div><span class="comment">       * to true in your wp-config.php file.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( ! defined( 'BP_SIGNUPS_SKIP_USER_CREATION' ) || ! BP_SIGNUPS_SKIP_USER_CREATION ) {&nbsp;</div></li><li><div>          $user_id = BP_Signup::add_backcompat( $user_login, $user_password, $user_email, $usermeta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>              return $user_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_update_user_meta( $user_id, 'activation_key', $activation_key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'user_login' =&gt; $user_login, &nbsp;</div></li><li><div>          'user_email' =&gt; $user_email, &nbsp;</div></li><li><div>          'activation_key' =&gt; $activation_key, &nbsp;</div></li><li><div>          'meta' =&gt; $usermeta, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      BP_Signup::add( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters if BuddyPress should send an activation key for a new signup.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.2.3</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool   $value          Whether or not to send the activation key.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $user_id        User ID to send activation key to.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_email     User email to send activation key to.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $activation_key Activation key to be sent.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $usermeta       Miscellaneous metadata about the user (blog-specific</span>&nbsp;</div></li><li><div><span class="comment">       *                               signup data, xprofile data, etc).</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( apply_filters( 'bp_core_signup_send_activation_key', true, $user_id, $user_email, $activation_key, $usermeta ) ) {&nbsp;</div></li><li><div>          bp_core_signup_send_validation_email( $user_id, $user_email, $activation_key, $user_login );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp-&gt;signup-&gt;username = $user_login;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the process to sign up a user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool|WP_Error   $user_id       True on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string          $user_login    Login name requested by the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string          $user_password Password requested by the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string          $user_email    Email address requested by the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array           $usermeta      Miscellaneous metadata about the user (blog-specific</span>&nbsp;</div></li><li><div><span class="comment">   *                                       signup data, xprofile data, etc).</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_signup_user', $user_id, $user_login, $user_password, $user_email, $usermeta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a blog and user based on data supplied at user registration.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_domain Domain requested by user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_path   Path requested by user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_title  Title as entered by user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_name   user_login of requesting user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email  Email address of requesting user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $usermeta    Miscellaneous metadata for the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_signup_blog( $blog_domain, $blog_path, $blog_title, $user_name, $user_email, $usermeta ) {&nbsp;</div></li><li><div>  if ( ! is_multisite() || ! function_exists( 'wpmu_signup_blog' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the result of wpmu_signup_blog().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This filter provides no value and is retained for</span>&nbsp;</div></li><li><div><span class="comment">   * backwards compatibility.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param void $value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_signup_blog', wpmu_signup_blog( $blog_domain, $blog_path, $blog_title, $user_name, $user_email, $usermeta ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Activate a signup, as identified by an activation key.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key Activation key.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool User ID on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_activate_signup( $key ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Multisite installs have their own activation routine.</span>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $user = wpmu_activate_signup( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If there were errors, add a message and redirect.</span>&nbsp;</div></li><li><div>      if ( ! empty( $user-&gt;errors ) ) {&nbsp;</div></li><li><div>          return $user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_id = $user['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $signups = BP_Signup::get( array(&nbsp;</div></li><li><div>          'activation_key' =&gt; $key, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $signups['signups'] ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'invalid_key', __( 'Invalid activation key.', 'buddypress' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $signup = $signups['signups'][0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $signup-&gt;active ) {&nbsp;</div></li><li><div>          if ( empty( $signup-&gt;domain ) ) {&nbsp;</div></li><li><div>              return new WP_Error( 'already_active', __( 'The user is already active.', 'buddypress' ), $signup );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return new WP_Error( 'already_active', __( 'The site is already active.', 'buddypress' ), $signup );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Password is hashed again in wp_insert_user.</span>&nbsp;</div></li><li><div>      $password = wp_generate_password( 12, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_id = username_exists( $signup-&gt;user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Create the user. This should only be necessary if BP_SIGNUPS_SKIP_USER_CREATION is true.</span>&nbsp;</div></li><li><div>      if ( ! $user_id ) {&nbsp;</div></li><li><div>          $user_id = wp_create_user( $signup-&gt;user_login, $password, $signup-&gt;user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Otherwise, update the existing user's status.</span>&nbsp;</div></li><li><div>      } elseif ( $key === bp_get_user_meta( $user_id, 'activation_key', true ) || $key === wp_hash( $user_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Change the user's status so they become active.</span>&nbsp;</div></li><li><div>          if ( ! $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;users} SET user_status = 0 WHERE ID = %d&quot;, $user_id ) ) ) {&nbsp;</div></li><li><div>              return new WP_Error( 'invalid_key', __( 'Invalid activation key.', 'buddypress' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          bp_delete_user_meta( $user_id, 'activation_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $member = get_userdata( $user_id );&nbsp;</div></li><li><div>          $member-&gt;set_role( get_option('default_role') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $user_already_created = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $user_already_exists = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $user_id ) {&nbsp;</div></li><li><div>          return new WP_Error( 'create_user', __( 'Could not create user', 'buddypress' ), $signup );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fetch the signup so we have the data later on.</span>&nbsp;</div></li><li><div>      $signups = BP_Signup::get( array(&nbsp;</div></li><li><div>          'activation_key' =&gt; $key, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $signup = isset( $signups['signups'] ) && ! empty( $signups['signups'][0] ) ? $signups['signups'][0] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Activate the signup.</span>&nbsp;</div></li><li><div>      BP_Signup::validate( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $user_already_exists ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'user_already_exists', __( 'That username is already activated.', 'buddypress' ), $signup );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set up data to pass to the legacy filter.</span>&nbsp;</div></li><li><div>      $user = array(&nbsp;</div></li><li><div>          'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>          'password' =&gt; $signup-&gt;meta['password'], &nbsp;</div></li><li><div>          'meta' =&gt; $signup-&gt;meta, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Notify the site admin of a new user registration.</span>&nbsp;</div></li><li><div>      wp_new_user_notification( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $user_already_created ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires if the user has already been created.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $user_id ID of the user being checked.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $key     Activation key.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array  $user    Array of user data.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'bp_core_activated_user', $user_id, $key, $user );&nbsp;</div></li><li><div>          return $user_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set any profile data.</span>&nbsp;</div></li><li><div>  if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>      if ( ! empty( $user['meta']['profile_field_ids'] ) ) {&nbsp;</div></li><li><div>          $profile_field_ids = explode( ', ', $user['meta']['profile_field_ids'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( (array) $profile_field_ids as $field_id ) {&nbsp;</div></li><li><div>              $current_field = isset( $user['meta'][&quot;field_{$field_id}&quot;] ) ? $user['meta'][&quot;field_{$field_id}&quot;] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !empty( $current_field ) ) {&nbsp;</div></li><li><div>                  xprofile_set_field_data( $field_id, $user_id, $current_field );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Save the visibility level.</span>&nbsp;</div></li><li><div>              $visibility_level = ! empty( $user['meta']['field_' . $field_id . '_visibility'] ) ? $user['meta']['field_' . $field_id . '_visibility'] : 'public';&nbsp;</div></li><li><div>              xprofile_set_field_visibility_level( $field_id, $user_id, $visibility_level );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Replace the password automatically generated by WordPress by the one the user chose.</span>&nbsp;</div></li><li><div>  if ( ! empty( $user['meta']['password'] ) ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;users} SET user_pass = %s WHERE ID = %d&quot;, $user['meta']['password'], $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Make sure to clean the user's cache as we've</span>&nbsp;</div></li><li><div><span class="comment">       * directly edited the password without using</span>&nbsp;</div></li><li><div><span class="comment">       * wp_update_user().</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * If we can't use wp_update_user() that's because</span>&nbsp;</div></li><li><div><span class="comment">       * we already hashed the password at the signup step.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $uc = wp_cache_get( $user_id, 'users' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $uc-&gt;ID ) ) {&nbsp;</div></li><li><div>          clean_user_cache( $uc-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the user activation process.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id ID of the user being checked.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key     Activation key.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $user    Array of user data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_activated_user', $user_id, $key, $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Migrate signups from pre-2.0 configuration to wp_signups.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.1</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_members_migrate_signups() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status_2_ids = $wpdb-&gt;get_col( &quot;SELECT ID FROM {$wpdb-&gt;users} WHERE user_status = '2'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $status_2_ids ) ) {&nbsp;</div></li><li><div>      $signups = get_users( array(&nbsp;</div></li><li><div>          'fields' =&gt; array(&nbsp;</div></li><li><div>              'ID', &nbsp;</div></li><li><div>              'user_login', &nbsp;</div></li><li><div>              'user_pass', &nbsp;</div></li><li><div>              'user_registered', &nbsp;</div></li><li><div>              'user_email', &nbsp;</div></li><li><div>              'display_name', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'include' =&gt; $status_2_ids, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fetch activation keys separately, to avoid the all_with_meta</span>&nbsp;</div></li><li><div>      <span class="comment">// overhead.</span>&nbsp;</div></li><li><div>      $status_2_ids_sql = implode( ', ', $status_2_ids );&nbsp;</div></li><li><div>      $ak_data = $wpdb-&gt;get_results( &quot;SELECT user_id, meta_value FROM {$wpdb-&gt;usermeta} WHERE meta_key = 'activation_key' AND user_id IN ({$status_2_ids_sql})&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Rekey.</span>&nbsp;</div></li><li><div>      $activation_keys = array();&nbsp;</div></li><li><div>      foreach ( $ak_data as $ak_datum ) {&nbsp;</div></li><li><div>          $activation_keys[ intval( $ak_datum-&gt;user_id ) ] = $ak_datum-&gt;meta_value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $status_2_ids_sql, $status_2_ids, $ak_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Merge.</span>&nbsp;</div></li><li><div>      foreach ( $signups as &$signup ) {&nbsp;</div></li><li><div>          if ( isset( $activation_keys[ $signup-&gt;ID ] ) ) {&nbsp;</div></li><li><div>              $signup-&gt;activation_key = $activation_keys[ $signup-&gt;ID ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Reset the signup var as we're using it to process the migration.</span>&nbsp;</div></li><li><div>      unset( $signup );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $signups as $signup ) {&nbsp;</div></li><li><div>      $meta = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Rebuild the activation key, if missing.</span>&nbsp;</div></li><li><div>      if ( empty( $signup-&gt;activation_key ) ) {&nbsp;</div></li><li><div>          $signup-&gt;activation_key = wp_generate_password( 32, false );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>          $meta['field_1'] = $signup-&gt;display_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $meta['password'] = $signup-&gt;user_pass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_login = preg_replace( '/\s+/', '', sanitize_user( $signup-&gt;user_login, true ) );&nbsp;</div></li><li><div>      $user_email = sanitize_email( $signup-&gt;user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      BP_Signup::add( array(&nbsp;</div></li><li><div>          'user_login' =&gt; $user_login, &nbsp;</div></li><li><div>          'user_email' =&gt; $user_email, &nbsp;</div></li><li><div>          'registered' =&gt; $signup-&gt;user_registered, &nbsp;</div></li><li><div>          'activation_key' =&gt; $signup-&gt;activation_key, &nbsp;</div></li><li><div>          'meta' =&gt; $meta&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Deleting these options will remove signups from users count.</span>&nbsp;</div></li><li><div>      delete_user_option( $signup-&gt;ID, 'capabilities' );&nbsp;</div></li><li><div>      delete_user_option( $signup-&gt;ID, 'user_level' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Map a user's WP display name to the XProfile fullname field, if necessary.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This only happens when a user is registered in wp-admin by an administrator;</span>&nbsp;</div></li><li><div><span class="comment"> * during normal registration, XProfile data is provided directly by the user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_map_user_registration( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only map data when the site admin is adding users, not on registration.</span>&nbsp;</div></li><li><div>  if ( ! is_admin() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the user's fullname to Xprofile.</span>&nbsp;</div></li><li><div>  if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>      $firstname = bp_get_user_meta( $user_id, 'first_name', true );&nbsp;</div></li><li><div>      $lastname = ' ' . bp_get_user_meta( $user_id, 'last_name', true );&nbsp;</div></li><li><div>      $name = $firstname . $lastname;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $name ) || ' ' == $name ) {&nbsp;</div></li><li><div>          $name = bp_get_user_meta( $user_id, 'nickname', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      xprofile_set_field_data( 1, $user_id, $name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'user_register', 'bp_core_map_user_registration' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the avatar storage directory for use during registration.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool Directory path on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_signup_avatar_upload_dir() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;signup-&gt;avatar_dir ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $directory = 'avatars/signups';&nbsp;</div></li><li><div>  $path = bp_core_avatar_upload_path() . '/' . $directory . '/' . $bp-&gt;signup-&gt;avatar_dir;&nbsp;</div></li><li><div>  $newbdir = $path;&nbsp;</div></li><li><div>  $newurl = bp_core_avatar_url() . '/' . $directory . '/' . $bp-&gt;signup-&gt;avatar_dir;&nbsp;</div></li><li><div>  $newburl = $newurl;&nbsp;</div></li><li><div>  $newsubdir = '/' . $directory . '/' . $bp-&gt;signup-&gt;avatar_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the avatar storage directory for use during registration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value Array of path and URL values for created storage directory.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_signup_avatar_upload_dir', array(&nbsp;</div></li><li><div>      'path' =&gt; $path, &nbsp;</div></li><li><div>      'url' =&gt; $newurl, &nbsp;</div></li><li><div>      'subdir' =&gt; $newsubdir, &nbsp;</div></li><li><div>      'basedir' =&gt; $newbdir, &nbsp;</div></li><li><div>      'baseurl' =&gt; $newburl, &nbsp;</div></li><li><div>      'error' =&gt; false&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send activation email to a newly registered user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0 Add the $user_login parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|bool $user_id    ID of the new user, false if BP_SIGNUPS_SKIP_USER_CREATION is true.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string   $user_email Email address of the new user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string   $key        Activation key.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string   $user_login Optional. The user login name.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_signup_send_validation_email( $user_id, $user_email, $key, $user_login = '' ) {&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'tokens' =&gt; array(&nbsp;</div></li><li><div>          'activate.url' =&gt; esc_url( trailingslashit( bp_get_activation_page() ) . &quot;{$key}/&quot; ), &nbsp;</div></li><li><div>          'key' =&gt; $key, &nbsp;</div></li><li><div>          'user.email' =&gt; $user_email, &nbsp;</div></li><li><div>          'user.id' =&gt; $user_id, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $user_id ) {&nbsp;</div></li><li><div>      $to = $user_id;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $to = array( array( $user_email =&gt; $user_login ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_send_email( 'core-user-registration', $to, $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display a &quot;resend email&quot; link when an unregistered user attempts to log in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error|null $user     Either the WP_User or the WP_Error object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $username The inputted, attempted username.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $password The inputted, attempted password.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_signup_disable_inactive( $user = null, $username = '', $password ='' ) {&nbsp;</div></li><li><div>  <span class="comment">// Login form not used.</span>&nbsp;</div></li><li><div>  if ( empty( $username ) && empty( $password ) ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// An existing WP_User with a user_status of 2 is either a legacy</span>&nbsp;</div></li><li><div>  <span class="comment">// signup, or is a user created for backward compatibility. See</span>&nbsp;</div></li><li><div>  <span class="comment">// {@link bp_core_signup_user()} for more details.</span>&nbsp;</div></li><li><div>  if ( is_a( $user, 'WP_User' ) && 2 == $user-&gt;user_status ) {&nbsp;</div></li><li><div>      $user_login = $user-&gt;user_login;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no WP_User is found corresponding to the username, this</span>&nbsp;</div></li><li><div>  <span class="comment">// is a potential signup.</span>&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $user ) && 'invalid_username' == $user-&gt;get_error_code() ) {&nbsp;</div></li><li><div>      $user_login = $username;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// This is an activated user, so bail.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Look for the unactivated signup corresponding to the login name.</span>&nbsp;</div></li><li><div>  $signup = BP_Signup::get( array( 'user_login' =&gt; sanitize_user( $user_login ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No signup or more than one, something is wrong. Let's bail.</span>&nbsp;</div></li><li><div>  if ( empty( $signup['signups'][0] ) || $signup['total'] &gt; 1 ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Unactivated user account found!</span>&nbsp;</div></li><li><div>  <span class="comment">// Set up the feedback message.</span>&nbsp;</div></li><li><div>  $signup_id = $signup['signups'][0]-&gt;signup_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $resend_url_params = array(&nbsp;</div></li><li><div>      'action' =&gt; 'bp-resend-activation', &nbsp;</div></li><li><div>      'id' =&gt; $signup_id, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $resend_url = wp_nonce_url(&nbsp;</div></li><li><div>      add_query_arg( $resend_url_params, wp_login_url() ), &nbsp;</div></li><li><div>      'bp-resend-activation'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $resend_string = '&lt;br /&gt;&lt;br /&gt;' . sprintf( __( 'If you have not received an email yet, &lt;a href=&quot;%s&quot;&gt;click here to resend it&lt;/a&gt;.', 'buddypress' ), esc_url( $resend_url ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return new WP_Error( 'bp_account_not_activated', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your account has not been activated. Check your email for the activation link.', 'buddypress' ) . $resend_string );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'authenticate', 'bp_core_signup_disable_inactive', 30, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * On the login screen, resends the activation email for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_core_signup_disable_inactive()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_members_login_resend_activation_email() {&nbsp;</div></li><li><div>  global $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_GET['id'] ) || empty( $_GET['_wpnonce'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify nonce.</span>&nbsp;</div></li><li><div>  if ( ! wp_verify_nonce( $_GET['_wpnonce'], 'bp-resend-activation' ) ) {&nbsp;</div></li><li><div>      die( 'Security check' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $signup_id = (int) $_GET['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Resend the activation email.</span>&nbsp;</div></li><li><div>  <span class="comment">// also updates the 'last sent' and '# of emails sent' values.</span>&nbsp;</div></li><li><div>  $resend = BP_Signup::resend( array( $signup_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add feedback message.</span>&nbsp;</div></li><li><div>  if ( ! empty( $resend['errors'] ) ) {&nbsp;</div></li><li><div>      $error = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your account has already been activated.', 'buddypress' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $error = __( 'Activation email resent! Please check your inbox or spam folder.', 'buddypress' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'login_form_bp-resend-activation', 'bp_members_login_resend_activation_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirect away from wp-signup.php if BP registration templates are present.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_wpsignup_redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail in admin or if custom signup page is broken.</span>&nbsp;</div></li><li><div>  if ( is_admin() || ! bp_has_custom_signup_page() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $action = !empty( $_GET['action'] ) ? $_GET['action'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Not at the WP core signup page and action is not register.</span>&nbsp;</div></li><li><div>  if ( ! empty( $_SERVER['SCRIPT_NAME'] ) && false === strpos( 'wp-signup.php', $_SERVER['SCRIPT_NAME'] ) && ( 'register' != $action ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_core_redirect( bp_get_signup_page() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_init', 'bp_core_wpsignup_redirect' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Stop a logged-in user who is marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When an admin marks a live user as a spammer, that user can still surf</span>&nbsp;</div></li><li><div><span class="comment"> * around and cause havoc on the site until that person is logged out.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This code checks to see if a logged-in user is marked as a spammer.  If so, </span>&nbsp;</div></li><li><div><span class="comment"> * we redirect the user back to wp-login.php with the 'reauth' parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This clears the logged-in spammer's cookies and will ask the spammer to</span>&nbsp;</div></li><li><div><span class="comment"> * reauthenticate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note: A spammer cannot log back in - {@see bp_core_boot_spammer()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Runs on 'bp_init' at priority 5 so the members component globals are setup</span>&nbsp;</div></li><li><div><span class="comment"> * before we do our spammer checks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is important as the $bp-&gt;loggedin_user object is setup at priority 4.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_stop_live_spammer() {&nbsp;</div></li><li><div>  <span class="comment">// If we're on the login page, stop now to prevent redirect loop.</span>&nbsp;</div></li><li><div>  $is_login = false;&nbsp;</div></li><li><div>  if ( isset( $GLOBALS['pagenow'] ) && ( false !== strpos( $GLOBALS['pagenow'], 'wp-login.php' ) ) ) {&nbsp;</div></li><li><div>      $is_login = true;&nbsp;</div></li><li><div>  } elseif ( isset( $_SERVER['SCRIPT_NAME'] ) && false !== strpos( $_SERVER['SCRIPT_NAME'], 'wp-login.php' ) ) {&nbsp;</div></li><li><div>      $is_login = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_login ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User isn't logged in, so stop!</span>&nbsp;</div></li><li><div>  if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If spammer, redirect to wp-login.php and reauthorize.</span>&nbsp;</div></li><li><div>  if ( bp_is_user_spammer( bp_loggedin_user_id() ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Setup login args.</span>&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          <span class="comment">// Custom action used to throw an error message.</span>&nbsp;</div></li><li><div>          'action' =&gt; 'bp-spam', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Reauthorize user to login.</span>&nbsp;</div></li><li><div>          'reauth' =&gt; 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the url used for redirection for a logged in user marked as spam.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value URL to redirect user to.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $login_url = apply_filters( 'bp_live_spammer_redirect', add_query_arg( $args, wp_login_url() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Redirect user to login page.</span>&nbsp;</div></li><li><div>      wp_redirect( $login_url );&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_init', 'bp_stop_live_spammer', 5 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Show a custom error message when a logged-in user is marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_live_spammer_login_error() {&nbsp;</div></li><li><div>  global $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $error = __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your account has been marked as a spammer.', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Shake shake shake!</span>&nbsp;</div></li><li><div>  add_action( 'login_head', 'wp_shake_js', 12 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'login_form_bp-spam', 'bp_live_spammer_login_error' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the displayed user Object</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return object The displayed user object, null otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_displayed_user() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $displayed_user = null;&nbsp;</div></li><li><div>  if ( ! empty( $bp-&gt;displayed_user-&gt;id ) ) {&nbsp;</div></li><li><div>      $displayed_user = $bp-&gt;displayed_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the displayed_user object corresponding to the displayed member.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $displayed_user The displayed_user object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_get_displayed_user', $displayed_user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Member Types *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output the slug of the member type taxonomy.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_member_type_tax_name() {&nbsp;</div></li><li><div>  echo bp_get_member_type_tax_name();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the slug of the member type taxonomy.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string The unique member taxonomy slug.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function bp_get_member_type_tax_name() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the slug of the member type taxonomy.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value Member type taxonomy slug.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'bp_get_member_type_tax_name', 'bp_member_type' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register a member type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $member_type Unique string identifier for the member type.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Array of arguments describing the member type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array       $labels {</span>&nbsp;</div></li><li><div><span class="comment"> *         Array of labels to use in various parts of the interface.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *         @type string $name          Default name. Should typically be plural.</span>&nbsp;</div></li><li><div><span class="comment"> *         @type string $singular_name Singular name.</span>&nbsp;</div></li><li><div><span class="comment"> *     }</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|string $has_directory Whether the member type should have its own type-specific directory.</span>&nbsp;</div></li><li><div><span class="comment"> *                                      Pass `true` to use the `$member_type` string as the type's slug.</span>&nbsp;</div></li><li><div><span class="comment"> *                                      Pass a string to customize the slug. Pass `false` to disable.</span>&nbsp;</div></li><li><div><span class="comment"> *                                      Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return object|WP_Error Member type object on success, WP_Error object on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_register_member_type( $member_type, $args = array() ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $bp-&gt;members-&gt;types[ $member_type ] ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'bp_member_type_exists', __( 'Member type already exists.', 'buddypress' ), $member_type );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = bp_parse_args( $args, array(&nbsp;</div></li><li><div>      'labels' =&gt; array(), &nbsp;</div></li><li><div>      'has_directory' =&gt; true, &nbsp;</div></li><li><div> ), 'register_member_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $member_type = sanitize_key( $member_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the list of illegal member type names.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * - 'any' is a special pseudo-type, representing items unassociated with any member type.</span>&nbsp;</div></li><li><div><span class="comment">   * - 'null' is a special pseudo-type, representing users without any type.</span>&nbsp;</div></li><li><div><span class="comment">   * - '_none' is used internally to denote an item that should not apply to any member types.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $illegal_names Array of illegal names.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $illegal_names = apply_filters( 'bp_member_type_illegal_names', array( 'any', 'null', '_none' ) );&nbsp;</div></li><li><div>  if ( in_array( $member_type, $illegal_names, true ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'bp_member_type_illegal_name', __( 'You may not register a member type with this name.', 'buddypress' ), $member_type );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store the post type name as data in the object (not just as the array key).</span>&nbsp;</div></li><li><div>  $r['name'] = $member_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure the relevant labels have been filled in.</span>&nbsp;</div></li><li><div>  $default_name = isset( $r['labels']['name'] ) ? $r['labels']['name'] : ucfirst( $r['name'] );&nbsp;</div></li><li><div>  $r['labels'] = array_merge( array(&nbsp;</div></li><li><div>      'name' =&gt; $default_name, &nbsp;</div></li><li><div>      'singular_name' =&gt; $default_name, &nbsp;</div></li><li><div> ), $r['labels'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Directory slug.</span>&nbsp;</div></li><li><div>  if ( $r['has_directory'] ) {&nbsp;</div></li><li><div>      <span class="comment">// A string value is intepreted as the directory slug. Otherwise fall back on member type.</span>&nbsp;</div></li><li><div>      if ( is_string( $r['has_directory'] ) ) {&nbsp;</div></li><li><div>          $directory_slug = $r['has_directory'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $directory_slug = $member_type;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Sanitize for use in URLs.</span>&nbsp;</div></li><li><div>      $r['directory_slug'] = sanitize_title( $directory_slug );&nbsp;</div></li><li><div>      $r['has_directory'] = true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $r['directory_slug'] = '';&nbsp;</div></li><li><div>      $r['has_directory'] = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp-&gt;members-&gt;types[ $member_type ] = $type = (object) $r;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a member type is registered.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $member_type Member type identifier.</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $type        Member type object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_registered_member_type', $member_type, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $type;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve a member type object by name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $member_type The name of the member type.</span>&nbsp;</div></li><li><div><span class="comment"> * @return object A member type object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_member_type_object( $member_type ) {&nbsp;</div></li><li><div>  $types = bp_get_member_types( array(), 'objects' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $types[ $member_type ] ) ) {&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $types[ $member_type ];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a list of all registered member type objects.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_register_member_type() for accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args     Optional. An array of key =&gt; value arguments to match against</span>&nbsp;</div></li><li><div><span class="comment"> *                               the member type objects. Default empty array.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $output   Optional. The type of output to return. Accepts 'names'</span>&nbsp;</div></li><li><div><span class="comment"> *                               or 'objects'. Default 'names'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $operator Optional. The logical operation to perform. 'or' means only one</span>&nbsp;</div></li><li><div><span class="comment"> *                               element from the array needs to match; 'and' means all elements</span>&nbsp;</div></li><li><div><span class="comment"> *                               must match. Accepts 'or' or 'and'. Default 'and'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array A list of member type names or objects.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_member_types( $args = array(), $output = 'names', $operator = 'and' ) {&nbsp;</div></li><li><div>  $types = buddypress()-&gt;members-&gt;types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $types = wp_filter_object_list( $types, $args, $operator );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the array of member type objects.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This filter is run before the $output filter has been applied, so that</span>&nbsp;</div></li><li><div><span class="comment">   * filtering functions have access to the entire member type objects.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $types     Member type objects, keyed by name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $args      Array of key=&gt;value arguments for filtering.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $operator  'or' to match any of $args, 'and' to require all.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $types = apply_filters( 'bp_get_member_types', $types, $args, $operator );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'names' === $output ) {&nbsp;</div></li><li><div>      $types = wp_list_pluck( $types, 'name' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $types;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set type for a member.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $member_type Member type.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $append      Optional. True to append this to existing types for user, </span>&nbsp;</div></li><li><div><span class="comment"> *                            false to replace. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $retval See {@see bp_set_object_terms()}.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_set_member_type( $user_id, $member_type, $append = false ) {&nbsp;</div></li><li><div>  <span class="comment">// Pass an empty $member_type to remove a user's type.</span>&nbsp;</div></li><li><div>  if ( ! empty( $member_type ) && ! bp_get_member_type_object( $member_type ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = bp_set_object_terms( $user_id, $member_type, bp_get_member_type_tax_name(), $append );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bust the cache if the type has been updated.</span>&nbsp;</div></li><li><div>  if ( ! is_wp_error( $retval ) ) {&nbsp;</div></li><li><div>      wp_cache_delete( $user_id, 'bp_member_member_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires just after a user's member type has been changed.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $user_id     ID of the user whose member type has been updated.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $member_type Member type.</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool   $append      Whether the type is being appended to existing types.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_set_member_type', $user_id, $member_type, $append );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove type for a member.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $member_type Member Type.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_remove_member_type( $user_id, $member_type ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if no valid member type was passed.</span></span>&nbsp;</div></li><li><div>  if ( empty( $member_type ) || ! bp_get_member_type_object( $member_type ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $deleted = bp_remove_object_terms( $user_id, $member_type, bp_get_member_type_tax_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bust the cache if the type has been removed.</span>&nbsp;</div></li><li><div>  if ( ! is_wp_error( $deleted ) ) {&nbsp;</div></li><li><div>      wp_cache_delete( $user_id, 'bp_member_member_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires just after a user's member type has been removed.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $user_id     ID of the user whose member type has been updated.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $member_type Member type.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_remove_member_type', $user_id, $member_type );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $deleted;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get type for a member.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int  $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $single  Optional. Whether to return a single type string. If multiple types are found</span>&nbsp;</div></li><li><div><span class="comment"> *                      for the user, the oldest one will be returned. Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|array|bool On success, returns a single member type (if $single is true) or an array of member</span>&nbsp;</div></li><li><div><span class="comment"> *                           types (if $single is false). Returns false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_member_type( $user_id, $single = true ) {&nbsp;</div></li><li><div>  $types = wp_cache_get( $user_id, 'bp_member_member_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $types ) {&nbsp;</div></li><li><div>      $raw_types = bp_get_object_terms( $user_id, bp_get_member_type_tax_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $raw_types ) ) {&nbsp;</div></li><li><div>          $types =  array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Only include currently registered group types.</span>&nbsp;</div></li><li><div>          foreach ( $raw_types as $mtype ) {&nbsp;</div></li><li><div>              if ( bp_get_member_type_object( $mtype-&gt;name ) ) {&nbsp;</div></li><li><div>                  $types[] = $mtype-&gt;name;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_cache_set( $user_id, $types, 'bp_member_member_type' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $type = false;&nbsp;</div></li><li><div>  if ( ! empty( $types ) ) {&nbsp;</div></li><li><div>      if ( $single ) {&nbsp;</div></li><li><div>          $type = array_pop( $types );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $type = $types;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's member type(s).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type    Member type.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $single  Whether to return a single type string, or an array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_get_member_type', $type, $user_id, $single );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether the given user has a certain member type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $member_type Member Type.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether the user has the given member type.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_has_member_type( $user_id, $member_type ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Bail if no valid member type was passed.</span></span>&nbsp;</div></li><li><div>  if ( empty( $member_type ) || ! bp_get_member_type_object( $member_type ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get all user's member types.</span>&nbsp;</div></li><li><div>  $types = bp_get_member_type( $user_id, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $types ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return in_array( $member_type, $types );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete a user's member type when the user when the user is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $value See {@see bp_set_member_type()}.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_remove_member_type_on_user_delete( $user_id ) {&nbsp;</div></li><li><div>  return bp_set_member_type( $user_id, '' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpmu_delete_user', 'bp_remove_member_type_on_user_delete' );&nbsp;</div></li><li><div>add_action( 'delete_user', 'bp_remove_member_type_on_user_delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the &quot;current&quot; member type, if one is provided, in member directories.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_current_member_type() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the &quot;current&quot; member type, if one is provided, in member directories.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value &quot;Current&quot; member type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_get_current_member_type', buddypress()-&gt;current_member_type );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>