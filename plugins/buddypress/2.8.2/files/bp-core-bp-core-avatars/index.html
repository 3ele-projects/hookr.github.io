<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.8.2" data-slug="buddypress" data-type="file" data-id="49022"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-core-bp-core-avatars | file | Buddypress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress, 2.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.24"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=b4ea5594d74460d1dd331dc40f084703' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.24' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-core-bp-core-avatars/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-core-bp-core-avatars%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-core-bp-core-avatars%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-2.8.2-file-bp-core-bp-core-avatars","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-core-bp-core-avatars" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress." href="http://hookr.io/plugins/buddypress/" class="plugin"><span property="name">buddypress</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.2." href="http://hookr.io/plugins/buddypress/2.8.2/" class="H_VERSION"><span property="name">2.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress/2.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-core-bp-core-avatars</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="7837"><a href="http://hookr.io/plugins/buddypress/2.8.2/all/" title="All">All <span class="count badge">7837</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="3621"><a href="http://hookr.io/plugins/buddypress/2.8.2/hooks/" title="Hooks">Hooks <span class="count badge">3621</span></a></li><li class="" data-id="action" data-count="1727"><a href="http://hookr.io/plugins/buddypress/2.8.2/actions/" title="Actions">Actions <span class="count badge">1727</span></a></li><li class="" data-id="filter" data-count="1894"><a href="http://hookr.io/plugins/buddypress/2.8.2/filters/" title="Filters">Filters <span class="count badge">1894</span></a></li><li class="" data-id="class" data-count="181"><a href="http://hookr.io/plugins/buddypress/2.8.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="161"><a href="http://hookr.io/plugins/buddypress/2.8.2/constants/" title="Constants">Constants <span class="count badge">161</span></a></li><li class="" data-id="function" data-count="3874"><a href="http://hookr.io/plugins/buddypress/2.8.2/functions/" title="Functions">Functions <span class="count badge">3874</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress/2.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-core/bp-core-avatars.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BuddyPress Avatars.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package BuddyPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Core</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly.</span>&nbsp;</div></li><li><div>defined( 'ABSPATH' ) || exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up the constants we need for avatar support.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_set_avatar_constants() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_THUMB_WIDTH' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_THUMB_WIDTH', 50 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_THUMB_HEIGHT' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_THUMB_HEIGHT', 50 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_FULL_WIDTH' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_FULL_WIDTH', 150 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_FULL_HEIGHT' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_FULL_HEIGHT', 150 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_ORIGINAL_MAX_WIDTH' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_ORIGINAL_MAX_WIDTH', 450 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'BP_AVATAR_ORIGINAL_MAX_FILESIZE' ) ) {&nbsp;</div></li><li><div>      define( 'BP_AVATAR_ORIGINAL_MAX_FILESIZE', bp_attachments_get_max_upload_file_size( 'avatar' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! defined( 'BP_SHOW_AVATARS' ) ) {&nbsp;</div></li><li><div>      define( 'BP_SHOW_AVATARS', bp_get_option( 'show_avatars' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_init', 'bp_core_set_avatar_constants', 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up global variables related to avatars.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_set_avatar_globals() {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp-&gt;avatar = new stdClass;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;thumb = new stdClass;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;full = new stdClass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Dimensions.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;thumb-&gt;width = BP_AVATAR_THUMB_WIDTH;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;thumb-&gt;height = BP_AVATAR_THUMB_HEIGHT;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;full-&gt;width = BP_AVATAR_FULL_WIDTH;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;full-&gt;height = BP_AVATAR_FULL_HEIGHT;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upload maximums.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;original_max_width = BP_AVATAR_ORIGINAL_MAX_WIDTH;&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;original_max_filesize = BP_AVATAR_ORIGINAL_MAX_FILESIZE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Defaults.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;thumb-&gt;default = bp_core_avatar_default_thumb();&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;full-&gt;default = bp_core_avatar_default();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// These have to be set on page load in order to avoid infinite filter loops at runtime.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;upload_path = bp_core_avatar_upload_path();&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;url = bp_core_avatar_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cache the root blog's show_avatars setting, to avoid unnecessary</span>&nbsp;</div></li><li><div>  <span class="comment">// calls to switch_to_blog().</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar-&gt;show_avatars = (bool) BP_SHOW_AVATARS;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Backpat for pre-1.5.</span></span>&nbsp;</div></li><li><div>  if ( ! defined( 'BP_AVATAR_UPLOAD_PATH' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_UPLOAD_PATH', $bp-&gt;avatar-&gt;upload_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Backpat for pre-1.5.</span></span>&nbsp;</div></li><li><div>  if ( ! defined( 'BP_AVATAR_URL' ) )&nbsp;</div></li><li><div>      define( 'BP_AVATAR_URL', $bp-&gt;avatar-&gt;url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires at the end of the core avatar globals setup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_set_avatar_globals' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_setup_globals', 'bp_core_set_avatar_globals' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get an avatar for a BuddyPress object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Supports avatars for users, groups, and blogs by default, but can be</span>&nbsp;</div></li><li><div><span class="comment"> * extended to support custom components as well.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function gives precedence to locally-uploaded avatars. When a local</span>&nbsp;</div></li><li><div><span class="comment"> * avatar is not found, Gravatar is queried. To disable Gravatar fallbacks</span>&nbsp;</div></li><li><div><span class="comment"> * locally:</span>&nbsp;</div></li><li><div><span class="comment"> *    add_filter( 'bp_core_fetch_avatar_no_grav', '__return_true' );</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0 Added 'extra_attr', 'scheme', 'rating' and 'force_default' for $args.</span>&nbsp;</div></li><li><div><span class="comment"> *              These are inherited from WordPress 4.2.0. See {@link get_avatar()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     An array of arguments. All arguments are technically optional; some</span>&nbsp;</div></li><li><div><span class="comment"> *     will, if not provided, be auto-detected by bp_core_fetch_avatar(). This</span>&nbsp;</div></li><li><div><span class="comment"> *     auto-detection is described more below, when discussing specific</span>&nbsp;</div></li><li><div><span class="comment"> *     arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool    $item_id    The numeric ID of the item for which you're requesting</span>&nbsp;</div></li><li><div><span class="comment"> *                                   an avatar (eg, a user ID). If no 'item_id' is present, </span>&nbsp;</div></li><li><div><span class="comment"> *                                   the function attempts to infer an ID from the 'object' + the</span>&nbsp;</div></li><li><div><span class="comment"> *                                   current context: if 'object' is 'user' and the current page is a</span>&nbsp;</div></li><li><div><span class="comment"> *                                   user page, 'item_id' will default to the displayed user ID; if</span>&nbsp;</div></li><li><div><span class="comment"> *                                   'group' and on a group page, to the current group ID; if 'blog', </span>&nbsp;</div></li><li><div><span class="comment"> *                                   to the current blog's ID. If no 'item_id' can be determined in</span>&nbsp;</div></li><li><div><span class="comment"> *                                   this way, the function returns false. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $object     The kind of object for which you're getting an</span>&nbsp;</div></li><li><div><span class="comment"> *                                   avatar. BuddyPress natively supports three options: 'user', </span>&nbsp;</div></li><li><div><span class="comment"> *                                   'group', 'blog'; a plugin may register more.  Default: 'user'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $type       When a new avatar is uploaded to BP, 'thumb' and</span>&nbsp;</div></li><li><div><span class="comment"> *                                   'full' versions are saved. This parameter specifies whether you'd</span>&nbsp;</div></li><li><div><span class="comment"> *                                   like the 'full' or smaller 'thumb' avatar. Default: 'thumb'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $avatar_dir The name of the subdirectory where the</span>&nbsp;</div></li><li><div><span class="comment"> *                                   requested avatar should be found. If no value is passed, </span>&nbsp;</div></li><li><div><span class="comment"> *                                   'avatar_dir' is inferred from 'object': 'user' becomes 'avatars', </span>&nbsp;</div></li><li><div><span class="comment"> *                                   'group' becomes 'group-avatars', 'blog' becomes 'blog-avatars'.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Remember that this string denotes a subdirectory of BP's main</span>&nbsp;</div></li><li><div><span class="comment"> *                                   avatar directory (usually based on {@link wp_upload_dir()}); it's a</span>&nbsp;</div></li><li><div><span class="comment"> *                                   string like 'group-avatars' rather than the full directory path.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Generally, it'll only be necessary to override the default value if</span>&nbsp;</div></li><li><div><span class="comment"> *                                   storing avatars in a non-default location. Defaults to false</span>&nbsp;</div></li><li><div><span class="comment"> *                                   (auto-detected).</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool    $width      Requested avatar width. The unit is px. This value</span>&nbsp;</div></li><li><div><span class="comment"> *                                   is used to build the 'width' attribute for the &lt;img&gt; element. If</span>&nbsp;</div></li><li><div><span class="comment"> *                                   no value is passed, BP uses the global avatar width for this</span>&nbsp;</div></li><li><div><span class="comment"> *                                   avatar type. Default: false (auto-detected).</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool    $height     Requested avatar height. The unit is px. This</span>&nbsp;</div></li><li><div><span class="comment"> *                                   value is used to build the 'height' attribute for the &lt;img&gt;</span>&nbsp;</div></li><li><div><span class="comment"> *                                   element. If no value is passed, BP uses the global avatar height</span>&nbsp;</div></li><li><div><span class="comment"> *                                   for this avatar type. Default: false (auto-detected).</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $class      The CSS class for the &lt;img&gt; element. Note that BP</span>&nbsp;</div></li><li><div><span class="comment"> *                                   uses the 'avatar' class fairly extensively in its default styling, </span>&nbsp;</div></li><li><div><span class="comment"> *                                   so if you plan to pass a custom value, consider appending it to</span>&nbsp;</div></li><li><div><span class="comment"> *                                   'avatar' (eg 'avatar foo') rather than replacing it altogether.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: 'avatar'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $css_id     The CSS id for the &lt;img&gt; element.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $title      The title attribute for the &lt;img&gt; element.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $alt        The alt attribute for the &lt;img&gt; element. In BP, this</span>&nbsp;</div></li><li><div><span class="comment"> *                                   value is generally passed by the wrapper functions, where the data</span>&nbsp;</div></li><li><div><span class="comment"> *                                   necessary for concatenating the string is at hand; see</span>&nbsp;</div></li><li><div><span class="comment"> *                                   {@link bp_get_activity_avatar()} for an example. Default: ''.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $email      An email to use in Gravatar queries. Unless</span>&nbsp;</div></li><li><div><span class="comment"> *                                   otherwise configured, BP uses Gravatar as a fallback for avatars</span>&nbsp;</div></li><li><div><span class="comment"> *                                   that are not provided locally. Gravatar's API requires using a hash</span>&nbsp;</div></li><li><div><span class="comment"> *                                   of the user's email address; this argument provides it. If not</span>&nbsp;</div></li><li><div><span class="comment"> *                                   provided, the function will infer it: for users, by getting the</span>&nbsp;</div></li><li><div><span class="comment"> *                                   user's email from the database, for groups/blogs, by concatenating</span>&nbsp;</div></li><li><div><span class="comment"> *                                   &quot;{$item_id}-{$object}@{bp_get_root_domain()}&quot;. The user query adds</span>&nbsp;</div></li><li><div><span class="comment"> *                                   overhead, so it's recommended that wrapper functions provide a</span>&nbsp;</div></li><li><div><span class="comment"> *                                   value for 'email' when querying user IDs. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool       $no_grav     Whether to disable the default Gravatar fallback.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   By default, BP will fall back on Gravatar when it cannot find a</span>&nbsp;</div></li><li><div><span class="comment"> *                                   local avatar. In some cases, this may be undesirable, in which</span>&nbsp;</div></li><li><div><span class="comment"> *                                   case 'no_grav' should be set to true. To disable Gravatar</span>&nbsp;</div></li><li><div><span class="comment"> *                                   fallbacks globally, see the 'bp_core_fetch_avatar_no_grav' filter.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: true for groups, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool       $html        Whether to return an &lt;img&gt; HTML element, vs a raw URL</span>&nbsp;</div></li><li><div><span class="comment"> *                                   to an avatar. If false, &lt;img&gt;-specific arguments (like 'css_id')</span>&nbsp;</div></li><li><div><span class="comment"> *                                   will be ignored. Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string     $extra_attr  HTML attributes to insert in the IMG element. Not sanitized. Default: ''.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string     $scheme      URL scheme to use. See set_url_scheme() for accepted values.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default null.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string     $rating      What rating to display Gravatars for. Accepts 'G', 'PG', 'R', 'X'.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default is the value of the 'avatar_rating' option.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool       $force_default Used when creating the Gravatar URL. Whether to force the default</span>&nbsp;</div></li><li><div><span class="comment"> *                                     image regardless if the Gravatar exists. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Formatted HTML &lt;img&gt; element, or raw avatar URL based on $html arg.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_fetch_avatar( $args = '' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If avatars are disabled for the root site, obey that request and bail.</span>&nbsp;</div></li><li><div>  if ( ! $bp-&gt;avatar-&gt;show_avatars ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $current_blog;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the default variables array and parse it against incoming $args array.</span>&nbsp;</div></li><li><div>  $params = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'item_id' =&gt; false, &nbsp;</div></li><li><div>      'object' =&gt; 'user', &nbsp;</div></li><li><div>      'type' =&gt; 'thumb', &nbsp;</div></li><li><div>      'avatar_dir' =&gt; false, &nbsp;</div></li><li><div>      'width' =&gt; false, &nbsp;</div></li><li><div>      'height' =&gt; false, &nbsp;</div></li><li><div>      'class' =&gt; 'avatar', &nbsp;</div></li><li><div>      'css_id' =&gt; false, &nbsp;</div></li><li><div>      'alt' =&gt; '', &nbsp;</div></li><li><div>      'email' =&gt; false, &nbsp;</div></li><li><div>      'no_grav' =&gt; null, &nbsp;</div></li><li><div>      'html' =&gt; true, &nbsp;</div></li><li><div>      'title' =&gt; '', &nbsp;</div></li><li><div>      'extra_attr' =&gt; '', &nbsp;</div></li><li><div>      'scheme' =&gt; null, &nbsp;</div></li><li><div>      'rating' =&gt; get_option( 'avatar_rating' ), &nbsp;</div></li><li><div>      'force_default' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Set item_id ***********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $params['item_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $params['object'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'blog'  :&nbsp;</div></li><li><div>              $params['item_id'] = $current_blog-&gt;id;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'group' :&nbsp;</div></li><li><div>              if ( bp_is_active( 'groups' ) ) {&nbsp;</div></li><li><div>                  $params['item_id'] = $bp-&gt;groups-&gt;current_group-&gt;id;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $params['item_id'] = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'user'  :&nbsp;</div></li><li><div>          default      :&nbsp;</div></li><li><div>              $params['item_id'] = bp_displayed_user_id();&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the ID of the item being requested.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  ID of avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $params['item_id'] = apply_filters( 'bp_core_avatar_item_id', $params['item_id'], $params['object'], $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $params['item_id'] ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Set avatar_dir ********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $params['avatar_dir'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $params['object'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'blog'  :&nbsp;</div></li><li><div>              $params['avatar_dir'] = 'blog-avatars';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'group' :&nbsp;</div></li><li><div>              if ( bp_is_active( 'groups' ) ) {&nbsp;</div></li><li><div>                  $params['avatar_dir'] = 'group-avatars';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $params['avatar_dir'] = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'user'  :&nbsp;</div></li><li><div>          default      :&nbsp;</div></li><li><div>              $params['avatar_dir'] = 'avatars';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the avatar directory to use.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  Name of the subdirectory where the requested avatar should be found.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $params['avatar_dir'] = apply_filters( 'bp_core_avatar_dir', $params['avatar_dir'], $params['object'], $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $params['avatar_dir'] ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** &lt;img&gt; alt *************************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== strpos( $params['alt'], '%s' ) || false !== strpos( $params['alt'], '%1$s' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $params['object'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'blog'  :&nbsp;</div></li><li><div>              $item_name = get_blog_option( $params['item_id'], 'blogname' );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'group' :&nbsp;</div></li><li><div>              $item_name = bp_get_group_name( groups_get_group( $params['item_id'] ) );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'user'  :&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $item_name = bp_core_get_user_displayname( $params['item_id'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the alt attribute value to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  alt to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  ID of avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $item_name = apply_filters( 'bp_core_avatar_alt', $item_name, $params['item_id'], $params['object'], $params );&nbsp;</div></li><li><div>      $params['alt'] = sprintf( $params['alt'], $item_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Sanity Checks *********************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get a fallback for the 'alt' parameter, create html output.</span>&nbsp;</div></li><li><div>  if ( empty( $params['alt'] ) ) {&nbsp;</div></li><li><div>      $params['alt'] = __( 'Profile Photo', 'buddypress' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $html_alt = ' alt=&quot;' . esc_attr( $params['alt'] ) . '&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Filter image title and create html string.</span>&nbsp;</div></li><li><div>  $html_title = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the title attribute value to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  Title to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  ID of avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $params['title'] = apply_filters( 'bp_core_avatar_title', $params['title'], $params['item_id'], $params['object'], $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $params['title'] ) ) {&nbsp;</div></li><li><div>      $html_title = ' title=&quot;' . esc_attr( $params['title'] ) . '&quot;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Extra attributes.</span>&nbsp;</div></li><li><div>  $extra_attr = ! empty( $args['extra_attr'] ) ? ' ' . $args['extra_attr'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set CSS ID and create html string.</span>&nbsp;</div></li><li><div>  $html_css_id = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the ID attribute to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  ID to be applied to avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  ID of avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $params['css_id'] = apply_filters( 'bp_core_css_id', $params['css_id'], $params['item_id'], $params['object'], $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $params['css_id'] ) ) {&nbsp;</div></li><li><div>      $html_css_id = ' id=&quot;' . esc_attr( $params['css_id'] ) . '&quot;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set image width.</span>&nbsp;</div></li><li><div>  if ( false !== $params['width'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Width has been specified. No modification necessary.</span>&nbsp;</div></li><li><div>  } elseif ( 'thumb' == $params['type'] ) {&nbsp;</div></li><li><div>      $params['width'] = bp_core_avatar_thumb_width();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $params['width'] = bp_core_avatar_full_width();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $html_width = ' width=&quot;' . $params['width'] . '&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set image height.</span>&nbsp;</div></li><li><div>  if ( false !== $params['height'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Height has been specified. No modification necessary.</span>&nbsp;</div></li><li><div>  } elseif ( 'thumb' == $params['type'] ) {&nbsp;</div></li><li><div>      $params['height'] = bp_core_avatar_thumb_height();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $params['height'] = bp_core_avatar_full_height();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $html_height = ' height=&quot;' . $params['height'] . '&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the classes to be applied to the avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|string $value  Class(es) to be applied to the avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $value  ID of the avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $value  Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array        $params Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $params['class'] = apply_filters( 'bp_core_avatar_class', $params['class'], $params['item_id'], $params['object'], $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use an alias to leave the param unchanged.</span>&nbsp;</div></li><li><div>  $avatar_classes = $params['class'];&nbsp;</div></li><li><div>  if ( ! is_array( $avatar_classes ) ) {&nbsp;</div></li><li><div>      $avatar_classes = explode( ' ', $avatar_classes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge classes.</span>&nbsp;</div></li><li><div>  $avatar_classes = array_merge( $avatar_classes, array(&nbsp;</div></li><li><div>      $params['object'] . '-' . $params['item_id'] . '-avatar', &nbsp;</div></li><li><div>      'avatar-' . $params['width'], &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sanitize each class.</span>&nbsp;</div></li><li><div>  $avatar_classes = array_map( 'sanitize_html_class', $avatar_classes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Populate the class attribute.</span>&nbsp;</div></li><li><div>  $html_class = ' class=&quot;' . join( ' ', $avatar_classes ) . ' photo&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set img URL and DIR based on prepopulated constants.</span>&nbsp;</div></li><li><div>  $avatar_loc = new stdClass();&nbsp;</div></li><li><div>  $avatar_loc-&gt;path = trailingslashit( bp_core_avatar_upload_path() );&nbsp;</div></li><li><div>  $avatar_loc-&gt;url = trailingslashit( bp_core_avatar_url() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar_loc-&gt;dir = trailingslashit( $params['avatar_dir'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the avatar folder directory URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Path to the avatar folder URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $value ID of the avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Subdirectory where the requested avatar should be found.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $avatar_folder_url = apply_filters( 'bp_core_avatar_folder_url', ( $avatar_loc-&gt;url  . $avatar_loc-&gt;dir . $params['item_id'] ), $params['item_id'], $params['object'], $params['avatar_dir'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the avatar folder directory path.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Path to the avatar folder directory.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $value ID of the avatar item being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Subdirectory where the requested avatar should be found.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $avatar_folder_dir = apply_filters( 'bp_core_avatar_folder_dir', ( $avatar_loc-&gt;path . $avatar_loc-&gt;dir . $params['item_id'] ), $params['item_id'], $params['object'], $params['avatar_dir'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Look for uploaded avatar first. Use it if it exists.</span>&nbsp;</div></li><li><div><span class="comment">   * Set the file names to search for, to select the full size</span>&nbsp;</div></li><li><div><span class="comment">   * or thumbnail image.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $avatar_size = ( 'full' == $params['type'] ) ? '-bpfull' : '-bpthumb';&nbsp;</div></li><li><div>  $legacy_user_avatar_name = ( 'full' == $params['type'] ) ? '-avatar2' : '-avatar1';&nbsp;</div></li><li><div>  $legacy_group_avatar_name = ( 'full' == $params['type'] ) ? '-groupavatar-full' : '-groupavatar-thumb';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for directory.</span>&nbsp;</div></li><li><div>  if ( file_exists( $avatar_folder_dir ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Open directory.</span>&nbsp;</div></li><li><div>      if ( $av_dir = opendir( $avatar_folder_dir ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Stash files in an array once to check for one that matches.</span>&nbsp;</div></li><li><div>          $avatar_files = array();&nbsp;</div></li><li><div>          while ( false !== ( $avatar_file = readdir( $av_dir ) ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Only add files to the array (skip directories).</span>&nbsp;</div></li><li><div>              if ( 2 &lt; strlen( $avatar_file ) ) {&nbsp;</div></li><li><div>                  $avatar_files[] = $avatar_file;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Check for array.</span>&nbsp;</div></li><li><div>          if ( 0 &lt; count( $avatar_files ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Check for current avatar.</span>&nbsp;</div></li><li><div>              foreach( $avatar_files as $key =&gt; $value ) {&nbsp;</div></li><li><div>                  if ( strpos ( $value, $avatar_size )!== false ) {&nbsp;</div></li><li><div>                      $avatar_url = $avatar_folder_url . '/' . $avatar_files[$key];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Legacy avatar check.</span>&nbsp;</div></li><li><div>              if ( !isset( $avatar_url ) ) {&nbsp;</div></li><li><div>                  foreach( $avatar_files as $key =&gt; $value ) {&nbsp;</div></li><li><div>                      if ( strpos ( $value, $legacy_user_avatar_name )!== false ) {&nbsp;</div></li><li><div>                          $avatar_url = $avatar_folder_url . '/' . $avatar_files[$key];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Legacy group avatar check.</span>&nbsp;</div></li><li><div>                  if ( !isset( $avatar_url ) ) {&nbsp;</div></li><li><div>                      foreach( $avatar_files as $key =&gt; $value ) {&nbsp;</div></li><li><div>                          if ( strpos ( $value, $legacy_group_avatar_name )!== false ) {&nbsp;</div></li><li><div>                              $avatar_url = $avatar_folder_url . '/' . $avatar_files[$key];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Close the avatar directory.</span>&nbsp;</div></li><li><div>      closedir( $av_dir );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we found a locally uploaded avatar.</span>&nbsp;</div></li><li><div>      if ( isset( $avatar_url ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Support custom scheme.</span>&nbsp;</div></li><li><div>          $avatar_url = set_url_scheme( $avatar_url, $params['scheme'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Return it wrapped in an &lt;img&gt; element.</span>&nbsp;</div></li><li><div>          if ( true === $params['html'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filters an avatar URL wrapped in an &lt;img&gt; element.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $value             Full &lt;img&gt; element for an avatar.</span>&nbsp;</div></li><li><div><span class="comment">               * @param array  $params            Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $value             ID of the item requested.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $value             Subdirectory where the requested avatar should be found.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $html_css_id       ID attribute for avatar.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $html_width        Width attribute for avatar.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $html_height       Height attribute for avatar.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $avatar_folder_url Avatar URL path.</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $avatar_folder_dir Avatar DIR path.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              return apply_filters( 'bp_core_fetch_avatar', '&lt;img src=&quot;' . $avatar_url . '&quot;' . $html_class . $html_css_id  . $html_width . $html_height . $html_alt . $html_title . $extra_attr . ' /&gt;', $params, $params['item_id'], $params['avatar_dir'], $html_css_id, $html_width, $html_height, $avatar_folder_url, $avatar_folder_dir );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// ...or only the URL</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filters a locally uploaded avatar URL.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 1.2.5</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $avatar_url URL for a locally uploaded avatar.</span>&nbsp;</div></li><li><div><span class="comment">               * @param array  $params     Array of parameters for the request.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              return apply_filters( 'bp_core_fetch_avatar_url', $avatar_url, $params );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// By default, Gravatar is not pinged for groups.</span>&nbsp;</div></li><li><div>  if ( null === $params['no_grav'] ) {&nbsp;</div></li><li><div>      $params['no_grav'] = 'group' === $params['object'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to skip Gravatar check.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $value  Whether or not to skip Gravatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params Array of parameters for the avatar request.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_core_fetch_avatar_no_grav', $params['no_grav'], $params ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set gravatar type.</span>&nbsp;</div></li><li><div>      if ( empty( $bp-&gt;grav_default-&gt;{$params['object']} ) ) {&nbsp;</div></li><li><div>          $default_grav = 'wavatar';&nbsp;</div></li><li><div>      } elseif ( 'mystery' == $bp-&gt;grav_default-&gt;{$params['object']} ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the Mystery person avatar src value.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $value Avatar value.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $value Width to display avatar at.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $default_grav = apply_filters( 'bp_core_mysteryman_src', 'mm', $params['width'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $default_grav = $bp-&gt;grav_default-&gt;{$params['object']};&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set gravatar object.</span>&nbsp;</div></li><li><div>      if ( empty( $params['email'] ) ) {&nbsp;</div></li><li><div>          if ( 'user' == $params['object'] ) {&nbsp;</div></li><li><div>              $params['email'] = bp_core_get_user_email( $params['item_id'] );&nbsp;</div></li><li><div>          } elseif ( 'group' == $params['object'] || 'blog' == $params['object'] ) {&nbsp;</div></li><li><div>              $params['email'] = $params['item_id'] . '-' . $params['object'] . '@' . bp_get_root_domain();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the Gravatar email to use.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value Email to use in Gravatar request.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value ID of the item being requested.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value Object type being requested.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $params['email'] = apply_filters( 'bp_core_gravatar_email', $params['email'], $params['item_id'], $params['object'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the Gravatar URL host.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.0.2</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value Gravatar URL host.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $gravatar = apply_filters( 'bp_gravatar_url', '<span class="comment">//www.gravatar.com/avatar/' );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Append email hash to Gravatar.</span>&nbsp;</div></li><li><div>      $gravatar .=  md5( strtolower( $params['email'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Main Gravatar URL args.</span>&nbsp;</div></li><li><div>      $url_args = array(&nbsp;</div></li><li><div>          's' =&gt; $params['width']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Custom Gravatar URL args.</span>&nbsp;</div></li><li><div>      if ( ! empty( $params['force_default'] ) ) {&nbsp;</div></li><li><div>          $url_args['f'] = 'y';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $params['rating'] ) ) {&nbsp;</div></li><li><div>          $url_args['r'] = strtolower( $params['rating'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the Gravatar &quot;d&quot; parameter.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $default_grav The avatar default.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $params       The avatar's data.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $default_grav = apply_filters( 'bp_core_avatar_default', $default_grav, $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only set default image if 'Gravatar Logo' is not requested.</span>&nbsp;</div></li><li><div>      if ( 'gravatar_default' !== $default_grav ) {&nbsp;</div></li><li><div>          $url_args['d'] = $default_grav;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set up the Gravatar URL.</span>&nbsp;</div></li><li><div>      $gravatar = esc_url( add_query_arg(&nbsp;</div></li><li><div>          rawurlencode_deep( array_filter( $url_args ) ), &nbsp;</div></li><li><div>          $gravatar&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No avatar was found, and we've been told not to use a gravatar.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the avatar default when Gravatar is not used.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * This is a variable filter dependent on the avatar type being requested.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value  Default avatar for non-gravatar requests.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $params Array of parameters for the avatar request.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $gravatar = apply_filters( 'bp_core_default_avatar_' . $params['object'], bp_core_avatar_default( 'local', $params ), $params );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( true === $params['html'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in bp-core/bp-core-avatars.php */</span></span></span></span></span>&nbsp;</div></li><li><div>      return apply_filters( 'bp_core_fetch_avatar', '&lt;img src=&quot;' . $gravatar . '&quot;' . $html_css_id . $html_class . $html_width . $html_height . $html_alt . $html_title . $extra_attr . ' /&gt;', $params, $params['item_id'], $params['avatar_dir'], $html_css_id, $html_width, $html_height, $avatar_folder_url, $avatar_folder_dir );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in bp-core/bp-core-avatars.php */</span></span></span></span></span>&nbsp;</div></li><li><div>      return apply_filters( 'bp_core_fetch_avatar_url', $gravatar, $params );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete an existing avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Array of function parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|int    $item_id    ID of the item whose avatar you're deleting.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Defaults to the current item of type $object.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $object     Object type of the item whose avatar you're</span>&nbsp;</div></li><li><div><span class="comment"> *                                   deleting. 'user', 'group', 'blog', or custom.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: 'user'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|string $avatar_dir Subdirectory where avatar is located.</span>&nbsp;</div></li><li><div><span class="comment"> *                                   Default: false, which falls back on the default location</span>&nbsp;</div></li><li><div><span class="comment"> *                                   corresponding to the $object.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_delete_existing_avatar( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'item_id' =&gt; false, &nbsp;</div></li><li><div>      'object' =&gt; 'user', <span class="comment">// User OR group OR blog OR custom type (if you use filters).</span>&nbsp;</div></li><li><div>      'avatar_dir' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle deleting an existing avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $value Whether or not to delete the avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args {</span>&nbsp;</div></li><li><div><span class="comment">   *     Array of function parameters.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool|int    $item_id    ID of the item whose avatar you're deleting.</span>&nbsp;</div></li><li><div><span class="comment">   *                                   Defaults to the current item of type $object.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string      $object     Object type of the item whose avatar you're</span>&nbsp;</div></li><li><div><span class="comment">   *                                   deleting. 'user', 'group', 'blog', or custom.</span>&nbsp;</div></li><li><div><span class="comment">   *                                   Default: 'user'.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool|string $avatar_dir Subdirectory where avatar is located.</span>&nbsp;</div></li><li><div><span class="comment">   *                                   Default: false, which falls back on the default location</span>&nbsp;</div></li><li><div><span class="comment">   *                                   corresponding to the $object.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_core_pre_delete_existing_avatar', true, $args ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $item_id ) ) {&nbsp;</div></li><li><div>      if ( 'user' == $object )&nbsp;</div></li><li><div>          $item_id = bp_displayed_user_id();&nbsp;</div></li><li><div>      elseif ( 'group' == $object )&nbsp;</div></li><li><div>          $item_id = buddypress()-&gt;groups-&gt;current_group-&gt;id;&nbsp;</div></li><li><div>      elseif ( 'blog' == $object )&nbsp;</div></li><li><div>          $item_id = $current_blog-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in bp-core/bp-core-avatars.php */</span></span></span></span></span>&nbsp;</div></li><li><div>      $item_id = apply_filters( 'bp_core_avatar_item_id', $item_id, $object );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$item_id ) return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $avatar_dir ) ) {&nbsp;</div></li><li><div>      if ( 'user' == $object )&nbsp;</div></li><li><div>          $avatar_dir = 'avatars';&nbsp;</div></li><li><div>      elseif ( 'group' == $object )&nbsp;</div></li><li><div>          $avatar_dir = 'group-avatars';&nbsp;</div></li><li><div>      elseif ( 'blog' == $object )&nbsp;</div></li><li><div>          $avatar_dir = 'blog-avatars';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in bp-core/bp-core-avatars.php */</span></span></span></span></span>&nbsp;</div></li><li><div>      $avatar_dir = apply_filters( 'bp_core_avatar_dir', $avatar_dir, $object );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$avatar_dir ) return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in bp-core/bp-core-avatars.php */</span></span></span></span></span>&nbsp;</div></li><li><div>  $avatar_folder_dir = apply_filters( 'bp_core_avatar_folder_dir', bp_core_avatar_upload_path() . '/' . $avatar_dir . '/' . $item_id, $item_id, $object, $avatar_dir );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !file_exists( $avatar_folder_dir ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $av_dir = opendir( $avatar_folder_dir ) ) {&nbsp;</div></li><li><div>      while ( false !== ( $avatar_file = readdir($av_dir) ) ) {&nbsp;</div></li><li><div>          if ( ( preg_match( &quot;/-bpfull/&quot;, $avatar_file ) || preg_match( &quot;/-bpthumb/&quot;, $avatar_file ) ) && '.' != $avatar_file && '..' != $avatar_file )&nbsp;</div></li><li><div>              @unlink( $avatar_folder_dir . '/' . $avatar_file );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  closedir($av_dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  @rmdir( $avatar_folder_dir );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after deleting an existing avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args Array of arguments used for avatar deletion.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'bp_core_delete_existing_avatar', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax delete an avatar for a given object and item id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null A JSON object containing success data if the avatar was deleted, </span>&nbsp;</div></li><li><div><span class="comment"> *                     error message otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_ajax_delete() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if not a POST action.</span></span></span>&nbsp;</div></li><li><div>  if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar_data = $_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $avatar_data['object'] ) || empty( $avatar_data['item_id'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $nonce = 'bp_delete_avatar_link';&nbsp;</div></li><li><div>  if ( 'group' === $avatar_data['object'] ) {&nbsp;</div></li><li><div>      $nonce = 'bp_group_avatar_delete';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Check the nonce.</span></span></span>&nbsp;</div></li><li><div>  check_admin_referer( $nonce, 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Capability check.</span></span></span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_current_user_can( 'edit_avatar', $avatar_data ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle delete.</span>&nbsp;</div></li><li><div>  if ( bp_core_delete_existing_avatar( array( 'item_id' =&gt; $avatar_data['item_id'], 'object' =&gt; $avatar_data['object'] ) ) ) {&nbsp;</div></li><li><div>      $return = array(&nbsp;</div></li><li><div>          'avatar' =&gt; html_entity_decode( bp_core_fetch_avatar( array(&nbsp;</div></li><li><div>              'object' =&gt; $avatar_data['object'], &nbsp;</div></li><li><div>              'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div>              'html' =&gt; false, &nbsp;</div></li><li><div>              'type' =&gt; 'full', &nbsp;</div></li><li><div> ) ) ), &nbsp;</div></li><li><div>          'feedback_code' =&gt; 4, &nbsp;</div></li><li><div>          'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success( $return );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'feedback_code' =&gt; 3, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_bp_avatar_delete', 'bp_avatar_ajax_delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle avatar uploading.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The functions starts off by checking that the file has been uploaded</span>&nbsp;</div></li><li><div><span class="comment"> * properly using bp_core_check_avatar_upload(). It then checks that the file</span>&nbsp;</div></li><li><div><span class="comment"> * size is within limits, and that it has an accepted file extension (jpg, gif, </span>&nbsp;</div></li><li><div><span class="comment"> * png). If everything checks out, crop the image and move it to its real</span>&nbsp;</div></li><li><div><span class="comment"> * location.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_core_check_avatar_upload()</span>&nbsp;</div></li><li><div><span class="comment"> * @see bp_core_check_avatar_type()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $file              The appropriate entry the from $_FILES superglobal.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $upload_dir_filter A filter to be applied to 'upload_dir'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_handle_upload( $file, $upload_dir_filter ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle uploading.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.4</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $value             Whether or not to crop.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $file              Appropriate entry from $_FILES superglobal.</span>&nbsp;</div></li><li><div><span class="comment">   * @parma string $upload_dir_filter A filter to be applied to 'upload_dir'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_core_pre_avatar_handle_upload', true, $file, $upload_dir_filter ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup some variables.</span>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>  $upload_path = bp_core_avatar_upload_path();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upload the file.</span>&nbsp;</div></li><li><div>  $avatar_attachment = new BP_Attachment_Avatar();&nbsp;</div></li><li><div>  $bp-&gt;avatar_admin-&gt;original = $avatar_attachment-&gt;upload( $file, $upload_dir_filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// In case of an error, stop the process and display a feedback to the user.</span>&nbsp;</div></li><li><div>  if ( ! empty( $bp-&gt;avatar_admin-&gt;original['error'] ) ) {&nbsp;</div></li><li><div>      bp_core_add_message( sprintf( __( 'Upload Failed! Error was: %s', 'buddypress' ), $bp-&gt;avatar_admin-&gt;original['error'] ), 'error' );&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The Avatar UI available width.</span>&nbsp;</div></li><li><div>  $ui_available_width = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try to set the ui_available_width using the avatar_admin global.</span>&nbsp;</div></li><li><div>  if ( isset( $bp-&gt;avatar_admin-&gt;ui_available_width ) ) {&nbsp;</div></li><li><div>      $ui_available_width = $bp-&gt;avatar_admin-&gt;ui_available_width;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Maybe resize.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar_admin-&gt;resized = $avatar_attachment-&gt;shrink( $bp-&gt;avatar_admin-&gt;original['file'], $ui_available_width );&nbsp;</div></li><li><div>  $bp-&gt;avatar_admin-&gt;image = new stdClass();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We only want to handle one image after resize.</span>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;avatar_admin-&gt;resized ) ) {&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin-&gt;image-&gt;file = $bp-&gt;avatar_admin-&gt;original['file'];&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin-&gt;image-&gt;dir = str_replace( $upload_path, '', $bp-&gt;avatar_admin-&gt;original['file'] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin-&gt;image-&gt;file = $bp-&gt;avatar_admin-&gt;resized['path'];&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin-&gt;image-&gt;dir = str_replace( $upload_path, '', $bp-&gt;avatar_admin-&gt;resized['path'] );&nbsp;</div></li><li><div>      @unlink( $bp-&gt;avatar_admin-&gt;original['file'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for WP_Error on what should be an image.</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $bp-&gt;avatar_admin-&gt;image-&gt;dir ) ) {&nbsp;</div></li><li><div>      bp_core_add_message( sprintf( __( 'Upload failed! Error was: %s', 'buddypress' ), $bp-&gt;avatar_admin-&gt;image-&gt;dir-&gt;get_error_message() ), 'error' );&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the uploaded image is smaller than the &quot;full&quot; dimensions, throw a warning.</span>&nbsp;</div></li><li><div>  if ( $avatar_attachment-&gt;is_too_small( $bp-&gt;avatar_admin-&gt;image-&gt;file ) ) {&nbsp;</div></li><li><div>      bp_core_add_message( sprintf( __( 'You have selected an image that is smaller than recommended. For best results, upload a picture larger than %d x %d pixels.', 'buddypress' ), bp_core_avatar_full_width(), bp_core_avatar_full_height() ), 'error' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the url value for the image.</span>&nbsp;</div></li><li><div>  $bp-&gt;avatar_admin-&gt;image-&gt;url = bp_core_avatar_url() . $bp-&gt;avatar_admin-&gt;image-&gt;dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax upload an avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null A JSON object containing success data if the upload succeeded</span>&nbsp;</div></li><li><div><span class="comment"> *                     error message otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_ajax_upload() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if not a POST action.</span></span></span>&nbsp;</div></li><li><div>  if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sending the json response will be different if</span>&nbsp;</div></li><li><div><span class="comment">   * the current Plupload runtime is html4.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $is_html4 = false;&nbsp;</div></li><li><div>  if ( ! empty( $_POST['html4' ] ) ) {&nbsp;</div></li><li><div>      $is_html4 = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Check the nonce.</span></span></span>&nbsp;</div></li><li><div>  check_admin_referer( 'bp-uploader' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init the BuddyPress parameters.</span>&nbsp;</div></li><li><div>  $bp_params = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need it to carry on.</span>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['bp_params' ] ) ) {&nbsp;</div></li><li><div>      $bp_params = $_POST['bp_params' ];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need the object to set the uploads dir filter.</span>&nbsp;</div></li><li><div>  if ( empty( $bp_params['object'] ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Capability check.</span></span></span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_current_user_can( 'edit_avatar', $bp_params ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>  $bp_params['upload_dir_filter'] = '';&nbsp;</div></li><li><div>  $needs_reset = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'user' === $bp_params['object'] && bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>      $bp_params['upload_dir_filter'] = 'xprofile_avatar_upload_dir';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_displayed_user_id() && ! empty( $bp_params['item_id'] ) ) {&nbsp;</div></li><li><div>          $needs_reset = array( 'key' =&gt; 'displayed_user', 'value' =&gt; $bp-&gt;displayed_user );&nbsp;</div></li><li><div>          $bp-&gt;displayed_user-&gt;id = $bp_params['item_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'group' === $bp_params['object'] && bp_is_active( 'groups' ) ) {&nbsp;</div></li><li><div>      $bp_params['upload_dir_filter'] = 'groups_avatar_upload_dir';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_get_current_group_id() && ! empty( $bp_params['item_id'] ) ) {&nbsp;</div></li><li><div>          $needs_reset = array( 'component' =&gt; 'groups', 'key' =&gt; 'current_group', 'value' =&gt; $bp-&gt;groups-&gt;current_group );&nbsp;</div></li><li><div>          $bp-&gt;groups-&gt;current_group = groups_get_group( $bp_params['item_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter here to deal with other components.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @var array $bp_params the BuddyPress Ajax parameters.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $bp_params = apply_filters( 'bp_core_avatar_ajax_upload_params', $bp_params );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $bp-&gt;avatar_admin ) ) {&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin = new stdClass();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The BuddyPress upload parameters is including the Avatar UI Available width, </span>&nbsp;</div></li><li><div><span class="comment">   * add it to the avatar_admin global for a later use.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( isset( $bp_params['ui_available_width'] ) ) {&nbsp;</div></li><li><div>      $bp-&gt;avatar_admin-&gt;ui_available_width =  (int) $bp_params['ui_available_width'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upload the avatar.</span>&nbsp;</div></li><li><div>  $avatar = bp_core_avatar_handle_upload( $_FILES, $bp_params['upload_dir_filter'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reset objects.</span>&nbsp;</div></li><li><div>  if ( ! empty( $needs_reset ) ) {&nbsp;</div></li><li><div>      if ( ! empty( $needs_reset['component'] ) ) {&nbsp;</div></li><li><div>          $bp-&gt;{$needs_reset['component']}-&gt;{$needs_reset['key']} = $needs_reset['value'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $bp-&gt;{$needs_reset['key']} = $needs_reset['value'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Init the feedback message.</span>&nbsp;</div></li><li><div>  $feedback_message = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $bp-&gt;template_message ) ) {&nbsp;</div></li><li><div>      $feedback_message = $bp-&gt;template_message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove template message.</span>&nbsp;</div></li><li><div>      $bp-&gt;template_message = false;&nbsp;</div></li><li><div>      $bp-&gt;template_message_type = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      @setcookie( 'bp-message', false, time() - 1000, COOKIEPATH, COOKIE_DOMAIN, is_ssl() );&nbsp;</div></li><li><div>      @setcookie( 'bp-message-type', false, time() - 1000, COOKIEPATH, COOKIE_DOMAIN, is_ssl() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $avatar ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Default upload error.</span>&nbsp;</div></li><li><div>      $message = __( 'Upload failed.', 'buddypress' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Use the template message if set.</span>&nbsp;</div></li><li><div>      if ( ! empty( $feedback_message ) ) {&nbsp;</div></li><li><div>          $message = $feedback_message;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Upload error reply.</span>&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4, array(&nbsp;</div></li><li><div>          'type' =&gt; 'upload_error', &nbsp;</div></li><li><div>          'message' =&gt; $message, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;avatar_admin-&gt;image-&gt;file ) ) {&nbsp;</div></li><li><div>      bp_attachments_json_response( false, $is_html4 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $uploaded_image = @getimagesize( $bp-&gt;avatar_admin-&gt;image-&gt;file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set the name of the file.</span>&nbsp;</div></li><li><div>  $name = $_FILES['file']['name'];&nbsp;</div></li><li><div>  $name_parts = pathinfo( $name );&nbsp;</div></li><li><div>  $name = trim( substr( $name, 0, - ( 1 + strlen( $name_parts['extension'] ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally return the avatar to the editor.</span>&nbsp;</div></li><li><div>  bp_attachments_json_response( true, $is_html4, array(&nbsp;</div></li><li><div>      'name' =&gt; $name, &nbsp;</div></li><li><div>      'url' =&gt; $bp-&gt;avatar_admin-&gt;image-&gt;url, &nbsp;</div></li><li><div>      'width' =&gt; $uploaded_image[0], &nbsp;</div></li><li><div>      'height' =&gt; $uploaded_image[1], &nbsp;</div></li><li><div>      'feedback' =&gt; $feedback_message, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_bp_avatar_upload', 'bp_avatar_ajax_upload' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle avatar webcam capture.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $data    Base64 encoded image.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $item_id Item to associate.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_handle_capture( $data = '', $item_id = 0 ) {&nbsp;</div></li><li><div>  if ( empty( $data ) || empty( $item_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle avatar webcam capture.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $value   Whether or not to crop.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $data    Base64 encoded image.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $item_id Item to associate.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_avatar_pre_handle_capture', true, $data, $item_id ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar_dir = bp_core_avatar_upload_path() . '/avatars';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// It's not a regular upload, we may need to create this folder.</span></span>&nbsp;</div></li><li><div>  if ( ! file_exists( $avatar_dir ) ) {&nbsp;</div></li><li><div>      if ( ! wp_mkdir_p( $avatar_dir ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the Avatar folder directory.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $avatar_dir Directory for storing avatars.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $item_id    ID of the item being acted on.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value      Avatar type.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value      Avatars word.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $avatar_folder_dir = apply_filters( 'bp_core_avatar_folder_dir', $avatar_dir . '/' . $item_id, $item_id, 'user', 'avatars' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// It's not a regular upload, we may need to create this folder.</span></span>&nbsp;</div></li><li><div>  if( ! is_dir( $avatar_folder_dir ) ) {&nbsp;</div></li><li><div>      if ( ! wp_mkdir_p( $avatar_folder_dir ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $original_file = $avatar_folder_dir . '/webcam-capture-' . $item_id . '.png';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( file_put_contents( $original_file, $data ) ) {&nbsp;</div></li><li><div>      $avatar_to_crop = str_replace( bp_core_avatar_upload_path(), '', $original_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Crop to default values.</span>&nbsp;</div></li><li><div>      $crop_args = array( 'item_id' =&gt; $item_id, 'original_file' =&gt; $avatar_to_crop, 'crop_x' =&gt; 0, 'crop_y' =&gt; 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return bp_core_avatar_handle_crop( $crop_args );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Crop an uploaded avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Array of function parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $object        Object type of the item whose avatar you're</span>&nbsp;</div></li><li><div><span class="comment"> *                                      handling. 'user', 'group', 'blog', or custom.</span>&nbsp;</div></li><li><div><span class="comment"> *                                      Default: 'user'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $avatar_dir    Subdirectory where avatar should be stored.</span>&nbsp;</div></li><li><div><span class="comment"> *                                      Default: 'avatars'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|int    $item_id       ID of the item that the avatar belongs to.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|string $original_file Absolute path to the original avatar file.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int         $crop_w        Crop width. Default: the global 'full' avatar width, </span>&nbsp;</div></li><li><div><span class="comment"> *                                      as retrieved by bp_core_avatar_full_width().</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int         $crop_h        Crop height. Default: the global 'full' avatar height, </span>&nbsp;</div></li><li><div><span class="comment"> *                                      as retrieved by bp_core_avatar_full_height().</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int         $crop_x        The horizontal starting point of the crop. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int         $crop_y        The vertical starting point of the crop. Default: 0.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_handle_crop( $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'object' =&gt; 'user', &nbsp;</div></li><li><div>      'avatar_dir' =&gt; 'avatars', &nbsp;</div></li><li><div>      'item_id' =&gt; false, &nbsp;</div></li><li><div>      'original_file' =&gt; false, &nbsp;</div></li><li><div>      'crop_w' =&gt; bp_core_avatar_full_width(), &nbsp;</div></li><li><div>      'crop_h' =&gt; bp_core_avatar_full_height(), &nbsp;</div></li><li><div>      'crop_x' =&gt; 0, &nbsp;</div></li><li><div>      'crop_y' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not to handle cropping.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If you want to override this function, make sure you return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.4</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $value Whether or not to crop.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $r     Array of parsed arguments for function.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'bp_core_pre_avatar_handle_crop', true, $r ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Crop the file.</span>&nbsp;</div></li><li><div>  $avatar_attachment = new BP_Attachment_Avatar();&nbsp;</div></li><li><div>  $cropped = $avatar_attachment-&gt;crop( $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for errors.</span>&nbsp;</div></li><li><div>  if ( empty( $cropped['full'] ) || empty( $cropped['thumb'] ) || is_wp_error( $cropped['full'] ) || is_wp_error( $cropped['thumb'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax set an avatar for a given object and item id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null A JSON object containing success data if the crop/capture succeeded</span>&nbsp;</div></li><li><div><span class="comment"> *                     error message otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_ajax_set() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Bail if not a POST action.</span></span></span>&nbsp;</div></li><li><div>  if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Check the nonce.</span></span></span>&nbsp;</div></li><li><div>  check_admin_referer( 'bp_avatar_cropstore', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar_data = wp_parse_args( $_POST, array(&nbsp;</div></li><li><div>      'crop_w' =&gt; bp_core_avatar_full_width(), &nbsp;</div></li><li><div>      'crop_h' =&gt; bp_core_avatar_full_height(), &nbsp;</div></li><li><div>      'crop_x' =&gt; 0, &nbsp;</div></li><li><div>      'crop_y' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $avatar_data['object'] ) || empty( $avatar_data['item_id'] ) || empty( $avatar_data['original_file'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Capability check.</span></span></span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_current_user_can( 'edit_avatar', $avatar_data ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $avatar_data['type'] ) && 'camera' === $avatar_data['type'] && 'user' === $avatar_data['object'] ) {&nbsp;</div></li><li><div>      $webcam_avatar = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $avatar_data['original_file'] ) ) {&nbsp;</div></li><li><div>          $webcam_avatar = str_replace( array( 'data:image/png;base64, ', ' ' ), array( '', '+' ), $avatar_data['original_file'] );&nbsp;</div></li><li><div>          $webcam_avatar = base64_decode( $webcam_avatar );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! bp_avatar_handle_capture( $webcam_avatar, $avatar_data['item_id'] ) ) {&nbsp;</div></li><li><div>          wp_send_json_error( array(&nbsp;</div></li><li><div>              'feedback_code' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $return = array(&nbsp;</div></li><li><div>              'avatar' =&gt; html_entity_decode( bp_core_fetch_avatar( array(&nbsp;</div></li><li><div>                  'object' =&gt; $avatar_data['object'], &nbsp;</div></li><li><div>                  'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div>                  'html' =&gt; false, &nbsp;</div></li><li><div>                  'type' =&gt; 'full', &nbsp;</div></li><li><div> ) ) ), &nbsp;</div></li><li><div>              'feedback_code' =&gt; 2, &nbsp;</div></li><li><div>              'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires if the new avatar was successfully captured.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.1.0 Used to inform the avatar was successfully cropped</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.3.4 Add two new parameters to inform about the user id and</span>&nbsp;</div></li><li><div><span class="comment">           *              about the way the avatar was set (eg: 'crop' or 'camera')</span>&nbsp;</div></li><li><div><span class="comment">           *              Move the action at the right place, once the avatar is set</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.8.0 Added the `$avatar_data` parameter.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $item_id     Inform about the user id the avatar was set for.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $type        Inform about the way the avatar was set ('camera').</span>&nbsp;</div></li><li><div><span class="comment">           * @param array  $avatar_data Array of parameters passed to the avatar handler.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'xprofile_avatar_uploaded', (int) $avatar_data['item_id'], $avatar_data['type'], $avatar_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_send_json_success( $return );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $original_file = str_replace( bp_core_avatar_url(), '', $avatar_data['original_file'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set avatars dir & feedback part.</span>&nbsp;</div></li><li><div>  if ( 'user' === $avatar_data['object'] ) {&nbsp;</div></li><li><div>      $avatar_dir = 'avatars';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Defaults to object-avatars dir.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $avatar_dir = sanitize_key( $avatar_data['object'] ) . '-avatars';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Crop args.</span>&nbsp;</div></li><li><div>  $r = array(&nbsp;</div></li><li><div>      'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div>      'object' =&gt; $avatar_data['object'], &nbsp;</div></li><li><div>      'avatar_dir' =&gt; $avatar_dir, &nbsp;</div></li><li><div>      'original_file' =&gt; $original_file, &nbsp;</div></li><li><div>      'crop_w' =&gt; $avatar_data['crop_w'], &nbsp;</div></li><li><div>      'crop_h' =&gt; $avatar_data['crop_h'], &nbsp;</div></li><li><div>      'crop_x' =&gt; $avatar_data['crop_x'], &nbsp;</div></li><li><div>      'crop_y' =&gt; $avatar_data['crop_y']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle crop.</span>&nbsp;</div></li><li><div>  if ( bp_core_avatar_handle_crop( $r ) ) {&nbsp;</div></li><li><div>      $return = array(&nbsp;</div></li><li><div>          'avatar' =&gt; html_entity_decode( bp_core_fetch_avatar( array(&nbsp;</div></li><li><div>              'object' =&gt; $avatar_data['object'], &nbsp;</div></li><li><div>              'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div>              'html' =&gt; false, &nbsp;</div></li><li><div>              'type' =&gt; 'full', &nbsp;</div></li><li><div> ) ) ), &nbsp;</div></li><li><div>          'feedback_code' =&gt; 2, &nbsp;</div></li><li><div>          'item_id' =&gt; $avatar_data['item_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'user' === $avatar_data['object'] ) {&nbsp;</div></li><li><div>          <span class="comment">/** This action is documented in bp-core/bp-core-avatars.php */</span>&nbsp;</div></li><li><div>          do_action( 'xprofile_avatar_uploaded', (int) $avatar_data['item_id'], $avatar_data['type'], $r );&nbsp;</div></li><li><div>      } elseif ( 'group' === $avatar_data['object'] ) {&nbsp;</div></li><li><div>          <span class="comment">/** This action is documented in bp-groups/bp-groups-screens.php */</span>&nbsp;</div></li><li><div>          do_action( 'groups_avatar_uploaded', (int) $avatar_data['item_id'], $avatar_data['type'], $r );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success( $return );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'feedback_code' =&gt; 1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_bp_avatar_set', 'bp_avatar_ajax_set' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Replace default WordPress avatars with BP avatars, if available.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * See 'get_avatar' filter description in wp-includes/pluggable.php.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.0 Added $args parameter to coincide with WordPress 4.2.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string            $avatar  The avatar path passed to 'get_avatar'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string|object $user    A user ID, email address, or comment object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int               $size    Size of the avatar image ('thumb' or 'full').</span>&nbsp;</div></li><li><div><span class="comment"> * @param string            $default URL to a default image to use if no avatar is available.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string            $alt     Alternate text to use in image tag. Default: ''.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array             $args    Arguments passed to get_avatar_data(), after processing.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string BP avatar path, if found; else the original avatar path.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_fetch_avatar_filter( $avatar, $user, $size, $default, $alt = '', $args = array() ) {&nbsp;</div></li><li><div>  global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't filter if inside WordPress options page and force_default is true.</span>&nbsp;</div></li><li><div>  if ( 'options-discussion.php' === $pagenow && true === $args['force_default'] ) {&nbsp;</div></li><li><div>      return $avatar;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If passed an object, assume $user-&gt;user_id.</span>&nbsp;</div></li><li><div>  if ( is_object( $user ) ) {&nbsp;</div></li><li><div>      if ( isset( $user-&gt;user_id ) ) {&nbsp;</div></li><li><div>          $id = $user-&gt;user_id;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $id = $user-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If passed a number, assume it was a $user_id.</span>&nbsp;</div></li><li><div>  } elseif ( is_numeric( $user ) ) {&nbsp;</div></li><li><div>      $id = $user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If passed a string and that string returns a user, get the $id.</span>&nbsp;</div></li><li><div>  } elseif ( is_string( $user ) && ( $user_by_email = get_user_by( 'email', $user ) ) ) {&nbsp;</div></li><li><div>      $id = $user_by_email-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If somehow $id hasn't been assigned, return the result of get_avatar.</span>&nbsp;</div></li><li><div>  if ( empty( $id ) ) {&nbsp;</div></li><li><div>      return !empty( $avatar ) ? $avatar : $default;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Image alt tag.</span>&nbsp;</div></li><li><div>  if ( empty( $alt ) ) {&nbsp;</div></li><li><div>      $alt = sprintf( __( 'Profile photo of %s', 'buddypress' ), bp_core_get_user_displayname( $id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use the 'thumb' type, unless the requested width is bigger than</span>&nbsp;</div></li><li><div>  <span class="comment">// BP's thumb width.</span>&nbsp;</div></li><li><div>  $type = 'thumb';&nbsp;</div></li><li><div>  if ( (int) $size &gt; bp_core_avatar_thumb_width() ) {&nbsp;</div></li><li><div>      $type = 'full';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avatar_args = array(&nbsp;</div></li><li><div>      'item_id' =&gt; $id, &nbsp;</div></li><li><div>      'type' =&gt; $type, &nbsp;</div></li><li><div>      'width' =&gt; $size, &nbsp;</div></li><li><div>      'height' =&gt; $size, &nbsp;</div></li><li><div>      'alt' =&gt; $alt, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Support new arguments as of WordPress 4.2.0.</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['width'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['width'] = $args['width'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['height'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['height'] = $args['height'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['class'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['class'] = $args['class'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['class'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['class'] = $args['class'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['extra_attr'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['extra_attr'] = $args['extra_attr'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['scheme'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['scheme'] = $args['scheme'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['force_default'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['force_default'] = $args['force_default'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( ! empty( $args['rating'] ) ) {&nbsp;</div></li><li><div>      $avatar_args['rating'] = $args['rating'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Let BuddyPress handle the fetching of the avatar.</span>&nbsp;</div></li><li><div>  $bp_avatar = bp_core_fetch_avatar( $avatar_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If BuddyPress found an avatar, use it. If not, use the result of get_avatar.</span>&nbsp;</div></li><li><div>  return ( !$bp_avatar ) ? $avatar : $bp_avatar;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'get_avatar', 'bp_core_fetch_avatar_filter', 10, 6 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Is the current avatar upload error-free?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $file The $_FILES array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if no errors are found. False if there are errors.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_check_avatar_upload( $file ) {&nbsp;</div></li><li><div>  if ( isset( $file['error'] ) && $file['error'] )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Is the file size of the current avatar upload permitted?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $file The $_FILES array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the avatar is under the size limit, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_check_avatar_size( $file ) {&nbsp;</div></li><li><div>  if ( $file['file']['size'] &gt; bp_core_avatar_original_max_filesize() )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get allowed avatar types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_allowed_avatar_types() {&nbsp;</div></li><li><div>  $allowed_types = bp_attachments_get_allowed_types( 'avatar' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the list of allowed image types.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $allowed_types List of image types.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $avatar_types = (array) apply_filters( 'bp_core_get_allowed_avatar_types', $allowed_types );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $avatar_types ) ) {&nbsp;</div></li><li><div>      $avatar_types = $allowed_types;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $avatar_types = array_intersect( $allowed_types, $avatar_types );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array_values( $avatar_types );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get allowed avatar mime types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_allowed_avatar_mimes() {&nbsp;</div></li><li><div>  $allowed_types = bp_core_get_allowed_avatar_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return bp_attachments_get_allowed_mimes( 'avatar', $allowed_types );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Does the current avatar upload have an allowed file type?</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Permitted file types are JPG, GIF and PNG.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $file The $_FILES array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the file extension is permitted, otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_check_avatar_type( $file ) {&nbsp;</div></li><li><div>  return bp_attachments_check_filetype( $file['file']['tmp_name'], $file['file']['name'], bp_core_get_allowed_avatar_mimes() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fetch data from the BP root blog's upload directory.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type The variable we want to return from the $bp-&gt;avatars object.</span>&nbsp;</div></li><li><div><span class="comment"> *                     Only 'upload_path' and 'url' are supported. Default: 'upload_path'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The avatar upload directory path.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_get_upload_dir( $type = 'upload_path' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $type ) {&nbsp;</div></li><li><div>      case 'upload_path' :&nbsp;</div></li><li><div>          $constant = 'BP_AVATAR_UPLOAD_PATH';&nbsp;</div></li><li><div>          $key = 'basedir';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'url' :&nbsp;</div></li><li><div>          $constant = 'BP_AVATAR_URL';&nbsp;</div></li><li><div>          $key = 'baseurl';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// See if the value has already been calculated and stashed in the $bp global.</span>&nbsp;</div></li><li><div>  if ( isset( $bp-&gt;avatar-&gt;$type ) ) {&nbsp;</div></li><li><div>      $retval = $bp-&gt;avatar-&gt;$type;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// If this value has been set in a constant, just use that.</span>&nbsp;</div></li><li><div>      if ( defined( $constant ) ) {&nbsp;</div></li><li><div>          $retval = constant( $constant );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Use cached upload dir data if available.</span>&nbsp;</div></li><li><div>          if ( ! empty( $bp-&gt;avatar-&gt;upload_dir ) ) {&nbsp;</div></li><li><div>              $upload_dir = $bp-&gt;avatar-&gt;upload_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// No cache, so query for it.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get upload directory information from current site.</span>&nbsp;</div></li><li><div>              $upload_dir = bp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Stash upload directory data for later use.</span>&nbsp;</div></li><li><div>              $bp-&gt;avatar-&gt;upload_dir = $upload_dir;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Directory does not exist and cannot be created.</span>&nbsp;</div></li><li><div>          if ( ! empty( $upload_dir['error'] ) ) {&nbsp;</div></li><li><div>              $retval = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $retval = $upload_dir[$key];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If $key is 'baseurl', check to see if we're on SSL</span>&nbsp;</div></li><li><div>              <span class="comment">// Workaround for WP13941, WP15928, WP19037.</span>&nbsp;</div></li><li><div>              if ( $key == 'baseurl' && is_ssl() ) {&nbsp;</div></li><li><div>                  $retval = str_replace( 'http:<span class="comment">//', 'https://', $retval );</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Stash in $bp for later use.</span>&nbsp;</div></li><li><div>      $bp-&gt;avatar-&gt;$type = $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the absolute upload path for the WP installation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Absolute path to WP upload directory.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_upload_path() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the absolute upload path for the WP installation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Absolute upload path for the WP installation.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_upload_path', bp_core_get_upload_dir() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the raw base URL for root site upload location.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Full URL to current upload location.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the raw base URL for root site upload location.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Raw base URL for the root site upload location.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_url', bp_core_get_upload_dir( 'url' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if a given user ID has an uploaded avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id ID of the user whose avatar is being checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the user has uploaded a local avatar. Otherwise false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_get_user_has_avatar( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) )&nbsp;</div></li><li><div>      $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>  if ( bp_core_fetch_avatar( array( 'item_id' =&gt; $user_id, 'no_grav' =&gt; true, 'html' =&gt; false, 'type' =&gt; 'full' ) ) != bp_core_avatar_default( 'local' ) )&nbsp;</div></li><li><div>      $retval = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether or not a user has an uploaded avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $retval  Whether or not a user has an uploaded avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $user_id ID of the user being checked.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'bp_get_user_has_avatar', $retval, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Utility function for fetching an avatar dimension setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type   Dimension type you're fetching dimensions for. 'thumb'</span>&nbsp;</div></li><li><div><span class="comment"> *                       or 'full'. Default: 'thumb'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $h_or_w Which dimension is being fetched. 'height' or 'width'.</span>&nbsp;</div></li><li><div><span class="comment"> *                       Default: 'height'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool $dim The dimension.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_dimension( $type = 'thumb', $h_or_w = 'height' ) {&nbsp;</div></li><li><div>  $bp = buddypress();&nbsp;</div></li><li><div>  $dim = isset( $bp-&gt;avatar-&gt;{$type}-&gt;{$h_or_w} ) ? (int) $bp-&gt;avatar-&gt;{$type}-&gt;{$h_or_w} : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the avatar dimension setting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|bool $dim    Dimension setting for the type.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $type   The type of avatar whose dimensions are requested. Default 'thumb'.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $h_or_w The dimension parameter being requested. Default 'height'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_dimension', $dim, $type, $h_or_w );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the 'thumb' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The 'thumb' width.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_thumb_width() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the 'thumb' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the 'thumb' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_thumb_width', bp_core_avatar_dimension( 'thumb', 'width' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the 'thumb' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The 'thumb' height.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_thumb_height() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the 'thumb' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the 'thumb' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_thumb_height', bp_core_avatar_dimension( 'thumb', 'height' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the 'full' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The 'full' width.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_full_width() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the 'full' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the 'full' avatar width setting.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_full_width', bp_core_avatar_dimension( 'full', 'width' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the 'full' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The 'full' height.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_full_height() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the 'full' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the 'full' avatar height setting.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_full_height', bp_core_avatar_dimension( 'full', 'height' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the max width for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The max width for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_original_max_width() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the max width for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the max width.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_original_max_width', (int) buddypress()-&gt;avatar-&gt;original_max_width );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the max filesize for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The max filesize for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_original_max_filesize() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the max filesize for original avatar uploads.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $value Value for the max filesize.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_original_max_filesize', (int) buddypress()-&gt;avatar-&gt;original_max_filesize );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the URL of the 'full' default avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 Introduced `$params` and `$object_type` parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type   'local' if the fallback should be the locally-hosted version</span>&nbsp;</div></li><li><div><span class="comment"> *                       of the mystery person, 'gravatar' if the fallback should be</span>&nbsp;</div></li><li><div><span class="comment"> *                       Gravatar's version. Default: 'gravatar'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $params Parameters passed to bp_core_fetch_avatar().</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The URL of the default avatar.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_default( $type = 'gravatar', $params = array() ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Local override.</span></span>&nbsp;</div></li><li><div>  if ( defined( 'BP_AVATAR_DEFAULT' ) ) {&nbsp;</div></li><li><div>      $avatar = BP_AVATAR_DEFAULT;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use the local default image.</span></span>&nbsp;</div></li><li><div>  } elseif ( 'local' === $type ) {&nbsp;</div></li><li><div>      $size = '';&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          ( isset( $params['type'] ) && 'thumb' === $params['type'] && bp_core_avatar_thumb_width() &lt;= 50 ) ||&nbsp;</div></li><li><div>          ( isset( $params['width'] ) && $params['width'] &lt;= 50 )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $size = '-50';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $avatar = buddypress()-&gt;plugin_url . &quot;bp-core/images/mystery-man{$size}.jpg&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use Gravatar's mystery person as fallback.</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $size = '';&nbsp;</div></li><li><div>      if ( isset( $params['type'] ) && 'thumb' === $params['type'] ) {&nbsp;</div></li><li><div>          $size = bp_core_avatar_thumb_width();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $size = bp_core_avatar_full_width();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $avatar = '<span class="comment">//www.gravatar.com/avatar/00000000000000000000000000000000?d=mm&amp;s=' . $size;</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the URL of the 'full' default avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0 Added `$params`.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $avatar URL of the default avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $params Params provided to bp_core_fetch_avatar().</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_default', $avatar, $params );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the URL of the 'thumb' default avatar.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Uses Gravatar's mystery-person avatar, unless BP_AVATAR_DEFAULT_THUMB has been</span>&nbsp;</div></li><li><div><span class="comment"> * defined.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 Introduced `$object_type` parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type   'local' if the fallback should be the locally-hosted version</span>&nbsp;</div></li><li><div><span class="comment"> *                       of the mystery person, 'gravatar' if the fallback should be</span>&nbsp;</div></li><li><div><span class="comment"> *                       Gravatar's version. Default: 'gravatar'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $params Parameters passed to bp_core_fetch_avatar().</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The URL of the default avatar thumb.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_default_thumb( $type = 'gravatar', $params = array() ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Local override.</span></span>&nbsp;</div></li><li><div>  if ( defined( 'BP_AVATAR_DEFAULT_THUMB' ) ) {&nbsp;</div></li><li><div>      $avatar = BP_AVATAR_DEFAULT_THUMB;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use the local default image.</span></span>&nbsp;</div></li><li><div>  } elseif ( 'local' === $type ) {&nbsp;</div></li><li><div>      $avatar = buddypress()-&gt;plugin_url . 'bp-core/images/mystery-man-50.jpg';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use Gravatar's mystery person as fallback.</span></span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $avatar = '<span class="comment">//www.gravatar.com/avatar/00000000000000000000000000000000?d=mm&amp;s=' . bp_core_avatar_thumb_width();</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the URL of the 'thumb' default avatar.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0 Added `$params`.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $avatar URL of the default avatar.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $params Params provided to bp_core_fetch_avatar().</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_avatar_thumb', $avatar, $params );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Reset the week parameter of the WordPress main query if needed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * When cropping an avatar, a $_POST['w'] var is sent, setting the 'week'</span>&nbsp;</div></li><li><div><span class="comment"> * parameter of the WordPress main query to this posted var. To avoid</span>&nbsp;</div></li><li><div><span class="comment"> * notices, we need to make sure this 'week' query var is reset to 0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Query|null $posts_query The main query object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_core_avatar_reset_query( $posts_query = null ) {&nbsp;</div></li><li><div>  $reset_w = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Group's avatar edit screen.</span>&nbsp;</div></li><li><div>  if ( bp_is_group_admin_page() ) {&nbsp;</div></li><li><div>      $reset_w = bp_is_group_admin_screen( 'group-avatar' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Group's avatar create screen.</span>&nbsp;</div></li><li><div>  } elseif ( bp_is_group_create() ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * We can't use bp_get_groups_current_create_step().</span>&nbsp;</div></li><li><div><span class="comment">       * as it's not set yet</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $reset_w = 'group-avatar' === bp_action_variable( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// User's change avatar screen.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $reset_w = bp_is_user_change_avatar();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// A user or a group is cropping an avatar.</span>&nbsp;</div></li><li><div>  if ( true === $reset_w && isset( $_POST['avatar-crop-submit'] ) ) {&nbsp;</div></li><li><div>      $posts_query-&gt;set( 'w', 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_parse_query', 'bp_core_avatar_reset_query', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether Avatar UI should be loaded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if Avatar UI should load, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_is_front_edit() {&nbsp;</div></li><li><div>  $retval = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No need to carry on if the current WordPress version is not supported.</span>&nbsp;</div></li><li><div>  if ( ! bp_attachments_is_wp_version_supported() ) {&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_user_change_avatar() && 'crop-image' !== bp_get_avatar_admin_step() ) {&nbsp;</div></li><li><div>      $retval = ! bp_core_get_root_option( 'bp-disable-avatar-uploads' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_active( 'groups' ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Group creation.</span>&nbsp;</div></li><li><div>      if ( bp_is_group_create() && bp_is_group_creation_step( 'group-avatar' ) && 'crop-image' !== bp_get_avatar_admin_step() ) {&nbsp;</div></li><li><div>          $retval = ! bp_disable_group_avatar_uploads();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Group Manage.</span>&nbsp;</div></li><li><div>      } elseif ( bp_is_group_admin_page() && bp_is_group_admin_screen( 'group-avatar' ) && 'crop-image' !== bp_get_avatar_admin_step() ) {&nbsp;</div></li><li><div>          $retval = ! bp_disable_group_avatar_uploads();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Use this filter if you need to :</span>&nbsp;</div></li><li><div><span class="comment">   * - Load the avatar UI for a component that is !groups or !user (return true regarding your conditions)</span>&nbsp;</div></li><li><div><span class="comment">   * - Completely disable the avatar UI introduced in 2.3 (eg: __return_false())</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $retval Whether or not to load the Avatar UI.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_avatar_is_front_edit', $retval );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether the Webcam Avatar UI part should be loaded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global $is_safari</span>&nbsp;</div></li><li><div><span class="comment"> * @global $is_IE</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True to load the Webcam Avatar UI part. False otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_use_webcam() {&nbsp;</div></li><li><div>  global $is_safari, $is_IE, $is_chrome;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Do not use the webcam feature for mobile devices</span>&nbsp;</div></li><li><div><span class="comment">   * to avoid possible confusions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( wp_is_mobile() ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Bail when the browser does not support getUserMedia.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see http://caniuse.com/#feat=stream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( $is_safari || $is_IE || ( $is_chrome && ! is_ssl() ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Use this filter if you need to disable the webcam capture feature</span>&nbsp;</div></li><li><div><span class="comment">   * by returning false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $value Whether or not to load Webcam Avatar UI part.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'bp_avatar_use_webcam', true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Template function to load the Avatar UI javascript templates.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_get_templates() {&nbsp;</div></li><li><div>  if ( ! bp_avatar_is_front_edit() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_attachments_get_template_part( 'avatars/index' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Trick to check if the theme's BuddyPress templates are up to date.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the &quot;avatar templates&quot; are not including the new template tag, this will</span>&nbsp;</div></li><li><div><span class="comment"> * help users to get the avatar UI.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bp_avatar_template_check() {&nbsp;</div></li><li><div>  if ( ! bp_avatar_is_front_edit() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! did_action( 'bp_attachments_avatar_check_template' ) ) {&nbsp;</div></li><li><div>      bp_attachments_get_template_part( 'avatars/index' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress</li><li><span></span>2.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>