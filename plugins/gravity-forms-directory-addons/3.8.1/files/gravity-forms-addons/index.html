<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.1" data-slug="gravity-forms-directory-addons" data-type="file" data-id="30397"><head xmlns="http://www.w3.org/1999/xhtml"><title> gravity-forms-addons | file | Gravity Forms Directory Addons | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, gravity-forms-directory-addons, 3.8.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=9efa22642aa151000fd5664839032d50' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/gravity-forms-addons/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fgravity-forms-addons%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fgravity-forms-addons%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-forms-directory-addons-3.8.1-file-gravity-forms-addons","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gravity-forms-addons" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms-directory-addons." href="http://hookr.io/plugins/gravity-forms-directory-addons/" class="plugin"><span property="name">gravity-forms-directory-addons</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.1." href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/" class="H_VERSION"><span property="name">3.8.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gravity-forms-addons</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="141"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/all/" title="All">All <span class="count badge">141</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="130"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/hooks/" title="Hooks">Hooks <span class="count badge">130</span></a></li><li class="" data-id="action" data-count="13"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/actions/" title="Actions">Actions <span class="count badge">13</span></a></li><li class="" data-id="filter" data-count="117"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/filters/" title="Filters">Filters <span class="count badge">117</span></a></li><li class="" data-id="class" data-count="4"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/classes/" title="Classes">Classes <span class="count badge">4</span></a></li><li class="" data-id="constant" data-count="1"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/constants/" title="Constants">Constants <span class="count badge">1</span></a></li><li class="" data-id="function" data-count="5"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/functions/" title="Functions">Functions <span class="count badge">5</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/gravity-forms-directory-addons/3.8.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/gravity-forms-addons.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name:     Gravity Forms Directory & Addons</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI:     http://katz.co/gravity-forms-addons/</span>&nbsp;</div></li><li><div><span class="comment">Description:     Turn &lt;a href=&quot;http://katz.si/gravityforms&quot;&gt;Gravity Forms&lt;/a&gt; into a great WordPress directory...and more!</span>&nbsp;</div></li><li><div><span class="comment">Author:         Katz Web Services, Inc.</span>&nbsp;</div></li><li><div><span class="comment">Version:         3.8.1</span>&nbsp;</div></li><li><div><span class="comment">Author URI:        https://gravityview.co</span>&nbsp;</div></li><li><div><span class="comment">Text Domain:    gravity-forms-addons</span>&nbsp;</div></li><li><div><span class="comment">License:        GPLv2 or later</span>&nbsp;</div></li><li><div><span class="comment">License URI:     http://www.gnu.org/licenses/gpl-2.0.html</span>&nbsp;</div></li><li><div><span class="comment">Domain Path:    /languages</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">Copyright 2015 Katz Web Services, Inc.  (email: info@katzwebservices.com)</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is free software; you can redistribute it and/or modify</span>&nbsp;</div></li><li><div><span class="comment">it under the terms of the GNU General Public License as published by</span>&nbsp;</div></li><li><div><span class="comment">the Free Software Foundation; either version 3 of the License, or</span>&nbsp;</div></li><li><div><span class="comment">(at your option) any later version.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is distributed in the hope that it will be useful, </span>&nbsp;</div></li><li><div><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>&nbsp;</div></li><li><div><span class="comment">GNU General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">You should have received a copy of the GNU General Public License</span>&nbsp;</div></li><li><div><span class="comment">along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>register_activation_hook( __FILE__, array( 'GFDirectory', 'activation' ) );&nbsp;</div></li><li><div>add_action( 'plugins_loaded', array( 'GFDirectory', 'plugins_loaded' ) );&nbsp;</div></li><li><div>add_action( 'plugins_loaded', 'kws_gf_load_functions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class GFDirectory {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $path = &quot;gravity-forms-addons/gravity-forms-addons.php&quot;;&nbsp;</div></li><li><div>  private static $slug = &quot;gravity-forms-addons&quot;;&nbsp;</div></li><li><div>  private static $version = &quot;3.8.1&quot;;&nbsp;</div></li><li><div>  private static $min_gravityforms_version = &quot;1.5&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function directory_defaults( $args = array() ) {&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'form' =&gt; 1, &nbsp;</div></li><li><div>          <span class="comment">// Gravity Forms form ID</span>&nbsp;</div></li><li><div>          'approved' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// Show only entries that have been Approved (have a field in the form that is an Admin-only checkbox with a value of 'Approved'</span>&nbsp;</div></li><li><div>          'smartapproval' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Auto-convert form into Approved-only when an Approved field is detected.</span>&nbsp;</div></li><li><div>          'directoryview' =&gt; 'table', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Table, list or DL</span></span>&nbsp;</div></li><li><div>          'entryview' =&gt; 'table', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Table, list or DL</span></span>&nbsp;</div></li><li><div>          'hovertitle' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Show column name as user hovers over cell</span>&nbsp;</div></li><li><div>          'tableclass' =&gt; 'gf_directory widefat', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Class for the &lt;table&gt;</span></span>&nbsp;</div></li><li><div>          'tablestyle' =&gt; '', &nbsp;</div></li><li><div>          <span class="comment">// inline CSS for the &lt;table&gt;</span>&nbsp;</div></li><li><div>          'rowclass' =&gt; '', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Class for the &lt;table&gt;</span></span>&nbsp;</div></li><li><div>          'rowstyle' =&gt; '', &nbsp;</div></li><li><div>          <span class="comment">// inline CSS for all &lt;tbody&gt;&lt;tr&gt;'s</span>&nbsp;</div></li><li><div>          'valign' =&gt; '', &nbsp;</div></li><li><div>          'sort' =&gt; 'date_created', &nbsp;</div></li><li><div>          <span class="comment">// Use the input ID ( example: 1.3 or 7 or ip )</span>&nbsp;</div></li><li><div>          'dir' =&gt; 'DESC', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          'useredit' =&gt; false, &nbsp;</div></li><li><div>          'limituser' =&gt; false, &nbsp;</div></li><li><div>          'adminedit' =&gt; false, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          'status' =&gt; 'active', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Added in 2.0</span></span></span>&nbsp;</div></li><li><div>          'start_date' =&gt; '', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Added in 2.0</span></span></span>&nbsp;</div></li><li><div>          'end_date' =&gt; '', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Added in 2.0</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//'wpautop' =&gt; true, // Convert bulk paragraph text to...paragraphs. Deprecated 3.6.3</span>&nbsp;</div></li><li><div>          'page_size' =&gt; 20, &nbsp;</div></li><li><div>          <span class="comment">// Number of entries to show at once</span>&nbsp;</div></li><li><div>          'startpage' =&gt; 1, &nbsp;</div></li><li><div>          <span class="comment">// If you want to show page 8 instead of 1</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          'lightboxstyle' =&gt; 3, &nbsp;</div></li><li><div>          'lightboxsettings' =&gt; array( 'images' =&gt; true, 'entry' =&gt; NULL, 'websites' =&gt; NULL ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          'showcount' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Do you want to show &quot;Displaying 1-19 of 19&quot;?</span>&nbsp;</div></li><li><div>          'pagelinksshowall' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Whether to show each page number, or just 7</span>&nbsp;</div></li><li><div>          'next_text' =&gt; '&raquo;', &nbsp;</div></li><li><div>          'prev_text' =&gt; '&laquo;', &nbsp;</div></li><li><div>          'pagelinkstype' =&gt; 'plain', &nbsp;</div></li><li><div>          <span class="comment">// 'plain' is just a string with the links separated by a newline character. The other possible values are either 'array' or 'list'.</span>&nbsp;</div></li><li><div>          <span class="comment">//'fulltext' =&gt; true, // If there's a textarea or post content field, show the full content or a summary? Deprecated 3.6.3</span>&nbsp;</div></li><li><div>          'linkemail' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Convert email fields to email mailto: links</span>&nbsp;</div></li><li><div>          'linkwebsite' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Convert URLs to links</span>&nbsp;</div></li><li><div>          'linknewwindow' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// Open links in new window? (uses target=&quot;_blank&quot;)</span>&nbsp;</div></li><li><div>          'nofollowlinks' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// Add nofollow to all links, including emails</span>&nbsp;</div></li><li><div>          'titleshow' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Show a form title? By default, the title will be the form title.</span>&nbsp;</div></li><li><div>          'titleprefix' =&gt; 'Entries for ', &nbsp;</div></li><li><div>          <span class="comment">// Default GF behavior is 'Entries : '</span>&nbsp;</div></li><li><div>          'tablewidth' =&gt; '100%', &nbsp;</div></li><li><div>          <span class="comment">// 'width' attribute for the table</span>&nbsp;</div></li><li><div>          'searchtabindex' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// adds tabindex=&quot;&quot; to the search field</span>&nbsp;</div></li><li><div>          'search' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// show the search field</span>&nbsp;</div></li><li><div>          'tfoot' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// show the &lt;tfoot&gt;</span>&nbsp;</div></li><li><div>          'thead' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// show the &lt;thead&gt;</span>&nbsp;</div></li><li><div>          'showadminonly' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// Admin only columns aren't shown by default, but can be (added 2.0.1)</span>&nbsp;</div></li><li><div>          'datecreatedformat' =&gt; get_option( 'date_format' ) . ' \a\t ' . get_option( 'time_format' ), &nbsp;</div></li><li><div>          <span class="comment">// Use standard PHP date formats (http://php.net/manual/en/function.date.php)</span>&nbsp;</div></li><li><div>          'credit' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// Credit link</span>&nbsp;</div></li><li><div>          'dateformat' =&gt; false, &nbsp;</div></li><li><div>          <span class="comment">// Override the options from Gravity Forms, and use standard PHP date formats (http://php.net/manual/en/function.date.php)</span>&nbsp;</div></li><li><div>          'postimage' =&gt; 'icon', &nbsp;</div></li><li><div>          <span class="comment">// Whether to show icon, thumbnail, or large image</span>&nbsp;</div></li><li><div>          'getimagesize' =&gt; false, &nbsp;</div></li><li><div>          'entry' =&gt; true, &nbsp;</div></li><li><div>          <span class="comment">// If there's an Entry ID column, link to the full entry</span>&nbsp;</div></li><li><div>          'entrylink' =&gt; 'View entry details', &nbsp;</div></li><li><div>          'entryth' =&gt; 'More Info', &nbsp;</div></li><li><div>          'entryback' =&gt; '&larr; Back to directory', &nbsp;</div></li><li><div>          'entryonly' =&gt; true, &nbsp;</div></li><li><div>          'entrytitle' =&gt; 'Entry Detail', &nbsp;</div></li><li><div>          'entrydetailtitle' =&gt; '%%formtitle%% : Entry # %%leadid%%', &nbsp;</div></li><li><div>          'entryanchor' =&gt; true, &nbsp;</div></li><li><div>          'truncatelink' =&gt; false, &nbsp;</div></li><li><div>          'appendaddress' =&gt; false, &nbsp;</div></li><li><div>          'hideaddresspieces' =&gt; false, &nbsp;</div></li><li><div>          'jssearch' =&gt; true, &nbsp;</div></li><li><div>          'jstable' =&gt; false, &nbsp;</div></li><li><div>          'lightbox' =&gt; NULL, &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// depreciated - Combining with lightboxsettings</span></span>&nbsp;</div></li><li><div>          'entrylightbox' =&gt; NULL, &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// depreciated - Combining with lightboxsettings</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = get_option( &quot;gf_addons_settings&quot; );&nbsp;</div></li><li><div>      if ( isset( $settings['directory_defaults'] ) ) {&nbsp;</div></li><li><div>          $defaults = wp_parse_args( $settings['directory_defaults'], $defaults );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $options = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backward Compatibility</span>&nbsp;</div></li><li><div>      if ( ! empty( $args['lightbox'] ) ) {&nbsp;</div></li><li><div>          $options['lightboxsettings']['images'] = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $args['entrylightbox'] ) ) {&nbsp;</div></li><li><div>          $options['lightboxsettings']['entry'] = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      unset( $options['lightbox'], $options['entrylightbox'] ); <span class="comment">// Depreciated for lightboxsettings</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'kws_gf_directory_defaults', $options );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function plugins_loaded() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! self::is_gravityforms_installed() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      include_once( plugin_dir_path( __FILE__ ) . '/edit-form.php' );&nbsp;</div></li><li><div>      include_once( plugin_dir_path( __FILE__ ) . '/admin.php' );&nbsp;</div></li><li><div>      include_once( plugin_dir_path( __FILE__ ) . '/gravity-forms-lead-creator.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( RG_CURRENT_PAGE, array( &quot;gf_entries&quot;, &quot;admin.php&quot;, &quot;admin-ajax.php&quot; ) ) ) {&nbsp;</div></li><li><div>          self::globals_get_approved_column();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( self::is_gravity_page() ) {&nbsp;</div></li><li><div>          self::load_functionality();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'init', array( 'GFDirectory', 'init' ) );&nbsp;</div></li><li><div>      add_shortcode( 'directory', array( 'GFDirectory', 'make_directory' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Plugin starting point. Will load appropriate files</span>&nbsp;</div></li><li><div>  public static function init() {&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      load_plugin_textdomain( 'gravity-forms-addons', false, dirname( plugin_basename( __FILE__ ) ) . '/languages/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::add_rewrite();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! self::is_gravityforms_supported() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_admin() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'template_redirect', array( 'GFDirectory', 'enqueue_files' ) );&nbsp;</div></li><li><div>          if ( apply_filters( 'kws_gf_directory_canonical_add', true ) ) {&nbsp;</div></li><li><div>              add_filter( 'post_link', array( 'GFDirectory', 'directory_canonical' ), 1, 3 );&nbsp;</div></li><li><div>              add_filter( 'page_link', array( 'GFDirectory', 'directory_canonical' ), 1, 3 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( apply_filters( 'kws_gf_directory_shortlink', true ) ) {&nbsp;</div></li><li><div>              add_filter( 'get_shortlink', array( 'GFDirectory', 'shortlink' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          add_filter( 'kws_gf_directory_lead_filter', array( 'GFDirectory', 'show_only_user_entries' ), 10, 2 );&nbsp;</div></li><li><div>          add_filter( 'kws_gf_directory_anchor_text', array( 'GFDirectory', 'directory_anchor_text' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//integrating with Members plugin</span>&nbsp;</div></li><li><div>      if ( function_exists( 'members_get_capabilities' ) ) {&nbsp;</div></li><li><div>          add_filter( 'members_get_capabilities', array( &quot;GFDirectory&quot;, &quot;members_get_capabilities&quot; ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'kws_gf_directory_td_address', array(&nbsp;</div></li><li><div>          'GFDirectory', &nbsp;</div></li><li><div>          'format_address', &nbsp;</div></li><li><div> ), 1, 2 ); <span class="comment">// Add this filter so it can be removed or overridden by users</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( self::is_directory_page() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//enqueueing sack for AJAX requests</span>&nbsp;</div></li><li><div>          wp_enqueue_script( array( &quot;sack&quot;, 'datepicker' ) );&nbsp;</div></li><li><div>          wp_enqueue_style( 'gravityforms-admin', GFCommon::get_base_url() . '/css/admin.css' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else if ( self::is_gravity_page( 'gf_entries' ) ) {&nbsp;</div></li><li><div>          wp_enqueue_script( 'thickbox', array( 'jquery' ) );&nbsp;</div></li><li><div>          add_filter( &quot;gform_get_field_value&quot;, array( 'GFDirectory', 'add_lead_approved_hidden_input' ), 1, 3 );&nbsp;</div></li><li><div>      } else if ( in_array( RG_CURRENT_PAGE, array( &quot;admin-ajax.php&quot; ) ) ) {&nbsp;</div></li><li><div>          add_action( 'wp_ajax_rg_update_feed_active', array( 'GFDirectory', 'update_feed_active' ) );&nbsp;</div></li><li><div>          add_action( 'wp_ajax_gf_select_directory_form', array( 'GFDirectory', 'select_directory_form' ) );&nbsp;</div></li><li><div>          add_action( 'wp_ajax_rg_update_approved', array( 'GFDirectory', 'directory_update_approved_hook' ) );&nbsp;</div></li><li><div>          add_action( 'wp_ajax_change_directory_columns', array( 'GFDirectory', 'change_directory_columns' ) );&nbsp;</div></li><li><div>      } else if ( in_array( RG_CURRENT_PAGE, array( &quot;plugins.php&quot; ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'plugin_action_links', array( 'GFDirectory', 'settings_link' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Target of Member plugin filter. Provides the plugin with Gravity Forms lists of capabilities</span>&nbsp;</div></li><li><div>  public static function members_get_capabilities( $caps ) {&nbsp;</div></li><li><div>      return array_merge( $caps, array( &quot;gravityforms_directory&quot;, &quot;gravityforms_directory_uninstall&quot; ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function activation() {&nbsp;</div></li><li><div>      self::add_permissions();&nbsp;</div></li><li><div>      self::flush_rules();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function is_gravityforms_installed() {&nbsp;</div></li><li><div>      return class_exists( &quot;RGForms&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function add_permissions() {&nbsp;</div></li><li><div>      global $wp_roles;&nbsp;</div></li><li><div>      $wp_roles-&gt;add_cap( &quot;administrator&quot;, &quot;gravityforms_directory&quot; );&nbsp;</div></li><li><div>      $wp_roles-&gt;add_cap( &quot;administrator&quot;, &quot;gravityforms_directory_uninstall&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function flush_rules() {&nbsp;</div></li><li><div>      global $wp_rewrite;&nbsp;</div></li><li><div>      self::add_rewrite();&nbsp;</div></li><li><div>      $wp_rewrite-&gt;flush_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function load_functionality() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      register_deactivation_hook( __FILE__, array( 'GFDirectory', 'uninstall' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = self::get_settings();&nbsp;</div></li><li><div>      extract( $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $referrer ) {&nbsp;</div></li><li><div>          <span class="comment">// Load Joost's referrer tracker</span>&nbsp;</div></li><li><div>          @include_once( 'gravity-forms-referrer.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function shortlink( $link = '' ) {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>      if ( empty( $post ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( empty( $link ) && isset( $post-&gt;guid ) ) {&nbsp;</div></li><li><div>          $link = $post-&gt;guid;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $link;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg( array() );&nbsp;</div></li><li><div>      if ( preg_match( '/' . sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) ) . '\/([0-9]+)(?:\/|-)([0-9]+)\/?/ism', $url, $matches ) ) {&nbsp;</div></li><li><div>          $link = add_query_arg( array( 'form' =&gt; (int) $matches[1], 'leadid' =&gt; (int) $matches[2] ), $link );&nbsp;</div></li><li><div>      } elseif ( isset( $_REQUEST['leadid'] ) && isset( $_REQUEST['form'] ) ) {&nbsp;</div></li><li><div>          $link = wp_nonce_url( add_query_arg( array(&nbsp;</div></li><li><div>              'leadid' =&gt; (int) $_REQUEST['leadid'], &nbsp;</div></li><li><div>              'form' =&gt; (int) $_REQUEST['form'], &nbsp;</div></li><li><div> ), $link ), sprintf( 'view-%d-%d', $_REQUEST['leadid'], $_REQUEST['form'] ), 'view' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return esc_url_raw( $link );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function directory_canonical( $permalink, $sentPost = '', $leavename = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This was messing up the wp menu links</span>&nbsp;</div></li><li><div>      if ( did_action( 'wp_head' ) ) {&nbsp;</div></li><li><div>          return $permalink;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_object( $post ) ) {&nbsp;</div></li><li><div>          $post-&gt;permalink = $permalink;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg( array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sentPostID = is_object( $sentPost ) ? $sentPost-&gt;ID : $sentPost;&nbsp;</div></li><li><div>      <span class="comment">// $post-&gt;ID === $sentPostID is so that add_query_arg match doesn't apply to prev/next posts; just current</span>&nbsp;</div></li><li><div>      preg_match( '/(' . sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) ) . '\/([0-9]+)(?:\/|-)([0-9]+)\/?)/ism', $url, $matches );&nbsp;</div></li><li><div>      if ( isset( $post-&gt;ID ) && $post-&gt;ID === $sentPostID && ! empty( $matches ) ) {&nbsp;</div></li><li><div>          return trailingslashit( $permalink ) . $matches[0];&nbsp;</div></li><li><div>      } elseif ( isset( $post-&gt;ID ) && $post-&gt;ID === $sentPostID && ( isset( $_REQUEST['leadid'] ) && isset( $_REQUEST['form'] ) ) || ! empty( $matches ) ) {&nbsp;</div></li><li><div>          if ( $matches ) {&nbsp;</div></li><li><div>              $leadid = $matches[2];&nbsp;</div></li><li><div>              $form = $matches[1];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $leadid = $_REQUEST['leadid'];&nbsp;</div></li><li><div>              $form = $_REQUEST['form'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return esc_url_raw( wp_nonce_url( add_query_arg( array(&nbsp;</div></li><li><div>              'leadid' =&gt; $leadid, &nbsp;</div></li><li><div>              'form' =&gt; $form, &nbsp;</div></li><li><div> ), trailingslashit( $permalink ) ), sprintf( 'view-%d-%d', $leadid, $form ), 'view' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $permalink;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function enqueue_files() {&nbsp;</div></li><li><div>      global $post, $kws_gf_styles, $kws_gf_scripts, $kws_gf_directory_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $kws_gf_styles = isset( $kws_gf_styles ) ? $kws_gf_styles : array();&nbsp;</div></li><li><div>      $kws_gf_scripts = isset( $kws_gf_scripts ) ? $kws_gf_scripts : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $post ) &&&nbsp;</div></li><li><div>           ! empty( $post-&gt;post_content ) &&&nbsp;</div></li><li><div>           preg_match( '/(.?)\[(directory)\b(.*?)(?:(\/))?\](?:(.+?)\[\/\2\])?(.?)/', $post-&gt;post_content, $matches )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $options = self::directory_defaults( shortcode_parse_atts( $matches[3] ) );&nbsp;</div></li><li><div>          if ( ! is_array( $options['lightboxsettings'] ) ) {&nbsp;</div></li><li><div>              $options['lightboxsettings'] = explode( ', ', $options['lightboxsettings'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $kws_gf_directory_options = $options;&nbsp;</div></li><li><div>          do_action( 'kws_gf_directory_enqueue', $options, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          extract( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $jstable ) {&nbsp;</div></li><li><div>              $theme = apply_filters( 'kws_gf_tablesorter_theme', 'blue', $form );&nbsp;</div></li><li><div>              wp_enqueue_style( 'tablesorter-' . $theme, plugins_url( &quot;/bower_components/jquery.tablesorter/css/theme.{$theme}.css&quot;, __FILE__ ) );&nbsp;</div></li><li><div>              wp_enqueue_script( 'tablesorter-min', plugins_url( &quot;/bower_components/jquery.tablesorter/js/jquery.tablesorter.min.js&quot;, __FILE__ ), array( 'jquery' ) );&nbsp;</div></li><li><div>              $kws_gf_styles[] = 'tablesorter-' . $theme;&nbsp;</div></li><li><div>              $kws_gf_scripts[] = 'tablesorter-min';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $lightboxsettings ) ) {&nbsp;</div></li><li><div>              wp_enqueue_script( 'colorbox', plugins_url( &quot;/bower_components/colorbox/jquery.colorbox-min.js&quot;, __FILE__ ), array( 'jquery' ) );&nbsp;</div></li><li><div>              wp_enqueue_style( 'colorbox', plugins_url( &quot;/bower_components/colorbox/example{$lightboxstyle}/colorbox.css&quot;, __FILE__ ), array() );&nbsp;</div></li><li><div>              $kws_gf_scripts[] = $kws_gf_styles[] = 'colorbox';&nbsp;</div></li><li><div>              add_action( apply_filters( 'kws_gf_directory_colorbox_action', 'wp_footer' ), array(&nbsp;</div></li><li><div>                  'GFDirectory', &nbsp;</div></li><li><div>                  'load_colorbox', &nbsp;</div></li><li><div> ), 1000 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          list( $urlformid, $urlleadid ) = self::get_form_and_lead_ids();&nbsp;</div></li><li><div>          if ( isset( $_GET['edit'] ) && ! empty( $urlformid ) && isset( $urlleadid ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $edit_scripts = array( 'jquery', 'gform_json', 'gform_placeholder', 'sack', 'plupload-all' );&nbsp;</div></li><li><div>              wp_enqueue_script( 'gform_gravityforms', $edit_scripts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $kws_gf_scripts[] = array_merge( $kws_gf_scripts, $edit_scripts );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function format_colorbox_settings( $colorboxSettings = array() ) {&nbsp;</div></li><li><div>      $settings = array();&nbsp;</div></li><li><div>      if ( ! empty( $colorboxSettings ) && is_array( $colorboxSettings ) ) {&nbsp;</div></li><li><div>          foreach ( $colorboxSettings as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( $value === NULL ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $value === true ) {&nbsp;</div></li><li><div>                  $value = 'true';&nbsp;</div></li><li><div>              } elseif ( empty( $value ) && $value !== 0 ) {&nbsp;</div></li><li><div>                  $value = 'false';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $value = '&quot;' . $value . '&quot;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $settings[&quot;{$key}&quot;] = $key . ':' . $value . '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function load_colorbox() {&nbsp;</div></li><li><div>      global $kws_gf_directory_options;&nbsp;</div></li><li><div>      extract( $kws_gf_directory_options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lightboxsettings = apply_filters( 'kws_gf_directory_lightbox_settings', $lightboxsettings );&nbsp;</div></li><li><div>      $colorboxSettings = apply_filters( 'kws_gf_directory_colorbox_settings', array(&nbsp;</div></li><li><div>          'width' =&gt; apply_filters( 'kws_gf_directory_lightbox_width', '70%' ), &nbsp;</div></li><li><div>          'height' =&gt; apply_filters( 'kws_gf_directory_lightbox_height', '70%' ), &nbsp;</div></li><li><div>          'iframe' =&gt; true, &nbsp;</div></li><li><div>          'maxWidth' =&gt; '95%', &nbsp;</div></li><li><div>          'maxHeight' =&gt; '95%', &nbsp;</div></li><li><div>          'current' =&gt; '{current} of {total}', &nbsp;</div></li><li><div>          'rel' =&gt; apply_filters( 'kws_gf_directory_lightbox_settings_rel', NULL ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;script&gt;&nbsp;</div></li><li><div>          jQuery( document ).ready( function ( $ ) {&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              $output = '';&nbsp;</div></li><li><div>              foreach ( $lightboxsettings as $key =&gt; $value ) {&nbsp;</div></li><li><div>                  $settings = $colorboxSettings;&nbsp;</div></li><li><div>                  if ( is_numeric( $key ) ) {&nbsp;</div></li><li><div>                      $key = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  switch ( $key ) {&nbsp;</div></li><li><div>                      case &quot;images&quot;:&nbsp;</div></li><li><div>                          $settings['width'] = $settings['height'] = $settings['iframe'] = NULL;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      case &quot;urls&quot;:&nbsp;</div></li><li><div>                          $settings['height'] = '80%';&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $output .= &quot;\t\t&quot; . '$(&quot;.colorbox[rel~=\'directory_' . $key . '\']&quot;).colorbox(';&nbsp;</div></li><li><div>                  if ( ! empty( $settings ) ) {&nbsp;</div></li><li><div>                      $output .= &quot;{\n\t\t\t&quot; . implode( &quot;, \n\t\t\t&quot;, self::format_colorbox_settings( apply_filters( &quot;kws_gf_directory_lightbox_{$key}_settings&quot;, $settings ) ) ) . &quot;\n\t\t}&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $output .= &quot;);\n\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              echo $output;&nbsp;</div></li><li><div>              do_action( 'kws_gf_directory_jquery', $kws_gf_directory_options );&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          } );&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function add_rewrite() {&nbsp;</div></li><li><div>      global $wp_rewrite, $wp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $endpoint = sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      # @TODO: Make sure this works in MU&nbsp;</div></li><li><div>      $wp_rewrite-&gt;add_permastruct( &quot;{$endpoint}&quot;, $endpoint . '/%' . $endpoint . '%/?', true );&nbsp;</div></li><li><div>      $wp_rewrite-&gt;add_endpoint( &quot;{$endpoint}&quot;, EP_ALL );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns true if the current page is one of Gravity Forms pages. Returns false if not</span>&nbsp;</div></li><li><div>  public static function is_gravity_page( $page = array() ) {&nbsp;</div></li><li><div>      $current_page = trim( strtolower( RGForms::get( &quot;page&quot; ) ) );&nbsp;</div></li><li><div>      if ( empty( $page ) ) {&nbsp;</div></li><li><div>          $gf_pages = array( &quot;gf_edit_forms&quot;, &quot;gf_new_form&quot;, &quot;gf_entries&quot;, &quot;gf_settings&quot;, &quot;gf_export&quot;, &quot;gf_help&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $gf_pages = is_array( $page ) ? $page : array( $page );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return in_array( $current_page, $gf_pages );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function directory_update_approved( $lead_id = 0, $approved = 0, $form_id = 0, $approvedcolumn = 0 ) {&nbsp;</div></li><li><div>      global $wpdb, $_gform_directory_approvedcolumn, $current_user;&nbsp;</div></li><li><div>      $current_user = wp_get_current_user();&nbsp;</div></li><li><div>      $user_data = get_userdata( $current_user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $approvedcolumn ) ) {&nbsp;</div></li><li><div>          $_gform_directory_approvedcolumn = $approvedcolumn;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_gform_directory_approvedcolumn ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lead_detail_table = RGFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This will be faster in the 1.6+ future.</span>&nbsp;</div></li><li><div>      if ( function_exists( 'gform_update_meta' ) ) {&nbsp;</div></li><li><div>          gform_update_meta( $lead_id, 'is_approved', $approved );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $approved ) ) {&nbsp;</div></li><li><div>          <span class="comment">//Deleting details for this field</span>&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_detail_table WHERE lead_id=%d AND field_number BETWEEN %f AND %f &quot;, $lead_id, $_gform_directory_approvedcolumn - 0.001, $_gform_directory_approvedcolumn + 0.001 );&nbsp;</div></li><li><div>          $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          RGFormsModel::add_note( $lead_id, $current_user-&gt;ID, $user_data-&gt;display_name, stripslashes( __( 'Disapproved the lead', 'gravity-forms-addons' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the fields for the lead</span>&nbsp;</div></li><li><div>          $current_fields = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id, field_number FROM $lead_detail_table WHERE lead_id=%d&quot;, $lead_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lead_detail_id = RGFormsModel::get_lead_detail_id( $current_fields, $_gform_directory_approvedcolumn );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If there's already a field for the approved column, then we update it.</span>&nbsp;</div></li><li><div>          if ( $lead_detail_id &gt; 0 ) {&nbsp;</div></li><li><div>              $update = $wpdb-&gt;update( $lead_detail_table, array( &quot;value&quot; =&gt; $approved ), array(&nbsp;</div></li><li><div>                  &quot;lead_id&quot; =&gt; $lead_id, &nbsp;</div></li><li><div>                  'form_id' =&gt; $form_id, &nbsp;</div></li><li><div>                  'field_number' =&gt; $_gform_directory_approvedcolumn, &nbsp;</div></li><li><div> ), array( &quot;%s&quot; ), array( &quot;%d&quot;, &quot;%d&quot;, &quot;%f&quot; ) );&nbsp;</div></li><li><div>          } <span class="comment">// Otherwise, we create it.</span>&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $update = $wpdb-&gt;insert( $lead_detail_table, array(&nbsp;</div></li><li><div>                  &quot;lead_id&quot; =&gt; $lead_id, &nbsp;</div></li><li><div>                  &quot;form_id&quot; =&gt; $form_id, &nbsp;</div></li><li><div>                  &quot;field_number&quot; =&gt; $_gform_directory_approvedcolumn, &nbsp;</div></li><li><div>                  &quot;value&quot; =&gt; $approved, &nbsp;</div></li><li><div> ), array( &quot;%d&quot;, &quot;%d&quot;, &quot;%f&quot;, &quot;%s&quot; ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          RGFormsModel::add_note( $lead_id, $current_user-&gt;ID, $user_data-&gt;display_name, stripslashes( __( 'Approved the lead', 'gravity-forms-addons' ) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function edit_lead_detail( $Form, $lead, $options ) {&nbsp;</div></li><li><div>      global $current_user, $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>      require_once( GFCommon::get_base_path() . &quot;/form_display.php&quot; );&nbsp;</div></li><li><div>      if ( empty( $_gform_directory_approvedcolumn ) ) {&nbsp;</div></li><li><div>          $_gform_directory_approvedcolumn = self::get_approved_column( $Form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We fetch this again, since it may have had some admin-only columns taken out.</span>&nbsp;</div></li><li><div>      #$lead = RGFormsModel::get_lead($lead[&quot;id&quot;]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If you want to allow users to edit their own approval (?) add a filter and return true.</span>&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_allow_user_edit_approved', false ) === false ) {&nbsp;</div></li><li><div>          $Form['fields'] = self::remove_approved_column( 'form', $Form['fields'], $_gform_directory_approvedcolumn );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this is not the form that should be edited</span>&nbsp;</div></li><li><div>      list( $urlformid, $urlleadid ) = self::get_form_and_lead_ids();&nbsp;</div></li><li><div>      if ( intval( $Form['id'] ) !== intval( $urlformid ) || intval( $lead['id'] ) !== intval( $urlleadid ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If either of these two things are false (creator of lead, or admin)</span>&nbsp;</div></li><li><div>      if ( ! (&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Users can edit their own listings, they are logged in, the current user is the creator of the lead</span>&nbsp;</div></li><li><div>          ( ! empty( $options['useredit'] ) && is_user_logged_in() && intval( $current_user-&gt;ID ) === intval( $lead['created_by'] ) ) === true || <span class="comment">// OR</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Administrators can edit every listing, and this person has administrator access</span>&nbsp;</div></li><li><div>          ( ! empty( $options['adminedit'] ) && self::has_access( &quot;gravityforms_directory&quot; ) ) === true )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          <span class="comment">// Kick them out.</span>&nbsp;</div></li><li><div>          printf( esc_html_e( '%sYou do not have permission to edit this form.%s', 'gravity-forms-addons' ), '&lt;div class=&quot;error&quot;&gt;', '&lt;/div&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $validation_message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the form is submitted</span>&nbsp;</div></li><li><div>      if ( RGForms::post( &quot;action&quot; ) === &quot;update&quot; ) {&nbsp;</div></li><li><div>          check_admin_referer( 'gforms_save_entry', 'gforms_save_entry' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lead = apply_filters( 'kws_gf_directory_lead_being_updated', $lead, $Form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We don't DO passwords.</span>&nbsp;</div></li><li><div>          foreach ( $Form['fields'] as $key =&gt; $field ) {&nbsp;</div></li><li><div>              if ( $field['type'] === 'password' ) {&nbsp;</div></li><li><div>                  unset( $Form['fields'][ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_valid = GFFormDisplay::validate( $Form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $validation_message = '';&nbsp;</div></li><li><div>          foreach ( $Form['fields'] as $field ) {&nbsp;</div></li><li><div>              if ( ! GFCommon::is_product_field( $field[&quot;type&quot;] ) ) {&nbsp;</div></li><li><div>                  $validation_message .= ( rgget( &quot;failed_validation&quot;, $field ) && ! empty( $field[&quot;validation_message&quot;] ) ) ? sprintf( &quot;&lt;li class='gfield_description validation_message'&gt;&lt;strong&gt;%s&lt;/strong&gt;: %s&lt;/li&gt;&quot;, $field[&quot;label&quot;], $field[&quot;validation_message&quot;] ) : &quot;&quot;;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! empty( $validation_message ) ) {&nbsp;</div></li><li><div>              $validation_message = '&lt;ul&gt;' . $validation_message . '&lt;/ul&gt;';&nbsp;</div></li><li><div>              echo esc_html( apply_filters( 'kws_gf_directory_lead_error_message', sprintf( __( &quot;%sThere were errors with the edit you made.%s%s&quot;, 'gravity-forms-addons' ), &quot;&lt;div class='error' id='message' style='padding:.5em .75em; background-color:#ffffcc; border:1px solid #ccc;'&gt;&lt;p&gt;&quot;, &quot;&lt;/p&gt;&quot;, $validation_message . '&lt;/div&gt;' ), $lead, $Form ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// So the form submission always throws an error even though there's no problem.</span>&nbsp;</div></li><li><div>          <span class="comment">// Product fields can't be edited, so that doesn't really matter.</span>&nbsp;</div></li><li><div>          if ( ! empty( $is_valid ) || ( empty( $is_valid ) && empty( $validation_message ) ) ) {&nbsp;</div></li><li><div>              do_action( 'kws_gf_directory_pre_update_lead', $lead, $Form );&nbsp;</div></li><li><div>              <span class="comment">// since @3.6.1 to enable conditional fields' updates.</span>&nbsp;</div></li><li><div>              self::save_lead( $Form, $lead );&nbsp;</div></li><li><div>              $lead = RGFormsModel::get_lead( $lead[&quot;id&quot;] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              do_action( 'kws_gf_directory_post_update_lead', $lead, $Form );&nbsp;</div></li><li><div>              echo apply_filters( 'kws_gf_directory_lead_updated_message', sprintf( esc_html__( &quot;%sThe entry was successfully updated.%s&quot;, 'gravity-forms-addons' ), &quot;&lt;p class='updated' id='message' style='padding:.5em .75em; background-color:#ffffcc; border:1px solid #ccc;'&gt;&quot;, &quot;&lt;/p&gt;&quot; ), $lead, $Form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $lead;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( isset( $_GET['edit'] ) && wp_verify_nonce( $_GET['edit'], 'edit' . $lead['id'] . $Form[&quot;id&quot;] ) ) || ! empty( $validation_message ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The ID of the form needs to be `gform_{form_id}` for the pluploader</span>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;form method=&quot;post&quot; id=&quot;gform_&lt;?php echo esc_attr( $Form['id'] ); ?&gt;&quot; enctype=&quot;multipart/form-data&quot;&nbsp;</div></li><li><div>                action=&quot;&lt;?php echo esc_url( remove_query_arg( array(&nbsp;</div></li><li><div>                    'gf_search', &nbsp;</div></li><li><div>                    'sort', &nbsp;</div></li><li><div>                    'dir', &nbsp;</div></li><li><div>                    'pagenum', &nbsp;</div></li><li><div>                    'edit', &nbsp;</div></li><li><div> ), add_query_arg( array() ) ) ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              wp_nonce_field( 'gforms_save_entry', 'gforms_save_entry' );&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;action&quot; id=&quot;action&quot; value=&quot;update&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;screen_mode&quot; id=&quot;screen_mode&quot; value=&quot;edit&quot;/&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $form_without_products = $Form;&nbsp;</div></li><li><div>              $post_message_shown = false;&nbsp;</div></li><li><div>              $product_fields = array();&nbsp;</div></li><li><div>              foreach ( $Form['fields'] as $key =&gt; $field ) {&nbsp;</div></li><li><div>                  if (&nbsp;</div></li><li><div>                      GFCommon::is_product_field( $field[&quot;type&quot;] ) ||&nbsp;</div></li><li><div>                      is_numeric( $lead[&quot;post_id&quot;] ) && GFCommon::is_post_field( $field )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                      if ( is_numeric( $lead[&quot;post_id&quot;] ) && GFCommon::is_post_field( $field ) && ! $message_shown ) {&nbsp;</div></li><li><div>                          echo apply_filters( 'kws_gf_directory_edit_post_details_text', sprintf( esc_html__( 'You can edit post details from the %1$spost page%2$s.', 'gravity-forms-addons' ), '&lt;a href=&quot;' . admin_url( 'post.php?action=edit&post=' . $lead[&quot;post_id&quot;] ) . '&quot;&gt;', '&lt;/a&gt;' ), $field, $lead, $lead['post_id'] );&nbsp;</div></li><li><div>                          $message_shown = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      unset( $form_without_products['fields'][ $key ] );&nbsp;</div></li><li><div>                      $product_fields[] = $field['id'];&nbsp;</div></li><li><div>                      if ( ! empty( $field['inputs'] ) ) {&nbsp;</div></li><li><div>                          foreach ( $field['inputs'] as $input ) {&nbsp;</div></li><li><div>                              $product_fields[] = $input['id'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $lead_without_products = &$lead;&nbsp;</div></li><li><div>              foreach ( $product_fields as $product_field ) {&nbsp;</div></li><li><div>                  $value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                  unset( $lead_without_products[ $product_field ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              require_once( GFCommon::get_base_path() . &quot;/entry_detail.php&quot; );&nbsp;</div></li><li><div>              GFEntryDetail::lead_detail_edit( apply_filters( 'kws_gf_directory_form_being_edited', $form_without_products, $lead ), apply_filters( 'kws_gf_directory_lead_being_edited', $lead_without_products, $form_without_products ) );&nbsp;</div></li><li><div>              echo '&lt;input class=&quot;button-primary&quot; type=&quot;submit&quot; tabindex=&quot;4&quot; value=&quot;' . esc_attr( apply_filters( 'kws_gf_directory_update_lead_button_text', __( 'Update Entry', 'gravity-forms-addons' ) ) ) . '&quot; name=&quot;save&quot; /&gt;';&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          do_action( 'kws_gf_directory_post_after_edit_lead_form', $lead, $Form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } elseif ( ( isset( $_GET['edit'] ) && ! wp_verify_nonce( $_GET['edit'], 'edit' ) ) ) {&nbsp;</div></li><li><div>          echo apply_filters( 'kws_gf_directory_edit_access_error_message', sprintf( esc_html__( &quot;%sThe link to edit this entry is not valid; it may have expired.%s&quot;, 'gravity-forms-addons' ), &quot;&lt;p class='error' id='message' style='padding:.5em .75em; background-color:#ffffcc; border:1px solid #ccc;'&gt;&quot;, &quot;&lt;/p&gt;&quot; ), $lead, $Form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $lead;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function lead_detail( $Form, $lead, $allow_display_empty_fields = false, $inline = true, $options = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFEntryList' ) ) {&nbsp;</div></li><li><div>          require_once( GFCommon::get_base_path() . &quot;/entry_list.php&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $current_user, $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>      get_currentuserinfo();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $display_empty_fields = '';&nbsp;</div></li><li><div>      $allow_display_empty_fields = true;&nbsp;</div></li><li><div>      if ( $allow_display_empty_fields ) {&nbsp;</div></li><li><div>          $display_empty_fields = @rgget( &quot;gf_display_empty_fields&quot;, $_COOKIE );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( empty( $options ) ) {&nbsp;</div></li><li><div>          $options = self::directory_defaults();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// There is no edit link</span>&nbsp;</div></li><li><div>      if ( isset( $_GET['edit'] ) || RGForms::post( &quot;action&quot; ) === &quot;update&quot; ) {&nbsp;</div></li><li><div>          <span class="comment">// Process editing leads</span>&nbsp;</div></li><li><div>          $lead = self::edit_lead_detail( $Form, $lead, $options );&nbsp;</div></li><li><div>          if ( RGForms::post( &quot;action&quot; ) !== &quot;update&quot; ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      extract( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;table cellspacing=&quot;0&quot; class=&quot;widefat fixed entry-detail-view&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          $title = str_replace( '%%formtitle%%', $Form[&quot;title&quot;], str_replace( '%%leadid%%', $lead['id'], $entrydetailtitle ) );&nbsp;</div></li><li><div>          if ( ! empty( $title ) && $inline ) { ?&gt;&nbsp;</div></li><li><div>              &lt;thead&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;th id=&quot;details&quot; colspan=&quot;2&quot; scope=&quot;col&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      $title = apply_filters( 'kws_gf_directory_detail_title', apply_filters( 'kws_gf_directory_detail_title_' . (int) $lead['id'], array(&nbsp;</div></li><li><div>                          $title, &nbsp;</div></li><li><div>                          $lead, &nbsp;</div></li><li><div> ), true ), true );&nbsp;</div></li><li><div>                      if ( is_array( $title ) ) {&nbsp;</div></li><li><div>                          echo $title[0];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          echo $title;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/th&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/thead&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;tbody&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          $count = 0;&nbsp;</div></li><li><div>          $has_product_fields = false;&nbsp;</div></li><li><div>          $field_count = sizeof( $Form[&quot;fields&quot;] );&nbsp;</div></li><li><div>          $display_value = '';&nbsp;</div></li><li><div>          foreach ( $Form[&quot;fields&quot;] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Don't show fields defined as hide in single.</span>&nbsp;</div></li><li><div>              if ( ! empty( $field['hideInSingle'] ) ) {&nbsp;</div></li><li><div>                  if ( self::has_access( &quot;gravityforms_directory&quot; ) ) {&nbsp;</div></li><li><div>                      echo &quot;\n\t\t\t\t\t\t\t\t\t&quot; . '&lt;!-- ' . sprintf( esc_html__( '(Admin-only notice) Field #%d not shown: &quot;Hide This Field in Single Entry View&quot; was selected.', 'gravity-forms-addons' ), $field['id'] ) . ' --&gt;' . &quot;\n\n&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $count ++;&nbsp;</div></li><li><div>              $is_last = $count &gt;= $field_count ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              switch ( RGFormsModel::get_input_type( $field ) ) {&nbsp;</div></li><li><div>                  case &quot;section&quot; :&nbsp;</div></li><li><div>                      if ( ! GFCommon::is_section_empty( $field, $Form, $lead ) || $display_empty_fields ) {&nbsp;</div></li><li><div>                          $count ++;&nbsp;</div></li><li><div>                          $is_last = $count &gt;= $field_count ? true : false;&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;td colspan=&quot;2&quot;&nbsp;</div></li><li><div>                                  class=&quot;entry-view-section-break&lt;?php echo $is_last ? &quot; lastrow&quot; : &quot;&quot; ?&gt;&quot;&gt;&lt;?php echo esc_html( GFCommon::get_label( $field ) ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case &quot;captcha&quot;:&nbsp;</div></li><li><div>                  case &quot;html&quot;:&nbsp;</div></li><li><div>                  case &quot;password&quot;:&nbsp;</div></li><li><div>                  case &quot;page&quot;:&nbsp;</div></li><li><div>                      <span class="comment">//ignore captcha, html, password, page field</span>&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case &quot;post_image&quot; :&nbsp;</div></li><li><div>                      $value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                      $valueArray = explode( &quot;|:|&quot;, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      @list( $url, $title, $caption, $description ) = $valueArray;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $url ) ) {&nbsp;</div></li><li><div>                          $value = $display_value = self::render_image_link( $url, $lead, $options, $title, $caption, $description );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  default :&nbsp;</div></li><li><div>                      <span class="comment">//ignore product fields as they will be grouped together at the end of the grid</span>&nbsp;</div></li><li><div>                      if ( GFCommon::is_product_field( $field[&quot;type&quot;] ) ) {&nbsp;</div></li><li><div>                          $has_product_fields = true;&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                      $display_value = GFCommon::get_lead_field_display( $field, $value, $lead[&quot;currency&quot;] );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } <span class="comment">// end switch</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $display_value = apply_filters( &quot;gform_entry_field_value&quot;, $display_value, $field, $lead, $Form );&nbsp;</div></li><li><div>              if ( $display_empty_fields || ! empty( $display_value ) || $display_value === &quot;0&quot; ) {&nbsp;</div></li><li><div>                  $count ++;&nbsp;</div></li><li><div>                  $is_last = $count &gt;= $field_count && ! $has_product_fields ? true : false;&nbsp;</div></li><li><div>                  $last_row = $is_last ? &quot; lastrow&quot; : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $display_value = empty( $display_value ) && $display_value !== &quot;0&quot; ? &quot;&nbsp;&quot; : $display_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $content = '&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;th colspan=&quot;2&quot; class=&quot;entry-view-field-name&quot;&gt;' . esc_html( GFCommon::get_label( $field ) ) . '&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;&nbsp;</div></li><li><div>                          &lt;tr&gt;&nbsp;</div></li><li><div>                              &lt;td colspan=&quot;2&quot; class=&quot;entry-view-field-value' . $last_row . '&quot;&gt;' . $display_value . '&lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;/tr&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $content = apply_filters( &quot;gform_field_content&quot;, $content, $field, $value, $lead[&quot;id&quot;], $Form[&quot;id&quot;] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  echo $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } <span class="comment">// End foreach</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $products = array();&nbsp;</div></li><li><div>          if ( $has_product_fields ) {&nbsp;</div></li><li><div>              $products = GFCommon::get_product_fields( $Form, $lead );&nbsp;</div></li><li><div>              if ( ! empty( $products[&quot;products&quot;] ) ) {&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;td colspan=&quot;2&quot;&nbsp;</div></li><li><div>                          class=&quot;entry-view-field-name&quot;&gt;&lt;?php echo apply_filters( &quot;gform_order_label_{$Form[&quot;id&quot;]}&quot;, apply_filters( &quot;gform_order_label&quot;, __( &quot;Order&quot;, &quot;gravityforms&quot; ), $Form[&quot;id&quot;] ), $Form[&quot;id&quot;] ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;td colspan=&quot;2&quot; class=&quot;entry-view-field-value lastrow&quot;&gt;&nbsp;</div></li><li><div>                          &lt;table class=&quot;entry-products&quot; cellspacing=&quot;0&quot; width=&quot;97%&quot;&gt;&nbsp;</div></li><li><div>                              &lt;colgroup&gt;&nbsp;</div></li><li><div>                                  &lt;col class=&quot;entry-products-col1&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;col class=&quot;entry-products-col2&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;col class=&quot;entry-products-col3&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;col class=&quot;entry-products-col4&quot;&gt;&nbsp;</div></li><li><div>                              &lt;/colgroup&gt;&nbsp;</div></li><li><div>                              &lt;thead&gt;&nbsp;</div></li><li><div>                              &lt;th scope=&quot;col&quot;&gt;&lt;?php echo apply_filters( &quot;gform_product_{$Form['id']}&quot;, apply_filters( &quot;gform_product&quot;, __( &quot;Product&quot;, &quot;gravityforms&quot; ), $Form['id'] ), $Form['id'] ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th scope=&quot;col&quot;&nbsp;</div></li><li><div>                                  class=&quot;textcenter&quot;&gt;&lt;?php echo apply_filters( &quot;gform_product_qty_{$Form['id']}&quot;, apply_filters( &quot;gform_product_qty&quot;, __( &quot;Qty&quot;, &quot;gravityforms&quot; ), $Form['id'] ), $Form['id'] ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th scope=&quot;col&quot;&gt;&lt;?php echo apply_filters( &quot;gform_product_unitprice_{$Form['id']}&quot;, apply_filters( &quot;gform_product_unitprice&quot;, __( &quot;Unit Price&quot;, &quot;gravityforms&quot; ), $Form['id'] ), $Form['id'] ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;th scope=&quot;col&quot;&gt;&lt;?php echo apply_filters( &quot;gform_product_price_{$Form['id']}&quot;, apply_filters( &quot;gform_product_price&quot;, __( &quot;Price&quot;, &quot;gravityforms&quot; ), $Form['id'] ), $Form['id'] ) ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;/thead&gt;&nbsp;</div></li><li><div>                              &lt;tbody&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $total = 0;&nbsp;</div></li><li><div>                              foreach ( $products[&quot;products&quot;] as $product ) {&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;tr&gt;&nbsp;</div></li><li><div>                                      &lt;td&gt;&nbsp;</div></li><li><div>                                          &lt;div class=&quot;product_name&quot;&gt;&lt;?php echo esc_html( $product[&quot;name&quot;] ) ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                                          &lt;ul class=&quot;product_options&quot;&gt;&nbsp;</div></li><li><div>                                              &lt;?php&nbsp;</div></li><li><div>                                              $price = GFCommon::to_number( $product[&quot;price&quot;] );&nbsp;</div></li><li><div>                                              if ( is_array( rgar( $product, &quot;options&quot; ) ) ) {&nbsp;</div></li><li><div>                                                  $count = sizeof( $product[&quot;options&quot;] );&nbsp;</div></li><li><div>                                                  $index = 1;&nbsp;</div></li><li><div>                                                  foreach ( $product[&quot;options&quot;] as $option ) {&nbsp;</div></li><li><div>                                                      $price += GFCommon::to_number( $option[&quot;price&quot;] );&nbsp;</div></li><li><div>                                                      $class = $index == $count ? &quot; class='lastitem'&quot; : &quot;&quot;;&nbsp;</div></li><li><div>                                                      $index ++;&nbsp;</div></li><li><div>                                                      ?&gt;&nbsp;</div></li><li><div>                                                      &lt;li&lt;?php echo $class ?&gt;&gt;&lt;?php echo $option[&quot;option_label&quot;] ?&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                                                      &lt;?php&nbsp;</div></li><li><div>                                                  }&nbsp;</div></li><li><div>                                              }&nbsp;</div></li><li><div>                                              $subtotal = floatval( $product[&quot;quantity&quot;] ) * $price;&nbsp;</div></li><li><div>                                              $total += $subtotal;&nbsp;</div></li><li><div>                                              ?&gt;&nbsp;</div></li><li><div>                                          &lt;/ul&gt;&nbsp;</div></li><li><div>                                      &lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;textcenter&quot;&gt;&lt;?php echo $product[&quot;quantity&quot;] ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;td&gt;&lt;?php echo GFCommon::to_money( $price, $lead[&quot;currency&quot;] ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;td&gt;&lt;?php echo GFCommon::to_money( $subtotal, $lead[&quot;currency&quot;] ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $total += floatval( $products[&quot;shipping&quot;][&quot;price&quot;] );&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;/tbody&gt;&nbsp;</div></li><li><div>                              &lt;tfoot&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                              if ( ! empty( $products[&quot;shipping&quot;][&quot;name&quot;] ) ) {&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;tr&gt;&nbsp;</div></li><li><div>                                      &lt;td colspan=&quot;2&quot; rowspan=&quot;2&quot; class=&quot;emptycell&quot;&gt;&nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;textright shipping&quot;&gt;&lt;?php echo $products[&quot;shipping&quot;][&quot;name&quot;] ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;td class=&quot;shipping_amount&quot;&gt;&lt;?php echo GFCommon::to_money( $products[&quot;shipping&quot;][&quot;price&quot;], $lead[&quot;currency&quot;] ) ?&gt;&nbsp;</div></li><li><div>                                          &nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;/tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;tr&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                                  if ( empty( $products[&quot;shipping&quot;][&quot;name&quot;] ) ) {&nbsp;</div></li><li><div>                                      ?&gt;&nbsp;</div></li><li><div>                                      &lt;td colspan=&quot;2&quot; class=&quot;emptycell&quot;&gt;&nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                                      &lt;?php&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;textright grandtotal&quot;&gt;&lt;?php esc_html_e( &quot;Total&quot;, &quot;gravityforms&quot; ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                  &lt;td class=&quot;grandtotal_amount&quot;&gt;&lt;?php echo GFCommon::to_money( $total, $lead[&quot;currency&quot;] ) ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                              &lt;/tr&gt;&nbsp;</div></li><li><div>                              &lt;/tfoot&gt;&nbsp;</div></li><li><div>                          &lt;/table&gt;&nbsp;</div></li><li><div>                      &lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Edit link</span>&nbsp;</div></li><li><div>          if (&nbsp;</div></li><li><div>              ! empty( $options['useredit'] ) && is_user_logged_in() && intval( $current_user-&gt;ID ) === intval( $lead['created_by'] ) || <span class="comment">// Is user who created the entry</span>&nbsp;</div></li><li><div>              ! empty( $options['adminedit'] ) && self::has_access( &quot;gravityforms_directory&quot; ) <span class="comment">// Or is an administrator</span>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $options['adminedit'] ) && self::has_access( &quot;gravityforms_directory&quot; ) ) {&nbsp;</div></li><li><div>                  $editbuttontext = apply_filters( 'kws_gf_directory_edit_entry_text_admin', __( &quot;Edit Entry&quot;, 'gravity-forms-addons' ) );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $editbuttontext = apply_filters( 'kws_gf_directory_edit_entry_text_user', __( &quot;Edit Your Entry&quot;, 'gravity-forms-addons' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;tr&gt;&nbsp;</div></li><li><div>                  &lt;th scope=&quot;row&quot;&nbsp;</div></li><li><div>                      class=&quot;entry-view-field-name&quot;&gt;&lt;?php echo esc_html( apply_filters( 'kws_gf_directory_edit_entry_th', __( &quot;Edit&quot;, &quot;gravity-forms-addons&quot; ) ) ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;td class=&quot;entry-view-field-value useredit&quot;&gt;&lt;a&nbsp;</div></li><li><div>                          href=&quot;&lt;?php echo esc_url( add_query_arg( array( 'edit' =&gt; wp_create_nonce( 'edit' . $lead['id'] . $Form[&quot;id&quot;] ) ) ) ); ?&gt;&quot;&gt;&lt;?php echo $editbuttontext; ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                  &lt;/td&gt;&nbsp;</div></li><li><div>              &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;/tbody&gt;&nbsp;</div></li><li><div>      &lt;/table&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function get_admin_only( $form, $adminOnly = array() ) {&nbsp;</div></li><li><div>      if ( ! is_array( $form ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $form['fields'] as $key =&gt; $col ) {&nbsp;</div></li><li><div>          <span class="comment">// Only the Go to Entry button adds disableMargins.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $col['type'] === 'hidden' && ! empty( $col['useAsEntryLink'] ) && ! empty( $col['disableMargins'] ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! empty( $col['adminOnly'] ) ) {&nbsp;</div></li><li><div>              $adminOnly[] = $col['id'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( isset( $col['inputs'] ) && is_array( $col['inputs'] ) ) {&nbsp;</div></li><li><div>              foreach ( $col['inputs'] as $key2 =&gt; $input ) {&nbsp;</div></li><li><div>                  if ( ! empty( $col['adminOnly'] ) ) {&nbsp;</div></li><li><div>                      $adminOnly[] = $input['id'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $adminOnly;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  *     Get the form and lead IDs from the URL or from $_REQUEST</span>&nbsp;</div></li><li><div><span class="comment">  *    @return array|null $formid, $leadid if found. Null if not.</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  static private function get_form_and_lead_ids() {&nbsp;</div></li><li><div>      global $wp, $wp_rewrite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $formid = $leadid = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = isset( $wp-&gt;request ) ? $wp-&gt;request : add_query_arg( array(), home_url() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          <span class="comment">// If permalinks is turned on</span>&nbsp;</div></li><li><div>          $wp_rewrite-&gt;using_permalinks() &&&nbsp;</div></li><li><div>          <span class="comment">// And</span>&nbsp;</div></li><li><div>          preg_match( '/\/?' . sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) ) . '\/([0-9]+)(?:\/|-)([0-9]+)/ism', $url, $matches )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $formid = $matches[1];&nbsp;</div></li><li><div>          $leadid = $matches[2];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $formid = isset( $_REQUEST['form'] ) ? (int) $_REQUEST['form'] : $formid;&nbsp;</div></li><li><div>          $leadid = isset( $_REQUEST['leadid'] ) ? (int) $_REQUEST['leadid'] : $leadid;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array( $formid, $leadid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get_back_link function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $entryback (default: '') The text of the back-link anchor</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string The HTML link for the backlink</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function get_back_link( $passed_entryback = '' ) {&nbsp;</div></li><li><div>      global $pagenow, $wp_rewrite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $options = self::directory_defaults();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['edit'] ) ) {&nbsp;</div></li><li><div>          return '&lt;p class=&quot;entryback&quot;&gt;&lt;a href=&quot;' . esc_url( add_query_arg( array(), remove_query_arg( array( 'edit' ) ) ) ) . '&quot;&gt;' . esc_html( __( apply_filters( 'kws_gf_directory_edit_entry_cancel', &quot;&larr; Cancel Editing&quot; ), &quot;gravity-forms-addons&quot; ) ) . '&lt;/a&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $formid, $leadid ) = self::get_form_and_lead_ids();&nbsp;</div></li><li><div>      extract( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Use passed value, if available. Otherwise, use default</span>&nbsp;</div></li><li><div>      $entryback = ! empty( $passed_entryback ) ? $passed_entryback : $entryback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $pagenow === 'entry-details.php' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If possible, link back to the original post.</span>&nbsp;</div></li><li><div>          if ( isset( $_GET['post'] ) ) {&nbsp;</div></li><li><div>              $href = get_permalink( (int) $_GET['post'] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Otherwise we rely on Javascript below.</span>&nbsp;</div></li><li><div>              $href = '#';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $onclick = ' onclick=&quot;parent.jQuery.fn.colorbox.close();&quot;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $onclick = '';&nbsp;</div></li><li><div>          $href = remove_query_arg( array( 'row', 'leadid', 'form', 'edit' ) );&nbsp;</div></li><li><div>          if ( $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>              $href = preg_replace( '/(' . sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) ) . '\/(?:[0-9]+)(?:\/|-)(?:[0-9]+)\/?)/ism', '', $href );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $href = esc_url_raw( $href );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = parse_url( add_query_arg( array(), $href ) );&nbsp;</div></li><li><div>      if ( ! empty( $url['query'] ) && ! empty( $permalink ) ) {&nbsp;</div></li><li><div>          $href .= '?' . $url['query'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $options['entryanchor'] ) ) {&nbsp;</div></li><li><div>          $href .= '#lead_row_' . $leadid;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If there's a back link, format it</span>&nbsp;</div></li><li><div>      if ( ! empty( $entryback ) && ! empty( $entryonly ) ) {&nbsp;</div></li><li><div>          $link = apply_filters( 'kws_gf_directory_backlink', '&lt;p class=&quot;entryback&quot;&gt;&lt;a href=&quot;' . $href . '&quot;' . $onclick . '&gt;' . esc_html( $entryback ) . '&lt;/a&gt;&lt;/p&gt;', $href, $entryback );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $link = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $link;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function process_lead_detail( $inline = true, $entryback = '', $showadminonly = false, $adminonlycolumns = array(), $approvedcolumn = NULL, $options = array(), $entryonly = true ) {&nbsp;</div></li><li><div>      global $wp, $post, $wp_rewrite, $wpdb;&nbsp;</div></li><li><div>      $formid = $leadid = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $formid, $leadid ) = self::get_form_and_lead_ids();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_null( $leadid ) && ! is_null( $formid ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $form = apply_filters( 'kws_gf_directory_lead_detail_form', RGFormsModel::get_form_meta( (int) $formid ) );&nbsp;</div></li><li><div>          $lead = apply_filters( 'kws_gf_directory_lead_detail', RGFormsModel::get_lead( (int) $leadid ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $approvedcolumn ) ) {&nbsp;</div></li><li><div>              $approvedcolumn = self::get_approved_column( $form );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( empty( $adminonlycolumns ) && ! $showadminonly ) {&nbsp;</div></li><li><div>              $adminonlycolumns = self::get_admin_only( $form );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//since 3.5</span></span>&nbsp;</div></li><li><div>          $lead = self::remove_hidden_fields( array( $lead ), $adminonlycolumns, $approvedcolumn, true, true, $showadminonly, $form );&nbsp;</div></li><li><div>          $lead = $lead[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ob_start(); <span class="comment">// Using ob_start() allows us to filter output</span>&nbsp;</div></li><li><div>          self::lead_detail( $form, $lead, false, $inline, $options );&nbsp;</div></li><li><div>          $content = ob_get_contents(); <span class="comment"><span class="comment">// Get the output</span></span>&nbsp;</div></li><li><div>          ob_end_clean(); <span class="comment">// Clear the buffer</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the back link if this is a single entry.</span>&nbsp;</div></li><li><div>          $link = ! empty( $entryonly ) ? self::get_back_link( $entryback ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $content = $link . $content;&nbsp;</div></li><li><div>          $content = apply_filters( 'kws_gf_directory_detail', apply_filters( 'kws_gf_directory_detail_' . (int) $leadid, $content, (int) $leadid ), (int) $leadid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $options['entryview'] ) ) {&nbsp;</div></li><li><div>              $content = self::html_display_type_filter( $content, $options['entryview'], true );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $content;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function change_directory_columns() {&nbsp;</div></li><li><div>      check_ajax_referer( 'gforms_directory_columns', 'gforms_directory_columns' );&nbsp;</div></li><li><div>      $columns = GFCommon::json_decode( stripslashes( $_POST[&quot;directory_columns&quot;] ), true );&nbsp;</div></li><li><div>      self::update_grid_column_meta( (int) $_POST['form_id'], $columns );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function update_grid_column_meta( $form_id, $columns ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $meta = maybe_serialize( stripslashes_deep( $columns ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_option( 'gf_directory_form_' . $form_id . '_grid', $meta );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_grid_column_meta( $form_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $grid = get_option( 'gf_directory_form_' . $form_id . '_grid' );&nbsp;</div></li><li><div>      if ( ! $grid ) {&nbsp;</div></li><li><div>          $grid = GFFormsModel::get_grid_column_meta( $form_id );&nbsp;</div></li><li><div>          self::update_grid_column_meta( $form_id, $grid );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return maybe_unserialize( $grid );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_grid_columns( $form_id, $input_label_only = false ) {&nbsp;</div></li><li><div>      $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>      $field_ids = self::get_grid_column_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_array( $field_ids ) ) {&nbsp;</div></li><li><div>          $field_ids = array();&nbsp;</div></li><li><div>          for ( $i = 0, $count = sizeof( $form[&quot;fields&quot;] ); $i &lt; $count && $i &lt; 5; $i ++ ) {&nbsp;</div></li><li><div>              $field = $form[&quot;fields&quot;][ $i ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( RGForms::get( &quot;displayOnly&quot;, $field ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $field[&quot;inputs&quot;] ) && is_array( $field[&quot;inputs&quot;] ) ) {&nbsp;</div></li><li><div>                  $field_ids[] = $field[&quot;id&quot;];&nbsp;</div></li><li><div>                  if ( $field[&quot;type&quot;] == &quot;name&quot; ) {&nbsp;</div></li><li><div>                      $field_ids[] = $field[&quot;id&quot;] . '.3'; <span class="comment">//adding first name</span>&nbsp;</div></li><li><div>                      $field_ids[] = $field[&quot;id&quot;] . '.6'; <span class="comment">//adding last name</span>&nbsp;</div></li><li><div>                  } else if ( isset( $field[&quot;inputs&quot;][0] ) ) {&nbsp;</div></li><li><div>                      $field_ids[] = $field[&quot;inputs&quot;][0][&quot;id&quot;]; <span class="comment">//getting first input</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $field_ids[] = $field[&quot;id&quot;];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">//adding default entry meta columns</span>&nbsp;</div></li><li><div>          $entry_metas = GFFormsModel::get_entry_meta( $form_id );&nbsp;</div></li><li><div>          foreach ( $entry_metas as $key =&gt; $entry_meta ) {&nbsp;</div></li><li><div>              if ( rgar( $entry_meta, &quot;is_default_column&quot; ) ) {&nbsp;</div></li><li><div>                  $field_ids[] = $key;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $columns = array();&nbsp;</div></li><li><div>      $entry_meta = GFFormsModel::get_entry_meta( $form_id );&nbsp;</div></li><li><div>      foreach ( $field_ids as $field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $field_id ) {&nbsp;</div></li><li><div>              case &quot;id&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Entry Id&quot;, &quot;type&quot; =&gt; &quot;id&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;ip&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;User IP&quot;, &quot;type&quot; =&gt; &quot;ip&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;date_created&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Entry Date&quot;, &quot;type&quot; =&gt; &quot;date_created&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;source_url&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Source Url&quot;, &quot;type&quot; =&gt; &quot;source_url&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;payment_status&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Payment Status&quot;, &quot;type&quot; =&gt; &quot;payment_status&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;transaction_id&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Transaction Id&quot;, &quot;type&quot; =&gt; &quot;transaction_id&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;payment_date&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Payment Date&quot;, &quot;type&quot; =&gt; &quot;payment_date&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;payment_amount&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;Payment Amount&quot;, &quot;type&quot; =&gt; &quot;payment_amount&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;created_by&quot; :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; &quot;User&quot;, &quot;type&quot; =&gt; &quot;created_by&quot; );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case ( ( is_string( $field_id ) || is_int( $field_id ) ) && array_key_exists( $field_id, $entry_meta ) ) :&nbsp;</div></li><li><div>                  $columns[ $field_id ] = array( &quot;label&quot; =&gt; $entry_meta[ $field_id ][&quot;label&quot;], &quot;type&quot; =&gt; $field_id );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>                  $field = GFFormsModel::get_field( $form, $field_id );&nbsp;</div></li><li><div>                  if ( $field ) {&nbsp;</div></li><li><div>                      $columns[ strval( $field_id ) ] = array(&nbsp;</div></li><li><div>                          &quot;label&quot; =&gt; self::get_label( $field, $field_id, $input_label_only ), &nbsp;</div></li><li><div>                          &quot;type&quot; =&gt; rgget( &quot;type&quot;, $field ), &nbsp;</div></li><li><div>                          &quot;inputType&quot; =&gt; rgget( &quot;inputType&quot;, $field ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $columns;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the label for the input field. This is necessary to prevent Admin Labels from being used instead of normal labels.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_label( $field, $input_id = 0, $input_only = false ) {&nbsp;</div></li><li><div>      $field_label = rgar( $field, &quot;label&quot; );&nbsp;</div></li><li><div>      $input = GFFormsModel::get_input( $field, $input_id );&nbsp;</div></li><li><div>      if ( rgget( &quot;type&quot;, $field ) == &quot;checkbox&quot; && $input != NULL ) {&nbsp;</div></li><li><div>          return $input[&quot;label&quot;];&nbsp;</div></li><li><div>      } else if ( $input != NULL ) {&nbsp;</div></li><li><div>          return $input_only ? $input[&quot;label&quot;] : $field_label . ' (' . $input[&quot;label&quot;] . ')';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $field_label;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function make_directory( $atts ) {&nbsp;</div></li><li><div>      global $wpdb, $wp_rewrite, $post, $wpdb, $directory_shown, $kws_gf_scripts, $kws_gf_styles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFEntryDetail' ) ) {&nbsp;</div></li><li><div>          @require_once( GFCommon::get_base_path() . &quot;/entry_detail.php&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFCommon' ) ) {&nbsp;</div></li><li><div>          @require_once( GFCommon::get_base_path() . &quot;/common.php&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! class_exists( 'RGFormsModel' ) ) {&nbsp;</div></li><li><div>          @require_once( GFCommon::get_base_path() . &quot;/forms_model.php&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFEntryList' ) ) {&nbsp;</div></li><li><div>          require_once( GFCommon::get_base_path() . &quot;/entry_list.php&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//quit if version of wp is not supported</span>&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFCommon' ) || ! GFCommon::ensure_wp_version() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Already showed edit directory form and there are more than one forms on the page.</span>&nbsp;</div></li><li><div>      if ( did_action( 'kws_gf_directory_post_after_edit_lead_form' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start(); <span class="comment">// Using ob_start() allows us to use echo instead of $output .=</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $atts as $key =&gt; $att ) {&nbsp;</div></li><li><div>          if ( strtolower( $att ) == 'false' ) {&nbsp;</div></li><li><div>              $atts[ $key ] = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( strtolower( $att ) == 'true' ) {&nbsp;</div></li><li><div>              $atts[ $key ] = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $atts['approved'] = isset( $atts['approved'] ) ? $atts['approved'] : - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $atts['lightboxsettings'] ) && is_string( $atts['lightboxsettings'] ) ) {&nbsp;</div></li><li><div>          $atts['lightboxsettings'] = explode( ', ', $atts['lightboxsettings'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $options = self::directory_defaults( $atts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Make sure everything is on the same page.</span>&nbsp;</div></li><li><div>      if ( is_array( $options['lightboxsettings'] ) ) {&nbsp;</div></li><li><div>          foreach ( $options['lightboxsettings'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( is_numeric( $key ) ) {&nbsp;</div></li><li><div>                  $options['lightboxsettings'][&quot;{$value}&quot;] = $value;&nbsp;</div></li><li><div>                  unset( $options['lightboxsettings'][&quot;{$key}&quot;] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      extract( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_id = $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $form ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sort_field = empty( $_GET[&quot;sort&quot;] ) ? $sort : $_GET[&quot;sort&quot;];&nbsp;</div></li><li><div>      $sort_direction = empty( $_GET[&quot;dir&quot;] ) ? $dir : $_GET[&quot;dir&quot;];&nbsp;</div></li><li><div>      $search_query = ! empty( $_GET[&quot;gf_search&quot;] ) ? $_GET[&quot;gf_search&quot;] : NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $start_date = ! empty( $_GET[&quot;start_date&quot;] ) ? $_GET[&quot;start_date&quot;] : $start_date;&nbsp;</div></li><li><div>      $end_date = ! empty( $_GET[&quot;end_date&quot;] ) ? $_GET[&quot;end_date&quot;] : $end_date;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $page_index = empty( $_GET[&quot;pagenum&quot;] ) ? $startpage - 1 : intval( $_GET[&quot;pagenum&quot;] ) - 1;&nbsp;</div></li><li><div>      $star = ( isset( $_GET[&quot;star&quot;] ) && is_numeric( $_GET[&quot;star&quot;] ) ) ? intval( $_GET[&quot;star&quot;] ) : NULL;&nbsp;</div></li><li><div>      $read = ( isset( $_GET[&quot;read&quot;] ) && is_numeric( $_GET[&quot;read&quot;] ) ) ? intval( $_GET[&quot;read&quot;] ) : NULL;&nbsp;</div></li><li><div>      $first_item_index = $page_index * $page_size;&nbsp;</div></li><li><div>      $link_params = array();&nbsp;</div></li><li><div>      if ( ! empty( $page_index ) ) {&nbsp;</div></li><li><div>          $link_params['pagenum'] = $page_index;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $formaction = esc_url_raw( remove_query_arg( array(&nbsp;</div></li><li><div>          'gf_search', &nbsp;</div></li><li><div>          'sort', &nbsp;</div></li><li><div>          'dir', &nbsp;</div></li><li><div>          'pagenum', &nbsp;</div></li><li><div>          'edit', &nbsp;</div></li><li><div> ), add_query_arg( $link_params ) ) );&nbsp;</div></li><li><div>      $tableclass .= ! empty( $jstable ) ? sprintf( ' tablesorter tablesorter-%s', apply_filters( 'kws_gf_tablesorter_theme', 'blue', $form ) ) : '';&nbsp;</div></li><li><div>      $title = $form[&quot;title&quot;];&nbsp;</div></li><li><div>      $sort_field_meta = RGFormsModel::get_field( $form, $sort_field );&nbsp;</div></li><li><div>      $is_numeric = $sort_field_meta[&quot;type&quot;] == &quot;number&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $columns = self::get_grid_columns( $form_id, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $approvedcolumn = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( ! $approved && $approved !== - 1 ) || ( ! empty( $smartapproval ) && $approved === - 1 ) ) {&nbsp;</div></li><li><div>          $approvedcolumn = self::get_approved_column( $form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $smartapproval ) && $approved === - 1 && ! empty( $approvedcolumn ) ) {&nbsp;</div></li><li><div>          $approved = true; <span class="comment">// If there is an approved column, turn on approval</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $approved = false; <span class="comment">// Otherwise, show entries as normal.</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $entrylinkcolumns = self::get_entrylink_column( $form, $entry );&nbsp;</div></li><li><div>      $adminonlycolumns = self::get_admin_only( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      // Show only a single entry</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      $detail = self::process_lead_detail( true, $entryback, $showadminonly, $adminonlycolumns, $approvedcolumn, $options, $entryonly );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $entry ) && ! empty( $detail ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Once again, checking to make sure this hasn't been shown already with multiple shortcodes on one page.</span>&nbsp;</div></li><li><div>          if ( ! did_action( 'kws_gf_after_directory' ) ) {&nbsp;</div></li><li><div>              echo $detail;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $entryonly ) ) {&nbsp;</div></li><li><div>              do_action( 'kws_gf_after_directory', do_action( 'kws_gf_after_directory_form_' . $form_id, $form, compact( &quot;approved&quot;, &quot;sort_field&quot;, &quot;sort_direction&quot;, &quot;search_query&quot;, &quot;first_item_index&quot;, &quot;page_size&quot;, &quot;star&quot;, &quot;read&quot;, &quot;is_numeric&quot;, &quot;start_date&quot;, &quot;end_date&quot; ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $content = ob_get_clean(); <span class="comment"><span class="comment">// Get the output</span></span> and clear the buffer&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// If the form is form #2, two filters are applied: `kws_gf_directory_output_2` and `kws_gf_directory_output`</span></span>&nbsp;</div></li><li><div>              $content = apply_filters( 'kws_gf_directory_output', apply_filters( 'kws_gf_directory_output_' . $form_id, self::html_display_type_filter( $content, $directoryview ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $content;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// since 3.5 - remove columns of the fields not allowed to be shown</span>&nbsp;</div></li><li><div>      $columns = self::remove_hidden_fields( $columns, $adminonlycolumns, $approvedcolumn, false, false, $showadminonly, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// hook for external selection of columns</span>&nbsp;</div></li><li><div>      $columns = apply_filters( 'kws_gf_directory_filter_columns', $columns );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//since 3.5</span></span> search criteria&nbsp;</div></li><li><div>      $show_search_filters = self::get_search_filters( $form );&nbsp;</div></li><li><div>      $show_search_filters = apply_filters( 'kws_gf_directory_search_filters', $show_search_filters, $form );&nbsp;</div></li><li><div>      $search_criteria = array();&nbsp;</div></li><li><div>      foreach ( $show_search_filters as $key ) {&nbsp;</div></li><li><div>          if ( ! empty( $_GET[ 'filter_' . $key ] ) ) {&nbsp;</div></li><li><div>              $search_criteria[ $key ] = $_GET[ 'filter_' . $key ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      // Or start to generate the directory</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      $leads = GFDirectory::get_leads( $form_id, $sort_field, $sort_direction, $search_query, $first_item_index, $page_size, $star, $read, $is_numeric, $start_date, $end_date, 'active', $approvedcolumn, $limituser, $search_criteria );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Allow lightbox to determine whether showadminonly is valid without passing a query string in URL</span>&nbsp;</div></li><li><div>      if ( $entry === true && ! empty( $lightboxsettings['entry'] ) ) {&nbsp;</div></li><li><div>          if ( get_site_transient( 'gf_form_' . $form_id . '_post_' . $post-&gt;ID . '_showadminonly' ) != $showadminonly ) {&nbsp;</div></li><li><div>              set_site_transient( 'gf_form_' . $form_id . '_post_' . $post-&gt;ID . '_showadminonly', $showadminonly, HOUR_IN_SECONDS );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          delete_site_transient( 'gf_form_' . $form_id . '_post_' . $post-&gt;ID . '_showadminonly' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get a list of query args for the pagination links</span>&nbsp;</div></li><li><div>      if ( ! empty( $search_query ) ) {&nbsp;</div></li><li><div>          $args[&quot;gf_search&quot;] = urlencode( $search_query );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $sort_field ) ) {&nbsp;</div></li><li><div>          $args[&quot;sort&quot;] = $sort_field;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $sort_direction ) ) {&nbsp;</div></li><li><div>          $args[&quot;dir&quot;] = $sort_direction;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $star ) ) {&nbsp;</div></li><li><div>          $args[&quot;star&quot;] = $star;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $page_size &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// $leads contains all the entries according to request, since 3.5, to allow multisort.</span>&nbsp;</div></li><li><div>          if ( apply_filters( 'kws_gf_directory_want_multisort', false ) ) {&nbsp;</div></li><li><div>              $lead_count = count( $leads );&nbsp;</div></li><li><div>              $leads = array_slice( $leads, $first_item_index, $page_size );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $lead_count = self::get_lead_count( $form_id, $search_query, $star, $read, $approvedcolumn, $approved, $leads, $start_date, $end_date, $limituser, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $page_links = array(&nbsp;</div></li><li><div>              'base' =&gt; esc_url_raw( @add_query_arg( 'pagenum', '%#%' ) ), <span class="comment">// get_permalink().'%_%', </span>&nbsp;</div></li><li><div>              'format' =&gt; '&pagenum=%#%', &nbsp;</div></li><li><div>              'add_args' =&gt; $args, &nbsp;</div></li><li><div>              'prev_text' =&gt; $prev_text, &nbsp;</div></li><li><div>              'next_text' =&gt; $next_text, &nbsp;</div></li><li><div>              'total' =&gt; ceil( $lead_count / $page_size ), &nbsp;</div></li><li><div>              'current' =&gt; $page_index + 1, &nbsp;</div></li><li><div>              'show_all' =&gt; $pagelinksshowall, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $page_links = apply_filters( 'kws_gf_results_pagination', $page_links );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $page_links = paginate_links( $page_links );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Showing all results</span>&nbsp;</div></li><li><div>          $page_links = false;&nbsp;</div></li><li><div>          $lead_count = sizeof( $leads );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $directory_shown ) ) {&nbsp;</div></li><li><div>          $directory_shown = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;script&gt;&nbsp;</div></li><li><div>              &lt;?php if(! empty( $lightboxsettings['images'] ) || ! empty( $lightboxsettings['entry'] )) { ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              var tb_pathToImage = &quot;&lt;?php echo site_url( '/wp-includes/js/thickbox/loadingAnimation.gif' ); ?&gt;&quot;;&nbsp;</div></li><li><div>              var tb_closeImage = &quot;&lt;?php echo site_url( '/wp-includes/js/thickbox/tb-close.png' ); ?&gt;&quot;;&nbsp;</div></li><li><div>              var tb_height = 600;&nbsp;</div></li><li><div>              &lt;?php } ?&gt;&nbsp;</div></li><li><div>              function not_empty( variable ) {&nbsp;</div></li><li><div>                  if ( variable == '' || variable == null || variable == 'undefined' || typeof(variable) == 'undefined' ) {&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;?php if(! empty( $jstable )) { ?&gt;&nbsp;</div></li><li><div>              jQuery( document ).ready( function ( $ ) {&nbsp;</div></li><li><div>                  $( '.tablesorter' ).each( function () {&nbsp;</div></li><li><div>                      $( this ).tablesorter(&lt;?php echo apply_filters( 'kws_gf_directory_tablesorter_options', '' ) ?&gt;);&nbsp;</div></li><li><div>                  } );&nbsp;</div></li><li><div>              } );&nbsp;</div></li><li><div>              &lt;?php } else if(isset( $jssearch ) && $jssearch) { ?&gt;&nbsp;</div></li><li><div>              function Search( search, sort_field_id, sort_direction, search_criteria ) {&nbsp;</div></li><li><div>                  if ( not_empty( search ) ) {&nbsp;</div></li><li><div>                      var search = &quot;&gf_search=&quot; + encodeURIComponent( search );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      var search = '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  var search_filters = '';&nbsp;</div></li><li><div>                  if ( not_empty( search_criteria ) ) {&nbsp;</div></li><li><div>                      $.each( search_criteria, function ( index, value ) {&nbsp;</div></li><li><div>                          search_filters += &quot;&filter_&quot; + index + &quot;=&quot; + encodeURIComponent( value );&nbsp;</div></li><li><div>                      } );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( not_empty( sort_field_id ) ) {&nbsp;</div></li><li><div>                      var sort = &quot;&sort=&quot; + sort_field_id;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      var sort = '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ( not_empty( sort_direction ) ) {&nbsp;</div></li><li><div>                      var dir = &quot;&dir=&quot; + sort_direction;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      var dir = '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  var page = '&lt;?php if ( $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>                          echo '?';&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          echo '&';&nbsp;</div></li><li><div>                      } ?&gt;page=' +&lt;?php echo isset( $_GET['pagenum'] ) ? intval( $_GET['pagenum'] ) : '&quot;1&quot;'; ?&gt;;&nbsp;</div></li><li><div>                  var location = &quot;&lt;?php echo get_permalink( $post-&gt;ID ); ?&gt;&quot; + page + search + sort + dir + search_filters;&nbsp;</div></li><li><div>                  document.location = location;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &lt;?php } ?&gt;&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php if ( $titleshow ) : ?&gt;&nbsp;</div></li><li><div>              &lt;h2&gt;&lt;?php echo $titleprefix . $title; ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php <span class="comment">// --- Render Search Box ---</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $search || ! empty( $show_search_filters ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;form id=&quot;lead_form&quot; method=&quot;get&quot; action=&quot;&lt;?php echo $formaction; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  <span class="comment">//New logic for search criterias (since 3.5)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $show_search_filters ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $show_search_filters as $key ) {&nbsp;</div></li><li><div>                          $properties = self::get_field_properties( $form, $key );&nbsp;</div></li><li><div>                          if ( in_array( $properties['type'], array(&nbsp;</div></li><li><div>                              'select', &nbsp;</div></li><li><div>                              'checkbox', &nbsp;</div></li><li><div>                              'radio', &nbsp;</div></li><li><div>                              'post_category', &nbsp;</div></li><li><div> ) ) ) {&nbsp;</div></li><li><div>                              echo self::render_search_dropdown( $properties['label'], 'filter_' . $properties['id'], $properties['choices'] ); <span class="comment">//Label, name attr, choices</span>&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              echo self::render_search_input( $properties['label'], 'filter_' . $properties['id'] ); <span class="comment">//label, attr name</span>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;search-box&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php if ( $search ) : ?&gt;&nbsp;</div></li><li><div>                          &lt;label class=&quot;hidden&quot;&nbsp;</div></li><li><div>                                 for=&quot;lead_search&quot;&gt;&lt;?php esc_html_e( &quot;Search Entries:&quot;, &quot;gravity-forms-addons&quot; ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                          &lt;input type=&quot;text&quot; name=&quot;gf_search&quot; id=&quot;lead_search&quot;&nbsp;</div></li><li><div>                                 value=&quot;&lt;?php echo $search_query ?&gt;&quot;&lt;?php if ( $searchtabindex ) {&nbsp;</div></li><li><div>                              echo ' tabindex=&quot;' . intval( $searchtabindex ) . '&quot;';&nbsp;</div></li><li><div>                          } ?&gt; /&gt;&nbsp;</div></li><li><div>                      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      <span class="comment">// If not using permalinks, let's make the form work!</span>&nbsp;</div></li><li><div>                      echo ! empty( $_GET['p'] ) ? '&lt;input name=&quot;p&quot; type=&quot;hidden&quot; value=&quot;' . esc_html( $_GET['p'] ) . '&quot; /&gt;' : '';&nbsp;</div></li><li><div>                      echo ! empty( $_GET['page_id'] ) ? '&lt;input name=&quot;page_id&quot; type=&quot;hidden&quot; value=&quot;' . esc_html( $_GET['page_id'] ) . '&quot; /&gt;' : '';&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;submit&quot; class=&quot;button&quot; id=&quot;lead_search_button&quot;&nbsp;</div></li><li><div>                             value=&quot;&lt;?php esc_attr_e( &quot;Search&quot;, &quot;gravity-forms-addons&quot; ) ?&gt;&quot;&lt;?php if ( $searchtabindex ) {&nbsp;</div></li><li><div>                          echo ' tabindex=&quot;' . intval( $searchtabindex ++ ) . '&quot;';&nbsp;</div></li><li><div>                      } ?&gt; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;&nbsp;</div></li><li><div>              &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//Displaying paging links if appropriate</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $lead_count &gt; 0 && $showcount || $page_links ) {&nbsp;</div></li><li><div>              if ( $lead_count == 0 ) {&nbsp;</div></li><li><div>                  $first_item_index --;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;tablenav-pages&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php if ( $showcount ) {&nbsp;</div></li><li><div>                          if ( ( $first_item_index + $page_size ) &gt; $lead_count || $page_size &lt;= 0 ) {&nbsp;</div></li><li><div>                              $second_part = $lead_count;&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $second_part = $first_item_index + $page_size;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;span&nbsp;</div></li><li><div>                              class=&quot;displaying-num&quot;&gt;&lt;?php printf( __( &quot;Displaying %d - %d of %d&quot;, &quot;gravity-forms-addons&quot; ), $first_item_index + 1, $second_part, $lead_count ) ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                      &lt;?php }&nbsp;</div></li><li><div>                      if ( $page_links ) {&nbsp;</div></li><li><div>                          echo $page_links;&nbsp;</div></li><li><div>                      } ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'kws_gf_before_directory_after_nav', do_action( 'kws_gf_before_directory_after_nav_form_' . $form_id, $form, $leads, compact( &quot;approved&quot;, &quot;sort_field&quot;, &quot;sort_direction&quot;, &quot;search_query&quot;, &quot;first_item_index&quot;, &quot;page_size&quot;, &quot;star&quot;, &quot;read&quot;, &quot;is_numeric&quot;, &quot;start_date&quot;, &quot;end_date&quot; ) ) );&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;table class=&quot;&lt;?php echo $tableclass; ?&gt;&quot; cellspacing=&quot;0&quot;&lt;?php if ( ! empty( $tablewidth ) ) {&nbsp;</div></li><li><div>              echo ' width=&quot;' . $tablewidth . '&quot;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo $tablestyle ? ' style=&quot;' . $tablestyle . '&quot;' : ''; ?&gt;&gt;&nbsp;</div></li><li><div>              &lt;?php if ( $thead ) { ?&gt;&nbsp;</div></li><li><div>                  &lt;thead&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $addressesExist = false;&nbsp;</div></li><li><div>                      foreach ( $columns as $field_id =&gt; $field_info ) {&nbsp;</div></li><li><div>                          $dir = $field_id == 0 ? &quot;DESC&quot; : &quot;ASC&quot;; <span class="comment"><span class="comment">//default every field so ascending sorting except date_created (id=0)</span></span>&nbsp;</div></li><li><div>                          if ( $field_id == $sort_field ) { <span class="comment"><span class="comment">//reverting direction if clicking on the currently sorted field</span></span>&nbsp;</div></li><li><div>                              $dir = $sort_direction == &quot;ASC&quot; ? &quot;DESC&quot; : &quot;ASC&quot;;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          if ( is_array( $adminonlycolumns ) && ! in_array( $field_id, $adminonlycolumns ) || ( is_array( $adminonlycolumns ) && in_array( $field_id, $adminonlycolumns ) && $showadminonly ) || ! $showadminonly ) {&nbsp;</div></li><li><div>                              if ( $field_info['type'] == 'address' && $appendaddress && $hideaddresspieces ) {&nbsp;</div></li><li><div>                                  $addressesExist = true;&nbsp;</div></li><li><div>                                  continue;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                              $_showlink = false;&nbsp;</div></li><li><div>                              if ( isset( $jssearch ) && $jssearch && ! isset( $jstable ) ) { ?&gt;&nbsp;</div></li><li><div>                                  &lt;th scope=&quot;col&quot; id=&quot;gf-col-&lt;?php echo $form_id . '-' . $field_id ?&gt;&quot; class=&quot;manage-column&quot; onclick=&quot;Search('&lt;?php echo $search_query ?&gt;', '&lt;?php echo $field_id ?&gt;', '&lt;?php echo $dir ?&gt;', '' );&quot; style=&quot;cursor:pointer;&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                              } elseif ( isset( $jstable ) && $jstable || $field_info['type'] === 'id' ) { ?&gt;&nbsp;</div></li><li><div>                                  &lt;th scope=&quot;col&quot; id=&quot;gf-col-&lt;?php echo $form_id . '-' . $field_id ?&gt;&quot; class=&quot;manage-column&quot;&gt;&nbsp;</div></li><li><div>                              &lt;?php } else {&nbsp;</div></li><li><div>                                  $_showlink = true;&nbsp;</div></li><li><div>                                  ?&gt;&nbsp;</div></li><li><div>                                  &lt;th scope=&quot;col&quot; id=&quot;gf-col-&lt;?php echo $form_id . '-' . $field_id ?&gt;&quot; class=&quot;manage-column&quot;&gt;&nbsp;</div></li><li><div>                                  &lt;a href=&quot;&lt;?php&nbsp;</div></li><li><div>                                  $searchpage = isset( $_GET['pagenum'] ) ? intval( $_GET['pagenum'] ) : 1;&nbsp;</div></li><li><div>                                  $new_query_args = array(&nbsp;</div></li><li><div>                                      'gf_search' =&gt; $search_query, &nbsp;</div></li><li><div>                                      'sort' =&gt; $field_id, &nbsp;</div></li><li><div>                                      'dir' =&gt; $dir, &nbsp;</div></li><li><div>                                      'pagenum' =&gt; $searchpage, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                  foreach ( $search_criteria as $key =&gt; $value ) {&nbsp;</div></li><li><div>                                      $new_query_args[ 'filter_' . $key ] = $value;&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  echo add_query_arg( $new_query_args, get_permalink( $post-&gt;ID ) );&nbsp;</div></li><li><div>                                  ?&gt;&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ( $field_info['type'] == 'id' && $entry ) {&nbsp;</div></li><li><div>                                  $label = $entryth;&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $label = $field_info[&quot;label&quot;];&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $label = apply_filters( 'kws_gf_directory_th', apply_filters( 'kws_gf_directory_th_' . $field_id, apply_filters( 'kws_gf_directory_th_' . sanitize_title( $label ), $label ) ) );&nbsp;</div></li><li><div>                              echo esc_html( $label );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( $_showlink ) { ?&gt;&lt;/a&gt;&lt;?php } ?&gt;&nbsp;</div></li><li><div>                              &lt;/th&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $appendaddress && $addressesExist ) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;gf-col-&lt;?php echo $form_id . '-' . $field_id ?&gt;&quot; class=&quot;manage-column&quot;&nbsp;</div></li><li><div>                              onclick=&quot;Search('&lt;?php echo $search_query ?&gt;', '&lt;?php echo $field_id ?&gt;', '&lt;?php echo $dir ?&gt;');&quot;&nbsp;</div></li><li><div>                              style=&quot;cursor:pointer;&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                              $label = apply_filters( 'kws_gf_directory_th', apply_filters( 'kws_gf_directory_th_address', 'Address' ) );&nbsp;</div></li><li><div>                              echo esc_html( $label )&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;/thead&gt;&nbsp;</div></li><li><div>              &lt;?php } ?&gt;&nbsp;</div></li><li><div>              &lt;tbody class=&quot;list:user user-list&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              include( plugin_dir_path( __FILE__ ) . &quot;/template-row.php&quot; );&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;/tbody&gt;&nbsp;</div></li><li><div>              &lt;?php if ( $tfoot ) {&nbsp;</div></li><li><div>                  if ( isset( $jssearch ) && $jssearch && ! isset( $jstable ) ) {&nbsp;</div></li><li><div>                      $th = '&lt;th scope=&quot;col&quot; id=&quot;gf-col-' . $form_id . '-' . $field_id . '&quot; class=&quot;manage-column&quot; onclick=&quot;Search(\'' . $search_query . '\', \'' . $field_id . '\', \'' . $dir . '\');&quot; style=&quot;cursor:pointer;&quot;&gt;';&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $th = '&lt;th scope=&quot;col&quot; id=&quot;gf-col-' . $form_id . '-' . $field_id . '&quot; class=&quot;manage-column&quot;&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;tfoot&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      $addressesExist = false;&nbsp;</div></li><li><div>                      foreach ( $columns as $field_id =&gt; $field_info ) {&nbsp;</div></li><li><div>                      $dir = $field_id == 0 ? &quot;DESC&quot; : &quot;ASC&quot;; <span class="comment"><span class="comment">//default every field so ascending sorting except date_created (id=0)</span></span>&nbsp;</div></li><li><div>                      if ( $field_id == $sort_field ) { <span class="comment"><span class="comment">//reverting direction if clicking on the currently sorted field</span></span>&nbsp;</div></li><li><div>                          $dir = $sort_direction == &quot;ASC&quot; ? &quot;DESC&quot; : &quot;ASC&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ( is_array( $adminonlycolumns ) && ! in_array( $field_id, $adminonlycolumns ) || ( is_array( $adminonlycolumns ) && in_array( $field_id, $adminonlycolumns ) && $showadminonly ) || ! $showadminonly ) {&nbsp;</div></li><li><div>                      if ( $field_info['type'] == 'address' && $appendaddress && $hideaddresspieces ) {&nbsp;</div></li><li><div>                          $addressesExist = true;&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo $th;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $field_info['type'] == 'id' && $entry ) {&nbsp;</div></li><li><div>                          $label = $entryth;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $label = $field_info[&quot;label&quot;];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $label = apply_filters( 'kws_gf_directory_th', apply_filters( 'kws_gf_directory_th_' . $field_id, apply_filters( 'kws_gf_directory_th_' . sanitize_title( $label ), $label ) ) );&nbsp;</div></li><li><div>                      echo esc_html( $label )&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ( $appendaddress && $addressesExist ) {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;th scope=&quot;col&quot; id=&quot;gf-col-&lt;?php echo $form_id . '-' . $field_id ?&gt;&quot; class=&quot;manage-column&quot;&nbsp;</div></li><li><div>                              onclick=&quot;Search('&lt;?php echo $search_query ?&gt;', '&lt;?php echo $field_id ?&gt;', '&lt;?php echo $dir ?&gt;');&quot;&nbsp;</div></li><li><div>                              style=&quot;cursor:pointer;&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                              $label = apply_filters( 'kws_gf_directory_th', apply_filters( 'kws_gf_directory_th_address', 'Address' ) );&nbsp;</div></li><li><div>                              echo esc_html( $label )&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                          &lt;?php&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;?php if ( ! empty( $credit ) ) {&nbsp;</div></li><li><div>                      self::get_credit_link( sizeof( $columns ), $options );&nbsp;</div></li><li><div>                  } ?&gt;&nbsp;</div></li><li><div>                  &lt;/tfoot&gt;&nbsp;</div></li><li><div>              &lt;?php } ?&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'kws_gf_after_directory_before_nav', do_action( 'kws_gf_after_directory_before_nav_form_' . $form_id, $form, $leads, compact( &quot;approved&quot;, &quot;sort_field&quot;, &quot;sort_direction&quot;, &quot;search_query&quot;, &quot;first_item_index&quot;, &quot;page_size&quot;, &quot;star&quot;, &quot;read&quot;, &quot;is_numeric&quot;, &quot;start_date&quot;, &quot;end_date&quot; ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//Displaying paging links if appropriate</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $lead_count &gt; 0 && $showcount || $page_links ) {&nbsp;</div></li><li><div>              if ( $lead_count == 0 ) {&nbsp;</div></li><li><div>                  $first_item_index --;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;tablenav-pages&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php if ( $showcount ) {&nbsp;</div></li><li><div>                          if ( ( $first_item_index + $page_size ) &gt; $lead_count || $page_size &lt;= 0 ) {&nbsp;</div></li><li><div>                              $second_part = $lead_count;&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $second_part = $first_item_index + $page_size;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                          &lt;span&nbsp;</div></li><li><div>                              class=&quot;displaying-num&quot;&gt;&lt;?php printf( __( &quot;Displaying %d - %d of %d&quot;, &quot;gravity-forms-addons&quot; ), $first_item_index + 1, $second_part, $lead_count ) ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                      &lt;?php }&nbsp;</div></li><li><div>                      if ( $page_links ) {&nbsp;</div></li><li><div>                          echo $page_links;&nbsp;</div></li><li><div>                      } ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      if ( empty( $credit ) ) {&nbsp;</div></li><li><div>          echo &quot;\n&quot; . '&lt;!-- Directory generated by Gravity Forms Directory & Addons : http:<span class="comment">//wordpress.org/extend/plugins/gravity-forms-addons/ --&gt;' . &quot;\n&quot;;</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'kws_gf_after_directory', do_action( 'kws_gf_after_directory_form_' . $form_id, $form, $leads, compact( &quot;approved&quot;, &quot;sort_field&quot;, &quot;sort_direction&quot;, &quot;search_query&quot;, &quot;first_item_index&quot;, &quot;page_size&quot;, &quot;star&quot;, &quot;read&quot;, &quot;is_numeric&quot;, &quot;start_date&quot;, &quot;end_date&quot; ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = ob_get_contents(); <span class="comment"><span class="comment">// Get the output</span></span>&nbsp;</div></li><li><div>      ob_end_clean(); <span class="comment">// Clear the cache</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If the form is form #2, two filters are applied: `kws_gf_directory_output_2` and `kws_gf_directory_output`</span></span>&nbsp;</div></li><li><div>      $content = apply_filters( 'kws_gf_directory_output', apply_filters( 'kws_gf_directory_output_' . $form_id, self::html_display_type_filter( $content, $directoryview ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content; <span class="comment">// Return it!</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render image link HTML</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.7</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  [type] $url         [description]</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $title [description]</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $caption [description]</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $description [description]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return [type]              [description]</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static private function render_image_link( $url, $lead, $options, $title = '', $caption = '', $description = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      extract( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $target = ( $linknewwindow && empty( $lightboxsettings['images'] ) ) ? ' target=&quot;_blank&quot;' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $size = false;&nbsp;</div></li><li><div>      if ( ! empty( $options['getimagesize'] ) ) {&nbsp;</div></li><li><div>          $size = @getimagesize( $url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//displaying thumbnail (if file is an image) or an icon based on the extension</span>&nbsp;</div></li><li><div>      $icon = GFEntryList::get_icon_url( $url );&nbsp;</div></li><li><div>      if ( ! preg_match( '/icon\_image\.gif/ism', $icon ) ) {&nbsp;</div></li><li><div>          $src = $icon;&nbsp;</div></li><li><div>          if ( ! empty( $size ) ) {&nbsp;</div></li><li><div>              $img = &quot;&lt;img src='$src' {$size[3]}/&gt;&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $img = &quot;&lt;img src='$src' /&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else { <span class="comment">// No thickbox for non-images please</span>&nbsp;</div></li><li><div>          switch ( strtolower( trim( $options['postimage'] ) ) ) {&nbsp;</div></li><li><div>              case 'image':&nbsp;</div></li><li><div>                  $src = $url;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'icon':&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $src = $icon;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $img = array(&nbsp;</div></li><li><div>          'src' =&gt; $src, &nbsp;</div></li><li><div>          'size' =&gt; $size, &nbsp;</div></li><li><div>          'title' =&gt; $title, &nbsp;</div></li><li><div>          'caption' =&gt; $caption, &nbsp;</div></li><li><div>          'description' =&gt; $description, &nbsp;</div></li><li><div>          'url' =&gt; esc_url_raw( $url ), &nbsp;</div></li><li><div>          'code' =&gt; isset( $size[3] ) ? &quot;&lt;img src='$src' {$size[3]} /&gt;&quot; : &quot;&lt;img src='$src' /&gt;&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $img = apply_filters( 'kws_gf_directory_lead_image', apply_filters( 'kws_gf_directory_lead_image_' . $options['postimage'], apply_filters( 'kws_gf_directory_lead_image_' . $lead['id'], $img ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lightboxclass = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $lightboxsettings['images'] ) && self::is_image_file( $url ) ) {&nbsp;</div></li><li><div>          if ( wp_script_is( 'colorbox', 'registered' ) ) {&nbsp;</div></li><li><div>              $lightboxclass = ' class=&quot;colorbox lightbox&quot;';&nbsp;</div></li><li><div>          } else if ( wp_script_is( 'thickbox', 'registered' ) ) {&nbsp;</div></li><li><div>              $lightboxclass = ' class=&quot;thickbox lightbox&quot;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( in_array( 'images', $lightboxsettings ) || ! empty( $lightboxsettings['images'] ) ) {&nbsp;</div></li><li><div>              $lightboxclass .= ' rel=&quot;directory_all directory_images&quot;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $value = &quot;&lt;a href='{$url}'{$target}{$lightboxclass}&gt;{$img['code']}&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $value = apply_filters( 'kws_gf_directory_render_image_link', $value, $url, $lead, $options, $title, $caption, $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Verify that the src URL matches image patterns.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean     True: matches pattern; False: does not match pattern.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_image_file( $src ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info = pathinfo( $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $image_exts = apply_filters( 'kws_gf_directory_image_extensions', array(&nbsp;</div></li><li><div>          'jpg', &nbsp;</div></li><li><div>          'jpeg', &nbsp;</div></li><li><div>          'jpe', &nbsp;</div></li><li><div>          'gif', &nbsp;</div></li><li><div>          'png', &nbsp;</div></li><li><div>          'bmp', &nbsp;</div></li><li><div>          'tif', &nbsp;</div></li><li><div>          'tiff', &nbsp;</div></li><li><div>          'ico', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return isset( $info['extension'] ) && in_array( strtolower( $info['extension'] ), $image_exts );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * render_search_dropdown function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $label (default: '') search field label</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name (default: '') input name attribute</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $choices</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return field dropdown html</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static private function render_search_dropdown( $label = '', $name = '', $choices ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $choices ) || ! is_array( $choices ) || empty( $name ) ) {&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_value = isset( $_GET[ $name ] ) ? $_GET[ $name ] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output = '&lt;div class=&quot;search-box&quot;&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;label for=search-box-' . $name . '&gt;' . $label . '&lt;/label&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;select name=&quot;' . $name . '&quot; id=&quot;search-box-' . $name . '&quot;&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;option value=&quot;&quot; ' . selected( '', $current_value, false ) . '&gt;---&lt;/option&gt;';&nbsp;</div></li><li><div>      foreach ( $choices as $choice ) {&nbsp;</div></li><li><div>          $output .= '&lt;option value=&quot;' . $choice['value'] . '&quot; ' . selected( $choice['value'], $current_value, false ) . '&gt;' . $choice['text'] . '&lt;/option&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $output .= '&lt;/select&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * render_search_input function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $label (default: '') search field label</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name (default: '') input name attribute</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return field input html</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static private function render_search_input( $label = '', $name = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $name ) ) {&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_value = isset( $_GET[ $name ] ) ? $_GET[ $name ] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output = '&lt;div class=&quot;search-box&quot;&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;label for=search-box-' . $name . '&gt;' . $label . '&lt;/label&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;input type=&quot;text&quot; name=&quot;' . $name . '&quot; id=&quot;search-box-' . $name . '&quot; value=&quot;' . $current_value . '&quot;&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function get_credit_link( $columns = 1, $options = array() ) {&nbsp;</div></li><li><div>      global $post;<span class="comment">// prevents calling before &lt;HTML&gt;</span>&nbsp;</div></li><li><div>      if ( empty( $post ) || is_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = self::get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only show credit link if the user has saved settings;</span>&nbsp;</div></li><li><div>      <span class="comment">// this prevents existing directories adding a link without user action.</span>&nbsp;</div></li><li><div>      if ( isset( $settings['version'] ) ) {&nbsp;</div></li><li><div>          echo &quot;&lt;tr&gt;&lt;th colspan='{$columns}'&gt;&quot; . self::attr( $options ) . &quot;&lt;/th&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function get_version() {&nbsp;</div></li><li><div>      return self::$version;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function return_7776000() {&nbsp;</div></li><li><div>      return 7776000; <span class="comment">// extend the cache to 90 days</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function attr( $options, $default = '&lt;span class=&quot;kws_gf_credit&quot; style=&quot;font-weight:normal; text-align:center; display:block; margin:0 auto;&quot;&gt;Powered by &lt;a href=&quot;http:<span class="comment">//katz.co/gravity-forms-addons/&quot;&gt;Gravity Forms Directory&lt;/a&gt;&lt;/span&gt;' ) {</span>&nbsp;</div></li><li><div>      include_once( ABSPATH . WPINC . '/feed.php' );&nbsp;</div></li><li><div>      add_filter( 'wp_feed_cache_transient_lifetime', array( 'GFDirectory', 'return_7776000' ) );&nbsp;</div></li><li><div>      $rss = fetch_feed( add_query_arg( array(&nbsp;</div></li><li><div>          'site' =&gt; htmlentities( substr( get_bloginfo( 'url' ), is_ssl() ? 8 : 7 ) ), &nbsp;</div></li><li><div>          'from' =&gt; 'kws_gf_addons', &nbsp;</div></li><li><div>          'version' =&gt; self::$version, &nbsp;</div></li><li><div>          'credit' =&gt; ! empty( $options['credit'] ), &nbsp;</div></li><li><div> ), 'http:<span class="comment">//www.katzwebservices.com/development/attribution.php' ) );</span>&nbsp;</div></li><li><div>      remove_filter( 'wp_feed_cache_transient_lifetime', array( 'GFDirectory', 'return_7776000' ) );&nbsp;</div></li><li><div>      if ( $rss && ! is_wp_error( $rss ) ) {&nbsp;</div></li><li><div>          <span class="comment">// We want to strip all tags except for 'style', 'id', and 'class' so that the return value is always safe for the site.</span>&nbsp;</div></li><li><div>          $strip = array(&nbsp;</div></li><li><div>              'bgsound', &nbsp;</div></li><li><div>              'expr', &nbsp;</div></li><li><div>              'onclick', &nbsp;</div></li><li><div>              'onerror', &nbsp;</div></li><li><div>              'onfinish', &nbsp;</div></li><li><div>              'onmouseover', &nbsp;</div></li><li><div>              'onmouseout', &nbsp;</div></li><li><div>              'onfocus', &nbsp;</div></li><li><div>              'onblur', &nbsp;</div></li><li><div>              'lowsrc', &nbsp;</div></li><li><div>              'dynsrc', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $rss-&gt;strip_attributes( $strip );&nbsp;</div></li><li><div>          $rss_items = $rss-&gt;get_items( 0, 1 );&nbsp;</div></li><li><div>          foreach ( $rss_items as $item ) {&nbsp;</div></li><li><div>              return str_replace( array( &quot;\n&quot;, &quot;\r&quot; ), ' ', $item-&gt;get_description() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $default;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function add_lead_approved_hidden_input( $value, $lead, $field = '' ) {&nbsp;</div></li><li><div>      global $_gform_directory_processed_meta, $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! in_array( $lead['id'], $_gform_directory_processed_meta ) ) {&nbsp;</div></li><li><div>          $_gform_directory_processed_meta[] = $lead['id'];&nbsp;</div></li><li><div>          if ( empty( $_gform_directory_approvedcolumn ) ) {&nbsp;</div></li><li><div>              $forms = RGFormsModel::get_forms( NULL, &quot;title&quot; );&nbsp;</div></li><li><div>              $_gform_directory_approvedcolumn = self::globals_get_approved_column( $forms[0]-&gt;id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( self::check_approval( $lead, $_gform_directory_approvedcolumn ) ) {&nbsp;</div></li><li><div>              echo '&lt;span style=&quot;display:none;&quot;&gt;&lt;input type=&quot;hidden&quot; class=&quot;lead_approved&quot; id=&quot;lead_approved_' . $lead['id'] . '&quot; value=&quot;true&quot; /&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function globals_get_approved_column( $formID = 0 ) {&nbsp;</div></li><li><div>      global $_gform_directory_processed_meta, $_gform_directory_approvedcolumn, $_gform_directory_activeform;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $_gform_directory_processed_meta = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $formID ) ) {&nbsp;</div></li><li><div>          $formID = RGForms::get( &quot;id&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $formID ) ) {&nbsp;</div></li><li><div>              $forms = RGFormsModel::get_forms( NULL, &quot;title&quot; );&nbsp;</div></li><li><div>              $formID = $forms[0]-&gt;id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $formID ) ) {&nbsp;</div></li><li><div>          $_gform_directory_activeform = RGFormsModel::get_form_meta( $formID );&nbsp;</div></li><li><div>      } else if ( isset( $_GET['id'] ) ) {&nbsp;</div></li><li><div>          $_gform_directory_activeform = RGFormsModel::get_form_meta( $_GET['id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $_gform_directory_approvedcolumn = self::get_approved_column( $_gform_directory_activeform );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function get_approved_column( $form ) {&nbsp;</div></li><li><div>      if ( ! is_array( $form ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( @$form['fields'] as $key =&gt; $col ) {&nbsp;</div></li><li><div>          if ( isset( $col['inputs'] ) && is_array( $col['inputs'] ) ) {&nbsp;</div></li><li><div>              foreach ( $col['inputs'] as $key2 =&gt; $input ) {&nbsp;</div></li><li><div>                  if ( strtolower( $input['label'] ) == 'approved' && $col['type'] == 'checkbox' && ! empty( $col['adminOnly'] ) ) {&nbsp;</div></li><li><div>                      return $input['id'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( @$form['fields'] as $key =&gt; $col ) {&nbsp;</div></li><li><div>          if ( isset( $col['label'] ) && strtolower( $col['label'] ) == 'approved' && $col['type'] == 'checkbox' ) {&nbsp;</div></li><li><div>              if ( isset( $col['inputs'][0]['id'] ) ) {&nbsp;</div></li><li><div>                  return $key;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return NULL;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function directory_update_approved_hook() {&nbsp;</div></li><li><div>      global $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>      check_ajax_referer( 'rg_update_approved', 'rg_update_approved' );&nbsp;</div></li><li><div>      if ( ! empty( $_POST[&quot;lead_id&quot;] ) ) {&nbsp;</div></li><li><div>          $_gform_directory_approvedcolumn = empty( $_gform_directory_approvedcolumn ) ? self::globals_get_approved_column( $_POST['form_id'] ) : $_gform_directory_approvedcolumn;&nbsp;</div></li><li><div>          self::directory_update_approved( (int) $_POST[&quot;lead_id&quot;], $_POST[&quot;approved&quot;], (int) $_POST['form_id'], $_gform_directory_approvedcolumn );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function settings_link( $links, $file ) {&nbsp;</div></li><li><div>      static $this_plugin;&nbsp;</div></li><li><div>      if ( ! $this_plugin ) {&nbsp;</div></li><li><div>          $this_plugin = plugin_basename( __FILE__ );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $file == $this_plugin ) {&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;' . admin_url( 'admin.php?page=gf_settings&addon=Directory+%26+Addons' ) . '&quot;&gt;' . __( 'Settings', 'gravity-forms-addons' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>          array_unshift( $links, $settings_link ); <span class="comment">// before other links</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns true if the current page is an Feed pages. Returns false if not</span>&nbsp;</div></li><li><div>  private static function is_directory_page() {&nbsp;</div></li><li><div>      if ( empty( $_GET[&quot;pagenum&quot;] ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $current_page = trim( strtolower( $_GET[&quot;pagenum&quot;] ) );&nbsp;</div></li><li><div>      $directory_pages = array( &quot;gf_directory&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return in_array( $current_page, $directory_pages );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function get_settings() {&nbsp;</div></li><li><div>      return get_option( &quot;gf_addons_settings&quot;, array(&nbsp;</div></li><li><div>              &quot;directory&quot; =&gt; true, &nbsp;</div></li><li><div>              &quot;directory_defaults&quot; =&gt; array(), &nbsp;</div></li><li><div>              &quot;referrer&quot; =&gt; false, &nbsp;</div></li><li><div>              &quot;modify_admin&quot; =&gt; array(&nbsp;</div></li><li><div>                  'expand' =&gt; true, &nbsp;</div></li><li><div>                  'toggle' =&gt; true, &nbsp;</div></li><li><div>                  'edit' =&gt; true, &nbsp;</div></li><li><div>                  'ids' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              &quot;saved&quot; =&gt; false, &nbsp;</div></li><li><div>              &quot;version&quot; =&gt; self::$version, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function disable_directory() {&nbsp;</div></li><li><div>      delete_option( &quot;gf_directory_oid&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function uninstall() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! GFDirectory::has_access( &quot;gravityforms_directory_uninstall&quot; ) ) {&nbsp;</div></li><li><div>          ( __( &quot;You don't have adequate permission to uninstall Directory Add-On.&quot;, &quot;gravity-forms-addons&quot; ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//removing options</span>&nbsp;</div></li><li><div>      delete_option( &quot;gf_addons_settings&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Deactivating plugin</span>&nbsp;</div></li><li><div>      $plugin = &quot;gravity-forms-addons/gravity-forms-addons.php&quot;;&nbsp;</div></li><li><div>      deactivate_plugins( $plugin );&nbsp;</div></li><li><div>      update_option( 'recently_activated', array( $plugin =&gt; time() ) + (array) get_option( 'recently_activated' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function is_gravityforms_supported() {&nbsp;</div></li><li><div>      if ( class_exists( &quot;GFCommon&quot; ) ) {&nbsp;</div></li><li><div>          $is_correct_version = version_compare( GFCommon::$version, self::$min_gravityforms_version, &quot;&gt;=&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $is_correct_version;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static function get_has_access( $required_permission ) {&nbsp;</div></li><li><div>      $has_members_plugin = function_exists( 'members_get_capabilities' );&nbsp;</div></li><li><div>      $has_access = $has_members_plugin ? current_user_can( $required_permission ) : current_user_can( &quot;level_7&quot; );&nbsp;</div></li><li><div>      if ( $has_access ) {&nbsp;</div></li><li><div>          return $has_members_plugin ? $required_permission : &quot;level_7&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function has_access( $required_permission ) {&nbsp;</div></li><li><div>      return self::get_has_access( $required_permission );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Returns the url of the plugin's root folder</span>&nbsp;</div></li><li><div>  static public function get_base_url() {&nbsp;</div></li><li><div>      return plugins_url( NULL, __FILE__ );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get_search_filters function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array search fields ids</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_search_filters( $form ) {&nbsp;</div></li><li><div>      if ( empty( $form['fields'] ) ) {&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $search_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>          if ( ! empty( $field['isSearchFilter'] ) ) {&nbsp;</div></li><li><div>              $search_fields[] = $field['id'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $search_fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get_leads function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $form_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $sort_field_number (default: 0)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $sort_direction (default: 'DESC')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $search (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset (default: 0)</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $page_size (default: 30)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $star (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $read (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_numeric_sort (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $start_date (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $end_date (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $status (default: 'active')</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $approvedcolumn (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $limituser (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $search_criterias , since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Leads results</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_leads( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 30, $star = NULL, $read = NULL, $is_numeric_sort = false, $start_date = NULL, $end_date = NULL, $status = 'active', $approvedcolumn = NULL, $limituser = false, $search_criterias ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $sort_field_number == 0 ) {&nbsp;</div></li><li><div>          $sort_field_number = &quot;date_created&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//since 3.5</span></span>&nbsp;</div></li><li><div>      if ( empty( $search_criterias ) ) {&nbsp;</div></li><li><div>          $search_criterias = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Retrieve the leads based on whether it's sorted or not.</span>&nbsp;</div></li><li><div>      if ( is_numeric( $sort_field_number ) ) {&nbsp;</div></li><li><div>          $sql = self::sort_by_custom_field_query( $form_id, $sort_field_number, $sort_direction, $search, $search_criterias, $offset, $page_size, $star, $read, $is_numeric_sort, $status, $approvedcolumn, $limituser );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $sql = self::sort_by_default_field_query( $form_id, $sort_field_number, $sort_direction, $search, $search_criterias, $offset, $page_size, $star, $read, $is_numeric_sort, $start_date, $end_date, $status, $approvedcolumn, $limituser );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//initializing rownum</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;select @rownum:=0&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//getting results</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = '';&nbsp;</div></li><li><div>      if ( function_exists( 'gform_get_meta' ) ) {&nbsp;</div></li><li><div>          $return = RGFormsModel::build_lead_array( $results ); <span class="comment">// This is a private function until 1.6</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Used by at least the show_only_user_entries() method</span>&nbsp;</div></li><li><div>      $return = apply_filters( 'kws_gf_directory_lead_filter', $return, compact( &quot;approved&quot;, &quot;sort_field_number&quot;, &quot;sort_direction&quot;, &quot;search_query&quot;, &quot;search_criterias&quot;, &quot;first_item_index&quot;, &quot;page_size&quot;, &quot;star&quot;, &quot;read&quot;, &quot;is_numeric&quot;, &quot;start_date&quot;, &quot;end_date&quot;, &quot;status&quot;, &quot;approvedcolumn&quot;, &quot;limituser&quot; ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function is_current_user( $lead = array() ) {&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>      get_currentuserinfo();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ( (int) $current_user-&gt;ID === (int) $lead[&quot;created_by&quot;] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function show_only_user_entries( $leads = array(), $settings = array() ) {&nbsp;</div></li><li><div>      if ( empty( $settings['limituser'] ) ) {&nbsp;</div></li><li><div>          return $leads;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_filter( $leads, array( 'GFDirectory', 'is_current_user' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * sort_by_custom_field_query function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * A copy of the Gravity Forms method, but adding $approvedcolumns and $limituser args</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $form_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $sort_field_number (default: 0)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $sort_direction (default: 'DESC')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $search (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $search_criterias , since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset (default: 0)</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $page_size (default: 30)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $star (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $read (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_numeric_sort (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $status (default: 'active')</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $approvedcolumn (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $limituser (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function sort_by_custom_field_query( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $search_criterias, $offset = 0, $page_size = 30, $star = NULL, $read = NULL, $is_numeric_sort = false, $status = 'active', $approvedcolumn = NULL, $limituser = false ) {&nbsp;</div></li><li><div>      global $wpdb, $current_user;&nbsp;</div></li><li><div>      if ( ! is_numeric( $form_id ) || ! is_numeric( $sort_field_number ) || ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>          return &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lead_detail_table_name = RGFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>      $lead_table_name = RGFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $orderby = $is_numeric_sort ? &quot;ORDER BY query, (value+0) $sort_direction&quot; : &quot;ORDER BY query, value $sort_direction&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//$search = empty($search) ? &quot;&quot; : &quot;WHERE d.value LIKE '%$search%' &quot;;</span>&nbsp;</div></li><li><div>      $search_term = &quot;%$search%&quot;;&nbsp;</div></li><li><div>      $search_filter = empty( $search ) ? &quot;&quot; : $wpdb-&gt;prepare( &quot;WHERE d.value LIKE %s&quot;, $search_term );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//starred clause</span>&nbsp;</div></li><li><div>      $where = empty( $search ) ? &quot;WHERE&quot; : &quot;AND&quot;;&nbsp;</div></li><li><div>      $search_filter .= $star !== NULL && $status == 'active' ? $wpdb-&gt;prepare( &quot;$where is_starred=%d AND status='active' &quot;, $star ) : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//read clause</span>&nbsp;</div></li><li><div>      $where = empty( $search ) ? &quot;WHERE&quot; : &quot;AND&quot;;&nbsp;</div></li><li><div>      $search_filter .= $read !== NULL && $status == 'active' ? $wpdb-&gt;prepare( &quot;$where is_read=%d AND status='active' &quot;, $read ) : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//status clause</span>&nbsp;</div></li><li><div>      if ( function_exists( 'gform_get_meta' ) ) {&nbsp;</div></li><li><div>          $where = empty( $search ) ? &quot;WHERE&quot; : &quot;AND&quot;;&nbsp;</div></li><li><div>          $search_filter .= $wpdb-&gt;prepare( &quot;$where status=%s &quot;, $status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// new search criterias since 3.5</span></span></span>&nbsp;</div></li><li><div>      $in_search_criteria = '';&nbsp;</div></li><li><div>      if ( ! empty( $search_criterias ) ) {&nbsp;</div></li><li><div>          foreach ( $search_criterias as $field_id =&gt; $value ) {&nbsp;</div></li><li><div>              $value = &quot;%$value%&quot;;&nbsp;</div></li><li><div>              $in_search_criteria .= $wpdb-&gt;prepare( &quot; l.id IN (SELECT lead_id from $lead_detail_table_name WHERE field_number = %s AND value LIKE %s) AND &quot;, $field_id, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $where = empty( $search_filter ) ? &quot;WHERE &quot; : &quot;AND &quot;;&nbsp;</div></li><li><div>      $in_search_criteria = ( ! empty( $in_search_criteria ) ) ? $where . substr( $in_search_criteria, 0, - 4 ) : ''; <span class="comment">// to add where/and and remove the last AND</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $limituser ) {&nbsp;</div></li><li><div>          get_currentuserinfo();&nbsp;</div></li><li><div>          if ( (int) $current_user-&gt;ID !== 0 || ( $current_user-&gt;ID === 0 && apply_filters( 'kws_gf_show_entries_if_not_logged_in', apply_filters( 'kws_gf_treat_not_logged_in_as_user', true ) ) ) ) {&nbsp;</div></li><li><div>              $where = empty( $search_filter ) ? &quot;WHERE&quot; : &quot;AND&quot;;&nbsp;</div></li><li><div>              if ( (int) $current_user-&gt;ID === 0 ) {&nbsp;</div></li><li><div>                  $search_filter .= $wpdb-&gt;prepare( &quot;$where (created_by IS NULL OR created_by=%d)&quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $search_filter .= $wpdb-&gt;prepare( &quot;$where l.created_by=%d &quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field_number_min = $sort_field_number - 0.001;&nbsp;</div></li><li><div>      $field_number_max = $sort_field_number + 0.001;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $in_filter = &quot;&quot;;&nbsp;</div></li><li><div>      if ( ! empty( $approvedcolumn ) ) {&nbsp;</div></li><li><div>          $in_filter = $wpdb-&gt;prepare( &quot;WHERE l.id IN (SELECT lead_id from $lead_detail_table_name WHERE field_number BETWEEN %f AND %f)&quot;, $approvedcolumn - 0.001, $approvedcolumn + 0.001 );&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// This will work once all the fields are converted to the meta_key after 1.6</span></span></span>&nbsp;</div></li><li><div>          #$search_filter .= $wpdb-&gt;prepare(&quot; AND m.meta_key = 'is_approved' AND m.meta_value = %s&quot;, 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $limit_filter = ''; <span class="comment"><span class="comment">//paging is done later since 3.5 to allow multisort</span></span>&nbsp;</div></li><li><div>      if ( ! apply_filters( 'kws_gf_directory_want_multisort', false ) ) {&nbsp;</div></li><li><div>          if ( $page_size &gt; 0 ) {&nbsp;</div></li><li><div>              $limit_filter = &quot;LIMIT $offset, $page_size&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = &quot;&nbsp;</div></li><li><div>          SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>          FROM $lead_table_name l&nbsp;</div></li><li><div>          INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>          INNER JOIN (&nbsp;</div></li><li><div>              SELECT distinct sorted.sort, l.id&nbsp;</div></li><li><div>              FROM $lead_table_name l&nbsp;</div></li><li><div>              INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>              INNER JOIN (&nbsp;</div></li><li><div>                  SELECT @rownum:=@rownum+1 as sort, id FROM (&nbsp;</div></li><li><div>                      SELECT 0 as query, lead_id as id, value&nbsp;</div></li><li><div>                      FROM $lead_detail_table_name&nbsp;</div></li><li><div>                      WHERE form_id=$form_id&nbsp;</div></li><li><div>                      AND field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      UNION ALL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      SELECT 1 as query, l.id, d.value&nbsp;</div></li><li><div>                      FROM $lead_table_name l&nbsp;</div></li><li><div>                      LEFT OUTER JOIN $lead_detail_table_name d ON d.lead_id = l.id AND field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>                      WHERE l.form_id=$form_id&nbsp;</div></li><li><div>                      AND d.lead_id IS NULL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) sorted1&nbsp;</div></li><li><div>                 $orderby&nbsp;</div></li><li><div> ) sorted ON d.lead_id = sorted.id&nbsp;</div></li><li><div>              $search_filter&nbsp;</div></li><li><div>              $in_search_criteria&nbsp;</div></li><li><div>              $limit_filter&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>          $in_filter&nbsp;</div></li><li><div>          ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $sql;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * sort_by_default_field_query function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * A copy of the Gravity Forms method, but adding $approvedcolumns and $limituser args</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $form_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $sort_field</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $sort_direction (default: 'DESC')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $search (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $search_criterias - since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset (default: 0)</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $page_size (default: 30)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $star (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $read (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_numeric_sort (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $start_date (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $end_date (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $status (default: 'active')</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $approvedcolumn (default: null)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $limituser (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function sort_by_default_field_query( $form_id, $sort_field, $sort_direction = 'DESC', $search = '', $search_criterias, $offset = 0, $page_size = 30, $star = NULL, $read = NULL, $is_numeric_sort = false, $start_date = NULL, $end_date = NULL, $status = 'active', $approvedcolumn = NULL, $limituser = false ) {&nbsp;</div></li><li><div>      global $wpdb, $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_numeric( $form_id ) || ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>          return &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lead_detail_table_name = RGFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>      $lead_table_name = RGFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $search_term = &quot;%$search%&quot;;&nbsp;</div></li><li><div>      $search_filter = empty( $search ) ? &quot;&quot; : $wpdb-&gt;prepare( &quot; AND value LIKE %s&quot;, $search_term );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// new search criterias since 3.5</span></span></span>&nbsp;</div></li><li><div>      $in_search_criteria = '';&nbsp;</div></li><li><div>      if ( ! empty( $search_criterias ) ) {&nbsp;</div></li><li><div>          foreach ( $search_criterias as $field_id =&gt; $value ) {&nbsp;</div></li><li><div>              $value = &quot;%$value%&quot;;&nbsp;</div></li><li><div>              $in_search_criteria .= $wpdb-&gt;prepare( &quot; AND l.id IN (SELECT lead_id from $lead_detail_table_name WHERE field_number = %s AND value LIKE %s)&quot;, $field_id, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $star_filter = $star !== NULL && $status == 'active' ? $wpdb-&gt;prepare( &quot; AND is_starred=%d AND status='active' &quot;, $star ) : &quot;&quot;;&nbsp;</div></li><li><div>      $read_filter = $read !== NULL && $status == 'active' ? $wpdb-&gt;prepare( &quot; AND is_read=%d AND status='active' &quot;, $read ) : &quot;&quot;;&nbsp;</div></li><li><div>      if ( function_exists( 'gform_get_meta' ) ) {&nbsp;</div></li><li><div>          $status_filter = $wpdb-&gt;prepare( &quot; AND status=%s &quot;, $status );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status_filter = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $start_date_filter = empty( $start_date ) ? &quot;&quot; : &quot; AND datediff(date_created, '$start_date') &gt;=0&quot;;&nbsp;</div></li><li><div>      $end_date_filter = empty( $end_date ) ? &quot;&quot; : &quot; AND datediff(date_created, '$end_date') &lt;=0&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $in_filter = &quot;&quot;;&nbsp;</div></li><li><div>      if ( ! empty( $approvedcolumn ) ) {&nbsp;</div></li><li><div>          $in_filter = $wpdb-&gt;prepare( &quot;l.id IN (SELECT lead_id from $lead_detail_table_name WHERE field_number BETWEEN %f AND %f) AND&quot;, $approvedcolumn - 0.001, $approvedcolumn + 0.001 );&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// This will work once all the fields are converted to the meta_key after 1.6</span></span></span>&nbsp;</div></li><li><div>          #$search_filter .= $wpdb-&gt;prepare(&quot; AND m.meta_key = 'is_approved' AND m.meta_value = %s&quot;, 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_filter = '';&nbsp;</div></li><li><div>      if ( $limituser ) {&nbsp;</div></li><li><div>          get_currentuserinfo();&nbsp;</div></li><li><div>          if ( (int) $current_user-&gt;ID !== 0 || ( $current_user-&gt;ID === 0 && apply_filters( 'kws_gf_show_entries_if_not_logged_in', apply_filters( 'kws_gf_treat_not_logged_in_as_user', true ) ) ) ) {&nbsp;</div></li><li><div>              if ( (int) $current_user-&gt;ID === 0 ) {&nbsp;</div></li><li><div>                  $user_filter = $wpdb-&gt;prepare( &quot; AND (created_by IS NULL OR created_by=%d)&quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $user_filter = $wpdb-&gt;prepare( &quot; AND created_by=%d &quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $limit_filter = ''; <span class="comment"><span class="comment">//paging is done later since 3.5 to allow multisort</span></span>&nbsp;</div></li><li><div>      if ( ! apply_filters( 'kws_gf_directory_want_multisort', false ) ) {&nbsp;</div></li><li><div>          if ( $page_size &gt; 0 ) {&nbsp;</div></li><li><div>              $limit_filter = &quot;LIMIT $offset, $page_size&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = &quot;&nbsp;</div></li><li><div>          SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>          FROM $lead_table_name l&nbsp;</div></li><li><div>          INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>          INNER JOIN&nbsp;</div></li><li><div>          (&nbsp;</div></li><li><div>              SELECT @rownum:=@rownum + 1 as sort, id&nbsp;</div></li><li><div>              FROM&nbsp;</div></li><li><div>              (&nbsp;</div></li><li><div>                  SELECT distinct l.id&nbsp;</div></li><li><div>                  FROM $lead_table_name l&nbsp;</div></li><li><div>                  INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>                  WHERE $in_filter&nbsp;</div></li><li><div>                  l.form_id=$form_id&nbsp;</div></li><li><div>                  $search_filter&nbsp;</div></li><li><div>                  $in_search_criteria&nbsp;</div></li><li><div>                  $star_filter&nbsp;</div></li><li><div>                  $read_filter&nbsp;</div></li><li><div>                  $user_filter&nbsp;</div></li><li><div>                  $status_filter&nbsp;</div></li><li><div>                  $start_date_filter&nbsp;</div></li><li><div>                  $end_date_filter&nbsp;</div></li><li><div>                  ORDER BY $sort_field $sort_direction&nbsp;</div></li><li><div>                  $limit_filter&nbsp;</div></li><li><div> ) page&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>          ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $sql;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function directory_anchor_text( $value = NULL ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_anchor_text_striphttp', true ) ) {&nbsp;</div></li><li><div>          $value = str_replace( 'http:<span class="comment"><span class="comment">//', '', $value );</span></span>&nbsp;</div></li><li><div>          $value = str_replace( 'https:<span class="comment"><span class="comment">//', '', $value );</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_anchor_text_stripwww', true ) ) {&nbsp;</div></li><li><div>          $value = str_replace( 'www.', '', $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_anchor_text_rootonly', true ) ) {&nbsp;</div></li><li><div>          $value = preg_replace( '/(.*?)\/(.+)/ism', '$1', $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_anchor_text_nosubdomain', true ) ) {&nbsp;</div></li><li><div>          $value = preg_replace( '/((.*?)\.)+(.*?)\.(.*?)/ism', '$3.$4', $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( apply_filters( 'kws_gf_directory_anchor_text_noquerystring', true ) ) {&nbsp;</div></li><li><div>          $ary = explode( &quot;?&quot;, $value );&nbsp;</div></li><li><div>          $value = $ary[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function r( $content, $die = false ) {&nbsp;</div></li><li><div>      echo '&lt;pre&gt;' . print_r( $content, true ) . '&lt;/pre&gt;';&nbsp;</div></li><li><div>      if ( $die ) {&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function get_entrylink_column( $form, $entry = false ) {&nbsp;</div></li><li><div>      if ( ! is_array( $form ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $columns = empty( $entry ) ? array() : array( 'id' =&gt; 'id' );&nbsp;</div></li><li><div>      foreach ( @$form['fields'] as $key =&gt; $col ) {&nbsp;</div></li><li><div>          if ( ! empty( $col['useAsEntryLink'] ) ) {&nbsp;</div></li><li><div>              $columns[ $col['id'] ] = $col['useAsEntryLink'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return empty( $columns ) ? false : $columns;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static private function prep_address_field( $field ) {&nbsp;</div></li><li><div>      return ! empty( $field ) ? GFCommon::trim_all( $field ) : '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function format_address( $address = array(), $linknewwindow = false ) {&nbsp;</div></li><li><div>      $address_field_id = @self::prep_address_field( $address['id'] );&nbsp;</div></li><li><div>      $street_value = @self::prep_address_field( $address[ $address_field_id . &quot;.1&quot; ] );&nbsp;</div></li><li><div>      $street2_value = @self::prep_address_field( $address[ $address_field_id . &quot;.2&quot; ] );&nbsp;</div></li><li><div>      $city_value = @self::prep_address_field( $address[ $address_field_id . &quot;.3&quot; ] );&nbsp;</div></li><li><div>      $state_value = @self::prep_address_field( $address[ $address_field_id . &quot;.4&quot; ] );&nbsp;</div></li><li><div>      $zip_value = @self::prep_address_field( $address[ $address_field_id . &quot;.5&quot; ] );&nbsp;</div></li><li><div>      $country_value = @self::prep_address_field( $address[ $address_field_id . &quot;.6&quot; ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $address = $street_value;&nbsp;</div></li><li><div>      $address .= ! empty( $address ) && ! empty( $street2_value ) ? &quot;&lt;br /&gt;$street2_value&quot; : $street2_value;&nbsp;</div></li><li><div>      $address .= ! empty( $address ) && ( ! empty( $city_value ) || ! empty( $state_value ) ) ? &quot;&lt;br /&gt;$city_value&quot; : $city_value;&nbsp;</div></li><li><div>      $address .= ! empty( $address ) && ! empty( $city_value ) && ! empty( $state_value ) ? &quot;, $state_value&quot; : $state_value;&nbsp;</div></li><li><div>      $address .= ! empty( $address ) && ! empty( $zip_value ) ? &quot; $zip_value&quot; : $zip_value;&nbsp;</div></li><li><div>      $address .= ! empty( $address ) && ! empty( $country_value ) ? &quot;&lt;br /&gt;$country_value&quot; : $country_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//adding map link</span>&nbsp;</div></li><li><div>      if ( ! empty( $address ) && apply_filters( 'kws_gf_directory_td_address_map', 1 ) ) {&nbsp;</div></li><li><div>          $address_qs = str_replace( &quot;&lt;br /&gt;&quot;, &quot; &quot;, $address ); <span class="comment">//replacing &lt;br/&gt; with spaces</span>&nbsp;</div></li><li><div>          $address_qs = urlencode( $address_qs );&nbsp;</div></li><li><div>          $target = '';&nbsp;</div></li><li><div>          if ( $linknewwindow ) {&nbsp;</div></li><li><div>              $target = ' target=&quot;_blank&quot;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $address .= &quot;&lt;br/&gt;&quot; . apply_filters( 'kws_gf_directory_map_link', &quot;&lt;a href='http:<span class="comment">//maps.google.com/maps?q=$address_qs'&quot; . $target . &quot; class='map-it-link'&gt;&quot; . __( 'Map It' ) . &quot;&lt;/a&gt;&quot; );</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $address;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function html_display_type_filter( $content = NULL, $type = 'table', $single = false ) {&nbsp;</div></li><li><div>      switch ( $type ) {&nbsp;</div></li><li><div>          case 'table':&nbsp;</div></li><li><div>              return $content;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'ul':&nbsp;</div></li><li><div>              $content = self::convert_to_ul( $content, $single );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'dl':&nbsp;</div></li><li><div>              $content = self::convert_to_dl( $content, $single );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function convert_to_ul( $content = NULL, $singleUL = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $strongHeader = apply_filters( 'kws_gf_convert_to_ul_strong_header', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Directory View</span>&nbsp;</div></li><li><div>      if ( ! $singleUL ) {&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;table([^&gt;]*)&gt;/ism&quot;, &quot;&lt;ul$1&gt;&quot;, $content );&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/table([^&gt;]*)&gt;/ism&quot;, &quot;&lt;/ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          if ( $strongHeader ) {&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;\s+/&quot;, &quot;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;li$1&gt;&lt;ul&gt;&quot;, $content );&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;th([^&gt;]*)\&gt;(.*?)\&lt;\/th\&gt;/&quot;, &quot;$2&lt;/strong&gt;\n\t\t\t\t\t\t\t\t\t\t\t\t\t&lt;ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;\s+/&quot;, &quot;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;li$1&gt;&quot;, $content );&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;th([^&gt;]*)\&gt;(.*?)\&lt;\/th\&gt;/&quot;, &quot;$2\n\t\t\t\t\t\t\t\t\t\t\t\t\t&lt;ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/tr[^&gt;]*&gt;/&quot;, &quot;\t\t\t\t\t&lt;/ul&gt;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;/li&gt;&quot;, $content );&nbsp;</div></li><li><div>      } <span class="comment">// Single listing view</span>&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;table([^&gt;]*)&gt;/ism&quot;, &quot;&lt;ul$1&gt;&quot;, $content );&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/table([^&gt;]*)&gt;/ism&quot;, &quot;&lt;/ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          if ( $strongHeader ) {&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;\s+/&quot;, &quot;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;li$1&gt;&lt;strong&gt;&quot;, $content );&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;th([^&gt;]*)\&gt;(.*?)\&lt;\/th\&gt;/&quot;, &quot;$2&lt;/strong&gt;\n\t\t\t\t\t\t\t\t\t\t\t\t\t&lt;ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;\s+/&quot;, &quot;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;li$1&gt;&quot;, $content );&nbsp;</div></li><li><div>              $content = preg_replace( &quot;/&lt;th([^&gt;]*)\&gt;(.*?)\&lt;\/th\&gt;/&quot;, &quot;$2\n\t\t\t\t\t\t\t\t\t\t\t\t\t&lt;ul&gt;&quot;, $content );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/tr[^&gt;]*&gt;/&quot;, &quot;\t\t\t\t\t&lt;/ul&gt;\n\t\t\t\t\t\t\t\t\t\t\t\t&lt;/li&gt;&quot;, $content );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      #    $content = preg_replace(&quot;/\&lt;\/p\&gt;\s+\&lt;\/li/ism&quot;, &quot;\&lt;\/p\&gt;\&lt;\/li&quot;, $content);&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/(?:\s+)?(valign\=\&quot;(?:.*?)\&quot;|width\=\&quot;(?:.*?)\&quot;|cellspacing\=\&quot;(?:.*?)\&quot;)(?:\s+)?/ism&quot;, ' ', $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/&lt;\/?tbody[^&gt;]*&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/&lt;thead[^&gt;]*&gt;.*&lt;\/thead&gt;|&lt;tfoot[^&gt;]*&gt;.*&lt;\/tfoot&gt;/is&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/\&lt;td([^&gt;]*)\&gt;(\&nbsp;|)\&lt;\/td\&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/\&lt;td([^&gt;]*)\&gt;/&quot;, &quot;\t\t\t\t\t&lt;li$1&gt;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/&lt;\/td[^&gt;]*&gt;/&quot;, &quot;&lt;/li&gt;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( '/\s?colspan\=&quot;([^&gt;]*?)&quot;\s?/ism', ' ', $content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function convert_to_dl( $content, $singleDL = false ) {&nbsp;</div></li><li><div>      $back = '';&nbsp;</div></li><li><div>      <span class="comment">// Get the back link, if it exists</span>&nbsp;</div></li><li><div>      preg_match( &quot;/\&lt;p\sclass=\&quot;entryback\&quot;\&gt;(.*?)\&lt;\/p\&gt;/&quot;, $content, $matches );&nbsp;</div></li><li><div>      if ( isset( $matches[0] ) ) {&nbsp;</div></li><li><div>          $back = $matches[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/\&lt;p\sclass=\&quot;entryback\&quot;\&gt;(.*?)\&lt;\/p\&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/&lt;\/?table[^&gt;]*&gt;|&lt;\/?tbody[^&gt;]*&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/&lt;thead[^&gt;]*&gt;.*&lt;\/thead&gt;|&lt;tfoot[^&gt;]*&gt;.*&lt;\/tfoot&gt;/is&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      if ( ! $singleDL ) {&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;/&quot;, &quot;&lt;dl$1&gt;&quot;, $content );&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/tr[^&gt;]*&gt;/&quot;, &quot;&lt;/dl&gt;&quot;, $content );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;tr([^&gt;]*)&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>          $content = preg_replace( &quot;/&lt;\/tr[^&gt;]*&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/\&lt;td([^&gt;]*)\&gt;(\&nbsp;|)\&lt;\/td\&gt;/&quot;, &quot;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/\&lt;th([^&gt;]*)\&gt;(.*?)&lt;\/th\&gt;/ism&quot;, &quot;&lt;dt$1&gt;$2&lt;/dt&gt;&quot;, $content );&nbsp;</div></li><li><div>      $content = preg_replace( '/&lt;td(.*?)(title=&quot;(.*?)&quot;)?&gt;(.*?)&lt;\/td[^&gt;]*&gt;/ism', &quot;&lt;dt$1&gt;$3&lt;/dt&gt;&lt;dd&gt;$4&lt;/dd&gt;&quot;, $content );&nbsp;</div></li><li><div>      $output = $back;&nbsp;</div></li><li><div>      $output .= &quot;\n\t\t\t\t\t\t\t\t&quot; . '&lt;dl&gt;';&nbsp;</div></li><li><div>      $output .= $content;&nbsp;</div></li><li><div>      $output .= &quot;\t\t\t\t\t\t&quot; . '&lt;/dl&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function make_entry_link( $options = array(), $link = false, $lead_id = '', $form_id = '', $field_id = '', $field_label = '', $linkClass = '' ) {&nbsp;</div></li><li><div>      global $wp_rewrite, $post, $wp;&nbsp;</div></li><li><div>      extract( $options );&nbsp;</div></li><li><div>      $entrylink = ( empty( $link ) || $link === '&nbsp;' ) ? $field_label : $link; <span class="comment">//$entrylink;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $entrytitle = apply_filters( 'kws_gf_directory_detail_title', apply_filters( 'kws_gf_directory_detail_title_' . $lead_id, $entrytitle ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $lightboxsettings['entry'] ) ) {&nbsp;</div></li><li><div>          $href = wp_nonce_url( plugins_url( &quot;/entry-details.php?leadid=$lead_id&amp;form={$form_id}&amp;post={$post-&gt;ID}&quot;, __FILE__ ), sprintf( 'view-%d-%d', $lead_id, $form_id ), 'view' );&nbsp;</div></li><li><div>          if ( wp_script_is( 'colorbox', 'registered' ) ) {&nbsp;</div></li><li><div>              $linkClass = ' class=&quot;colorbox lightbox&quot; rel=&quot;directory_all directory_entry&quot;';&nbsp;</div></li><li><div>          } else if ( wp_script_is( 'thickbox', 'registered' ) ) {&nbsp;</div></li><li><div>              $linkClass = ' class=&quot;thickbox lightbox&quot; rel=&quot;directory_all directory_entry&quot;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $multisite = ( function_exists( 'is_multisite' ) && is_multisite() && $wpdb-&gt;blogid == 1 );&nbsp;</div></li><li><div>          if ( $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>              <span class="comment">// example.com/example-directory/entry/4/14/</span>&nbsp;</div></li><li><div>              if ( isset( $post-&gt;ID ) ) {&nbsp;</div></li><li><div>                  $url = get_permalink( $post-&gt;ID );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $url = parse_url( add_query_arg( array(), home_url() ) );&nbsp;</div></li><li><div>                  $url = $url['path'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $href = trailingslashit( $url ) . sanitize_title( apply_filters( 'kws_gf_directory_endpoint', 'entry' ) ) . '/' . $form_id . apply_filters( 'kws_gf_directory_endpoint_separator', '/' ) . $lead_id . '/';&nbsp;</div></li><li><div>              #if(!empty($url['query'])) { $href .= '?'.$url['query']; }&nbsp;</div></li><li><div>              $href = add_query_arg( array(&nbsp;</div></li><li><div>                  'gf_search' =&gt; ! empty( $_REQUEST['gf_search'] ) ? $_REQUEST['gf_search'] : NULL, &nbsp;</div></li><li><div>                  'sort' =&gt; isset( $_REQUEST['sort'] ) ? $_REQUEST['sort'] : NULL, &nbsp;</div></li><li><div>                  'dir' =&gt; isset( $_REQUEST['dir'] ) ? $_REQUEST['dir'] : NULL, &nbsp;</div></li><li><div>                  'pagenum' =&gt; isset( $_REQUEST['pagenum'] ) ? $_REQUEST['pagenum'] : NULL, &nbsp;</div></li><li><div>                  'start_date' =&gt; isset( $_REQUEST['start_date'] ) ? $_REQUEST['start_date'] : NULL, &nbsp;</div></li><li><div>                  'end_date' =&gt; isset( $_REQUEST['start_date'] ) ? $_REQUEST['end_date'] : NULL, &nbsp;</div></li><li><div> ), $href );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// example.com/?page_id=24&leadid=14&form=4</span>&nbsp;</div></li><li><div>              $href = wp_nonce_url( add_query_arg( array(&nbsp;</div></li><li><div>                  'leadid' =&gt; $lead_id, &nbsp;</div></li><li><div>                  'form' =&gt; $form_id, &nbsp;</div></li><li><div> ) ), sprintf( 'view-%d-%d', $lead_id, $form_id ), 'view' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this is a preview, add preview arguments to the link.</span>&nbsp;</div></li><li><div>      <span class="comment">// @since 3.5</span>&nbsp;</div></li><li><div>      if ( ! empty( $_GET['preview'] ) && ! empty( $_GET['preview_id'] ) && ! empty( $_GET['preview_nonce'] ) ) {&nbsp;</div></li><li><div>          if ( current_user_can( 'edit_posts' ) ) {&nbsp;</div></li><li><div>              $href = add_query_arg( array(&nbsp;</div></li><li><div>                  'preview' =&gt; $_GET['preview'], &nbsp;</div></li><li><div>                  'preview_id' =&gt; $_GET['preview_id'], &nbsp;</div></li><li><div>                  'preview_nonce' =&gt; $_GET['preview_nonce'], &nbsp;</div></li><li><div> ), $href );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $value = '&lt;a href=&quot;' . esc_url( $href ) . '&quot;' . $linkClass . ' title=&quot;' . $entrytitle . '&quot;&gt;' . $entrylink . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function get_lead_count( $form_id, $search, $star = NULL, $read = NULL, $column, $approved = false, $leads = array(), $start_date = NULL, $end_date = NULL, $limituser = false, $search_criterias ) {&nbsp;</div></li><li><div>      global $wpdb, $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_numeric( $form_id ) ) {&nbsp;</div></li><li><div>          return &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $detail_table_name = RGFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>      $lead_table_name = RGFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $star_filter = $star !== NULL ? $wpdb-&gt;prepare( &quot;AND is_starred=%d &quot;, $star ) : &quot;&quot;;&nbsp;</div></li><li><div>      $read_filter = $read !== NULL ? $wpdb-&gt;prepare( &quot;AND is_read=%d &quot;, $read ) : &quot;&quot;;&nbsp;</div></li><li><div>      if ( function_exists( 'gform_get_meta' ) ) {&nbsp;</div></li><li><div>          $status_filter = $wpdb-&gt;prepare( &quot; AND status=%s &quot;, 'active' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status_filter = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $start_date_filter = empty( $start_date ) ? &quot;&quot; : &quot; AND datediff(date_created, '$start_date') &gt;=0&quot;;&nbsp;</div></li><li><div>      $end_date_filter = empty( $end_date ) ? &quot;&quot; : &quot; AND datediff(date_created, '$end_date') &lt;=0&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $search_term = &quot;%$search%&quot;;&nbsp;</div></li><li><div>      $search_filter = empty( $search ) ? &quot;&quot; : $wpdb-&gt;prepare( &quot;AND ld.value LIKE %s&quot;, $search_term );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// new search criterias since 3.5</span></span></span>&nbsp;</div></li><li><div>      $in_search_criteria = '';&nbsp;</div></li><li><div>      if ( ! empty( $search_criterias ) ) {&nbsp;</div></li><li><div>          foreach ( $search_criterias as $field_id =&gt; $value ) {&nbsp;</div></li><li><div>              $value = &quot;%$value%&quot;;&nbsp;</div></li><li><div>              $in_search_criteria .= $wpdb-&gt;prepare( &quot; AND l.id IN (SELECT lead_id from $detail_table_name WHERE field_number = %s AND value LIKE %s)&quot;, $field_id, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_filter = '';&nbsp;</div></li><li><div>      if ( $limituser ) {&nbsp;</div></li><li><div>          get_currentuserinfo();&nbsp;</div></li><li><div>          if ( (int) $current_user-&gt;ID !== 0 || ( $current_user-&gt;ID === 0 && apply_filters( 'kws_gf_show_entries_if_not_logged_in', apply_filters( 'kws_gf_treat_not_logged_in_as_user', true ) ) ) ) {&nbsp;</div></li><li><div>              if ( ! empty( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>                  $user_filter = $wpdb-&gt;prepare( &quot; AND l.created_by=%d &quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $user_filter = $wpdb-&gt;prepare( &quot; AND (created_by IS NULL OR created_by=%d)&quot;, $current_user-&gt;ID );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $in_filter = &quot;&quot;;&nbsp;</div></li><li><div>      if ( $approved ) {&nbsp;</div></li><li><div>          $in_filter = $wpdb-&gt;prepare( &quot;l.id IN (SELECT lead_id from $detail_table_name WHERE field_number BETWEEN %f AND %f) AND&quot;, $column - 0.001, $column + 0.001 );&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// This will work once all the fields are converted to the meta_key after 1.6</span></span></span>&nbsp;</div></li><li><div>          #$search_filter .= $wpdb-&gt;prepare(&quot; AND m.meta_key = 'is_approved' AND m.meta_value = %s&quot;, 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = &quot;SELECT count(distinct l.id) FROM $lead_table_name as l, &nbsp;</div></li><li><div>              $detail_table_name as ld&quot;;&nbsp;</div></li><li><div>#        $sql .= function_exists('gform_get_meta') ? &quot; INNER JOIN wp_rg_lead_meta m ON l.id = m.lead_id &quot; : &quot;&quot;; <span class="comment">// After 1.6</span>&nbsp;</div></li><li><div>      $sql .= &quot;&nbsp;</div></li><li><div>              WHERE $in_filter&nbsp;</div></li><li><div>              l.form_id=$form_id&nbsp;</div></li><li><div>              AND ld.form_id=$form_id&nbsp;</div></li><li><div>              AND l.id = ld.lead_id&nbsp;</div></li><li><div>              $star_filter&nbsp;</div></li><li><div>              $read_filter&nbsp;</div></li><li><div>              $status_filter&nbsp;</div></li><li><div>              $user_filter&nbsp;</div></li><li><div>              $start_date_filter&nbsp;</div></li><li><div>              $end_date_filter&nbsp;</div></li><li><div>              $search_filter&nbsp;</div></li><li><div>              $in_search_criteria&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function check_meta_approval( $lead_id ) {&nbsp;</div></li><li><div>      return gform_get_meta( $lead_id, 'is_approved' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function check_approval( $lead, $column ) {&nbsp;</div></li><li><div>      return self::check_meta_approval( $lead['id'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function hide_in_directory( $form, $field_id ) {&nbsp;</div></li><li><div>      return self::check_hide_in( 'hideInDirectory', $form, $field_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function hide_in_single( $form, $field_id ) {&nbsp;</div></li><li><div>      return self::check_hide_in( 'hideInSingle', $form, $field_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function check_hide_in( $type, $form, $field_id ) {&nbsp;</div></li><li><div>      foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>#            echo $field['label'] . ' / ' . floor($field['id']).' / '.floor($field_id).' / &lt;strong&gt;'.$field[&quot;{$type}&quot;].'&lt;/strong&gt;&lt;br /&gt;';&nbsp;</div></li><li><div>          if ( floor( $field_id ) === floor( $field['id'] ) && ! empty( $field[&quot;{$type}&quot;] ) ) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get field property value, for a specific field_id on a $form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.5</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_field_property( $property, $form, $field_id = '' ) {&nbsp;</div></li><li><div>      if ( empty( $property ) || empty( $form ) || '' === $field_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( floor( $field_id ) === floor( $field['id'] ) && ! empty( $field[ $property ] ) ) {&nbsp;</div></li><li><div>              return $field[ $property ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get field properties, for a specific field_id on a $form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form GF Form array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $field_id Field ID</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|array           If the field matches the searched-for field ID, return the field array. Otherwise, return false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_field_properties( $form, $field_id = '' ) {&nbsp;</div></li><li><div>      if ( empty( $form ) || '' === $field_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>          if ( floor( $field_id ) === floor( $field['id'] ) ) {&nbsp;</div></li><li><div>              return $field;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Deprecated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 3.5</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function remove_admin_only() {&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function remove_approved_column( $type = 'form', $fields, $approvedcolumn ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $fields as $key =&gt; $column ) {&nbsp;</div></li><li><div>          if ( (int) floor( $column['id'] ) === (int) floor( $approvedcolumn ) ) {&nbsp;</div></li><li><div>              unset( $fields[&quot;{$key}&quot;] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter columns and fields when generating directory or single entry view based on Admin Only fields, or &quot;hide from directory&quot; fields or (since 3.5) only visible if user is logged in.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method replaces GFDirectory::remove_admin_only() in 3.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.5</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $leads</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $admin_only</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $approved</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $is_leads</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_single (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $show_admin_only (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function remove_hidden_fields( $leads, $admin_only, $approved, $is_leads, $is_single = false, $show_admin_only = false, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $admin_only ) || ! is_array( $admin_only ) ) {&nbsp;</div></li><li><div>          $admin_only = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $leads ) || ! is_array( $leads ) ) {&nbsp;</div></li><li><div>          return $leads;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_leads ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $leads as $index =&gt; $lead ) {&nbsp;</div></li><li><div>              <span class="comment">// the field_ids are the numeric array keys of a lead</span>&nbsp;</div></li><li><div>              $field_ids = array_filter( array_keys( $lead ), 'is_int' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $field_ids as $id ) {&nbsp;</div></li><li><div>                  if ( self::check_hide_field_conditions( $id, $admin_only, $approved, $is_single, $show_admin_only, $form ) ) {&nbsp;</div></li><li><div>                      unset( $leads[ $index ][ $id ] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $leads;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// the KEY = field_id (to be used to check directory columns)</span>&nbsp;</div></li><li><div>          foreach ( $leads as $key =&gt; $column ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( self::check_hide_field_conditions( $key, $admin_only, $approved, $is_single, $show_admin_only, $form ) ) {&nbsp;</div></li><li><div>                  unset( $leads[ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $leads;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** returns true if field should be hidden / returns false if not , since 3.5 */</span>&nbsp;</div></li><li><div>  static function check_hide_field_conditions( $field_id, $admin_only, $approved, $is_single = false, $show_admin_only = false, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $properties = self::get_field_properties( $form, $field_id );&nbsp;</div></li><li><div>      if ( empty( $properties ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//check if set to be hidden in directory or in single entry view</span>&nbsp;</div></li><li><div>      if ( ( $is_single && ! empty( $properties['hideInSingle'] ) ) || ( ! $is_single && ! empty( $properties['hideInDirectory'] ) ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check if is and admin only field and remove if not authorized to be shown</span>&nbsp;</div></li><li><div>      if ( ! $show_admin_only && @in_array( $field_id, $admin_only ) && $field_id != $approved && $field_id != floor( $approved ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//check if field is only visible for logged in users, and in that case, check capabilities level</span>&nbsp;</div></li><li><div>      if ( ! empty( $properties['visibleToLoggedIn'] ) && ! current_user_can( $properties['visibleToLoggedInCap'] ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adapted from forms_model.php, RGFormsModel::save_lead($Form, $lead)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form Form object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $lead Lead object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function save_lead( $form, &$lead ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( IS_ADMIN && ! GFCommon::current_user_can_any( &quot;gravityforms_edit_entries&quot; ) ) {&nbsp;</div></li><li><div>          die( __( &quot;You don't have adequate permission to edit entries.&quot;, &quot;gravityforms&quot; ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lead_detail_table = RGFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Inserting lead if null</span>&nbsp;</div></li><li><div>      if ( $lead == NULL ) {&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          $user_id = $current_user && $current_user-&gt;ID ? $current_user-&gt;ID : 'NULL';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lead_table = RGFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>          $user_agent = RGFormsModel::truncate( $_SERVER[&quot;HTTP_USER_AGENT&quot;], 250 );&nbsp;</div></li><li><div>          $currency = GFCommon::get_currency();&nbsp;</div></li><li><div>          $source_url = RGFormsModel::truncate( RGFormsModel::get_current_page_url(), 200 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;INSERT INTO $lead_table(form_id, ip, source_url, date_created, user_agent, currency, created_by) VALUES(%d, %s, %s, utc_timestamp(), %s, %s, {$user_id})&quot;, $form[&quot;id&quot;], RGFormsModel::get_ip(), $source_url, $user_agent, $currency ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//reading newly created lead id</span>&nbsp;</div></li><li><div>          $lead_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>          $lead = array( &quot;id&quot; =&gt; $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_fields = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id, field_number FROM $lead_detail_table WHERE lead_id=%d&quot;, $lead[&quot;id&quot;] ) );&nbsp;</div></li><li><div>      $original_post_id = rgget( &quot;post_id&quot;, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $total_fields = array();&nbsp;</div></li><li><div>      $calculation_fields = array();&nbsp;</div></li><li><div>      $recalculate_total = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $form[&quot;fields&quot;] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Ignore fields that are marked as display only</span>&nbsp;</div></li><li><div>          if ( rgget( &quot;displayOnly&quot;, $field ) && $field[&quot;type&quot;] != &quot;password&quot; ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//ignore pricing fields in the entry detail</span>&nbsp;</div></li><li><div>          if ( RG_CURRENT_VIEW == &quot;entry&quot; && GFCommon::is_pricing_field( $field[&quot;type&quot;] ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//process total field after all fields have been saved</span>&nbsp;</div></li><li><div>          if ( $field[&quot;type&quot;] == &quot;total&quot; ) {&nbsp;</div></li><li><div>              $total_fields[] = $field;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//only save fields that are not hidden (except on entry screen)</span>&nbsp;</div></li><li><div>          if ( RG_CURRENT_VIEW == &quot;entry&quot; || ! RGFormsModel::is_field_hidden( $form, $field, array(), $lead ) ) {&nbsp;</div></li><li><div>              <span class="comment">// process calculation fields after all fields have been saved (moved after the is hidden check)</span>&nbsp;</div></li><li><div>              if ( GFCommon::has_field_calculation( $field ) ) {&nbsp;</div></li><li><div>                  $calculation_fields[] = $field;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $field['type'] == 'post_category' ) {&nbsp;</div></li><li><div>                  $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $field[&quot;inputs&quot;] ) && is_array( $field[&quot;inputs&quot;] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $field[&quot;inputs&quot;] as $input ) {&nbsp;</div></li><li><div>                      RGFormsModel::save_input( $form, $field, $lead, $current_fields, $input[&quot;id&quot;] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  RGFormsModel::save_input( $form, $field, $lead, $current_fields, $field[&quot;id&quot;] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Refresh lead to support conditionals (not optimal but...)</span>&nbsp;</div></li><li><div>          $lead = RGFormsModel::get_lead( $lead['id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $calculation_fields ) ) {&nbsp;</div></li><li><div>          foreach ( $calculation_fields as $calculation_field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $calculation_field[&quot;inputs&quot;] ) && is_array( $calculation_field[&quot;inputs&quot;] ) ) {&nbsp;</div></li><li><div>                  foreach ( $calculation_field[&quot;inputs&quot;] as $input ) {&nbsp;</div></li><li><div>                      RGFormsModel::save_input( $form, $calculation_field, $lead, $current_fields, $input[&quot;id&quot;] );&nbsp;</div></li><li><div>                      RGFormsModel::refresh_lead_field_value( $lead[&quot;id&quot;], $input[&quot;id&quot;] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  RGFormsModel::save_input( $form, $calculation_field, $lead, $current_fields, $calculation_field[&quot;id&quot;] );&nbsp;</div></li><li><div>                  RGFormsModel::refresh_lead_field_value( $lead[&quot;id&quot;], $calculation_field[&quot;id&quot;] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          RGFormsModel::refresh_product_cache( $form, $lead = RGFormsModel::get_lead( $lead['id'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//saving total field as the last field of the form.</span>&nbsp;</div></li><li><div>      if ( ! empty( $total_fields ) ) {&nbsp;</div></li><li><div>          foreach ( $total_fields as $total_field ) {&nbsp;</div></li><li><div>              GFCommon::log_debug( &quot;Saving total field.&quot; );&nbsp;</div></li><li><div>              RGFormsModel::save_input( $form, $total_field, $lead, $current_fields, $total_field[&quot;id&quot;] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function kws_gf_load_functions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If Gravity Forms is installed and exists</span>&nbsp;</div></li><li><div>  if ( defined( 'RG_CURRENT_PAGE' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function gf_field_value( $leadid, $fieldid, $form = array() ) {&nbsp;</div></li><li><div>          echo get_gf_field_value( $leadid, $fieldid, $form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// To retrieve textarea inputs from a lead</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Example: get_gf_field_value_long(22, '14');</span></span>&nbsp;</div></li><li><div>      function get_gf_field_value_long( $leadid, $fieldid, $form = array(), $apply_filter = true ) {&nbsp;</div></li><li><div>          return RGFormsModel::get_field_value_long( $leadid, $fieldid, $form, $apply_filter );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// To retrieve textarea inputs from a lead</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Example: get_gf_field_value_long(22, '14');</span></span>&nbsp;</div></li><li><div>      function get_gf_field_value( $leadid, $fieldid, $form = array() ) {&nbsp;</div></li><li><div>          $lead = RGFormsModel::get_lead( $leadid );&nbsp;</div></li><li><div>          $fieldid = floatval( $fieldid );&nbsp;</div></li><li><div>          if ( is_numeric( $fieldid ) ) {&nbsp;</div></li><li><div>              $result = $lead[&quot;$fieldid&quot;];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $max_length = GFORMS_MAX_FIELD_LENGTH;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strlen( $result ) &gt;= ( $max_length - 50 ) ) {&nbsp;</div></li><li><div>              $result = get_gf_field_value_long( $lead[&quot;id&quot;], $fieldid, $form );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $result = trim( $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $result ) ) {&nbsp;</div></li><li><div>              return $result;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function gf_field_value_long( $leadid, $fieldid, $form = array() ) {&nbsp;</div></li><li><div>          echo get_gf_field_value_long( $leadid, $fieldid, $form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Gives you the label for a form input (such as First Name). Enter in the form and the field ID to access the label.</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Example: echo get_gf_field_label(1, 1.3);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Gives you the label for a form input (such as First Name). Enter in the form and the field ID to access the label.</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Example: echo get_gf_field_label(1, 1.3);</span></span>&nbsp;</div></li><li><div>      function get_gf_field_label( $form_id, $field_id ) {&nbsp;</div></li><li><div>          $form = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>          foreach ( $form[&quot;fields&quot;] as $field ) {&nbsp;</div></li><li><div>              if ( $field['id'] == $field_id ) {&nbsp;</div></li><li><div>                  # $output = RGForms::escape_text($field['label']); <span class="comment"><span class="comment"><span class="comment">// No longer used</span></span></span>&nbsp;</div></li><li><div>                  $output = esc_html( $field['label'] ); <span class="comment">// Using esc_html(), a WP function</span>&nbsp;</div></li><li><div>              } elseif ( is_array( $field['inputs'] ) ) {&nbsp;</div></li><li><div>                  foreach ( $field[&quot;inputs&quot;] as $input ) {&nbsp;</div></li><li><div>                      if ( $input['id'] == $field_id ) {&nbsp;</div></li><li><div>                          if ( class_exists( 'GFCommon' ) ) {&nbsp;</div></li><li><div>                              $output = esc_html( GFCommon::get_label( $field, $field_id ) );&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              #$output = RGForms::escape_text(RGForms::get_label($field, $field_id));  <span class="comment"><span class="comment"><span class="comment">// No longer used</span></span></span>&nbsp;</div></li><li><div>                              $output = esc_html( RGForms::get_label( $field, $field_id ) );  <span class="comment"><span class="comment"><span class="comment">// No longer used</span></span></span>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $output;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function gf_field_label( $form_id, $field_id ) {&nbsp;</div></li><li><div>          echo get_gf_field_label( $form_id, $field_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Returns a form using php instead of shortcode</span>&nbsp;</div></li><li><div>      function get_gf_form( $id, $display_title = true, $display_description = true, $force_display = false, $field_values = NULL ) {&nbsp;</div></li><li><div>          if ( class_exists( 'GFFormDisplay' ) ) {&nbsp;</div></li><li><div>              return GFFormDisplay::get_form( $id, $display_title = true, $display_description = true, $force_display = false, $field_values = NULL );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return RGFormsModel::get_form( $id, $display_title, $display_description );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function gf_form( $id, $display_title = true, $display_description = true, $force_display = false, $field_values = NULL ) {&nbsp;</div></li><li><div>          echo get_gf_form( $id, $display_title, $display_description, $force_display, $field_values );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Returns array of leads for a specific form</span>&nbsp;</div></li><li><div>      function get_gf_leads( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 3000, $star = NULL, $read = NULL, $is_numeric_sort = false, $start_date = NULL, $end_date = NULL, $status = 'active', $approvedcolumn = false, $limituser = false ) {&nbsp;</div></li><li><div>          return GFDirectory::get_leads( $form_id, $sort_field_number, $sort_direction, $search, $offset, $page_size, $star, $read, $is_numeric_sort, $start_date, $end_date, $status, $approvedcolumn, $limituser );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function gf_leads( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 3000, $star = NULL, $read = NULL, $is_numeric_sort = false, $start_date = NULL, $end_date = NULL ) {&nbsp;</div></li><li><div>          echo get_gf_leads( $form_id, $sort_field_number, $sort_direction, $search, $offset, $page_size, $star, $read, $is_numeric_sort, $start_date, $end_date );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function kws_gf_directory( $atts ) {&nbsp;</div></li><li><div>          GFDirectory::make_directory( $atts );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! function_exists( 'kws_print_r' ) ) {&nbsp;</div></li><li><div>          function kws_print_r( $content, $die = false ) {&nbsp;</div></li><li><div>              echo '&lt;pre&gt;' . print_r( $content, true ) . '&lt;/pre&gt;';&nbsp;</div></li><li><div>              if ( $die ) {&nbsp;</div></li><li><div>                  die();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $content;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Ending ?&gt; left out intentionally */</span>&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Gravity Forms Directory &amp; Addons</li><li><span></span>3.8.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>