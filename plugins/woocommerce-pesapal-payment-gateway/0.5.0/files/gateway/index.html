<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="0.5.0" data-slug="woocommerce-pesapal-payment-gateway" data-type="file" data-id="96583"><head xmlns="http://www.w3.org/1999/xhtml"><title> gateway | file | Woocommerce Pesapal Payment Gateway | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-pesapal-payment-gateway, 0.5.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=abce929a3e6b260e4a6f77854e4d8052' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/gateway/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fgateway%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fgateway%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-pesapal-payment-gateway-0.5.0-file-gateway","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gateway" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-pesapal-payment-g&hellip;." href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/" class="plugin"><span property="name">woocommerce-pesapal-payment-g&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><span property="name">0.5.0</span><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gateway</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="13"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/all/" title="All">All <span class="count badge">13</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="1"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/hooks/" title="Hooks">Hooks <span class="count badge">1</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="1"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/filters/" title="Filters">Filters <span class="count badge">1</span></a></li><li class="" data-id="class" data-count="11"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/classes/" title="Classes">Classes <span class="count badge">11</span></a></li><li class="" data-id="constant" data-count="1"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/constants/" title="Constants">Constants <span class="count badge">1</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pesapal-payment-gateway/0.5.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/gateway.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name: Woocommerce Pesapal Payment Gateway</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI: http://bodhi.io</span>&nbsp;</div></li><li><div><span class="comment">Description: Allows use of kenyan payment processor Pesapal - http://pesapal.com.</span>&nbsp;</div></li><li><div><span class="comment">Version: 0.5.0</span>&nbsp;</div></li><li><div><span class="comment">Author: Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">Author URI: http://bodhi.io</span>&nbsp;</div></li><li><div><span class="comment">License: GPLv3</span>&nbsp;</div></li><li><div><span class="comment">License URI: http://www.gnu.org/licenses/gpl-3.0.html</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">Copyright 2012  Jake Lee Kennedy  (email : jake@bodhi.io)</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is free software; you can redistribute it and/or modify</span>&nbsp;</div></li><li><div><span class="comment">it under the terms of the GNU General Public License, version 3, as</span>&nbsp;</div></li><li><div><span class="comment">published by the Free Software Foundation.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is distributed in the hope that it will be useful, </span>&nbsp;</div></li><li><div><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>&nbsp;</div></li><li><div><span class="comment">GNU General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">You should have received a copy of the GNU General Public License</span>&nbsp;</div></li><li><div><span class="comment">along with this program; if not, write to the Free Software</span>&nbsp;</div></li><li><div><span class="comment">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USAv</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Check for woocommerce</span>&nbsp;</div></li><li><div>if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Hooks for adding/ removing the database table, and the wpcron to check them</span>&nbsp;</div></li><li><div>register_activation_hook( __FILE__, 'create_background_checks' );&nbsp;</div></li><li><div>register_deactivation_hook( __FILE__, 'remove_background_checks' );&nbsp;</div></li><li><div>register_uninstall_hook( __FILE__, 'on_uninstall' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// include OAuth</span>&nbsp;</div></li><li><div>define( 'PLUGIN_DIR', dirname(__FILE__).'/' );&nbsp;</div></li><li><div>require_once(PLUGIN_DIR . 'libs/OAuth.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Woocommerce doesn't have KES by default so add it if not already added</span>&nbsp;</div></li><li><div>add_filter( 'woocommerce_currencies', 'add_kenya_shilling' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function add_kenya_shilling( $currencies ) {&nbsp;</div></li><li><div>  if(!isset($currencies['KES'])||!isset($currencies['KSH'])) {&nbsp;</div></li><li><div>     $currencies['KES'] = __( 'Kenyan Shilling', 'woocommerce' );&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>     return $currencies;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_currency_symbol', 'add_kenya_shilling_symbol', 10, 2);&nbsp;</div></li><li><div>function add_kenya_shilling_symbol( $currency_symbol, $currency ) {&nbsp;</div></li><li><div>   switch( $currency ) {&nbsp;</div></li><li><div>      case 'KES': $currency_symbol = '/='; break;&nbsp;</div></li><li><div>   }&nbsp;</div></li><li><div>   return $currency_symbol;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// cron interval for ever 5 minuites</span>&nbsp;</div></li><li><div>add_filter('cron_schedules', 'fivemins_cron_definer');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function fivemins_cron_definer($schedules) {&nbsp;</div></li><li><div>  $schedules['fivemins'] = array(&nbsp;</div></li><li><div>      'interval'=&gt; 300, &nbsp;</div></li><li><div>      'display'=&gt;  __('Once Every 5 minuites')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  return $schedules;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Activation, create processing order table, and table version option</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function create_background_checks()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// Wp_cron checks pending payments in the background</span>&nbsp;</div></li><li><div>  wp_schedule_event(time(), 'fivemins', 'pesapal_background_payment_checks');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Get the table name with the WP database prefix</span>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $db_version = &quot;1.0&quot;;&nbsp;</div></li><li><div>  $table_name = $wpdb-&gt;prefix . &quot;pesapal_queue&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;CREATE TABLE IF NOT EXISTS $table_name (&nbsp;</div></li><li><div>    order_id mediumint(9) NOT NULL, &nbsp;</div></li><li><div>    tracking_id varchar(36) NOT NULL, &nbsp;</div></li><li><div>    time datetime DEFAULT '0000-00-00 00:00:00' NOT NULL, &nbsp;</div></li><li><div>    PRIMARY KEY (order_id, tracking_id)&nbsp;</div></li><li><div> );&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once(ABSPATH . 'wp-admin/includes/upgrade.php');&nbsp;</div></li><li><div>  dbDelta($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_option('pesapal_db_version', $db_version);&nbsp;</div></li><li><div>} &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function remove_background_checks()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $next_sheduled = wp_next_scheduled( 'pesapal_background_payment_checks' );&nbsp;</div></li><li><div>  wp_unschedule_event($next_sheduled, 'pesapal_background_payment_checks');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean up table and options on uninstall</span>&nbsp;</div></li><li><div><span class="comment"> * @return [type] [description]</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function on_uninstall()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// Clean up i.e. delete the table, wp_cron already removed on deacivate</span>&nbsp;</div></li><li><div>  delete_option('pesapal_db_version');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $table_name = $wpdb-&gt;prefix . &quot;pesapal_queue&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;DROP TABLE IF EXISTS $table_name&quot;);&nbsp;</div></li><li><div>} &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('plugins_loaded', 'init_woo_pesapal_gateway', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function init_woo_pesapal_gateway() {&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    class WC_Pesapal_Gateway extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function __construct()&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        $this-&gt;id = 'pesapal';&nbsp;</div></li><li><div>        $this-&gt;method_title = __('Pesapal', 'woocommerce');&nbsp;</div></li><li><div>        $this-&gt;has_fields = false;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Gateway payment URLs</span>&nbsp;</div></li><li><div>        $this-&gt;gatewayurl = 'https:<span class="comment">//pesapal.com/api/PostPesapalDirectOrderV4';</span>&nbsp;</div></li><li><div>        $this-&gt;gatewaytesturl = 'https:<span class="comment">//demo.pesapal.com/api/PostPesapalDirectOrderV4';</span>&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Gateway status URLs</span>&nbsp;</div></li><li><div>        $this-&gt;statusurl = 'http:<span class="comment">//pesapal.com/api/querypaymentstatus';</span>&nbsp;</div></li><li><div>        $this-&gt;statustesturl = 'http:<span class="comment">//demo.pesapal.com/api/querypaymentstatus';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        <span class="comment">// IPN Request URL</span>&nbsp;</div></li><li><div>        $this-&gt;notify_url = str_replace( 'https:', 'http:', add_query_arg( 'wc-api', 'WC_Pesapal_Gateway', home_url( '/' ) ) );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $this-&gt;init_form_fields();&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $this-&gt;init_settings();&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Settings</span>&nbsp;</div></li><li><div>        $this-&gt;title = $this-&gt;get_option('title');&nbsp;</div></li><li><div>        $this-&gt;description = $this-&gt;get_option('description');&nbsp;</div></li><li><div>        $this-&gt;ipn = ($this-&gt;get_option('ipn') === 'yes') ? true : false;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $this-&gt;secretkey = $this-&gt;get_option('secretkey');&nbsp;</div></li><li><div>        $this-&gt;consumerkey = $this-&gt;get_option('consumerkey');&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $this-&gt;testmode = ($this-&gt;get_option('testmode') === 'yes') ? true : false;&nbsp;</div></li><li><div>        $this-&gt;testsecretkey = $this-&gt;get_option('testsecretkey');&nbsp;</div></li><li><div>        $this-&gt;testconsumerkey = $this-&gt;get_option('testconsumerkey');&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Actions</span>&nbsp;</div></li><li><div>        add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// If user wants to use an iframe add the iframe code</span>&nbsp;</div></li><li><div>        if($this-&gt;iframe) { add_action('woocommerce_receipt_pesapal', array(&$this, 'payment_page')); }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        add_action('before_woocommerce_pay', array(&$this, 'before_pay'));&nbsp;</div></li><li><div>        add_action('woocommerce_thankyou_pesapal', array(&$this, 'thankyou_page'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action('pesapal_background_payment_checks', array($this, 'background_check_payment_status'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'woocommerce_api_wc_pesapal_gateway', array( $this, 'ipn_response' ) );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>        add_action('pesapal_process_valid_ipn_request', array($this, 'process_valid_ipn_request'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      function init_form_fields() {&nbsp;</div></li><li><div>        $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Enable/Disable', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; __( 'Enable Pesapal Payment', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Title', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; __( 'Pesapal Payment', 'woothemes' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Description', 'woocommerce' ), &nbsp;</div></li><li><div>            'type' =&gt; 'textarea', &nbsp;</div></li><li><div>            'description' =&gt; __( 'This is the description which the user sees during checkout.', 'woocommerce' ), &nbsp;</div></li><li><div>            'default' =&gt; __(&quot;Payment via Pesapal Gateway, you can pay by either credit/debit card or use mobile payment option such as Mpesa.&quot;, 'woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'ipn' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Use IPN', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; __( 'Use IPN', 'woothemes' ), &nbsp;</div></li><li><div>            'description' =&gt; __( 'Pesapal has the ability to send your site an Instant Payment Notification whenever there is an order update. It is highly reccomended that you enable this, as there are some issues with the &quot;background&quot; status checking. It is disabled by default because the IPN URL needs to be entered in the pesapal control panel.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'ipnurl' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'IPN URL', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'This is the IPN URL that you must enter in the Pesapal control panel. (This is not editable)', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; $this-&gt;notify_url&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'consumerkey' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Pesapal Consumer Key', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'Your Pesapal consumer key which should have been emailed to you.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'secretkey' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Pesapal Secret Key', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'Your Pesapal secret key which should have been emailed to you.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testmode' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Use Demo Gateway', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; __( 'Use Demo Gateway', 'woothemes' ), &nbsp;</div></li><li><div>            'description' =&gt; __( 'Use demo pesapal gateway for testing.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testconsumerkey' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Pesapal Demo Consumer Key', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'Your demo Pesapal consumer key which can be seen at demo.pesapal.com.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testsecretkey' =&gt; array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Pesapal Demo Secret Key', 'woothemes' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'Your demo Pesapal secret key which can be seen at demo.pesapal.com.', 'woothemes' ), &nbsp;</div></li><li><div>            'default' =&gt; ''&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      public function admin_options() {&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;h3&gt;&lt;?php _e('Pesapal Payment', 'woothemes'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>        &lt;p&gt;&lt;?php _e('Allows use of the Pesapal Payment Gateway, all you need is an account at pesapal.com and your consumer and secret key.', 'woothemes'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>          <span class="comment">// Generate the HTML For the settings form.</span>&nbsp;</div></li><li><div>          $this-&gt;generate_settings_html();&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;/table&gt;&nbsp;</div></li><li><div>        &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>        jQuery(function() {&nbsp;</div></li><li><div>          var testMode = jQuery(&quot;#woocommerce_pesapal_testmode&quot;);&nbsp;</div></li><li><div>          var ipn = jQuery(&quot;#woocommerce_pesapal_ipn&quot;);&nbsp;</div></li><li><div>          var ipnurl = jQuery(&quot;#woocommerce_pesapal_ipnurl&quot;);&nbsp;</div></li><li><div>          var consumer = jQuery(&quot;#woocommerce_pesapal_testconsumerkey&quot;);&nbsp;</div></li><li><div>          var secrect = jQuery(&quot;#woocommerce_pesapal_testsecretkey&quot;);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if (testMode.is(&quot;:not(:checked)&quot;)) {&nbsp;</div></li><li><div>            consumer.parents(&quot;tr&quot;).css(&quot;display&quot;, &quot;none&quot;);&nbsp;</div></li><li><div>            secrect.parents(&quot;tr&quot;).css(&quot;display&quot;, &quot;none&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if (ipn.is(&quot;:not(:checked)&quot;)) {&nbsp;</div></li><li><div>            ipnurl.parents(&quot;tr&quot;).css(&quot;display&quot;, &quot;none&quot;);&nbsp;</div></li><li><div>          } &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add onclick handler to checkbox w/id checkme</span>&nbsp;</div></li><li><div>          testMode.click(function() {            &nbsp;</div></li><li><div>            <span class="comment"><span class="comment">// If checked</span></span>&nbsp;</div></li><li><div>            if (testMode.is(&quot;:checked&quot;)) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//show the hidden div</span></span>&nbsp;</div></li><li><div>              consumer.parents(&quot;tr&quot;).show(&quot;fast&quot;);&nbsp;</div></li><li><div>              secrect.parents(&quot;tr&quot;).show(&quot;fast&quot;);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//otherwise, hide it</span></span>&nbsp;</div></li><li><div>              consumer.parents(&quot;tr&quot;).hide(&quot;fast&quot;);&nbsp;</div></li><li><div>              secrect.parents(&quot;tr&quot;).hide(&quot;fast&quot;);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ipn.click(function() {            &nbsp;</div></li><li><div>            <span class="comment"><span class="comment">// If checked</span></span>&nbsp;</div></li><li><div>            if (ipn.is(&quot;:checked&quot;)) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//show the hidden div</span></span>&nbsp;</div></li><li><div>              ipnurl.parents(&quot;tr&quot;).show(&quot;fast&quot;);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//otherwise, hide it</span></span>&nbsp;</div></li><li><div>              ipnurl.parents(&quot;tr&quot;).hide(&quot;fast&quot;);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        });&nbsp;</div></li><li><div>        &lt;/script&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>      } <span class="comment">// End admin_options()</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Thankyou Page</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return void</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function thankyou_page($order_id) {&nbsp;</div></li><li><div>        global $woocommerce;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Remove cart</span>&nbsp;</div></li><li><div>        $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">// Empty awaiting payment session</span>&nbsp;</div></li><li><div>        unset($_SESSION['order_awaiting_payment']);&nbsp;</div></li><li><div>                &nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Proccess payment</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return void</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function process_payment( $order_id ) {&nbsp;</div></li><li><div>        global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>        $order = &new WC_Order( $order_id );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>        <span class="comment">// Redirect to payment page</span>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>          'result' =&gt; 'success', &nbsp;</div></li><li><div>          'redirect' =&gt; add_query_arg('key', $order-&gt;order_key, add_query_arg('order', $order_id, get_permalink(woocommerce_get_page_id('pay'))))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      } <span class="comment">//END process_payment()</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Payment page, creates pesapal oauth request and shows the gateway iframe</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return void</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function payment_page($order_id) {&nbsp;</div></li><li><div>        $url = $this-&gt;create_url($order_id);&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;iframe src=&quot;&lt;?php echo $url;?&gt;&quot; width=&quot;100%&quot; height=&quot;620px&quot;  scrolling=&quot;no&quot; frameBorder=&quot;0&quot;&gt;&nbsp;</div></li><li><div>          &lt;p&gt;Browser unable to load iFrame&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;/iframe&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Before Payment</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return void</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function before_pay()&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        <span class="comment">// if we have come from the gateway do some stuff</span>&nbsp;</div></li><li><div>        if(isset($_GET['pesapal_transaction_tracking_id'])) {&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $order_id = $_GET['order'];&nbsp;</div></li><li><div>          $order = &new WC_Order( $order_id );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $order-&gt;add_order_note( __('Payment accepted, awaiting confirmation.', 'woothemes') );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          add_post_meta( $order_id, 'Pesapal Tracking ID', $_GET['pesapal_transaction_tracking_id']);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if(!$this-&gt;ipn) {&nbsp;</div></li><li><div>            $tracking_id = $_GET['pesapal_transaction_tracking_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>            $table_name = $wpdb-&gt;prefix . 'pesapal_queue';&nbsp;</div></li><li><div>            $wpdb-&gt;insert($table_name, array('order_id' =&gt; $order_id, 'tracking_id' =&gt; $tracking_id, 'time' =&gt; current_time('mysql')), array('%d', '%s', '%s'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          wp_redirect(add_query_arg('key', $order-&gt;order_key, add_query_arg('order', $order_id, get_permalink(woocommerce_get_page_id('thanks')))));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * backgroud check payment</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return void</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function background_check_payment_status()&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $table_name = $wpdb-&gt;prefix . 'pesapal_queue';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $checks = $wpdb-&gt;get_results(&quot;SELECT order_id, tracking_id FROM $table_name&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($wpdb-&gt;num_rows &gt; 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($checks as $check) {&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>            $order = &new WC_Order( $check-&gt;order_id );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>            $status = $this-&gt;status_request($check-&gt;tracking_id, $check-&gt;order_id);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>            switch ($status) {&nbsp;</div></li><li><div>              case 'COMPLETED':&nbsp;</div></li><li><div>                <span class="comment"><span class="comment">// hooray payment complete</span></span>&nbsp;</div></li><li><div>                $order-&gt;add_order_note( __('Payment confirmed.', 'woothemes') );&nbsp;</div></li><li><div>                $order-&gt;payment_complete(); &nbsp;</div></li><li><div>                $wpdb-&gt;query(&quot;DELETE FROM $table_name WHERE order_id = $check-&gt;order_id&quot;);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>              case 'FAILED':&nbsp;</div></li><li><div>                <span class="comment"><span class="comment">// aw, payment failed</span></span>&nbsp;</div></li><li><div>                $order-&gt;update_status('failed', __('Payment denied by gateway.', 'woocommerce'));&nbsp;</div></li><li><div>                $wpdb-&gt;query(&quot;DELETE FROM $table_name WHERE order_id = $check-&gt;order_id&quot;);&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Generate OAuth pesapal payment url</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return string</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function create_url($order_id)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        $order = &new WC_Order( $order_id );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $order_xml = $this-&gt;pesapal_xml($order_id);&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $signature_method = new OAuthSignatureMethod_HMAC_SHA1();&nbsp;</div></li><li><div>        $token = $params = NULL;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment"><span class="comment">//use test vars if in testmode</span></span>&nbsp;</div></li><li><div>        if($this-&gt;testmode) {&nbsp;</div></li><li><div>          $baseurl = $this-&gt;gatewaytesturl;&nbsp;</div></li><li><div>          $consumerkey = $this-&gt;testconsumerkey;&nbsp;</div></li><li><div>          $secretkey = $this-&gt;testsecretkey;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $baseurl = $this-&gt;gatewayurl;&nbsp;</div></li><li><div>          $consumerkey = $this-&gt;consumerkey;&nbsp;</div></li><li><div>          $secretkey = $this-&gt;secretkey;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $thankyou = add_query_arg('key', $order-&gt;order_key, add_query_arg('order', $order_id, get_permalink(woocommerce_get_page_id('pay'))));&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $consumer = new OAuthConsumer($consumerkey, $secretkey);&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $url = OAuthRequest::from_consumer_and_token($consumer, $token, &quot;GET&quot;, $baseurl, $params);&nbsp;</div></li><li><div>        $url-&gt;set_parameter(&quot;oauth_callback&quot;, $thankyou);&nbsp;</div></li><li><div>        $url-&gt;set_parameter(&quot;pesapal_request_data&quot;, $order_xml);&nbsp;</div></li><li><div>        $url-&gt;sign_request($signature_method, $consumer, $token);&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create XML order request</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return string</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function pesapal_xml($order_id) {&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $order = &new WC_Order( $order_id );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $pesapal_args['total'] = $order-&gt;get_total();&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>        $pesapal_args['reference'] = $order_id;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $pesapal_args['first_name'] = $order-&gt;billing_first_name;&nbsp;</div></li><li><div>        $pesapal_args['last_name'] = $order-&gt;billing_last_name;&nbsp;</div></li><li><div>        $pesapal_args['email'] = $order-&gt;billing_email;&nbsp;</div></li><li><div>        $pesapal_args['phone'] = $order-&gt;billing_phone;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $i = 0;&nbsp;</div></li><li><div>        foreach($order-&gt;get_items() as $item) {&nbsp;</div></li><li><div>          $product = $order-&gt;get_product_from_item($item);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $cart[$i] = array(&nbsp;</div></li><li><div>            'id' =&gt; ($product-&gt;get_sku() ? $product-&gt;get_sku() : $product-&gt;id), &nbsp;</div></li><li><div>            'particulars' =&gt; $cart_row['name'], &nbsp;</div></li><li><div>            'quantity' =&gt; $item['qty'], &nbsp;</div></li><li><div>            'unitcost' =&gt; $product-&gt;regular_price, &nbsp;</div></li><li><div>            'subtotal' =&gt; $order-&gt;get_item_total($item, true)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $i++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $xml = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&nbsp;</div></li><li><div>          &lt;PesapalDirectOrderInfo xmlns:xsi=\&quot;http:<span class="comment">//www.w3.org/2001/XMLSchema-instance\&quot; xmlns:xsd=\&quot;http://www.w3.org/2001/XMLSchema\&quot;</span>&nbsp;</div></li><li><div>          Amount=\&quot;&quot; . $pesapal_args['total'] . &quot;\&quot;&nbsp;</div></li><li><div>          Description=\&quot;Order from &quot; . bloginfo('name') . &quot;.\&quot;&nbsp;</div></li><li><div>          Type=\&quot;MERCHANT\&quot;&nbsp;</div></li><li><div>          Reference=\&quot;&quot; . $pesapal_args['reference'] . &quot;\&quot;&nbsp;</div></li><li><div>          FirstName=\&quot;&quot; . $pesapal_args['first_name'] . &quot;\&quot;&nbsp;</div></li><li><div>          LastName=\&quot;&quot; . $pesapal_args['last_name'] . &quot;\&quot;&nbsp;</div></li><li><div>          Email=\&quot;&quot; . $pesapal_args['email'] . &quot;\&quot;&nbsp;</div></li><li><div>          PhoneNumber=\&quot;&quot; . $pesapal_args['phone'] . &quot;\&quot;&nbsp;</div></li><li><div>          Currency=\&quot;&quot; . get_woocommerce_currency() . &quot;\&quot;&nbsp;</div></li><li><div>          xmlns=\&quot;http:<span class="comment">//www.pesapal.com\&quot; /&gt;</span>&nbsp;</div></li><li><div>          &lt;lineitems&gt;&quot;;&nbsp;</div></li><li><div>        foreach($cart as $item) {&nbsp;</div></li><li><div>          $xml .= &quot;&lt;lineitem&nbsp;</div></li><li><div>                uniqueid=\&quot;&quot;.$item['id'].&quot;\&quot;&nbsp;</div></li><li><div>                particulars=\&quot;&quot;.$item['particulars'].&quot;\&quot;&nbsp;</div></li><li><div>                quantity=\&quot;&quot;.$item['quantity'].&quot;\&quot;&nbsp;</div></li><li><div>                unitcost=\&quot;&quot;.$item['unitcost'].&quot;\&quot;&nbsp;</div></li><li><div>                subtotal=\&quot;&quot;.$item['subtotal'].&quot;\&quot;&gt;&lt;/lineitem&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $xml .= &quot;&lt;/lineitems&gt;&lt;/pesapaldirectorderinfo&gt;&quot;;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        return htmlentities($xml);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Status request</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return object</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      function status_request($transaction_id, $merchant_ref)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        $token = $params = NULL;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment"><span class="comment">//use test vars if in testmode</span></span>&nbsp;</div></li><li><div>          if($this-&gt;testmode = true) {&nbsp;</div></li><li><div>          $baseurl = $this-&gt;statustesturl;&nbsp;</div></li><li><div>          $consumerkey = $this-&gt;testconsumerkey;&nbsp;</div></li><li><div>          $secretkey = $this-&gt;testsecretkey;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>          $baseurl = $this-&gt;statusurl;&nbsp;</div></li><li><div>          $consumerkey = $this-&gt;consumerkey;&nbsp;</div></li><li><div>          $secretkey = $this-&gt;secretkey;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>        $consumer = new OAuthConsumer($consumerkey, $secretkey);&nbsp;</div></li><li><div>        $signature_method = new OAuthSignatureMethod_HMAC_SHA1();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request_status = OAuthRequest::from_consumer_and_token($consumer, $token, &quot;GET&quot;, $baseurl, $params);&nbsp;</div></li><li><div>        $request_status-&gt;set_parameter(&quot;pesapal_merchant_reference&quot;, $merchant_ref);&nbsp;</div></li><li><div>        $request_status-&gt;set_parameter(&quot;pesapal_transaction_tracking_id&quot;, $transaction_id);&nbsp;</div></li><li><div>        $request_status-&gt;sign_request($signature_method, $consumer, $token);&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $result = wp_remote_get( $request_status );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        <span class="comment">//curl request</span>&nbsp;</div></li><li><div>        <span class="comment">// $ajax_req =  new XMLHttpRequest();</span>&nbsp;</div></li><li><div>        <span class="comment">// $ajax_req-&gt;open(&quot;GET&quot;, $request_status);</span>&nbsp;</div></li><li><div>        <span class="comment">// $ajax_req-&gt;send();</span>&nbsp;</div></li><li><div>        <span class="comment">//if curl request successful</span>&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        if ($result['response']['code'] == 200) {&nbsp;</div></li><li><div>          $elements = preg_split(&quot;/=/&quot;, $result['body']);&nbsp;</div></li><li><div>          return $elements[1];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * IPN Response</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @return null</span>&nbsp;</div></li><li><div><span class="comment">       * @author Jake Lee Kennedy</span>&nbsp;</div></li><li><div><span class="comment">       **/</span>&nbsp;</div></li><li><div>      public function ipn_response()&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>        @ob_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        error_log(print_r($_GET, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_GET['pesapal_notification_type'])&&!empty($_GET['pesapal_transaction_tracking_id'])&&!empty($_GET['pesapal_merchant_reference'])) {&nbsp;</div></li><li><div>          if($_GET['pesapal_notification_type']==='CHANGE') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            status_header(200);&nbsp;</div></li><li><div>            nocache_headers();&nbsp;</div></li><li><div>            header( 'Content-Type: text/plain; charset=utf-8' );&nbsp;</div></li><li><div>            &nbsp;</div></li><li><div>            <span class="comment">// Get rid of first query param</span>&nbsp;</div></li><li><div>            echo substr($_SERVER['QUERY_STRING'], 26);&nbsp;</div></li><li><div>            &nbsp;</div></li><li><div>            $this-&gt;process_valid_ipn_request($_GET['pesapal_transaction_tracking_id'], $_GET['pesapal_merchant_reference']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            wp_die( &quot;Pesapal IPN Request Failure&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          wp_die( &quot;Pesapal IPN Request Failure&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      public function process_valid_ipn_request($ttid, $merchant_ref)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order = &new WC_Order( $merchant_ref );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($order-&gt;status===&quot;pending&quot;) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $status = $this-&gt;status_request($ttid, $merchant_ref);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ($status) {&nbsp;</div></li><li><div>            case 'COMPLETED':&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// hooray payment complete</span></span>&nbsp;</div></li><li><div>              $order-&gt;add_order_note( __('Payment confirmed.', 'woothemes') );&nbsp;</div></li><li><div>              $order-&gt;payment_complete(); &nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>            case 'FAILED':&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// aw, payment failed</span></span>&nbsp;</div></li><li><div>              $order-&gt;update_status('failed', __('Payment denied by gateway.', 'woocommerce'));&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>    } <span class="comment">// END WC_Pesapal_Gateway Class</span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>} <span class="comment">// END init_woo_pesapal_gateway()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function add_pesapal_gateway( $methods ) {&nbsp;</div></li><li><div>  $methods[] = 'WC_Pesapal_Gateway';&nbsp;</div></li><li><div>  return $methods;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_payment_gateways', 'add_pesapal_gateway' );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Woocommerce Pesapal Payment Gateway</li><li><span></span>0.5.0</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>