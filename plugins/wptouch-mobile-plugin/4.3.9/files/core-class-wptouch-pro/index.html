<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.3.9" data-slug="wptouch-mobile-plugin" data-type="file" data-id="16296"><head xmlns="http://www.w3.org/1999/xhtml"><title> core-class-wptouch-pro | file | Wptouch Mobile Plugin | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wptouch-mobile-plugin, 4.3.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d2b5ca25a8c671600dcb90421a1fe492' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/core-class-wptouch-pro/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcore-class-wptouch-pro%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcore-class-wptouch-pro%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wptouch-mobile-plugin-4.3.9-file-core-class-wptouch-pro","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="core-class-wptouch-pro" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wptouch-mobile-plugin." href="http://hookr.io/plugins/wptouch-mobile-plugin/" class="plugin"><span property="name">wptouch-mobile-plugin</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.3.9." href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/" class="H_VERSION"><span property="name">4.3.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">core-class-wptouch-pro</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="996"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/all/" title="All">All <span class="count badge">996</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="218"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/hooks/" title="Hooks">Hooks <span class="count badge">218</span></a></li><li class="" data-id="action" data-count="60"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/actions/" title="Actions">Actions <span class="count badge">60</span></a></li><li class="" data-id="filter" data-count="158"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/filters/" title="Filters">Filters <span class="count badge">158</span></a></li><li class="" data-id="class" data-count="20"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/classes/" title="Classes">Classes <span class="count badge">20</span></a></li><li class="" data-id="constant" data-count="107"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/constants/" title="Constants">Constants <span class="count badge">107</span></a></li><li class="" data-id="function" data-count="649"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/functions/" title="Functions">Functions <span class="count badge">649</span></a></li><li class="" data-id="shortcode" data-count="2"><a href="http://hookr.io/plugins/wptouch-mobile-plugin/4.3.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">2</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/core/class-wptouch-pro.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>class WPtouchProFour {&nbsp;</div></li><li><div>  <span class="comment">// Set to true when the user is surfing on a supported mobile device</span>&nbsp;</div></li><li><div>  var $is_mobile_device;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set to true when WPtouch is showing a mobile theme</span>&nbsp;</div></li><li><div>  var $showing_mobile_theme;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Contains information about the active user's mobile device</span>&nbsp;</div></li><li><div>  var $active_device;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Contains information about the active user's mobile device</span> class&nbsp;</div></li><li><div>  var $active_device_class;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Contains the BNC API object</span>&nbsp;</div></li><li><div>  var $bnc_api;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Contains a list of installed modules</span>&nbsp;</div></li><li><div>  var $modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Contains the version information while doing an update</span>&nbsp;</div></li><li><div>  var $latest_version_info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stores a debug log</span>&nbsp;</div></li><li><div>  var $debug_log;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stores the current language locale</span>&nbsp;</div></li><li><div>  var $locale;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stores a hash map of icons to sets</span>&nbsp;</div></li><li><div>  var $icon_to_set_map;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stores the post-processed POST variables</span>&nbsp;</div></li><li><div>  var $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stores the post-processed GET variables</span>&nbsp;</div></li><li><div>  var $get;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Stores a list of all internal notifications</span></span>&nbsp;</div></li><li><div>  var $notifications;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Stores a list of all internal notifications</span></span>&nbsp;</div></li><li><div>  var $critical_notifications;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Keeps track whether or not a settings restoration failed</span>&nbsp;</div></li><li><div>  var $restore_failure;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Settings objects, based on domains</span>&nbsp;</div></li><li><div>  var $settings_objects;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For storing menus in themes</span>&nbsp;</div></li><li><div>  var $theme_menus;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Keeps track of whether or not theme updates are available</span>&nbsp;</div></li><li><div>  var $theme_upgrades_available;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Keeps track of whether or not extension updates are available</span>&nbsp;</div></li><li><div>  var $extension_upgrades_available;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $desktop_ajax_nonce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  var $cache_smash;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Shortcodes that must process before AJAX shortcode request</span>&nbsp;</div></li><li><div>  var $preprocess_shortcodes = array( 'gallery', 'new_royalslider', 'contact-form-7', 'metaslider', 'wdi_feed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;is_mobile_device = false;&nbsp;</div></li><li><div>      $this-&gt;showing_mobile_theme = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;active_device = false;&nbsp;</div></li><li><div>      $this-&gt;active_device_class = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;latest_version_info = false;&nbsp;</div></li><li><div>      $this-&gt;icon_to_set_map = false;&nbsp;</div></li><li><div>      $this-&gt;restore_failure = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;modules = array();&nbsp;</div></li><li><div>      $this-&gt;notifications = array();&nbsp;</div></li><li><div>      $this-&gt;post = array();&nbsp;</div></li><li><div>      $this-&gt;get = array();&nbsp;</div></li><li><div>      $this-&gt;settings_object = array();&nbsp;</div></li><li><div>      $this-&gt;theme_menus = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;locale = '';&nbsp;</div></li><li><div>      $this-&gt;desktop_ajax_nonce = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;critical_notifications = array();&nbsp;</div></li><li><div>      $this-&gt;theme_upgrades_available = false;&nbsp;</div></li><li><div>      $this-&gt;extension_upgrades_available = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;cache_smash = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( dirname( __FILE__ ) . '/class-theme.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function invalidate_settings( $domain = false ) {&nbsp;</div></li><li><div>      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Invalidating settings' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;settings_objects[ $domain ] ) ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, '...Invalidated settings on domain ' . $domain . ' were ' . print_r( $this-&gt;settings_objects[ $domain ], true ) );&nbsp;</div></li><li><div>          unsset( $this-&gt;settings_objects[ $domain ] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;settings_objects = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function should_do_desktop_shortcode_magic( $settings = false ) {&nbsp;</div></li><li><div>      if ( !$settings ) {&nbsp;</div></li><li><div>          $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ( $settings-&gt;process_desktop_shortcodes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_self_destruct() {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;post[ 'wptouch-self-destruct' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $nonce = $this-&gt;post[ 'wptouch-self-destruct-nonce' ];&nbsp;</div></li><li><div>          if ( !wp_verify_nonce( $nonce, 'tsarbomba' ) || !current_user_can( 'activate_plugins' ) ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Self Destruct</span>&nbsp;</div></li><li><div>          $wipe_settings = false;&nbsp;</div></li><li><div>          $wipe_wptouch_data = false;&nbsp;</div></li><li><div>          $wipe_deactivate = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $this-&gt;post[ 'wptouch-self-destruct-1'] ) ) {&nbsp;</div></li><li><div>              $wipe_settings = true;&nbsp;</div></li><li><div>          } else if ( isset( $this-&gt;post[ 'wptouch-self-destruct-2' ] ) ) {&nbsp;</div></li><li><div>              $wipe_settings = true;&nbsp;</div></li><li><div>              $wipe_wptouch_data = true;&nbsp;</div></li><li><div>          } else if ( isset( $this-&gt;post[ 'wptouch-self-destruct-3'] ) ) {&nbsp;</div></li><li><div>              $wipe_settings = true;&nbsp;</div></li><li><div>              $wipe_wptouch_data = true;&nbsp;</div></li><li><div>              $wipe_deactivate = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Wipe all settings, including the active domain and foundation/framework</span>&nbsp;</div></li><li><div>          if ( $wipe_settings ) {&nbsp;</div></li><li><div>              $setting_domains = $this-&gt;get_active_setting_domains();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach( $setting_domains as $domain ) {&nbsp;</div></li><li><div>                  if ( $domain == 'bncid' ) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $setting_name = $this-&gt;get_wp_setting_name_for_domain( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;is_domain_site_wide( $domain ) ) {&nbsp;</div></li><li><div>                      delete_site_option( $setting_name );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      delete_option( $setting_name );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              do_action( 'wptouch_after_self_destruct' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $wipe_wptouch_data ) {&nbsp;</div></li><li><div>              require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( wptouch_is_controlled_network() ) {&nbsp;</div></li><li><div>                  wptouch_recursive_delete( WPTOUCH_BASE_CONTENT_MS_DIR );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wptouch_recursive_delete( WPTOUCH_BASE_CONTENT_DIR );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $wipe_deactivate ) {&nbsp;</div></li><li><div>              deactivate_plugins( WPTOUCH_PLUGIN_ACTIVATE_NAME );&nbsp;</div></li><li><div>              wp_redirect( admin_url( 'plugins.php' ) );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              setcookie( 'jQu3ry_5teps_St@te_wptouch-wizard-container', '', time() - 3600 );&nbsp;</div></li><li><div>              wp_redirect( wptouch_admin_url( 'admin.php?page=wptouch-admin-wizard' ) );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;get[ 'wptouch_license_action' ] ) && $this-&gt;get[ 'wptouch_license_action' ] == 'remove_license' ) {&nbsp;</div></li><li><div>          $nonce = $this-&gt;get[ 'wptouch_license_nonce' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( wp_verify_nonce( $nonce, 'tsarbomba' ) && current_user_can( 'activate_plugins' ) ) {&nbsp;</div></li><li><div>              $this-&gt;setup_bncapi();&nbsp;</div></li><li><div>              $this-&gt;bnc_api-&gt;user_remove_license();&nbsp;</div></li><li><div>              wp_redirect( add_query_arg( array( 'wptouch_license_action' =&gt; null, 'wptouch_license_nonce' =&gt; null ) ) );&nbsp;</div></li><li><div>              die;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function initialize() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( 'mobile-user-agents.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to see if we should initialize WPtouch Pro - can be used by certain other plugins to disable WPtouch Pro</span>&nbsp;</div></li><li><div>      <span class="comment">// When not initialized, WPtouch Pro is effectively disabled</span>&nbsp;</div></li><li><div>      $should_init = apply_filters( 'wptouch_should_init_pro', true );&nbsp;</div></li><li><div>      if ( !$should_init ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/admin/customizer/wptouch-customizer.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'WPTOUCH_IS_FREE' ) ) {&nbsp;</div></li><li><div>          add_filter( 'wptouch_settings_override_defaults', array( &$this, 'handle_free_migration' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Ensure we're using free Bauhaus</span>&nbsp;</div></li><li><div>          $settings = $wptouch_pro-&gt;get_settings();&nbsp;</div></li><li><div>          $settings-&gt;current_theme_name = 'bauhaus';&nbsp;</div></li><li><div>          $settings-&gt;current_theme_location = '/plugins/' . WPTOUCH_ROOT_NAME . '/themes';&nbsp;</div></li><li><div>          $settings-&gt;current_theme_friendly_name = 'Bauhaus';&nbsp;</div></li><li><div>          $settings-&gt;save();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only check directories when admin is showing</span>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          $this-&gt;check_directories();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/admin-page-templates.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;cleanup_post_and_get();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prime the settings</span>&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check license</span>&nbsp;</div></li><li><div>      $bncid_settings = wptouch_get_settings( 'bncid' );&nbsp;</div></li><li><div>      if ( !isset( $bncid_settings-&gt;current_version ) || $bncid_settings-&gt;current_version != WPTOUCH_VERSION ) {&nbsp;</div></li><li><div>          $bncid_settings-&gt;current_version = WPTOUCH_VERSION;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wptouch_version_update', WPTOUCH_VERSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$bncid_settings-&gt;license_accepted ) {&nbsp;</div></li><li><div>              $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Check for old license accepted code</span>&nbsp;</div></li><li><div>              if ( isset( $settings-&gt;license_accepted ) && $settings-&gt;license_accepted ) {&nbsp;</div></li><li><div>                  $bncid_settings-&gt;license_accepted = $settings-&gt;license_accepted;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Perform upgrade here</span>&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, '...saving BNCID settings in upgrade path' );&nbsp;</div></li><li><div>          $bncid_settings-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Delete the language information transient so we check for a new language file</span>&nbsp;</div></li><li><div>          delete_site_transient( '_wptouch_language_info' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/class-cache-smash.php' );&nbsp;</div></li><li><div>      $this-&gt;cache_smash = new WPtouchCacheSmash;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          <span class="comment">// New Admin panels</span>&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/admin-load.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'admin_init', array( &$this, 'admin_handle_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'all_admin_notices', array( &$this, 'handle_admin_notices' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'admin_menu', 'wptouch_admin_build_menu' );&nbsp;</div></li><li><div>          add_action( 'network_admin_menu', 'wptouch_admin_build_network_menu' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Icon Upload Ajax</span>&nbsp;</div></li><li><div>          add_action( 'wp_ajax_upload_file', array( &$this, 'handle_upload_file' ) );&nbsp;</div></li><li><div>          add_action( 'wp_ajax_nopriv_upload_file', array( &$this, 'handle_upload_file' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Handle admin AJAX requests from JS</span>&nbsp;</div></li><li><div>          add_action( 'wp_ajax_wptouch_client_ajax', array( &$this, 'handle_client_ajax' ) );&nbsp;</div></li><li><div>          add_action( 'wp_ajax_nopriv_wptouch_client_ajax', array( &$this, 'handle_client_ajax' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Languages</span>&nbsp;</div></li><li><div>          add_filter( 'wptouch_admin_languages', array( &$this, 'setup_custom_languages' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Plugin page</span>&nbsp;</div></li><li><div>          add_filter( 'plugin_action_links', array( &$this, 'wptouch_pro_settings_link' ), 9, 2 );&nbsp;</div></li><li><div>          add_action( 'install_plugins_pre_plugin-information', array( &$this, 'show_plugin_info' ) );&nbsp;</div></li><li><div>          add_action( 'after_plugin_row_wptouch-pro/wptouch-pro.php', array( &$this, 'plugin_row' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Backup/Restore</span>&nbsp;</div></li><li><div>          add_action( 'wptouch_settings_saved', array( &$this, 'check_for_restored_settings' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/cloud-migrate.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;should_do_desktop_shortcode_magic( $settings ) ) {&nbsp;</div></li><li><div>              add_action( 'save_post', array( &$this, 'handle_desktop_shortcode_save_post' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $this-&gt;should_do_desktop_shortcode_magic( $settings ) ) {&nbsp;</div></li><li><div>              add_filter( 'wptouch_force_mobile_device', array( &$this, 'shortcode_override' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( defined( 'WPTOUCH_SHORTCODE_TIMING' ) ) {&nbsp;</div></li><li><div>                  $shortcode_priority = WPTOUCH_SHORTCODE_TIMING;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $shortcode_priority = 10;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              add_action( 'init', array( &$this, 'handle_desktop_shortcode' ), $shortcode_priority);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'wp', array( &$this, 'set_cache_cookie' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wptouch_debug_enable( false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wptouch_available_icon_sets_post_sort', array( &$this, 'setup_custom_icons' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Can be used to adjust the support mobile devices</span>&nbsp;</div></li><li><div>      add_filter( 'wptouch_supported_device_classes', array( &$this, 'augment_supported_devices' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_for_settings_changes( false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Adding root functions files' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loads root functions files from the themes</span>&nbsp;</div></li><li><div>      $this-&gt;load_root_functions_files();&nbsp;</div></li><li><div>      $this-&gt;load_addon_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Do settings download after we load root functions</span>&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() ) {&nbsp;</div></li><li><div>          $this-&gt;check_for_settings_download();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Foundation modules are loaded off of this one</span>&nbsp;</div></li><li><div>      do_action( 'wptouch_root_functions_loaded' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This is where the main user-agent matching happens to determine module or non-mobile</span>&nbsp;</div></li><li><div>      $this-&gt;analyze_user_agent_string();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Mobile content handler (delayed to allow device/display check)</span>&nbsp;</div></li><li><div>      if ( !is_admin() ) {&nbsp;</div></li><li><div>          if ( $this-&gt;should_do_desktop_shortcode_magic( $settings ) && ( $this-&gt;is_mobile_device && $this-&gt;showing_mobile_theme ) ) {&nbsp;</div></li><li><div>              remove_filter( 'the_content', 'wptexturize' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// allow custom preprocess_shortcodes</span>&nbsp;</div></li><li><div>              $custom_preprocess_shortcodes = array();&nbsp;</div></li><li><div>              $custom_preprocess_shortcodes = apply_filters( 'wptouch_preprocess_shortcodes', $custom_preprocess_shortcodes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Need finer-grain control over what gets processed or not.</span>&nbsp;</div></li><li><div>              global $shortcode_tags;&nbsp;</div></li><li><div>              foreach ( $shortcode_tags as $shortcode =&gt; $object ) {&nbsp;</div></li><li><div>                  if ( !in_array( $shortcode, $this-&gt;preprocess_shortcodes ) && !in_array( $shortcode, $custom_preprocess_shortcodes ) ) {&nbsp;</div></li><li><div>                      unset ( $shortcode_tags[ $shortcode ] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              add_filter( 'the_content', array( &$this, 'desktop_shortcode_magic' ), 99 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We have a mobile device, so WPtouch Pro could potentially cache it or allow another app to cache</span>&nbsp;</div></li><li><div>      if ( $this-&gt;is_mobile_device ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, 'User is viewing on a MOBILE device' );&nbsp;</div></li><li><div>          do_action( 'wptouch_cache_enable' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, 'User is viewing on a NON-MOBILE device' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if we're using a version of WordPress that supports themes</span>&nbsp;</div></li><li><div>      if ( function_exists( 'add_theme_support' ) ) {&nbsp;</div></li><li><div>          add_theme_support( 'menus' );&nbsp;</div></li><li><div>          add_action( 'after_setup_theme', array( &$this, 'finish_thumbnail_setup' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to see if the mobile theme should be shown - if so, initialize it</span>&nbsp;</div></li><li><div>      if ( $this-&gt;is_showing_mobile_theme_on_mobile_device() && !$this-&gt;cache_smash-&gt;should_disable_mobile_theme() ) {&nbsp;</div></li><li><div>          $this-&gt;setup_mobile_theme_for_viewing();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// For Google Best Practices</span>&nbsp;</div></li><li><div>          header( 'Vary: User-Agent' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          remove_action( 'wp_enqueue_scripts', 'wptouch_foundation_load_framework_styles', 1 );&nbsp;</div></li><li><div>          add_action( 'wp_footer', array( &$this, 'handle_desktop_footer' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'init', array( &$this, 'finish_initialization' ) );&nbsp;</div></li><li><div>      add_action( 'init', array( &$this, 'setup_desktop_nonce') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_for_critical_notifications();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function shortcode_override( $is_mobile_device ) {&nbsp;</div></li><li><div>      if ( isset( $_GET[ 'wptouch_shortcode' ] ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $is_mobile_device;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function desktop_shortcode_magic( $content ) {&nbsp;</div></li><li><div>      if ( $this-&gt;is_mobile_device && $this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_singular() && ( !is_object( $woocommerce ) || !( is_account_page() || is_cart() || is_checkout() ) ) ) {&nbsp;</div></li><li><div>              $should_regenerate = true;&nbsp;</div></li><li><div>              global $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $shortcode_data = get_post_meta( get_the_ID(), 'wptouch_sc_data', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_array( $shortcode_data ) && isset( $shortcode_data[ 'page-' . $page ] ) ) {&nbsp;</div></li><li><div>                  $shortcode_data = $shortcode_data[ 'page-' . $page ];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $shortcode_data = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $shortcode_data ) {&nbsp;</div></li><li><div>                  if ( $shortcode_data-&gt;has_desktop_shortcode ) {&nbsp;</div></li><li><div>                      if ( $shortcode_data-&gt;valid_until &gt; time() ) {&nbsp;</div></li><li><div>                          <span class="comment">// We can use this shortcode information</span>&nbsp;</div></li><li><div>                          $should_regenerate = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $content = $shortcode_data-&gt;shortcode_content;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          <span class="comment">// Shortcode is not valid</span>&nbsp;</div></li><li><div>                          delete_post_meta( get_the_ID(), 'wptouch_sc_data' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment">// We've already done a request, but there was no desktop shortcodes, so we just return the normal WPtouch content</span>&nbsp;</div></li><li><div>                      $should_regenerate = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_object( $woocommerce ) && ( is_cart() || is_checkout() || is_account_page() ) ) {&nbsp;</div></li><li><div>                  $should_regenerate = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $should_regenerate ) {&nbsp;</div></li><li><div>                  $scripts_object = wp_scripts();&nbsp;</div></li><li><div>                  update_post_meta( get_the_ID(), 'wptouch_sc_scripts', $scripts_object-&gt;queue );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $styles_object = wp_styles();&nbsp;</div></li><li><div>                  update_post_meta( get_the_ID(), 'wptouch_sc_styles', $styles_object-&gt;queue );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  global $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $content = '&lt;div class=&quot;wptouch-sc-content&quot; data-post-id=&quot;' . get_the_ID() . '&quot; data-page=&quot;' . $page . '&quot;&gt;&lt;/div&gt;&lt;div style=&quot;display: none;&quot; class=&quot;wptouch-orig-content&quot;&gt;' . $content . '&lt;/div&gt;';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $content = wptexturize( $content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Enqueue missing scripts</span>&nbsp;</div></li><li><div>                  if ( isset( $shortcode_data-&gt;scripts ) && count( $shortcode_data-&gt;scripts ) &gt; 0 ) {&nbsp;</div></li><li><div>                      foreach ( $shortcode_data-&gt;scripts as $script ) {&nbsp;</div></li><li><div>                          wp_enqueue_script( $script-&gt;handle, $script-&gt;src, $script-&gt;deps, $script-&gt;ver );&nbsp;</div></li><li><div>                          if ( is_array( $script-&gt;extra ) && isset( $script-&gt;extra[ 'data' ] ) ) {&nbsp;</div></li><li><div>                              wp_scripts()-&gt;add_data( $script-&gt;handle, 'data', $script-&gt;extra[ 'data' ] );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Enqueue missing styles</span>&nbsp;</div></li><li><div>                  if ( isset( $shortcode_data-&gt;scripts ) &&  count( $shortcode_data-&gt;styles ) &gt; 0 ) {&nbsp;</div></li><li><div>                      foreach ( $shortcode_data-&gt;styles as $style ) {&nbsp;</div></li><li><div>                          wp_enqueue_style( $style-&gt;handle, $style-&gt;src, $style-&gt;deps, $style-&gt;ver, $style-&gt;args );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $content;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return wptexturize( $content );;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function desktop_shortcode_get_assets( $post_id, $type ) {&nbsp;</div></li><li><div>      <span class="comment">// Compares assets loaded on original page load to those loaded during AJAX content retrieval and prepares the balance for enqueuing in later page views (from our cache)</span>&nbsp;</div></li><li><div>      if ( $type == 'scripts' ) {&nbsp;</div></li><li><div>          $source_object = wp_scripts();&nbsp;</div></li><li><div>      } elseif ( $type == 'styles' ) {&nbsp;</div></li><li><div>          $source_object = wp_styles();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $starting_assets = get_post_meta( $post_id, 'wptouch_sc_' . $type, true );&nbsp;</div></li><li><div>      $queued_assets = $source_object-&gt;queue;&nbsp;</div></li><li><div>      $registered_assets = $source_object-&gt;registered;&nbsp;</div></li><li><div>      if ( is_array( $starting_assets ) ) {&nbsp;</div></li><li><div>          $missing_assets = array_diff( $queued_assets, $starting_assets );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $missing_assets = $queued_assets;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return_array = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $missing_assets as $asset ) {&nbsp;</div></li><li><div>          $return_array[] = $registered_assets[ $asset ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// cleanup postmeta</span>&nbsp;</div></li><li><div>      delete_post_meta( $post_id, 'wptouch_sc_' . $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_desktop_shortcode_save_post( $post_id ) {&nbsp;</div></li><li><div>      delete_post_meta( $post_id, 'wptouch_sc_data' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_desktop_shortcode() {&nbsp;</div></li><li><div>      if ( isset( $_GET[ 'wptouch_shortcode'] ) ) {&nbsp;</div></li><li><div>          $post_nonce = $this-&gt;post[ 'post_nonce' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !wp_verify_nonce( $post_nonce, 'wptouch-ajax' ) ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post = get_post( $this-&gt;post[ 'post_id' ] );&nbsp;</div></li><li><div>          $page = $this-&gt;post[ 'page' ];&nbsp;</div></li><li><div>          $post_content = $this-&gt;post[ 'post_content' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $post ) {&nbsp;</div></li><li><div>              $shortcode_data = get_post_meta( $this-&gt;post[ 'post_id' ], 'wptouch_sc_data', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_object( $shortcode_data ) ) {&nbsp;</div></li><li><div>                  delete_post_meta( $this-&gt;post[ 'post_id'], 'wptouch_sc_data' );&nbsp;</div></li><li><div>                  $shortcode_data = &quot;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Save data for later</span>&nbsp;</div></li><li><div>              $page_shortcode_data = new stdClass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $page_shortcode_data-&gt;has_desktop_shortcode = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Prevent mobile content from overriding this</span>&nbsp;</div></li><li><div>              remove_action( 'the_content', 'wptouch_addon_the_content_mobile_content', 1 );&nbsp;</div></li><li><div>              $content = apply_filters( 'the_content', $post_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $page_shortcode_data-&gt;scripts = $this-&gt;desktop_shortcode_get_assets( $this-&gt;post[ 'post_id' ], 'scripts' );&nbsp;</div></li><li><div>              $page_shortcode_data-&gt;styles = $this-&gt;desktop_shortcode_get_assets( $this-&gt;post[ 'post_id' ], 'styles' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $page_shortcode_data-&gt;valid_until = time() + 3600*24;&nbsp;</div></li><li><div>              $page_shortcode_data-&gt;shortcode_content = $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $shortcode_data[ 'page-' . $page ] = $page_shortcode_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              update_post_meta( $this-&gt;post[ 'post_id' ], 'wptouch_sc_data', $shortcode_data );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          die;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_free_migration( $defaults, $domain ) {&nbsp;</div></li><li><div>      $free_settings = get_option( 'bnc_iphone_pages', false );&nbsp;</div></li><li><div>      if ( $free_settings ) {&nbsp;</div></li><li><div>          if ( !is_array( $free_settings ) ) {&nbsp;</div></li><li><div>              $free_settings = maybe_unserialize( $free_settings );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $domain == 'wptouch_pro' ) {&nbsp;</div></li><li><div>              $defaults-&gt;site_title = $free_settings[ 'header-title' ];&nbsp;</div></li><li><div>              $defaults-&gt;show_wptouch_in_footer = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'home-page' ] ) ) {&nbsp;</div></li><li><div>                  $defaults-&gt;homepage_landing = 'select';&nbsp;</div></li><li><div>                  $defaults-&gt;homepage_redirect_wp_target = $free_settings[ 'home-page' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'statistics' ] ) && $free_settings[ 'statistics' ] ) {&nbsp;</div></li><li><div>                  $defaults-&gt;custom_stats_code = $free_settings[ 'statistics' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'custom-user-agents'] ) && is_array( $free_settings[ 'custom-user-agents'] ) ) {&nbsp;</div></li><li><div>                  $agents = '';&nbsp;</div></li><li><div>                  foreach( $free_settings[ 'custom-user-agents'] as $agent ) {&nbsp;</div></li><li><div>                      $agents = $agents . $agent . &quot;\n&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $defaults-&gt;custom_user_agents = $agents;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $domain == 'foundation' ) {&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'custom-footer-msg' ] ) && $free_settings[ 'custom-footer-msg' ] )  {&nbsp;</div></li><li><div>                  $defaults-&gt;custom_footer_message = $free_settings[ 'custom-footer-msg' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'excluded-cat-ids' ] ) && $free_settings[ 'excluded-cat-ids' ] ) {&nbsp;</div></li><li><div>                  $data = explode( &quot;, &quot;, $free_settings[ 'excluded-cat-ids'] );&nbsp;</div></li><li><div>                  if ( is_array( $data ) && count( $data ) ) {&nbsp;</div></li><li><div>                      $new_cats = array();&nbsp;</div></li><li><div>                      foreach( $data as $cat_id ) {&nbsp;</div></li><li><div>                          $cat_name = get_cat_name( trim( $cat_id ) );&nbsp;</div></li><li><div>                          if ( $cat_name ) {&nbsp;</div></li><li><div>                              $new_cats[] = $cat_name;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( count( $new_cats ) ) {&nbsp;</div></li><li><div>                          $defaults-&gt;excluded_categories = implode( &quot;, &quot;, $new_cats );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'excluded-tag-ids' ] ) && $free_settings[ 'excluded-tag-ids' ] ) {&nbsp;</div></li><li><div>                  $data = explode( &quot;, &quot;, $free_settings[ 'excluded-tag-ids'] );&nbsp;</div></li><li><div>                  if ( is_array( $data ) && count( $data ) ) {&nbsp;</div></li><li><div>                      $new_tags = array();&nbsp;</div></li><li><div>                      foreach( $data as $tag_id ) {&nbsp;</div></li><li><div>                          $tag_name = get_term_by( 'id', trim( $tag_id ), 'post_tag' );&nbsp;</div></li><li><div>                          if ( $tag_name ) {&nbsp;</div></li><li><div>                              $new_tags[] = $tag_name-&gt;name;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( count( $new_tags ) ) {&nbsp;</div></li><li><div>                          $defaults-&gt;excluded_tags = implode( &quot;, &quot;, $new_tags );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $free_settings[ 'excluded-tag-ids' ] ) && $free_settings[ 'excluded-tag-ids' ] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $domain == 'bauhaus' ) {&nbsp;</div></li><li><div>              if ( $free_settings[ 'link-color' ] != '006bb3' ) {&nbsp;</div></li><li><div>                  $defaults-&gt;bauhaus_link_color = '#' . $free_settings[ 'link-color' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $free_settings[ 'header-background-color' ] != '000000' ) {&nbsp;</div></li><li><div>                  $defaults-&gt;bauhaus_header_color = '#' . $free_settings[ 'header-background-color' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $free_settings[ 'header-border-color' ] != '333333' ) {&nbsp;</div></li><li><div>                  $defaults-&gt;bauhaus_post_page_header_color = '#' . $free_settings[ 'header-border-color' ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $defaults;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_critical_notifications() {&nbsp;</div></li><li><div>      if ( defined( 'WPTOUCH_MIGRATION_OLD_ISSUE' ) ) {&nbsp;</div></li><li><div>          $this-&gt;add_critical_notification( sprintf( __( 'Automatic theme migration from wp-content/uploads/wptouch-data directory failed. Please manually move these folders to wp-content/wptouch-data: %s', 'wptouch-pro' ), &quot;&lt;em&gt;'themes', 'icons', 'lang', 'uploads', 'backups'&lt;/em&gt;&quot; ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function can_perform_cloud_install( $theme = true ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/addon-theme-installer.php' );&nbsp;</div></li><li><div>      $installer = new WPtouchAddonThemeInstaller;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $theme ) {&nbsp;</div></li><li><div>          return $installer-&gt;can_perform_install_anywhere( wptouch_get_multsite_aware_install_path( 'themes' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $installer-&gt;can_perform_install( wptouch_get_multsite_aware_install_path( 'extensions' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_admin_notices() {&nbsp;</div></li><li><div>      if ( $this-&gt;cache_smash-&gt;is_wp_super_cache_broken() ) {&nbsp;</div></li><li><div>          <span class="comment">// When Super Cache was active but deactivated</span>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;error&quot;&gt;' .&nbsp;</div></li><li><div>          sprintf( __( '%sWPtouch: %s was recently disabled, but is still affecting your website and caching pages.%s', 'wptouch-pro' ), '&lt;p&gt;&lt;strong style=&quot;color: darkred&quot;&gt;', $this-&gt;cache_smash-&gt;cache_plugin_name(), '&lt;/strong&gt;&lt;/p&gt;' ) .&nbsp;</div></li><li><div>          sprintf( __( '%sPlease reactivate the plugin, disable page caching, then deactivate the plugin again to correct this issue.%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>          sprintf( __( '%sFixing this issue prevents cached desktop pages being served to mobile devices and vice-versa.%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>          sprintf( __( '%sOnce fixed, this message will be dismissed automatically. Until fixed, %sWPtouch will not be shown%s to mobile visitors, and cannot be previewed.%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;em&gt;&lt;strong&gt;', '&lt;/strong&gt;&lt;/em&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>          '&lt;/div&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $this-&gt;cache_smash-&gt;cache_plugin_detected ) {&nbsp;</div></li><li><div>              <span class="comment">// When Super Cache or Total Cache are active</span>&nbsp;</div></li><li><div>              if ( !$this-&gt;cache_smash-&gt;cache_plugin_configured ) {&nbsp;</div></li><li><div>                  echo '&lt;div class=&quot;error&quot;&gt;' .&nbsp;</div></li><li><div>                  sprintf( __( '%sWPtouch: %s needs to be configured to work correctly with WPtouch.%s', 'wptouch-pro' ), '&lt;p&gt;&lt;strong style=&quot;color: darkred&quot;&gt;', $this-&gt;cache_smash-&gt;cache_plugin_name(), '&lt;/strong&gt;&lt;/p&gt;' ) .&nbsp;</div></li><li><div>                  sprintf( __( '%sFixing this issue prevents cached desktop pages being served to mobile devices and vice-versa.%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>                  sprintf( __( '%sOnce fixed, this message will be dismissed automatically. Until fixed, %sWPtouch will not be shown%s to mobile visitors, and cannot be previewed.%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;em&gt;&lt;strong&gt;', '&lt;/strong&gt;&lt;/em&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>                  sprintf( __( '%sTo fix the issue, follow our %sstep-by-step setup guide%s on support.wptouch.com%s', 'wptouch-pro' ), '&lt;p&gt;', '&lt;a href=&quot;' . $this-&gt;cache_smash-&gt;get_cache_support_url() . '?utm_campaign=cache_smash&utm_medium=web&utm_source=' . WPTOUCH_UTM_SOURCE . '&quot; target=&quot;_blank&quot;&gt;', '&lt;/a&gt;', '&lt;/p&gt;' ) .&nbsp;</div></li><li><div>                  '&lt;/div&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wptouch_migration_is_theme_broken() && !wptouch_can_repair_active_theme() && !wptouch_active_theme_is_custom() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;remodal remodal-cloud&quot; data-remodal-id=&quot;modal-repair&quot; data-remodal-options=&quot;hashTracking: false&quot;&gt;';&nbsp;</div></li><li><div>          echo '&lt;button data-remodal-action=&quot;close&quot; class=&quot;remodal-close&quot;&gt;&lt;/button&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;can_perform_cloud_install( true ) ) {&nbsp;</div></li><li><div>              echo '&lt;h1&gt;' . __( &quot;WPtouch Repair Required&quot;, &quot;wptouch-pro&quot; ) . '&lt;/h1&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;progress-repair&quot; class=&quot;license-status&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;progress&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;bar&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;success-msg message&quot;&gt;&nbsp;</div></li><li><div>                  &lt;p&gt;' . __( &quot;Your mobile theme was either broken or missing.&quot;, &quot;wptouch-pro&quot; ) . '&lt;br /&gt;&nbsp;</div></li><li><div>                  ' . __( &quot;We downloaded a fresh copy for you.&quot;, &quot;wptouch-pro&quot; ) . '&lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;button data-remodal-action=&quot;confirm&quot; class=&quot;remodal-confirm&quot;&gt;' . __( &quot;OK&quot;, &quot;wptouch-pro&quot; ) . '&lt;/button&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;failed-msg message&quot;&gt;&nbsp;</div></li><li><div>                  &lt;p&gt;' . wptouchize_it( sprintf( __( &quot;We were unable to install your WPtouch Pro theme from the Cloud. %s Please visit %sthis article%s for more information.&quot;, &quot;wptouch-pro&quot; ), &quot;&lt;br /&gt;&quot;, &quot;&lt;a href='<span class="comment">//support.wptouch.com/support/solutions/articles/5000525305-themes-or-extensions-cannot-be-downloaded'&gt;&quot;, &quot;&lt;/a&gt;&quot; ) ) . '&lt;/p&gt;</span>&nbsp;</div></li><li><div>              &lt;/div&gt;';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo '&lt;h1&gt;' . __( &quot;WPtouch Server Issue&quot;, &quot;wptouch-pro&quot; ) . '&lt;/h1&gt;&nbsp;</div></li><li><div>              &lt;div&gt;&nbsp;</div></li><li><div>              &lt;p&gt;' . wptouchize_it( sprintf( __( 'Your server setup is preventing WPtouch Pro from installing from the Cloud. %s Please visit %sthis article%s for more information on how to fix it.', 'wptouch-pro' ), '&lt;/br &gt;', '&lt;a href=&quot;<span class="comment">//support.wptouch.com/support/solutions/articles/5000525305-themes-or-extensions-cannot-be-downloaded&quot;&gt;', '&lt;/a&gt;' ) ) . '&lt;/p&gt;' .</span>&nbsp;</div></li><li><div>              '&lt;/div&gt;' .&nbsp;</div></li><li><div>              '&lt;button data-remodal-action=&quot;confirm&quot; class=&quot;remodal-confirm&quot;&gt;' . __( &quot;OK&quot;, &quot;wptouch-pro&quot; ) . '&lt;/button&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else if ( $this-&gt;has_critical_notifications() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;error&quot;&gt;';&nbsp;</div></li><li><div>          foreach( $this-&gt;get_critical_notifications() as $notification ) {&nbsp;</div></li><li><div>              echo '&lt;p&gt;' . $notification[0] . '&lt;/p&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function load_addon_modules() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      $execute_hooks = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $multisite_info = get_site_option( 'wptouch_multisite_active', false, false );&nbsp;</div></li><li><div>          if ( $multisite_info ) {&nbsp;</div></li><li><div>              $addon_file_name = WP_CONTENT_DIR . '/' . $multisite_info-&gt;location . '/' . $multisite_info-&gt;addon_name . '/' . $multisite_info-&gt;addon_name . '.php';&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Load the add-on file</span></span>&nbsp;</div></li><li><div>              if ( file_exists( $addon_file_name ) ) {&nbsp;</div></li><li><div>                  require_once( $addon_file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $execute_hooks = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $settings-&gt;active_addons ) ) {&nbsp;</div></li><li><div>          foreach( $settings-&gt;active_addons as $addon_name =&gt; $addon_info ) {&nbsp;</div></li><li><div>              $addon_file_name = WP_CONTENT_DIR . '/' . $addon_info-&gt;location . '/' . $addon_info-&gt;addon_name . '/' . $addon_info-&gt;addon_name . '.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Load the add-on file</span></span>&nbsp;</div></li><li><div>              if ( file_exists( $addon_file_name ) ) {&nbsp;</div></li><li><div>                  require_once( $addon_file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $execute_hooks = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $execute_hooks ) {&nbsp;</div></li><li><div>          do_action( 'wptouch_addon_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_admin() ) {&nbsp;</div></li><li><div>              do_action( 'wptouch_addon_admin_init' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function set_cache_cookie() {&nbsp;</div></li><li><div>      if ( !is_admin() && ( function_exists( 'wptouch_cache_admin_bar' ) || function_exists( 'wptouch_power_pack_admin_bar') ) ) {&nbsp;</div></li><li><div>          global $wptouch_pro;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $cookie_value = 'desktop';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;is_mobile_device ) {&nbsp;</div></li><li><div>              if ( $this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>                  $cookie_value = 'mobile';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $cookie_value = 'mobile-desktop';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( function_exists( 'wptouch_addon_should_cache_desktop' ) ) {&nbsp;</div></li><li><div>              $cache_desktop = wptouch_addon_should_cache_desktop();&nbsp;</div></li><li><div>          } else if ( function_exists( 'wptouch_power_pack_should_cache_desktop' ) ) {&nbsp;</div></li><li><div>              $cache_desktop = wptouch_power_pack_should_cache_desktop();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $cache_desktop = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;is_mobile_device || $cache_desktop === true ) {&nbsp;</div></li><li><div>              if ( !isset( $_COOKIE[ WPTOUCH_CACHE_COOKIE ] ) || ( isset( $_COOKIE[ WPTOUCH_CACHE_COOKIE ] ) && $_COOKIE[ WPTOUCH_CACHE_COOKIE] != $cookie_value ) ) {&nbsp;</div></li><li><div>                  setcookie( WPTOUCH_CACHE_COOKIE, $cookie_value, time() + 3600, '/' );&nbsp;</div></li><li><div>                  $_COOKIE[ WPTOUCH_CACHE_COOKIE ] = $cookie_value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wptouch_cache_page' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function finish_thumbnail_setup() {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup Post Thumbnails</span>&nbsp;</div></li><li><div>      $create_thumbnails = apply_filters( 'wptouch_create_thumbnails', function_exists( 'add_theme_support' ) );&nbsp;</div></li><li><div>      if ( $create_thumbnails ) {&nbsp;</div></li><li><div>          add_theme_support( 'post-thumbnails' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $thumbnail_size = apply_filters( 'wptouch_thumbnail_size', WPTOUCH_THUMBNAIL_SIZE );&nbsp;</div></li><li><div>          add_image_size( 'wptouch-new-thumbnail', $thumbnail_size, $thumbnail_size, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_settings_changes( $update_info = false ) {&nbsp;</div></li><li><div>      <span class="comment">// Process settings</span>&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() ) {&nbsp;</div></li><li><div>          $this-&gt;process_submitted_settings( $update_info );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wptouch_settings_processed' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function finish_initialization() {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_for_settings_changes( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !defined( 'DOING_AJAX' ) ) {&nbsp;</div></li><li><div>          $this-&gt;setup_languages();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For the wptouch shortcode</span>&nbsp;</div></li><li><div>      add_shortcode( 'wptouch', array( &$this, 'handle_shortcode' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_desktop_nonce() {&nbsp;</div></li><li><div>      $this-&gt;desktop_ajax_nonce = wp_create_nonce( 'wptouch-ajax' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function augment_supported_devices( $devices) {&nbsp;</div></li><li><div>      if ( isset( $devices[ WPTOUCH_DEFAULT_DEVICE_CLASS ] ) ) {&nbsp;</div></li><li><div>          $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $user_agents = trim( $settings-&gt;custom_user_agents );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strlen( $user_agents) ) {&nbsp;</div></li><li><div>              <span class="comment">// get user agents</span>&nbsp;</div></li><li><div>              $agents = explode( &quot;\n&quot;, str_replace( &quot;\r\n&quot;, &quot;\n&quot;, $user_agents ) );&nbsp;</div></li><li><div>              if ( is_array( $agents) && count( $agents ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// add our custom user agents</span>&nbsp;</div></li><li><div>                  $devices[ WPTOUCH_DEFAULT_DEVICE_CLASS ] = array_merge( $devices[ WPTOUCH_DEFAULT_DEVICE_CLASS ], $agents );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $devices;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_handle_init() {&nbsp;</div></li><li><div>      require_once( dirname( __FILE__ ) . '/info.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;check_for_self_destruct();&nbsp;</div></li><li><div>      $this-&gt;admin_initialize();&nbsp;</div></li><li><div>      $this-&gt;setup_admin_stylesheets();&nbsp;</div></li><li><div>      $this-&gt;handle_admin_menu_commands();&nbsp;</div></li><li><div>      $this-&gt;setup_automatic_backup();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// wptouch_update_info();</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_automatic_backup() {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>      <span class="comment">// Check to see if we've schedule the event</span>&nbsp;</div></li><li><div>      if ( !wp_next_scheduled( 'wptouch_cron_backup_settings' ) ) {&nbsp;</div></li><li><div>          $next_time = floor( time() / WPTOUCH_SECS_IN_DAY ) + WPTOUCH_SECS_IN_DAY;&nbsp;</div></li><li><div>          wp_schedule_event( $next_time, 'daily', 'wptouch_cron_backup_settings' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_settings_download() {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;get[ 'action' ] ) && $this-&gt;get[ 'action' ] == 'wptouch-download-settings' ) {&nbsp;</div></li><li><div>          $nonce = $this-&gt;get[ 'nonce' ];&nbsp;</div></li><li><div>          if( wp_verify_nonce( $nonce, 'wptouch_admin' ) ) {&nbsp;</div></li><li><div>              if ( current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $file_name = WPTOUCH_BACKUP_DIRECTORY . '/' . $this-&gt;get[ 'backup_file' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $backup_data = $this-&gt;load_file( $file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  header( 'Content-type: text/plain' );&nbsp;</div></li><li><div>                  header( 'Content-Disposition: attachment; filename=&quot;' . $this-&gt;get[ 'backup_file' ] . '&quot;' );&nbsp;</div></li><li><div>                  header( 'Content-length: ' . strlen( $backup_data ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  echo $backup_data;&nbsp;</div></li><li><div>                  die;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_is_wptouch_page() {&nbsp;</div></li><li><div>      return ( is_admin() && strpos( $_SERVER['REQUEST_URI'], 'page=wptouch-' ) !== false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_is_menu_page() {&nbsp;</div></li><li><div>      return ( is_admin() && strpos( $_SERVER[ 'REQUEST_URI' ], 'nav-menus.php' ) !== false && ( !isset( $_REQUEST[ 'action'] ) || $_REQUEST[ 'action' ] != 'locations' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_initialize() {&nbsp;</div></li><li><div>      $is_plugins_page = ( strpos( $_SERVER['REQUEST_URI'], 'plugins.php' ) !== false );&nbsp;</div></li><li><div>      $is_wizard_page = ( strpos( $_SERVER['REQUEST_URI'], '?page=wptouch-admin-wizard' ) !== false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We need the BNCAPI for checking for plugin updates and all the wptouch-pro admin functions</span>&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() || $is_plugins_page ) {&nbsp;</div></li><li><div>          $this-&gt;setup_bncapi();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only check for updates explicitly on plugins page</span>&nbsp;</div></li><li><div>      if ( $is_plugins_page ) {&nbsp;</div></li><li><div>          $can_check_for_update = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $can_check_for_update ) {&nbsp;</div></li><li><div>              WPTOUCH_DEBUG( WPTOUCH_INFO, 'Checking for product update' );&nbsp;</div></li><li><div>              $this-&gt;check_for_update( true );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remodal, load everywhere except wizard</span>&nbsp;</div></li><li><div>      if ( !$is_wizard_page ) {&nbsp;</div></li><li><div>          wp_enqueue_script( 'wptouch-remodal', WPTOUCH_URL . '/admin/js/wptouch-admin-remodal.js', array( 'wptouch-pro-ajax' ), md5( WPTOUCH_VERSION ), true );&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-remodal', WPTOUCH_URL . '/admin/css/wptouch-admin-remodal.css', false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// load the core AJAX on all pages</span>&nbsp;</div></li><li><div>      $theme_broken = wptouch_migration_is_theme_broken() && !wptouch_can_repair_active_theme();&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() || $theme_broken ) {&nbsp;</div></li><li><div>          $ajax_params = array(&nbsp;</div></li><li><div>              'admin_ajax_nonce' =&gt; wp_create_nonce( 'wptouch_admin_ajax' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script( 'wptouch-pro-ajax', WPTOUCH_URL . '/admin/js/wptouch-ajax.js', array( 'jquery' ), md5( WPTOUCH_VERSION ), true );&nbsp;</div></li><li><div>          wp_localize_script( 'wptouch-pro-ajax', 'WPtouchAjax', $ajax_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $theme_broken && !defined( 'WPTOUCH_IS_FREE' ) ) {&nbsp;</div></li><li><div>              wp_enqueue_script( 'wptouch-cloud-migrate', WPTOUCH_URL . '/admin/js/wptouch-admin-migrate.js', array( 'wptouch-pro-ajax' ), md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check for broken plugins</span>&nbsp;</div></li><li><div>      wptouch_migration_check_for_broken_extensions();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//  load the rest of the admin scripts when we're looking at the WPtouch Pro page</span>&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() ) {&nbsp;</div></li><li><div>          $localize_params =     array(&nbsp;</div></li><li><div>              'admin_url' =&gt; get_bloginfo('wpurl') . '/wp-admin', &nbsp;</div></li><li><div>              'plugin_admin_image_url' =&gt; WPTOUCH_ADMIN_URL . '/images', &nbsp;</div></li><li><div>              'admin_nonce' =&gt; wp_create_nonce( 'wptouch_admin' ), &nbsp;</div></li><li><div>              'plugin_url' =&gt; admin_url( 'admin.php?page=' . $_GET['page'] ), &nbsp;</div></li><li><div>              'reset_settings' =&gt; wptouchize_it( __( &quot;This will reset all WPtouch Pro settings.\nAre you sure?&quot;, 'wptouch-pro' ) ), &nbsp;</div></li><li><div>              'reset_delete' =&gt; __( &quot;This will reset all WPtouch Pro settings and delete the wptouch-data folder.\nAre you sure?&quot;, 'wptouch-pro' ), &nbsp;</div></li><li><div>              'reset_delete_deactivate' =&gt; __( &quot;This will reset all WPtouch Pro settings, delete the wptouch-data folder, and deactivate the plugin. Are you sure?&quot;, 'wptouch-pro' ), &nbsp;</div></li><li><div>              'cloud_download_fail' =&gt; __( 'The item failed to download for this reason: %reason%', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'remove_license' =&gt; __( 'You are about to reset your license information. Proceed?', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'upload_complete' =&gt; __( 'Upload Complete!', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'upload_invalid' =&gt; __( 'Upload Failed: Not a valid image.', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'saving_settings' =&gt; __( 'WPtouch is saving settings. Please do not refresh the page while saving.', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'install_themes' =&gt; __( 'Install Themes', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'install_extensions' =&gt; __( 'Install Extensions', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'install' =&gt; __( 'Install', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'installing' =&gt; __( 'Installing', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'installed' =&gt; __( 'Installed', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'download' =&gt; __( 'Download', 'wptouch-pro' ), &nbsp;</div></li><li><div>              'is_network_admin' =&gt; is_network_admin()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// 4.0 Adding some easing :)</span>&nbsp;</div></li><li><div>          wp_enqueue_script(&nbsp;</div></li><li><div>              'jquery-easing', &nbsp;</div></li><li><div>              '<span class="comment">//cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js', </span>&nbsp;</div></li><li><div>              array( 'jquery' ), &nbsp;</div></li><li><div>              md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>              false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $_SERVER['REQUEST_URI'], 'wptouch-admin-wizard' ) == true ) {&nbsp;</div></li><li><div>              <span class="comment">// 4.0 Wizard Script</span>&nbsp;</div></li><li><div>              wp_enqueue_script(&nbsp;</div></li><li><div>                  'wptouch-wizard', &nbsp;</div></li><li><div>                  WPTOUCH_URL . '/admin/js/wptouch-admin-wizard.js', &nbsp;</div></li><li><div>                  array( 'jquery', 'wptouch-admin-plugins' ), &nbsp;</div></li><li><div>                  md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>                  false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script(&nbsp;</div></li><li><div>              'wptouch-admin-plugins', &nbsp;</div></li><li><div>              WPTOUCH_URL . '/admin/js/wptouch-admin-plugins.js', &nbsp;</div></li><li><div>              array( 'jquery' ), &nbsp;</div></li><li><div>              md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>              false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_localize_script( 'wptouch-admin-plugins', 'WPtouchCustom', $localize_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $_SERVER['REQUEST_URI'], 'wptouch-admin-wizard' ) == false ) {&nbsp;</div></li><li><div>              wp_enqueue_script(&nbsp;</div></li><li><div>                  'wptouch-pro-admin', &nbsp;</div></li><li><div>                  WPTOUCH_URL . '/admin/js/wptouch-admin-4.js', &nbsp;</div></li><li><div>                  array( 'wptouch-admin-plugins', 'wptouch-pro-ajax', 'jquery', 'jquery-easing' ), &nbsp;</div></li><li><div>                  md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>                  false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( defined( 'WPTOUCH_IS_FREE' ) ) {&nbsp;</div></li><li><div>                  wp_enqueue_style( 'wp-color-picker' );&nbsp;</div></li><li><div>                  wp_enqueue_script(&nbsp;</div></li><li><div>                      'wptouch-pro-admin-color', &nbsp;</div></li><li><div>                      WPTOUCH_URL . '/admin/js/wptouch-admin-color.js', &nbsp;</div></li><li><div>                      array( 'wptouch-pro-admin', 'wp-color-picker' ), &nbsp;</div></li><li><div>                      md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>                      false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else { <span class="comment">// Not a WPtouch admin page</span>&nbsp;</div></li><li><div>          $localize_params =     array(&nbsp;</div></li><li><div>              'admin_url' =&gt; get_bloginfo('wpurl') . '/wp-admin', &nbsp;</div></li><li><div>              'admin_nonce' =&gt; wp_create_nonce( 'wptouch_admin' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script(&nbsp;</div></li><li><div>              'wptouch-pro-ajax', &nbsp;</div></li><li><div>              WPTOUCH_URL . '/admin/js/wptouch-ajax.js', &nbsp;</div></li><li><div>              array( 'jquery' ), &nbsp;</div></li><li><div>              md5( WPTOUCH_VERSION ), &nbsp;</div></li><li><div>              false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ajax_params = array(&nbsp;</div></li><li><div>              'admin_ajax_nonce' =&gt; wp_create_nonce( 'wptouch_admin_ajax' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_localize_script( 'wptouch-pro-ajax', 'WPtouchAjax', $ajax_params );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;setup_wptouch_admin_ajax();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function load_root_functions_files() {&nbsp;</div></li><li><div>      <span class="comment">// Load root functions files only if we are in the admin or we are showing a mobile theme</span>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/menu.php' );&nbsp;</div></li><li><div>      $clear_settings = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the parent root-functions if it exists</span>&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>          if ( $parent_info-&gt;framework &gt; 1 && ( $theme_info-&gt;framework &lt;= 1 || $theme_info-&gt;framework == false ) ) {&nbsp;</div></li><li><div>              wptouch_load_framework();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( file_exists( WP_CONTENT_DIR . $parent_info-&gt;location . '/root-functions.php' ) ) {&nbsp;</div></li><li><div>              require_once( WP_CONTENT_DIR . $parent_info-&gt;location . '/root-functions.php' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// next time get_settings is called, the current theme defaults will be added in</span></span>&nbsp;</div></li><li><div>          $clear_settings = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the current theme functions.php, or the child root functions if it exists in WPtouch themes</span>&nbsp;</div></li><li><div>      if ( file_exists( $this-&gt;get_current_theme_directory() . '/root-functions.php' ) ) {&nbsp;</div></li><li><div>          if ( isset( $theme_info-&gt;framework ) && $theme_info-&gt;framework &gt; 1 ) {&nbsp;</div></li><li><div>              wptouch_load_framework();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          require_once( $this-&gt;get_current_theme_directory() . '/root-functions.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// next time get_settings is called, the current theme defaults will be added in</span></span>&nbsp;</div></li><li><div>          $clear_settings = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load a custom functions.php file</span>&nbsp;</div></li><li><div>      if ( file_exists( WPTOUCH_BASE_CONTENT_DIR . '/functions.php' ) ) {&nbsp;</div></li><li><div>          require_once( WPTOUCH_BASE_CONTENT_DIR . '/functions.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_functions_loaded' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $clear_settings ) {&nbsp;</div></li><li><div>          <span class="comment">// each theme can add it's own default settings, so we need to reset our internal settings object</span>&nbsp;</div></li><li><div>          <span class="comment">// so that the defaults will get merged in from the current theme</span>&nbsp;</div></li><li><div>          $this-&gt;reload_settings();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function analyze_user_agent_string() {&nbsp;</div></li><li><div>      <span class="comment">// check and set cookie</span>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;get['wptouch_switch'] ) ) {&nbsp;</div></li><li><div>          $expires_time = time()+3600*24*365; <span class="comment">// 365 days</span>&nbsp;</div></li><li><div>          setcookie( WPTOUCH_COOKIE, $this-&gt;get['wptouch_switch'], $expires_time, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $_COOKIE[ WPTOUCH_CACHE_COOKIE ] ) ) {&nbsp;</div></li><li><div>              if ( $this-&gt;get[ 'wptouch_switch' ] == 'desktop' ) {&nbsp;</div></li><li><div>                  setcookie ( WPTOUCH_CACHE_COOKIE, 'mobile-desktop', $expires_time );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  setcookie ( WPTOUCH_CACHE_COOKIE, 'mobile', $expires_time );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $this-&gt;get[ 'nonce' ] ) && wp_verify_nonce( $this-&gt;get[ 'nonce' ], 'wptouch_switch' ) ) {&nbsp;</div></li><li><div>              $this-&gt;redirect_to_page( $this-&gt;get['redirect'] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;redirect_to_page( remove_query_arg( array( 'wptouch_switch', 'redirect', 'nonce' ) ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Settings are reloaded inside this function since themes can augment the user-agent data</span>&nbsp;</div></li><li><div>      $this-&gt;is_mobile_device = apply_filters( 'wptouch_force_mobile_device', $this-&gt;is_supported_device() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We can have a mobile device detected, but not show the mobile theme</span>&nbsp;</div></li><li><div>      <span class="comment">// usually this is a result of the user manually disabling it via a link in the footer</span>&nbsp;</div></li><li><div>      if ( $this-&gt;is_mobile_device ) {&nbsp;</div></li><li><div>          $this-&gt;showing_mobile_theme = ( !isset( $_COOKIE[WPTOUCH_COOKIE] ) || $_COOKIE[WPTOUCH_COOKIE] === 'mobile' || wptouch_is_customizing_mobile() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>              if ( $settings-&gt;url_filter_behaviour != 'disabled' && $settings-&gt;filtered_urls ) {&nbsp;</div></li><li><div>                  $server_url = strtolower( $_SERVER['REQUEST_URI'] );&nbsp;</div></li><li><div>                  $url_list = preg_split('/\R/', trim( strtolower( $settings-&gt;filtered_urls ) ) );&nbsp;</div></li><li><div>                  $block_mobile = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $settings-&gt;url_filter_behaviour == 'exclusive_urls' ) {&nbsp;</div></li><li><div>                      $block_mobile = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach( $url_list as $url ) {&nbsp;</div></li><li><div>                      if ( $this-&gt;compare_url( $url, $server_url, $settings-&gt;filtered_urls_exact ) ) {&nbsp;</div></li><li><div>                          if ( $settings-&gt;url_filter_behaviour == 'exclude_urls' ) { <span class="comment">// Excluding URLs - kill mobile if the URL is matched</span>&nbsp;</div></li><li><div>                              $block_mobile = true;&nbsp;</div></li><li><div>                          } elseif( $settings-&gt;url_filter_behaviour == 'exclusive_urls' ) { <span class="comment">// Exclusive URLs - kill mobile if the URL is *not* matched</span>&nbsp;</div></li><li><div>                              $block_mobile = false;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Allow WPtouch to run on the homepage if we're going to wind up redirecting to a landing page.</span>&nbsp;</div></li><li><div>                  if ( $settings-&gt;homepage_landing != 'none' && $server_url == '/' ) {&nbsp;</div></li><li><div>                      $block_mobile = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $block_mobile ) {&nbsp;</div></li><li><div>                      $this-&gt;showing_mobile_theme = false;&nbsp;</div></li><li><div>                      $this-&gt;is_mobile_device = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Filter to programmatically disable WPtouch Pro on a certain page</span>&nbsp;</div></li><li><div>      $this-&gt;showing_mobile_theme = apply_filters( 'wptouch_should_show_mobile_theme', $this-&gt;showing_mobile_theme );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Mobile support is only for clients, not the admin</span>&nbsp;</div></li><li><div>      $force_mobile_ajax = false;&nbsp;</div></li><li><div>      if ( apply_filters( 'wptouch_force_mobile_ajax', false ) && $this-&gt;is_mobile_device && $this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>          $force_mobile_ajax = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !wptouch_is_customizing_mobile() && is_admin() && !$force_mobile_ajax && !isset( $this-&gt;post[ 'wptouch_switch_location' ] ) ) {&nbsp;</div></li><li><div>          $this-&gt;is_mobile_device = false;&nbsp;</div></li><li><div>          $this-&gt;showing_mobile_theme = false;&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$this-&gt;showing_mobile_theme && $settings-&gt;show_switch_link ) {&nbsp;</div></li><li><div>          add_action( 'wp_footer', array( &$this, 'show_desktop_switch_link' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'response_modify_cache_key', array( &$this, 'modify_response_key' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function compare_url( $comparison_url, $requested_url, $exact_match = false ) {&nbsp;</div></li><li><div>      if ( $comparison_url == '/' && $requested_url == '/' ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ( !$exact_match && $comparison_url != '/' && strpos( trim( $requested_url, '\/' ), trim( $comparison_url, '\/' ) ) !== false ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif( $exact_match && $comparison_url != '/' && trim( $requested_url, '\/' ) == trim( $comparison_url, '\/' ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function modify_response_key( $current_key ) {&nbsp;</div></li><li><div>      if ( $this-&gt;is_mobile_device ) {&nbsp;</div></li><li><div>          if ( $this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>              return md5( $current_key . 'MobileOnMobile' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return md5( $current_key . 'DesktopOnMobile' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $current_key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_mobile_theme_for_viewing() {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_mobile_theme_showing' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove the admin bar in WPtouch Pro themes for now</span>&nbsp;</div></li><li><div>      if ( function_exists( 'show_admin_bar' ) ) {&nbsp;</div></li><li><div>          add_filter( 'show_admin_bar', '__return_false' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Theme functions</span>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/theme.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Menu Tags</span>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/menu.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// These actions and filters are only loaded when WPtouch and a mobile theme are active</span>&nbsp;</div></li><li><div>      add_action( 'wp', array( &$this, 'check_for_redirect' ) );&nbsp;</div></li><li><div>      add_filter( 'init', array( &$this, 'init_theme' ) );&nbsp;</div></li><li><div>      add_filter( 'excerpt_length', array( &$this, 'get_excerpt_length' ) );&nbsp;</div></li><li><div>      add_filter( 'excerpt_more', array( &$this, 'get_excerpt_more' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// New switch hooks</span>&nbsp;</div></li><li><div>      add_filter( 'template_directory', array( &$this, 'get_template_directory' ) );&nbsp;</div></li><li><div>      add_filter( 'template_directory_uri', array( &$this, 'get_template_directory_uri' ) );&nbsp;</div></li><li><div>      add_filter( 'stylesheet_directory', array( &$this, 'get_stylesheet_directory' ) );&nbsp;</div></li><li><div>      add_filter( 'stylesheet_directory_uri', array( &$this, 'get_stylesheet_directory_uri' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wp_get_attachment_url', array( &$this, 'https_for_ssl' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'template_redirect', array( &$this, 'intercept_template' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wp_enqueue_scripts', array( &$this, 'setup_theme_styles' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings-&gt;remove_shortcodes ) && strlen( $settings-&gt;remove_shortcodes ) ) {&nbsp;</div></li><li><div>          $this-&gt;remove_shortcodes( $settings-&gt;remove_shortcodes );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/theme.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function intercept_template() {&nbsp;</div></li><li><div>      if ( is_page() ) {&nbsp;</div></li><li><div>          global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR .'/core/admin-page-templates.php' );&nbsp;</div></li><li><div>          $mobile_template = wptouch_get_page_template( $post-&gt;ID );&nbsp;</div></li><li><div>          if ( $mobile_template ) {&nbsp;</div></li><li><div>              $template_file = $this-&gt;get_stylesheet_directory( false ) . '/' . $mobile_template;&nbsp;</div></li><li><div>              if ( file_exists( $template_file ) ) {&nbsp;</div></li><li><div>                  include( $template_file );&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $template_file = $this-&gt;get_template_directory( false ) . '/' . $mobile_template;&nbsp;</div></li><li><div>              if ( file_exists( $template_file ) ) {&nbsp;</div></li><li><div>                  include( $template_file );&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_activation() {&nbsp;</div></li><li><div>      <span class="comment">// activation hook</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clear shortcode data</span>&nbsp;</div></li><li><div>      delete_post_meta_by_key( 'wptouch_sc_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_root = get_home_path();&nbsp;</div></li><li><div>      if ( file_exists( $site_root . 'robots.txt' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_deactivation() {&nbsp;</div></li><li><div>      <span class="comment">// Cancel our automatic backup hook</span>&nbsp;</div></li><li><div>      if ( wp_next_scheduled( 'wptouch_cron_backup_settings' ) ) {&nbsp;</div></li><li><div>          wp_clear_scheduled_hook( 'wptouch_cron_backup_settings' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function update_encoded_setting( $encoded_setting, $new_value ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/settings.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $decoded_setting = wptouch_decode_encoded_setting( $encoded_setting );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = wptouch_get_settings( $decoded_setting-&gt;domain );&nbsp;</div></li><li><div>      $name = $decoded_setting-&gt;name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings-&gt;$name = $new_value;&nbsp;</div></li><li><div>      $settings-&gt;save();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_upload_file() {&nbsp;</div></li><li><div>      $this-&gt;cleanup_post_and_get();&nbsp;</div></li><li><div>      header( 'HTTP/1.1 200 OK' );&nbsp;</div></li><li><div>      $nonce = $this-&gt;post[ 'wp_nonce' ];&nbsp;</div></li><li><div>      if( wp_verify_nonce( $nonce, 'wptouch_admin' ) && current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>          switch( $this-&gt;post[ 'file_type'] ) {&nbsp;</div></li><li><div>              case 'homescreen_image':&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Uploading new HOMESCREEN image' );&nbsp;</div></li><li><div>                  if ( $this-&gt;is_image_file( $_FILES[ 'myfile' ][ 'name' ] ) ) {&nbsp;</div></li><li><div>                      <span class="comment">// Move uploaded file</span>&nbsp;</div></li><li><div>                      if ( isset( $_FILES[ 'myfile' ] ) ) {&nbsp;</div></li><li><div>                          $temp_name = $_FILES[ 'myfile' ][ 'tmp_name' ];&nbsp;</div></li><li><div>                          $real_name = $_FILES[ 'myfile' ][ 'name' ];&nbsp;</div></li><li><div>                          $real_name = str_replace( ' ', '-', $real_name );&nbsp;</div></li><li><div>                          $destination_file = WPTOUCH_CUSTOM_UPLOAD_DIRECTORY . '/' . $real_name;&nbsp;</div></li><li><div>                          if ( file_exists( $destination_file ) ) {&nbsp;</div></li><li><div>                              unlink( $destination_file );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          move_uploaded_file( $temp_name, $destination_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          require_once( WPTOUCH_DIR . '/core/settings.php' );&nbsp;</div></li><li><div>                          do_action( 'wptouch_post_process_image_file', $destination_file, wptouch_decode_encoded_setting( $this-&gt;post[ 'setting_name'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $image_file = str_replace( WPTOUCH_BASE_CONTENT_DIR, '', $destination_file ) ;&nbsp;</div></li><li><div>                          $this-&gt;update_encoded_setting( $this-&gt;post[ 'setting_name'], $image_file );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo WPTOUCH_BASE_CONTENT_URL . $image_file;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      echo 'invalid image';&nbsp;</div></li><li><div>                      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Not a valid image' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'custom_image':&nbsp;</div></li><li><div>                  if ( $this-&gt;is_image_file( $_FILES[ 'myfile' ][ 'name' ] ) ) {&nbsp;</div></li><li><div>                      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Uploading new CUSTOM image' );&nbsp;</div></li><li><div>                      if ( isset( $_FILES[ 'myfile' ] ) ) {&nbsp;</div></li><li><div>                          $temp_name = $_FILES[ 'myfile' ][ 'tmp_name' ];&nbsp;</div></li><li><div>                          $real_name = $_FILES[ 'myfile' ][ 'name' ];&nbsp;</div></li><li><div>                          $real_name = str_replace( ' ', '-', $real_name );&nbsp;</div></li><li><div>                          $destination_file = WPTOUCH_CUSTOM_ICON_DIRECTORY . '/' . $real_name;&nbsp;</div></li><li><div>                          if ( file_exists( $destination_file ) ) {&nbsp;</div></li><li><div>                              unlink( $destination_file );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          move_uploaded_file( $temp_name, $destination_file );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      echo 'invalid image';&nbsp;</div></li><li><div>                      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Not a valid image' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'settings_backup':&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Uploading SETTINGS BACKUP file' );&nbsp;</div></li><li><div>                  if ( isset( $_FILES[ 'myfile' ] ) ) {&nbsp;</div></li><li><div>                      $temp_name = $_FILES[ 'myfile' ][ 'tmp_name' ];&nbsp;</div></li><li><div>                      if ( file_exists( $temp_name ) ) {&nbsp;</div></li><li><div>                          $settings_info = $this-&gt;load_file( $temp_name );&nbsp;</div></li><li><div>                          if ( $settings_info ) {&nbsp;</div></li><li><div>                              require_once( WPTOUCH_DIR . '/core/admin-backup-restore.php' );&nbsp;</div></li><li><div>                              wptouch_restore_settings( $settings_info );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          unlink( $temp_name );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'theme':&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Uploading THEME file' );&nbsp;</div></li><li><div>                  if ( isset( $_FILES[ 'theme-upload' ] ) ) {&nbsp;</div></li><li><div>                      $temp_name = $_FILES[ 'theme-upload' ][ 'tmp_name' ];&nbsp;</div></li><li><div>                      $destination_path = wptouch_get_multsite_aware_install_path( 'themes' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      require_once( WPTOUCH_DIR . '/core/addon-theme-installer.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $installer = new WPtouchAddonThemeInstaller;&nbsp;</div></li><li><div>                      $installer-&gt;install_anywhere( false, false, $destination_path, $temp_name );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'extension':&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Uploading EXTENSION file' );&nbsp;</div></li><li><div>                  if ( isset( $_FILES[ 'extension-upload' ] ) ) {&nbsp;</div></li><li><div>                      $temp_name = $_FILES[ 'extension-upload' ][ 'tmp_name' ];&nbsp;</div></li><li><div>                      $destination_path = wptouch_get_multsite_aware_install_path( 'extensions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      require_once( WPTOUCH_DIR . '/core/addon-theme-installer.php' );&nbsp;</div></li><li><div>                      $installer = new WPtouchAddonThemeInstaller;&nbsp;</div></li><li><div>                      $installer-&gt;install_anywhere( false, false, $destination_path, $temp_name );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  <span class="comment">// For different file uploads</span>&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Handling default file upload' );&nbsp;</div></li><li><div>                  do_action( 'wptouch_upload_file', $this-&gt;post[ 'file_type'] );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_admin_menu_commands() {&nbsp;</div></li><li><div>      if ( function_exists( 'wptouch_pro_handle_admin_command') ) {&nbsp;</div></li><li><div>          wptouch_pro_handle_admin_command();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_showing_mobile_theme_on_mobile_device() {&nbsp;</div></li><li><div>      return ( $this-&gt;is_mobile_device && $this-&gt;showing_mobile_theme );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function nullify_shortcode( $params ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_shortcodes( $shortcodes ) {&nbsp;</div></li><li><div>      $all_short_codes = explode( ', ', str_replace( ', ', ', ', $shortcodes ) );&nbsp;</div></li><li><div>      if ( $all_short_codes ) {&nbsp;</div></li><li><div>          foreach( $all_short_codes as $code ) {&nbsp;</div></li><li><div>              add_shortcode( $code, array( &$this, 'nullify_shortcode' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_theme_directory_uri( $directory = false, $template = false, $root = false ) {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return wptouch_check_url_ssl( content_url() . $parent_info-&gt;location );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return wptouch_check_url_ssl( content_url() . $theme_info-&gt;location );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_template_directory( $directory, $template = false, $root = false ) {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return WP_CONTENT_DIR . $parent_info-&gt;location . DIRECTORY_SEPARATOR . apply_filters( 'wptouch_parent_device_class', $this-&gt;get_active_device_class() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return WP_CONTENT_DIR . $theme_info-&gt;location . DIRECTORY_SEPARATOR . $this-&gt;get_active_device_class();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_template_directory_uri( $directory, $template = false, $root = false ) {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return wptouch_check_url_ssl( content_url() . $parent_info-&gt;location . '/' . apply_filters( 'wptouch_parent_device_class', $this-&gt;get_active_device_class() ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return wptouch_check_url_ssl( content_url() . $theme_info-&gt;location . '/' . $this-&gt;get_active_device_class() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_stylesheet_directory( $directory, $template = false, $root = false ) {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return WP_CONTENT_DIR . $theme_info-&gt;location . DIRECTORY_SEPARATOR . $this-&gt;get_active_device_class();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_stylesheet_directory_uri( $directory, $template = false, $root = false ) {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wptouch_check_url_ssl( content_url() . $theme_info-&gt;location . '/' . $this-&gt;get_active_device_class() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function has_parent_theme() {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ( isset( $theme_info-&gt;parent_theme ) && strlen( $theme_info-&gt;parent_theme ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_child_theme() {&nbsp;</div></li><li><div>      return $this-&gt;has_parent_theme();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_parent_theme_info() {&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $theme_info ) {&nbsp;</div></li><li><div>          $themes = $this-&gt;get_available_themes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $themes[ $theme_info-&gt;parent_theme ] ) ) {&nbsp;</div></li><li><div>              return $themes[ $theme_info-&gt;parent_theme ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_custom_languages( $languages ) {&nbsp;</div></li><li><div>      $custom_lang_files = $this-&gt;get_files_in_directory( WPTOUCH_CUSTOM_LANG_DIRECTORY, '.mo' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $custom_lang_files && count( $custom_lang_files ) ) {&nbsp;</div></li><li><div>          foreach( $custom_lang_files as $lang_file ) {&nbsp;</div></li><li><div>              $locale_name = str_replace( 'wptouch-pro-', '', basename( $lang_file, '.mo' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !isset( $languages[ $locale_name ] ) ) {&nbsp;</div></li><li><div>                  $languages[ $locale_name ] = $locale_name;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $languages;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_restored_settings() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $settings-&gt;restore_string ) {&nbsp;</div></li><li><div>          if ( function_exists( 'gzuncompress' ) ) {&nbsp;</div></li><li><div>              $new_settings = @unserialize( gzuncompress( base64_decode( $settings-&gt;restore_string ) ) );&nbsp;</div></li><li><div>              if ( is_object( $new_settings ) ) {&nbsp;</div></li><li><div>                  $settings = $new_settings;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;restore_failure = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings-&gt;restore_string = '';&nbsp;</div></li><li><div>          $settings-&gt;save();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_shortcode( $attr, $content ) {&nbsp;</div></li><li><div>      $new_content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add a default for target=mobile</span>&nbsp;</div></li><li><div>      if ( !isset( $attr[ 'target' ] ) ) {&nbsp;</div></li><li><div>          $attr[ 'target' ] = 'mobile';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $attr['target'] ) ) {&nbsp;</div></li><li><div>          switch( $attr['target'] ) {&nbsp;</div></li><li><div>              case 'non-mobile':&nbsp;</div></li><li><div>                  if ( !$this-&gt;is_mobile_device ) {&nbsp;</div></li><li><div>                      $new_content = '&lt;span class=&quot;wptouch-shortcode-non-mobile&quot;&gt;' . $content . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'desktop':&nbsp;</div></li><li><div>                  if ( $this-&gt;is_mobile_device && !$this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>                      $new_content = '&lt;span class=&quot;wptouch-shortcode-desktop&quot;&gt;' . $content . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'non-webapp':&nbsp;</div></li><li><div>                  if ( $this-&gt;is_showing_mobile_theme_on_mobile_device() ) {&nbsp;</div></li><li><div>                      $new_content = '&lt;span class=&quot;wptouch-shortcode-mobile-only&quot; style=&quot;display: none;&quot;&gt;' . $content . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'webapp':&nbsp;</div></li><li><div>                  if ( $this-&gt;is_showing_mobile_theme_on_mobile_device() ) {&nbsp;</div></li><li><div>                      $new_content = '&lt;span class=&quot;wptouch-shortcode-webapp-only&quot; style=&quot;display: none;&quot;&gt;' . $content . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'mobile':&nbsp;</div></li><li><div>                  if ( $this-&gt;is_showing_mobile_theme_on_mobile_device() ) {&nbsp;</div></li><li><div>                      $new_content = '&lt;span class=&quot;wptouch-shortcode-webapp-mobile&quot;&gt;' . $content . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $new_content = apply_filters( 'wptouch_shortcode_' . $attr[ 'target' ], $content );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return do_shortcode( $new_content );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function copy_file( $src_name, $dst_name ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wptouch_copy_file( $src_name, $dst_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_friendly_plugin_name( $name ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/plugins.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wptouch_plugins_get_friendly_name( $this, $name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function cleanup_post_and_get() {&nbsp;</div></li><li><div>      if ( count( $_GET ) ) {&nbsp;</div></li><li><div>          foreach( $_GET as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( get_magic_quotes_gpc() ) {&nbsp;</div></li><li><div>                  $this-&gt;get[ $key ] = @stripslashes( $value );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;get[ $key ] = $value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $_POST ) ) {&nbsp;</div></li><li><div>          foreach( $_POST as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( get_magic_quotes_gpc() ) {&nbsp;</div></li><li><div>                  if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                      $new_value = array();&nbsp;</div></li><li><div>                      foreach( $value as $val_key =&gt; $x ) {&nbsp;</div></li><li><div>                          if ( !is_array( $x ) ) {&nbsp;</div></li><li><div>                              $new_value[ $val_key ] = @stripslashes( $x );&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              foreach ( $x as $x_key =&gt; $x_val ) {&nbsp;</div></li><li><div>                                  $new_value[ $val_key ][ $x_key ] = @stripslashes( $x_val );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $this-&gt;post[ $key ] = $new_value;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this-&gt;post[ $key ] = @stripslashes( $value );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;post[ $key ] = $value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function plugin_row( $plugin_name ) {&nbsp;</div></li><li><div>      $plugin_name = WPTOUCH_PLUGIN_SLUG;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      include( WPTOUCH_DIR . '/admin/html/plugin-area.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wptouch_pro_settings_link( $links, $file ) {&nbsp;</div></li><li><div>      if ( $file == 'wptouch-pro/wptouch-pro.php' && function_exists( &quot;admin_url&quot; ) ) {&nbsp;</div></li><li><div>          $settings_link = '&lt;a href=&quot;' . admin_url( 'admin.php?page=wptouch-admin-general-settings' ) . '&quot;&gt;' . __( 'Settings' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>          array_push( $links, $settings_link );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_transient_info() {&nbsp;</div></li><li><div>      $bnc_api = $this-&gt;get_bnc_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugin_name = WPTOUCH_ROOT_NAME . '/wptouch-pro.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'is_super_admin' ) ) {&nbsp;</div></li><li><div>          $option = get_site_transient( 'update_plugins' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $option = function_exists( 'get_transient' ) ? get_transient( 'update_plugins' ) : get_option( 'update_plugins' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $option-&gt;response[ $plugin_name ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'is_super_admin' ) ) {&nbsp;</div></li><li><div>          set_site_transient( 'update_plugins', $option );&nbsp;</div></li><li><div>      } else if ( function_exists( 'set_transient' ) ) {&nbsp;</div></li><li><div>          set_transient( 'update_plugins', $option );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_update() {&nbsp;</div></li><li><div>      if ( function_exists( 'wptouch_pro_check_for_update' ) ) {&nbsp;</div></li><li><div>          return wptouch_pro_check_for_update();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function show_plugin_info() {&nbsp;</div></li><li><div>      switch( $_REQUEST[ 'plugin' ] ) {&nbsp;</div></li><li><div>          case 'wptouch-pro':&nbsp;</div></li><li><div>              echo '&lt;div style=&quot;padding: 3%&quot;&gt;';&nbsp;</div></li><li><div>              echo &quot;&lt;h2 style=\&quot;font-family:'open sans', sans-serif;\&quot;&gt;&quot; . sprintf( __( '%s Changelog', 'wptouch-pro' ), WPTOUCH_PRODUCT_NAME ) . &quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              require_once( WPTOUCH_DIR . '/core/admin-ajax.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wptouch_admin_handle_ajax( $this, 'admin-change-log' );&nbsp;</div></li><li><div>              echo '&lt;/div&gt;';&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_information_fragment( &$style_info, $fragment ) {&nbsp;</div></li><li><div>      if ( preg_match( '#' . $fragment . ': (.*)#i', $style_info, $matches ) ) {&nbsp;</div></li><li><div>          return trim( $matches[1] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_addon_information( $addon_location, $addon_url ) {&nbsp;</div></li><li><div>      $info_file = $addon_location . '/readme.txt';&nbsp;</div></li><li><div>      if ( file_exists( $info_file ) ) {&nbsp;</div></li><li><div>          $info = $this-&gt;load_file( $info_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $addon_info = new stdClass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $addon_info-&gt;name = $this-&gt;get_information_fragment( $info, 'Extension Name' );&nbsp;</div></li><li><div>          $addon_info-&gt;description = $this-&gt;get_information_fragment( $info, 'Description' );&nbsp;</div></li><li><div>          $addon_info-&gt;author = $this-&gt;get_information_fragment( $info, 'Author' );&nbsp;</div></li><li><div>          $addon_info-&gt;version = $this-&gt;get_information_fragment( $info, 'Version' );&nbsp;</div></li><li><div>          $addon_info-&gt;screenshot = $addon_url . '/screenshot.png';&nbsp;</div></li><li><div>          $addon_info-&gt;location = str_replace( WP_CONTENT_DIR, '', $addon_location );&nbsp;</div></li><li><div>          $addon_info-&gt;long_description = '';&nbsp;</div></li><li><div>          $addon_info-&gt;changelog = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $addon_frags = explode( DIRECTORY_SEPARATOR, trim( $addon_location, DIRECTORY_SEPARATOR ) );&nbsp;</div></li><li><div>          $addon_info-&gt;base = $addon_frags[ count( $addon_frags ) - 1 ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $addon_info;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sanitize_directory_win( $str ) {&nbsp;</div></li><li><div>      return str_replace( '/', DIRECTORY_SEPARATOR, $str );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_theme_information( $theme_location, $theme_url ) {&nbsp;</div></li><li><div>      $style_file = $theme_location . '/readme.txt';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( file_exists( $style_file ) ) {&nbsp;</div></li><li><div>          $style_info = $this-&gt;load_file( $style_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $theme_info = new stdClass;&nbsp;</div></li><li><div>          $theme_frags = explode( DIRECTORY_SEPARATOR, trim( $theme_location, DIRECTORY_SEPARATOR ) );&nbsp;</div></li><li><div>          $theme_info-&gt;base = $theme_frags[ count( $theme_frags ) - 1 ];&nbsp;</div></li><li><div>          $theme_info-&gt;name = $this-&gt;get_information_fragment( $style_info, 'Theme Name' );&nbsp;</div></li><li><div>          $theme_info-&gt;theme_url = $this-&gt;get_information_fragment( $style_info, 'Theme URI' );&nbsp;</div></li><li><div>          $theme_info-&gt;description = $this-&gt;get_information_fragment( $style_info, 'Description' );&nbsp;</div></li><li><div>          $theme_info-&gt;plugin_version = $this-&gt;get_information_fragment( $style_info, 'Depends on' );&nbsp;</div></li><li><div>          $theme_info-&gt;author = $this-&gt;get_information_fragment( $style_info, 'Author' );&nbsp;</div></li><li><div>          $theme_info-&gt;version = $this-&gt;get_information_fragment( $style_info, 'Version' );&nbsp;</div></li><li><div>          $theme_info-&gt;framework = $this-&gt;get_information_fragment( $style_info, 'Framework' );&nbsp;</div></li><li><div>          $theme_info-&gt;long_description = '';&nbsp;</div></li><li><div>          $theme_info-&gt;changelog = '';&nbsp;</div></li><li><div>          $theme_info-&gt;preview_images = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( preg_match_all( '#== Long Description ==(.*)(==|\z)#sUi', $style_info, $matches ) ) {&nbsp;</div></li><li><div>              $theme_info-&gt;long_description = $matches[1][0];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( preg_match_all( '#== Changelog ==(.*)(==|\z)#sUi', $style_info, $matches ) ) {&nbsp;</div></li><li><div>              $changelog = str_replace( array( &quot;= &quot;, &quot;=\n&quot;, '* ' ), array( '&lt;em&gt;', '&lt;/em&gt;&lt;ul&gt;&lt;li&gt;', '&lt;/li&gt;&lt;li&gt;' ), $matches[1][0] );&nbsp;</div></li><li><div>              $theme_info-&gt;changelog = $changelog . '&lt;/li&gt;&lt;/ul&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $features = $this-&gt;get_information_fragment( $style_info, 'Features' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $features ) {&nbsp;</div></li><li><div>              $theme_info-&gt;features = explode( ', ', str_replace( ', ', ', ', $features ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $theme_info-&gt;features = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$theme_info-&gt;framework ) {&nbsp;</div></li><li><div>              $theme_info-&gt;framework = 1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_information_fragment( $style_info, 'Parent' );&nbsp;</div></li><li><div>          if ( $parent_info ) {&nbsp;</div></li><li><div>              $theme_info-&gt;parent_theme = $parent_info;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $theme_info-&gt;tags = explode( ', ', str_replace( ', ', ', ', $this-&gt;get_information_fragment( $style_info, 'Tags' ) ) );&nbsp;</div></li><li><div>          $theme_info-&gt;screenshot = $theme_url . '/screenshot.png';&nbsp;</div></li><li><div>          $theme_info-&gt;location = $this-&gt;sanitize_directory_win( str_replace( WP_CONTENT_DIR, '', $theme_location ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $theme_info;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_files_in_directory( $directory_name, $extension ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wptouch_get_files_in_directory( $directory_name, $extension );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_theme_directories() {&nbsp;</div></li><li><div>      $theme_directorys = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_directories[] = array( WPTOUCH_DIR . DIRECTORY_SEPARATOR . 'themes', WPTOUCH_URL . '/themes' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_theme_directories', $theme_directories );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_addon_directories() {&nbsp;</div></li><li><div>      $addon_directories = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $addon_directories[] = array( WPTOUCH_BASE_CONTENT_DIR . DIRECTORY_SEPARATOR . 'extensions', WPTOUCH_BASE_CONTENT_URL . '/extensions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_addon_directories', $addon_directories );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function should_skip_file( $f ) {&nbsp;</div></li><li><div>      return ( $f == '.' || $f == '..' || $f == '.svn' || $f == '._.DS_Store' || $f == 'core' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function repair_active_theme( $location, $friendly_name ) {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>      $settings-&gt;current_theme_location = str_replace( WP_CONTENT_DIR, '', $location );&nbsp;</div></li><li><div>      $settings-&gt;save();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function theme_upgrades_available() {&nbsp;</div></li><li><div>      $this-&gt;get_available_themes( true );&nbsp;</div></li><li><div>      return $this-&gt;theme_upgrades_available;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function extension_upgrades_available() {&nbsp;</div></li><li><div>      $this-&gt;get_available_addons( true );&nbsp;</div></li><li><div>      return $this-&gt;extension_upgrades_available;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_available_addons( $include_cloud = false ) {&nbsp;</div></li><li><div>      $addons = array();&nbsp;</div></li><li><div>      $addon_directories = $this-&gt;get_addon_directories();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $addon_directories as $addon_dir ) {&nbsp;</div></li><li><div>          $list_dir = @opendir( $addon_dir[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $list_dir ) {&nbsp;</div></li><li><div>              while ( ( $f = readdir( $list_dir ) ) !== false ) {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Skip common files in each directory</span></span></span>&nbsp;</div></li><li><div>                  if ( $this-&gt;should_skip_file( $f ) ) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $addon_info = $this-&gt;get_addon_information( $addon_dir[0] . DIRECTORY_SEPARATOR . $f, $addon_dir[1] . DIRECTORY_SEPARATOR . $f );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $addon_info ) {&nbsp;</div></li><li><div>                      $addons[ $addon_info-&gt;name ] = $addon_info;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              closedir( $list_dir );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $include_cloud ) {&nbsp;</div></li><li><div>          if ( defined( 'WPTOUCH_FORCE_CLOUD_REFRESH' ) ) {&nbsp;</div></li><li><div>              delete_site_transient( '_wptouch_available_cloud_addons' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( false === ( $cloud_addons = get_site_transient( '_wptouch_available_cloud_addons' ) ) ) {&nbsp;</div></li><li><div>              $cloud_addons = wptouch_get_available_cloud_addons();&nbsp;</div></li><li><div>              set_site_transient( '_wptouch_available_cloud_addons', $cloud_addons, WPTOUCH_THEME_ADDON_TRANSIENT_TIME );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $to_add = array();&nbsp;</div></li><li><div>          if ( is_array( $cloud_addons ) && count( $cloud_addons ) ) {&nbsp;</div></li><li><div>              foreach( $cloud_addons as $cloud_addon ) {&nbsp;</div></li><li><div>                  if ( !isset( $addons[ $cloud_addon[ 'name' ] ] ) ) {&nbsp;</div></li><li><div>                      $this_addon = new stdClass;&nbsp;</div></li><li><div>                      $this_addon-&gt;name = $cloud_addon[ 'name' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;description = $cloud_addon[ 'description' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;author = $cloud_addon[ 'author' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;version = $cloud_addon[ 'version' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;screenshot = $cloud_addon[ 'screenshot' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;base = $cloud_addon[ 'base' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;location = 'cloud';&nbsp;</div></li><li><div>                      $this_addon-&gt;long_description = '';&nbsp;</div></li><li><div>                      $this_addon-&gt;changelog = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'changelog' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;changelog = $cloud_addon[ 'changelog' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'long_description' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;long_description = $cloud_addon[ 'long_description' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'upgrade_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;download_url = $cloud_addon[ 'upgrade_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'buy_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;buy_url = $cloud_addon[ 'buy_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'info_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;info_url = $cloud_addon[ 'info_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $to_add[ $this_addon-&gt;name ] = $this_addon;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this_addon = $addons[ $cloud_addon[ 'name' ] ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this_addon-&gt;cloud_version = $cloud_addon[ 'version' ];&nbsp;</div></li><li><div>                      $this_addon-&gt;extension_upgrade_available = version_compare( $cloud_addon[ 'version' ], $this_addon-&gt;version, '&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'changelog' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;changelog = $cloud_addon[ 'changelog' ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $this_addon-&gt;changelog = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $this_addon-&gt;long_description == '' && isset( $cloud_addon[ 'long_description' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;long_description = $cloud_addon[ 'long_description' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_addon[ 'upgrade_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_addon-&gt;download_url = $cloud_addon[ 'upgrade_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $this_addon-&gt;extension_upgrade_available ) { $this-&gt;extension_upgrades_available = true; }&nbsp;</div></li><li><div>                      $addons[ $cloud_addon[ 'name' ] ] = $this_addon;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $addons = array_merge( $addons, $to_add );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      uksort( $addons, 'strnatcasecmp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $addons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_available_themes( $include_cloud = false ) {&nbsp;</div></li><li><div>      $themes = array();&nbsp;</div></li><li><div>      $cloud_themes = array();&nbsp;</div></li><li><div>      $theme_directories = $this-&gt;get_theme_directories();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $theme_directories as $theme_dir ) {&nbsp;</div></li><li><div>          $list_dir = @opendir( $theme_dir[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $list_dir ) {&nbsp;</div></li><li><div>              while ( ( $f = readdir( $list_dir ) ) !== false ) {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Skip common files in each directory</span></span></span>&nbsp;</div></li><li><div>                  if ( $this-&gt;should_skip_file( $f ) ) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $theme_info = $this-&gt;get_theme_information( $theme_dir[0] . DIRECTORY_SEPARATOR . $f, $theme_dir[1] . DIRECTORY_SEPARATOR . $f );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $theme_info ) {&nbsp;</div></li><li><div>                      $themes[ $theme_info-&gt;name ] = $theme_info;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              closedir( $list_dir );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $include_cloud ) {&nbsp;</div></li><li><div>          if ( defined( 'WPTOUCH_FORCE_CLOUD_REFRESH' ) ) {&nbsp;</div></li><li><div>              delete_site_transient( '_wptouch_available_cloud_themes' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( false === ( $cloud_themes = get_site_transient( '_wptouch_available_cloud_themes' ) ) ) {&nbsp;</div></li><li><div>              $cloud_themes = wptouch_get_available_cloud_themes();&nbsp;</div></li><li><div>              set_site_transient( '_wptouch_available_cloud_themes', $cloud_themes, WPTOUCH_THEME_ADDON_TRANSIENT_TIME );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $to_add = array();&nbsp;</div></li><li><div>          if ( is_array( $cloud_themes ) && count( $cloud_themes ) ) {&nbsp;</div></li><li><div>              foreach( $cloud_themes as $cloud_theme ) {&nbsp;</div></li><li><div>                  if ( !isset( $themes[ $cloud_theme[ 'name' ] ] ) ) {&nbsp;</div></li><li><div>                      $this_theme = new stdClass;&nbsp;</div></li><li><div>                      $this_theme-&gt;name = $cloud_theme[ 'name' ];&nbsp;</div></li><li><div>                      $this_theme-&gt;description = $cloud_theme[ 'description' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this_theme-&gt;author = $cloud_theme[ 'author' ];&nbsp;</div></li><li><div>                      $this_theme-&gt;version = $cloud_theme[ 'version' ];&nbsp;</div></li><li><div>                      $this_theme-&gt;screenshot = $cloud_theme[ 'screenshot' ];&nbsp;</div></li><li><div>                      $this_theme-&gt;base = $cloud_theme[ 'base' ];&nbsp;</div></li><li><div>                      $this_theme-&gt;location = 'cloud';&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'preview_images' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;preview_images = unserialize( $cloud_theme[ 'preview_images' ] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $this_theme-&gt;changelog = '';&nbsp;</div></li><li><div>                      $this_theme-&gt;long_description = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'long_description' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;long_description = $cloud_theme[ 'long_description' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'theme_type' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;theme_type = $cloud_theme[ 'theme_type' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'info_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;info_url = $cloud_theme[ 'info_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'upgrade_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;download_url = $cloud_theme[ 'upgrade_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'buy_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;buy_url = $cloud_theme[ 'buy_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $to_add[ $this_theme-&gt;name ] = $this_theme;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this_theme = $themes[ $cloud_theme[ 'name' ] ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this_theme-&gt;cloud_version = $cloud_theme[ 'version' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'upgrade_url' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;theme_upgrade_available = version_compare( $cloud_theme[ 'version' ], $this_theme-&gt;version, '&gt;' );&nbsp;</div></li><li><div>                          $this_theme-&gt;download_url = $cloud_theme[ 'upgrade_url' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $this_theme-&gt;long_description == '' && isset( $cloud_theme[ 'long_description' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;long_description = $cloud_theme[ 'long_description' ];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'changelog' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;changelog = $cloud_theme[ 'changelog' ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $this_theme-&gt;changelog = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $cloud_theme[ 'preview_images' ] ) ) {&nbsp;</div></li><li><div>                          $this_theme-&gt;preview_images = unserialize( $cloud_theme[ 'preview_images' ] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $this_theme-&gt;theme_upgrade_available ) && $this_theme-&gt;theme_upgrade_available ) {&nbsp;</div></li><li><div>                          $this-&gt;theme_upgrades_available = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $themes[ $cloud_theme[ 'name' ] ] = $this_theme;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $themes = array_merge( $themes, $to_add );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Move current theme to the front of the list and alphabetize the rest</span>&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to make sure the active theme exists - it may not, in which case we will autodownload it later</span>&nbsp;</div></li><li><div>      if ( isset( $themes[ $settings-&gt;current_theme_friendly_name ] ) ) {&nbsp;</div></li><li><div>          $current_theme = $themes[ $settings-&gt;current_theme_friendly_name ];&nbsp;</div></li><li><div>          unset( $themes[ $settings-&gt;current_theme_friendly_name ] );&nbsp;</div></li><li><div>          ksort( $themes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $first_theme = array( $settings-&gt;current_theme_friendly_name =&gt; $current_theme );&nbsp;</div></li><li><div>          $themes = array_merge( $first_theme, $themes );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          ksort( $themes );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_available_themes', $themes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_theme_info() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $themes = $this-&gt;get_available_themes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $themes[ $settings-&gt;current_theme_friendly_name ] ) ) {&nbsp;</div></li><li><div>          return $themes[ $settings-&gt;current_theme_friendly_name ];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// check to see if we can find it using the path, in the case where the Theme Friendly Name has changed</span>&nbsp;</div></li><li><div>          $active_theme_location = $settings-&gt;current_theme_location . '/' . $settings-&gt;current_theme_name;&nbsp;</div></li><li><div>          foreach( $themes as $name =&gt; $theme_info ) {&nbsp;</div></li><li><div>              if ( $theme_info-&gt;location == $active_theme_location ) {&nbsp;</div></li><li><div>                  return $theme_info;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function create_icon_set_info( $name, $desc, $author, $author_url, $url, $location, $dark = false ) {&nbsp;</div></li><li><div>      $icon_pack_info = new stdClass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $icon_pack_info-&gt;name = $name;&nbsp;</div></li><li><div>      $icon_pack_info-&gt;description = $desc;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to see if we have an author.  It's not required that you do, i.e. in the case of Custom</span>&nbsp;</div></li><li><div>      if ( $author ) {&nbsp;</div></li><li><div>          $icon_pack_info-&gt;author = $author;&nbsp;</div></li><li><div>          $icon_pack_info-&gt;author_url = $author_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $icon_pack_info-&gt;url = $url;&nbsp;</div></li><li><div>      $icon_pack_info-&gt;location = $location;&nbsp;</div></li><li><div>      $icon_pack_info-&gt;class_name = wptouch_convert_to_class_name( $icon_pack_info-&gt;name );&nbsp;</div></li><li><div>      $icon_pack_info-&gt;dark_background = $dark;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>      $icon_pack_info-&gt;icons = wptouch_get_files_in_directory( $location, 'png' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $icon_pack_info-&gt;icons ) && count( $icon_pack_info-&gt;icons ) ) {&nbsp;</div></li><li><div>          $icon_pack_info-&gt;thumbnail = str_replace( WP_CONTENT_DIR, content_url(), $icon_pack_info-&gt;icons[ 0 ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $icon_pack_info;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_icon_set_information( $icon_pack_location, $icon_pack_url ) {&nbsp;</div></li><li><div>      $info_file = $icon_pack_location . '/wptouch.info';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( file_exists( $info_file ) ) {&nbsp;</div></li><li><div>          $icon_info = $this-&gt;load_file( $info_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $dark = false;&nbsp;</div></li><li><div>          $background_type = $this-&gt;get_information_fragment( $icon_info, 'Background' );&nbsp;</div></li><li><div>          if ( $background_type == 'Dark' ) {&nbsp;</div></li><li><div>              $dark = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Create icon set information</span>&nbsp;</div></li><li><div>          $icon_pack_info = $this-&gt;create_icon_set_info(&nbsp;</div></li><li><div>              $this-&gt;get_information_fragment( $icon_info, 'Name' ), &nbsp;</div></li><li><div>              $this-&gt;get_information_fragment( $icon_info, 'Description' ), &nbsp;</div></li><li><div>              $this-&gt;get_information_fragment( $icon_info, 'Author' ), &nbsp;</div></li><li><div>              $this-&gt;get_information_fragment( $icon_info, 'Author URL' ), &nbsp;</div></li><li><div>              $icon_pack_url, &nbsp;</div></li><li><div>              $icon_pack_location, &nbsp;</div></li><li><div>              $dark&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $icon_pack_info;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_available_icon_packs() {&nbsp;</div></li><li><div>      $icon_packs = array();&nbsp;</div></li><li><div>      $icon_pack_directories = array();&nbsp;</div></li><li><div>      $icon_pack_directories[] = array( WPTOUCH_DIR . '/resources/icons', WPTOUCH_URL . '/resources/icons' );&nbsp;</div></li><li><div>      $icon_pack_directories[] = array( WPTOUCH_BASE_CONTENT_DIR . '/icons', WPTOUCH_BASE_CONTENT_URL . '/icons' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $icon_pack_directories as $some_key =&gt; $icon_dir ) {&nbsp;</div></li><li><div>          $list_dir = @opendir( $icon_dir[0] );&nbsp;</div></li><li><div>          if ( $list_dir ) {&nbsp;</div></li><li><div>              while ( ( $f = readdir( $list_dir ) ) !== false ) {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Skip common files in each directory</span></span></span>&nbsp;</div></li><li><div>                  if ( $f == '.' || $f == '..' || $f == '.svn' || $f == '._.DS_Store' ) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $icon_pack_info = $this-&gt;get_icon_set_information( $icon_dir[0] . DIRECTORY_SEPARATOR . $f, $icon_dir[1] . DIRECTORY_SEPARATOR . $f );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $icon_pack_info ) {&nbsp;</div></li><li><div>                      $icon_packs[ $icon_pack_info-&gt;name ] = $icon_pack_info;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $icon_packs = apply_filters( 'wptouch_available_icon_sets_pre_sort', $icon_packs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ksort( $icon_packs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_available_icon_sets_post_sort', $icon_packs );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_custom_icons( $icon_pack_info ) {&nbsp;</div></li><li><div>      $icon_info = array();&nbsp;</div></li><li><div>      $icon_info[ __( 'Custom Icons', 'wptouch-pro' ) ] = $this-&gt;create_icon_set_info(&nbsp;</div></li><li><div>          __( 'Custom Icons', 'wptouch-pro' ), &nbsp;</div></li><li><div>          'Custom Icons', &nbsp;</div></li><li><div>          false, &nbsp;</div></li><li><div>          '', &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_ICON_URL, &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_ICON_DIRECTORY&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_merge( $icon_pack_info, $icon_info );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_icon_pack( $set_name ) {&nbsp;</div></li><li><div>      $available_packs = $this-&gt;get_available_icon_packs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $available_packs[ $set_name ] ) ) {&nbsp;</div></li><li><div>          return $available_packs[ $set_name ];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_image_file( $file_name ) {&nbsp;</div></li><li><div>      $file_name = strtolower( $file_name );&nbsp;</div></li><li><div>      $allowable_extensions = apply_filters( 'wptouch_image_file_types', array( '.png', '.jpg', '.gif', '.jpeg', '.svg' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_image = false;&nbsp;</div></li><li><div>      foreach( $allowable_extensions as $ext ) {&nbsp;</div></li><li><div>          if ( strpos( $file_name, $ext ) !== false ) {&nbsp;</div></li><li><div>              $is_image = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is_image;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_icons_from_packs( $setname ) {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      $icon_packs = $this-&gt;get_available_icon_packs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $icons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $icon_packs[ $setname ] ) ) {&nbsp;</div></li><li><div>          $pack = $icon_packs[ $setname ];&nbsp;</div></li><li><div>          $dir = @opendir( $pack-&gt;location );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $class_name = wptouch_convert_to_class_name( $setname );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $dir ) {&nbsp;</div></li><li><div>              while ( $f = readdir( $dir ) ) {&nbsp;</div></li><li><div>                  if ( $f == '.' || $f == '..' || $f == '.svn' || !$this-&gt;is_image_file( $f ) ) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $icon_info = new stdClass;&nbsp;</div></li><li><div>                  $icon_info-&gt;location = $pack-&gt;location . DIRECTORY_SEPARATOR . $f;&nbsp;</div></li><li><div>                  $icon_info-&gt;short_location = str_replace( WP_CONTENT_DIR, '', $icon_info-&gt;location );&nbsp;</div></li><li><div>                  $icon_info-&gt;url = $pack-&gt;url . DIRECTORY_SEPARATOR . $f;&nbsp;</div></li><li><div>                  $icon_info-&gt;name = $f;&nbsp;</div></li><li><div>                  $icon_info-&gt;set = $setname;&nbsp;</div></li><li><div>                  $icon_info-&gt;class_name = $class_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $short_name_array = explode( '.', $f );&nbsp;</div></li><li><div>                  $short_name = $short_name_array[0];&nbsp;</div></li><li><div>                  $icon_info-&gt;short_name = $short_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// add image size information if the user has the GD library installed</span>&nbsp;</div></li><li><div>                  if ( function_exists( 'getimagesize' ) ) {&nbsp;</div></li><li><div>                      $icon_info-&gt;image_size = getimagesize( $pack-&gt;location . DIRECTORY_SEPARATOR . $f );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $icons[ $f . DIRECTORY_SEPARATOR . $setname ] = $icon_info;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              closedir( $dir );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ksort( $icons );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $icons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function clean_up_url_slashes( $str ) {&nbsp;</div></li><li><div>      return str_replace( array( '\\\\', '\\' ), array( '/', '/' ), $str );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_and_use_min_file( $file_name, $file_ext, $rel_path = WPTOUCH_DIR, $rel_url = WPTOUCH_URL ) {&nbsp;</div></li><li><div>      $min_file = str_replace( $file_ext, '.min' . $file_ext, $file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( file_exists( $rel_path . $min_file ) ) {&nbsp;</div></li><li><div>          return $this-&gt;clean_up_url_slashes( $rel_url . $min_file );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $this-&gt;clean_up_url_slashes( $rel_url . $file_name );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_and_use_js_file( $file_name, $rel_path = WPTOUCH_DIR, $rel_url = WPTOUCH_URL ) {&nbsp;</div></li><li><div>      return $this-&gt;check_and_use_min_file( $file_name, '.js', $rel_path, $rel_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_and_use_css_file( $file_name, $rel_path = WPTOUCH_DIR, $rel_url = WPTOUCH_URL ) {&nbsp;</div></li><li><div>      return $this-&gt;check_and_use_min_file( $file_name, '.css', $rel_path, $rel_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_admin_stylesheets() {&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_wptouch_page() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// 4.0 - Lato'ing it up</span>&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-admin-google-fonts', '<span class="comment">//fonts.googleapis.com/css?family=Lato:300, 400, 700, 300italic, 400italic, 700italic', false, md5( WPTOUCH_VERSION ) );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// 4.0 - Loading Fontello</span>&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-admin-fontello', $this-&gt;check_and_use_css_file( '/admin/fontello/css/fontello-embedded.css' ), false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strpos( $_SERVER['REQUEST_URI'], 'wptouch-admin-wizard' ) !== false ) {&nbsp;</div></li><li><div>              wp_enqueue_style( 'wptouch-admin-wizard-styles', $this-&gt;check_and_use_css_file( '/admin/css/wptouch-admin-4-wizard.css' ), false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_enqueue_style( 'wptouch-admin-styles', $this-&gt;check_and_use_css_file( '/admin/css/wptouch-admin-4.css' ), false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( wptouch_should_load_rtl() && file_exists( WPTOUCH_DIR . '/admin/css/wptouch-admin-rtl.css' ) ) {&nbsp;</div></li><li><div>              WPTOUCH_DEBUG( WPTOUCH_INFO, 'Loading RTL stylesheet' );&nbsp;</div></li><li><div>              wp_enqueue_style(&nbsp;</div></li><li><div>                  'wptouch-admin-rtl', &nbsp;</div></li><li><div>                  wptouch_check_url_ssl( $this-&gt;check_and_use_css_file(&nbsp;</div></li><li><div>                      '/admin/css/wptouch-admin-rtl.css', &nbsp;</div></li><li><div>                      WPTOUCH_DIR, &nbsp;</div></li><li><div>                      WPTOUCH_URL&nbsp;</div></li><li><div> ) ), &nbsp;</div></li><li><div>                  array( 'wptouch-admin-styles' ), &nbsp;</div></li><li><div>                  md5( WPTOUCH_VERSION )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;admin_is_menu_page() ) {&nbsp;</div></li><li><div>          $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script( 'wptouch-menu', $this-&gt;check_and_use_js_file( '/admin/js/wptouch-menu.js' ), array( 'jquery' ), md5( WPTOUCH_VERSION ), true );&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-menu', $this-&gt;check_and_use_css_file( '/admin/css/wptouch-menu.css' ), false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $localize_params = array(&nbsp;</div></li><li><div>              'default_icon' =&gt; wptouch_get_site_default_icon()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_localize_script( 'wptouch-menu', 'wptouchMenu', $localize_params );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_client_ajax() {&nbsp;</div></li><li><div>      $nonce = $this-&gt;post['wptouch_nonce'];&nbsp;</div></li><li><div>      if ( !wp_verify_nonce( $nonce, 'wptouch-ajax' ) ) {&nbsp;</div></li><li><div>          die( 'Security problem with nonce' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;post['wptouch_action'] ) ) {&nbsp;</div></li><li><div>          do_action( 'wptouch_ajax_' . $this-&gt;post['wptouch_action'] );&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function init_theme() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wp_footer', array( &$this, 'handle_footer' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'wptouch-front-ajax', WPTOUCH_URL . '/include/js/wptouch.js', array( 'jquery' ), md5( WPTOUCH_VERSION ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'JSON_HEX_TAG' ) ) {&nbsp;</div></li><li><div>          $query_vars = json_encode( $_GET, JSON_HEX_TAG );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $query_vars = json_encode( $_GET );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $localize_params =     array(&nbsp;</div></li><li><div>          'ajaxurl' =&gt; get_bloginfo( 'wpurl' ) . '/wp-admin/admin-ajax.php', &nbsp;</div></li><li><div>          'siteurl' =&gt; str_replace( array( 'http:<span class="comment">//' . $_SERVER['SERVER_NAME'] . '', 'https://' . $_SERVER['SERVER_NAME'] . '' ), '', get_bloginfo( 'url' ) . '/' ), </span>&nbsp;</div></li><li><div>          'security_nonce' =&gt; wp_create_nonce( 'wptouch-ajax' ), &nbsp;</div></li><li><div>          'current_shortcode_url' =&gt; add_query_arg( array( 'wptouch_shortcode' =&gt; '1' ), esc_url_raw( $_SERVER[ 'REQUEST_URI' ] ) ), &nbsp;</div></li><li><div>          'query_vars' =&gt; $query_vars&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_localize_script( 'wptouch-front-ajax', 'wptouchMain', apply_filters( 'wptouch_localize_scripts', $localize_params ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Do the theme init</span>&nbsp;</div></li><li><div>      do_action( 'wptouch_theme_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;disable_plugins();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_critical_notification( $information ) {&nbsp;</div></li><li><div>      $this-&gt;critical_notifications[] = array( $information );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_critical_notifications() {&nbsp;</div></li><li><div>      return $this-&gt;critical_notifications;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function has_critical_notifications() {&nbsp;</div></li><li><div>      return is_array( $this-&gt;critical_notifications ) && count( $this-&gt;critical_notifications );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_notification( $area_or_plugin, $warning_desc, $notification_type = 'warning', $link = false ) {&nbsp;</div></li><li><div>      $this-&gt;notifications[ $area_or_plugin ] = array( $area_or_plugin, $warning_desc, $notification_type, $link );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function generate_plugin_hook_list( $update_list = false ) {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings( 'compat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $update_list ) {&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/plugins.php' );&nbsp;</div></li><li><div>          wptouch_plugins_generate_hook_list( $this, $settings );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;plugin_hooks = $settings-&gt;plugin_hooks;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;reload_settings();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function disable_plugins() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings( 'compat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $settings-&gt;plugin_hooks && count( $settings-&gt;plugin_hooks ) ) {&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/plugins.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wptouch_plugins_disable( $this, $settings );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_directory( $dir_name ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wptouch_remove_directory( $dir_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_languages() {&nbsp;</div></li><li><div>      $current_locale = get_locale();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check for language override</span>&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_network_admin() ) {&nbsp;</div></li><li><div>          $locale_setting = 'force_network_locale';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $locale_setting = 'force_locale';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $destination_directory = wptouch_get_multsite_aware_install_path( 'lang' );&nbsp;</div></li><li><div>      <span class="comment">// Auto download code for language files</span>&nbsp;</div></li><li><div>      if ( $current_locale != 'en_US' || ( $settings-&gt;$locale_setting != 'auto' && $settings-&gt;$locale_setting != 'en_US' ) ) {&nbsp;</div></li><li><div>          if ( $settings-&gt;$locale_setting != 'auto' ) {&nbsp;</div></li><li><div>              $current_locale = $settings-&gt;$locale_setting;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;setup_bncapi();&nbsp;</div></li><li><div>          $bnc_api = $this-&gt;get_bnc_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $list = false;&nbsp;</div></li><li><div>          if ( false === ( $list = get_site_transient( '_wptouch_language_info' ) ) ) {&nbsp;</div></li><li><div>              $list = $bnc_api-&gt;translations_get_list();&nbsp;</div></li><li><div>              set_site_transient( '_wptouch_language_info', $list, 3600*24 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $language_file = 'wptouch-pro-' . $current_locale . '.mo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $list[ $language_file ] ) ) {&nbsp;</div></li><li><div>              $should_install = false;&nbsp;</div></li><li><div>              if ( !file_exists( $destination_directory . '/' . $language_file ) ) {&nbsp;</div></li><li><div>                  $should_install = true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $language_file_size = filesize( $destination_directory . '/' . $language_file );&nbsp;</div></li><li><div>                  if ( $language_file_size != $list[ $language_file ][ 'size' ] ) {&nbsp;</div></li><li><div>                      $should_install = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $should_install ) {&nbsp;</div></li><li><div>                  require_once( WPTOUCH_DIR . '/core/addon-theme-installer.php' );&nbsp;</div></li><li><div>                  $installer = new WPtouchAddonThemeInstaller;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $language_to_install = $list[ $language_file ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $installer-&gt;install_anywhere( $language_file, $language_to_install[ 'file' ], $destination_directory );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !empty( $current_locale ) ) {&nbsp;</div></li><li><div>          $current_locale = apply_filters( 'wptouch_language', $current_locale );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $use_lang_file = false;&nbsp;</div></li><li><div>          $custom_lang_file = $destination_directory . '/wptouch-pro-' . $current_locale . '.mo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( file_exists( $custom_lang_file ) && is_readable( $custom_lang_file ) ) {&nbsp;</div></li><li><div>              $use_lang_file = $custom_lang_file;&nbsp;</div></li><li><div>              $rel_path = str_replace( WP_CONTENT_DIR, '..', $destination_directory );&nbsp;</div></li><li><div>              $use_lang_rel_path = $rel_path;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $lang_file = WPTOUCH_DIR . '/lang/wptouch-pro-' . $current_locale . '.mo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( file_exists( $lang_file ) && is_readable( $lang_file ) ) {&nbsp;</div></li><li><div>                  $use_lang_file = $lang_file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( defined( 'WPTOUCH_IS_FREE' ) ) {&nbsp;</div></li><li><div>                      $use_lang_rel_path = 'wptouch/lang';&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $use_lang_rel_path = 'wptouch-pro/lang';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'plugin_locale', array( &$this, 'get_wordpress_locale' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;locale = $current_locale;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $use_lang_file ) {&nbsp;</div></li><li><div>              $can_load = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_admin() && !$settings-&gt;translate_admin ) {&nbsp;</div></li><li><div>                  $can_load = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $can_load ) {&nbsp;</div></li><li><div>                  load_plugin_textdomain( 'wptouch-pro', false, $use_lang_rel_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, 'Loading language file ' . $use_lang_file );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wptouch_language_loaded', $this-&gt;locale );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_wordpress_locale( $locale, $domain ) {&nbsp;</div></li><li><div>      if ( $domain == 'wptouch-pro' ) {&nbsp;</div></li><li><div>          return $this-&gt;locale;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $locale;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_raw_settings( $domain ) {&nbsp;</div></li><li><div>      $settings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $setting_name = $this-&gt;get_wp_setting_name_for_domain( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_domain_site_wide( $domain ) ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, 'Loading site wide option on DOMAIN ' . $domain );&nbsp;</div></li><li><div>          $settings = get_site_option( $setting_name, false, false );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $settings = get_option( $setting_name, false );&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, 'Loading setting ' . $setting_name . ' from DATABASE' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_object( $settings ) ) {&nbsp;</div></li><li><div>          $settings-&gt;domain = $domain;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function update_raw_settings( $domain, $settings ) {&nbsp;</div></li><li><div>      $setting_name = $this-&gt;get_wp_setting_name_for_domain( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_domain_site_wide( $domain ) ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_VERBOSE, 'Saving site wide option for domain ' . $domain );&nbsp;</div></li><li><div>          update_site_option( $setting_name, $settings );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_VERBOSE, 'Saving non-site wide option for domain ' . $domain );&nbsp;</div></li><li><div>          update_option( $setting_name, $settings );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function seletively_unset( $name, &$object ) {&nbsp;</div></li><li><div>      if ( isset( $object-&gt;$name ) ) {&nbsp;</div></li><li><div>          unset( $object-&gt;$name );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_setting_defaults( $domain ) {&nbsp;</div></li><li><div>      $setting_defaults = new WPtouchSettings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $domain == 'wptouch_pro' ) {&nbsp;</div></li><li><div>          $setting_defaults = new WPtouchDefaultSettings30;&nbsp;</div></li><li><div>      } else if ( $domain == 'bncid' ) {&nbsp;</div></li><li><div>          $setting_defaults = new WPtouchDefaultSettingsBNCID30;&nbsp;</div></li><li><div>      } else if ( $domain == 'compat' ) {&nbsp;</div></li><li><div>          $setting_defaults = new WPtouchDefaultSettingsCompat;&nbsp;</div></li><li><div>      } else if ( $domain == 'multisite' ) {&nbsp;</div></li><li><div>          $setting_defaults = new WPtouchDefaultSettingsMultisite;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $setting_defaults = apply_filters( 'wptouch_setting_defaults', $setting_defaults, $domain );&nbsp;</div></li><li><div>          $setting_defaults = apply_filters( 'wptouch_setting_defaults_' . wptouch_strip_dashes( $domain ), $setting_defaults );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() && $domain != 'multisite' && !is_network_admin() ) {&nbsp;</div></li><li><div>          $multisite_settings = $this-&gt;get_raw_settings( 'multisite' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $multisite_settings && $multisite_settings-&gt;multisite_use_master_settings ) {&nbsp;</div></li><li><div>              $master_blog_id = $multisite_settings-&gt;multisite_master_site;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $current_blog_id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $current_blog_id != $master_blog_id ) {&nbsp;</div></li><li><div>                  switch_to_blog( $master_blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// load settings</span>&nbsp;</div></li><li><div>                  $settings = $this-&gt;get_raw_settings( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $domain == 'wptouch_pro' ) {&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'site_title', $settings );&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'homepage_redirect_wp_target', $settings );&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'homepage_redirect_custom_target', $settings );&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'custom_menu_name', $settings );&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'appended_menu_name', $settings );&nbsp;</div></li><li><div>                      $this-&gt;seletively_unset( 'prepended_menu_name', $settings );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $settings_defaults = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// merge settings</span>&nbsp;</div></li><li><div>                  restore_current_blog();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings_defaults = apply_filters( 'wptouch_settings_override_defaults', $setting_defaults, $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $setting_defaults;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_active_setting_domains() {&nbsp;</div></li><li><div>      $active_domains = array( 'wptouch_pro', 'bncid' , 'compat', 'addons', 'multisite' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_registered_setting_domains', $active_domains );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_wp_setting_name_for_domain( $domain ) {&nbsp;</div></li><li><div>      return 'wpts_' . wptouch_strip_dashes( $domain );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_domain_site_wide( $domain ) {&nbsp;</div></li><li><div>      $site_wide = false;&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $site_wide_domains = array( 'bncid', 'multisite' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $domains = apply_filters( 'wptouch_domain_site_wide', false, $site_wide_domains );&nbsp;</div></li><li><div>          if ( in_array( $domain, $site_wide_domains ) ) {&nbsp;</div></li><li><div>              $site_wide = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_wide;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_settings( $domain = 'wptouch_pro', $clone_it = true ) {&nbsp;</div></li><li><div>      WPTOUCH_DEBUG( WPTOUCH_INFO, 'In get_settings with DOMAIN ' . $domain . ' CLONE: ' . $clone_it );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load main settings information</span>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/class-wptouch-pro-settings.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = new WPtouchSettings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;settings_objects[ $domain ] ) ) {&nbsp;</div></li><li><div>          <span class="comment">// settings have been loaded before</span>&nbsp;</div></li><li><div>          $settings = $this-&gt;settings_objects[ $domain ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, '.. Returning previously loaded settings ' . $domain );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// settings have not been loaded</span>&nbsp;</div></li><li><div>          $settings = $this-&gt;get_raw_settings( $domain );&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, '.. Loading settings from database ' . $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$settings ) {&nbsp;</div></li><li><div>              <span class="comment">// Nothing stored in the database, return default settings</span>&nbsp;</div></li><li><div>              $settings = $this-&gt;get_setting_defaults( $domain );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Check for stray serialization</span>&nbsp;</div></li><li><div>              if ( is_serialized( $settings ) ) {&nbsp;</div></li><li><div>                  WPTOUCH_DEBUG( WPTOUCH_INFO, '.. stray serialization? ' . $domain );&nbsp;</div></li><li><div>                  $settings = unserialize( $settings );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $defaults = $this-&gt;get_setting_defaults( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Merge in default settings</span>&nbsp;</div></li><li><div>              foreach( (array)$defaults as $name =&gt; $value ) {&nbsp;</div></li><li><div>                  if ( !isset( $settings-&gt;$name ) ) {&nbsp;</div></li><li><div>                      $settings-&gt;$name = $value;&nbsp;</div></li><li><div>                      do_action( 'wptouch_settings_after_merge_default', $domain, $name, $value );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Old settings filter</span>&nbsp;</div></li><li><div>          if ( $domain == 'wptouch_pro' ) {&nbsp;</div></li><li><div>              $settings = apply_filters( 'wptouch_settings', $settings );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings = apply_filters( 'wptouch_settings_domain', $settings, $domain );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update our internal cache of the settings</span>&nbsp;</div></li><li><div>      $this-&gt;settings_objects[ $domain ] = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $clone_it ) {&nbsp;</div></li><li><div>          $new_domain = clone $settings;&nbsp;</div></li><li><div>          $new_domain-&gt;domain = $domain;&nbsp;</div></li><li><div>          return $new_domain;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $settings-&gt;domain = $domain;&nbsp;</div></li><li><div>          return $settings;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function reload_settings() {&nbsp;</div></li><li><div>      $this-&gt;settings_objects = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_supported_device_classes() {&nbsp;</div></li><li><div>      global $wptouch_device_classes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $supported_classes = apply_filters( 'wptouch_supported_device_classes', $wptouch_device_classes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $wptouch_device_classes as $device_class =&gt; $device_info ) {&nbsp;</div></li><li><div>          $supported_classes[] = $device_class;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $supported_classes;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_supported_theme_device_classes() {&nbsp;</div></li><li><div>      global $wptouch_device_classes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get a list of all supported mobile device classes</span>&nbsp;</div></li><li><div>      $supported_device_classes = apply_filters( 'wptouch_theme_device_classes', $this-&gt;get_supported_device_classes() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $device_listing = array();&nbsp;</div></li><li><div>      foreach( $wptouch_device_classes as $class_name =&gt; $class_info ) {&nbsp;</div></li><li><div>          if ( in_array( $class_name, $supported_device_classes ) ) {&nbsp;</div></li><li><div>              if ( file_exists( $this-&gt;get_current_theme_directory() . '/' . $class_name ) ) {&nbsp;</div></li><li><div>                  $device_listing[ $class_name ] = $class_info;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We have a complete list of device classes and device user agents</span>&nbsp;</div></li><li><div>      <span class="comment">// but we'll give themes and plugins a chance to modify them</span>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_supported_device_classes', $device_listing );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_supported_user_agents() {&nbsp;</div></li><li><div>      <span class="comment">// Get a list of the supported theme device classes</span>&nbsp;</div></li><li><div>      $device_listing = $this-&gt;get_supported_theme_device_classes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now we'll create a master list of user agents</span>&nbsp;</div></li><li><div>      $useragents = array();&nbsp;</div></li><li><div>      foreach( $device_listing as $device_class =&gt; $device_user_agents ) {&nbsp;</div></li><li><div>          $useragents = array_merge( $useragents, $device_user_agents );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_supported_agents', $useragents );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function inject_preview_javascript() {&nbsp;</div></li><li><div>      echo $this-&gt;load_file( WPTOUCH_DIR . '/admin/js/wptouch-preview.js' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function user_agent_matches( $browser_user_agent, $user_agent_to_check ) {&nbsp;</div></li><li><div>      $is_detected = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $user_agent_to_check ) ) {&nbsp;</div></li><li><div>          $check_against = $user_agent_to_check;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $check_against = array( $user_agent_to_check );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $check_against as $this_user_agent ) {&nbsp;</div></li><li><div>          $friendly_agent = preg_quote( $this_user_agent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !preg_match( &quot;#$friendly_agent#i&quot;, $browser_user_agent ) ) {&nbsp;</div></li><li><div>              $is_detected = false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is_detected;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_supported_device() {&nbsp;</div></li><li><div>      $exclude_patterns = array(&nbsp;</div></li><li><div>              'FBSN/iPhone OS' =&gt; '', &nbsp;</div></li><li><div>              'Twitter for iPhone' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $user_agent = apply_filters( 'wptouch_user_agent', strtr( $_SERVER['HTTP_USER_AGENT'], $exclude_patterns ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_in_preview_mode() ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ( $settings-&gt;new_display_mode == false && !wptouch_is_customizing_mobile() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now that preview mode is out of the way, let's figure out the proper list of user agents</span>&nbsp;</div></li><li><div>      $supported_agents = $this-&gt;get_supported_user_agents();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Figure out the active device type and the active device class</span>&nbsp;</div></li><li><div>      foreach( $supported_agents as $agent ) {&nbsp;</div></li><li><div>          if ( $agent != array() && $this-&gt;user_agent_matches( $user_agent, $agent ) ) {&nbsp;</div></li><li><div>              $agent_ok = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $exclusion_list = apply_filters( 'wptouch_exclusion_list', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach( $exclusion_list as $exclude_user_agent ) {&nbsp;</div></li><li><div>                  $friendly_exclude = preg_quote( $exclude_user_agent );&nbsp;</div></li><li><div>                  if ( preg_match( &quot;#$friendly_exclude#i&quot;, $user_agent ) ) {&nbsp;</div></li><li><div>                      $agent_ok = false;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !$agent_ok ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;active_device = $agent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $supported_device_classes = $this-&gt;get_supported_theme_device_classes();&nbsp;</div></li><li><div>              foreach ( $supported_device_classes as $device_class =&gt; $device_user_agents ) {&nbsp;</div></li><li><div>                  if ( in_array( $agent, $device_user_agents ) ) {&nbsp;</div></li><li><div>                      $this-&gt;active_device_class = $device_class;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;active_device = $this-&gt;active_device_class = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_in_preview_mode() {&nbsp;</div></li><li><div>      if ( $this-&gt;is_previewing_mobile_theme() ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_previewing_mobile_theme() {&nbsp;</div></li><li><div>      return ( isset( $this-&gt;get[ 'wptouch_preview_theme'] ) && $this-&gt;get[ 'wptouch_preview_theme' ] == 'enabled' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_active_device_class() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_in_preview_mode() ) {&nbsp;</div></li><li><div>          <span class="comment">// the default theme for preview mode is the iphone</span>&nbsp;</div></li><li><div>          <span class="comment">// a developer could override this by implementing the following filter in the functions.php file of the active theme</span>&nbsp;</div></li><li><div>          return apply_filters( 'wptouch_preview_mode_device_class', 'default' );&nbsp;</div></li><li><div>      } else if ( $this-&gt;is_previewing_mobile_theme() ) {&nbsp;</div></li><li><div>          return 'default';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $this-&gt;active_device_class;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function delete_theme_add_on_cache() {&nbsp;</div></li><li><div>      delete_site_transient( '_wptouch_available_cloud_addons' );&nbsp;</div></li><li><div>      delete_site_transient( '_wptouch_available_cloud_themes' );&nbsp;</div></li><li><div>      delete_site_transient( '_wptouch_bncid_latest_version' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function activate_license() {&nbsp;</div></li><li><div>      WPTOUCH_DEBUG( WPTOUCH_INFO, 'Attempting to activate a site license' );&nbsp;</div></li><li><div>      $bnc_api = $this-&gt;get_bnc_api();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $bnc_api ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_INFO, 'Adding license for wptouch-pro' );&nbsp;</div></li><li><div>          $bnc_api-&gt;user_add_license();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings = wptouch_get_settings( 'bncid' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Force a license check next time</span>&nbsp;</div></li><li><div>          $settings-&gt;last_bncid_time = 0;&nbsp;</div></li><li><div>          $settings-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;delete_theme_add_on_cache();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_active_mobile_device() {&nbsp;</div></li><li><div>      return $this-&gt;active_device;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function active_mobile_device() {&nbsp;</div></li><li><div>      echo $this-&gt;get_active_mobile_device();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_bnc_api() {&nbsp;</div></li><li><div>      return $this-&gt;bnc_api;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function has_site_license() {&nbsp;</div></li><li><div>      $api = $this-&gt;get_bnc_api();&nbsp;</div></li><li><div>      $licenses = $api-&gt;user_list_licenses();&nbsp;</div></li><li><div>      $this_site = $_SERVER['HTTP_HOST'];&nbsp;</div></li><li><div>      return ( in_array( $this_site, (array)$licenses['licenses'] ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_bncapi( $bncid = 'default', $key = 'default', $override_free = false ) {&nbsp;</div></li><li><div>      if ( !$this-&gt;bnc_api ) {&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/class-bncapi.php' );&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/bncid.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings = $this-&gt;get_settings( 'bncid' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( defined( 'WPTOUCH_IS_FREE' ) && !$override_free ) {&nbsp;</div></li><li><div>              $bncid = '';&nbsp;</div></li><li><div>              $key = '';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $bncid == 'default' ) {&nbsp;</div></li><li><div>                  $bncid = $settings-&gt;bncid;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $key == 'default' ) {&nbsp;</div></li><li><div>                  $key = $settings-&gt;wptouch_license_key;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;bnc_api = new BNCAPI( $bncid, $key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_footer() {&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $settings-&gt;show_wptouch_in_footer ) {&nbsp;</div></li><li><div>          global $footer_settings;&nbsp;</div></li><li><div>          $footer_settings = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo wptouch_capture_include_file( WPTOUCH_DIR . '/include/html/footer.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $settings-&gt;analytics_embed_method ) {&nbsp;</div></li><li><div>          case 'simple':&nbsp;</div></li><li><div>              if ( $settings-&gt;analytics_google_id ) {&nbsp;</div></li><li><div>                  $analytics_code = &quot;&nbsp;</div></li><li><div>                  &lt;script&gt;&nbsp;</div></li><li><div>                      !function(W, P, t, o, u, c, h) {W.GoogleAnalyticsObject=t;W[t]||(W[t]=function() {&nbsp;</div></li><li><div>                      (W[t].q=W[t].q||[]).push(arguments)});W[t].l=+new Date;c=P.createElement(o);&nbsp;</div></li><li><div>                      h=P.getElementsByTagName(o)[0];c.src=u;h.parentNode.insertBefore(c, h)}&nbsp;</div></li><li><div>                      (window, document, 'ga', 'script', '<span class="comment">//www.google-analytics.com/analytics.js');</span>&nbsp;</div></li><li><div>                      ga('create', '&quot; . $settings-&gt;analytics_google_id . &quot;', 'auto');&nbsp;</div></li><li><div>                      ga('send', 'pageview');&nbsp;</div></li><li><div>                  &lt;/script&gt;&quot;;&nbsp;</div></li><li><div>                  echo $analytics_code;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'custom':&nbsp;</div></li><li><div>              if ( $settings-&gt;custom_stats_code ) {&nbsp;</div></li><li><div>                  echo apply_filters( 'wptouch_custom_stats_code', $settings-&gt;custom_stats_code );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function redirect_to_page( $url, $query_string = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strpos( urldecode( $url ), '<span class="comment">//' ) !== 0 ) { // Prevent redirects to remote URLs.</span>&nbsp;</div></li><li><div>          if ( $query_string ) {&nbsp;</div></li><li><div>              $query_string = '?' . $query_string;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          header( 'Location: ' . urldecode( $url ) . $query_string );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_for_redirect() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      if ( $this-&gt;is_front_page() ) {&nbsp;</div></li><li><div>          $redirect_target = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch( $settings-&gt;homepage_landing ) {&nbsp;</div></li><li><div>              case 'select':&nbsp;</div></li><li><div>                  $redirect_target = get_permalink( $settings-&gt;homepage_redirect_wp_target );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'custom':&nbsp;</div></li><li><div>                  $redirect_target = $settings-&gt;homepage_redirect_custom_target;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'none':&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect_target = apply_filters( 'wptouch_redirect_target', $redirect_target );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $redirect_target ) {&nbsp;</div></li><li><div>              $can_do_redirect = true;&nbsp;</div></li><li><div>              if ( get_option( 'show_on_front', false ) == 'page' ) {&nbsp;</div></li><li><div>                  $front_page = get_option( 'page_on_front' );&nbsp;</div></li><li><div>                  if ( $front_page == $settings-&gt;homepage_redirect_wp_target ) {&nbsp;</div></li><li><div>                      $can_do_redirect = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_GET[ 'lang' ] ) && stristr( $redirect_target, 'lang=' ) ) {&nbsp;</div></li><li><div>                  unset( $_GET[ 'lang' ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $query_string = http_build_query( $_GET );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $can_do_redirect ) {&nbsp;</div></li><li><div>                  $this-&gt;redirect_to_page( $redirect_target, $query_string );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_front_page() {&nbsp;</div></li><li><div>      $front_option = get_option( 'show_on_front', false );&nbsp;</div></li><li><div>      if ( $front_option == 'page' ) {&nbsp;</div></li><li><div>          $front_page = get_option( 'page_on_front' );&nbsp;</div></li><li><div>          if ( $front_page ) {&nbsp;</div></li><li><div>              return is_front_page();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return is_home();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// user hasn't defined a dedicated front page, so we return true when on the blog page</span>&nbsp;</div></li><li><div>          return is_home();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_wptouch_admin_ajax() {&nbsp;</div></li><li><div>      add_action( 'wp_ajax_wptouch_ajax', array( &$this, 'admin_ajax_handler' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_nopriv_wptouch_ajax', array( &$this, 'admin_nopriv_ajax_handler' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_ajax_handler() {&nbsp;</div></li><li><div>      if ( current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Check security nonce</span>&nbsp;</div></li><li><div>          $wptouch_nonce = $this-&gt;post['wptouch_ajax_nonce'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !wp_verify_nonce( $wptouch_nonce, 'wptouch_admin_ajax' ) ) {&nbsp;</div></li><li><div>              WPTOUCH_DEBUG( WPTOUCH_SECURITY, 'Invalid security nonce for AJAX call' );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;setup_bncapi();&nbsp;</div></li><li><div>          header( 'HTTP/1.1 200 OK' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// AJAX is split out into another file to reduce class load times for main WPtouch Pro class</span>&nbsp;</div></li><li><div>          require_once( WPTOUCH_DIR . '/core/admin-ajax.php' );&nbsp;</div></li><li><div>          wptouch_admin_handle_ajax( $this, $this-&gt;post['wptouch_action'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_SECURITY, 'Insufficient security privileges for AJAX call' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      die;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function admin_nopriv_ajax_handler() {&nbsp;</div></li><li><div>      if ( $this-&gt;post[ 'wptouch_action' ] == 'post_upgrade_refresh' ) {&nbsp;</div></li><li><div>          $wptouch_nonce = $this-&gt;post['wptouch_ajax_nonce'];&nbsp;</div></li><li><div>          if ( wp_verify_nonce( $wptouch_nonce, 'wptouch_ajax_callback' ) ) {&nbsp;</div></li><li><div>              wptouch_check_api( true );&nbsp;</div></li><li><div>              delete_site_transient( 'wptouch_license_upgrade_available' );&nbsp;</div></li><li><div>              die( '1' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              die( 'Invalid nonce' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function check_directories() {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>      $creation_failure = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $directories_to_create = array(&nbsp;</div></li><li><div>          WPTOUCH_BASE_CONTENT_DIR, &nbsp;</div></li><li><div>          WPTOUCH_TEMP_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_TEMP_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_BASE_CONTENT_DIR . '/cache', &nbsp;</div></li><li><div>          WPTOUCH_BASE_CONTENT_DIR . '/themes', &nbsp;</div></li><li><div>          WPTOUCH_BASE_CONTENT_DIR . '/modules', &nbsp;</div></li><li><div>          WPTOUCH_BASE_CONTENT_DIR . '/extensions', &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_SET_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_ICON_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_LANG_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_CUSTOM_UPLOAD_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_BACKUP_DIRECTORY, &nbsp;</div></li><li><div>          WPTOUCH_DEBUG_DIRECTORY&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add extra for multisite</span>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $multisite_dirs = array(&nbsp;</div></li><li><div>              WPTOUCH_BASE_CONTENT_MS_DIR, &nbsp;</div></li><li><div>              WPTOUCH_BASE_CONTENT_MS_DIR . '/themes', &nbsp;</div></li><li><div>              WPTOUCH_BASE_CONTENT_MS_DIR . '/extensions', &nbsp;</div></li><li><div>              WPTOUCH_BASE_CONTENT_MS_DIR . '/lang'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $directories_to_create = array_merge( $multisite_dirs, $directories_to_create );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $directories_to_check = apply_filters(&nbsp;</div></li><li><div>          'wptouch_create_directories', &nbsp;</div></li><li><div>          $directories_to_create&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through all directories</span>&nbsp;</div></li><li><div>      foreach( $directories_to_check as $dir_name ) {&nbsp;</div></li><li><div>          $creation_failure = $creation_failure | !wptouch_create_directory_if_not_exist( $dir_name );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $creation_failure ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_WARNING, 'Unable to create one or more directories' );&nbsp;</div></li><li><div>          $this-&gt;add_notification(&nbsp;</div></li><li><div>              __( 'Directory Problem', 'wptouch-pro' ), &nbsp;</div></li><li><div>              __( 'One or more required directories could not be created', 'wptouch-pro' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_excerpt_length( $length ) {&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_excerpt_length', WPTOUCH_EXCERPT_LENGTH );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_excerpt_more( $more ) {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wptouch_excerpt_more', ' ...' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function load_file( $file_name ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wptouch_load_file( $file_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_theme_directory() {&nbsp;</div></li><li><div>      return str_replace( '/', DIRECTORY_SEPARATOR, rtrim( WP_CONTENT_DIR, '/\\' ) . DIRECTORY_SEPARATOR . ltrim( $this-&gt;get_current_theme_location(), '/\\' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_theme_uri() {&nbsp;</div></li><li><div>      return wptouch_check_url_ssl( str_replace( '\\', '/', ltrim( content_url(), '/' ) . '/' . ltrim( $this-&gt;get_current_theme_location(), '/\\' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function change_dir_to_url( $dir ) {&nbsp;</div></li><li><div>      return wptouch_check_url_ssl( str_replace( '\\', '/', ltrim( content_url(), '/' ) . '/' . ltrim( $dir, '/\\' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_theme() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings-&gt;current_theme_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_theme_location() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings-&gt;current_theme_location . DIRECTORY_SEPARATOR . $settings-&gt;current_theme_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_current_parent_location() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $parent_info-&gt;location;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $settings-&gt;current_theme_location . DIRECTORY_SEPARATOR . $settings-&gt;current_theme_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_theme_styles() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the default stylesheet to the end, use min if available</span>&nbsp;</div></li><li><div>      $dependencies = array();&nbsp;</div></li><li><div>      if ( $this-&gt;has_parent_theme() ) {&nbsp;</div></li><li><div>          $parent_info = $this-&gt;get_parent_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $css_file = $this-&gt;check_and_use_css_file( $parent_info-&gt;location . '/' . $this-&gt;get_active_device_class() . '/style.css', WP_CONTENT_DIR, content_url() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-parent-theme-css', wptouch_check_url_ssl( $css_file ), false, md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_css_file = $this-&gt;check_and_use_css_file(&nbsp;</div></li><li><div>          $settings-&gt;current_theme_location . DIRECTORY_SEPARATOR . $settings-&gt;current_theme_name . DIRECTORY_SEPARATOR . $this-&gt;get_active_device_class() . DIRECTORY_SEPARATOR . 'style.css', &nbsp;</div></li><li><div>          str_replace( '/', DIRECTORY_SEPARATOR, WP_CONTENT_DIR ), &nbsp;</div></li><li><div>          content_url()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $framework_version = $this-&gt;current_theme_framework_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $framework_version &gt; 1 ) {&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-theme-css', wptouch_check_url_ssl( $theme_css_file ), array( 'foundation-framework-style' ), md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_enqueue_style( 'wptouch-theme-css', wptouch_check_url_ssl( $theme_css_file ), array( 'wptouch-parent-theme-css' ), md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_parent_style_queued' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function current_theme_framework_version() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_info = $this-&gt;get_current_theme_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $theme_info-&gt;framework ) {&nbsp;</div></li><li><div>          return $theme_info-&gt;framework;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_child_theme_styles() {&nbsp;</div></li><li><div>      $css_file = $this-&gt;check_and_use_css_file( $this-&gt;get_stylesheet_directory( false )  . '/style.css' );&nbsp;</div></li><li><div>      wp_enqueue_style( 'wptouch_child', wptouch_check_url_ssl( $css_file ), array( 'wptouch-parent-theme-css' ), md5( WPTOUCH_VERSION ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function https_for_ssl( $content ) {&nbsp;</div></li><li><div>      return wptouch_check_url_ssl( $content );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_desktop_footer() {&nbsp;</div></li><li><div>      if ( !is_feed() ) {&nbsp;</div></li><li><div>          if ( defined( 'WPTOUCH_IS_FREE' ) ) {&nbsp;</div></li><li><div>              echo &quot;&lt;!-- Powered by WPtouch: &quot; . WPTOUCH_VERSION . &quot; --&gt;&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo &quot;&lt;!-- Powered by WPtouch Pro: &quot; . WPTOUCH_VERSION . &quot; --&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function show_desktop_switch_link() {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/theme.php' );&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/globals.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_mobile_device && !$this-&gt;showing_mobile_theme ) {&nbsp;</div></li><li><div>          if ( file_exists( WPTOUCH_DIR . '/include/html/desktop-switch.php' ) ) {&nbsp;</div></li><li><div>              wptouch_show_desktop_switch_link();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function verify_post_nonce() {&nbsp;</div></li><li><div>      if ( !isset( $this-&gt;post[ 'wptouch-admin-nonce' ] ) ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_SECURITY, &quot;Unable to verify WPtouch post nonce&quot; );&nbsp;</div></li><li><div>          die( 'Unable to verify WPtouch Pro post nonce' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $nonce = $this-&gt;post['wptouch-admin-nonce'];&nbsp;</div></li><li><div>          if ( !wp_verify_nonce( $nonce, 'wptouch-post-nonce' ) ) {&nbsp;</div></li><li><div>              WPTOUCH_DEBUG( WPTOUCH_SECURITY, &quot;Unable to verify WPtouch post nonce&quot; );&nbsp;</div></li><li><div>              die( 'Unable to verify WPtouch Pro post nonce' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function reset_icon_states() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&nbsp;</div></li><li><div>          $wpdb-&gt;prepare( 'DELETE FROM ' . $wpdb-&gt;prefix . 'postmeta WHERE meta_key = %s', '_wptouch_pro_menu_item_disabled' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&nbsp;</div></li><li><div>          $wpdb-&gt;prepare( 'DELETE FROM ' . $wpdb-&gt;prefix . 'postmeta WHERE meta_key = %s', '_wptouch_pro_menu_item_icon' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = wptouch_get_settings();&nbsp;</div></li><li><div>      $settings-&gt;default_menu_icon = WPTOUCH_DEFAULT_MENU_ICON;&nbsp;</div></li><li><div>      $settings-&gt;save();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function erase_all_settings() {&nbsp;</div></li><li><div>      WPTOUCH_DEBUG( WPTOUCH_WARNING, 'Erasing all settings' );&nbsp;</div></li><li><div>      $this-&gt;load_root_functions_files();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $setting_domains = $this-&gt;get_active_setting_domains();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $setting_domains ) && count( $setting_domains ) ) {&nbsp;</div></li><li><div>          foreach( $setting_domains as $domain ) {&nbsp;</div></li><li><div>              $setting_name = $this-&gt;get_wp_setting_name_for_domain( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;is_domain_site_wide( $domain ) ) {&nbsp;</div></li><li><div>                  delete_site_option( $setting_name );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  delete_option( $setting_name );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;settings_objects = array();&nbsp;</div></li><li><div>      $this-&gt;delete_theme_add_on_cache();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_after_reset_settings' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function process_submitted_settings( $update_info = false ) {&nbsp;</div></li><li><div>      $old_settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'POST' != $_SERVER['REQUEST_METHOD'] ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/admin-settings.php' );&nbsp;</div></li><li><div>      wptouch_settings_process( $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_settings = wptouch_get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wptouch_pro_update_site_info' ) && $update_info ) {&nbsp;</div></li><li><div>          <span class="comment">//wptouch_pro_update_site_info();</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_theme_copy_num( $base ) {&nbsp;</div></li><li><div>      $num = 1;&nbsp;</div></li><li><div>      while( true ) {&nbsp;</div></li><li><div>          if ( !file_exists( WPTOUCH_CUSTOM_THEME_DIRECTORY . '/' . $base . '-copy-' . $num ) ) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $num++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $num;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_settings( $settings, $domain = 'wptouch_pro' ) {&nbsp;</div></li><li><div>      if ( $domain == 'wptouch_pro' ) {&nbsp;</div></li><li><div>          $settings = apply_filters( 'wptouch_update_settings', $settings );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Domain specific filtering</span>&nbsp;</div></li><li><div>      $settings = apply_filters( 'wptouch_update_settings_domain', $settings, $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save the old domain</span>&nbsp;</div></li><li><div>      $old_domain = $settings-&gt;domain;&nbsp;</div></li><li><div>      unset( $settings-&gt;domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// From development</span>&nbsp;</div></li><li><div>      if ( isset( $settings-&gt;site_wide ) ) {&nbsp;</div></li><li><div>          unset( $settings-&gt;site_wide );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $setting_name = $this-&gt;get_wp_setting_name_for_domain( $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_domain_site_wide( $domain ) ) {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_VERBOSE, 'Saving site wide option for domain ' . $domain );&nbsp;</div></li><li><div>          update_site_option( $setting_name, $settings );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WPTOUCH_DEBUG( WPTOUCH_VERBOSE, 'Saving non-site wide option for domain ' . $domain );&nbsp;</div></li><li><div>          update_option( $setting_name, $settings );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Restore old domain</span>&nbsp;</div></li><li><div>      $settings-&gt;domain = $old_domain;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/menu.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;settings_objects[ $domain ] = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wptouch_update_settings_domain_' . $domain );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function recursive_copy( $source_dir, $dest_dir ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wptouch_recursive_copy( $source_dir, $dest_dir );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function recursive_delete( $source_dir ) {&nbsp;</div></li><li><div>      require_once( WPTOUCH_DIR . '/core/file-operations.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wptouch_recursive_delete( $source_dir );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WPtouch Mobile Plugin</li><li><span></span>4.3.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>