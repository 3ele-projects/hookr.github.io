<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="class" data-id="11694"><head xmlns="http://www.w3.org/1999/xhtml"><title> jetpack | class | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Jetpack, class, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The Jetpack by WordPress.com Jetpack class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=335f7fe5846c9031508ca418b8228f38' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/jetpack/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-class-jetpack","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="jetpack" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">jetpack</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="active" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Jetpack</strong></h1><p>Options: jetpack_options (array) An array of options.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/class-jetpack/" class="file">/class.jetpack.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="25" class="block" start="25"><li><div>class Jetpack {&nbsp;</div></li><li><div>    public $xmlrpc_server = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $xmlrpc_verification = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $HTTP_RAW_POST_DATA = null; // copy of $GLOBALS['HTTP_RAW_POST_DATA']&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @var array The handles of styles that are concatenated into jetpack.css&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $concatenated_style_handles = array(&nbsp;</div></li><li><div>        'jetpack-carousel', &nbsp;</div></li><li><div>        'grunion.css', &nbsp;</div></li><li><div>        'the-neverending-homepage', &nbsp;</div></li><li><div>        'jetpack_likes', &nbsp;</div></li><li><div>        'jetpack_related-posts', &nbsp;</div></li><li><div>        'sharedaddy', &nbsp;</div></li><li><div>        'jetpack-slideshow', &nbsp;</div></li><li><div>        'presentations', &nbsp;</div></li><li><div>        'jetpack-subscriptions', &nbsp;</div></li><li><div>        'tiled-gallery', &nbsp;</div></li><li><div>        'widget-conditions', &nbsp;</div></li><li><div>        'jetpack_display_posts_widget', &nbsp;</div></li><li><div>        'gravatar-profile-widget', &nbsp;</div></li><li><div>        'widget-grid-and-list', &nbsp;</div></li><li><div>        'jetpack-widgets', &nbsp;</div></li><li><div>        'goodreads-widget', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $plugins_to_deactivate = array(&nbsp;</div></li><li><div>        'stats' =&gt; array( 'stats/stats.php', 'WordPress.com Stats' ), &nbsp;</div></li><li><div>        'shortlinks' =&gt; array( 'stats/stats.php', 'WordPress.com Stats' ), &nbsp;</div></li><li><div>        'sharedaddy' =&gt; array( 'sharedaddy/sharedaddy.php', 'Sharedaddy' ), &nbsp;</div></li><li><div>        'twitter-widget' =&gt; array( 'wickett-twitter-widget/wickett-twitter-widget.php', 'Wickett Twitter Widget' ), &nbsp;</div></li><li><div>        'after-the-deadline' =&gt; array( 'after-the-deadline/after-the-deadline.php', 'After The Deadline' ), &nbsp;</div></li><li><div>        'contact-form' =&gt; array( 'grunion-contact-form/grunion-contact-form.php', 'Grunion Contact Form' ), &nbsp;</div></li><li><div>        'contact-form' =&gt; array( 'mullet/mullet-contact-form.php', 'Mullet Contact Form' ), &nbsp;</div></li><li><div>        'custom-css' =&gt; array( 'safecss/safecss.php', 'WordPress.com Custom CSS' ), &nbsp;</div></li><li><div>        'random-redirect' =&gt; array( 'random-redirect/random-redirect.php', 'Random Redirect' ), &nbsp;</div></li><li><div>        'videopress' =&gt; array( 'video/video.php', 'VideoPress' ), &nbsp;</div></li><li><div>        'widget-visibility' =&gt; array( 'jetpack-widget-visibility/widget-visibility.php', 'Jetpack Widget Visibility' ), &nbsp;</div></li><li><div>        'widget-visibility' =&gt; array( 'widget-visibility-without-jetpack/widget-visibility-without-jetpack.php', 'Widget Visibility Without Jetpack' ), &nbsp;</div></li><li><div>        'sharedaddy' =&gt; array( 'jetpack-sharing/sharedaddy.php', 'Jetpack Sharing' ), &nbsp;</div></li><li><div>        'omnisearch' =&gt; array( 'jetpack-omnisearch/omnisearch.php', 'Jetpack Omnisearch' ), &nbsp;</div></li><li><div>        'gravatar-hovercards' =&gt; array( 'jetpack-gravatar-hovercards/gravatar-hovercards.php', 'Jetpack Gravatar Hovercards' ), &nbsp;</div></li><li><div>        'latex' =&gt; array( 'wp-latex/wp-latex.php', 'WP LaTeX' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $capability_translations = array(&nbsp;</div></li><li><div>        'administrator' =&gt; 'manage_options', &nbsp;</div></li><li><div>        'editor' =&gt; 'edit_others_posts', &nbsp;</div></li><li><div>        'author' =&gt; 'publish_posts', &nbsp;</div></li><li><div>        'contributor' =&gt; 'edit_posts', &nbsp;</div></li><li><div>        'subscriber' =&gt; 'read', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Map of modules that have conflicts with plugins and should not be auto-activated&nbsp;</div></li><li><div>     * if the plugins are active.  Used by filter_default_modules&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Plugin Authors: If you'd like to prevent a single module from auto-activating, &nbsp;</div></li><li><div>     * change `module-slug` and add this to your plugin:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * add_filter( 'jetpack_get_default_modules', 'my_jetpack_get_default_modules' );&nbsp;</div></li><li><div>     * function my_jetpack_get_default_modules( $modules ) {&nbsp;</div></li><li><div>     *     return array_diff( $modules, array( 'module-slug' ) );&nbsp;</div></li><li><div>     * }&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $conflicting_plugins = array(&nbsp;</div></li><li><div>        'comments' =&gt; array(&nbsp;</div></li><li><div>            'Intense Debate' =&gt; 'intensedebate/intensedebate.php', &nbsp;</div></li><li><div>            'Disqus' =&gt; 'disqus-comment-system/disqus.php', &nbsp;</div></li><li><div>            'Livefyre' =&gt; 'livefyre-comments/livefyre.php', &nbsp;</div></li><li><div>            'Comments Evolved for WordPress' =&gt; 'gplus-comments/comments-evolved.php', &nbsp;</div></li><li><div>            'Google+ Comments' =&gt; 'google-plus-comments/google-plus-comments.php', &nbsp;</div></li><li><div>            'WP-SpamShield Anti-Spam' =&gt; 'wp-spamshield/wp-spamshield.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'contact-form' =&gt; array(&nbsp;</div></li><li><div>            'Contact Form 7' =&gt; 'contact-form-7/wp-contact-form-7.php', &nbsp;</div></li><li><div>            'Gravity Forms' =&gt; 'gravityforms/gravityforms.php', &nbsp;</div></li><li><div>            'Contact Form Plugin' =&gt; 'contact-form-plugin/contact_form.php', &nbsp;</div></li><li><div>            'Easy Contact Forms' =&gt; 'easy-contact-forms/easy-contact-forms.php', &nbsp;</div></li><li><div>            'Fast Secure Contact Form' =&gt; 'si-contact-form/si-contact-form.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'minileven' =&gt; array(&nbsp;</div></li><li><div>            'WPtouch' =&gt; 'wptouch/wptouch.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'latex' =&gt; array(&nbsp;</div></li><li><div>            'LaTeX for WordPress' =&gt; 'latex/latex.php', &nbsp;</div></li><li><div>            'Youngwhans Simple Latex' =&gt; 'youngwhans-simple-latex/yw-latex.php', &nbsp;</div></li><li><div>            'Easy WP LaTeX' =&gt; 'easy-wp-latex-lite/easy-wp-latex-lite.php', &nbsp;</div></li><li><div>            'MathJax-LaTeX' =&gt; 'mathjax-latex/mathjax-latex.php', &nbsp;</div></li><li><div>            'Enable Latex' =&gt; 'enable-latex/enable-latex.php', &nbsp;</div></li><li><div>            'WP QuickLaTeX' =&gt; 'wp-quicklatex/wp-quicklatex.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'protect' =&gt; array(&nbsp;</div></li><li><div>            'Limit Login Attempts' =&gt; 'limit-login-attempts/limit-login-attempts.php', &nbsp;</div></li><li><div>            'Captcha' =&gt; 'captcha/captcha.php', &nbsp;</div></li><li><div>            'Brute Force Login Protection' =&gt; 'brute-force-login-protection/brute-force-login-protection.php', &nbsp;</div></li><li><div>            'Login Security Solution' =&gt; 'login-security-solution/login-security-solution.php', &nbsp;</div></li><li><div>            'WPSecureOps Brute Force Protect' =&gt; 'wpsecureops-bruteforce-protect/wpsecureops-bruteforce-protect.php', &nbsp;</div></li><li><div>            'BulletProof Security' =&gt; 'bulletproof-security/bulletproof-security.php', &nbsp;</div></li><li><div>            'SiteGuard WP Plugin' =&gt; 'siteguard/siteguard.php', &nbsp;</div></li><li><div>            'Security-protection' =&gt; 'security-protection/security-protection.php', &nbsp;</div></li><li><div>            'Login Security' =&gt; 'login-security/login-security.php', &nbsp;</div></li><li><div>            'Botnet Attack Blocker' =&gt; 'botnet-attack-blocker/botnet-attack-blocker.php', &nbsp;</div></li><li><div>            'Wordfence Security' =&gt; 'wordfence/wordfence.php', &nbsp;</div></li><li><div>            'All In One WP Security & Firewall' =&gt; 'all-in-one-wp-security-and-firewall/wp-security.php', &nbsp;</div></li><li><div>            'iThemes Security' =&gt; 'better-wp-security/better-wp-security.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'random-redirect' =&gt; array(&nbsp;</div></li><li><div>            'Random Redirect 2' =&gt; 'random-redirect-2/random-redirect.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'related-posts' =&gt; array(&nbsp;</div></li><li><div>            'YARPP' =&gt; 'yet-another-related-posts-plugin/yarpp.php', &nbsp;</div></li><li><div>            'WordPress Related Posts' =&gt; 'wordpress-23-related-posts-plugin/wp_related_posts.php', &nbsp;</div></li><li><div>            'nrelate Related Content' =&gt; 'nrelate-related-content/nrelate-related.php', &nbsp;</div></li><li><div>            'Contextual Related Posts' =&gt; 'contextual-related-posts/contextual-related-posts.php', &nbsp;</div></li><li><div>            'Related Posts for WordPress' =&gt; 'microkids-related-posts/microkids-related-posts.php', &nbsp;</div></li><li><div>            'outbrain' =&gt; 'outbrain/outbrain.php', &nbsp;</div></li><li><div>            'Shareaholic' =&gt; 'shareaholic/shareaholic.php', &nbsp;</div></li><li><div>            'Sexybookmarks' =&gt; 'sexybookmarks/shareaholic.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'sharedaddy' =&gt; array(&nbsp;</div></li><li><div>            'AddThis' =&gt; 'addthis/addthis_social_widget.php', &nbsp;</div></li><li><div>            'Add To Any' =&gt; 'add-to-any/add-to-any.php', &nbsp;</div></li><li><div>            'ShareThis' =&gt; 'share-this/sharethis.php', &nbsp;</div></li><li><div>            'Shareaholic' =&gt; 'shareaholic/shareaholic.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'verification-tools' =&gt; array(&nbsp;</div></li><li><div>            'WordPress SEO by Yoast' =&gt; 'wordpress-seo/wp-seo.php', &nbsp;</div></li><li><div>            'WordPress SEO Premium by Yoast' =&gt; 'wordpress-seo-premium/wp-seo-premium.php', &nbsp;</div></li><li><div>            'All in One SEO Pack' =&gt; 'all-in-one-seo-pack/all_in_one_seo_pack.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>        'widget-visibility' =&gt; array(&nbsp;</div></li><li><div>            'Widget Logic' =&gt; 'widget-logic/widget_logic.php', &nbsp;</div></li><li><div>            'Dynamic Widgets' =&gt; 'dynamic-widgets/dynamic-widgets.php', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Plugins for which we turn off our Facebook OG Tags implementation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note: WordPress SEO by Yoast and WordPress SEO Premium by Yoast automatically deactivate&nbsp;</div></li><li><div>     * Jetpack's Open Graph tags via filter when their Social Meta modules are active.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Plugin authors: If you'd like to prevent Jetpack's Open Graph tag generation in your plugin, you can do so via this filter:&nbsp;</div></li><li><div>     * add_filter( 'jetpack_enable_open_graph', '__return_false' );&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $open_graph_conflicting_plugins = array(&nbsp;</div></li><li><div>        '2-click-socialmedia-buttons/2-click-socialmedia-buttons.php', &nbsp;</div></li><li><div>                                                                 // 2 Click Social Media Buttons&nbsp;</div></li><li><div>        'add-link-to-facebook/add-link-to-facebook.php', // Add Link to Facebook&nbsp;</div></li><li><div>        'add-meta-tags/add-meta-tags.php', // Add Meta Tags&nbsp;</div></li><li><div>        'easy-facebook-share-thumbnails/esft.php', // Easy Facebook Share Thumbnail&nbsp;</div></li><li><div>        'facebook/facebook.php', // Facebook (official plugin)&nbsp;</div></li><li><div>        'facebook-awd/AWD_facebook.php', // Facebook AWD All in one&nbsp;</div></li><li><div>        'facebook-featured-image-and-open-graph-meta-tags/fb-featured-image.php', &nbsp;</div></li><li><div>                                                                 // Facebook Featured Image & OG Meta Tags&nbsp;</div></li><li><div>        'facebook-meta-tags/facebook-metatags.php', // Facebook Meta Tags&nbsp;</div></li><li><div>        'wonderm00ns-simple-facebook-open-graph-tags/wonderm00n-open-graph.php', &nbsp;</div></li><li><div>                                                                 // Facebook Open Graph Meta Tags for WordPress&nbsp;</div></li><li><div>        'facebook-revised-open-graph-meta-tag/index.php', // Facebook Revised Open Graph Meta Tag&nbsp;</div></li><li><div>        'facebook-thumb-fixer/_facebook-thumb-fixer.php', // Facebook Thumb Fixer&nbsp;</div></li><li><div>        'facebook-and-digg-thumbnail-generator/facebook-and-digg-thumbnail-generator.php', &nbsp;</div></li><li><div>                                                                 // Fedmich's Facebook Open Graph Meta&nbsp;</div></li><li><div>        'header-footer/plugin.php', // Header and Footer&nbsp;</div></li><li><div>        'network-publisher/networkpub.php', // Network Publisher&nbsp;</div></li><li><div>        'nextgen-facebook/nextgen-facebook.php', // NextGEN Facebook OG&nbsp;</div></li><li><div>        'social-networks-auto-poster-facebook-twitter-g/NextScripts_SNAP.php', &nbsp;</div></li><li><div>                                                                 // NextScripts SNAP&nbsp;</div></li><li><div>        'opengraph/opengraph.php', // Open Graph&nbsp;</div></li><li><div>        'open-graph-protocol-framework/open-graph-protocol-framework.php', &nbsp;</div></li><li><div>                                                                 // Open Graph Protocol Framework&nbsp;</div></li><li><div>        'seo-facebook-comments/seofacebook.php', // SEO Facebook Comments&nbsp;</div></li><li><div>        'seo-ultimate/seo-ultimate.php', // SEO Ultimate&nbsp;</div></li><li><div>        'sexybookmarks/sexy-bookmarks.php', // Shareaholic&nbsp;</div></li><li><div>        'shareaholic/sexy-bookmarks.php', // Shareaholic&nbsp;</div></li><li><div>        'sharepress/sharepress.php', // SharePress&nbsp;</div></li><li><div>        'simple-facebook-connect/sfc.php', // Simple Facebook Connect&nbsp;</div></li><li><div>        'social-discussions/social-discussions.php', // Social Discussions&nbsp;</div></li><li><div>        'social-sharing-toolkit/social_sharing_toolkit.php', // Social Sharing Toolkit&nbsp;</div></li><li><div>        'socialize/socialize.php', // Socialize&nbsp;</div></li><li><div>        'only-tweet-like-share-and-google-1/tweet-like-plusone.php', &nbsp;</div></li><li><div>                                                                 // Tweet, Like, Google +1 and Share&nbsp;</div></li><li><div>        'wordbooker/wordbooker.php', // Wordbooker&nbsp;</div></li><li><div>        'wpsso/wpsso.php', // WordPress Social Sharing Optimization&nbsp;</div></li><li><div>        'wp-caregiver/wp-caregiver.php', // WP Caregiver&nbsp;</div></li><li><div>        'wp-facebook-like-send-open-graph-meta/wp-facebook-like-send-open-graph-meta.php', &nbsp;</div></li><li><div>                                                                 // WP Facebook Like Send & Open Graph Meta&nbsp;</div></li><li><div>        'wp-facebook-open-graph-protocol/wp-facebook-ogp.php', // WP Facebook Open Graph protocol&nbsp;</div></li><li><div>        'wp-ogp/wp-ogp.php', // WP-OGP&nbsp;</div></li><li><div>        'zoltonorg-social-plugin/zosp.php', // Zolton.org Social Plugin&nbsp;</div></li><li><div>        'wp-fb-share-like-button/wp_fb_share-like_widget.php'    // WP Facebook Like Button&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Plugins for which we turn off our Twitter Cards Tags implementation.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $twitter_cards_conflicting_plugins = array(&nbsp;</div></li><li><div>    //    'twitter/twitter.php', // The official one handles this on its own.&nbsp;</div></li><li><div>    //                                                 // https://github.com/twitter/wordpress/blob/master/src/Twitter/WordPress/Cards/Compatibility.php&nbsp;</div></li><li><div>        'eewee-twitter-card/index.php', // Eewee Twitter Card&nbsp;</div></li><li><div>        'ig-twitter-cards/ig-twitter-cards.php', // IG:Twitter Cards&nbsp;</div></li><li><div>        'jm-twitter-cards/jm-twitter-cards.php', // JM Twitter Cards&nbsp;</div></li><li><div>        'kevinjohn-gallagher-pure-web-brilliants-social-graph-twitter-cards-extention/kevinjohn_gallagher___social_graph_twitter_output.php', &nbsp;</div></li><li><div>                                                     // Pure Web Brilliant's Social Graph Twitter Cards Extension&nbsp;</div></li><li><div>        'twitter-cards/twitter-cards.php', // Twitter Cards&nbsp;</div></li><li><div>        'twitter-cards-meta/twitter-cards-meta.php', // Twitter Cards Meta&nbsp;</div></li><li><div>        'wp-twitter-cards/twitter_cards.php', // WP Twitter Cards&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Message to display in admin_notice&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Error to display in admin_notice&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Modules that need more privacy description.&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $privacy_checks = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stats to record once the page loads&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $stats = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Allows us to build a temporary security report&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static $security_report = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Sync object&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $sync;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Verified data for JSON authorization request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $json_api_authorization_request = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds the singleton instance of this class&nbsp;</div></li><li><div>     * @since 2.3.3&nbsp;</div></li><li><div>     * @var Jetpack&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static $instance = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Singleton&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init() {&nbsp;</div></li><li><div>        if ( ! self::$instance ) {&nbsp;</div></li><li><div>            if ( did_action( 'plugins_loaded' ) )&nbsp;</div></li><li><div>                self::plugin_textdomain();&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                add_action( 'plugins_loaded', array( __CLASS__, 'plugin_textdomain' ), 99 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            self::$instance = new Jetpack;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            self::$instance-&gt;plugin_upgrade();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_action( 'init', array( __CLASS__, 'perform_security_reporting' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Must never be called statically&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function plugin_upgrade() {&nbsp;</div></li><li><div>        // Upgrade: 1.1 -&gt; 1.2&nbsp;</div></li><li><div>        if ( get_option( 'jetpack_id' ) ) {&nbsp;</div></li><li><div>            // Move individual jetpack options to single array of options&nbsp;</div></li><li><div>            $options = array();&nbsp;</div></li><li><div>            foreach ( Jetpack_Options::get_option_names() as $option ) {&nbsp;</div></li><li><div>                if ( false !== $value = get_option( &quot;jetpack_$option&quot; ) ) {&nbsp;</div></li><li><div>                    $options[$option] = $value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $options ) {&nbsp;</div></li><li><div>                Jetpack_Options::update_options( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( array_keys( $options ) as $option ) {&nbsp;</div></li><li><div>                    delete_option( &quot;jetpack_$option&quot; );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add missing version and old_version options&nbsp;</div></li><li><div>            if ( ! $version = Jetpack_Options::get_option( 'version' ) ) {&nbsp;</div></li><li><div>                $version = $old_version = '1.1:' . time();&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires on update, before bumping version numbers up to a new version.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.4.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param string $version Jetpack version number.&nbsp;</div></li><li><div>                 * @param bool false Does an old version exist. Default is false.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'updating_jetpack_version', $version, false );&nbsp;</div></li><li><div>                Jetpack_Options::update_options( compact( 'version', 'old_version' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upgrade from a single user token to a user_id-indexed array and a master_user ID&nbsp;</div></li><li><div>        if ( ! Jetpack_Options::get_option( 'user_tokens' ) ) {&nbsp;</div></li><li><div>            if ( $user_token = Jetpack_Options::get_option( 'user_token' ) ) {&nbsp;</div></li><li><div>                $token_parts = explode( '.', $user_token );&nbsp;</div></li><li><div>                if ( isset( $token_parts[2] ) ) {&nbsp;</div></li><li><div>                    $master_user = $token_parts[2];&nbsp;</div></li><li><div>                    $user_tokens = array( $master_user =&gt; $user_token );&nbsp;</div></li><li><div>                    Jetpack_Options::update_options( compact( 'master_user', 'user_tokens' ) );&nbsp;</div></li><li><div>                    Jetpack_Options::delete_option( 'user_token' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // @todo: is this even possible?&nbsp;</div></li><li><div>                    trigger_error( sprintf( 'Jetpack::plugin_upgrade found no user_id in user_token &quot;%s&quot;', $user_token ), E_USER_WARNING );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Clean up legacy G+ Authorship data.&nbsp;</div></li><li><div>        if ( get_option( 'gplus_authors' ) ) {&nbsp;</div></li><li><div>            delete_option( 'gplus_authors' );&nbsp;</div></li><li><div>            delete_option( 'hide_gplus' );&nbsp;</div></li><li><div>            delete_metadata( 'post', 0, 'gplus_authorship_disabled', null, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! get_option( 'jetpack_private_options' ) ) {&nbsp;</div></li><li><div>            $jetpack_options = get_option( 'jetpack_options', array() );&nbsp;</div></li><li><div>            foreach( Jetpack_Options::get_option_names( 'private' ) as $option_name ) {&nbsp;</div></li><li><div>                if ( isset( $jetpack_options[ $option_name ] ) ) {&nbsp;</div></li><li><div>                    Jetpack_Options::update_option( $option_name, $jetpack_options[ $option_name ] );&nbsp;</div></li><li><div>                    unset( $jetpack_options[ $option_name ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            update_option( 'jetpack_options', $jetpack_options );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>            list( $version ) = explode( ':', Jetpack_Options::get_option( 'version' ) );&nbsp;</div></li><li><div>            if ( JETPACK__VERSION != $version ) {&nbsp;</div></li><li><div>                add_action( 'init', array( __CLASS__, 'activate_new_modules' ) );&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires when synchronizing all registered options and constants.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.3.0&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'jetpack_sync_all_registered_options' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //if Jetpack is connected check if jetpack_unique_connection exists and if not then set it&nbsp;</div></li><li><div>            $jetpack_unique_connection = get_option( 'jetpack_unique_connection' );&nbsp;</div></li><li><div>            $is_unique_connection = $jetpack_unique_connection && array_key_exists( 'version', $jetpack_unique_connection );&nbsp;</div></li><li><div>            if ( ! $is_unique_connection ) {&nbsp;</div></li><li><div>                $jetpack_unique_connection = array(&nbsp;</div></li><li><div>                    'connected' =&gt; 1, &nbsp;</div></li><li><div>                    'disconnected' =&gt; -1, &nbsp;</div></li><li><div>                    'version' =&gt; '3.6.1'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                update_option( 'jetpack_unique_connection', $jetpack_unique_connection );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( get_option( 'jetpack_json_api_full_management' ) ) {&nbsp;</div></li><li><div>            delete_option( 'jetpack_json_api_full_management' );&nbsp;</div></li><li><div>            self::activate_manage();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    static function activate_manage( ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( did_action( 'init' ) || current_filter() == 'init' ) {&nbsp;</div></li><li><div>            self::activate_module( 'manage', false, false );&nbsp;</div></li><li><div>        } else if ( !  has_action( 'init' , array( __CLASS__, 'activate_manage' ) ) ) {&nbsp;</div></li><li><div>            add_action( 'init', array( __CLASS__, 'activate_manage' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Constructor.  Initializes WordPress hooks&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function __construct() {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Check for and alert any deprecated hooks&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_action( 'init', array( $this, 'deprecated_hooks' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Do things that should run even in the network admin&nbsp;</div></li><li><div>         * here, before we potentially fail out.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_filter( 'jetpack_require_lib_dir', array( $this, 'require_lib_dir' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * We need sync object even in Multisite mode&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $this-&gt;sync = new Jetpack_Sync;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Trigger a wp_version sync when updating WP versions&nbsp;</div></li><li><div>         **/&nbsp;</div></li><li><div>        add_action( 'upgrader_process_complete', array( 'Jetpack', 'update_get_wp_version' ), 10, 2 );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'wp_version', array( 'Jetpack', 'get_wp_version' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'init', array( $this, 'sync_update_data') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Load things that should only be in Network Admin.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * For now blow away everything else until a more full&nbsp;</div></li><li><div>         * understanding of what is needed at the network level is&nbsp;</div></li><li><div>         * available&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if( is_multisite() ) {&nbsp;</div></li><li><div>            Jetpack_Network::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Only sync this info if we are on a multi site&nbsp;</div></li><li><div>            // @since  3.7&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_name', array( 'Jetpack', 'network_name' ) );&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_allow_new_registrations', array( 'Jetpack', 'network_allow_new_registrations' ) );&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_add_new_users', array( 'Jetpack', 'network_add_new_users' ) );&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_site_upload_space', array( 'Jetpack', 'network_site_upload_space' ) );&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_upload_file_types', array( 'Jetpack', 'network_upload_file_types' ) );&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'network_enable_administration_menus', array( 'Jetpack', 'network_enable_administration_menus' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( is_network_admin() ) {&nbsp;</div></li><li><div>                // Sync network site data if it is updated or not.&nbsp;</div></li><li><div>                add_action( 'update_wpmu_options', array( $this, 'update_jetpack_network_settings' ) );&nbsp;</div></li><li><div>                return; // End here to prevent single site actions from firing&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $theme_slug = get_option( 'stylesheet' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Modules should do Jetpack_Sync::sync_options( __FILE__, $option, ... ); instead&nbsp;</div></li><li><div>        // We access the &quot;internal&quot; method here only because the Jetpack object isn't instantiated yet&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;options(&nbsp;</div></li><li><div>            JETPACK__PLUGIN_DIR . 'jetpack.php', &nbsp;</div></li><li><div>            'home', &nbsp;</div></li><li><div>            'siteurl', &nbsp;</div></li><li><div>            'blogname', &nbsp;</div></li><li><div>            'gmt_offset', &nbsp;</div></li><li><div>            'timezone_string', &nbsp;</div></li><li><div>            'security_report', &nbsp;</div></li><li><div>            'stylesheet', &nbsp;</div></li><li><div>            &quot;theme_mods_{$theme_slug}&quot;, &nbsp;</div></li><li><div>            'jetpack_sync_non_public_post_stati', &nbsp;</div></li><li><div>            'jetpack_options', &nbsp;</div></li><li><div>            'site_icon' // (int) - ID of core's Site Icon attachment ID&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( Jetpack_Options::get_option_names( 'non-compact' ) as $option ) {&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;options( __FILE__, 'jetpack_' . $option );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Sometimes you want to sync data to .com without adding options to .org sites.&nbsp;</div></li><li><div>         * The mock option allows you to do just that.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'is_main_network', array( $this, 'is_main_network_option' ) );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'is_multi_site', array( $this, 'is_multisite' ) );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'main_network_site', array( $this, 'jetpack_main_network_site_option' ) );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'single_user_site', array( 'Jetpack', 'is_single_user_site' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'has_file_system_write_access', array( 'Jetpack', 'file_system_write_access' ) );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'is_version_controlled', array( 'Jetpack', 'is_version_controlled' ) );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'max_upload_size', 'wp_max_upload_size' );&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'content_width', array( 'Jetpack', 'get_content_width' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Trigger an update to the main_network_site when we update the blogname of a site.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_action( 'update_option_siteurl', array( $this, 'update_jetpack_main_network_site_option' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'update_option', array( $this, 'log_settings_change' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update the settings everytime the we register a new user to the site or we delete a user.&nbsp;</div></li><li><div>        add_action( 'user_register', array( $this, 'is_single_user_site_invalidate' ) );&nbsp;</div></li><li><div>        add_action( 'deleted_user', array( $this, 'is_single_user_site_invalidate' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unlink user before deleting the user from .com&nbsp;</div></li><li><div>        add_action( 'deleted_user', array( $this, 'unlink_user' ), 10, 1 );&nbsp;</div></li><li><div>        add_action( 'remove_user_from_blog', array( $this, 'unlink_user' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( defined( 'XMLRPC_REQUEST' ) && XMLRPC_REQUEST && isset( $_GET['for'] ) && 'jetpack' == $_GET['for'] ) {&nbsp;</div></li><li><div>            @ini_set( 'display_errors', false ); // Display errors can cause the XML to be not well formed.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            require_once JETPACK__PLUGIN_DIR . 'class.jetpack-xmlrpc-server.php';&nbsp;</div></li><li><div>            $this-&gt;xmlrpc_server = new Jetpack_XMLRPC_Server();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;require_jetpack_authentication();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>                // Hack to preserve $HTTP_RAW_POST_DATA&nbsp;</div></li><li><div>                add_filter( 'xmlrpc_methods', array( $this, 'xmlrpc_methods' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $signed = $this-&gt;verify_xml_rpc_signature();&nbsp;</div></li><li><div>                if ( $signed && ! is_wp_error( $signed ) ) {&nbsp;</div></li><li><div>                    // The actual API methods.&nbsp;</div></li><li><div>                    add_filter( 'xmlrpc_methods', array( $this-&gt;xmlrpc_server, 'xmlrpc_methods' ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    add_filter( 'xmlrpc_methods', '__return_empty_array' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // The bootstrap API methods.&nbsp;</div></li><li><div>                add_filter( 'xmlrpc_methods', array( $this-&gt;xmlrpc_server, 'bootstrap_xmlrpc_methods' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Now that no one can authenticate, and we're whitelisting all XML-RPC methods, force enable_xmlrpc on.&nbsp;</div></li><li><div>            add_filter( 'pre_option_enable_xmlrpc', '__return_true' );&nbsp;</div></li><li><div>        } elseif ( is_admin() && isset( $_POST['action'] ) && 'jetpack_upload_file' == $_POST['action'] ) {&nbsp;</div></li><li><div>            $this-&gt;require_jetpack_authentication();&nbsp;</div></li><li><div>            $this-&gt;add_remote_request_handlers();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>                add_action( 'login_form_jetpack_json_api_authorization', array( &$this, 'login_form_json_api_authorization' ) );&nbsp;</div></li><li><div>                add_filter( 'xmlrpc_methods', array( $this, 'public_xmlrpc_methods' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>            Jetpack_Heartbeat::init();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'jetpack_clean_nonces', array( 'Jetpack', 'clean_nonces' ) );&nbsp;</div></li><li><div>        if ( ! wp_next_scheduled( 'jetpack_clean_nonces' ) ) {&nbsp;</div></li><li><div>            wp_schedule_event( time(), 'hourly', 'jetpack_clean_nonces' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'xmlrpc_blog_options', array( $this, 'xmlrpc_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_init', array( $this, 'admin_init' ) );&nbsp;</div></li><li><div>        add_action( 'admin_init', array( $this, 'dismiss_jetpack_notice' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'admin_body_class', array( $this, 'admin_body_class' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_dashboard_setup', array( $this, 'wp_dashboard_setup' ) );&nbsp;</div></li><li><div>        // Filter the dashboard meta box order to swap the new one in in place of the old one.&nbsp;</div></li><li><div>        add_filter( 'get_user_option_meta-box-order_dashboard', array( $this, 'get_user_option_meta_box_order_dashboard' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack-sync-reindex-trigger', array( $this, 'sync_reindex_trigger' ) );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack-sync-reindex-status', array( $this, 'sync_reindex_status' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Jump Start AJAX callback function&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack_jumpstart_ajax', array( $this, 'jetpack_jumpstart_ajax_callback' ) );&nbsp;</div></li><li><div>        add_action( 'update_option', array( $this, 'jumpstart_has_updated_module_option' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Identity Crisis AJAX callback function&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack_resolve_identity_crisis', array( $this, 'resolve_identity_crisis_ajax_callback' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // JITM AJAX callback function&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jitm_ajax', array( $this, 'jetpack_jitm_ajax_callback' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack_admin_ajax', array( $this, 'jetpack_admin_ajax_callback' ) );&nbsp;</div></li><li><div>        add_action( 'wp_ajax_jetpack_admin_ajax_refresh', array( $this, 'jetpack_admin_ajax_refresh_data' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_loaded', array( $this, 'register_assets' ) );&nbsp;</div></li><li><div>        add_action( 'wp_enqueue_scripts', array( $this, 'devicepx' ) );&nbsp;</div></li><li><div>        add_action( 'customize_controls_enqueue_scripts', array( $this, 'devicepx' ) );&nbsp;</div></li><li><div>        add_action( 'admin_enqueue_scripts', array( $this, 'devicepx' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'jetpack_activate_module', array( $this, 'activate_module_actions' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'plugins_loaded', array( $this, 'extra_oembed_providers' ), 100 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'jetpack_notices', array( $this, 'show_development_mode_notice' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * These actions run checks to load additional files.&nbsp;</div></li><li><div>         * They check for external files or plugins, so they need to run as late as possible.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        add_action( 'wp_head', array( $this, 'check_open_graph' ), 1 );&nbsp;</div></li><li><div>        add_action( 'plugins_loaded', array( $this, 'check_twitter_tags' ), 999 );&nbsp;</div></li><li><div>        add_action( 'plugins_loaded', array( $this, 'check_rest_api_compat' ), 1000 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'plugins_url', array( 'Jetpack', 'maybe_min_asset' ), 1, 3 );&nbsp;</div></li><li><div>        add_filter( 'style_loader_tag', array( 'Jetpack', 'maybe_inline_style' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'map_meta_cap', array( $this, 'jetpack_custom_caps' ), 1, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'jetpack_get_default_modules', array( $this, 'filter_default_modules' ) );&nbsp;</div></li><li><div>        add_filter( 'jetpack_get_default_modules', array( $this, 'handle_deprecated_modules' ), 99 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // A filter to control all just in time messages&nbsp;</div></li><li><div>        add_filter( 'jetpack_just_in_time_msgs', '__return_true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * This is the hack to concatinate all css files into one.&nbsp;</div></li><li><div>         * For description and reasoning see the implode_frontend_css method&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Super late priority so we catch all the registered styles&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if( !is_admin() ) {&nbsp;</div></li><li><div>            add_action( 'wp_print_styles', array( $this, 'implode_frontend_css' ), -1 ); // Run first&nbsp;</div></li><li><div>            add_action( 'wp_print_footer_scripts', array( $this, 'implode_frontend_css' ), -1 ); // Run first to trigger before `print_late_styles`&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sync Core Icon: Detect changes in Core's Site Icon and make it syncable.&nbsp;</div></li><li><div>        add_action( 'add_option_site_icon', array( $this, 'jetpack_sync_core_icon' ) );&nbsp;</div></li><li><div>        add_action( 'update_option_site_icon', array( $this, 'jetpack_sync_core_icon' ) );&nbsp;</div></li><li><div>        add_action( 'delete_option_site_icon', array( $this, 'jetpack_sync_core_icon' ) );&nbsp;</div></li><li><div>        add_action( 'jetpack_heartbeat', array( $this, 'jetpack_sync_core_icon' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Make sure any site icon added to core can get&nbsp;</div></li><li><div>     * synced back to dotcom, so we can display it there.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function jetpack_sync_core_icon() {&nbsp;</div></li><li><div>        if ( function_exists( 'get_site_icon_url' ) ) {&nbsp;</div></li><li><div>            $url = get_site_icon_url();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once( JETPACK__PLUGIN_DIR . 'modules/site-icon/site-icon-functions.php' );&nbsp;</div></li><li><div>        // If there's a core icon, maybe update the option.  If not, fall back to Jetpack's.&nbsp;</div></li><li><div>        if ( ! empty( $url ) && $url !== jetpack_site_icon_url() ) {&nbsp;</div></li><li><div>            // This is the option that is synced with dotcom&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'site_icon_url', $url );&nbsp;</div></li><li><div>        } else if ( empty( $url ) && did_action( 'delete_option_site_icon' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::delete_option( 'site_icon_url' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function jetpack_admin_ajax_callback() {&nbsp;</div></li><li><div>        // Check for nonce&nbsp;</div></li><li><div>        if ( ! isset( $_REQUEST['adminNonce'] ) || ! wp_verify_nonce( $_REQUEST['adminNonce'], 'jetpack-admin-nonce' ) || ! current_user_can( 'jetpack_manage_modules' ) ) {&nbsp;</div></li><li><div>            wp_die( 'permissions check failed' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['toggleModule'] ) && 'nux-toggle-module' == $_REQUEST['toggleModule'] ) {&nbsp;</div></li><li><div>            $slug = $_REQUEST['thisModuleSlug'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( $slug, Jetpack::get_available_modules() ) ) {&nbsp;</div></li><li><div>                wp_die( 'That is not a Jetpack module slug' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( Jetpack::is_module_active( $slug ) ) {&nbsp;</div></li><li><div>                Jetpack::deactivate_module( $slug );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                Jetpack::activate_module( $slug, false, false );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $modules = Jetpack_Admin::init()-&gt;get_modules();&nbsp;</div></li><li><div>            echo json_encode( $modules[ $slug ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sometimes we need to refresh the data, &nbsp;</div></li><li><div>     * especially if the page is visited via a 'history'&nbsp;</div></li><li><div>     * event like back/forward&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function jetpack_admin_ajax_refresh_data() {&nbsp;</div></li><li><div>        // Check for nonce&nbsp;</div></li><li><div>        if ( ! isset( $_REQUEST['adminNonce'] ) || ! wp_verify_nonce( $_REQUEST['adminNonce'], 'jetpack-admin-nonce' ) ) {&nbsp;</div></li><li><div>            wp_die( 'permissions check failed' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['refreshData'] ) && 'refresh' == $_REQUEST['refreshData'] ) {&nbsp;</div></li><li><div>            $modules = Jetpack_Admin::init()-&gt;get_modules();&nbsp;</div></li><li><div>            echo json_encode( $modules );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The callback for the Jump Start ajax requests.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function jetpack_jumpstart_ajax_callback() {&nbsp;</div></li><li><div>        // Check for nonce&nbsp;</div></li><li><div>        if ( ! isset( $_REQUEST['jumpstartNonce'] ) || ! wp_verify_nonce( $_REQUEST['jumpstartNonce'], 'jetpack-jumpstart-nonce' ) )&nbsp;</div></li><li><div>            wp_die( 'permissions check failed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['jumpStartActivate'] ) && 'jump-start-activate' == $_REQUEST['jumpStartActivate'] ) {&nbsp;</div></li><li><div>            // Update the jumpstart option&nbsp;</div></li><li><div>            if ( 'new_connection' === Jetpack_Options::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>                Jetpack_Options::update_option( 'jumpstart', 'jumpstart_activated' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Loops through the requested &quot;Jump Start&quot; modules, and activates them.&nbsp;</div></li><li><div>            // Custom 'no_message' state, so that no message will be shown on reload.&nbsp;</div></li><li><div>            $modules = $_REQUEST['jumpstartModSlug'];&nbsp;</div></li><li><div>            $module_slugs = array();&nbsp;</div></li><li><div>            foreach( $modules as $module =&gt; $value ) {&nbsp;</div></li><li><div>                $module_slugs[] = $value['module_slug'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for possible conflicting plugins&nbsp;</div></li><li><div>            $module_slugs_filtered = $this-&gt;filter_default_modules( $module_slugs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $module_slugs_filtered as $module_slug ) {&nbsp;</div></li><li><div>                Jetpack::log( 'activate', $module_slug );&nbsp;</div></li><li><div>                Jetpack::activate_module( $module_slug, false, false );&nbsp;</div></li><li><div>                Jetpack::state( 'message', 'no_message' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set the default sharing buttons and set to display on posts if none have been set.&nbsp;</div></li><li><div>            $sharing_services = get_option( 'sharing-services' );&nbsp;</div></li><li><div>            $sharing_options = get_option( 'sharing-options' );&nbsp;</div></li><li><div>            if ( empty( $sharing_services['visible'] ) ) {&nbsp;</div></li><li><div>                // Default buttons to set&nbsp;</div></li><li><div>                $visible = array(&nbsp;</div></li><li><div>                    'twitter', &nbsp;</div></li><li><div>                    'facebook', &nbsp;</div></li><li><div>                    'google-plus-1', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $hidden = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Set some sharing settings&nbsp;</div></li><li><div>                $sharing = new Sharing_Service();&nbsp;</div></li><li><div>                $sharing_options['global'] = array(&nbsp;</div></li><li><div>                    'button_style' =&gt; 'icon', &nbsp;</div></li><li><div>                    'sharing_label' =&gt; $sharing-&gt;default_sharing_label, &nbsp;</div></li><li><div>                    'open_links' =&gt; 'same', &nbsp;</div></li><li><div>                    'show' =&gt; array( 'post' ), &nbsp;</div></li><li><div>                    'custom' =&gt; isset( $sharing_options['global']['custom'] ) ? $sharing_options['global']['custom'] : array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_option( 'sharing-options', $sharing_options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Send a success response so that we can display an error message.&nbsp;</div></li><li><div>                $success = update_option( 'sharing-services', array( 'visible' =&gt; $visible, 'hidden' =&gt; $hidden ) );&nbsp;</div></li><li><div>                echo json_encode( $success );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif ( isset( $_REQUEST['disableJumpStart'] ) && true == $_REQUEST['disableJumpStart'] ) {&nbsp;</div></li><li><div>            // If dismissed, flag the jumpstart option as such.&nbsp;</div></li><li><div>            // Send a success response so that we can display an error message.&nbsp;</div></li><li><div>            if ( 'new_connection' === Jetpack_Options::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>                $success = Jetpack_Options::update_option( 'jumpstart', 'jumpstart_dismissed' );&nbsp;</div></li><li><div>                echo json_encode( $success );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif ( isset( $_REQUEST['jumpStartDeactivate'] ) && 'jump-start-deactivate' == $_REQUEST['jumpStartDeactivate'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // FOR TESTING ONLY&nbsp;</div></li><li><div>            // @todo remove&nbsp;</div></li><li><div>            $modules = (array) $_REQUEST['jumpstartModSlug'];&nbsp;</div></li><li><div>            foreach( $modules as $module =&gt; $value ) {&nbsp;</div></li><li><div>                if ( !in_array( $value['module_slug'], Jetpack::get_default_modules() ) ) {&nbsp;</div></li><li><div>                    Jetpack::log( 'deactivate', $value['module_slug'] );&nbsp;</div></li><li><div>                    Jetpack::deactivate_module( $value['module_slug'] );&nbsp;</div></li><li><div>                    Jetpack::state( 'message', 'no_message' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    Jetpack::log( 'activate', $value['module_slug'] );&nbsp;</div></li><li><div>                    Jetpack::activate_module( $value['module_slug'], false, false );&nbsp;</div></li><li><div>                    Jetpack::state( 'message', 'no_message' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'jumpstart', 'new_connection' );&nbsp;</div></li><li><div>            echo &quot;reload the page&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The callback for the JITM ajax requests.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function jetpack_jitm_ajax_callback() {&nbsp;</div></li><li><div>        // Check for nonce&nbsp;</div></li><li><div>        if ( ! isset( $_REQUEST['jitmNonce'] ) || ! wp_verify_nonce( $_REQUEST['jitmNonce'], 'jetpack-jitm-nonce' ) ) {&nbsp;</div></li><li><div>            wp_die( 'Module activation failed due to lack of appropriate permissions' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['jitmActionToTake'] ) && 'activate' == $_REQUEST['jitmActionToTake'] ) {&nbsp;</div></li><li><div>            $module_slug = $_REQUEST['jitmModule'];&nbsp;</div></li><li><div>            Jetpack::log( 'activate', $module_slug );&nbsp;</div></li><li><div>            Jetpack::activate_module( $module_slug, false, false );&nbsp;</div></li><li><div>            Jetpack::state( 'message', 'no_message' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //A Jetpack module is being activated through a JITM, track it&nbsp;</div></li><li><div>            $this-&gt;stat( 'jitm', $module_slug.'-activated-' . JETPACK__VERSION );&nbsp;</div></li><li><div>            $this-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['jitmActionToTake'] ) && 'dismiss' == $_REQUEST['jitmActionToTake'] ) {&nbsp;</div></li><li><div>            // get the hide_jitm options array&nbsp;</div></li><li><div>            $jetpack_hide_jitm = Jetpack_Options::get_option( 'hide_jitm' );&nbsp;</div></li><li><div>            $module_slug = $_REQUEST['jitmModule'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( ! $jetpack_hide_jitm ) {&nbsp;</div></li><li><div>                $jetpack_hide_jitm = array(&nbsp;</div></li><li><div>                    $module_slug =&gt; 'hide'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $jetpack_hide_jitm[$module_slug] = 'hide';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'hide_jitm', $jetpack_hide_jitm );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //jitm is being dismissed forever, track it&nbsp;</div></li><li><div>            $this-&gt;stat( 'jitm', $module_slug.'-dismissed-' . JETPACK__VERSION );&nbsp;</div></li><li><div>            $this-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If there are any stats that need to be pushed, but haven't been, push them now.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function __destruct() {&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;stats ) ) {&nbsp;</div></li><li><div>            $this-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function jetpack_custom_caps( $caps, $cap, $user_id, $args ) {&nbsp;</div></li><li><div>        switch( $cap ) {&nbsp;</div></li><li><div>            case 'jetpack_connect' :&nbsp;</div></li><li><div>            case 'jetpack_reconnect' :&nbsp;</div></li><li><div>                if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>                    $caps = array( 'do_not_allow' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Pass through. If it's not development mode, these should match disconnect.&nbsp;</div></li><li><div>                 * Let users disconnect if it's development mode, just in case things glitch.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>            case 'jetpack_disconnect' :&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * In multisite, can individual site admins manage their own connection?&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * Ideally, this should be extracted out to a separate filter in the Jetpack_Network class.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                if ( is_multisite() && ! is_super_admin() && is_plugin_active_for_network( 'jetpack/jetpack.php' ) ) {&nbsp;</div></li><li><div>                    if ( ! Jetpack_Network::init()-&gt;get_option( 'sub-site-connection-override' ) ) {&nbsp;</div></li><li><div>                        /**&nbsp;</div></li><li><div>                         * We need to update the option name -- it's terribly unclear which&nbsp;</div></li><li><div>                         * direction the override goes.&nbsp;</div></li><li><div>                         *&nbsp;</div></li><li><div>                         * @todo: Update the option name to `sub-sites-can-manage-own-connections`&nbsp;</div></li><li><div>                         */&nbsp;</div></li><li><div>                        $caps = array( 'do_not_allow' );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $caps = array( 'manage_options' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack_manage_modules' :&nbsp;</div></li><li><div>            case 'jetpack_activate_modules' :&nbsp;</div></li><li><div>            case 'jetpack_deactivate_modules' :&nbsp;</div></li><li><div>                $caps = array( 'manage_options' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack_configure_modules' :&nbsp;</div></li><li><div>                $caps = array( 'manage_options' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack_network_admin_page':&nbsp;</div></li><li><div>            case 'jetpack_network_settings_page':&nbsp;</div></li><li><div>                $caps = array( 'manage_network_plugins' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack_network_sites_page':&nbsp;</div></li><li><div>                $caps = array( 'manage_sites' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack_admin_page' :&nbsp;</div></li><li><div>                if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>                    $caps = array( 'manage_options' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Don't ever show to subscribers, but allow access to the page if they're trying to unlink.&nbsp;</div></li><li><div>                if ( ! current_user_can( 'edit_posts' ) ) {&nbsp;</div></li><li><div>                    if ( isset( $_GET['redirect'] ) && 'sub-unlink' == $_GET['redirect'] ) {&nbsp;</div></li><li><div>                        // We need this in order to unlink the user.&nbsp;</div></li><li><div>                        $this-&gt;admin_page_load();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ( ! wp_verify_nonce( 'jetpack-unlink' ) ) {&nbsp;</div></li><li><div>                        $caps = array( 'do_not_allow' );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! self::is_active() && ! current_user_can( 'jetpack_connect' ) ) {&nbsp;</div></li><li><div>                    $caps = array( 'do_not_allow' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Pass through. If it's not development mode, these should match the admin page.&nbsp;</div></li><li><div>                 * Let users disconnect if it's development mode, just in case things glitch.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>            case 'jetpack_connect_user' :&nbsp;</div></li><li><div>                if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>                    $caps = array( 'do_not_allow' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $caps = array( 'read' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $caps;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function require_jetpack_authentication() {&nbsp;</div></li><li><div>        // Don't let anyone authenticate&nbsp;</div></li><li><div>        $_COOKIE = array();&nbsp;</div></li><li><div>        remove_all_filters( 'authenticate' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * For the moment, remove Limit Login Attempts if its xmlrpc for Jetpack.&nbsp;</div></li><li><div>         * If Limit Login Attempts is installed as a mu-plugin, it can occasionally&nbsp;</div></li><li><div>         * generate false-positives.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        remove_filter( 'wp_login_failed', 'limit_login_failed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>            // Allow Jetpack authentication&nbsp;</div></li><li><div>            add_filter( 'authenticate', array( $this, 'authenticate_jetpack' ), 10, 3 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load language files&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function plugin_textdomain() {&nbsp;</div></li><li><div>        // Note to self, the third argument must not be hardcoded, to account for relocated folders.&nbsp;</div></li><li><div>        load_plugin_textdomain( 'jetpack', false, dirname( plugin_basename( JETPACK__PLUGIN_FILE ) ) . '/languages/' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register assets for use in various modules and the Jetpack admin page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses wp_script_is, wp_register_script, plugins_url&nbsp;</div></li><li><div>     * @action wp_loaded&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_assets() {&nbsp;</div></li><li><div>        if ( ! wp_script_is( 'spin', 'registered' ) ) {&nbsp;</div></li><li><div>            wp_register_script( 'spin', plugins_url( '_inc/spin.js', JETPACK__PLUGIN_FILE ), false, '1.3' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_script_is( 'jquery.spin', 'registered' ) ) {&nbsp;</div></li><li><div>            wp_register_script( 'jquery.spin', plugins_url( '_inc/jquery.spin.js', JETPACK__PLUGIN_FILE ) , array( 'jquery', 'spin' ), '1.3' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_script_is( 'jetpack-gallery-settings', 'registered' ) ) {&nbsp;</div></li><li><div>            wp_register_script( 'jetpack-gallery-settings', plugins_url( '_inc/gallery-settings.js', JETPACK__PLUGIN_FILE ), array( 'media-views' ), '20121225' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * As jetpack_register_genericons is by default fired off a hook, &nbsp;</div></li><li><div>         * the hook may have already fired by this point.&nbsp;</div></li><li><div>         * So, let's just trigger it manually.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        require_once( JETPACK__PLUGIN_DIR . '_inc/genericons.php' );&nbsp;</div></li><li><div>        jetpack_register_genericons();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_style_is( 'jetpack-icons', 'registered' ) )&nbsp;</div></li><li><div>            wp_register_style( 'jetpack-icons', plugins_url( 'css/jetpack-icons.min.css', JETPACK__PLUGIN_FILE ), false, JETPACK__VERSION );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Device Pixels support&nbsp;</div></li><li><div>     * This improves the resolution of gravatars and wordpress.com uploads on hi-res and zoomed browsers.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function devicepx() {&nbsp;</div></li><li><div>        if ( Jetpack::is_active() ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'devicepx', set_url_scheme( 'http://s0.wp.com/wp-content/js/devicepx-jetpack.js' ), array(), gmdate( 'oW' ), true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the location of Jetpack's lib directory. This filter is applied&nbsp;</div></li><li><div>     * in require_lib().&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @filter require_lib_dir&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function require_lib_dir() {&nbsp;</div></li><li><div>        return JETPACK__PLUGIN_DIR . '_inc/lib';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return the network_site_url so that .com knows what network this site is a part of.&nbsp;</div></li><li><div>     * @param  bool $option&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function jetpack_main_network_site_option( $option ) {&nbsp;</div></li><li><div>        return network_site_url();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Network Name.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_name( $option = null ) {&nbsp;</div></li><li><div>        global $current_site;&nbsp;</div></li><li><div>        return $current_site-&gt;site_name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Does the network allow new user and site registrations.&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_allow_new_registrations( $option = null ) {&nbsp;</div></li><li><div>        return ( in_array( get_site_option( 'registration' ), array('none', 'user', 'blog', 'all' ) ) ? get_site_option( 'registration') : 'none' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Does the network allow admins to add new users.&nbsp;</div></li><li><div>     * @return boolian&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_add_new_users( $option = null ) {&nbsp;</div></li><li><div>        return (bool) get_site_option( 'add_new_users' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * File upload psace left per site in MB.&nbsp;</div></li><li><div>     *  -1 means NO LIMIT.&nbsp;</div></li><li><div>     * @return number&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_site_upload_space( $option = null ) {&nbsp;</div></li><li><div>        // value in MB&nbsp;</div></li><li><div>        return ( get_site_option( 'upload_space_check_disabled' ) ? -1 : get_space_allowed() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Network allowed file types.&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_upload_file_types( $option = null ) {&nbsp;</div></li><li><div>        return get_site_option( 'upload_filetypes', 'jpg jpeg png gif' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Maximum file upload size set by the network.&nbsp;</div></li><li><div>     * @return number&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_max_upload_file_size( $option = null ) {&nbsp;</div></li><li><div>        // value in KB&nbsp;</div></li><li><div>        return get_site_option( 'fileupload_maxk', 300 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Lets us know if a site allows admins to manage the network.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function network_enable_administration_menus( $option = null ) {&nbsp;</div></li><li><div>        return get_site_option( 'menu_items' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return whether we are dealing with a multi network setup or not.&nbsp;</div></li><li><div>     * The reason we are type casting this is because we want to avoid the situation where&nbsp;</div></li><li><div>     * the result is false since when is_main_network_option return false it cases&nbsp;</div></li><li><div>     * the rest the get_option( 'jetpack_is_multi_network' ); to return the value that is set in the&nbsp;</div></li><li><div>     * database which could be set to anything as opposed to what this function returns.&nbsp;</div></li><li><div>     * @param  bool  $option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_main_network_option( $option ) {&nbsp;</div></li><li><div>        // return '1' or ''&nbsp;</div></li><li><div>        return (string) (bool) Jetpack::is_multi_network();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return true if we are with multi-site or multi-network false if we are dealing with single site.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string  $option&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_multisite( $option ) {&nbsp;</div></li><li><div>        return (string) (bool) is_multisite();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Implemented since there is no core is multi network function&nbsp;</div></li><li><div>     * Right now there is no way to tell if we which network is the dominant network on the system&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.3&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_multi_network() {&nbsp;</div></li><li><div>        global  $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if we don't have a multi site setup no need to do any more&nbsp;</div></li><li><div>        if ( ! is_multisite() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $num_sites = $wpdb-&gt;get_var( &quot;SELECT COUNT(*) FROM {$wpdb-&gt;site}&quot; );&nbsp;</div></li><li><div>        if ( $num_sites &gt; 1 ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Trigger an update to the main_network_site when we update the siteurl of a site.&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function update_jetpack_main_network_site_option() {&nbsp;</div></li><li><div>        // do_action( 'add_option_$option', '$option', '$value-of-the-option' );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when the site URL is updated.&nbsp;</div></li><li><div>         * Determines if the site is the main site of a Mulitiste network.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string jetpack_main_network_site.&nbsp;</div></li><li><div>         * @param string network_site_url() Site URL for the &quot;main&quot; site of the current Multisite network.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_main_network_site', 'jetpack_main_network_site', network_site_url() );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when the site URL is updated.&nbsp;</div></li><li><div>         * Determines if the is part of a multi network.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string jetpack_is_main_network.&nbsp;</div></li><li><div>         * @param bool Jetpack::is_multi_network() Is the site part of a multi network.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_is_main_network', 'jetpack_is_main_network', (string) (bool) Jetpack::is_multi_network() );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when the site URL is updated.&nbsp;</div></li><li><div>         * Determines if the site is part of a multisite network.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.4.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string jetpack_is_multi_site.&nbsp;</div></li><li><div>         * @param bool is_multisite() Is the site part of a mutlisite network.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_is_multi_site', 'jetpack_is_multi_site', (string) (bool) is_multisite() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Triggered after a user updates the network settings via Network Settings Admin Page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function update_jetpack_network_settings() {&nbsp;</div></li><li><div>        // Only sync this info for the main network site.&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_name', 'jetpack_network_name', Jetpack::network_name() );&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_allow_new_registrations', 'jetpack_network_allow_new_registrations', Jetpack::network_allow_new_registrations() );&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_add_new_users', 'jetpack_network_add_new_users', Jetpack::network_add_new_users() );&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_site_upload_space', 'jetpack_network_site_upload_space', Jetpack::network_site_upload_space() );&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_upload_file_types', 'jetpack_network_upload_file_types', Jetpack::network_upload_file_types() );&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_network_enable_administration_menus', 'jetpack_network_enable_administration_menus', Jetpack::network_enable_administration_menus() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get back if the current site is single user site.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_single_user_site() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_query = new WP_User_Query( array(&nbsp;</div></li><li><div>            'blog_id' =&gt; get_current_blog_id(), &nbsp;</div></li><li><div>            'fields' =&gt; 'ID', &nbsp;</div></li><li><div>            'number' =&gt; 2&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        return 1 === (int) $user_query-&gt;get_total();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns true if the site has file write access false otherwise.&nbsp;</div></li><li><div>     * @return string ( '1' | '0' )&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public static function file_system_write_access() {&nbsp;</div></li><li><div>        if ( ! function_exists( 'get_filesystem_method' ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/file.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once( ABSPATH . 'wp-admin/includes/template.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filesystem_method = get_filesystem_method();&nbsp;</div></li><li><div>        if ( $filesystem_method === 'direct' ) {&nbsp;</div></li><li><div>            return 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        $filesystem_credentials_are_stored = request_filesystem_credentials( self_admin_url() );&nbsp;</div></li><li><div>        ob_end_clean();&nbsp;</div></li><li><div>        if ( $filesystem_credentials_are_stored ) {&nbsp;</div></li><li><div>            return 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Finds out if a site is using a version control system.&nbsp;</div></li><li><div>     * @return string ( '1' | '0' )&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public static function is_version_controlled() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !class_exists( 'WP_Automatic_Updater' ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $updater = new WP_Automatic_Updater();&nbsp;</div></li><li><div>        $is_version_controlled = strval( $updater-&gt;is_vcs_checkout( $context = ABSPATH ) );&nbsp;</div></li><li><div>        // transients should not be empty&nbsp;</div></li><li><div>        if ( empty( $is_version_controlled ) ) {&nbsp;</div></li><li><div>            $is_version_controlled = '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $is_version_controlled;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sync back wp_version&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_wp_version() {&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        return $wp_version;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Keeps wp_version in sync with .com when WordPress core updates&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public static function update_get_wp_version( $update, $meta_data ) {&nbsp;</div></li><li><div>        if ( 'update' === $meta_data['action'] && 'core' === $meta_data['type'] ) {&nbsp;</div></li><li><div>            /** This action is documented in wp-includes/option.php */&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * This triggers the sync for the jetpack version&nbsp;</div></li><li><div>             * See Jetpack_Sync options method for more info.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'add_option_jetpack_wp_version', 'jetpack_wp_version', (string) Jetpack::get_wp_version() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Triggers a sync of update counts and update details&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function sync_update_data() {&nbsp;</div></li><li><div>        // Anytime WordPress saves update data, we'll want to sync update data&nbsp;</div></li><li><div>        add_action( 'set_site_transient_update_plugins', array( 'Jetpack', 'refresh_update_data' ) );&nbsp;</div></li><li><div>        add_action( 'set_site_transient_update_themes', array( 'Jetpack', 'refresh_update_data' ) );&nbsp;</div></li><li><div>        add_action( 'set_site_transient_update_core', array( 'Jetpack', 'refresh_update_data' ) );&nbsp;</div></li><li><div>        // Anytime a connection to jetpack is made, sync the update data&nbsp;</div></li><li><div>        add_action( 'jetpack_site_registered', array( 'Jetpack', 'refresh_update_data' ) );&nbsp;</div></li><li><div>        // Anytime the Jetpack Version changes, sync the the update data&nbsp;</div></li><li><div>        add_action( 'updating_jetpack_version', array( 'Jetpack', 'refresh_update_data' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( current_user_can( 'update_core' ) && current_user_can( 'update_plugins' ) && current_user_can( 'update_themes' ) ) {&nbsp;</div></li><li><div>            $this-&gt;sync-&gt;mock_option( 'updates', array( 'Jetpack', 'get_updates' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;mock_option( 'update_details', array( 'Jetpack', 'get_update_details' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * jetpack_updates is saved in the following schema:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * array (&nbsp;</div></li><li><div>     *      'plugins' =&gt; (int) Number of plugin updates available.&nbsp;</div></li><li><div>     *      'themes' =&gt; (int) Number of theme updates available.&nbsp;</div></li><li><div>     *      'wordpress' =&gt; (int) Number of WordPress core updates available.&nbsp;</div></li><li><div>     *      'translations' =&gt; (int) Number of translation updates available.&nbsp;</div></li><li><div>     *      'total' =&gt; (int) Total of all available updates.&nbsp;</div></li><li><div>     *      'wp_update_version' =&gt; (string) The latest available version of WordPress, only present if a WordPress update is needed.&nbsp;</div></li><li><div>     * )&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_updates() {&nbsp;</div></li><li><div>        $update_data = wp_get_update_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stores the individual update counts as well as the total count.&nbsp;</div></li><li><div>        if ( isset( $update_data['counts'] ) ) {&nbsp;</div></li><li><div>            $updates = $update_data['counts'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we need to update WordPress core, let's find the latest version number.&nbsp;</div></li><li><div>        if ( ! empty( $updates['wordpress'] ) ) {&nbsp;</div></li><li><div>            $cur = get_preferred_from_update_core();&nbsp;</div></li><li><div>            if ( isset( $cur-&gt;response ) && 'upgrade' === $cur-&gt;response ) {&nbsp;</div></li><li><div>                $updates['wp_update_version'] = $cur-&gt;current;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return isset( $updates ) ? $updates : array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_update_details() {&nbsp;</div></li><li><div>        $update_details = array(&nbsp;</div></li><li><div>            'update_core' =&gt; get_site_transient( 'update_core' ), &nbsp;</div></li><li><div>            'update_plugins' =&gt; get_site_transient( 'update_plugins' ), &nbsp;</div></li><li><div>            'update_themes' =&gt; get_site_transient( 'update_themes' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return $update_details;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function refresh_update_data() {&nbsp;</div></li><li><div>        if ( current_user_can( 'update_core' ) && current_user_can( 'update_plugins' ) && current_user_can( 'update_themes' ) ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires whenever the amount of updates needed for a site changes.&nbsp;</div></li><li><div>             * Syncs an array that includes the number of theme, plugin, and core updates available, as well as the latest core version available.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 3.7.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string jetpack_updates&nbsp;</div></li><li><div>             * @param array Update counts calculated by Jetpack::get_updates&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'add_option_jetpack_updates', 'jetpack_updates', Jetpack::get_updates() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires whenever the amount of updates needed for a site changes.&nbsp;</div></li><li><div>         * Syncs an array of core, theme, and plugin data, and which of each is out of date&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.7.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string jetpack_update_details&nbsp;</div></li><li><div>         * @param array Update details calculated by Jetpack::get_update_details&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'add_option_jetpack_update_details', 'jetpack_update_details', Jetpack::get_update_details() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Invalides the transient as well as triggers the update of the mock option.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function is_single_user_site_invalidate() {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when a user is added or removed from a site.&nbsp;</div></li><li><div>         * Determines if the site is a single user site.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.4.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string jetpack_single_user_site.&nbsp;</div></li><li><div>         * @param bool Jetpack::is_single_user_site() Is the current site a single user site.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'update_option_jetpack_single_user_site', 'jetpack_single_user_site', (bool) Jetpack::is_single_user_site() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is Jetpack active?&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_active() {&nbsp;</div></li><li><div>        return (bool) Jetpack_Data::get_access_token( JETPACK_MASTER_USER );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is Jetpack in development (offline) mode?&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_development_mode() {&nbsp;</div></li><li><div>        $development_mode = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( defined( 'JETPACK_DEV_DEBUG' ) ) {&nbsp;</div></li><li><div>            $development_mode = JETPACK_DEV_DEBUG;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        elseif ( site_url() && false === strpos( site_url(), '.' ) ) {&nbsp;</div></li><li><div>            $development_mode = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters Jetpack's development mode.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @see http://jetpack.me/support/development-mode/&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.2.1&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $development_mode Is Jetpack's development mode active.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_development_mode', $development_mode );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Get Jetpack development mode notice text and notice class.&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * Mirrors the checks made in Jetpack::is_development_mode&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    public static function show_development_mode_notice() {&nbsp;</div></li><li><div>        if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            if ( defined( 'JETPACK_DEV_DEBUG' ) && JETPACK_DEV_DEBUG ) {&nbsp;</div></li><li><div>                $notice = sprintf(&nbsp;</div></li><li><div>                    /** translators: %s is a URL */&nbsp;</div></li><li><div>                    __( 'In &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Development Mode&lt;/a&gt;, via the JETPACK_DEV_DEBUG constant being defined in wp-config.php or elsewhere.', 'jetpack' ), &nbsp;</div></li><li><div>                    'http://jetpack.me/support/development-mode/'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            } elseif ( site_url() && false === strpos( site_url(), '.' ) ) {&nbsp;</div></li><li><div>                $notice = sprintf(&nbsp;</div></li><li><div>                    /** translators: %s is a URL */&nbsp;</div></li><li><div>                    __( 'In &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Development Mode&lt;/a&gt;, via site URL lacking a dot (e.g. http://localhost).', 'jetpack' ), &nbsp;</div></li><li><div>                    'http://jetpack.me/support/development-mode/'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $notice = sprintf(&nbsp;</div></li><li><div>                    /** translators: %s is a URL */&nbsp;</div></li><li><div>                    __( 'In &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Development Mode&lt;/a&gt;, via the jetpack_development_mode filter.', 'jetpack' ), &nbsp;</div></li><li><div>                    'http://jetpack.me/support/development-mode/'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div class=&quot;updated&quot; style=&quot;border-color: #f0821e;&quot;&gt;&lt;p&gt;' . $notice . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Throw up a notice if using a development version and as for feedback.&nbsp;</div></li><li><div>        if ( Jetpack::is_development_version() ) {&nbsp;</div></li><li><div>            /** translators: %s is a URL */&nbsp;</div></li><li><div>            $notice = sprintf( __( 'You are currently running a development version of Jetpack. &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Submit your feedback&lt;/a&gt;', 'jetpack' ), 'https://jetpack.me/contact-support/beta-group/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;div class=&quot;updated&quot; style=&quot;border-color: #f0821e;&quot;&gt;&lt;p&gt;' . $notice . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether Jetpack's version maps to a public release, or a development version.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_development_version() {&nbsp;</div></li><li><div>        return ! preg_match( '/^\d+(\.\d+)+$/', JETPACK__VERSION );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is a given user (or the current user if none is specified) linked to a WordPress.com user?&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_user_connected( $user_id = false ) {&nbsp;</div></li><li><div>        $user_id = false === $user_id ? get_current_user_id() : absint( $user_id );&nbsp;</div></li><li><div>        if ( ! $user_id ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return (bool) Jetpack_Data::get_access_token( $user_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the wpcom user data of the current|specified connected user.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_connected_user_data( $user_id = null ) {&nbsp;</div></li><li><div>        if ( ! $user_id ) {&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $xml = new Jetpack_IXR_Client( array(&nbsp;</div></li><li><div>            'user_id' =&gt; $user_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        $xml-&gt;query( 'wpcom.getUser' );&nbsp;</div></li><li><div>        if ( ! $xml-&gt;isError() ) {&nbsp;</div></li><li><div>            return $xml-&gt;getResponse();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the wpcom email of the current|specified connected user.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_connected_user_email( $user_id = null ) {&nbsp;</div></li><li><div>        if ( ! $user_id ) {&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $xml = new Jetpack_IXR_Client( array(&nbsp;</div></li><li><div>            'user_id' =&gt; $user_id, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        $xml-&gt;query( 'wpcom.getUserEmail' );&nbsp;</div></li><li><div>        if ( ! $xml-&gt;isError() ) {&nbsp;</div></li><li><div>            return $xml-&gt;getResponse();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the wpcom email of the master user.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_master_user_email() {&nbsp;</div></li><li><div>        $master_user_id = Jetpack_Options::get_option( 'master_user' );&nbsp;</div></li><li><div>        if ( $master_user_id ) {&nbsp;</div></li><li><div>            return self::get_connected_user_email( $master_user_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function current_user_is_connection_owner() {&nbsp;</div></li><li><div>        $user_token = Jetpack_Data::get_access_token( JETPACK_MASTER_USER );&nbsp;</div></li><li><div>        return $user_token && is_object( $user_token ) && isset( $user_token-&gt;external_user_id ) && get_current_user_id() === $user_token-&gt;external_user_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add any extra oEmbed providers that we know about and use on wpcom for feature parity.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function extra_oembed_providers() {&nbsp;</div></li><li><div>        // Cloudup: https://dev.cloudup.com/#oembed&nbsp;</div></li><li><div>        wp_oembed_add_provider( 'https://cloudup.com/*' , 'https://cloudup.com/oembed' );&nbsp;</div></li><li><div>        wp_oembed_add_provider( 'https://me.sh/*', 'https://me.sh/oembed?format=json' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Synchronize connected user role changes&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function user_role_change( $user_id ) {&nbsp;</div></li><li><div>        if ( Jetpack::is_active() && Jetpack::is_user_connected( $user_id ) ) {&nbsp;</div></li><li><div>            $current_user_id = get_current_user_id();&nbsp;</div></li><li><div>            wp_set_current_user( $user_id );&nbsp;</div></li><li><div>            $role = $this-&gt;translate_current_user_to_role();&nbsp;</div></li><li><div>            $signed_role = $this-&gt;sign_role( $role );&nbsp;</div></li><li><div>            wp_set_current_user( $current_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $master_token = Jetpack_Data::get_access_token( JETPACK_MASTER_USER );&nbsp;</div></li><li><div>            $master_user_id = absint( $master_token-&gt;external_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $master_user_id )&nbsp;</div></li><li><div>                return; // this shouldn't happen&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Jetpack::xmlrpc_async_call( 'jetpack.updateRole', $user_id, $signed_role );&nbsp;</div></li><li><div>            //@todo retry on failure&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //try to choose a new master if we're demoting the current one&nbsp;</div></li><li><div>            if ( $user_id == $master_user_id && 'administrator' != $role ) {&nbsp;</div></li><li><div>                $query = new WP_User_Query(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'fields' =&gt; array( 'id' ), &nbsp;</div></li><li><div>                        'role' =&gt; 'administrator', &nbsp;</div></li><li><div>                        'orderby' =&gt; 'id', &nbsp;</div></li><li><div>                        'exclude' =&gt; array( $master_user_id ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $new_master = false;&nbsp;</div></li><li><div>                foreach ( $query-&gt;results as $result ) {&nbsp;</div></li><li><div>                    $uid = absint( $result-&gt;id );&nbsp;</div></li><li><div>                    if ( $uid && Jetpack::is_user_connected( $uid ) ) {&nbsp;</div></li><li><div>                        $new_master = $uid;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $new_master ) {&nbsp;</div></li><li><div>                    Jetpack_Options::update_option( 'master_user', $new_master );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // else disconnect..?&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads the currently active modules.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_modules() {&nbsp;</div></li><li><div>        if ( ! self::is_active() && !self::is_development_mode() ) {&nbsp;</div></li><li><div>            if ( ! is_multisite() || ! get_site_option( 'jetpack_protect_active' ) ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version = Jetpack_Options::get_option( 'version' );&nbsp;</div></li><li><div>        if ( ! $version ) {&nbsp;</div></li><li><div>            $version = $old_version = JETPACK__VERSION . ':' . time();&nbsp;</div></li><li><div>            /** This action is documented in class.jetpack.php */&nbsp;</div></li><li><div>            do_action( 'updating_jetpack_version', $version, false );&nbsp;</div></li><li><div>            Jetpack_Options::update_options( compact( 'version', 'old_version' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        list( $version ) = explode( ':', $version );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modules = array_filter( Jetpack::get_active_modules(), array( 'Jetpack', 'is_module' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modules_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Don't load modules that have had &quot;Major&quot; changes since the stored version until they have been deactivated/reactivated through the lint check.&nbsp;</div></li><li><div>        if ( version_compare( $version, JETPACK__VERSION, '&lt;' ) ) {&nbsp;</div></li><li><div>            $updated_modules = array();&nbsp;</div></li><li><div>            foreach ( $modules as $module ) {&nbsp;</div></li><li><div>                $modules_data[ $module ] = Jetpack::get_module( $module );&nbsp;</div></li><li><div>                if ( ! isset( $modules_data[ $module ]['changed'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( version_compare( $modules_data[ $module ]['changed'], $version, '&lt;=' ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $updated_modules[] = $module;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $modules = array_diff( $modules, $updated_modules );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_development_mode = Jetpack::is_development_mode();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $modules as $module ) {&nbsp;</div></li><li><div>            // If we're in dev mode, disable modules requiring a connection&nbsp;</div></li><li><div>            if ( $is_development_mode ) {&nbsp;</div></li><li><div>                // Prime the pump if we need to&nbsp;</div></li><li><div>                if ( empty( $modules_data[ $module ] ) ) {&nbsp;</div></li><li><div>                    $modules_data[ $module ] = Jetpack::get_module( $module );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // If the module requires a connection, but we're in local mode, don't include it.&nbsp;</div></li><li><div>                if ( $modules_data[ $module ]['requires_connection'] ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( did_action( 'jetpack_module_loaded_' . $module ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            require Jetpack::get_module_path( $module );&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires when a specific module is loaded.&nbsp;</div></li><li><div>             * The dynamic part of the hook, $module, is the module slug.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.1.0&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'jetpack_module_loaded_' . $module );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when all the modules are loaded.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.1.0&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_modules_loaded' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load module-specific code that is needed even when a module isn't active. Loaded here because code contained therein may need actions such as setup_theme.&nbsp;</div></li><li><div>        if ( Jetpack::is_active() || Jetpack::is_development_mode() )&nbsp;</div></li><li><div>            require_once( JETPACK__PLUGIN_DIR . 'modules/module-extras.php' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if Jetpack's REST API compat file should be included&nbsp;</div></li><li><div>     * @action plugins_loaded&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_rest_api_compat() {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the list of REST API compat files to be included.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.2.5&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args Array of REST API compat files to include.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $_jetpack_rest_api_compat_includes = apply_filters( 'jetpack_rest_api_compat', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( function_exists( 'bbpress' ) )&nbsp;</div></li><li><div>            $_jetpack_rest_api_compat_includes[] = JETPACK__PLUGIN_DIR . 'class.jetpack-bbpress-json-api-compat.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $_jetpack_rest_api_compat_includes as $_jetpack_rest_api_compat_include )&nbsp;</div></li><li><div>            require_once $_jetpack_rest_api_compat_include;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Gets all plugins currently active in values, regardless of whether they're&nbsp;</div></li><li><div>     * traditionally activated or network activated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo Store the result in core's object cache maybe?&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_active_plugins() {&nbsp;</div></li><li><div>        $active_plugins = (array) get_option( 'active_plugins', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            // Due to legacy code, active_sitewide_plugins stores them in the keys, &nbsp;</div></li><li><div>            // whereas active_plugins stores them in the values.&nbsp;</div></li><li><div>            $network_plugins = array_keys( get_site_option( 'active_sitewide_plugins', array() ) );&nbsp;</div></li><li><div>            if ( $network_plugins ) {&nbsp;</div></li><li><div>                $active_plugins = array_merge( $active_plugins, $network_plugins );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        sort( $active_plugins );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_unique( $active_plugins );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks whether a specific plugin is active.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * We don't want to store these in a static variable, in case&nbsp;</div></li><li><div>     * there are switch_to_blog() calls involved.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_plugin_active( $plugin = 'jetpack/jetpack.php' ) {&nbsp;</div></li><li><div>        return in_array( $plugin, self::get_active_plugins() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if Jetpack's Open Graph tags should be used.&nbsp;</div></li><li><div>     * If certain plugins are active, Jetpack's og tags are suppressed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses Jetpack::get_active_modules, add_filter, get_option, apply_filters&nbsp;</div></li><li><div>     * @action plugins_loaded&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_open_graph() {&nbsp;</div></li><li><div>        if ( in_array( 'publicize', Jetpack::get_active_modules() ) || in_array( 'sharedaddy', Jetpack::get_active_modules() ) ) {&nbsp;</div></li><li><div>            add_filter( 'jetpack_enable_open_graph', '__return_true', 0 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_plugins = self::get_active_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $active_plugins ) ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;open_graph_conflicting_plugins as $plugin ) {&nbsp;</div></li><li><div>                if ( in_array( $plugin, $active_plugins ) ) {&nbsp;</div></li><li><div>                    add_filter( 'jetpack_enable_open_graph', '__return_false', 99 );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow the addition of Open Graph Meta Tags to all pages.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.0.3&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool false Should Open Graph Meta tags be added. Default to false.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( apply_filters( 'jetpack_enable_open_graph', false ) ) {&nbsp;</div></li><li><div>            require_once JETPACK__PLUGIN_DIR . 'functions.opengraph.php';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if Jetpack's Twitter tags should be used.&nbsp;</div></li><li><div>     * If certain plugins are active, Jetpack's twitter tags are suppressed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses Jetpack::get_active_modules, add_filter, get_option, apply_filters&nbsp;</div></li><li><div>     * @action plugins_loaded&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_twitter_tags() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_plugins = self::get_active_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $active_plugins ) ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;twitter_cards_conflicting_plugins as $plugin ) {&nbsp;</div></li><li><div>                if ( in_array( $plugin, $active_plugins ) ) {&nbsp;</div></li><li><div>                    add_filter( 'jetpack_disable_twitter_cards', '__return_true', 99 );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow Twitter Card Meta tags to be disabled.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.6.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool true Should Twitter Card Meta tags be disabled. Default to true.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( apply_filters( 'jetpack_disable_twitter_cards', true ) ) {&nbsp;</div></li><li><div>            require_once JETPACK__PLUGIN_DIR . 'class.jetpack-twitter-cards.php';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Jetpack Security Reports&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Allowed types: login_form, backup, file_scanning, spam&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Args for login_form and spam: 'blocked'=&gt;(int)(optional), 'status'=&gt;(string)(ok, warning, error), 'message'=&gt;(optional, disregarded if status is ok, allowed tags: a, em, strong)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Args for backup and file_scanning: 'last'=&gt;(timestamp)(optional), 'next'=&gt;(timestamp)(optional), 'status'=&gt;(string)(ok, warning, error), 'message'=&gt;(optional, disregarded if status is ok, allowed tags: a, em, strong)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Example code to submit a security report:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *  function akismet_submit_jetpack_security_report() {&nbsp;</div></li><li><div>     *      Jetpack::submit_security_report( 'spam', __FILE__, $args = array( 'blocked' =&gt; 138284, status =&gt; 'ok' ) );&nbsp;</div></li><li><div>     *  }&nbsp;</div></li><li><div>     *  add_action( 'jetpack_security_report', 'akismet_submit_jetpack_security_report' );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Calls for security report submissions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function perform_security_reporting() {&nbsp;</div></li><li><div>        $no_check_needed = get_site_transient( 'security_report_performed_recently' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $no_check_needed ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires before a security report is created.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.4.0&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_security_report' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'security_report', self::$security_report );&nbsp;</div></li><li><div>        set_site_transient( 'security_report_performed_recently', 1, 15 * MINUTE_IN_SECONDS );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Allows plugins to submit security reports.&nbsp;</div></li><li><div>      *&nbsp;</div></li><li><div>     * @param string  $type         Report type (login_form, backup, file_scanning, spam)&nbsp;</div></li><li><div>     * @param string  $plugin_file  Plugin __FILE__, so that we can pull plugin data&nbsp;</div></li><li><div>     * @param array   $args         See definitions above&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function submit_security_report( $type = '', $plugin_file = '', $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( !doing_action( 'jetpack_security_report' ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'not_collecting_report', 'Not currently collecting security reports.  Please use the jetpack_security_report hook.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( !is_string( $type ) || !is_string( $plugin_file ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'invalid_security_report', 'Invalid Security Report' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( !function_exists( 'get_plugin_data' ) ) {&nbsp;</div></li><li><div>            include( ABSPATH . 'wp-admin/includes/plugin.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Get rid of any non-allowed args&nbsp;</div></li><li><div>        $args = array_intersect_key( $args, array_flip( array( 'blocked', 'last', 'next', 'status', 'message' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugin = get_plugin_data( $plugin_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$plugin['Name'] ) {&nbsp;</div></li><li><div>            return new WP_Error( 'security_report_missing_plugin_name', 'Invalid Plugin File Provided' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sanitize everything to make sure we're not syncing something wonky&nbsp;</div></li><li><div>        $type = sanitize_key( $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['plugin'] = $plugin;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cast blocked, last and next as integers.&nbsp;</div></li><li><div>        // Last and next should be in unix timestamp format&nbsp;</div></li><li><div>        if ( isset( $args['blocked'] ) ) {&nbsp;</div></li><li><div>            $args['blocked'] = (int) $args['blocked'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $args['last'] ) ) {&nbsp;</div></li><li><div>            $args['last'] = (int) $args['last'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $args['next'] ) ) {&nbsp;</div></li><li><div>            $args['next'] = (int) $args['next'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( !in_array( $args['status'], array( 'ok', 'warning', 'error' ) ) ) {&nbsp;</div></li><li><div>            $args['status'] = 'ok';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $args['message'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( $args['status'] == 'ok' ) {&nbsp;</div></li><li><div>                unset( $args['message'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $allowed_html = array(&nbsp;</div></li><li><div>                'a' =&gt; array(&nbsp;</div></li><li><div>                    'href' =&gt; array(), &nbsp;</div></li><li><div>                    'title' =&gt; array()&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'em' =&gt; array(), &nbsp;</div></li><li><div>                'strong' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args['message'] = wp_kses( $args['message'], $allowed_html );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugin_name = $plugin[ 'Name' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::$security_report[ $type ][ $plugin_name ] = $args;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Collects a new report if needed, then returns it.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_security_report() {&nbsp;</div></li><li><div>        self::perform_security_reporting();&nbsp;</div></li><li><div>        return Jetpack_Options::get_option( 'security_report' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Jetpack Options API */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_option_names( $type = 'compact' ) {&nbsp;</div></li><li><div>        return Jetpack_Options::get_option_names( $type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the requested option.  Looks in jetpack_options or jetpack_$name as appropriate.&nbsp;</div></li><li><div>      *&nbsp;</div></li><li><div>     * @param string $name    Option name&nbsp;</div></li><li><div>     * @param mixed  $default (optional)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_option( $name, $default = false ) {&nbsp;</div></li><li><div>        return Jetpack_Options::get_option( $name, $default );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * Stores two secrets and a timestamp so WordPress.com can make a request back and verify an action&nbsp;</div></li><li><div>    * Does some extra verification so urls (such as those to public-api, register, etc) can't just be crafted&nbsp;</div></li><li><div>    * $name must be a registered option name.&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    public static function create_nonce( $name ) {&nbsp;</div></li><li><div>        $secret = wp_generate_password( 32, false ) . ':' . wp_generate_password( 32, false ) . ':' . ( time() + 600 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( $name, $secret );&nbsp;</div></li><li><div>        @list( $secret_1, $secret_2, $eol ) = explode( ':', Jetpack_Options::get_option( $name ) );&nbsp;</div></li><li><div>        if ( empty( $secret_1 ) || empty( $secret_2 ) || $eol &lt; time() )&nbsp;</div></li><li><div>            return new Jetpack_Error( 'missing_secrets' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'secret_1' =&gt; $secret_1, &nbsp;</div></li><li><div>            'secret_2' =&gt; $secret_2, &nbsp;</div></li><li><div>            'eol' =&gt; $eol, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates the single given option.  Updates jetpack_options or jetpack_$name as appropriate.&nbsp;</div></li><li><div>      *&nbsp;</div></li><li><div>     * @deprecated 3.4 use Jetpack_Options::update_option() instead.&nbsp;</div></li><li><div>     * @param string $name  Option name&nbsp;</div></li><li><div>     * @param mixed  $value Option value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_option( $name, $value ) {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, 'jetpack-3.4', 'Jetpack_Options::update_option()' );&nbsp;</div></li><li><div>        return Jetpack_Options::update_option( $name, $value );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates the multiple given options.  Updates jetpack_options and/or jetpack_$name as appropriate.&nbsp;</div></li><li><div>      *&nbsp;</div></li><li><div>     * @deprecated 3.4 use Jetpack_Options::update_options() instead.&nbsp;</div></li><li><div>     * @param array $array array( option name =&gt; option value, ... )&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_options( $array ) {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, 'jetpack-3.4', 'Jetpack_Options::update_options()' );&nbsp;</div></li><li><div>        return Jetpack_Options::update_options( $array );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Deletes the given option.  May be passed multiple option names as an array.&nbsp;</div></li><li><div>     * Updates jetpack_options and/or deletes jetpack_$name as appropriate.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @deprecated 3.4 use Jetpack_Options::delete_option() instead.&nbsp;</div></li><li><div>     * @param string|array $names&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function delete_option( $names ) {&nbsp;</div></li><li><div>        _deprecated_function( __METHOD__, 'jetpack-3.4', 'Jetpack_Options::delete_option()' );&nbsp;</div></li><li><div>        return Jetpack_Options::delete_option( $names );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Enters a user token into the user_tokens option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @param string $token&nbsp;</div></li><li><div>     * return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_user_token( $user_id, $token, $is_master_user ) {&nbsp;</div></li><li><div>        // not designed for concurrent updates&nbsp;</div></li><li><div>        $user_tokens = Jetpack_Options::get_option( 'user_tokens' );&nbsp;</div></li><li><div>        if ( ! is_array( $user_tokens ) )&nbsp;</div></li><li><div>            $user_tokens = array();&nbsp;</div></li><li><div>        $user_tokens[$user_id] = $token;&nbsp;</div></li><li><div>        if ( $is_master_user ) {&nbsp;</div></li><li><div>            $master_user = $user_id;&nbsp;</div></li><li><div>            $options = compact( 'user_tokens', 'master_user' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $options = compact( 'user_tokens' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return Jetpack_Options::update_options( $options );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of all PHP files in the specified absolute path.&nbsp;</div></li><li><div>     * Equivalent to glob( &quot;$absolute_path/**.php&quot; ).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $absolute_path The absolute path of the directory to search.&nbsp;</div></li><li><div>     * @return array Array of absolute paths to the PHP files.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function glob_php( $absolute_path ) {&nbsp;</div></li><li><div>        if ( function_exists( 'glob' ) ) {&nbsp;</div></li><li><div>            return glob( &quot;$absolute_path/*.php&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $absolute_path = untrailingslashit( $absolute_path );&nbsp;</div></li><li><div>        $files = array();&nbsp;</div></li><li><div>        if ( ! $dir = @opendir( $absolute_path ) ) {&nbsp;</div></li><li><div>            return $files;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        while ( false !== $file = readdir( $dir ) ) {&nbsp;</div></li><li><div>            if ( '.' == substr( $file, 0, 1 ) || '.php' != substr( $file, -4 ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $file = &quot;$absolute_path/$file&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_file( $file ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $files[] = $file;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        closedir( $dir );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $files;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function activate_new_modules( $redirect = false ) {&nbsp;</div></li><li><div>        if ( ! Jetpack::is_active() && ! Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_old_version = Jetpack_Options::get_option( 'version' ); // [sic]&nbsp;</div></li><li><div>        if ( ! $jetpack_old_version ) {&nbsp;</div></li><li><div>            $jetpack_old_version = $version = $old_version = '1.1:' . time();&nbsp;</div></li><li><div>            /** This action is documented in class.jetpack.php */&nbsp;</div></li><li><div>            do_action( 'updating_jetpack_version', $version, false );&nbsp;</div></li><li><div>            Jetpack_Options::update_options( compact( 'version', 'old_version' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list( $jetpack_version ) = explode( ':', $jetpack_old_version ); // [sic]&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( version_compare( JETPACK__VERSION, $jetpack_version, '&lt;=' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_modules = Jetpack::get_active_modules();&nbsp;</div></li><li><div>        $reactivate_modules = array();&nbsp;</div></li><li><div>        foreach ( $active_modules as $active_module ) {&nbsp;</div></li><li><div>            $module = Jetpack::get_module( $active_module );&nbsp;</div></li><li><div>            if ( ! isset( $module['changed'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( version_compare( $module['changed'], $jetpack_version, '&lt;=' ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $reactivate_modules[] = $active_module;&nbsp;</div></li><li><div>            Jetpack::deactivate_module( $active_module );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_version = JETPACK__VERSION . ':' . time();&nbsp;</div></li><li><div>        /** This action is documented in class.jetpack.php */&nbsp;</div></li><li><div>        do_action( 'updating_jetpack_version', $new_version, $jetpack_old_version );&nbsp;</div></li><li><div>        Jetpack_Options::update_options(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'version' =&gt; $new_version, &nbsp;</div></li><li><div>                'old_version' =&gt; $jetpack_old_version, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::state( 'message', 'modules_activated' );&nbsp;</div></li><li><div>        Jetpack::activate_default_modules( $jetpack_version, JETPACK__VERSION, $reactivate_modules );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $redirect ) {&nbsp;</div></li><li><div>            $page = 'jetpack'; // make sure we redirect to either settings or the jetpack page&nbsp;</div></li><li><div>            if ( isset( $_GET['page'] ) && in_array( $_GET['page'], array( 'jetpack', 'jetpack_modules' ) ) ) {&nbsp;</div></li><li><div>                $page = $_GET['page'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_safe_redirect( Jetpack::admin_url( 'page=' . $page ) );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * List available Jetpack modules. Simply lists .php files in /modules/.&nbsp;</div></li><li><div>     * Make sure to tuck away module &quot;library&quot; files in a sub-directory.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_available_modules( $min_version = false, $max_version = false ) {&nbsp;</div></li><li><div>        static $modules = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $modules ) ) {&nbsp;</div></li><li><div>            $available_modules_option = Jetpack_Options::get_option( 'available_modules', array() );&nbsp;</div></li><li><div>            // Use the cache if we're on the front-end and it's available...&nbsp;</div></li><li><div>            if ( ! is_admin() && ! empty( $available_modules_option[ JETPACK__VERSION ] ) ) {&nbsp;</div></li><li><div>                $modules = $available_modules_option[ JETPACK__VERSION ];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $files = Jetpack::glob_php( JETPACK__PLUGIN_DIR . 'modules' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $modules = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $files as $file ) {&nbsp;</div></li><li><div>                    if ( ! $headers = Jetpack::get_module( $file ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $modules[ Jetpack::get_module_slug( $file ) ] = $headers['introduced'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                Jetpack_Options::update_option( 'available_modules', array(&nbsp;</div></li><li><div>                    JETPACK__VERSION =&gt; $modules, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the array of modules available to be activated.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.4.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $modules Array of available modules.&nbsp;</div></li><li><div>         * @param string $min_version Minimum version number required to use modules.&nbsp;</div></li><li><div>         * @param string $max_version Maximum version number required to use modules.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $mods = apply_filters( 'jetpack_get_available_modules', $modules, $min_version, $max_version );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $min_version && ! $max_version ) {&nbsp;</div></li><li><div>            return array_keys( $mods );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = array();&nbsp;</div></li><li><div>        foreach ( $mods as $slug =&gt; $introduced ) {&nbsp;</div></li><li><div>            if ( $min_version && version_compare( $min_version, $introduced, '&gt;=' ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $max_version && version_compare( $max_version, $introduced, '&lt;' ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $r[] = $slug;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $r;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Default modules loaded on activation.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_default_modules( $min_version = false, $max_version = false ) {&nbsp;</div></li><li><div>        $return = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( Jetpack::get_available_modules( $min_version, $max_version ) as $module ) {&nbsp;</div></li><li><div>            $module_data = Jetpack::get_module( $module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( strtolower( $module_data['auto_activate'] ) ) {&nbsp;</div></li><li><div>                case 'yes' :&nbsp;</div></li><li><div>                    $return[] = $module;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'public' :&nbsp;</div></li><li><div>                    if ( Jetpack_Options::get_option( 'public' ) ) {&nbsp;</div></li><li><div>                        $return[] = $module;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'no' :&nbsp;</div></li><li><div>                default :&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the array of default modules.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $return Array of default modules.&nbsp;</div></li><li><div>         * @param string $min_version Minimum version number required to use modules.&nbsp;</div></li><li><div>         * @param string $max_version Maximum version number required to use modules.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_get_default_modules', $return, $min_version, $max_version );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks activated modules during auto-activation to determine&nbsp;</div></li><li><div>     * if any of those modules are being deprecated.  If so, close&nbsp;</div></li><li><div>     * them out, and add any replacement modules.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Runs at priority 99 by default.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is run late, so that it can still activate a module if&nbsp;</div></li><li><div>     * the new module is a replacement for another that the user&nbsp;</div></li><li><div>     * currently has active, even if something at the normal priority&nbsp;</div></li><li><div>     * would kibosh everything.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @uses jetpack_get_default_modules filter&nbsp;</div></li><li><div>     * @param array $modules&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function handle_deprecated_modules( $modules ) {&nbsp;</div></li><li><div>        $deprecated_modules = array(&nbsp;</div></li><li><div>            'debug' =&gt; null, // Closed out and moved to ./class.jetpack-debugger.php&nbsp;</div></li><li><div>            'wpcc' =&gt; 'sso', // Closed out in 2.6 -- SSO provides the same functionality.&nbsp;</div></li><li><div>            'gplus-authorship' =&gt; null, // Closed out in 3.2 -- Google dropped support.&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Don't activate SSO if they never completed activating WPCC.&nbsp;</div></li><li><div>        if ( Jetpack::is_module_active( 'wpcc' ) ) {&nbsp;</div></li><li><div>            $wpcc_options = Jetpack_Options::get_option( 'wpcc_options' );&nbsp;</div></li><li><div>            if ( empty( $wpcc_options ) || empty( $wpcc_options['client_id'] ) || empty( $wpcc_options['client_id'] ) ) {&nbsp;</div></li><li><div>                $deprecated_modules['wpcc'] = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $deprecated_modules as $module =&gt; $replacement ) {&nbsp;</div></li><li><div>            if ( Jetpack::is_module_active( $module ) ) {&nbsp;</div></li><li><div>                self::deactivate_module( $module );&nbsp;</div></li><li><div>                if ( $replacement ) {&nbsp;</div></li><li><div>                    $modules[] = $replacement;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_unique( $modules );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks activated plugins during auto-activation to determine&nbsp;</div></li><li><div>     * if any of those plugins are in the list with a corresponding module&nbsp;</div></li><li><div>     * that is not compatible with the plugin. The module will not be allowed&nbsp;</div></li><li><div>     * to auto-activate.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @uses jetpack_get_default_modules filter&nbsp;</div></li><li><div>     * @param array $modules&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function filter_default_modules( $modules ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_plugins = self::get_active_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $active_plugins ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // For each module we'd like to auto-activate...&nbsp;</div></li><li><div>            foreach ( $modules as $key =&gt; $module ) {&nbsp;</div></li><li><div>                // If there are potential conflicts for it...&nbsp;</div></li><li><div>                if ( ! empty( $this-&gt;conflicting_plugins[ $module ] ) ) {&nbsp;</div></li><li><div>                    // For each potential conflict...&nbsp;</div></li><li><div>                    foreach ( $this-&gt;conflicting_plugins[ $module ] as $title =&gt; $plugin ) {&nbsp;</div></li><li><div>                        // If that conflicting plugin is active...&nbsp;</div></li><li><div>                        if ( in_array( $plugin, $active_plugins ) ) {&nbsp;</div></li><li><div>                            // Remove that item from being auto-activated.&nbsp;</div></li><li><div>                            unset( $modules[ $key ] );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $modules;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Extract a module's slug from its full path.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_module_slug( $file ) {&nbsp;</div></li><li><div>        return str_replace( '.php', '', basename( $file ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate a module's path from its slug.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_module_path( $slug ) {&nbsp;</div></li><li><div>        return JETPACK__PLUGIN_DIR . &quot;modules/$slug.php&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load module data from module file. Headers differ from WordPress&nbsp;</div></li><li><div>     * plugin headers to avoid them being identified as standalone&nbsp;</div></li><li><div>     * plugins on the WordPress plugins page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_module( $module ) {&nbsp;</div></li><li><div>        $headers = array(&nbsp;</div></li><li><div>            'name' =&gt; 'Module Name', &nbsp;</div></li><li><div>            'description' =&gt; 'Module Description', &nbsp;</div></li><li><div>            'jumpstart_desc' =&gt; 'Jumpstart Description', &nbsp;</div></li><li><div>            'sort' =&gt; 'Sort Order', &nbsp;</div></li><li><div>            'recommendation_order' =&gt; 'Recommendation Order', &nbsp;</div></li><li><div>            'introduced' =&gt; 'First Introduced', &nbsp;</div></li><li><div>            'changed' =&gt; 'Major Changes In', &nbsp;</div></li><li><div>            'deactivate' =&gt; 'Deactivate', &nbsp;</div></li><li><div>            'free' =&gt; 'Free', &nbsp;</div></li><li><div>            'requires_connection' =&gt; 'Requires Connection', &nbsp;</div></li><li><div>            'auto_activate' =&gt; 'Auto Activate', &nbsp;</div></li><li><div>            'module_tags' =&gt; 'Module Tags', &nbsp;</div></li><li><div>            'feature' =&gt; 'Feature', &nbsp;</div></li><li><div>            'additional_search_queries' =&gt; 'Additional Search Queries', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file = Jetpack::get_module_path( Jetpack::get_module_slug( $module ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $mod = Jetpack::get_file_data( $file, $headers );&nbsp;</div></li><li><div>        if ( empty( $mod['name'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $mod['jumpstart_desc'] = _x( $mod['jumpstart_desc'], 'Jumpstart Description', 'jetpack' );&nbsp;</div></li><li><div>        $mod['name'] = _x( $mod['name'], 'Module Name', 'jetpack' );&nbsp;</div></li><li><div>        $mod['description'] = _x( $mod['description'], 'Module Description', 'jetpack' );&nbsp;</div></li><li><div>        $mod['sort'] = empty( $mod['sort'] ) ? 10 : (int) $mod['sort'];&nbsp;</div></li><li><div>        $mod['recommendation_order'] = empty( $mod['recommendation_order'] ) ? 20 : (int) $mod['recommendation_order'];&nbsp;</div></li><li><div>        $mod['deactivate'] = empty( $mod['deactivate'] );&nbsp;</div></li><li><div>        $mod['free'] = empty( $mod['free'] );&nbsp;</div></li><li><div>        $mod['requires_connection'] = ( ! empty( $mod['requires_connection'] ) && 'No' == $mod['requires_connection'] ) ? false : true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $mod['auto_activate'] ) || ! in_array( strtolower( $mod['auto_activate'] ), array( 'yes', 'no', 'public' ) ) ) {&nbsp;</div></li><li><div>            $mod['auto_activate'] = 'No';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $mod['auto_activate'] = (string) $mod['auto_activate'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $mod['module_tags'] ) {&nbsp;</div></li><li><div>            $mod['module_tags'] = explode( ', ', $mod['module_tags'] );&nbsp;</div></li><li><div>            $mod['module_tags'] = array_map( 'trim', $mod['module_tags'] );&nbsp;</div></li><li><div>            $mod['module_tags'] = array_map( array( __CLASS__, 'translate_module_tag' ), $mod['module_tags'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $mod['module_tags'] = array( self::translate_module_tag( 'Other' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $mod['feature'] ) {&nbsp;</div></li><li><div>            $mod['feature'] = explode( ', ', $mod['feature'] );&nbsp;</div></li><li><div>            $mod['feature'] = array_map( 'trim', $mod['feature'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $mod['feature'] = array( self::translate_module_tag( 'Other' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the feature array on a module.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * This filter allows you to control where each module is filtered: Recommended, &nbsp;</div></li><li><div>         * Jumpstart, and the default &quot;Other&quot; listing.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array   $mod['feature'] The areas to feature this module:&nbsp;</div></li><li><div>         *     'Jumpstart' adds to the &quot;Jumpstart&quot; option to activate many modules at once.&nbsp;</div></li><li><div>         *     'Recommended' shows on the main Jetpack admin screen.&nbsp;</div></li><li><div>         *     'Other' should be the default if no other value is in the array.&nbsp;</div></li><li><div>         * @param string  $module The slug of the module, e.g. sharedaddy.&nbsp;</div></li><li><div>         * @param array   $mod All the currently assembled module data.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $mod['feature'] = apply_filters( 'jetpack_module_feature', $mod['feature'], $module, $mod );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the returned data about a module.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * This filter allows overriding any info about Jetpack modules. It is dangerous, &nbsp;</div></li><li><div>         * so please be careful.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.6.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array   $mod    The details of the requested module.&nbsp;</div></li><li><div>         * @param string  $module The slug of the module, e.g. sharedaddy&nbsp;</div></li><li><div>         * @param string  $file   The path to the module source file.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_get_module', $mod, $module, $file );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Like core's get_file_data implementation, but caches the result.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_file_data( $file, $headers ) {&nbsp;</div></li><li><div>        //Get just the filename from $file (i.e. exclude full path) so that a consistent hash is generated&nbsp;</div></li><li><div>        $file_name = basename( $file );&nbsp;</div></li><li><div>        $file_data_option = Jetpack_Options::get_option( 'file_data', array() );&nbsp;</div></li><li><div>        $key = md5( $file_name . serialize( $headers ) );&nbsp;</div></li><li><div>        $refresh_cache = is_admin() && isset( $_GET['page'] ) && 'jetpack' === substr( $_GET['page'], 0, 7 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we don't need to refresh the cache, and already have the value, short-circuit!&nbsp;</div></li><li><div>        if ( ! $refresh_cache && isset( $file_data_option[ JETPACK__VERSION ][ $key ] ) ) {&nbsp;</div></li><li><div>            return $file_data_option[ JETPACK__VERSION ][ $key ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = get_file_data( $file, $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Strip out any old Jetpack versions that are cluttering the option.&nbsp;</div></li><li><div>        $file_data_option = array_intersect_key( (array) $file_data_option, array( JETPACK__VERSION =&gt; null ) );&nbsp;</div></li><li><div>        $file_data_option[ JETPACK__VERSION ][ $key ] = $data;&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'file_data', $file_data_option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function translate_module_tag( $untranslated_tag ) {&nbsp;</div></li><li><div>        // Tags are aggregated by tools/build-module-headings-translations.php&nbsp;</div></li><li><div>        // and output in modules/module-headings.php&nbsp;</div></li><li><div>        return _x( $untranslated_tag, 'Module Tag', 'jetpack' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a list of activated modules as an array of module slugs.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_active_modules() {&nbsp;</div></li><li><div>        $active = Jetpack_Options::get_option( 'active_modules' );&nbsp;</div></li><li><div>        if ( ! is_array( $active ) )&nbsp;</div></li><li><div>            $active = array();&nbsp;</div></li><li><div>        if ( is_admin() && ( class_exists( 'VaultPress' ) || function_exists( 'vaultpress_contact_service' ) ) ) {&nbsp;</div></li><li><div>            $active[] = 'vaultpress';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $active = array_diff( $active, array( 'vaultpress' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //If protect is active on the main site of a multisite, it should be active on all sites.&nbsp;</div></li><li><div>        if ( ! in_array( 'protect', $active ) && is_multisite() && get_site_option( 'jetpack_protect_active' ) ) {&nbsp;</div></li><li><div>            $active[] = 'protect';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_unique( $active );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check whether or not a Jetpack module is active.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $module The slug of a Jetpack module.&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_module_active( $module ) {&nbsp;</div></li><li><div>        return in_array( $module, self::get_active_modules() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_module( $module ) {&nbsp;</div></li><li><div>        return ! empty( $module ) && ! validate_file( $module, Jetpack::get_available_modules() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Catches PHP errors.  Must be used in conjunction with output buffering.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $catch True to start catching, False to stop.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function catch_errors( $catch ) {&nbsp;</div></li><li><div>        static $display_errors, $error_reporting;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $catch ) {&nbsp;</div></li><li><div>            $display_errors = @ini_set( 'display_errors', 1 );&nbsp;</div></li><li><div>            $error_reporting = @error_reporting( E_ALL );&nbsp;</div></li><li><div>            add_action( 'shutdown', array( 'Jetpack', 'catch_errors_on_shutdown' ), 0 );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            @ini_set( 'display_errors', $display_errors );&nbsp;</div></li><li><div>            @error_reporting( $error_reporting );&nbsp;</div></li><li><div>            remove_action( 'shutdown', array( 'Jetpack', 'catch_errors_on_shutdown' ), 0 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Saves any generated PHP errors in ::state( 'php_errors', {errors} )&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function catch_errors_on_shutdown() {&nbsp;</div></li><li><div>        Jetpack::state( 'php_errors', ob_get_clean() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function activate_default_modules( $min_version = false, $max_version = false, $other_modules = array() ) {&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modules = Jetpack::get_default_modules( $min_version, $max_version );&nbsp;</div></li><li><div>        $modules = array_merge( $other_modules, $modules );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Look for standalone plugins and disable if active.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $to_deactivate = array();&nbsp;</div></li><li><div>        foreach ( $modules as $module ) {&nbsp;</div></li><li><div>            if ( isset( $jetpack-&gt;plugins_to_deactivate[$module] ) ) {&nbsp;</div></li><li><div>                $to_deactivate[$module] = $jetpack-&gt;plugins_to_deactivate[$module];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $deactivated = array();&nbsp;</div></li><li><div>        foreach ( $to_deactivate as $module =&gt; $deactivate_me ) {&nbsp;</div></li><li><div>            list( $probable_file, $probable_title ) = $deactivate_me;&nbsp;</div></li><li><div>            if ( Jetpack_Client_Server::deactivate_plugin( $probable_file, $probable_title ) ) {&nbsp;</div></li><li><div>                $deactivated[] = $module;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $deactivated ) {&nbsp;</div></li><li><div>            Jetpack::state( 'deactivated_plugins', join( ', ', $deactivated ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $url = add_query_arg(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'action' =&gt; 'activate_default_modules', &nbsp;</div></li><li><div>                    '_wpnonce' =&gt; wp_create_nonce( 'activate_default_modules' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                add_query_arg( compact( 'min_version', 'max_version', 'other_modules' ), Jetpack::admin_url( 'page=jetpack' ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            wp_safe_redirect( $url );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires before default modules are activated.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $min_version Minimum version number required to use modules.&nbsp;</div></li><li><div>         * @param string $max_version Maximum version number required to use modules.&nbsp;</div></li><li><div>         * @param array $other_modules Array of other modules to activate alongside the default modules.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_before_activate_default_modules', $min_version, $max_version, $other_modules );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check each module for fatal errors, a la wp-admin/plugins.php::activate before activating&nbsp;</div></li><li><div>        Jetpack::restate();&nbsp;</div></li><li><div>        Jetpack::catch_errors( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = Jetpack::get_active_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $modules as $module ) {&nbsp;</div></li><li><div>            if ( did_action( &quot;jetpack_module_loaded_$module&quot; ) ) {&nbsp;</div></li><li><div>                $active[] = $module;&nbsp;</div></li><li><div>                Jetpack_Options::update_option( 'active_modules', array_unique( $active ) );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( $module, $active ) ) {&nbsp;</div></li><li><div>                $module_info = Jetpack::get_module( $module );&nbsp;</div></li><li><div>                if ( ! $module_info['deactivate'] ) {&nbsp;</div></li><li><div>                    $state = in_array( $module, $other_modules ) ? 'reactivated_modules' : 'activated_modules';&nbsp;</div></li><li><div>                    if ( $active_state = Jetpack::state( $state ) ) {&nbsp;</div></li><li><div>                        $active_state = explode( ', ', $active_state );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $active_state = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $active_state[] = $module;&nbsp;</div></li><li><div>                    Jetpack::state( $state, implode( ', ', $active_state ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $file = Jetpack::get_module_path( $module );&nbsp;</div></li><li><div>            if ( ! file_exists( $file ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // we'll override this later if the plugin can be included without fatal error&nbsp;</div></li><li><div>            wp_safe_redirect( Jetpack::admin_url( 'page=jetpack' ) );&nbsp;</div></li><li><div>            Jetpack::state( 'error', 'module_activation_failed' );&nbsp;</div></li><li><div>            Jetpack::state( 'module', $module );&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            require $file;&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires when a specific module is activated.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.9.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string $module Module slug.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'jetpack_activate_module', $module );&nbsp;</div></li><li><div>            $active[] = $module;&nbsp;</div></li><li><div>            $state = in_array( $module, $other_modules ) ? 'reactivated_modules' : 'activated_modules';&nbsp;</div></li><li><div>            if ( $active_state = Jetpack::state( $state ) ) {&nbsp;</div></li><li><div>                $active_state = explode( ', ', $active_state );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $active_state = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $active_state[] = $module;&nbsp;</div></li><li><div>            Jetpack::state( $state, implode( ', ', $active_state ) );&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'active_modules', array_unique( $active ) );&nbsp;</div></li><li><div>            ob_end_clean();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        Jetpack::state( 'error', false );&nbsp;</div></li><li><div>        Jetpack::state( 'module', false );&nbsp;</div></li><li><div>        Jetpack::catch_errors( false );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when default modules are activated.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $min_version Minimum version number required to use modules.&nbsp;</div></li><li><div>         * @param string $max_version Maximum version number required to use modules.&nbsp;</div></li><li><div>         * @param array $other_modules Array of other modules to activate alongside the default modules.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_activate_default_modules', $min_version, $max_version, $other_modules );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function activate_module( $module, $exit = true, $redirect = true ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires before a module is activated.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.6.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $module Module slug.&nbsp;</div></li><li><div>         * @param bool $exit Should we exit after the module has been activated. Default to true.&nbsp;</div></li><li><div>         * @param bool $redirect Should the user be redirected after module activation? Default to true.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_pre_activate_module', $module, $exit, $redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! strlen( $module ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! Jetpack::is_module( $module ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If it's already active, then don't do it again&nbsp;</div></li><li><div>        $active = Jetpack::get_active_modules();&nbsp;</div></li><li><div>        foreach ( $active as $act ) {&nbsp;</div></li><li><div>            if ( $act == $module )&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $module_data = Jetpack::get_module( $module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! Jetpack::is_active() ) {&nbsp;</div></li><li><div>            if ( !Jetpack::is_development_mode() )&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If we're not connected but in development mode, make sure the module doesn't require a connection&nbsp;</div></li><li><div>            if ( Jetpack::is_development_mode() && $module_data['requires_connection'] )&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check and see if the old plugin is active&nbsp;</div></li><li><div>        if ( isset( $jetpack-&gt;plugins_to_deactivate[ $module ] ) ) {&nbsp;</div></li><li><div>            // Deactivate the old plugin&nbsp;</div></li><li><div>            if ( Jetpack_Client_Server::deactivate_plugin( $jetpack-&gt;plugins_to_deactivate[ $module ][0], $jetpack-&gt;plugins_to_deactivate[ $module ][1] ) ) {&nbsp;</div></li><li><div>                // If we deactivated the old plugin, remembere that with ::state() and redirect back to this page to activate the module&nbsp;</div></li><li><div>                // We can't activate the module on this page load since the newly deactivated old plugin is still loaded on this page load.&nbsp;</div></li><li><div>                Jetpack::state( 'deactivated_plugins', $module );&nbsp;</div></li><li><div>                wp_safe_redirect( add_query_arg( 'jetpack_restate', 1 ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check the file for fatal errors, a la wp-admin/plugins.php::activate&nbsp;</div></li><li><div>        Jetpack::state( 'module', $module );&nbsp;</div></li><li><div>        Jetpack::state( 'error', 'module_activation_failed' ); // we'll override this later if the plugin can be included without fatal error&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::catch_errors( true );&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        require Jetpack::get_module_path( $module );&nbsp;</div></li><li><div>        /** This action is documented in class.jetpack.php */&nbsp;</div></li><li><div>        do_action( 'jetpack_activate_module', $module );&nbsp;</div></li><li><div>        $active[] = $module;&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'active_modules', array_unique( $active ) );&nbsp;</div></li><li><div>        Jetpack::state( 'error', false ); // the override&nbsp;</div></li><li><div>        Jetpack::state( 'message', 'module_activated' );&nbsp;</div></li><li><div>        Jetpack::state( 'module', $module );&nbsp;</div></li><li><div>        ob_end_clean();&nbsp;</div></li><li><div>        Jetpack::catch_errors( false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // A flag for Jump Start so it's not shown again. Only set if it hasn't been yet.&nbsp;</div></li><li><div>        if ( 'new_connection' === Jetpack_Options::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'jumpstart', 'jetpack_action_taken' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Jump start is being dismissed send data to MC Stats&nbsp;</div></li><li><div>            $jetpack-&gt;stat( 'jumpstart', 'manual, '.$module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $jetpack-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $redirect ) {&nbsp;</div></li><li><div>            wp_safe_redirect( Jetpack::admin_url( 'page=jetpack' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $exit ) {&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function activate_module_actions( $module ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when a module is activated.&nbsp;</div></li><li><div>         * The dynamic part of the filter, $module, is the module slug.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $module Module slug.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( &quot;jetpack_activate_module_$module&quot;, $module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync-&gt;sync_all_module_options( $module );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function deactivate_module( $module ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when a module is deactivated.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $module Module slug.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_pre_deactivate_module', $module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = Jetpack::get_active_modules();&nbsp;</div></li><li><div>        $new = array_filter( array_diff( $active, (array) $module ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when a module is deactivated.&nbsp;</div></li><li><div>         * The dynamic part of the filter, $module, is the module slug.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $module Module slug.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( &quot;jetpack_deactivate_module_$module&quot;, $module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // A flag for Jump Start so it's not shown again.&nbsp;</div></li><li><div>        if ( 'new_connection' === Jetpack_Options::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'jumpstart', 'jetpack_action_taken' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Jump start is being dismissed send data to MC Stats&nbsp;</div></li><li><div>            $jetpack-&gt;stat( 'jumpstart', 'manual, deactivated-'.$module );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $jetpack-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return Jetpack_Options::update_option( 'active_modules', array_unique( $new ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function enable_module_configurable( $module ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        add_filter( 'jetpack_module_configurable_' . $module, '__return_true' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function module_configuration_url( $module ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        return Jetpack::admin_url( array( 'page' =&gt; 'jetpack', 'configure' =&gt; $module ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function module_configuration_load( $module, $method ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        add_action( 'jetpack_module_configuration_load_' . $module, $method );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function module_configuration_head( $module, $method ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        add_action( 'jetpack_module_configuration_head_' . $module, $method );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function module_configuration_screen( $module, $method ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        add_action( 'jetpack_module_configuration_screen_' . $module, $method );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function module_configuration_activation_screen( $module, $method ) {&nbsp;</div></li><li><div>        $module = Jetpack::get_module_slug( $module );&nbsp;</div></li><li><div>        add_action( 'display_activate_module_setting_' . $module, $method );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Installation */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function bail_on_activation( $message, $deactivate = true ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;!doctype html&gt;&nbsp;</div></li><li><div>&lt;html&gt;&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>&lt;meta charset=&quot;&lt;?php bloginfo( 'charset' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&lt;style&gt;&nbsp;</div></li><li><div>* {&nbsp;</div></li><li><div>    text-align: center;&nbsp;</div></li><li><div>    margin: 0;&nbsp;</div></li><li><div>    padding: 0;&nbsp;</div></li><li><div>    font-family: &quot;Lucida Grande&quot;, Verdana, Arial, &quot;Bitstream Vera Sans&quot;, sans-serif;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>p {&nbsp;</div></li><li><div>    margin-top: 1em;&nbsp;</div></li><li><div>    font-size: 18px;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&lt;/style&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>&lt;p&gt;&lt;?php echo esc_html( $message ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>        if ( $deactivate ) {&nbsp;</div></li><li><div>            $plugins = get_option( 'active_plugins' );&nbsp;</div></li><li><div>            $jetpack = plugin_basename( JETPACK__PLUGIN_DIR . 'jetpack.php' );&nbsp;</div></li><li><div>            $update = false;&nbsp;</div></li><li><div>            foreach ( $plugins as $i =&gt; $plugin ) {&nbsp;</div></li><li><div>                if ( $plugin === $jetpack ) {&nbsp;</div></li><li><div>                    $plugins[$i] = false;&nbsp;</div></li><li><div>                    $update = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $update ) {&nbsp;</div></li><li><div>                update_option( 'active_plugins', array_filter( $plugins ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Attached to activate_{ plugin_basename( __FILES__ ) } by register_activation_hook()&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function plugin_activation( $network_wide ) {&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'activated', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( version_compare( $GLOBALS['wp_version'], JETPACK__MINIMUM_WP_VERSION, '&lt;' ) ) {&nbsp;</div></li><li><div>            Jetpack::bail_on_activation( sprintf( __( 'Jetpack requires WordPress version %s or later.', 'jetpack' ), JETPACK__MINIMUM_WP_VERSION ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $network_wide )&nbsp;</div></li><li><div>            Jetpack::state( 'network_nag', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::plugin_initialize();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Runs before bumping version numbers up to a new version&nbsp;</div></li><li><div>     * @param  (string) $version    Version:timestamp&nbsp;</div></li><li><div>     * @param  (string) $old_version Old Version:timestamp or false if not set yet.&nbsp;</div></li><li><div>     * @return null              [description]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function do_version_bump( $version, $old_version ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $old_version ) { // For new sites&nbsp;</div></li><li><div>            // Setting up jetpack manage&nbsp;</div></li><li><div>            Jetpack::activate_manage();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets the internal version number and activation state.&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function plugin_initialize() {&nbsp;</div></li><li><div>        if ( ! Jetpack_Options::get_option( 'activated' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'activated', 2 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! Jetpack_Options::get_option( 'version' ) ) {&nbsp;</div></li><li><div>            $version = $old_version = JETPACK__VERSION . ':' . time();&nbsp;</div></li><li><div>            /** This action is documented in class.jetpack.php */&nbsp;</div></li><li><div>            do_action( 'updating_jetpack_version', $version, false );&nbsp;</div></li><li><div>            Jetpack_Options::update_options( compact( 'version', 'old_version' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::delete_option( 'do_activate' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Removes all connection options&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function plugin_deactivation( ) {&nbsp;</div></li><li><div>        require_once( ABSPATH . '/wp-admin/includes/plugin.php' );&nbsp;</div></li><li><div>        if( is_plugin_active_for_network( 'jetpack/jetpack.php' ) ) {&nbsp;</div></li><li><div>            Jetpack_Network::init()-&gt;deactivate();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            Jetpack::disconnect( false );&nbsp;</div></li><li><div>            //Jetpack_Heartbeat::init()-&gt;deactivate();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Disconnects from the Jetpack servers.&nbsp;</div></li><li><div>     * Forgets all connection details and tells the Jetpack servers to do the same.&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function disconnect( $update_activated_state = true ) {&nbsp;</div></li><li><div>        wp_clear_scheduled_hook( 'jetpack_clean_nonces' );&nbsp;</div></li><li><div>        Jetpack::clean_nonces( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $xml = new Jetpack_IXR_Client();&nbsp;</div></li><li><div>        $xml-&gt;query( 'jetpack.deregister' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::delete_option(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'register', &nbsp;</div></li><li><div>                'blog_token', &nbsp;</div></li><li><div>                'user_token', &nbsp;</div></li><li><div>                'user_tokens', &nbsp;</div></li><li><div>                'master_user', &nbsp;</div></li><li><div>                'time_diff', &nbsp;</div></li><li><div>                'fallback_no_verify_ssl_certs', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $update_activated_state ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'activated', 4 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_unique_connection = Jetpack_Options::get_option( 'unique_connection' );&nbsp;</div></li><li><div>        // Check then record unique disconnection if site has never been disconnected previously&nbsp;</div></li><li><div>        if ( -1 == $jetpack_unique_connection['disconnected'] ) {&nbsp;</div></li><li><div>            $jetpack_unique_connection['disconnected'] = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            if ( 0 == $jetpack_unique_connection['disconnected'] ) {&nbsp;</div></li><li><div>                //track unique disconnect&nbsp;</div></li><li><div>                $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $jetpack-&gt;stat( 'connections', 'unique-disconnect' );&nbsp;</div></li><li><div>                $jetpack-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // increment number of times disconnected&nbsp;</div></li><li><div>            $jetpack_unique_connection['disconnected'] += 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'unique_connection', $jetpack_unique_connection );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Disable the Heartbeat cron&nbsp;</div></li><li><div>        Jetpack_Heartbeat::init()-&gt;deactivate();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Unlinks the current user from the linked WordPress.com user&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function unlink_user( $user_id = null ) {&nbsp;</div></li><li><div>        if ( ! $tokens = Jetpack_Options::get_option( 'user_tokens' ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_id = empty( $user_id ) ? get_current_user_id() : intval( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack_Options::get_option( 'master_user' ) == $user_id )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $tokens[ $user_id ] ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $xml = new Jetpack_IXR_Client( compact( 'user_id' ) );&nbsp;</div></li><li><div>        $xml-&gt;query( 'jetpack.unlink_user', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $tokens[ $user_id ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'user_tokens', $tokens );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Attempts Jetpack registration.  If it fail, a state flag is set: @see ::admin_page_load()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function try_registration() {&nbsp;</div></li><li><div>        // Let's get some testing in beta versions and such.&nbsp;</div></li><li><div>        if ( self::is_development_version() && defined( 'PHP_URL_HOST' ) ) {&nbsp;</div></li><li><div>            // Before attempting to connect, let's make sure that the domains are viable.&nbsp;</div></li><li><div>            $domains_to_check = array_unique( array(&nbsp;</div></li><li><div>                'siteurl' =&gt; parse_url( get_site_url(), PHP_URL_HOST ), &nbsp;</div></li><li><div>                'homeurl' =&gt; parse_url( get_home_url(), PHP_URL_HOST ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            foreach ( $domains_to_check as $domain ) {&nbsp;</div></li><li><div>                $result = Jetpack_Data::is_usable_domain( $domain );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    return $result;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = Jetpack::register();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If there was an error with registration and the site was not registered, record this so we can show a message.&nbsp;</div></li><li><div>        if ( ! $result || is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            return $result;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Tracking an internal event log. Try not to put too much chaff in here.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * [Everyone Loves a Log!](https://www.youtube.com/watch?v=2C7mNr5WMjA)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function log( $code, $data = null ) {&nbsp;</div></li><li><div>        $log = Jetpack_Options::get_option( 'log', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Append our event to the log&nbsp;</div></li><li><div>        $log_entry = array(&nbsp;</div></li><li><div>            'time' =&gt; time(), &nbsp;</div></li><li><div>            'user_id' =&gt; get_current_user_id(), &nbsp;</div></li><li><div>            'blog_id' =&gt; Jetpack_Options::get_option( 'id' ), &nbsp;</div></li><li><div>            'code' =&gt; $code, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        // Don't bother storing it unless we've got some.&nbsp;</div></li><li><div>        if ( ! is_null( $data ) ) {&nbsp;</div></li><li><div>            $log_entry['data'] = $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $log[] = $log_entry;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Try add_option first, to make sure it's not autoloaded.&nbsp;</div></li><li><div>        // @todo: Add an add_option method to Jetpack_Options&nbsp;</div></li><li><div>        if ( ! add_option( 'jetpack_log', $log, null, 'no' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'log', $log );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when Jetpack logs an internal event.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.0.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $log_entry {&nbsp;</div></li><li><div>         *    Array of details about the log entry.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         *    @param string time Time of the event.&nbsp;</div></li><li><div>         *    @param int user_id ID of the user who trigerred the event.&nbsp;</div></li><li><div>         *    @param int blog_id Jetpack Blog ID.&nbsp;</div></li><li><div>         *    @param string code Unique name for the event.&nbsp;</div></li><li><div>         *    @param string data Data about the event.&nbsp;</div></li><li><div>         * }&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_log_entry', $log_entry );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the internal event log.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $event (string) - only return the specific log events&nbsp;</div></li><li><div>     * @param $num   (int)    - get specific number of latest results&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array of log events || WP_Error for invalid params&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_log( $event = false, $num = false ) {&nbsp;</div></li><li><div>        if ( $event && ! is_string( $event ) ) {&nbsp;</div></li><li><div>            return new WP_Error( __( 'First param must be string or empty', 'jetpack' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $num && ! is_numeric( $num ) ) {&nbsp;</div></li><li><div>            return new WP_Error( __( 'Second param must be numeric or empty', 'jetpack' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entire_log = Jetpack_Options::get_option( 'log', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If nothing set - act as it did before, otherwise let's start customizing the output&nbsp;</div></li><li><div>        if ( ! $num && ! $event ) {&nbsp;</div></li><li><div>            return $entire_log;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $entire_log = array_reverse( $entire_log );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $custom_log_output = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $event ) {&nbsp;</div></li><li><div>            foreach ( $entire_log as $log_event ) {&nbsp;</div></li><li><div>                if ( $event == $log_event[ 'code' ] ) {&nbsp;</div></li><li><div>                    $custom_log_output[] = $log_event;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $custom_log_output = $entire_log;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $num ) {&nbsp;</div></li><li><div>            $custom_log_output = array_slice( $custom_log_output, 0, $num );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $custom_log_output;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Log modification of important settings.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function log_settings_change( $option, $old_value, $value ) {&nbsp;</div></li><li><div>        switch( $option ) {&nbsp;</div></li><li><div>            case 'jetpack_sync_non_public_post_stati':&nbsp;</div></li><li><div>                self::log( $option, $value );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Admin Pages */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_init() {&nbsp;</div></li><li><div>        // If the plugin is not connected, display a connect message.&nbsp;</div></li><li><div>        if (&nbsp;</div></li><li><div>            // the plugin was auto-activated and needs its candy&nbsp;</div></li><li><div>            Jetpack_Options::get_option( 'do_activate' )&nbsp;</div></li><li><div>        ||&nbsp;</div></li><li><div>            // the plugin is active, but was never activated.  Probably came from a site-wide network activation&nbsp;</div></li><li><div>            ! Jetpack_Options::get_option( 'activated' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            Jetpack::plugin_initialize();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! Jetpack::is_active() && ! Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            if ( 4 != Jetpack_Options::get_option( 'activated' ) ) {&nbsp;</div></li><li><div>                // Show connect notice on dashboard and plugins pages&nbsp;</div></li><li><div>                add_action( 'load-index.php', array( $this, 'prepare_connect_notice' ) );&nbsp;</div></li><li><div>                add_action( 'load-plugins.php', array( $this, 'prepare_connect_notice' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( false === Jetpack_Options::get_option( 'fallback_no_verify_ssl_certs' ) ) {&nbsp;</div></li><li><div>            // Upgrade: 1.1 -&gt; 1.1.1&nbsp;</div></li><li><div>            // Check and see if host can verify the Jetpack servers' SSL certificate&nbsp;</div></li><li><div>            $args = array();&nbsp;</div></li><li><div>            Jetpack_Client::_wp_remote_request(&nbsp;</div></li><li><div>                Jetpack::fix_url_for_bad_hosts( Jetpack::api_url( 'test' ) ), &nbsp;</div></li><li><div>                $args, &nbsp;</div></li><li><div>                true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Show the notice on the Dashboard only for now&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            add_action( 'load-index.php', array( $this, 'prepare_manage_jetpack_notice' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Identity crisis notices&nbsp;</div></li><li><div>            add_action( 'jetpack_notices', array( $this, 'alert_identity_crisis' ) );&nbsp;</div></li><li><div>            add_action( 'admin_notices', array( $this, 'alert_identity_crisis' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the plugin has just been disconnected from WP.com, show the survey notice&nbsp;</div></li><li><div>        if ( isset( $_GET['disconnected'] ) && 'true' === $_GET['disconnected'] ) {&nbsp;</div></li><li><div>            add_action( 'jetpack_notices', array( $this, 'disconnect_survey_notice' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( current_user_can( 'manage_options' ) && 'ALWAYS' == JETPACK_CLIENT__HTTPS && ! self::permit_ssl() ) {&nbsp;</div></li><li><div>            add_action( 'admin_notices', array( $this, 'alert_required_ssl_fail' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'load-plugins.php', array( $this, 'intercept_plugin_error_scrape_init' ) );&nbsp;</div></li><li><div>        add_action( 'admin_enqueue_scripts', array( $this, 'admin_menu_css' ) );&nbsp;</div></li><li><div>        add_filter( 'plugin_action_links_' . plugin_basename( JETPACK__PLUGIN_DIR . 'jetpack.php' ), array( $this, 'plugin_action_links' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::is_active() || Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            // Artificially throw errors in certain whitelisted cases during plugin activation&nbsp;</div></li><li><div>            add_action( 'activate_plugin', array( $this, 'throw_error_on_activate_plugin' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Kick off synchronization of user role when it changes&nbsp;</div></li><li><div>            add_action( 'set_user_role', array( $this, 'user_role_change' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Jetpack Manage Activation Screen from .com&nbsp;</div></li><li><div>        Jetpack::module_configuration_activation_screen( 'manage', array( $this, 'manage_activate_screen' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_body_class( $admin_body_class = '' ) {&nbsp;</div></li><li><div>        $classes = explode( ' ', trim( $admin_body_class ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $classes[] = self::is_active() ? 'jetpack-connected' : 'jetpack-disconnected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $admin_body_class = implode( ' ', array_unique( $classes ) );&nbsp;</div></li><li><div>        return &quot; $admin_body_class &quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    static function add_jetpack_pagestyles( $admin_body_class = '' ) {&nbsp;</div></li><li><div>        return $admin_body_class . ' jetpack-pagestyles ';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function prepare_connect_notice() {&nbsp;</div></li><li><div>        add_action( 'admin_print_styles', array( $this, 'admin_banner_styles' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_notices', array( $this, 'admin_connect_notice' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::state( 'network_nag' ) )&nbsp;</div></li><li><div>            add_action( 'network_admin_notices', array( $this, 'network_connect_notice' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Call this function if you want the Big Jetpack Manage Notice to show up.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function prepare_manage_jetpack_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_print_styles', array( $this, 'admin_banner_styles' ) );&nbsp;</div></li><li><div>        add_action( 'admin_notices', array( $this, 'admin_jetpack_manage_notice' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function manage_activate_screen() {&nbsp;</div></li><li><div>        include ( JETPACK__PLUGIN_DIR . 'modules/manage/activate-admin.php' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sometimes a plugin can activate without causing errors, but it will cause errors on the next page load.&nbsp;</div></li><li><div>     * This function artificially throws errors for such cases (whitelisted).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $plugin The activated plugin.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function throw_error_on_activate_plugin( $plugin ) {&nbsp;</div></li><li><div>        $active_modules = Jetpack::get_active_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The Shortlinks module and the Stats plugin conflict, but won't cause errors on activation because of some function_exists() checks.&nbsp;</div></li><li><div>        if ( function_exists( 'stats_get_api_key' ) && in_array( 'shortlinks', $active_modules ) ) {&nbsp;</div></li><li><div>            $throw = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Try and make sure it really was the stats plugin&nbsp;</div></li><li><div>            if ( ! class_exists( 'ReflectionFunction' ) ) {&nbsp;</div></li><li><div>                if ( 'stats.php' == basename( $plugin ) ) {&nbsp;</div></li><li><div>                    $throw = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $reflection = new ReflectionFunction( 'stats_get_api_key' );&nbsp;</div></li><li><div>                if ( basename( $plugin ) == basename( $reflection-&gt;getFileName() ) ) {&nbsp;</div></li><li><div>                    $throw = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $throw ) {&nbsp;</div></li><li><div>                trigger_error( sprintf( __( 'Jetpack contains the most recent version of the old &#8220;%1$s&#8221; plugin.', 'jetpack' ), 'WordPress.com Stats' ), E_USER_ERROR );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function intercept_plugin_error_scrape_init() {&nbsp;</div></li><li><div>        add_action( 'check_admin_referer', array( $this, 'intercept_plugin_error_scrape' ), 10, 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function intercept_plugin_error_scrape( $action, $result ) {&nbsp;</div></li><li><div>        if ( ! $result ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;plugins_to_deactivate as $deactivate_me ) {&nbsp;</div></li><li><div>            if ( &quot;plugin-activation-error_{$deactivate_me[0]}&quot; == $action ) {&nbsp;</div></li><li><div>                Jetpack::bail_on_activation( sprintf( __( 'Jetpack contains the most recent version of the old &#8220;%1$s&#8221; plugin.', 'jetpack' ), $deactivate_me[1] ), false );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_remote_request_handlers() {&nbsp;</div></li><li><div>        add_action( 'wp_ajax_nopriv_jetpack_upload_file', array( $this, 'remote_request_handlers' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function remote_request_handlers() {&nbsp;</div></li><li><div>        switch ( current_filter() ) {&nbsp;</div></li><li><div>        case 'wp_ajax_nopriv_jetpack_upload_file' :&nbsp;</div></li><li><div>            $response = $this-&gt;upload_handler();&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        default :&nbsp;</div></li><li><div>            $response = new Jetpack_Error( 'unknown_handler', 'Unknown Handler', 400 );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $response ) {&nbsp;</div></li><li><div>            $response = new Jetpack_Error( 'unknown_error', 'Unknown Error', 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            $status_code = $response-&gt;get_error_data();&nbsp;</div></li><li><div>            $error = $response-&gt;get_error_code();&nbsp;</div></li><li><div>            $error_description = $response-&gt;get_error_message();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_int( $status_code ) ) {&nbsp;</div></li><li><div>                $status_code = 400;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            status_header( $status_code );&nbsp;</div></li><li><div>            die( json_encode( (object) compact( 'error', 'error_description' ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        status_header( 200 );&nbsp;</div></li><li><div>        if ( true === $response ) {&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        die( json_encode( (object) $response ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function upload_handler() {&nbsp;</div></li><li><div>        if ( 'POST' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 405, get_status_header_desc( 405 ), 405 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = wp_authenticate( '', '' );&nbsp;</div></li><li><div>        if ( ! $user || is_wp_error( $user ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 403, get_status_header_desc( 403 ), 403 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_set_current_user( $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'upload_files' ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'cannot_upload_files', 'User does not have permission to upload files', 403 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $_FILES ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'no_files_uploaded', 'No files were uploaded: nothing to process', 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( array_keys( $_FILES ) as $files_key ) {&nbsp;</div></li><li><div>            if ( ! isset( $_POST[&quot;_jetpack_file_hmac_{$files_key}&quot;] ) ) {&nbsp;</div></li><li><div>                return new Jetpack_Error( 'missing_hmac', 'An HMAC for one or more files is missing', 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $media_keys = array_keys( $_FILES['media'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token = Jetpack_Data::get_access_token( get_current_user_id() );&nbsp;</div></li><li><div>        if ( ! $token || is_wp_error( $token ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'unknown_token', 'Unknown Jetpack token', 403 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $uploaded_files = array();&nbsp;</div></li><li><div>        $global_post = isset( $GLOBALS['post'] ) ? $GLOBALS['post'] : null;&nbsp;</div></li><li><div>        unset( $GLOBALS['post'] );&nbsp;</div></li><li><div>        foreach ( $_FILES['media']['name'] as $index =&gt; $name ) {&nbsp;</div></li><li><div>            $file = array();&nbsp;</div></li><li><div>            foreach ( $media_keys as $media_key ) {&nbsp;</div></li><li><div>                $file[$media_key] = $_FILES['media'][$media_key][$index];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            list( $hmac_provided, $salt ) = explode( ':', $_POST['_jetpack_file_hmac_media'][$index] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $hmac_file = hash_hmac_file( 'sha1', $file['tmp_name'], $salt . $token-&gt;secret );&nbsp;</div></li><li><div>            if ( $hmac_provided !== $hmac_file ) {&nbsp;</div></li><li><div>                $uploaded_files[$index] = (object) array( 'error' =&gt; 'invalid_hmac', 'error_description' =&gt; 'The corresponding HMAC for this file does not match' );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $_FILES['.jetpack.upload.'] = $file;&nbsp;</div></li><li><div>            $post_id = isset( $_POST['post_id'][$index] ) ? absint( $_POST['post_id'][$index] ) : 0;&nbsp;</div></li><li><div>            if ( ! current_user_can( 'edit_post', $post_id ) ) {&nbsp;</div></li><li><div>                $post_id = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $attachment_id = media_handle_upload(&nbsp;</div></li><li><div>                '.jetpack.upload.', &nbsp;</div></li><li><div>                $post_id, &nbsp;</div></li><li><div>                array(), &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'action' =&gt; 'jetpack_upload_file', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $attachment_id ) {&nbsp;</div></li><li><div>                $uploaded_files[$index] = (object) array( 'error' =&gt; 'unknown', 'error_description' =&gt; 'An unknown problem occurred processing the upload on the Jetpack site' );&nbsp;</div></li><li><div>            } elseif ( is_wp_error( $attachment_id ) ) {&nbsp;</div></li><li><div>                $uploaded_files[$index] = (object) array( 'error' =&gt; 'attachment_' . $attachment_id-&gt;get_error_code(), 'error_description' =&gt; $attachment_id-&gt;get_error_message() );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $attachment = get_post( $attachment_id );&nbsp;</div></li><li><div>                $uploaded_files[$index] = (object) array(&nbsp;</div></li><li><div>                    'id' =&gt; (string) $attachment_id, &nbsp;</div></li><li><div>                    'file' =&gt; $attachment-&gt;post_title, &nbsp;</div></li><li><div>                    'url' =&gt; wp_get_attachment_url( $attachment_id ), &nbsp;</div></li><li><div>                    'type' =&gt; $attachment-&gt;post_mime_type, &nbsp;</div></li><li><div>                    'meta' =&gt; wp_get_attachment_metadata( $attachment_id ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! is_null( $global_post ) ) {&nbsp;</div></li><li><div>            $GLOBALS['post'] = $global_post;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $uploaded_files;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add help to the Jetpack page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since Jetpack (1.2.3)&nbsp;</div></li><li><div>     * @return false if not the Jetpack page&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_help() {&nbsp;</div></li><li><div>        $current_screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Overview&nbsp;</div></li><li><div>        $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'id' =&gt; 'home', &nbsp;</div></li><li><div>                'title' =&gt; __( 'Home', 'jetpack' ), &nbsp;</div></li><li><div>                'content' =&gt;&nbsp;</div></li><li><div>                    '&lt;p&gt;&lt;strong&gt;' . __( 'Jetpack by WordPress.com', 'jetpack' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                    '&lt;p&gt;' . __( 'Jetpack supercharges your self-hosted WordPress site with the awesome cloud power of WordPress.com.', 'jetpack' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                    '&lt;p&gt;' . __( 'On this page, you are able to view the modules available within Jetpack, learn more about them, and activate or deactivate them as needed.', 'jetpack' ) . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Screen Content&nbsp;</div></li><li><div>        if ( current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'id' =&gt; 'settings', &nbsp;</div></li><li><div>                    'title' =&gt; __( 'Settings', 'jetpack' ), &nbsp;</div></li><li><div>                    'content' =&gt;&nbsp;</div></li><li><div>                        '&lt;p&gt;&lt;strong&gt;' . __( 'Jetpack by WordPress.com', 'jetpack' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                        '&lt;p&gt;' . __( 'You can activate or deactivate individual Jetpack modules to suit your needs.', 'jetpack' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                        '&lt;ol&gt;' .&nbsp;</div></li><li><div>                            '&lt;li&gt;' . __( 'Each module has an Activate or Deactivate link so you can toggle one individually.', 'jetpack' ) . '&lt;/li&gt;' .&nbsp;</div></li><li><div>                            '&lt;li&gt;' . __( 'Using the checkboxes next to each module, you can select multiple modules to toggle via the Bulk Actions menu at the top of the list.', 'jetpack' ) . '&lt;/li&gt;' .&nbsp;</div></li><li><div>                        '&lt;/ol&gt;' .&nbsp;</div></li><li><div>                        '&lt;p&gt;' . __( 'Using the tools on the right, you can search for specific modules, filter by module categories or which are active, or change the sorting order.', 'jetpack' ) . '&lt;/p&gt;'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Help Sidebar&nbsp;</div></li><li><div>        $current_screen-&gt;set_help_sidebar(&nbsp;</div></li><li><div>            '&lt;p&gt;&lt;strong&gt;' . __( 'For more information:', 'jetpack' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>            '&lt;p&gt;&lt;a href=&quot;http://jetpack.me/faq/&quot; target=&quot;_blank&quot;&gt;'     . __( 'Jetpack FAQ', 'jetpack' ) . '&lt;/a&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>            '&lt;p&gt;&lt;a href=&quot;http://jetpack.me/support/&quot; target=&quot;_blank&quot;&gt;' . __( 'Jetpack Support', 'jetpack' ) . '&lt;/a&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>            '&lt;p&gt;&lt;a href=&quot;' . Jetpack::admin_url( array( 'page' =&gt; 'jetpack-debugger' ) ) .'&quot;&gt;' . __( 'Jetpack Debugging Center', 'jetpack' ) . '&lt;/a&gt;&lt;/p&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_menu_css() {&nbsp;</div></li><li><div>        wp_enqueue_style( 'jetpack-icons' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_menu_order() {&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function jetpack_menu_order( $menu_order ) {&nbsp;</div></li><li><div>        $jp_menu_order = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $menu_order as $index =&gt; $item ) {&nbsp;</div></li><li><div>            if ( $item != 'jetpack' ) {&nbsp;</div></li><li><div>                $jp_menu_order[] = $item;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $index == 0 ) {&nbsp;</div></li><li><div>                $jp_menu_order[] = 'jetpack';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $jp_menu_order;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_head() {&nbsp;</div></li><li><div>        if ( isset( $_GET['configure'] ) && Jetpack::is_module( $_GET['configure'] ) && current_user_can( 'manage_options' ) )&nbsp;</div></li><li><div>            /** This action is documented in class.jetpack-admin-page.php */&nbsp;</div></li><li><div>            do_action( 'jetpack_module_configuration_head_' . $_GET['configure'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_banner_styles() {&nbsp;</div></li><li><div>        $min = ( defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style( 'jetpack', plugins_url( &quot;css/jetpack-banners{$min}.css&quot;, JETPACK__PLUGIN_FILE ), false, JETPACK__VERSION . '-20121016' );&nbsp;</div></li><li><div>        wp_style_add_data( 'jetpack', 'rtl', 'replace' );&nbsp;</div></li><li><div>        wp_style_add_data( 'jetpack', 'suffix', $min );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_scripts() {&nbsp;</div></li><li><div>        wp_enqueue_script( 'jetpack-js', plugins_url( '_inc/jp.js', JETPACK__PLUGIN_FILE ), array( 'jquery', 'wp-util' ), JETPACK__VERSION . '-20121111' );&nbsp;</div></li><li><div>        wp_localize_script(&nbsp;</div></li><li><div>            'jetpack-js', &nbsp;</div></li><li><div>            'jetpackL10n', &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'ays_disconnect' =&gt; &quot;This will deactivate all Jetpack modules.\nAre you sure you want to disconnect?&quot;, &nbsp;</div></li><li><div>                'ays_unlink' =&gt; &quot;This will prevent user-specific modules such as Publicize, Notifications and Post By Email from working.\nAre you sure you want to unlink?&quot;, &nbsp;</div></li><li><div>                'ays_dismiss' =&gt; &quot;This will deactivate Jetpack.\nAre you sure you want to deactivate Jetpack?&quot;, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        add_action( 'admin_footer', array( $this, 'do_stats' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function plugin_action_links( $actions ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_home = array( 'jetpack-home' =&gt; sprintf( '&lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;', Jetpack::admin_url( 'page=jetpack' ), __( 'Jetpack', 'jetpack' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( current_user_can( 'jetpack_manage_modules' ) && ( Jetpack::is_active() || Jetpack::is_development_mode() ) ) {&nbsp;</div></li><li><div>            return array_merge(&nbsp;</div></li><li><div>                $jetpack_home, &nbsp;</div></li><li><div>                array( 'settings' =&gt; sprintf( '&lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;', Jetpack::admin_url( 'page=jetpack_modules' ), __( 'Settings', 'jetpack' ) ) ), &nbsp;</div></li><li><div>                array( 'support' =&gt; sprintf( '&lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;', Jetpack::admin_url( 'page=jetpack-debugger '), __( 'Support', 'jetpack' ) ) ), &nbsp;</div></li><li><div>                $actions&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge( $jetpack_home, $actions );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_connect_notice() {&nbsp;</div></li><li><div>        // Don't show the connect notice anywhere but the plugins.php after activating&nbsp;</div></li><li><div>        $current = get_current_screen();&nbsp;</div></li><li><div>        if ( 'plugins' !== $current-&gt;parent_base )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'jetpack_connect' ) )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dismiss_and_deactivate_url = wp_nonce_url( Jetpack::admin_url( '?page=jetpack&jetpack-notice=dismiss' ), 'jetpack-deactivate' );&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;updated jetpack-message jp-banner&quot; style=&quot;display:block !important;&quot;&gt;&nbsp;</div></li><li><div>            &lt;a class=&quot;jp-banner__dismiss&quot; href=&quot;&lt;?php echo esc_url( $dismiss_and_deactivate_url ); ?&gt;&quot; title=&quot;&lt;?php esc_attr_e( 'Dismiss this notice and deactivate Jetpack.', 'jetpack' ); ?&gt;&quot;&gt;&lt;/a&gt;&nbsp;</div></li><li><div>            &lt;?php if ( in_array( Jetpack_Options::get_option( 'activated' ) , array( 1, 2, 3 ) ) ) : ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-banner__content is-connection&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e( 'Your Jetpack is almost ready!', 'jetpack' ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;?php _e( 'Connect now to enable features like Stats, Likes, and Social Sharing.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-banner__action-container is-connection&quot;&gt;&nbsp;</div></li><li><div>                        &lt;a href=&quot;&lt;?php echo $this-&gt;build_connect_url() ?&gt;&quot; class=&quot;jp-banner__button&quot; id=&quot;wpcom-connect&quot;&gt;&lt;?php _e( 'Connect to WordPress.com', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-banner__content&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e( 'Jetpack is installed!', 'jetpack' ) ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;?php _e( 'It\'s ready to bring awesome, WordPress.com cloud-powered features to your site.', 'jetpack' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-banner__action-container&quot;&gt;&nbsp;</div></li><li><div>                    &lt;a href=&quot;&lt;?php echo Jetpack::admin_url() ?&gt;&quot; class=&quot;jp-banner__button&quot; id=&quot;wpcom-connect&quot;&gt;&lt;?php _e( 'Learn More', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This is the first banner&nbsp;</div></li><li><div>     * It should be visible only to user that can update the option&nbsp;</div></li><li><div>     * Are not connected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_jetpack_manage_notice() {&nbsp;</div></li><li><div>        $screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Don't show the connect notice on the jetpack settings page.&nbsp;</div></li><li><div>        if ( ! in_array( $screen-&gt;base, array( 'dashboard' ) ) || $screen-&gt;is_network || $screen-&gt;action )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only show it if don't have the managment option set.&nbsp;</div></li><li><div>        // And not dismissed it already.&nbsp;</div></li><li><div>        if ( ! $this-&gt;can_display_jetpack_manage_notice() || Jetpack_Options::get_option( 'dismissed_manage_banner' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $opt_out_url = $this-&gt;opt_out_jetpack_manage_url();&nbsp;</div></li><li><div>        $opt_in_url = $this-&gt;opt_in_jetpack_manage_url();&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * I think it would be great to have different wordsing depending on where you are&nbsp;</div></li><li><div>         * for example if we show the notice on dashboard and a different one if we show it on Plugins screen&nbsp;</div></li><li><div>         * etc..&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;updated jetpack-message jp-banner is-opt-in&quot; style=&quot;display:block !important;&quot;&gt;&nbsp;</div></li><li><div>            &lt;a class=&quot;jp-banner__dismiss&quot; href=&quot;&lt;?php echo esc_url( $opt_out_url ); ?&gt;&quot; title=&quot;&lt;?php esc_attr_e( 'Dismiss this notice for now.', 'jetpack' ); ?&gt;&quot;&gt;&lt;/a&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;jp-banner__content&quot;&gt;&nbsp;</div></li><li><div>                &lt;h4&gt;&lt;?php esc_html_e( 'New in Jetpack: Centralized Site Management', 'jetpack' ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php printf( __( 'Manage multiple sites from one dashboard at wordpress.com/sites. Enabling allows all existing, connected Administrators to modify your site from WordPress.com. &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Learn More&lt;/a&gt;.', 'jetpack' ), 'http://jetpack.me/support/site-management' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;jp-banner__action-container is-opt-in&quot;&gt;&nbsp;</div></li><li><div>                &lt;a href=&quot;&lt;?php echo esc_url( $opt_in_url ); ?&gt;&quot; class=&quot;jp-banner__button&quot; id=&quot;wpcom-connect&quot;&gt;&lt;?php _e( 'Activate now', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the url that the user clicks to remove the notice for the big banner&nbsp;</div></li><li><div>     * @return (string)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function opt_out_jetpack_manage_url() {&nbsp;</div></li><li><div>        $referer = '&_wp_http_referer=' . add_query_arg( '_wp_http_referer', null );&nbsp;</div></li><li><div>        return wp_nonce_url( Jetpack::admin_url( 'jetpack-notice=jetpack-manage-opt-out' . $referer ), 'jetpack_manage_banner_opt_out' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the url that the user clicks to opt in to Jetpack Manage&nbsp;</div></li><li><div>     * @return (string)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function opt_in_jetpack_manage_url() {&nbsp;</div></li><li><div>        return wp_nonce_url( Jetpack::admin_url( 'jetpack-notice=jetpack-manage-opt-in' ), 'jetpack_manage_banner_opt_in' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function opt_in_jetpack_manage_notice() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;message&quot; class=&quot;jetpack-message is-opt-in&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php echo sprintf( __( '&lt;p&gt;&lt;a href=&quot;%1$s&quot; title=&quot;Opt in to WordPress.com Site Management&quot; &gt;Activate Site Management&lt;/a&gt; to manage multiple sites from our centralized dashboard at wordpress.com/sites. &lt;a href=&quot;%2$s&quot; target=&quot;_blank&quot;&gt;Learn more&lt;/a&gt;.&lt;/p&gt;&lt;a href=&quot;%1$s&quot; class=&quot;jp-button&quot;&gt;Activate Now&lt;/a&gt;', 'jetpack' ), $this-&gt;opt_in_jetpack_manage_url(), 'http://jetpack.me/support/site-management' ); ?&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines whether to show the notice of not true = display notice&nbsp;</div></li><li><div>     * @return (bool)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function can_display_jetpack_manage_notice() {&nbsp;</div></li><li><div>        // never display the notice to users that can't do anything about it anyways&nbsp;</div></li><li><div>        if( ! current_user_can( 'jetpack_manage_modules' ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // don't display if we are in development more&nbsp;</div></li><li><div>        if( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // don't display if the site is private&nbsp;</div></li><li><div>        if(  ! Jetpack_Options::get_option( 'public' ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Should the Jetpack Remote Site Management notice be displayed.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool ! self::is_module_active( 'manage' ) Is the Manage module inactive.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'can_display_jetpack_manage_notice', ! self::is_module_active( 'manage' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function network_connect_notice() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;updated jetpack-message&quot;&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;squeezer&quot;&gt;&nbsp;</div></li><li><div>                &lt;h4&gt;&lt;?php _e( '&lt;strong&gt;Jetpack is activated!&lt;/strong&gt; Each site on your network must be connected individually by an admin on that site.', 'jetpack' ) ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function jetpack_comment_notice() {&nbsp;</div></li><li><div>        if ( in_array( 'comments', Jetpack::get_active_modules() ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_old_version = explode( ':', Jetpack_Options::get_option( 'old_version' ) );&nbsp;</div></li><li><div>        $jetpack_new_version = explode( ':', Jetpack_Options::get_option( 'version' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $jetpack_old_version ) {&nbsp;</div></li><li><div>            if ( version_compare( $jetpack_old_version[0], '1.4', '&gt;=' ) ) {&nbsp;</div></li><li><div>                return '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $jetpack_new_version ) {&nbsp;</div></li><li><div>            if ( version_compare( $jetpack_new_version[0], '1.4-something', '&lt;' ) ) {&nbsp;</div></li><li><div>                return '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return '&lt;br /&gt;&lt;br /&gt;' . sprintf(&nbsp;</div></li><li><div>            __( 'Jetpack now includes Comments, which enables your visitors to use their WordPress.com, Twitter, or Facebook accounts when commenting on your site. To activate Comments, &lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;.', 'jetpack' ), &nbsp;</div></li><li><div>            wp_nonce_url(&nbsp;</div></li><li><div>                Jetpack::admin_url(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'page' =&gt; 'jetpack', &nbsp;</div></li><li><div>                        'action' =&gt; 'activate', &nbsp;</div></li><li><div>                        'module' =&gt; 'comments', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'jetpack_activate-comments'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            __( 'click here', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Show the survey link when the user has just disconnected Jetpack.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function disconnect_survey_notice() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;message&quot; class=&quot;jetpack-message stay-visible&quot;&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;squeezer&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&nbsp;</div></li><li><div>                        &lt;?php _e( 'You have successfully disconnected Jetpack.', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                        &lt;br /&gt;&nbsp;</div></li><li><div>                        &lt;?php echo sprintf(&nbsp;</div></li><li><div>                            __( 'Would you tell us why? Just &lt;a href=&quot;%1$s&quot; target=&quot;%2$s&quot;&gt;answering two simple questions&lt;/a&gt; would help us improve Jetpack.', 'jetpack' ), &nbsp;</div></li><li><div>                            'https://jetpack.me/survey-disconnected/', &nbsp;</div></li><li><div>                            '_blank'&nbsp;</div></li><li><div> ); ?&gt;&nbsp;</div></li><li><div>                    &lt;/h4&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registration flow:&nbsp;</div></li><li><div>     * 1 - ::admin_page_load() action=register&nbsp;</div></li><li><div>     * 2 - ::try_registration()&nbsp;</div></li><li><div>     * 3 - ::register()&nbsp;</div></li><li><div>     *     - Creates jetpack_register option containing two secrets and a timestamp&nbsp;</div></li><li><div>     *     - Calls https://jetpack.wordpress.com/jetpack.register/1/ with&nbsp;</div></li><li><div>     *       siteurl, home, gmt_offset, timezone_string, site_name, secret_1, secret_2, site_lang, timeout, stats_id&nbsp;</div></li><li><div>     *     - That request to jetpack.wordpress.com does not immediately respond.  It first makes a request BACK to this site's&nbsp;</div></li><li><div>     *       xmlrpc.php?for=jetpack: RPC method: jetpack.verifyRegistration, Parameters: secret_1&nbsp;</div></li><li><div>     *     - The XML-RPC request verifies secret_1, deletes both secrets and responds with: secret_2&nbsp;</div></li><li><div>     *     - https://jetpack.wordpress.com/jetpack.register/1/ verifies that XML-RPC response (secret_2) then finally responds itself with&nbsp;</div></li><li><div>     *       jetpack_id, jetpack_secret, jetpack_public&nbsp;</div></li><li><div>     *     - ::register() then stores jetpack_options: id =&gt; jetpack_id, blog_token =&gt; jetpack_secret&nbsp;</div></li><li><div>     * 4 - redirect to https://jetpack.wordpress.com/jetpack.authorize/1/&nbsp;</div></li><li><div>     * 5 - user logs in with WP.com account&nbsp;</div></li><li><div>     * 6 - redirect to this site's wp-admin/index.php?page=jetpack&action=authorize with&nbsp;</div></li><li><div>     *     code &lt;-- OAuth2 style authorization code&nbsp;</div></li><li><div>     * 7 - ::admin_page_load() action=authorize&nbsp;</div></li><li><div>     * 8 - Jetpack_Client_Server::authorize()&nbsp;</div></li><li><div>     * 9 - Jetpack_Client_Server::get_token()&nbsp;</div></li><li><div>     * 10- GET https://jetpack.wordpress.com/jetpack.token/1/ with&nbsp;</div></li><li><div>     *     client_id, client_secret, grant_type, code, redirect_uri:action=authorize, state, scope, user_email, user_login&nbsp;</div></li><li><div>     * 11- which responds with&nbsp;</div></li><li><div>     *     access_token, token_type, scope&nbsp;</div></li><li><div>     * 12- Jetpack_Client_Server::authorize() stores jetpack_options: user_token =&gt; access_token.$user_id&nbsp;</div></li><li><div>     * 13- Jetpack::activate_default_modules()&nbsp;</div></li><li><div>     *     Deactivates deprecated plugins&nbsp;</div></li><li><div>     *     Activates all default modules&nbsp;</div></li><li><div>     *     Catches errors: redirects to wp-admin/index.php?page=jetpack state:error=something&nbsp;</div></li><li><div>     * 14- redirect to this site's wp-admin/index.php?page=jetpack with state:message=authorized&nbsp;</div></li><li><div>     *     Done!&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles the page load events for the Jetpack admin page&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_page_load() {&nbsp;</div></li><li><div>        $error = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure we have the right body class to hook stylings for subpages off of.&nbsp;</div></li><li><div>        add_filter( 'admin_body_class', array( __CLASS__, 'add_jetpack_pagestyles' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['jetpack_restate'] ) ) {&nbsp;</div></li><li><div>            // Should only be used in intermediate redirects to preserve state across redirects&nbsp;</div></li><li><div>            Jetpack::restate();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['connect_url_redirect'] ) ) {&nbsp;</div></li><li><div>            // User clicked in the iframe to link their accounts&nbsp;</div></li><li><div>            if ( ! Jetpack::is_user_connected() ) {&nbsp;</div></li><li><div>                $connect_url = $this-&gt;build_connect_url( true );&nbsp;</div></li><li><div>                if ( isset( $_GET['notes_iframe'] ) )&nbsp;</div></li><li><div>                    $connect_url .= '&notes_iframe';&nbsp;</div></li><li><div>                wp_redirect( $connect_url );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                Jetpack::state( 'message', 'already_authorized' );&nbsp;</div></li><li><div>                wp_safe_redirect( Jetpack::admin_url() );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['action'] ) ) {&nbsp;</div></li><li><div>            switch ( $_GET['action'] ) {&nbsp;</div></li><li><div>            case 'authorize' :&nbsp;</div></li><li><div>                if ( Jetpack::is_active() && Jetpack::is_user_connected() ) {&nbsp;</div></li><li><div>                    Jetpack::state( 'message', 'already_authorized' );&nbsp;</div></li><li><div>                    wp_safe_redirect( Jetpack::admin_url() );&nbsp;</div></li><li><div>                    exit;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                Jetpack::log( 'authorize' );&nbsp;</div></li><li><div>                $client_server = new Jetpack_Client_Server;&nbsp;</div></li><li><div>                $client_server-&gt;authorize();&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'register' :&nbsp;</div></li><li><div>                if ( ! current_user_can( 'jetpack_connect' ) ) {&nbsp;</div></li><li><div>                    $error = 'cheatin';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                check_admin_referer( 'jetpack-register' );&nbsp;</div></li><li><div>                Jetpack::log( 'register' );&nbsp;</div></li><li><div>                Jetpack::maybe_set_version_option();&nbsp;</div></li><li><div>                $registered = Jetpack::try_registration();&nbsp;</div></li><li><div>                if ( is_wp_error( $registered ) ) {&nbsp;</div></li><li><div>                    $error = $registered-&gt;get_error_code();&nbsp;</div></li><li><div>                    Jetpack::state( 'error_description', $registered-&gt;get_error_message() );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_redirect( $this-&gt;build_connect_url( true ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'activate' :&nbsp;</div></li><li><div>                if ( ! current_user_can( 'jetpack_activate_modules' ) ) {&nbsp;</div></li><li><div>                    $error = 'cheatin';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $module = stripslashes( $_GET['module'] );&nbsp;</div></li><li><div>                check_admin_referer( &quot;jetpack_activate-$module&quot; );&nbsp;</div></li><li><div>                Jetpack::log( 'activate', $module );&nbsp;</div></li><li><div>                Jetpack::activate_module( $module );&nbsp;</div></li><li><div>                // The following two lines will rarely happen, as Jetpack::activate_module normally exits at the end.&nbsp;</div></li><li><div>                wp_safe_redirect( Jetpack::admin_url( 'page=jetpack' ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'activate_default_modules' :&nbsp;</div></li><li><div>                check_admin_referer( 'activate_default_modules' );&nbsp;</div></li><li><div>                Jetpack::log( 'activate_default_modules' );&nbsp;</div></li><li><div>                Jetpack::restate();&nbsp;</div></li><li><div>                $min_version = isset( $_GET['min_version'] ) ? $_GET['min_version'] : false;&nbsp;</div></li><li><div>                $max_version = isset( $_GET['max_version'] ) ? $_GET['max_version'] : false;&nbsp;</div></li><li><div>                $other_modules = isset( $_GET['other_modules'] ) && is_array( $_GET['other_modules'] ) ? $_GET['other_modules'] : array();&nbsp;</div></li><li><div>                Jetpack::activate_default_modules( $min_version, $max_version, $other_modules );&nbsp;</div></li><li><div>                wp_safe_redirect( Jetpack::admin_url( 'page=jetpack' ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'disconnect' :&nbsp;</div></li><li><div>                if ( ! current_user_can( 'jetpack_disconnect' ) ) {&nbsp;</div></li><li><div>                    $error = 'cheatin';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                check_admin_referer( 'jetpack-disconnect' );&nbsp;</div></li><li><div>                Jetpack::log( 'disconnect' );&nbsp;</div></li><li><div>                Jetpack::disconnect();&nbsp;</div></li><li><div>                wp_safe_redirect( Jetpack::admin_url( 'disconnected=true' ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'reconnect' :&nbsp;</div></li><li><div>                if ( ! current_user_can( 'jetpack_reconnect' ) ) {&nbsp;</div></li><li><div>                    $error = 'cheatin';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                check_admin_referer( 'jetpack-reconnect' );&nbsp;</div></li><li><div>                Jetpack::log( 'reconnect' );&nbsp;</div></li><li><div>                $this-&gt;disconnect();&nbsp;</div></li><li><div>                wp_redirect( $this-&gt;build_connect_url( true ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'deactivate' :&nbsp;</div></li><li><div>                if ( ! current_user_can( 'jetpack_deactivate_modules' ) ) {&nbsp;</div></li><li><div>                    $error = 'cheatin';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $modules = stripslashes( $_GET['module'] );&nbsp;</div></li><li><div>                check_admin_referer( &quot;jetpack_deactivate-$modules&quot; );&nbsp;</div></li><li><div>                foreach ( explode( ', ', $modules ) as $module ) {&nbsp;</div></li><li><div>                    Jetpack::log( 'deactivate', $module );&nbsp;</div></li><li><div>                    Jetpack::deactivate_module( $module );&nbsp;</div></li><li><div>                    Jetpack::state( 'message', 'module_deactivated' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                Jetpack::state( 'module', $modules );&nbsp;</div></li><li><div>                wp_safe_redirect( Jetpack::admin_url( 'page=jetpack' ) );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            case 'unlink' :&nbsp;</div></li><li><div>                $redirect = isset( $_GET['redirect'] ) ? $_GET['redirect'] : '';&nbsp;</div></li><li><div>                check_admin_referer( 'jetpack-unlink' );&nbsp;</div></li><li><div>                Jetpack::log( 'unlink' );&nbsp;</div></li><li><div>                $this-&gt;unlink_user();&nbsp;</div></li><li><div>                Jetpack::state( 'message', 'unlinked' );&nbsp;</div></li><li><div>                if ( 'sub-unlink' == $redirect ) {&nbsp;</div></li><li><div>                    wp_safe_redirect( admin_url() );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    wp_safe_redirect( Jetpack::admin_url( array( 'page' =&gt; $redirect ) ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires when a Jetpack admin page is loaded with an unrecognized parameter.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 2.6.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param string sanitize_key( $_GET['action'] ) Unrecognized URL parameter.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'jetpack_unrecognized_action', sanitize_key( $_GET['action'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $error = $error ? $error : Jetpack::state( 'error' ) ) {&nbsp;</div></li><li><div>            self::activate_new_modules( true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $error ) {&nbsp;</div></li><li><div>        case 'cheatin' :&nbsp;</div></li><li><div>            $this-&gt;error = __( 'Cheatin&#8217; uh?', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'access_denied' :&nbsp;</div></li><li><div>            $this-&gt;error = __( 'You need to authorize the Jetpack connection between your site and WordPress.com to enable the awesome features.', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'wrong_state' :&nbsp;</div></li><li><div>            $this-&gt;error = __( 'Don&#8217;t cross the streams!  You need to stay logged in to your WordPress blog while you authorize Jetpack.', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'invalid_client' :&nbsp;</div></li><li><div>            // @todo re-register instead of deactivate/reactivate&nbsp;</div></li><li><div>            $this-&gt;error = __( 'Return to sender.  Whoops! It looks like you got the wrong Jetpack in the mail; deactivate then reactivate the Jetpack plugin to get a new one.', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'invalid_grant' :&nbsp;</div></li><li><div>            $this-&gt;error = __( 'Wrong size.  Hm&#8230; it seems your Jetpack doesn&#8217;t quite fit.  Have you lost weight? Click &#8220;Connect to WordPress.com&#8221; again to get your Jetpack adjusted.', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'site_inaccessible' :&nbsp;</div></li><li><div>        case 'site_requires_authorization' :&nbsp;</div></li><li><div>            $this-&gt;error = sprintf( __( 'Your website needs to be publicly accessible to use Jetpack: %s', 'jetpack' ), &quot;&lt;code&gt;$error&lt;/code&gt;&quot; );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'module_activation_failed' :&nbsp;</div></li><li><div>            $module = Jetpack::state( 'module' );&nbsp;</div></li><li><div>            if ( ! empty( $module ) && $mod = Jetpack::get_module( $module ) ) {&nbsp;</div></li><li><div>                $this-&gt;error = sprintf( __( '%s could not be activated because it triggered a &lt;strong&gt;fatal error&lt;/strong&gt;. Perhaps there is a conflict with another plugin you have installed?', 'jetpack' ), $mod['name'] );&nbsp;</div></li><li><div>                if ( isset( $this-&gt;plugins_to_deactivate[$module] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;error .= ' ' . sprintf( __( 'Do you still have the %s plugin installed?', 'jetpack' ), $this-&gt;plugins_to_deactivate[$module][1] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;error = __( 'Module could not be activated because it triggered a &lt;strong&gt;fatal error&lt;/strong&gt;. Perhaps there is a conflict with another plugin you have installed?', 'jetpack' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $php_errors = Jetpack::state( 'php_errors' ) ) {&nbsp;</div></li><li><div>                $this-&gt;error .= &quot;&lt;br /&gt;\n&quot;;&nbsp;</div></li><li><div>                $this-&gt;error .= $php_errors;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'master_user_required' :&nbsp;</div></li><li><div>            $module = Jetpack::state( 'module' );&nbsp;</div></li><li><div>            $module_name = '';&nbsp;</div></li><li><div>            if ( ! empty( $module ) && $mod = Jetpack::get_module( $module ) ) {&nbsp;</div></li><li><div>                $module_name = $mod['name'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $master_user = Jetpack_Options::get_option( 'master_user' );&nbsp;</div></li><li><div>            $master_userdata = get_userdata( $master_user ) ;&nbsp;</div></li><li><div>            if ( $master_userdata ) {&nbsp;</div></li><li><div>                if ( ! in_array( $module, Jetpack::get_active_modules() ) ) {&nbsp;</div></li><li><div>                    $this-&gt;error = sprintf( __( '%s was not activated.' , 'jetpack' ), $module_name );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;error = sprintf( __( '%s was not deactivated.' , 'jetpack' ), $module_name );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;error .= '  ' . sprintf( __( 'This module can only be altered by %s, the user who initiated the Jetpack connection on this site.' , 'jetpack' ), esc_html( $master_userdata-&gt;display_name ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;error = sprintf( __( 'Only the user who initiated the Jetpack connection on this site can toggle %s, but that user no longer exists. This should not happen.', 'jetpack' ), $module_name );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'not_public' :&nbsp;</div></li><li><div>            $this-&gt;error = __( '&lt;strong&gt;Your Jetpack has a glitch.&lt;/strong&gt; Connecting this site with WordPress.com is not possible. This usually means your site is not publicly accessible (localhost).', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'wpcom_408' :&nbsp;</div></li><li><div>        case 'wpcom_5??' :&nbsp;</div></li><li><div>        case 'wpcom_bad_response' :&nbsp;</div></li><li><div>        case 'wpcom_outage' :&nbsp;</div></li><li><div>            $this-&gt;error = __( 'WordPress.com is currently having problems and is unable to fuel up your Jetpack.  Please try again later.', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'register_http_request_failed' :&nbsp;</div></li><li><div>        case 'token_http_request_failed' :&nbsp;</div></li><li><div>            $this-&gt;error = sprintf( __( 'Jetpack could not contact WordPress.com: %s.  This usually means something is incorrectly configured on your web host.', 'jetpack' ), &quot;&lt;code&gt;$error&lt;/code&gt;&quot; );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        default :&nbsp;</div></li><li><div>            if ( empty( $error ) ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $error = trim( substr( strip_tags( $error ), 0, 20 ) );&nbsp;</div></li><li><div>            // no break: fall through&nbsp;</div></li><li><div>        case 'no_role' :&nbsp;</div></li><li><div>        case 'no_cap' :&nbsp;</div></li><li><div>        case 'no_code' :&nbsp;</div></li><li><div>        case 'no_state' :&nbsp;</div></li><li><div>        case 'invalid_state' :&nbsp;</div></li><li><div>        case 'invalid_request' :&nbsp;</div></li><li><div>        case 'invalid_scope' :&nbsp;</div></li><li><div>        case 'unsupported_response_type' :&nbsp;</div></li><li><div>        case 'invalid_token' :&nbsp;</div></li><li><div>        case 'no_token' :&nbsp;</div></li><li><div>        case 'missing_secrets' :&nbsp;</div></li><li><div>        case 'home_missing' :&nbsp;</div></li><li><div>        case 'siteurl_missing' :&nbsp;</div></li><li><div>        case 'gmt_offset_missing' :&nbsp;</div></li><li><div>        case 'site_name_missing' :&nbsp;</div></li><li><div>        case 'secret_1_missing' :&nbsp;</div></li><li><div>        case 'secret_2_missing' :&nbsp;</div></li><li><div>        case 'site_lang_missing' :&nbsp;</div></li><li><div>        case 'home_malformed' :&nbsp;</div></li><li><div>        case 'siteurl_malformed' :&nbsp;</div></li><li><div>        case 'gmt_offset_malformed' :&nbsp;</div></li><li><div>        case 'timezone_string_malformed' :&nbsp;</div></li><li><div>        case 'site_name_malformed' :&nbsp;</div></li><li><div>        case 'secret_1_malformed' :&nbsp;</div></li><li><div>        case 'secret_2_malformed' :&nbsp;</div></li><li><div>        case 'site_lang_malformed' :&nbsp;</div></li><li><div>        case 'secrets_mismatch' :&nbsp;</div></li><li><div>        case 'verify_secret_1_missing' :&nbsp;</div></li><li><div>        case 'verify_secret_1_malformed' :&nbsp;</div></li><li><div>        case 'verify_secrets_missing' :&nbsp;</div></li><li><div>        case 'verify_secrets_mismatch' :&nbsp;</div></li><li><div>            $error = esc_html( $error );&nbsp;</div></li><li><div>            $this-&gt;error = sprintf( __( '&lt;strong&gt;Your Jetpack has a glitch.&lt;/strong&gt;  Something went wrong that&#8217;s never supposed to happen.  Guess you&#8217;re just lucky: %s', 'jetpack' ), &quot;&lt;code&gt;$error&lt;/code&gt;&quot; );&nbsp;</div></li><li><div>            if ( ! Jetpack::is_active() ) {&nbsp;</div></li><li><div>                $this-&gt;error .= '&lt;br /&gt;';&nbsp;</div></li><li><div>                $this-&gt;error .= sprintf( __( 'Try connecting again.', 'jetpack' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message_code = Jetpack::state( 'message' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_state = Jetpack::state( 'activated_modules' );&nbsp;</div></li><li><div>        if ( ! empty( $active_state ) ) {&nbsp;</div></li><li><div>            $available = Jetpack::get_available_modules();&nbsp;</div></li><li><div>            $active_state = explode( ', ', $active_state );&nbsp;</div></li><li><div>            $active_state = array_intersect( $active_state, $available );&nbsp;</div></li><li><div>            if ( count( $active_state ) ) {&nbsp;</div></li><li><div>                foreach ( $active_state as $mod ) {&nbsp;</div></li><li><div>                    $this-&gt;stat( 'module-activated', $mod );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $active_state = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if( Jetpack::state( 'optin-manage' ) ) {&nbsp;</div></li><li><div>            $activated_manage = $message_code;&nbsp;</div></li><li><div>            $message_code = 'jetpack-manage';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        switch ( $message_code ) {&nbsp;</div></li><li><div>        case 'modules_activated' :&nbsp;</div></li><li><div>            $this-&gt;message = sprintf(&nbsp;</div></li><li><div>                __( 'Welcome to &lt;strong&gt;Jetpack %s&lt;/strong&gt;!', 'jetpack' ), &nbsp;</div></li><li><div>                JETPACK__VERSION&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $active_state ) {&nbsp;</div></li><li><div>                $titles = array();&nbsp;</div></li><li><div>                foreach ( $active_state as $mod ) {&nbsp;</div></li><li><div>                    if ( $mod_headers = Jetpack::get_module( $mod ) ) {&nbsp;</div></li><li><div>                        $titles[] = '&lt;strong&gt;' . preg_replace( '/\s+(?![^&lt;&gt;]++&gt;)/', '&nbsp;', $mod_headers['name'] ) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $titles ) {&nbsp;</div></li><li><div>                    $this-&gt;message .= '&lt;br /&gt;&lt;br /&gt;' . wp_sprintf( __( 'The following new modules have been activated: %l.', 'jetpack' ), $titles );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $reactive_state = Jetpack::state( 'reactivated_modules' ) ) {&nbsp;</div></li><li><div>                $titles = array();&nbsp;</div></li><li><div>                foreach ( explode( ', ', $reactive_state ) as $mod ) {&nbsp;</div></li><li><div>                    if ( $mod_headers = Jetpack::get_module( $mod ) ) {&nbsp;</div></li><li><div>                        $titles[] = '&lt;strong&gt;' . preg_replace( '/\s+(?![^&lt;&gt;]++&gt;)/', '&nbsp;', $mod_headers['name'] ) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $titles ) {&nbsp;</div></li><li><div>                    $this-&gt;message .= '&lt;br /&gt;&lt;br /&gt;' . wp_sprintf( __( 'The following modules have been updated: %l.', 'jetpack' ), $titles );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;message .= Jetpack::jetpack_comment_notice();&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'jetpack-manage':&nbsp;</div></li><li><div>            $this-&gt;message = '&lt;strong&gt;' . sprintf( __( 'You are all set! Your site can now be managed from &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;wordpress.com/sites&lt;/a&gt;.', 'jetpack' ), 'https://wordpress.com/sites' ) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>            if ( $activated_manage ) {&nbsp;</div></li><li><div>                $this-&gt;message .= '&lt;br /&gt;&lt;strong&gt;' . __( 'Manage has been activated for you!', 'jetpack' ) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        case 'module_activated' :&nbsp;</div></li><li><div>            if ( $module = Jetpack::get_module( Jetpack::state( 'module' ) ) ) {&nbsp;</div></li><li><div>                $this-&gt;message = sprintf( __( '&lt;strong&gt;%s Activated!&lt;/strong&gt; You can deactivate at any time by clicking the Deactivate link next to each module.', 'jetpack' ), $module['name'] );&nbsp;</div></li><li><div>                $this-&gt;stat( 'module-activated', Jetpack::state( 'module' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'module_deactivated' :&nbsp;</div></li><li><div>            $modules = Jetpack::state( 'module' );&nbsp;</div></li><li><div>            if ( ! $modules ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $module_names = array();&nbsp;</div></li><li><div>            foreach ( explode( ', ', $modules ) as $module_slug ) {&nbsp;</div></li><li><div>                $module = Jetpack::get_module( $module_slug );&nbsp;</div></li><li><div>                if ( $module ) {&nbsp;</div></li><li><div>                    $module_names[] = $module['name'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;stat( 'module-deactivated', $module_slug );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $module_names ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;message = wp_sprintf(&nbsp;</div></li><li><div>                _nx(&nbsp;</div></li><li><div>                    '&lt;strong&gt;%l Deactivated!&lt;/strong&gt; You can activate it again at any time using the activate link next to each module.', &nbsp;</div></li><li><div>                    '&lt;strong&gt;%l Deactivated!&lt;/strong&gt; You can activate them again at any time using the activate links next to each module.', &nbsp;</div></li><li><div>                    count( $module_names ), &nbsp;</div></li><li><div>                    '%l = list of Jetpack module/feature names', &nbsp;</div></li><li><div>                    'jetpack'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                $module_names&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'module_configured' :&nbsp;</div></li><li><div>            $this-&gt;message = __( '&lt;strong&gt;Module settings were saved.&lt;/strong&gt; ', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'already_authorized' :&nbsp;</div></li><li><div>            $this-&gt;message = __( '&lt;strong&gt;Your Jetpack is already connected.&lt;/strong&gt; ', 'jetpack' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'authorized' :&nbsp;</div></li><li><div>            $this-&gt;message = __( '&lt;strong&gt;You&#8217;re fueled up and ready to go, Jetpack is now active.&lt;/strong&gt; ', 'jetpack' );&nbsp;</div></li><li><div>            $this-&gt;message .= Jetpack::jetpack_comment_notice();&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'linked' :&nbsp;</div></li><li><div>            $this-&gt;message = __( '&lt;strong&gt;You&#8217;re fueled up and ready to go.&lt;/strong&gt; ', 'jetpack' );&nbsp;</div></li><li><div>            $this-&gt;message .= Jetpack::jetpack_comment_notice();&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'unlinked' :&nbsp;</div></li><li><div>            $user = wp_get_current_user();&nbsp;</div></li><li><div>            $this-&gt;message = sprintf( __( '&lt;strong&gt;You have unlinked your account (%s) from WordPress.com.&lt;/strong&gt;', 'jetpack' ), $user-&gt;user_login );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'switch_master' :&nbsp;</div></li><li><div>            global $current_user;&nbsp;</div></li><li><div>            $is_master_user = $current_user-&gt;ID == Jetpack_Options::get_option( 'master_user' );&nbsp;</div></li><li><div>            $master_userdata = get_userdata( Jetpack_Options::get_option( 'master_user' ) );&nbsp;</div></li><li><div>            if ( $is_master_user ) {&nbsp;</div></li><li><div>                $this-&gt;message = __( 'You have successfully set yourself as Jetpack*s primary user.', 'jetpack' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;message = sprintf( _x( 'You have successfully set %s as Jetpack*s primary user.', '%s is a username', 'jetpack' ), $master_userdata-&gt;user_login );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $deactivated_plugins = Jetpack::state( 'deactivated_plugins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $deactivated_plugins ) ) {&nbsp;</div></li><li><div>            $deactivated_plugins = explode( ', ', $deactivated_plugins );&nbsp;</div></li><li><div>            $deactivated_titles = array();&nbsp;</div></li><li><div>            foreach ( $deactivated_plugins as $deactivated_plugin ) {&nbsp;</div></li><li><div>                if ( ! isset( $this-&gt;plugins_to_deactivate[$deactivated_plugin] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $deactivated_titles[] = '&lt;strong&gt;' . str_replace( ' ', '&nbsp;', $this-&gt;plugins_to_deactivate[$deactivated_plugin][1] ) . '&lt;/strong&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $deactivated_titles ) {&nbsp;</div></li><li><div>                if ( $this-&gt;message ) {&nbsp;</div></li><li><div>                    $this-&gt;message .= &quot;&lt;br /&gt;&lt;br /&gt;\n&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;message .= wp_sprintf(&nbsp;</div></li><li><div>                    _n(&nbsp;</div></li><li><div>                        'Jetpack contains the most recent version of the old %l plugin.', &nbsp;</div></li><li><div>                        'Jetpack contains the most recent versions of the old %l plugins.', &nbsp;</div></li><li><div>                        count( $deactivated_titles ), &nbsp;</div></li><li><div>                        'jetpack'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    $deactivated_titles&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;message .= &quot;&lt;br /&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;message .= _n(&nbsp;</div></li><li><div>                    'The old version has been deactivated and can be removed from your site.', &nbsp;</div></li><li><div>                    'The old versions have been deactivated and can be removed from your site.', &nbsp;</div></li><li><div>                    count( $deactivated_titles ), &nbsp;</div></li><li><div>                    'jetpack'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;privacy_checks = Jetpack::state( 'privacy_checks' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;message || $this-&gt;error || $this-&gt;privacy_checks || $this-&gt;can_display_jetpack_manage_notice() ) {&nbsp;</div></li><li><div>            add_action( 'jetpack_notices', array( $this, 'admin_notices' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['configure'] ) && Jetpack::is_module( $_GET['configure'] ) && current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires when a module configuration page is loaded.&nbsp;</div></li><li><div>             * The dynamic part of the hook is the configure parameter from the URL.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 1.1.0&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'jetpack_module_configuration_load_' . $_GET['configure'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'jetpack_short_module_description', 'wptexturize' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function admin_notices() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;error ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;message&quot; class=&quot;jetpack-message jetpack-err&quot;&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;squeezer&quot;&gt;&nbsp;</div></li><li><div>        &lt;h4&gt;&lt;?php echo wp_kses( $this-&gt;error, array( 'code' =&gt; true, 'strong' =&gt; true, 'br' =&gt; true, 'b' =&gt; true ) ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>&lt;?php    if ( $desc = Jetpack::state( 'error_description' ) ) : ?&gt;&nbsp;</div></li><li><div>        &lt;p&gt;&lt;?php echo esc_html( stripslashes( $desc ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php    endif; ?&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;message ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;message&quot; class=&quot;jetpack-message&quot;&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;squeezer&quot;&gt;&nbsp;</div></li><li><div>        &lt;h4&gt;&lt;?php echo wp_kses( $this-&gt;message, array( 'strong' =&gt; array(), 'a' =&gt; array( 'href' =&gt; true ), 'br' =&gt; true ) ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;privacy_checks ) :&nbsp;</div></li><li><div>            $module_names = $module_slugs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $privacy_checks = explode( ', ', $this-&gt;privacy_checks );&nbsp;</div></li><li><div>            $privacy_checks = array_filter( $privacy_checks, array( 'Jetpack', 'is_module' ) );&nbsp;</div></li><li><div>            foreach ( $privacy_checks as $module_slug ) {&nbsp;</div></li><li><div>                $module = Jetpack::get_module( $module_slug );&nbsp;</div></li><li><div>                if ( ! $module ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $module_slugs[] = $module_slug;&nbsp;</div></li><li><div>                $module_names[] = &quot;&lt;strong&gt;{$module['name']}&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $module_slugs = join( ', ', $module_slugs );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;message&quot; class=&quot;jetpack-message jetpack-err&quot;&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;squeezer&quot;&gt;&nbsp;</div></li><li><div>        &lt;h4&gt;&lt;strong&gt;&lt;?php esc_html_e( 'Is this site private?', 'jetpack' ); ?&gt;&lt;/strong&gt;&lt;/h4&gt;&lt;br /&gt;&nbsp;</div></li><li><div>        &lt;p&gt;&lt;?php&nbsp;</div></li><li><div>            echo wp_kses(&nbsp;</div></li><li><div>                wptexturize(&nbsp;</div></li><li><div>                    wp_sprintf(&nbsp;</div></li><li><div>                        _nx(&nbsp;</div></li><li><div>                            &quot;Like your site's RSS feeds, %l allows access to your posts and other content to third parties.&quot;, &nbsp;</div></li><li><div>                            &quot;Like your site's RSS feeds, %l allow access to your posts and other content to third parties.&quot;, &nbsp;</div></li><li><div>                            count( $privacy_checks ), &nbsp;</div></li><li><div>                            '%l = list of Jetpack module/feature names', &nbsp;</div></li><li><div>                            'jetpack'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        $module_names&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( 'strong' =&gt; true )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo &quot;\n&lt;br /&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo wp_kses(&nbsp;</div></li><li><div>                sprintf(&nbsp;</div></li><li><div>                    _nx(&nbsp;</div></li><li><div>                        'If your site is not publicly accessible, consider &lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot;&gt;deactivating this feature&lt;/a&gt;.', &nbsp;</div></li><li><div>                        'If your site is not publicly accessible, consider &lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot;&gt;deactivating these features&lt;/a&gt;.', &nbsp;</div></li><li><div>                        count( $privacy_checks ), &nbsp;</div></li><li><div>                        '%1$s = deactivation URL, %2$s = &quot;Deactivate {list of Jetpack module/feature names}', &nbsp;</div></li><li><div>                        'jetpack'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    wp_nonce_url(&nbsp;</div></li><li><div>                        Jetpack::admin_url(&nbsp;</div></li><li><div>                            array(&nbsp;</div></li><li><div>                                'page' =&gt; 'jetpack', &nbsp;</div></li><li><div>                                'action' =&gt; 'deactivate', &nbsp;</div></li><li><div>                                'module' =&gt; urlencode( $module_slugs ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        &quot;jetpack_deactivate-$module_slugs&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    esc_attr( wp_kses( wp_sprintf( _x( 'Deactivate %l', '%l = list of Jetpack module/feature names', 'jetpack' ), $module_names ), array() ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( 'a' =&gt; array( 'href' =&gt; true, 'title' =&gt; true ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php endif;&nbsp;</div></li><li><div>    // only display the notice if the other stuff is not there&nbsp;</div></li><li><div>    if( $this-&gt;can_display_jetpack_manage_notice() && !  $this-&gt;error && ! $this-&gt;message && ! $this-&gt;privacy_checks ) {&nbsp;</div></li><li><div>        if( isset( $_GET['page'] ) && 'jetpack' != $_GET['page'] )&nbsp;</div></li><li><div>            $this-&gt;opt_in_jetpack_manage_notice();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Record a stat for later output.  This will only currently output in the admin_footer.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function stat( $group, $detail ) {&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;stats[ $group ] ) )&nbsp;</div></li><li><div>            $this-&gt;stats[ $group ] = array();&nbsp;</div></li><li><div>        $this-&gt;stats[ $group ][] = $detail;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load stats pixels. $group is auto-prefixed with &quot;x_jetpack-&quot;&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function do_stats( $method = '' ) {&nbsp;</div></li><li><div>        if ( is_array( $this-&gt;stats ) && count( $this-&gt;stats ) ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;stats as $group =&gt; $stats ) {&nbsp;</div></li><li><div>                if ( is_array( $stats ) && count( $stats ) ) {&nbsp;</div></li><li><div>                    $args = array( &quot;x_jetpack-{$group}&quot; =&gt; implode( ', ', $stats ) );&nbsp;</div></li><li><div>                    if ( 'server_side' === $method ) {&nbsp;</div></li><li><div>                        self::do_server_side_stat( $args );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        echo '&lt;img src=&quot;' . esc_url( self::build_stats_url( $args ) ) . '&quot; width=&quot;1&quot; height=&quot;1&quot; style=&quot;display:none;&quot; /&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                unset( $this-&gt;stats[ $group ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Runs stats code for a one-off, server-side.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $args array|string The arguments to append to the URL. Should include `x_jetpack-{$group}={$stats}` or whatever we want to store.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool If it worked.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function do_server_side_stat( $args ) {&nbsp;</div></li><li><div>        $response = wp_remote_get( esc_url_raw( self::build_stats_url( $args ) ) );&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 200 !== wp_remote_retrieve_response_code( $response ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Builds the stats url.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $args array|string The arguments to append to the URL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string The URL to be pinged.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function build_stats_url( $args ) {&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'v' =&gt; 'wpcom2', &nbsp;</div></li><li><div>            'rand' =&gt; md5( mt_rand( 0, 999 ) . time() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the URL used as the Stats tracking pixel.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.3.2&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $url Base URL used as the Stats tracking pixel.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $base_url = apply_filters(&nbsp;</div></li><li><div>            'jetpack_stats_base_url', &nbsp;</div></li><li><div>            set_url_scheme( 'http://pixel.wp.com/g.gif' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $url = add_query_arg( $args, $base_url );&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function translate_current_user_to_role() {&nbsp;</div></li><li><div>        foreach ( $this-&gt;capability_translations as $role =&gt; $cap ) {&nbsp;</div></li><li><div>            if ( current_user_can( $role ) || current_user_can( $cap ) ) {&nbsp;</div></li><li><div>                return $role;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function translate_role_to_cap( $role ) {&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;capability_translations[$role] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;capability_translations[$role];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sign_role( $role ) {&nbsp;</div></li><li><div>        if ( ! $user_id = (int) get_current_user_id() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token = Jetpack_Data::get_access_token();&nbsp;</div></li><li><div>        if ( ! $token || is_wp_error( $token ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $role . ':' . hash_hmac( 'md5', &quot;{$role}|{$user_id}&quot;, $token-&gt;secret );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function build_connect_url( $raw = false, $redirect = false ) {&nbsp;</div></li><li><div>        if ( ! Jetpack_Options::get_option( 'blog_token' ) || ! Jetpack_Options::get_option( 'id' ) ) {&nbsp;</div></li><li><div>            $url = Jetpack::nonce_url_no_esc( Jetpack::admin_url( 'action=register' ), 'jetpack-register' );&nbsp;</div></li><li><div>            if( is_network_admin() ) {&nbsp;</div></li><li><div>                $url = add_query_arg( 'is_multisite', network_admin_url(&nbsp;</div></li><li><div>                'admin.php?page=jetpack-settings' ), $url );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $role = $this-&gt;translate_current_user_to_role();&nbsp;</div></li><li><div>            $signed_role = $this-&gt;sign_role( $role );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user = wp_get_current_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $redirect = $redirect ? esc_url_raw( $redirect ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( isset( $_REQUEST['is_multisite'] ) ) {&nbsp;</div></li><li><div>                $redirect = Jetpack_Network::init()-&gt;get_url( 'network_admin_page' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = urlencode_deep(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'response_type' =&gt; 'code', &nbsp;</div></li><li><div>                    'client_id' =&gt; Jetpack_Options::get_option( 'id' ), &nbsp;</div></li><li><div>                    'redirect_uri' =&gt; add_query_arg(&nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'action' =&gt; 'authorize', &nbsp;</div></li><li><div>                            '_wpnonce' =&gt; wp_create_nonce( &quot;jetpack-authorize_{$role}_{$redirect}&quot; ), &nbsp;</div></li><li><div>                            'redirect' =&gt; $redirect ? urlencode( $redirect ) : false, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        menu_page_url( 'jetpack', false )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    'state' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>                    'scope' =&gt; $signed_role, &nbsp;</div></li><li><div>                    'user_email' =&gt; $user-&gt;user_email, &nbsp;</div></li><li><div>                    'user_login' =&gt; $user-&gt;user_login, &nbsp;</div></li><li><div>                    'is_active' =&gt; Jetpack::is_active(), &nbsp;</div></li><li><div>                    'jp_version' =&gt; JETPACK__VERSION, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $url = add_query_arg( $args, Jetpack::api_url( 'authorize' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $raw ? $url : esc_url( $url );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function build_reconnect_url( $raw = false ) {&nbsp;</div></li><li><div>        $url = wp_nonce_url( Jetpack::admin_url( 'action=reconnect' ), 'jetpack-reconnect' );&nbsp;</div></li><li><div>        return $raw ? $url : esc_url( $url );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function admin_url( $args = null ) {&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, array( 'page' =&gt; 'jetpack' ) );&nbsp;</div></li><li><div>        $url = add_query_arg( $args, admin_url( 'admin.php' ) );&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function nonce_url_no_esc( $actionurl, $action = -1, $name = '_wpnonce' ) {&nbsp;</div></li><li><div>        $actionurl = str_replace( '&amp;', '&', $actionurl );&nbsp;</div></li><li><div>        return add_query_arg( $name, wp_create_nonce( $action ), $actionurl );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function dismiss_jetpack_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_GET['jetpack-notice'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $_GET['jetpack-notice'] ) {&nbsp;</div></li><li><div>            case 'dismiss':&nbsp;</div></li><li><div>                if ( check_admin_referer( 'jetpack-deactivate' ) && ! is_plugin_active_for_network( plugin_basename( JETPACK__PLUGIN_DIR . 'jetpack.php' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    require_once ABSPATH . 'wp-admin/includes/plugin.php';&nbsp;</div></li><li><div>                    deactivate_plugins( JETPACK__PLUGIN_DIR . 'jetpack.php', false, false );&nbsp;</div></li><li><div>                    wp_safe_redirect( admin_url() . 'plugins.php?deactivate=true&plugin_status=all&paged=1&s=' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack-manage-opt-out':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( check_admin_referer( 'jetpack_manage_banner_opt_out' ) ) {&nbsp;</div></li><li><div>                    // Don't show the banner again&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    Jetpack_Options::update_option( 'dismissed_manage_banner', true );&nbsp;</div></li><li><div>                    // redirect back to the page that had the notice&nbsp;</div></li><li><div>                    if ( wp_get_referer() ) {&nbsp;</div></li><li><div>                        wp_safe_redirect( wp_get_referer() );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // Take me to Jetpack&nbsp;</div></li><li><div>                        wp_safe_redirect( admin_url( 'admin.php?page=jetpack' ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack-protect-multisite-opt-out':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( check_admin_referer( 'jetpack_protect_multisite_banner_opt_out' ) ) {&nbsp;</div></li><li><div>                    // Don't show the banner again&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    update_site_option( 'jetpack_dismissed_protect_multisite_banner', true );&nbsp;</div></li><li><div>                    // redirect back to the page that had the notice&nbsp;</div></li><li><div>                    if ( wp_get_referer() ) {&nbsp;</div></li><li><div>                        wp_safe_redirect( wp_get_referer() );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // Take me to Jetpack&nbsp;</div></li><li><div>                        wp_safe_redirect( admin_url( 'admin.php?page=jetpack' ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'jetpack-manage-opt-in':&nbsp;</div></li><li><div>                if ( check_admin_referer( 'jetpack_manage_banner_opt_in' ) ) {&nbsp;</div></li><li><div>                    // This makes sure that we are redirect to jetpack home so that we can see the Success Message.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $redirection_url = Jetpack::admin_url();&nbsp;</div></li><li><div>                    remove_action( 'jetpack_pre_activate_module', array( Jetpack_Admin::init(), 'fix_redirect' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Don't redirect form the Jetpack Setting Page&nbsp;</div></li><li><div>                    $referer_parsed = parse_url ( wp_get_referer() );&nbsp;</div></li><li><div>                    // check that we do have a wp_get_referer and the query paramater is set orderwise go to the Jetpack Home&nbsp;</div></li><li><div>                    if ( isset( $referer_parsed['query'] ) && false !== strpos( $referer_parsed['query'], 'page=jetpack_modules' ) ) {&nbsp;</div></li><li><div>                        // Take the user to Jetpack home except when on the setting page&nbsp;</div></li><li><div>                        $redirection_url = wp_get_referer();&nbsp;</div></li><li><div>                        add_action( 'jetpack_pre_activate_module', array( Jetpack_Admin::init(), 'fix_redirect' ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // Also update the JSON API FULL MANAGEMENT Option&nbsp;</div></li><li><div>                    Jetpack::activate_module( 'manage', false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Special Message when option in.&nbsp;</div></li><li><div>                    Jetpack::state( 'optin-manage', 'true' );&nbsp;</div></li><li><div>                    // Activate the Module if not activated already&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Redirect properly&nbsp;</div></li><li><div>                    wp_safe_redirect( $redirection_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function debugger_page() {&nbsp;</div></li><li><div>        nocache_headers();&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            die( '-1' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        Jetpack_Debugger::jetpack_debug_display_handler();&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function admin_screen_configure_module( $module_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // User that doesn't have 'jetpack_configure_modules' will never end up here since Jetpack Landing Page woun't let them.&nbsp;</div></li><li><div>        if ( ! in_array( $module_id, Jetpack::get_active_modules() ) && current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            if ( has_action( 'display_activate_module_setting_' . $module_id ) ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires to diplay a custom module activation screen.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * To add a module actionation screen use Jetpack::module_configuration_activation_screen method.&nbsp;</div></li><li><div>                 * Example: Jetpack::module_configuration_activation_screen( 'manage', array( $this, 'manage_activate_screen' ) );&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @module manage&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.8.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param int $module_id Module ID.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'display_activate_module_setting_' . $module_id );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                self::display_activate_module_link( $module_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div id=&quot;jp-settings-screen&quot; style=&quot;position: relative&quot;&gt;&nbsp;</div></li><li><div>            &lt;h3&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                $module = Jetpack::get_module( $module_id );&nbsp;</div></li><li><div>                echo '&lt;a href=&quot;' . Jetpack::admin_url( 'page=jetpack_modules' ) . '&quot;&gt;' . __( 'Jetpack by WordPress.com', 'jetpack' ) . '&lt;/a&gt; &rarr; ';&nbsp;</div></li><li><div>                printf( __( 'Configure %s', 'jetpack' ), $module['name'] );&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;/h3&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires within the displayed message when a feature configuation is updated.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.4.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param int $module_id Module ID.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'jetpack_notices_update_settings', $module_id );&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires when a feature configuation screen is loaded.&nbsp;</div></li><li><div>                 * The dynamic part of the hook, $module_id, is the module ID.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 1.1.0&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( 'jetpack_module_configuration_screen_' . $module_id );&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Display link to activate the module to see the settings screen.&nbsp;</div></li><li><div>     * @param  string $module_id&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function display_activate_module_link( $module_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info =  Jetpack::get_module( $module_id );&nbsp;</div></li><li><div>        $extra = '';&nbsp;</div></li><li><div>        $activate_url = wp_nonce_url(&nbsp;</div></li><li><div>                Jetpack::admin_url(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'page' =&gt; 'jetpack', &nbsp;</div></li><li><div>                        'action' =&gt; 'activate', &nbsp;</div></li><li><div>                        'module' =&gt; $module_id, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                &quot;jetpack_activate-$module_id&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div class=&quot;wrap configure-module&quot;&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;jp-settings-screen&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                if ( $module_id == 'json-api' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $info['name'] = esc_html__( 'Activate Site Management and JSON API', 'jetpack' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $activate_url = Jetpack::init()-&gt;opt_in_jetpack_manage_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $info['description'] = sprintf( __( 'Manage your multiple Jetpack sites from our centralized dashboard at wordpress.com/sites. &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Learn more&lt;/a&gt;.', 'jetpack' ), 'http://jetpack.me/support/site-management' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // $extra = __( 'To use Site Management, you need to first activate JSON API to allow remote management of your site. ', 'jetpack' );&nbsp;</div></li><li><div>                } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;h3&gt;&lt;?php echo esc_html( $info['name'] ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;narrow&quot;&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;?php echo  $info['description']; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;?php if( $extra ) { ?&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;?php echo esc_html( $extra ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        if( wp_get_referer() ) {&nbsp;</div></li><li><div>                            printf( __( '&lt;a class=&quot;button-primary&quot; href=&quot;%s&quot;&gt;Activate Now&lt;/a&gt; or &lt;a href=&quot;%s&quot; &gt;return to previous page&lt;/a&gt;.', 'jetpack' ) , $activate_url, wp_get_referer() );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            printf( __( '&lt;a class=&quot;button-primary&quot; href=&quot;%s&quot;&gt;Activate Now&lt;/a&gt;', 'jetpack' ) , $activate_url );&nbsp;</div></li><li><div>                        } ?&gt;&nbsp;</div></li><li><div>                    &lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function sort_modules( $a, $b ) {&nbsp;</div></li><li><div>        if ( $a['sort'] == $b['sort'] )&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ( $a['sort'] &lt; $b['sort'] ) ? -1 : 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sync_reindex_trigger() {&nbsp;</div></li><li><div>        if ( $this-&gt;current_user_is_connection_owner() && current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            echo json_encode( $this-&gt;sync-&gt;reindex_trigger() );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            echo '{&quot;status&quot;:&quot;ERROR&quot;}';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sync_reindex_status() {&nbsp;</div></li><li><div>        if ( $this-&gt;current_user_is_connection_owner() && current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>            echo json_encode( $this-&gt;sync-&gt;reindex_status() );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            echo '{&quot;status&quot;:&quot;ERROR&quot;}';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Client API */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the requested Jetpack API URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function api_url( $relative_url ) {&nbsp;</div></li><li><div>        return trailingslashit( JETPACK__API_BASE . $relative_url ) . JETPACK__API_VERSION . '/';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Some hosts disable the OpenSSL extension and so cannot make outgoing HTTPS requsets&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function fix_url_for_bad_hosts( $url ) {&nbsp;</div></li><li><div>        if ( 0 !== strpos( $url, 'https://' ) ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( JETPACK_CLIENT__HTTPS ) {&nbsp;</div></li><li><div>            case 'ALWAYS' :&nbsp;</div></li><li><div>                return $url;&nbsp;</div></li><li><div>            case 'NEVER' :&nbsp;</div></li><li><div>                return set_url_scheme( $url, 'http' );&nbsp;</div></li><li><div>            // default : case 'AUTO' :&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Yay! Your host is good!&nbsp;</div></li><li><div>        if ( self::permit_ssl() && wp_http_supports( array( 'ssl' =&gt; true ) ) ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Boo! Your host is bad and makes Jetpack cry!&nbsp;</div></li><li><div>        return set_url_scheme( $url, 'http' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks to see if the URL is using SSL to connect with Jetpack&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.3&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function permit_ssl( $force_recheck = false ) {&nbsp;</div></li><li><div>        // Do some fancy tests to see if ssl is being supported&nbsp;</div></li><li><div>        if ( $force_recheck || false === ( $ssl = get_transient( 'jetpack_https_test' ) ) ) {&nbsp;</div></li><li><div>            if ( 'https' !== substr( JETPACK__API_BASE, 0, 5 ) ) {&nbsp;</div></li><li><div>                $ssl = 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                switch ( JETPACK_CLIENT__HTTPS ) {&nbsp;</div></li><li><div>                    case 'NEVER':&nbsp;</div></li><li><div>                        $ssl = 0;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'ALWAYS':&nbsp;</div></li><li><div>                    case 'AUTO':&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $ssl = 1;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If it's not 'NEVER', test to see&nbsp;</div></li><li><div>                if ( $ssl ) {&nbsp;</div></li><li><div>                    $response = wp_remote_get( JETPACK__API_BASE . 'test/1/' );&nbsp;</div></li><li><div>                    if ( is_wp_error( $response ) || ( 'OK' !== wp_remote_retrieve_body( $response ) ) ) {&nbsp;</div></li><li><div>                        $ssl = 0;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            set_transient( 'jetpack_https_test', $ssl, DAY_IN_SECONDS );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return (bool) $ssl;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an admin_notice, alerting the user to their JETPACK_CLIENT__HTTPS constant being 'ALWAYS' but SSL isn't working.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function alert_required_ssl_fail() {&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_options' ) )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;error jetpack-message jp-identity-crisis&quot;&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;jp-banner__content&quot;&gt;&nbsp;</div></li><li><div>                &lt;h4&gt;&lt;?php _e( 'Something is being cranky!', 'jetpack' ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php _e( 'Your site is configured to only permit SSL connections to Jetpack, but SSL connections don\'t seem to be functional!', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the Jetpack XML-RPC API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function xmlrpc_api_url() {&nbsp;</div></li><li><div>        $base = preg_replace( '#(https?://[^?/]+)(/?.*)?$#', '\\1', JETPACK__API_BASE );&nbsp;</div></li><li><div>        return untrailingslashit( $base ) . '/xmlrpc.php';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates two secret tokens and the end of life timestamp for them.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note these tokens are unique per call, NOT static per site for connecting.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_secrets() {&nbsp;</div></li><li><div>        $secrets = array(&nbsp;</div></li><li><div>        wp_generate_password( 32, false ), // secret_1&nbsp;</div></li><li><div>        wp_generate_password( 32, false ), // secret_2&nbsp;</div></li><li><div>        ( time() + 600 ), // eol ( End of Life )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $secrets;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Builds the timeout limit for queries talking with the wpcom servers.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Based on local php max_execution_time in php.ini&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function get_remote_query_timeout_limit() {&nbsp;</div></li><li><div>        $timeout = (int) ini_get( 'max_execution_time' );&nbsp;</div></li><li><div>        if ( ! $timeout ) // Ensure exec time set in php.ini&nbsp;</div></li><li><div>        $timeout = 30;&nbsp;</div></li><li><div>        return intval( $timeout / 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Takes the response from the Jetpack register new site endpoint and&nbsp;</div></li><li><div>     * verifies it worked properly.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @return true or Jetpack_Error&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function validate_remote_register_response( $response ) {&nbsp;</div></li><li><div>            if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'register_http_request_failed', $response-&gt;get_error_message() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $code = wp_remote_retrieve_response_code( $response );&nbsp;</div></li><li><div>        $entity = wp_remote_retrieve_body( $response );&nbsp;</div></li><li><div>        if ( $entity )&nbsp;</div></li><li><div>            $json = json_decode( $entity );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $json = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $code_type = intval( $code / 100 );&nbsp;</div></li><li><div>        if ( 5 == $code_type ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'wpcom_5??', sprintf( __( 'Error Details: %s', 'jetpack' ), $code ), $code );&nbsp;</div></li><li><div>        } elseif ( 408 == $code ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'wpcom_408', sprintf( __( 'Error Details: %s', 'jetpack' ), $code ), $code );&nbsp;</div></li><li><div>        } elseif ( ! empty( $json-&gt;error ) ) {&nbsp;</div></li><li><div>            $error_description = isset( $json-&gt;error_description ) ? sprintf( __( 'Error Details: %s', 'jetpack' ), (string) $json-&gt;error_description ) : '';&nbsp;</div></li><li><div>            return new Jetpack_Error( (string) $json-&gt;error, $error_description, $code );&nbsp;</div></li><li><div>        } elseif ( 200 != $code ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'wpcom_bad_response', sprintf( __( 'Error Details: %s', 'jetpack' ), $code ), $code );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Jetpack ID error block&nbsp;</div></li><li><div>        if ( empty( $json-&gt;jetpack_id ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'jetpack_id', sprintf( __( 'Error Details: Jetpack ID is empty. Do not publicly post this error message! %s', 'jetpack' ), $entity ), $entity );&nbsp;</div></li><li><div>        } elseif ( ! is_scalar( $json-&gt;jetpack_id ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'jetpack_id', sprintf( __( 'Error Details: Jetpack ID is not a scalar. Do not publicly post this error message! %s', 'jetpack' ) , $entity ), $entity );&nbsp;</div></li><li><div>        } elseif ( preg_match( '/[^0-9]/', $json-&gt;jetpack_id ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'jetpack_id', sprintf( __( 'Error Details: Jetpack ID begins with a numeral. Do not publicly post this error message! %s', 'jetpack' ) , $entity ), $entity );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @return bool|WP_Error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function register() {&nbsp;</div></li><li><div>        add_action( 'pre_update_jetpack_option_register', array( 'Jetpack_Options', 'delete_option' ) );&nbsp;</div></li><li><div>        $secrets = Jetpack::init()-&gt;generate_secrets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'register', $secrets[0] . ':' . $secrets[1] . ':' . $secrets[2] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        @list( $secret_1, $secret_2, $secret_eol ) = explode( ':', Jetpack_Options::get_option( 'register' ) );&nbsp;</div></li><li><div>        if ( empty( $secret_1 ) || empty( $secret_2 ) || empty( $secret_eol ) || $secret_eol &lt; time() ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'missing_secrets' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $timeout = Jetpack::init()-&gt;get_remote_query_timeout_limit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gmt_offset = get_option( 'gmt_offset' );&nbsp;</div></li><li><div>        if ( ! $gmt_offset ) {&nbsp;</div></li><li><div>            $gmt_offset = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stats_options = get_option( 'stats_options' );&nbsp;</div></li><li><div>        $stats_id = isset($stats_options['blog_id']) ? $stats_options['blog_id'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'method' =&gt; 'POST', &nbsp;</div></li><li><div>            'body' =&gt; array(&nbsp;</div></li><li><div>                'siteurl' =&gt; site_url(), &nbsp;</div></li><li><div>                'home' =&gt; home_url(), &nbsp;</div></li><li><div>                'gmt_offset' =&gt; $gmt_offset, &nbsp;</div></li><li><div>                'timezone_string' =&gt; (string) get_option( 'timezone_string' ), &nbsp;</div></li><li><div>                'site_name' =&gt; (string) get_option( 'blogname' ), &nbsp;</div></li><li><div>                'secret_1' =&gt; $secret_1, &nbsp;</div></li><li><div>                'secret_2' =&gt; $secret_2, &nbsp;</div></li><li><div>                'site_lang' =&gt; get_locale(), &nbsp;</div></li><li><div>                'timeout' =&gt; $timeout, &nbsp;</div></li><li><div>                'stats_id' =&gt; $stats_id, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'headers' =&gt; array(&nbsp;</div></li><li><div>                'Accept' =&gt; 'application/json', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'timeout' =&gt; $timeout, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $response = Jetpack_Client::_wp_remote_request( Jetpack::fix_url_for_bad_hosts( Jetpack::api_url( 'register' ) ), $args, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure the response is valid and does not contain any Jetpack errors&nbsp;</div></li><li><div>        $valid_response = Jetpack::init()-&gt;validate_remote_register_response( $response );&nbsp;</div></li><li><div>        if( is_wp_error( $valid_response ) || !$valid_response ) {&nbsp;</div></li><li><div>            return $valid_response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Grab the response values to work with&nbsp;</div></li><li><div>        $code = wp_remote_retrieve_response_code( $response );&nbsp;</div></li><li><div>        $entity = wp_remote_retrieve_body( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $entity )&nbsp;</div></li><li><div>            $json = json_decode( $entity );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $json = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $json-&gt;jetpack_secret ) || ! is_string( $json-&gt;jetpack_secret ) )&nbsp;</div></li><li><div>            return new Jetpack_Error( 'jetpack_secret', '', $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $json-&gt;jetpack_public ) ) {&nbsp;</div></li><li><div>            $jetpack_public = (int) $json-&gt;jetpack_public;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $jetpack_public = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_options(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'id' =&gt; (int)    $json-&gt;jetpack_id, &nbsp;</div></li><li><div>                'blog_token' =&gt; (string) $json-&gt;jetpack_secret, &nbsp;</div></li><li><div>                'public' =&gt; $jetpack_public, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when a site is registered on WordPress.com.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.7.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $json-&gt;jetpack_id Jetpack Blog ID.&nbsp;</div></li><li><div>         * @param string $json-&gt;jetpack_secret Jetpack Blog Token.&nbsp;</div></li><li><div>         * @param int|bool $jetpack_public Is the site public.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_site_registered', $json-&gt;jetpack_id, $json-&gt;jetpack_secret, $jetpack_public );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initialize Jump Start for the first and only time.&nbsp;</div></li><li><div>        if ( ! Jetpack_Options::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'jumpstart', 'new_connection' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $jetpack-&gt;stat( 'jumpstart', 'unique-views' );&nbsp;</div></li><li><div>            $jetpack-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>        };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If the db version is showing something other that what we've got now, bump it to current.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool: True if the option was incorrect and updated, false if nothing happened.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function maybe_set_version_option() {&nbsp;</div></li><li><div>        list( $version ) = explode( ':', Jetpack_Options::get_option( 'version' ) );&nbsp;</div></li><li><div>        if ( JETPACK__VERSION != $version ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'version', JETPACK__VERSION . ':' . time() );&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Client Server API */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads the Jetpack XML-RPC client&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_xml_rpc_client() {&nbsp;</div></li><li><div>        require_once ABSPATH . WPINC . '/class-IXR.php';&nbsp;</div></li><li><div>        require_once JETPACK__PLUGIN_DIR . 'class.jetpack-ixr-client.php';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function verify_xml_rpc_signature() {&nbsp;</div></li><li><div>        if ( $this-&gt;xmlrpc_verification ) {&nbsp;</div></li><li><div>            return $this-&gt;xmlrpc_verification;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // It's not for us&nbsp;</div></li><li><div>        if ( ! isset( $_GET['token'] ) || empty( $_GET['signature'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        @list( $token_key, $version, $user_id ) = explode( ':', $_GET['token'] );&nbsp;</div></li><li><div>        if (&nbsp;</div></li><li><div>            empty( $token_key )&nbsp;</div></li><li><div>        ||&nbsp;</div></li><li><div>            empty( $version ) || strval( JETPACK__API_VERSION ) !== $version&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '0' === $user_id ) {&nbsp;</div></li><li><div>            $token_type = 'blog';&nbsp;</div></li><li><div>            $user_id = 0;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $token_type = 'user';&nbsp;</div></li><li><div>            if ( empty( $user_id ) || ! ctype_digit( $user_id ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $user_id = (int) $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user = new WP_User( $user_id );&nbsp;</div></li><li><div>            if ( ! $user || ! $user-&gt;exists() ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token = Jetpack_Data::get_access_token( $user_id );&nbsp;</div></li><li><div>        if ( ! $token ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token_check = &quot;$token_key.&quot;;&nbsp;</div></li><li><div>        if ( ! hash_equals( substr( $token-&gt;secret, 0, strlen( $token_check ) ), $token_check ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once JETPACK__PLUGIN_DIR . 'class.jetpack-signature.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_signature = new Jetpack_Signature( $token-&gt;secret, (int) Jetpack_Options::get_option( 'time_diff' ) );&nbsp;</div></li><li><div>        if ( isset( $_POST['_jetpack_is_multipart'] ) ) {&nbsp;</div></li><li><div>            $post_data = $_POST;&nbsp;</div></li><li><div>            $file_hashes = array();&nbsp;</div></li><li><div>            foreach ( $post_data as $post_data_key =&gt; $post_data_value ) {&nbsp;</div></li><li><div>                if ( 0 !== strpos( $post_data_key, '_jetpack_file_hmac_' ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $post_data_key = substr( $post_data_key, strlen( '_jetpack_file_hmac_' ) );&nbsp;</div></li><li><div>                $file_hashes[$post_data_key] = $post_data_value;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $file_hashes as $post_data_key =&gt; $post_data_value ) {&nbsp;</div></li><li><div>                unset( $post_data[&quot;_jetpack_file_hmac_{$post_data_key}&quot;] );&nbsp;</div></li><li><div>                $post_data[$post_data_key] = $post_data_value;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ksort( $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $body = http_build_query( stripslashes_deep( $post_data ) );&nbsp;</div></li><li><div>        } elseif ( is_null( $this-&gt;HTTP_RAW_POST_DATA ) ) {&nbsp;</div></li><li><div>            $body = file_get_contents( 'php://input' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $body = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $signature = $jetpack_signature-&gt;sign_current_request(&nbsp;</div></li><li><div>            array( 'body' =&gt; is_null( $body ) ? $this-&gt;HTTP_RAW_POST_DATA : $body, )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $signature ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else if ( is_wp_error( $signature ) ) {&nbsp;</div></li><li><div>            return $signature;&nbsp;</div></li><li><div>        } else if ( ! hash_equals( $signature, $_GET['signature'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $timestamp = (int) $_GET['timestamp'];&nbsp;</div></li><li><div>        $nonce = stripslashes( (string) $_GET['nonce'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;add_nonce( $timestamp, $nonce ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;xmlrpc_verification = array(&nbsp;</div></li><li><div>            'type' =&gt; $token_type, &nbsp;</div></li><li><div>            'user_id' =&gt; $token-&gt;external_user_id, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;xmlrpc_verification;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Authenticates XML-RPC and other requests from the Jetpack Server&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function authenticate_jetpack( $user, $username, $password ) {&nbsp;</div></li><li><div>        if ( is_a( $user, 'WP_User' ) ) {&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token_details = $this-&gt;verify_xml_rpc_signature();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $token_details || is_wp_error( $token_details ) ) {&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'user' !== $token_details['type'] ) {&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $token_details['user_id'] ) {&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        nocache_headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_User( $token_details['user_id'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add_nonce( $timestamp, $nonce ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        static $nonces_used_this_request = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $nonces_used_this_request[&quot;$timestamp:$nonce&quot;] ) ) {&nbsp;</div></li><li><div>            return $nonces_used_this_request[&quot;$timestamp:$nonce&quot;];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // This should always have gone through Jetpack_Signature::sign_request() first to check $timestamp an $nonce&nbsp;</div></li><li><div>        $timestamp = (int) $timestamp;&nbsp;</div></li><li><div>        $nonce = esc_sql( $nonce );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Raw query so we can avoid races: add_option will also update&nbsp;</div></li><li><div>        $show_errors = $wpdb-&gt;show_errors( false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $old_nonce = $wpdb-&gt;get_row(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare( &quot;SELECT * FROM `$wpdb-&gt;options` WHERE option_name = %s&quot;, &quot;jetpack_nonce_{$timestamp}_{$nonce}&quot; )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_null( $old_nonce ) ) {&nbsp;</div></li><li><div>            $return = $wpdb-&gt;query(&nbsp;</div></li><li><div>                $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                    &quot;INSERT INTO `$wpdb-&gt;options` (`option_name`, `option_value`, `autoload`) VALUES (%s, %s, %s)&quot;, &nbsp;</div></li><li><div>                    &quot;jetpack_nonce_{$timestamp}_{$nonce}&quot;, &nbsp;</div></li><li><div>                    time(), &nbsp;</div></li><li><div>                    'no'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $return = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;show_errors( $show_errors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $nonces_used_this_request[&quot;$timestamp:$nonce&quot;] = $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * In some setups, $HTTP_RAW_POST_DATA can be emptied during some IXR_Server paths since it is passed by reference to various methods.&nbsp;</div></li><li><div>     * Capture it here so we can verify the signature later.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function xmlrpc_methods( $methods ) {&nbsp;</div></li><li><div>        $this-&gt;HTTP_RAW_POST_DATA = $GLOBALS['HTTP_RAW_POST_DATA'];&nbsp;</div></li><li><div>        return $methods;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function public_xmlrpc_methods( $methods ) {&nbsp;</div></li><li><div>        if ( array_key_exists( 'wp.getOptions', $methods ) ) {&nbsp;</div></li><li><div>            $methods['wp.getOptions'] = array( $this, 'jetpack_getOptions' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $methods;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function jetpack_getOptions( $args ) {&nbsp;</div></li><li><div>        global $wp_xmlrpc_server;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_xmlrpc_server-&gt;escape( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $username = $args[1];&nbsp;</div></li><li><div>        $password = $args[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$user = $wp_xmlrpc_server-&gt;login($username, $password) ) {&nbsp;</div></li><li><div>            return $wp_xmlrpc_server-&gt;error;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options = array();&nbsp;</div></li><li><div>        $user_data = $this-&gt;get_connected_user_data();&nbsp;</div></li><li><div>        if ( is_array( $user_data ) ) {&nbsp;</div></li><li><div>            $options['jetpack_user_id'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'The WP.com user ID of the connected user', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; $user_data['ID'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $options['jetpack_user_login'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'The WP.com username of the connected user', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; $user_data['login'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $options['jetpack_user_email'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'The WP.com user email of the connected user', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; $user_data['email'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $options['jetpack_user_site_count'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'The number of sites of the connected WP.com user', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; $user_data['site_count'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $wp_xmlrpc_server-&gt;blog_options = array_merge( $wp_xmlrpc_server-&gt;blog_options, $options );&nbsp;</div></li><li><div>        $args = stripslashes_deep( $args );&nbsp;</div></li><li><div>        return $wp_xmlrpc_server-&gt;wp_getOptions( $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function xmlrpc_options( $options ) {&nbsp;</div></li><li><div>        $jetpack_client_id = false;&nbsp;</div></li><li><div>        if ( self::is_active() ) {&nbsp;</div></li><li><div>            $jetpack_client_id = Jetpack_Options::get_option( 'id' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $options['jetpack_version'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'Jetpack Plugin Version', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; JETPACK__VERSION, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options['jetpack_client_id'] = array(&nbsp;</div></li><li><div>                'desc' =&gt; __( 'The Client ID/WP.com Blog ID of this site', 'jetpack' ), &nbsp;</div></li><li><div>                'readonly' =&gt; true, &nbsp;</div></li><li><div>                'value' =&gt; $jetpack_client_id, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return $options;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function clean_nonces( $all = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;DELETE FROM `$wpdb-&gt;options` WHERE `option_name` LIKE %s&quot;;&nbsp;</div></li><li><div>        if ( method_exists ( $wpdb , 'esc_like' ) ) {&nbsp;</div></li><li><div>            $sql_args = array( $wpdb-&gt;esc_like( 'jetpack_nonce_' ) . '%' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sql_args = array( like_escape( 'jetpack_nonce_' ) . '%' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( true !== $all ) {&nbsp;</div></li><li><div>            $sql .= ' AND CAST( `option_value` AS UNSIGNED ) &lt; %d';&nbsp;</div></li><li><div>            $sql_args[] = time() - 3600;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql .= ' ORDER BY `option_id` LIMIT 100';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( $sql, $sql_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        for ( $i = 0; $i &lt; 1000; $i++ ) {&nbsp;</div></li><li><div>            if ( ! $wpdb-&gt;query( $sql ) ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * State is passed via cookies from one request to the next, but never to subsequent requests.&nbsp;</div></li><li><div>     * SET: state( $key, $value );&nbsp;</div></li><li><div>     * GET: $value = state( $key );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key&nbsp;</div></li><li><div>     * @param string $value&nbsp;</div></li><li><div>     * @param bool $restate private&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function state( $key = null, $value = null, $restate = false ) {&nbsp;</div></li><li><div>        static $state = array();&nbsp;</div></li><li><div>        static $path, $domain;&nbsp;</div></li><li><div>        if ( ! isset( $path ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/plugin.php' );&nbsp;</div></li><li><div>            $admin_url = Jetpack::admin_url();&nbsp;</div></li><li><div>            $bits = parse_url( $admin_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $bits ) ) {&nbsp;</div></li><li><div>                $path = ( isset( $bits['path'] ) ) ? dirname( $bits['path'] ) : null;&nbsp;</div></li><li><div>                $domain = ( isset( $bits['host'] ) ) ? $bits['host'] : null;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $path = $domain = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Extract state from cookies and delete cookies&nbsp;</div></li><li><div>        if ( isset( $_COOKIE[ 'jetpackState' ] ) && is_array( $_COOKIE[ 'jetpackState' ] ) ) {&nbsp;</div></li><li><div>            $yum = $_COOKIE[ 'jetpackState' ];&nbsp;</div></li><li><div>            unset( $_COOKIE[ 'jetpackState' ] );&nbsp;</div></li><li><div>            foreach ( $yum as $k =&gt; $v ) {&nbsp;</div></li><li><div>                if ( strlen( $v ) )&nbsp;</div></li><li><div>                    $state[ $k ] = $v;&nbsp;</div></li><li><div>                setcookie( &quot;jetpackState[$k]&quot;, false, 0, $path, $domain );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $restate ) {&nbsp;</div></li><li><div>            foreach ( $state as $k =&gt; $v ) {&nbsp;</div></li><li><div>                setcookie( &quot;jetpackState[$k]&quot;, $v, 0, $path, $domain );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get a state variable&nbsp;</div></li><li><div>        if ( isset( $key ) && ! isset( $value ) ) {&nbsp;</div></li><li><div>            if ( array_key_exists( $key, $state ) )&nbsp;</div></li><li><div>                return $state[ $key ];&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set a state variable&nbsp;</div></li><li><div>        if ( isset ( $key ) && isset( $value ) ) {&nbsp;</div></li><li><div>            if( is_array( $value ) && isset( $value[0] ) ) {&nbsp;</div></li><li><div>                $value = $value[0];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $state[ $key ] = $value;&nbsp;</div></li><li><div>            setcookie( &quot;jetpackState[$key]&quot;, $value, 0, $path, $domain );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function restate() {&nbsp;</div></li><li><div>        Jetpack::state( null, null, true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function check_privacy( $file ) {&nbsp;</div></li><li><div>        static $is_site_publicly_accessible = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_null( $is_site_publicly_accessible ) ) {&nbsp;</div></li><li><div>            $is_site_publicly_accessible = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>            $rpc = new Jetpack_IXR_Client();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $success = $rpc-&gt;query( 'jetpack.isSitePubliclyAccessible', home_url() );&nbsp;</div></li><li><div>            if ( $success ) {&nbsp;</div></li><li><div>                $response = $rpc-&gt;getResponse();&nbsp;</div></li><li><div>                if ( $response ) {&nbsp;</div></li><li><div>                    $is_site_publicly_accessible = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'public', (int) $is_site_publicly_accessible );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_site_publicly_accessible ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $module_slug = self::get_module_slug( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $privacy_checks = Jetpack::state( 'privacy_checks' );&nbsp;</div></li><li><div>        if ( ! $privacy_checks ) {&nbsp;</div></li><li><div>            $privacy_checks = $module_slug;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $privacy_checks .= &quot;, $module_slug&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::state( 'privacy_checks', $privacy_checks );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method for multicall XMLRPC.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function xmlrpc_async_call() {&nbsp;</div></li><li><div>        global $blog_id;&nbsp;</div></li><li><div>        static $clients = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $client_blog_id = is_multisite() ? $blog_id : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $clients[$client_blog_id] ) ) {&nbsp;</div></li><li><div>            Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>            $clients[$client_blog_id] = new Jetpack_IXR_ClientMulticall( array( 'user_id' =&gt; JETPACK_MASTER_USER, ) );&nbsp;</div></li><li><div>            if ( function_exists( 'ignore_user_abort' ) ) {&nbsp;</div></li><li><div>                ignore_user_abort( true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            add_action( 'shutdown', array( 'Jetpack', 'xmlrpc_async_call' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args[0] ) ) {&nbsp;</div></li><li><div>            call_user_func_array( array( $clients[$client_blog_id], 'addCall' ), $args );&nbsp;</div></li><li><div>        } elseif ( is_multisite() ) {&nbsp;</div></li><li><div>            foreach ( $clients as $client_blog_id =&gt; $client ) {&nbsp;</div></li><li><div>                if ( ! $client_blog_id || empty( $client-&gt;calls ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $switch_success = switch_to_blog( $client_blog_id, true );&nbsp;</div></li><li><div>                if ( ! $switch_success ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                flush();&nbsp;</div></li><li><div>                $client-&gt;query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                restore_current_blog();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( isset( $clients[0] ) && ! empty( $clients[0]-&gt;calls ) ) {&nbsp;</div></li><li><div>                flush();&nbsp;</div></li><li><div>                $clients[0]-&gt;query();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function staticize_subdomain( $url ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Extract hostname from URL&nbsp;</div></li><li><div>        $host = parse_url( $url, PHP_URL_HOST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Explode hostname on '.'&nbsp;</div></li><li><div>        $exploded_host = explode( '.', $host );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Retrieve the name and TLD&nbsp;</div></li><li><div>        if ( count( $exploded_host ) &gt; 1 ) {&nbsp;</div></li><li><div>            $name = $exploded_host[ count( $exploded_host ) - 2 ];&nbsp;</div></li><li><div>            $tld = $exploded_host[ count( $exploded_host ) - 1 ];&nbsp;</div></li><li><div>            // Rebuild domain excluding subdomains&nbsp;</div></li><li><div>            $domain = $name . '.' . $tld;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $domain = $host;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Array of Automattic domains&nbsp;</div></li><li><div>        $domain_whitelist = array( 'wordpress.com', 'wp.com' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return $url if not an Automattic domain&nbsp;</div></li><li><div>        if ( ! in_array( $domain, $domain_whitelist ) ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_ssl() ) {&nbsp;</div></li><li><div>            return preg_replace( '|https?://[^/]++/|', 'https://s-ssl.wordpress.com/', $url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        srand( crc32( basename( $url ) ) );&nbsp;</div></li><li><div>        $static_counter = rand( 0, 2 );&nbsp;</div></li><li><div>        srand(); // this resets everything that relies on this, like array_rand() and shuffle()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return preg_replace( '|://[^/]+?/|', &quot;://s$static_counter.wp.com/&quot;, $url );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** JSON API Authorization */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles the login action for Authorizing the JSON API&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function login_form_json_api_authorization() {&nbsp;</div></li><li><div>        $this-&gt;verify_json_api_authorization_request();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_login', array( &$this, 'store_json_api_authorization_token' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'login_message', array( &$this, 'login_message_json_api_authorization' ) );&nbsp;</div></li><li><div>        add_action( 'login_form', array( &$this, 'preserve_action_in_login_form_for_json_api_authorization' ) );&nbsp;</div></li><li><div>        add_filter( 'site_url', array( &$this, 'post_login_form_to_signed_url' ), 10, 3 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Make sure the login form is POSTed to the signed URL so we can reverify the request&nbsp;</div></li><li><div>    function post_login_form_to_signed_url( $url, $path, $scheme ) {&nbsp;</div></li><li><div>        if ( 'wp-login.php' !== $path || 'login_post' !== $scheme ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $parsed_url = parse_url( $url );&nbsp;</div></li><li><div>        $url = strtok( $url, '?' );&nbsp;</div></li><li><div>        $url = &quot;$url?{$_SERVER['QUERY_STRING']}&quot;;&nbsp;</div></li><li><div>        if ( ! empty( $parsed_url['query'] ) )&nbsp;</div></li><li><div>            $url .= &quot;&{$parsed_url['query']}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Make sure the POSTed request is handled by the same action&nbsp;</div></li><li><div>    function preserve_action_in_login_form_for_json_api_authorization() {&nbsp;</div></li><li><div>        echo &quot;&lt;input type='hidden' name='action' value='jetpack_json_api_authorization' /&gt;\n&quot;;&nbsp;</div></li><li><div>        echo &quot;&lt;input type='hidden' name='jetpack_json_api_original_query' value='&quot; . esc_url( set_url_scheme( $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] ) ) . &quot;' /&gt;\n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // If someone logs in to approve API access, store the Access Code in usermeta&nbsp;</div></li><li><div>    function store_json_api_authorization_token( $user_login, $user ) {&nbsp;</div></li><li><div>        add_filter( 'login_redirect', array( &$this, 'add_token_to_login_redirect_json_api_authorization' ), 10, 3 );&nbsp;</div></li><li><div>        add_filter( 'allowed_redirect_hosts', array( &$this, 'allow_wpcom_public_api_domain' ) );&nbsp;</div></li><li><div>        $token = wp_generate_password( 32, false );&nbsp;</div></li><li><div>        update_user_meta( $user-&gt;ID, 'jetpack_json_api_' . $this-&gt;json_api_authorization_request['client_id'], $token );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Add public-api.wordpress.com to the safe redirect whitelist - only added when someone allows API access&nbsp;</div></li><li><div>    function allow_wpcom_public_api_domain( $domains ) {&nbsp;</div></li><li><div>        $domains[] = 'public-api.wordpress.com';&nbsp;</div></li><li><div>        return $domains;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Add the Access Code details to the public-api.wordpress.com redirect&nbsp;</div></li><li><div>    function add_token_to_login_redirect_json_api_authorization( $redirect_to, $original_redirect_to, $user ) {&nbsp;</div></li><li><div>        return add_query_arg(&nbsp;</div></li><li><div>            urlencode_deep(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'jetpack-code' =&gt; get_user_meta( $user-&gt;ID, 'jetpack_json_api_' . $this-&gt;json_api_authorization_request['client_id'], true ), &nbsp;</div></li><li><div>                    'jetpack-user-id' =&gt; (int) $user-&gt;ID, &nbsp;</div></li><li><div>                    'jetpack-state' =&gt; $this-&gt;json_api_authorization_request['state'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            $redirect_to&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Verifies the request by checking the signature&nbsp;</div></li><li><div>    function verify_json_api_authorization_request() {&nbsp;</div></li><li><div>        require_once JETPACK__PLUGIN_DIR . 'class.jetpack-signature.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $token = Jetpack_Data::get_access_token( JETPACK_MASTER_USER );&nbsp;</div></li><li><div>        if ( ! $token || empty( $token-&gt;secret ) ) {&nbsp;</div></li><li><div>            wp_die( __( 'You must connect your Jetpack plugin to WordPress.com to use this feature.' , 'jetpack' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $die_error = __( 'Someone may be trying to trick you into giving them access to your site.  Or it could be you just encountered a bug :).  Either way, please close this window.', 'jetpack' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack_signature = new Jetpack_Signature( $token-&gt;secret, (int) Jetpack_Options::get_option( 'time_diff' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_POST['jetpack_json_api_original_query'] ) ) {&nbsp;</div></li><li><div>            $signature = $jetpack_signature-&gt;sign_request( $_GET['token'], $_GET['timestamp'], $_GET['nonce'], '', 'GET', $_POST['jetpack_json_api_original_query'], null, true );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $signature = $jetpack_signature-&gt;sign_current_request( array( 'body' =&gt; null, 'method' =&gt; 'GET' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $signature ) {&nbsp;</div></li><li><div>            wp_die( $die_error );&nbsp;</div></li><li><div>        } else if ( is_wp_error( $signature ) ) {&nbsp;</div></li><li><div>            wp_die( $die_error );&nbsp;</div></li><li><div>        } else if ( $signature !== $_GET['signature'] ) {&nbsp;</div></li><li><div>            if ( is_ssl() ) {&nbsp;</div></li><li><div>                // If we signed an HTTP request on the Jetpack Servers, but got redirected to HTTPS by the local blog, check the HTTP signature as well&nbsp;</div></li><li><div>                $signature = $jetpack_signature-&gt;sign_current_request( array( 'scheme' =&gt; 'http', 'body' =&gt; null, 'method' =&gt; 'GET' ) );&nbsp;</div></li><li><div>                if ( ! $signature || is_wp_error( $signature ) || $signature !== $_GET['signature'] ) {&nbsp;</div></li><li><div>                    wp_die( $die_error );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_die( $die_error );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $timestamp = (int) $_GET['timestamp'];&nbsp;</div></li><li><div>        $nonce = stripslashes( (string) $_GET['nonce'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;add_nonce( $timestamp, $nonce ) ) {&nbsp;</div></li><li><div>            // De-nonce the nonce, at least for 5 minutes.&nbsp;</div></li><li><div>            // We have to reuse this nonce at least once (used the first time when the initial request is made, used a second time when the login form is POSTed)&nbsp;</div></li><li><div>            $old_nonce_time = get_option( &quot;jetpack_nonce_{$timestamp}_{$nonce}&quot; );&nbsp;</div></li><li><div>            if ( $old_nonce_time &lt; time() - 300 ) {&nbsp;</div></li><li><div>                wp_die( __( 'The authorization process expired.  Please go back and try again.' , 'jetpack' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = json_decode( base64_decode( stripslashes( $_GET['data'] ) ) );&nbsp;</div></li><li><div>        $data_filters = array(&nbsp;</div></li><li><div>            'state' =&gt; 'opaque', &nbsp;</div></li><li><div>            'client_id' =&gt; 'int', &nbsp;</div></li><li><div>            'client_title' =&gt; 'string', &nbsp;</div></li><li><div>            'client_image' =&gt; 'url', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $data_filters as $key =&gt; $sanitation ) {&nbsp;</div></li><li><div>            if ( ! isset( $data-&gt;$key ) ) {&nbsp;</div></li><li><div>                wp_die( $die_error );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $sanitation ) {&nbsp;</div></li><li><div>            case 'int' :&nbsp;</div></li><li><div>                $this-&gt;json_api_authorization_request[$key] = (int) $data-&gt;$key;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'opaque' :&nbsp;</div></li><li><div>                $this-&gt;json_api_authorization_request[$key] = (string) $data-&gt;$key;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'string' :&nbsp;</div></li><li><div>                $this-&gt;json_api_authorization_request[$key] = wp_kses( (string) $data-&gt;$key, array() );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'url' :&nbsp;</div></li><li><div>                $this-&gt;json_api_authorization_request[$key] = esc_url_raw( (string) $data-&gt;$key );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;json_api_authorization_request['client_id'] ) ) {&nbsp;</div></li><li><div>            wp_die( $die_error );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function login_message_json_api_authorization( $message ) {&nbsp;</div></li><li><div>        return '&lt;p class=&quot;message&quot;&gt;' . sprintf(&nbsp;</div></li><li><div>            esc_html__( '%s wants to access your site&#8217;s data.  Log in to authorize that access.' , 'jetpack' ), &nbsp;</div></li><li><div>            '&lt;strong&gt;' . esc_html( $this-&gt;json_api_authorization_request['client_title'] ) . '&lt;/strong&gt;'&nbsp;</div></li><li><div> ) . '&lt;img src=&quot;' . esc_url( $this-&gt;json_api_authorization_request['client_image'] ) . '&quot; /&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get $content_width, but with a &lt;s&gt;twist&lt;/s&gt; filter.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_content_width() {&nbsp;</div></li><li><div>        $content_width = isset( $GLOBALS['content_width'] ) ? $GLOBALS['content_width'] : false;&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Content Width value.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.2.3&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $content_width Content Width value.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_content_width', $content_width );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Centralize the function here until it gets added to core.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int|string|object $id_or_email A user ID, email address, or comment object&nbsp;</div></li><li><div>     * @param int $size Size of the avatar image&nbsp;</div></li><li><div>     * @param string $default URL to a default image to use if no avatar is available&nbsp;</div></li><li><div>     * @param bool $force_display Whether to force it to return an avatar even if show_avatars is disabled&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array First element is the URL, second is the class.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_avatar_url( $id_or_email, $size = 96, $default = '', $force_display = false ) {&nbsp;</div></li><li><div>        // Don't bother adding the __return_true filter if it's already there.&nbsp;</div></li><li><div>        $has_filter = has_filter( 'pre_option_show_avatars', '__return_true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force_display && ! $has_filter )&nbsp;</div></li><li><div>            add_filter( 'pre_option_show_avatars', '__return_true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $avatar = get_avatar( $id_or_email, $size, $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force_display && ! $has_filter )&nbsp;</div></li><li><div>            remove_filter( 'pre_option_show_avatars', '__return_true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If no data, fail out.&nbsp;</div></li><li><div>        if ( is_wp_error( $avatar ) || ! $avatar )&nbsp;</div></li><li><div>            return array( null, null );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Pull out the URL.  If it's not there, fail out.&nbsp;</div></li><li><div>        if ( ! preg_match( '/src=[&quot;\']([^&quot;\']+)[&quot;\']/', $avatar, $url_matches ) )&nbsp;</div></li><li><div>            return array( null, null );&nbsp;</div></li><li><div>        $url = wp_specialchars_decode( $url_matches[1], ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Pull out the class, but it's not a big deal if it's missing.&nbsp;</div></li><li><div>        $class = '';&nbsp;</div></li><li><div>        if ( preg_match( '/class=[&quot;\']([^&quot;\']+)[&quot;\']/', $avatar, $class_matches ) )&nbsp;</div></li><li><div>            $class = wp_specialchars_decode( $class_matches[1], ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( $url, $class );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Pings the WordPress.com Mirror Site for the specified options.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|array $option_names The option names to request from the WordPress.com Mirror Site&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array An associative array of the option values as stored in the WordPress.com Mirror Site&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_cloud_site_options( $option_names ) {&nbsp;</div></li><li><div>        $option_names = array_filter( (array) $option_names, 'is_string' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $xml = new Jetpack_IXR_Client( array( 'user_id' =&gt; JETPACK_MASTER_USER, ) );&nbsp;</div></li><li><div>        $xml-&gt;query( 'jetpack.fetchSiteOptions', $option_names );&nbsp;</div></li><li><div>        if ( $xml-&gt;isError() ) {&nbsp;</div></li><li><div>            return array(&nbsp;</div></li><li><div>                'error_code' =&gt; $xml-&gt;getErrorCode(), &nbsp;</div></li><li><div>                'error_msg' =&gt; $xml-&gt;getErrorMessage(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cloud_site_options = $xml-&gt;getResponse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $cloud_site_options;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Fetch the filtered array of options that we should compare to determine an identity crisis.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array An array of options to check.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function identity_crisis_options_to_check() {&nbsp;</div></li><li><div>        $options = array(&nbsp;</div></li><li><div>            'siteurl', &nbsp;</div></li><li><div>            'home', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the options that we should compare to determine an identity crisis.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $options Array of options to compare to determine an identity crisis.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_identity_crisis_options_to_check', $options );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks to make sure that local options have the same values as remote options.  Will cache the results for up to 24 hours.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $force_recheck Whether to ignore any cached transient and manually re-check.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array An array of options that do not match.  If everything is good, it will evaluate to false.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function check_identity_crisis( $force_recheck = false ) {&nbsp;</div></li><li><div>        if ( ! Jetpack::is_active() || Jetpack::is_development_mode() )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force_recheck || false === ( $errors = get_transient( 'jetpack_has_identity_crisis' ) ) ) {&nbsp;</div></li><li><div>            $options_to_check = self::identity_crisis_options_to_check();&nbsp;</div></li><li><div>            $cloud_options = Jetpack::init()-&gt;get_cloud_site_options( $options_to_check );&nbsp;</div></li><li><div>            $errors = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $cloud_options as $cloud_key =&gt; $cloud_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If it's not the same as the local value...&nbsp;</div></li><li><div>                if ( $cloud_value !== get_option( $cloud_key ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Break out if we're getting errors.  We are going to check the error keys later when we alert.&nbsp;</div></li><li><div>                    if ( 'error_code' == $cloud_key ) {&nbsp;</div></li><li><div>                        $errors[ $cloud_key ] = $cloud_value;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $parsed_cloud_value = parse_url( $cloud_value );&nbsp;</div></li><li><div>                    // If the current options is an IP address&nbsp;</div></li><li><div>                    if ( filter_var( $parsed_cloud_value['host'], FILTER_VALIDATE_IP ) ) {&nbsp;</div></li><li><div>                        // Give the new value a Jetpack to fly in to the clouds&nbsp;</div></li><li><div>                        Jetpack::resolve_identity_crisis( $cloud_key );&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // And it's not been added to the whitelist...&nbsp;</div></li><li><div>                    if ( ! self::is_identity_crisis_value_whitelisted( $cloud_key, $cloud_value ) ) {&nbsp;</div></li><li><div>                        /**&nbsp;</div></li><li><div>                         * This should be a temporary hack until a cleaner solution is found.&nbsp;</div></li><li><div>                         *&nbsp;</div></li><li><div>                         * The siteurl and home can be set to use http in General &gt; Settings&nbsp;</div></li><li><div>                         * however some constants can be defined that can force https in wp-admin&nbsp;</div></li><li><div>                         * when this happens wpcom can confuse wporg with a fake identity&nbsp;</div></li><li><div>                         * crisis with a mismatch of http vs https when it should be allowed.&nbsp;</div></li><li><div>                         * we need to check that here.&nbsp;</div></li><li><div>                         *&nbsp;</div></li><li><div>                         * @see https://github.com/Automattic/jetpack/issues/1006&nbsp;</div></li><li><div>                         */&nbsp;</div></li><li><div>                        if ( ( 'home' == $cloud_key || 'siteurl' == $cloud_key )&nbsp;</div></li><li><div>                            && ( substr( $cloud_value, 0, 8 ) == &quot;https://&quot; )&nbsp;</div></li><li><div>                            && Jetpack::init()-&gt;is_ssl_required_to_visit_site() ) {&nbsp;</div></li><li><div>                            // Ok, we found a mismatch of http and https because of wp-config, not an invalid url&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Then kick an error!&nbsp;</div></li><li><div>                        $errors[ $cloud_key ] = $cloud_value;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the errors returned when checking for an Identity Crisis.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.3.2&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $errors Array of Identity Crisis errors.&nbsp;</div></li><li><div>         * @param bool $force_recheck Ignore any cached transient and manually re-check. Default to false.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_has_identity_crisis', $errors, $force_recheck );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Resolve ID crisis&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If the URL has changed, but the rest of the options are the same (i.e. blog/user tokens)&nbsp;</div></li><li><div>     * The user has the option to update the shadow site with the new URL before a new&nbsp;</div></li><li><div>     * token is created.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $key : Which option to sync.  null defautlts to home and siteurl&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function resolve_identity_crisis( $key = null ) {&nbsp;</div></li><li><div>        if ( $key ) {&nbsp;</div></li><li><div>            $identity_options = array( $key );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $identity_options = self::identity_crisis_options_to_check();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $identity_options ) ) {&nbsp;</div></li><li><div>            foreach( $identity_options as $identity_option ) {&nbsp;</div></li><li><div>                Jetpack_Sync::sync_options( __FILE__, $identity_option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Fires when a shadow site option is updated.&nbsp;</div></li><li><div>                 * These options are updated via the Identity Crisis UI.&nbsp;</div></li><li><div>                 * $identity_option is the option that gets updated.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.7.0&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                do_action( &quot;update_option_{$identity_option}&quot; );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whitelist URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Ignore the URL differences between the blog and the shadow site.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function whitelist_current_url() {&nbsp;</div></li><li><div>        $options_to_check = Jetpack::identity_crisis_options_to_check();&nbsp;</div></li><li><div>        $cloud_options = Jetpack::init()-&gt;get_cloud_site_options( $options_to_check );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $cloud_options as $cloud_key =&gt; $cloud_value ) {&nbsp;</div></li><li><div>            Jetpack::whitelist_identity_crisis_value( $cloud_key, $cloud_value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ajax callbacks for ID crisis resolutions&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Things that could happen here:&nbsp;</div></li><li><div>     *  - site_migrated : Update the URL on the shadow blog to match new domain&nbsp;</div></li><li><div>     *  - whitelist     : Ignore the URL difference&nbsp;</div></li><li><div>     *  - default       : Error message&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function resolve_identity_crisis_ajax_callback() {&nbsp;</div></li><li><div>        check_ajax_referer( 'resolve-identity-crisis', 'ajax-nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $_POST[ 'crisis_resolution_action' ] ) {&nbsp;</div></li><li><div>            case 'site_migrated':&nbsp;</div></li><li><div>                Jetpack::resolve_identity_crisis();&nbsp;</div></li><li><div>                echo 'resolved';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'whitelist':&nbsp;</div></li><li><div>                Jetpack::whitelist_current_url();&nbsp;</div></li><li><div>                echo 'whitelisted';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'reset_connection':&nbsp;</div></li><li><div>                // Delete the options first so it doesn't get confused which site to disconnect dotcom-side&nbsp;</div></li><li><div>                Jetpack_Options::delete_option(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'register', &nbsp;</div></li><li><div>                        'blog_token', &nbsp;</div></li><li><div>                        'user_token', &nbsp;</div></li><li><div>                        'user_tokens', &nbsp;</div></li><li><div>                        'master_user', &nbsp;</div></li><li><div>                        'time_diff', &nbsp;</div></li><li><div>                        'fallback_no_verify_ssl_certs', &nbsp;</div></li><li><div>                        'id', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                delete_transient( 'jetpack_has_identity_crisis' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                echo 'reset-connection-success';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                echo 'missing action';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds a value to the whitelist for the specified key.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key The option name that we're whitelisting the value for.&nbsp;</div></li><li><div>     * @param string $value The value that we're intending to add to the whitelist.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool Whether the value was added to the whitelist, or false if it was already there.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function whitelist_identity_crisis_value( $key, $value ) {&nbsp;</div></li><li><div>        if ( Jetpack::is_identity_crisis_value_whitelisted( $key, $value ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $whitelist = Jetpack_Options::get_option( 'identity_crisis_whitelist', array() );&nbsp;</div></li><li><div>        if ( empty( $whitelist[ $key ] ) || ! is_array( $whitelist[ $key ] ) ) {&nbsp;</div></li><li><div>            $whitelist[ $key ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        array_push( $whitelist[ $key ], $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'identity_crisis_whitelist', $whitelist );&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks whether a value is already whitelisted.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key The option name that we're checking the value for.&nbsp;</div></li><li><div>     * @param string $value The value that we're curious to see if it's on the whitelist.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool Whether the value is whitelisted.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_identity_crisis_value_whitelisted( $key, $value ) {&nbsp;</div></li><li><div>        $whitelist = Jetpack_Options::get_option( 'identity_crisis_whitelist', array() );&nbsp;</div></li><li><div>        if ( ! empty( $whitelist[ $key ] ) && is_array( $whitelist[ $key ] ) && in_array( $value, $whitelist[ $key ] ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks whether the home and siteurl specifically are whitelisted&nbsp;</div></li><li><div>     * Written so that we don't have re-check $key and $value params every time&nbsp;</div></li><li><div>     * we want to check if this site is whitelisted, for example in footer.php&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool True = already whitelsisted False = not whitelisted&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function jetpack_is_staging_site() {&nbsp;</div></li><li><div>        $current_whitelist = Jetpack_Options::get_option( 'identity_crisis_whitelist' );&nbsp;</div></li><li><div>        if ( ! $current_whitelist ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options_to_check = Jetpack::identity_crisis_options_to_check();&nbsp;</div></li><li><div>        $cloud_options = Jetpack::init()-&gt;get_cloud_site_options( $options_to_check );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $cloud_options as $cloud_key =&gt; $cloud_value ) {&nbsp;</div></li><li><div>            if ( ! self::is_identity_crisis_value_whitelisted( $cloud_key, $cloud_value ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function identity_crisis_js( $nonce ) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;script&gt;&nbsp;</div></li><li><div>(function( $ ) {&nbsp;</div></li><li><div>    var SECOND_IN_MS = 1000;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function contactSupport( e ) {&nbsp;</div></li><li><div>        e.preventDefault();&nbsp;</div></li><li><div>        $( '.jp-id-crisis-question' ).hide();&nbsp;</div></li><li><div>        $( '#jp-id-crisis-contact-support' ).show();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function autodismissSuccessBanner() {&nbsp;</div></li><li><div>        $( '.jp-identity-crisis' ).fadeOut(600); //.addClass( 'dismiss' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var data = { action: 'jetpack_resolve_identity_crisis', 'ajax-nonce': '&lt;?php echo $nonce; ?&gt;' };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $( document ).ready(function() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Site moved: Update the URL on the shadow blog&nbsp;</div></li><li><div>        $( '.site-moved' ).click(function( e ) {&nbsp;</div></li><li><div>            e.preventDefault();&nbsp;</div></li><li><div>            data.crisis_resolution_action = 'site_migrated';&nbsp;</div></li><li><div>            $( '#jp-id-crisis-question-1 .spinner' ).show();&nbsp;</div></li><li><div>            $.post( ajaxurl, data, function() {&nbsp;</div></li><li><div>                $( '.jp-id-crisis-question' ).hide();&nbsp;</div></li><li><div>                $( '.banner-title' ).hide();&nbsp;</div></li><li><div>                $( '#jp-id-crisis-success' ).show();&nbsp;</div></li><li><div>                setTimeout( autodismissSuccessBanner, 6 * SECOND_IN_MS );&nbsp;</div></li><li><div>            });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // URL hasn't changed, next question please.&nbsp;</div></li><li><div>        $( '.site-not-moved' ).click(function( e ) {&nbsp;</div></li><li><div>            e.preventDefault();&nbsp;</div></li><li><div>            $( '.jp-id-crisis-question' ).hide();&nbsp;</div></li><li><div>            $( '#jp-id-crisis-question-2' ).show();&nbsp;</div></li><li><div>        });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Reset connection: two separate sites.&nbsp;</div></li><li><div>        $( '.reset-connection' ).click(function( e ) {&nbsp;</div></li><li><div>            data.crisis_resolution_action = 'reset_connection';&nbsp;</div></li><li><div>            $.post( ajaxurl, data, function( response ) {&nbsp;</div></li><li><div>                if ( 'reset-connection-success' === response ) {&nbsp;</div></li><li><div>                    window.location.replace( '&lt;?php echo Jetpack::admin_url(); ?&gt;' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            });&nbsp;</div></li><li><div>        });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // It's a dev environment.  Ignore.&nbsp;</div></li><li><div>        $( '.is-dev-env' ).click(function( e ) {&nbsp;</div></li><li><div>            data.crisis_resolution_action = 'whitelist';&nbsp;</div></li><li><div>            $( '#jp-id-crisis-question-2 .spinner' ).show();&nbsp;</div></li><li><div>            $.post( ajaxurl, data, function() {&nbsp;</div></li><li><div>                $( '.jp-id-crisis-question' ).hide();&nbsp;</div></li><li><div>                $( '.banner-title' ).hide();&nbsp;</div></li><li><div>                $( '#jp-id-crisis-success' ).show();&nbsp;</div></li><li><div>                setTimeout( autodismissSuccessBanner, 4 * SECOND_IN_MS );&nbsp;</div></li><li><div>            });&nbsp;</div></li><li><div>        });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $( '.not-reconnecting' ).click(contactSupport);&nbsp;</div></li><li><div>        $( '.not-staging-or-dev' ).click(contactSupport);&nbsp;</div></li><li><div>    });&nbsp;</div></li><li><div>})( jQuery );&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an admin_notice, alerting the user to an identity crisis.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function alert_identity_crisis() {&nbsp;</div></li><li><div>        // @todo temporary copout for dealing with domain mapping&nbsp;</div></li><li><div>        // @see https://github.com/Automattic/jetpack/issues/2702&nbsp;</div></li><li><div>        if ( is_multisite() && defined( 'SUNRISE' ) && ! Jetpack::is_development_version() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'jetpack_disconnect' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $errors = self::check_identity_crisis() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only show on dashboard and jetpack pages&nbsp;</div></li><li><div>        $screen = get_current_screen();&nbsp;</div></li><li><div>        if ( 'dashboard' !== $screen-&gt;base && ! did_action( 'jetpack_notices' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Include the js!&nbsp;</div></li><li><div>        $ajax_nonce = wp_create_nonce( 'resolve-identity-crisis' );&nbsp;</div></li><li><div>        $this-&gt;identity_crisis_js( $ajax_nonce );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Include the CSS!&nbsp;</div></li><li><div>        if ( ! wp_script_is( 'jetpack', 'done' ) ) {&nbsp;</div></li><li><div>            $this-&gt;admin_banner_styles();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! array_key_exists( 'error_code', $errors ) ) {&nbsp;</div></li><li><div>            $key = 'siteurl';&nbsp;</div></li><li><div>            if ( ! $errors[ $key ] ) {&nbsp;</div></li><li><div>                $key = 'home';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $key = 'error_code';&nbsp;</div></li><li><div>            // 401 is the only error we care about.  Any other errors should not trigger the alert.&nbsp;</div></li><li><div>            if ( 401 !== $errors[ $key ] ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;style&gt;&nbsp;</div></li><li><div>            .jp-identity-crisis .jp-btn-group {&nbsp;</div></li><li><div>                    margin: 15px 0;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            .jp-identity-crisis strong {&nbsp;</div></li><li><div>                    color: #518d2a;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            .jp-identity-crisis.dismiss {&nbsp;</div></li><li><div>                display: none;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            .jp-identity-crisis .button {&nbsp;</div></li><li><div>                margin-right: 4px;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        &lt;/style&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div id=&quot;message&quot; class=&quot;error jetpack-message jp-identity-crisis stay-visible&quot;&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;service-mark&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;jp-id-banner__content&quot;&gt;&nbsp;</div></li><li><div>                &lt;!-- &lt;h3 class=&quot;banner-title&quot;&gt;&lt;?php _e( 'Something\'s not quite right with your Jetpack connection! Let\'s fix that.', 'jetpack' ); ?&gt;&lt;/h3&gt; --&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-id-crisis-question&quot; id=&quot;jp-id-crisis-question-1&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    // 401 means that this site has been disconnected from wpcom, but the remote site still thinks it's connected.&nbsp;</div></li><li><div>                    if ( 'error_code' == $key && '401' == $errors[ $key ] ) : ?&gt;&nbsp;</div></li><li><div>                        &lt;div class=&quot;banner-content&quot;&gt;&nbsp;</div></li><li><div>                            &lt;p&gt;&lt;?php&nbsp;</div></li><li><div>                                /** translators: %s is a URL */&nbsp;</div></li><li><div>                                printf( __( 'Our records show that this site does not have a valid connection to WordPress.com. Please reset your connection to fix this. &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;What caused this?&lt;/a&gt;', 'jetpack' ), 'https://jetpack.me/support/no-valid-wordpress-com-connection/' );&nbsp;</div></li><li><div>                            ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;div class=&quot;jp-btn-group&quot;&gt;&nbsp;</div></li><li><div>                            &lt;a href=&quot;#&quot; class=&quot;reset-connection&quot;&gt;&lt;?php _e( 'Reset the connection', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                            &lt;span class=&quot;idc-separator&quot;&gt;|&lt;/span&gt;&nbsp;</div></li><li><div>                            &lt;a href=&quot;&lt;?php echo esc_url( wp_nonce_url( Jetpack::admin_url( 'jetpack-notice=dismiss' ), 'jetpack-deactivate' ) ); ?&gt;&quot;&gt;&lt;?php _e( 'Deactivate Jetpack', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                            &lt;div class=&quot;banner-content&quot;&gt;&nbsp;</div></li><li><div>                            &lt;p&gt;&lt;?php printf( __( 'It looks like you may have changed your domain. Is &lt;strong&gt;%1$s&lt;/strong&gt; still your site\'s domain, or have you updated it to &lt;strong&gt; %2$s &lt;/strong&gt;?', 'jetpack' ), $errors[ $key ], (string) get_option( $key ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                            &lt;/div&gt;&nbsp;</div></li><li><div>                        &lt;div class=&quot;jp-btn-group&quot;&gt;&nbsp;</div></li><li><div>                            &lt;a href=&quot;#&quot; class=&quot;regular site-moved&quot;&gt;&lt;?php printf( __( '%s is now my domain.', 'jetpack' ), $errors[ $key ] ); ?&gt;&lt;/a&gt; &lt;span class=&quot;idc-separator&quot;&gt;|&lt;/span&gt; &lt;a href=&quot;#&quot; class=&quot;site-not-moved&quot; &gt;&lt;?php printf( __( '%s is still my domain.', 'jetpack' ), (string) get_option( $key ) ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                            &lt;span class=&quot;spinner&quot;&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;?php endif ; ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-id-crisis-question&quot; id=&quot;jp-id-crisis-question-2&quot; style=&quot;display: none;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;banner-content&quot;&gt;&nbsp;</div></li><li><div>                        &lt;p&gt;&lt;?php printf(&nbsp;</div></li><li><div>                            /** translators: %1$s, %2$s and %3$s are URLs */&nbsp;</div></li><li><div>                            __(&nbsp;</div></li><li><div>                                'Are &lt;strong&gt; %2$s &lt;/strong&gt; and &lt;strong&gt; %1$s &lt;/strong&gt; two completely separate websites? If so we should create a new connection, which will reset your followers and linked services. &lt;a href=&quot;%3$s&quot;&gt;&lt;em&gt;What does this mean?&lt;/em&gt;&lt;/a&gt;', &nbsp;</div></li><li><div>                                'jetpack'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                            $errors[ $key ], &nbsp;</div></li><li><div>                            (string) get_option( $key ), &nbsp;</div></li><li><div>                            'https://jetpack.me/support/what-does-resetting-the-connection-mean/'&nbsp;</div></li><li><div> ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;jp-btn-group&quot;&gt;&nbsp;</div></li><li><div>                        &lt;a href=&quot;#&quot; class=&quot;reset-connection&quot;&gt;&lt;?php _e( 'Reset the connection', 'jetpack' ); ?&gt;&lt;/a&gt; &lt;span class=&quot;idc-separator&quot;&gt;|&lt;/span&gt;&nbsp;</div></li><li><div>                        &lt;a href=&quot;#&quot; class=&quot;is-dev-env&quot;&gt;&lt;?php _e( 'This is a development environment', 'jetpack' ); ?&gt;&lt;/a&gt; &lt;span class=&quot;idc-separator&quot;&gt;|&lt;/span&gt;&nbsp;</div></li><li><div>                        &lt;a href=&quot;https://jetpack.me/contact-support/&quot; class=&quot;contact-support&quot;&gt;&lt;?php _e( 'Submit a support ticket', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                        &lt;span class=&quot;spinner&quot;&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div class=&quot;jp-id-crisis-success&quot; id=&quot;jp-id-crisis-success&quot; style=&quot;display: none;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h3 class=&quot;success-notice&quot;&gt;&lt;?php printf( __( 'Thanks for taking the time to sort things out. We&#039;ve updated our records accordingly!', 'jetpack' ) ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Maybe Use a .min.css stylesheet, maybe not.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Hooks onto `plugins_url` filter at priority 1, and accepts all 3 args.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function maybe_min_asset( $url, $path, $plugin ) {&nbsp;</div></li><li><div>        // Short out on things trying to find actual paths.&nbsp;</div></li><li><div>        if ( ! $path || empty( $plugin ) ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Strip out the abspath.&nbsp;</div></li><li><div>        $base = dirname( plugin_basename( $plugin ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Short out on non-Jetpack assets.&nbsp;</div></li><li><div>        if ( 'jetpack/' !== substr( $base, 0, 8 ) ) {&nbsp;</div></li><li><div>            return $url;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // File name parsing.&nbsp;</div></li><li><div>        $file = &quot;{$base}/{$path}&quot;;&nbsp;</div></li><li><div>        $full_path = JETPACK__PLUGIN_DIR . substr( $file, 8 );&nbsp;</div></li><li><div>        $file_name = substr( $full_path, strrpos( $full_path, '/' ) + 1 );&nbsp;</div></li><li><div>        $file_name_parts_r = array_reverse( explode( '.', $file_name ) );&nbsp;</div></li><li><div>        $extension = array_shift( $file_name_parts_r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( in_array( strtolower( $extension ), array( 'css', 'js' ) ) ) {&nbsp;</div></li><li><div>            // Already pointing at the minified version.&nbsp;</div></li><li><div>            if ( 'min' === $file_name_parts_r[0] ) {&nbsp;</div></li><li><div>                return $url;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $min_full_path = preg_replace( &quot;#\.{$extension}$#&quot;, &quot;.min.{$extension}&quot;, $full_path );&nbsp;</div></li><li><div>            if ( file_exists( $min_full_path ) ) {&nbsp;</div></li><li><div>                $url = preg_replace( &quot;#\.{$extension}$#&quot;, &quot;.min.{$extension}&quot;, $url );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Maybe inlines a stylesheet.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If you'd like to inline a stylesheet instead of printing a link to it, &nbsp;</div></li><li><div>     * wp_style_add_data( 'handle', 'jetpack-inline', true );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Attached to `style_loader_tag` filter.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $tag The tag that would link to the external asset.&nbsp;</div></li><li><div>     * @param string $handle The registered handle of the script in question.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function maybe_inline_style( $tag, $handle ) {&nbsp;</div></li><li><div>        global $wp_styles;&nbsp;</div></li><li><div>        $item = $wp_styles-&gt;registered[ $handle ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $item-&gt;extra['jetpack-inline'] ) || ! $item-&gt;extra['jetpack-inline'] ) {&nbsp;</div></li><li><div>            return $tag;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( preg_match( '# href=\'([^\']+)\' #i', $tag, $matches ) ) {&nbsp;</div></li><li><div>            $href = $matches[1];&nbsp;</div></li><li><div>            // Strip off query string&nbsp;</div></li><li><div>            if ( $pos = strpos( $href, '?' ) ) {&nbsp;</div></li><li><div>                $href = substr( $href, 0, $pos );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Strip off fragment&nbsp;</div></li><li><div>            if ( $pos = strpos( $href, '#' ) ) {&nbsp;</div></li><li><div>                $href = substr( $href, 0, $pos );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $tag;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugins_dir = plugin_dir_url( JETPACK__PLUGIN_FILE );&nbsp;</div></li><li><div>        if ( $plugins_dir !== substr( $href, 0, strlen( $plugins_dir ) ) ) {&nbsp;</div></li><li><div>            return $tag;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If this stylesheet has a RTL version, and the RTL version replaces normal...&nbsp;</div></li><li><div>        if ( isset( $item-&gt;extra['rtl'] ) && 'replace' === $item-&gt;extra['rtl'] && is_rtl() ) {&nbsp;</div></li><li><div>            // And this isn't the pass that actually deals with the RTL version...&nbsp;</div></li><li><div>            if ( false === strpos( $tag, &quot; id='$handle-rtl-css' &quot; ) ) {&nbsp;</div></li><li><div>                // Short out, as the RTL version will deal with it in a moment.&nbsp;</div></li><li><div>                return $tag;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file = JETPACK__PLUGIN_DIR . substr( $href, strlen( $plugins_dir ) );&nbsp;</div></li><li><div>        $css = Jetpack::absolutize_css_urls( file_get_contents( $file ), $href );&nbsp;</div></li><li><div>        if ( $css ) {&nbsp;</div></li><li><div>            $tag = &quot;&lt;!-- Inline {$item-&gt;handle} --&gt;\r\n&quot;;&nbsp;</div></li><li><div>            if ( empty( $item-&gt;extra['after'] ) ) {&nbsp;</div></li><li><div>                wp_add_inline_style( $handle, $css );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                array_unshift( $item-&gt;extra['after'], $css );&nbsp;</div></li><li><div>                wp_style_add_data( $handle, 'after', $item-&gt;extra['after'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $tag;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Loads a view file from the views&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Data passed in with the $data parameter will be available in the&nbsp;</div></li><li><div>     * template file as $data['value']&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $template - Template file to load&nbsp;</div></li><li><div>     * @param array $data - Any data to pass along to the template&nbsp;</div></li><li><div>     * @return boolean - If template file was found&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function load_view( $template, $data = array() ) {&nbsp;</div></li><li><div>        $views_dir = JETPACK__PLUGIN_DIR . 'views/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( file_exists( $views_dir . $template ) ) {&nbsp;</div></li><li><div>            require_once( $views_dir . $template );&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        error_log( &quot;Jetpack: Unable to find view file $views_dir$template&quot; );&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sends a ping to the Jetpack servers to toggle on/off remote portions&nbsp;</div></li><li><div>     * required by some modules.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $module_slug&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function toggle_module_on_wpcom( $module_slug ) {&nbsp;</div></li><li><div>        Jetpack::init()-&gt;sync-&gt;register( 'noop' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== strpos( current_filter(), 'jetpack_activate_module_' ) ) {&nbsp;</div></li><li><div>            self::check_privacy( $module_slug );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Throws warnings for deprecated hooks to be removed from Jetpack&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function deprecated_hooks() {&nbsp;</div></li><li><div>        global $wp_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Format:&nbsp;</div></li><li><div>         * deprecated_filter_name =&gt; replacement_name&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * If there is no replacement us null for replacement_name&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $deprecated_list = array(&nbsp;</div></li><li><div>            'jetpack_bail_on_shortcode' =&gt; 'jetpack_shortcodes_to_include', &nbsp;</div></li><li><div>            'wpl_sharing_2014_1' =&gt; null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // This is a silly loop depth. Better way?&nbsp;</div></li><li><div>        foreach( $deprecated_list AS $hook =&gt; $hook_alt ) {&nbsp;</div></li><li><div>            if( isset( $wp_filter[ $hook ] ) && is_array( $wp_filter[ $hook ] ) ) {&nbsp;</div></li><li><div>                foreach( $wp_filter[$hook] AS $func =&gt; $values ) {&nbsp;</div></li><li><div>                    foreach( $values AS $hooked ) {&nbsp;</div></li><li><div>                        _deprecated_function( $hook . ' used for ' . $hooked['function'], null, $hook_alt );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Converts any url in a stylesheet, to the correct absolute url.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Considerations:&nbsp;</div></li><li><div>     *  - Normal, relative URLs     `feh.png`&nbsp;</div></li><li><div>     *  - Data URLs                 `data:image/gif;base64, eh129ehiuehjdhsa==`&nbsp;</div></li><li><div>     *  - Schema-agnostic URLs      `//domain.com/feh.png`&nbsp;</div></li><li><div>     *  - Absolute URLs             `http://domain.com/feh.png`&nbsp;</div></li><li><div>     *  - Domain root relative URLs `/feh.png`&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $css string: The raw CSS -- should be read in directly from the file.&nbsp;</div></li><li><div>     * @param $css_file_url : The URL that the file can be accessed at, for calculating paths from.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function absolutize_css_urls( $css, $css_file_url ) {&nbsp;</div></li><li><div>        $pattern = '#url\((?P&lt;path&gt;[^)]*)\)#i';&nbsp;</div></li><li><div>        $css_dir = dirname( $css_file_url );&nbsp;</div></li><li><div>        $p = parse_url( $css_dir );&nbsp;</div></li><li><div>        $domain = sprintf(&nbsp;</div></li><li><div>                    '%1$s//%2$s%3$s%4$s', &nbsp;</div></li><li><div>                    isset( $p['scheme'] )           ? &quot;{$p['scheme']}:&quot; : '', &nbsp;</div></li><li><div>                    isset( $p['user'], $p['pass'] ) ? &quot;{$p['user']}:{$p['pass']}@&quot; : '', &nbsp;</div></li><li><div>                    $p['host'], &nbsp;</div></li><li><div>                    isset( $p['port'] )             ? &quot;:{$p['port']}&quot; : ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( preg_match_all( $pattern, $css, $matches, PREG_SET_ORDER ) ) {&nbsp;</div></li><li><div>            $find = $replace = array();&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>                $url = trim( $match['path'], &quot;'\&quot; \t&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If this is a data url, we don't want to mess with it.&nbsp;</div></li><li><div>                if ( 'data:' === substr( $url, 0, 5 ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If this is an absolute or protocol-agnostic url, &nbsp;</div></li><li><div>                // we don't want to mess with it.&nbsp;</div></li><li><div>                if ( preg_match( '#^(https?:)?//#i', $url ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( substr( $url, 0, 1 ) ) {&nbsp;</div></li><li><div>                    case '/':&nbsp;</div></li><li><div>                        $absolute = $domain . $url;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $absolute = $css_dir . '/' . $url;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $find[] = $match[0];&nbsp;</div></li><li><div>                $replace[] = sprintf( 'url(&quot;%s&quot;)', $absolute );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $css = str_replace( $find, $replace, $css );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $css;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method checks to see if SSL is required by the site in&nbsp;</div></li><li><div>     * order to visit it in some way other than only setting the&nbsp;</div></li><li><div>     * https value in the home or siteurl values.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.2&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    private function is_ssl_required_to_visit_site() {&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        $ssl = is_ssl();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( version_compare( $wp_version, '4.4-alpha', '&lt;=' ) && force_ssl_login() ) { // force_ssl_login deprecated WP 4.4.&nbsp;</div></li><li><div>            $ssl = true;&nbsp;</div></li><li><div>        } else if ( force_ssl_admin() ) {&nbsp;</div></li><li><div>            $ssl = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $ssl;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This methods removes all of the registered css files on the frontend&nbsp;</div></li><li><div>     * from Jetpack in favor of using a single file. In effect &quot;imploding&quot;&nbsp;</div></li><li><div>     * all the files into one file.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Pros:&nbsp;</div></li><li><div>     * - Uses only ONE css asset connection instead of 15&nbsp;</div></li><li><div>     * - Saves a minimum of 56k&nbsp;</div></li><li><div>     * - Reduces server load&nbsp;</div></li><li><div>     * - Reduces time to first painted byte&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Cons:&nbsp;</div></li><li><div>     * - Loads css for ALL modules. However all selectors are prefixed so it&nbsp;</div></li><li><div>     *        should not cause any issues with themes.&nbsp;</div></li><li><div>     * - Plugins/themes dequeuing styles no longer do anything. See&nbsp;</div></li><li><div>     *        jetpack_implode_frontend_css filter for a workaround&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * For some situations developers may wish to disable css imploding and&nbsp;</div></li><li><div>     * instead operate in legacy mode where each file loads seperately and&nbsp;</div></li><li><div>     * can be edited individually or dequeued. This can be accomplished with&nbsp;</div></li><li><div>     * the following line:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * add_filter( 'jetpack_implode_frontend_css', '__return_false' );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.2&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function implode_frontend_css( $travis_test = false ) {&nbsp;</div></li><li><div>        $do_implode = true;&nbsp;</div></li><li><div>        if ( defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ) {&nbsp;</div></li><li><div>            $do_implode = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow CSS to be concatenated into a single jetpack.css file.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.2.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $do_implode Should CSS be concatenated? Default to true.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $do_implode = apply_filters( 'jetpack_implode_frontend_css', $do_implode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Do not use the imploded file when default behaviour was altered through the filter&nbsp;</div></li><li><div>        if ( ! $do_implode ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We do not want to use the imploded file in dev mode, or if not connected&nbsp;</div></li><li><div>        if ( Jetpack::is_development_mode() || ! self::is_active() ) {&nbsp;</div></li><li><div>            if ( ! $travis_test ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Do not use the imploded file if sharing css was dequeued via the sharing settings screen&nbsp;</div></li><li><div>        if ( get_option( 'sharedaddy_disable_resources' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Now we assume Jetpack is connected and able to serve the single&nbsp;</div></li><li><div>         * file.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * In the future there will be a check here to serve the file locally&nbsp;</div></li><li><div>         * or potentially from the Jetpack CDN&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * For now:&nbsp;</div></li><li><div>         * - Enqueue a single imploded css file&nbsp;</div></li><li><div>         * - Zero out the style_loader_tag for the bundled ones&nbsp;</div></li><li><div>         * - Be happy, drink scotch&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'style_loader_tag', array( $this, 'concat_remove_style_loader_tag' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version = Jetpack::is_development_version() ? filemtime( JETPACK__PLUGIN_DIR . 'css/jetpack.css' ) : JETPACK__VERSION;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style( 'jetpack_css', plugins_url( 'css/jetpack.css', __FILE__ ), array(), $version );&nbsp;</div></li><li><div>        wp_style_add_data( 'jetpack_css', 'rtl', 'replace' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function concat_remove_style_loader_tag( $tag, $handle ) {&nbsp;</div></li><li><div>        if ( in_array( $handle, $this-&gt;concatenated_style_handles ) ) {&nbsp;</div></li><li><div>            $tag = '';&nbsp;</div></li><li><div>            if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {&nbsp;</div></li><li><div>                $tag = &quot;&lt;!-- `&quot; . esc_html( $handle ) . &quot;` is included in the concatenated jetpack.css --&gt;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $tag;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check the heartbeat data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Organizes the heartbeat data by severity.  For example, if the site&nbsp;</div></li><li><div>     * is in an ID crisis, it will be in the $filtered_data['bad'] array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Data will be added to &quot;caution&quot; array, if it either:&nbsp;</div></li><li><div>     *  - Out of date Jetpack version&nbsp;</div></li><li><div>     *  - Out of date WP version&nbsp;</div></li><li><div>     *  - Out of date PHP version&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * $return array $filtered_data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function jetpack_check_heartbeat_data() {&nbsp;</div></li><li><div>        $raw_data = Jetpack_Heartbeat::generate_stats_array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $good = array();&nbsp;</div></li><li><div>        $caution = array();&nbsp;</div></li><li><div>        $bad = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $raw_data as $stat =&gt; $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check jetpack version&nbsp;</div></li><li><div>            if ( 'version' == $stat ) {&nbsp;</div></li><li><div>                if ( version_compare( $value, JETPACK__VERSION, '&lt;' ) ) {&nbsp;</div></li><li><div>                    $caution[ $stat ] = $value . &quot; - min supported is &quot; . JETPACK__VERSION;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check WP version&nbsp;</div></li><li><div>            if ( 'wp-version' == $stat ) {&nbsp;</div></li><li><div>                if ( version_compare( $value, JETPACK__MINIMUM_WP_VERSION, '&lt;' ) ) {&nbsp;</div></li><li><div>                    $caution[ $stat ] = $value . &quot; - min supported is &quot; . JETPACK__MINIMUM_WP_VERSION;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check PHP version&nbsp;</div></li><li><div>            if ( 'php-version' == $stat ) {&nbsp;</div></li><li><div>                if ( version_compare( PHP_VERSION, '5.2.4', '&lt;' ) ) {&nbsp;</div></li><li><div>                    $caution[ $stat ] = $value . &quot; - min supported is 5.2.4&quot;;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check ID crisis&nbsp;</div></li><li><div>            if ( 'identitycrisis' == $stat ) {&nbsp;</div></li><li><div>                if ( 'yes' == $value ) {&nbsp;</div></li><li><div>                    $bad[ $stat ] = $value;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // The rest are good :)&nbsp;</div></li><li><div>            $good[ $stat ] = $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filtered_data = array(&nbsp;</div></li><li><div>            'good' =&gt; $good, &nbsp;</div></li><li><div>            'caution' =&gt; $caution, &nbsp;</div></li><li><div>            'bad' =&gt; $bad&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $filtered_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method is used to organize all options that can be reset&nbsp;</div></li><li><div>     * without disconnecting Jetpack.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * It is used in class.jetpack-cli.php to reset options&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array of options to delete.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_jetpack_options_for_reset() {&nbsp;</div></li><li><div>        $jetpack_options = Jetpack_Options::get_option_names();&nbsp;</div></li><li><div>        $jetpack_options_non_compat = Jetpack_Options::get_option_names( 'non_compact' );&nbsp;</div></li><li><div>        $jetpack_options_private = Jetpack_Options::get_option_names( 'private' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $all_jp_options = array_merge( $jetpack_options, $jetpack_options_non_compat, $jetpack_options_private );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // A manual build of the wp options&nbsp;</div></li><li><div>        $wp_options = array(&nbsp;</div></li><li><div>            'sharing-options', &nbsp;</div></li><li><div>            'disabled_likes', &nbsp;</div></li><li><div>            'disabled_reblogs', &nbsp;</div></li><li><div>            'jetpack_comments_likes_enabled', &nbsp;</div></li><li><div>            'wp_mobile_excerpt', &nbsp;</div></li><li><div>            'wp_mobile_featured_images', &nbsp;</div></li><li><div>            'wp_mobile_app_promos', &nbsp;</div></li><li><div>            'stats_options', &nbsp;</div></li><li><div>            'stats_dashboard_widget', &nbsp;</div></li><li><div>            'safecss_preview_rev', &nbsp;</div></li><li><div>            'safecss_rev', &nbsp;</div></li><li><div>            'safecss_revision_migrated', &nbsp;</div></li><li><div>            'nova_menu_order', &nbsp;</div></li><li><div>            'jetpack_portfolio', &nbsp;</div></li><li><div>            'jetpack_portfolio_posts_per_page', &nbsp;</div></li><li><div>            'jetpack_testimonial', &nbsp;</div></li><li><div>            'jetpack_testimonial_posts_per_page', &nbsp;</div></li><li><div>            'wp_mobile_custom_css', &nbsp;</div></li><li><div>            'sharedaddy_disable_resources', &nbsp;</div></li><li><div>            'sharing-options', &nbsp;</div></li><li><div>            'sharing-services', &nbsp;</div></li><li><div>            'site_icon_temp_data', &nbsp;</div></li><li><div>            'featured-content', &nbsp;</div></li><li><div>            'site_logo', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Flag some Jetpack options as unsafe&nbsp;</div></li><li><div>        $unsafe_options = array(&nbsp;</div></li><li><div>            'id', // (int)    The Client ID/WP.com Blog ID of this site.&nbsp;</div></li><li><div>            'master_user', // (int)    The local User ID of the user who connected this site to jetpack.wordpress.com.&nbsp;</div></li><li><div>            'version', // (string) Used during upgrade procedure to auto-activate new modules. version:time&nbsp;</div></li><li><div>            'jumpstart', // (string) A flag for whether or not to show the Jump Start.  Accepts: new_connection, jumpstart_activated, jetpack_action_taken, jumpstart_dismissed.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // non_compact&nbsp;</div></li><li><div>            'activated', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // private&nbsp;</div></li><li><div>            'register', &nbsp;</div></li><li><div>            'blog_token', // (string) The Client Secret/Blog Token of this site.&nbsp;</div></li><li><div>            'user_token', // (string) The User Token of this site. (deprecated)&nbsp;</div></li><li><div>            'user_tokens'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove the unsafe Jetpack options&nbsp;</div></li><li><div>        foreach ( $unsafe_options as $unsafe_option ) {&nbsp;</div></li><li><div>            if ( false !== ( $key = array_search( $unsafe_option, $all_jp_options ) ) ) {&nbsp;</div></li><li><div>                unset( $all_jp_options[ $key ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options = array(&nbsp;</div></li><li><div>            'jp_options' =&gt; $all_jp_options, &nbsp;</div></li><li><div>            'wp_options' =&gt; $wp_options&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $options;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if an option of a Jetpack module has been updated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If any module option has been updated before Jump Start has been dismissed, &nbsp;</div></li><li><div>     * update the 'jumpstart' option so we can hide Jump Start.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function jumpstart_has_updated_module_option( $option_name = '' ) {&nbsp;</div></li><li><div>        // Bail if Jump Start has already been dismissed&nbsp;</div></li><li><div>        if ( 'new_connection' !== Jetpack::get_option( 'jumpstart' ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Manual build of module options&nbsp;</div></li><li><div>        $option_names = self::get_jetpack_options_for_reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( in_array( $option_name, $option_names['wp_options'] ) ) {&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'jumpstart', 'jetpack_action_taken' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Jump start is being dismissed send data to MC Stats&nbsp;</div></li><li><div>            $jetpack-&gt;stat( 'jumpstart', 'manual, '.$option_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $jetpack-&gt;do_stats( 'server_side' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Strip http:// or https:// from a url, replaces forward slash with ::, &nbsp;</div></li><li><div>     * so we can bring them directly to their site in calypso.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string | url&nbsp;</div></li><li><div>     * @return string | url without the guff&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function build_raw_urls( $url ) {&nbsp;</div></li><li><div>        $strip_http = '/.*?:\/\//i';&nbsp;</div></li><li><div>        $url = preg_replace( $strip_http, '', $url );&nbsp;</div></li><li><div>        $url = str_replace( '/', '::', $url );&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stores and prints out domains to prefetch for page speed optimization.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed $new_urls&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function dns_prefetch( $new_urls = null ) {&nbsp;</div></li><li><div>        static $prefetch_urls = array();&nbsp;</div></li><li><div>        if ( empty( $new_urls ) && ! empty( $prefetch_urls ) ) {&nbsp;</div></li><li><div>            echo &quot;\r\n&quot;;&nbsp;</div></li><li><div>            foreach ( $prefetch_urls as $this_prefetch_url ) {&nbsp;</div></li><li><div>                printf( &quot;&lt;link rel='dns-prefetch' href='%s'&gt;\r\n&quot;, esc_attr( $this_prefetch_url ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! empty( $new_urls ) ) {&nbsp;</div></li><li><div>            if ( ! has_action( 'wp_head', array( __CLASS__, __FUNCTION__ ) ) ) {&nbsp;</div></li><li><div>                add_action( 'wp_head', array( __CLASS__, __FUNCTION__ ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( (array) $new_urls as $this_new_url ) {&nbsp;</div></li><li><div>                $prefetch_urls[] = strtolower( untrailingslashit( preg_replace( '#^https?://#i', '//', $this_new_url ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $prefetch_urls = array_unique( $prefetch_urls );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function wp_dashboard_setup() {&nbsp;</div></li><li><div>        if ( self::is_active() ) {&nbsp;</div></li><li><div>            add_action( 'jetpack_dashboard_widget', array( __CLASS__, 'dashboard_widget_footer' ), 999 );&nbsp;</div></li><li><div>            $widget_title = __( 'Jetpack', 'jetpack' );&nbsp;</div></li><li><div>        } elseif ( ! self::is_development_mode() && current_user_can( 'jetpack_connect' ) ) {&nbsp;</div></li><li><div>            add_action( 'jetpack_dashboard_widget', array( $this, 'dashboard_widget_connect_to_wpcom' ) );&nbsp;</div></li><li><div>            $widget_title = __( 'Please Connect Jetpack', 'jetpack' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( has_action( 'jetpack_dashboard_widget' ) ) {&nbsp;</div></li><li><div>            wp_add_dashboard_widget(&nbsp;</div></li><li><div>                'jetpack_summary_widget', &nbsp;</div></li><li><div>                $widget_title, &nbsp;</div></li><li><div>                array( __CLASS__, 'dashboard_widget' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            wp_enqueue_style( 'jetpack-dashboard-widget', plugins_url( 'css/dashboard-widget.css', JETPACK__PLUGIN_FILE ), array(), JETPACK__VERSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If we're inactive and not in development mode, sort our box to the top.&nbsp;</div></li><li><div>            if ( ! self::is_active() && ! self::is_development_mode() ) {&nbsp;</div></li><li><div>                global $wp_meta_boxes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $dashboard = $wp_meta_boxes['dashboard']['normal']['core'];&nbsp;</div></li><li><div>                $ours = array( 'jetpack_summary_widget' =&gt; $dashboard['jetpack_summary_widget'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $wp_meta_boxes['dashboard']['normal']['core'] = array_merge( $ours, $dashboard );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param mixed $result Value for the user's option&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_user_option_meta_box_order_dashboard( $sorted ) {&nbsp;</div></li><li><div>        if ( ! is_array( $sorted ) ) {&nbsp;</div></li><li><div>            return $sorted;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $sorted as $box_context =&gt; $ids ) {&nbsp;</div></li><li><div>            if ( false === strpos( $ids, 'dashboard_stats' ) ) {&nbsp;</div></li><li><div>                // If the old id isn't anywhere in the ids, don't bother exploding and fail out.&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $ids_array = explode( ', ', $ids );&nbsp;</div></li><li><div>            $key = array_search( 'dashboard_stats', $ids_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( false !== $key ) {&nbsp;</div></li><li><div>                // If we've found that exact value in the option (and not `google_dashboard_stats` for example)&nbsp;</div></li><li><div>                $ids_array[ $key ] = 'jetpack_summary_widget';&nbsp;</div></li><li><div>                $sorted[ $box_context ] = implode( ', ', $ids_array );&nbsp;</div></li><li><div>                // We've found it, stop searching, and just return.&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sorted;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function dashboard_widget() {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when the dashboard is loaded.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.4.0&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_dashboard_widget' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function dashboard_widget_footer() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;footer&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div class=&quot;protect&quot;&gt;&nbsp;</div></li><li><div>            &lt;?php if ( Jetpack::is_module_active( 'protect' ) ) : ?&gt;&nbsp;</div></li><li><div>                &lt;h3&gt;&lt;?php echo number_format_i18n( get_site_option( 'jetpack_protect_blocked_attempts', 0 ) ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php echo esc_html_x( 'Blocked malicious login attempts', '{#} Blocked malicious login attempts -- number is on a prior line, text is a caption.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php elseif ( current_user_can( 'jetpack_activate_modules' ) && ! self::is_development_mode() ) : ?&gt;&nbsp;</div></li><li><div>                &lt;a href=&quot;&lt;?php echo esc_url( wp_nonce_url( Jetpack::admin_url( array( 'action' =&gt; 'activate', 'module' =&gt; 'protect' ) ), 'jetpack_activate-protect' ) ); ?&gt;&quot; class=&quot;button button-jetpack&quot; title=&quot;&lt;?php esc_attr_e( 'Protect helps to keep you secure from brute-force login attacks.', 'jetpack' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php esc_html_e( 'Activate Protect', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                &lt;/a&gt;&nbsp;</div></li><li><div>            &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                &lt;?php esc_html_e( 'Protect is inactive.', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div class=&quot;akismet&quot;&gt;&nbsp;</div></li><li><div>            &lt;?php if ( is_plugin_active( 'akismet/akismet.php' ) ) : ?&gt;&nbsp;</div></li><li><div>                &lt;h3&gt;&lt;?php echo number_format_i18n( get_option( 'akismet_spam_count', 0 ) ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;?php echo esc_html_x( 'Spam comments blocked by Akismet.', '{#} Spam comments blocked by Akismet -- number is on a prior line, text is a caption.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php elseif ( current_user_can( 'activate_plugins' ) && ! is_wp_error( validate_plugin( 'akismet/akismet.php' ) ) ) : ?&gt;&nbsp;</div></li><li><div>                &lt;a href=&quot;&lt;?php echo esc_url( wp_nonce_url( add_query_arg( array( 'action' =&gt; 'activate', 'plugin' =&gt; 'akismet/akismet.php' ), admin_url( 'plugins.php' ) ), 'activate-plugin_akismet/akismet.php' ) ); ?&gt;&quot; class=&quot;button button-jetpack&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php esc_html_e( 'Activate Akismet', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                &lt;/a&gt;&nbsp;</div></li><li><div>            &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                &lt;p&gt;&lt;a href=&quot;&lt;?php echo esc_url( 'https://akismet.com/?utm_source=jetpack&utm_medium=link&utm_campaign=Jetpack%20Dashboard%20Widget%20Footer%20Link' ); ?&gt;&quot;&gt;&lt;?php esc_html_e( 'Akismet can help to keep your blog safe from spam!', 'jetpack' ); ?&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>            &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php if ( ! current_user_can( 'edit_posts' ) && self::is_user_connected() ) : ?&gt;&nbsp;</div></li><li><div>            &lt;div style=&quot;width: 100%; text-align: center; padding-top: 20px; clear: both;&quot;&gt;&lt;a class=&quot;button&quot; title=&quot;&lt;?php esc_attr_e( 'Unlink your account from WordPress.com', 'jetpack' ); ?&gt;&quot; href=&quot;&lt;?php echo esc_url( wp_nonce_url( add_query_arg( array( 'action' =&gt; 'unlink', 'redirect' =&gt; 'sub-unlink' ), admin_url( 'index.php' ) ), 'jetpack-unlink' ) ); ?&gt;&quot;&gt;&lt;?php esc_html_e( 'Unlink your account from WordPress.com', 'jetpack' ); ?&gt;&lt;/a&gt;&lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/footer&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function dashboard_widget_connect_to_wpcom() {&nbsp;</div></li><li><div>        if ( Jetpack::is_active() || Jetpack::is_development_mode() || ! current_user_can( 'jetpack_connect' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;div class=&quot;wpcom-connect&quot;&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;jp-emblem&quot;&gt;&nbsp;</div></li><li><div>            &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; version=&quot;1.1&quot; id=&quot;Layer_1&quot; x=&quot;0&quot; y=&quot;0&quot; viewBox=&quot;0 0 172.9 172.9&quot; enable-background=&quot;new 0 0 172.9 172.9&quot; xml:space=&quot;preserve&quot;&gt;&nbsp;</div></li><li><div>                &lt;path d=&quot;M86.4 0C38.7 0 0 38.7 0 86.4c0 47.7 38.7 86.4 86.4 86.4s86.4-38.7 86.4-86.4C172.9 38.7 134.2 0 86.4 0zM83.1 106.6l-27.1-6.9C49 98 45.7 90.1 49.3 84l33.8-58.5V106.6zM124.9 88.9l-33.8 58.5V66.3l27.1 6.9C125.1 74.9 128.4 82.8 124.9 88.9z&quot;/&gt;&nbsp;</div></li><li><div>            &lt;/svg&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;h3&gt;&lt;?php esc_html_e( 'Please Connect Jetpack', 'jetpack' ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>            &lt;p&gt;&lt;?php echo wp_kses( __( 'Connecting Jetpack will show you &lt;strong&gt;stats&lt;/strong&gt; about your traffic, &lt;strong&gt;protect&lt;/strong&gt; you from brute force attacks, &lt;strong&gt;speed up&lt;/strong&gt; your images and photos, and enable other &lt;strong&gt;traffic and security&lt;/strong&gt; features.', 'jetpack' ), 'jetpack' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;div class=&quot;actions&quot;&gt;&nbsp;</div></li><li><div>                &lt;a href=&quot;&lt;?php echo $this-&gt;build_connect_url() ?&gt;&quot; class=&quot;button button-primary&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php esc_html_e( 'Connect Jetpack', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                &lt;/a&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * A graceful transition to using Core's site icon.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * All of the hard work has already been done with the image&nbsp;</div></li><li><div>     * in all_done_page(). All that needs to be done now is update&nbsp;</div></li><li><div>     * the option and display proper messaging.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo remove when WP 4.3 is minimum&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.6.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool false = Core's icon not available || true = Core's icon is available&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function jetpack_site_icon_available_in_core() {&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        $core_icon_available = function_exists( 'has_site_icon' ) && version_compare( $wp_version, '4.3-beta' ) &gt;= 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $core_icon_available ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No need for Jetpack's site icon anymore if core's is already set&nbsp;</div></li><li><div>        if ( has_site_icon() ) {&nbsp;</div></li><li><div>            if ( Jetpack::is_module_active( 'site-icon' ) ) {&nbsp;</div></li><li><div>                Jetpack::log( 'deactivate', 'site-icon' );&nbsp;</div></li><li><div>                Jetpack::deactivate_module( 'site-icon' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Transfer Jetpack's site icon to use core.&nbsp;</div></li><li><div>        $site_icon_id = Jetpack::get_option( 'site_icon_id' );&nbsp;</div></li><li><div>        if ( $site_icon_id ) {&nbsp;</div></li><li><div>            // Update core's site icon&nbsp;</div></li><li><div>            update_option( 'site_icon', $site_icon_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Delete Jetpack's icon option. We still want the blavatar and attached data though.&nbsp;</div></li><li><div>            delete_option( 'site_icon_id' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No need for Jetpack's site icon anymore&nbsp;</div></li><li><div>        if ( Jetpack::is_module_active( 'site-icon' ) ) {&nbsp;</div></li><li><div>            Jetpack::log( 'deactivate', 'site-icon' );&nbsp;</div></li><li><div>            Jetpack::deactivate_module( 'site-icon' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/jetpack/" class="">3.8.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.1/classes/jetpack/" class="">3.8.1</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/jetpack/" class="active">3.8.0</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.2/classes/jetpack/" class="">3.7.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.1/classes/jetpack/" class="">3.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Jetpack</li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>