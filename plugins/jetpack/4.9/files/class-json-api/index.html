<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="11467"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-json-api | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3dbfffd8a4aeabe92b86e3e09a456b32' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-json-api/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-json-api%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-json-api%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-file-class-json-api","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-json-api" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-json-api</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class.json-api.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>defined( 'WPCOM_JSON_API__DEBUG' ) or define( 'WPCOM_JSON_API__DEBUG', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WPCOM_JSON_API {&nbsp;</div></li><li><div>  static $self = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $endpoints = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $token_details = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $method = '';&nbsp;</div></li><li><div>  public $url = '';&nbsp;</div></li><li><div>  public $path = '';&nbsp;</div></li><li><div>  public $version = null;&nbsp;</div></li><li><div>  public $query = array();&nbsp;</div></li><li><div>  public $post_body = null;&nbsp;</div></li><li><div>  public $files = null;&nbsp;</div></li><li><div>  public $content_type = null;&nbsp;</div></li><li><div>  public $accept = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $_server_https;&nbsp;</div></li><li><div>  public $exit = true;&nbsp;</div></li><li><div>  public $public_api_scheme = 'https';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $output_status_code = 200;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $trapped_error = null;&nbsp;</div></li><li><div>  public $did_output = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return WPCOM_JSON_API instance</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function init( $method = null, $url = null, $post_body = null ) {&nbsp;</div></li><li><div>      if ( !self::$self ) {&nbsp;</div></li><li><div>          $class = function_exists( 'get_called_class' ) ? get_called_class() : __CLASS__;&nbsp;</div></li><li><div>          self::$self = new $class( $method, $url, $post_body );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$self;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add( WPCOM_JSON_API_Endpoint $endpoint ) {&nbsp;</div></li><li><div>      $path_versions = serialize( array (&nbsp;</div></li><li><div>          $endpoint-&gt;path, &nbsp;</div></li><li><div>          $endpoint-&gt;min_version, &nbsp;</div></li><li><div>          $endpoint-&gt;max_version, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      if ( !isset( $this-&gt;endpoints[$path_versions] ) ) {&nbsp;</div></li><li><div>          $this-&gt;endpoints[$path_versions] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;endpoints[$path_versions][$endpoint-&gt;method] = $endpoint;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function is_truthy( $value ) {&nbsp;</div></li><li><div>      switch ( strtolower( (string) $value ) ) {&nbsp;</div></li><li><div>      case '1' :&nbsp;</div></li><li><div>      case 't' :&nbsp;</div></li><li><div>      case 'true' :&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function is_falsy( $value ) {&nbsp;</div></li><li><div>      switch ( strtolower( (string) $value ) ) {&nbsp;</div></li><li><div>          case '0' :&nbsp;</div></li><li><div>          case 'f' :&nbsp;</div></li><li><div>          case 'false' :&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $args = func_get_args();&nbsp;</div></li><li><div>      call_user_func_array( array( $this, 'setup_inputs' ), $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function setup_inputs( $method = null, $url = null, $post_body = null ) {&nbsp;</div></li><li><div>      if ( is_null( $method ) ) {&nbsp;</div></li><li><div>          $this-&gt;method = strtoupper( $_SERVER['REQUEST_METHOD'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;method = strtoupper( $method );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( is_null( $url ) ) {&nbsp;</div></li><li><div>          $this-&gt;url = set_url_scheme( 'http:<span class="comment">//' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] );</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;url = $url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parsed = parse_url( $this-&gt;url );&nbsp;</div></li><li><div>      $this-&gt;path = $parsed['path'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $parsed['query'] ) ) {&nbsp;</div></li><li><div>          wp_parse_str( $parsed['query'], $this-&gt;query );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_SERVER['HTTP_ACCEPT'] ) && $_SERVER['HTTP_ACCEPT'] ) {&nbsp;</div></li><li><div>          $this-&gt;accept = $_SERVER['HTTP_ACCEPT'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'POST' === $this-&gt;method ) {&nbsp;</div></li><li><div>          if ( is_null( $post_body ) ) {&nbsp;</div></li><li><div>              $this-&gt;post_body = file_get_contents( 'php:<span class="comment">//input' );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_SERVER['HTTP_CONTENT_TYPE'] ) && $_SERVER['HTTP_CONTENT_TYPE'] ) {&nbsp;</div></li><li><div>                  $this-&gt;content_type = $_SERVER['HTTP_CONTENT_TYPE'];&nbsp;</div></li><li><div>              } elseif ( isset( $_SERVER['CONTENT_TYPE'] ) && $_SERVER['CONTENT_TYPE'] ) {&nbsp;</div></li><li><div>                  $this-&gt;content_type = $_SERVER['CONTENT_TYPE'] ;&nbsp;</div></li><li><div>              } elseif ( '{' === $this-&gt;post_body[0] ) {&nbsp;</div></li><li><div>                  $this-&gt;content_type = 'application/json';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;content_type = 'application/x-www-form-urlencoded';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 0 === strpos( strtolower( $this-&gt;content_type ), 'multipart/' ) ) {&nbsp;</div></li><li><div>                  $this-&gt;post_body = http_build_query( stripslashes_deep( $_POST ) );&nbsp;</div></li><li><div>                  $this-&gt;files = $_FILES;&nbsp;</div></li><li><div>                  $this-&gt;content_type = 'multipart/form-data';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;post_body = $post_body;&nbsp;</div></li><li><div>              $this-&gt;content_type = '{' === isset( $this-&gt;post_body[0] ) && $this-&gt;post_body[0] ? 'application/json' : 'application/x-www-form-urlencoded';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;post_body = null;&nbsp;</div></li><li><div>          $this-&gt;content_type = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;_server_https = array_key_exists( 'HTTPS', $_SERVER ) ? $_SERVER['HTTPS'] : '--UNset--';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function initialize() {&nbsp;</div></li><li><div>      $this-&gt;token_details['blog_id'] = Jetpack_Options::get_option( 'id' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function serve( $exit = true ) {&nbsp;</div></li><li><div>      ini_set( 'display_errors', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;exit = (bool) $exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This was causing problems with Jetpack, but is necessary for wpcom</span>&nbsp;</div></li><li><div>      <span class="comment">// @see https://github.com/Automattic/jetpack/pull/2603</span>&nbsp;</div></li><li><div>      <span class="comment">// @see r124548-wpcom</span>&nbsp;</div></li><li><div>      if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {&nbsp;</div></li><li><div>          add_filter( 'home_url', array( $this, 'ensure_http_scheme_of_home_url' ), 10, 3 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'user_can_richedit', '__return_true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'comment_edit_pre', array( $this, 'comment_edit_pre' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $initialization = $this-&gt;initialize();&nbsp;</div></li><li><div>      if ( 'OPTIONS' == $this-&gt;method ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before the page output.</span>&nbsp;</div></li><li><div><span class="comment">           * Can be used to specify custom header options.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'wpcom_json_api_options' );&nbsp;</div></li><li><div>          return $this-&gt;output( 200, '', 'plain/text' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $initialization ) ) {&nbsp;</div></li><li><div>          $this-&gt;output_error( $initialization );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Normalize</span> path and extract API version</span>&nbsp;</div></li><li><div>      $this-&gt;path = untrailingslashit( $this-&gt;path );&nbsp;</div></li><li><div>      preg_match( '#^/rest/v(\d+(\.\d+)*)#', $this-&gt;path, $matches );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// HACK Alert!</span>&nbsp;</div></li><li><div>      <span class="comment">// In order to workaround a bug in the iOS 5.6 release we need to handle /rest/sites/new as if it was</span>&nbsp;</div></li><li><div>      <span class="comment">// /rest/v1.1/sites/new</span>&nbsp;</div></li><li><div>      if ( $this-&gt;path === '/rest/sites/new' ) {&nbsp;</div></li><li><div>          $this-&gt;version = '1.1';&nbsp;</div></li><li><div>          $this-&gt;path = '/sites/new';&nbsp;</div></li><li><div>      } else if ( $this-&gt;path === '/rest/users/new' ) {&nbsp;</div></li><li><div>          $this-&gt;version = '1.1';&nbsp;</div></li><li><div>          $this-&gt;path = '/users/new';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;path = substr( $this-&gt;path, strlen( $matches[0] ) );&nbsp;</div></li><li><div>          $this-&gt;version = $matches[1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $allowed_methods = array( 'GET', 'POST' );&nbsp;</div></li><li><div>      $four_oh_five = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_help = preg_match( '#/help/?$#i', $this-&gt;path );&nbsp;</div></li><li><div>      $matching_endpoints = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_help ) {&nbsp;</div></li><li><div>          $origin = get_http_origin();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $origin ) && 'GET' == $this-&gt;method ) {&nbsp;</div></li><li><div>              header( 'Access-Control-Allow-Origin: ' . esc_url_raw( $origin ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;path = substr( rtrim( $this-&gt;path, '/' ), 0, -5 );&nbsp;</div></li><li><div>          <span class="comment">// Show help for all matching endpoints regardless of method</span>&nbsp;</div></li><li><div>          $methods = $allowed_methods;&nbsp;</div></li><li><div>          $find_all_matching_endpoints = true;&nbsp;</div></li><li><div>          <span class="comment">// How deep to truncate each endpoint's path to see if it matches this help request</span>&nbsp;</div></li><li><div>          $depth = substr_count( $this-&gt;path, '/' ) + 1;&nbsp;</div></li><li><div>          if ( false !== stripos( $this-&gt;accept, 'javascript' ) || false !== stripos( $this-&gt;accept, 'json' ) ) {&nbsp;</div></li><li><div>              $help_content_type = 'json';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $help_content_type = 'html';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( in_array( $this-&gt;method, $allowed_methods ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Only serve requested method</span>&nbsp;</div></li><li><div>              $methods = array( $this-&gt;method );&nbsp;</div></li><li><div>              $find_all_matching_endpoints = false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// We don't allow this requested method - find matching endpoints and send 405</span>&nbsp;</div></li><li><div>              $methods = $allowed_methods;&nbsp;</div></li><li><div>              $find_all_matching_endpoints = true;&nbsp;</div></li><li><div>              $four_oh_five = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Find which endpoint to serve</span>&nbsp;</div></li><li><div>      $found = false;&nbsp;</div></li><li><div>      foreach ( $this-&gt;endpoints as $endpoint_path_versions =&gt; $endpoints_by_method ) {&nbsp;</div></li><li><div>          $endpoint_path_versions = unserialize( $endpoint_path_versions );&nbsp;</div></li><li><div>          $endpoint_path = $endpoint_path_versions[0];&nbsp;</div></li><li><div>          $endpoint_min_version = $endpoint_path_versions[1];&nbsp;</div></li><li><div>          $endpoint_max_version = $endpoint_path_versions[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Make sure max_version is not less than min_version</span>&nbsp;</div></li><li><div>          if ( version_compare( $endpoint_max_version, $endpoint_min_version, '&lt;' ) ) {&nbsp;</div></li><li><div>              $endpoint_max_version = $endpoint_min_version;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $methods as $method ) {&nbsp;</div></li><li><div>              if ( !isset( $endpoints_by_method[$method] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Normalize</span>&nbsp;</div></li><li><div>              $endpoint_path = untrailingslashit( $endpoint_path );&nbsp;</div></li><li><div>              if ( $is_help ) {&nbsp;</div></li><li><div>                  <span class="comment">// Truncate path at help depth</span>&nbsp;</div></li><li><div>                  $endpoint_path = join( '/', array_slice( explode( '/', $endpoint_path ), 0, $depth ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Generate regular expression from sprintf()</span>&nbsp;</div></li><li><div>              $endpoint_path_regex = str_replace( array( '%s', '%d' ), array( '([^/?&]+)', '(\d+)' ), $endpoint_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !preg_match( &quot;#^$endpoint_path_regex\$#&quot;, $this-&gt;path, $path_pieces ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// This endpoint does not match the requested path.</span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( version_compare( $this-&gt;version, $endpoint_min_version, '&lt;' ) || version_compare( $this-&gt;version, $endpoint_max_version, '&gt;' ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// This endpoint does not match the requested version.</span>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $found = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $find_all_matching_endpoints ) {&nbsp;</div></li><li><div>                  $matching_endpoints[] = array( $endpoints_by_method[$method], $path_pieces );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// The method parameters are now in $path_pieces</span>&nbsp;</div></li><li><div>                  $endpoint = $endpoints_by_method[$method];&nbsp;</div></li><li><div>                  break 2;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$found ) {&nbsp;</div></li><li><div>          return $this-&gt;output( 404, '', 'text/plain' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $four_oh_five ) {&nbsp;</div></li><li><div>          $allowed_methods = array();&nbsp;</div></li><li><div>          foreach ( $matching_endpoints as $matching_endpoint ) {&nbsp;</div></li><li><div>              $allowed_methods[] = $matching_endpoint[0]-&gt;method;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          header( 'Allow: ' . strtoupper( join( ', ', array_unique( $allowed_methods ) ) ) );&nbsp;</div></li><li><div>          return $this-&gt;output( 405, array( 'error' =&gt; 'not_allowed', 'error_message' =&gt; 'Method not allowed' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_help ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before the API output.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string help.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'wpcom_json_api_output', 'help' );&nbsp;</div></li><li><div>          if ( 'json' === $help_content_type ) {&nbsp;</div></li><li><div>              $docs = array();&nbsp;</div></li><li><div>              foreach ( $matching_endpoints as $matching_endpoint ) {&nbsp;</div></li><li><div>                  if ( $matching_endpoint[0]-&gt;is_publicly_documentable() || WPCOM_JSON_API__DEBUG )&nbsp;</div></li><li><div>                      $docs[] = call_user_func( array( $matching_endpoint[0], 'generate_documentation' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;output( 200, $docs );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              status_header( 200 );&nbsp;</div></li><li><div>              foreach ( $matching_endpoints as $matching_endpoint ) {&nbsp;</div></li><li><div>                  if ( $matching_endpoint[0]-&gt;is_publicly_documentable() || WPCOM_JSON_API__DEBUG )&nbsp;</div></li><li><div>                      call_user_func( array( $matching_endpoint[0], 'document' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $endpoint-&gt;in_testing && !WPCOM_JSON_API__DEBUG ) {&nbsp;</div></li><li><div>          return $this-&gt;output( 404, '', 'text/plain' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** This action is documented in class.json-api.php */</span>&nbsp;</div></li><li><div>      do_action( 'wpcom_json_api_output', $endpoint-&gt;stat );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = $this-&gt;process_request( $endpoint, $path_pieces );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$response && !is_array( $response ) ) {&nbsp;</div></li><li><div>          return $this-&gt;output( 500, '', 'text/plain' );&nbsp;</div></li><li><div>      } elseif ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>          return $this-&gt;output_error( $response );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output_status_code = $this-&gt;output_status_code;&nbsp;</div></li><li><div>      $this-&gt;set_output_status_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;output( $output_status_code, $response );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function process_request( WPCOM_JSON_API_Endpoint $endpoint, $path_pieces ) {&nbsp;</div></li><li><div>      $this-&gt;endpoint = $endpoint;&nbsp;</div></li><li><div>      return call_user_func_array( array( $endpoint, 'callback' ), $path_pieces );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function output_early( $status_code, $response = null, $content_type = 'application/json' ) {&nbsp;</div></li><li><div>      $exit = $this-&gt;exit;&nbsp;</div></li><li><div>      $this-&gt;exit = false;&nbsp;</div></li><li><div>      if ( is_wp_error( $response ) )&nbsp;</div></li><li><div>          $this-&gt;output_error( $response );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $this-&gt;output( $status_code, $response, $content_type );&nbsp;</div></li><li><div>      $this-&gt;exit = $exit;&nbsp;</div></li><li><div>      if ( ! defined( 'XMLRPC_REQUEST' ) || ! XMLRPC_REQUEST ) {&nbsp;</div></li><li><div>          $this-&gt;finish_request();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function set_output_status_code( $code = 200 ) {&nbsp;</div></li><li><div>      $this-&gt;output_status_code = $code;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function output( $status_code, $response = null, $content_type = 'application/json' ) {&nbsp;</div></li><li><div>      <span class="comment">// In case output() was called before the callback returned</span>&nbsp;</div></li><li><div>      if ( $this-&gt;did_output ) {&nbsp;</div></li><li><div>          if ( $this-&gt;exit )&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          return $content_type;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;did_output = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// 400s and 404s are allowed for all origins</span>&nbsp;</div></li><li><div>      if ( 404 == $status_code || 400 == $status_code )&nbsp;</div></li><li><div>          header( 'Access-Control-Allow-Origin: *' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $response ) ) {&nbsp;</div></li><li><div>          $response = new stdClass;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'text/plain' === $content_type ) {&nbsp;</div></li><li><div>          status_header( (int) $status_code );&nbsp;</div></li><li><div>          header( 'Content-Type: text/plain' );&nbsp;</div></li><li><div>          echo $response;&nbsp;</div></li><li><div>          if ( $this-&gt;exit ) {&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $content_type;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = $this-&gt;filter_fields( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;query['http_envelope'] ) && self::is_truthy( $this-&gt;query['http_envelope'] ) ) {&nbsp;</div></li><li><div>          $response = array(&nbsp;</div></li><li><div>              'code' =&gt; (int) $status_code, &nbsp;</div></li><li><div>              'headers' =&gt; array(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'name' =&gt; 'Content-Type', &nbsp;</div></li><li><div>                      'value' =&gt; $content_type, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'body' =&gt; $response, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $status_code = 200;&nbsp;</div></li><li><div>          $content_type = 'application/json';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      status_header( (int) $status_code );&nbsp;</div></li><li><div>      header( &quot;Content-Type: $content_type&quot; );&nbsp;</div></li><li><div>      if ( isset( $this-&gt;query['callback'] ) && is_string( $this-&gt;query['callback'] ) ) {&nbsp;</div></li><li><div>          $callback = preg_replace( '/[^a-z0-9_.]/i', '', $this-&gt;query['callback'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $callback = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $callback ) {&nbsp;</div></li><li><div>          <span class="comment">// Mitigate Rosetta Flash [1] by setting the Content-Type-Options: nosniff header</span>&nbsp;</div></li><li><div>          <span class="comment">// and by prepending the JSONP response with a JS comment.</span>&nbsp;</div></li><li><div>          <span class="comment">// [1] http://miki.it/blog/2014/7/8/abusing-jsonp-with-rosetta-flash/</span>&nbsp;</div></li><li><div>          echo &quot;<span class="comment">/**/</span>$callback(&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo $this-&gt;json_encode( $response );&nbsp;</div></li><li><div>      if ( $callback ) {&nbsp;</div></li><li><div>          echo &quot;);&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;exit ) {&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content_type;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function serializable_error ( $error ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status_code = $error-&gt;get_error_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $status_code ) )&nbsp;</div></li><li><div>          $status_code = $status_code['status_code'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$status_code ) {&nbsp;</div></li><li><div>          $status_code = 400;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $response = array(&nbsp;</div></li><li><div>          'error' =&gt; $error-&gt;get_error_code(), &nbsp;</div></li><li><div>          'message' =&gt; $error-&gt;get_error_message(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'status_code' =&gt; $status_code, &nbsp;</div></li><li><div>          'errors' =&gt; $response&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function output_error( $error ) {&nbsp;</div></li><li><div>      if ( function_exists( 'bump_stats_extra' ) ) {&nbsp;</div></li><li><div>          $client_id = ! empty( $this-&gt;token_details['client_id'] ) ? $this-&gt;token_details['client_id'] : 0;&nbsp;</div></li><li><div>          bump_stats_extra( 'rest-api-errors', $client_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error_response = $this-&gt;serializable_error( $error );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;output( $error_response[ 'status_code'], $error_response['errors'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_fields( $response ) {&nbsp;</div></li><li><div>      if ( empty( $this-&gt;query['fields'] ) || ( is_array( $response ) && ! empty( $response['error'] ) ) || ! empty( $this-&gt;endpoint-&gt;custom_fields_filtering ) )&nbsp;</div></li><li><div>          return $response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $fields = array_map( 'trim', explode( ', ', $this-&gt;query['fields'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_object( $response ) ) {&nbsp;</div></li><li><div>          $response = (array) $response;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $has_filtered = false;&nbsp;</div></li><li><div>      if ( is_array( $response ) && empty( $response['ID'] ) ) {&nbsp;</div></li><li><div>          $keys_to_filter = array(&nbsp;</div></li><li><div>              'categories', &nbsp;</div></li><li><div>              'comments', &nbsp;</div></li><li><div>              'connections', &nbsp;</div></li><li><div>              'domains', &nbsp;</div></li><li><div>              'groups', &nbsp;</div></li><li><div>              'likes', &nbsp;</div></li><li><div>              'media', &nbsp;</div></li><li><div>              'notes', &nbsp;</div></li><li><div>              'posts', &nbsp;</div></li><li><div>              'services', &nbsp;</div></li><li><div>              'sites', &nbsp;</div></li><li><div>              'suggestions', &nbsp;</div></li><li><div>              'tags', &nbsp;</div></li><li><div>              'themes', &nbsp;</div></li><li><div>              'topics', &nbsp;</div></li><li><div>              'users', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $keys_to_filter as $key_to_filter ) {&nbsp;</div></li><li><div>              if ( ! isset( $response[ $key_to_filter ] ) || $has_filtered )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $response[ $key_to_filter ] as $key =&gt; $values ) {&nbsp;</div></li><li><div>                  if ( is_object( $values ) ) {&nbsp;</div></li><li><div>                      $response[ $key_to_filter ][ $key ] = (object) array_intersect_key( (array) $values, array_flip( $fields ) );&nbsp;</div></li><li><div>                  } elseif ( is_array( $values ) ) {&nbsp;</div></li><li><div>                      $response[ $key_to_filter ][ $key ] = array_intersect_key( $values, array_flip( $fields ) );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $has_filtered = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $has_filtered ) {&nbsp;</div></li><li><div>          if ( is_object( $response ) ) {&nbsp;</div></li><li><div>              $response = (object) array_intersect_key( (array) $response, array_flip( $fields ) );&nbsp;</div></li><li><div>          } else if ( is_array( $response ) ) {&nbsp;</div></li><li><div>              $response = array_intersect_key( $response, array_flip( $fields ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $response;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function ensure_http_scheme_of_home_url( $url, $path, $original_scheme ) {&nbsp;</div></li><li><div>      if ( $original_scheme ) {&nbsp;</div></li><li><div>          return $url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return preg_replace( '#^https:#', 'http:', $url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function comment_edit_pre( $comment_content ) {&nbsp;</div></li><li><div>      return htmlspecialchars_decode( $comment_content, ENT_QUOTES );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function json_encode( $data ) {&nbsp;</div></li><li><div>      return json_encode( $data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function ends_with( $haystack, $needle ) {&nbsp;</div></li><li><div>      return $needle === substr( $haystack, -strlen( $needle ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Returns the site's blog_id in the WP.com ecosystem</span>&nbsp;</div></li><li><div>  function get_blog_id_for_output() {&nbsp;</div></li><li><div>      return $this-&gt;token_details['blog_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Returns the site's local blog_id</span>&nbsp;</div></li><li><div>  function get_blog_id( $blog_id ) {&nbsp;</div></li><li><div>      return $GLOBALS['blog_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function switch_to_blog_and_validate_user( $blog_id = 0, $verify_token_for_blog = true ) {&nbsp;</div></li><li><div>      if ( $this-&gt;is_restricted_blog( $blog_id ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'unauthorized', 'User cannot access this restricted blog', 403 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( -1 == get_option( 'blog_public' ) && !current_user_can( 'read' ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'unauthorized', 'User cannot access this private blog.', 403 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $blog_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Returns true if the specified blog ID is a restricted blog</span>&nbsp;</div></li><li><div>  function is_restricted_blog( $blog_id ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters all REST API access and return a 403 unauthorized response for all Restricted blog IDs.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $array Array of Blog IDs.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $restricted_blog_ids = apply_filters( 'wpcom_json_api_restricted_blog_ids', array() );&nbsp;</div></li><li><div>      return true === in_array( $blog_id, $restricted_blog_ids );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function post_like_count( $blog_id, $post_id ) {&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_liked( $blog_id, $post_id ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_reblogged( $blog_id, $post_id ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_following( $blog_id ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_global_ID( $blog_id, $post_id ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_avatar_url( $email, $avatar_size = 96 ) {&nbsp;</div></li><li><div>      add_filter( 'pre_option_show_avatars', '__return_true', 999 );&nbsp;</div></li><li><div>      $_SERVER['HTTPS'] = 'off';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $avatar_img_element = get_avatar( $email, $avatar_size, '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$avatar_img_element || is_wp_error( $avatar_img_element ) ) {&nbsp;</div></li><li><div>          $return = '';&nbsp;</div></li><li><div>      } elseif ( !preg_match( '#src=([\'&quot;])?(.*?)(?(1)\\1|\s)#', $avatar_img_element, $matches ) ) {&nbsp;</div></li><li><div>          $return = '';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $return = esc_url_raw( htmlspecialchars_decode( $matches[2] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'pre_option_show_avatars', '__return_true', 999 );&nbsp;</div></li><li><div>      if ( '--UNset--' === $this-&gt;_server_https ) {&nbsp;</div></li><li><div>          unset( $_SERVER['HTTPS'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $_SERVER['HTTPS'] = $this-&gt;_server_https;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Traps `wp_die()` calls and outputs a JSON response instead.</span>&nbsp;</div></li><li><div><span class="comment">   * The result is always output, never returned.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|null $error_code.  Call with string to start the trapping.  Call with null to stop.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function trap_wp_die( $error_code = null ) {&nbsp;</div></li><li><div>      <span class="comment">// Stop trapping</span>&nbsp;</div></li><li><div>      if ( is_null( $error_code ) ) {&nbsp;</div></li><li><div>          $this-&gt;trapped_error = null;&nbsp;</div></li><li><div>          remove_filter( 'wp_die_handler', array( $this, 'wp_die_handler_callback' ) );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If API called via PHP, bail: don't do our custom wp_die().  Do the normal wp_die().</span>&nbsp;</div></li><li><div>      if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {&nbsp;</div></li><li><div>          if ( ! defined( 'REST_API_REQUEST' ) || ! REST_API_REQUEST ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( ! defined( 'XMLRPC_REQUEST' ) || ! XMLRPC_REQUEST ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Start trapping</span>&nbsp;</div></li><li><div>      $this-&gt;trapped_error = array(&nbsp;</div></li><li><div>          'status' =&gt; 500, &nbsp;</div></li><li><div>          'code' =&gt; $error_code, &nbsp;</div></li><li><div>          'message' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wp_die_handler', array( $this, 'wp_die_handler_callback' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wp_die_handler_callback() {&nbsp;</div></li><li><div>      return array( $this, 'wp_die_handler' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wp_die_handler( $message, $title = '', $args = array() ) {&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, array(&nbsp;</div></li><li><div>          'response' =&gt; 500, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $title ) {&nbsp;</div></li><li><div>          $message = &quot;$title: $message&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $this-&gt;trapped_error['code'] ) {&nbsp;</div></li><li><div>      case 'comment_failure' :&nbsp;</div></li><li><div>          if ( did_action( 'comment_duplicate_trigger' ) ) {&nbsp;</div></li><li><div>              $this-&gt;trapped_error['code'] = 'comment_duplicate';&nbsp;</div></li><li><div>          } else if ( did_action( 'comment_flood_trigger' ) ) {&nbsp;</div></li><li><div>              $this-&gt;trapped_error['code'] = 'comment_flood';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;trapped_error['status'] = $args['response'];&nbsp;</div></li><li><div>      $this-&gt;trapped_error['message'] = wp_kses( $message, array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We still want to exit so that code execution stops where it should.</span>&nbsp;</div></li><li><div>      <span class="comment">// Attach the JSON output to WordPress' shutdown handler</span>&nbsp;</div></li><li><div>      add_action( 'shutdown', array( $this, 'output_trapped_error' ), 0 );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function output_trapped_error() {&nbsp;</div></li><li><div>      $this-&gt;exit = false; <span class="comment">// We're already exiting once.  Don't do it twice.</span>&nbsp;</div></li><li><div>      $this-&gt;output( $this-&gt;trapped_error['status'], (object) array(&nbsp;</div></li><li><div>          'error' =&gt; $this-&gt;trapped_error['code'], &nbsp;</div></li><li><div>          'message' =&gt; $this-&gt;trapped_error['message'], &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function finish_request() {&nbsp;</div></li><li><div>      if ( function_exists( 'fastcgi_finish_request' ) )&nbsp;</div></li><li><div>          return fastcgi_finish_request();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>