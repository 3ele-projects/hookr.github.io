<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="13199"><head xmlns="http://www.w3.org/1999/xhtml"><title> modules-subscriptions | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=0046f139ba677f241259913ac7ee48d1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/modules-subscriptions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-subscriptions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-subscriptions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-file-modules-subscriptions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="modules-subscriptions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">modules-subscriptions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/modules/subscriptions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Module Name: Subscriptions</span>&nbsp;</div></li><li><div><span class="comment"> * Module Description: Allow users to subscribe to your posts and comments and receive notifications via email.</span>&nbsp;</div></li><li><div><span class="comment"> * Jumpstart Description: Give visitors two easy subscription options * while commenting, or via a separate email subscription widget you can display.</span>&nbsp;</div></li><li><div><span class="comment"> * Sort Order: 9</span>&nbsp;</div></li><li><div><span class="comment"> * Recommendation Order: 8</span>&nbsp;</div></li><li><div><span class="comment"> * First Introduced: 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * Requires Connection: Yes</span>&nbsp;</div></li><li><div><span class="comment"> * Auto Activate: Yes</span>&nbsp;</div></li><li><div><span class="comment"> * Module Tags: Social</span>&nbsp;</div></li><li><div><span class="comment"> * Feature: Jumpstart</span>&nbsp;</div></li><li><div><span class="comment"> * Additional Search Queries: subscriptions, subscription, email, follow, followers, subscribers, signup</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'jetpack_modules_loaded', 'jetpack_subscriptions_load' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Jetpack_Sync::sync_options(&nbsp;</div></li><li><div>  __FILE__, &nbsp;</div></li><li><div>  'home', &nbsp;</div></li><li><div>  'blogname', &nbsp;</div></li><li><div>  'siteurl', &nbsp;</div></li><li><div>  'page_on_front', &nbsp;</div></li><li><div>  'permalink_structure', &nbsp;</div></li><li><div>  'category_base', &nbsp;</div></li><li><div>  'rss_use_excerpt', &nbsp;</div></li><li><div>  'subscription_options', &nbsp;</div></li><li><div>  'stb_enabled', &nbsp;</div></li><li><div>  'stc_enabled', &nbsp;</div></li><li><div>  'tag_base'&nbsp;</div></li><li><div>);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Jetpack_Sync::sync_posts( __FILE__ );&nbsp;</div></li><li><div>Jetpack_Sync::sync_comments( __FILE__ );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function jetpack_subscriptions_load() {&nbsp;</div></li><li><div>  Jetpack::enable_module_configurable( __FILE__ );&nbsp;</div></li><li><div>  Jetpack::module_configuration_load( __FILE__, 'jetpack_subscriptions_configuration_load' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function jetpack_subscriptions_configuration_load() {&nbsp;</div></li><li><div>  wp_safe_redirect( admin_url( 'options-discussion.php#jetpack-subscriptions-settings' ) );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_Subscriptions {&nbsp;</div></li><li><div>  public $jetpack = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static $hash;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Singleton</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function init() {&nbsp;</div></li><li><div>      static $instance = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$instance ) {&nbsp;</div></li><li><div>          $instance = new Jetpack_Subscriptions;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Don't use COOKIEHASH as it could be shared across installs && is non-unique in multisite.</span>&nbsp;</div></li><li><div>      <span class="comment">// @see: https://twitter.com/nacin/status/378246957451333632</span>&nbsp;</div></li><li><div>      self::$hash = md5( get_option( 'siteurl' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'jetpack_xmlrpc_methods', array( $this, 'xmlrpc_methods' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// @todo remove sync from subscriptions and move elsewhere...</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add Configuration Page</span>&nbsp;</div></li><li><div>      add_action( 'admin_init', array( $this, 'configure' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set up the subscription widget.</span>&nbsp;</div></li><li><div>      add_action( 'widgets_init', array( $this, 'widget_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Catch subscription widget submits</span>&nbsp;</div></li><li><div>      if ( isset( $_REQUEST['jetpack_subscriptions_widget'] ) )&nbsp;</div></li><li><div>          add_action( 'template_redirect', array( $this, 'widget_submit' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set up the comment subscription checkboxes</span>&nbsp;</div></li><li><div>      add_action( 'comment_form', array( $this, 'comment_subscribe_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Catch comment posts and check for subscriptions.</span>&nbsp;</div></li><li><div>      add_action( 'comment_post', array( $this, 'comment_subscribe_submit' ), 50, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Adds post meta checkbox in the post submit metabox</span>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter whether or not to show the per-post subscription option.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool true = show checkbox option on all new posts | false = hide the option.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          apply_filters( 'jetpack_allow_per_post_subscriptions', false ) )&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          add_action( 'post_submitbox_misc_actions', array( $this, 'subscription_post_page_metabox' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'transition_post_status', array( $this, 'maybe_send_subscription_email' ), 10, 3 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function post_is_public( $the_post ) {&nbsp;</div></li><li><div>      if ( !$post = get_post( $the_post ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'publish' === $post-&gt;post_status && strlen( (string) $post-&gt;post_password ) &lt; 1 ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter whether posts can be emailed to subscribers.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool true Can the post be emailed to Subscribers. Default to true.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          return apply_filters( 'jetpack_is_post_mailable', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::xmlrpc_methods()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Register subscriptions methods with the Jetpack XML-RPC server.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $methods</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function xmlrpc_methods( $methods ) {&nbsp;</div></li><li><div>      return array_merge(&nbsp;</div></li><li><div>          $methods, &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'jetpack.subscriptions.subscribe' =&gt; array( $this, 'subscribe' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Disable Subscribe on Single Post</span>&nbsp;</div></li><li><div><span class="comment">   * Register post meta</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function subscription_post_page_metabox() {&nbsp;</div></li><li><div>      if ( has_filter( 'jetpack_subscriptions_exclude_these_categories' ) || has_filter( 'jetpack_subscriptions_include_only_these_categories' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>      $disable_subscribe_value = get_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', true );&nbsp;</div></li><li><div>      <span class="comment">// Nonce it</span>&nbsp;</div></li><li><div>      wp_nonce_field( 'disable_subscribe', 'disable_subscribe_nonce' );&nbsp;</div></li><li><div>      <span class="comment">// only show checkbox if post hasn't been published and is a 'post' post type.</span>&nbsp;</div></li><li><div>      if ( get_post_status( $post-&gt;ID ) !== 'publish' && get_post_type( $post-&gt;ID ) == 'post' ) : ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;misc-pub-section&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;_jetpack_dont_email_post_to_subs&quot;&gt;&lt;?php _e( 'Jetpack Subscriptions:', 'jetpack' ); ?&gt;&lt;/label&gt;&lt;br&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;checkbox&quot; name=&quot;_jetpack_dont_email_post_to_subs&quot; id=&quot;jetpack-per-post-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $disable_subscribe_value, 1, true ); ?&gt; /&gt;&nbsp;</div></li><li><div>              &lt;?php _e( 'Don&#8217;t send this to subscribers', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php endif;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks whether or not the post should be emailed to subscribers</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * It checks for the following things in order:</span>&nbsp;</div></li><li><div><span class="comment">   * - Usage of filter jetpack_subscriptions_exclude_these_categories</span>&nbsp;</div></li><li><div><span class="comment">   * - Usage of filter jetpack_subscriptions_include_only_these_categories</span>&nbsp;</div></li><li><div><span class="comment">   * - Existence of the per-post checkbox option</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Only one of these can be used at any given time.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $new_status string - the &quot;new&quot; post status of the transition when saved</span>&nbsp;</div></li><li><div><span class="comment">   * @param $old_status string - the &quot;old&quot; post status of the transition when saved</span>&nbsp;</div></li><li><div><span class="comment">   * @param $post obj - The post object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function maybe_send_subscription_email( $new_status, $old_status, $post ) {&nbsp;</div></li><li><div>      <span class="comment">// Only do things on publish</span>&nbsp;</div></li><li><div>      if ( 'publish' !== $new_status ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Array of categories that will never trigger subscription emails.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Will not send subscription emails from any post from within these categories.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args Array of category slugs or ID's.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $excluded_categories = apply_filters( 'jetpack_subscriptions_exclude_these_categories', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Never email posts from these categories</span>&nbsp;</div></li><li><div>      if ( ! empty( $excluded_categories ) && in_category( $excluded_categories, $post-&gt;ID ) ) {&nbsp;</div></li><li><div>          update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * ONLY send subscription emails for these categories</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Will ONLY send subscription emails to these categories.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args Array of category slugs or ID's.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $only_these_categories = apply_filters( 'jetpack_subscriptions_exclude_all_categories_except', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only emails posts from these categories</span>&nbsp;</div></li><li><div>      if ( ! empty( $only_these_categories ) && ! in_category( $only_these_categories, $post-&gt;ID ) ) {&nbsp;</div></li><li><div>          update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Email the post, depending on the checkbox option</span>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['disable_subscribe_nonce'] ) && wp_verify_nonce( $_POST['disable_subscribe_nonce'], 'disable_subscribe' ) ) {&nbsp;</div></li><li><div>          if ( isset( $_POST['_jetpack_dont_email_post_to_subs'] ) ) {&nbsp;</div></li><li><div>              update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', $_POST['_jetpack_dont_email_post_to_subs'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::configure()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack Subscriptions configuration screen.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function configure() {&nbsp;</div></li><li><div>      <span class="comment">// Create the section</span>&nbsp;</div></li><li><div>      add_settings_section(&nbsp;</div></li><li><div>          'jetpack_subscriptions', &nbsp;</div></li><li><div>          __( 'Jetpack Subscriptions Settings', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'subscriptions_settings_section' ), &nbsp;</div></li><li><div>          'discussion'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Subscribe to Posts ***************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_settings_field(&nbsp;</div></li><li><div>          'jetpack_subscriptions_post_subscribe', &nbsp;</div></li><li><div>          __( 'Follow Blog', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'subscription_post_subscribe_setting' ), &nbsp;</div></li><li><div>          'discussion', &nbsp;</div></li><li><div>          'jetpack_subscriptions'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      register_setting(&nbsp;</div></li><li><div>          'discussion', &nbsp;</div></li><li><div>          'stb_enabled'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Subscribe to Comments ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_settings_field(&nbsp;</div></li><li><div>          'jetpack_subscriptions_comment_subscribe', &nbsp;</div></li><li><div>          __( 'Follow Comments', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'subscription_comment_subscribe_setting' ), &nbsp;</div></li><li><div>          'discussion', &nbsp;</div></li><li><div>          'jetpack_subscriptions'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      register_setting(&nbsp;</div></li><li><div>          'discussion', &nbsp;</div></li><li><div>          'stc_enabled'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Subscription Messaging Options ******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      register_setting(&nbsp;</div></li><li><div>          'reading', &nbsp;</div></li><li><div>          'subscription_options', &nbsp;</div></li><li><div>          array( $this, 'validate_settings' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_settings_section(&nbsp;</div></li><li><div>          'email_settings', &nbsp;</div></li><li><div>          __( 'Follower Settings', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'reading_section' ), &nbsp;</div></li><li><div>          'reading'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_settings_field(&nbsp;</div></li><li><div>          'invitation', &nbsp;</div></li><li><div>          __( 'Blog follow email text', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'setting_invitation' ), &nbsp;</div></li><li><div>          'reading', &nbsp;</div></li><li><div>          'email_settings'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_settings_field(&nbsp;</div></li><li><div>          'comment-follow', &nbsp;</div></li><li><div>          __( 'Comment follow email text', 'jetpack' ), &nbsp;</div></li><li><div>          array( $this, 'setting_comment_follow' ), &nbsp;</div></li><li><div>          'reading', &nbsp;</div></li><li><div>          'email_settings'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Discussions setting section blurb</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function subscriptions_settings_section() {&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;p id=&quot;jetpack-subscriptions-settings&quot;&gt;&lt;?php _e( 'Change whether your visitors can subscribe to your posts or comments or both.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Post Subscriptions Toggle</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function subscription_post_subscribe_setting() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stb_enabled = get_option( 'stb_enabled', 1 ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;p class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;checkbox&quot; name=&quot;stb_enabled&quot; id=&quot;jetpack-post-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $stb_enabled, 1 ); ?&gt; /&gt;&nbsp;</div></li><li><div>          &lt;?php _e( &quot;Show a &lt;em&gt;'follow blog'&lt;/em&gt; option in the comment form&quot;, 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Comments Subscriptions Toggle</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function subscription_comment_subscribe_setting() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stc_enabled = get_option( 'stc_enabled', 1 ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;p class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;checkbox&quot; name=&quot;stc_enabled&quot; id=&quot;jetpack-comment-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $stc_enabled, 1 ); ?&gt; /&gt;&nbsp;</div></li><li><div>          &lt;?php _e( &quot;Show a &lt;em&gt;'follow comments'&lt;/em&gt; option in the comment form&quot;, 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function validate_settings( $settings ) {&nbsp;</div></li><li><div>      global $allowedposttags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default = $this-&gt;get_default_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Blog Follow</span>&nbsp;</div></li><li><div>      $settings['invitation'] = trim( wp_kses( $settings['invitation'], $allowedposttags ) );&nbsp;</div></li><li><div>      if ( empty( $settings['invitation'] ) )&nbsp;</div></li><li><div>          $settings['invitation'] = $default['invitation'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Comments Follow (single post)</span>&nbsp;</div></li><li><div>      $settings['comment_follow'] = trim( wp_kses( $settings['comment_follow'], $allowedposttags ) );&nbsp;</div></li><li><div>      if ( empty( $settings['comment_follow'] ) )&nbsp;</div></li><li><div>          $settings['comment_follow'] = $default['comment_follow'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function reading_section() {&nbsp;</div></li><li><div>      echo '&lt;p id=&quot;follower-settings&quot;&gt;';&nbsp;</div></li><li><div>      _e( 'These settings change emails sent from your blog to followers.', 'jetpack' );&nbsp;</div></li><li><div>      echo '&lt;/p&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setting_invitation() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      echo '&lt;textarea name=&quot;subscription_options[invitation]&quot; class=&quot;large-text&quot; cols=&quot;50&quot; rows=&quot;5&quot;&gt;' . esc_textarea( $settings['invitation'] ) . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>      echo '&lt;p&gt;&lt;span class=&quot;description&quot;&gt;'.__( 'Introduction text sent when someone follows your blog. (Site and confirmation details will be automatically added for you.)', 'jetpack' ).'&lt;/span&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setting_comment_follow() {&nbsp;</div></li><li><div>      $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>      echo '&lt;textarea name=&quot;subscription_options[comment_follow]&quot; class=&quot;large-text&quot; cols=&quot;50&quot; rows=&quot;5&quot;&gt;' . esc_textarea( $settings['comment_follow'] ) . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>      echo '&lt;p&gt;&lt;span class=&quot;description&quot;&gt;'.__( 'Introduction text sent when someone follows a post on your blog. (Site and confirmation details will be automatically added for you.)', 'jetpack' ).'&lt;/span&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_default_settings() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'invitation' =&gt; __( &quot;Howdy.\n\nYou recently followed this blog's posts. This means you will receive each new post by email.\n\nTo activate, click confirm below. If you believe this is an error, ignore this message and we'll never bother you again.&quot;, 'jetpack' ), &nbsp;</div></li><li><div>          'comment_follow' =&gt; __( &quot;Howdy.\n\nYou recently followed one of my posts. This means you will receive an email when new comments are posted.\n\nTo activate, click confirm below. If you believe this is an error, ignore this message and we'll never bother you again.&quot;, 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_settings() {&nbsp;</div></li><li><div>      return wp_parse_args( (array) get_option( 'subscription_options', array() ), $this-&gt;get_default_settings() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::subscribe()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Send a synchronous XML-RPC subscribe to blog posts or subscribe to post comments request.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $email</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $post_ids (optional) defaults to 0 for blog posts only: array of post IDs to subscribe to blog's posts</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $async    (optional) Should the subscription be performed asynchronously?  Defaults to true.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return true|Jetpack_Error true on success</span>&nbsp;</div></li><li><div><span class="comment">   *    invalid_email   : not a valid email address</span>&nbsp;</div></li><li><div><span class="comment">   *    invalid_post_id : not a valid post ID</span>&nbsp;</div></li><li><div><span class="comment">   *    unknown_post_id : unknown post</span>&nbsp;</div></li><li><div><span class="comment">   *    not_subscribed  : strange error.  Jetpack servers at WordPress.com could subscribe the email.</span>&nbsp;</div></li><li><div><span class="comment">   *    disabled        : Site owner has disabled subscriptions.</span>&nbsp;</div></li><li><div><span class="comment">   *    active          : Already subscribed.</span>&nbsp;</div></li><li><div><span class="comment">   *    unknown         : strange error.  Jetpack servers at WordPress.com returned something malformed.</span>&nbsp;</div></li><li><div><span class="comment">   *    unknown_status  : strange error.  Jetpack servers at WordPress.com returned something I didn't understand.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function subscribe( $email, $post_ids = 0, $async = true, $extra_data = array() ) {&nbsp;</div></li><li><div>      if ( !is_email( $email ) ) {&nbsp;</div></li><li><div>          return new Jetpack_Error( 'invalid_email' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$async ) {&nbsp;</div></li><li><div>          Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>          $xml = new Jetpack_IXR_ClientMulticall();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( (array) $post_ids as $post_id ) {&nbsp;</div></li><li><div>          $post_id = (int) $post_id;&nbsp;</div></li><li><div>          if ( $post_id &lt; 0 ) {&nbsp;</div></li><li><div>              return new Jetpack_Error( 'invalid_post_id' );&nbsp;</div></li><li><div>          } else if ( $post_id && !$post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>              return new Jetpack_Error( 'unknown_post_id' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $async ) {&nbsp;</div></li><li><div>              Jetpack::xmlrpc_async_call( 'jetpack.subscribeToSite', $email, $post_id, serialize( $extra_data ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $xml-&gt;addCall( 'jetpack.subscribeToSite', $email, $post_id, serialize( $extra_data ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $async ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Call</span>&nbsp;</div></li><li><div>      $xml-&gt;query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $xml-&gt;isError() ) {&nbsp;</div></li><li><div>          return $xml-&gt;get_jetpack_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $responses = $xml-&gt;getResponse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = array();&nbsp;</div></li><li><div>      foreach ( (array) $responses as $response ) {&nbsp;</div></li><li><div>          if ( isset( $response['faultCode'] ) || isset( $response['faultString'] ) ) {&nbsp;</div></li><li><div>              $r[] = $xml-&gt;get_jetpack_error( $response['faultCode'], $response['faultString'] );&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !is_array( $response[0] ) || empty( $response[0]['status'] ) ) {&nbsp;</div></li><li><div>              $r[] = new Jetpack_Error( 'unknown' );&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $response[0]['status'] ) {&nbsp;</div></li><li><div>          case 'error' :&nbsp;</div></li><li><div>              $r[] = new Jetpack_Error( 'not_subscribed' );&nbsp;</div></li><li><div>              continue 2;&nbsp;</div></li><li><div>          case 'disabled' :&nbsp;</div></li><li><div>              $r[] = new Jetpack_Error( 'disabled' );&nbsp;</div></li><li><div>              continue 2;&nbsp;</div></li><li><div>          case 'active' :&nbsp;</div></li><li><div>              $r[] = new Jetpack_Error( 'active' );&nbsp;</div></li><li><div>              continue 2;&nbsp;</div></li><li><div>          case 'pending' :&nbsp;</div></li><li><div>              $r[] = true;&nbsp;</div></li><li><div>              continue 2;&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $r[] = new Jetpack_Error( 'unknown_status', (string) $response[0]['status'] );&nbsp;</div></li><li><div>              continue 2;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::widget_init()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize and register the Jetpack Subscriptions widget.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function widget_init() {&nbsp;</div></li><li><div>      register_widget( 'Jetpack_Subscriptions_Widget' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::widget_submit()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * When a user submits their email via the blog subscription widget, check the details and call the subsribe() method.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function widget_submit() {&nbsp;</div></li><li><div>      <span class="comment">// Check the nonce.</span>&nbsp;</div></li><li><div>      if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>          check_admin_referer( 'blogsub_subscribe_' . get_current_blog_id() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_REQUEST['email'] ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect_fragment = false;&nbsp;</div></li><li><div>      if ( isset( $_REQUEST['redirect_fragment'] ) ) {&nbsp;</div></li><li><div>          $redirect_fragment = preg_replace( '/[^a-z0-9_-]/i', '', $_REQUEST['redirect_fragment'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !$redirect_fragment ) {&nbsp;</div></li><li><div>          $redirect_fragment = 'subscribe-blog';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscribe = Jetpack_Subscriptions::subscribe(&nbsp;</div></li><li><div>                                              $_REQUEST['email'], &nbsp;</div></li><li><div>                                              0, &nbsp;</div></li><li><div>                                              false, &nbsp;</div></li><li><div>                                              array(&nbsp;</div></li><li><div>                                                  'source' =&gt; 'widget', &nbsp;</div></li><li><div>                                                  'widget-in-use' =&gt; is_active_widget( false, false, 'blog_subscription', true ) ? 'yes' : 'no', &nbsp;</div></li><li><div>                                                  'comment_status' =&gt; '', &nbsp;</div></li><li><div>                                                  'server_data' =&gt; $_SERVER, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $subscribe ) ) {&nbsp;</div></li><li><div>          $error = $subscribe-&gt;get_error_code();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $error = false;&nbsp;</div></li><li><div>          foreach ( $subscribe as $response ) {&nbsp;</div></li><li><div>              if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>                  $error = $response-&gt;get_error_code();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $error ) {&nbsp;</div></li><li><div>          case false:&nbsp;</div></li><li><div>              $result = 'success';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'invalid_email':&nbsp;</div></li><li><div>              $result = $error;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'active':&nbsp;</div></li><li><div>          case 'blocked_email':&nbsp;</div></li><li><div>              $result = 'opted_out';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'pending':&nbsp;</div></li><li><div>              $result = 'already';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $result = 'error';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $redirect = add_query_arg( 'subscribe', $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires on each subscription form submission.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $result Result of form submission: success, invalid_email, already, error.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'jetpack_subscriptions_form_submission', $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_safe_redirect( &quot;$redirect#$redirect_fragment&quot; );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::comment_subscribe_init()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Set up and add the comment subscription checkbox to the comment form.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function comment_subscribe_init() {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comments_checked = '';&nbsp;</div></li><li><div>      $blog_checked = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check for a comment / blog submission and set a cookie to retain the setting and check the boxes.</span>&nbsp;</div></li><li><div>      if ( isset( $_COOKIE[ 'jetpack_comments_subscribe_' . self::$hash ] ) && $_COOKIE[ 'jetpack_comments_subscribe_' . self::$hash ] == $post-&gt;ID )&nbsp;</div></li><li><div>          $comments_checked = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_COOKIE[ 'jetpack_blog_subscribe_' . self::$hash ] ) )&nbsp;</div></li><li><div>          $blog_checked = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Some themes call this function, don't show the checkbox again</span>&nbsp;</div></li><li><div>      remove_action( 'comment_form', 'subscription_comment_form' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if Mark Jaquith's Subscribe to Comments plugin is active - if so, suppress Jetpack checkbox</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $str = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( FALSE === has_filter( 'comment_form', 'show_subscription_checkbox' ) && 1 == get_option( 'stc_enabled', 1 ) && empty( $post-&gt;post_password ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Subscribe to comments checkbox</span>&nbsp;</div></li><li><div>          $str .= '&lt;p class=&quot;comment-subscription-form&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;subscribe_comments&quot; id=&quot;subscribe_comments&quot; value=&quot;subscribe&quot; style=&quot;width: auto; -moz-appearance: checkbox; -webkit-appearance: checkbox;&quot;' . $comments_checked . ' /&gt; ';&nbsp;</div></li><li><div>          $comment_sub_text = __( 'Notify me of follow-up comments by email.', 'jetpack' );&nbsp;</div></li><li><div>          $str .=    '&lt;label class=&quot;subscribe-label&quot; id=&quot;subscribe-label&quot; for=&quot;subscribe_comments&quot;&gt;' . esc_html(&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter the Subscribe to comments text appearing below the comment form.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $comment_sub_text Subscribe to comments text.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              apply_filters( 'jetpack_subscribe_comment_label', $comment_sub_text )&nbsp;</div></li><li><div> ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>          $str .= '&lt;/p&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 1 == get_option( 'stb_enabled', 1 ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Subscribe to blog checkbox</span>&nbsp;</div></li><li><div>          $str .= '&lt;p class=&quot;comment-subscription-form&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;subscribe_blog&quot; id=&quot;subscribe_blog&quot; value=&quot;subscribe&quot; style=&quot;width: auto; -moz-appearance: checkbox; -webkit-appearance: checkbox;&quot;' . $blog_checked . ' /&gt; ';&nbsp;</div></li><li><div>          $blog_sub_text = __( 'Notify me of new posts by email.', 'jetpack' );&nbsp;</div></li><li><div>          $str .=    '&lt;label class=&quot;subscribe-label&quot; id=&quot;subscribe-blog-label&quot; for=&quot;subscribe_blog&quot;&gt;' . esc_html(&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter the Subscribe to blog text appearing below the comment form.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param string $comment_sub_text Subscribe to blog text.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              apply_filters( 'jetpack_subscribe_blog_label', $blog_sub_text )&nbsp;</div></li><li><div> ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>          $str .= '&lt;/p&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the output of the subscription options appearing below the comment form.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $str Comment Subscription form HTML output.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      echo apply_filters( 'jetpack_comment_subscription_form', $str );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::comment_subscribe_init()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * When a user checks the comment subscribe box and submits a comment, subscribe them to the comment thread.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function comment_subscribe_submit( $comment_id, $approved ) {&nbsp;</div></li><li><div>      if ( 'spam' === $approved ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set cookies for this post/comment</span>&nbsp;</div></li><li><div>      $this-&gt;set_cookies( isset( $_REQUEST['subscribe_comments'] ), isset( $_REQUEST['subscribe_blog'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset( $_REQUEST['subscribe_comments'] ) && !isset( $_REQUEST['subscribe_blog'] ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>      $post_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_REQUEST['subscribe_comments'] ) )&nbsp;</div></li><li><div>          $post_ids[] = $comment-&gt;comment_post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_REQUEST['subscribe_blog'] ) )&nbsp;</div></li><li><div>          $post_ids[] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Jetpack_Subscriptions::subscribe(&nbsp;</div></li><li><div>                                  $comment-&gt;comment_author_email, &nbsp;</div></li><li><div>                                  $post_ids, &nbsp;</div></li><li><div>                                  true, &nbsp;</div></li><li><div>                                  array(&nbsp;</div></li><li><div>                                      'source' =&gt; 'comment-form', &nbsp;</div></li><li><div>                                      'widget-in-use' =&gt; is_active_widget( false, false, 'blog_subscription', true ) ? 'yes' : 'no', &nbsp;</div></li><li><div>                                      'comment_status' =&gt; $approved, &nbsp;</div></li><li><div>                                      'server_data' =&gt; $_SERVER, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Jetpack_Subscriptions::set_cookies()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Set a cookie to save state on the comment and post subscription checkboxes.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_cookies( $comments = true, $posts = true ) {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** This filter is already documented in core/wp-includes/comment-functions.php */</span>&nbsp;</div></li><li><div>      $cookie_lifetime = apply_filters( 'comment_cookie_lifetime', 30000000 );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Jetpack Comment cookie path.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string COOKIEPATH Cookie path.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $cookie_path = apply_filters( 'jetpack_comment_cookie_path', COOKIEPATH );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Jetpack Comment cookie domain.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string COOKIE_DOMAIN Cookie domain.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $cookie_domain = apply_filters( 'jetpack_comment_cookie_domain', COOKIE_DOMAIN );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $comments )&nbsp;</div></li><li><div>          setcookie( 'jetpack_comments_subscribe_' . self::$hash, $post-&gt;ID, time() + $cookie_lifetime, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          setcookie( 'jetpack_comments_subscribe_' . self::$hash, '', time() - 3600, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $posts )&nbsp;</div></li><li><div>          setcookie( 'jetpack_blog_subscribe_' . self::$hash, 1, time() + $cookie_lifetime, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          setcookie( 'jetpack_blog_subscribe_' . self::$hash, '', time() - 3600, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Jetpack_Subscriptions::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/***</span>&nbsp;</div></li><li><div><span class="comment"> * Blog Subscription Widget</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_Subscriptions_Widget extends WP_Widget {&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $widget_ops = array( 'classname' =&gt; 'jetpack_subscription_widget', 'description' =&gt; __( 'Add an email signup form to allow people to subscribe to your blog.', 'jetpack' ) );&nbsp;</div></li><li><div>      $control_ops = array( 'width' =&gt; 300 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      parent::__construct(&nbsp;</div></li><li><div>          'blog_subscription', &nbsp;</div></li><li><div>          <span class="comment">/** This filter is documented in modules/widgets/facebook-likebox.php */</span>&nbsp;</div></li><li><div>          apply_filters( 'jetpack_widget_name', __( 'Blog Subscriptions', 'jetpack' ) ), &nbsp;</div></li><li><div>          $widget_ops, &nbsp;</div></li><li><div>          $control_ops&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function widget( $args, $instance ) {&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          ( ! defined( 'IS_WPCOM' ) || ! IS_WPCOM ) &&&nbsp;</div></li><li><div>          <span class="comment">/** This filter is already documented in modules/contact-form/grunion-contact-form.php */</span>&nbsp;</div></li><li><div>          false === apply_filters( 'jetpack_auto_fill_logged_in_user', false )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $subscribe_email = '';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          global $current_user;&nbsp;</div></li><li><div>          if ( ! empty( $current_user-&gt;user_email ) ) {&nbsp;</div></li><li><div>              $subscribe_email = esc_attr( $current_user-&gt;user_email );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $subscribe_email = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $source = 'widget';&nbsp;</div></li><li><div>      $instance = wp_parse_args( (array) $instance, $this-&gt;defaults() );&nbsp;</div></li><li><div>      $subscribe_text = isset( $instance['subscribe_text'] )        ? stripslashes( $instance['subscribe_text'] )        : '';&nbsp;</div></li><li><div>      $subscribe_placeholder = isset( $instance['subscribe_placeholder'] ) ? stripslashes( $instance['subscribe_placeholder'] ) : '';&nbsp;</div></li><li><div>      $subscribe_button = isset( $instance['subscribe_button'] )      ? stripslashes( $instance['subscribe_button'] )      : '';&nbsp;</div></li><li><div>      $success_message = isset( $instance['success_message'] )       ? stripslashes( $instance['success_message'] )      : '';&nbsp;</div></li><li><div>      $widget_id = esc_attr( !empty( $args['widget_id'] )      ? esc_attr( $args['widget_id'] ) : mt_rand( 450, 550 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $show_subscribers_total = (bool) $instance['show_subscribers_total'];&nbsp;</div></li><li><div>      $subscribers_total = $this-&gt;fetch_subscriber_count(); <span class="comment">// Only used for the shortcode [total-subscribers]</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Give the input element a unique ID</span>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the subscription form's ID prefix.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module subscriptions</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string subscribe-field Subscription form field prefix.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $widget_id Widget ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $subscribe_field_id = apply_filters( 'subscribe_field_id', 'subscribe-field', $widget_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Enqueue the form's CSS</span>&nbsp;</div></li><li><div>      wp_register_style( 'jetpack-subscriptions', plugins_url( 'subscriptions/subscriptions.css', __FILE__ ) );&nbsp;</div></li><li><div>      wp_enqueue_style( 'jetpack-subscriptions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display the subscription form</span>&nbsp;</div></li><li><div>      echo $args['before_widget'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only show the title if there actually is a title</span>&nbsp;</div></li><li><div>      if( ! empty( $instance['title'] ) ) {&nbsp;</div></li><li><div>          echo $args['before_title'] . esc_attr( $instance['title'] ) . $args['after_title'] . &quot;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $referer = set_url_scheme( 'http:<span class="comment">//' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display any errors</span>&nbsp;</div></li><li><div>      if ( isset( $_GET['subscribe'] ) ) :&nbsp;</div></li><li><div>          switch ( $_GET['subscribe'] ) :&nbsp;</div></li><li><div>              case 'invalid_email' : ?&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;error&quot;&gt;&lt;?php esc_html_e( 'The email you entered was invalid. Please check and try again.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php break;&nbsp;</div></li><li><div>              case 'opted_out' : ?&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;error&quot;&gt;&lt;?php printf( __( 'The email address has opted out of subscription emails. &lt;br /&gt; You can manage your preferences at &lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot; target=&quot;_blank&quot;&gt;subscribe.wordpress.com&lt;/a&gt;', 'jetpack' ), &nbsp;</div></li><li><div>                          'https:<span class="comment">//subscribe.wordpress.com/', </span>&nbsp;</div></li><li><div>                          __( 'Manage your email preferences.', 'jetpack' )&nbsp;</div></li><li><div> ); ?&gt;&nbsp;</div></li><li><div>              &lt;?php break;&nbsp;</div></li><li><div>              case 'already' : ?&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;error&quot;&gt;&lt;?php esc_html_e( 'You have already subscribed to this site. Please check your inbox.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php break;&nbsp;</div></li><li><div>              case 'success' : ?&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;success&quot;&gt;&lt;?php echo wpautop( str_replace( '[total-subscribers]', number_format_i18n( $subscribers_total['value'] ), $success_message ) ); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;?php break;&nbsp;</div></li><li><div>              default : ?&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;error&quot;&gt;&lt;?php esc_html_e( 'There was an error when subscribing. Please try again.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php break;&nbsp;</div></li><li><div>          endswitch;&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display a subscribe form</span>&nbsp;</div></li><li><div>      if ( isset( $_GET['subscribe'] ) && 'success' == $_GET['subscribe'] ) { ?&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      } else { ?&gt;&nbsp;</div></li><li><div>          &lt;form action=&quot;#&quot; method=&quot;post&quot; accept-charset=&quot;utf-8&quot; id=&quot;subscribe-blog-&lt;?php echo $widget_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              if ( ! isset ( $_GET['subscribe'] ) || 'success' != $_GET['subscribe'] ) {&nbsp;</div></li><li><div>                  ?&gt;&lt;div id=&quot;subscribe-text&quot;&gt;&lt;?php echo wpautop( str_replace( '[total-subscribers]', number_format_i18n( $subscribers_total['value'] ), $subscribe_text ) ); ?&gt;&lt;/div&gt;&lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $show_subscribers_total && 0 &lt; $subscribers_total['value'] ) {&nbsp;</div></li><li><div>                  echo wpautop( sprintf( _n( 'Join %s other subscriber', 'Join %s other subscribers', $subscribers_total['value'], 'jetpack' ), number_format_i18n( $subscribers_total['value'] ) ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( ! isset ( $_GET['subscribe'] ) || 'success' != $_GET['subscribe'] ) { ?&gt;&nbsp;</div></li><li><div>                  &lt;p id=&quot;subscribe-email&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label id=&quot;jetpack-subscribe-label&quot; for=&quot;&lt;?php echo esc_attr( $subscribe_field_id ) . '-' . esc_attr( $widget_id ); ?&gt;; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                          &lt;?php echo !empty( $subscribe_placeholder ) ? esc_html( $subscribe_placeholder ) : esc_html__( 'Email Address:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                      &lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;email&quot; name=&quot;email&quot; required=&quot;required&quot; class=&quot;required&quot; value=&quot;&lt;?php echo esc_attr( $subscribe_email ); ?&gt;&quot; id=&quot;&lt;?php echo esc_attr( $subscribe_field_id ) . '-' . esc_attr( $widget_id ); ?&gt;&quot; placeholder=&quot;&lt;?php echo esc_attr( $subscribe_placeholder ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;p id=&quot;subscribe-submit&quot;&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;subscribe&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;source&quot; value=&quot;&lt;?php echo esc_url( $referer ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;sub-type&quot; value=&quot;&lt;?php echo esc_attr( $source ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;redirect_fragment&quot; value=&quot;&lt;?php echo $widget_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                          if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>                              wp_nonce_field( 'blogsub_subscribe_'. get_current_blog_id(), '_wpnonce', false );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo esc_attr( $subscribe_button ); ?&gt;&quot; name=&quot;jetpack_subscriptions_widget&quot; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php }?&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;script&gt;&nbsp;</div></li><li><div>          <span class="comment">/*</span>&nbsp;</div></li><li><div><span class="comment">          Custom functionality for safari and IE</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          (function( d ) {&nbsp;</div></li><li><div>              <span class="comment">// Creates placeholders for IE</span>&nbsp;</div></li><li><div>              if ( ( 'placeholder' in d.createElement( 'input' ) ) ) {&nbsp;</div></li><li><div>                  var label = d.getElementById( 'jetpack-subscribe-label' );&nbsp;</div></li><li><div>                      label.style.clip = 'rect(1px, 1px, 1px, 1px)';&nbsp;</div></li><li><div>                      label.style.position = 'absolute';&nbsp;</div></li><li><div>                      label.style.height = '1px';&nbsp;</div></li><li><div>                      label.style.width = '1px';&nbsp;</div></li><li><div>                      label.style.overflow = 'hidden';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Make sure the email value is filled in before allowing submit</span>&nbsp;</div></li><li><div>              var form = d.getElementById('subscribe-blog-&lt;?php echo $widget_id; ?&gt;'), &nbsp;</div></li><li><div>                  input = d.getElementById('&lt;?php echo esc_attr( $subscribe_field_id ) . '-' . esc_attr( $widget_id ); ?&gt;'), &nbsp;</div></li><li><div>                  handler = function( event ) {&nbsp;</div></li><li><div>                      if ( '' === input.value ) {&nbsp;</div></li><li><div>                          input.focus();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( event.preventDefault ) {&nbsp;</div></li><li><div>                              event.preventDefault();&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( window.addEventListener ) {&nbsp;</div></li><li><div>                  form.addEventListener( 'submit', handler, false );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  form.attachEvent( 'onsubmit', handler );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          })( document );&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php } ?&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;\n&quot; . $args['after_widget'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function increment_subscriber_count( $current_subs_array = array() ) {&nbsp;</div></li><li><div>      $current_subs_array['value']++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_transient( 'wpcom_subscribers_total', $current_subs_array, 3600 ); <span class="comment"><span class="comment">// try to cache the result for at least 1 hour</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $current_subs_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function fetch_subscriber_count() {&nbsp;</div></li><li><div>      $subs_count = get_transient( 'wpcom_subscribers_total' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( FALSE === $subs_count || 'failed' == $subs_count['status'] ) {&nbsp;</div></li><li><div>          Jetpack:: load_xml_rpc_client();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $xml = new Jetpack_IXR_Client( array( 'user_id' =&gt; JETPACK_MASTER_USER, ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $xml-&gt;query( 'jetpack.fetchSubscriberCount' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $xml-&gt;isError() ) { <span class="comment">// if we get an error from .com, set the status to failed so that we will try again next time the data is requested</span>&nbsp;</div></li><li><div>              $subs_count = array(&nbsp;</div></li><li><div>                  'status' =&gt; 'failed', &nbsp;</div></li><li><div>                  'code' =&gt; $xml-&gt;getErrorCode(), &nbsp;</div></li><li><div>                  'message' =&gt; $xml-&gt;getErrorMessage(), &nbsp;</div></li><li><div>                  'value' =&gt; ( isset( $subs_count['value'] ) ) ? $subs_count['value'] : 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $subs_count = array(&nbsp;</div></li><li><div>                  'status' =&gt; 'success', &nbsp;</div></li><li><div>                  'value' =&gt; $xml-&gt;getResponse(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          set_transient( 'wpcom_subscribers_total', $subs_count, 3600 ); <span class="comment"><span class="comment">// try to cache the result for at least 1 hour</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $subs_count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function update( $new_instance, $old_instance ) {&nbsp;</div></li><li><div>      $instance = $old_instance;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $instance['title'] = wp_kses( stripslashes( $new_instance['title'] ), array() );&nbsp;</div></li><li><div>      $instance['subscribe_text'] = wp_filter_post_kses( stripslashes( $new_instance['subscribe_text'] ) );&nbsp;</div></li><li><div>      $instance['subscribe_placeholder'] = wp_kses( stripslashes( $new_instance['subscribe_placeholder'] ), array() );&nbsp;</div></li><li><div>      $instance['subscribe_button'] = wp_kses( stripslashes( $new_instance['subscribe_button'] ), array() );&nbsp;</div></li><li><div>      $instance['success_message'] = wp_kses( stripslashes( $new_instance['success_message'] ), array() );&nbsp;</div></li><li><div>      $instance['show_subscribers_total'] = isset( $new_instance['show_subscribers_total'] ) && $new_instance['show_subscribers_total'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function defaults() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'title' =&gt; esc_html__( 'Subscribe to Blog via Email', 'jetpack' ), &nbsp;</div></li><li><div>          'subscribe_text' =&gt; esc_html__( 'Enter your email address to subscribe to this blog and receive notifications of new posts by email.', 'jetpack' ), &nbsp;</div></li><li><div>          'subscribe_placeholder' =&gt; esc_html__( 'Email Address', 'jetpack' ), &nbsp;</div></li><li><div>          'subscribe_button' =&gt; esc_html__( 'Subscribe', 'jetpack' ), &nbsp;</div></li><li><div>          'success_message' =&gt; esc_html__( 'Success! An email was just sent to confirm your subscription. Please find the email now and click activate to start subscribing.', 'jetpack' ), &nbsp;</div></li><li><div>          'show_subscribers_total' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function form( $instance ) {&nbsp;</div></li><li><div>      $instance = wp_parse_args( (array) $instance, $this-&gt;defaults() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $title = stripslashes( $instance['title'] );&nbsp;</div></li><li><div>      $subscribe_text = stripslashes( $instance['subscribe_text'] );&nbsp;</div></li><li><div>      $subscribe_placeholder = stripslashes( $instance['subscribe_placeholder'] );&nbsp;</div></li><li><div>      $subscribe_button = stripslashes( $instance['subscribe_button'] );&nbsp;</div></li><li><div>      $success_message = stripslashes( $instance['success_message']);&nbsp;</div></li><li><div>      $show_subscribers_total = checked( $instance['show_subscribers_total'], true, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subs_fetch = $this-&gt;fetch_subscriber_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'failed' == $subs_fetch['status'] ) {&nbsp;</div></li><li><div>          printf( '&lt;div class=&quot;error inline&quot;&gt;&lt;p&gt;' . __( '%s: %s', 'jetpack' ) . '&lt;/p&gt;&lt;/div&gt;', esc_html( $subs_fetch['code'] ), esc_html( $subs_fetch['message'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $subscribers_total = number_format_i18n( $subs_fetch['value'] );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'title' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'Widget title:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'title' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'title' ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr( $title ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_text' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'Optional text to display to your readers:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;textarea style=&quot;width: 95%&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_text' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'subscribe_text' ); ?&gt;&quot; type=&quot;text&quot;&gt;&lt;?php echo esc_html( $subscribe_text ); ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_placeholder' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php esc_html_e( 'Subscribe Placeholder:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_placeholder' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'subscribe_placeholder' ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr( $subscribe_placeholder ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_button' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'Subscribe Button:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'subscribe_button' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'subscribe_button' ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr( $subscribe_button ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'success_message' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'Success Message Text:', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>      &lt;textarea style=&quot;width: 95%&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'success_message' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'success_message' ); ?&gt;&quot; type=&quot;text&quot;&gt;&lt;?php echo esc_html( $success_message ); ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;p&gt;&nbsp;</div></li><li><div>  &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( 'show_subscribers_total' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;checkbox&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( 'show_subscribers_total' ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( 'show_subscribers_total' ); ?&gt;&quot; value=&quot;1&quot;&lt;?php echo $show_subscribers_total; ?&gt; /&gt;&nbsp;</div></li><li><div>      &lt;?php echo esc_html( sprintf( _n( 'Show total number of subscribers? (%s subscriber)', 'Show total number of subscribers? (%s subscribers)', $subscribers_total, 'jetpack' ), $subscribers_total ) ); ?&gt;&nbsp;</div></li><li><div>  &lt;/label&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_shortcode( 'jetpack_subscription_form', 'jetpack_do_subscription_form' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function jetpack_do_subscription_form( $instance ) {&nbsp;</div></li><li><div>  $instance['show_subscribers_total'] = empty( $instance['show_subscribers_total'] ) ? false : true;&nbsp;</div></li><li><div>  $instance = shortcode_atts( Jetpack_Subscriptions_Widget::defaults(), $instance, 'jetpack_subscription_form' );&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'before_widget' =&gt; sprintf( '&lt;div class=&quot;%s&quot;&gt;', 'jetpack_subscription_widget' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  the_widget( 'Jetpack_Subscriptions_Widget', $instance, $args );&nbsp;</div></li><li><div>  $output = ob_get_clean();&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>