<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.1" data-slug="woocommerce-globalpay" data-type="file" data-id="68598"><head xmlns="http://www.w3.org/1999/xhtml"><title> trunk-woocommerce-globalpay | file | Woocommerce Globalpay | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-globalpay, 2.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=70d89ce03a71f49c1641d430d835ecbb' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/trunk-woocommerce-globalpay/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Ftrunk-woocommerce-globalpay%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Ftrunk-woocommerce-globalpay%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-globalpay-2.1-file-trunk-woocommerce-globalpay","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="trunk-woocommerce-globalpay" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-globalpay." href="http://hookr.io/plugins/woocommerce-globalpay/" class="plugin"><span property="name">woocommerce-globalpay</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.1." href="http://hookr.io/plugins/woocommerce-globalpay/2.1/" class="H_VERSION"><span property="name">2.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-globalpay/2.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">trunk-woocommerce-globalpay</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="114"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/all/" title="All">All <span class="count badge">114</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="8"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/hooks/" title="Hooks">Hooks <span class="count badge">8</span></a></li><li class="" data-id="action" data-count="4"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/actions/" title="Actions">Actions <span class="count badge">4</span></a></li><li class="" data-id="filter" data-count="4"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/filters/" title="Filters">Filters <span class="count badge">4</span></a></li><li class="" data-id="class" data-count="68"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/classes/" title="Classes">Classes <span class="count badge">68</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="38"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/functions/" title="Functions">Functions <span class="count badge">38</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-globalpay/2.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/trunk/woocommerce-globalpay.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Plugin Name: Woocommerce GlobalPay</span>&nbsp;</div></li><li><div><span class="comment"> * Plugin URI:  http://wordpress.org/plugins/woocommerce-globalpay</span>&nbsp;</div></li><li><div><span class="comment"> * Description: Allows payments to be made to a Woocommerce shop via GlobalPay</span>&nbsp;</div></li><li><div><span class="comment"> * Author:      Feyisayo Akinboboye</span>&nbsp;</div></li><li><div><span class="comment"> * Author URI:  http://twitter.com/Feyisayo</span>&nbsp;</div></li><li><div><span class="comment"> * Version:     2.1</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function woocommerce_globalpay_init() {&nbsp;</div></li><li><div><span class="comment">// The GlobalPay plugin should only be loaded if Woocommerce is installed.</span>&nbsp;</div></li><li><div>if (!class_exists('WC_Payment_Gateway')) {&nbsp;</div></li><li><div>  return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WC_GlobalPay extends WC_Payment_Gateway {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array that will hold payment information.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The response from GlobalPay's transaction lookup webservice is in XML.</span>&nbsp;</div></li><li><div><span class="comment">   * So SimpleXML is used to manipulate it but eventually it will be made into</span>&nbsp;</div></li><li><div><span class="comment">   * a single-dimension array so that it can stored as part of the order meta</span>&nbsp;</div></li><li><div><span class="comment">   * information. This variable needs to declared at class level at the</span>&nbsp;</div></li><li><div><span class="comment">   * function that converts the simpleXML object into an array is recursive.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var      array</span>&nbsp;</div></li><li><div><span class="comment">   * @access   private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $payment_info = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;id = 'globalpay';&nbsp;</div></li><li><div>    $this-&gt;icon = apply_filters('woocommerce_globalpay_icon', &nbsp;</div></li><li><div>        plugins_url('/images/globalpay_logo.png', __FILE__ ));&nbsp;</div></li><li><div>    $this-&gt;has_fields = false;&nbsp;</div></li><li><div>    $this-&gt;liveurl = 'https:<span class="comment">//www.globalpay.com.ng/Paymentgatewaycapture.aspx';</span>&nbsp;</div></li><li><div>    $this-&gt;testurl = 'https:<span class="comment">//demo.globalpay.com.ng/globalpay_demo/paymentgatewaycapture.aspx';</span>&nbsp;</div></li><li><div>    $this-&gt;method_title = __('GlobalPay', 'woocommerce');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the form fields.</span>&nbsp;</div></li><li><div>    $this-&gt;init_form_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>    $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Define user set variables.</span>&nbsp;</div></li><li><div>    $this-&gt;title = $this-&gt;settings['title'];&nbsp;</div></li><li><div>    $this-&gt;description = $this-&gt;settings['description'];&nbsp;</div></li><li><div>    $this-&gt;merchant_id = $this-&gt;settings['merchant_id'];&nbsp;</div></li><li><div>    $this-&gt;testmode = $this-&gt;settings['testmode'];&nbsp;</div></li><li><div>    $this-&gt;debug = $this-&gt;settings['debug'];&nbsp;</div></li><li><div>    $this-&gt;thanks_message = $this-&gt;settings['thanks_message'];&nbsp;</div></li><li><div>    $this-&gt;error_message = $this-&gt;settings['error_message'];&nbsp;</div></li><li><div>    $this-&gt;feedback_message = '';&nbsp;</div></li><li><div>    $this-&gt;webservice_user = $this-&gt;settings['webservice_user'];&nbsp;</div></li><li><div>    $this-&gt;webservice_password = $this-&gt;settings['webservice_password'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Actions.</span>&nbsp;</div></li><li><div>    add_action('woocommerce_receipt_globalpay', &nbsp;</div></li><li><div>      array(&$this, 'receipt_page'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    add_action('woocommerce_thankyou_' . $this-&gt;id, &nbsp;</div></li><li><div>      array(&$this, 'thankyou_page'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, &nbsp;</div></li><li><div>      array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment">// Logs</span>&nbsp;</div></li><li><div>    if ($this-&gt;debug=='yes') $this-&gt;log = $woocommerce-&gt;logger();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !$this-&gt;is_valid_for_use() ) $this-&gt;enabled = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_valid_for_use() {&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if (!in_array(get_option('woocommerce_currency'), array('NGN'))) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>  function admin_options() {&nbsp;</div></li><li><div>    echo '&lt;h3&gt;' . __('GlobalPay', 'woocommerce') . '&lt;/h3&gt;';&nbsp;</div></li><li><div>    echo '&lt;p&gt;' . __('GlobalPay works by sending the user to GlobalPay to enter their payment information.', 'woocommerce') . '&lt;/p&gt;';&nbsp;</div></li><li><div>    echo '&lt;table class=&quot;form-table&quot;&gt;';&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>    if ( $this-&gt;is_valid_for_use() ) {&nbsp;</div></li><li><div>      $this-&gt;generate_settings_html();&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;inline error&quot;&gt;&lt;p&gt;&lt;strong&gt;' . __( 'Gateway Disabled', 'woocommerce' ) . '&lt;/strong&gt;: ' . __( 'GlobalPay does not support your store currency.', 'woocommerce' ) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>    echo '&lt;/table&gt;';&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function init_form_fields() {&nbsp;</div></li><li><div>    $this-&gt;form_fields = array(&nbsp;</div></li><li><div>      'enabled' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Enable/Disable', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'label' =&gt; __( 'Enable GlobalPay', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'title' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Title', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'text', &nbsp;</div></li><li><div>        'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; __( 'GlobalPay', 'woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'description' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Description', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'textarea', &nbsp;</div></li><li><div>        'description' =&gt; __( 'This controls the description which the user sees during checkout.', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; __('Pay via GlobalPay', 'woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'merchant_id' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'GlobalPay Merchant ID', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'text', &nbsp;</div></li><li><div>        'description' =&gt; __( 'Merchant ID given to you by GlobalPay', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; __('', 'woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'thanks_message' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Thanks message', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'textarea', &nbsp;</div></li><li><div>        'description' =&gt; __( 'The message to show on a successful payment', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; __('Thank you. Your payment was successful. Your order is status is now &lt;strong&gt;processing&lt;/strong&gt;', 'woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'error_message' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Failure message', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'textarea', &nbsp;</div></li><li><div>        'description' =&gt; __( 'The message to show when a payment has failed', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; __('Sorry. Your payment was not successful', 'woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'testmode' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'GlobalPay Test Mode', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'label' =&gt; __( 'Enable GlobalPay Test Mode', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'webservice_user' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('GlobalPay webservice user ID', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'text', &nbsp;</div></li><li><div>        'description' =&gt; __( 'The user ID for the GlobalPay transaction lookup service', 'woocommerce' ), &nbsp;</div></li><li><div>        'label' =&gt; __( 'GlobalPay webservice user ID', 'woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'webservice_password' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __('GlobalPay webservice password', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'text', &nbsp;</div></li><li><div>        'description' =&gt; __( 'The password for the GlobalPay transaction lookup service', 'woocommerce' ), &nbsp;</div></li><li><div>        'label' =&gt; __( 'GlobalPay webservice user ID', 'woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'debug' =&gt; array(&nbsp;</div></li><li><div>        'title' =&gt; __( 'Debug', 'woocommerce' ), &nbsp;</div></li><li><div>        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>        'label' =&gt; __( 'Enable logging (&lt;code&gt;woocommerce/logs/globalpay.txt&lt;/code&gt;)', 'woocommerce' ), &nbsp;</div></li><li><div>        'default' =&gt; 'no'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_globalpay_args( $order ) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $txn_ref = get_current_user_id() . '-' . $order-&gt;id . '-' . time();&nbsp;</div></li><li><div>    update_post_meta($order-&gt;id, 'merch_txnref', $txn_ref);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order_total = $order-&gt;get_order_total();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;debug=='yes') {&nbsp;</div></li><li><div>      $this-&gt;log-&gt;add( 'globalpay', 'Generating payment form for order #' . $order-&gt;id . '.');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $globalpay_args = array(&nbsp;</div></li><li><div>      'merchantid' =&gt; $this-&gt;merchant_id, &nbsp;</div></li><li><div>      'amount' =&gt; $order_total, &nbsp;</div></li><li><div>      'currency' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div>      'merch_txnref' =&gt; $txn_ref, &nbsp;</div></li><li><div>      'names' =&gt; trim($order-&gt;billing_first_name .&nbsp;</div></li><li><div>          ' ' . $order-&gt;billing_last_name), &nbsp;</div></li><li><div>      'email_address' =&gt; $order-&gt;billing_email, &nbsp;</div></li><li><div>      'phone_number' =&gt; $order-&gt;billing_phone&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $globalpay_args = apply_filters('woocommerce_globalpay_args', &nbsp;</div></li><li><div>        $globalpay_args);&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    return $globalpay_args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function generate_globalpay_form( $order_id ) {&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>    $globalpay_args = $this-&gt;get_globalpay_args( $order );&nbsp;</div></li><li><div>    $globalpay_args_array = array();&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    $globalpay_adr = $this-&gt;liveurl;&nbsp;</div></li><li><div>    if ( $this-&gt;testmode == 'yes' ) {&nbsp;</div></li><li><div>      $globalpay_adr = $this-&gt;testurl;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach ($globalpay_args as $key =&gt; $value) {&nbsp;</div></li><li><div>      $globalpay_args_array[] = '&lt;input type=&quot;hidden&quot; name=&quot;' . esc_attr($key) . '&quot; value=&quot;' . esc_attr($value) . '&quot; /&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    $woocommerce-&gt;add_inline_js('&nbsp;</div></li><li><div>      jQuery(&quot;body&quot;).block({&nbsp;</div></li><li><div>        message: &quot;' . __('Thank you for your order. We are now redirecting you to GlobalPay to make payment.', 'woocommerce') .'&quot;, &nbsp;</div></li><li><div>        overlayCSS: {&nbsp;</div></li><li><div>          background: &quot;#fff&quot;, &nbsp;</div></li><li><div>          opacity: 0.6&nbsp;</div></li><li><div>        }, &nbsp;</div></li><li><div>        css: {&nbsp;</div></li><li><div>          padding:        20, &nbsp;</div></li><li><div>          textAlign:      &quot;center&quot;, &nbsp;</div></li><li><div>          color:          &quot;#555&quot;, &nbsp;</div></li><li><div>          border:         &quot;3px solid #aaa&quot;, &nbsp;</div></li><li><div>          backgroundColor:&quot;#fff&quot;, &nbsp;</div></li><li><div>          cursor:         &quot;wait&quot;, &nbsp;</div></li><li><div>          lineHeight:  &quot;32px&quot;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>      jQuery(&quot;#submit_globalpay_payment_form&quot;).click();&nbsp;</div></li><li><div>    ');&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    $form = '&lt;form action=&quot;'.esc_url( $globalpay_adr ).'&quot; method=&quot;post&quot; id=&quot;globalpay_payment_form&quot;&gt;&nbsp;</div></li><li><div>        ' . implode('', $globalpay_args_array) . '&nbsp;</div></li><li><div>        &lt;input type=&quot;submit&quot; class=&quot;button-alt&quot; id=&quot;submit_globalpay_payment_form&quot; value=&quot;'.__('Pay via GlobalPay', 'woocommerce').'&quot; /&gt; &lt;a class=&quot;button cancel&quot; href=&quot;'.esc_url( $order-&gt;get_cancel_order_url() ).'&quot;&gt;'.__('Cancel order &amp; restore cart', 'woocommerce').'&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/form&gt;';&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if ('yes' == $this-&gt;debug) {&nbsp;</div></li><li><div>      $this-&gt;log-&gt;add('globalpay', &nbsp;</div></li><li><div>        'User redirected to GlobalPay with the following:' . &quot;\r\n&quot;&nbsp;</div></li><li><div>        . 'GlobalPay URL: ' . $globalpay_adr . &quot;\r\n&quot;&nbsp;</div></li><li><div>        . print_r($globalpay_args, TRUE));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    <span class="comment">// Place the order ID and redirect URL in the session. To be used when the</span>&nbsp;</div></li><li><div>    <span class="comment">// user is redirected back from GlobalPay</span>&nbsp;</div></li><li><div>    $_SESSION['globalpay_order_id'] = $order_id;&nbsp;</div></li><li><div>    $_SESSION['globalpay_redirect_url'] = $this-&gt;get_return_url($order);&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    return $form;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function check_transaction_on_user_return() {&nbsp;</div></li><li><div>    @ob_clean();&nbsp;</div></li><li><div>    global $woocommerce;&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if ('yes' == $this-&gt;debug) {&nbsp;</div></li><li><div>      $this-&gt;log-&gt;add('globalpay', &nbsp;</div></li><li><div>        'Transaction details received on user return from GlobalPay:' . &quot;\r\n&quot;&nbsp;</div></li><li><div>        . print_r($_GET, TRUE));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if (!isset($_SESSION['globalpay_order_id'])) {&nbsp;</div></li><li><div>      wp_redirect(home_url());&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $order_id = $_SESSION['globalpay_order_id'];&nbsp;</div></li><li><div>    unset($_SESSION['globalpay_order_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $order = new WC_Order( (int) $order_id );&nbsp;</div></li><li><div>    $merch_txnref = get_post_meta($order-&gt;id, 'merch_txnref', true);&nbsp;</div></li><li><div>    if (!$order) {&nbsp;</div></li><li><div>      <span class="comment">// @todo: notify user and admin of this ie order not found</span>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    <span class="comment">//fool the thanks page into working?</span>&nbsp;</div></li><li><div>    $_GET['key'] = $order-&gt;order_key;&nbsp;</div></li><li><div>    $_GET['order'] = $order-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;get_transaction_status($merch_txnref, $order-&gt;get_order_total());&nbsp;</div></li><li><div>    foreach ($this-&gt;payment_info as $k =&gt; $v) {&nbsp;</div></li><li><div>      if ('status' != $k) {&nbsp;</div></li><li><div>        update_post_meta((int)$order_id, $k, $v);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ('completed' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Payment completed</span></span>&nbsp;</div></li><li><div>      $order-&gt;add_order_note( __('Payment completed', 'woocommerce') );&nbsp;</div></li><li><div>      $order-&gt;payment_complete();&nbsp;</div></li><li><div>      $woocommerce-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ($this-&gt;debug=='yes') $this-&gt;log-&gt;add('globalpay', 'Payment complete.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta((int) $order_id, 'Payment Method', $this-&gt;method_title);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;send_mail_successful_payment(&nbsp;</div></li><li><div>        $order-&gt;id, &nbsp;</div></li><li><div>        $order-&gt;get_order_total(), &nbsp;</div></li><li><div>        $this-&gt;payment_info['txnref'], &nbsp;</div></li><li><div>        $order-&gt;user_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    } else if ('failed' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>      $error_code = $this-&gt;payment_info['payment_status_description'];&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__('Payment Failed - ' . $error_code, 'woocommerce'));&nbsp;</div></li><li><div>      $order-&gt;update_status('failed');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $woocommerce-&gt;add_error('Transaction Failed: ' . $error_code);&nbsp;</div></li><li><div>    } else if ('on-hold' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>      $order-&gt;update_status('on-hold', sprintf(&nbsp;</div></li><li><div>          __( 'Payment pending: %s', 'woocommerce' ), &nbsp;</div></li><li><div>          'Amount discrepancy'&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      $error_code = 'Amount discrepancy';&nbsp;</div></li><li><div>      <span class="comment">// Notify admin of discrepancy in amount</span>&nbsp;</div></li><li><div>      $this-&gt;send_mail_discrepancy_in_payment($order-&gt;id, $order-&gt;user_id, &nbsp;</div></li><li><div>          $order-&gt;get_order_total(), $this-&gt;payment_info['amount']);&nbsp;</div></li><li><div>      $woocommerce-&gt;add_error('Order on hold: ' . $error_code);&nbsp;</div></li><li><div>    } else if (FALSE == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>      $order-&gt;update_status(&nbsp;</div></li><li><div>        'on-hold', &nbsp;</div></li><li><div>        sprintf (&nbsp;</div></li><li><div>          __( 'Payment pending: %s', 'woocommerce' ), &nbsp;</div></li><li><div>          $error&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $order-&gt;add_order_note(__('Payment on-hold - ' . $error, 'woocommerce'));&nbsp;</div></li><li><div>      $order-&gt;update_status('on-hold');&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $this-&gt;send_mail_payment_info_pending($order-&gt;id, &nbsp;</div></li><li><div>        $order-&gt;billing_first_name . ' ' . $order-&gt;billing_last_name);&nbsp;</div></li><li><div>      $woocommerce-&gt;add_error('There was an error while looking up the details of your payment information. A sales person has been notified');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function thankyou_page($order_id) {&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>    <span class="comment">// All elements of $order_payment_info are arrays. So when getting the</span>&nbsp;</div></li><li><div>    <span class="comment">// value get the value at the end of the array which should represent</span>&nbsp;</div></li><li><div>    <span class="comment">// the most current value</span>&nbsp;</div></li><li><div>    $order_payment_info = get_post_meta($order_id);&nbsp;</div></li><li><div>    if ('completed' == $order-&gt;status || 'processing' == $order-&gt;status) {&nbsp;</div></li><li><div>      $this-&gt;feedback_message = $this-&gt;thanks_message&nbsp;</div></li><li><div>        . '&lt;br/&gt;Below are the details of your payment transaction:'&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction reference:&lt;/strong&gt; ' . end($order_payment_info['merch_txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Customer name:&lt;/strong&gt; ' . end($order_payment_info['names'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Amount paid:&lt;/strong&gt; '&nbsp;</div></li><li><div>          . number_format(end($order_payment_info['amount']), 2)&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Currency:&lt;/strong&gt; ' . end($order_payment_info['currency'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Payment Channel:&lt;/strong&gt; ' . end($order_payment_info['channel'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;GlobalPay reference:&lt;/strong&gt; ' . end($order_payment_info['txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction status description:&lt;/strong&gt; ' . end($order_payment_info['payment_status_description']);&nbsp;</div></li><li><div>    } else if ('failed' == $order-&gt;status) {&nbsp;</div></li><li><div>      $this-&gt;feedback_message = $this-&gt;error_message&nbsp;</div></li><li><div>        . '&lt;br/&gt;Below are the details of your payment transaction:'&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction reference:&lt;/strong&gt; ' . end($order_payment_info['merch_txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Customer name:&lt;/strong&gt; ' . end($order_payment_info['names'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Amount paid:&lt;/strong&gt; '&nbsp;</div></li><li><div>          . number_format(end($order_payment_info['amount']), 2)&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Currency:&lt;/strong&gt; ' . end($order_payment_info['currency'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Payment Channel:&lt;/strong&gt; ' . end($order_payment_info['channel'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;GlobalPay reference:&lt;/strong&gt; ' . end($order_payment_info['txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction status description:&lt;/strong&gt; ' . end($order_payment_info['payment_status_description']);&nbsp;</div></li><li><div>    } else if ('on-hold' == $order-&gt;status && TRUE == $order_payment_info['amount_discrepancy']) {&nbsp;</div></li><li><div>      $this-&gt;feedback_message = 'Your payment was successful. '&nbsp;</div></li><li><div>        . 'However there was a discrepancy in the amount paid.'&nbsp;</div></li><li><div>        . '&lt;br/&gt;The order amount is &lt;strong&gt;NGN' . number_format($order-&gt;get_order_total(), 2) . '&lt;/strong&gt;'&nbsp;</div></li><li><div>        . '&lt;br/&gt;while the actual amount paid is &lt;strong&gt;NGN' . number_format(end($order_payment_info['amount']), 2) . '&lt;/strong&gt;'&nbsp;</div></li><li><div>        . '&lt;br/&gt; A sales person has already been notified of this.&lt;br/&gt;'&nbsp;</div></li><li><div>        . '&lt;br/&gt;Below are the details of your payment transaction:'&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction reference:&lt;/strong&gt; ' . end($order_payment_info['merch_txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Customer name:&lt;/strong&gt; ' . end($order_payment_info['names'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Amount paid:&lt;/strong&gt; '&nbsp;</div></li><li><div>          . number_format(end($order_payment_info['amount']), 2)&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Currency:&lt;/strong&gt; ' . end($order_payment_info['currency'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Payment Channel:&lt;/strong&gt; ' . end($order_payment_info['channel'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;GlobalPay reference:&lt;/strong&gt; ' . end($order_payment_info['txnref'])&nbsp;</div></li><li><div>        . '&lt;br/&gt;&lt;strong&gt;Transaction status description:&lt;/strong&gt; ' . end($order_payment_info['payment_status_description']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    echo wpautop($this-&gt;feedback_message);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function process_payment($order_id) {&nbsp;</div></li><li><div>    $order = new WC_Order($order_id);&nbsp;</div></li><li><div>    return array(&nbsp;</div></li><li><div>      'result' =&gt; 'success', &nbsp;</div></li><li><div>      'redirect' =&gt; add_query_arg('order', $order-&gt;id, add_query_arg('key', $order-&gt;order_key, get_permalink(woocommerce_get_page_id('pay'))))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function receipt_page( $order ) {&nbsp;</div></li><li><div>    echo '&lt;p&gt;'.__('Thank you for your order, please click the button below to pay with GlobalPay.', 'woocommerce').'&lt;/p&gt;';&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    echo $this-&gt;generate_globalpay_form( $order );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converts an object into an array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * A recursive function used to convert an object (in this case a SimpleXML</span>&nbsp;</div></li><li><div><span class="comment">   * object) into an array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see http://brian.moonspot.net/2008/06/03/stupid-php-tricks-normalizing-simplexml-data/</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $obj</span>&nbsp;</div></li><li><div><span class="comment">   *  Object to be converted</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>private function make_array($obj) {&nbsp;</div></li><li><div>  $arr = (array)$obj;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($arr)) {&nbsp;</div></li><li><div>    foreach($arr as $key=&gt;$value) {&nbsp;</div></li><li><div>      if(!is_scalar($value)) {&nbsp;</div></li><li><div>        $arr[$key] = $this-&gt;make_array($value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $arr;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Function to be used as callback for array_walk_recursive.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function fill_out_payment_info($value, $key) {&nbsp;</div></li><li><div>  $this-&gt;payment_info[$key] = $value;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Looks up transaction information from GlobalPay's lookup webservice.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the lookup is successful it fills out the class-level array $payment_info</span>&nbsp;</div></li><li><div><span class="comment"> * with the details. Otherwise it set $payment_info to FALSE. When filled out</span>&nbsp;</div></li><li><div><span class="comment"> * $payment_info should like so:</span>&nbsp;</div></li><li><div><span class="comment"> *   'status' =&gt; string 'completed' (length=10)</span>&nbsp;</div></li><li><div><span class="comment"> *   'txnref' =&gt; string '9113339143629597' (length=16)</span>&nbsp;</div></li><li><div><span class="comment"> *   'channel' =&gt; string 'mastercard' (length=10)</span>&nbsp;</div></li><li><div><span class="comment"> *   'amount' =&gt; string '2000' (length=4)</span>&nbsp;</div></li><li><div><span class="comment"> *   'payment_date' =&gt; string '12/5/2013 2:36:29 PM' (length=20)</span>&nbsp;</div></li><li><div><span class="comment"> *   'payment_status' =&gt; string 'successful' (length=10)</span>&nbsp;</div></li><li><div><span class="comment"> *   'names' =&gt; string 'John Doe' (length=19)</span>&nbsp;</div></li><li><div><span class="comment"> *   'acct_desc' =&gt; string 'False' (length=5)</span>&nbsp;</div></li><li><div><span class="comment"> *   'acct_desc_order' =&gt; string '0' (length=1)</span>&nbsp;</div></li><li><div><span class="comment"> *   'hidden' =&gt; string 'False' (length=5)</span>&nbsp;</div></li><li><div><span class="comment"> *   'xpath_field' =&gt; string '0' (length=1)</span>&nbsp;</div></li><li><div><span class="comment"> *   'currency' =&gt; string 'NGN' (length=3)</span>&nbsp;</div></li><li><div><span class="comment"> *   'email_address' =&gt; string 'john.doe@example.com' (length=29)</span>&nbsp;</div></li><li><div><span class="comment"> *   'phone_number' =&gt; string '1234567890' (length=10)</span>&nbsp;</div></li><li><div><span class="comment"> *   'merch_txnref' =&gt; string 'ref-1234567897' (length=14)</span>&nbsp;</div></li><li><div><span class="comment"> *   'payment_status_description' =&gt; string 'Transaction Successful - Approved' (length=33)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $merch_txnref</span>&nbsp;</div></li><li><div><span class="comment"> * @param number $amount</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_transaction_status ($merch_txnref, $amount) {&nbsp;</div></li><li><div>  require_once 'lib/nusoap.php';&nbsp;</div></li><li><div>  <span class="comment">// Clear previous payment info.</span>&nbsp;</div></li><li><div>  $this-&gt;payment_info = array();&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if ('yes' == $this-&gt;testmode) {&nbsp;</div></li><li><div>    $endpoint = 'https:<span class="comment">//demo.globalpay.com.ng/GlobalpayWebService_demo/service.asmx?wsdl';</span>&nbsp;</div></li><li><div>    $namespace = 'http:<span class="comment">//www.eazypaynigeria.com/globalpay_demo/';</span>&nbsp;</div></li><li><div>    $soap_action = 'http:<span class="comment">//www.eazypaynigeria.com/globalpay_demo/getTransactions';</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>    $endpoint = 'https:<span class="comment">//www.globalpay.com.ng/globalpaywebservice/service.asmx?wsdl';</span>&nbsp;</div></li><li><div>    $namespace = 'https:<span class="comment">//www.eazypaynigeria.com/globalpay/';</span>&nbsp;</div></li><li><div>    $soap_action = 'https:<span class="comment">//www.eazypaynigeria.com/globalpay/getTransactions';</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $soap_client = new nusoap_client($endpoint, true);&nbsp;</div></li><li><div>  if ($soap_client-&gt;getError()) {&nbsp;</div></li><li><div>    $this-&gt;payment_info = false;&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Set up parameters.</span>&nbsp;</div></li><li><div>  $params = array(&nbsp;</div></li><li><div>    'merch_txnref' =&gt; $merch_txnref, &nbsp;</div></li><li><div>    'channel' =&gt; '', &nbsp;</div></li><li><div>    'merchantID' =&gt; $this-&gt;merchant_id, &nbsp;</div></li><li><div>    'start_date' =&gt; '', &nbsp;</div></li><li><div>    'end_date' =&gt; '', &nbsp;</div></li><li><div>    'uid' =&gt; $this-&gt;webservice_user, &nbsp;</div></li><li><div>    'pwd' =&gt; $this-&gt;webservice_password, &nbsp;</div></li><li><div>    'payment_status' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $this-&gt;log-&gt;add('globalpay', 'Connecting to GlobalPay at ' . $endpoint);&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Connect.</span>&nbsp;</div></li><li><div>  $result = $soap_client-&gt;call(&nbsp;</div></li><li><div>    'getTransactions', &nbsp;</div></li><li><div>    array('parameters' =&gt; $params), &nbsp;</div></li><li><div>    $namespace, &nbsp;</div></li><li><div>    $soap_action , &nbsp;</div></li><li><div>    false, &nbsp;</div></li><li><div>    true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  if ($soap_client-&gt;fault) {&nbsp;</div></li><li><div>    $this-&gt;log-&gt;add('globalpay', 'Error looking transaction\n' . print_r($result, true));&nbsp;</div></li><li><div>    $this-&gt;payment_info = false;&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $err = $soap_client-&gt;getError();&nbsp;</div></li><li><div>  if ($err) {&nbsp;</div></li><li><div>    $this-&gt;log-&gt;add('globalpay', 'Error looking transaction\n' . print_r($err, true));&nbsp;</div></li><li><div>    $this-&gt;payment_info = false;&nbsp;</div></li><li><div>    return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Interpret XML string result into an object.</span>&nbsp;</div></li><li><div>  $this-&gt;payment_info['amount_discrepancy'] = FALSE;&nbsp;</div></li><li><div>  $xml = simplexml_load_string($result['getTransactionsResult']);&nbsp;</div></li><li><div>  if ('successful' == $xml-&gt;record-&gt;payment_status) {&nbsp;</div></li><li><div>    <span class="comment">// If there is an amount discrepancy flag it</span>&nbsp;</div></li><li><div>    if ($xml-&gt;record-&gt;amount != $amount) {&nbsp;</div></li><li><div>      $this-&gt;payment_info['amount_discrepancy'] = TRUE;&nbsp;</div></li><li><div>      $this-&gt;payment_info['status'] = 'on-hold';&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;payment_info['status'] = 'completed';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>    $this-&gt;payment_info['status'] = 'failed';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Add all $xml's properties to $this-&gt;payment_info</span>&nbsp;</div></li><li><div>  $xml_arr = $this-&gt;make_array($xml);&nbsp;</div></li><li><div>  array_walk_recursive($xml_arr, array($this, 'fill_out_payment_info'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ('yes' == $this-&gt;debug) {&nbsp;</div></li><li><div>    $this-&gt;log-&gt;add('globalpay', &nbsp;</div></li><li><div>      'Response dump from GlobalPay' . print_r($this-&gt;payment_info, TRUE));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Used by Orders interface to update payment information via AJAX.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> *   'processing', 'failed' or 'on-hold' if the update was successful</span>&nbsp;</div></li><li><div><span class="comment"> *   FALSE otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ajax_update_payment_info ($order_id) {&nbsp;</div></li><li><div>  $order = new WC_Order( (int) $order_id );&nbsp;</div></li><li><div>  $merch_txnref = get_post_meta($order-&gt;id, 'merch_txnref', TRUE);&nbsp;</div></li><li><div>  if (!$merch_txnref) {&nbsp;</div></li><li><div>    return FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  $this-&gt;get_transaction_status($merch_txnref, $order-&gt;get_order_total());&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  if (FALSE == $this-&gt;payment_info) {&nbsp;</div></li><li><div>    return FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Update the order information with the response from ISW</span>&nbsp;</div></li><li><div>  foreach ($this-&gt;payment_info as $k =&gt; $v) {&nbsp;</div></li><li><div>    if ('status' != $k) {&nbsp;</div></li><li><div>      update_post_meta((int)$order-&gt;id, $k, $v);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ('completed' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>    <span class="comment"><span class="comment">// Payment completed</span></span>&nbsp;</div></li><li><div>    $order-&gt;add_order_note( __('Payment completed', 'woocommerce') );&nbsp;</div></li><li><div>    $order-&gt;payment_complete();&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if ($this-&gt;debug=='yes') $this-&gt;log-&gt;add( 'globalpay', 'Payment complete.' );&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    update_post_meta( (int) $order-&gt;id, 'Payment Method', 'GlobalPay');&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    return 'completed';&nbsp;</div></li><li><div>  } else if ('on-hold' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>    $order-&gt;update_status(&nbsp;</div></li><li><div>      'on-hold', &nbsp;</div></li><li><div>      sprintf (&nbsp;</div></li><li><div>        __( 'Payment pending: %s', 'woocommerce' ), &nbsp;</div></li><li><div>        $this-&gt;payment_info['ResponseDescription']&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    return 'on-hold';&nbsp;</div></li><li><div>  } else if ('failed' == $this-&gt;payment_info['status']) {&nbsp;</div></li><li><div>    $error_code = $this-&gt;payment_info['ResponseDescription'];&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    $order-&gt;add_order_note(__('Payment Failed - ' . $error_code, 'woocommerce'));&nbsp;</div></li><li><div>    $order-&gt;update_status('failed');&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    return 'failed';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function send_mail_discrepancy_in_payment ($order_id, $user_id, $expected_amount, $amount_paid) {&nbsp;</div></li><li><div>  $orders_page = admin_url() . 'edit.php?post_type=shop_order';&nbsp;</div></li><li><div>  $site_name = get_bloginfo('name');&nbsp;</div></li><li><div>  $to = get_bloginfo ('admin_email');&nbsp;</div></li><li><div>  $subject = &quot;Discrepancy in payment for Order #$order_id&quot;;&nbsp;</div></li><li><div>  $expected_amount = number_format($expected_amount, 2);&nbsp;</div></li><li><div>  $amount_paid = number_format($amount_paid, 2);&nbsp;</div></li><li><div>  $user = get_userdata ($user_id);&nbsp;</div></li><li><div>  $name_of_user = $user-&gt;first_name . ' ' . $user-&gt;last_name;&nbsp;</div></li><li><div>  $message = &lt;&lt;&lt;HTML&nbsp;</div></li><li><div>  &lt;html&gt;&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>  &lt;title&gt;Pending payment transaction&lt;/title&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    There was a discrepancy in payment transaction for order &lt;a href = &quot;$orders_page&quot;&gt;&lt;strong&gt;$order_id&lt;/strong&gt;&lt;/a&gt; by customer &lt;strong&gt;$name_of_user&lt;/strong&gt; via GlobalPay&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    The expected amount is &lt;strong&gt;*$expected_amount&lt;/strong&gt; while the actual paid amount is &lt;strong&gt;*$amount_paid&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    This message was auto-generated by the GlobalPay payment plugin for Woocommerce at $site_name&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>HTML;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $headers[] = 'From: ' . $site_name . &quot; &lt;$to&gt;&quot;;&nbsp;</div></li><li><div>  $headers[] = 'Content-type: text/html';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_mail($to, $subject, $message, $headers);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>function send_mail_payment_info_pending ($order_id, $customer) {&nbsp;</div></li><li><div>  $orders_page = admin_url() . 'edit.php?post_type=shop_order';&nbsp;</div></li><li><div>  $site_name = get_bloginfo('name');&nbsp;</div></li><li><div>  $to = get_bloginfo ('admin_email');&nbsp;</div></li><li><div>  $subject = &quot;Order #$order_id payment information pending&quot;;&nbsp;</div></li><li><div>  $message = &lt;&lt;&lt;HTML&nbsp;</div></li><li><div>  &lt;html&gt;&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>  &lt;title&gt;Pending payment transaction&lt;/title&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>  &lt;h1&gt;&nbsp;</div></li><li><div>    Pending payment transaction&lt;/h1&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    There was a problem looking up the details of the payment transaction for order &lt;a href = &quot;$orders_page&quot;&gt;&lt;strong&gt;$order_id&lt;/strong&gt;&lt;/a&gt; by customer &lt;strong&gt;$customer&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    You can resolve this by going to the orders page of Woocommerce and clicking the button labeled &quot;R&quot; beside the order.&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    This message was auto-generated by the GlobalPay payment plugin for Woocommerce at $site_name&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>HTML;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $headers[] = 'From: ' . $site_name . &quot; &lt;$to&gt;&quot;;&nbsp;</div></li><li><div>  $headers[] = 'Content-type: text/html';&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  wp_mail($to, $subject, $message, $headers);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function send_mail_successful_payment ($order_id, $amount, $globalpay_ref, $user_id) {&nbsp;</div></li><li><div>  $user = get_userdata ($user_id);&nbsp;</div></li><li><div>  $site_name = get_bloginfo('name');&nbsp;</div></li><li><div>  $name_of_user = $user-&gt;first_name . ' ' . $user-&gt;last_name;&nbsp;</div></li><li><div>  $amount = number_format($amount, 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $to = $user-&gt;user_email;&nbsp;</div></li><li><div>  $subject = &quot;Successful payment for order #$order_id&quot;;&nbsp;</div></li><li><div>  $message = &lt;&lt;&lt;HTML&nbsp;</div></li><li><div>&lt;html&gt;&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>  &lt;title&gt;Payment successful&lt;/title&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>  &lt;h1&gt;&nbsp;</div></li><li><div>    Payment successful&lt;/h1&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    Dear $name_of_user, &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    This is to inform you that your payment of &lt;strong&gt;*$amount&lt;/strong&gt; for order &lt;strong&gt;$order_id&lt;/strong&gt; via GlobalPay was successful.&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    Your GlobalPay payment reference is &lt;strong&gt;$globalpay_ref&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>    Thanks for purchasing at $site_name&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>HTML;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $headers[] = 'From: ' . $site_name . ' &lt;' . get_bloginfo ('admin_email') . '&gt;';&nbsp;</div></li><li><div>  $headers[] = 'Content-type: text/html';&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  wp_mail($to, $subject, $message, $headers);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add the gateway to WooCommerce</span>&nbsp;</div></li><li><div><span class="comment"> **/</span>&nbsp;</div></li><li><div>function add_globalpay_gateway( $methods ) {&nbsp;</div></li><li><div>  $methods[] = 'WC_GlobalPay'; return $methods;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_payment_gateways', 'add_globalpay_gateway' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// This is called when the user is redirected from GlobalPay. It redirects the</span>&nbsp;</div></li><li><div><span class="comment">// user the &quot;Order received&quot; page</span>&nbsp;</div></li><li><div>add_action('template_redirect', 'globalpay_check_response');&nbsp;</div></li><li><div>function globalpay_check_response() {&nbsp;</div></li><li><div>global $wp_query;&nbsp;</div></li><li><div>if (isset($wp_query-&gt;query['globalpay-transaction-response']) && isset($_SESSION['globalpay_redirect_url'])) {&nbsp;</div></li><li><div>  $r = $_SESSION['globalpay_redirect_url'];&nbsp;</div></li><li><div>  unset($_SESSION['globalpay_redirect_url']);&nbsp;</div></li><li><div>  wp_redirect($r);&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// This is called when the user is being redirected to the &quot;Order received&quot;</span>&nbsp;</div></li><li><div><span class="comment">// page.</span>&nbsp;</div></li><li><div>add_action('init', 'globalpay_check_transaction_on_user_return');&nbsp;</div></li><li><div>function globalpay_check_transaction_on_user_return () {&nbsp;</div></li><li><div><span class="comment">// Ensure that $_SESSION['globalpay_redirect_url'] is NOT set as this shows</span>&nbsp;</div></li><li><div><span class="comment">// that the function globalpay_check_response() has been previously called</span>&nbsp;</div></li><li><div>if (isset($_SESSION['globalpay_order_id']) && !isset($_SESSION['globalpay_redirect_url'])) {&nbsp;</div></li><li><div>  $wc_globalpay = new WC_GlobalPay();&nbsp;</div></li><li><div>  $wc_globalpay-&gt;check_transaction_on_user_return();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_admin_order_actions', &nbsp;</div></li><li><div>'add_globalpay_requery_button', 10, 2);&nbsp;</div></li><li><div>function add_globalpay_requery_button ($actions, $the_order) {&nbsp;</div></li><li><div><span class="comment">// Do this only for GlobalPay-based payments.</span>&nbsp;</div></li><li><div>$wc_globalpay = new WC_GlobalPay();&nbsp;</div></li><li><div>if ($the_order-&gt;payment_method != $wc_globalpay-&gt;id) {&nbsp;</div></li><li><div>  return $actions;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>$actions['requery'] = array(&nbsp;</div></li><li><div>  'url' =&gt; '#', &nbsp;</div></li><li><div>  'name' =&gt; __( 'Requery', 'woocommerce-globalpay' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>return $actions;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'admin_enqueue_scripts', 'add_globalpay_requery_js' );&nbsp;</div></li><li><div>function add_globalpay_requery_js ($hook) {&nbsp;</div></li><li><div>if( 'edit.php' != $hook ) return;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>wp_enqueue_script(&nbsp;</div></li><li><div>  'ajax-script', &nbsp;</div></li><li><div>  plugins_url( 'woocommerce-globalpay-requery.js', __FILE__ ), &nbsp;</div></li><li><div>  array('jquery')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$WC_icon_dir = plugins_url() . '/woocommerce/assets/images/icons';&nbsp;</div></li><li><div>$admin_url = admin_url();&nbsp;</div></li><li><div>$processing_html_template = '&lt;a class=&quot;button tips processing&quot; href=&quot;' . $admin_url . '/admin-ajax.php?action=woocommerce-mark-order-processing&amp;order_id=ORDER_ID&quot;&gt;Processing&lt;/a&gt;';&nbsp;</div></li><li><div>$complete_html_template = '&lt;a class=&quot;button tips complete&quot; href=&quot;' . $admin_url . '/admin-ajax.php?action=woocommerce-mark-order-complete&amp;order_id=ORDER_ID&quot;&gt;Complete&lt;/a&gt;';&nbsp;</div></li><li><div>$view_html_template = '&lt;a class=&quot;button tips view&quot; href=&quot;' . $admin_url . '/post.php?post=ORDER_ID&amp;action=edit&quot;&gt;View&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>wp_localize_script(&nbsp;</div></li><li><div>  'ajax-script', 'ajax_object', &nbsp;</div></li><li><div>  array(&nbsp;</div></li><li><div>    'ajax_url' =&gt; admin_url( 'admin-ajax.php' ), &nbsp;</div></li><li><div>    'processing_html_template' =&gt; $processing_html_template, &nbsp;</div></li><li><div>    'complete_html_template' =&gt; $complete_html_template, &nbsp;</div></li><li><div>    'view_html_template' =&gt; $view_html_template&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action('wp_ajax_requery', 'globalpay_requery_callback');&nbsp;</div></li><li><div>function globalpay_requery_callback () {&nbsp;</div></li><li><div>$wc_globalpay = new WC_GlobalPay();&nbsp;</div></li><li><div>$status = $wc_globalpay-&gt;ajax_update_payment_info($_POST['the_order_id']);&nbsp;</div></li><li><div>if (FALSE === $status) {&nbsp;</div></li><li><div>  $status = '';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>echo $status;&nbsp;</div></li><li><div>die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Start a PHP session as WP does not use it.</span>&nbsp;</div></li><li><div>add_action('init', 'globalpay_start_session', 1);&nbsp;</div></li><li><div>function globalpay_start_session() {&nbsp;</div></li><li><div>if (!session_id()) {&nbsp;</div></li><li><div>  session_start();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// End the PHP session when the user logs in or logs out.</span>&nbsp;</div></li><li><div>add_action('wp_logout', 'globalpay_end_session');&nbsp;</div></li><li><div>add_action('wp_login', 'globalpay_end_session');&nbsp;</div></li><li><div>function globalpay_end_session() {&nbsp;</div></li><li><div>session_destroy ();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Clear all existing re-write rules when this plugin is activated.</span>&nbsp;</div></li><li><div>register_activation_hook(__FILE__, 'globalpay_activate');&nbsp;</div></li><li><div>function globalpay_activate() {&nbsp;</div></li><li><div>flush_rewrite_rules();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Register our custom redirect URL</span>&nbsp;</div></li><li><div>add_action('init', 'globalpay_add_endpoint');&nbsp;</div></li><li><div>function globalpay_add_endpoint() {&nbsp;</div></li><li><div>add_rewrite_endpoint('globalpay-transaction-response', EP_ALL);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter('query_vars', 'globalpay_add_query_var');&nbsp;</div></li><li><div>function globalpay_add_query_var($vars) {&nbsp;</div></li><li><div>$vars[] = 'globalpay-transaction-response';&nbsp;</div></li><li><div>return $vars;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Add Naira to the currency list.</span>&nbsp;</div></li><li><div>add_filter('woocommerce_currencies', 'add_ngn_currency');&nbsp;</div></li><li><div>function add_ngn_currency($currencies) {&nbsp;</div></li><li><div>$currencies['NGN'] = __('Nigerian Naira', 'woocommerce');&nbsp;</div></li><li><div>return $currencies;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('woocommerce_currency_symbol', 'add_ngn_currency_symbol', 10, 2);&nbsp;</div></li><li><div>function add_ngn_currency_symbol($currency_symbol, $currency) {&nbsp;</div></li><li><div>switch ($currency) {&nbsp;</div></li><li><div>  case 'NGN':&nbsp;</div></li><li><div>    $currency_symbol = '&#8358;';&nbsp;</div></li><li><div>    break;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>return $currency_symbol;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter('plugins_loaded', 'woocommerce_globalpay_init');&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Woocommerce GlobalPay</li><li><span></span>3.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>