<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.3.1" data-slug="akismet-anti-spam" data-type="file" data-id="32077"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-akismet-admin | file | Akismet Anti Spam | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, akismet-anti-spam, 3.3.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=f1148696e32e82fbc482d4775df09bc1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-akismet-admin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-akismet-admin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-akismet-admin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-akismet-anti-spam-3.3.1-file-class-akismet-admin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-akismet-admin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to akismet-anti-spam." href="http://hookr.io/plugins/akismet-anti-spam/" class="plugin"><span property="name">akismet-anti-spam</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.3.1." href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/" class="H_VERSION"><span property="name">3.3.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-akismet-admin</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="108"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/all/" title="All">All <span class="count badge">108</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="38"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/hooks/" title="Hooks">Hooks <span class="count badge">38</span></a></li><li class="" data-id="action" data-count="21"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/actions/" title="Actions">Actions <span class="count badge">21</span></a></li><li class="" data-id="filter" data-count="17"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/filters/" title="Filters">Filters <span class="count badge">17</span></a></li><li class="" data-id="class" data-count="4"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/classes/" title="Classes">Classes <span class="count badge">4</span></a></li><li class="" data-id="constant" data-count="4"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/constants/" title="Constants">Constants <span class="count badge">4</span></a></li><li class="" data-id="function" data-count="62"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/functions/" title="Functions">Functions <span class="count badge">62</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/akismet-anti-spam/3.3.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class.akismet-admin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Akismet_Admin {&nbsp;</div></li><li><div>  const NONCE = 'akismet-update-key';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $initiated = false;&nbsp;</div></li><li><div>  private static $notices = array();&nbsp;</div></li><li><div>  private static $allowed = array(&nbsp;</div></li><li><div>      'a' =&gt; array(&nbsp;</div></li><li><div>          'href' =&gt; true, &nbsp;</div></li><li><div>          'title' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'b' =&gt; array(), &nbsp;</div></li><li><div>      'code' =&gt; array(), &nbsp;</div></li><li><div>      'del' =&gt; array(&nbsp;</div></li><li><div>          'datetime' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'em' =&gt; array(), &nbsp;</div></li><li><div>      'i' =&gt; array(), &nbsp;</div></li><li><div>      'q' =&gt; array(&nbsp;</div></li><li><div>          'cite' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'strike' =&gt; array(), &nbsp;</div></li><li><div>      'strong' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function init() {&nbsp;</div></li><li><div>      if ( ! self::$initiated ) {&nbsp;</div></li><li><div>          self::init_hooks();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['action'] ) && $_POST['action'] == 'enter-key' ) {&nbsp;</div></li><li><div>          self::enter_api_key();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function init_hooks() {&nbsp;</div></li><li><div>      <span class="comment">// The standalone stats page was removed in 3.0 for an all-in-one config and stats page.</span>&nbsp;</div></li><li><div>      <span class="comment">// Redirect any links that might have been bookmarked or in browser history.</span>&nbsp;</div></li><li><div>      if ( isset( $_GET['page'] ) && 'akismet-stats-display' == $_GET['page'] ) {&nbsp;</div></li><li><div>          wp_safe_redirect( esc_url_raw( self::get_page_url( 'stats' ) ), 301 );&nbsp;</div></li><li><div>          die;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::$initiated = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_init', array( 'Akismet_Admin', 'admin_init' ) );&nbsp;</div></li><li><div>      add_action( 'admin_menu', array( 'Akismet_Admin', 'admin_menu' ), 5 ); # Priority 5, so it's called before Jetpack's admin_menu.&nbsp;</div></li><li><div>      add_action( 'admin_notices', array( 'Akismet_Admin', 'display_notice' ) );&nbsp;</div></li><li><div>      add_action( 'admin_enqueue_scripts', array( 'Akismet_Admin', 'load_resources' ) );&nbsp;</div></li><li><div>      add_action( 'activity_box_end', array( 'Akismet_Admin', 'dashboard_stats' ) );&nbsp;</div></li><li><div>      add_action( 'rightnow_end', array( 'Akismet_Admin', 'rightnow_stats' ) );&nbsp;</div></li><li><div>      add_action( 'manage_comments_nav', array( 'Akismet_Admin', 'check_for_spam_button' ) );&nbsp;</div></li><li><div>      add_action( 'admin_action_akismet_recheck_queue', array( 'Akismet_Admin', 'recheck_queue' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_akismet_recheck_queue', array( 'Akismet_Admin', 'recheck_queue' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_comment_author_deurl', array( 'Akismet_Admin', 'remove_comment_author_url' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_comment_author_reurl', array( 'Akismet_Admin', 'add_comment_author_url' ) );&nbsp;</div></li><li><div>      add_action( 'jetpack_auto_activate_akismet', array( 'Akismet_Admin', 'connect_jetpack_user' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'plugin_action_links', array( 'Akismet_Admin', 'plugin_action_links' ), 10, 2 );&nbsp;</div></li><li><div>      add_filter( 'comment_row_actions', array( 'Akismet_Admin', 'comment_row_action' ), 10, 2 );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'plugin_action_links_'.plugin_basename( plugin_dir_path( __FILE__ ) . 'akismet.php'), array( 'Akismet_Admin', 'admin_plugin_settings_link' ) );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'wxr_export_skip_commentmeta', array( 'Akismet_Admin', 'exclude_commentmeta_from_export' ), 10, 3 );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'all_plugins', array( 'Akismet_Admin', 'modify_plugin_description' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function admin_init() {&nbsp;</div></li><li><div>      load_plugin_textdomain( 'akismet' );&nbsp;</div></li><li><div>      add_meta_box( 'akismet-status', __('Comment History', 'akismet'), array( 'Akismet_Admin', 'comment_status_meta_box' ), 'comment', 'normal' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function admin_menu() {&nbsp;</div></li><li><div>      if ( class_exists( 'Jetpack' ) )&nbsp;</div></li><li><div>          add_action( 'jetpack_admin_menu', array( 'Akismet_Admin', 'load_menu' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          self::load_menu();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function admin_head() {&nbsp;</div></li><li><div>      if ( !current_user_can( 'manage_options' ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function admin_plugin_settings_link( $links ) { &nbsp;</div></li><li><div>        $settings_link = '&lt;a href=&quot;'.esc_url( self::get_page_url() ).'&quot;&gt;'.__('Settings', 'akismet').'&lt;/a&gt;';&nbsp;</div></li><li><div>        array_unshift( $links, $settings_link ); &nbsp;</div></li><li><div>        return $links; &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function load_menu() {&nbsp;</div></li><li><div>      if ( class_exists( 'Jetpack' ) )&nbsp;</div></li><li><div>          $hook = add_submenu_page( 'jetpack', __( 'Akismet' , 'akismet'), __( 'Akismet' , 'akismet'), 'manage_options', 'akismet-key-config', array( 'Akismet_Admin', 'display_page' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $hook = add_options_page( __('Akismet', 'akismet'), __('Akismet', 'akismet'), 'manage_options', 'akismet-key-config', array( 'Akismet_Admin', 'display_page' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( $GLOBALS['wp_version'], '3.3', '&gt;=' ) ) {&nbsp;</div></li><li><div>          add_action( &quot;load-$hook&quot;, array( 'Akismet_Admin', 'admin_help' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function load_resources() {&nbsp;</div></li><li><div>      global $hook_suffix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $hook_suffix, apply_filters( 'akismet_admin_page_hook_suffixes', array(&nbsp;</div></li><li><div>          'index.php', # dashboard&nbsp;</div></li><li><div>          'edit-comments.php', &nbsp;</div></li><li><div>          'comment.php', &nbsp;</div></li><li><div>          'post.php', &nbsp;</div></li><li><div>          'settings_page_akismet-key-config', &nbsp;</div></li><li><div>          'jetpack_page_akismet-key-config', &nbsp;</div></li><li><div>          'plugins.php', &nbsp;</div></li><li><div> ) ) ) ) {&nbsp;</div></li><li><div>          wp_register_style( 'akismet.css', plugin_dir_url( __FILE__ ) . '_inc/akismet.css', array(), AKISMET_VERSION );&nbsp;</div></li><li><div>          wp_enqueue_style( 'akismet.css');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_register_script( 'akismet.js', plugin_dir_url( __FILE__ ) . '_inc/akismet.js', array('jquery'), AKISMET_VERSION );&nbsp;</div></li><li><div>          wp_enqueue_script( 'akismet.js' );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $inline_js = array(&nbsp;</div></li><li><div>              'comment_author_url_nonce' =&gt; wp_create_nonce( 'comment_author_url_nonce' ), &nbsp;</div></li><li><div>              'strings' =&gt; array(&nbsp;</div></li><li><div>                  'Remove this URL' =&gt; __( 'Remove this URL' , 'akismet'), &nbsp;</div></li><li><div>                  'Removing...' =&gt; __( 'Removing...' , 'akismet'), &nbsp;</div></li><li><div>                  'URL removed' =&gt; __( 'URL removed' , 'akismet'), &nbsp;</div></li><li><div>                  '(undo)' =&gt; __( '(undo)' , 'akismet'), &nbsp;</div></li><li><div>                  'Re-adding...' =&gt; __( 'Re-adding...' , 'akismet'), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $_GET['akismet_recheck'] ) && wp_verify_nonce( $_GET['akismet_recheck'], 'akismet_recheck' ) ) {&nbsp;</div></li><li><div>              $inline_js['start_recheck'] = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_localize_script( 'akismet.js', 'WPAkismet', $inline_js );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add help to the Akismet page</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return false if not the Akismet page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function admin_help() {&nbsp;</div></li><li><div>      $current_screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Screen Content</span>&nbsp;</div></li><li><div>      if ( current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>          if ( !Akismet::get_api_key() || ( isset( $_GET['view'] ) && $_GET['view'] == 'start' ) ) {&nbsp;</div></li><li><div>              <span class="comment">//setup page</span>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'overview', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Overview' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Setup' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'Akismet filters out spam, so you can focus on more important things.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'On this page, you are able to set up the Akismet plugin.' , 'akismet') . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'setup-signup', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'New to Akismet' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Setup' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'You need to enter an API key to activate the Akismet service on your site.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . sprintf( __( 'Sign up for an account on %s to get an API Key.' , 'akismet'), '&lt;a href=&quot;https:<span class="comment">//akismet.com/plugin-signup/&quot; target=&quot;_blank&quot;&gt;Akismet.com&lt;/a&gt;' ) . '&lt;/p&gt;', </span>&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'setup-manual', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Enter an API Key' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Setup' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'If you already have an API key' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;ol&gt;' .&nbsp;</div></li><li><div>                              '&lt;li&gt;' . esc_html__( 'Copy and paste the API key into the text field.' , 'akismet') . '&lt;/li&gt;' .&nbsp;</div></li><li><div>                              '&lt;li&gt;' . esc_html__( 'Click the Use this Key button.' , 'akismet') . '&lt;/li&gt;' .&nbsp;</div></li><li><div>                          '&lt;/ol&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          elseif ( isset( $_GET['view'] ) && $_GET['view'] == 'stats' ) {&nbsp;</div></li><li><div>              <span class="comment">//stats page</span>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'overview', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Overview' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Stats' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'Akismet filters out spam, so you can focus on more important things.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'On this page, you are able to view stats on spam filtered on your site.' , 'akismet') . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              <span class="comment">//configuration page</span>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'overview', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Overview' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Configuration' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'Akismet filters out spam, so you can focus on more important things.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;' . esc_html__( 'On this page, you are able to enter/remove an API key, view account information and view spam stats.' , 'akismet') . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'settings', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Settings' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Configuration' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'API Key' , 'akismet') . '&lt;/strong&gt; - ' . esc_html__( 'Enter/remove an API key.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Comments' , 'akismet') . '&lt;/strong&gt; - ' . esc_html__( 'Show the number of approved comments beside each comment author in the comments list page.' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Strictness' , 'akismet') . '&lt;/strong&gt; - ' . esc_html__( 'Choose to either discard the worst spam automatically or to always put all spam in spam folder.' , 'akismet') . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $current_screen-&gt;add_help_tab(&nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; 'account', &nbsp;</div></li><li><div>                      'title' =&gt; __( 'Account' , 'akismet'), &nbsp;</div></li><li><div>                      'content' =&gt;&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Akismet Configuration' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Subscription Type' , 'akismet') . '&lt;/strong&gt; - ' . esc_html__( 'The Akismet subscription plan' , 'akismet') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>                          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'Status' , 'akismet') . '&lt;/strong&gt; - ' . esc_html__( 'The subscription status - active, cancelled or suspended' , 'akismet') . '&lt;/p&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Help Sidebar</span>&nbsp;</div></li><li><div>      $current_screen-&gt;set_help_sidebar(&nbsp;</div></li><li><div>          '&lt;p&gt;&lt;strong&gt;' . esc_html__( 'For more information:' , 'akismet') . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>          '&lt;p&gt;&lt;a href=&quot;https:<span class="comment">//akismet.com/faq/&quot; target=&quot;_blank&quot;&gt;'     . esc_html__( 'Akismet FAQ' , 'akismet') . '&lt;/a&gt;&lt;/p&gt;' .</span>&nbsp;</div></li><li><div>          '&lt;p&gt;&lt;a href=&quot;https:<span class="comment">//akismet.com/support/&quot; target=&quot;_blank&quot;&gt;' . esc_html__( 'Akismet Support' , 'akismet') . '&lt;/a&gt;&lt;/p&gt;'</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function enter_api_key() {&nbsp;</div></li><li><div>      if ( function_exists('current_user_can') && !current_user_can('manage_options') )&nbsp;</div></li><li><div>          die(__('Cheatin&#8217; uh?', 'akismet'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !wp_verify_nonce( $_POST['_wpnonce'], self::NONCE ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( array( 'akismet_strictness', 'akismet_show_user_comments_approved' ) as $option ) {&nbsp;</div></li><li><div>          update_option( $option, isset( $_POST[$option] ) && (int) $_POST[$option] == 1 ? '1' : '0' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'WPCOM_API_KEY' ) )&nbsp;</div></li><li><div>          return false; <span class="comment">//shouldn't have option to save key if already defined</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_key = preg_replace( '/[^a-f0-9]/i', '', $_POST['key'] );&nbsp;</div></li><li><div>      $old_key = Akismet::get_api_key();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $new_key ) ) {&nbsp;</div></li><li><div>          if ( !empty( $old_key ) ) {&nbsp;</div></li><li><div>              delete_option( 'wordpress_api_key' );&nbsp;</div></li><li><div>              self::$notices[] = 'new-key-empty';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( $new_key != $old_key ) {&nbsp;</div></li><li><div>          self::save_key( $new_key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function save_key( $api_key ) {&nbsp;</div></li><li><div>      $key_status = Akismet::verify_key( $api_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $key_status == 'valid' ) {&nbsp;</div></li><li><div>          $akismet_user = self::get_akismet_user( $api_key );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( $akismet_user ) {                &nbsp;</div></li><li><div>              if ( in_array( $akismet_user-&gt;status, array( 'active', 'active-dunning', 'no-sub' ) ) )&nbsp;</div></li><li><div>                  update_option( 'wordpress_api_key', $api_key );&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              if ( $akismet_user-&gt;status == 'active' )&nbsp;</div></li><li><div>                  self::$notices['status'] = 'new-key-valid';&nbsp;</div></li><li><div>              elseif ( $akismet_user-&gt;status == 'notice' )&nbsp;</div></li><li><div>                  self::$notices['status'] = $akismet_user;&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  self::$notices['status'] = $akismet_user-&gt;status;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              self::$notices['status'] = 'new-key-invalid';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( in_array( $key_status, array( 'invalid', 'failed' ) ) )&nbsp;</div></li><li><div>          self::$notices['status'] = 'new-key-'.$key_status;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function dashboard_stats() {&nbsp;</div></li><li><div>      if ( !function_exists('did_action') || did_action( 'rightnow_end' ) )&nbsp;</div></li><li><div>          return; <span class="comment">// We already displayed this info in the &quot;Right Now&quot; section</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$count = get_option('akismet_spam_count') )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $submenu;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo '&lt;h3&gt;' . esc_html( _x( 'Spam', 'comments' , 'akismet') ) . '&lt;/h3&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo '&lt;p&gt;'.sprintf( _n(&nbsp;</div></li><li><div>              '&lt;a href=&quot;%1$s&quot;&gt;Akismet&lt;/a&gt; has protected your site from &lt;a href=&quot;%2$s&quot;&gt;%3$s spam comment&lt;/a&gt;.', &nbsp;</div></li><li><div>              '&lt;a href=&quot;%1$s&quot;&gt;Akismet&lt;/a&gt; has protected your site from &lt;a href=&quot;%2$s&quot;&gt;%3$s spam comments&lt;/a&gt;.', &nbsp;</div></li><li><div>              $count&nbsp;</div></li><li><div> , 'akismet'), 'https:<span class="comment">//akismet.com/wordpress/', esc_url( add_query_arg( array( 'page' =&gt; 'akismet-admin' ), admin_url( isset( $submenu['edit-comments.php'] ) ? 'edit-comments.php' : 'edit.php' ) ) ), number_format_i18n($count) ).'&lt;/p&gt;';</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// WP 2.5+</span>&nbsp;</div></li><li><div>  public static function rightnow_stats() {&nbsp;</div></li><li><div>      if ( $count = get_option('akismet_spam_count') ) {&nbsp;</div></li><li><div>          $intro = sprintf( _n(&nbsp;</div></li><li><div>              '&lt;a href=&quot;%1$s&quot;&gt;Akismet&lt;/a&gt; has protected your site from %2$s spam comment already. ', &nbsp;</div></li><li><div>              '&lt;a href=&quot;%1$s&quot;&gt;Akismet&lt;/a&gt; has protected your site from %2$s spam comments already. ', &nbsp;</div></li><li><div>              $count&nbsp;</div></li><li><div> , 'akismet'), 'https:<span class="comment">//akismet.com/wordpress/', number_format_i18n( $count ) );</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $intro = sprintf( __('&lt;a href=&quot;%s&quot;&gt;Akismet&lt;/a&gt; blocks spam from getting to your blog. ', 'akismet'), 'https:<span class="comment">//akismet.com/wordpress/' );</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $link = add_query_arg( array( 'comment_status' =&gt; 'spam' ), admin_url( 'edit-comments.php' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $queue_count = self::get_spam_count() ) {&nbsp;</div></li><li><div>          $queue_text = sprintf( _n(&nbsp;</div></li><li><div>              'There&#8217;s &lt;a href=&quot;%2$s&quot;&gt;%1$s comment&lt;/a&gt; in your spam queue right now.', &nbsp;</div></li><li><div>              'There are &lt;a href=&quot;%2$s&quot;&gt;%1$s comments&lt;/a&gt; in your spam queue right now.', &nbsp;</div></li><li><div>              $queue_count&nbsp;</div></li><li><div> , 'akismet'), number_format_i18n( $queue_count ), esc_url( $link ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $queue_text = sprintf( __( &quot;There&#8217;s nothing in your &lt;a href='%s'&gt;spam queue&lt;/a&gt; at the moment.&quot; , 'akismet'), esc_url( $link ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $text = $intro . '&lt;br /&gt;' . $queue_text;&nbsp;</div></li><li><div>      echo &quot;&lt;p class='akismet-right-now'&gt;$text&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function check_for_spam_button( $comment_status ) {&nbsp;</div></li><li><div>      <span class="comment">// The &quot;Check for Spam&quot; button should only appear when the page might be showing</span>&nbsp;</div></li><li><div>      <span class="comment">// a comment with comment_approved=0, which means an un-trashed, un-spammed, </span>&nbsp;</div></li><li><div>      <span class="comment">// not-yet-moderated comment.</span>&nbsp;</div></li><li><div>      if ( 'all' != $comment_status && 'moderated' != $comment_status ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists('plugins_url') )&nbsp;</div></li><li><div>          $link = add_query_arg( array( 'action' =&gt; 'akismet_recheck_queue' ), admin_url( 'admin.php' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $link = add_query_arg( array( 'page' =&gt; 'akismet-admin', 'recheckqueue' =&gt; 'true', 'noheader' =&gt; 'true' ), admin_url( 'edit-comments.php' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;alignleft&quot;&gt;';&nbsp;</div></li><li><div>      echo '&lt;a&nbsp;</div></li><li><div>              class=&quot;button-secondary checkforspam&quot;&nbsp;</div></li><li><div>              href=&quot;' . esc_url( $link ) . '&quot;&nbsp;</div></li><li><div>              data-active-label=&quot;' . esc_attr( __( 'Checking for Spam', 'akismet' ) ) . '&quot;&nbsp;</div></li><li><div>              data-progress-label-format=&quot;' . esc_attr( __( '(%1$s...)', 'akismet' ) ) . '&quot;&nbsp;</div></li><li><div>              data-success-url=&quot;' . esc_attr( remove_query_arg( 'akismet_recheck', add_query_arg( array( 'akismet_recheck_complete' =&gt; 1, 'recheck_count' =&gt; urlencode( '__recheck_count__' ), 'spam_count' =&gt; urlencode( '__spam_count__' ) ) ) ) ) . '&quot;&nbsp;</div></li><li><div>              &gt;';&nbsp;</div></li><li><div>          echo '&lt;span class=&quot;akismet-label&quot;&gt;' . esc_html__('Check for Spam', 'akismet') . '&lt;/span&gt;';&nbsp;</div></li><li><div>          echo '&lt;span class=&quot;checkforspam-progress&quot;&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>      echo '&lt;/a&gt;';&nbsp;</div></li><li><div>      echo '&lt;span class=&quot;checkforspam-spinner&quot;&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function recheck_queue() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Akismet::fix_scheduled_recheck();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! ( isset( $_GET['recheckqueue'] ) || ( isset( $_REQUEST['action'] ) && 'akismet_recheck_queue' == $_REQUEST['action'] ) ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result_counts = self::recheck_queue_portion( empty( $_POST['offset'] ) ? 0 : $_POST['offset'], empty( $_POST['limit'] ) ? 100 : $_POST['limit'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {&nbsp;</div></li><li><div>          wp_send_json( array(&nbsp;</div></li><li><div>              'counts' =&gt; $result_counts, &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $redirect_to = isset( $_SERVER['HTTP_REFERER'] ) ? $_SERVER['HTTP_REFERER'] : admin_url( 'edit-comments.php' );&nbsp;</div></li><li><div>          wp_safe_redirect( $redirect_to );&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function recheck_queue_portion( $start = 0, $limit = 100 ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $paginate = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $limit &lt;= 0 ) {&nbsp;</div></li><li><div>          $limit = 100;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $start &lt; 0 ) {&nbsp;</div></li><li><div>          $start = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $moderation = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT * FROM {$wpdb-&gt;comments} WHERE comment_approved = '0' LIMIT %d OFFSET %d&quot;, $limit, $start ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result_counts = array(&nbsp;</div></li><li><div>          'processed' =&gt; count( $moderation ), &nbsp;</div></li><li><div>          'spam' =&gt; 0, &nbsp;</div></li><li><div>          'ham' =&gt; 0, &nbsp;</div></li><li><div>          'error' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $moderation as $comment_id ) {&nbsp;</div></li><li><div>          $api_response = Akismet::recheck_comment( $comment_id, 'recheck_queue' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'true' === $api_response ) {&nbsp;</div></li><li><div>              ++$result_counts['spam'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          elseif ( 'false' === $api_response ) {&nbsp;</div></li><li><div>              ++$result_counts['ham'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              ++$result_counts['error'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result_counts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Adds an 'x' link next to author URLs, clicking will remove the author URL and show an undo link</span>&nbsp;</div></li><li><div>  public static function remove_comment_author_url() {&nbsp;</div></li><li><div>      if ( !empty( $_POST['id'] ) && check_admin_referer( 'comment_author_url_nonce' ) ) {&nbsp;</div></li><li><div>          $comment_id = intval( $_POST['id'] );&nbsp;</div></li><li><div>          $comment = get_comment( $comment_id, ARRAY_A );&nbsp;</div></li><li><div>          if ( $comment && current_user_can( 'edit_comment', $comment['comment_ID'] ) ) {&nbsp;</div></li><li><div>              $comment['comment_author_url'] = '';&nbsp;</div></li><li><div>              do_action( 'comment_remove_author_url' );&nbsp;</div></li><li><div>              print( wp_update_comment( $comment ) );&nbsp;</div></li><li><div>              die();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function add_comment_author_url() {&nbsp;</div></li><li><div>      if ( !empty( $_POST['id'] ) && !empty( $_POST['url'] ) && check_admin_referer( 'comment_author_url_nonce' ) ) {&nbsp;</div></li><li><div>          $comment_id = intval( $_POST['id'] );&nbsp;</div></li><li><div>          $comment = get_comment( $comment_id, ARRAY_A );&nbsp;</div></li><li><div>          if ( $comment && current_user_can( 'edit_comment', $comment['comment_ID'] ) ) {&nbsp;</div></li><li><div>              $comment['comment_author_url'] = esc_url( $_POST['url'] );&nbsp;</div></li><li><div>              do_action( 'comment_add_author_url' );&nbsp;</div></li><li><div>              print( wp_update_comment( $comment ) );&nbsp;</div></li><li><div>              die();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function comment_row_action( $a, $comment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// failsafe for old WP versions</span>&nbsp;</div></li><li><div>      if ( !function_exists('add_comment_meta') )&nbsp;</div></li><li><div>          return $a;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $akismet_result = get_comment_meta( $comment-&gt;comment_ID, 'akismet_result', true );&nbsp;</div></li><li><div>      $akismet_error = get_comment_meta( $comment-&gt;comment_ID, 'akismet_error', true );&nbsp;</div></li><li><div>      $user_result = get_comment_meta( $comment-&gt;comment_ID, 'akismet_user_result', true);&nbsp;</div></li><li><div>      $comment_status = wp_get_comment_status( $comment-&gt;comment_ID );&nbsp;</div></li><li><div>      $desc = null;&nbsp;</div></li><li><div>      if ( $akismet_error ) {&nbsp;</div></li><li><div>          $desc = __( 'Awaiting spam check' , 'akismet');&nbsp;</div></li><li><div>      } elseif ( !$user_result || $user_result == $akismet_result ) {&nbsp;</div></li><li><div>          <span class="comment">// Show the original Akismet result if the user hasn't overridden it, or if their decision was the same</span>&nbsp;</div></li><li><div>          if ( $akismet_result == 'true' && $comment_status != 'spam' && $comment_status != 'trash' )&nbsp;</div></li><li><div>              $desc = __( 'Flagged as spam by Akismet' , 'akismet');&nbsp;</div></li><li><div>          elseif ( $akismet_result == 'false' && $comment_status == 'spam' )&nbsp;</div></li><li><div>              $desc = __( 'Cleared by Akismet' , 'akismet');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $who = get_comment_meta( $comment-&gt;comment_ID, 'akismet_user', true );&nbsp;</div></li><li><div>          if ( $user_result == 'true' )&nbsp;</div></li><li><div>              $desc = sprintf( __('Flagged as spam by %s', 'akismet'), $who );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $desc = sprintf( __('Un-spammed by %s', 'akismet'), $who );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add a History item to the hover links, just after Edit</span>&nbsp;</div></li><li><div>      if ( $akismet_result ) {&nbsp;</div></li><li><div>          $b = array();&nbsp;</div></li><li><div>          foreach ( $a as $k =&gt; $item ) {&nbsp;</div></li><li><div>              $b[ $k ] = $item;&nbsp;</div></li><li><div>              if (&nbsp;</div></li><li><div>                  $k == 'edit'&nbsp;</div></li><li><div>                  || ( $k == 'unspam' && $GLOBALS['wp_version'] &gt;= 3.4 )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                  $b['history'] = '&lt;a href=&quot;comment.php?action=editcomment&amp;c='.$comment-&gt;comment_ID.'#akismet-status&quot; title=&quot;'. esc_attr__( 'View comment history' , 'akismet') . '&quot;&gt; '. esc_html__('History', 'akismet') . '&lt;/a&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $a = $b;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $desc )&nbsp;</div></li><li><div>          echo '&lt;span class=&quot;akismet-status&quot; commentid=&quot;'.$comment-&gt;comment_ID.'&quot;&gt;&lt;a href=&quot;comment.php?action=editcomment&amp;c='.$comment-&gt;comment_ID.'#akismet-status&quot; title=&quot;' . esc_attr__( 'View comment history' , 'akismet') . '&quot;&gt;'.esc_html( $desc ).'&lt;/a&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $show_user_comments_option = get_option( 'akismet_show_user_comments_approved' );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( $show_user_comments_option === false ) {&nbsp;</div></li><li><div>          <span class="comment">// Default to active if the user hasn't made a decision.</span>&nbsp;</div></li><li><div>          $show_user_comments_option = '1';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $show_user_comments = apply_filters( 'akismet_show_user_comments_approved', $show_user_comments_option );&nbsp;</div></li><li><div>      $show_user_comments = $show_user_comments === 'false' ? false : $show_user_comments; <span class="comment">//option used to be saved as 'false' / 'true'</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( $show_user_comments ) {&nbsp;</div></li><li><div>          $comment_count = Akismet::get_user_comments_approved( $comment-&gt;user_id, $comment-&gt;comment_author_email, $comment-&gt;comment_author, $comment-&gt;comment_author_url );&nbsp;</div></li><li><div>          $comment_count = intval( $comment_count );&nbsp;</div></li><li><div>          echo '&lt;span class=&quot;akismet-user-comment-count&quot; commentid=&quot;'.$comment-&gt;comment_ID.'&quot; style=&quot;display:none;&quot;&gt;&lt;br&gt;&lt;span class=&quot;akismet-user-comment-counts&quot;&gt;'. sprintf( esc_html( _n( '%s approved', '%s approved', $comment_count , 'akismet') ), number_format_i18n( $comment_count ) ) . '&lt;/span&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $a;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function comment_status_meta_box( $comment ) {&nbsp;</div></li><li><div>      $history = Akismet::get_comment_history( $comment-&gt;comment_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $history ) {&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;akismet-history&quot; style=&quot;margin: 13px;&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $history as $row ) {&nbsp;</div></li><li><div>              $time = date( 'D d M Y @ h:i:m a', $row['time'] ) . ' GMT';&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              $message = '';&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              if ( ! empty( $row['message'] ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// Old versions of Akismet stored the message as a literal string in the commentmeta.</span>&nbsp;</div></li><li><div>                  <span class="comment">// New versions don't do that for two reasons:</span>&nbsp;</div></li><li><div>                  <span class="comment">// 1) Save space.</span>&nbsp;</div></li><li><div>                  <span class="comment">// 2) The message can be translated into the current language of the blog, not stuck </span>&nbsp;</div></li><li><div>                  <span class="comment">//    in the language of the blog when the comment was made.</span>&nbsp;</div></li><li><div>                  $message = $row['message'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              <span class="comment">// If possible, use a current translation.</span>&nbsp;</div></li><li><div>              switch ( $row['event'] ) {&nbsp;</div></li><li><div>                  case 'recheck-spam';&nbsp;</div></li><li><div>                      $message = __( 'Akismet re-checked and caught this comment as spam.', 'akismet' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'check-spam':&nbsp;</div></li><li><div>                      $message = __( 'Akismet caught this comment as spam.', 'akismet' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'recheck-ham':&nbsp;</div></li><li><div>                      $message = __( 'Akismet re-checked and cleared this comment.', 'akismet' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'check-ham':&nbsp;</div></li><li><div>                      $message = __( 'Akismet cleared this comment.', 'akismet' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'wp-blacklisted':&nbsp;</div></li><li><div>                      $message = __( 'Comment was caught by wp_blacklist_check.', 'akismet' );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'report-spam':&nbsp;</div></li><li><div>                      if ( isset( $row['user'] ) ) {&nbsp;</div></li><li><div>                          $message = sprintf( __( '%s reported this comment as spam.', 'akismet' ), $row['user'] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else if ( ! $message ) {&nbsp;</div></li><li><div>                          $message = __( 'This comment was reported as spam.', 'akismet' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'report-ham':&nbsp;</div></li><li><div>                      if ( isset( $row['user'] ) ) {&nbsp;</div></li><li><div>                          $message = sprintf( __( '%s reported this comment as not spam.', 'akismet' ), $row['user'] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else if ( ! $message ) {&nbsp;</div></li><li><div>                          $message = __( 'This comment was reported as not spam.', 'akismet' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'cron-retry-spam':&nbsp;</div></li><li><div>                      $message = __( 'Akismet caught this comment as spam during an automatic retry.' , 'akismet');&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'cron-retry-ham':&nbsp;</div></li><li><div>                      $message = __( 'Akismet cleared this comment during an automatic retry.', 'akismet');&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'check-error':&nbsp;</div></li><li><div>                      if ( isset( $row['meta'], $row['meta']['response'] ) ) {&nbsp;</div></li><li><div>                          $message = sprintf( __( 'Akismet was unable to check this comment (response: %s) but will automatically retry later.', 'akismet'), $row['meta']['response'] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  case 'recheck-error':&nbsp;</div></li><li><div>                      if ( isset( $row['meta'], $row['meta']['response'] ) ) {&nbsp;</div></li><li><div>                          $message = sprintf( __( 'Akismet was unable to recheck this comment (response: %s).', 'akismet'), $row['meta']['response'] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  default:&nbsp;</div></li><li><div>                      if ( preg_match( '/^status-changed/', $row['event'] ) ) {&nbsp;</div></li><li><div>                          <span class="comment">// Half of these used to be saved without the dash after 'status-changed'.</span>&nbsp;</div></li><li><div>                          <span class="comment">// See https://plugins.trac.wordpress.org/changeset/1150658/akismet/trunk</span>&nbsp;</div></li><li><div>                          $new_status = preg_replace( '/^status-changed-?/', '', $row['event'] );&nbsp;</div></li><li><div>                          $message = sprintf( __( 'Comment status was changed to %s', 'akismet' ), $new_status );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else if ( preg_match( '/^status-/', $row['event'] ) ) {&nbsp;</div></li><li><div>                          $new_status = preg_replace( '/^status-/', '', $row['event'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( isset( $row['user'] ) ) {&nbsp;</div></li><li><div>                              $message = sprintf( __( '%1$s changed the comment status to %2$s.', 'akismet' ), $row['user'], $new_status );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo '&lt;div style=&quot;margin-bottom: 13px;&quot;&gt;';&nbsp;</div></li><li><div>                  echo '&lt;span style=&quot;color: #999;&quot; alt=&quot;' . $time . '&quot; title=&quot;' . $time . '&quot;&gt;' . sprintf( esc_html__('%s ago', 'akismet'), human_time_diff( $row['time'] ) ) . '&lt;/span&gt;';&nbsp;</div></li><li><div>                  echo ' - ';&nbsp;</div></li><li><div>                  echo esc_html( $message );&nbsp;</div></li><li><div>              echo '&lt;/div&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function plugin_action_links( $links, $file ) {&nbsp;</div></li><li><div>      if ( $file == plugin_basename( plugin_dir_url( __FILE__ ) . '/akismet.php' ) ) {&nbsp;</div></li><li><div>          $links[] = '&lt;a href=&quot;' . esc_url( self::get_page_url() ) . '&quot;&gt;'.esc_html__( 'Settings' , 'akismet').'&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Total spam in queue</span>&nbsp;</div></li><li><div>  <span class="comment">// get_option( 'akismet_spam_count' ) is the total caught ever</span>&nbsp;</div></li><li><div>  public static function get_spam_count( $type = false ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$type ) { <span class="comment">// total</span>&nbsp;</div></li><li><div>          $count = wp_cache_get( 'akismet_spam_count', 'widget' );&nbsp;</div></li><li><div>          if ( false === $count ) {&nbsp;</div></li><li><div>              if ( function_exists('wp_count_comments') ) {&nbsp;</div></li><li><div>                  $count = wp_count_comments();&nbsp;</div></li><li><div>                  $count = $count-&gt;spam;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $count = (int) $wpdb-&gt;get_var(&quot;SELECT COUNT(comment_ID) FROM {$wpdb-&gt;comments} WHERE comment_approved = 'spam'&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              wp_cache_set( 'akismet_spam_count', $count, 'widget', 3600 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $count;&nbsp;</div></li><li><div>      } elseif ( 'comments' == $type || 'comment' == $type ) { <span class="comment">// comments</span>&nbsp;</div></li><li><div>          $type = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (int) $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT COUNT(comment_ID) FROM {$wpdb-&gt;comments} WHERE comment_approved = 'spam' AND comment_type = %s&quot;, $type ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check connectivity between the WordPress blog and Akismet's servers.</span>&nbsp;</div></li><li><div>  <span class="comment">// Returns an associative array of server IP addresses, where the key is the IP address, and value is true (available) or false (unable to connect).</span>&nbsp;</div></li><li><div>  public static function check_server_ip_connectivity() {&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $servers = $ips = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Some web hosts may disable this function</span>&nbsp;</div></li><li><div>      if ( function_exists('gethostbynamel') ) {    &nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $ips = gethostbynamel( 'rest.akismet.com' );&nbsp;</div></li><li><div>          if ( $ips && is_array($ips) && count($ips) ) {&nbsp;</div></li><li><div>              $api_key = Akismet::get_api_key();&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              foreach ( $ips as $ip ) {&nbsp;</div></li><li><div>                  $response = Akismet::verify_key( $api_key, $ip );&nbsp;</div></li><li><div>                  <span class="comment">// even if the key is invalid, at least we know we have connectivity</span>&nbsp;</div></li><li><div>                  if ( $response == 'valid' || $response == 'invalid' )&nbsp;</div></li><li><div>                      $servers[$ip] = 'connected';&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $servers[$ip] = $response ? $response : 'unable to connect';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $servers;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// Simpler connectivity check</span>&nbsp;</div></li><li><div>  public static function check_server_connectivity($cache_timeout = 86400) {&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $debug = array();&nbsp;</div></li><li><div>      $debug[ 'PHP_VERSION' ]         = PHP_VERSION;&nbsp;</div></li><li><div>      $debug[ 'WORDPRESS_VERSION' ]   = $GLOBALS['wp_version'];&nbsp;</div></li><li><div>      $debug[ 'AKISMET_VERSION' ]     = AKISMET_VERSION;&nbsp;</div></li><li><div>      $debug[ 'AKISMET__PLUGIN_DIR' ] = AKISMET__PLUGIN_DIR;&nbsp;</div></li><li><div>      $debug[ 'SITE_URL' ]            = site_url();&nbsp;</div></li><li><div>      $debug[ 'HOME_URL' ]            = home_url();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $servers = get_option('akismet_available_servers');&nbsp;</div></li><li><div>      if ( (time() - get_option('akismet_connectivity_time') &lt; $cache_timeout) && $servers !== false ) {&nbsp;</div></li><li><div>          $servers = self::check_server_ip_connectivity();&nbsp;</div></li><li><div>          update_option('akismet_available_servers', $servers);&nbsp;</div></li><li><div>          update_option('akismet_connectivity_time', time());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_http_supports' ) && ( wp_http_supports( array( 'ssl' ) ) ) ) {&nbsp;</div></li><li><div>          $response = wp_remote_get( 'https:<span class="comment"><span class="comment">//rest.akismet.com/1.1/test' );</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $response = wp_remote_get( 'http:<span class="comment"><span class="comment">//rest.akismet.com/1.1/test' );</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $debug[ 'gethostbynamel' ]  = function_exists('gethostbynamel') ? 'exists' : 'not here';&nbsp;</div></li><li><div>      $debug[ 'Servers' ]         = $servers;&nbsp;</div></li><li><div>      $debug[ 'Test Connection' ] = $response;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      Akismet::log( $debug );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( $response && 'connected' == wp_remote_retrieve_body( $response ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the server connectivity and store the available servers in an option. </span>&nbsp;</div></li><li><div>  public static function get_server_connectivity($cache_timeout = 86400) {&nbsp;</div></li><li><div>      return self::check_server_connectivity( $cache_timeout );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_number_spam_waiting() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      return (int) $wpdb-&gt;get_var( &quot;SELECT COUNT(*) FROM {$wpdb-&gt;commentmeta} WHERE meta_key = 'akismet_error'&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_page_url( $page = 'config' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array( 'page' =&gt; 'akismet-key-config' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $page == 'stats' )&nbsp;</div></li><li><div>          $args = array( 'page' =&gt; 'akismet-key-config', 'view' =&gt; 'stats' );&nbsp;</div></li><li><div>      elseif ( $page == 'delete_key' )&nbsp;</div></li><li><div>          $args = array( 'page' =&gt; 'akismet-key-config', 'view' =&gt; 'start', 'action' =&gt; 'delete-key', '_wpnonce' =&gt; wp_create_nonce( self::NONCE ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg( $args, class_exists( 'Jetpack' ) ? admin_url( 'admin.php' ) : admin_url( 'options-general.php' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function get_akismet_user( $api_key ) {&nbsp;</div></li><li><div>      $akismet_user = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscription_verification = Akismet::http_post( Akismet::build_query( array( 'key' =&gt; $api_key, 'blog' =&gt; get_option( 'home' ) ) ), 'get-subscription' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $subscription_verification[1] ) ) {&nbsp;</div></li><li><div>          if ( 'invalid' !== $subscription_verification[1] ) {&nbsp;</div></li><li><div>              $akismet_user = json_decode( $subscription_verification[1] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $akismet_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function get_stats( $api_key ) {&nbsp;</div></li><li><div>      $stat_totals = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( array( '6-months', 'all' ) as $interval ) {&nbsp;</div></li><li><div>          $response = Akismet::http_post( Akismet::build_query( array( 'blog' =&gt; get_option( 'home' ), 'key' =&gt; $api_key, 'from' =&gt; $interval ) ), 'get-stats' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $response[1] ) ) {&nbsp;</div></li><li><div>              $stat_totals[$interval] = json_decode( $response[1] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $stat_totals;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function verify_wpcom_key( $api_key, $user_id, $extra = array() ) {&nbsp;</div></li><li><div>      $akismet_account = Akismet::http_post( Akismet::build_query( array_merge( array(&nbsp;</div></li><li><div>          'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>          'api_key' =&gt; $api_key, &nbsp;</div></li><li><div>          'get_account_type' =&gt; 'true'&nbsp;</div></li><li><div> ), $extra ) ), 'verify-wpcom-key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $akismet_account[1] ) )&nbsp;</div></li><li><div>          $akismet_account = json_decode( $akismet_account[1] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Akismet::log( compact( 'akismet_account' ) );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $akismet_account;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function connect_jetpack_user() {&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>      if ( $jetpack_user = self::get_jetpack_user() ) {&nbsp;</div></li><li><div>          if ( isset( $jetpack_user['user_id'] ) && isset(  $jetpack_user['api_key'] ) ) {&nbsp;</div></li><li><div>              $akismet_user = self::verify_wpcom_key( $jetpack_user['api_key'], $jetpack_user['user_id'], array( 'action' =&gt; 'connect_jetpack_user' ) );&nbsp;</div></li><li><div>                          &nbsp;</div></li><li><div>              if ( is_object( $akismet_user ) ) {&nbsp;</div></li><li><div>                  self::save_key( $akismet_user-&gt;api_key );&nbsp;</div></li><li><div>                  return in_array( $akismet_user-&gt;status, array( 'active', 'active-dunning', 'no-sub' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_alert() {&nbsp;</div></li><li><div>      Akismet::view( 'notice', array(&nbsp;</div></li><li><div>          'type' =&gt; 'alert', &nbsp;</div></li><li><div>          'code' =&gt; (int) get_option( 'akismet_alert_code' ), &nbsp;</div></li><li><div>          'msg' =&gt; get_option( 'akismet_alert_msg' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_spam_check_warning() {&nbsp;</div></li><li><div>      Akismet::fix_scheduled_recheck();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wp_next_scheduled('akismet_schedule_cron_recheck') &gt; time() && self::get_number_spam_waiting() &gt; 0 ) {&nbsp;</div></li><li><div>          $link_text = apply_filters( 'akismet_spam_check_warning_link_text', sprintf( __( 'Please check your &lt;a href=&quot;%s&quot;&gt;Akismet configuration&lt;/a&gt; and contact your web host if problems persist.', 'akismet'), esc_url( self::get_page_url() ) ) );&nbsp;</div></li><li><div>          Akismet::view( 'notice', array( 'type' =&gt; 'spam-check', 'link_text' =&gt; $link_text ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_api_key_warning() {&nbsp;</div></li><li><div>      Akismet::view( 'notice', array( 'type' =&gt; 'plugin' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_page() {&nbsp;</div></li><li><div>      if ( !Akismet::get_api_key() || ( isset( $_GET['view'] ) && $_GET['view'] == 'start' ) )&nbsp;</div></li><li><div>          self::display_start_page();&nbsp;</div></li><li><div>      elseif ( isset( $_GET['view'] ) && $_GET['view'] == 'stats' )&nbsp;</div></li><li><div>          self::display_stats_page();&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          self::display_configuration_page();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_start_page() {&nbsp;</div></li><li><div>      if ( isset( $_GET['action'] ) ) {&nbsp;</div></li><li><div>          if ( $_GET['action'] == 'delete-key' ) {&nbsp;</div></li><li><div>              if ( isset( $_GET['_wpnonce'] ) && wp_verify_nonce( $_GET['_wpnonce'], self::NONCE ) )&nbsp;</div></li><li><div>                  delete_option( 'wordpress_api_key' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $api_key = Akismet::get_api_key() && ( empty( self::$notices['status'] ) || 'existing-key-invalid' != self::$notices['status'] ) ) {&nbsp;</div></li><li><div>          self::display_configuration_page();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">//the user can choose to auto connect their API key by clicking a button on the akismet done page</span>&nbsp;</div></li><li><div>      <span class="comment">//if jetpack, get verified api key by using connected wpcom user id</span>&nbsp;</div></li><li><div>      <span class="comment">//if no jetpack, get verified api key by using an akismet token    </span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $akismet_user = false;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( isset( $_GET['token'] ) && preg_match('/^(\d+)-[0-9a-f]{20}$/', $_GET['token'] ) )&nbsp;</div></li><li><div>          $akismet_user = self::verify_wpcom_key( '', '', array( 'token' =&gt; $_GET['token'] ) );&nbsp;</div></li><li><div>      elseif ( $jetpack_user = self::get_jetpack_user() )&nbsp;</div></li><li><div>          $akismet_user = self::verify_wpcom_key( $jetpack_user['api_key'], $jetpack_user['user_id'] );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      if ( isset( $_GET['action'] ) ) {&nbsp;</div></li><li><div>          if ( $_GET['action'] == 'save-key' ) {&nbsp;</div></li><li><div>              if ( is_object( $akismet_user ) ) {&nbsp;</div></li><li><div>                  self::save_key( $akismet_user-&gt;api_key );&nbsp;</div></li><li><div>                  self::display_configuration_page();&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Akismet::view( 'start', compact( 'akismet_user' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      // To see all variants when testing.</span>&nbsp;</div></li><li><div><span class="comment">      $akismet_user-&gt;status = 'no-sub';</span>&nbsp;</div></li><li><div><span class="comment">      Akismet::view( 'start', compact( 'akismet_user' ) );</span>&nbsp;</div></li><li><div><span class="comment">      $akismet_user-&gt;status = 'cancelled';</span>&nbsp;</div></li><li><div><span class="comment">      Akismet::view( 'start', compact( 'akismet_user' ) );</span>&nbsp;</div></li><li><div><span class="comment">      $akismet_user-&gt;status = 'suspended';</span>&nbsp;</div></li><li><div><span class="comment">      Akismet::view( 'start', compact( 'akismet_user' ) );</span>&nbsp;</div></li><li><div><span class="comment">      $akismet_user-&gt;status = 'other';</span>&nbsp;</div></li><li><div><span class="comment">      Akismet::view( 'start', compact( 'akismet_user' ) );</span>&nbsp;</div></li><li><div><span class="comment">      $akismet_user = false;</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_stats_page() {&nbsp;</div></li><li><div>      Akismet::view( 'stats' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_configuration_page() {&nbsp;</div></li><li><div>      $api_key = Akismet::get_api_key();&nbsp;</div></li><li><div>      $akismet_user = self::get_akismet_user( $api_key );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( ! $akismet_user ) {&nbsp;</div></li><li><div>          <span class="comment">// This could happen if the user's key became invalid after it was previously valid and successfully set up.</span>&nbsp;</div></li><li><div>          self::$notices['status'] = 'existing-key-invalid';&nbsp;</div></li><li><div>          self::display_start_page();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stat_totals = self::get_stats( $api_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If unset, create the new strictness option using the old discard option to determine its default.</span>&nbsp;</div></li><li><div>      <span class="comment">// If the old option wasn't set, default to discarding the blatant spam.</span>&nbsp;</div></li><li><div>      if ( get_option( 'akismet_strictness' ) === false ) {&nbsp;</div></li><li><div>          add_option( 'akismet_strictness', ( get_option( 'akismet_discard_month' ) === 'false' ? '0' : '1' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $notices = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( self::$notices ) ) {&nbsp;</div></li><li><div>          if ( ! empty( $stat_totals['all'] ) && isset( $stat_totals['all']-&gt;time_saved ) && $akismet_user-&gt;status == 'active' && $akismet_user-&gt;account_type == 'free-api-key' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $time_saved = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $stat_totals['all']-&gt;time_saved &gt; 1800 ) {&nbsp;</div></li><li><div>                  $total_in_minutes = round( $stat_totals['all']-&gt;time_saved / 60 );&nbsp;</div></li><li><div>                  $total_in_hours = round( $total_in_minutes / 60 );&nbsp;</div></li><li><div>                  $total_in_days = round( $total_in_hours / 8 );&nbsp;</div></li><li><div>                  $cleaning_up = __( 'Cleaning up spam takes time.' , 'akismet');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $total_in_days &gt; 1 )&nbsp;</div></li><li><div>                      $time_saved = $cleaning_up . ' ' . sprintf( _n( 'Akismet has saved you %s day!', 'Akismet has saved you %s days!', $total_in_days, 'akismet' ), number_format_i18n( $total_in_days ) );&nbsp;</div></li><li><div>                  elseif ( $total_in_hours &gt; 1 )&nbsp;</div></li><li><div>                      $time_saved = $cleaning_up . ' ' . sprintf( _n( 'Akismet has saved you %d hour!', 'Akismet has saved you %d hours!', $total_in_hours, 'akismet' ), $total_in_hours );&nbsp;</div></li><li><div>                  elseif ( $total_in_minutes &gt;= 30 )&nbsp;</div></li><li><div>                      $time_saved = $cleaning_up . ' ' . sprintf( _n( 'Akismet has saved you %d minute!', 'Akismet has saved you %d minutes!', $total_in_minutes, 'akismet' ), $total_in_minutes );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              $notices[] =  array( 'type' =&gt; 'active-notice', 'time_saved' =&gt; $time_saved );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( !empty( $akismet_user-&gt;limit_reached ) && in_array( $akismet_user-&gt;limit_reached, array( 'yellow', 'red' ) ) ) {&nbsp;</div></li><li><div>              $notices[] = array( 'type' =&gt; 'limit-reached', 'level' =&gt; $akismet_user-&gt;limit_reached );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( !isset( self::$notices['status'] ) && in_array( $akismet_user-&gt;status, array( 'cancelled', 'suspended', 'missing', 'no-sub' ) ) ) {&nbsp;</div></li><li><div>          $notices[] = array( 'type' =&gt; $akismet_user-&gt;status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      // To see all variants when testing.</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'active-notice', 'time_saved' =&gt; 'Cleaning up spam takes time. Akismet has saved you 1 minute!' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'plugin' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'spam-check', 'link_text' =&gt; 'Link text.' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'notice', 'notice_header' =&gt; 'This is the notice header.', 'notice_text' =&gt; 'This is the notice text.' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'missing-functions' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'servers-be-down' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'active-dunning' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'cancelled' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'suspended' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'missing' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'no-sub' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'new-key-valid' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'new-key-invalid' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'existing-key-invalid' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'new-key-failed' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'limit-reached', 'level' =&gt; 'yellow' );</span>&nbsp;</div></li><li><div><span class="comment">      $notices[] = array( 'type' =&gt; 'limit-reached', 'level' =&gt; 'red' );</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      Akismet::log( compact( 'stat_totals', 'akismet_user' ) );&nbsp;</div></li><li><div>      Akismet::view( 'config', compact( 'api_key', 'akismet_user', 'stat_totals', 'notices' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_notice() {&nbsp;</div></li><li><div>      global $hook_suffix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $hook_suffix, array( 'jetpack_page_akismet-key-config', 'settings_page_akismet-key-config' ) ) ) {&nbsp;</div></li><li><div>          <span class="comment">// This page manages the notices and puts them inline where they make sense.</span>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $hook_suffix, array( 'edit-comments.php' ) ) && (int) get_option( 'akismet_alert_code' ) &gt; 0 ) {&nbsp;</div></li><li><div>          Akismet::verify_key( Akismet::get_api_key() ); <span class="comment">//verify that the key is still in alert state</span>&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( get_option( 'akismet_alert_code' ) &gt; 0 )&nbsp;</div></li><li><div>              self::display_alert();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( $hook_suffix == 'plugins.php' && !Akismet::get_api_key() ) {&nbsp;</div></li><li><div>          self::display_api_key_warning();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( $hook_suffix == 'edit-comments.php' && wp_next_scheduled( 'akismet_schedule_cron_recheck' ) ) {&nbsp;</div></li><li><div>          self::display_spam_check_warning();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ( isset( $_GET['akismet_recheck_complete'] ) ) {&nbsp;</div></li><li><div>          $recheck_count = (int) $_GET['recheck_count'];&nbsp;</div></li><li><div>          $spam_count = (int) $_GET['spam_count'];&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ( $recheck_count === 0 ) {&nbsp;</div></li><li><div>              $message = __( 'There were no comments to check. Akismet will only check comments in the Pending queue.', 'akismet' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $message = sprintf( _n( 'Akismet checked %s comment.', 'Akismet checked %s comments.', $recheck_count, 'akismet' ), number_format( $recheck_count ) );&nbsp;</div></li><li><div>              $message .= ' ';&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>              if ( $spam_count === 0 ) {&nbsp;</div></li><li><div>                  $message .= __( 'No comments were caught as spam.' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else {&nbsp;</div></li><li><div>                  $message .= sprintf( _n( '%s comment was caught as spam.', '%s comments were caught as spam.', $spam_count, 'akismet' ), number_format( $spam_count ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          echo '&lt;div class=&quot;notice notice-success&quot;&gt;&lt;p&gt;' . esc_html( $message ) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function display_status() {&nbsp;</div></li><li><div>      if ( ! self::get_server_connectivity() ) {&nbsp;</div></li><li><div>          Akismet::view( 'notice', compact( 'servers-be-down' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ( ! empty( self::$notices ) ) {&nbsp;</div></li><li><div>          foreach ( self::$notices as $index =&gt; $type ) {&nbsp;</div></li><li><div>              if ( is_object( $type ) ) {&nbsp;</div></li><li><div>                  $notice_header = $notice_text = '';&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                  if ( property_exists( $type, 'notice_header' ) ) {&nbsp;</div></li><li><div>                      $notice_header = wp_kses( $type-&gt;notice_header, self::$allowed );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                  if ( property_exists( $type, 'notice_text' ) ) {&nbsp;</div></li><li><div>                      $notice_text = wp_kses( $type-&gt;notice_text, self::$allowed );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                  if ( property_exists( $type, 'status' ) ) {&nbsp;</div></li><li><div>                      $type = wp_kses( $type-&gt;status, self::$allowed );&nbsp;</div></li><li><div>                      Akismet::view( 'notice', compact( 'type', 'notice_header', 'notice_text' ) );&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      unset( self::$notices[ $index ] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else {&nbsp;</div></li><li><div>                  Akismet::view( 'notice', compact( 'type' ) );&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                  unset( self::$notices[ $index ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function get_jetpack_user() {&nbsp;</div></li><li><div>      if ( !class_exists('Jetpack') )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>      $xml = new Jetpack_IXR_ClientMulticall( array( 'user_id' =&gt; get_current_user_id() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml-&gt;addCall( 'wpcom.getUserID' );&nbsp;</div></li><li><div>      $xml-&gt;addCall( 'akismet.getAPIKey' );&nbsp;</div></li><li><div>      $xml-&gt;query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Akismet::log( compact( 'xml' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$xml-&gt;isError() ) {&nbsp;</div></li><li><div>          $responses = $xml-&gt;getResponse();&nbsp;</div></li><li><div>          if ( count( $responses ) &gt; 1 ) {&nbsp;</div></li><li><div>              $api_key = array_shift( $responses[0] );&nbsp;</div></li><li><div>              $user_id = (int) array_shift( $responses[1] );&nbsp;</div></li><li><div>              return compact( 'api_key', 'user_id' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Some commentmeta isn't useful in an export file. Suppress it (when supported).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $exclude</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key The meta key</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $meta The meta object</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool Whether to exclude this meta entry from the export.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function exclude_commentmeta_from_export( $exclude, $key, $meta ) {&nbsp;</div></li><li><div>      if ( in_array( $key, array( 'akismet_as_submitted', 'akismet_rechecking', 'akismet_delayed_moderation_email' ) ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $exclude;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * When Akismet is active, remove the &quot;Activate Akismet&quot; step from the plugin description.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function modify_plugin_description( $all_plugins ) {&nbsp;</div></li><li><div>      if ( isset( $all_plugins['akismet/akismet.php'] ) ) {&nbsp;</div></li><li><div>          if ( Akismet::get_api_key() ) {&nbsp;</div></li><li><div>              $all_plugins['akismet/akismet.php']['Description'] = __( 'Used by millions, Akismet is quite possibly the best way in the world to &lt;strong&gt;protect your blog from spam&lt;/strong&gt;. Your site is fully configured and being protected, even while you sleep.', 'akismet' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $all_plugins['akismet/akismet.php']['Description'] = __( 'Used by millions, Akismet is quite possibly the best way in the world to &lt;strong&gt;protect your blog from spam&lt;/strong&gt;. It keeps your site protected even while you sleep. To get started, just go to &lt;a href=&quot;admin.php?page=akismet-key-config&quot;&gt;your Akismet Settings page&lt;/a&gt; to set up your API key.', 'akismet' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $all_plugins;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Akismet Anti-Spam</li><li><span></span>3.3.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>