<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="11.1.1" data-slug="novalnet-payment-plugin-woocommerce" data-type="class" data-id="70270"><head xmlns="http://www.w3.org/1999/xhtml"><title> nn_payment_gateways | class | Novalnet Payment Plugin Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="NN_Payment_Gateways, class, plugin, novalnet-payment-plugin-woocommerce, 11.1.1" /><meta name="description" content="NN_Payment_Gateways Abstract Class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=370e8ea513a02c80a25eecb91c99c57a' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/nn_payment_gateways/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fnn_payment_gateways%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fnn_payment_gateways%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-novalnet-payment-plugin-woocommerce-11.1.1-class-nn_payment_gateways","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="nn_payment_gateways" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to novalnet-payment-plugin-wooco&hellip;." href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/" class="plugin"><span property="name">novalnet-payment-plugin-wooco&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 11.1.1." href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/" class="H_VERSION"><span property="name">11.1.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">nn_payment_gateways</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="142"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/all/" title="All">All <span class="count badge">142</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="40"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/hooks/" title="Hooks">Hooks <span class="count badge">40</span></a></li><li class="" data-id="action" data-count="7"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/actions/" title="Actions">Actions <span class="count badge">7</span></a></li><li class="" data-id="filter" data-count="33"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/filters/" title="Filters">Filters <span class="count badge">33</span></a></li><li class="active" data-id="class" data-count="23"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/classes/" title="Classes">Classes <span class="count badge">23</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="79"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/functions/" title="Functions">Functions <span class="count badge">79</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>NN_Payment_Gateways</strong></h1><p>NN_Payment_Gateways Abstract Class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/files/includes-abstracts-abstract-wc-novalnet-payment/" class="file">/includes/abstracts/abstract-wc-novalnet-payment.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="22" class="block" start="22"><li><div>abstract class NN_Payment_Gateways extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Maintain Log object.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var obj&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $novalnet_log;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Perform the payment call to Novalnet server.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param array  $request_param The request parameters.&nbsp;</div></li><li><div>     * @param string $url           The request url.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function perform_payment_call( $request_param, $url = 'https://payport.novalnet.de/paygate.jsp' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to maintain payment call process.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( &quot;Initiate payment call to $url&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Submit the given request and convert the query string to array.&nbsp;</div></li><li><div>        return novalnet_instance()-&gt;novalnet_functions()-&gt;submit_request( $request_param, $url );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Perform encoding process for the given data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     * @param array  $data The encode values.&nbsp;</div></li><li><div>     * @param string $key  The payment access key value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function encode_data( $data, $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $crc = sprintf( '%u', crc32( $data ) );&nbsp;</div></li><li><div>            $data = bin2hex( $crc . '|' . $data . $key );&nbsp;</div></li><li><div>            $data = strrev( base64_encode( $data ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Error log for the exception.&nbsp;</div></li><li><div>            $this-&gt;novalnet_log-&gt;add( 'novalneterrorlog', 'Encode error occured: ' . $e-&gt;getMessage() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Perform decoding process for the given data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     * @param string $data The decode values.&nbsp;</div></li><li><div>     * @param string $key  The payment access key value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function decode_data( $data, $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $data = base64_decode( strrev( $data ) );&nbsp;</div></li><li><div>            $data = pack( 'H' . strlen( $data ), $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Using payment access key.&nbsp;</div></li><li><div>            $data = substr( $data, 0, stripos( $data, $key ) );&nbsp;</div></li><li><div>            $pos = strpos( $data, '|' );&nbsp;</div></li><li><div>            $value = trim( substr( $data, $pos + 1 ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Error log for the exception.&nbsp;</div></li><li><div>            $this-&gt;novalnet_log-&gt;add( 'novalneterrorlog', 'Decode error occured: ' . $e-&gt;getMessage() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Fetch all the global configuration values from the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function global_configurations() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge(&nbsp;</div></li><li><div>            novalnet_instance()-&gt;novalnet_functions()-&gt;get_basic_vendor_details(), array(&nbsp;</div></li><li><div>            'key_password' =&gt; get_option( 'novalnet_key_password' ), &nbsp;</div></li><li><div>            'manual_limit' =&gt; novalnet_instance()-&gt;novalnet_functions()-&gt;get_manual_check_limit(), &nbsp;</div></li><li><div>            'payment_logo' =&gt; get_option( 'novalnet_payment_logo' ), &nbsp;</div></li><li><div>            'referrer_id' =&gt; get_option( 'novalnet_referrer_id' ), &nbsp;</div></li><li><div>            'notify_url' =&gt; get_option( 'novalnet_callback_notify_url' ), &nbsp;</div></li><li><div>            'debug_log' =&gt; get_option( 'novalnet_debug_log' ), &nbsp;</div></li><li><div>            'callback_emailtoaddr' =&gt; get_option( 'novalnet_callback_emailtoaddr' ), &nbsp;</div></li><li><div>            'callback_emailbccaddr' =&gt; get_option( 'novalnet_callback_emailbccaddr' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return basic payment configurations fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function basic_payment_config() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $payment_details = wc_novalnet_payment_details( $this-&gt;id );&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'enabled' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Enable payment method', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                'label' =&gt; ' ', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'title_en' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Payment title in English', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'text', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'default' =&gt; $payment_details ['title_en'], &nbsp;</div></li><li><div>                'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                    'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'description_en' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Description in English', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'textarea', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'default' =&gt; $payment_details ['description_en'], &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'title_de' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Payment title in German', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'text', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'default' =&gt; $payment_details ['title_de'], &nbsp;</div></li><li><div>                'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                    'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'description_de' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Description in German', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'textarea', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'default' =&gt; $payment_details ['description_de'], &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'test_mode' =&gt; array(&nbsp;</div></li><li><div>                'title' =&gt; __( 'Enable test mode', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'type' =&gt; 'select', &nbsp;</div></li><li><div>                'options' =&gt; array(&nbsp;</div></li><li><div>                    '0' =&gt; __( 'No', 'wc-novalnet' ), &nbsp;</div></li><li><div>                    '1' =&gt; __( 'Yes', 'wc-novalnet' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'description' =&gt; __( 'The payment will be processed in the test mode therefore amount for this transaction will not be charged', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                'default' =&gt; '0', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return fraud module payment configurations fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function fraud_module_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['fraud_module'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Enable fraud prevention', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'select', &nbsp;</div></li><li><div>            'options' =&gt; array(&nbsp;</div></li><li><div>                '' =&gt; __( 'None', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'tel' =&gt; __( 'PIN by callback', 'wc-novalnet' ), &nbsp;</div></li><li><div>                'mobile' =&gt; __( 'PIN by SMS', 'wc-novalnet' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'description' =&gt; __( 'To authenticate the buyer for a transaction, the PIN will be automatically generated and sent to the buyer. This service is only available for customers from DE, AT, CH', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; true, &nbsp;</div></li><li><div>            'default' =&gt; '0', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['pin_amt_limit'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Minimum value of goods for the fraud module', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( '(in minimum unit of currency. E.g. enter 100 which is equal to 1.00)', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; __( 'Enter the minimum value of goods from which the fraud module should be activated', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Shopping type payment configurations fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function shopping_type_payment_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['payment_process'] = array(&nbsp;</div></li><li><div>         'title' =&gt; __( 'Shopping type', 'wc-novalnet' ), &nbsp;</div></li><li><div>         'type' =&gt; 'select', &nbsp;</div></li><li><div>         'options' =&gt; array(&nbsp;</div></li><li><div>          'none' =&gt; __( 'Select shopping type', 'wc-novalnet' ), &nbsp;</div></li><li><div>          'one_click_shop' =&gt; __( 'One click shopping', 'wc-novalnet' ), &nbsp;</div></li><li><div>          'zero_amount_book' =&gt; __( 'Zero amount booking', 'wc-novalnet' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>         'description' =&gt; __( '&lt;span id=&quot;novalnet_reference_alert&quot; style=&quot;color:red;&quot;&gt;&lt;/span&gt;', 'wc-novalnet' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Pending status payment configurations fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function pending_status_payment_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['pending_status'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Order status for the pending payment', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'select', &nbsp;</div></li><li><div>            'default' =&gt; wc_novalnet_format_default_order_status( 'on-hold' ), &nbsp;</div></li><li><div>            'options' =&gt; wc_novalnet_get_shop_order_status(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return other payment configuration fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function other_payment_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['order_success_status'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Order completion status ', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'select', &nbsp;</div></li><li><div>            'default' =&gt; wc_novalnet_format_default_order_status( 'processing' ), &nbsp;</div></li><li><div>            'options' =&gt; wc_novalnet_get_shop_order_status(), &nbsp;</div></li><li><div>            'description' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['payment_instruction'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Notification for the buyer', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'textarea', &nbsp;</div></li><li><div>            'description' =&gt; __( 'The entered text will be displayed on the checkout page', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['instructions'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Thank you page instructions', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'textarea', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['email_notes'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'E-mail instructions', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'textarea', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['min_amount'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Minimum value of goods', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'desc_tip' =&gt; __( 'Enter the minimum value of goods from which the payment method is displayed to the customer during checkout', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'description' =&gt; __( '(in minimum unit of currency. E.g. enter 100 which is equal to 1.00)', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['reference1'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Transaction reference 1', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'This reference will appear in your bank account statement', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; true, &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['reference2'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Transaction reference 2', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( 'This reference will appear in your bank account statement', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; true, &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Guarantee payment configuration fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function guarantee_payment_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['guarantee_payment_title'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Payment guarantee configuration', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'title', &nbsp;</div></li><li><div>            'description' =&gt; sprintf('&lt;strong&gt;%1$s&lt;/strong&gt;&lt;br/&gt;&nbsp;</div></li><li><div>            &lt;ul&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%2$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%3$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%4$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%5$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%6$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%7$s&lt;/li&gt;&nbsp;</div></li><li><div>                &lt;li&gt;%8$s&lt;/li&gt;&nbsp;</div></li><li><div>            &lt;/ul&gt;', __( 'Basic requirements for payment guarantee', 'wc-novalnet' ), __( 'Allowed countries: AT, DE, CH', 'wc-novalnet' ), __( 'Allowed currency: EUR', 'wc-novalnet' ), __( 'Minimum amount of order &gt;= 20, 00 EUR', 'wc-novalnet' ), __( 'Maximum amount of order &lt;= 5.000, 00 EUR', 'wc-novalnet' ), __( 'Minimum age of end customer &gt;= 18 Years', 'wc-novalnet' ), __( 'The billing address must be the same as the shipping address', 'wc-novalnet' ), __( 'Gift certificates/vouchers are not allowed', 'wc-novalnet' ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['guarantee_payment'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Enable payment guarantee', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'label' =&gt; ' ', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['guarantee_payment_minimum_order_amount'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Minimum order amount', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( '(in minimum unit of currency. E.g. enter 100 which is equal to 1.00)', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; __( 'This setting will override the default setting made in the minimum order amount. Note that amount should be in the range of 20, 00 EUR - 5.000, 00 EUR', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['guarantee_payment_maximum_order_amount'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Maximum order amount', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'text', &nbsp;</div></li><li><div>            'description' =&gt; __( '(in minimum unit of currency. E.g. enter 100 which is equal to 1.00)', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'desc_tip' =&gt; __( 'This setting will override the default setting made in the maximum order amount. Note that amount should be greater than minimum order amount, but not more than 5.000, 00 EUR', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                'autocomplete' =&gt; 'OFF', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Non-Guarantee payment force field.&nbsp;</div></li><li><div>        $form_fields ['force_normal_payment'] = array(&nbsp;</div></li><li><div>            'title' =&gt; __( 'Force Non-Guarantee payment', 'wc-novalnet' ), &nbsp;</div></li><li><div>            'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>            'default' =&gt; 'yes', &nbsp;</div></li><li><div>            'label' =&gt; __( 'If the payment guarantee is activated (True), but the above mentioned requirements are not met, the payment should be processed as non-guarantee payment.', 'wc-novalnet' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_enqueue_js( &quot;&nbsp;</div></li><li><div>            jQuery( document ).ready(function () {&nbsp;</div></li><li><div>                jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment' ).live( 'change', function() {&nbsp;</div></li><li><div>                    if ( jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment' ).is( ':checked' ) ) {&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_force_normal_payment').closest( 'tr' ).show();&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment_minimum_order_amount').closest( 'tr' ).show();&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment_maximum_order_amount').closest( 'tr' ).show();&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_force_normal_payment').closest( 'tr' ).hide();&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment_minimum_order_amount').closest( 'tr' ).hide();&nbsp;</div></li><li><div>                        jQuery( '#woocommerce_&quot; . $this-&gt;id . &quot;_guarantee_payment_maximum_order_amount').closest( 'tr' ).hide();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }).change();&nbsp;</div></li><li><div>            });&nbsp;</div></li><li><div>        &quot; );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return Invoice / Prepayment payments configurations fields.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form_fields The form fields.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function invoice_payments_config( &$form_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_fields ['payment_reference_1'] = array(&nbsp;</div></li><li><div>         'title' =&gt; __( 'Payment Reference 1 (Novalnet Invoice Reference)', 'wc-novalnet' ), &nbsp;</div></li><li><div>         'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>         'label' =&gt; ' ', &nbsp;</div></li><li><div>         'default' =&gt; 'yes', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['payment_reference_2'] = array(&nbsp;</div></li><li><div>         'title' =&gt; __( 'Payment Reference 2 (TID)', 'wc-novalnet' ), &nbsp;</div></li><li><div>         'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>         'label' =&gt; ' ', &nbsp;</div></li><li><div>         'default' =&gt; 'yes', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['payment_reference_3'] = array(&nbsp;</div></li><li><div>         'title' =&gt; __( 'Payment Reference 3 (Order No)', 'wc-novalnet' ), &nbsp;</div></li><li><div>         'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>         'label' =&gt; ' ', &nbsp;</div></li><li><div>         'default' =&gt; 'yes', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $form_fields ['callback_status'] = array(&nbsp;</div></li><li><div>         'title' =&gt; __( 'Callback order status', 'wc-novalnet' ), &nbsp;</div></li><li><div>         'type' =&gt; 'select', &nbsp;</div></li><li><div>         'default' =&gt; wc_novalnet_format_default_order_status( 'completed' ), &nbsp;</div></li><li><div>         'options' =&gt; wc_novalnet_get_shop_order_status(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Built logo with link to display in front-end.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param boolean $logo_enabled The logo enabled value.&nbsp;</div></li><li><div>     * @param string  $logo         The logo value.&nbsp;</div></li><li><div>     * @param string  $title        The title value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function built_logo( $logo_enabled, $logo, $title ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $href_link = __( 'http://www.novalnet.com', 'wc-novalnet' );&nbsp;</div></li><li><div>        $plugin_url = novalnet_instance()-&gt;plugin_url() . '/assets/images/' . $logo . '.png';&nbsp;</div></li><li><div>        $logo_href = '';&nbsp;</div></li><li><div>        if ( $logo_enabled ) {&nbsp;</div></li><li><div>            $logo_href = &quot;&lt;a href='$href_link' target='_blank'&gt;&lt;img src='$plugin_url' alt='$title' title='$title' /&gt;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $logo_href;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Forming basic params to process payment in Novalnet server.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     * @param WC_Order $wc_order           The order object.&nbsp;</div></li><li><div>     * @param array    $config             The config values.&nbsp;</div></li><li><div>     * @param string   $payment_type       The payment type value.&nbsp;</div></li><li><div>     * @param boolean  $admin_subscription Checks for admin processed order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_payment_parameters( $wc_order, $config, $payment_type, $admin_subscription = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Customize order details to process server request.&nbsp;</div></li><li><div>        $order_amount = wc_novalnet_formatted_amount( $wc_order-&gt;order_total );&nbsp;</div></li><li><div>        $order_no = novalnet_instance()-&gt;novalnet_functions()-&gt;get_order_post_id( $wc_order );&nbsp;</div></li><li><div>        $wc_order = new WC_Order( $order_no );&nbsp;</div></li><li><div>        $language = strtoupper( $this-&gt;language );&nbsp;</div></li><li><div>        $is_change_payment = $admin_subscription;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get formated order number.&nbsp;</div></li><li><div>        $formatted_order_no = ltrim( $wc_order-&gt;get_order_number(), _x( '#', 'hash before order number', 'woocommerce' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form customer details parameters.&nbsp;</div></li><li><div>        $customer_parameters = novalnet_instance()-&gt;novalnet_functions()-&gt;form_user_payment_parameter( $wc_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Assign test mode value as 1/ 0 based on configuration value.&nbsp;</div></li><li><div>        $test_mode = (int) $config ['test_mode'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get payment key and type.&nbsp;</div></li><li><div>        $payment_details = wc_novalnet_get_payment_type( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $admin_subscription ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for affiliate.&nbsp;</div></li><li><div>            wc_novalnet_process_affiliate_action( $config );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set current payment method in session.&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;set( 'current_novalnet_payment', $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for change payment method.&nbsp;</div></li><li><div>            $is_change_payment = WC()-&gt;session-&gt;__isset( 'novalnet_change_payment_method' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! novalnet_instance()-&gt;novalnet_functions()-&gt;validate_customer_parameters( $customer_parameters ) ) {&nbsp;</div></li><li><div>                $this-&gt;display_info( __( 'Customer name/email fields are not valid', 'wc-novalnet' ), 'error' );&nbsp;</div></li><li><div>                wc_novalnet_safe_redirect();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form vendor parameters.&nbsp;</div></li><li><div>        $vendor_parameters = array(&nbsp;</div></li><li><div>            'vendor' =&gt; $config ['vendor_id'], &nbsp;</div></li><li><div>            'auth_code' =&gt; $config ['auth_code'], &nbsp;</div></li><li><div>            'product' =&gt; $config ['product_id'], &nbsp;</div></li><li><div>            'key' =&gt; $payment_details ['key'], &nbsp;</div></li><li><div>            'payment_type' =&gt; $payment_details ['payment_type'], &nbsp;</div></li><li><div>            'tariff' =&gt; $config ['tariff_id'], &nbsp;</div></li><li><div>            'test_mode' =&gt; $test_mode, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form order details parameters.&nbsp;</div></li><li><div>        $order_parameters = array(&nbsp;</div></li><li><div>            'currency' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div>            'lang' =&gt; $language, &nbsp;</div></li><li><div>            'remote_ip' =&gt; wc_novalnet_get_ip_address(), &nbsp;</div></li><li><div>            'amount' =&gt; $order_amount, &nbsp;</div></li><li><div>            'order_no' =&gt; $formatted_order_no, &nbsp;</div></li><li><div>            'system_name' =&gt; 'wordpress-woocommerce', &nbsp;</div></li><li><div>            'system_version' =&gt; get_bloginfo( 'version' ) . '-' . WOOCOMMERCE_VERSION . '-NN' . NN_VERSION, &nbsp;</div></li><li><div>            'system_url' =&gt; site_url(), &nbsp;</div></li><li><div>            'system_ip' =&gt; wc_novalnet_get_ip_address( 'SERVER_ADDR' ), &nbsp;</div></li><li><div>            'language' =&gt; $language, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form additional parameters.&nbsp;</div></li><li><div>        $additional_parameters = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Append Company parameter.&nbsp;</div></li><li><div>        $additional_parameters ['company'] = trim( $wc_order-&gt;billing_company );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Append Referrer ID.&nbsp;</div></li><li><div>        $additional_parameters ['referrer_id'] = wc_novalnet_digits_check( $config ['referrer_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Append Notification URL.&nbsp;</div></li><li><div>        $additional_parameters ['notify_url'] = trim( $config ['notify_url'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check and append on-hold parameter.&nbsp;</div></li><li><div>        $additional_parameters ['on_hold'] = (int) ( ! $is_change_payment && in_array( $payment_type, array( 'novalnet_invoice', 'novalnet_cc', 'novalnet_sepa', 'novalnet_paypal' ), true ) && novalnet_instance()-&gt;novalnet_functions()-&gt;manual_limit_check( $order_amount, $config['manual_limit'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add transaction reference.&nbsp;</div></li><li><div>        $this-&gt;add_transaction_reference( $additional_parameters, $config );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Combine formed parameters.&nbsp;</div></li><li><div>        $parameters = array_merge( $vendor_parameters, $customer_parameters, $order_parameters, array_filter( $additional_parameters ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get Subscription details parameters if available.&nbsp;</div></li><li><div>        $parameters = apply_filters( 'novalnet_form_subscription_parameters', $parameters, $wc_order, $config ['subs_tariff_id'], $config ['enable_subs'], $is_change_payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Forming subscription parameters if enabled.&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'payment_parameters' =&gt; $parameters, &nbsp;</div></li><li><div>            'payment_access_key' =&gt; $config ['key_password'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add transaction reference.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $formed_params The formed parameters.&nbsp;</div></li><li><div>     * @param array $config        The global configurations array.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_transaction_reference( &$formed_params, $config ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Transaction reference 1.&nbsp;</div></li><li><div>        if ( $reference1 = sanitize_text_field( $config ['reference1'] ) ) {&nbsp;</div></li><li><div>            $formed_params ['inputval1'] = $reference1;&nbsp;</div></li><li><div>            $formed_params ['input1'] = 'Reference1';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Transaction reference 2.&nbsp;</div></li><li><div>        if ( $reference2 = sanitize_text_field( $config ['reference2'] ) ) {&nbsp;</div></li><li><div>            $formed_params ['inputval2'] = $reference2;&nbsp;</div></li><li><div>            $formed_params ['input2'] = 'Reference2';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Assigning zero amount and storing The formed&nbsp;</div></li><li><div>     * parameters in session to store in database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $formed_params The formed parameters.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function assign_zero_amount( &$formed_params ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $formed_params ['on_hold'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get needed payment parameters.&nbsp;</div></li><li><div>        $payment_params = $formed_params;&nbsp;</div></li><li><div>        unset( $payment_params ['create_payment_ref'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get payment session and store the serialized payment parameters.&nbsp;</div></li><li><div>        $payment_session = WC()-&gt;session-&gt;get( $this-&gt;id );&nbsp;</div></li><li><div>        $payment_session ['payment_params'] = wc_novalnet_serialize_data( $payment_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set assigned payment session.&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( $this-&gt;id, $payment_session );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Assign amount as zero.&nbsp;</div></li><li><div>        $formed_params ['amount'] = '0';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Encoding required params and generating&nbsp;</div></li><li><div>     * the hash and form basic redirect payment params.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array    $data               The encode values.&nbsp;</div></li><li><div>     * @param WC_Order $wc_order           The WC_Order.&nbsp;</div></li><li><div>     * @param string   $payment_access_key The payment access key value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function redirect_payment_params( &$data, $wc_order, $payment_access_key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Customize the shop return URL's based on payment process type.&nbsp;</div></li><li><div>        $shop_return_url = apply_filters( 'novalnet_return_url', $this-&gt;get_return_url( $wc_order ) );&nbsp;</div></li><li><div>        $shop_error_return_url = apply_filters( 'novalnet_error_return_url', $this-&gt;get_return_url( $wc_order ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form redirected parameters.&nbsp;</div></li><li><div>        $data ['uniqid'] = uniqid();&nbsp;</div></li><li><div>        $data ['return_method'] = $data ['error_return_method'] = 'POST';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'novalnet_cc' !== $this-&gt;id ) {&nbsp;</div></li><li><div>            $data ['user_variable_0'] = site_url();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data ['implementation'] = 'PHP';&nbsp;</div></li><li><div>        $data ['return_url'] = esc_url( add_query_arg( 'wc-api', 'response_' . $this-&gt;id, $shop_return_url ) );&nbsp;</div></li><li><div>        $data ['error_return_url'] = esc_url( add_query_arg( 'wc-api', 'response_' . $this-&gt;id, $shop_error_return_url ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Send order numebr in input value.&nbsp;</div></li><li><div>        $data ['input3'] = 'nn_shopnr';&nbsp;</div></li><li><div>        $data ['inputval3'] = $wc_order-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Perform data encode.&nbsp;</div></li><li><div>        foreach ( array(&nbsp;</div></li><li><div>         'auth_code', &nbsp;</div></li><li><div>         'product', &nbsp;</div></li><li><div>         'tariff', &nbsp;</div></li><li><div>         'amount', &nbsp;</div></li><li><div>         'test_mode', &nbsp;</div></li><li><div>         'uniqid', &nbsp;</div></li><li><div> ) as $key ) {&nbsp;</div></li><li><div>            $data [ $key ] = $this-&gt;encode_data( $data [ $key ], $payment_access_key );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Generate hash.&nbsp;</div></li><li><div>        $data ['hash'] = wc_novalnet_generate_hash( $data, $payment_access_key );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Show guarantee payment&nbsp;</div></li><li><div>     * module visiblity process.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function show_guarantee_payment() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_amount = wc_novalnet_formatted_amount( WC()-&gt;session-&gt;total );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Billing address.&nbsp;</div></li><li><div>        $billing_address = array(&nbsp;</div></li><li><div>            'country' =&gt; WC()-&gt;customer-&gt;get_country(), &nbsp;</div></li><li><div>            'post_code' =&gt; WC()-&gt;customer-&gt;get_postcode(), &nbsp;</div></li><li><div>            'city' =&gt; WC()-&gt;customer-&gt;get_city(), &nbsp;</div></li><li><div>            'address' =&gt; WC()-&gt;customer-&gt;get_address(), &nbsp;</div></li><li><div>            'address2' =&gt; WC()-&gt;customer-&gt;get_address_2(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipping address.&nbsp;</div></li><li><div>        $shipping_address = array(&nbsp;</div></li><li><div>            'country' =&gt; WC()-&gt;customer-&gt;get_shipping_country(), &nbsp;</div></li><li><div>            'post_code' =&gt; WC()-&gt;customer-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>            'city' =&gt; WC()-&gt;customer-&gt;get_shipping_city(), &nbsp;</div></li><li><div>            'address' =&gt; WC()-&gt;customer-&gt;get_shipping_address(), &nbsp;</div></li><li><div>            'address2' =&gt; WC()-&gt;customer-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default value.&nbsp;</div></li><li><div>        $minimum_amount = 2000;&nbsp;</div></li><li><div>        $maximum_amount = 500000;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;settings ['guarantee_payment_minimum_order_amount'] ) {&nbsp;</div></li><li><div>            $minimum_amount = $this-&gt;settings ['guarantee_payment_minimum_order_amount'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $this-&gt;settings ['guarantee_payment_maximum_order_amount'] ) {&nbsp;</div></li><li><div>            $maximum_amount = $this-&gt;settings ['guarantee_payment_maximum_order_amount'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Payment guarantee process.&nbsp;</div></li><li><div>        if ( 'yes' === $this-&gt;settings ['guarantee_payment'] ) {&nbsp;</div></li><li><div>            if ( in_array( WC()-&gt;customer-&gt;country, array( 'AT', 'DE', 'CH' ), true ) && 'EUR' === get_woocommerce_currency() && $billing_address === $shipping_address && ( $order_amount &gt;= $minimum_amount && $order_amount &lt;= $maximum_amount ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Process as guarantee payment.&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;set( $this-&gt;id . '_guarantee_payment', true );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment_error' );&nbsp;</div></li><li><div>            } elseif ( 'yes' === $this-&gt;settings ['force_normal_payment'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Process as normal payment.&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment' );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment_error' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Show error on payment field/ checkout.&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment' );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;set( $this-&gt;id . '_guarantee_payment_error', true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Process as normal payment.&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment_error' );&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( $this-&gt;id . '_guarantee_payment' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check for the success status of the&nbsp;</div></li><li><div>     * Novalnet payment call.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $payment_type The payment type value.&nbsp;</div></li><li><div>     * @param array  $data         The given array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function success_status( $payment_type, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return wc_novalnet_status_check( $data ) || ( 'novalnet_paypal' === $payment_type &&  wc_novalnet_status_check( $data, 'status', '90' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Assigning the shop order process based on the&nbsp;</div></li><li><div>     * Novalnet server response whether success / failure.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param string   $server_response The server response data.&nbsp;</div></li><li><div>     * @param WC_Order $wc_order        The order object.&nbsp;</div></li><li><div>     * @param string   $payment_type    The payment type value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_transaction_status( $server_response, $wc_order, $payment_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to notify server call return response.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( 'Response successfully reached to shop for the order: ' . $wc_order-&gt;id );&nbsp;</div></li><li><div>        if ( $this-&gt;success_status( $payment_type, $server_response ) ) {&nbsp;</div></li><li><div>            return $this-&gt;transaction_success( $server_response, $wc_order, $payment_type );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $this-&gt;transaction_failure( $server_response, $wc_order, $payment_type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Transaction success process for completing the order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     * @param array    $server_response The server response data.&nbsp;</div></li><li><div>     * @param WC_Order $wc_order        The order object.&nbsp;</div></li><li><div>     * @param string   $payment_type    The payment type value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function transaction_success( $server_response, $wc_order, $payment_type ) {&nbsp;</div></li><li><div>        $session_values = array();&nbsp;</div></li><li><div>        $payment_param = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for change payment method process.&nbsp;</div></li><li><div>        $is_change_payment = WC()-&gt;session-&gt;__isset( 'novalnet_change_payment_method' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Retrieve vendor details.&nbsp;</div></li><li><div>        $vendor_details = novalnet_instance()-&gt;novalnet_functions()-&gt;get_basic_vendor_details();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get post ID of the Parent order.&nbsp;</div></li><li><div>        $post_id = novalnet_instance()-&gt;novalnet_functions()-&gt;get_order_post_id( $wc_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Handle session and affiliate process.&nbsp;</div></li><li><div>        novalnet_instance()-&gt;novalnet_functions()-&gt;update_payment_process_details( $wc_order, $payment_type, $vendor_details, $payment_param, $session_values, $server_response ['order_no'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $settings = wc_novalnet_payment_config( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $test_mode = ( ! empty( $server_response ['test_mode'] ) || $settings ['test_mode'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Form order comments.&nbsp;</div></li><li><div>        list( $tid_details, $transaction_comments, $bank_details ) = $this-&gt;prepare_payment_comments( $server_response, $payment_type, $vendor_details ['product_id'], $settings, $test_mode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $transaction_comments = $tid_details . $transaction_comments;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Fetch transaction tariff id.&nbsp;</div></li><li><div>        $tariff = $vendor_details ['tariff_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_post_meta( $post_id, '_novalnet_gateway_status', $server_response['tid_status'] );&nbsp;</div></li><li><div>        $subs_id = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_subscription = ! empty( $server_response ['subs_id'] ) ) {&nbsp;</div></li><li><div>            $subs_id = $server_response ['subs_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Request sent to process change payment method in Novalnet server.&nbsp;</div></li><li><div>        if ( $is_change_payment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subscription_details = wc_novalnet_get_subs_details( '', $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for recurring payment type available in Novalnet table for the payment.&nbsp;</div></li><li><div>            if ( ! empty( $subscription_details ['recurring_payment_type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Update recurring payment process.&nbsp;</div></li><li><div>                novalnet_instance()-&gt;novalnet_functions()-&gt;update_recurring_payment( $post_id, $server_response, $payment_type, $settings, $this-&gt;language );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Update recurring payment details in Novalnet subscription details.&nbsp;</div></li><li><div>                wc_novalnet_db_update_query( array(&nbsp;</div></li><li><div>                    'recurring_payment_type' =&gt; $payment_type, &nbsp;</div></li><li><div>                    'subs_id' =&gt; $subs_id, &nbsp;</div></li><li><div>                    'recurring_tid' =&gt; $server_response ['tid'], &nbsp;</div></li><li><div> ), array(&nbsp;</div></li><li><div>                    'order_no' =&gt; $post_id, &nbsp;</div></li><li><div> ), 'novalnet_subscription_details' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Get subscription order object.&nbsp;</div></li><li><div>                $subscription_order = new WC_Order( $wc_order-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Update transaction comments.&nbsp;</div></li><li><div>                novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $subscription_order, $tid_details, true, 'transaction_info' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Update change payment method notice comments.&nbsp;</div></li><li><div>                novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $subscription_order, wc_novalnet_format_text( sprintf( __( 'Successfully changed the payment method for next subscription on %s', 'wc-novalnet' ), wc_novalnet_formatted_date() ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Unset the Novalnet sessions.&nbsp;</div></li><li><div>                wc_novalnet_unset_payment_session( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $success_url = $this-&gt;get_return_url( $subscription_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 'novalnet_paypal' === $this-&gt;id || ( 'novalnet_cc' === $this-&gt;id && $this-&gt;settings ['cc_secure_enabled'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get success URL for change payment method.&nbsp;</div></li><li><div>                    $data = apply_filters( 'novalnet_subscription_change_payment_method_success_url', $this-&gt;get_return_url( $subscription_order ), $subscription_order );&nbsp;</div></li><li><div>                    $success_url = $data ['success_url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Display shop change payment method notice.&nbsp;</div></li><li><div>                    $this-&gt;display_info( $data ['notice'], 'success' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $this-&gt;novalnet_redirect( $success_url );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update order comments.&nbsp;</div></li><li><div>        novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $wc_order, $transaction_comments, true, 'transaction_info' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Handle subscription process.&nbsp;</div></li><li><div>        $info = novalnet_instance()-&gt;novalnet_functions()-&gt;handle_subscription_post_process( $is_subscription, $post_id, $payment_type, $server_response, $wc_order, $vendor_details, $tid_details, $tariff );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update order information.&nbsp;</div></li><li><div>        if ( ! empty( $info ) ) {&nbsp;</div></li><li><div>            novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $wc_order, $info, true, 'note', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Complete the payment process.&nbsp;</div></li><li><div>        $wc_order-&gt;payment_complete( $server_response ['tid'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Converting the amount into cents.&nbsp;</div></li><li><div>        $amount = wc_novalnet_formatted_amount( $wc_order-&gt;order_total );&nbsp;</div></li><li><div>        $key = wc_novalnet_get_payment_type( $payment_type, 'key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for guarantee payment keys.&nbsp;</div></li><li><div>        if ( WC()-&gt;session-&gt;__isset( $payment_type . '_guarantee_payment' ) ) {&nbsp;</div></li><li><div>            $key = wc_novalnet_get_payment_type( 'guarantee_' . $payment_type, 'key' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;display_info( wc_novalnet_response_text( $server_response ), 'success' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unset the Novalnet sessions.&nbsp;</div></li><li><div>        wc_novalnet_unset_payment_session( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get book status and order amount.&nbsp;</div></li><li><div>        if ( $booked = (int) ( '' === $payment_param ) ) {&nbsp;</div></li><li><div>            $order_amount = $amount;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $order_amount = '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get callback amount.&nbsp;</div></li><li><div>        $callback_amount = $amount;&nbsp;</div></li><li><div>        if ( in_array( $payment_type, array( 'novalnet_invoice', 'novalnet_prepayment' ), true ) || in_array( $server_response ['tid_status'], array( '86', '90' ), true ) ) {&nbsp;</div></li><li><div>            $callback_amount = '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Insert the transaction details.&nbsp;</div></li><li><div>        wc_novalnet_db_insert_query(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>            'order_no' =&gt; $post_id, &nbsp;</div></li><li><div>            'order_number_formatted' =&gt; $server_response ['order_no'], &nbsp;</div></li><li><div>            'vendor_id' =&gt; $vendor_details ['vendor_id'], &nbsp;</div></li><li><div>            'auth_code' =&gt; $vendor_details ['auth_code'], &nbsp;</div></li><li><div>            'product_id' =&gt; $vendor_details ['product_id'], &nbsp;</div></li><li><div>            'tariff_id' =&gt; $tariff, &nbsp;</div></li><li><div>            'subs_id' =&gt; $subs_id, &nbsp;</div></li><li><div>            'payment_id' =&gt; $key, &nbsp;</div></li><li><div>            'payment_type' =&gt; $payment_type, &nbsp;</div></li><li><div>            'tid' =&gt; $server_response ['tid'], &nbsp;</div></li><li><div>            'gateway_status' =&gt; $server_response ['tid_status'], &nbsp;</div></li><li><div>            'amount' =&gt; $order_amount, &nbsp;</div></li><li><div>            'callback_amount' =&gt; $callback_amount, &nbsp;</div></li><li><div>            'currency' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div>            'test_mode' =&gt; (int) $test_mode, &nbsp;</div></li><li><div>            'customer_id' =&gt; $wc_order-&gt;user_id, &nbsp;</div></li><li><div>            'customer_email' =&gt; $wc_order-&gt;billing_email, &nbsp;</div></li><li><div>            'date' =&gt; date( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div>            'booked' =&gt; $booked, &nbsp;</div></li><li><div>            'payment_ref' =&gt; (int) ! empty( $session_values [ $payment_type . '_reference_tid' ] ), &nbsp;</div></li><li><div>            'bank_details' =&gt; $bank_details, &nbsp;</div></li><li><div>            'payment_params' =&gt; $payment_param, &nbsp;</div></li><li><div> ), 'novalnet_transaction_detail'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update Novalnet version while processing the current post id.&nbsp;</div></li><li><div>        update_post_meta( $post_id, '_nn_version', NN_VERSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to notify order got success.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( &quot;Transaction success process completed for the order $post_id TID:&quot; . $server_response ['tid'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;novalnet_redirect( $this-&gt;get_return_url( $wc_order ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check and maintain debug log if enabled&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $message Message to be logged.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function maintain_debug_log( $message ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;global_settings ['debug_log'] ) {&nbsp;</div></li><li><div>            $this-&gt;novalnet_log-&gt;add( 'novalnetpayments', $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Transaction failure process which cancel the&nbsp;</div></li><li><div>     * order and redirect to checkout page with error.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param array    $server_response The server response data.&nbsp;</div></li><li><div>     * @param WC_Order $wc_order        The order object.&nbsp;</div></li><li><div>     * @param string   $payment_type    The payment type value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception For admin change payment method.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function transaction_failure( $server_response, $wc_order, $payment_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $front_change_payment = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get message.&nbsp;</div></li><li><div>        $message = wc_novalnet_response_text( $server_response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to notify order got failed.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( &quot;Transaction got failed due to: $message for the order&quot; . $wc_order-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $front_change_payment = WC()-&gt;session-&gt;__isset( 'novalnet_change_payment_method' );&nbsp;</div></li><li><div>        if ( ! $front_change_payment ) {&nbsp;</div></li><li><div>            $payment_settings = wc_novalnet_payment_config( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Form transaction comments.&nbsp;</div></li><li><div>            $transaction_comments = novalnet_instance()-&gt;novalnet_functions()-&gt;form_comments(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                'test_mode' =&gt; ( ! empty( $server_response ['test_mode'] ) || $payment_settings ['test_mode'] ), &nbsp;</div></li><li><div>                'tid' =&gt; $server_response ['tid'], &nbsp;</div></li><li><div>                'title' =&gt; wc_novalnet_get_payment_text( $payment_settings, $this-&gt;language, $payment_type ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $transaction_comments .= PHP_EOL . $message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update transaction comments.&nbsp;</div></li><li><div>            novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $wc_order, $transaction_comments, true, 'transaction_info' );&nbsp;</div></li><li><div>            update_post_meta( $wc_order-&gt;id, '_nn_version', NN_VERSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Cancel order.&nbsp;</div></li><li><div>            $wc_order-&gt;cancel_order();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update cancelled transaction payment method with old payment method.&nbsp;</div></li><li><div>            $old_payment_method = get_post_meta( WC()-&gt;session-&gt;novalnet_change_payment_method, '_old_payment_method', true );&nbsp;</div></li><li><div>            $old_payment_method_title = get_post_meta( WC()-&gt;session-&gt;novalnet_change_payment_method, '_old_payment_method_title', true );&nbsp;</div></li><li><div>            update_post_meta( WC()-&gt;session-&gt;novalnet_change_payment_method, '_payment_method', $old_payment_method );&nbsp;</div></li><li><div>            update_post_meta( WC()-&gt;session-&gt;novalnet_change_payment_method, '_payment_method_title', $old_payment_method_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update notice comments.&nbsp;</div></li><li><div>            $transaction_comments = sprintf( __( 'Recurring change payment method has been failed due to %s', 'wc-novalnet' ), $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update transaction comments.&nbsp;</div></li><li><div>            novalnet_instance()-&gt;novalnet_functions()-&gt;update_comments( $wc_order, $transaction_comments, true, 'transaction_info' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error_return_url = apply_filters( 'novalnet_error_return_url', WC()-&gt;cart-&gt;get_checkout_url() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unset used sessions.&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;__unset( 'novalnet_change_payment_method' );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;__unset( 'novalnet_receipt_page' );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;__unset( $payment_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Display message.&nbsp;</div></li><li><div>        $this-&gt;display_info( $message, 'error' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Redirecting to checkout page.&nbsp;</div></li><li><div>        return $this-&gt;novalnet_redirect( $error_return_url, 'error' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Forming the mandatory fraud module parameters.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param array $params             The novalnet parameters.&nbsp;</div></li><li><div>     * @param int   $fraud_module_value The fraud module values.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function form_fraud_module_params( &$params, $fraud_module_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Fraud module parameters.&nbsp;</div></li><li><div>        if ( 'tel' === $this-&gt;settings ['fraud_module'] ) {&nbsp;</div></li><li><div>            $params ['pin_by_callback'] = '1';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $params ['pin_by_sms'] = '1';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $params [ $this-&gt;settings ['fraud_module'] ] = $fraud_module_value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepare the Novalnet transaction comments.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     * @param array   $response         The response data.&nbsp;</div></li><li><div>     * @param string  $payment_type     The payment type value.&nbsp;</div></li><li><div>     * @param int     $product_id       The product id.&nbsp;</div></li><li><div>     * @param array   $payment_settings The payment settings.&nbsp;</div></li><li><div>     * @param boolean $test_mode        The payment settings.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function prepare_payment_comments( $response, $payment_type, $product_id, $payment_settings, $test_mode ) {&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>        $bank_details = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initiate TEST ORDER notification to the Merchant.&nbsp;</div></li><li><div>        if ( get_option( 'novalnet_test_order_notification' ) && ! $payment_settings ['test_mode'] && '1' === $response ['test_mode'] ) {&nbsp;</div></li><li><div>            $content = sprintf( __( 'Dear client, &lt;br/&gt;&lt;br/&gt;We would like to inform you that test order (%s) has been placed in your shop recently.Please make sure your project is in LIVE mode at Novalnet administration portal and Novalnet payments are enabled in your shop system.&lt;br/&gt;Please ignore this email if the order has been placed by you for testing purpose.&lt;br/&gt;&lt;/br&gt;Regards, &lt;br/&gt;Novalnet AG', 'wc-novalnet' ), $response ['order_no'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subject = sprintf( __( 'Novalnet test order notification - %s', 'wc-novalnet' ), get_option( 'blogname' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Send E-mail notification for test order.&nbsp;</div></li><li><div>            wc_novalnet_send_mail( true, get_option( 'admin_email' ), $subject, $content );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Forming basic comments.&nbsp;</div></li><li><div>        $tid_details = novalnet_instance()-&gt;novalnet_functions()-&gt;form_comments(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>            'test_mode' =&gt; $test_mode, &nbsp;</div></li><li><div>            'tid' =&gt; $response ['tid'], &nbsp;</div></li><li><div>            'title' =&gt; wc_novalnet_get_payment_text( $payment_settings, $this-&gt;language, $payment_type ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $novalnet_comments = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Forming bank details comments.&nbsp;</div></li><li><div>        if ( in_array( $payment_type, array( 'novalnet_invoice', 'novalnet_prepayment' ), true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Payment reference values.&nbsp;</div></li><li><div>            $response ['payment_reference_1'] = $payment_settings ['payment_reference_1'];&nbsp;</div></li><li><div>            $response ['payment_reference_2'] = $payment_settings ['payment_reference_2'];&nbsp;</div></li><li><div>            $response ['payment_reference_3'] = $payment_settings ['payment_reference_3'];&nbsp;</div></li><li><div>            $response ['invoice_ref'] = 'BNR-' . $product_id . '-' . $response ['order_no'];&nbsp;</div></li><li><div>            $response ['amount'] = $response ['amount'] * 100;&nbsp;</div></li><li><div>            $response ['invoice_bankname'] = $response ['invoice_bankname'] . ' ' . $response ['invoice_bankplace'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Comments with bank details.&nbsp;</div></li><li><div>            $novalnet_comments .= novalnet_instance()-&gt;novalnet_functions()-&gt;form_bank_comments( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $bank_details = array(&nbsp;</div></li><li><div>                'test_mode' =&gt; (int) $test_mode, &nbsp;</div></li><li><div>                'invoice_bankname' =&gt; $response ['invoice_bankname'], &nbsp;</div></li><li><div>                'invoice_iban' =&gt; $response ['invoice_iban'], &nbsp;</div></li><li><div>                'invoice_bic' =&gt; $response ['invoice_bic'], &nbsp;</div></li><li><div>                'response_order_no' =&gt; $response ['order_no'], &nbsp;</div></li><li><div>                'invoice_ref' =&gt; $response ['invoice_ref'], &nbsp;</div></li><li><div>                'due_date' =&gt; $response ['due_date'], &nbsp;</div></li><li><div>                'payment_reference_1' =&gt; $payment_settings ['payment_reference_1'], &nbsp;</div></li><li><div>                'payment_reference_2' =&gt; $payment_settings ['payment_reference_2'], &nbsp;</div></li><li><div>                'payment_reference_3' =&gt; $payment_settings ['payment_reference_3'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check and store masked credit card details.&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>            if ( 'novalnet_cc' === $payment_type && empty( WC()-&gt;session-&gt;novalnet_cc ['novalnet_cc_reference_tid'] ) && isset( $this-&gt;settings ['payment_process'] ) && 'one_click_shop' === $this-&gt;settings ['payment_process'] && ! $this-&gt;settings ['cc_secure_enabled'] ) {&nbsp;</div></li><li><div>                $bank_details = array(&nbsp;</div></li><li><div>                    'cc_type' =&gt; $response ['cc_card_type'], &nbsp;</div></li><li><div>                    'cc_holder' =&gt; $response ['cc_holder'], &nbsp;</div></li><li><div>                    'cc_no' =&gt; $response ['cc_no'], &nbsp;</div></li><li><div>                    'cc_exp_month' =&gt; $response ['cc_exp_month'], &nbsp;</div></li><li><div>                    'cc_exp_year' =&gt; $response ['cc_exp_year'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Check and store masked Direct Debit SEPA details.&nbsp;</div></li><li><div>            } elseif ( 'novalnet_sepa' === $payment_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( empty( WC()-&gt;session-&gt;novalnet_sepa ['novalnet_sepa_reference_tid'] ) && isset( $this-&gt;settings ['payment_process'] ) && 'one_click_shop' === $this-&gt;settings ['payment_process'] ) {&nbsp;</div></li><li><div>                    $bank_details = array(&nbsp;</div></li><li><div>                        'account_holder' =&gt; $response ['bankaccount_holder'], &nbsp;</div></li><li><div>                        'iban' =&gt; $response ['iban'], &nbsp;</div></li><li><div>                        'bic' =&gt; $response ['bic'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( ! empty( WC()-&gt;session-&gt;novalnet_sepa ['novalnet_sepa_hash'] ) ) {&nbsp;</div></li><li><div>                    $bank_details ['hash'] = WC()-&gt;session-&gt;novalnet_sepa ['novalnet_sepa_hash'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Check and store PayPal transaction details.&nbsp;</div></li><li><div>            } elseif ( 'novalnet_paypal' === $payment_type && empty( WC()-&gt;session-&gt;novalnet_paypal ['novalnet_paypal_reference_tid'] ) && 'one_click_shop' === $this-&gt;settings ['payment_process'] ) {&nbsp;</div></li><li><div>                $bank_details = array(&nbsp;</div></li><li><div>                    'paypal_transaction_id' =&gt; $response ['paypal_transaction_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Serialize bank details.&nbsp;</div></li><li><div>        $bank_details = wc_novalnet_serialize_data( $bank_details );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( $tid_details, $novalnet_comments, $bank_details );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Processing redirect payment process.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param array $server_response The server response data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_redirect_payment_response( $server_response ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Trim the response values.&nbsp;</div></li><li><div>        $server_response = array_map( 'trim', $server_response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get order ID.&nbsp;</div></li><li><div>        if ( ! empty( $server_response ['inputval3'] ) ) {&nbsp;</div></li><li><div>            $order_id = $server_response ['inputval3'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $order_id = WC()-&gt;session-&gt;novalnet_post_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wc_order = new WC_Order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_novalnet_process_affiliate_action( $this-&gt;global_settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for hash error.&nbsp;</div></li><li><div>        if ( ( $this-&gt;success_status( $this-&gt;id, $server_response ) ) && isset( $server_response ['hash2'] ) && wc_novalnet_generate_hash( $server_response, $this-&gt;global_settings ['key_password'] ) !== $server_response ['hash2'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $server_response['status_text'] = __( 'While redirecting some data has been changed. The hash check failed', 'wc-novalnet' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Transaction failure process.&nbsp;</div></li><li><div>            return $this-&gt;transaction_failure( $server_response, $wc_order, $this-&gt;id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $server_response ['test_mode'] = $this-&gt;decode_data( $server_response ['test_mode'], $this-&gt;global_settings ['key_password'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Checks transaction status.&nbsp;</div></li><li><div>        return $this-&gt;check_transaction_status( $server_response, $wc_order, $this-&gt;id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set time limit for Fraud module&nbsp;</div></li><li><div>     * and fraud module process&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     * @param array $server_response The server response data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_time_limit( $server_response ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set session to process fraud module.&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( 'novalnet', $server_response );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( $this-&gt;id . '_time_limit', time() + ( 30 * 60 ) );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( $this-&gt;id . '_tid', $server_response['tid'] );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( $this-&gt;id . '_order_total', wc_novalnet_formatted_amount( WC()-&gt;session-&gt;total ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the Display message.&nbsp;</div></li><li><div>        if ( 'mobile' === $this-&gt;settings ['fraud_module'] ) {&nbsp;</div></li><li><div>            $message = __( 'You will shortly receive an SMS containing your transaction PIN to complete the payment', 'wc-novalnet' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $message = __( 'You will shortly receive a transaction PIN through phone call to complete the payment', 'wc-novalnet' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;display_info( $message );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;__unset( $this-&gt;id . '_fraud_check_validate' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to notify PIN generated successfully.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( 'Pin generated for the payment: ' . $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Redirect to checkout page.&nbsp;</div></li><li><div>        return $this-&gt;novalnet_redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Send PIN to Novalnet server&nbsp;</div></li><li><div>     * to Process fraud module second call&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_pin_call() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for amount change while processing pin status call.&nbsp;</div></li><li><div>        if ( WC()-&gt;session-&gt;get( $this-&gt;id . '_order_total' ) !== wc_novalnet_formatted_amount( WC()-&gt;session-&gt;total ) ) {&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( $this-&gt;id . '_tid' );&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( $this-&gt;id . '_order_total' );&nbsp;</div></li><li><div>            $this-&gt;display_info( __( 'The order amount has been changed, please proceed with the new order', 'wc-novalnet' ), 'error' );&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Payment session values.&nbsp;</div></li><li><div>        $session = WC()-&gt;session-&gt;get( $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Using TRANSMIT_PIN_AGAIN as default.&nbsp;</div></li><li><div>        $request_type = 'TRANSMIT_PIN_AGAIN';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_novalnet_process_affiliate_action( $this-&gt;global_settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request = array(&nbsp;</div></li><li><div>         'vendor_id' =&gt; $this-&gt;global_settings ['vendor_id'], &nbsp;</div></li><li><div>         'vendor_authcode' =&gt; $this-&gt;global_settings ['auth_code'], &nbsp;</div></li><li><div>         'product_id' =&gt; $this-&gt;global_settings ['product_id'], &nbsp;</div></li><li><div>         'request_type' =&gt; $request_type, &nbsp;</div></li><li><div>         'tid' =&gt; WC()-&gt;session-&gt;get( $this-&gt;id . '_tid' ), &nbsp;</div></li><li><div>         'lang' =&gt; $this-&gt;language, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Assign PIN_STATUS request.&nbsp;</div></li><li><div>        if ( empty( $session [ $this-&gt;id . '_new_pin' ] ) ) {&nbsp;</div></li><li><div>            $request ['pin'] = $session [ $this-&gt;id . '_pin' ];&nbsp;</div></li><li><div>            $request_type = 'PIN_STATUS';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $request ['request_type'] = $request_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Perform XML request.&nbsp;</div></li><li><div>        $response = novalnet_instance()-&gt;novalnet_functions()-&gt;perform_xmlrequest( $request );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unset the previous pin session values and update in the session.&nbsp;</div></li><li><div>        unset( $session [ $this-&gt;id . '_new_pin' ], $session [ $this-&gt;id . '_pin' ] );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( $this-&gt;id, $session );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check the status to hide the payment.&nbsp;</div></li><li><div>        if ( wc_novalnet_status_check( $response, 'status', '0529006' ) ) {&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;set( $this-&gt;id . '_invalid_count', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to maintain PIN_STATUS call process.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( 'Pin sent to the server for the payment: ' . $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Receipt page for redirect and iframe process.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $order_id The order id.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function receipt_page( $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wc_order = new WC_Order( $order_id );&nbsp;</div></li><li><div>        $novalnet_parameters = $this-&gt;form_payment_params( $wc_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set post ID in session to use in post response process.&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( 'novalnet_post_id', $wc_order-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! WC()-&gt;session-&gt;__isset( 'novalnet_receipt_page' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $contents = array(&nbsp;</div></li><li><div>             'paygate_url' =&gt; $novalnet_parameters ['paygate_url'], &nbsp;</div></li><li><div>             'params' =&gt; $novalnet_parameters ['params'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_novalnet_load_template( 'render-redirect-form.php', $contents );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Assign receipt page session.&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;set( 'novalnet_receipt_page', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * To get instance values.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function initialize_basic_details() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initiate Log.&nbsp;</div></li><li><div>        $this-&gt;novalnet_log = wc_novalnet_logger();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get global configuraion.&nbsp;</div></li><li><div>        $this-&gt;global_settings = $this-&gt;global_configurations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get language.&nbsp;</div></li><li><div>        $this-&gt;language = wc_novalnet_shop_language();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Assigning basic details in gateway instance&nbsp;</div></li><li><div>     * variable and using shop actions and filters.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function assign_basic_payment_details() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initialize Log & vendor details.&nbsp;</div></li><li><div>        $this-&gt;initialize_basic_details();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Initiate payment settings.&nbsp;</div></li><li><div>        $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Payment title in back-end.&nbsp;</div></li><li><div>        $this-&gt;method_title = wc_novalnet_get_payment_text( $this-&gt;settings, $this-&gt;language, $this-&gt;id, 'admin_title' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Payment title in front-end.&nbsp;</div></li><li><div>        $this-&gt;title = wc_novalnet_get_payment_text( $this-&gt;settings, $this-&gt;language, $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Payment description.&nbsp;</div></li><li><div>        $this-&gt;description = wc_novalnet_get_payment_text( $this-&gt;settings, $this-&gt;language, $this-&gt;id, 'description' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Gateway view transaction URL.&nbsp;</div></li><li><div>        $this-&gt;view_transaction_url = admin_url( 'admin.php?page=wc-novalnet-admin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Basic payment supports.&nbsp;</div></li><li><div>        $this-&gt;supports = array(&nbsp;</div></li><li><div>         'products', &nbsp;</div></li><li><div>         'add-payment-method', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Novalnet subscription supports.&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;global_settings ['subs_payments'] ) && in_array( $this-&gt;id, $this-&gt;global_settings ['subs_payments'], true ) ) {&nbsp;</div></li><li><div>            $this-&gt;supports = apply_filters( 'novalnet_subscription_supports', $this-&gt;supports, $this-&gt;id, $this-&gt;settings );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wc_novalnet_check_admin() ) {&nbsp;</div></li><li><div>            $this-&gt;chosen = ( WC()-&gt;session-&gt;__isset( 'chosen_payment_method' ) && WC()-&gt;session-&gt;chosen_payment_method === $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Assign order status.&nbsp;</div></li><li><div>            add_filter( 'woocommerce_valid_order_statuses_for_payment_complete', 'wc_novalnet_append_shop_order_status', 10, 2 );&nbsp;</div></li><li><div>            add_filter( 'woocommerce_payment_complete_order_status', array( &$this, 'get_order_status' ), 10, 2 );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Display payment configuration fields.&nbsp;</div></li><li><div>            $this-&gt;init_form_fields();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Handle redirection payment request form.&nbsp;</div></li><li><div>        add_action( 'woocommerce_receipt_' . $this-&gt;id, array( &$this, 'receipt_page' ) );&nbsp;</div></li><li><div>        add_action( 'after_woocommerce_pay', 'wc_novalnet_receipt_page_session_unset' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save gateway settings.&nbsp;</div></li><li><div>        add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Customize front-end my-account option.&nbsp;</div></li><li><div>        add_filter( 'woocommerce_my_account_my_orders_actions', 'wc_novalnet_filter_my_account', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Process Callback.&nbsp;</div></li><li><div>        add_action( 'woocommerce_api_novalnet_callback', 'wc_novalnet_process_callback_api_process', 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Customize thank you page.&nbsp;</div></li><li><div>        add_action( 'woocommerce_thankyou_' . $this-&gt;id, array( &$this, 'thankyou_page' ) );&nbsp;</div></li><li><div>        add_action( 'woocommerce_thankyou', 'wc_novalnet_thankyou_page_session_unset' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Customize E-mail.&nbsp;</div></li><li><div>        add_action( 'woocommerce_email_after_order_table', array( &$this, 'add_email_instructions' ), 10, 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Align order confirmation mail transaction comments.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Order $order The order object.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_email_instructions( $order ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check Novalnet payment.&nbsp;</div></li><li><div>        if ( wc_novalnet_check_string( $order-&gt;payment_method ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check email notes.&nbsp;</div></li><li><div>            if ( $order-&gt;payment_method === $this-&gt;id && ! empty( $this-&gt;settings ['email_notes'] ) && ! wc_novalnet_check_string( $order-&gt;customer_note, $this-&gt;settings ['email_notes'] ) ) {&nbsp;</div></li><li><div>                $order-&gt;customer_note .= wpautop( $this-&gt;settings ['email_notes'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $order-&gt;customer_note = wpautop( $order-&gt;customer_note );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Customizing shop thankyou page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function thankyou_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! WC()-&gt;session-&gt;__isset( 'novalnet_thankyou_page' ) ) {&nbsp;</div></li><li><div>            echo wp_kses( wpautop( $this-&gt;settings ['instructions'] ), array() );&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;set( 'novalnet_thankyou_page', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Display the gateway details in checkout page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $details The details data.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function display_payment_details( $details ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Hide multiple payment fields.&nbsp;</div></li><li><div>        wc_novalnet_hide_multiple_payment();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add payment informations.&nbsp;</div></li><li><div>        $contents = wpautop( $details ['description'] );&nbsp;</div></li><li><div>        $contents .= wpautop( $details ['payment_instruction'] );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;__unset( 'novalnet_receipt_page' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Unset payment session for ignored payments.&nbsp;</div></li><li><div>        if ( WC()-&gt;session-&gt;__isset( 'chosen_payment_method' ) && WC()-&gt;session-&gt;chosen_payment_method !== $this-&gt;id ) {&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( $this-&gt;id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $details ['test_mode'] ) {&nbsp;</div></li><li><div>            $contents .= wpautop( '&lt;p style=&quot;color:red;&quot;&gt;' . esc_html__( 'The payment will be processed in the test mode therefore amount for this transaction will not be charged', 'wc-novalnet' ) . '&lt;/p&gt;' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Include checkout template.&nbsp;</div></li><li><div>        wc_novalnet_load_template( 'render-checkout-form.php', $contents );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Redirects to the given URL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $url      The url value.&nbsp;</div></li><li><div>     * @param string $redirect The result type.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function novalnet_redirect( $url = '', $redirect = 'success' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' === $url ) {&nbsp;</div></li><li><div>            $url = WC()-&gt;cart-&gt;get_checkout_url();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>         'result' =&gt; $redirect, &nbsp;</div></li><li><div>         'redirect' =&gt; $url, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * To display the success and failure&nbsp;</div></li><li><div>     * messages.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 10.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $message      The message value.&nbsp;</div></li><li><div>     * @param string $message_type The message type value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function display_info( $message, $message_type = 'success' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log to maintain error validations.&nbsp;</div></li><li><div>        $this-&gt;maintain_debug_log( &quot;Payment has notify message $message_type: $message&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_add_notice( $message, $message_type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks and unset the other Novalnet sessions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function unset_other_payment_session() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( wc_novalnet_get_payment_type() as $payment ) {&nbsp;</div></li><li><div>            if ( $this-&gt;id !== $payment ) {&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $payment );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( $payment . '_tid' );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( 'novalnet_receipt_page' );&nbsp;</div></li><li><div>                WC()-&gt;session-&gt;__unset( 'sepa_hash' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $get_request = $_GET; // input var okay.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for force order.&nbsp;</div></li><li><div>        if ( ! empty( $get_request['pay_for_order'] ) && ! empty( $get_request['force_pay_order'] ) && empty( $get_request['change_payment_method'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Display message.&nbsp;</div></li><li><div>            $this-&gt;display_info( __( 'Novalnet Transaction for the Order has been executed / cancelled already.', 'wc-novalnet' ), 'error' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Redirect to my-account page.&nbsp;</div></li><li><div>            wc_novalnet_safe_redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check for change payment method.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 11.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_change_payment_method() {&nbsp;</div></li><li><div>        $request = $_REQUEST; // input var okay.&nbsp;</div></li><li><div>        if ( ! empty( $request ['change_payment_method'] ) ) {&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;set( 'novalnet_change_payment_method', $request ['change_payment_method'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            WC()-&gt;session-&gt;__unset( 'novalnet_change_payment_method' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 11.1.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.1/classes/nn_payment_gateways/" class="active">11.1.1</a></li><li><a href="http://hookr.io/plugins/novalnet-payment-plugin-woocommerce/11.1.0/classes/nn_payment_gateways/" class="">11.1.0</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>NN_Payment_Gateways</li><li><span></span>Novalnet Payment Plugin - WooCommerce</li><li><span></span>11.1.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>