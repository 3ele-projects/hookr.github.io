<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.4" data-slug="woocommerce-safircod" data-type="file" data-id="83073"><head xmlns="http://www.w3.org/1999/xhtml"><title> safircod | file | Woocommerce Safircod | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-safircod, 1.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=ccd8a07bbccc40b6bc549fc081ef69eb' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/safircod/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fsafircod%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fsafircod%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-safircod-1.4-file-safircod","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="safircod" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-safircod." href="http://hookr.io/plugins/woocommerce-safircod/" class="plugin"><span property="name">woocommerce-safircod</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.4." href="http://hookr.io/plugins/woocommerce-safircod/1.4/" class="H_VERSION"><span property="name">1.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-safircod/1.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">safircod</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="60"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/all/" title="All">All <span class="count badge">60</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="13"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/hooks/" title="Hooks">Hooks <span class="count badge">13</span></a></li><li class="" data-id="action" data-count="10"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/actions/" title="Actions">Actions <span class="count badge">10</span></a></li><li class="" data-id="filter" data-count="3"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/filters/" title="Filters">Filters <span class="count badge">3</span></a></li><li class="" data-id="class" data-count="36"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/classes/" title="Classes">Classes <span class="count badge">36</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="11"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/functions/" title="Functions">Functions <span class="count badge">11</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-safircod/1.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/safircod.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name: WooCommerce SafirCOD</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI: http://safircod.ir/</span>&nbsp;</div></li><li><div><span class="comment">Description: This plugin integrates &lt;strong&gt;SafirCOD&lt;/strong&gt; service with WooCommerce.</span>&nbsp;</div></li><li><div><span class="comment">Version: 1.4</span>&nbsp;</div></li><li><div><span class="comment">Author: Domanjiri</span>&nbsp;</div></li><li><div><span class="comment">Text Domain: safircod</span>&nbsp;</div></li><li><div><span class="comment">Domain Path: /lang/</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is free software; you can redistribute it and/or modify</span>&nbsp;</div></li><li><div><span class="comment">it under the terms of the GNU General Public License, version 2, as </span>&nbsp;</div></li><li><div><span class="comment">published by the Free Software Foundation.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">This program is distributed in the hope that it will be useful, </span>&nbsp;</div></li><li><div><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>&nbsp;</div></li><li><div><span class="comment">GNU General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">**/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function activate_WC_SafirCOD_plugin()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  wp_schedule_event(time(), 'hourly', 'update_safir_orders_state');&nbsp;</div></li><li><div>} &nbsp;</div></li><li><div>register_activation_hook(__FILE__, 'activate_WC_SafirCOD_plugin');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function deactivate_WC_SafirCOD_plugin()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  wp_clear_scheduled_hook('update_safir_orders_state');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>register_deactivation_hook(__FILE__, 'deactivate_WC_SafirCOD_plugin');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">// </span>Check if WooCommerce is active</span>&nbsp;</div></li><li><div>if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) ) {&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>  function safircod_shipping_method_init() {&nbsp;</div></li><li><div>          if(!class_exists('nusoap_client')) { <span class="comment"><span class="comment">// </span>edit @ 02 14</span>&nbsp;</div></li><li><div>              include_once(plugin_dir_path(__FILE__) . 'lib/nusoap/nusoap.php');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">// </span>&nbsp;</div></li><li><div>          date_default_timezone_set('Asia/Tehran');&nbsp;</div></li><li><div>          ini_set('default_socket_timeout', 160);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">// </span>Define Pishtaz method&nbsp;</div></li><li><div>          if ( ! class_exists( 'WC_Safircod_Pishtaz_Method' ) ) {&nbsp;</div></li><li><div>               class WC_Safircod_Pishtaz_Method extends WC_Shipping_Method &nbsp;</div></li><li><div>               {&nbsp;</div></li><li><div>                      var $url = &quot;&quot;;&nbsp;</div></li><li><div>                      var $wsdl_url = &quot;http:<span class="comment">//ws.safircod.ir/userservice.asmx?WSDL&quot;;</span>&nbsp;</div></li><li><div>                      var $username = &quot;&quot;;&nbsp;</div></li><li><div>                      var $password = &quot;&quot;;&nbsp;</div></li><li><div>                      var $debug = 0;&nbsp;</div></li><li><div>                      var $w_unit = &quot;&quot;;&nbsp;</div></li><li><div>                      var $debug_file = &quot;&quot;;&nbsp;</div></li><li><div>                      var $client = null;&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                      public function __construct() &nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                         $this-&gt;id = 'safircod_pishtaz'; &nbsp;</div></li><li><div>                         $this-&gt;method_title = __( '*** ******' ); &nbsp;</div></li><li><div>                         $this-&gt;method_description = __( '***** **** *** ****** ' ); <span class="comment">// </span>Description shown in admin&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>                         $this-&gt;init();&nbsp;</div></li><li><div>                         $this-&gt;account_data();&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>                      function init() &nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                         $this-&gt;init_form_fields(); <span class="comment">// </span>This is part of the settings API. Override the method to add your own settings&nbsp;</div></li><li><div>                         $this-&gt;init_settings(); <span class="comment">// </span>This is part of the settings API. Loads settings you previously init.&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                         $this-&gt;enabled = $this-&gt;get_option( 'enabled' );&nbsp;</div></li><li><div>                         $this-&gt;title = $this-&gt;get_option( 'title' );&nbsp;</div></li><li><div>                         $this-&gt;minimum_fee = $this-&gt;get_option( 'min_amount', 0 );&nbsp;</div></li><li><div>                         $this-&gt;w_unit = strtolower( get_option('woocommerce_weight_unit') );&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                         <span class="comment">// </span>Save settings in admin if you have any defined&nbsp;</div></li><li><div>                         add_action( 'woocommerce_update_options_shipping_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      function account_data() &nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                          $this-&gt;username = $this-&gt;get_option( 'username', '' );&nbsp;</div></li><li><div>                          $this-&gt;password = $this-&gt;get_option( 'password', '' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                      function init_form_fields() &nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                             global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( $this-&gt;minimum_fee )&nbsp;</div></li><li><div>                               $default_requires = 'min_amount';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           $this-&gt;form_fields = array(&nbsp;</div></li><li><div>                               'enabled' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( 'Enable/Disable', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                                               'label' =&gt; __( '**** **** *** ******', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'title' =&gt; array(&nbsp;</div></li><li><div>                                                                    'title' =&gt; __( 'Method Title', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'text', &nbsp;</div></li><li><div>                                               'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; __( '*** ******', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'min_amount' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( 'Minimum Order Amount', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'number', &nbsp;</div></li><li><div>                                               'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                                                   'step' =&gt; 'any', &nbsp;</div></li><li><div>                                                   'min' =&gt; '0'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                                               'description' =&gt; __( '****** ***** **** **** **** *** *** *** *****.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; '0', &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                                               'placeholder' =&gt; '0.00'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'username' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( '*** ****** ***** ****', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'text', &nbsp;</div></li><li><div>                                               'description' =&gt; __( '*** ****** *** ** ***** ****.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; __( '', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'password' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( '*** ******* ** ** *****', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'password', &nbsp;</div></li><li><div>                                               'description' =&gt; __( '*** **** **** ***** ** ** ***** ****.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; __( '', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>                      public function admin_options() &nbsp;</div></li><li><div>                      {&nbsp;</div></li><li><div>                          ?&gt;&nbsp;</div></li><li><div>                           &lt;h3&gt;&lt;?php _e( '*** ******' ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                           &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                           &lt;?php&nbsp;</div></li><li><div>                               <span class="comment">// </span>Generate the HTML For the settings form.&nbsp;</div></li><li><div>                               $this-&gt;generate_settings_html();&nbsp;</div></li><li><div>                           ?&gt;&nbsp;</div></li><li><div>                           &lt;/table&gt;&nbsp;</div></li><li><div>                           &lt;?php&nbsp;</div></li><li><div>                     }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>                    function is_available( $package ) &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                         global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         if ( $this-&gt;enabled == &quot;no&quot; ) return false;&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>                         if ( ! in_array( get_woocommerce_currency(), array( 'IRR', 'IRT' ) ) ) return false;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                         if( $this-&gt;w_unit != 'g' && $this-&gt;w_unit != 'kg' )&nbsp;</div></li><li><div>                             return false;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                         if ( $this-&gt;username ==&quot;&quot; || $this-&gt;password==&quot;&quot;)&nbsp;</div></li><li><div>                             return false;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                         <span class="comment">// </span>Enabled logic&nbsp;</div></li><li><div>                            $has_met_min_amount = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( isset( $woocommerce-&gt;cart-&gt;cart_contents_total ) ) {&nbsp;</div></li><li><div>                                &nbsp;</div></li><li><div>                               if ( $woocommerce-&gt;cart-&gt;prices_include_tax )&nbsp;</div></li><li><div>                                       $total = $woocommerce-&gt;cart-&gt;cart_contents_total + array_sum( $woocommerce-&gt;cart-&gt;taxes );&nbsp;</div></li><li><div>                                else&nbsp;</div></li><li><div>                                      $total = $woocommerce-&gt;cart-&gt;cart_contents_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if ( $total &gt;= $this-&gt;minimum_fee )&nbsp;</div></li><li><div>                                      $has_met_min_amount = true;&nbsp;</div></li><li><div>                         }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         if ( $has_met_min_amount ) $is_available = true;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         return apply_filters( 'woocommerce_shipping_' . $this-&gt;id . '_is_available', $is_available );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    public function calculate_shipping( $package ) &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                         global $woocommerce;&nbsp;</div></li><li><div>                         $customer = $woocommerce-&gt;customer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         if( empty($package['destination']['city'])) {&nbsp;</div></li><li><div>                             $rate = array(&nbsp;</div></li><li><div>                                 'id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>                                 'label' =&gt; $this-&gt;title, &nbsp;</div></li><li><div>                                 'cost' =&gt; 0&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                             $this-&gt;add_rate( $rate );&nbsp;</div></li><li><div>                         }&nbsp;</div></li><li><div>                        &nbsp;</div></li><li><div>                         $this-&gt;shipping_total = 0;&nbsp;</div></li><li><div>                           $weight = 0;&nbsp;</div></li><li><div>                         $unit = ($this-&gt;w_unit == 'g') ? 1 : 1000;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                         $data = array();&nbsp;</div></li><li><div>                         if (sizeof($woocommerce-&gt;cart-&gt;get_cart()) &gt; 0 && ($customer-&gt;get_shipping_city())) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            foreach ($woocommerce-&gt;cart-&gt;get_cart() as $item_id =&gt; $values) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $_product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($_product-&gt;exists() && $values['quantity'] &gt; 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if (!$_product-&gt;is_virtual()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $weight += $_product-&gt;get_weight() * $unit * $values['quantity'];&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                               }&nbsp;</div></li><li><div>                            } <span class="comment"><span class="comment">//end foreach</span></span>&nbsp;</div></li><li><div>                            &nbsp;</div></li><li><div>                            $data['weight'] = $weight;&nbsp;</div></li><li><div>                            $data['service_type'] = 1;  <span class="comment">// </span>pishtaz&nbsp;</div></li><li><div>                            if ($weight) {&nbsp;</div></li><li><div>                                $this-&gt;get_shipping_response($data, $package);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                       &nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                    function get_shipping_response($data = false, $package) &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                         global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         if($this-&gt;debug) {&nbsp;</div></li><li><div>                             $this-&gt;debug_file = new WC_SafirCOD_Debug();&nbsp;</div></li><li><div>                         }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                         $rates = array();&nbsp;</div></li><li><div>                         $customer = $woocommerce-&gt;customer;&nbsp;</div></li><li><div>                         $update_rates = false;&nbsp;</div></li><li><div>                         $debug_response = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         $cart_items = $woocommerce-&gt;cart-&gt;get_cart();&nbsp;</div></li><li><div>                         foreach ($cart_items as $id =&gt; $cart_item) {&nbsp;</div></li><li><div>                             $cart_temp[] = $id . $cart_item['quantity'];&nbsp;</div></li><li><div>                         }&nbsp;</div></li><li><div>                         $cart_hash = hash('MD5', serialize($cart_temp));&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                      $service = $this-&gt;safir_service();&nbsp;</div></li><li><div>                      $total_price = (get_woocommerce_currency() == &quot;IRT&quot;) ? $woocommerce-&gt;cart-&gt;subtotal * 10 + $service : $woocommerce-&gt;cart-&gt;subtotal + $service;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                      $customer_state = $package['destination']['state'];&nbsp;</div></li><li><div>                      $customer_state = explode('-', $customer_state);&nbsp;</div></li><li><div>                      $customer_state = intval($customer_state[0]);&nbsp;</div></li><li><div>                      if( $customer_state && $customer_state &gt;0) {&nbsp;</div></li><li><div>                          <span class="comment">// </span>nothing!&nbsp;</div></li><li><div>                      }else{&nbsp;</div></li><li><div>                           if($this-&gt;debug) {&nbsp;</div></li><li><div>                              ob_start();&nbsp;</div></li><li><div>                              var_dump($customer_state);&nbsp;</div></li><li><div>                              $text = ob_get_contents();&nbsp;</div></li><li><div>                              ob_end_clean();&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                              $this-&gt;debug_file-&gt;write('@get_shipping_response::state is not valid:'.$text);&nbsp;</div></li><li><div>                           }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                      $customer_city = $package['destination']['city'];&nbsp;</div></li><li><div>                      $customer_city = explode('-', $customer_city);&nbsp;</div></li><li><div>                      $customer_city = intval($customer_city[0]);&nbsp;</div></li><li><div>                      if( $customer_city && $customer_city &gt;0) {&nbsp;</div></li><li><div>                          <span class="comment">// </span>again nothing!&nbsp;</div></li><li><div>                      }else{&nbsp;</div></li><li><div>                          if($this-&gt;debug) {&nbsp;</div></li><li><div>                              $this-&gt;debug_file-&gt;write('@get_shipping_response::city is not valid:'.$customer_city);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                      $shipping_data = array(&nbsp;</div></li><li><div>                                       'ZoneID' =&gt; $customer_state, &nbsp;</div></li><li><div>                                       'CityID' =&gt; $customer_city, &nbsp;</div></li><li><div>                                       'TotalWeight' =&gt; $data['weight'], &nbsp;</div></li><li><div>                                       'TotalPrice' =&gt; $total_price, &nbsp;</div></li><li><div>                                       'ServiceType' =&gt; $data['service_type'], &nbsp;</div></li><li><div>                                       'COD' =&gt; 0, <span class="comment">// </span>cod&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $cache_data = get_transient(get_class($this));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($cache_data) &nbsp;</div></li><li><div>                          if ($cache_data['cart_hash'] == $cart_hash && $cache_data['shipping_data']['CityID'] == $shipping_data['CityID'] && $cache_data['shipping_data']['TotalWeight'] == $shipping_data['TotalWeight'] && $cache_data['shipping_data']['TotalPrice'] == $shipping_data['TotalPrice'] && $cache_data['shipping_data']['ServiceType'] == $shipping_data['ServiceType'])  &nbsp;</div></li><li><div>                              $rates = $cache_data['rates'];&nbsp;</div></li><li><div>                          else&nbsp;</div></li><li><div>                              $update_rates = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      else&nbsp;</div></li><li><div>                          $update_rates = true;&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       if ($update_rates) {&nbsp;</div></li><li><div>                          $data = $this-&gt;safir_prepare($shipping_data);&nbsp;</div></li><li><div>                          $result = $this-&gt;safir_shipping($data);&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                          if ($this-&gt;debug) {&nbsp;</div></li><li><div>                              ob_start();&nbsp;</div></li><li><div>                              var_dump($result);&nbsp;</div></li><li><div>                              $text = ob_get_contents();&nbsp;</div></li><li><div>                              ob_end_clean();&nbsp;</div></li><li><div>                             $this-&gt;debug_file-&gt;write('@get_shipping_response::everything is Ok:'.$text);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                          $rates = intval($result)*1.09;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $cache_data['shipping_data'] = $shipping_data;&nbsp;</div></li><li><div>                          $cache_data['cart_hash'] = $cart_hash;&nbsp;</div></li><li><div>                          $cache_data['rates'] = $rates;&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>                       &nbsp;</div></li><li><div>                       set_transient(get_class($this), $cache_data, 60*60*5);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       $rate = (get_woocommerce_currency() == &quot;IRT&quot;) ? (int)(intval(($rates+$service) / 10)/100)*100+100  : (int)(((int)$rates+$service)/1000)*1000+1000;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       $my_rate = array(&nbsp;</div></li><li><div>                                 'id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>                                 'label' =&gt; $this-&gt;title, &nbsp;</div></li><li><div>                                 'cost' =&gt; $rate, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                       $this-&gt;add_rate($my_rate);&nbsp;</div></li><li><div>                       &nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                    function safir_prepare($data = false) &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                        $data['UserName'] = $this-&gt;username;&nbsp;</div></li><li><div>                        $data['Pass'] = $this-&gt;password;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        return $data;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    function safir_shipping($data = false, $cache = false) &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                        global $woocommerce;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                        if ($this-&gt;debug) {&nbsp;</div></li><li><div>                            $this-&gt;debug_file-&gt;write('@safir_shipping::here is top of function');&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        &nbsp;</div></li><li><div>                        $this-&gt;client = new nusoap_client( $this-&gt;wsdl_url, true );&nbsp;</div></li><li><div>                        $this-&gt;client-&gt;soap_defencoding = 'UTF-8';&nbsp;</div></li><li><div>                        $this-&gt;client-&gt;decode_utf8 = true;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                        $response = $this-&gt;call(&quot;GetPostCost&quot;, $data);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                        if(is_array($response) && !empty($response['error'])) {&nbsp;</div></li><li><div>                            if ($this-&gt;debug) {&nbsp;</div></li><li><div>                                  $this-&gt;debug_file-&gt;write('@safir_service::'.$response['message']);&nbsp;</div></li><li><div>                                  wc_clear_notices();&nbsp;</div></li><li><div>                                  wc_add_notice('&lt;p&gt;Safir Error:&lt;/p&gt; &lt;p&gt;'.$response['message'].'&lt;/p&gt;');&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                            return 30000;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                        mkobject($response);&nbsp;</div></li><li><div>                        $cost = intval($response-&gt;GetPostCostResult);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                        if ($this-&gt;debug) {&nbsp;</div></li><li><div>                            ob_start();&nbsp;</div></li><li><div>                            var_dump($data);&nbsp;</div></li><li><div>                            $text = ob_get_contents();&nbsp;</div></li><li><div>                            ob_end_clean();&nbsp;</div></li><li><div>                            $this-&gt;debug_file-&gt;write('@safir_shipping::Everything is Ok:'.$text);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          return $cost;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                    function safir_service() &nbsp;</div></li><li><div>                    {&nbsp;</div></li><li><div>                      <span class="comment">// </span>webservice dont responsible!&nbsp;</div></li><li><div>                       return 6000; &nbsp;</div></li><li><div>                       global $woocommerce;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       $cache_data = get_transient('safir_cod_service_price');&nbsp;</div></li><li><div>                       if ($cache_data) {&nbsp;</div></li><li><div>                           if (time() - (int)$cache_data['date'] &lt; 86400) {&nbsp;</div></li><li><div>                               if ($this-&gt;debug) {&nbsp;</div></li><li><div>                                   $this-&gt;debug_file-&gt;write('@safir_service::Everything is Ok --&gt; return from cache');&nbsp;</div></li><li><div>                               }&nbsp;</div></li><li><div>                               return $cache_data['price'];&nbsp;</div></li><li><div>                           }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>       &nbsp;</div></li><li><div>                       $this-&gt;client = new nusoap_client( $this-&gt;wsdl_url, true );&nbsp;</div></li><li><div>                       $this-&gt;client-&gt;soap_defencoding = 'UTF-8';&nbsp;</div></li><li><div>                       $this-&gt;client-&gt;decode_utf8 = true;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       $response = $this-&gt;call(&quot;GetServiceCost&quot;, array());&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       if(is_array($response) && $response['error']) {&nbsp;</div></li><li><div>                           if ($this-&gt;debug) {&nbsp;</div></li><li><div>                                      $this-&gt;debug_file-&gt;write('@safir_service::'.$response['message']);&nbsp;</div></li><li><div>                                       wc_clear_notices();&nbsp;</div></li><li><div>                                       wc_add_notice('&lt;p&gt;Safir Error:&lt;/p&gt; &lt;p&gt;'.$response['message'].'&lt;/p&gt;');&nbsp;</div></li><li><div>                           }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                          return 7000; <span class="comment">// </span>estimated&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       $service = intval($response);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       $cache_data['date'] = time();&nbsp;</div></li><li><div>                       $cache_data['price'] = $service;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       set_transient('safir_cod_service_price', $cache_data, 60*60*24);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                       if ($this-&gt;debug) {&nbsp;</div></li><li><div>                           $this-&gt;debug_file-&gt;write('@safir_service::Everything is Ok');&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       return $service;&nbsp;</div></li><li><div>                   }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                   public function call($method, $params)&nbsp;</div></li><li><div>                   {&nbsp;</div></li><li><div>                       $result = $this-&gt;client-&gt;call($method, $params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       if($this-&gt;client-&gt;fault || ((bool)$this-&gt;client-&gt;getError()))&nbsp;</div></li><li><div>                       {&nbsp;</div></li><li><div>                           return array('error' =&gt; true, 'fault' =&gt; true, 'message' =&gt; $this-&gt;client-&gt;getError());&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       return $result;&nbsp;</div></li><li><div>                   }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                   public function handleError($error, $status)&nbsp;</div></li><li><div>                   {&nbsp;</div></li><li><div>                       if($status =='sendprice')&nbsp;</div></li><li><div>                       switch ($error)&nbsp;</div></li><li><div>                       {&nbsp;</div></li><li><div>                           case -1:&nbsp;</div></li><li><div>                               return 'User name or password is wrong';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           case -2:&nbsp;</div></li><li><div>                               return 'Requested service is wrong';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           case -3:&nbsp;</div></li><li><div>                               return 'resquest is out of normal service';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           case -4:&nbsp;</div></li><li><div>                               return 'weight or amount is invalid';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                               return false;&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>                       if($status =='register')&nbsp;</div></li><li><div>                       switch ($error)&nbsp;</div></li><li><div>                       {&nbsp;</div></li><li><div>                           case -1:&nbsp;</div></li><li><div>                               return 'User name or password is wrong';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>               &nbsp;</div></li><li><div>                           case -2:&nbsp;</div></li><li><div>                               return 'Requested service is wrong';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           case -3:&nbsp;</div></li><li><div>                               return 'resquest is out of normal service';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           case -4:&nbsp;</div></li><li><div>                               return 'Products list is invalid';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>                           case -5:&nbsp;</div></li><li><div>                               return 'Error in webservice';&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>         &nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                               return false;&nbsp;</div></li><li><div>                               break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>                   }&nbsp;</div></li><li><div>          } <span class="comment">// </span>end class&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( ! class_exists( 'WC_Safircod_Sefareshi_Method' ) ) {&nbsp;</div></li><li><div>          class WC_Safircod_Sefareshi_Method extends WC_Safircod_Pishtaz_Method {&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              var $username = &quot;&quot;;&nbsp;</div></li><li><div>              var $password = &quot;&quot;;&nbsp;</div></li><li><div>              var $w_unit = &quot;&quot;;&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              public function __construct() &nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                  $this-&gt;id = 'safircod_sefareshi'; &nbsp;</div></li><li><div>                  $this-&gt;method_title = __( '*** ******' ); &nbsp;</div></li><li><div>                  $this-&gt;method_description = __( '***** **** *** ****** ' ); <span class="comment">// </span>Description shown in admin&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>                  $this-&gt;init();&nbsp;</div></li><li><div>                  $this-&gt;account_data();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>              function init() &nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  <span class="comment">// </span>Load the settings API&nbsp;</div></li><li><div>                  $this-&gt;init_form_fields(); <span class="comment">// </span>This is part of the settings API. Override the method to add your own settings&nbsp;</div></li><li><div>                  $this-&gt;init_settings(); <span class="comment">// </span>This is part of the settings API. Loads settings you previously init.&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>                  $this-&gt;enabled = $this-&gt;get_option( 'enabled' );&nbsp;</div></li><li><div>                  $this-&gt;title = $this-&gt;get_option( 'title' );&nbsp;</div></li><li><div>                  $this-&gt;minimum_fee = $this-&gt;get_option( 'min_amount', 0 );&nbsp;</div></li><li><div>                  $this-&gt;w_unit = strtolower( get_option('woocommerce_weight_unit') );&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>                  <span class="comment">// </span>Save settings in admin if you have any defined&nbsp;</div></li><li><div>                  add_action( 'woocommerce_update_options_shipping_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              function account_data() {&nbsp;</div></li><li><div>                  $ins = new WC_Safircod_Pishtaz_Method();&nbsp;</div></li><li><div>                  $this-&gt;username = $ins-&gt;get_option( 'username', '' );&nbsp;</div></li><li><div>                  $this-&gt;password = $ins-&gt;get_option( 'password', '' );&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              function init_form_fields() &nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $this-&gt;minimum_fee )&nbsp;</div></li><li><div>                    $default_requires = 'min_amount';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                 $this-&gt;form_fields = array(&nbsp;</div></li><li><div>                               'enabled' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( 'Enable/Disable', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                                               'label' =&gt; __( '**** **** *** ******', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'title' =&gt; array(&nbsp;</div></li><li><div>                                                                    'title' =&gt; __( 'Method Title', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'text', &nbsp;</div></li><li><div>                                               'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; __( '*** ******', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                               'min_amount' =&gt; array(&nbsp;</div></li><li><div>                                               'title' =&gt; __( 'Minimum Order Amount', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'type' =&gt; 'number', &nbsp;</div></li><li><div>                                               'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                                                   'step' =&gt; 'any', &nbsp;</div></li><li><div>                                                   'min' =&gt; '0'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                                               'description' =&gt; __( '****** ***** **** **** **** *** *** *** *****.', 'woocommerce' ), &nbsp;</div></li><li><div>                                               'default' =&gt; '0', &nbsp;</div></li><li><div>                                               'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                                               'placeholder' =&gt; '0.00'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              public function admin_options() &nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                 ?&gt;&nbsp;</div></li><li><div>                 &lt;h3&gt;&lt;?php _e( '*** ******' ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>                 &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                 &lt;?php&nbsp;</div></li><li><div>                    <span class="comment">// </span>Generate the HTML For the settings form.&nbsp;</div></li><li><div>                    $this-&gt;generate_settings_html();&nbsp;</div></li><li><div>                 ?&gt;&nbsp;</div></li><li><div>                &lt;/table&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>              public function calculate_shipping( $package ) &nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                         global $woocommerce;&nbsp;</div></li><li><div>                         $customer = $woocommerce-&gt;customer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                         if( empty($package['destination']['city'])) {&nbsp;</div></li><li><div>                             $rate = array(&nbsp;</div></li><li><div>                                 'id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>                                 'label' =&gt; $this-&gt;title, &nbsp;</div></li><li><div>                                 'cost' =&gt; 0&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                             $this-&gt;add_rate( $rate );&nbsp;</div></li><li><div>                         }&nbsp;</div></li><li><div>                        &nbsp;</div></li><li><div>                         $this-&gt;shipping_total = 0;&nbsp;</div></li><li><div>                           $weight = 0;&nbsp;</div></li><li><div>                         $unit = ($this-&gt;w_unit == 'g') ? 1 : 1000;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                         $data = array();&nbsp;</div></li><li><div>                         if (sizeof($woocommerce-&gt;cart-&gt;get_cart()) &gt; 0 && ($customer-&gt;get_shipping_city())) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            foreach ($woocommerce-&gt;cart-&gt;get_cart() as $item_id =&gt; $values) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $_product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($_product-&gt;exists() && $values['quantity'] &gt; 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    if (!$_product-&gt;is_virtual()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $weight += $_product-&gt;get_weight() * $unit * $values['quantity'];&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                               }&nbsp;</div></li><li><div>                            } <span class="comment"><span class="comment">//end foreach</span></span>&nbsp;</div></li><li><div>                            &nbsp;</div></li><li><div>                            $data['weight'] = $weight;&nbsp;</div></li><li><div>                            $data['service_type'] = 0;  <span class="comment">// </span>sefareshi&nbsp;</div></li><li><div>                            if ($weight) {&nbsp;</div></li><li><div>                                $this-&gt;get_shipping_response($data, $package);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                       &nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>               } <span class="comment">// </span>end class&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// </span>end function&nbsp;</div></li><li><div>  add_action( 'woocommerce_shipping_init', 'safircod_shipping_method_init' );&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>  function add_safircod_shipping_method( $methods ) {&nbsp;</div></li><li><div>      $methods[] = 'WC_Safircod_Pishtaz_Method';&nbsp;</div></li><li><div>      $methods[] = 'WC_Safircod_Sefareshi_Method';&nbsp;</div></li><li><div>      return $methods;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  add_filter( 'woocommerce_shipping_methods', 'add_safircod_shipping_method' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WC_SafirCOD_Debug {&nbsp;</div></li><li><div>  var $handle = null;&nbsp;</div></li><li><div>  public function __construct() &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  private function open() &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;handle ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;handle = @fopen( untrailingslashit( plugin_dir_path( __FILE__ ) ).'/log/safir_log.txt', 'a' ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function write($text) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return ;&nbsp;</div></li><li><div>      if ( $this-&gt;open() && is_resource( $this-&gt;handle) ) {&nbsp;</div></li><li><div>          $time = date_i18n( 'm-d-Y @ H:i:s -' ); <span class="comment">//Grab Time</span>&nbsp;</div></li><li><div>          @fwrite( $this-&gt;handle, $time . &quot; &quot; . $text . &quot;\n&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      @fclose($this-&gt;handle);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function sep() &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;write('------------------------------------'.&quot;\n&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}     &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WC_SafirCOD {&nbsp;</div></li><li><div>  var $safir_carrier;&nbsp;</div></li><li><div>  var $debug_file = &quot;&quot;;&nbsp;</div></li><li><div>  var $email_handle;&nbsp;</div></li><li><div>  private $client = null;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>   public function __construct() &nbsp;</div></li><li><div>   {&nbsp;</div></li><li><div>      <span class="comment">//global $woocommerce;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// </span>edit @ 02 14</span>&nbsp;</div></li><li><div>      <span class="comment">//if (version_compare(WOOCOMMERCE_VERSION, '2.1.0', '&gt;='))</span>&nbsp;</div></li><li><div>      <span class="comment">//add_action( 'woocommerce_order_status_processing', array( $this, 'save_order'), 10, 1);</span>&nbsp;</div></li><li><div>      <span class="comment">//add_action( 'woocommerce_order_status_on-hold', array( $this, 'save_order'), 10, 1);</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_checkout_order_processed', array( $this, 'save_order'), 10, 2);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'woocommerce_available_payment_gateways', array( $this, 'get_available_payment_gateways'), 10, 1);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'woocommerce_cart_shipping_method_full_label', array( $this, 'remove_free_text'), 10, 2);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_action( 'woocommerce_admin_css', array( $this, 'add_css_file'));&nbsp;</div></li><li><div>      add_action('admin_enqueue_scripts', array( $this, 'overriade_js_file'), 11);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_action( 'update_safir_orders_state', array( $this, 'update_safir_orders_state'));&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'woocommerce_currencies', array( $this, 'check_currency'), 20 );&nbsp;</div></li><li><div>      add_filter('woocommerce_currency_symbol', array( $this, 'check_currency_symbol'), 20, 2);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter('woocommerce_states', array( $this, 'woocommerce_states'));&nbsp;</div></li><li><div>      add_action( 'woocommerce_thankyou', array( $this, 'show_invoice'), 5 );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter( 'woocommerce_default_address_fields', array( $this, 'remove_country_field'), 10, 1);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">//if(is_object($woocommerce-&gt;cart))</span>&nbsp;</div></li><li><div>      <span class="comment">//if($woocommerce-&gt;cart-&gt;needs_shipping()) {</span>&nbsp;</div></li><li><div>          add_action('woocommerce_before_checkout_form', array( $this, 'calc_shipping_after_login'));&nbsp;</div></li><li><div>          add_action( 'woocommerce_cart_collaterals', array( $this, 'remove_shipping_calculator'));&nbsp;</div></li><li><div>          add_action( 'woocommerce_calculated_shipping', array( $this, 'set_state_and_city_in_cart_page'));&nbsp;</div></li><li><div>          add_action( 'woocommerce_cart_collaterals', array( $this, 'add_new_calculator'), 20);&nbsp;</div></li><li><div>          add_action( 'woocommerce_before_cart', array( $this, 'remove_proceed_btn'));&nbsp;</div></li><li><div>          add_action( 'woocommerce_cart_totals_after_order_total', array( $this, 'add_proceed_btn'));&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          add_filter( 'woocommerce_locate_template', array( $this, 'new_template'), 50, 3); <span class="comment"><span class="comment">// </span>edit @ 02 14</span>&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      <span class="comment">//}             </span>&nbsp;</div></li><li><div>      if(!class_exists('WC_Safircod_Pishtaz_Method') && function_exists('safircod_shipping_method_init') && class_exists('WC_Shipping_Method'))&nbsp;</div></li><li><div>          safircod_shipping_method_init();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function woocommerce_states($st) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }        &nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function show_invoice( $order_id )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $factor = get_post_meta( $order_id, '_safir_tracking_code', true);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if( empty($factor))&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      $html = '&lt;p&gt;';&nbsp;</div></li><li><div>      $html .= '** ****** ***** ***.';&nbsp;</div></li><li><div>      $html .= '&lt;/br&gt;';&nbsp;</div></li><li><div>      $html .= '*** ** ** *** *** ********* * ** ****** ** **** *** ** ***** ***** *** **** ****. ';&nbsp;</div></li><li><div>      $html .= '&lt;/br&gt;'. $factor .'&lt;/p&gt;&lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      echo $html;&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>  public function get_available_payment_gateways( $_available_gateways)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $shipping_method = $woocommerce-&gt;session-&gt;chosen_shipping_method;&nbsp;</div></li><li><div>      if(in_array( $shipping_method, array('safircod_pishtaz' , 'safircod_sefareshi' ))) {   &nbsp;</div></li><li><div>          foreach ( $_available_gateways as $gateway ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>               if ($gateway-&gt;id == 'cod') $new_available_gateways[$gateway-&gt;id] = $gateway;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          endforeach;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $new_available_gateways;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $_available_gateways;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function new_template( $template, $template_name, $template_path)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return $template;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      $shipping_method = $woocommerce-&gt;session-&gt;chosen_shipping_method;&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      @ edit 02 14</span>&nbsp;</div></li><li><div><span class="comment">      if(!in_array( $shipping_method, array('safircod_pishtaz' , 'safircod_sefareshi' )))</span>&nbsp;</div></li><li><div><span class="comment">          return $template;*/</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if( $template_name =='checkout/form-billing.php' OR $template_name =='checkout/form-shipping.php')&nbsp;</div></li><li><div>          return untrailingslashit( plugin_dir_path( __FILE__ ) ). '/'. $template_name;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $template;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function save_order($id, $posted)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;email_handle =  $woocommerce-&gt;mailer();&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>      $order = new WC_Order($id);&nbsp;</div></li><li><div>      if(!is_object($order))&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// </span>edit @ 02 14</span>   &nbsp;</div></li><li><div>      $is_safir = false; &nbsp;</div></li><li><div>      if ( $order-&gt;shipping_method ) {&nbsp;</div></li><li><div>          if( in_array($order-&gt;shipping_method, array('safircod_pishtaz' , 'safircod_sefareshi' )) ) {&nbsp;</div></li><li><div>              $is_safir = true;&nbsp;</div></li><li><div>              $shipping_methods = $order-&gt;shipping_method;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $shipping_s = $order-&gt;get_shipping_methods();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $shipping_s as $shipping ) {&nbsp;</div></li><li><div>              if( in_array($shipping['method_id'], array('safircod_pishtaz' , 'safircod_sefareshi' )) ) {&nbsp;</div></li><li><div>                  $is_safir = true;&nbsp;</div></li><li><div>                  $shipping_methods = $shipping['method_id'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if( !$is_safir || $order-&gt;payment_method != 'cod' )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>         &nbsp;</div></li><li><div>      $this-&gt;safir_carrier = new WC_Safircod_Pishtaz_Method();&nbsp;</div></li><li><div>      $service_type = ($shipping_methods == 'safircod_pishtaz') ? 1 : 0;&nbsp;</div></li><li><div>      if($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>         $this-&gt;debug_file = new WC_SafirCOD_Debug();&nbsp;</div></li><li><div>         $this-&gt;debug_file-&gt;sep();&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $unit = ($this-&gt;safir_carrier-&gt;w_unit == 'g') ? 1 : 1000;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $orders = '';&nbsp;</div></li><li><div>      foreach ( $order-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($item['product_id']&gt;0) {&nbsp;</div></li><li><div>                  $_product = $order-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>                  $productName = str_ireplace('^', '', $_product-&gt;get_title()); <span class="comment"><span class="comment">// </span>edit @ 02 14</span>&nbsp;</div></li><li><div>                  $productName = str_ireplace(';', '', $productName);&nbsp;</div></li><li><div>                  $orders .= $productName.'^';&nbsp;</div></li><li><div>                  $orders .= intval($_product-&gt;weight * $unit).'^';&nbsp;</div></li><li><div>                  $orders .= (int)$item['qty'].'^';&nbsp;</div></li><li><div>                  $price = $order-&gt;get_item_total( $item); &nbsp;</div></li><li><div>                  $orders .= (get_woocommerce_currency() == &quot;IRT&quot;) ? (int)$price*10: (int)$price;&nbsp;</div></li><li><div>                  $orders .= ';';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $customer_city = $order-&gt;shipping_city;&nbsp;</div></li><li><div>          $customer_city = explode('-', $customer_city);&nbsp;</div></li><li><div>          $customer_city = intval($customer_city[0]);&nbsp;</div></li><li><div>          if( $customer_city && $customer_city &gt;0) {&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              if($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>                  $this-&gt;debug_file-&gt;write('@save_order::city is not valid');&nbsp;</div></li><li><div>                  die('city is not valid');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $params = array(&nbsp;</div></li><li><div>       'UserName' =&gt;  $this-&gt;safir_carrier-&gt;username, &nbsp;</div></li><li><div>       'Pass' =&gt;  $this-&gt;safir_carrier-&gt;password, &nbsp;</div></li><li><div>       'COD' =&gt;  0, <span class="comment">// </span>cod&nbsp;</div></li><li><div>       'ServiceType' =&gt;  $service_type, &nbsp;</div></li><li><div>       'ShopperIP' =&gt;  $this-&gt;getIp(), &nbsp;</div></li><li><div>       'ShopperCityID' =&gt;  $customer_city, &nbsp;</div></li><li><div>       'ShopperInfo' =&gt;  $order-&gt;billing_first_name.' '.$order-&gt;billing_last_name, &nbsp;</div></li><li><div>       'ShopperPhone' =&gt;  $order-&gt;billing_phone, &nbsp;</div></li><li><div>       'ShopperAddress' =&gt;  $order-&gt;billing_address_1 . ' - '. $order-&gt;billing_address_2, &nbsp;</div></li><li><div>       'ShopperEmail' =&gt;  $order-&gt;billing_email, &nbsp;</div></li><li><div>       'ShopperPostCode' =&gt;  $order-&gt;billing_postcode, &nbsp;</div></li><li><div>       'ShopperDescription'=&gt; $order-&gt;customer_note, &nbsp;</div></li><li><div>       'ProductList' =&gt;  trim($orders, ';')&nbsp;</div></li><li><div> ); &nbsp;</div></li><li><div>       &nbsp;</div></li><li><div>       list($res, $response) = $this-&gt;add_order( $params, $order );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>       if ($res === false) {&nbsp;</div></li><li><div>                  if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>                          ob_start();&nbsp;</div></li><li><div>                          var_dump($params);&nbsp;</div></li><li><div>                          $text = ob_get_contents();&nbsp;</div></li><li><div>                          ob_end_clean();&nbsp;</div></li><li><div>                          $this-&gt;debug_file-&gt;write('@save_order::error in registering by webservice:'.$response.'::'.$text);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $order-&gt;update_status( 'pending', 'Safir : '.$response );&nbsp;</div></li><li><div>                  $this-&gt;trigger($order-&gt;id, $order, '::***** ** ***** **** *** ***::');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       } elseif($res === true) {&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>                          $this-&gt;debug_file-&gt;write('@save_order::everything is Ok');&nbsp;</div></li><li><div>                          wc_clear_notices();&nbsp;</div></li><li><div>                          wc_add_notice('&lt;p&gt;Safir:&lt;/p&gt; &lt;p&gt;Everthing is Ok!&lt;/p&gt;');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;trigger($order-&gt;id, $order, true);&nbsp;</div></li><li><div>          update_post_meta($id, '_safir_tracking_code', $response-&gt;RegisterNewOrderResult);&nbsp;</div></li><li><div> &nbsp;</div></li><li><div>       } else {&nbsp;</div></li><li><div>          $order-&gt;update_status( 'pending', 'Safir : error in webservice, Order not register!' );&nbsp;</div></li><li><div>          $this-&gt;trigger($order-&gt;id, $order, false);    &nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function add_order( $data, $order )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>          $this-&gt;debug_file-&gt;write('@add_order::here is top of function');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client = new nusoap_client( $this-&gt;safir_carrier-&gt;wsdl_url, true );&nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client-&gt;soap_defencoding = 'UTF-8';&nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client-&gt;decode_utf8 = true;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      $response = $this-&gt;safir_carrier-&gt;call(&quot;RegisterNewOrder&quot;, $data);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      if(is_array($response) && $response['error']) {&nbsp;</div></li><li><div>          if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>                          $this-&gt;debug_file-&gt;write('@safir_service::'.$response['message']);&nbsp;</div></li><li><div>                          wc_clear_notices();&nbsp;</div></li><li><div>                          wc_add_notice('&lt;p&gt;Safir Error:&lt;/p&gt; &lt;p&gt;'.$response['message'].'&lt;/p&gt;');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              mkobject($response);&nbsp;</div></li><li><div>              return array(false, $this-&gt;safir_carrier-&gt;handleError($response-&gt;RegisterNewOrderResult, 'register'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      mkobject($response);&nbsp;</div></li><li><div>      if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>              ob_start();&nbsp;</div></li><li><div>              var_dump($response);&nbsp;</div></li><li><div>              $text = ob_get_contents();&nbsp;</div></li><li><div>              ob_end_clean();&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>             $this-&gt;debug_file-&gt;write('@add_order::everything is Ok: '.$text);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return array(true, $response);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  function trigger( $order_id, $order, $subject= false ) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      if(!$subject) {&nbsp;</div></li><li><div>          $message = $this-&gt;email_handle-&gt;wrap_message(&nbsp;</div></li><li><div>                          '***** ** ***** **** *** ***', &nbsp;</div></li><li><div>                          sprintf( '*****  %s ** ***** **** *** **** **** ***** **** ***** ** *** ***** ** *** **** **** ******.', $order-&gt;get_order_number() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;email_handle-&gt;send( get_option( 'admin_email' ), sprintf('*****  %s ** ***** **** *** ***', $order-&gt;get_order_number() ), $message );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $message = $this-&gt;email_handle-&gt;wrap_message(&nbsp;</div></li><li><div>                          '***** ** ****** ** ***** **** *** *****', &nbsp;</div></li><li><div>                          sprintf( '*****  %s ** ****** ** ***** **** *** *****.', $order-&gt;get_order_number() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;email_handle-&gt;send( get_option( 'admin_email' ), sprintf( '***** %s ** ***** **** ** ****** *** *****', $order-&gt;get_order_number() ), $message );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function calc_shipping_after_login( $checkout ) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      $state = $woocommerce-&gt;customer-&gt;get_shipping_state() ;&nbsp;</div></li><li><div>      $city = $woocommerce-&gt;customer-&gt;get_shipping_city() ;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if( $state && $city ) {&nbsp;</div></li><li><div>          $woocommerce-&gt;customer-&gt;calculated_shipping( true );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wc_add_notice( '*** ** **** **** ****** * ***** **** *** ***** * *** *** ** **** ****.');&nbsp;</div></li><li><div>          $cart_page_id = get_option('woocommerce_cart_page_id' );<span class="comment">//wc_get_page_id( 'cart' );</span>&nbsp;</div></li><li><div>          wp_redirect( get_permalink( $cart_page_id ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function getIp()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!empty($_SERVER['HTTP_CLIENT_IP']))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>           $ip = $_SERVER['HTTP_CLIENT_IP'];&nbsp;</div></li><li><div>      } &nbsp;</div></li><li><div>      elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];&nbsp;</div></li><li><div>      } &nbsp;</div></li><li><div>      else &nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $ip = $_SERVER['REMOTE_ADDR'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $ip;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function remove_shipping_calculator()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      if( get_option('woocommerce_enable_shipping_calc')!='no' )&nbsp;</div></li><li><div>          update_option('woocommerce_enable_shipping_calc', 'no');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function remove_free_text( $full_label, $method)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $shipping_city = $woocommerce-&gt;customer-&gt;city;&nbsp;</div></li><li><div>      if(!in_array( $method-&gt;id, array('safircod_pishtaz' , 'safircod_sefareshi' )))&nbsp;</div></li><li><div>          return $full_label;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($shipping_city))&nbsp;</div></li><li><div>          return $method-&gt;label;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $full_label;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function remove_country_field( $fields )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset( $fields['country'] );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function add_css_file()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $typenow;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ( $typenow == '' || $typenow == &quot;product&quot; || $typenow == &quot;service&quot; || $typenow == &quot;agent&quot; ) {&nbsp;</div></li><li><div>           wp_enqueue_style( 'woocommerce_admin_override', untrailingslashit( plugins_url( '/', __FILE__ ) ) . '/css/override.css', array('woocommerce_admin_styles') );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function overriade_js_file()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      wp_deregister_script( 'jquery-tiptip' );&nbsp;</div></li><li><div>      wp_register_script( 'jquery-tiptip', untrailingslashit( plugins_url( '/', __FILE__ ) ) . '/js/jquery.tipTip.min.js', array( 'jquery' ), $woocommerce-&gt;version, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function set_state_and_city_in_cart_page()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// </span>edit @ 02 14</span>&nbsp;</div></li><li><div>      $state = (woocommerce_clean( $_POST['calc_shipping_state'] )) ? woocommerce_clean( $_POST['calc_shipping_state'] ) : $woocommerce-&gt;customer-&gt;get_shipping_state() ;&nbsp;</div></li><li><div>      $city = (woocommerce_clean( $_POST['calc_shipping_city'] )) ? woocommerce_clean( $_POST['calc_shipping_city'] ) : $woocommerce-&gt;customer-&gt;get_shipping_city() ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $city && $state) {&nbsp;</div></li><li><div>              $woocommerce-&gt;customer-&gt;set_location( 'IR', $state, '', $city );&nbsp;</div></li><li><div>              $woocommerce-&gt;customer-&gt;set_shipping_location( 'IR', $state, '', $city );&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              wc_clear_notices();&nbsp;</div></li><li><div>              $woocommerce-&gt;add_error('***** * *** ** ****** ****. ****** ** ** **** ****** ***.');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function add_new_calculator()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      $have_city = true;&nbsp;</div></li><li><div>      if( ! $woocommerce-&gt;customer-&gt;get_shipping_city()) {&nbsp;</div></li><li><div>          echo '&lt;style&gt; div.cart_totals{display:none!important;}&nbsp;</div></li><li><div>                        p.selectcitynotice {display:block;}&nbsp;</div></li><li><div>                  &lt;/style&gt;';&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $have_city = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>      include('cart/shipping-calculator.php');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function remove_proceed_btn()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      echo '&lt;style&gt;input.checkout-button{ display:none!important;}&nbsp;</div></li><li><div>                  .woocommerce .cart-collaterals .cart_totals table, .woocommerce-page .cart-collaterals .cart_totals table { border:0px; }&nbsp;</div></li><li><div>            &lt;/style&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function add_proceed_btn()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if(!$woocommerce-&gt;cart-&gt;needs_shipping())&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>             &nbsp;</div></li><li><div>      echo '&lt;tr style=&quot;border:0px;&quot;&gt;&lt;td colspan=&quot;2&quot; style=&quot;padding:15px 0px;border:0px;&quot;&gt;&nbsp;</div></li><li><div>            &lt;input onclick=&quot;submitchform();&quot; type=&quot;submit&quot; style=&quot;padding:10px 15px;&quot; class=&quot;button alt&quot; id=&quot;temp_proceed&quot; name=&quot;temp_proceed&quot; value=&quot; &rarr; ***** **** * **** **** **** * ******&quot; /&gt;&nbsp;</div></li><li><div>            &lt;/td&gt;&lt;/tr&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function update_safir_orders_state()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_results($wpdab-&gt;prepare(&quot;        SELECT meta.meta_value, posts.ID FROM {$wpdb-&gt;posts} AS posts&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      LEFT JOIN {$wpdb-&gt;postmeta} AS meta ON posts.ID = meta.post_id&nbsp;</div></li><li><div>      LEFT JOIN {$wpdb-&gt;term_relationships} AS rel ON posts.ID=rel.object_ID&nbsp;</div></li><li><div>      LEFT JOIN {$wpdb-&gt;term_taxonomy} AS tax USING( term_taxonomy_id )&nbsp;</div></li><li><div>      LEFT JOIN {$wpdb-&gt;terms} AS term USING( term_id )&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      WHERE     meta.meta_key = '_safir_tracking_code'&nbsp;</div></li><li><div>      AND     meta.meta_value     != ''&nbsp;</div></li><li><div>      AND     posts.post_type = 'shop_order'&nbsp;</div></li><li><div>      AND     posts.post_status = 'publish'&nbsp;</div></li><li><div>      AND     tax.taxonomy = 'shop_order_status'&nbsp;</div></li><li><div>      AND        term.slug            IN ('processing', 'on-hold', 'pending')&nbsp;</div></li><li><div>     &quot;));&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>     if ( $results ) {&nbsp;</div></li><li><div>          $tracks = array();&nbsp;</div></li><li><div>          foreach( $results as $result ) {&nbsp;</div></li><li><div>             $tracks['code'][] = $result-&gt;meta_value;&nbsp;</div></li><li><div>             $tracks['id'][] = $result-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>     }&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>     if( empty($tracks))&nbsp;</div></li><li><div>          return ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_object($this-&gt;safir_carrier))&nbsp;</div></li><li><div>          $this-&gt;safir_carrier = new WC_Safircod_Pishtaz_Method();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client = new nusoap_client( $this-&gt;safir_carrier-&gt;wsdl_url, true );&nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client-&gt;soap_defencoding = 'UTF-8';&nbsp;</div></li><li><div>      $this-&gt;safir_carrier-&gt;client-&gt;decode_utf8 = true;&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      for($i = 0; $i &lt; 5; $i++)&nbsp;</div></li><li><div>      {  &nbsp;</div></li><li><div>          $data = array(&nbsp;</div></li><li><div>              'UserName' =&gt;  $this-&gt;safir_carrier-&gt;username, &nbsp;</div></li><li><div>              'Pass' =&gt;  $this-&gt;safir_carrier-&gt;password, &nbsp;</div></li><li><div>              'OrderNumber' =&gt;  $tracks['code'][$i]); &nbsp;</div></li><li><div>          $response = $this-&gt;safir_carrier-&gt;call(&quot;GetOrderState&quot;, $data);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if(is_array($response) && $response['error']) {&nbsp;</div></li><li><div>              if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>                          $this-&gt;debug_file-&gt;write('@update_safir_orders_state::'.$response['message']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          mkobject($response);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ($this-&gt;safir_carrier-&gt;debug) {&nbsp;</div></li><li><div>              ob_start();&nbsp;</div></li><li><div>              var_dump($response);&nbsp;</div></li><li><div>              $text = ob_get_contents();&nbsp;</div></li><li><div>              ob_end_clean();&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>             $this-&gt;debug_file-&gt;write('@update_safir_orders_state::everything is Ok: '.$text);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $res = explode(';', $response-&gt;GetOrderStateResult);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $status = false;&nbsp;</div></li><li><div>          switch($res[1]) {&nbsp;</div></li><li><div>              /**case '0': <span class="comment">// </span>***** ****&nbsp;</div></li><li><div>                     $status = 'pending';&nbsp;</div></li><li><div>                     break; */&nbsp;</div></li><li><div>              case '1': <span class="comment">// </span>***** ** *****&nbsp;</div></li><li><div>              case '2': <span class="comment">// </span>***** ***&nbsp;</div></li><li><div>              case '3':  <span class="comment">//***** ***</span>&nbsp;</div></li><li><div>                     <span class="comment">/**$status = 'processing';</span>&nbsp;</div></li><li><div><span class="comment">                     break; */</span>&nbsp;</div></li><li><div>              case '4': <span class="comment">// </span>**** ***&nbsp;</div></li><li><div>                     $status = 'completed';&nbsp;</div></li><li><div>                     break; &nbsp;</div></li><li><div>              case '5': <span class="comment">// </span>****** *****&nbsp;</div></li><li><div>              case '6': <span class="comment">//****** *****</span>&nbsp;</div></li><li><div>                     $status = 'refunded';&nbsp;</div></li><li><div>                     break; &nbsp;</div></li><li><div>              case '7': <span class="comment">// </span>*******&nbsp;</div></li><li><div>                     $status = 'cancelled';&nbsp;</div></li><li><div>                     break; &nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $status )&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $order = new WC_Order( $tracks['id'][$i] );&nbsp;</div></li><li><div>              $order-&gt;update_status( $status, '***** **** @ '.$res[0] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>       }<span class="comment">// </span>end for   &nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">// </span>thanks to  woocommerce parsi&nbsp;</div></li><li><div>  public function check_currency( $currencies ) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(empty($currencies['IRR'])) &nbsp;</div></li><li><div>          $currencies['IRR'] = __( '****', 'woocommerce' );&nbsp;</div></li><li><div>      if(empty($currencies['IRT'])) &nbsp;</div></li><li><div>          $currencies['IRT'] = __( '*****', 'woocommerce' );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $currencies;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function check_currency_symbol( $currency_symbol, $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch( $currency ) {&nbsp;</div></li><li><div>          case 'IRR': $currency_symbol = '****'; break;&nbsp;</div></li><li><div>          case 'IRT': $currency_symbol = '*****'; break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      return $currency_symbol;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>   &nbsp;</div></li><li><div>  $GLOBALS['SafirCOD'] = new WC_SafirCOD();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function mkobject(&$data) &nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $numeric = false;&nbsp;</div></li><li><div>      foreach ($data as $p =&gt; &$d) {&nbsp;</div></li><li><div>          if (is_array($d))&nbsp;</div></li><li><div>              mkobject($d);&nbsp;</div></li><li><div>          if (is_int($p))&nbsp;</div></li><li><div>              $numeric = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$numeric)&nbsp;</div></li><li><div>          settype($data, 'object');&nbsp;</div></li><li><div>  } &nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce SafirCOD</li><li><span></span>1.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>