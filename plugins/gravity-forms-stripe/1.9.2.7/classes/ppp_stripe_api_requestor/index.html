<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.9.2.7" data-slug="gravity-forms-stripe" data-type="class" data-id="72707"><head xmlns="http://www.w3.org/1999/xhtml"><title> pppstripeapirequestor | class | Gravity Forms Stripe | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="PPP\Stripe\ApiRequestor, class, plugin, gravity-forms-stripe, 1.9.2.7" /><meta name="description" content="Class ApiRequestor" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=a571b098ce89214fcac86438c5b73e04' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ppp_stripe_api_requestor/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fppp_stripe_api_requestor%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fppp_stripe_api_requestor%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-forms-stripe-1.9.2.7-class-ppp_stripe_api_requestor","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ppp_stripe_api_requestor" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms-stripe." href="http://hookr.io/plugins/gravity-forms-stripe/" class="plugin"><span property="name">gravity-forms-stripe</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.2.7." href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/" class="H_VERSION"><span property="name">1.9.2.7</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ppp_stripe_api_requestor</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="107"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/all/" title="All">All <span class="count badge">107</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="52"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/hooks/" title="Hooks">Hooks <span class="count badge">52</span></a></li><li class="" data-id="action" data-count="18"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/actions/" title="Actions">Actions <span class="count badge">18</span></a></li><li class="" data-id="filter" data-count="34"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/filters/" title="Filters">Filters <span class="count badge">34</span></a></li><li class="active" data-id="class" data-count="44"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/classes/" title="Classes">Classes <span class="count badge">44</span></a></li><li class="" data-id="constant" data-count="5"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/constants/" title="Constants">Constants <span class="count badge">5</span></a></li><li class="" data-id="function" data-count="6"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/functions/" title="Functions">Functions <span class="count badge">6</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>PPPStripeApiRequestor</strong></h1><p>Class ApiRequestor.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/files/includes-api-stripe-php-lib-apirequestor/" class="file">/includes/api/stripe-php/lib/ApiRequestor.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="5" class="block" start="5"><li><div>class ApiRequestor&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>    private $_apiKey;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $_apiBase;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static $_preFlight = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static $_blacklistedCerts = array(&nbsp;</div></li><li><div>        '05c0b3643694470a888c6e7feb5c9e24e823dc53', &nbsp;</div></li><li><div>        '5b7dc7fbc98d78bf76d4d4fa6f597a0c901fad5c', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function __construct($apiKey = null, $apiBase = null)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_apiKey = $apiKey;&nbsp;</div></li><li><div>        if (!$apiBase) {&nbsp;</div></li><li><div>            $apiBase = Stripe::$apiBase;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;_apiBase = $apiBase;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string|mixed $value A string to UTF8-encode.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string|mixed The UTF8-encoded string, or the object passed in if&nbsp;</div></li><li><div>     *    it wasn't a string.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function utf8($value)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (is_string($value) && mb_detect_encoding($value, &quot;UTF-8&quot;, true) != &quot;UTF-8&quot;) {&nbsp;</div></li><li><div>            return utf8_encode($value);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function _encodeObjects($d)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if ($d instanceof ApiResource) {&nbsp;</div></li><li><div>            return self::utf8($d-&gt;id);&nbsp;</div></li><li><div>        } elseif ($d === true) {&nbsp;</div></li><li><div>            return 'true';&nbsp;</div></li><li><div>        } elseif ($d === false) {&nbsp;</div></li><li><div>            return 'false';&nbsp;</div></li><li><div>        } elseif (is_array($d)) {&nbsp;</div></li><li><div>            $res = array();&nbsp;</div></li><li><div>            foreach ($d as $k =&gt; $v) {&nbsp;</div></li><li><div>                $res[$k] = self::_encodeObjects($v);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $res;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return self::utf8($d);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param array $arr An map of param keys to values.&nbsp;</div></li><li><div>     * @param string|null $prefix (It doesn't look like we ever use $prefix...)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string A querystring, essentially.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function encode($arr, $prefix = null)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!is_array($arr)) {&nbsp;</div></li><li><div>            return $arr;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = array();&nbsp;</div></li><li><div>        foreach ($arr as $k =&gt; $v) {&nbsp;</div></li><li><div>            if (is_null($v)) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($prefix && $k && !is_int($k)) {&nbsp;</div></li><li><div>                $k = $prefix.&quot;[&quot;.$k.&quot;]&quot;;&nbsp;</div></li><li><div>            } elseif ($prefix) {&nbsp;</div></li><li><div>                $k = $prefix.&quot;[]&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (is_array($v)) {&nbsp;</div></li><li><div>                $r[] = self::encode($v, $k, true);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $r[] = urlencode($k).&quot;=&quot;.urlencode($v);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return implode(&quot;&&quot;, $r);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $method&nbsp;</div></li><li><div>     * @param string $url&nbsp;</div></li><li><div>     * @param array|null $params&nbsp;</div></li><li><div>     * @param array|null $headers&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array An array whose first element is the response and second&nbsp;</div></li><li><div>     *    element is the API key used to make the request.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function request($method, $url, $params = null, $headers = null)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!$params) {&nbsp;</div></li><li><div>            $params = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (!$headers) {&nbsp;</div></li><li><div>            $headers = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        list($rbody, $rcode, $myApiKey) =&nbsp;</div></li><li><div>        $this-&gt;_requestRaw($method, $url, $params, $headers);&nbsp;</div></li><li><div>        $resp = $this-&gt;_interpretResponse($rbody, $rcode);&nbsp;</div></li><li><div>        return array($resp, $myApiKey);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $rbody A JSON string.&nbsp;</div></li><li><div>     * @param int $rcode&nbsp;</div></li><li><div>     * @param array $resp&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Error\InvalidRequest if the error is caused by the user.&nbsp;</div></li><li><div>     * @throws Error\Authentication if the error is caused by a lack of&nbsp;</div></li><li><div>     *    permissions.&nbsp;</div></li><li><div>     * @throws Error\Card if the error is the error code is 402 (payment&nbsp;</div></li><li><div>     *    required)&nbsp;</div></li><li><div>     * @throws Error\Api otherwise.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function handleApiError($rbody, $rcode, $resp)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!is_array($resp) || !isset($resp['error'])) {&nbsp;</div></li><li><div>            $msg = &quot;Invalid response object from API: $rbody &quot;&nbsp;</div></li><li><div>              . &quot;(HTTP response code was $rcode)&quot;;&nbsp;</div></li><li><div>            throw new Error\Api($msg, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error = $resp['error'];&nbsp;</div></li><li><div>        $msg = isset($error['message']) ? $error['message'] : null;&nbsp;</div></li><li><div>        $param = isset($error['param']) ? $error['param'] : null;&nbsp;</div></li><li><div>        $code = isset($error['code']) ? $error['code'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($rcode) {&nbsp;</div></li><li><div>            case 400:&nbsp;</div></li><li><div>                if ($code == 'rate_limit') {&nbsp;</div></li><li><div>                    throw new Error\RateLimit($msg, $param, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // intentional fall-through&nbsp;</div></li><li><div>            case 404:&nbsp;</div></li><li><div>                throw new Error\InvalidRequest($msg, $param, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>            case 401:&nbsp;</div></li><li><div>                throw new Error\Authentication($msg, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>            case 402:&nbsp;</div></li><li><div>                throw new Error\Card($msg, $param, $code, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                throw new Error\Api($msg, $rcode, $rbody, $resp);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _requestRaw($method, $url, $params, $headers)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!array_key_exists($this-&gt;_apiBase, self::$_preFlight) ||&nbsp;</div></li><li><div>            !self::$_preFlight[$this-&gt;_apiBase]) {&nbsp;</div></li><li><div>            self::$_preFlight[$this-&gt;_apiBase] = $this-&gt;checkSslCert($this-&gt;_apiBase);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $myApiKey = $this-&gt;_apiKey;&nbsp;</div></li><li><div>        if (!$myApiKey) {&nbsp;</div></li><li><div>            $myApiKey = Stripe::$apiKey;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$myApiKey) {&nbsp;</div></li><li><div>            $msg = 'No API key provided.  (HINT: set your API key using '&nbsp;</div></li><li><div>              . '&quot;Stripe::setApiKey(&lt;API-KEY&gt;)&quot;.  You can generate API keys from '&nbsp;</div></li><li><div>              . 'the Stripe web interface.  See https://stripe.com/api for '&nbsp;</div></li><li><div>              . 'details, or email support@stripe.com if you have any questions.';&nbsp;</div></li><li><div>            throw new Error\Authentication($msg);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $absUrl = $this-&gt;_apiBase.$url;&nbsp;</div></li><li><div>        $params = self::_encodeObjects($params);&nbsp;</div></li><li><div>        $langVersion = phpversion();&nbsp;</div></li><li><div>        $uname = php_uname();&nbsp;</div></li><li><div>        $ua = array(&nbsp;</div></li><li><div>            'bindings_version' =&gt; Stripe::VERSION, &nbsp;</div></li><li><div>            'lang' =&gt; 'php', &nbsp;</div></li><li><div>            'lang_version' =&gt; $langVersion, &nbsp;</div></li><li><div>            'publisher' =&gt; 'stripe', &nbsp;</div></li><li><div>            'uname' =&gt; $uname, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $defaultHeaders = array(&nbsp;</div></li><li><div>            'X-Stripe-Client-User-Agent' =&gt; json_encode($ua), &nbsp;</div></li><li><div>            'User-Agent' =&gt; 'Stripe/v1 PhpBindings/' . Stripe::VERSION, &nbsp;</div></li><li><div>            'Authorization' =&gt; 'Bearer ' . $myApiKey, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        if (Stripe::$apiVersion) {&nbsp;</div></li><li><div>            $defaultHeaders['Stripe-Version'] = Stripe::$apiVersion;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $hasFile = false;&nbsp;</div></li><li><div>        $hasCurlFile = class_exists('\CURLFile', false);&nbsp;</div></li><li><div>        foreach ($params as $k =&gt; $v) {&nbsp;</div></li><li><div>            if (is_resource($v)) {&nbsp;</div></li><li><div>                $hasFile = true;&nbsp;</div></li><li><div>                $params[$k] = self::_processResourceParam($v, $hasCurlFile);&nbsp;</div></li><li><div>            } elseif ($hasCurlFile && $v instanceof \CURLFile) {&nbsp;</div></li><li><div>                $hasFile = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($hasFile) {&nbsp;</div></li><li><div>            $defaultHeaders['Content-Type'] = 'multipart/form-data';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $defaultHeaders['Content-Type'] = 'application/x-www-form-urlencoded';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $combinedHeaders = array_merge($defaultHeaders, $headers);&nbsp;</div></li><li><div>        $rawHeaders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($combinedHeaders as $header =&gt; $value) {&nbsp;</div></li><li><div>            $rawHeaders[] = $header . ': ' . $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list($rbody, $rcode) = $this-&gt;_curlRequest(&nbsp;</div></li><li><div>            $method, &nbsp;</div></li><li><div>            $absUrl, &nbsp;</div></li><li><div>            $rawHeaders, &nbsp;</div></li><li><div>            $params, &nbsp;</div></li><li><div>            $hasFile&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        return array($rbody, $rcode, $myApiKey);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _processResourceParam($resource, $hasCurlFile)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (get_resource_type($resource) !== 'stream') {&nbsp;</div></li><li><div>            throw new Error\Api(&nbsp;</div></li><li><div>                'Attempted to upload a resource that is not a stream'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $metaData = stream_get_meta_data($resource);&nbsp;</div></li><li><div>        if ($metaData['wrapper_type'] !== 'plainfile') {&nbsp;</div></li><li><div>            throw new Error\Api(&nbsp;</div></li><li><div>                'Only plainfile resource streams are supported'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($hasCurlFile) {&nbsp;</div></li><li><div>            // We don't have the filename or mimetype, but the API doesn't care&nbsp;</div></li><li><div>            return new \CURLFile($metaData['uri']);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return '@'.$metaData['uri'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _interpretResponse($rbody, $rcode)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $resp = json_decode($rbody, true);&nbsp;</div></li><li><div>        } catch (Exception $e) {&nbsp;</div></li><li><div>            $msg = &quot;Invalid response body from API: $rbody &quot;&nbsp;</div></li><li><div>              . &quot;(HTTP response code was $rcode)&quot;;&nbsp;</div></li><li><div>            throw new Error\Api($msg, $rcode, $rbody);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($rcode &lt; 200 || $rcode &gt;= 300) {&nbsp;</div></li><li><div>            $this-&gt;handleApiError($rbody, $rcode, $resp);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $resp;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _curlRequest($method, $absUrl, $headers, $params, $hasFile)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $curl = curl_init();&nbsp;</div></li><li><div>        $method = strtolower($method);&nbsp;</div></li><li><div>        $opts = array();&nbsp;</div></li><li><div>        if ($method == 'get') {&nbsp;</div></li><li><div>            if ($hasFile) {&nbsp;</div></li><li><div>                throw new Error\Api(&nbsp;</div></li><li><div>                    &quot;Issuing a GET request with a file parameter&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $opts[CURLOPT_HTTPGET] = 1;&nbsp;</div></li><li><div>            if (count($params) &gt; 0) {&nbsp;</div></li><li><div>                $encoded = self::encode($params);&nbsp;</div></li><li><div>                $absUrl = &quot;$absUrl?$encoded&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ($method == 'post') {&nbsp;</div></li><li><div>            $opts[CURLOPT_POST] = 1;&nbsp;</div></li><li><div>            $opts[CURLOPT_POSTFIELDS] = $hasFile ? $params : self::encode($params);&nbsp;</div></li><li><div>        } elseif ($method == 'delete') {&nbsp;</div></li><li><div>            $opts[CURLOPT_CUSTOMREQUEST] = 'DELETE';&nbsp;</div></li><li><div>            if (count($params) &gt; 0) {&nbsp;</div></li><li><div>                $encoded = self::encode($params);&nbsp;</div></li><li><div>                $absUrl = &quot;$absUrl?$encoded&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            throw new Error\Api(&quot;Unrecognized method $method&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $absUrl = self::utf8($absUrl);&nbsp;</div></li><li><div>        $opts[CURLOPT_URL] = $absUrl;&nbsp;</div></li><li><div>        $opts[CURLOPT_RETURNTRANSFER] = true;&nbsp;</div></li><li><div>        $opts[CURLOPT_CONNECTTIMEOUT] = 30;&nbsp;</div></li><li><div>        $opts[CURLOPT_TIMEOUT] = 80;&nbsp;</div></li><li><div>        $opts[CURLOPT_RETURNTRANSFER] = true;&nbsp;</div></li><li><div>        $opts[CURLOPT_HTTPHEADER] = $headers;&nbsp;</div></li><li><div>        if (!Stripe::$verifySslCerts) {&nbsp;</div></li><li><div>            $opts[CURLOPT_SSL_VERIFYPEER] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        curl_setopt_array($curl, $opts);&nbsp;</div></li><li><div>        $rbody = curl_exec($curl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!defined('CURLE_SSL_CACERT_BADFILE')) {&nbsp;</div></li><li><div>            define('CURLE_SSL_CACERT_BADFILE', 77);  // constant not defined in PHP&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errno = curl_errno($curl);&nbsp;</div></li><li><div>        if ($errno == CURLE_SSL_CACERT ||&nbsp;</div></li><li><div>            $errno == CURLE_SSL_PEER_CERTIFICATE ||&nbsp;</div></li><li><div>            $errno == CURLE_SSL_CACERT_BADFILE&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            array_push(&nbsp;</div></li><li><div>                $headers, &nbsp;</div></li><li><div>                'X-Stripe-Client-Info: {&quot;ca&quot;:&quot;using Stripe-supplied CA bundle&quot;}'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $cert = $this-&gt;caBundle();&nbsp;</div></li><li><div>            curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);&nbsp;</div></li><li><div>            curl_setopt($curl, CURLOPT_CAINFO, $cert);&nbsp;</div></li><li><div>            $rbody = curl_exec($curl);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($rbody === false) {&nbsp;</div></li><li><div>            $errno = curl_errno($curl);&nbsp;</div></li><li><div>            $message = curl_error($curl);&nbsp;</div></li><li><div>            curl_close($curl);&nbsp;</div></li><li><div>            $this-&gt;handleCurlError($errno, $message);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $rcode = curl_getinfo($curl, CURLINFO_HTTP_CODE);&nbsp;</div></li><li><div>        curl_close($curl);&nbsp;</div></li><li><div>        return array($rbody, $rcode);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param number $errno&nbsp;</div></li><li><div>     * @param string $message&nbsp;</div></li><li><div>     * @throws ApiConnectionError&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function handleCurlError($errno, $message)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $apiBase = $this-&gt;_apiBase;&nbsp;</div></li><li><div>        switch ($errno) {&nbsp;</div></li><li><div>            case CURLE_COULDNT_CONNECT:&nbsp;</div></li><li><div>            case CURLE_COULDNT_RESOLVE_HOST:&nbsp;</div></li><li><div>            case CURLE_OPERATION_TIMEOUTED:&nbsp;</div></li><li><div>                $msg = &quot;Could not connect to Stripe ($apiBase).  Please check your &quot;&nbsp;</div></li><li><div>                 . &quot;internet connection and try again.  If this problem persists, &quot;&nbsp;</div></li><li><div>                 . &quot;you should check Stripe's service status at &quot;&nbsp;</div></li><li><div>                 . &quot;https://twitter.com/stripestatus, or&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case CURLE_SSL_CACERT:&nbsp;</div></li><li><div>            case CURLE_SSL_PEER_CERTIFICATE:&nbsp;</div></li><li><div>                $msg = &quot;Could not verify Stripe's SSL certificate.  Please make sure &quot;&nbsp;</div></li><li><div>                 . &quot;that your network is not intercepting certificates.  &quot;&nbsp;</div></li><li><div>                 . &quot;(Try going to $apiBase in your browser.)  &quot;&nbsp;</div></li><li><div>                 . &quot;If this problem persists, &quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                $msg = &quot;Unexpected error communicating with Stripe.  &quot;&nbsp;</div></li><li><div>                 . &quot;If this problem persists, &quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $msg .= &quot; let us know at support@stripe.com.&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $msg .= &quot;\n\n(Network error [errno $errno]: $message)&quot;;&nbsp;</div></li><li><div>        throw new Error\ApiConnection($msg);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Preflight the SSL certificate presented by the backend. This isn't 100%&nbsp;</div></li><li><div>     * bulletproof, in that we're not actually validating the transport used to&nbsp;</div></li><li><div>     * communicate with Stripe, merely that the first attempt to does not use a&nbsp;</div></li><li><div>     * revoked certificate.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Unfortunately the interface to OpenSSL doesn't make it easy to check the&nbsp;</div></li><li><div>     * certificate before sending potentially sensitive data on the wire. This&nbsp;</div></li><li><div>     * approach raises the bar for an attacker significantly.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function checkSslCert($url)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!function_exists('stream_context_get_params') ||&nbsp;</div></li><li><div>            !function_exists('stream_socket_enable_crypto')) {&nbsp;</div></li><li><div>            error_log(&nbsp;</div></li><li><div>                'Warning: This version of PHP does not support checking SSL ' .&nbsp;</div></li><li><div>                'certificates Stripe cannot guarantee that the server has a ' .&nbsp;</div></li><li><div>                'certificate which is not blacklisted.'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $url = parse_url($url);&nbsp;</div></li><li><div>        $port = isset($url[&quot;port&quot;]) ? $url[&quot;port&quot;] : 443;&nbsp;</div></li><li><div>        $url = &quot;ssl://{$url[&quot;host&quot;]}:{$port}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sslContext = stream_context_create(&nbsp;</div></li><li><div>            array('ssl' =&gt; array(&nbsp;</div></li><li><div>                'capture_peer_cert' =&gt; true, &nbsp;</div></li><li><div>                'verify_peer' =&gt; true, &nbsp;</div></li><li><div>                'cafile' =&gt; $this-&gt;caBundle(), &nbsp;</div></li><li><div> ))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $result = stream_socket_client(&nbsp;</div></li><li><div>            $url, &nbsp;</div></li><li><div>            $errno, &nbsp;</div></li><li><div>            $errstr, &nbsp;</div></li><li><div>            30, &nbsp;</div></li><li><div>            STREAM_CLIENT_CONNECT, &nbsp;</div></li><li><div>            $sslContext&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        if (($errno !== 0 && $errno !== null) || $result === false) {&nbsp;</div></li><li><div>            throw new Error\ApiConnection(&nbsp;</div></li><li><div>                'Could not connect to Stripe (' . $url . ').  Please check your ' .&nbsp;</div></li><li><div>                'internet connection and try again.  If this problem persists, ' .&nbsp;</div></li><li><div>                'you should check Stripe\'s service status at ' .&nbsp;</div></li><li><div>                'https://twitter.com/stripestatus. Reason was: ' . $errstr&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $params = stream_context_get_params($result);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cert = $params['options']['ssl']['peer_certificate'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        openssl_x509_export($cert, $pemCert);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (self::isBlackListed($pemCert)) {&nbsp;</div></li><li><div>            throw new Error\ApiConnection(&nbsp;</div></li><li><div>                'Invalid server certificate. You tried to connect to a server that ' .&nbsp;</div></li><li><div>                'has a revoked SSL certificate, which means we cannot securely send ' .&nbsp;</div></li><li><div>                'data to that server.  Please email support@stripe.com if you need ' .&nbsp;</div></li><li><div>                'help connecting to the correct API server.'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks if a valid PEM encoded certificate is blacklisted&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function isBlackListed($certificate)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $certificate = trim($certificate);&nbsp;</div></li><li><div>        $lines = explode(&quot;\n&quot;, $certificate);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Kludgily remove the PEM padding&nbsp;</div></li><li><div>        array_shift($lines);&nbsp;</div></li><li><div>        array_pop($lines);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $derCert = base64_decode(implode(&quot;&quot;, $lines));&nbsp;</div></li><li><div>        $fingerprint = sha1($derCert);&nbsp;</div></li><li><div>        return in_array($fingerprint, self::$_blacklistedCerts);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function caBundle()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        return dirname(__FILE__) . '/../data/ca-certificates.crt';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.9.2.5</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.9/classes/ppp_stripe_api_requestor/" class="">1.9.2.9</a></li><li><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.8/classes/ppp_stripe_api_requestor/" class="">1.9.2.8</a></li><li><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.7/classes/ppp_stripe_api_requestor/" class="active">1.9.2.7</a></li><li><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.6/classes/ppp_stripe_api_requestor/" class="">1.9.2.6</a></li><li><a href="http://hookr.io/plugins/gravity-forms-stripe/1.9.2.5/classes/ppp_stripe_api_requestor/" class="">1.9.2.5</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>PPP\Stripe\ApiRequestor</li><li><span></span>Gravity Forms + Stripe</li><li><span></span>1.9.2.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>