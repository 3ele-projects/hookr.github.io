<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.2.4" data-slug="paypal-for-woocommerce" data-type="file" data-id="81151"><head xmlns="http://www.w3.org/1999/xhtml"><title> classes-wc-gateway-paypal-pro-payflow-angelleye | file | Paypal For Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paypal-for-woocommerce, 1.2.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.9"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=a08f3be6446938fe43d83fa898175af2' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.9' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/classes-wc-gateway-paypal-pro-payflow-angelleye/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-paypal-pro-payflow-angelleye%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-paypal-pro-payflow-angelleye%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paypal-for-woocommerce-1.2.4-file-classes-wc-gateway-paypal-pro-payflow-angelleye","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="classes-wc-gateway-paypal-pro-payflow-angelleye" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paypal-for-woocommerce." href="http://hookr.io/plugins/paypal-for-woocommerce/" class="plugin"><span property="name">paypal-for-woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.2.4." href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/" class="H_VERSION"><span property="name">1.2.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">classes-wc-gateway-paypal-pro&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="448"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/all/" title="All">All <span class="count badge">448</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="127"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/hooks/" title="Hooks">Hooks <span class="count badge">127</span></a></li><li class="" data-id="action" data-count="37"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/actions/" title="Actions">Actions <span class="count badge">37</span></a></li><li class="" data-id="filter" data-count="90"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/filters/" title="Filters">Filters <span class="count badge">90</span></a></li><li class="" data-id="class" data-count="298"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/classes/" title="Classes">Classes <span class="count badge">298</span></a></li><li class="" data-id="constant" data-count="16"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/constants/" title="Constants">Constants <span class="count badge">16</span></a></li><li class="" data-id="function" data-count="6"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/functions/" title="Functions">Functions <span class="count badge">6</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.2.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/classes/wc-gateway-paypal-pro-payflow-angelleye.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WC_Gateway_PayPal_Pro_PayFlow class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @extends WC_Payment_Gateway</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_Gateway_PayPal_Pro_PayFlow_AngellEYE extends WC_Payment_Gateway {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * __construct function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;id = 'paypal_pro_payflow';&nbsp;</div></li><li><div>      $this-&gt;method_title = __( 'PayPal Payments Pro 2.0 (PayFlow)', 'paypal-for-woocommerce' );&nbsp;</div></li><li><div>      $this-&gt;method_description = __( 'PayPal Payments Pro allows you to accept credit cards directly on your site without any redirection through PayPal.  You host the checkout form on your own web server, so you will need an SSL certificate to ensure your customer data is protected.', 'paypal-for-woocommerce' );&nbsp;</div></li><li><div>      $this-&gt;has_fields = true;&nbsp;</div></li><li><div>      $this-&gt;liveurl = 'https:<span class="comment">//payflowpro.paypal.com';</span>&nbsp;</div></li><li><div>      $this-&gt;testurl = 'https:<span class="comment">//pilot-payflowpro.paypal.com';</span>&nbsp;</div></li><li><div>      $this-&gt;allowed_currencies = apply_filters( 'woocommerce_paypal_pro_allowed_currencies', array( 'USD', 'EUR', 'GBP', 'CAD', 'JPY', 'AUD', 'NZD' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Load the form fields</span>&nbsp;</div></li><li><div>      $this-&gt;init_form_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Load the settings.</span>&nbsp;</div></li><li><div>      $this-&gt;init_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Get setting values</span>&nbsp;</div></li><li><div>      $this-&gt;title = $this-&gt;settings['title'];&nbsp;</div></li><li><div>      $this-&gt;description = $this-&gt;settings['description'];&nbsp;</div></li><li><div>      $this-&gt;enabled = $this-&gt;settings['enabled'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;paypal_vendor = $this-&gt;settings['paypal_vendor'];&nbsp;</div></li><li><div>      $this-&gt;paypal_partner = ! empty( $this-&gt;settings['paypal_partner'] ) ? $this-&gt;settings['paypal_partner'] : 'PayPal';&nbsp;</div></li><li><div>      $this-&gt;paypal_password = $this-&gt;settings['paypal_password'];&nbsp;</div></li><li><div>      $this-&gt;paypal_user = ! empty( $this-&gt;settings['paypal_user'] ) ? $this-&gt;settings['paypal_user'] : $this-&gt;paypal_vendor;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;testmode = $this-&gt;settings['testmode'];&nbsp;</div></li><li><div>      $this-&gt;invoice_id_prefix = isset( $this-&gt;settings['invoice_id_prefix'] ) ? $this-&gt;settings['invoice_id_prefix'] : '';&nbsp;</div></li><li><div>      $this-&gt;debug = isset( $this-&gt;settings['debug'] ) && $this-&gt;settings['debug'] == 'yes' ? true : false;&nbsp;</div></li><li><div>      $this-&gt;error_email_notify = isset($this-&gt;settings['error_email_notify']) && $this-&gt;settings['error_email_notify'] == 'yes' ? true : false;&nbsp;</div></li><li><div>      $this-&gt;error_display_type = isset($this-&gt;settings['error_display_type']) ? $this-&gt;settings['error_display_type'] : '';&nbsp;</div></li><li><div>      $this-&gt;send_items = isset( $this-&gt;settings['send_items'] ) && $this-&gt;settings['send_items'] == 'no' ? false : true;&nbsp;</div></li><li><div>      $this-&gt;payment_action = isset($this-&gt;settings['payment_action']) ? $this-&gt;settings['payment_action'] : 'Sale';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//fix ssl for image icon</span>&nbsp;</div></li><li><div>      $this-&gt;icon = ! empty($this-&gt;settings['card_icon']) ? $this-&gt;settings['card_icon'] : WP_PLUGIN_URL . &quot;/&quot; . plugin_basename( dirname( dirname( __FILE__ ) ) ) . '/assets/images/payflow-cards.png';&nbsp;</div></li><li><div>      if (is_ssl())&nbsp;</div></li><li><div>          $this-&gt;icon = preg_replace(&quot;/^http:/i&quot;, &quot;https:&quot;, $this-&gt;settings['card_icon']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;testmode==&quot;yes&quot;) {&nbsp;</div></li><li><div>          $this-&gt;paypal_vendor = $this-&gt;settings['sandbox_paypal_vendor'];&nbsp;</div></li><li><div>          $this-&gt;paypal_partner = ! empty( $this-&gt;settings['sandbox_paypal_partner'] ) ? $this-&gt;settings['sandbox_paypal_partner'] : 'PayPal';&nbsp;</div></li><li><div>          $this-&gt;paypal_password = $this-&gt;settings['sandbox_paypal_password'];&nbsp;</div></li><li><div>          $this-&gt;paypal_user = ! empty( $this-&gt;settings['sandbox_paypal_user'] ) ? $this-&gt;settings['sandbox_paypal_user'] : $this-&gt;paypal_vendor;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;supports = array(&nbsp;</div></li><li><div>          'products', &nbsp;</div></li><li><div>          'refunds'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;Force_tls_one_point_two = get_option('Force_tls_one_point_two', 'no');&nbsp;</div></li><li><div>      $this-&gt;enable_cardholder_first_last_name = isset($this-&gt;settings['enable_cardholder_first_last_name']) && $this-&gt;settings['enable_cardholder_first_last_name'] == 'yes' ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** 1.6.6 */</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_update_options_payment_gateways', array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** 2.0.0 */</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_update_options_payment_gateways_' . $this-&gt;id, array( $this, 'process_admin_options' ) );&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              add_filter( 'woocommerce_credit_card_form_fields', array($this, 'angelleye_paypal_pro_payflow_credit_card_form_fields'), 10, 2);&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              if ($this-&gt;enable_cardholder_first_last_name) {&nbsp;</div></li><li><div>                  add_action('woocommerce_credit_card_form_start', array($this, 'angelleye_woocommerce_credit_card_form_start'), 10, 1);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function add_log($message) {&nbsp;</div></li><li><div>      if ($this-&gt;debug) {&nbsp;</div></li><li><div>          if (!isset($this-&gt;log)) {&nbsp;</div></li><li><div>              $this-&gt;log = new WC_Logger();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;log-&gt;add('paypal_payflow', $message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_form_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Enable/Disable', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'label' =&gt; __( 'Enable PayPal Pro Payflow Edition', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                          'description' =&gt; '', &nbsp;</div></li><li><div>                          'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Title', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'text', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'This controls the title which the user sees during checkout.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; __( 'Credit card', 'paypal-for-woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Description', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'textarea', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'This controls the description which the user sees during checkout.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; __( 'Pay with your credit card.', 'paypal-for-woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testmode' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Test Mode', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'label' =&gt; __( 'Enable PayPal Sandbox/Test Mode', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'Place the payment gateway in development mode.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'invoice_id_prefix' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Invoice ID Prefix', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Add a prefix to the invoice ID sent to PayPal. This can resolve duplicate invoice problems when working with multiple websites on the same PayPal account.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'card_icon' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Card Icon', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; WP_PLUGIN_URL . &quot;/&quot; . plugin_basename( dirname( dirname( __FILE__ ) ) ) . '/assets/images/payflow-cards.png'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'debug' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Debug Log', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable logging', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; sprintf( __( 'Log PayPal events inside &lt;code&gt;%s&lt;/code&gt;', 'paypal-for-woocommerce' ), wc_get_log_file_path( 'paypal_payflow' ) ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'error_email_notify' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Error Email Notifications', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Enable admin email notifications for errors.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'description' =&gt; __( 'This will send a detailed error email to the WordPress site administrator if a PayPal API error occurs.', 'paypal-for-woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'error_display_type' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Error Display Type', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'label' =&gt; __( 'Display detailed or generic errors', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'class' =&gt; 'error_display_type_option', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'detailed' =&gt; 'Detailed', &nbsp;</div></li><li><div>                  'generic' =&gt; 'Generic'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'description' =&gt; __( 'Detailed displays actual errors returned from PayPal.  Generic displays general errors that do not reveal details &nbsp;</div></li><li><div>                                  and helps to prevent fraudulant activity on your site.' , 'paypal-for-woocommerce' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_paypal_vendor' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Sandbox PayPal Vendor', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Your merchant login ID that you created when you registered for the account.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_paypal_password' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Sandbox PayPal Password', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __( 'The password that you defined while registering for the account.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_paypal_user' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Sandbox PayPal User', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'If you set up one or more additional users on the account, this value is the ID&nbsp;</div></li><li><div>of the user authorized to process transactions. Otherwise, leave this field blank.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_paypal_partner' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Sandbox PayPal Partner', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __( 'The ID provided to you by the authorized PayPal Reseller who registered you&nbsp;</div></li><li><div>for the Payflow SDK. If you purchased your account directly from PayPal, use PayPal or leave blank.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; 'PayPal'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_vendor' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Live PayPal Vendor', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'text', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'Your merchant login ID that you created when you registered for the account.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_password' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Live PayPal Password', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'password', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'The password that you defined while registering for the account.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_user' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Live PayPal User', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'text', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'If you set up one or more additional users on the account, this value is the ID&nbsp;</div></li><li><div>of the user authorized to process transactions. Otherwise, leave this field blank.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_partner' =&gt; array(&nbsp;</div></li><li><div>                          'title' =&gt; __( 'Live PayPal Partner', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'type' =&gt; 'text', &nbsp;</div></li><li><div>                          'description' =&gt; __( 'The ID provided to you by the authorized PayPal Reseller who registered you&nbsp;</div></li><li><div>for the Payflow SDK. If you purchased your account directly from PayPal, use PayPal or leave blank.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                          'default' =&gt; 'PayPal'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'send_items' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Send Item Details', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'label' =&gt; __( 'Send line item details to PayPal', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __( 'Include all line item details in the payment request to PayPal so that they can be seen from the PayPal transaction details page.', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'payment_action' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Payment Action', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Whether to process as a Sale or Authorization.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'description' =&gt; __('Sale will capture the funds immediately when the order is placed.  Authorization will authorize the payment but will not capture the funds.  You would need to capture funds through your PayPal account when you are ready to deliver.'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'Sale' =&gt; 'Sale', &nbsp;</div></li><li><div>                  'Authorization' =&gt; 'Authorization', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'default' =&gt; 'Sale'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_cardholder_first_last_name' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Cardholder Name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Adds fields for &quot;card holder name&quot; to checkout in addition to the &quot;billing name&quot; fields.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Display card holder first and last name in credit card form.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;form_fields = apply_filters( 'angelleye_fc_form_fields', $this-&gt;form_fields );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if this gateway is enabled and available in the user's country</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method no is used anywhere??? put above but need a fix below</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function is_available() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;enabled == &quot;yes&quot; ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;testmode == &quot;no&quot; && get_option('woocommerce_force_ssl_checkout')=='no' && !class_exists( 'WordPressHTTPS' ) )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Currency check</span>&nbsp;</div></li><li><div>          if ( ! in_array( get_woocommerce_currency(), $this-&gt;allowed_currencies ) )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required fields check</span>&nbsp;</div></li><li><div>          if ( ! $this-&gt;paypal_vendor || ! $this-&gt;paypal_password )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function process_payment( $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! session_id() )&nbsp;</div></li><li><div>          session_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order = new WC_Order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              $card_number = isset( $_POST['paypal_pro_payflow-card-number'] ) ? wc_clean( $_POST['paypal_pro_payflow-card-number'] ) : '';&nbsp;</div></li><li><div>              $card_cvc = isset( $_POST['paypal_pro_payflow-card-cvc'] ) ? wc_clean( $_POST['paypal_pro_payflow-card-cvc'] ) : '';&nbsp;</div></li><li><div>              $card_exp_year = isset( $_POST['paypal_pro_payflow_card_expiration_year'] ) ? wc_clean( $_POST['paypal_pro_payflow_card_expiration_year'] ) : '';&nbsp;</div></li><li><div>              $card_exp_month = isset( $_POST['paypal_pro_payflow_card_expiration_month'] ) ? wc_clean( $_POST['paypal_pro_payflow_card_expiration_month'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Format values</span>&nbsp;</div></li><li><div>              $card_number = str_replace( array( ' ', '-' ), '', $card_number );&nbsp;</div></li><li><div>             &nbsp;</div></li><li><div>              $card_type = AngellEYE_Utility::card_type_from_account_number($card_number);&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              if($card_type == 'amex' && (get_woocommerce_currency() != 'USD' && get_woocommerce_currency() != 'AUD')) {&nbsp;</div></li><li><div>                  throw new Exception( __( 'Your processor is unable to process the Card Type in the currency requested. Please try another card type', 'paypal-for-woocommerce' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( strlen( $card_exp_year ) == 4 ) {&nbsp;</div></li><li><div>                      $card_exp_year = $card_exp_year - 2000;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              $card_exp_month = (int) $card_exp_month;&nbsp;</div></li><li><div>              if ($card_exp_month &lt; 10) {&nbsp;</div></li><li><div>                  $card_exp_month = '0'.$card_exp_month;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Do payment with paypal</span>&nbsp;</div></li><li><div>      return $this-&gt;do_payment( $order, $card_number, $card_exp_month . $card_exp_year, $card_cvc );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * do_payment</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Process the PayFlow transaction with PayPal.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $order</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_number</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_exp</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_csc</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelPAResStatus (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelEnrolled (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelCavv (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelEciFlag (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelXid (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function do_payment( $order, $card_number, $card_exp, $card_csc, $centinelPAResStatus = '', $centinelEnrolled = '', $centinelCavv = '', $centinelEciFlag = '', $centinelXid = '')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Display message to user if session has expired.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if(sizeof(WC()-&gt;cart-&gt;get_cart()) == 0)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $fc_session_expired = apply_filters( 'angelleye_fc_session_expired', sprintf(__( 'Sorry, your session has expired. &lt;a href=%s&gt;Return to homepage &rarr;&lt;/a&gt;', 'paypal-for-woocommerce' ), '&quot;'.home_url().'&quot;'), $this );&nbsp;</div></li><li><div>          wc_add_notice( $fc_session_expired, &quot;error&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Check if the PayPal_PayFlow class has already been established.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>                  require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if(!class_exists('Angelleye_PayPal_PayFlow' )) {&nbsp;</div></li><li><div>                  require_once('lib/angelleye/paypal-php-library/includes/paypal.payflow.class.php');    &nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create PayPal_PayFlow object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>                      'Sandbox' =&gt; ($this-&gt;testmode=='yes')? true:false, &nbsp;</div></li><li><div>                      'APIUsername' =&gt; $this-&gt;paypal_user, &nbsp;</div></li><li><div>                      'APIPassword' =&gt; trim($this-&gt;paypal_password), &nbsp;</div></li><li><div>                      'APIVendor' =&gt; $this-&gt;paypal_vendor, &nbsp;</div></li><li><div>                      'APIPartner' =&gt; $this-&gt;paypal_partner, &nbsp;</div></li><li><div>                                              'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal_PayFlow($PayPalConfig);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Pulled from original Woo extension.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if(empty($GLOBALS['wp_rewrite']))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $GLOBALS['wp_rewrite'] = new WP_Rewrite();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      try&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Parameter set by original Woo.  I can probably ditch this, but leaving it for now.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $url = $this-&gt;testmode == 'yes' ? $this-&gt;testurl : $this-&gt;liveurl;&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * PayPal PayFlow Gateway Request Params</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      $customer_note = $order-&gt;customer_note ? substr(preg_replace(&quot;/[^A-Za-z0-9 ]/&quot;, &quot;&quot;, $order-&gt;customer_note), 0, 256) : '';&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      $firstname = isset($_POST['paypal_pro-card-cardholder-first']) && !empty($_POST['paypal_pro_payflow-card-cardholder-first']) ? wc_clean($_POST['paypal_pro_payflow-card-cardholder-first']) : $order-&gt;billing_first_name;&nbsp;</div></li><li><div>                      $lastname = isset($_POST['paypal_pro-card-cardholder-last']) && !empty($_POST['paypal_pro_payflow-card-cardholder-last']) ? wc_clean($_POST['paypal_pro_payflow-card-cardholder-last']) : $order-&gt;billing_last_name;&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>          $PayPalRequestData = array(&nbsp;</div></li><li><div>                  'tender'=&gt;'C', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required.  The method of payment.  Values are: A = ACH, C = Credit Card, D = Pinless Debit, K = Telecheck, P = PayPal</span>&nbsp;</div></li><li><div>                  'trxtype'=&gt; $this-&gt;payment_action == 'Authorization' ? 'A' : 'S', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required.  Indicates the type of transaction to perform.  Values are:  A = Authorization, B = Balance Inquiry, C = Credit, D = Delayed Capture, F = Voice Authorization, I = Inquiry, L = Data Upload, N = Duplicate Transaction, S = Sale, V = Void</span>&nbsp;</div></li><li><div>                  'acct'=&gt;$card_number, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required for credit card transaction.  Credit card or purchase card number.</span>&nbsp;</div></li><li><div>                  'expdate'=&gt;$card_exp, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required for credit card transaction.  Expiration date of the credit card.  Format:  MMYY</span>&nbsp;</div></li><li><div>                  'amt'=&gt; AngellEYE_Gateway_Paypal::number_format($order-&gt;get_total()), <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required.  Amount of the transaction.  Must have 2 decimal places. </span>&nbsp;</div></li><li><div>                  'currency'=&gt;get_woocommerce_currency(), <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'dutyamt'=&gt;'', <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">                  'freightamt'=&gt;'', //</span>&nbsp;</div></li><li><div>                  'taxamt'=&gt;'', //&nbsp;</div></li><li><div>                  'taxexempt'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'comment1'=&gt; apply_filters( 'ae_pppf_custom_parameter', $customer_note , $order ), <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Merchant-defined value for reporting and auditing purposes.  128 char max&nbsp;</div></li><li><div>                  'comment2'=&gt; apply_filters( 'ae_pppf_comment2_parameter', '' , $order ), <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Merchant-defined value for reporting and auditing purposes.  128 char max&nbsp;</div></li><li><div>                  'cvv2'=&gt;$card_csc, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>A code printed on the back of the card (or front for Amex)&nbsp;</div></li><li><div>                  'recurring'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Identifies the transaction as recurring.  One of the following values:  Y = transaction is recurring, N = transaction is not recurring. &nbsp;</div></li><li><div>                  'swipe'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required for card-present transactions.  Used to pass either Track 1 or Track 2, but not both.&nbsp;</div></li><li><div>                  'orderid'=&gt; $this-&gt;invoice_id_prefix . preg_replace(&quot;/[^a-zA-Z0-9]/&quot;, &quot;&quot;, $order-&gt;get_order_number()), <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Checks for duplicate order.  If you pass orderid in a request and pass it again in the future the response returns DUPLICATE=2 along with the orderid&nbsp;</div></li><li><div>                  'orderdesc'=&gt;'Order ' . $order-&gt;get_order_number() . ' on ' . get_bloginfo( 'name' ), //&nbsp;</div></li><li><div>                  'billtoemail'=&gt;$order-&gt;billing_email, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's email address.&nbsp;</div></li><li><div>                  'billtophonenum'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's phone number.&nbsp;</div></li><li><div>                  'billtofirstname'=&gt; $firstname, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's first name.&nbsp;</div></li><li><div>                  'billtomiddlename'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's middle name.&nbsp;</div></li><li><div>                  'billtolastname'=&gt; $lastname, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's last name.&nbsp;</div></li><li><div>                  'billtostreet'=&gt;$order-&gt;billing_address_1.' '.$order-&gt;billing_address_2, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>The cardholder's street address (number and street name).  150 char max&nbsp;</div></li><li><div>                  'billtocity'=&gt;$order-&gt;billing_city, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Bill to city.  45 char max&nbsp;</div></li><li><div>                  'billtostate'=&gt;$order-&gt;billing_state, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Bill to state.  &nbsp;</div></li><li><div>                  'billtozip'=&gt;$order-&gt;billing_postcode, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Account holder's 5 to 9 digit postal code.  9 char max.  No dashes, spaces, or non-numeric characters&nbsp;</div></li><li><div>                  'billtocountry'=&gt;$order-&gt;billing_country, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Bill to Country.  3 letter country code.&nbsp;</div></li><li><div>                  'origid'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required by some transaction types.  ID of the original transaction referenced.  The PNREF parameter returns this ID, and it appears as the Transaction ID in PayPal Manager reports.  &nbsp;</div></li><li><div>                  'custref'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'custcode'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'custip'=&gt;$this-&gt;get_user_ip(), <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'invnum'=&gt;$this-&gt;invoice_id_prefix . str_replace(&quot;#&quot;, &quot;&quot;, $order-&gt;get_order_number()), //&nbsp;</div></li><li><div>                  'ponum'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>&nbsp;</div></li><li><div>                  'starttime'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>For inquiry transaction when using CUSTREF to specify the transaction.&nbsp;</div></li><li><div>                  'endtime'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>For inquiry transaction when using CUSTREF to specify the transaction.&nbsp;</div></li><li><div>                  'securetoken'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required if using secure tokens.  A value the Payflow server created upon your request for storing transaction data.  32 char&nbsp;</div></li><li><div>                  'partialauth'=&gt;'', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Required for partial authorizations.  Set to Y to submit a partial auth.    &nbsp;</div></li><li><div>                  'authcode'=&gt;''             <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Rrequired for voice authorizations.  Returned only for approved voice authorization transactions.  AUTHCODE is the approval code received over the phone from the processing network.  6 char max&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Shipping info</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if($order-&gt;shipping_address_1)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOFIRSTNAME'] = $order-&gt;shipping_first_name;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOLASTNAME'] = $order-&gt;shipping_last_name;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOSTREET'] = $order-&gt;shipping_address_1 . ' ' . $order-&gt;shipping_address_2;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOCITY'] = $order-&gt;shipping_city;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOSTATE'] = $order-&gt;shipping_state;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOCOUNTRY'] = $order-&gt;shipping_country;&nbsp;</div></li><li><div>              $PayPalRequestData['SHIPTOZIP'] = $order-&gt;shipping_postcode;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $PaymentData = AngellEYE_Gateway_Paypal::calculate($order, $this-&gt;send_items);&nbsp;</div></li><li><div>          $OrderItems = array();&nbsp;</div></li><li><div>          if ($this-&gt;send_items) {&nbsp;</div></li><li><div>              $item_loop = 0;&nbsp;</div></li><li><div>              foreach ($PaymentData['order_items'] as $_item) {&nbsp;</div></li><li><div>                  $Item['L_NUMBER' . $item_loop] = $_item['number'];&nbsp;</div></li><li><div>                  $Item['L_NAME' . $item_loop] = $_item['name'];&nbsp;</div></li><li><div>                  $Item['L_COST' . $item_loop] = $_item['amt'];&nbsp;</div></li><li><div>                  $Item['L_QTY' . $item_loop] = $_item['qty'];&nbsp;</div></li><li><div>                  if ($_item['number']) {&nbsp;</div></li><li><div>                      $Item['L_SKU' . $item_loop] = $_item['number'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $OrderItems = array_merge($OrderItems, $Item);&nbsp;</div></li><li><div>                  $item_loop++;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Shipping/tax/item amount</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $PayPalRequestData['taxamt'] = $PaymentData['taxamt'];&nbsp;</div></li><li><div>          $PayPalRequestData['freightamt'] = $PaymentData['shippingamt'];&nbsp;</div></li><li><div>          $PayPalRequestData['ITEMAMT'] = $PaymentData['itemamt'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( $this-&gt;send_items ) {&nbsp;</div></li><li><div>              $PayPalRequestData = array_merge($PayPalRequestData, $OrderItems);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>                      $log = $PayPalRequestData;&nbsp;</div></li><li><div>                      $log['acct'] = '****';&nbsp;</div></li><li><div>                      $log['cvv2'] = '****';&nbsp;</div></li><li><div>                      $this-&gt;add_log('PayFlow Request: '.print_r( $log, true ) );&nbsp;</div></li><li><div>          $PayPalResult = $PayPal-&gt;ProcessTransaction($PayPalRequestData);&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                      *  cURL Error Handling #146 </span>&nbsp;</div></li><li><div><span class="comment">                      *  @since    1.1.8</span>&nbsp;</div></li><li><div><span class="comment">                      */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      AngellEYE_Gateway_Paypal::angelleye_paypal_for_woocommerce_curl_error_handler($PayPalResult, $methos_name = 'do_payment', $gateway = 'PayPal Payments Pro 2.0 (PayFlow)', $this-&gt;error_email_notify);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>                      $this-&gt;add_log('PayFlow Endpoint: '.$PayPal-&gt;APIEndPoint);&nbsp;</div></li><li><div>                      $this-&gt;add_log('PayFlow Response: '.print_r($PayPalResult, true));&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Error check</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if(empty($PayPalResult['RAWRESPONSE']))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $fc_empty_response = apply_filters( 'ae_pppf_paypal_response_empty_message', __('Empty PayPal response.', 'paypal-for-woocommerce'), $PayPalResult );&nbsp;</div></li><li><div>              throw new Exception( $fc_empty_response );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Check for errors or fraud filter warnings and proceed accordingly.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if(isset($PayPalResult['RESULT']) && ($PayPalResult['RESULT'] == 0 || $PayPalResult['RESULT'] == 126))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Add order note&nbsp;</div></li><li><div>              if ($PayPalResult['RESULT'] == 126)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $order-&gt;add_order_note( $PayPalResult['RESPMSG']);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note( $PayPalResult['PREFPSMSG']);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note( &quot;The payment was flagged by a fraud filter, please check your PayPal Manager account to review and accept or deny the payment.&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                              &nbsp;</div></li><li><div>                              if( isset($PayPalResult['PPREF']) && !empty($PayPalResult['PPREF']) ) {&nbsp;</div></li><li><div>                                  add_post_meta($order-&gt;id, 'PPREF', $PayPalResult['PPREF']);&nbsp;</div></li><li><div>                                  $order-&gt;add_order_note(sprintf(__('PayPal Pro payment completed (PNREF: %s) (PPREF: %s)', 'paypal-for-woocommerce'), $PayPalResult['PNREF'], $PayPalResult['PPREF']));&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $order-&gt;add_order_note(sprintf(__('PayPal Pro payment completed (PNREF: %s)', 'paypal-for-woocommerce'), $PayPalResult['PNREF']));&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              <span class="comment">/** Checkout Note */</span>&nbsp;</div></li><li><div>                              if (isset($_POST) && !empty($_POST['order_comments'])) {&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Update post 37&nbsp;</div></li><li><div>                                  $checkout_note = array(&nbsp;</div></li><li><div>                                      'ID' =&gt; $order-&gt;id, &nbsp;</div></li><li><div>                                      'post_excerpt' =&gt; $_POST['order_comments'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                  wp_update_post($checkout_note);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Add order notes for AVS result</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $avs_address_response_code = isset($PayPalResult['AVSADDR']) ? $PayPalResult['AVSADDR'] : '';&nbsp;</div></li><li><div>              $avs_zip_response_code = isset($PayPalResult['AVSZIP']) ? $PayPalResult['AVSZIP'] : '';&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              $avs_response_order_note = __('Address Verification Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $avs_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>              $avs_response_order_note .= sprintf(__('Address Match: %s', 'paypal-for-woocommerce'), $avs_address_response_code);&nbsp;</div></li><li><div>              $avs_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>              $avs_response_order_note .= sprintf(__('Postal Match: %s', 'paypal-for-woocommerce'), $avs_zip_response_code);&nbsp;</div></li><li><div>              $order-&gt;add_order_note($avs_response_order_note);&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Add order notes for CVV2 result</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $cvv2_response_code = isset($PayPalResult['CVV2MATCH']) ? $PayPalResult['CVV2MATCH'] : '';&nbsp;</div></li><li><div>              $cvv2_response_order_note = __('Card Security Code Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $cvv2_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>              $cvv2_response_order_note .= sprintf(__('CVV2 Match: %s', 'paypal-for-woocommerce'), $cvv2_response_code);&nbsp;</div></li><li><div>              $order-&gt;add_order_note($cvv2_response_order_note);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Payment complete&nbsp;</div></li><li><div>              <span class="comment">//$order-&gt;add_order_note(&quot;PayPal Result&quot;.print_r($PayPalResult, true));</span>&nbsp;</div></li><li><div>              $order-&gt;payment_complete($PayPalResult['PNREF']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Remove cart&nbsp;</div></li><li><div>              WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Return thank you page redirect&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $order-&gt;update_status( 'failed', __('PayPal Pro payment failed. Payment was rejected due to an error: ', 'paypal-for-woocommerce' ) . '(' . $PayPalResult['RESULT'] . ') ' . '&quot;' . $PayPalResult['RESPMSG'] . '&quot;' );&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Generate error message based on Error Display Type setting&nbsp;</div></li><li><div>              if($this-&gt;error_display_type == 'detailed')&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $fc_error_display_type = __( 'Payment error:', 'paypal-for-woocommerce' ) . ' ' . $PayPalResult['RESULT'].'-'.$PayPalResult['RESPMSG'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $fc_error_display_type = __( 'Payment error:', 'paypal-for-woocommerce' ) . ' There was a problem processing your payment.  Please try another method.';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $fc_error_display_type = apply_filters( 'ae_pppf_error_user_display_message', $fc_error_display_type, $PayPalResult['RESULT'], $PayPalResult['RESPMSG'], $PayPalResult );&nbsp;</div></li><li><div>              wc_add_notice( $fc_error_display_type, &quot;error&quot; );&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Notice admin if has any issue from PayPal&nbsp;</div></li><li><div>              if($this-&gt;error_email_notify)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>                  $message = __( &quot;PayFlow API call failed.&quot; , &quot;paypal-for-woocommerce&quot; ).&quot;\n\n&quot;;&nbsp;</div></li><li><div>                  $message .= __( 'Error Code: ' , 'paypal-for-woocommerce' ) . $PayPalResult['RESULT'] .&quot;\n&quot;;&nbsp;</div></li><li><div>                  $message .= __( 'Detailed Error Message: ' , 'paypal-for-woocommerce') . $PayPalResult['RESPMSG'];&nbsp;</div></li><li><div>                  $message .= isset($PayPalResult['PREFPSMSG']) && $PayPalResult['PREFPSMSG'] != '' ? ' - ' . $PayPalResult['PREFPSMSG'] .&quot;\n&quot; : &quot;\n&quot;;&nbsp;</div></li><li><div>                                      $message .= __( 'User IP: ', 'paypal-for-woocommerce') . $this-&gt;get_user_ip() . &quot;\n&quot;;&nbsp;</div></li><li><div>                  $message .= __( 'Order ID: ' ).$order-&gt;id .&quot;\n&quot;;&nbsp;</div></li><li><div>                  $message .= __( 'Customer Name: ' ).$order-&gt;billing_first_name.' '.$order-&gt;billing_last_name.&quot;\n&quot;;&nbsp;</div></li><li><div>                  $message .= __( 'Customer Email: ' ).$order-&gt;billing_email.&quot;\n&quot;;&nbsp;</div></li><li><div>                  $message = apply_filters( 'ae_pppf_error_email_message', $message );&nbsp;</div></li><li><div>                  $subject = apply_filters( 'ae_pppf_error_email_subject', &quot;PayPal Pro Error Notification&quot; );&nbsp;</div></li><li><div>                  wp_mail( $admin_email, $subject, $message );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      catch(Exception $e)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $fc_connect_error = apply_filters( 'angelleye_fc_connect_error', $e-&gt;getMessage() , $e );&nbsp;</div></li><li><div>          wc_add_notice( $fc_connect_error, &quot;error&quot;);&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }    &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      public function payment_fields() {&nbsp;</div></li><li><div>          do_action( 'angelleye_before_fc_payment_fields', $this );&nbsp;</div></li><li><div>          if ( $this-&gt;description ) {&nbsp;</div></li><li><div>              echo '&lt;p&gt;' . wp_kses_post( $this-&gt;description );&nbsp;</div></li><li><div>              if($this-&gt;testmode == &quot;yes&quot;)&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  echo '&lt;p&gt;';&nbsp;</div></li><li><div>                  _e('NOTICE: SANDBOX (TEST) MODE ENABLED.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>                  echo '&lt;br /&gt;';&nbsp;</div></li><li><div>                  _e('For testing purposes you can use the card number 4111111111111111 with any CVC and a valid expiration date.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>                  echo '&lt;/p&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if(class_exists('WC_Payment_Gateway_CC')) {&nbsp;</div></li><li><div>              $cc_form = new WC_Payment_Gateway_CC;&nbsp;</div></li><li><div>              $cc_form-&gt;id = $this-&gt;id;&nbsp;</div></li><li><div>              $cc_form-&gt;supports = $this-&gt;supports;&nbsp;</div></li><li><div>              $cc_form-&gt;form();&nbsp;</div></li><li><div>              do_action( 'angelleye_after_fc_payment_fields', $this );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $fields = $this-&gt;angelleye_paypal_pro_payflow_credit_card_form_fields($default_fields = null, $this-&gt;id);&nbsp;</div></li><li><div>              $this-&gt;credit_card_form(array(), $fields);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      public function paypal_for_woocommerce_paypal_pro_payflow_credit_card_form_expiration_date_selectbox() {&nbsp;</div></li><li><div>          $form_html = &quot;&quot;;&nbsp;</div></li><li><div>          $form_html .= '&lt;p class=&quot;form-row form-row-first&quot;&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;label for=&quot;cc-expire-month&quot;&gt;' . __(&quot;Expiration Date&quot;, 'paypal-for-woocommerce') . '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;select name=&quot;paypal_pro_payflow_card_expiration_month&quot; id=&quot;cc-expire-month&quot; class=&quot;woocommerce-select woocommerce-cc-month mr5&quot;&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;option value=&quot;&quot;&gt;' . __('Month', 'paypal-for-woocommerce') . '&lt;/option&gt;';&nbsp;</div></li><li><div>          $months = array();&nbsp;</div></li><li><div>          for ($i = 1; $i &lt;= 12; $i++) :&nbsp;</div></li><li><div>              $timestamp = mktime(0, 0, 0, $i, 1);&nbsp;</div></li><li><div>              $months[date('n', $timestamp)] = date_i18n(_x('F', 'Month Names', 'paypal-for-woocommerce'), $timestamp);&nbsp;</div></li><li><div>          endfor;&nbsp;</div></li><li><div>          foreach ($months as $num =&gt; $name) {&nbsp;</div></li><li><div>              $form_html .= '&lt;option value=' . $num . '&gt;' . $name . '&lt;/option&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $form_html .= '&lt;/select&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;select name=&quot;paypal_pro_payflow_card_expiration_year&quot; id=&quot;cc-expire-year&quot; class=&quot;woocommerce-select woocommerce-cc-year ml5&quot;&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;option value=&quot;&quot;&gt;' . __('Year', 'paypal-for-woocommerce') . '&lt;/option&gt;';&nbsp;</div></li><li><div>          for ($i = date('y'); $i &lt;= date('y') + 15; $i++) {&nbsp;</div></li><li><div>              $form_html .= '&lt;option value=' . $i . '&gt;20' . $i . '&lt;/option&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $form_html .= '&lt;/select&gt;';&nbsp;</div></li><li><div>          $form_html .= '&lt;/p&gt;';&nbsp;</div></li><li><div>          return $form_html;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get user's IP address</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_user_ip() {&nbsp;</div></li><li><div>      return ! empty( $_SERVER['HTTP_X_FORWARD_FOR'] ) ? $_SERVER['HTTP_X_FORWARD_FOR'] : $_SERVER['REMOTE_ADDR'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * clear_centinel_session function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function clear_centinel_session() {&nbsp;</div></li><li><div>      unset( $_SESSION['Message'] );&nbsp;</div></li><li><div>      foreach ( $_SESSION as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( preg_match( &quot;/^Centinel_.*/&quot;, $key ) &gt; 0 ) {&nbsp;</div></li><li><div>              unset( $_SESSION[ $key ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process a refund if supported</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $order_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param  float $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $reason</span>&nbsp;</div></li><li><div><span class="comment">   * @return  bool|wp_error True or false based on success, or a WP_Error object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_refund( $order_id, $amount = null, $reason = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'angelleye_before_fc_refund', $order_id, $amount, $reason );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>      $this-&gt;add_log( 'Begin Refund' );&nbsp;</div></li><li><div>      $this-&gt;add_log( 'Order ID: '. print_r($order_id, true) );&nbsp;</div></li><li><div>      $this-&gt;add_log( 'Transaction ID: '. print_r($order-&gt;get_transaction_id(), true) );&nbsp;</div></li><li><div>      if ( ! $order || ! $order-&gt;get_transaction_id() || ! $this-&gt;paypal_user || ! $this-&gt;paypal_password || ! $this-&gt;paypal_vendor ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if the PayPal_PayFlow class has already been established.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!class_exists('Angelleye_PayPal_PayFlow' )) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.payflow.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create PayPal_PayFlow object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; ($this-&gt;testmode=='yes')? true:false, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;paypal_user, &nbsp;</div></li><li><div>          'APIPassword' =&gt; trim($this-&gt;paypal_password), &nbsp;</div></li><li><div>          'APIVendor' =&gt; $this-&gt;paypal_vendor, &nbsp;</div></li><li><div>          'APIPartner' =&gt; $this-&gt;paypal_partner, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal_PayFlow($PayPalConfig);&nbsp;</div></li><li><div>      $PayPalRequestData = array(&nbsp;</div></li><li><div>          'TENDER' =&gt; 'C', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>C = credit card, P = PayPal&nbsp;</div></li><li><div>          'TRXTYPE' =&gt; 'C', <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span> S=Sale, A= Auth, C=Credit, D=Delayed Capture, V=Void&nbsp;</div></li><li><div>          'ORIGID' =&gt; $order-&gt;get_transaction_id(), &nbsp;</div></li><li><div>          'AMT' =&gt; $amount, &nbsp;</div></li><li><div>          'CURRENCY' =&gt; $order-&gt;get_order_currency()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>      $PayPalResult = $PayPal-&gt;ProcessTransaction($PayPalRequestData);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $PayPalRequest = isset($PayPalResult['RAWREQUEST']) ? $PayPalResult['RAWREQUEST'] : '';&nbsp;</div></li><li><div>      $PayPalResponse = isset($PayPalResult['RAWRESPONSE']) ? $PayPalResult['RAWRESPONSE'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;add_log('Refund Request: ' . print_r($PayPalRequestData, true));&nbsp;</div></li><li><div>      $this-&gt;add_log('Refund Response: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalResponse)), true));&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>       <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       *  cURL Error Handling #146 </span>&nbsp;</div></li><li><div><span class="comment">       *  @since    1.1.8</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      AngellEYE_Gateway_Paypal::angelleye_paypal_for_woocommerce_curl_error_handler($PayPalResult, $methos_name = 'Refund Request', $gateway = 'PayPal Payments Pro 2.0 (PayFlow)', $this-&gt;error_email_notify);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_action( 'angelleye_after_refund', $PayPalResult, $order, $amount, $reason );&nbsp;</div></li><li><div>      if(isset($PayPalResult['RESULT']) && ($PayPalResult['RESULT'] == 0 || $PayPalResult['RESULT'] == 126)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $order-&gt;add_order_note('Refund Transaction ID:' . $PayPalResult['PNREF']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $max_remaining_refund = wc_format_decimal( $order-&gt;get_total() - $order-&gt;get_total_refunded() );&nbsp;</div></li><li><div>          if ( !$max_remaining_refund &gt; 0 ) {&nbsp;</div></li><li><div>              $order-&gt;update_status('refunded');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (ob_get_length()) ob_end_clean();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $fc_refund_error = apply_filters( 'ae_pppf_refund_error_message', $PayPalResult['RESPMSG'], $PayPalResult );&nbsp;</div></li><li><div>          return new WP_Error( 'paypal-error', $fc_refund_error );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Validate the payment form</span>&nbsp;</div></li><li><div><span class="comment">   * PayFlow - Empty Card Data Validation Problem #220 </span>&nbsp;</div></li><li><div><span class="comment">   * @since    1.1.7.6</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function validate_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $card_number = isset( $_POST['paypal_pro_payflow-card-number'] ) ? wc_clean( $_POST['paypal_pro_payflow-card-number'] ) : '';&nbsp;</div></li><li><div>      $card_cvc = isset( $_POST['paypal_pro_payflow-card-cvc'] ) ? wc_clean( $_POST['paypal_pro_payflow-card-cvc'] ) : '';&nbsp;</div></li><li><div>      $card_exp_year = isset( $_POST['paypal_pro_payflow_card_expiration_year'] ) ? wc_clean( $_POST['paypal_pro_payflow_card_expiration_year'] ) : '';&nbsp;</div></li><li><div>      $card_exp_month = isset( $_POST['paypal_pro_payflow_card_expiration_month'] ) ? wc_clean( $_POST['paypal_pro_payflow_card_expiration_month'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Format values</span>&nbsp;</div></li><li><div>      $card_number = str_replace( array( ' ', '-' ), '', $card_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strlen( $card_exp_year ) == 4 ) {&nbsp;</div></li><li><div>              $card_exp_year = $card_exp_year - 2000;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action('before_angelleye_pro_payflow_checkout_validate_fields', $card_number, $card_cvc, $card_exp_month, $card_exp_year);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Check card security code&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!ctype_digit($card_cvc)) {&nbsp;</div></li><li><div>          wc_add_notice(__('Card security code is invalid (only digits are allowed)', 'paypal-for-woocommerce'), &quot;error&quot;);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Check card expiration data&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!ctype_digit($card_exp_month) || !ctype_digit($card_exp_year) || $card_exp_month &gt; 12 || $card_exp_month &lt; 1 || $card_exp_year &lt; date('y') || $card_exp_year &gt; date('y') + 20) {&nbsp;</div></li><li><div>          wc_add_notice(__('Card expiration date is invalid', 'paypal-for-woocommerce'), &quot;error&quot;);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// </span></span></span></span>Check card number&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($card_number) || !ctype_digit($card_number)) {&nbsp;</div></li><li><div>          wc_add_notice(__('Card number is invalid', 'paypal-for-woocommerce'), &quot;error&quot;);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action('after_angelleye_pro_payflow_checkout_validate_fields', $card_number, $card_cvc, $card_exp_month, $card_exp_year);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_paypal_pro_payflow_credit_card_form_fields($default_fields, $current_gateway_id) {&nbsp;</div></li><li><div>      if($current_gateway_id == $this-&gt;id) {&nbsp;</div></li><li><div>            $fields = array(&nbsp;</div></li><li><div>          'card-number-field' =&gt; '&lt;p class=&quot;form-row form-row-wide&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;' . esc_attr( $this-&gt;id ) . '-card-number&quot;&gt;' . __( 'Credit Card Number', 'paypal-for-woocommerce' ) . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;input id=&quot;' . esc_attr( $this-&gt;id ) . '-card-number&quot; class=&quot;input-text wc-credit-card-form-card-number&quot; type=&quot;text&quot; maxlength=&quot;20&quot; autocomplete=&quot;off&quot; placeholder=&quot;**** **** **** ****&quot; name=&quot;' . $this-&gt;id . '-card-number' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;', &nbsp;</div></li><li><div>          'card-expiry-field' =&gt; $this-&gt;paypal_for_woocommerce_paypal_pro_payflow_credit_card_form_expiration_date_selectbox(), &nbsp;</div></li><li><div>          'card-cvc-field' =&gt; '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;' . esc_attr( $this-&gt;id ) . '-card-cvc&quot;&gt;' . __( 'Card Security Code', 'paypal-for-woocommerce' ) . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;input id=&quot;' . esc_attr( $this-&gt;id ) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-card-cvc&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . esc_attr__( 'CVC', 'paypal-for-woocommerce' ) . '&quot; name=&quot;' .  $this-&gt;id . '-card-cvc' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            return $fields;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $default_fields;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_woocommerce_credit_card_form_start($current_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($this-&gt;enable_cardholder_first_last_name && $current_id == $this-&gt;id) {&nbsp;</div></li><li><div>          $fields['card-cardholder-first'] = '&lt;p class=&quot;form-row form-row-first&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot;&gt;' . __('Cardholder First Name', 'paypal-for-woocommerce') . '&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-cardholder&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . esc_attr__('First Name', 'paypal-for-woocommerce') . '&quot; name=&quot;' . $current_id . '-card-cardholder-first' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;';&nbsp;</div></li><li><div>          $fields['card-cardholder-last'] = '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot;&gt;' . __('Cardholder Last Name', 'paypal-for-woocommerce') . '&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot; class=&quot;input-text wc-credit-card-form-cardholder&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . __('Last Name', 'paypal-for-woocommerce') . '&quot; name=&quot;' . $current_id . '-card-cardholder-last' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($fields as $field) {&nbsp;</div></li><li><div>              echo $field;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>PayPal for WooCommerce</li><li><span></span>1.2.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>