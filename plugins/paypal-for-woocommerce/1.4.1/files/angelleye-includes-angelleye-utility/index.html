<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.4.1" data-slug="paypal-for-woocommerce" data-type="file" data-id="80480"><head xmlns="http://www.w3.org/1999/xhtml"><title> angelleye-includes-angelleye-utility | file | Paypal For Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paypal-for-woocommerce, 1.4.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5721cfb92960abf6f19589af1f90e4de' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/angelleye-includes-angelleye-utility/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fangelleye-includes-angelleye-utility%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fangelleye-includes-angelleye-utility%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paypal-for-woocommerce-1.4.1-file-angelleye-includes-angelleye-utility","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="angelleye-includes-angelleye-utility" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paypal-for-woocommerce." href="http://hookr.io/plugins/paypal-for-woocommerce/" class="plugin"><span property="name">paypal-for-woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.4.1." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/" class="H_VERSION"><span property="name">1.4.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">angelleye-includes-angelleye-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="489"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/all/" title="All">All <span class="count badge">489</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="153"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/hooks/" title="Hooks">Hooks <span class="count badge">153</span></a></li><li class="" data-id="action" data-count="31"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/actions/" title="Actions">Actions <span class="count badge">31</span></a></li><li class="" data-id="filter" data-count="122"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/filters/" title="Filters">Filters <span class="count badge">122</span></a></li><li class="" data-id="class" data-count="309"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/classes/" title="Classes">Classes <span class="count badge">309</span></a></li><li class="" data-id="constant" data-count="21"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/constants/" title="Constants">Constants <span class="count badge">21</span></a></li><li class="" data-id="function" data-count="6"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/functions/" title="Functions">Functions <span class="count badge">6</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/angelleye-includes/angelleye-utility.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @class       AngellEYE_Utility</span>&nbsp;</div></li><li><div><span class="comment"> * @version    1.1.9.2</span>&nbsp;</div></li><li><div><span class="comment"> * @package    paypal-for-woocommerce</span>&nbsp;</div></li><li><div><span class="comment"> * @category    Class</span>&nbsp;</div></li><li><div><span class="comment"> * @author      Angell EYE &lt;service@angelleye.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class AngellEYE_Utility {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $plugin_name;&nbsp;</div></li><li><div>  public $version;&nbsp;</div></li><li><div>  public $paypal;&nbsp;</div></li><li><div>  public $testmode;&nbsp;</div></li><li><div>  public $api_username;&nbsp;</div></li><li><div>  public $api_password;&nbsp;</div></li><li><div>  public $api_signature;&nbsp;</div></li><li><div>  public $ec_debug;&nbsp;</div></li><li><div>  public $payment_method;&nbsp;</div></li><li><div>  public $error_email_notify;&nbsp;</div></li><li><div>  public $angelleye_woocommerce_order_actions;&nbsp;</div></li><li><div>  public $total_Order;&nbsp;</div></li><li><div>  public $total_DoVoid;&nbsp;</div></li><li><div>  public $total_DoCapture;&nbsp;</div></li><li><div>  public $total_Pending_DoAuthorization;&nbsp;</div></li><li><div>  public $total_Completed_DoAuthorization;&nbsp;</div></li><li><div>  public $total_DoReauthorization;&nbsp;</div></li><li><div>  public $max_authorize_amount;&nbsp;</div></li><li><div>  public $remain_authorize_amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct($plugin_name, $version) {&nbsp;</div></li><li><div>      $this-&gt;plugin_name = $plugin_name;&nbsp;</div></li><li><div>      $this-&gt;version = $version;&nbsp;</div></li><li><div>      $this-&gt;load_dependencies();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_ec_angelleye_paypal_php_library() {&nbsp;</div></li><li><div>      if (!class_exists('WC_Payment_Gateway')) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once( PAYPAL_FOR_WOOCOMMERCE_PLUGIN_DIR . '/classes/lib/angelleye/paypal-php-library/includes/paypal.class.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if( empty($this-&gt;payment_method) || $this-&gt;payment_method == false) {&nbsp;</div></li><li><div>          $this-&gt;angelleye_set_payment_method();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if( empty($this-&gt;payment_method) || $this-&gt;payment_method == false) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;payment_method == 'paypal_express') {&nbsp;</div></li><li><div>          $gateway_obj = new WC_Gateway_PayPal_Express_AngellEYE();&nbsp;</div></li><li><div>          $this-&gt;testmode = 'yes' === $gateway_obj-&gt;get_option('testmode', 'yes');&nbsp;</div></li><li><div>      } else if($this-&gt;payment_method == 'paypal_pro') {&nbsp;</div></li><li><div>          $gateway_obj = new WC_Gateway_PayPal_Pro_AngellEYE();&nbsp;</div></li><li><div>          $this-&gt;testmode = 'yes' === $gateway_obj-&gt;get_option('testmode', 'no');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;testmode == false) {&nbsp;</div></li><li><div>          $this-&gt;testmode = AngellEYE_Utility::angelleye_paypal_for_woocommerce_is_set_sandbox_product();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;testmode == true) {&nbsp;</div></li><li><div>          $this-&gt;api_username = $gateway_obj-&gt;get_option('sandbox_api_username');&nbsp;</div></li><li><div>          $this-&gt;api_password = $gateway_obj-&gt;get_option('sandbox_api_password');&nbsp;</div></li><li><div>          $this-&gt;api_signature = $gateway_obj-&gt;get_option('sandbox_api_signature');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;api_username = $gateway_obj-&gt;get_option('api_username');&nbsp;</div></li><li><div>          $this-&gt;api_password = $gateway_obj-&gt;get_option('api_password');&nbsp;</div></li><li><div>          $this-&gt;api_signature = $gateway_obj-&gt;get_option('api_signature');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;error_email_notify = $gateway_obj-&gt;get_option('error_email_notify');&nbsp;</div></li><li><div>      $this-&gt;ec_debug = $gateway_obj-&gt;get_option('debug');&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;paypal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function load_dependencies() {&nbsp;</div></li><li><div>      add_action('init', array($this, 'paypal_for_woocommerce_paypal_transaction_history'), 5);&nbsp;</div></li><li><div>      if (is_admin() && !defined('DOING_AJAX')) {&nbsp;</div></li><li><div>          add_action('add_meta_boxes', array($this, 'angelleye_paypal_for_woocommerce_order_action_meta_box'), 10, 2);&nbsp;</div></li><li><div>          $hook_name = '';&nbsp;</div></li><li><div>          $payment_action_with_gateway = array('paypal_express' =&gt; array('DoAuthorization', 'DoCapture', 'DoVoid', 'DoReauthorization'), 'paypal_pro' =&gt; array('DoAuthorization', 'DoCapture', 'DoVoid'));&nbsp;</div></li><li><div>          foreach ($payment_action_with_gateway as $payment_method_name =&gt; $payment_action_name) {&nbsp;</div></li><li><div>              foreach ($payment_action_name as $action_name) {&nbsp;</div></li><li><div>                  $hook_name = 'wc_' . $payment_method_name . '_' . strtolower($action_name);&nbsp;</div></li><li><div>                  add_action('woocommerce_order_action_' . $hook_name, array($this, 'angelleye_' . $hook_name));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          add_filter('woocommerce_payment_gateway_supports', array($this, 'angelleye_woocommerce_payment_gateway_supports'), 10, 3);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'woocommerce_process_shop_order_meta', array($this, 'save' ), 50, 2);&nbsp;</div></li><li><div>      add_action( 'woocommerce_admin_order_data_after_shipping_address', array($this, 'angelleye_paypal_for_woocommerce_billing_agreement_details'), 10, 1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_woocommerce_order_actions($order_actions = array()) {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>      $order_id = $post-&gt;ID;&nbsp;</div></li><li><div>      if (!is_object($order_id)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $paypal_payment_action = array();&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $this-&gt;payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>      $payment_action = $old_wc ? get_post_meta($order_id, '_payment_action', true) : get_post_meta($order-&gt;get_id(), '_payment_action', true);&nbsp;</div></li><li><div>      if ((isset($this-&gt;payment_method) && !empty($this-&gt;payment_method)) && (isset($payment_action) && !empty($payment_action)) && !$this-&gt;has_authorization_expired($post-&gt;ID)) {&nbsp;</div></li><li><div>          switch ($this-&gt;payment_method) {&nbsp;</div></li><li><div>              case 'paypal_express': {&nbsp;</div></li><li><div>                      $paypal_payment_action = array();&nbsp;</div></li><li><div>                      $this-&gt;total_Order = self::get_total('Order', 'Pending', $order_id);&nbsp;</div></li><li><div>                      $this-&gt;total_DoVoid = self::get_total('DoVoid', '', $order_id);&nbsp;</div></li><li><div>                      $this-&gt;total_DoCapture = self::get_total('DoCapture', 'Completed', $order_id);&nbsp;</div></li><li><div>                      $this-&gt;total_Pending_DoAuthorization = self::get_total('DoAuthorization', 'Pending', $order_id);&nbsp;</div></li><li><div>                      $this-&gt;total_Completed_DoAuthorization = self::get_total('DoAuthorization', 'Completed', $order_id);&nbsp;</div></li><li><div>                      $this-&gt;total_DoReauthorization = self::get_total('DoReauthorization', '', $order_id);&nbsp;</div></li><li><div>                      switch ($payment_action) {&nbsp;</div></li><li><div>                          case ($payment_action == 'Order'):&nbsp;</div></li><li><div>                              $this-&gt;angelleye_max_authorize_amount($order_id);&nbsp;</div></li><li><div>                              $this-&gt;angelleye_remain_authorize_amount();&nbsp;</div></li><li><div>                              if ($this-&gt;max_authorize_amount == $this-&gt;total_DoVoid || $this-&gt;max_authorize_amount == $this-&gt;total_DoCapture) {&nbsp;</div></li><li><div>                                  return $paypal_payment_action;&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $paypal_payment_action = array('DoCapture' =&gt; 'Capture Authorization', 'DoVoid' =&gt; 'Void Authorization', 'DoAuthorization' =&gt; 'Authorization');&nbsp;</div></li><li><div>                                  if ($this-&gt;total_Completed_DoAuthorization == $this-&gt;total_Pending_DoAuthorization || $this-&gt;total_Pending_DoAuthorization == 0 || $this-&gt;total_Pending_DoAuthorization == $this-&gt;total_DoCapture || $this-&gt;total_DoCapture == $order-&gt;get_total() - $order-&gt;get_total_refunded()) {&nbsp;</div></li><li><div>                                      unset($paypal_payment_action['DoCapture']);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  if ($this-&gt;total_Pending_DoAuthorization == 0 && $this-&gt;total_Completed_DoAuthorization &gt; 0 || $this-&gt;total_Pending_DoAuthorization == $this-&gt;total_DoCapture) {&nbsp;</div></li><li><div>                                      unset($paypal_payment_action['DoVoid']);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  if ($this-&gt;max_authorize_amount == self::round($this-&gt;total_Pending_DoAuthorization + $this-&gt;total_Completed_DoAuthorization)) {&nbsp;</div></li><li><div>                                      unset($paypal_payment_action['DoAuthorization']);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  return $paypal_payment_action;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          case ($payment_action == 'Authorization'):&nbsp;</div></li><li><div>                              $paypal_payment_action = array('DoCapture' =&gt; 'Capture Authorization', 'DoReauthorization' =&gt; 'Authorization', 'DoVoid' =&gt; 'Void Authorization');&nbsp;</div></li><li><div>                              $transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>                              if (!$this-&gt;has_authorization_inside_honor_period($transaction_id)) {&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoReauthorization']);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if (!is_object($order_id)) {&nbsp;</div></li><li><div>                                  $order = wc_get_order($order_id);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ($order-&gt;get_total() == $this-&gt;total_DoVoid || $this-&gt;total_Completed_DoAuthorization == $order-&gt;get_total() || $order-&gt;get_total() == $this-&gt;total_DoCapture || $this-&gt;total_DoCapture == $order-&gt;get_total() - $order-&gt;get_total_refunded()) {&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoCapture']);&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoVoid']);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              return $paypal_payment_action;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              case 'paypal_pro': {&nbsp;</div></li><li><div>                      switch ($payment_action) {&nbsp;</div></li><li><div>                          case ($payment_action == 'Authorization'):&nbsp;</div></li><li><div>                              $this-&gt;total_DoVoid = self::get_total('DoVoid', '', $order_id);&nbsp;</div></li><li><div>                              $this-&gt;total_DoCapture = self::get_total('DoCapture', 'Completed', $order_id);&nbsp;</div></li><li><div>                              if ($payment_action == 'Order') {&nbsp;</div></li><li><div>                                  $Authorization = 'DoAuthorization';&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $Authorization = 'authorization';&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $this-&gt;total_Pending_DoAuthorization = self::get_total($Authorization, 'Pending', $order_id);&nbsp;</div></li><li><div>                              $this-&gt;total_Completed_DoAuthorization = self::get_total($Authorization, 'Completed', $order_id);&nbsp;</div></li><li><div>                              $this-&gt;total_DoReauthorization = self::get_total('DoReauthorization', '', $order_id);&nbsp;</div></li><li><div>                              $paypal_payment_action = array('DoCapture' =&gt; 'Capture Authorization', 'DoReauthorization' =&gt; 'Reauthorization', 'DoVoid' =&gt; 'Void Authorization');&nbsp;</div></li><li><div>                              $this-&gt;angelleye_max_authorize_amount($order_id);&nbsp;</div></li><li><div>                              $this-&gt;angelleye_remain_authorize_amount();&nbsp;</div></li><li><div>                              $transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>                              if (!$this-&gt;has_authorization_inside_honor_period($transaction_id)) {&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoReauthorization']);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if (!is_object($order_id)) {&nbsp;</div></li><li><div>                                  $order = wc_get_order($order_id);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ($order-&gt;get_total() == $this-&gt;total_DoVoid || $this-&gt;total_Completed_DoAuthorization == $order-&gt;get_total() - $order-&gt;get_total_refunded() || $this-&gt;total_DoCapture == $order-&gt;get_total() - $order-&gt;get_total_refunded()) {&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoCapture']);&nbsp;</div></li><li><div>                                  unset($paypal_payment_action['DoVoid']);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              return $paypal_payment_action;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($paypal_payment_action) && !empty($paypal_payment_action)) {&nbsp;</div></li><li><div>          foreach ($paypal_payment_action as $key =&gt; $value) {&nbsp;</div></li><li><div>              $order_actions['wc_' . $this-&gt;payment_method . '_' . strtolower($value)] = _x($value, $value, $this-&gt;plugin_name);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $order_actions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * $_transaction_id, $payment_action, $gateway_name</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function angelleye_add_order_meta($order_id, $payment_order_meta) {&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      foreach ($payment_order_meta as $key =&gt; $value) {&nbsp;</div></li><li><div>          if ($old_wc) {&nbsp;</div></li><li><div>          update_post_meta($order_id, $key, $value);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_post_meta( $order-&gt;get_id(), $key, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($old_wc) {&nbsp;</div></li><li><div>      update_post_meta($order_id, '_trans_date', current_time('mysql'));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          update_post_meta( $order-&gt;get_id(), '_trans_date', current_time('mysql') );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_authorization_expired($order_id) {&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      $transaction_time = $old_wc ? get_post_meta($order_id, '_trans_date', true) : get_post_meta($order-&gt;get_id(), '_trans_date', true);&nbsp;</div></li><li><div>      return floor(( time() - strtotime($transaction_time) ) / 3600) &gt; 720;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function has_authorization_inside_honor_period($transaction_id) {&nbsp;</div></li><li><div>      $transaction_post_is = $this-&gt;get_post_by_title($transaction_id);&nbsp;</div></li><li><div>      $transaction_time = get_post_meta($transaction_post_is, '_trans_date', true);&nbsp;</div></li><li><div>      return floor(( time() - strtotime($transaction_time) ) / 3600) &gt; 72;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_express_docapture($order) {&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// ensure the authorization is still valid for capture</span></span></span></span>&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if ($this-&gt;has_authorization_expired($order_id)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($_POST['angelleye_paypal_capture_transaction_dropdown']) && !empty($_POST['angelleye_paypal_capture_transaction_dropdown'])) {&nbsp;</div></li><li><div>          $transaction_id = $_POST['angelleye_paypal_capture_transaction_dropdown'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $transaction_id = $old_wc ? get_post_meta($order_id, '_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_transaction_id', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_express_docapture', array($this, 'angelleye_wc_paypal_express_docapture'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;pfw_do_capture($order, $transaction_id, $order-&gt;get_total());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_pro_docapture($order) {&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// ensure the authorization is still valid for capture</span></span></span></span>&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if ($this-&gt;has_authorization_expired($order_id)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $transaction_id = $old_wc ? get_post_meta($order_id, '_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_transaction_id', true);&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_pro_docapture', array($this, 'angelleye_wc_paypal_pro_docapture'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;pfw_do_capture($order, $transaction_id, $order-&gt;get_total());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function pfw_do_capture($order, $transaction_id = null, $capture_total = null) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('DoCapture API call');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if($capture_total == null)&nbsp;</div></li><li><div>          $AMT = $this-&gt;get_amount_by_transaction_id($transaction_id);&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $AMT = $capture_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $AMT = self::round($AMT - $order-&gt;get_total_refunded());&nbsp;</div></li><li><div>      $DataArray = array(&nbsp;</div></li><li><div>          'AUTHORIZATIONID' =&gt; $transaction_id, &nbsp;</div></li><li><div>          'AMT' =&gt; $AMT, &nbsp;</div></li><li><div>          'CURRENCYCODE' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency(), &nbsp;</div></li><li><div>          'COMPLETETYPE' =&gt; 'NotComplete', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPalRequest = array(&nbsp;</div></li><li><div>          'DCFields' =&gt; $DataArray&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $do_capture_result = $this-&gt;paypal-&gt;DoCapture($PayPalRequest);&nbsp;</div></li><li><div>      $this-&gt;angelleye_write_request_response_api_log($do_capture_result);&nbsp;</div></li><li><div>      $ack = strtoupper($do_capture_result[&quot;ACK&quot;]);&nbsp;</div></li><li><div>      if ($ack == &quot;SUCCESS&quot; || $ack == &quot;SUCCESSWITHWARNING&quot;) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__('PayPal DoCapture', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                  ' ( Response Code: ' . $do_capture_result[&quot;ACK&quot;] . &quot;, &quot; .&nbsp;</div></li><li><div>                  ' DoCapture TransactionID: ' . $do_capture_result['TRANSACTIONID'] . ' )' .&nbsp;</div></li><li><div>                  ' Authorization ID: ' . $do_capture_result['AUTHORIZATIONID'] . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $order-&gt;add_order_note('Payment Action: DoCapture');&nbsp;</div></li><li><div>          $payerstatus_note = __('Payment Status: ', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>          $payerstatus_note .= ucfirst($do_capture_result['PAYMENTSTATUS']);&nbsp;</div></li><li><div>          $order-&gt;add_order_note($payerstatus_note);&nbsp;</div></li><li><div>          if ($do_capture_result['PAYMENTSTATUS'] == 'Completed') {&nbsp;</div></li><li><div>              $AUTHORIZATIONID = $this-&gt;get_post_by_title($transaction_id);&nbsp;</div></li><li><div>              if ($AUTHORIZATIONID != null) {&nbsp;</div></li><li><div>                  update_post_meta($AUTHORIZATIONID, 'PAYMENTSTATUS', $do_capture_result['PAYMENTSTATUS']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $payment_order_meta = array('_transaction_id' =&gt; $do_capture_result['TRANSACTIONID']);&nbsp;</div></li><li><div>          self::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>          self::angelleye_paypal_for_woocommerce_add_paypal_transaction($do_capture_result, $order, 'DoCapture');&nbsp;</div></li><li><div>          $this-&gt;angelleye_paypal_for_woocommerce_order_status_handler($order);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $ErrorCode = urldecode($do_capture_result[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>          $ErrorShortMsg = urldecode($do_capture_result[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>          $ErrorLongMsg = urldecode($do_capture_result[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>          $ErrorSeverityCode = urldecode($do_capture_result[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('PayPal DoCapture API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>          $order-&gt;add_order_note(__('PayPal DoCapture API call failed. ', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                  ' ( Detailed Error Message: ' . $ErrorLongMsg . &quot;, &quot; .&nbsp;</div></li><li><div>                  ' Short Error Message: ' . $ErrorShortMsg . ' )' .&nbsp;</div></li><li><div>                  ' Error Code: ' . $ErrorCode . ' )' .&nbsp;</div></li><li><div>                  ' Error Severity Code: ' . $ErrorSeverityCode . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $this-&gt;call_error_email_notifications($subject = 'DoCapture failed', $method_name = 'DoCapture', $resArray = $do_capture_result);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_express_dovoid($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// ensure the authorization is still valid for capture</span></span></span></span>&nbsp;</div></li><li><div>      if ($this-&gt;has_authorization_expired($order_id)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_express_dovoid', array($this, 'angelleye_wc_paypal_express_dovoid'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;call_do_void($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_pro_dovoid($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// ensure the authorization is still valid for capture</span></span></span></span>&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if ($this-&gt;has_authorization_expired($order_id)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_express_dovoid', array($this, 'angelleye_wc_paypal_pro_dovoid'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;call_do_void($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function call_do_void($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('DoVoid API call');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if (isset($_POST['angelleye_paypal_dovoid_transaction_dropdown']) && !empty($_POST['angelleye_paypal_dovoid_transaction_dropdown'])) {&nbsp;</div></li><li><div>          $transaction_id = $_POST['angelleye_paypal_dovoid_transaction_dropdown'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($transaction_id) && !empty($transaction_id)) {&nbsp;</div></li><li><div>          $DVFields = array(&nbsp;</div></li><li><div>              'authorizationid' =&gt; $transaction_id, &nbsp;</div></li><li><div>              'note' =&gt; '', &nbsp;</div></li><li><div>              'msgsubid' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $PayPalRequestData = array('DVFields' =&gt; $DVFields);&nbsp;</div></li><li><div>          $do_void_result = $this-&gt;paypal-&gt;DoVoid($PayPalRequestData);&nbsp;</div></li><li><div>          $this-&gt;angelleye_write_request_response_api_log($do_void_result);&nbsp;</div></li><li><div>          $ack = strtoupper($do_void_result[&quot;ACK&quot;]);&nbsp;</div></li><li><div>          if ($ack == &quot;SUCCESS&quot; || $ack == &quot;SUCCESSWITHWARNING&quot;) {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal DoVoid', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                      ' ( Response Code: ' . $do_void_result[&quot;ACK&quot;] . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' DoVoid AUTHORIZATIONID: ' . $do_void_result['AUTHORIZATIONID'] . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $this-&gt;angelleye_get_transactionDetails($do_void_result['AUTHORIZATIONID']);&nbsp;</div></li><li><div>              $payment_order_meta = array('_transaction_id' =&gt; $do_void_result['AUTHORIZATIONID']);&nbsp;</div></li><li><div>              self::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>              self::angelleye_paypal_for_woocommerce_add_paypal_transaction($do_void_result, $order, 'DoVoid');&nbsp;</div></li><li><div>              $this-&gt;angelleye_paypal_for_woocommerce_order_status_handler($order);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $ErrorCode = urldecode($do_void_result[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>              $ErrorShortMsg = urldecode($do_void_result[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorLongMsg = urldecode($do_void_result[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorSeverityCode = urldecode($do_void_result[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('PayPal DoVoid API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal DoVoid API call failed. ', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                      ' ( Detailed Error Message: ' . $ErrorLongMsg . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' Short Error Message: ' . $ErrorShortMsg . ' )' .&nbsp;</div></li><li><div>                      ' Error Code: ' . $ErrorCode . ' )' .&nbsp;</div></li><li><div>                      ' Error Severity Code: ' . $ErrorSeverityCode . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $this-&gt;call_error_email_notifications($subject = 'DoVoid failed', $method_name = 'DoVoid', $resArray = $do_void_result);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_express_doreauthorization($order) {&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $this-&gt;payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_express_doreauthorization', array($this, 'angelleye_wc_paypal_express_doreauthorization'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;call_do_reauthorization($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function call_do_reauthorization($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('DoReauthorization API call');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if (isset($_POST['angelleye_paypal_doreauthorization_transaction_dropdown']) && !empty($_POST['angelleye_paypal_doreauthorization_transaction_dropdown'])) {&nbsp;</div></li><li><div>          $transaction_id = $_POST['angelleye_paypal_doreauthorization_transaction_dropdown'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $AMT = $this-&gt;get_amount_by_transaction_id($transaction_id);&nbsp;</div></li><li><div>      if (isset($transaction_id) && !empty($transaction_id)) {&nbsp;</div></li><li><div>          $DRFields = array(&nbsp;</div></li><li><div>              'authorizationid' =&gt; $transaction_id, <span class="comment"><span class="comment">// Required. The value of a previously authorized transaction ID returned by PayPal.</span></span>&nbsp;</div></li><li><div>              'amt' =&gt; self::number_format($AMT), <span class="comment"><span class="comment">// Required. Must have two decimal places.  Decimal separator must be a period (.) and optional thousands separator must be a comma (, )</span></span>&nbsp;</div></li><li><div>              'currencycode' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency(), <span class="comment">// Three-character currency code.</span>&nbsp;</div></li><li><div>              'msgsubid' =&gt; ''      <span class="comment">// A message ID used for idempotence to uniquely identify a message.</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $PayPalRequestData = array('DRFields' =&gt; $DRFields);&nbsp;</div></li><li><div>          $do_reauthorization_result = $this-&gt;paypal-&gt;DoReauthorization($PayPalRequestData);&nbsp;</div></li><li><div>          $this-&gt;angelleye_write_request_response_api_log($do_reauthorization_result);&nbsp;</div></li><li><div>          $ack = strtoupper($do_reauthorization_result[&quot;ACK&quot;]);&nbsp;</div></li><li><div>          if ($ack == &quot;SUCCESS&quot; || $ack == &quot;SUCCESSWITHWARNING&quot;) {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal DoReauthorization', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                      ' ( Response Code: ' . $do_reauthorization_result[&quot;ACK&quot;] . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' DoReauthorization AUTHORIZATIONID: ' . $do_reauthorization_result['AUTHORIZATIONID'] . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $payment_order_meta = array('_transaction_id' =&gt; $do_reauthorization_result['AUTHORIZATIONID']);&nbsp;</div></li><li><div>              self::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>              self::angelleye_paypal_for_woocommerce_add_paypal_transaction($do_reauthorization_result, $order, 'DoReauthorization');&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $ErrorCode = urldecode($do_reauthorization_result[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>              $ErrorShortMsg = urldecode($do_reauthorization_result[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorLongMsg = urldecode($do_reauthorization_result[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorSeverityCode = urldecode($do_reauthorization_result[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('PayPal DoReauthorization API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal DoReauthorization API call failed. ', $this-&gt;plugin_name) .&nbsp;</div></li><li><div>                      ' ( Detailed Error Message: ' . $ErrorLongMsg . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' Short Error Message: ' . $ErrorShortMsg . ' )' .&nbsp;</div></li><li><div>                      ' Error Code: ' . $ErrorCode . ' )' .&nbsp;</div></li><li><div>                      ' Error Severity Code: ' . $ErrorSeverityCode . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $this-&gt;call_error_email_notifications($subject = 'DoReauthorization failed', $method_name = 'DoReauthorization', $resArray = $do_reauthorization_result);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_pro_doreauthorization($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_pro_doreauthorization', array($this, 'angelleye_wc_paypal_pro_doreauthorization'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;call_do_reauthorization($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $order</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function angelleye_wc_paypal_express_doauthorization($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      remove_action('woocommerce_order_action_wc_paypal_express_doauthorization', array($this, 'angelleye_wc_paypal_express_doauthorization'));&nbsp;</div></li><li><div>      remove_action('woocommerce_process_shop_order_meta', 'WC_Meta_Box_Order_Data::save', 40, 2);&nbsp;</div></li><li><div>      $this-&gt;call_do_authorization($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function call_do_authorization($order) {&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('DoAuthorization API call');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>      if (isset($transaction_id) && !empty($transaction_id)) {&nbsp;</div></li><li><div>          $DRFields = array(&nbsp;</div></li><li><div>              'TRANSACTIONID' =&gt; $transaction_id, <span class="comment"><span class="comment">// Required. The value of a previously authorized transaction ID returned by PayPal.</span></span>&nbsp;</div></li><li><div>              'AMT' =&gt; self::number_format($_POST['_regular_price']), <span class="comment"><span class="comment">// Required. Must have two decimal places.  Decimal separator must be a period (.) and optional thousands separator must be a comma (, )</span></span>&nbsp;</div></li><li><div>              'CURRENCYCODE' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $PayPalRequestData = array('DAFields' =&gt; $DRFields);&nbsp;</div></li><li><div>          $do_authorization_result = $this-&gt;paypal-&gt;DoAuthorization($PayPalRequestData);&nbsp;</div></li><li><div>          $this-&gt;angelleye_write_request_response_api_log($do_authorization_result);&nbsp;</div></li><li><div>          $ack = strtoupper($do_authorization_result[&quot;ACK&quot;]);&nbsp;</div></li><li><div>          if ($ack == &quot;SUCCESS&quot; || $ack == &quot;SUCCESSWITHWARNING&quot;) {&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal authorization', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                      ' ( Response Code: ' . $do_authorization_result[&quot;ACK&quot;] . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' DoAuthorization AUTHORIZATIONID: ' . $do_authorization_result['TRANSACTIONID'] . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $payment_order_meta = array('_transaction_id' =&gt; $do_authorization_result['TRANSACTIONID']);&nbsp;</div></li><li><div>              self::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>              self::angelleye_paypal_for_woocommerce_add_paypal_transaction($do_authorization_result, $order, 'DoAuthorization');&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $ErrorCode = urldecode($do_authorization_result[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>              $ErrorShortMsg = urldecode($do_authorization_result[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorLongMsg = urldecode($do_authorization_result[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>              $ErrorSeverityCode = urldecode($do_authorization_result[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('PayPal DoAuthorization API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>              $this-&gt;ec_add_log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>              $order-&gt;add_order_note(__('PayPal DoAuthorization API call failed. ', 'paypal-for-woocommerce') .&nbsp;</div></li><li><div>                      ' ( Detailed Error Message: ' . $ErrorLongMsg . &quot;, &quot; .&nbsp;</div></li><li><div>                      ' Short Error Message: ' . $ErrorShortMsg . ' )' .&nbsp;</div></li><li><div>                      ' Error Code: ' . $ErrorCode . ' )' .&nbsp;</div></li><li><div>                      ' Error Severity Code: ' . $ErrorSeverityCode . ' )'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $this-&gt;call_error_email_notifications($subject = 'DoAuthorization failed', $method_name = 'DoAuthorization', $resArray = $do_authorization_result);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function ec_add_log($message) {&nbsp;</div></li><li><div>      if ($this-&gt;ec_debug == 'yes') {&nbsp;</div></li><li><div>          if (empty($this-&gt;log)) {&nbsp;</div></li><li><div>              $this-&gt;log = new WC_Logger();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;log-&gt;add(str_replace(&quot;_&quot;, &quot;-&quot;, $this-&gt;payment_method) , $message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function call_error_email_notifications($subject = null, $method_name = null, $resArray = null) {&nbsp;</div></li><li><div>      if ((isset($resArray[&quot;L_ERRORCODE0&quot;]) && !empty($resArray[&quot;L_ERRORCODE0&quot;])) && ( isset($resArray[&quot;L_SHORTMESSAGE0&quot;]) && !empty($resArray[&quot;L_SHORTMESSAGE0&quot;]))) {&nbsp;</div></li><li><div>          $ErrorCode = urldecode($resArray[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>          $ErrorShortMsg = urldecode($resArray[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>          $ErrorLongMsg = urldecode($resArray[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>          $ErrorSeverityCode = urldecode($resArray[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__($method_name . ' API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>          $message = '';&nbsp;</div></li><li><div>          if ($this-&gt;error_email_notify) {&nbsp;</div></li><li><div>              $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>              $message .= __($method_name, &quot;paypal-for-woocommerce&quot;) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg . &quot;\n&quot;;&nbsp;</div></li><li><div>              $ofw_error_email_notify_mes = apply_filters('angelleye_error_email_notify_message', $message, $ErrorCode, $ErrorSeverityCode, $ErrorShortMsg, $ErrorLongMsg);&nbsp;</div></li><li><div>              $ofw_error_email_notify_subject = apply_filters('angelleye_error_email_notify_subject', $subject);&nbsp;</div></li><li><div>              wp_mail($admin_email, $ofw_error_email_notify_subject, $ofw_error_email_notify_mes);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ((isset($resArray[&quot;Errors&quot;][0]['ErrorID']) && !empty($resArray[&quot;Errors&quot;][0]['ErrorID'])) && ( isset($resArray[&quot;Errors&quot;][0]['Message']) && !empty($resArray[&quot;Errors&quot;][0]['Message']))) {&nbsp;</div></li><li><div>          $ErrorCode = $resArray[&quot;Errors&quot;][0]['ErrorID'];&nbsp;</div></li><li><div>          $ErrorShortMsg = $resArray[&quot;Errors&quot;][0]['Message'];&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__($method_name . ' API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>          $this-&gt;ec_add_log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>          $message = '';&nbsp;</div></li><li><div>          if ($this-&gt;error_email_notify) {&nbsp;</div></li><li><div>              $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>              $message .= __($method_name, &quot;paypal-for-woocommerce&quot;) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg . &quot;\n&quot;;&nbsp;</div></li><li><div>              $ofw_error_email_notify_mes = apply_filters('angelleye_error_email_notify_message', $message, $ErrorCode, $ErrorShortMsg);&nbsp;</div></li><li><div>              $ofw_error_email_notify_subject = apply_filters('angelleye_error_email_notify_subject', $subject);&nbsp;</div></li><li><div>              wp_mail($admin_email, $ofw_error_email_notify_subject, $ofw_error_email_notify_mes);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_woocommerce_payment_gateway_supports($boolean, $feature, $current) {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>      if( empty($post-&gt;ID) ) {&nbsp;</div></li><li><div>         return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $order_id = $post-&gt;ID;&nbsp;</div></li><li><div>      if (!is_object($order_id)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $payment_action = '';&nbsp;</div></li><li><div>      if ($current-&gt;id == 'paypal_express' || $current-&gt;id == 'paypal_pro') {&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $payment_action = $old_wc ? get_post_meta($order_id, '_payment_action', true) : get_post_meta($order-&gt;get_id(), '_payment_action', true);&nbsp;</div></li><li><div>          if ($payment_action == 'Sale' || $payment_action == 'DoCapture' || empty($payment_action)) {&nbsp;</div></li><li><div>              return $boolean;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $boolean;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_write_request_response_api_log($PayPalResult) {&nbsp;</div></li><li><div>      $PayPalRequest = isset($PayPalResult['RAWREQUEST']) ? $PayPalResult['RAWREQUEST'] : '';&nbsp;</div></li><li><div>      $PayPalResponse = isset($PayPalResult['RAWRESPONSE']) ? $PayPalResult['RAWRESPONSE'] : '';&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('Request: ' . print_r($this-&gt;paypal-&gt;NVPToArray($this-&gt;paypal-&gt;MaskAPIResult($PayPalRequest)), true));&nbsp;</div></li><li><div>      $this-&gt;ec_add_log('Response: ' . print_r($this-&gt;paypal-&gt;NVPToArray($this-&gt;paypal-&gt;MaskAPIResult($PayPalResponse)), true));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function angelleye_paypal_credit_card_rest_setting_fields() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable/Disable', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable PayPal Credit Card (REST)', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Title', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the title which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; __('PayPal Credit Card (REST)', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Description', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the description which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; __('PayPal Credit Card (REST) description', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testmode' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Test Mode', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable PayPal Sandbox/Test Mode', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'description' =&gt; sprintf(__('Place the payment gateway in development mode. Sign up for a developer account &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;', 'paypal-for-woocommerce'), 'https:<span class="comment">//developer.paypal.com/'), </span>&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'rest_client_id_sandbox' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Client ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; 'Enter your Sandbox PayPal Rest API Client ID', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'rest_secret_id_sandbox' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Secret ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Enter your Sandbox PayPal Rest API Secret ID.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'rest_client_id' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live Client ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; 'Enter your PayPal Rest API Client ID', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'rest_secret_id' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live Secret ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Enter your PayPal Rest API Secret ID.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_tokenized_payments' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Allow buyers to securely save payment details to their account for quick checkout / auto-ship orders in the future.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'class' =&gt; 'enable_tokenized_payments'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'invoice_prefix' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Invoice Prefix', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('Please enter a prefix for your invoice numbers. If you use your PayPal account for multiple stores ensure this prefix is unique as PayPal will not allow orders with the same invoice number.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'WC-PCCR', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'card_icon' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __( 'Card Icon', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; plugins_url('/assets/images/cards.png', plugin_basename(dirname(__FILE__))), &nbsp;</div></li><li><div>              'class' =&gt; 'button_upload'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'softdescriptor' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Credit Card Statement Name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('The value entered here will be displayed on the buyer\'s credit card statement.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'debug' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Debug Log', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable logging', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; sprintf(__('Log PayPal events, such as Secured Token requests, inside &lt;code&gt;%s&lt;/code&gt;', 'paypal-for-woocommerce'), wc_get_log_file_path('paypal_credit_card_rest')), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'is_encrypt' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'hidden', &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'class' =&gt; ''&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function card_type_from_account_number($account_number) {&nbsp;</div></li><li><div>      $types = array(&nbsp;</div></li><li><div>          'visa' =&gt; '/^4/', &nbsp;</div></li><li><div>          'mastercard' =&gt; '/^5[1-5]/', &nbsp;</div></li><li><div>          'amex' =&gt; '/^3[47]/', &nbsp;</div></li><li><div>          'discover' =&gt; '/^(6011|65|64[4-9]|622)/', &nbsp;</div></li><li><div>          'diners' =&gt; '/^(36|38|30[0-5])/', &nbsp;</div></li><li><div>          'jcb' =&gt; '/^35/', &nbsp;</div></li><li><div>          'maestro' =&gt; '/^(5018|5020|5038|6304|6759|676[1-3])/', &nbsp;</div></li><li><div>          'laser' =&gt; '/^(6706|6771|6709)/', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      foreach ($types as $type =&gt; $pattern) {&nbsp;</div></li><li><div>          if (1 === preg_match($pattern, $account_number)) {&nbsp;</div></li><li><div>              return $type;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function is_express_checkout_credentials_is_set() {&nbsp;</div></li><li><div>      $pp_settings = get_option('woocommerce_paypal_express_settings');&nbsp;</div></li><li><div>      $testmode = isset($pp_settings['testmode']) ? $pp_settings['testmode'] : 'yes';&nbsp;</div></li><li><div>      $enabled = (isset($pp_settings['enabled']) && $pp_settings['enabled'] == 'yes') ? 'yes' : 'no';&nbsp;</div></li><li><div>      if ($testmode == 'yes') {&nbsp;</div></li><li><div>          $api_username = isset($pp_settings['sandbox_api_username']) ? $pp_settings['sandbox_api_username'] : '';&nbsp;</div></li><li><div>          $api_password = isset($pp_settings['sandbox_api_password']) ? $pp_settings['sandbox_api_password'] : '';&nbsp;</div></li><li><div>          $api_signature = isset($pp_settings['sandbox_api_signature']) ? $pp_settings['sandbox_api_signature'] : '';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $api_username = isset($pp_settings['api_username']) ? $pp_settings['api_username'] : '';&nbsp;</div></li><li><div>          $api_password = isset($pp_settings['api_password']) ? $pp_settings['api_password'] : '';&nbsp;</div></li><li><div>          $api_signature = isset($pp_settings['api_signature']) ? $pp_settings['api_signature'] : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ('yes' != $enabled) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$api_username || !$api_password || !$api_signature) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function paypal_for_woocommerce_paypal_transaction_history() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (post_type_exists('paypal_transaction')) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action('paypal_for_woocommerce_register_post_type');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      register_post_type('paypal_transaction', apply_filters('paypal_for_woocommerce_register_post_type_paypal_transaction_history', array(&nbsp;</div></li><li><div>          'labels' =&gt; array(&nbsp;</div></li><li><div>              'name' =&gt; __('PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'singular_name' =&gt; __('PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'menu_name' =&gt; _x('PayPal Transaction', 'Admin menu name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'add_new' =&gt; __('Add PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'add_new_item' =&gt; __('Add New PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'edit' =&gt; __('Edit', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'edit_item' =&gt; __('View PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'new_item' =&gt; __('New PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'view' =&gt; __('View PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'view_item' =&gt; __('View PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'search_items' =&gt; __('Search PayPal Transaction', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'not_found' =&gt; __('No PayPal Transaction found', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'not_found_in_trash' =&gt; __('No PayPal Transaction found in trash', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'parent' =&gt; __('Parent PayPal Transaction', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; __('This is where you can add new PayPal Transaction to your store.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>          'public' =&gt; false, &nbsp;</div></li><li><div>          'show_ui' =&gt; false, &nbsp;</div></li><li><div>          'capability_type' =&gt; 'post', &nbsp;</div></li><li><div>          'capabilities' =&gt; array(&nbsp;</div></li><li><div>              'create_posts' =&gt; false, <span class="comment">// Removes support for the &quot;Add New&quot; function</span>&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'map_meta_cap' =&gt; true, &nbsp;</div></li><li><div>          'publicly_queryable' =&gt; true, &nbsp;</div></li><li><div>          'exclude_from_search' =&gt; false, &nbsp;</div></li><li><div>          'hierarchical' =&gt; false, <span class="comment">// Hierarchical causes memory issues - WP loads all records!</span>&nbsp;</div></li><li><div>          'rewrite' =&gt; array('slug' =&gt; 'paypal_ipn'), &nbsp;</div></li><li><div>          'query_var' =&gt; true, &nbsp;</div></li><li><div>          'supports' =&gt; array('', ''), &nbsp;</div></li><li><div>          'has_archive' =&gt; true, &nbsp;</div></li><li><div>          'show_in_nav_menus' =&gt; FALSE&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_paypal_for_woocommerce_order_action_meta_box($post_type, $post) {&nbsp;</div></li><li><div>      if (isset($post-&gt;ID) && !empty($post-&gt;ID) && $post_type == 'shop_order') {&nbsp;</div></li><li><div>          if ($this-&gt;angelleye_is_display_paypal_transaction_details($post-&gt;ID)) {&nbsp;</div></li><li><div>              add_meta_box('angelleye-pw-order-action', __('PayPal Transaction History', 'paypal-for-woocommerce'), array($this, 'angelleye_paypal_for_woocommerce_order_action_callback'), 'shop_order', 'normal', 'high', null);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_paypal_for_woocommerce_order_action_callback($post) {&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>              'post_type' =&gt; 'paypal_transaction', &nbsp;</div></li><li><div>              'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>              'meta_key' =&gt; 'order_id', &nbsp;</div></li><li><div>              'meta_value' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>              'order' =&gt; 'ASC', &nbsp;</div></li><li><div>              'post_status' =&gt; 'any'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $posts_array = get_posts($args);&nbsp;</div></li><li><div>          foreach ($posts_array as $post_data):&nbsp;</div></li><li><div>              $payment_status = get_post_meta($post_data-&gt;ID, 'PAYMENTSTATUS', true);&nbsp;</div></li><li><div>              if( isset($post-&gt;post_title) && !empty($post_data-&gt;post_title) && isset($payment_status) && $payment_status == 'Pending' ) {&nbsp;</div></li><li><div>                  $this-&gt;angelleye_get_transactionDetails($post_data-&gt;post_title);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          endforeach;&nbsp;</div></li><li><div>          $order = wc_get_order($post-&gt;ID);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if (empty($this-&gt;angelleye_woocommerce_order_actions)) {&nbsp;</div></li><li><div>          $this-&gt;angelleye_woocommerce_order_actions = $this-&gt;angelleye_woocommerce_order_actions();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class='wrap'&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          if (isset($this-&gt;angelleye_woocommerce_order_actions) && !empty($this-&gt;angelleye_woocommerce_order_actions)) {&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;select name=&quot;angelleye_payment_action&quot; id=&quot;angelleye_payment_action&quot;&gt; &nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $i = 0;&nbsp;</div></li><li><div>                  foreach ($this-&gt;angelleye_woocommerce_order_actions as $k =&gt; $v) :&nbsp;</div></li><li><div>                      if ($i == 0) {&nbsp;</div></li><li><div>                          echo '&lt;option value=&quot;&quot; &gt;Select Action&lt;/option&gt;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;option value=&quot;&lt;?php echo esc_attr($k); ?&gt;&quot; &gt;&lt;?php echo esc_html($v); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                      $i = $i + 1;&nbsp;</div></li><li><div>                  endforeach;&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/select&gt; &nbsp;</div></li><li><div>              &lt;div class=&quot;angelleye_authorization_box&quot; style=&quot;display: none;&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  if (isset($this-&gt;remain_authorize_amount)) {&nbsp;</div></li><li><div>                      $remain_authorize_amount_text = 'less than ' . $this-&gt;remain_authorize_amount;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $remain_authorize_amount_text = '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;input type=&quot;text&quot; placeholder=&quot;Enter amount &lt;?php echo $remain_authorize_amount_text; ?&gt;&quot; id=&quot;_regular_price&quot; name=&quot;_regular_price&quot; class=&quot;short wc_input_price text-box&quot; style=&quot;width: 220px&quot;&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php $this-&gt;angelleye_express_checkout_transaction_capture_dropdownbox($post-&gt;ID); ?&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;submit&quot; id=&quot;angelleye_payment_submit_button&quot; value=&quot;Submit&quot; name=&quot;save&quot; class=&quot;button button-primary&quot; style=&quot;display: none&quot;&gt;&nbsp;</div></li><li><div>              &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>              &lt;script&gt;&nbsp;</div></li><li><div>              (function($) {&nbsp;</div></li><li><div>                  &quot;use strict&quot;;&nbsp;</div></li><li><div>                  &nbsp;</div></li><li><div>                  <span class="comment">//Asking confirm for the capture</span>&nbsp;</div></li><li><div>                  $('#angelleye_payment_submit_button').on('click', function() {&nbsp;</div></li><li><div>                      var selected = $('#angelleye_payment_action option:checked').val();&nbsp;</div></li><li><div>                      if(selected == 'DoCapture') {&nbsp;</div></li><li><div>                          var amt = $('.angelleye_order_action_table:first tr:first td:last').text();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          return confirm('You are capturing: ' + amt + '. Are you sure?');&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  })&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  MutationObserver = window.MutationObserver || window.WebKitMutationObserver;&nbsp;</div></li><li><div>                  var observer = new MutationObserver(function(mutations, observer) {&nbsp;</div></li><li><div>                      var currency_symbol = window.woocommerce_admin_meta_boxes.currency_format_symbol;&nbsp;</div></li><li><div>                      &nbsp;</div></li><li><div>                      for(var i = 0, len = mutations.length; i &lt; len; i++) {&nbsp;</div></li><li><div>                          <span class="comment">//Updating the total order action table field</span>&nbsp;</div></li><li><div>                          if(mutations[i].target.className == 'inside' && mutations[i].addedNodes.length &gt; 0) {&nbsp;</div></li><li><div>                              var new_amt_with_curr = $('.wc-order-refund-items .wc-order-totals tr td.total .amount:last').text();&nbsp;</div></li><li><div>                              <span class="comment">//Adjusting price with paypal-for-woocommerce amount format</span>&nbsp;</div></li><li><div>                              new_amt_with_curr = currency_symbol + new_amt_with_curr.replace(currency_symbol, '');&nbsp;</div></li><li><div>                              $('.angelleye_order_action_table:first tr:first td:last').text(new_amt_with_curr);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//Setting an observer to know about total new total amount</span>&nbsp;</div></li><li><div>                  $(document).ready(function () {&nbsp;</div></li><li><div>                      var target = document.getElementById('woocommerce-order-items').getElementsByClassName('inside')[0];&nbsp;</div></li><li><div>                      observer.observe(target, {&nbsp;</div></li><li><div>                          childList: true, &nbsp;</div></li><li><div>                      });&nbsp;</div></li><li><div>                  });&nbsp;</div></li><li><div>              })(jQuery);&nbsp;</div></li><li><div>              &lt;/script&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;widefat angelleye_order_action_table&quot; style=&quot;width: 190px;float: right;&quot;&gt;&nbsp;</div></li><li><div>              &lt;tbody&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&lt;?php echo __('Order Total:', 'paypal-for-woocommerce'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&lt;?php echo $order-&gt;get_formatted_order_total(); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&lt;?php echo __('Total Capture:', 'paypal-for-woocommerce'); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                      &lt;td&gt;&lt;?php echo $this-&gt;total_DoCapture .' '. get_woocommerce_currency_symbol() ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/tbody&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>          &lt;br/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;widefat angelleye_order_action_table&quot;&gt;&nbsp;</div></li><li><div>              &lt;thead&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Transaction ID', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Date', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;       &nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Amount', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Payment Status', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Payment Action', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/thead&gt;&nbsp;</div></li><li><div>              &lt;tfoot&gt;&nbsp;</div></li><li><div>                  &lt;tr&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Transaction ID', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Date', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;       &nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Amount', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Payment Status', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                      &lt;th&gt;&lt;?php echo __('Payment Action', 'paypal-for-woocommerce'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                  &lt;/tr&gt;&nbsp;</div></li><li><div>              &lt;/tfoot&gt;&nbsp;</div></li><li><div>              &lt;tbody&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  foreach ($posts_array as $post):&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;tr&gt;&nbsp;</div></li><li><div>                          &lt;td&gt;&lt;?php echo $post-&gt;post_title; ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;td&gt;&lt;?php echo esc_attr(get_post_meta($post-&gt;ID, 'TIMESTAMP', true)); ?&gt;&lt;/th&gt;       &nbsp;</div></li><li><div>                          &lt;td&gt;&lt;?php echo esc_attr(get_post_meta($post-&gt;ID, 'AMT', true)) .' '. get_woocommerce_currency_symbol(); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;?php $PENDINGREASON = esc_attr(get_post_meta($post-&gt;ID, 'PENDINGREASON', true)); ?&gt;&nbsp;</div></li><li><div>                          &lt;td &lt;?php echo ($PENDINGREASON) ? sprintf('title=&quot;%s&quot;', $PENDINGREASON) : &quot;&quot;; ?&gt; &gt;&lt;?php echo esc_attr(get_post_meta($post-&gt;ID, 'PAYMENTSTATUS', true)); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                          &lt;td&gt;&lt;?php echo esc_attr(get_post_meta($post-&gt;ID, 'payment_action', true)); ?&gt; &lt;/td&gt;&nbsp;</div></li><li><div>                      &lt;/tr&gt;&nbsp;</div></li><li><div>                      &lt;?php&nbsp;</div></li><li><div>                  endforeach;&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/tbody&gt;&nbsp;</div></li><li><div>          &lt;/table&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function angelleye_paypal_for_woocommerce_add_paypal_transaction($response, $order, $payment_action) {&nbsp;</div></li><li><div>      if ($payment_action == 'Authorization') {&nbsp;</div></li><li><div>          $payment_action = 'DoAuthorization';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $TRANSACTIONID = '';&nbsp;</div></li><li><div>      if (isset($response['PAYMENTINFO_0_TRANSACTIONID']) && !empty($response['PAYMENTINFO_0_TRANSACTIONID'])) {&nbsp;</div></li><li><div>          $TRANSACTIONID = $response['PAYMENTINFO_0_TRANSACTIONID'];&nbsp;</div></li><li><div>      } elseif (isset($response['TRANSACTIONID']) && !empty($response['TRANSACTIONID'])) {&nbsp;</div></li><li><div>          $TRANSACTIONID = $response['TRANSACTIONID'];&nbsp;</div></li><li><div>      } elseif (isset($response['AUTHORIZATIONID'])) {&nbsp;</div></li><li><div>          $TRANSACTIONID = $response['AUTHORIZATIONID'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $insert_paypal_transaction = array(&nbsp;</div></li><li><div>          'ID' =&gt; '', &nbsp;</div></li><li><div>          'post_type' =&gt; 'paypal_transaction', &nbsp;</div></li><li><div>          'post_status' =&gt; $payment_action, &nbsp;</div></li><li><div>          'post_title' =&gt; $TRANSACTIONID, &nbsp;</div></li><li><div>          'post_parent' =&gt; $order_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      unset($response['ERRORS']);&nbsp;</div></li><li><div>      unset($response['REQUESTDATA']);&nbsp;</div></li><li><div>      unset($response['RAWREQUEST']);&nbsp;</div></li><li><div>      unset($response['RAWRESPONSE']);&nbsp;</div></li><li><div>      unset($response['PAYMENTS']);&nbsp;</div></li><li><div>      $post_id = wp_insert_post($insert_paypal_transaction);&nbsp;</div></li><li><div>      $response['order_id'] = $order_id;&nbsp;</div></li><li><div>      $response['payment_action'] = $payment_action;&nbsp;</div></li><li><div>      $response['_trans_date'] = current_time('mysql');&nbsp;</div></li><li><div>      update_post_meta($post_id, 'paypal_transaction', $response);&nbsp;</div></li><li><div>      foreach ($response as $metakey =&gt; $metavalue) {&nbsp;</div></li><li><div>          $metakey = str_replace('PAYMENTINFO_0_', '', $metakey);&nbsp;</div></li><li><div>          update_post_meta($post_id, $metakey, $metavalue);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($payment_action == 'DoVoid') {&nbsp;</div></li><li><div>          $post_id_value = self::get_post_id_by_meta_key_and_meta_value('TRANSACTIONID', $response['AUTHORIZATIONID']);&nbsp;</div></li><li><div>          $AMT = get_post_meta($post_id_value, 'AMT', true);&nbsp;</div></li><li><div>          update_post_meta($post_id, 'AMT', $AMT);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_post_id_by_meta_key_and_meta_value($key, $value) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $post_id_value = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT post_id FROM {$wpdb-&gt;postmeta} WHERE `meta_key` LIKE '%s' AND `meta_value` LIKE '%s'&quot;, $key, $value));&nbsp;</div></li><li><div>      return $post_id_value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save($post_id, $post) {&nbsp;</div></li><li><div>      $order = wc_get_order($post_id);&nbsp;</div></li><li><div>      if (empty($this-&gt;payment_method)) {&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>          $this-&gt;payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!empty($_POST['angelleye_payment_action'])) {&nbsp;</div></li><li><div>          $action = wc_clean($_POST['angelleye_payment_action']);&nbsp;</div></li><li><div>          $hook_name = 'wc_' . $this-&gt;payment_method . '_' . strtolower($action);&nbsp;</div></li><li><div>          if (!did_action('woocommerce_order_action_' . sanitize_title($hook_name))) {&nbsp;</div></li><li><div>              do_action('woocommerce_order_action_' . sanitize_title($hook_name), $order);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_total($action, $status, $order_id) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      if ($action == 'DoVoid') {&nbsp;</div></li><li><div>          $total = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>          SELECT SUM( postmeta.meta_value )&nbsp;</div></li><li><div>          FROM $wpdb-&gt;postmeta AS postmeta&nbsp;</div></li><li><div>          INNER JOIN $wpdb-&gt;posts AS posts ON ( posts.post_type = 'paypal_transaction' AND posts.post_status LIKE '%s' AND post_parent = %d )&nbsp;</div></li><li><div>          WHERE postmeta.meta_key = 'AMT' &nbsp;</div></li><li><div>          AND postmeta.post_id = posts.ID LIMIT 0, 99&nbsp;</div></li><li><div>      &quot;, $action, $order_id));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ($action == 'DoCapture') {&nbsp;</div></li><li><div>              $total = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>                          SELECT SUM( postmeta.meta_value )&nbsp;</div></li><li><div>                          FROM $wpdb-&gt;postmeta AS postmeta&nbsp;</div></li><li><div>                          JOIN $wpdb-&gt;postmeta pm2 ON pm2.post_id = postmeta.post_id&nbsp;</div></li><li><div>                          INNER JOIN $wpdb-&gt;posts AS posts ON ( posts.post_type = 'paypal_transaction' AND posts.post_status LIKE '%s' AND post_parent = %d )&nbsp;</div></li><li><div>                          WHERE postmeta.meta_key = 'AMT' AND pm2.meta_key = 'PAYMENTSTATUS' AND (pm2.meta_value LIKE '%s' OR pm2.meta_value LIKE 'Pending')&nbsp;</div></li><li><div>                          AND postmeta.post_id = posts.ID LIMIT 0, 99&nbsp;</div></li><li><div>                  &quot;, $action, $order_id, $status));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $total = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>                          SELECT SUM( postmeta.meta_value )&nbsp;</div></li><li><div>                          FROM $wpdb-&gt;postmeta AS postmeta&nbsp;</div></li><li><div>                          JOIN $wpdb-&gt;postmeta pm2 ON pm2.post_id = postmeta.post_id&nbsp;</div></li><li><div>                          INNER JOIN $wpdb-&gt;posts AS posts ON ( posts.post_type = 'paypal_transaction' AND posts.post_status LIKE '%s' AND post_parent = %d )&nbsp;</div></li><li><div>                          WHERE postmeta.meta_key = 'AMT' AND pm2.meta_key = 'PAYMENTSTATUS' AND pm2.meta_value LIKE '%s'&nbsp;</div></li><li><div>                          AND postmeta.post_id = posts.ID LIMIT 0, 99&nbsp;</div></li><li><div>                  &quot;, $action, $order_id, $status));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($total == NULL) {&nbsp;</div></li><li><div>          $total = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::number_format($total);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_paypal_for_woocommerce_order_status_handler($order) {&nbsp;</div></li><li><div>      $this-&gt;angelleye_woocommerce_order_actions = $this-&gt;angelleye_woocommerce_order_actions();&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $_first_transaction_id = $old_wc ? get_post_meta($order_id, '_first_transaction_id', true) : get_post_meta($order-&gt;get_id(), '_first_transaction_id', true);&nbsp;</div></li><li><div>      if( empty($_first_transaction_id) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;angelleye_get_transactionDetails($_first_transaction_id);&nbsp;</div></li><li><div>      $_payment_action = $old_wc ? get_post_meta($order_id, '_payment_action', true) : get_post_meta($order-&gt;get_id(), '_payment_action', true);&nbsp;</div></li><li><div>      if (isset($_payment_action) && !empty($_payment_action) && $_payment_action == 'Order') {&nbsp;</div></li><li><div>          if (($this-&gt;max_authorize_amount &lt;= $this-&gt;total_DoVoid) || ($this-&gt;total_Pending_DoAuthorization == 0 && $this-&gt;total_Completed_DoAuthorization == 0 && $this-&gt;total_DoVoid == $order-&gt;get_total())) {&nbsp;</div></li><li><div>              $order-&gt;update_status('cancelled');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($order-&gt;get_total() - $order-&gt;get_total_refunded() &lt;= $this-&gt;total_Completed_DoAuthorization && $this-&gt;total_Pending_DoAuthorization == 0) {&nbsp;</div></li><li><div>              do_action('woocommerce_order_status_pending_to_processing', $order_id);&nbsp;</div></li><li><div>              $order-&gt;payment_complete($_first_transaction_id);&nbsp;</div></li><li><div>              do_action('woocommerce_checkout_order_processed', $order_id, $posted = array());&nbsp;</div></li><li><div>              if ($old_wc) {&nbsp;</div></li><li><div>              $order-&gt;reduce_order_stock();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wc_reduce_stock_levels($order-&gt;get_id());&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>      if ($order-&gt;get_total() == $this-&gt;total_DoVoid) {&nbsp;</div></li><li><div>          $order-&gt;update_status('cancelled');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_express_checkout_transaction_capture_dropdownbox($post_id) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $order = wc_get_order($post_id);&nbsp;</div></li><li><div>      wp_reset_postdata();&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $payment_action = $old_wc ? get_post_meta($order_id, '_payment_action', true) : get_post_meta($order-&gt;get_id(), '_payment_action', true);&nbsp;</div></li><li><div>      if ($this-&gt;total_DoCapture == 0 && $this-&gt;total_Pending_DoAuthorization == 0) {&nbsp;</div></li><li><div>          if ('Order' == $payment_action) {&nbsp;</div></li><li><div>              $post_status = 'Order';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $post_status = 'DoAuthorization';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_status = 'DoAuthorization';&nbsp;</div></li><li><div>      } &nbsp;</div></li><li><div>      if ($this-&gt;total_Completed_DoAuthorization &lt; $this-&gt;total_Order || $this-&gt;total_Pending_DoAuthorization &gt; 0) {&nbsp;</div></li><li><div>          $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;posts.post_title FROM $wpdb-&gt;posts INNER JOIN $wpdb-&gt;postmeta ON ( $wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id ) WHERE 1=1 AND $wpdb-&gt;posts.post_status LIKE '%s' AND $wpdb-&gt;posts.post_parent = %d AND ( ( $wpdb-&gt;postmeta.meta_key = 'PAYMENTSTATUS' AND CAST($wpdb-&gt;postmeta.meta_value AS CHAR) = 'Pending' ) ) AND $wpdb-&gt;posts.post_type = 'paypal_transaction' GROUP BY $wpdb-&gt;posts.ID ORDER BY $wpdb-&gt;posts.post_date DESC LIMIT 0, 99&quot;, $post_status, $order_id), ARRAY_A);&nbsp;</div></li><li><div>          if (empty($posts)) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;select name=&quot;angelleye_paypal_capture_transaction_dropdown&quot; id=&quot;angelleye_paypal_capture_transaction_dropdown&quot; style=&quot;display: none&quot;&gt; &nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              $i = 0;&nbsp;</div></li><li><div>              foreach ($posts as $post):&nbsp;</div></li><li><div>                  if ($i == 0) {&nbsp;</div></li><li><div>                      echo '&lt;option value=&quot;&quot; &gt;Select Transaction ID&lt;/option&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;option value=&quot;&lt;?php echo esc_attr($post['post_title']); ?&gt;&quot; &gt;&lt;?php echo esc_html($post['post_title']); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $i = $i + 1;&nbsp;</div></li><li><div>              endforeach;&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/select&gt;  &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($this-&gt;total_Completed_DoAuthorization == $this-&gt;total_DoCapture && $this-&gt;total_DoCapture &gt; 0) || $this-&gt;total_Pending_DoAuthorization &gt;= 0) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;select name=&quot;angelleye_paypal_dovoid_transaction_dropdown&quot; id=&quot;angelleye_paypal_dovoid_transaction_dropdown&quot; style=&quot;display: none&quot;&gt; &nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              $i = 0;&nbsp;</div></li><li><div>              if (empty($posts)) {&nbsp;</div></li><li><div>              $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;posts.post_title FROM $wpdb-&gt;posts INNER JOIN $wpdb-&gt;postmeta ON ( $wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id ) WHERE 1=1 AND $wpdb-&gt;posts.post_status LIKE '%s' AND $wpdb-&gt;posts.post_parent = %d AND ( ( $wpdb-&gt;postmeta.meta_key = 'PAYMENTSTATUS' AND CAST($wpdb-&gt;postmeta.meta_value AS CHAR) = 'Pending' ) ) AND $wpdb-&gt;posts.post_type = 'paypal_transaction' GROUP BY $wpdb-&gt;posts.ID ORDER BY $wpdb-&gt;posts.post_date DESC LIMIT 0, 99&quot;, $post_status, $order_id), ARRAY_A);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              foreach ($posts as $post):&nbsp;</div></li><li><div>                  if ($i == 0) {&nbsp;</div></li><li><div>                      echo '&lt;option value=&quot;&quot; &gt;Select Transaction ID&lt;/option&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;option value=&quot;&lt;?php echo esc_attr($post['post_title']); ?&gt;&quot; &gt;&lt;?php echo esc_html($post['post_title']); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $i = $i + 1;&nbsp;</div></li><li><div>              endforeach;&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/select&gt;  &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($this-&gt;total_Completed_DoAuthorization == $this-&gt;total_DoCapture && $this-&gt;total_DoCapture &gt; 0) || $this-&gt;total_Pending_DoAuthorization &gt;= 0) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;select name=&quot;angelleye_paypal_doreauthorization_transaction_dropdown&quot; id=&quot;angelleye_paypal_doreauthorization_transaction_dropdown&quot; style=&quot;display: none&quot;&gt; &nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>              $i = 0;&nbsp;</div></li><li><div>              if (empty($posts)) {&nbsp;</div></li><li><div>              $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;posts.post_title FROM $wpdb-&gt;posts INNER JOIN $wpdb-&gt;postmeta ON ( $wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id ) WHERE 1=1 AND $wpdb-&gt;posts.post_status LIKE '%s' AND $wpdb-&gt;posts.post_parent = %d AND ( ( $wpdb-&gt;postmeta.meta_key = 'PAYMENTSTATUS' AND CAST($wpdb-&gt;postmeta.meta_value AS CHAR) = 'Pending' ) ) AND $wpdb-&gt;posts.post_type = 'paypal_transaction' GROUP BY $wpdb-&gt;posts.ID ORDER BY $wpdb-&gt;posts.post_date DESC LIMIT 0, 99&quot;, $post_status, $order_id), ARRAY_A);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              foreach ($posts as $post):&nbsp;</div></li><li><div>                  if ($i == 0) {&nbsp;</div></li><li><div>                      echo '&lt;option value=&quot;&quot; &gt;Select Transaction ID&lt;/option&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;option value=&quot;&lt;?php echo esc_attr($post['post_title']); ?&gt;&quot; &gt;&lt;?php echo esc_html($post['post_title']); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $i = $i + 1;&nbsp;</div></li><li><div>              endforeach;&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/select&gt;  &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_get_transactionDetails($transaction_id) {&nbsp;</div></li><li><div>      if( empty($this-&gt;payment_method) && $this-&gt;payment_method == false) {&nbsp;</div></li><li><div>          $this-&gt;angelleye_set_payment_method_using_transaction_id($transaction_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;add_ec_angelleye_paypal_php_library();&nbsp;</div></li><li><div>      $GTDFields = array(&nbsp;</div></li><li><div>          'transactionid' =&gt; $transaction_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPalRequestData = array('GTDFields' =&gt; $GTDFields);&nbsp;</div></li><li><div>      $get_transactionDetails_result = $this-&gt;paypal-&gt;GetTransactionDetails($PayPalRequestData);&nbsp;</div></li><li><div>      $this-&gt;angelleye_write_request_response_api_log($get_transactionDetails_result);&nbsp;</div></li><li><div>      $ack = strtoupper($get_transactionDetails_result[&quot;ACK&quot;]);&nbsp;</div></li><li><div>      if ($ack == &quot;SUCCESS&quot; || $ack == &quot;SUCCESSWITHWARNING&quot;) {&nbsp;</div></li><li><div>          $AUTHORIZATIONID = $this-&gt;get_post_by_title($transaction_id);&nbsp;</div></li><li><div>          if ($AUTHORIZATIONID != null) {&nbsp;</div></li><li><div>              update_post_meta($AUTHORIZATIONID, 'PAYMENTSTATUS', $get_transactionDetails_result['PAYMENTSTATUS']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_post_by_title($page_title) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $post = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = %s AND post_type='paypal_transaction'&quot;, $page_title));&nbsp;</div></li><li><div>      if ($post) {&nbsp;</div></li><li><div>          return $post;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_amount_by_transaction_id($transaction_id) {&nbsp;</div></li><li><div>      $meta_post_id = self::get_post_id_by_meta_key_and_meta_value('TRANSACTIONID', $transaction_id);&nbsp;</div></li><li><div>      $AMT = get_post_meta($meta_post_id, 'AMT', true);&nbsp;</div></li><li><div>      return self::number_format($AMT);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_max_authorize_amount($order_id) {&nbsp;</div></li><li><div>      if (!is_object($order_id)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $percentage = 115;&nbsp;</div></li><li><div>          $new_percentage_amount = self::round(($percentage / 100) * $order-&gt;get_total());&nbsp;</div></li><li><div>          $diff_percentage_amount = self::round($new_percentage_amount - $order-&gt;get_total());&nbsp;</div></li><li><div>      if ($diff_percentage_amount &gt; 75) {&nbsp;</div></li><li><div>              $max_authorize_amount = self::round($order-&gt;get_total() + 75);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $max_authorize_amount = $new_percentage_amount;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;max_authorize_amount = self::number_format($max_authorize_amount);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_remain_authorize_amount() {&nbsp;</div></li><li><div>      $this-&gt;remain_authorize_amount = self::number_format($this-&gt;max_authorize_amount - ( self::round($this-&gt;total_Pending_DoAuthorization + $this-&gt;total_Completed_DoAuthorization)));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function currency_has_decimals($currency) {&nbsp;</div></li><li><div>      if (in_array($currency, array('HUF', 'JPY', 'TWD'))) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function round($price) {&nbsp;</div></li><li><div>      $precision = 2;&nbsp;</div></li><li><div>      if (!self::currency_has_decimals(get_woocommerce_currency())) {&nbsp;</div></li><li><div>          $precision = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return round($price, $precision);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @since    1.1.8.1</span>&nbsp;</div></li><li><div><span class="comment">   * Non-decimal currency bug..?? #384 </span>&nbsp;</div></li><li><div><span class="comment">   * Round prices</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $price</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function number_format($price) {&nbsp;</div></li><li><div>      $decimals = 2;&nbsp;</div></li><li><div>      if (!self::currency_has_decimals(get_woocommerce_currency())) {&nbsp;</div></li><li><div>          $decimals = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return number_format($price, $decimals, '.', '');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_is_display_paypal_transaction_details($post_id) {&nbsp;</div></li><li><div>      $order = wc_get_order($post_id);&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $_payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>      $_payment_action = $old_wc ? get_post_meta($order_id, '_payment_action', true) : get_post_meta($order-&gt;get_id(), '_payment_action', true);&nbsp;</div></li><li><div>      if (isset($_payment_method) && !empty($_payment_method) && isset($_payment_action) && !empty($_payment_action)) {&nbsp;</div></li><li><div>          if (($_payment_method == 'paypal_pro' || $_payment_method == 'paypal_express') && $_payment_method != &quot;Sale&quot;) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function is_valid_for_use_paypal_express() {&nbsp;</div></li><li><div>  return in_array( get_woocommerce_currency(), apply_filters( 'woocommerce_paypal_express_supported_currencies', array( 'AUD', 'BRL', 'CAD', 'MXN', 'NZD', 'HKD', 'SGD', 'USD', 'EUR', 'JPY', 'NOK', 'CZK', 'DKK', 'HUF', 'ILS', 'MYR', 'PHP', 'PLN', 'SEK', 'CHF', 'TWD', 'THB', 'GBP' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_set_payment_method() {&nbsp;</div></li><li><div>      if( empty($this-&gt;payment_method) || $this-&gt;payment_method == false) {&nbsp;</div></li><li><div>          global $post;&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          $order = wc_get_order($post-&gt;ID);&nbsp;</div></li><li><div>          $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>          $this-&gt;payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_set_payment_method_using_transaction_id($transaction) {&nbsp;</div></li><li><div>      if( empty($this-&gt;payment_method) || $this-&gt;payment_method == false) {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          $results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT post_id FROM {$wpdb-&gt;prefix}postmeta WHERE meta_value = %s ORDER BY meta_id&quot;, $transaction ));&nbsp;</div></li><li><div>          if( !empty($results[0]-&gt;post_id) ) {&nbsp;</div></li><li><div>              $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>              $order = wc_get_order($results[0]-&gt;post_id);&nbsp;</div></li><li><div>              $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>              $this-&gt;payment_method = $old_wc ? get_post_meta($order_id, '_payment_method', true) : get_post_meta($order-&gt;get_id(), '_payment_method', true);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public static function crypting( $string, $action = 'e' ) {&nbsp;</div></li><li><div>      $secret_key = AUTH_SALT;&nbsp;</div></li><li><div>      $secret_iv = SECURE_AUTH_SALT;&nbsp;</div></li><li><div>      $output = false;&nbsp;</div></li><li><div>      $encrypt_method = &quot;AES-256-CBC&quot;;&nbsp;</div></li><li><div>      $key = hash( 'sha256', $secret_key );&nbsp;</div></li><li><div>      $iv = substr( hash( 'sha256', $secret_iv ), 0, 16 );&nbsp;</div></li><li><div>      if( $action == 'e' ) {&nbsp;</div></li><li><div>          $output = base64_encode( openssl_encrypt( $string, $encrypt_method, $key, 0, $iv ) );&nbsp;</div></li><li><div>          } else if ($action == 'd') {&nbsp;</div></li><li><div>          $output = openssl_decrypt( base64_decode( $string ), $encrypt_method, $key, 0, $iv );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_paypal_for_woocommerce_billing_agreement_details($order) {&nbsp;</div></li><li><div>      if (!is_object($order)) {&nbsp;</div></li><li><div>          $order = wc_get_order($order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $billing_agreement_id = $old_wc ? get_post_meta($order_id, 'BILLINGAGREEMENTID', true) : get_post_meta($order-&gt;get_id(), 'BILLINGAGREEMENTID', true);&nbsp;</div></li><li><div>      if( empty($billing_agreement_id) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;h3&gt;&nbsp;</div></li><li><div>          &lt;?php _e( 'Billing Agreement Details', 'woocommerce' ); ?&gt;&nbsp;</div></li><li><div>      &lt;/h3&gt;&nbsp;</div></li><li><div>      &lt;p&gt; &lt;?php echo $billing_agreement_id; ?&gt;&lt;/p&gt; &lt;?php &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function angelleye_paypal_for_woocommerce_is_set_sandbox_product() {&nbsp;</div></li><li><div>      $is_sandbox_set = false;&nbsp;</div></li><li><div>      if (isset(WC()-&gt;cart) && sizeof(WC()-&gt;cart-&gt;get_cart()) &gt; 0) {&nbsp;</div></li><li><div>          foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>              $product_id = apply_filters( 'woocommerce_cart_item_product_id', $cart_item['product_id'], $cart_item, $cart_item_key );&nbsp;</div></li><li><div>              $_enable_sandbox_mode = get_post_meta($product_id, '_enable_sandbox_mode', true);&nbsp;</div></li><li><div>              if ($_enable_sandbox_mode == 'yes') {&nbsp;</div></li><li><div>                  $is_sandbox_set = true;&nbsp;</div></li><li><div>                  return $is_sandbox_set;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $is_sandbox_set;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>PayPal for WooCommerce</li><li><span></span>1.4.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>