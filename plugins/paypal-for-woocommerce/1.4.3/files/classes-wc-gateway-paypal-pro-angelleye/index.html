<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.4.3" data-slug="paypal-for-woocommerce" data-type="file" data-id="80880"><head xmlns="http://www.w3.org/1999/xhtml"><title> classes-wc-gateway-paypal-pro-angelleye | file | Paypal For Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paypal-for-woocommerce, 1.4.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=a429c8d3bb9fedf66d64b766d0b89331' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/classes-wc-gateway-paypal-pro-angelleye/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-paypal-pro-angelleye%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-paypal-pro-angelleye%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paypal-for-woocommerce-1.4.3-file-classes-wc-gateway-paypal-pro-angelleye","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="classes-wc-gateway-paypal-pro-angelleye" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paypal-for-woocommerce." href="http://hookr.io/plugins/paypal-for-woocommerce/" class="plugin"><span property="name">paypal-for-woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.4.3." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/" class="H_VERSION"><span property="name">1.4.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">classes-wc-gateway-paypal-pro&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="497"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/all/" title="All">All <span class="count badge">497</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="157"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/hooks/" title="Hooks">Hooks <span class="count badge">157</span></a></li><li class="" data-id="action" data-count="32"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/actions/" title="Actions">Actions <span class="count badge">32</span></a></li><li class="" data-id="filter" data-count="125"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/filters/" title="Filters">Filters <span class="count badge">125</span></a></li><li class="" data-id="class" data-count="309"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/classes/" title="Classes">Classes <span class="count badge">309</span></a></li><li class="" data-id="constant" data-count="25"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/constants/" title="Constants">Constants <span class="count badge">25</span></a></li><li class="" data-id="function" data-count="6"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/functions/" title="Functions">Functions <span class="count badge">6</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/classes/wc-gateway-paypal-pro-angelleye.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WC_Gateway_PayPal_Pro class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @extends WC_Payment_Gateway</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_Gateway_PayPal_Pro_AngellEYE extends WC_Payment_Gateway_CC {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Store client</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $centinel_client = false;&nbsp;</div></li><li><div>  public $customer_id;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * __construct function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;id = 'paypal_pro';&nbsp;</div></li><li><div>      $this-&gt;method_title = __('PayPal Website Payments Pro (DoDirectPayment) ', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>      $this-&gt;method_description = __('PayPal Website Payments Pro allows you to accept credit cards directly on your site without any redirection through PayPal.  You host the checkout form on your own web server, so you will need an SSL certificate to ensure your customer data is protected.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>      $this-&gt;has_fields = true;&nbsp;</div></li><li><div>      $this-&gt;liveurl = 'https:<span class="comment">//api-3t.paypal.com/nvp';</span>&nbsp;</div></li><li><div>      $this-&gt;testurl = 'https:<span class="comment">//api-3t.sandbox.paypal.com/nvp';</span>&nbsp;</div></li><li><div>      $this-&gt;liveurl_3ds = 'https:<span class="comment">//paypal.cardinalcommerce.com/maps/txns.asp';</span>&nbsp;</div></li><li><div>      $this-&gt;testurl_3ds = 'https:<span class="comment">//centineltest.cardinalcommerce.com/maps/txns.asp';</span>&nbsp;</div></li><li><div>      $this-&gt;available_card_types = apply_filters('woocommerce_paypal_pro_available_card_types', array(&nbsp;</div></li><li><div>          'GB' =&gt; array(&nbsp;</div></li><li><div>              'Visa' =&gt; 'Visa', &nbsp;</div></li><li><div>              'MasterCard' =&gt; 'MasterCard', &nbsp;</div></li><li><div>              'Maestro' =&gt; 'Maestro/Switch', &nbsp;</div></li><li><div>              'Solo' =&gt; 'Solo'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'US' =&gt; array(&nbsp;</div></li><li><div>              'Visa' =&gt; 'Visa', &nbsp;</div></li><li><div>              'MasterCard' =&gt; 'MasterCard', &nbsp;</div></li><li><div>              'Discover' =&gt; 'Discover', &nbsp;</div></li><li><div>              'AmEx' =&gt; 'American Express'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'CA' =&gt; array(&nbsp;</div></li><li><div>              'Visa' =&gt; 'Visa', &nbsp;</div></li><li><div>              'MasterCard' =&gt; 'MasterCard'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'AU' =&gt; array(&nbsp;</div></li><li><div>              'Visa' =&gt; 'Visa', &nbsp;</div></li><li><div>              'MasterCard' =&gt; 'MasterCard', &nbsp;</div></li><li><div>              'Discover' =&gt; 'Discover', &nbsp;</div></li><li><div>              'AmEx' =&gt; 'American Express'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      $this-&gt;iso4217 = apply_filters('woocommerce_paypal_pro_iso_currencies', array(&nbsp;</div></li><li><div>          'AUD' =&gt; '036', &nbsp;</div></li><li><div>          'CAD' =&gt; '124', &nbsp;</div></li><li><div>          'CZK' =&gt; '203', &nbsp;</div></li><li><div>          'DKK' =&gt; '208', &nbsp;</div></li><li><div>          'EUR' =&gt; '978', &nbsp;</div></li><li><div>          'HUF' =&gt; '348', &nbsp;</div></li><li><div>          'JPY' =&gt; '392', &nbsp;</div></li><li><div>          'NOK' =&gt; '578', &nbsp;</div></li><li><div>          'NZD' =&gt; '554', &nbsp;</div></li><li><div>          'PLN' =&gt; '985', &nbsp;</div></li><li><div>          'GBP' =&gt; '826', &nbsp;</div></li><li><div>          'SGD' =&gt; '702', &nbsp;</div></li><li><div>          'SEK' =&gt; '752', &nbsp;</div></li><li><div>          'CHF' =&gt; '756', &nbsp;</div></li><li><div>          'USD' =&gt; '840'&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      <span class="comment">// Load the form fields</span>&nbsp;</div></li><li><div>      $this-&gt;init_form_fields();&nbsp;</div></li><li><div>      <span class="comment">// Load the settings.</span>&nbsp;</div></li><li><div>      $this-&gt;init_settings();&nbsp;</div></li><li><div>      <span class="comment">// Get setting values</span>&nbsp;</div></li><li><div>      $this-&gt;title = $this-&gt;get_option('title');&nbsp;</div></li><li><div>      $this-&gt;description = $this-&gt;get_option('description');&nbsp;</div></li><li><div>      $this-&gt;enabled = $this-&gt;get_option('enabled');&nbsp;</div></li><li><div>      $this-&gt;api_username = $this-&gt;get_option('api_username');&nbsp;</div></li><li><div>      $this-&gt;api_password = $this-&gt;get_option('api_password');&nbsp;</div></li><li><div>      $this-&gt;api_signature = $this-&gt;get_option('api_signature');&nbsp;</div></li><li><div>      $this-&gt;testmode = 'yes' === $this-&gt;get_option('testmode', 'no');&nbsp;</div></li><li><div>      if( $this-&gt;testmode == false ) {&nbsp;</div></li><li><div>          $this-&gt;testmode = AngellEYE_Utility::angelleye_paypal_for_woocommerce_is_set_sandbox_product();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;invoice_id_prefix = $this-&gt;get_option('invoice_id_prefix');&nbsp;</div></li><li><div>      $this-&gt;error_email_notify = $this-&gt;get_option('error_email_notify');&nbsp;</div></li><li><div>      $this-&gt;error_display_type = $this-&gt;get_option('error_display_type'); &nbsp;</div></li><li><div>      <span class="comment">//$this-&gt;enable_3dsecure = 'yes' === $this-&gt;get_option('enable_3dsecure', 'no');</span>&nbsp;</div></li><li><div>      $this-&gt;enable_3dsecure = false;&nbsp;</div></li><li><div>      $this-&gt;liability_shift = 'yes' === $this-&gt;get_option('liability_shift', 'no');&nbsp;</div></li><li><div>      $this-&gt;debug = 'yes' === $this-&gt;get_option('debug', 'no'); &nbsp;</div></li><li><div>      $this-&gt;payment_action = $this-&gt;get_option('payment_action', 'Sale');&nbsp;</div></li><li><div>      $this-&gt;send_items = 'yes' === $this-&gt;get_option('send_items', 'yes');&nbsp;</div></li><li><div>      $this-&gt;enable_notifyurl = $this-&gt;get_option('enable_notifyurl', 'no');&nbsp;</div></li><li><div>      $this-&gt;is_encrypt = $this-&gt;get_option('is_encrypt', 'no');&nbsp;</div></li><li><div>      $this-&gt;softdescriptor = $this-&gt;get_option('softdescriptor', '');&nbsp;</div></li><li><div>      $this-&gt;avs_cvv2_result_admin_email = 'yes' === $this-&gt;get_option('avs_cvv2_result_admin_email', 'no'); &nbsp;</div></li><li><div>      $this-&gt;fraud_management_filters = $this-&gt;get_option('fraud_management_filters', 'place_order_on_hold_for_further_review');&nbsp;</div></li><li><div>      $this-&gt;notifyurl = '';&nbsp;</div></li><li><div>      if ($this-&gt;enable_notifyurl == 'yes') {&nbsp;</div></li><li><div>          $this-&gt;notifyurl = $this-&gt;get_option('notifyurl');&nbsp;</div></li><li><div>          if (isset($this-&gt;notifyurl) && !empty($this-&gt;notifyurl)) {&nbsp;</div></li><li><div>              $this-&gt;notifyurl = str_replace('&amp;', '&', $this-&gt;notifyurl);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;enable_cardholder_first_last_name = 'yes' === $this-&gt;get_option('enable_cardholder_first_last_name', 'no');&nbsp;</div></li><li><div>      <span class="comment">// 3DS</span>&nbsp;</div></li><li><div>      if ($this-&gt;enable_3dsecure) {&nbsp;</div></li><li><div>          $this-&gt;centinel_pid = $this-&gt;get_option('centinel_pid');&nbsp;</div></li><li><div>          $this-&gt;centinel_mid = $this-&gt;get_option('centinel_mid');&nbsp;</div></li><li><div>          $this-&gt;centinel_pwd = $this-&gt;get_option('centinel_pwd');&nbsp;</div></li><li><div>          if (empty($this-&gt;centinel_pid) || empty($this-&gt;centinel_mid) || empty($this-&gt;centinel_pwd))&nbsp;</div></li><li><div>              $this-&gt;enable_3dsecure = false;&nbsp;</div></li><li><div>          $this-&gt;centinel_url = $this-&gt;testmode == false ? $this-&gt;liveurl_3ds : $this-&gt;testurl_3ds;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      <span class="comment">//fix ssl for image icon</span>&nbsp;</div></li><li><div>      $this-&gt;icon = $this-&gt;get_option('card_icon', plugins_url('/assets/images/cards.png', plugin_basename(dirname(__FILE__))));&nbsp;</div></li><li><div>      if (is_ssl()) {&nbsp;</div></li><li><div>          $this-&gt;icon = preg_replace(&quot;/^http:/i&quot;, &quot;https:&quot;, $this-&gt;icon);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;icon = apply_filters('woocommerce_paypal_pro_icon', $this-&gt;icon);&nbsp;</div></li><li><div>      $this-&gt;supports = array(&nbsp;</div></li><li><div>          'products', &nbsp;</div></li><li><div>          'refunds'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;enable_tokenized_payments = $this-&gt;get_option('enable_tokenized_payments', 'no');&nbsp;</div></li><li><div>      if($this-&gt;enable_tokenized_payments == 'yes') {&nbsp;</div></li><li><div>          $this-&gt;supports = array(&nbsp;</div></li><li><div>              'subscriptions', &nbsp;</div></li><li><div>              'products', &nbsp;</div></li><li><div>              'refunds', &nbsp;</div></li><li><div>              'subscription_cancellation', &nbsp;</div></li><li><div>              'subscription_reactivation', &nbsp;</div></li><li><div>              'subscription_suspension', &nbsp;</div></li><li><div>              'subscription_amount_changes', &nbsp;</div></li><li><div>              'subscription_payment_method_change', <span class="comment">// Subs 1.n compatibility.</span>&nbsp;</div></li><li><div>              'subscription_payment_method_change_customer', &nbsp;</div></li><li><div>              'subscription_payment_method_change_admin', &nbsp;</div></li><li><div>              'subscription_date_changes', &nbsp;</div></li><li><div>              'multiple_subscriptions', &nbsp;</div></li><li><div>              'add_payment_method', &nbsp;</div></li><li><div>              'tokenization'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;Force_tls_one_point_two = get_option('Force_tls_one_point_two', 'no');&nbsp;</div></li><li><div>      $this-&gt;credit_card_month_field = $this-&gt;get_option('credit_card_month_field', 'names');&nbsp;</div></li><li><div>      $this-&gt;credit_card_year_field = $this-&gt;get_option('credit_card_year_field', 'four_digit');&nbsp;</div></li><li><div>      if ($this-&gt;testmode == true) {&nbsp;</div></li><li><div>          $this-&gt;api_username = $this-&gt;get_option('sandbox_api_username');&nbsp;</div></li><li><div>          $this-&gt;api_password = $this-&gt;get_option('sandbox_api_password');&nbsp;</div></li><li><div>          $this-&gt;api_signature = $this-&gt;get_option('sandbox_api_signature');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Maestro</span>&nbsp;</div></li><li><div>      if (!$this-&gt;enable_3dsecure) {&nbsp;</div></li><li><div>          unset($this-&gt;available_card_types['GB']['Maestro']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hooks</span>&nbsp;</div></li><li><div>      add_action('woocommerce_api_wc_gateway_paypal_pro_angelleye', array($this, 'handle_3dsecure'));&nbsp;</div></li><li><div>      <span class="comment">/** 2.0.0 */</span>&nbsp;</div></li><li><div>      add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array($this, 'process_admin_options'));&nbsp;</div></li><li><div>      add_filter('woocommerce_settings_api_sanitized_fields_' . $this-&gt;id, array($this, 'angelleye_paypal_pro_encrypt_gateway_api'), 10, 1);&nbsp;</div></li><li><div>      if ($this-&gt;enable_cardholder_first_last_name) {&nbsp;</div></li><li><div>          add_action('woocommerce_credit_card_form_start', array($this, 'angelleye_woocommerce_credit_card_form_start'), 10, 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      add_filter('woocommerce_credit_card_form_fields', array($this, 'angelleye_paypal_pro_credit_card_form_fields'), 10, 2);&nbsp;</div></li><li><div>      if( $this-&gt;avs_cvv2_result_admin_email ) {&nbsp;</div></li><li><div>          add_action( 'woocommerce_email_before_order_table', array( $this, 'angelleye_paypal_pro_email_instructions' ), 10, 3 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>     &nbsp;</div></li><li><div>      $this-&gt;customer_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function init_form_fields() {&nbsp;</div></li><li><div>      $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable/Disable', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable PayPal Pro', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; '', &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Title', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the title which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; __('Credit card', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Description', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'textarea', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the description which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; __('Pay with your credit card', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'testmode' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Test Mode', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable PayPal Sandbox/Test Mode', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Place the payment gateway in development mode.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'invoice_id_prefix' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Invoice ID Prefix', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('Add a prefix to the invoice ID sent to PayPal. This can resolve duplicate invoice problems when working with multiple websites on the same PayPal account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'card_icon' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Card Icon', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; plugins_url('/assets/images/cards.png', plugin_basename(dirname(__FILE__))), &nbsp;</div></li><li><div>              'class' =&gt; 'button_upload', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'error_email_notify' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Error Email Notifications', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable admin email notifications for errors.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'description' =&gt; __('This will send a detailed error email to the WordPress site administrator if a PayPal API error occurs.', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_api_username' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox API Username', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('Create sandbox accounts and obtain API credentials from within your&nbsp;</div></li><li><div>                                  &lt;a href=&quot;http:<span class="comment">//developer.paypal.com&quot;&gt;PayPal developer account&lt;/a&gt;.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_api_password' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox API Password', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_api_signature' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox API Signature', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'api_username' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live API Username', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your live account API credentials from your PayPal account profile under the API Access section &lt;br /&gt;or by using&nbsp;</div></li><li><div>                                  &lt;a target=&quot;_blank&quot; href=&quot;https:<span class="comment">//www.paypal.com/us/cgi-bin/webscr?cmd=_login-api-run&quot;&gt;this tool&lt;/a&gt;.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'api_password' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live API Password', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'api_signature' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live API Signature', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'default' =&gt; ''&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div><span class="comment">//            'enable_3dsecure' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">//                'title' =&gt; __('3DSecure', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment">//                'label' =&gt; __('Enable 3DSecure', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'type' =&gt; 'checkbox', </span></span>&nbsp;</div></li><li><div><span class="comment">//                'description' =&gt; __('Allows UK merchants to pass 3-D Secure authentication data to PayPal for debit and credit cards. Updating your site with 3-D Secure enables your participation in the Verified by Visa and MasterCard SecureCode programs. (Required to accept Maestro)', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'default' =&gt; 'no'</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// ), </span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//            'centinel_pid' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">//                'title' =&gt; __('Centinel PID', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'type' =&gt; 'text', </span></span>&nbsp;</div></li><li><div><span class="comment">//                'description' =&gt; __('If enabling 3D Secure, enter your Cardinal Centinel Processor ID.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                'default' =&gt; ''</span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// ), </span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//            'centinel_mid' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">//                'title' =&gt; __('Centinel MID', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'type' =&gt; 'text', </span></span>&nbsp;</div></li><li><div><span class="comment">//                'description' =&gt; __('If enabling 3D Secure, enter your Cardinal Centinel Merchant ID.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                'default' =&gt; ''</span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// ), </span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//            'centinel_pwd' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">//                'title' =&gt; __('Transaction Password', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment">//                'type' =&gt; 'password', </span>&nbsp;</div></li><li><div><span class="comment">//                'description' =&gt; __('If enabling 3D Secure, enter your Cardinal Centinel Transaction Password.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment">//                'default' =&gt; ''</span></span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// ), </span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//            'liability_shift' =&gt; array(</span>&nbsp;</div></li><li><div><span class="comment">//                'title' =&gt; __('Liability Shift', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment">//                'label' =&gt; __('Require liability shift', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'type' =&gt; 'checkbox', </span></span>&nbsp;</div></li><li><div><span class="comment">//                'description' =&gt; __('Only accept payments when liability shift has occurred.', 'paypal-for-woocommerce'), </span>&nbsp;</div></li><li><div><span class="comment"><span class="comment">//                'default' =&gt; 'no'</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// ), </span></span></span></span></span>&nbsp;</div></li><li><div>          'error_display_type' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Error Display Type', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'label' =&gt; __('Display detailed or generic errors', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'css' =&gt; 'max-width:150px;', &nbsp;</div></li><li><div>              'class' =&gt; 'error_display_type_option, wc-enhanced-select', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'detailed' =&gt; __('Detailed', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>                  'generic' =&gt; __('Generic', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'description' =&gt; __('Detailed displays actual errors returned from PayPal.  Generic displays general errors that do not reveal details&nbsp;</div></li><li><div>                                  and helps to prevent fraudulant activity on your site.', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'payment_action' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Payment Action', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Whether to process as a Sale or Authorization.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'description' =&gt; __('Sale will capture the funds immediately when the order is placed.  Authorization will authorize the payment but will not capture the funds.  You would need to capture funds from within the WooCommerce order when you are ready to deliver.'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'css' =&gt; 'max-width:150px;', &nbsp;</div></li><li><div>              'class' =&gt; 'wc-enhanced-select', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'Sale' =&gt; 'Sale', &nbsp;</div></li><li><div>                  'Authorization' =&gt; 'Authorization', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'default' =&gt; 'Sale'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'send_items' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Send Item Details', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Send line item details to PayPal', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Include all line item details in the payment request to PayPal so that they can be seen from the PayPal transaction details page.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_notifyurl' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable PayPal IPN', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Instant Payment Notification.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'class' =&gt; 'angelleye_enable_notifyurl'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_tokenized_payments' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Allow buyers to securely save payment details to their account for quick checkout / auto-ship orders in the future.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'class' =&gt; 'enable_tokenized_payments'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'notifyurl' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('PayPal IPN URL', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('Your URL for receiving Instant Payment Notification (IPN) about transactions.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'class' =&gt; 'angelleye_notifyurl'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'fraud_management_filters' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Fraud Management Filters ', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; '', &nbsp;</div></li><li><div>              'description' =&gt; __('Choose how you would like to handle orders when Fraud Management Filters are flagged.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'class' =&gt; '', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'ignore_warnings_and_proceed_as_usual' =&gt; __('Ignore warnings and proceed as usual.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>                  'place_order_on_hold_for_further_review' =&gt; __('Place order On Hold for further review.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'default' =&gt; 'place_order_on_hold_for_further_review', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_cardholder_first_last_name' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Cardholder Name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Adds fields for &quot;card holder name&quot; to checkout in addition to the &quot;billing name&quot; fields.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Display card holder first and last name in credit card form.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'avs_cvv2_result_admin_email' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('AVS / CVV2 Results in Admin Order Email', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Adds the AVS / CVV2 results to the admin order email notification.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Display Address Verification Result (AVS) and Card Security Code Result (CVV2) Results in Admin Order Email.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'softdescriptor' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Credit Card Statement Name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('The value entered here will be displayed on the buyer\'s credit card statement.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'credit_card_month_field' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Credit Card Month Format', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Credit Card Month Display Format.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'description' =&gt; __('Choose whether you wish to display Name format or Number format of Month field in the credit card form.'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'css' =&gt; 'max-width:200px;', &nbsp;</div></li><li><div>              'class' =&gt; 'wc-enhanced-select', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'numbers' =&gt; 'Numbers', &nbsp;</div></li><li><div>                  'names' =&gt; 'Names', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'default' =&gt; 'names'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'credit_card_year_field' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Credit Card Year Format', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Credit Card Year Display Format.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'description' =&gt; __('Choose whether you wish to display two digit format or four digit of Year field in the credit card form.'), &nbsp;</div></li><li><div>              'type' =&gt; 'select', &nbsp;</div></li><li><div>              'css' =&gt; 'max-width:200px;', &nbsp;</div></li><li><div>              'class' =&gt; 'wc-enhanced-select', &nbsp;</div></li><li><div>              'options' =&gt; array(&nbsp;</div></li><li><div>                  'two_digit' =&gt; 'Show Two Digit Years', &nbsp;</div></li><li><div>                  'four_digit' =&gt; 'Show Four Digit Years', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'default' =&gt; 'four_digit'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'debug' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Debug Log', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable logging', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; sprintf( __( 'Log PayPal events, inside &lt;code&gt;%s&lt;/code&gt;', 'paypal-for-woocommerce' ), wc_get_log_file_path( 'paypal-pro' ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'is_encrypt' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'hidden', &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'class' =&gt; ''&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;form_fields = apply_filters('angelleye_pc_form_fields', $this-&gt;form_fields);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if this gateway is enabled and available in the user's country</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method no is used anywhere??? put above but need a fix below</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function is_available() {&nbsp;</div></li><li><div>      if ($this-&gt;enabled == &quot;yes&quot;) :&nbsp;</div></li><li><div>          if ($this-&gt;testmode == false && get_option('woocommerce_force_ssl_checkout') == 'no' && !class_exists('WordPressHTTPS')) return false;&nbsp;</div></li><li><div>          <span class="comment">// Currency check</span>&nbsp;</div></li><li><div>          if (!in_array(get_woocommerce_currency(), apply_filters('woocommerce_paypal_pro_supported_currencies', array('AUD', 'CAD', 'CZK', 'DKK', 'EUR', 'HUF', 'JPY', 'NOK', 'NZD', 'PLN', 'GBP', 'SGD', 'SEK', 'CHF', 'USD')))) return false;&nbsp;</div></li><li><div>          <span class="comment">// Required fields check</span>&nbsp;</div></li><li><div>          if (!$this-&gt;api_username || !$this-&gt;api_password || !$this-&gt;api_signature) return false;&nbsp;</div></li><li><div>          return isset($this-&gt;available_card_types[WC()-&gt;countries-&gt;get_base_country()]);&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a log entry</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function log($message) {&nbsp;</div></li><li><div>      if ($this-&gt;debug) {&nbsp;</div></li><li><div>          if (!isset($this-&gt;log)) {&nbsp;</div></li><li><div>              $this-&gt;log = new WC_Logger();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;log-&gt;add('paypal-pro', $message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Payment form on checkout page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function payment_fields() {&nbsp;</div></li><li><div>      do_action('before_angelleye_pc_payment_fields', $this);&nbsp;</div></li><li><div>      if ($this-&gt;description) {&nbsp;</div></li><li><div>          echo '&lt;p&gt;' . wp_kses_post($this-&gt;description);&nbsp;</div></li><li><div>          if ($this-&gt;testmode == true) {&nbsp;</div></li><li><div>              echo '&lt;p&gt;';&nbsp;</div></li><li><div>              _e('NOTICE: SANDBOX (TEST) MODE ENABLED.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              echo '&lt;br /&gt;';&nbsp;</div></li><li><div>              _e('For testing purposes you can use the card number 4916311462114485 with any CVC and a valid expiration date.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              echo '&lt;/p&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      parent::payment_fields();&nbsp;</div></li><li><div>      do_action('payment_fields_saved_payment_methods', $this);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function paypal_for_woocommerce_paypal_pro_credit_card_form_expiration_date_selectbox($class) {&nbsp;</div></li><li><div>      $form_html = &quot;&quot;;&nbsp;</div></li><li><div>      $form_html .= '&lt;p class=&quot;' . $class . '&quot;&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;label for=&quot;cc-expire-month&quot;&gt;' . __(&quot;Expiration Date&quot;, 'paypal-for-woocommerce') . '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;select name=&quot;paypal_pro_card_expiration_month&quot; id=&quot;cc-expire-month&quot; class=&quot;woocommerce-select woocommerce-cc-month mr5&quot;&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;option value=&quot;&quot;&gt;' . __('Month', 'paypal-for-woocommerce') . '&lt;/option&gt;';&nbsp;</div></li><li><div>      $months = array();&nbsp;</div></li><li><div>      for ($i = 1; $i &lt;= 12; $i++) :&nbsp;</div></li><li><div>          $timestamp = mktime(0, 0, 0, $i, 1);&nbsp;</div></li><li><div>          $months[date('n', $timestamp)] = date_i18n(_x('F', 'Month Names', 'paypal-for-woocommerce'), $timestamp);&nbsp;</div></li><li><div>      endfor;&nbsp;</div></li><li><div>      foreach ($months as $num =&gt; $name) {&nbsp;</div></li><li><div>          if($this-&gt;credit_card_month_field == 'names') {&nbsp;</div></li><li><div>          $form_html .= '&lt;option value=' . $num . '&gt;' . $name . '&lt;/option&gt;';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $month_value = ($num &lt; 10) ? '0'.$num : $num;&nbsp;</div></li><li><div>              $form_html .= '&lt;option value=' . $num . '&gt;' . $month_value . '&lt;/option&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $form_html .= '&lt;/select&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;select name=&quot;paypal_pro_card_expiration_year&quot; id=&quot;cc-expire-year&quot; class=&quot;woocommerce-select woocommerce-cc-year ml5&quot;&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;option value=&quot;&quot;&gt;' . __('Year', 'paypal-for-woocommerce') . '&lt;/option&gt;';&nbsp;</div></li><li><div>      for ($i = date('y'); $i &lt;= date('y') + 15; $i++) {&nbsp;</div></li><li><div>          if($this-&gt;credit_card_year_field == 'four_digit') {&nbsp;</div></li><li><div>          $form_html .= '&lt;option value=' . $i . '&gt;20' . $i . '&lt;/option&gt;';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $form_html .= '&lt;option value=' . $i . '&gt;' . $i . '&lt;/option&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $form_html .= '&lt;/select&gt;';&nbsp;</div></li><li><div>      $form_html .= '&lt;/p&gt;';&nbsp;</div></li><li><div>      return $form_html;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Format and get posted details</span>&nbsp;</div></li><li><div><span class="comment">   * @return object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_posted_card() {&nbsp;</div></li><li><div>      $card_number = isset($_POST['paypal_pro-card-number']) ? wc_clean($_POST['paypal_pro-card-number']) : '';&nbsp;</div></li><li><div>      $card_cvc = isset($_POST['paypal_pro-card-cvc']) ? wc_clean($_POST['paypal_pro-card-cvc']) : '';&nbsp;</div></li><li><div>      $card_exp_month = isset($_POST['paypal_pro_card_expiration_month']) ? wc_clean($_POST['paypal_pro_card_expiration_month']) : '';&nbsp;</div></li><li><div>      $card_exp_year = isset($_POST['paypal_pro_card_expiration_year']) ? wc_clean($_POST['paypal_pro_card_expiration_year']) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Format values</span>&nbsp;</div></li><li><div>      $card_number = str_replace(array(' ', '-'), '', $card_number);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($_POST['paypal_pro-card-startdate'])) {&nbsp;</div></li><li><div>          $card_start = wc_clean($_POST['paypal_pro-card-startdate']);&nbsp;</div></li><li><div>          $card_start = array_map('trim', explode('/', $card_start));&nbsp;</div></li><li><div>          $card_start_month = str_pad($card_start[0], 2, &quot;0&quot;, STR_PAD_LEFT);&nbsp;</div></li><li><div>          $card_start_year = $card_start[1];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $card_start_month = '';&nbsp;</div></li><li><div>          $card_start_year = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (strlen($card_exp_year) == 2) {&nbsp;</div></li><li><div>          $card_exp_year += 2000;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (strlen($card_start_year) == 2) {&nbsp;</div></li><li><div>          $card_start_year += 2000;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) array(&nbsp;</div></li><li><div>                  'number' =&gt; $card_number, &nbsp;</div></li><li><div>                  'type' =&gt; '', &nbsp;</div></li><li><div>                  'cvc' =&gt; $card_cvc, &nbsp;</div></li><li><div>                  'exp_month' =&gt; $card_exp_month, &nbsp;</div></li><li><div>                  'exp_year' =&gt; $card_exp_year, &nbsp;</div></li><li><div>                  'start_month' =&gt; $card_start_month, &nbsp;</div></li><li><div>                  'start_year' =&gt; $card_start_year&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function validate_fields() {&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          if (isset($_POST['wc-paypal_pro-payment-token']) && 'new' !== $_POST['wc-paypal_pro-payment-token']) {&nbsp;</div></li><li><div>              $token_id = wc_clean($_POST['wc-paypal_pro-payment-token']);&nbsp;</div></li><li><div>              $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>              if ($token-&gt;get_user_id() !== get_current_user_id()) {&nbsp;</div></li><li><div>                  throw new Exception(__('Error processing checkout. Please try again.', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>          do_action('before_angelleye_pro_checkout_validate_fields', $card-&gt;type, $card-&gt;number, $card-&gt;cvc, $card-&gt;exp_month, $card-&gt;exp_year);&nbsp;</div></li><li><div>          if (empty($card-&gt;exp_month) || empty($card-&gt;exp_year)) {&nbsp;</div></li><li><div>              throw new Exception(__('Card expiration date is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Validate values</span>&nbsp;</div></li><li><div>          if (!ctype_digit($card-&gt;cvc)) {&nbsp;</div></li><li><div>              throw new Exception(__('Card security code is invalid (only digits are allowed)', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (&nbsp;</div></li><li><div>                  !ctype_digit($card-&gt;exp_month) ||&nbsp;</div></li><li><div>                  !ctype_digit($card-&gt;exp_year) ||&nbsp;</div></li><li><div>                  $card-&gt;exp_month &gt; 12 ||&nbsp;</div></li><li><div>                  $card-&gt;exp_month &lt; 1 ||&nbsp;</div></li><li><div>                  $card-&gt;exp_year &lt; date('y')&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>              throw new Exception(__('Card expiration date is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (empty($card-&gt;number) || !ctype_digit($card-&gt;number)) {&nbsp;</div></li><li><div>              throw new Exception(__('Card number is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $card_type = AngellEYE_Utility::card_type_from_account_number($card-&gt;number);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($card_type == 'amex' && (get_woocommerce_currency() != 'USD' && get_woocommerce_currency() != 'AUD')) {&nbsp;</div></li><li><div>              throw new Exception(__('Your processor is unable to process the Card Type in the currency requested. Please try another card type', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action('after_angelleye_pro_checkout_validate_fields', $card-&gt;type, $card-&gt;number, $card-&gt;cvc, $card-&gt;exp_month, $card-&gt;exp_year);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>          wc_add_notice($e-&gt;getMessage(), 'error');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function process_payment($order_id) {&nbsp;</div></li><li><div>      $order = new WC_Order($order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log('Processing order #' . $order_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * 3D Secure Handling</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ($this-&gt;enable_3dsecure) {&nbsp;</div></li><li><div>          if (!class_exists('CentinelClient')) include_once('lib/CentinelClient.php');&nbsp;</div></li><li><div>          $this-&gt;clear_centinel_session();&nbsp;</div></li><li><div>          $this-&gt;centinel_client = new CentinelClient;&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;MsgType&quot;, &quot;cmpi_lookup&quot;);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;Version&quot;, &quot;1.7&quot;);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;ProcessorId&quot;, $this-&gt;centinel_pid);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;MerchantId&quot;, $this-&gt;centinel_mid);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;TransactionPwd&quot;, $this-&gt;centinel_pwd);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add(&quot;TransactionType&quot;, 'C');&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('OrderNumber', $order_id);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('Amount', $order-&gt;get_total() * 100);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('CurrencyCode', $this-&gt;iso4217[version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency()]);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('TransactionMode', 'S');&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ProductCode', 'PHY');&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('CardNumber', $card-&gt;number);&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('CardNumber', $card-&gt;number);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('CardExpMonth', $card-&gt;exp_month);&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('CardExpMonth', $card-&gt;exp_month);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('CardExpYear', $card-&gt;exp_year);&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('CardExpYear', $card-&gt;exp_year);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('CardCode', $card-&gt;cvc);&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('CardCode', $card-&gt;cvc);&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          $billing_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>          $billing_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>          $billing_address_1 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_1 : $order-&gt;get_billing_address_1();&nbsp;</div></li><li><div>          $billing_address_2 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_2 : $order-&gt;get_billing_address_2();&nbsp;</div></li><li><div>          $billing_city = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_city : $order-&gt;get_billing_city();&nbsp;</div></li><li><div>          $billing_postcode = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_postcode : $order-&gt;get_billing_postcode();&nbsp;</div></li><li><div>          $billing_country = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_country : $order-&gt;get_billing_country();&nbsp;</div></li><li><div>          $billing_state = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_state : $order-&gt;get_billing_state();&nbsp;</div></li><li><div>          $billing_phone = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingFirstName', $billing_first_name);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingLastName', $billing_last_name);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingAddress1', $billing_address_1);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingAddress2', $billing_address_2);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingCity', $billing_city);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingState', $billing_state);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingPostalCode', $billing_postcode);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingCountryCode', $billing_country);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('BillingPhone', $billing_phone);&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingFirstName', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_first_name : $order-&gt;get_shipping_first_name());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingLastName', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_last_name : $order-&gt;get_shipping_last_name());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingAddress1', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_1 : $order-&gt;get_shipping_address_1());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingAddress2', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_2 : $order-&gt;get_shipping_address_2());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingCity', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_city : $order-&gt;get_shipping_city());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingState', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_state : $order-&gt;get_shipping_state());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingPostalCode', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_postcode : $order-&gt;get_shipping_postcode());&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;add('ShippingCountryCode', version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_country : $order-&gt;get_shipping_country());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Items</span>&nbsp;</div></li><li><div>          $item_loop = 0;&nbsp;</div></li><li><div>          if (sizeof($order-&gt;get_items()) &gt; 0) {&nbsp;</div></li><li><div>              foreach ($order-&gt;get_items() as $item) {&nbsp;</div></li><li><div>                  $item_loop++;&nbsp;</div></li><li><div>                  $this-&gt;centinel_client-&gt;add('Item_Name_' . $item_loop, $item['name']);&nbsp;</div></li><li><div>                  $this-&gt;centinel_client-&gt;add('Item_Price_' . $item_loop, number_format($order-&gt;get_item_total($item, true, true) * 100), 2, '.', '');&nbsp;</div></li><li><div>                  $this-&gt;centinel_client-&gt;add('Item_Quantity_' . $item_loop, $item['qty']);&nbsp;</div></li><li><div>                  $this-&gt;centinel_client-&gt;add('Item_Desc_' . $item_loop, $item['name']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Send request</span>&nbsp;</div></li><li><div>          $this-&gt;centinel_client-&gt;sendHttp($this-&gt;centinel_url, &quot;5000&quot;, &quot;15000&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log('Centinal client request: ' . print_r($this-&gt;centinel_client-&gt;request, true));&nbsp;</div></li><li><div>          $this-&gt;log('Centinal client response: ' . print_r($this-&gt;centinel_client-&gt;response, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Save response in session</span>&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_ErrorNo', $this-&gt;get_centinel_value(&quot;ErrorNo&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_ErrorDesc', $this-&gt;get_centinel_value(&quot;ErrorDesc&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_TransactionId', $this-&gt;get_centinel_value(&quot;TransactionId&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_OrderId', $this-&gt;get_centinel_value(&quot;OrderId&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_Enrolled', $this-&gt;get_centinel_value(&quot;Enrolled&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_ACSUrl', $this-&gt;get_centinel_value(&quot;ACSUrl&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_Payload', $this-&gt;get_centinel_value(&quot;Payload&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_EciFlag', $this-&gt;get_centinel_value(&quot;EciFlag&quot;));&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_card_start_month', $card-&gt;start_month);&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set('Centinel_card_start_year', $card-&gt;start_year);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;get_centinel_value(&quot;ErrorNo&quot;)) {&nbsp;</div></li><li><div>              wc_add_notice(apply_filters('angelleye_pc_process_payment_authentication', __('Error in 3D secure authentication: ', 'woocommerce-gateway-paypal-pro') . $this-&gt;get_centinel_value(&quot;ErrorDesc&quot;)), 'error');&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ('Y' === $this-&gt;get_centinel_value(&quot;Enrolled&quot;)) {&nbsp;</div></li><li><div>              $this-&gt;log('Doing 3dsecure payment authorization');&nbsp;</div></li><li><div>              $this-&gt;log('ASCUrl: ' . $this-&gt;get_centinel_value(&quot;ACSUrl&quot;));&nbsp;</div></li><li><div>              $this-&gt;log('PaReq: ' . $this-&gt;get_centinel_value(&quot;Payload&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  'redirect' =&gt; add_query_arg(array('acs' =&gt; $order_id), WC()-&gt;api_request_url('WC_Gateway_PayPal_Pro_AngellEYE', is_ssl()))&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } elseif ($this-&gt;liability_shift && 'N' !== $this-&gt;get_centinel_value(&quot;Enrolled&quot;)) {&nbsp;</div></li><li><div>              wc_add_notice(apply_filters('angelleye_pc_process_payment_authentication_unavailable', __('Authentication unavailable. Please try a different payment method or card.', 'woocommerce-gateway-paypal-pro')), 'error');&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Do payment with paypal</span>&nbsp;</div></li><li><div>      return $this-&gt;do_payment($order, $card-&gt;number, $card-&gt;type, $card-&gt;exp_month, $card-&gt;exp_year, $card-&gt;cvc, '', '', '', '', '', $card-&gt;start_month, $card-&gt;start_year);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Auth 3dsecure</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function handle_3dsecure() {&nbsp;</div></li><li><div>      if (!empty($_GET['acs'])) {&nbsp;</div></li><li><div>          $order_id = wc_clean($_GET['acs']);&nbsp;</div></li><li><div>          $acsurl = WC()-&gt;session-&gt;get('Centinel_ACSUrl');&nbsp;</div></li><li><div>          $payload = WC()-&gt;session-&gt;get('Centinel_Payload');&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;html&gt;&nbsp;</div></li><li><div>              &lt;head&gt;&nbsp;</div></li><li><div>                  &lt;title&gt;3DSecure Payment Authorisation&lt;/title&gt;&nbsp;</div></li><li><div>              &lt;/head&gt;&nbsp;</div></li><li><div>              &lt;body&gt;&nbsp;</div></li><li><div>                  &lt;form name=&quot;frmLaunchACS&quot; id=&quot;3ds_submit_form&quot; method=&quot;POST&quot; action=&quot;&lt;?php echo esc_url($acsurl); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;PaReq&quot; value=&quot;&lt;?php echo esc_attr($payload); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;TermUrl&quot;&nbsp;</div></li><li><div>                             value=&quot;&lt;?php echo esc_attr(WC()-&gt;api_request_url('WC_Gateway_PayPal_Pro_AngellEYE', is_ssl())); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;MD&quot; value=&quot;&lt;?php echo absint($order_id); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                      &lt;noscript&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;submit&quot; class=&quot;button&quot; id=&quot;3ds_submit&quot; value=&quot;Submit&quot;/&gt;&nbsp;</div></li><li><div>                      &lt;/noscript&gt;&nbsp;</div></li><li><div>                  &lt;/form&gt;&nbsp;</div></li><li><div>                  &lt;script&gt;&nbsp;</div></li><li><div>                      document.frmLaunchACS.submit();&nbsp;</div></li><li><div>                  &lt;/script&gt;&nbsp;</div></li><li><div>              &lt;/body&gt;&nbsp;</div></li><li><div>          &lt;/html&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;authorise_3dsecure();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function authorise_3dsecure() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!class_exists('CentinelClient')) {&nbsp;</div></li><li><div>          include_once('lib/CentinelClient.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pares = !empty($_POST['PaRes']) ? $_POST['PaRes'] : '';&nbsp;</div></li><li><div>      $order_id = absint(!empty($_POST['MD']) ? $_POST['MD'] : 0);&nbsp;</div></li><li><div>      $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      $redirect_url = $this-&gt;get_return_url($order);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log('authorise_3dsecure() for order ' . absint($order_id));&nbsp;</div></li><li><div>      $this-&gt;log('authorise_3dsecure() PARes ' . print_r($pares, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/**         * *************************************************************************** */</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/**                                                                            */</span></span>&nbsp;</div></li><li><div>      <span class="comment">/**    If the PaRes is Not Empty then process the cmpi_authenticate message    */</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/**                                                                            */</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/**         * *************************************************************************** */</span></span>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          <span class="comment">// If the PaRes is Not Empty then process the cmpi_authenticate message</span>&nbsp;</div></li><li><div>          if (!empty($pares)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;centinel_client = new CentinelClient;&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add('MsgType', 'cmpi_authenticate');&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add(&quot;Version&quot;, &quot;1.7&quot;);&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add(&quot;ProcessorId&quot;, $this-&gt;centinel_pid);&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add(&quot;MerchantId&quot;, $this-&gt;centinel_mid);&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add(&quot;TransactionPwd&quot;, $this-&gt;centinel_pwd);&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add(&quot;TransactionType&quot;, 'C');&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add('TransactionId', WC()-&gt;session-&gt;get('Centinel_TransactionId'));&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;add('PAResPayload', $pares);&nbsp;</div></li><li><div>              $this-&gt;centinel_client-&gt;sendHttp($this-&gt;centinel_url, &quot;5000&quot;, &quot;15000&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $response_to_log = $this-&gt;centinel_client-&gt;response;&nbsp;</div></li><li><div>              $response_to_log['CardNumber'] = 'XXX';&nbsp;</div></li><li><div>              $response_to_log['CardCode'] = 'XXX';&nbsp;</div></li><li><div>              $this-&gt;log('Centinal transaction ID ' . WC()-&gt;session-&gt;get('Centinel_TransactionId'));&nbsp;</div></li><li><div>              $this-&gt;log('Centinal client request : ' . print_r($this-&gt;centinel_client-&gt;request, true));&nbsp;</div></li><li><div>              $this-&gt;log('Centinal client response: ' . print_r($response_to_log, true));&nbsp;</div></li><li><div>              $this-&gt;log('3dsecure pa_res_status: ' . $this-&gt;get_centinel_value(&quot;PAResStatus&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;liability_shift && ($this-&gt;get_centinel_value(&quot;EciFlag&quot;) == '07' || $this-&gt;get_centinel_value(&quot;EciFlag&quot;) == '01')) {&nbsp;</div></li><li><div>              $order-&gt;update_status('failed', __('3D Secure error: No liability shift', 'woocommerce-gateway-paypal-pro'));&nbsp;</div></li><li><div>              throw new Exception(apply_filters('angelleye_pc_3d_authentication_unavailable', __('Authentication unavailable.  Please try a different payment method or card.', 'woocommerce-gateway-paypal-pro')));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$this-&gt;get_centinel_value(&quot;ErrorNo&quot;) && in_array($this-&gt;get_centinel_value(&quot;PAResStatus&quot;), array('Y', 'A', 'U')) && &quot;Y&quot; === $this-&gt;get_centinel_value(&quot;SignatureVerification&quot;)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If we are here we can process the card</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $card = new stdClass();&nbsp;</div></li><li><div>              $card-&gt;number = $this-&gt;get_centinel_value(&quot;CardNumber&quot;);&nbsp;</div></li><li><div>              $card-&gt;type = '';&nbsp;</div></li><li><div>              $card-&gt;cvc = $this-&gt;get_centinel_value(&quot;CardCode&quot;);&nbsp;</div></li><li><div>              $card-&gt;exp_month = $this-&gt;get_centinel_value(&quot;CardExpMonth&quot;);&nbsp;</div></li><li><div>              $card-&gt;exp_year = $this-&gt;get_centinel_value(&quot;CardExpYear&quot;);&nbsp;</div></li><li><div>              $card-&gt;start_month = WC()-&gt;session-&gt;get('Centinel_card_start_month');&nbsp;</div></li><li><div>              $card-&gt;start_year = WC()-&gt;session-&gt;get('Centinel_card_start_year');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $centinel = new stdClass();&nbsp;</div></li><li><div>              $centinel-&gt;paresstatus = $this-&gt;get_centinel_value(&quot;PAResStatus&quot;);&nbsp;</div></li><li><div>              $centinel-&gt;xid = $this-&gt;get_centinel_value(&quot;Xid&quot;);&nbsp;</div></li><li><div>              $centinel-&gt;cavv = $this-&gt;get_centinel_value(&quot;Cavv&quot;);&nbsp;</div></li><li><div>              $centinel-&gt;eciflag = $this-&gt;get_centinel_value(&quot;EciFlag&quot;);&nbsp;</div></li><li><div>              $centinel-&gt;enrolled = WC()-&gt;session-&gt;get('Centinel_Enrolled');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;do_payment($order, $card-&gt;number, $card-&gt;type, $card-&gt;exp_month, $card-&gt;exp_year, $card-&gt;cvc, $centinel-&gt;paresstatus, &quot;Y&quot;, $centinel-&gt;cavv, $centinel-&gt;eciflag, $centinel-&gt;xid, $card-&gt;start_month, $card-&gt;start_year);&nbsp;</div></li><li><div>              $this-&gt;clear_centinel_session();&nbsp;</div></li><li><div>              wp_redirect($redirect_url);&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $order-&gt;update_status('failed', sprintf(apply_filters('angelleye_pc_3d_secure_authentication', __('3D Secure error: %s', 'woocommerce-gateway-paypal-pro')), $this-&gt;get_centinel_value(&quot;ErrorDesc&quot;)));&nbsp;</div></li><li><div>              throw new Exception(__('Payer Authentication failed. Please try a different payment method.', 'woocommerce-gateway-paypal-pro'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>          wc_add_notice($e-&gt;getMessage(), 'error');&nbsp;</div></li><li><div>          wp_redirect($order-&gt;get_checkout_payment_url(true));&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * do_payment</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Makes the request to PayPal's DoDirectPayment API</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $order</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_number</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_type</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_exp_month</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_exp_year</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $card_csc</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelPAResStatus (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelEnrolled (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelCavv (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelEciFlag (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $centinelXid (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function do_payment($order, $card_number, $card_type, $card_exp_month, $card_exp_year, $card_csc, $centinelPAResStatus = '', $centinelEnrolled = '', $centinelCavv = '', $centinelEciFlag = '', $centinelXid = '', $start_month = '', $start_year = '') {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Display message to user if session has expired.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if (sizeof(WC()-&gt;cart-&gt;get_cart()) == 0) {&nbsp;</div></li><li><div>          $pc_session_expired_error = apply_filters('angelleye_pc_session_expired_error', sprintf(__('Sorry, your session has expired. &lt;a href=%s&gt;Return to homepage &rarr;&lt;/a&gt;', 'paypal-for-woocommerce'), '&quot;' . home_url() . '&quot;'));&nbsp;</div></li><li><div>          wc_add_notice($pc_session_expired_error, &quot;error&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if the PayPal class has already been established.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create PayPal object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($GLOBALS['wp_rewrite'])) {&nbsp;</div></li><li><div>          $GLOBALS['wp_rewrite'] = new WP_Rewrite();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($_POST['paypal_pro-card-cardholder-first'])) {&nbsp;</div></li><li><div>          $firstname = wc_clean($_POST['paypal_pro-card-cardholder-first']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $firstname = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>      }       &nbsp;</div></li><li><div>         &nbsp;</div></li><li><div>      if(!empty($_POST['paypal_pro-card-cardholder-last'])) {&nbsp;</div></li><li><div>          $lastname = wc_clean($_POST['paypal_pro-card-cardholder-last']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $lastname = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $card_exp = $card_exp_month . $card_exp_year;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Generate PayPal request</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $DPFields = array(&nbsp;</div></li><li><div>          'paymentaction' =&gt; ($order-&gt;get_total() &gt; 0) ? $this-&gt;payment_action : 'Authorization', <span class="comment"><span class="comment">// How you want to obtain payment.  Authorization indidicates the payment is a basic auth subject to settlement with Auth & Capture.  Sale indicates that this is a final sale for which you are requesting payment.  Default is Sale.</span></span>&nbsp;</div></li><li><div>          'ipaddress' =&gt; $this-&gt;get_user_ip(), <span class="comment"><span class="comment">// Required.  IP address of the payer's browser.</span></span>&nbsp;</div></li><li><div>          'returnfmfdetails' =&gt; '1'                   <span class="comment"><span class="comment">// Flag to determine whether you want the results returned by FMF.  1 or 0.  Default is 0.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $CCDetails = array(&nbsp;</div></li><li><div>          'creditcardtype' =&gt; $card_type, <span class="comment"><span class="comment">// Required. Type of credit card.  Visa, MasterCard, Discover, Amex, Maestro, Solo.  If Maestro or Solo, the currency code must be GBP.  In addition, either start date or issue number must be specified.</span></span>&nbsp;</div></li><li><div>          'acct' =&gt; $card_number, <span class="comment"><span class="comment">// Required.  Credit card number.  No spaces or punctuation.</span></span>&nbsp;</div></li><li><div>          'expdate' =&gt; $card_exp, <span class="comment"><span class="comment">// Required.  Credit card expiration date.  Format is MMYYYY</span></span>&nbsp;</div></li><li><div>          'cvv2' =&gt; $card_csc, <span class="comment"><span class="comment">// Requirements determined by your PayPal account settings.  Security digits for credit card.</span></span>&nbsp;</div></li><li><div>          'startdate' =&gt; $start_month . $start_year, <span class="comment"><span class="comment">// Month and year that Maestro or Solo card was issued.  MMYYYY</span></span>&nbsp;</div></li><li><div>          'issuenumber' =&gt; ''                            <span class="comment"><span class="comment">// Issue number of Maestro or Solo card.  Two numeric digits max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $billing_address_1 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_1 : $order-&gt;get_billing_address_1();&nbsp;</div></li><li><div>      $billing_address_2 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_2 : $order-&gt;get_billing_address_2();&nbsp;</div></li><li><div>      $billing_city = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_city : $order-&gt;get_billing_city();&nbsp;</div></li><li><div>      $billing_postcode = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_postcode : $order-&gt;get_billing_postcode();&nbsp;</div></li><li><div>      $billing_country = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_country : $order-&gt;get_billing_country();&nbsp;</div></li><li><div>      $billing_state = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_state : $order-&gt;get_billing_state();&nbsp;</div></li><li><div>      $billing_email = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_email : $order-&gt;get_billing_email();&nbsp;</div></li><li><div>      $billing_phone = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $PayerInfo = array(&nbsp;</div></li><li><div>          'email' =&gt; $billing_email, <span class="comment"><span class="comment">// Email address of payer.</span></span>&nbsp;</div></li><li><div>          'firstname' =&gt; $firstname, <span class="comment"><span class="comment">// Required.  Payer's first name.</span></span>&nbsp;</div></li><li><div>          'lastname' =&gt; $lastname                            <span class="comment"><span class="comment">// Required.  Payer's last name.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $BillingAddress = array(&nbsp;</div></li><li><div>          'street' =&gt; $billing_address_1, <span class="comment"><span class="comment">// Required.  First street address.</span></span>&nbsp;</div></li><li><div>          'street2' =&gt; $billing_address_2, <span class="comment"><span class="comment">// Second street address.</span></span>&nbsp;</div></li><li><div>          'city' =&gt; $billing_city, <span class="comment"><span class="comment">// Required.  Name of City.</span></span>&nbsp;</div></li><li><div>          'state' =&gt; $billing_state, <span class="comment"><span class="comment">// Required. Name of State or Province.</span></span>&nbsp;</div></li><li><div>          'countrycode' =&gt; $billing_country, <span class="comment"><span class="comment">// Required.  Country code.</span></span>&nbsp;</div></li><li><div>          'zip' =&gt; $billing_postcode, <span class="comment"><span class="comment">// Required.  Postal code of payer.</span></span>&nbsp;</div></li><li><div>          'phonenum' =&gt; $billing_phone                        <span class="comment"><span class="comment">// Phone Number of payer.  20 char max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_first_name : $order-&gt;get_shipping_first_name();&nbsp;</div></li><li><div>      $shipping_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_last_name : $order-&gt;get_shipping_last_name();&nbsp;</div></li><li><div>      $ShippingAddress = array(&nbsp;</div></li><li><div>          'shiptoname' =&gt; $shipping_first_name . ' ' . $shipping_last_name, <span class="comment"><span class="comment">// Required if shipping is included.  Person's name associated with this address.  32 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostreet' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_1 : $order-&gt;get_shipping_address_1(), <span class="comment"><span class="comment">// Required if shipping is included.  First street address.  100 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostreet2' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_2 : $order-&gt;get_shipping_address_2(), <span class="comment"><span class="comment">// Second street address.</span></span>  100 char max.&nbsp;</div></li><li><div>          'shiptocity' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_city : $order-&gt;get_shipping_city(), <span class="comment"><span class="comment">// Required if shipping is included.  Name of city.  40 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostate' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_state : $order-&gt;get_shipping_state(), <span class="comment"><span class="comment">// Required if shipping is included.  Name of state or province.  40 char max.</span></span>&nbsp;</div></li><li><div>          'shiptozip' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_postcode : $order-&gt;get_shipping_postcode(), <span class="comment"><span class="comment">// Required if shipping is included.  Postal code of shipping address.  20 char max.</span></span>&nbsp;</div></li><li><div>          'shiptocountry' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_country : $order-&gt;get_shipping_country(), <span class="comment"><span class="comment">// Required if shipping is included.  Country code of shipping address.  2 char max.</span></span>&nbsp;</div></li><li><div>          'shiptophonenum' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone()                    <span class="comment"><span class="comment">// Phone number for shipping address.  20 char max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $customer_note_value = version_compare(WC_VERSION, '3.0', '&lt;') ? wptexturize($order-&gt;customer_note) : wptexturize($order-&gt;get_customer_note());&nbsp;</div></li><li><div>      $customer_note = $customer_note_value ? substr(preg_replace(&quot;/[^A-Za-z0-9 ]/&quot;, &quot;&quot;, $customer_note_value), 0, 256) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PaymentDetails = array(&nbsp;</div></li><li><div>          'amt' =&gt; AngellEYE_Gateway_Paypal::number_format($order-&gt;get_total()), <span class="comment"><span class="comment">// Required.  Total amount of order, including shipping, handling, and tax.</span></span>&nbsp;</div></li><li><div>          'currencycode' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency(), <span class="comment"><span class="comment">// Required.  Three-letter currency code.  Default is USD.</span></span>&nbsp;</div></li><li><div>          'insuranceamt' =&gt; '', <span class="comment"><span class="comment">// Total shipping insurance costs for this order.</span></span>&nbsp;</div></li><li><div>          'shipdiscamt' =&gt; '0.00', <span class="comment"><span class="comment">// Shipping discount for the order, specified as a negative number.</span></span>&nbsp;</div></li><li><div>          'handlingamt' =&gt; '0.00', <span class="comment"><span class="comment">// Total handling costs for the order.  If you specify handlingamt, you must also specify itemamt.</span></span>&nbsp;</div></li><li><div>          'desc' =&gt; '', <span class="comment"><span class="comment">// Description of the order the customer is purchasing.  127 char max.</span></span>&nbsp;</div></li><li><div>          'custom' =&gt; apply_filters( 'ae_ppddp_custom_parameter', json_encode( array( 'order_id' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id(), 'order_key' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;order_key : $order-&gt;get_order_key() ) ) , $order ), <span class="comment"><span class="comment">// Free-form field for your own use.  256 char max.</span></span>&nbsp;</div></li><li><div>          'invnum' =&gt; $this-&gt;invoice_id_prefix . preg_replace(&quot;/[^a-zA-Z0-9]/&quot;, &quot;&quot;, str_replace(&quot;#&quot;, &quot;&quot;, $order-&gt;get_order_number())), <span class="comment"><span class="comment">// Your own invoice or tracking number</span></span>&nbsp;</div></li><li><div>          'recurring' =&gt; ''                        <span class="comment"><span class="comment">// Flag to indicate a recurring transaction.  Value should be Y for recurring, or anything other than Y if it's not recurring.  To pass Y here, you must have an established billing agreement with the buyer.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($this-&gt;notifyurl) && !empty($this-&gt;notifyurl)) {&nbsp;</div></li><li><div>          $PaymentDetails['notifyurl'] = $this-&gt;notifyurl;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PaymentData = AngellEYE_Gateway_Paypal::calculate($order, $this-&gt;send_items);&nbsp;</div></li><li><div>      $OrderItems = array();&nbsp;</div></li><li><div>      if ($this-&gt;send_items) {&nbsp;</div></li><li><div>          foreach ($PaymentData['order_items'] as $item) {&nbsp;</div></li><li><div>              $Item = array(&nbsp;</div></li><li><div>                  'l_name' =&gt; $item['name'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_amt' =&gt; $item['amt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_number' =&gt; $item['number'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_qty' =&gt; $item['qty'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              array_push($OrderItems, $Item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//fix: itemamt = 0, make shipping or tax as order item</span></span>&nbsp;</div></li><li><div>      if ($PaymentData['itemamt'] == 0 && $PaymentData['shippingamt'] &gt; 0) {&nbsp;</div></li><li><div>          $OrderItems = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $Item = array(&nbsp;</div></li><li><div>              'l_name' =&gt; __(apply_filters('angelleye_paypal_pro_shipping_text', 'Shipping'), 'paypal-for-woocommerce'), <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_amt' =&gt; $PaymentData['shippingamt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_number' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_qty' =&gt; 1, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          array_push($OrderItems, $Item);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($PaymentData['taxamt'] &gt; 0) {&nbsp;</div></li><li><div>              $Item = array(&nbsp;</div></li><li><div>                  'l_name' =&gt; __(apply_filters('angelleye_paypal_pro_tax_text', 'Tax'), 'paypal-for-woocommerce'), <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_amt' =&gt; $PaymentData['taxamt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_number' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_qty' =&gt; 1, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              array_push($OrderItems, $Item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $PaymentDetails['itemamt'] = AngellEYE_Gateway_Paypal::number_format($order-&gt;get_total());&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Shipping/tax/item amount</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $PaymentDetails['taxamt'] = $PaymentData['taxamt'];&nbsp;</div></li><li><div>          $PaymentDetails['shippingamt'] = $PaymentData['shippingamt'];&nbsp;</div></li><li><div>          $PaymentDetails['itemamt'] = $PaymentData['itemamt'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * 3D Secure Params</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ($this-&gt;enable_3dsecure) {&nbsp;</div></li><li><div>          $Secure3D = array(&nbsp;</div></li><li><div>              'authstatus3ds' =&gt; $centinelPAResStatus, &nbsp;</div></li><li><div>              'mpivendor3ds' =&gt; $centinelEnrolled, &nbsp;</div></li><li><div>              'cavv' =&gt; $centinelCavv, &nbsp;</div></li><li><div>              'eci3ds' =&gt; $centinelEciFlag, &nbsp;</div></li><li><div>              'xid' =&gt; $centinelXid&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $Secure3D = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PayPalRequestData = array(&nbsp;</div></li><li><div>          'DPFields' =&gt; $DPFields, &nbsp;</div></li><li><div>          'CCDetails' =&gt; $CCDetails, &nbsp;</div></li><li><div>          'PayerInfo' =&gt; $PayerInfo, &nbsp;</div></li><li><div>          'BillingAddress' =&gt; $BillingAddress, &nbsp;</div></li><li><div>          'ShippingAddress' =&gt; $ShippingAddress, &nbsp;</div></li><li><div>          'PaymentDetails' =&gt; $PaymentDetails, &nbsp;</div></li><li><div>          'OrderItems' =&gt; $OrderItems, &nbsp;</div></li><li><div>          'Secure3D' =&gt; $Secure3D&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $log = $PayPalRequestData;&nbsp;</div></li><li><div>      $log['CCDetails']['acct'] = empty($log['CCDetails']['acct']) ? '****' : '';&nbsp;</div></li><li><div>      $log['CCDetails']['cvv2'] = empty($log['CCDetails']['cvv2']) ? '****' : '';&nbsp;</div></li><li><div>      $this-&gt;log('Do payment request ' . print_r($log, true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($_POST['wc-paypal_pro-payment-token']) && $_POST['wc-paypal_pro-payment-token'] != 'new') {&nbsp;</div></li><li><div>          $token_id = wc_clean($_POST['wc-paypal_pro-payment-token']);&nbsp;</div></li><li><div>          $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>          unset($PayPalRequestData['DPFields']);&nbsp;</div></li><li><div>          $PayPalRequestData['DRTFields'] = array(&nbsp;</div></li><li><div>              'referenceid' =&gt; $token-&gt;get_token(), &nbsp;</div></li><li><div>              'paymentaction' =&gt; ($order-&gt;get_total() &gt; 0) ? $this-&gt;payment_action : 'Authorization', &nbsp;</div></li><li><div>              'returnfmfdetails' =&gt; '1', &nbsp;</div></li><li><div>              'softdescriptor' =&gt; $this-&gt;softdescriptor&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $PayPalResult = $PayPal-&gt;DoReferenceTransaction(apply_filters('angelleye_woocommerce_paypal_pro_do_reference_transaction_request_args', $PayPalRequestData));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $PayPalResult = $PayPal-&gt;DoDirectPayment(apply_filters('angelleye_woocommerce_paypal_pro_do_direct_payment_request_args', $PayPalRequestData));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Pass data into class for processing with PayPal and load the response array into $PayPalResult</span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       *  cURL Error Handling #146</span>&nbsp;</div></li><li><div><span class="comment">       * @since    1.1.8</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      AngellEYE_Gateway_Paypal::angelleye_paypal_for_woocommerce_curl_error_handler($PayPalResult, $methos_name = 'DoDirectPayment', $gateway = 'PayPal Website Payments Pro (DoDirectPayment)', $this-&gt;error_email_notify);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PayPalRequest = isset($PayPalResult['RAWREQUEST']) ? $PayPalResult['RAWREQUEST'] : '';&nbsp;</div></li><li><div>      $PayPalResponse = isset($PayPalResult['RAWRESPONSE']) ? $PayPalResult['RAWRESPONSE'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log('Request: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalRequest)), true));&nbsp;</div></li><li><div>      $this-&gt;log('Response: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalResponse)), true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($PayPalResult['RAWRESPONSE'])) {&nbsp;</div></li><li><div>          $pc_empty_response = apply_filters('ae_ppddp_paypal_response_empty_message', __('Empty PayPal response.', 'paypal-for-woocommerce'), $PayPalResult);&nbsp;</div></li><li><div>          throw new Exception($pc_empty_response);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($PayPal-&gt;APICallSuccessful($PayPalResult['ACK'])) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Add order note</span></span>&nbsp;</div></li><li><div>          $order-&gt;add_order_note(sprintf(__('PayPal Pro payment completed (Transaction ID: %s, Correlation ID: %s)', 'paypal-for-woocommerce'), $PayPalResult['TRANSACTIONID'], $PayPalResult['CORRELATIONID']));&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//$order-&gt;add_order_note(&quot;PayPal Results: &quot;.print_r($PayPalResult, true));</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** Checkout Note */</span></span>&nbsp;</div></li><li><div>          if (isset($_POST) && !empty($_POST['order_comments'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Update post 37</span></span>&nbsp;</div></li><li><div>              $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>              $checkout_note = array(&nbsp;</div></li><li><div>                  'ID' =&gt; $order_id, &nbsp;</div></li><li><div>                  'post_excerpt' =&gt; $_POST['order_comments'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              wp_update_post($checkout_note);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Add order notes for AVS result</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $avs_response_code = isset($PayPalResult['AVSCODE']) ? $PayPalResult['AVSCODE'] : '';&nbsp;</div></li><li><div>          $avs_response_message = $PayPal-&gt;GetAVSCodeMessage($avs_response_code);&nbsp;</div></li><li><div>          $avs_response_order_note = __('Address Verification Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>          $avs_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>          $avs_response_order_note .= $avs_response_code;&nbsp;</div></li><li><div>          $avs_response_order_note .= $avs_response_message != '' ? ' - ' . $avs_response_message : '';&nbsp;</div></li><li><div>          $order-&gt;add_order_note($avs_response_order_note);&nbsp;</div></li><li><div>          $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>          $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>          if ($old_wc) {&nbsp;</div></li><li><div>              update_post_meta($order_id, '_AVSCODE', $avs_response_code);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_post_meta($order-&gt;get_id(), '_AVSCODE', $avs_response_code);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Add order notes for CVV2 result</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $cvv2_response_code = isset($PayPalResult['CVV2MATCH']) ? $PayPalResult['CVV2MATCH'] : '';&nbsp;</div></li><li><div>          $cvv2_response_message = $PayPal-&gt;GetCVV2CodeMessage($cvv2_response_code);&nbsp;</div></li><li><div>          $cvv2_response_order_note = __('Card Security Code Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>          $cvv2_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>          $cvv2_response_order_note .= $cvv2_response_code;&nbsp;</div></li><li><div>          $cvv2_response_order_note .= $cvv2_response_message != '' ? ' - ' . $cvv2_response_message : '';&nbsp;</div></li><li><div>          $order-&gt;add_order_note($cvv2_response_order_note);&nbsp;</div></li><li><div>          if ($old_wc) {&nbsp;</div></li><li><div>              update_post_meta($order_id, '_CVV2MATCH', $cvv2_response_code);&nbsp;</div></li><li><div>              update_post_meta($order_id, 'is_sandbox', $this-&gt;testmode);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_post_meta($order-&gt;get_id(), '_CVV2MATCH', $cvv2_response_code);&nbsp;</div></li><li><div>              update_post_meta($order-&gt;get_id(), 'is_sandbox', $this-&gt;testmode);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          do_action('before_save_payment_token', $order_id);&nbsp;</div></li><li><div>          if(!empty($_POST['wc-paypal_pro-payment-token']) && $_POST['wc-paypal_pro-payment-token'] == 'new') {&nbsp;</div></li><li><div>              if(!empty($_POST['wc-paypal_pro-new-payment-method']) && $_POST['wc-paypal_pro-new-payment-method'] == true) {&nbsp;</div></li><li><div>                  $TRANSACTIONID = $PayPalResult['TRANSACTIONID'];&nbsp;</div></li><li><div>                  $token = new WC_Payment_Token_CC();&nbsp;</div></li><li><div>                  if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>                  $token-&gt;set_user_id( get_current_user_id() );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $token-&gt;set_token( $TRANSACTIONID );&nbsp;</div></li><li><div>                  $token-&gt;set_gateway_id( $this-&gt;id );&nbsp;</div></li><li><div>                  $token-&gt;set_card_type( AngellEYE_Utility::card_type_from_account_number($PayPalRequestData['CCDetails']['acct']));&nbsp;</div></li><li><div>                  $token-&gt;set_last4( substr( $PayPalRequestData['CCDetails']['acct'], -4 ) );&nbsp;</div></li><li><div>                  $token-&gt;set_expiry_month( substr( $PayPalRequestData['CCDetails']['expdate'], 0, 2 ) );&nbsp;</div></li><li><div>                  $token-&gt;set_expiry_year( substr( $PayPalRequestData['CCDetails']['expdate'], 2, 5 ) );&nbsp;</div></li><li><div>                  $this-&gt;save_payment_token($order, $TRANSACTIONID);&nbsp;</div></li><li><div>                  $save_result = $token-&gt;save();&nbsp;</div></li><li><div>                  if ($save_result) {&nbsp;</div></li><li><div>                      $order-&gt;add_payment_token($token);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Payment complete</span></span>&nbsp;</div></li><li><div>          if($PayPalResult['ACK'] == 'SuccessWithWarning' && !empty($PayPalResult['L_ERRORCODE0'])) {&nbsp;</div></li><li><div>              if($this-&gt;fraud_management_filters == 'place_order_on_hold_for_further_review' && $PayPalResult['L_ERRORCODE0'] == '11610') {&nbsp;</div></li><li><div>                  $error = !empty($PayPalResult['L_LONGMESSAGE0']) ? $PayPalResult['L_LONGMESSAGE0'] : $PayPalResult['L_SHORTMESSAGE0'];&nbsp;</div></li><li><div>                  $order-&gt;update_status('on-hold', $error);&nbsp;</div></li><li><div>              } elseif ($PayPalResult['L_ERRORCODE0'] == '10574') {&nbsp;</div></li><li><div>                  $error = !empty($PayPalResult['L_LONGMESSAGE0']) ? $PayPalResult['L_LONGMESSAGE0'] : $PayPalResult['L_SHORTMESSAGE0'];&nbsp;</div></li><li><div>                  $order-&gt;add_order_note('ERROR MESSAGE: ' . $error);&nbsp;</div></li><li><div>                  $order-&gt;payment_complete($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              } elseif (!empty($PayPalResult['L_ERRORCODE0'])) {&nbsp;</div></li><li><div>                  $error = !empty($PayPalResult['L_LONGMESSAGE0']) ? $PayPalResult['L_LONGMESSAGE0'] : $PayPalResult['L_SHORTMESSAGE0'];&nbsp;</div></li><li><div>                  $order-&gt;add_order_note('ERROR MESSAGE: ' . $error);&nbsp;</div></li><li><div>                  $order-&gt;update_status('on-hold', $error);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $order-&gt;payment_complete($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $order-&gt;payment_complete($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          if ($this-&gt;payment_action == &quot;Authorization&quot;) {&nbsp;</div></li><li><div>              if ($old_wc) {&nbsp;</div></li><li><div>                  update_post_meta($order_id, '_first_transaction_id', $PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>                  update_post_meta($order-&gt;get_id(), '_first_transaction_id', $PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $payment_order_meta = array('_transaction_id' =&gt; $PayPalResult['TRANSACTIONID'], '_payment_action' =&gt; $this-&gt;payment_action);&nbsp;</div></li><li><div>              AngellEYE_Utility::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>              AngellEYE_Utility::angelleye_paypal_for_woocommerce_add_paypal_transaction($PayPalResult, $order, $this-&gt;payment_action);&nbsp;</div></li><li><div>              $angelleye_utility = new AngellEYE_Utility(null, null);&nbsp;</div></li><li><div>              $angelleye_utility-&gt;angelleye_get_transactionDetails($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              $order-&gt;payment_complete($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              $order-&gt;add_order_note('Payment Action: ' . $this-&gt;payment_action);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Remove cart</span></span>&nbsp;</div></li><li><div>          WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Return thank you page redirect</span></span>&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Get error message</span></span>&nbsp;</div></li><li><div>          $error_code = isset($PayPalResult['ERRORS'][0]['L_ERRORCODE']) ? $PayPalResult['ERRORS'][0]['L_ERRORCODE'] : '';&nbsp;</div></li><li><div>          $long_message = isset($PayPalResult['ERRORS'][0]['L_LONGMESSAGE']) ? $PayPalResult['ERRORS'][0]['L_LONGMESSAGE'] : '';&nbsp;</div></li><li><div>          $error_message = $error_code . '-' . $long_message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Notice admin if has any issue from PayPal</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;error_email_notify) {&nbsp;</div></li><li><div>              $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>              $message = __(&quot;DoDirectPayment API call failed.&quot;, &quot;paypal-for-woocommerce&quot;) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Error Code: ', 'paypal-for-woocommerce') . $error_code . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Detailed Error Message: ', 'paypal-for-woocommerce') . $long_message . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('User IP: ', 'paypal-for-woocommerce') . $this-&gt;get_user_ip() . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Order ID: ') . $order_id . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Customer Name: ') . $firstname . ' ' . $lastname . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Customer Email: ') . $billing_email . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $pc_error_email_message = apply_filters('ae_ppddp_error_email_message', $message, $error_code, $long_message);&nbsp;</div></li><li><div>              $pc_error_email_subject = apply_filters('ae_ppddp_error_email_subject', &quot;PayPal Pro Error Notification&quot;, $error_code, $long_message);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_mail($admin_email, $pc_error_email_subject, $pc_error_email_message);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log('Error ' . print_r($PayPalResult['ERRORS'], true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $order-&gt;update_status('failed', sprintf(__('PayPal Pro payment failed (Correlation ID: %s). Payment was rejected due to an error: %s', &nbsp;</div></li><li><div>              'paypal-for-woocommerce'), $PayPalResult['CORRELATIONID'], '(' . $PayPalResult['L_ERRORCODE0'] . ') ' . '&quot;' . $error_message . '&quot;'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Generate error message based on Error Display Type setting</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;error_display_type == 'detailed') {&nbsp;</div></li><li><div>              $pc_display_type_error = __($error_message, 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $pc_display_type_notice = __('Payment error:', 'paypal-for-woocommerce') . ' ' . $error_message;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $pc_display_type_error = __('There was a problem connecting to the payment gateway.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $pc_display_type_notice = __('Payment error:', 'paypal-for-woocommerce') . ' ' . $error_message;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pc_display_type_error = apply_filters('ae_ppddp_error_exception', $pc_display_type_error, $error_code, $long_message);&nbsp;</div></li><li><div>          $pc_display_type_notice = apply_filters('ae_ppddp_error_user_display_message', $pc_display_type_notice, $error_code, $long_message);&nbsp;</div></li><li><div>          wc_add_notice($pc_display_type_notice, &quot;error&quot;);&nbsp;</div></li><li><div>          throw new Exception($pc_display_type_error);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get user's IP address</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_user_ip() {&nbsp;</div></li><li><div>      return WC_Geolocation::get_ip_address();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * clear_centinel_session function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function clear_centinel_session() {&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_ErrorNo', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_ErrorDesc', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_TransactionId', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_OrderId', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_Enrolled', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_ACSUrl', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_Payload', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_EciFlag', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_card_start_month', null);&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set('Centinel_card_start_year', null);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process a refund if supported</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $order_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param  float $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $reason</span>&nbsp;</div></li><li><div><span class="comment">   * @return  bool|wp_error True or false based on success, or a WP_Error object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_refund($order_id, $amount = null, $reason = '') {&nbsp;</div></li><li><div>      $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      $this-&gt;log('Begin Refund');&nbsp;</div></li><li><div>      $this-&gt;log('Order ID: ' . print_r($order_id, true));&nbsp;</div></li><li><div>      $this-&gt;log('Transaction ID: ' . print_r($order-&gt;get_transaction_id(), true));&nbsp;</div></li><li><div>      if (!$order || !$order-&gt;get_transaction_id() || !$this-&gt;api_username || !$this-&gt;api_password || !$this-&gt;api_signature) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if the PayPal class has already been established.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create PayPal object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>      if ($reason) {&nbsp;</div></li><li><div>          if (255 &lt; strlen($reason)) {&nbsp;</div></li><li><div>              $reason = substr($reason, 0, 252) . '...';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $reason = html_entity_decode($reason, ENT_NOQUOTES, 'UTF-8');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prepare request arrays</span>&nbsp;</div></li><li><div>      $RTFields = array(&nbsp;</div></li><li><div>          'transactionid' =&gt; $order-&gt;get_transaction_id(), <span class="comment">// Required.  PayPal transaction ID for the order you're refunding.</span>&nbsp;</div></li><li><div>          'payerid' =&gt; '', <span class="comment">// Encrypted PayPal customer account ID number.  Note:  Either transaction ID or payer ID must be specified.  127 char max</span>&nbsp;</div></li><li><div>          'invoiceid' =&gt; '', <span class="comment">// Your own invoice tracking number.</span>&nbsp;</div></li><li><div>          'refundtype' =&gt; $order-&gt;get_total() == $amount ? 'Full' : 'Partial', <span class="comment">// Required.  Type of refund.  Must be Full, Partial, or Other.</span>&nbsp;</div></li><li><div>          'amt' =&gt; AngellEYE_Gateway_Paypal::number_format($amount), <span class="comment">// Refund Amt.  Required if refund type is Partial.</span>&nbsp;</div></li><li><div>          'currencycode' =&gt; version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;get_order_currency() : $order-&gt;get_currency(), <span class="comment">// Three-letter currency code.  Required for Partial Refunds.  Do not use for full refunds.</span>&nbsp;</div></li><li><div>          'note' =&gt; $reason, <span class="comment">// Custom memo about the refund.  255 char max.</span>&nbsp;</div></li><li><div>          'retryuntil' =&gt; '', <span class="comment">// Maximum time until you must retry the refund.  Note:  this field does not apply to point-of-sale transactions.</span>&nbsp;</div></li><li><div>          'refundsource' =&gt; '', <span class="comment">// Type of PayPal funding source (balance or eCheck) that can be used for auto refund.  Values are:  any, default, instant, eCheck</span>&nbsp;</div></li><li><div>          'merchantstoredetail' =&gt; '', <span class="comment">// Information about the merchant store.</span>&nbsp;</div></li><li><div>          'refundadvice' =&gt; '', <span class="comment">// Flag to indicate that the buyer was already given store credit for a given transaction.  Values are:  1/0</span>&nbsp;</div></li><li><div>          'refunditemdetails' =&gt; '', <span class="comment">// Details about the individual items to be returned.</span>&nbsp;</div></li><li><div>          'msgsubid' =&gt; '', <span class="comment">// A message ID used for idempotence to uniquely identify a message.</span>&nbsp;</div></li><li><div>          'storeid' =&gt; '', <span class="comment">// ID of a merchant store.  This field is required for point-of-sale transactions.  50 char max.</span>&nbsp;</div></li><li><div>          'terminalid' =&gt; ''                                <span class="comment">// ID of the terminal.  50 char max.</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PayPalRequestData = array('RTFields' =&gt; $RTFields);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Pass data into class for processing with PayPal and load the response array into $PayPalResult</span></span></span>&nbsp;</div></li><li><div>      $PayPalResult = $PayPal-&gt;RefundTransaction(apply_filters('angelleye_woocommerce_paypal_pro_refund_request_args', $PayPalRequestData));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       *  cURL Error Handling #146</span>&nbsp;</div></li><li><div><span class="comment">       * @since    1.1.8</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      AngellEYE_Gateway_Paypal::angelleye_paypal_for_woocommerce_curl_error_handler($PayPalResult, $methos_name = 'RefundTransaction', $gateway = 'PayPal Website Payments Pro (DoDirectPayment)', $this-&gt;error_email_notify);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $PayPalRequest = isset($PayPalResult['RAWREQUEST']) ? $PayPalResult['RAWREQUEST'] : '';&nbsp;</div></li><li><div>      $PayPalResponse = isset($PayPalResult['RAWRESPONSE']) ? $PayPalResult['RAWRESPONSE'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log('Refund Request: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalRequest)), true));&nbsp;</div></li><li><div>      $this-&gt;log('Refund Response: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalResponse)), true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($PayPal-&gt;APICallSuccessful($PayPalResult['ACK'])) {&nbsp;</div></li><li><div>          $order-&gt;add_order_note('Refund Transaction ID:' . $PayPalResult['REFUNDTRANSACTIONID']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $max_remaining_refund = wc_format_decimal($order-&gt;get_total() - $order-&gt;get_total_refunded());&nbsp;</div></li><li><div>          if (!$max_remaining_refund &gt; 0) {&nbsp;</div></li><li><div>              $order-&gt;update_status('refunded');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (ob_get_length()) ob_end_clean();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $pc_message = apply_filters('ae_ppddp_refund_error_message', $PayPalResult['L_LONGMESSAGE0'], $PayPalResult['L_ERRORCODE'], $PayPalResult);&nbsp;</div></li><li><div>          return new WP_Error('ec_refund-error', $pc_message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_woocommerce_credit_card_form_start($current_id) {&nbsp;</div></li><li><div>      if ($this-&gt;enable_cardholder_first_last_name && $current_id == $this-&gt;id) {&nbsp;</div></li><li><div>          $fields['card-cardholder-first'] = '&lt;p class=&quot;form-row form-row-first&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot;&gt;' . __('Cardholder First Name', 'paypal-for-woocommerce') . '&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-cardholder&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . esc_attr__('First Name', 'paypal-for-woocommerce') . '&quot; name=&quot;' . $current_id . '-card-cardholder-first' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;';&nbsp;</div></li><li><div>          $fields['card-cardholder-last'] = '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot;&gt;' . __('Cardholder Last Name', 'paypal-for-woocommerce') . '&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot; class=&quot;input-text wc-credit-card-form-cardholder&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . __('Last Name', 'paypal-for-woocommerce') . '&quot; name=&quot;' . $current_id . '-card-cardholder-last' . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($fields as $field) {&nbsp;</div></li><li><div>              echo $field;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get and clean a value from $this-&gt;centinel_client because the SDK does a poor job of cleaning.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_centinel_value($key) {&nbsp;</div></li><li><div>      $value = $this-&gt;centinel_client-&gt;getValue($key);&nbsp;</div></li><li><div>      if (empty($value)) {&nbsp;</div></li><li><div>          $value = WC()-&gt;session-&gt;get($key);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $value = wc_clean($value);&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function field_name($name) {&nbsp;</div></li><li><div>      return ' name=&quot;' . esc_attr($this-&gt;id . '-' . $name) . '&quot; ';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_paypal_pro_credit_card_form_fields($default_fields, $current_gateway_id) {&nbsp;</div></li><li><div>      if ($current_gateway_id == $this-&gt;id) {&nbsp;</div></li><li><div>          $fields = array();&nbsp;</div></li><li><div>          $class = 'form-row form-row-first';&nbsp;</div></li><li><div>          if (isset($this-&gt;available_card_types[WC()-&gt;countries-&gt;get_base_country()]['Maestro'])) {&nbsp;</div></li><li><div>              $class = 'form-row form-row-last';&nbsp;</div></li><li><div>              $fields = array(&nbsp;</div></li><li><div>                  'card-number-field' =&gt; '&lt;p class=&quot;form-row form-row-wide&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot;&gt;' . __('Card number', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot; class=&quot;input-text wc-credit-card-form-card-number&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;cc-number&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; placeholder=&quot;&bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull;&quot; ' . $this-&gt;field_name('card-number') . ' /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;', &nbsp;</div></li><li><div>                  'card-expiry-field' =&gt; $this-&gt;paypal_for_woocommerce_paypal_pro_credit_card_form_expiration_date_selectbox($class), &nbsp;</div></li><li><div>                  '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>          &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot;&gt;' . __('Card Security Code', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-card-cvc&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;off&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; maxlength=&quot;4&quot; placeholder=&quot;' . esc_attr__('CVC', 'woocommerce') . '&quot; ' . $this-&gt;field_name('card-cvc') . ' style=&quot;width:100px&quot; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;', &nbsp;</div></li><li><div>                  'card-startdate-field' =&gt; '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot;&gt;' . __('Start Date (MM/YY)', 'paypal-for-woocommerce') . '&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-startdate&quot; class=&quot;input-text wc-credit-card-form-card-expiry&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; placeholder=&quot;' . __('MM / YY', 'paypal-for-woocommerce') . '&quot; name=&quot;' . $this-&gt;id . '-card-startdate' . '&quot; /&gt;&nbsp;</div></li><li><div>                   &lt;/p&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $fields = array(&nbsp;</div></li><li><div>                  'card-number-field' =&gt; '&lt;p class=&quot;form-row form-row-wide&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot;&gt;' . __('Card number', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot; class=&quot;input-text wc-credit-card-form-card-number&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;cc-number&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; placeholder=&quot;&bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull;&quot; ' . $this-&gt;field_name('card-number') . ' /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;', &nbsp;</div></li><li><div>                  'card-expiry-field' =&gt; $this-&gt;paypal_for_woocommerce_paypal_pro_credit_card_form_expiration_date_selectbox($class), &nbsp;</div></li><li><div>                  '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>          &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot;&gt;' . __('Card Security Code', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-card-cvc&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;off&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; maxlength=&quot;4&quot; placeholder=&quot;' . esc_attr__('CVC', 'woocommerce') . '&quot; ' . $this-&gt;field_name('card-cvc') . ' style=&quot;width:100px&quot; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $fields;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $default_fields;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_transaction_url($order) {&nbsp;</div></li><li><div>      $sandbox_transaction_url = 'https:<span class="comment">//www.sandbox.paypal.com/cgi-bin/webscr?cmd=_view-a-trans&id=%s';</span>&nbsp;</div></li><li><div>      $live_transaction_url = 'https:<span class="comment">//www.paypal.com/cgi-bin/webscr?cmd=_view-a-trans&id=%s';</span>&nbsp;</div></li><li><div>      $old_wc = version_compare( WC_VERSION, '3.0', '&lt;' );&nbsp;</div></li><li><div>      $is_sandbox = $old_wc ? get_post_meta( $order-&gt;id, 'is_sandbox', true ) : get_post_meta($order-&gt;get_id(), 'is_sandbox', true);&nbsp;</div></li><li><div>      if ($is_sandbox == true) {&nbsp;</div></li><li><div>          $this-&gt;view_transaction_url = $sandbox_transaction_url;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (empty($is_sandbox)) {&nbsp;</div></li><li><div>              if (  $this-&gt;testmode == true ) {&nbsp;</div></li><li><div>                  $this-&gt;view_transaction_url = $sandbox_transaction_url;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;view_transaction_url = $live_transaction_url;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;view_transaction_url = $live_transaction_url;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return parent::get_transaction_url($order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function paypal_pro_error_handler($request_name = '', $redirect_url = '', $result) {&nbsp;</div></li><li><div>      $ErrorCode = urldecode($result[&quot;L_ERRORCODE0&quot;]);&nbsp;</div></li><li><div>      $ErrorShortMsg = urldecode($result[&quot;L_SHORTMESSAGE0&quot;]);&nbsp;</div></li><li><div>      $ErrorLongMsg = urldecode($result[&quot;L_LONGMESSAGE0&quot;]);&nbsp;</div></li><li><div>      $ErrorSeverityCode = urldecode($result[&quot;L_SEVERITYCODE0&quot;]);&nbsp;</div></li><li><div>      $this-&gt;log(__($request_name . 'API call failed. ', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>      $this-&gt;log(__('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg);&nbsp;</div></li><li><div>      $this-&gt;log(__('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg);&nbsp;</div></li><li><div>      $this-&gt;log(__('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode);&nbsp;</div></li><li><div>      $this-&gt;log(__('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode);&nbsp;</div></li><li><div>      $message = '';&nbsp;</div></li><li><div>      if ($this-&gt;error_email_notify) {&nbsp;</div></li><li><div>          $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>          $message .= __($request_name . &quot; API call failed.&quot;, &quot;paypal-for-woocommerce&quot;) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>          $message .= __('Error Code: ', 'paypal-for-woocommerce') . $ErrorCode . &quot;\n&quot;;&nbsp;</div></li><li><div>          $message .= __('Error Severity Code: ', 'paypal-for-woocommerce') . $ErrorSeverityCode . &quot;\n&quot;;&nbsp;</div></li><li><div>          $message .= __('Short Error Message: ', 'paypal-for-woocommerce') . $ErrorShortMsg . &quot;\n&quot;;&nbsp;</div></li><li><div>          $message .= __('Detailed Error Message: ', 'paypal-for-woocommerce') . $ErrorLongMsg . &quot;\n&quot;;&nbsp;</div></li><li><div>          $message .= __('User IP: ', 'paypal-for-woocommerce') . $this-&gt;get_user_ip() . &quot;\n&quot;;&nbsp;</div></li><li><div>          $error_email_notify_mes = apply_filters('ae_ppec_error_email_message', $message, $ErrorCode, $ErrorSeverityCode, $ErrorShortMsg, $ErrorLongMsg);&nbsp;</div></li><li><div>          $subject = &quot;PayPal Express Checkout Error Notification&quot;;&nbsp;</div></li><li><div>          $error_email_notify_subject = apply_filters('ae_ppec_error_email_subject', $subject);&nbsp;</div></li><li><div>          wp_mail($admin_email, $error_email_notify_subject, $error_email_notify_mes);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;error_display_type == 'detailed') {&nbsp;</div></li><li><div>          $sec_error_notice = $ErrorCode . ' - ' . $ErrorLongMsg;&nbsp;</div></li><li><div>          $error_display_type_message = sprintf(__($sec_error_notice, 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $error_display_type_message = sprintf(__('There was a problem paying with PayPal.  Please try another method.', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $error_display_type_message = apply_filters('ae_ppec_error_user_display_message', $error_display_type_message, $ErrorCode, $ErrorLongMsg);&nbsp;</div></li><li><div>      wc_add_notice($error_display_type_message, 'error');&nbsp;</div></li><li><div>      if (!is_ajax()) {&nbsp;</div></li><li><div>          wp_redirect($redirect_url);&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'fail', &nbsp;</div></li><li><div>              'redirect' =&gt; $redirect_url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_payment_method() {&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;validate_fields();&nbsp;</div></li><li><div>      $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>      $DPFields = array(&nbsp;</div></li><li><div>          'paymentaction' =&gt; 'Authorization', &nbsp;</div></li><li><div>          'ipaddress' =&gt; $this-&gt;get_user_ip(), &nbsp;</div></li><li><div>          'returnfmfdetails' =&gt; '1'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $CCDetails = array(&nbsp;</div></li><li><div>          'creditcardtype' =&gt; $card-&gt;type, &nbsp;</div></li><li><div>          'acct' =&gt; $card-&gt;number, &nbsp;</div></li><li><div>          'expdate' =&gt; $card-&gt;exp_month . $card-&gt;exp_year, &nbsp;</div></li><li><div>          'cvv2' =&gt; $card-&gt;cvc&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PaymentDetails = array(&nbsp;</div></li><li><div>          'amt' =&gt; 0, &nbsp;</div></li><li><div>          'currencycode' =&gt; get_woocommerce_currency(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPalRequestData = array(&nbsp;</div></li><li><div>          'DPFields' =&gt; $DPFields, &nbsp;</div></li><li><div>          'CCDetails' =&gt; $CCDetails, &nbsp;</div></li><li><div>          'PaymentDetails' =&gt; $PaymentDetails&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $result = $PayPal-&gt;DoDirectPayment(apply_filters('angelleye_woocommerce_do_direct_payment_request_args', $PayPalRequestData));&nbsp;</div></li><li><div>      if ($result['ACK'] == 'Success' || $result['ACK'] == 'SuccessWithWarning') {&nbsp;</div></li><li><div>          $customer_id = get_current_user_id();&nbsp;</div></li><li><div>          $TRANSACTIONID = $result['TRANSACTIONID'];&nbsp;</div></li><li><div>          $token = new WC_Payment_Token_CC();&nbsp;</div></li><li><div>          $token-&gt;set_user_id( $customer_id );&nbsp;</div></li><li><div>          $token-&gt;set_token( $TRANSACTIONID );&nbsp;</div></li><li><div>          $token-&gt;set_gateway_id( $this-&gt;id );&nbsp;</div></li><li><div>          $token-&gt;set_card_type( AngellEYE_Utility::card_type_from_account_number($PayPalRequestData['CCDetails']['acct']));&nbsp;</div></li><li><div>          $token-&gt;set_last4( substr( $PayPalRequestData['CCDetails']['acct'], -4 ) );&nbsp;</div></li><li><div>          $token-&gt;set_expiry_month( substr( $PayPalRequestData['CCDetails']['expdate'], 0, 2 ) );&nbsp;</div></li><li><div>          $token-&gt;set_expiry_year( substr( $PayPalRequestData['CCDetails']['expdate'], 2, 5 ) );&nbsp;</div></li><li><div>          $save_result = $token-&gt;save();&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; wc_get_account_endpoint_url('payment-methods')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>         &nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $redirect_url = wc_get_account_endpoint_url('payment-methods');&nbsp;</div></li><li><div>          $this-&gt;paypal_pro_error_handler($request_name = 'DoDirectPayment', $redirect_url, $result);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_paypal_pro_encrypt_gateway_api($settings) {&nbsp;</div></li><li><div>      if( !empty($settings['sandbox_api_password'])) {&nbsp;</div></li><li><div>          $api_password = $settings['sandbox_api_password'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $api_password = $settings['api_password'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(strlen($api_password) &gt; 35 ) {&nbsp;</div></li><li><div>          return $settings;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if( !empty($settings['is_encrypt']) ) {&nbsp;</div></li><li><div>          $gateway_settings_keys = array('sandbox_api_username', 'sandbox_api_password', 'sandbox_api_signature', 'api_username', 'api_password', 'api_signature');&nbsp;</div></li><li><div>          foreach ($gateway_settings_keys as $gateway_settings_key =&gt; $gateway_settings_value) {&nbsp;</div></li><li><div>              if( !empty( $settings[$gateway_settings_value]) ) {&nbsp;</div></li><li><div>                  $settings[$gateway_settings_value] = AngellEYE_Utility::crypting($settings[$gateway_settings_value], $action = 'e');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function angelleye_paypal_pro_email_instructions($order, $sent_to_admin, $plain_text = false) {&nbsp;</div></li><li><div>      $payment_method = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;payment_method : $order-&gt;get_payment_method();&nbsp;</div></li><li><div>      if ( $sent_to_admin && 'paypal_pro' === $payment_method ) {&nbsp;</div></li><li><div>          if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>              require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>          $old_wc = version_compare( WC_VERSION, '3.0', '&lt;' );&nbsp;</div></li><li><div>          $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>          $avscode = $old_wc ? get_post_meta( $order-&gt;id, '_AVSCODE', true ) : get_post_meta($order-&gt;get_id(), '_AVSCODE', true);&nbsp;</div></li><li><div>          if ( ! empty( $avscode ) ) {&nbsp;</div></li><li><div>              $avs_response_message = $PayPal-&gt;GetAVSCodeMessage($avscode);&nbsp;</div></li><li><div>              echo '&lt;h2 class=&quot;wc-avs-details-heading&quot;&gt;' . __( 'Address Verification Details', 'paypal-for-woocommerce' ) . '&lt;/h2&gt;' . PHP_EOL;&nbsp;</div></li><li><div>              echo '&lt;ul class=&quot;wc-avs-details order_details avs_details&quot;&gt;' . PHP_EOL;&nbsp;</div></li><li><div>              $avs_details_fields = apply_filters( 'angelleye_avs_details_fields', array(&nbsp;</div></li><li><div>                      'avs_response_code'=&gt; array(&nbsp;</div></li><li><div>                              'label' =&gt; __( 'AVS Response Code', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                              'value' =&gt; $avscode&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                      'avs_response_message' =&gt; array(&nbsp;</div></li><li><div>                              'label' =&gt; __( 'AVS Response Message', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                              'value' =&gt; $avs_response_message&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), $order_id );&nbsp;</div></li><li><div>              foreach ( $avs_details_fields as $field_key =&gt; $field ) {&nbsp;</div></li><li><div>                      if ( ! empty( $field['value'] ) ) {&nbsp;</div></li><li><div>                              echo '&lt;li class=&quot;' . esc_attr( $field_key ) . '&quot;&gt;' . esc_attr( $field['label'] ) . ': &lt;strong&gt;' . wptexturize( $field['value'] ) . '&lt;/strong&gt;&lt;/li&gt;' . PHP_EOL;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              echo '&lt;/ul&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $old_wc = version_compare( WC_VERSION, '3.0', '&lt;' );&nbsp;</div></li><li><div>          $cvvmatch = $old_wc ? get_post_meta( $order-&gt;id, '_CVV2MATCH', true ) : get_post_meta($order-&gt;get_id(), '_CVV2MATCH', true);&nbsp;</div></li><li><div>          if ( ! empty( $cvvmatch ) ) {&nbsp;</div></li><li><div>              $cvv2_response_message = $PayPal-&gt;GetCVV2CodeMessage($cvvmatch);&nbsp;</div></li><li><div>              echo '&lt;h2 class=&quot;wc-cvv2-details-heading&quot;&gt;' . __( 'Card Security Code Details', 'paypal-for-woocommerce' ) . '&lt;/h2&gt;' . PHP_EOL;&nbsp;</div></li><li><div>              echo '&lt;ul class=&quot;wc-cvv2-details order_details cvv2_details&quot;&gt;' . PHP_EOL;&nbsp;</div></li><li><div>              $cvv_details_fields = apply_filters( 'angelleye_cvv2_details_fields', array(&nbsp;</div></li><li><div>                      'cvv2_response_code'=&gt; array(&nbsp;</div></li><li><div>                              'label' =&gt; __( 'AVS Response Code', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                              'value' =&gt; $cvvmatch&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                      'cvv2_response_message' =&gt; array(&nbsp;</div></li><li><div>                              'label' =&gt; __( 'AVS Response Message', 'paypal-for-woocommerce' ), &nbsp;</div></li><li><div>                              'value' =&gt; $cvv2_response_message&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), $order_id );&nbsp;</div></li><li><div>              foreach ( $cvv_details_fields as $field_key =&gt; $field ) {&nbsp;</div></li><li><div>                      if ( ! empty( $field['value'] ) ) {&nbsp;</div></li><li><div>                              echo '&lt;li class=&quot;' . esc_attr( $field_key ) . '&quot;&gt;' . esc_attr( $field['label'] ) . ': &lt;strong&gt;' . wptexturize( $field['value'] ) . '&lt;/strong&gt;&lt;/li&gt;' . PHP_EOL;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function process_subscription_payment($order) {&nbsp;</div></li><li><div>      if (!class_exists('Angelleye_PayPal')) {&nbsp;</div></li><li><div>          require_once('lib/angelleye/paypal-php-library/includes/paypal.class.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $PayPalConfig = array(&nbsp;</div></li><li><div>          'Sandbox' =&gt; $this-&gt;testmode == 'yes' ? TRUE : FALSE, &nbsp;</div></li><li><div>          'APIUsername' =&gt; $this-&gt;api_username, &nbsp;</div></li><li><div>          'APIPassword' =&gt; $this-&gt;api_password, &nbsp;</div></li><li><div>          'APISignature' =&gt; $this-&gt;api_signature, &nbsp;</div></li><li><div>          'Force_tls_one_point_two' =&gt; $this-&gt;Force_tls_one_point_two&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $PayPal = new Angelleye_PayPal($PayPalConfig);&nbsp;</div></li><li><div>      if(!empty($_POST['paypal_pro-card-cardholder-first'])) {&nbsp;</div></li><li><div>          $firstname = wc_clean($_POST['paypal_pro-card-cardholder-first']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $firstname = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>      }       &nbsp;</div></li><li><div>         &nbsp;</div></li><li><div>      if(!empty($_POST['paypal_pro-card-cardholder-last'])) {&nbsp;</div></li><li><div>          $lastname = wc_clean($_POST['paypal_pro-card-cardholder-last']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $lastname = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $card_exp = $card_exp_month . $card_exp_year;&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Generate PayPal request</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $DPFields = array(&nbsp;</div></li><li><div>          'paymentaction' =&gt; ($order-&gt;get_total() &gt; 0) ? $this-&gt;payment_action : 'Authorization', <span class="comment"><span class="comment">// How you want to obtain payment.  Authorization indidicates the payment is a basic auth subject to settlement with Auth & Capture.  Sale indicates that this is a final sale for which you are requesting payment.  Default is Sale.</span></span>&nbsp;</div></li><li><div>          'ipaddress' =&gt; $this-&gt;get_user_ip(), <span class="comment"><span class="comment">// Required.  IP address of the payer's browser.</span></span>&nbsp;</div></li><li><div>          'returnfmfdetails' =&gt; '1'                   <span class="comment"><span class="comment">// Flag to determine whether you want the results returned by FMF.  1 or 0.  Default is 0.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $CCDetails = array(&nbsp;</div></li><li><div>          'creditcardtype' =&gt; $card_type, <span class="comment"><span class="comment">// Required. Type of credit card.  Visa, MasterCard, Discover, Amex, Maestro, Solo.  If Maestro or Solo, the currency code must be GBP.  In addition, either start date or issue number must be specified.</span></span>&nbsp;</div></li><li><div>          'acct' =&gt; $card_number, <span class="comment"><span class="comment">// Required.  Credit card number.  No spaces or punctuation.</span></span>&nbsp;</div></li><li><div>          'expdate' =&gt; $card_exp, <span class="comment"><span class="comment">// Required.  Credit card expiration date.  Format is MMYYYY</span></span>&nbsp;</div></li><li><div>          'cvv2' =&gt; $card_csc, <span class="comment"><span class="comment">// Requirements determined by your PayPal account settings.  Security digits for credit card.</span></span>&nbsp;</div></li><li><div>          'startdate' =&gt; $start_month . $start_year, <span class="comment"><span class="comment">// Month and year that Maestro or Solo card was issued.  MMYYYY</span></span>&nbsp;</div></li><li><div>          'issuenumber' =&gt; ''                            <span class="comment"><span class="comment">// Issue number of Maestro or Solo card.  Two numeric digits max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $billing_company = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_company : $order-&gt;get_billing_company();&nbsp;</div></li><li><div>      $billing_address_1 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_1 : $order-&gt;get_billing_address_1();&nbsp;</div></li><li><div>      $billing_address_2 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_2 : $order-&gt;get_billing_address_2();&nbsp;</div></li><li><div>      $billing_city = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_city : $order-&gt;get_billing_city();&nbsp;</div></li><li><div>      $billing_postcode = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_postcode : $order-&gt;get_billing_postcode();&nbsp;</div></li><li><div>      $billing_country = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_country : $order-&gt;get_billing_country();&nbsp;</div></li><li><div>      $billing_state = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_state : $order-&gt;get_billing_state();&nbsp;</div></li><li><div>      $billing_email = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_email : $order-&gt;get_billing_email();&nbsp;</div></li><li><div>      $billing_phone = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $PayerInfo = array(&nbsp;</div></li><li><div>          'email' =&gt; $billing_email, <span class="comment"><span class="comment">// Email address of payer.</span></span>&nbsp;</div></li><li><div>          'firstname' =&gt; $firstname, <span class="comment"><span class="comment">// Required.  Payer's first name.</span></span>&nbsp;</div></li><li><div>          'lastname' =&gt; $lastname                            <span class="comment"><span class="comment">// Required.  Payer's last name.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $BillingAddress = array(&nbsp;</div></li><li><div>          'street' =&gt; $billing_address_1, <span class="comment"><span class="comment">// Required.  First street address.</span></span>&nbsp;</div></li><li><div>          'street2' =&gt; $billing_address_2, <span class="comment"><span class="comment">// Second street address.</span></span>&nbsp;</div></li><li><div>          'city' =&gt; $billing_city, <span class="comment"><span class="comment">// Required.  Name of City.</span></span>&nbsp;</div></li><li><div>          'state' =&gt; $billing_state, <span class="comment"><span class="comment">// Required. Name of State or Province.</span></span>&nbsp;</div></li><li><div>          'countrycode' =&gt; $billing_country, <span class="comment"><span class="comment">// Required.  Country code.</span></span>&nbsp;</div></li><li><div>          'zip' =&gt; $billing_postcode, <span class="comment"><span class="comment">// Required.  Postal code of payer.</span></span>&nbsp;</div></li><li><div>          'phonenum' =&gt; $billing_phone                        <span class="comment"><span class="comment">// Phone Number of payer.  20 char max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_first_name : $order-&gt;get_shipping_first_name();&nbsp;</div></li><li><div>      $shipping_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_last_name : $order-&gt;get_shipping_last_name();&nbsp;</div></li><li><div>      $ShippingAddress = array(&nbsp;</div></li><li><div>          'shiptoname' =&gt; $shipping_first_name . ' ' . $shipping_last_name, <span class="comment"><span class="comment">// Required if shipping is included.  Person's name associated with this address.  32 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostreet' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_1 : $order-&gt;get_shipping_address_1(), <span class="comment"><span class="comment">// Required if shipping is included.  First street address.  100 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostreet2' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_2 : $order-&gt;get_shipping_address_2(), <span class="comment"><span class="comment">// Second street address.</span></span>  100 char max.&nbsp;</div></li><li><div>          'shiptocity' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_city : $order-&gt;get_shipping_city(), <span class="comment"><span class="comment">// Required if shipping is included.  Name of city.  40 char max.</span></span>&nbsp;</div></li><li><div>          'shiptostate' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_state : $order-&gt;get_shipping_state(), <span class="comment"><span class="comment">// Required if shipping is included.  Name of state or province.  40 char max.</span></span>&nbsp;</div></li><li><div>          'shiptozip' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_postcode : $order-&gt;get_shipping_postcode(), <span class="comment"><span class="comment">// Required if shipping is included.  Postal code of shipping address.  20 char max.</span></span>&nbsp;</div></li><li><div>          'shiptocountry' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_country : $order-&gt;get_shipping_country(), <span class="comment"><span class="comment">// Required if shipping is included.  Country code of shipping address.  2 char max.</span></span>&nbsp;</div></li><li><div>          'shiptophonenum' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone()                    <span class="comment"><span class="comment">// Phone number for shipping address.  20 char max.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $customer_note_value = version_compare(WC_VERSION, '3.0', '&lt;') ? wptexturize($order-&gt;customer_note) : wptexturize($order-&gt;get_customer_note());&nbsp;</div></li><li><div>      $customer_note = $customer_note_value ? substr(preg_replace(&quot;/[^A-Za-z0-9 ]/&quot;, &quot;&quot;, $customer_note_value), 0, 256) : '';&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $PaymentDetails = array(&nbsp;</div></li><li><div>          'amt' =&gt; AngellEYE_Gateway_Paypal::number_format($order-&gt;get_total()), <span class="comment"><span class="comment">// Required.  Total amount of order, including shipping, handling, and tax.</span></span>&nbsp;</div></li><li><div>          'currencycode' =&gt; get_woocommerce_currency(), <span class="comment"><span class="comment">// Required.  Three-letter currency code.  Default is USD.</span></span>&nbsp;</div></li><li><div>          'insuranceamt' =&gt; '', <span class="comment"><span class="comment">// Total shipping insurance costs for this order.</span></span>&nbsp;</div></li><li><div>          'shipdiscamt' =&gt; '0.00', <span class="comment"><span class="comment">// Shipping discount for the order, specified as a negative number.</span></span>&nbsp;</div></li><li><div>          'handlingamt' =&gt; '0.00', <span class="comment"><span class="comment">// Total handling costs for the order.  If you specify handlingamt, you must also specify itemamt.</span></span>&nbsp;</div></li><li><div>          'desc' =&gt; '', <span class="comment"><span class="comment">// Description of the order the customer is purchasing.  127 char max.</span></span>&nbsp;</div></li><li><div>          'custom' =&gt; apply_filters('ae_ppddp_custom_parameter', $customer_note, $order), <span class="comment"><span class="comment">// Free-form field for your own use.  256 char max.</span></span>&nbsp;</div></li><li><div>          'invnum' =&gt; $this-&gt;invoice_id_prefix . preg_replace(&quot;/[^a-zA-Z0-9]/&quot;, &quot;&quot;, $order_id), <span class="comment"><span class="comment">// Your own invoice or tracking number</span></span>&nbsp;</div></li><li><div>          'recurring' =&gt; ''                        <span class="comment"><span class="comment">// Flag to indicate a recurring transaction.  Value should be Y for recurring, or anything other than Y if it's not recurring.  To pass Y here, you must have an established billing agreement with the buyer.</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      if (isset($this-&gt;notifyurl) && !empty($this-&gt;notifyurl)) {&nbsp;</div></li><li><div>          $PaymentDetails['notifyurl'] = $this-&gt;notifyurl;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $PaymentData = AngellEYE_Gateway_Paypal::calculate($order, $this-&gt;send_items);&nbsp;</div></li><li><div>      $OrderItems = array();&nbsp;</div></li><li><div>      if ($this-&gt;send_items) {&nbsp;</div></li><li><div>          foreach ($PaymentData['order_items'] as $item) {&nbsp;</div></li><li><div>              $Item = array(&nbsp;</div></li><li><div>                  'l_name' =&gt; $item['name'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_amt' =&gt; $item['amt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_number' =&gt; $item['number'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_qty' =&gt; $item['qty'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              array_push($OrderItems, $Item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//fix: itemamt = 0, make shipping or tax as order item</span></span>&nbsp;</div></li><li><div>      if ($PaymentData['itemamt'] == 0 && $PaymentData['shippingamt'] &gt; 0) {&nbsp;</div></li><li><div>          $OrderItems = array();&nbsp;</div></li><li><div>          $Item = array(&nbsp;</div></li><li><div>              'l_name' =&gt; __(apply_filters('angelleye_paypal_pro_shipping_text', 'Shipping'), 'paypal-for-woocommerce'), <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_amt' =&gt; $PaymentData['shippingamt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_number' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_qty' =&gt; 1, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>              'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          array_push($OrderItems, $Item);&nbsp;</div></li><li><div>          if ($PaymentData['taxamt'] &gt; 0) {&nbsp;</div></li><li><div>              $Item = array(&nbsp;</div></li><li><div>                  'l_name' =&gt; __(apply_filters('angelleye_paypal_pro_tax_text', 'Tax'), 'paypal-for-woocommerce'), <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Name.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_desc' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item description.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_amt' =&gt; $PaymentData['taxamt'], <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Cost of individual item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_number' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item Number.  127 char max.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_qty' =&gt; 1, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item quantity.  Must be any positive integer.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_taxamt' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Item's sales tax amount.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemnumber' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay auction number of item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemauctiontxnid' =&gt; '', <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay transaction ID of purchased item.</span></span></span></span></span></span>&nbsp;</div></li><li><div>                  'l_ebayitemorderid' =&gt; ''                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// eBay order ID for the item.</span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              array_push($OrderItems, $Item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $PaymentDetails['itemamt'] = AngellEYE_Gateway_Paypal::number_format($order-&gt;get_total());&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Shipping/tax/item amount</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $PaymentDetails['taxamt'] = $PaymentData['taxamt'];&nbsp;</div></li><li><div>          $PaymentDetails['shippingamt'] = $PaymentData['shippingamt'];&nbsp;</div></li><li><div>          $PaymentDetails['itemamt'] = $PaymentData['itemamt'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * 3D Secure Params</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ($this-&gt;enable_3dsecure) {&nbsp;</div></li><li><div>          $Secure3D = array(&nbsp;</div></li><li><div>              'authstatus3ds' =&gt; $centinelPAResStatus, &nbsp;</div></li><li><div>              'mpivendor3ds' =&gt; $centinelEnrolled, &nbsp;</div></li><li><div>              'cavv' =&gt; $centinelCavv, &nbsp;</div></li><li><div>              'eci3ds' =&gt; $centinelEciFlag, &nbsp;</div></li><li><div>              'xid' =&gt; $centinelXid&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $Secure3D = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $PayPalRequestData = array(&nbsp;</div></li><li><div>          'DPFields' =&gt; $DPFields, &nbsp;</div></li><li><div>          'CCDetails' =&gt; $CCDetails, &nbsp;</div></li><li><div>          'PayerInfo' =&gt; $PayerInfo, &nbsp;</div></li><li><div>          'BillingAddress' =&gt; $BillingAddress, &nbsp;</div></li><li><div>          'ShippingAddress' =&gt; $ShippingAddress, &nbsp;</div></li><li><div>          'PaymentDetails' =&gt; $PaymentDetails, &nbsp;</div></li><li><div>          'OrderItems' =&gt; $OrderItems, &nbsp;</div></li><li><div>          'Secure3D' =&gt; $Secure3D&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $log = $PayPalRequestData;&nbsp;</div></li><li><div>      $log['CCDetails']['acct'] = isset($log['CCDetails']['acct']) ? '****' : '';&nbsp;</div></li><li><div>      $log['CCDetails']['cvv2'] = isset($log['CCDetails']['cvv2']) ? '****' : '';&nbsp;</div></li><li><div>      $this-&gt;log('Do payment request ' . print_r($log, true));&nbsp;</div></li><li><div>      if (!empty($_POST['wc-paypal_pro-payment-token']) && $_POST['wc-paypal_pro-payment-token'] != 'new') {&nbsp;</div></li><li><div>          $token_id = wc_clean($_POST['wc-paypal_pro-payment-token']);&nbsp;</div></li><li><div>          $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>          unset($PayPalRequestData['DPFields']);&nbsp;</div></li><li><div>          $PayPalRequestData['DRTFields'] = array(&nbsp;</div></li><li><div>              'referenceid' =&gt; $token-&gt;get_token(), &nbsp;</div></li><li><div>              'paymentaction' =&gt; ($order-&gt;get_total() &gt; 0) ? $this-&gt;payment_action : 'Authorization', &nbsp;</div></li><li><div>              'returnfmfdetails' =&gt; '1', &nbsp;</div></li><li><div>              'softdescriptor' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $PayPalResult = $PayPal-&gt;DoReferenceTransaction($PayPalRequestData);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $PayPalResult = $PayPal-&gt;DoDirectPayment($PayPalRequestData);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Pass data into class for processing with PayPal and load the response array into $PayPalResult</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       *  cURL Error Handling #146</span>&nbsp;</div></li><li><div><span class="comment">       * @since    1.1.8</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      AngellEYE_Gateway_Paypal::angelleye_paypal_for_woocommerce_curl_error_handler($PayPalResult, $methos_name = 'DoDirectPayment', $gateway = 'PayPal Website Payments Pro (DoDirectPayment)', $this-&gt;error_email_notify);&nbsp;</div></li><li><div>      $PayPalRequest = isset($PayPalResult['RAWREQUEST']) ? $PayPalResult['RAWREQUEST'] : '';&nbsp;</div></li><li><div>      $PayPalResponse = isset($PayPalResult['RAWRESPONSE']) ? $PayPalResult['RAWRESPONSE'] : '';&nbsp;</div></li><li><div>      $this-&gt;log('Request: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalRequest)), true));&nbsp;</div></li><li><div>      $this-&gt;log('Response: ' . print_r($PayPal-&gt;NVPToArray($PayPal-&gt;MaskAPIResult($PayPalResponse)), true));&nbsp;</div></li><li><div>      if (empty($PayPalResult['RAWRESPONSE'])) {&nbsp;</div></li><li><div>          $pc_empty_response = apply_filters('ae_ppddp_paypal_response_empty_message', __('Empty PayPal response.', 'paypal-for-woocommerce'), $PayPalResult);&nbsp;</div></li><li><div>          throw new Exception($pc_empty_response);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($PayPal-&gt;APICallSuccessful($PayPalResult['ACK'])) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Add order note</span></span>&nbsp;</div></li><li><div>          $order-&gt;add_order_note(sprintf(__('PayPal Pro payment completed (Transaction ID: %s, Correlation ID: %s)', 'paypal-for-woocommerce'), $PayPalResult['TRANSACTIONID'], $PayPalResult['CORRELATIONID']));&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//$order-&gt;add_order_note(&quot;PayPal Results: &quot;.print_r($PayPalResult, true));</span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** Checkout Note */</span></span>&nbsp;</div></li><li><div>          if (isset($_POST) && !empty($_POST['order_comments'])) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Update post 37</span></span>&nbsp;</div></li><li><div>              $checkout_note = array(&nbsp;</div></li><li><div>                  'ID' =&gt; $order_id, &nbsp;</div></li><li><div>                  'post_excerpt' =&gt; $_POST['order_comments'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              wp_update_post($checkout_note);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Add order notes for AVS result</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $avs_response_code = isset($PayPalResult['AVSCODE']) ? $PayPalResult['AVSCODE'] : '';&nbsp;</div></li><li><div>          $avs_response_message = $PayPal-&gt;GetAVSCodeMessage($avs_response_code);&nbsp;</div></li><li><div>          $avs_response_order_note = __('Address Verification Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>          $avs_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>          $avs_response_order_note .= $avs_response_code;&nbsp;</div></li><li><div>          $avs_response_order_note .= $avs_response_message != '' ? ' - ' . $avs_response_message : '';&nbsp;</div></li><li><div>          $order-&gt;add_order_note($avs_response_order_note);&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Add order notes for CVV2 result</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $cvv2_response_code = isset($PayPalResult['CVV2MATCH']) ? $PayPalResult['CVV2MATCH'] : '';&nbsp;</div></li><li><div>          $cvv2_response_message = $PayPal-&gt;GetCVV2CodeMessage($cvv2_response_code);&nbsp;</div></li><li><div>          $cvv2_response_order_note = __('Card Security Code Result', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>          $cvv2_response_order_note .= &quot;\n&quot;;&nbsp;</div></li><li><div>          $cvv2_response_order_note .= $cvv2_response_code;&nbsp;</div></li><li><div>          $cvv2_response_order_note .= $cvv2_response_message != '' ? ' - ' . $cvv2_response_message : '';&nbsp;</div></li><li><div>          $order-&gt;add_order_note($cvv2_response_order_note);&nbsp;</div></li><li><div>          $is_sandbox = $this-&gt;testmode == 'yes' ? true : false;&nbsp;</div></li><li><div>          update_post_meta($order_id, 'is_sandbox', $is_sandbox);&nbsp;</div></li><li><div>          if (!empty($_POST['wc-paypal_pro-payment-token']) && $_POST['wc-paypal_pro-payment-token'] == 'new') {&nbsp;</div></li><li><div>              if (!empty($_POST['wc-paypal_pro-new-payment-method']) && $_POST['wc-paypal_pro-new-payment-method'] == true) {&nbsp;</div></li><li><div>                  $customer_id = $order-&gt;get_user_id();&nbsp;</div></li><li><div>                  $TRANSACTIONID = $PayPalResult['TRANSACTIONID'];&nbsp;</div></li><li><div>                  $token = new WC_Payment_Token_CC();&nbsp;</div></li><li><div>                  $token-&gt;set_user_id($customer_id);&nbsp;</div></li><li><div>                  $token-&gt;set_token($TRANSACTIONID);&nbsp;</div></li><li><div>                  $token-&gt;set_gateway_id($this-&gt;id);&nbsp;</div></li><li><div>                  $token-&gt;set_card_type(AngellEYE_Utility::card_type_from_account_number($PayPalRequestData['CCDetails']['acct']));&nbsp;</div></li><li><div>                  $token-&gt;set_last4(substr($PayPalRequestData['CCDetails']['acct'], -4));&nbsp;</div></li><li><div>                  $token-&gt;set_expiry_month(date('m'));&nbsp;</div></li><li><div>                  $token-&gt;set_expiry_year(date('Y', strtotime('+2 years')));&nbsp;</div></li><li><div>                  $save_result = $token-&gt;save();&nbsp;</div></li><li><div>                  $this-&gt;save_payment_token($order, $TRANSACTIONID);&nbsp;</div></li><li><div>                  if ($save_result) {&nbsp;</div></li><li><div>                      $order-&gt;add_payment_token($token);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Payment complete</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;payment_action == &quot;Sale&quot;) {&nbsp;</div></li><li><div>              $order-&gt;payment_complete($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_post_meta($order_id, '_first_transaction_id', $PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              $payment_order_meta = array('_transaction_id' =&gt; $PayPalResult['TRANSACTIONID'], '_payment_action' =&gt; $this-&gt;payment_action);&nbsp;</div></li><li><div>              AngellEYE_Utility::angelleye_add_order_meta($order_id, $payment_order_meta);&nbsp;</div></li><li><div>              AngellEYE_Utility::angelleye_paypal_for_woocommerce_add_paypal_transaction($PayPalResult, $order, $this-&gt;payment_action);&nbsp;</div></li><li><div>              $angelleye_utility = new AngellEYE_Utility(null, null);&nbsp;</div></li><li><div>              $angelleye_utility-&gt;angelleye_get_transactionDetails($PayPalResult['TRANSACTIONID']);&nbsp;</div></li><li><div>              $order-&gt;update_status('on-hold');&nbsp;</div></li><li><div>              $order-&gt;add_order_note('Payment Action: ' . $this-&gt;payment_action);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Remove cart</span></span>&nbsp;</div></li><li><div>          WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Return thank you page redirect</span></span>&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Get error message</span></span>&nbsp;</div></li><li><div>          $error_code = isset($PayPalResult['ERRORS'][0]['L_ERRORCODE']) ? $PayPalResult['ERRORS'][0]['L_ERRORCODE'] : '';&nbsp;</div></li><li><div>          $long_message = isset($PayPalResult['ERRORS'][0]['L_LONGMESSAGE']) ? $PayPalResult['ERRORS'][0]['L_LONGMESSAGE'] : '';&nbsp;</div></li><li><div>          $error_message = $error_code . '-' . $long_message;&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Notice admin if has any issue from PayPal</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;error_email_notify) {&nbsp;</div></li><li><div>              $admin_email = get_option(&quot;admin_email&quot;);&nbsp;</div></li><li><div>              $message = __(&quot;DoDirectPayment API call failed.&quot;, &quot;paypal-for-woocommerce&quot;) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Error Code: ', 'paypal-for-woocommerce') . $error_code . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Detailed Error Message: ', 'paypal-for-woocommerce') . $long_message . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('User IP: ', 'paypal-for-woocommerce') . $this-&gt;get_user_ip() . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Order ID: ') . $order_id . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Customer Name: ') . $firstname . ' ' . $lastname . &quot;\n&quot;;&nbsp;</div></li><li><div>              $message .= __('Customer Email: ') . $billing_email . &quot;\n&quot;;&nbsp;</div></li><li><div>              $pc_error_email_message = apply_filters('ae_ppddp_error_email_message', $message, $error_code, $long_message);&nbsp;</div></li><li><div>              $pc_error_email_subject = apply_filters('ae_ppddp_error_email_subject', &quot;PayPal Pro Error Notification&quot;, $error_code, $long_message);&nbsp;</div></li><li><div>              wp_mail($admin_email, $pc_error_email_subject, $pc_error_email_message);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;log('Error ' . print_r($PayPalResult['ERRORS'], true));&nbsp;</div></li><li><div>          $order-&gt;update_status('failed', sprintf(__('PayPal Pro payment failed (Correlation ID: %s). Payment was rejected due to an error: %s', 'paypal-for-woocommerce'), $PayPalResult['CORRELATIONID'], '(' . $PayPalResult['L_ERRORCODE0'] . ') ' . '&quot;' . $error_message . '&quot;'));&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Generate error message based on Error Display Type setting</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;error_display_type == 'detailed') {&nbsp;</div></li><li><div>              $pc_display_type_error = __($error_message, 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $pc_display_type_notice = __('Payment error:', 'paypal-for-woocommerce') . ' ' . $error_message;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $pc_display_type_error = __('There was a problem connecting to the payment gateway.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              $pc_display_type_notice = __('Payment error:', 'paypal-for-woocommerce') . ' ' . $error_message;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $pc_display_type_error = apply_filters('ae_ppddp_error_exception', $pc_display_type_error, $error_code, $long_message);&nbsp;</div></li><li><div>          $pc_display_type_notice = apply_filters('ae_ppddp_error_user_display_message', $pc_display_type_notice, $error_code, $long_message);&nbsp;</div></li><li><div>          wc_add_notice($pc_display_type_notice, &quot;error&quot;);&nbsp;</div></li><li><div>          throw new Exception($pc_display_type_error);&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save_payment_token($order, $payment_tokens_id) {&nbsp;</div></li><li><div>      <span class="comment">// Store source in the order</span>&nbsp;</div></li><li><div>      $order_id = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if (!empty($payment_tokens_id)) {&nbsp;</div></li><li><div>          update_post_meta($order_id, '_payment_tokens_id', $payment_tokens_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  public function free_signup_order_payment($order_id) {&nbsp;</div></li><li><div>      $order = new WC_Order($order_id);&nbsp;</div></li><li><div>      $this-&gt;log('Processing order #' . $order_id);&nbsp;</div></li><li><div>      if (!empty($_POST['wc-paypal_pro-payment-token']) && $_POST['wc-paypal_pro-payment-token'] != 'new') {&nbsp;</div></li><li><div>          $token_id = wc_clean($_POST['wc-paypal_pro-payment-token']);&nbsp;</div></li><li><div>          $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>          $order-&gt;payment_complete($token-&gt;get_token());&nbsp;</div></li><li><div>          update_post_meta($order_id, '_first_transaction_id', $token-&gt;get_token());&nbsp;</div></li><li><div>          $order-&gt;add_order_note('Payment Action: ' . $this-&gt;payment_action);&nbsp;</div></li><li><div>          WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>PayPal for WooCommerce</li><li><span></span>1.4.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>