<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="1.4.3" data-slug="paypal-for-woocommerce" data-type="file" data-id="80875"><head xmlns="http://www.w3.org/1999/xhtml"><title> classes-wc-gateway-braintree-angelleye | file | Paypal For Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, paypal-for-woocommerce, 1.4.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5abf1f58c8708229461e77c8ff7ca00a' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/classes-wc-gateway-braintree-angelleye/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-braintree-angelleye%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-wc-gateway-braintree-angelleye%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-paypal-for-woocommerce-1.4.3-file-classes-wc-gateway-braintree-angelleye","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="classes-wc-gateway-braintree-angelleye" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to paypal-for-woocommerce." href="http://hookr.io/plugins/paypal-for-woocommerce/" class="plugin"><span property="name">paypal-for-woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.4.3." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/" class="H_VERSION"><span property="name">1.4.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">classes-wc-gateway-braintree-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="497"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/all/" title="All">All <span class="count badge">497</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="157"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/hooks/" title="Hooks">Hooks <span class="count badge">157</span></a></li><li class="" data-id="action" data-count="32"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/actions/" title="Actions">Actions <span class="count badge">32</span></a></li><li class="" data-id="filter" data-count="125"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/filters/" title="Filters">Filters <span class="count badge">125</span></a></li><li class="" data-id="class" data-count="309"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/classes/" title="Classes">Classes <span class="count badge">309</span></a></li><li class="" data-id="constant" data-count="25"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/constants/" title="Constants">Constants <span class="count badge">25</span></a></li><li class="" data-id="function" data-count="6"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/functions/" title="Functions">Functions <span class="count badge">6</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/paypal-for-woocommerce/1.4.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/classes/wc-gateway-braintree-angelleye.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WC_Gateway_Braintree_AngellEYE class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @extends WC_Payment_Gateway</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_Gateway_Braintree_AngellEYE extends WC_Payment_Gateway_CC {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $customer_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;id = 'braintree';&nbsp;</div></li><li><div>      $this-&gt;icon = $this-&gt;get_option('card_icon', plugins_url('/assets/images/cards.png', plugin_basename(dirname(__FILE__))));&nbsp;</div></li><li><div>      if (is_ssl()) {&nbsp;</div></li><li><div>          $this-&gt;icon = preg_replace(&quot;/^http:/i&quot;, &quot;https:&quot;, $this-&gt;icon);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;icon = apply_filters('woocommerce_braintree_icon', $this-&gt;icon);&nbsp;</div></li><li><div>      $this-&gt;has_fields = true;&nbsp;</div></li><li><div>      $this-&gt;method_title = 'Braintree';&nbsp;</div></li><li><div>      $this-&gt;method_description = __('Credit Card payments Powered by PayPal / Braintree.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>      $this-&gt;supports = array(&nbsp;</div></li><li><div>          'products', &nbsp;</div></li><li><div>          'refunds'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;init_form_fields();&nbsp;</div></li><li><div>      $this-&gt;init_settings();&nbsp;</div></li><li><div>      $this-&gt;enable_tokenized_payments = $this-&gt;get_option('enable_tokenized_payments', 'no');&nbsp;</div></li><li><div>      if ($this-&gt;enable_tokenized_payments == 'yes') {&nbsp;</div></li><li><div>          $this-&gt;supports = array(&nbsp;</div></li><li><div>              'subscriptions', &nbsp;</div></li><li><div>              'products', &nbsp;</div></li><li><div>              'refunds', &nbsp;</div></li><li><div>              'subscription_cancellation', &nbsp;</div></li><li><div>              'subscription_reactivation', &nbsp;</div></li><li><div>              'subscription_suspension', &nbsp;</div></li><li><div>              'subscription_amount_changes', &nbsp;</div></li><li><div>              'subscription_payment_method_change', <span class="comment">// Subs 1.n compatibility.</span>&nbsp;</div></li><li><div>              'subscription_payment_method_change_customer', &nbsp;</div></li><li><div>              'subscription_payment_method_change_admin', &nbsp;</div></li><li><div>              'subscription_date_changes', &nbsp;</div></li><li><div>              'multiple_subscriptions', &nbsp;</div></li><li><div>              'add_payment_method', &nbsp;</div></li><li><div>              'tokenization'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;title = $this-&gt;get_option('title');&nbsp;</div></li><li><div>      $this-&gt;description = $this-&gt;get_option('description');&nbsp;</div></li><li><div>      $this-&gt;enabled = $this-&gt;get_option('enabled');&nbsp;</div></li><li><div>      $this-&gt;sandbox = 'yes' === $this-&gt;get_option('sandbox', 'yes');&nbsp;</div></li><li><div>      if ($this-&gt;sandbox == false) {&nbsp;</div></li><li><div>          $this-&gt;sandbox = AngellEYE_Utility::angelleye_paypal_for_woocommerce_is_set_sandbox_product();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;environment = $this-&gt;sandbox == false ? 'production' : 'sandbox';&nbsp;</div></li><li><div>      $this-&gt;merchant_id = $this-&gt;sandbox == false ? $this-&gt;get_option('merchant_id') : $this-&gt;get_option('sandbox_merchant_id');&nbsp;</div></li><li><div>      $this-&gt;private_key = $this-&gt;sandbox == false ? $this-&gt;get_option('private_key') : $this-&gt;get_option('sandbox_private_key');&nbsp;</div></li><li><div>      $this-&gt;public_key = $this-&gt;sandbox == false ? $this-&gt;get_option('public_key') : $this-&gt;get_option('sandbox_public_key');&nbsp;</div></li><li><div>      $this-&gt;enable_braintree_drop_in = $this-&gt;get_option('enable_braintree_drop_in') === &quot;yes&quot; ? true : false;&nbsp;</div></li><li><div>      $this-&gt;merchant_account_id = $this-&gt;sandbox == false ? $this-&gt;get_option('merchant_account_id') : $this-&gt;get_option('sandbox_merchant_account_id');&nbsp;</div></li><li><div>      $this-&gt;debug = 'yes' === $this-&gt;get_option('debug', 'no');&nbsp;</div></li><li><div>      $this-&gt;is_encrypt = $this-&gt;get_option('is_encrypt', 'no');&nbsp;</div></li><li><div>      $this-&gt;softdescriptor = $this-&gt;get_option('softdescriptor', '');&nbsp;</div></li><li><div>      add_action('woocommerce_update_options_payment_gateways_' . $this-&gt;id, array($this, 'process_admin_options'));&nbsp;</div></li><li><div>      add_filter('woocommerce_settings_api_sanitized_fields_' . $this-&gt;id, array($this, 'angelleye_braintree_encrypt_gateway_api'), 10, 1);&nbsp;</div></li><li><div>      $this-&gt;response = '';&nbsp;</div></li><li><div>      if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>          add_action('wp_enqueue_scripts', array($this, 'payment_scripts'), 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      add_action('admin_notices', array($this, 'checks'));&nbsp;</div></li><li><div>      add_filter('woocommerce_credit_card_form_fields', array($this, 'angelleye_braintree_credit_card_form_fields'), 10, 2);&nbsp;</div></li><li><div>      $this-&gt;customer_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Admin Panel Options</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_options() {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;h3&gt;&lt;?php _e('Braintree', 'paypal-for-woocommerce'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php _e($this-&gt;method_description, 'paypal-for-woocommerce'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php $this-&gt;generate_settings_html(); ?&gt;&nbsp;</div></li><li><div>          &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>              jQuery('#woocommerce_braintree_sandbox').change(function () {&nbsp;</div></li><li><div>                  sandbox = jQuery('#woocommerce_braintree_sandbox_public_key, #woocommerce_braintree_sandbox_private_key, #woocommerce_braintree_sandbox_merchant_id, #woocommerce_braintree_sandbox_merchant_account_id').closest('tr'), &nbsp;</div></li><li><div>                          production = jQuery('#woocommerce_braintree_public_key, #woocommerce_braintree_private_key, #woocommerce_braintree_merchant_id, #woocommerce_braintree_merchant_account_id').closest('tr');&nbsp;</div></li><li><div>                  if (jQuery(this).is(':checked')) {&nbsp;</div></li><li><div>                      sandbox.show();&nbsp;</div></li><li><div>                      production.hide();&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      sandbox.hide();&nbsp;</div></li><li><div>                      production.show();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }).change();&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;/table&gt; &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if SSL is enabled and notify the user</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function checks() {&nbsp;</div></li><li><div>      if ($this-&gt;enabled == 'no') {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (version_compare(phpversion(), '5.2.1', '&lt;')) {&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;' . sprintf(__('Braintree Error: Braintree requires PHP 5.2.1 and above. You are using version %s.', 'paypal-for-woocommerce'), phpversion()) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ('no' == get_option('woocommerce_force_ssl_checkout') && !class_exists('WordPressHTTPS') && $this-&gt;enable_braintree_drop_in == false && $this-&gt;sandbox == false) {&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;' . sprintf(__('Braintree is enabled, but the &lt;a href=&quot;%s&quot;&gt;force SSL option&lt;/a&gt; is disabled; your checkout may not be secure! Please enable SSL and ensure your server has a valid SSL certificate - Braintree custome credit card UI will only work in sandbox mode.', 'paypal-for-woocommerce'), admin_url('admin.php?page=wc-settings&tab=checkout')) . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;add_dependencies_admin_notices();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if this gateway is enabled</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_available() {&nbsp;</div></li><li><div>      if ('yes' != $this-&gt;enabled) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$this-&gt;merchant_id || !$this-&gt;public_key || !$this-&gt;private_key) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function validate_fields() {&nbsp;</div></li><li><div>      if (!$this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              if (isset($_POST['wc-braintree-payment-token']) && 'new' !== $_POST['wc-braintree-payment-token']) {&nbsp;</div></li><li><div>                  $token_id = wc_clean($_POST['wc-braintree-payment-token']);&nbsp;</div></li><li><div>                  $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>                  if ($token-&gt;get_user_id() !== get_current_user_id()) {&nbsp;</div></li><li><div>                      throw new Exception(__('Error processing checkout. Please try again.', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>                  if (empty($card-&gt;exp_month) || empty($card-&gt;exp_year)) {&nbsp;</div></li><li><div>                      throw new Exception(__('Card expiration date is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!ctype_digit($card-&gt;cvc)) {&nbsp;</div></li><li><div>                      throw new Exception(__('Card security code is invalid (only digits are allowed)', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!ctype_digit($card-&gt;exp_month) || !ctype_digit($card-&gt;exp_year) || $card-&gt;exp_month &gt; 12 || $card-&gt;exp_month &lt; 1 || $card-&gt;exp_year &lt; date('y')) {&nbsp;</div></li><li><div>                      throw new Exception(__('Card expiration date is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (empty($card-&gt;number) || !ctype_digit($card-&gt;number)) {&nbsp;</div></li><li><div>                      throw new Exception(__('Card number is invalid', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } catch (Exception $e) {&nbsp;</div></li><li><div>              wc_add_notice($e-&gt;getMessage(), 'error');&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              if (isset($_POST['braintree_token']) && !empty($_POST['braintree_token'])) {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  throw new Exception(__('Braintree payment method nonce is empty', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } catch (Exception $e) {&nbsp;</div></li><li><div>              wc_add_notice($e-&gt;getMessage(), 'error');&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialise Gateway Settings Form Fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init_form_fields() {&nbsp;</div></li><li><div>      $this-&gt;form_fields = array(&nbsp;</div></li><li><div>          'enabled' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable/Disable', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Braintree Payment Gateway', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; '', &nbsp;</div></li><li><div>              'default' =&gt; 'no'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'title' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Title', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the title which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; __('Credit Card', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'description' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Description', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'textarea', &nbsp;</div></li><li><div>              'description' =&gt; __('This controls the description which the user sees during checkout.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'Pay securely with your credit card.', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_braintree_drop_in' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Drop-in Payment UI', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Drop-in Payment UI', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Rather than showing a credit card form on your checkout, this shows the form on it\'s own page, thus making the process more secure and more PCI friendly.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Sandbox Mode', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Place the payment gateway in sandbox mode using sandbox API keys (real payments will not be taken).', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'yes'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_public_key' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Public Key', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_private_key' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Private Key', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_merchant_id' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Merchant ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sandbox_merchant_account_id' =&gt; array(&nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'title' =&gt; __('Sandbox Merchant Account Id', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'tool_tip' =&gt; true, &nbsp;</div></li><li><div>              'description' =&gt; __('NOTE: Not to be confused with the API key Merchant ID. The Merchant Account ID determines the currency that the payment is settled in. You can find your Merchant Account Id by logging into Braintree, &nbsp;</div></li><li><div>                               and clicking Settings &gt; Processing and scrolling to the bottom of the page.', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'public_key' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live Public Key', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'private_key' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live Private Key', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'merchant_id' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Live Merchant ID', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'password', &nbsp;</div></li><li><div>              'description' =&gt; __('Get your API keys from your Braintree account.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'merchant_account_id' =&gt; array(&nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'title' =&gt; __('Live Merchant Account Id', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'tool_tip' =&gt; true, &nbsp;</div></li><li><div>              'description' =&gt; __('NOTE: Not to be confused with the API key Merchant ID. The Merchant Account ID determines the currency that the payment is settled in. You can find your Merchant Account Id by logging into Braintree, &nbsp;</div></li><li><div>                               and clicking Settings &gt; Processing and scrolling to the bottom of the page.', 'paypal-for-woocommerce')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'enable_tokenized_payments' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('Enable Tokenized Payments', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'description' =&gt; __('Allow buyers to securely save payment details to their account for quick checkout / auto-ship orders in the future.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'class' =&gt; 'enable_tokenized_payments'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'softdescriptor' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Credit Card Statement Name', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'description' =&gt; __('The value entered here will be displayed on the buyer\'s credit card statement.', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; '', &nbsp;</div></li><li><div>              'desc_tip' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'card_icon' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Card Icon', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'default' =&gt; plugins_url('/assets/images/cards.png', plugin_basename(dirname(__FILE__))), &nbsp;</div></li><li><div>              'class' =&gt; 'button_upload'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'debug' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('Debug Log', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>              'label' =&gt; __('Enable logging', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'default' =&gt; 'no', &nbsp;</div></li><li><div>              'description' =&gt; sprintf( __( 'Log PayPal/Braintree events, inside &lt;code&gt;%s&lt;/code&gt;', 'paypal-for-woocommerce' ), wc_get_log_file_path( 'braintree' ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'is_encrypt' =&gt; array(&nbsp;</div></li><li><div>              'title' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'label' =&gt; __('', 'paypal-for-woocommerce'), &nbsp;</div></li><li><div>              'type' =&gt; 'hidden', &nbsp;</div></li><li><div>              'default' =&gt; 'yes', &nbsp;</div></li><li><div>              'class' =&gt; ''&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function payment_fields() {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      if ($this-&gt;description) {&nbsp;</div></li><li><div>          echo wpautop(wptexturize($this-&gt;description));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;tokenization_script();&nbsp;</div></li><li><div>      if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>          $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>          $this-&gt;add_log('Begin Braintree_ClientToken::generate Request');&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              if (is_user_logged_in()) {&nbsp;</div></li><li><div>                  $customer_id = get_current_user_id();&nbsp;</div></li><li><div>                  $braintree_customer_id = get_user_meta($customer_id, 'braintree_customer_id', true);&nbsp;</div></li><li><div>                  if (!empty($braintree_customer_id) && !empty($this-&gt;merchant_account_id)) {&nbsp;</div></li><li><div>                      $clientToken = Braintree_ClientToken::generate(array('customerId' =&gt; $braintree_customer_id, 'merchantAccountId' =&gt; $this-&gt;merchant_account_id));&nbsp;</div></li><li><div>                  } else if (!empty($braintree_customer_id)) {&nbsp;</div></li><li><div>                      $clientToken = Braintree_ClientToken::generate(array('customerId' =&gt; $braintree_customer_id));&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $clientToken = Braintree_ClientToken::generate();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $clientToken = Braintree_ClientToken::generate();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } catch (Braintree_Exception_Authentication $e) {&nbsp;</div></li><li><div>              wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } catch (Braintree_Exception_Authorization $e) {&nbsp;</div></li><li><div>              wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } catch (Braintree_Exception_DownForMaintenance $e) {&nbsp;</div></li><li><div>              wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: Request times out.&quot;);&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } catch (Braintree_Exception_ServerError $e) {&nbsp;</div></li><li><div>              wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Braintree_Exception_ServerError&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } catch (Braintree_Exception_SSLCertificate $e) {&nbsp;</div></li><li><div>              wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Braintree_Exception_SSLCertificate&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } catch (InvalidArgumentException $e) {&nbsp;</div></li><li><div>              if ($e-&gt;getMessage() == 'Customer specified by customer_id does not exist') {&nbsp;</div></li><li><div>                  if (is_user_logged_in()) {&nbsp;</div></li><li><div>                      $customer_id = get_current_user_id();&nbsp;</div></li><li><div>                      delete_user_meta($customer_id, 'braintree_customer_id');&nbsp;</div></li><li><div>                      $clientToken = Braintree_ClientToken::generate();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_ClientToken::generate Braintree_Exception_NotFound&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } catch (Exception $ex) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception:&quot; . $ex-&gt;getMessage());&nbsp;</div></li><li><div>              wp_redirect($woocommerce-&gt;cart-&gt;get_cart_url());&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;braintree-cc-form&quot; class=&quot;wc-payment-form&quot;&gt;&nbsp;</div></li><li><div>              &lt;fieldset&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;braintree-payment-form&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/fieldset&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;script&gt;&nbsp;</div></li><li><div>              var $form = jQuery('form.checkout, #order_review');&nbsp;</div></li><li><div>              var ccForm = jQuery('form.checkout');&nbsp;</div></li><li><div>              var clientToken = &quot;&lt;?php echo $clientToken; ?&gt;&quot;;&nbsp;</div></li><li><div>              braintree.setup(clientToken, &quot;dropin&quot;, {&nbsp;</div></li><li><div>                  container: &quot;braintree-payment-form&quot;, &nbsp;</div></li><li><div>                  onReady: function () {&nbsp;</div></li><li><div>                      jQuery.each(jQuery('#braintree-payment-form').children('iFrame'), &nbsp;</div></li><li><div>                              function (index) {&nbsp;</div></li><li><div>                                  if (index &gt; 0) {&nbsp;</div></li><li><div>                                      jQuery(this).remove();&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                              });&nbsp;</div></li><li><div>                  }, &nbsp;</div></li><li><div>                  onError: function (a) {&nbsp;</div></li><li><div>                      if (&quot;VALIDATION&quot; === a.type) {&nbsp;</div></li><li><div>                          if (is_angelleye_braintree_selected()) {&nbsp;</div></li><li><div>                              console.log(&quot;configuration error &quot; + a.message);&nbsp;</div></li><li><div>                              jQuery('.woocommerce-error, .braintree-token', ccForm).remove();&nbsp;</div></li><li><div>                              ccForm.prepend('&lt;ul class=&quot;woocommerce-error&quot;&gt;&lt;li&gt;' + a.message + '&lt;/li&gt;&lt;/ul&gt;');&nbsp;</div></li><li><div>                              return $form.unblock();&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          jQuery('.woocommerce-error, .braintree-token', ccForm).remove();&nbsp;</div></li><li><div>                          ccForm.prepend('&lt;ul class=&quot;woocommerce-error&quot;&gt;&lt;li&gt;' + a.message + '&lt;/li&gt;&lt;/ul&gt;');&nbsp;</div></li><li><div>                          console.log(&quot;configuration error &quot; + a.message);&nbsp;</div></li><li><div>                          return $form.unblock();&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }, &nbsp;</div></li><li><div>                  onPaymentMethodReceived: function (obj) {&nbsp;</div></li><li><div>                      braintreeResponseHandler(obj);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              function is_angelleye_braintree_selected() {&nbsp;</div></li><li><div>                  if (jQuery('#payment_method_braintree').is(':checked')) {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              function braintreeResponseHandler(obj) {&nbsp;</div></li><li><div>                  var $form = jQuery('form.checkout, #order_review, #add_payment_method'), &nbsp;</div></li><li><div>                          ccForm = jQuery('#braintree-cc-form');&nbsp;</div></li><li><div>                  if (obj.nonce) {&nbsp;</div></li><li><div>                      jQuery('.woocommerce-error, .braintree-token', ccForm).remove();&nbsp;</div></li><li><div>                      ccForm.append('&lt;input type=&quot;hidden&quot; class=&quot;braintree-token&quot; name=&quot;braintree_token&quot; value=&quot;' + obj.nonce + '&quot;/&gt;');&nbsp;</div></li><li><div>                      $form.submit();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              jQuery('form.checkout').on('checkout_place_order_braintree', function () {&nbsp;</div></li><li><div>                  return braintreeFormHandler();&nbsp;</div></li><li><div>              });&nbsp;</div></li><li><div>              function braintreeFormHandler() {&nbsp;</div></li><li><div>                  if (jQuery('#payment_method_braintree').is(':checked')) {&nbsp;</div></li><li><div>                      if (0 === jQuery('input.braintree-token').size()) {&nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          parent::payment_fields();&nbsp;</div></li><li><div>          do_action('payment_fields_saved_payment_methods', $this);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function get_posted_card() {&nbsp;</div></li><li><div>      $card_number = isset($_POST['braintree-card-number']) ? wc_clean($_POST['braintree-card-number']) : '';&nbsp;</div></li><li><div>      $card_cvc = isset($_POST['braintree-card-cvc']) ? wc_clean($_POST['braintree-card-cvc']) : '';&nbsp;</div></li><li><div>      $card_expiry = isset($_POST['braintree-card-expiry']) ? wc_clean($_POST['braintree-card-expiry']) : '';&nbsp;</div></li><li><div>      $card_number = str_replace(array(' ', '-'), '', $card_number);&nbsp;</div></li><li><div>      $card_expiry = array_map('trim', explode('/', $card_expiry));&nbsp;</div></li><li><div>      $card_exp_month = str_pad($card_expiry[0], 2, &quot;0&quot;, STR_PAD_LEFT);&nbsp;</div></li><li><div>      $card_exp_year = isset($card_expiry[1]) ? $card_expiry[1] : '';&nbsp;</div></li><li><div>      if (strlen($card_exp_year) == 2) {&nbsp;</div></li><li><div>          $card_exp_year += 2000;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return (object) array(&nbsp;</div></li><li><div>                  'number' =&gt; $card_number, &nbsp;</div></li><li><div>                  'type' =&gt; '', &nbsp;</div></li><li><div>                  'cvc' =&gt; $card_cvc, &nbsp;</div></li><li><div>                  'exp_month' =&gt; $card_exp_month, &nbsp;</div></li><li><div>                  'exp_year' =&gt; $card_exp_year, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the payment</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_payment($order_id) {&nbsp;</div></li><li><div>      $order = new WC_Order($order_id);&nbsp;</div></li><li><div>      $success = $this-&gt;angelleye_do_payment($order);&nbsp;</div></li><li><div>      if ($success == true) {&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'success', &nbsp;</div></li><li><div>              'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set( 'reload_checkout', true );&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'result' =&gt; 'fail', &nbsp;</div></li><li><div>              'redirect' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_do_payment($order) {&nbsp;</div></li><li><div>      $success = true;&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>              if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>                  $payment_method_nonce = self::get_posted_variable('braintree_token');&nbsp;</div></li><li><div>                  if (empty($payment_method_nonce)) {&nbsp;</div></li><li><div>                      $this-&gt;add_log(&quot;Error: The payment_method_nonce was unexpectedly empty&quot;);&nbsp;</div></li><li><div>                      wc_add_notice(__('Error: PayPal Powered by Braintree did not supply a payment nonce. Please try again later or use another means of payment.', 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $request_data = array();&nbsp;</div></li><li><div>              $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>              $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $billing_company = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_company : $order-&gt;get_billing_company();&nbsp;</div></li><li><div>              $billing_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>              $billing_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>              $billing_address_1 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_1 : $order-&gt;get_billing_address_1();&nbsp;</div></li><li><div>              $billing_address_2 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_2 : $order-&gt;get_billing_address_2();&nbsp;</div></li><li><div>              $billing_city = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_city : $order-&gt;get_billing_city();&nbsp;</div></li><li><div>              $billing_postcode = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_postcode : $order-&gt;get_billing_postcode();&nbsp;</div></li><li><div>              $billing_country = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_country : $order-&gt;get_billing_country();&nbsp;</div></li><li><div>              $billing_state = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_state : $order-&gt;get_billing_state();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $request_data['billing'] = array(&nbsp;</div></li><li><div>                  'firstName' =&gt; $billing_first_name, &nbsp;</div></li><li><div>                  'lastName' =&gt; $billing_last_name, &nbsp;</div></li><li><div>                  'company' =&gt; $billing_company, &nbsp;</div></li><li><div>                  'streetAddress' =&gt; $billing_address_1, &nbsp;</div></li><li><div>                  'extendedAddress' =&gt; $billing_address_2, &nbsp;</div></li><li><div>                  'locality' =&gt; $billing_city, &nbsp;</div></li><li><div>                  'region' =&gt; $billing_state, &nbsp;</div></li><li><div>                  'postalCode' =&gt; $billing_postcode, &nbsp;</div></li><li><div>                  'countryCodeAlpha2' =&gt; $billing_country, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $request_data['shipping'] = array(&nbsp;</div></li><li><div>                  'firstName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_first_name : $order-&gt;get_shipping_first_name(), &nbsp;</div></li><li><div>                  'lastName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_last_name : $order-&gt;get_shipping_last_name(), &nbsp;</div></li><li><div>                  'company' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_company : $order-&gt;get_shipping_company(), &nbsp;</div></li><li><div>                  'streetAddress' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_1 : $order-&gt;get_shipping_address_1(), &nbsp;</div></li><li><div>                  'extendedAddress' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_2 : $order-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div>                  'locality' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_city : $order-&gt;get_shipping_city(), &nbsp;</div></li><li><div>                  'region' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_state : $order-&gt;get_shipping_state(), &nbsp;</div></li><li><div>                  'postalCode' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_postcode : $order-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>                  'countryCodeAlpha2' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_country : $order-&gt;get_shipping_country(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              if ($this-&gt;enable_braintree_drop_in == false) {&nbsp;</div></li><li><div>                  if ((!empty($_POST['wc-braintree-payment-token']) && $_POST['wc-braintree-payment-token'] == 'new') || empty($_POST['wc-braintree-payment-token'])) {&nbsp;</div></li><li><div>                      $billing_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>                      $billing_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>                      $request_data['creditCard'] = array(&nbsp;</div></li><li><div>                          'number' =&gt; $card-&gt;number, &nbsp;</div></li><li><div>                          'expirationDate' =&gt; $card-&gt;exp_month . '/' . $card-&gt;exp_year, &nbsp;</div></li><li><div>                          'cvv' =&gt; $card-&gt;cvc, &nbsp;</div></li><li><div>                          'cardholderName' =&gt; $billing_first_name . ' ' . $billing_last_name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  } else if (is_user_logged_in() && (!empty($_POST['wc-braintree-payment-token']) && $_POST['wc-braintree-payment-token'] != 'new')) {&nbsp;</div></li><li><div>                      $customer_id = get_current_user_id();&nbsp;</div></li><li><div>                      $token_id = wc_clean($_POST['wc-braintree-payment-token']);&nbsp;</div></li><li><div>                      $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>                      $braintree_customer_id = get_user_meta($customer_id, 'braintree_customer_id', true);&nbsp;</div></li><li><div>                      $request_data['paymentMethodToken'] = $token-&gt;get_token();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $request_data['paymentMethodNonce'] = $payment_method_nonce;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (is_user_logged_in()) {&nbsp;</div></li><li><div>                  $customer_id = get_current_user_id();&nbsp;</div></li><li><div>                  $braintree_customer_id = get_user_meta($customer_id, 'braintree_customer_id', true);&nbsp;</div></li><li><div>                  if (!empty($braintree_customer_id)) {&nbsp;</div></li><li><div>                      $request_data['customerId'] = $braintree_customer_id;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $request_data['customer'] = array(&nbsp;</div></li><li><div>                          'firstName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name(), &nbsp;</div></li><li><div>                          'lastName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name(), &nbsp;</div></li><li><div>                          'company' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_company : $order-&gt;get_billing_company(), &nbsp;</div></li><li><div>                          'phone' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone(), &nbsp;</div></li><li><div>                          'email' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_email : $order-&gt;get_billing_email(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $request_data['amount'] = number_format($order-&gt;get_total(), 2, '.', '');&nbsp;</div></li><li><div>              if (isset($this-&gt;merchant_account_id) && !empty($this-&gt;merchant_account_id)) {&nbsp;</div></li><li><div>                  $request_data['merchantAccountId'] = $this-&gt;merchant_account_id;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $request_data['orderId'] = $order-&gt;get_order_number();&nbsp;</div></li><li><div>              $request_data['options'] = $this-&gt;get_braintree_options();&nbsp;</div></li><li><div>              $request_data['channel'] = 'AngellEYEPayPalforWoo_BT';&nbsp;</div></li><li><div>              if (!empty($this-&gt;softdescriptor)) {&nbsp;</div></li><li><div>                  $request_data['descriptor'] = array('name' =&gt; $this-&gt;softdescriptor);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;debug) {&nbsp;</div></li><li><div>                  $this-&gt;add_log('Begin Braintree_Transaction::sale request');&nbsp;</div></li><li><div>                  $this-&gt;add_log('Order: ' . print_r($order-&gt;get_order_number(), true));&nbsp;</div></li><li><div>                  $log = $request_data;&nbsp;</div></li><li><div>                  if ($this-&gt;enable_braintree_drop_in == false) {&nbsp;</div></li><li><div>                      $log['creditCard'] = array(&nbsp;</div></li><li><div>                          'number' =&gt; '**** **** **** ****', &nbsp;</div></li><li><div>                          'expirationDate' =&gt; '**' . '/' . '****', &nbsp;</div></li><li><div>                          'cvv' =&gt; '***'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $log['paymentMethodNonce'] = '*********************';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $this-&gt;add_log('Braintree_Transaction::sale Reuest Data ' . print_r($log, true));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              try {&nbsp;</div></li><li><div>                  $this-&gt;response = Braintree_Transaction::sale(apply_filters('angelleye_woocommerce_braintree_sale_request_args', $request_data));&nbsp;</div></li><li><div>              } catch (Braintree_Exception_Authentication $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_Authentication: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Braintree_Transaction::sale Braintree_Exception_Authentication: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              } catch (Braintree_Exception_Authorization $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_Authorization: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Braintree_Transaction::sale Braintree_Exception_Authorization: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              } catch (Braintree_Exception_DownForMaintenance $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_DownForMaintenance: Request times out.&quot;);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Braintree_Transaction::sale Braintree_Exception_DownForMaintenance: Request times out.&quot;);&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              } catch (Braintree_Exception_ServerError $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_ServerError &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Braintree_Transaction::sale Braintree_Exception_ServerError &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              } catch (Braintree_Exception_SSLCertificate $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_SSLCertificate &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Braintree_Transaction::sale Braintree_Exception_SSLCertificate &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              } catch (Exception $e) {&nbsp;</div></li><li><div>                  wc_add_notice(__('Error: PayPal Powered by Braintree was unable to complete the transaction. Please try again later or use another means of payment.', 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log('Error: Unable to complete transaction. Reason: ' . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Error: Unable to complete transaction. Reason: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!$this-&gt;response-&gt;success) {&nbsp;</div></li><li><div>                  $notice = sprintf(__('Error: PayPal Powered by Braintree was unable to complete the transaction. Please try again later or use another means of payment. Reason: %s', 'paypal-for-woocommerce'), $this-&gt;response-&gt;message);&nbsp;</div></li><li><div>                  wc_add_notice($notice, 'error');&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Error: Unable to complete transaction. Reason: {$this-&gt;response-&gt;message}&quot;);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(&quot;Error: Unable to complete transaction. Reason: {$this-&gt;response-&gt;message}&quot;);&nbsp;</div></li><li><div>                  return $success = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;add_log('Braintree_Transaction::sale Response code: ' . print_r($this-&gt;get_status_code(), true));&nbsp;</div></li><li><div>              $this-&gt;add_log('Braintree_Transaction::sale Response message: ' . print_r($this-&gt;get_status_message(), true));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $maybe_settled_later = array(&nbsp;</div></li><li><div>                  'settling', &nbsp;</div></li><li><div>                  'settlement_pending', &nbsp;</div></li><li><div>                  'submitted_for_settlement', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (in_array($this-&gt;response-&gt;transaction-&gt;status, $maybe_settled_later)) {&nbsp;</div></li><li><div>              if ($old_wc) {&nbsp;</div></li><li><div>                  update_post_meta($order_id, 'is_sandbox', $this-&gt;sandbox);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  update_post_meta( $order-&gt;get_id(), 'is_sandbox', $this-&gt;sandbox );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $order-&gt;payment_complete($this-&gt;response-&gt;transaction-&gt;id);&nbsp;</div></li><li><div>              do_action('before_save_payment_token', $order_id);&nbsp;</div></li><li><div>              if ((!empty($_POST['wc-braintree-payment-token']) && $_POST['wc-braintree-payment-token'] == 'new') || ( $this-&gt;enable_braintree_drop_in && $this-&gt;supports('tokenization'))) {&nbsp;</div></li><li><div>                  if ((!empty($_POST['wc-braintree-new-payment-method']) && $_POST['wc-braintree-new-payment-method'] == true) || ($this-&gt;enable_braintree_drop_in && $this-&gt;supports('tokenization'))) {&nbsp;</div></li><li><div>                  try {&nbsp;</div></li><li><div>                      $transaction = Braintree_Transaction::find($this-&gt;response-&gt;transaction-&gt;id);&nbsp;</div></li><li><div>                      if (!empty($transaction-&gt;creditCard) && !empty($transaction-&gt;customer['id'])) {&nbsp;</div></li><li><div>                          $customer_id = $order-&gt;get_user_id();&nbsp;</div></li><li><div>                          update_user_meta($customer_id, 'braintree_customer_id', $transaction-&gt;customer['id']);&nbsp;</div></li><li><div>                          $payment_method_token = $transaction-&gt;creditCard['token'];&nbsp;</div></li><li><div>                          $wc_existing_token = $this-&gt;get_token_by_token($payment_method_token);&nbsp;</div></li><li><div>                          if ($wc_existing_token == null) {&nbsp;</div></li><li><div>                              $token = new WC_Payment_Token_CC();&nbsp;</div></li><li><div>                              $token-&gt;set_user_id($customer_id);&nbsp;</div></li><li><div>                              $token-&gt;set_token($payment_method_token);&nbsp;</div></li><li><div>                              $token-&gt;set_gateway_id($this-&gt;id);&nbsp;</div></li><li><div>                              $token-&gt;set_card_type($transaction-&gt;creditCard['cardType']);&nbsp;</div></li><li><div>                              $token-&gt;set_last4($transaction-&gt;creditCard['last4']);&nbsp;</div></li><li><div>                              $token-&gt;set_expiry_month($transaction-&gt;creditCard['expirationMonth']);&nbsp;</div></li><li><div>                              $token-&gt;set_expiry_year($transaction-&gt;creditCard['expirationYear']);&nbsp;</div></li><li><div>                              $save_result = $token-&gt;save();&nbsp;</div></li><li><div>                              $this-&gt;save_payment_token($order, $payment_method_token);&nbsp;</div></li><li><div>                                      if ($save_result) {&nbsp;</div></li><li><div>                                          $order-&gt;add_payment_token($token);&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                                  } else {&nbsp;</div></li><li><div>                                      $order-&gt;add_payment_token($wc_existing_token);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } catch (Braintree_Exception_NotFound $e) {&nbsp;</div></li><li><div>                      $this-&gt;add_log(&quot;Braintree_Transaction::find Braintree_Exception_NotFound: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                      return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>                  } catch (Exception $ex) {&nbsp;</div></li><li><div>                      $this-&gt;add_log(&quot;Braintree_Transaction::find Exception: &quot; . $ex-&gt;getMessage());&nbsp;</div></li><li><div>                      return new WP_Error(404, $ex-&gt;getMessage());&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $order-&gt;payment_complete($this-&gt;response-&gt;transaction-&gt;id);&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(sprintf(__('%s payment approved! Trnsaction ID: %s', 'paypal-for-woocommerce'), $this-&gt;title, $this-&gt;response-&gt;transaction-&gt;id));&nbsp;</div></li><li><div>                  WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;add_log(sprintf('Info: unhandled transaction id = %s, status = %s', $this-&gt;response-&gt;transaction-&gt;id, $this-&gt;response-&gt;transaction-&gt;status));&nbsp;</div></li><li><div>                  $order-&gt;update_status('on-hold', sprintf(__('Transaction was submitted to PayPal Braintree but not handled by WooCommerce order, transaction_id: %s, status: %s. Order was put in-hold.', 'paypal-for-woocommerce'), $this-&gt;response-&gt;transaction-&gt;id, $this-&gt;response-&gt;transaction-&gt;status));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>      }     catch (Exception $ex) {&nbsp;</div></li><li><div>          wc_add_notice($ex-&gt;getMessage(), 'error');&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $success;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_braintree_options() {&nbsp;</div></li><li><div>      return array('submitForSettlement' =&gt; true, 'storeInVaultOnSuccess' =&gt; 'true');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function multibyte_loaded() {&nbsp;</div></li><li><div>      return extension_loaded('mbstring');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function process_refund($order_id, $amount = null, $reason = '') {&nbsp;</div></li><li><div>      $order = wc_get_order($order_id);&nbsp;</div></li><li><div>      if (!$order || !$order-&gt;get_transaction_id()) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          $transaction = Braintree_Transaction::find($order-&gt;get_transaction_id());&nbsp;</div></li><li><div>      } catch (Braintree_Exception_NotFound $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::find Braintree_Exception_NotFound&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>          return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authentication $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::find Braintree_Exception_Authentication: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>          return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authorization $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::find Braintree_Exception_Authorization: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>          return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>      } catch (Braintree_Exception_DownForMaintenance $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::find Braintree_Exception_DownForMaintenance: Request times out.&quot;);&nbsp;</div></li><li><div>          return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log($e-&gt;getMessage());&nbsp;</div></li><li><div>          return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($transaction-&gt;status) && $transaction-&gt;status == 'submitted_for_settlement') {&nbsp;</div></li><li><div>          if ($amount == $order-&gt;get_total()) {&nbsp;</div></li><li><div>              try {&nbsp;</div></li><li><div>                  $result = Braintree_Transaction::void($order-&gt;get_transaction_id());&nbsp;</div></li><li><div>                  if ($result-&gt;success) {&nbsp;</div></li><li><div>                      $order-&gt;add_order_note(sprintf(__('Refunded %s - Transaction ID: %s', 'paypal-for-woocommerce'), wc_price(number_format($amount, 2, '.', '')), $result-&gt;transaction-&gt;id));&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $error = '';&nbsp;</div></li><li><div>                      foreach (($result-&gt;errors-&gt;deepAll()) as $error) {&nbsp;</div></li><li><div>                          return new WP_Error(404, 'ec_refund-error', $error-&gt;message);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } catch (Braintree_Exception_NotFound $e) {&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::void Braintree_Exception_NotFound: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>              } catch (Exception $ex) {&nbsp;</div></li><li><div>                  $this-&gt;add_log(&quot;Braintree_Transaction::void Exception: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>                  return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return new WP_Error(404, 'braintree_refund-error', __('Oops, you cannot partially void this order. Please use the full order amount.', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif (isset($transaction-&gt;status) && ($transaction-&gt;status == 'settled' || $transaction-&gt;status == 'settling')) {&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $result = Braintree_Transaction::refund($order-&gt;get_transaction_id(), $amount);&nbsp;</div></li><li><div>              if ($result-&gt;success) {&nbsp;</div></li><li><div>                  $order-&gt;add_order_note(sprintf(__('Refunded %s - Transaction ID: %s', 'paypal-for-woocommerce'), wc_price(number_format($amount, 2, '.', '')), $result-&gt;transaction-&gt;id));&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $error = '';&nbsp;</div></li><li><div>                  foreach (($result-&gt;errors-&gt;deepAll()) as $error) {&nbsp;</div></li><li><div>                      return new WP_Error(404, 'ec_refund-error', $error-&gt;message);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } catch (Braintree_Exception_NotFound $e) {&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_Transaction::refund Braintree_Exception_NotFound: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>              return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>          } catch (Exception $ex) {&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Braintree_Transaction::refund Exception: &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>              return new WP_Error(404, $e-&gt;getMessage());&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Error: The transaction cannot be voided nor refunded in its current state: state = {$transaction-&gt;status}&quot;);&nbsp;</div></li><li><div>          return new WP_Error(404, &quot;Error: The transaction cannot be voided nor refunded in its current state: state = {$transaction-&gt;status}&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_braintree_lib() {&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          require_once( 'lib/Braintree/Braintree.php' );&nbsp;</div></li><li><div>          Braintree_Configuration::environment($this-&gt;environment);&nbsp;</div></li><li><div>          Braintree_Configuration::merchantId($this-&gt;merchant_id);&nbsp;</div></li><li><div>          Braintree_Configuration::publicKey($this-&gt;public_key);&nbsp;</div></li><li><div>          Braintree_Configuration::privateKey($this-&gt;private_key);&nbsp;</div></li><li><div>      } catch (Exception $ex) {&nbsp;</div></li><li><div>          $this-&gt;add_log('Error: Unable to Load Braintree. Reason: ' . $ex-&gt;getMessage());&nbsp;</div></li><li><div>          WP_Error(404, 'Error: Unable to Load Braintree. Reason: ' . $ex-&gt;getMessage());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_dependencies_admin_notices() {&nbsp;</div></li><li><div>      $missing_extensions = $this-&gt;get_missing_dependencies();&nbsp;</div></li><li><div>      if (count($missing_extensions) &gt; 0) {&nbsp;</div></li><li><div>          $message = sprintf(&nbsp;</div></li><li><div>                  _n(&nbsp;</div></li><li><div>                          '%s requires the %s PHP extension to function.  Contact your host or server administrator to configure and install the missing extension.', '%s requires the following PHP extensions to function: %s.  Contact your host or server administrator to configure and install the missing extensions.', count($missing_extensions), 'paypal-for-woocommerce'&nbsp;</div></li><li><div> ), &quot;PayPal For WooCoomerce - Braintree&quot;, '&lt;strong&gt;' . implode(', ', $missing_extensions) . '&lt;/strong&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;error&quot;&gt;&lt;p&gt;' . $message . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_missing_dependencies() {&nbsp;</div></li><li><div>      $missing_extensions = array();&nbsp;</div></li><li><div>      foreach ($this-&gt;get_dependencies() as $ext) {&nbsp;</div></li><li><div>          if (!extension_loaded($ext)) {&nbsp;</div></li><li><div>              $missing_extensions[] = $ext;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $missing_extensions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_dependencies() {&nbsp;</div></li><li><div>      return array('curl', 'dom', 'hash', 'openssl', 'SimpleXML', 'xmlwriter');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_log($message) {&nbsp;</div></li><li><div>      if ($this-&gt;debug == 'yes') {&nbsp;</div></li><li><div>          if (empty($this-&gt;log))&nbsp;</div></li><li><div>              $this-&gt;log = new WC_Logger();&nbsp;</div></li><li><div>          $this-&gt;log-&gt;add('braintree', $message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_status_code() {&nbsp;</div></li><li><div>      if ($this-&gt;response-&gt;success) {&nbsp;</div></li><li><div>          return $this-&gt;get_success_status_info('code');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $this-&gt;get_failure_status_info('code');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_status_message() {&nbsp;</div></li><li><div>      if ($this-&gt;response-&gt;success) {&nbsp;</div></li><li><div>          return $this-&gt;get_success_status_info('message');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $this-&gt;get_failure_status_info('message');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_success_status_info($type) {&nbsp;</div></li><li><div>      $transaction = !empty($this-&gt;response-&gt;transaction) ? $this-&gt;response-&gt;transaction : $this-&gt;response-&gt;creditCardVerification;&nbsp;</div></li><li><div>      if (isset($transaction-&gt;processorSettlementResponseCode) && !empty($transaction-&gt;processorSettlementResponseCode)) {&nbsp;</div></li><li><div>          $status = array(&nbsp;</div></li><li><div>              'code' =&gt; $transaction-&gt;processorSettlementResponseCode, &nbsp;</div></li><li><div>              'message' =&gt; $transaction-&gt;processorSettlementResponseText, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status = array(&nbsp;</div></li><li><div>              'code' =&gt; $transaction-&gt;processorResponseCode, &nbsp;</div></li><li><div>              'message' =&gt; $transaction-&gt;processorResponseText, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return isset($status[$type]) ? $status[$type] : null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_failure_status_info($type) {&nbsp;</div></li><li><div>      if ($this-&gt;has_validation_errors()) {&nbsp;</div></li><li><div>          $errors = $this-&gt;get_validation_errors();&nbsp;</div></li><li><div>          return implode(', ', ( 'code' === $type ? array_keys($errors) : array_values($errors)));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $transaction = !empty($this-&gt;response-&gt;transaction) ? $this-&gt;response-&gt;transaction : $this-&gt;response-&gt;creditCardVerification;&nbsp;</div></li><li><div>      switch ($transaction-&gt;status) {&nbsp;</div></li><li><div>          case 'gateway_rejected':&nbsp;</div></li><li><div>              $status = array(&nbsp;</div></li><li><div>                  'code' =&gt; $transaction-&gt;gatewayRejectionReason, &nbsp;</div></li><li><div>                  'message' =&gt; $this-&gt;response-&gt;message, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'processor_declined':&nbsp;</div></li><li><div>              $status = array(&nbsp;</div></li><li><div>                  'code' =&gt; $transaction-&gt;processorResponseCode, &nbsp;</div></li><li><div>                  'message' =&gt; $transaction-&gt;processorResponseText . (!empty($transaction-&gt;additionalProcessorResponse) ? ' (' . $transaction-&gt;additionalProcessorResponse . ')' : '' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'settlement_declined':&nbsp;</div></li><li><div>              $status = array(&nbsp;</div></li><li><div>                  'code' =&gt; $transaction-&gt;processorSettlementResponseCode, &nbsp;</div></li><li><div>                  'message' =&gt; $transaction-&gt;processorSettlementResponseText, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $status = array(&nbsp;</div></li><li><div>                  'code' =&gt; $transaction-&gt;status, &nbsp;</div></li><li><div>                  'message' =&gt; $this-&gt;response-&gt;message, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return isset($status[$type]) ? $status[$type] : null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function has_validation_errors() {&nbsp;</div></li><li><div>      return isset($this-&gt;response-&gt;errors) && $this-&gt;response-&gt;errors-&gt;deepSize();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_validation_errors() {&nbsp;</div></li><li><div>      $errors = array();&nbsp;</div></li><li><div>      if ($this-&gt;has_validation_errors()) {&nbsp;</div></li><li><div>          foreach ($this-&gt;response-&gt;errors-&gt;deepAll() as $error) {&nbsp;</div></li><li><div>              $errors[$error-&gt;code] = $error-&gt;message;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $errors;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_user_message($message_id) {&nbsp;</div></li><li><div>      $message = null;&nbsp;</div></li><li><div>      switch ($message_id) {&nbsp;</div></li><li><div>          case 'error': $message = __('An error occurred, please try again or try an alternate form of payment', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'decline': $message = __('We cannot process your order with the payment information that you provided. Please use a different payment account or an alternate payment method.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'held_for_review': $message = __('This order is being placed on hold for review. Please contact us to complete the transaction.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'held_for_incorrect_csc': $message = __('This order is being placed on hold for review due to an incorrect card verification number.  You may contact the store to complete the transaction.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'csc_invalid': $message = __('The card verification number is invalid, please try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'csc_missing': $message = __('Please enter your card verification number and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_type_not_accepted': $message = __('That card type is not accepted, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_type_invalid': $message = __('The card type is invalid or does not correlate with the credit card number.  Please try again or use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_type_missing': $message = __('Please select the card type and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_number_type_invalid': $message = __('The card type is invalid or does not correlate with the credit card number.  Please try again or use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_number_invalid': $message = __('The card number is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_number_missing': $message = __('Please enter your card number and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_expiry_invalid': $message = __('The card expiration date is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_expiry_month_invalid': $message = __('The card expiration month is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_expiry_year_invalid': $message = __('The card expiration year is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_expiry_missing': $message = __('Please enter your card expiration date and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'bank_aba_invalid': $message_id = __('The bank routing number is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'bank_account_number_invalid': $message_id = __('The bank account number is invalid, please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_expired': $message = __('The provided card is expired, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_declined': $message = __('The provided card was declined, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'insufficient_funds': $message = __('Insufficient funds in account, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'card_inactive': $message = __('The card is inactivate or not authorized for card-not-present transactions, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'credit_limit_reached': $message = __('The credit limit for the card has been reached, please use an alternate card or other form of payment.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'csc_mismatch': $message = __('The card verification number does not match. Please re-enter and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'avs_mismatch': $message = __('The provided address does not match the billing address for cardholder. Please verify the address and try again.', 'paypal-for-woocommerce');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters('wc_payment_gateway_transaction_response_user_message', $message, $message_id, $this);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_message() {&nbsp;</div></li><li><div>      $messages = array();&nbsp;</div></li><li><div>      $message_id = array();&nbsp;</div></li><li><div>      $decline_codes = array(&nbsp;</div></li><li><div>          'cvv' =&gt; 'csc_mismatch', &nbsp;</div></li><li><div>          'avs' =&gt; 'avs_mismatch', &nbsp;</div></li><li><div>          '2000' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2001' =&gt; 'insufficient_funds', &nbsp;</div></li><li><div>          '2002' =&gt; 'credit_limit_reached', &nbsp;</div></li><li><div>          '2003' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2004' =&gt; 'card_expired', &nbsp;</div></li><li><div>          '2005' =&gt; 'card_number_invalid', &nbsp;</div></li><li><div>          '2006' =&gt; 'card_expiry_invalid', &nbsp;</div></li><li><div>          '2007' =&gt; 'card_type_invalid', &nbsp;</div></li><li><div>          '2008' =&gt; 'card_number_invalid', &nbsp;</div></li><li><div>          '2010' =&gt; 'csc_mismatch', &nbsp;</div></li><li><div>          '2012' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2013' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2014' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2016' =&gt; 'error', &nbsp;</div></li><li><div>          '2017' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2018' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2023' =&gt; 'card_type_not_accepted', &nbsp;</div></li><li><div>          '2024' =&gt; 'card_type_not_accepted', &nbsp;</div></li><li><div>          '2038' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2046' =&gt; 'card_declined', &nbsp;</div></li><li><div>          '2056' =&gt; 'credit_limit_reached', &nbsp;</div></li><li><div>          '2059' =&gt; 'avs_mismatch', &nbsp;</div></li><li><div>          '2060' =&gt; 'avs_mismatch', &nbsp;</div></li><li><div>          '2075' =&gt; 'paypal_closed', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $response_codes = $this-&gt;get_validation_errors();&nbsp;</div></li><li><div>      if (isset($response_codes) && !empty($response_codes) && is_array($response_codes)) {&nbsp;</div></li><li><div>          foreach ($response_codes as $key =&gt; $value) {&nbsp;</div></li><li><div>              $messages[] = isset($decline_codes[$key]) ? $this-&gt;get_user_message($key) : $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return implode(' ', $messages);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function payment_scripts() {&nbsp;</div></li><li><div>      if (!$this-&gt;is_available()) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>          wp_enqueue_script('braintree-gateway', 'https:<span class="comment">//js.braintreegateway.com/js/braintree-2.29.0.min.js', array(), WC_VERSION, false);</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_posted_variable($variable, $default = '') {&nbsp;</div></li><li><div>      return ( isset($_POST[$variable]) ? $_POST[$variable] : $default );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_transaction_url($order) {&nbsp;</div></li><li><div>      $transaction_id = $order-&gt;get_transaction_id();&nbsp;</div></li><li><div>      if (empty($transaction_id)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_wc = version_compare(WC_VERSION, '3.0', '&lt;');&nbsp;</div></li><li><div>      $is_sandbox = $old_wc ? get_post_meta($order-&gt;id, 'is_sandbox', true) : get_post_meta($order-&gt;get_id(), 'is_sandbox', true);&nbsp;</div></li><li><div>      if ($is_sandbox == true) {&nbsp;</div></li><li><div>          $server = &quot;sandbox.braintreegateway.com&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (empty($is_sandbox)) {&nbsp;</div></li><li><div>              if ($this-&gt;sandbox == true) {&nbsp;</div></li><li><div>                  $server = &quot;sandbox.braintreegateway.com&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $server = &quot;braintreegateway.com&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $server = &quot;braintreegateway.com&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return &quot;https:<span class="comment">//&quot; . $server . &quot;/merchants/&quot; . urlencode($this-&gt;merchant_id) . &quot;/transactions/&quot; . urlencode($transaction_id);</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function field_name($name) {&nbsp;</div></li><li><div>      return ' name=&quot;' . esc_attr($this-&gt;id . '-' . $name) . '&quot; ';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_braintree_credit_card_form_fields($default_fields, $current_gateway_id) {&nbsp;</div></li><li><div>      if ($current_gateway_id == $this-&gt;id) {&nbsp;</div></li><li><div>          $fields = array(&nbsp;</div></li><li><div>              'card-number-field' =&gt; '&lt;p class=&quot;form-row form-row-wide&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot;&gt;' . __('Card number', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-number&quot; class=&quot;input-text wc-credit-card-form-card-number&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;cc-number&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; placeholder=&quot;&bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull;&quot; ' . $this-&gt;field_name('card-number') . ' /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;', &nbsp;</div></li><li><div>              'card-expiry-field' =&gt; '&lt;p class=&quot;form-row form-row-first&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-expiry&quot;&gt;' . __('Expiry (MM/YY)', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-expiry&quot; class=&quot;input-text wc-credit-card-form-card-expiry&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;cc-exp&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; placeholder=&quot;' . esc_attr__('MM / YY', 'woocommerce') . '&quot; ' . $this-&gt;field_name('card-expiry') . ' /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;', &nbsp;</div></li><li><div>              '&lt;p class=&quot;form-row form-row-last&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label for=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot;&gt;' . __('Card code', 'woocommerce') . ' &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;input id=&quot;' . esc_attr($this-&gt;id) . '-card-cvc&quot; class=&quot;input-text wc-credit-card-form-card-cvc&quot; inputmode=&quot;numeric&quot; autocomplete=&quot;off&quot; autocorrect=&quot;no&quot; autocapitalize=&quot;no&quot; spellcheck=&quot;no&quot; type=&quot;tel&quot; maxlength=&quot;4&quot; placeholder=&quot;' . esc_attr__('CVC', 'woocommerce') . '&quot; ' . $this-&gt;field_name('card-cvc') . ' style=&quot;width:100px&quot; /&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          return $fields;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $default_fields;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_token_by_token($token_id, $token_result = null) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      if (is_null($token_result)) {&nbsp;</div></li><li><div>          $token_result = $wpdb-&gt;get_row($wpdb-&gt;prepare(&nbsp;</div></li><li><div>                          &quot;SELECT * FROM {$wpdb-&gt;prefix}woocommerce_payment_tokens WHERE token = %s&quot;, $token_id&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>          if (empty($token_result)) {&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $token_class = 'WC_Payment_Token_' . $token_result-&gt;type;&nbsp;</div></li><li><div>      if (class_exists($token_class)) {&nbsp;</div></li><li><div>          $meta = get_metadata('payment_token', $token_result-&gt;token_id);&nbsp;</div></li><li><div>          $passed_meta = array();&nbsp;</div></li><li><div>          if (!empty($meta)) {&nbsp;</div></li><li><div>              foreach ($meta as $meta_key =&gt; $meta_value) {&nbsp;</div></li><li><div>                  $passed_meta[$meta_key] = $meta_value[0];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return new $token_class($token_result-&gt;token_id, (array) $token_result, $passed_meta);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_payment_method($zero_amount_payment = false) {&nbsp;</div></li><li><div>      $this-&gt;validate_fields();&nbsp;</div></li><li><div>      $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>      $customer_id = get_current_user_id();&nbsp;</div></li><li><div>      $braintree_customer_id = get_user_meta($customer_id, 'braintree_customer_id', true);&nbsp;</div></li><li><div>      if (!empty($braintree_customer_id)) {&nbsp;</div></li><li><div>          $result = $this-&gt;braintree_create_payment_method($braintree_customer_id, $zero_amount_payment);&nbsp;</div></li><li><div>          if ($result-&gt;success == true) {&nbsp;</div></li><li><div>              $return = $this-&gt;braintree_save_payment_method($customer_id, $result, $zero_amount_payment);&nbsp;</div></li><li><div>              return $return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $braintree_customer_id = $this-&gt;braintree_create_customer($customer_id);&nbsp;</div></li><li><div>          if (!empty($braintree_customer_id)) {&nbsp;</div></li><li><div>              $result = $this-&gt;braintree_create_payment_method($braintree_customer_id, $zero_amount_payment);&nbsp;</div></li><li><div>              if ($result-&gt;success == true) {&nbsp;</div></li><li><div>                  $return = $this-&gt;braintree_save_payment_method($customer_id, $result, $zero_amount_payment);&nbsp;</div></li><li><div>                  return $return;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function braintree_create_payment_method($braintree_customer_id, $zero_amount_payment = false) {&nbsp;</div></li><li><div>      if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>          $payment_method_nonce = self::get_posted_variable('braintree_token');&nbsp;</div></li><li><div>          if (!empty($payment_method_nonce)) {&nbsp;</div></li><li><div>              $payment_method_request = array('customerId' =&gt; $braintree_customer_id, 'paymentMethodNonce' =&gt; $payment_method_nonce, 'options' =&gt; array('failOnDuplicatePaymentMethod' =&gt; true));&nbsp;</div></li><li><div>              if (isset($this-&gt;merchant_account_id) && !empty($this-&gt;merchant_account_id)) {&nbsp;</div></li><li><div>                  $payment_method_request['options']['verificationMerchantAccountId'] = $this-&gt;merchant_account_id;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;add_log(&quot;Error: The payment_method_nonce was unexpectedly empty&quot;);&nbsp;</div></li><li><div>              wc_add_notice(__('Error: PayPal Powered by Braintree did not supply a payment nonce. Please try again later or use another means of payment.', 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $card = $this-&gt;get_posted_card();&nbsp;</div></li><li><div>          $payment_method_request = array('customerId' =&gt; $braintree_customer_id, 'cvv' =&gt; $card-&gt;cvc, 'expirationDate' =&gt; $card-&gt;exp_month . '/' . $card-&gt;exp_year, 'number' =&gt; $card-&gt;number);&nbsp;</div></li><li><div>          if (isset($this-&gt;merchant_account_id) && !empty($this-&gt;merchant_account_id)) {&nbsp;</div></li><li><div>              $payment_method_request['options']['verificationMerchantAccountId'] = $this-&gt;merchant_account_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          if ($this-&gt;enable_braintree_drop_in) {&nbsp;</div></li><li><div>              $result = Braintree_PaymentMethod::create($payment_method_request);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $result = Braintree_CreditCard::create($payment_method_request);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $result;&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authentication $e) {&nbsp;</div></li><li><div>          wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authorization $e) {&nbsp;</div></li><li><div>          wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Braintree_Exception_DownForMaintenance $e) {&nbsp;</div></li><li><div>          wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception: Request times out.&quot;);&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>          wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Braintree_Exception_ServerError $e) {&nbsp;</div></li><li><div>          wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Braintree_Exception_ServerError&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Braintree_Exception_SSLCertificate $e) {&nbsp;</div></li><li><div>          wc_add_notice(__(&quot;Error processing checkout. Please try again. &quot;, 'paypal-for-woocommerce'), 'error');&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Braintree_Exception_SSLCertificate&quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch (Exception $ex) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_ClientToken::generate Exception:&quot; . $ex-&gt;getMessage());&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function braintree_save_payment_method($customer_id, $result) {&nbsp;</div></li><li><div>      if (!empty($result-&gt;paymentMethod)) {&nbsp;</div></li><li><div>          $braintree_method = $result-&gt;paymentMethod;&nbsp;</div></li><li><div>      } elseif ($result-&gt;creditCard) {&nbsp;</div></li><li><div>          $braintree_method = $result-&gt;creditCard;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      update_user_meta($customer_id, 'braintree_customer_id', $braintree_method-&gt;customerId);&nbsp;</div></li><li><div>      $payment_method_token = $braintree_method-&gt;token;&nbsp;</div></li><li><div>      $wc_existing_token = $this-&gt;get_token_by_token($payment_method_token);&nbsp;</div></li><li><div>      if ($wc_existing_token == null) {&nbsp;</div></li><li><div>          $token = new WC_Payment_Token_CC();&nbsp;</div></li><li><div>          $token-&gt;set_user_id( $customer_id );&nbsp;</div></li><li><div>          $token-&gt;set_token( $payment_method_token );&nbsp;</div></li><li><div>          $token-&gt;set_gateway_id( $this-&gt;id );&nbsp;</div></li><li><div>          $token-&gt;set_card_type( $braintree_method-&gt;cardType);&nbsp;</div></li><li><div>          $token-&gt;set_last4( $braintree_method-&gt;last4 );&nbsp;</div></li><li><div>          $token-&gt;set_expiry_month( $braintree_method-&gt;expirationMonth );&nbsp;</div></li><li><div>          $token-&gt;set_expiry_year( $braintree_method-&gt;expirationYear );&nbsp;</div></li><li><div>          $save_result = $token-&gt;save();&nbsp;</div></li><li><div>          if ($save_result) {&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  '_payment_tokens_id' =&gt; $payment_method_token, &nbsp;</div></li><li><div>                  'redirect' =&gt; wc_get_account_endpoint_url('payment-methods')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>                  wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return array(&nbsp;</div></li><li><div>                      'result' =&gt; 'success', &nbsp;</div></li><li><div>                      '_payment_tokens_id' =&gt; $payment_method_token, &nbsp;</div></li><li><div>                      'redirect' =&gt; wc_get_account_endpoint_url('payment-methods')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ($zero_amount_payment == false) {&nbsp;</div></li><li><div>              wp_redirect(wc_get_account_endpoint_url('payment-methods'));&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  '_payment_tokens_id' =&gt; $payment_method_token, &nbsp;</div></li><li><div>                  'redirect' =&gt; wc_get_account_endpoint_url('payment-methods')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } &nbsp;</div></li><li><div>      } &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function braintree_create_customer($customer_id) {&nbsp;</div></li><li><div>      $user = get_user_by('id', $customer_id);&nbsp;</div></li><li><div>      $firstName = (get_user_meta($customer_id, 'billing_first_name', true)) ? get_user_meta($customer_id, 'billing_first_name', true) : get_user_meta($customer_id, 'shipping_first_name', true);&nbsp;</div></li><li><div>      $lastName = (get_user_meta($customer_id, 'billing_last_name', true)) ? get_user_meta($customer_id, 'billing_last_name', true) : get_user_meta($customer_id, 'shipping_last_name', true);&nbsp;</div></li><li><div>      $company = (get_user_meta($customer_id, 'billing_company', true)) ? get_user_meta($customer_id, 'billing_company', true) : get_user_meta($customer_id, 'shipping_company', true);&nbsp;</div></li><li><div>      $billing_email = (get_user_meta($customer_id, 'billing_email', true)) ? get_user_meta($customer_id, 'billing_email', true) : get_user_meta($customer_id, 'shipping_last_name', true);&nbsp;</div></li><li><div>      $billing_email = ($billing_email) ? $billing_email : $user-&gt;user_email;&nbsp;</div></li><li><div>      $firstName = ($firstName) ? $firstName : $user-&gt;first_name;&nbsp;</div></li><li><div>      $lastName = ($lastName) ? $lastName : $user-&gt;last_name;&nbsp;</div></li><li><div>      $create_customer_request = array('firstName' =&gt; $firstName, &nbsp;</div></li><li><div>          'lastName' =&gt; $lastName, &nbsp;</div></li><li><div>          'company' =&gt; $company, &nbsp;</div></li><li><div>          'email' =&gt; $billing_email, &nbsp;</div></li><li><div>          'phone' =&gt; '', &nbsp;</div></li><li><div>          'fax' =&gt; '', &nbsp;</div></li><li><div>          'website' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $result = Braintree_Customer::create(apply_filters('angelleye_woocommerce_braintree_create_customer_request_args', $create_customer_request));&nbsp;</div></li><li><div>      if ($result-&gt;success == true) {&nbsp;</div></li><li><div>          if (!empty($result-&gt;customer-&gt;id)) {&nbsp;</div></li><li><div>              update_user_meta($customer_id, 'braintree_customer_id', $result-&gt;customer-&gt;id);&nbsp;</div></li><li><div>              return $result-&gt;customer-&gt;id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function subscription_process_payment($order_id) {&nbsp;</div></li><li><div>      $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>      $order = new WC_Order($order_id);&nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if (isset($_POST['wc-braintree-payment-token']) && 'new' !== $_POST['wc-braintree-payment-token']) {&nbsp;</div></li><li><div>          $token_id = wc_clean($_POST['wc-braintree-payment-token']);&nbsp;</div></li><li><div>          $token = WC_Payment_Tokens::get($token_id);&nbsp;</div></li><li><div>          if ($token-&gt;get_user_id() !== get_current_user_id()) {&nbsp;</div></li><li><div>              throw new Exception(__('Error processing checkout. Please try again.', 'paypal-for-woocommerce'));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $is_sandbox = $this-&gt;sandbox == 'no' ? false : true;&nbsp;</div></li><li><div>              update_post_meta($order_id, 'is_sandbox', $is_sandbox);&nbsp;</div></li><li><div>              $payment_tokens_id = $token-&gt;get_token();&nbsp;</div></li><li><div>              $this-&gt;save_payment_token($order, $payment_tokens_id);&nbsp;</div></li><li><div>              $order-&gt;payment_complete($payment_tokens_id);&nbsp;</div></li><li><div>              WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>              $result = array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              if (is_ajax()) {&nbsp;</div></li><li><div>                  wp_send_json($result);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wp_redirect($result['redirect']);&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $result = $this-&gt;add_payment_method($zero_amount_payment = true);&nbsp;</div></li><li><div>          if ($result['result'] == 'success') {&nbsp;</div></li><li><div>              $is_sandbox = $this-&gt;sandbox == 'no' ? false : true;&nbsp;</div></li><li><div>              update_post_meta($order_id, 'is_sandbox', $is_sandbox);&nbsp;</div></li><li><div>              $payment_tokens_id = (!empty($result['_payment_tokens_id'])) ? $result['_payment_tokens_id'] : '';&nbsp;</div></li><li><div>              $this-&gt;save_payment_token($order, $payment_tokens_id);&nbsp;</div></li><li><div>              $order-&gt;payment_complete($payment_tokens_id);&nbsp;</div></li><li><div>              WC()-&gt;cart-&gt;empty_cart();&nbsp;</div></li><li><div>              $result = array(&nbsp;</div></li><li><div>                  'result' =&gt; 'success', &nbsp;</div></li><li><div>                  'redirect' =&gt; $this-&gt;get_return_url($order)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              if (is_ajax()) {&nbsp;</div></li><li><div>                  wp_send_json($result);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  wp_redirect($result['redirect']);&nbsp;</div></li><li><div>                  exit;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              WC()-&gt;session-&gt;set( 'reload_checkout', true );&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  'result' =&gt; 'fail', &nbsp;</div></li><li><div>                  'redirect' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function send_failed_order_email($order_id) {&nbsp;</div></li><li><div>      $emails = WC()-&gt;mailer()-&gt;get_emails();&nbsp;</div></li><li><div>      if (!empty($emails) && !empty($order_id)) {&nbsp;</div></li><li><div>          $emails['WC_Email_Failed_Order']-&gt;trigger($order_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save_payment_token($order, $payment_tokens_id) {&nbsp;</div></li><li><div>      <span class="comment">// Store source in the order</span>&nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      if (!empty($payment_tokens_id)) {&nbsp;</div></li><li><div>          update_post_meta($order_id, '_payment_tokens_id', $payment_tokens_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_subscription($order_id) {&nbsp;</div></li><li><div>      return ( function_exists('wcs_order_contains_subscription') && ( wcs_order_contains_subscription($order_id) || wcs_is_subscription($order_id) || wcs_order_contains_renewal($order_id) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function process_subscription_payment($order, $amount) {&nbsp;</div></li><li><div>      $order_id = version_compare(WC_VERSION, '3.0', '&lt;') ? $order-&gt;id : $order-&gt;get_id();&nbsp;</div></li><li><div>      $request_data = array();&nbsp;</div></li><li><div>      $this-&gt;angelleye_braintree_lib();&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      $billing_company = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_company : $order-&gt;get_billing_company();&nbsp;</div></li><li><div>      $billing_first_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name();&nbsp;</div></li><li><div>      $billing_last_name = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name();&nbsp;</div></li><li><div>      $billing_address_1 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_1 : $order-&gt;get_billing_address_1();&nbsp;</div></li><li><div>      $billing_address_2 = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_address_2 : $order-&gt;get_billing_address_2();&nbsp;</div></li><li><div>      $billing_city = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_city : $order-&gt;get_billing_city();&nbsp;</div></li><li><div>      $billing_postcode = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_postcode : $order-&gt;get_billing_postcode();&nbsp;</div></li><li><div>      $billing_country = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_country : $order-&gt;get_billing_country();&nbsp;</div></li><li><div>      $billing_state = version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_state : $order-&gt;get_billing_state();&nbsp;</div></li><li><div>              &nbsp;</div></li><li><div>      $request_data['billing'] = array(&nbsp;</div></li><li><div>          'firstName' =&gt; $billing_first_name, &nbsp;</div></li><li><div>          'lastName' =&gt; $billing_last_name, &nbsp;</div></li><li><div>          'company' =&gt; $billing_company, &nbsp;</div></li><li><div>          'streetAddress' =&gt; $billing_address_1, &nbsp;</div></li><li><div>          'extendedAddress' =&gt; $billing_address_2, &nbsp;</div></li><li><div>          'locality' =&gt; $billing_city, &nbsp;</div></li><li><div>          'region' =&gt; $billing_state, &nbsp;</div></li><li><div>          'postalCode' =&gt; $billing_postcode, &nbsp;</div></li><li><div>          'countryCodeAlpha2' =&gt; $billing_country, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request_data['shipping'] = array(&nbsp;</div></li><li><div>          'firstName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_first_name : $order-&gt;get_shipping_first_name(), &nbsp;</div></li><li><div>          'lastName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_last_name : $order-&gt;get_shipping_last_name(), &nbsp;</div></li><li><div>          'company' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_company : $order-&gt;get_shipping_company(), &nbsp;</div></li><li><div>          'streetAddress' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_1 : $order-&gt;get_shipping_address_1(), &nbsp;</div></li><li><div>          'extendedAddress' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_address_2 : $order-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div>          'locality' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_city : $order-&gt;get_shipping_city(), &nbsp;</div></li><li><div>          'region' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_state : $order-&gt;get_shipping_state(), &nbsp;</div></li><li><div>          'postalCode' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_postcode : $order-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>          'countryCodeAlpha2' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;shipping_country : $order-&gt;get_shipping_country(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if (!empty($order-&gt;subscription_renewal)) {&nbsp;</div></li><li><div>          $request_data['paymentMethodToken'] = get_post_meta($order_id, '_payment_tokens_id', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_user_logged_in()) {&nbsp;</div></li><li><div>          $customer_id = get_current_user_id();&nbsp;</div></li><li><div>          $braintree_customer_id = get_user_meta($customer_id, 'braintree_customer_id', true);&nbsp;</div></li><li><div>          if (!empty($braintree_customer_id)) {&nbsp;</div></li><li><div>              $request_data['customerId'] = $braintree_customer_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $request_data['customer'] = array(&nbsp;</div></li><li><div>                  'firstName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_first_name : $order-&gt;get_billing_first_name(), &nbsp;</div></li><li><div>                  'lastName' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_last_name : $order-&gt;get_billing_last_name(), &nbsp;</div></li><li><div>                  'company' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_company : $order-&gt;get_billing_company(), &nbsp;</div></li><li><div>                  'phone' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_phone : $order-&gt;get_billing_phone(), &nbsp;</div></li><li><div>                  'email' =&gt; version_compare( WC_VERSION, '3.0', '&lt;' ) ? $order-&gt;billing_email : $order-&gt;get_billing_email(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $request_data['amount'] = number_format($order-&gt;get_total(), 2, '.', '');&nbsp;</div></li><li><div>      if (isset($this-&gt;merchant_account_id) && !empty($this-&gt;merchant_account_id)) {&nbsp;</div></li><li><div>          $request_data['merchantAccountId'] = $this-&gt;merchant_account_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $request_data['orderId'] = $order-&gt;get_order_number();&nbsp;</div></li><li><div>      $request_data['options'] = $this-&gt;get_braintree_options();&nbsp;</div></li><li><div>      $request_data['channel'] = 'AngellEYEPayPalforWoo_BT';&nbsp;</div></li><li><div>      if ($this-&gt;debug) {&nbsp;</div></li><li><div>          $this-&gt;add_log('Begin Braintree_Transaction::sale request');&nbsp;</div></li><li><div>          $this-&gt;add_log('Order: ' . print_r($order-&gt;get_order_number(), true));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          $this-&gt;response = Braintree_Transaction::sale($request_data);&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authentication $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_Authentication: API keys are incorrect, Please double-check that you haven't accidentally tried to use your sandbox keys in production or vice-versa.&quot;);&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      } catch (Braintree_Exception_Authorization $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_Authorization: The API key that you're using is not authorized to perform the attempted action according to the role assigned to the user who owns the API key.&quot;);&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      } catch (Braintree_Exception_DownForMaintenance $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_DownForMaintenance: Request times out.&quot;);&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      } catch (Braintree_Exception_ServerError $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_ServerError &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      } catch (Braintree_Exception_SSLCertificate $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Braintree_Transaction::sale Braintree_Exception_SSLCertificate &quot; . $e-&gt;getMessage());&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      } catch (Exception $e) {&nbsp;</div></li><li><div>          $this-&gt;add_log('Error: Unable to complete transaction. Reason: ' . $e-&gt;getMessage());&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$this-&gt;response-&gt;success) {&nbsp;</div></li><li><div>          $this-&gt;add_log(&quot;Error: Unable to complete transaction. Reason: {$this-&gt;response-&gt;message}&quot;);&nbsp;</div></li><li><div>          return $success = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;add_log('Braintree_Transaction::sale Response code: ' . print_r($this-&gt;get_status_code(), true));&nbsp;</div></li><li><div>      $this-&gt;add_log('Braintree_Transaction::sale Response message: ' . print_r($this-&gt;get_status_message(), true));&nbsp;</div></li><li><div>      $maybe_settled_later = array(&nbsp;</div></li><li><div>          'settling', &nbsp;</div></li><li><div>          'settlement_pending', &nbsp;</div></li><li><div>          'submitted_for_settlement', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      if (in_array($this-&gt;response-&gt;transaction-&gt;status, $maybe_settled_later)) {&nbsp;</div></li><li><div>          $is_sandbox = $this-&gt;sandbox == 'no' ? false : true;&nbsp;</div></li><li><div>          update_post_meta($order_id, 'is_sandbox', $is_sandbox);&nbsp;</div></li><li><div>          $order-&gt;payment_complete($this-&gt;response-&gt;transaction-&gt;id);&nbsp;</div></li><li><div>          $order-&gt;add_order_note(sprintf(__('%s payment approved! Trnsaction ID: %s', 'paypal-for-woocommerce'), $this-&gt;title, $this-&gt;response-&gt;transaction-&gt;id));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;add_log(sprintf('Info: unhandled transaction id = %s, status = %s', $this-&gt;response-&gt;transaction-&gt;id, $this-&gt;response-&gt;transaction-&gt;status));&nbsp;</div></li><li><div>          $order-&gt;update_status('on-hold', sprintf(__('Transaction was submitted to PayPal Braintree but not handled by WooCommerce order, transaction_id: %s, status: %s. Order was put in-hold.', 'paypal-for-woocommerce'), $this-&gt;response-&gt;transaction-&gt;id, $this-&gt;response-&gt;transaction-&gt;status));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function angelleye_braintree_encrypt_gateway_api($settings) {&nbsp;</div></li><li><div>      if( !empty($settings['is_encrypt']) ) {&nbsp;</div></li><li><div>          $gateway_settings_key_array = array('sandbox_public_key', 'sandbox_private_key', 'sandbox_merchant_id', 'sandbox_merchant_account_id', 'public_key', 'private_key', 'merchant_id', 'merchant_account_id');&nbsp;</div></li><li><div>          foreach ($gateway_settings_key_array as $gateway_settings_key =&gt; $gateway_settings_value) {&nbsp;</div></li><li><div>              if( !empty( $settings[$gateway_settings_value]) ) {&nbsp;</div></li><li><div>                  $settings[$gateway_settings_value] = AngellEYE_Utility::crypting($settings[$gateway_settings_value], $action = 'e');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>PayPal for WooCommerce</li><li><span></span>1.4.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>