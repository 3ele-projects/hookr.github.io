<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="0.9.5" data-slug="w3-total-cache" data-type="file" data-id="95006"><head xmlns="http://www.w3.org/1999/xhtml"><title> util-environment | file | W3 Total Cache | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, w3-total-cache, 0.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.18"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=402e02056db6b592f3e087440d0c3051' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.18' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/util-environment/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Futil-environment%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Futil-environment%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-w3-total-cache-0.9.5-file-util-environment","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="util-environment" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to w3-total-cache." href="http://hookr.io/plugins/w3-total-cache/" class="plugin"><span property="name">w3-total-cache</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 0.9.5." href="http://hookr.io/plugins/w3-total-cache/0.9.5/" class="H_VERSION"><span property="name">0.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/w3-total-cache/0.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">util-environment</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="973"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/all/" title="All">All <span class="count badge">973</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="149"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/hooks/" title="Hooks">Hooks <span class="count badge">149</span></a></li><li class="" data-id="action" data-count="69"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/actions/" title="Actions">Actions <span class="count badge">69</span></a></li><li class="" data-id="filter" data-count="80"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/filters/" title="Filters">Filters <span class="count badge">80</span></a></li><li class="" data-id="class" data-count="539"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/classes/" title="Classes">Classes <span class="count badge">539</span></a></li><li class="" data-id="constant" data-count="230"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/constants/" title="Constants">Constants <span class="count badge">230</span></a></li><li class="" data-id="function" data-count="55"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/functions/" title="Functions">Functions <span class="count badge">55</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/Util_Environment.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>namespace W3TC;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Util_Environment {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Formats URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $params</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $skip_empty</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $separator</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_format( $url = '', $params = array(), &nbsp;</div></li><li><div>      $skip_empty = false, $separator = '&' ) {&nbsp;</div></li><li><div>      if ( $url != '' ) {&nbsp;</div></li><li><div>          $parse_url = @parse_url( $url );&nbsp;</div></li><li><div>          $url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $parse_url['scheme'] ) ) {&nbsp;</div></li><li><div>              $url .= $parse_url['scheme'] . ':<span class="comment">//';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !empty( $parse_url['user'] ) ) {&nbsp;</div></li><li><div>                  $url .= $parse_url['user'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( !empty( $parse_url['pass'] ) ) {&nbsp;</div></li><li><div>                      $url .= ':' . $parse_url['pass'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !empty( $parse_url['host'] ) ) {&nbsp;</div></li><li><div>                  $url .= $parse_url['host'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !empty( $parse_url['port'] ) && $parse_url['port'] != 80 ) {&nbsp;</div></li><li><div>                  $url .= ':' . (int) $parse_url['port'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $parse_url['path'] ) ) {&nbsp;</div></li><li><div>              $url .= $parse_url['path'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $parse_url['query'] ) ) {&nbsp;</div></li><li><div>              $old_params = array();&nbsp;</div></li><li><div>              parse_str( $parse_url['query'], $old_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $params = array_merge( $old_params, $params );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $query = Util_Environment::url_query( $params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $query != '' ) {&nbsp;</div></li><li><div>              $url .= '?' . $query;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $parse_url['fragment'] ) ) {&nbsp;</div></li><li><div>              $url .= '#' . $parse_url['fragment'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $query = Util_Environment::url_query( $params, $skip_empty, $separator );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $query != '' ) {&nbsp;</div></li><li><div>              $url = '?' . $query;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Formats query string</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $params</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $skip_empty</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $separator</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_query( $params = array(), $skip_empty = false, &nbsp;</div></li><li><div>      $separator = '&' ) {&nbsp;</div></li><li><div>      $str = '';&nbsp;</div></li><li><div>      static $stack = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( (array) $params as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( $skip_empty === true && empty( $value ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          array_push( $stack, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array( $value ) ) {&nbsp;</div></li><li><div>              if ( count( $value ) ) {&nbsp;</div></li><li><div>                  $str .= ( $str != '' ? '&' : '' ) .&nbsp;</div></li><li><div>                      Util_Environment::url_query( $value, $skip_empty, $key );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $name = '';&nbsp;</div></li><li><div>              foreach ( $stack as $key ) {&nbsp;</div></li><li><div>                  $name .= ( $name != '' ? '[' . $key . ']' : $key );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $str .= ( $str != '' ? $separator : '' ) . $name . '=' . rawurlencode( $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          array_pop( $stack );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns URI from filename/dirname</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function filename_to_url( $filename, $use_site_url = false ) {&nbsp;</div></li><li><div>      <span class="comment">// using wp-content instead of document_root as known dir since dirbased</span>&nbsp;</div></li><li><div>      <span class="comment">// multisite wp adds blogname to the path inside site_url</span>&nbsp;</div></li><li><div>      if ( substr( $filename, 0, strlen( WP_CONTENT_DIR ) ) != WP_CONTENT_DIR )&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      $uri_from_wp_content = substr( $filename, strlen( WP_CONTENT_DIR ) );&nbsp;</div></li><li><div>      $url = content_url( $uri_from_wp_content );&nbsp;</div></li><li><div>      $url = apply_filters( 'w3tc_filename_to_url', $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if database cluster is used</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_dbcluster() {&nbsp;</div></li><li><div>      return defined( 'W3TC_FILE_DB_CLUSTER_CONFIG' ) &&&nbsp;</div></li><li><div>          @file_exists( W3TC_FILE_DB_CLUSTER_CONFIG )&nbsp;</div></li><li><div>          && defined( 'W3TC_ENTERPRISE' ) && W3TC_ENTERPRISE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if WPMU uses vhosts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_wpmu_subdomain() {&nbsp;</div></li><li><div>      return ( ( defined( 'SUBDOMAIN_INSTALL' ) && SUBDOMAIN_INSTALL ) ||&nbsp;</div></li><li><div>          ( defined( 'VHOST' ) && VHOST == 'yes' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns if there is multisite mode</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_wpmu() {&nbsp;</div></li><li><div>      static $wpmu = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $wpmu === null ) {&nbsp;</div></li><li><div>          $wpmu = ( file_exists( ABSPATH . 'wpmu-settings.php' ) ||&nbsp;</div></li><li><div>              ( defined( 'MULTISITE' ) && MULTISITE ) ||&nbsp;</div></li><li><div>              defined( 'SUNRISE' ) ||&nbsp;</div></li><li><div>              Util_Environment::is_wpmu_subdomain() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $wpmu;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function is_using_master_config() {&nbsp;</div></li><li><div>      static $result = null;&nbsp;</div></li><li><div>      if ( is_null( $result ) ) {&nbsp;</div></li><li><div>          if ( !Util_Environment::is_wpmu() ) {&nbsp;</div></li><li><div>              $result = true;&nbsp;</div></li><li><div>          } elseif ( is_network_admin() ) {&nbsp;</div></li><li><div>              $result = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $blog_data = Util_WpmuBlogmap::get_current_blog_data();&nbsp;</div></li><li><div>              if ( is_null( $blog_data ) )&nbsp;</div></li><li><div>                  $result = true;&nbsp;</div></li><li><div>              $result = ( $blog_data[0] == 'm' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns header W3TC adds to responses powered by itself</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function w3tc_header( $config ) {&nbsp;</div></li><li><div>      return W3TC_POWERED_BY .&nbsp;</div></li><li><div>          ( Util_Environment::is_w3tc_pro( $config ) ? ' Pro' : '' ) .&nbsp;</div></li><li><div>          '/' . W3TC_VERSION;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if URL is valid</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_url( $url ) {&nbsp;</div></li><li><div>      return preg_match( '~^(https?:)?<span class="comment">//~', $url );</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if current connection is secure</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_https() {&nbsp;</div></li><li><div>      switch ( true ) {&nbsp;</div></li><li><div>      case ( isset( $_SERVER['HTTPS'] ) &&&nbsp;</div></li><li><div>              Util_Environment::to_boolean( $_SERVER['HTTPS'] ) ):&nbsp;</div></li><li><div>      case ( isset( $_SERVER['SERVER_PORT'] ) &&&nbsp;</div></li><li><div>              (int) $_SERVER['SERVER_PORT'] == 443 ):&nbsp;</div></li><li><div>      case ( isset( $_SERVER['HTTP_X_FORWARDED_PROTO'] ) &&&nbsp;</div></li><li><div>              $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https' ):&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Moves user to preview-mode or opposite</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function set_preview( $is_enabled ) {&nbsp;</div></li><li><div>      if ( $is_enabled )&nbsp;</div></li><li><div>          setcookie( 'w3tc_preview', '*', 0, '/' );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          setcookie( &quot;w3tc_preview&quot;, '', time()-3600, '/' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retuns true if preview settings active</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_preview_mode() {&nbsp;</div></li><li><div>      return !empty( $_COOKIE['w3tc_preview'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if server is Apache</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_apache() {&nbsp;</div></li><li><div>      <span class="comment">// assume apache when unknown, since most common</span>&nbsp;</div></li><li><div>      if ( empty( $_SERVER['SERVER_SOFTWARE'] ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return isset( $_SERVER['SERVER_SOFTWARE'] ) && stristr( $_SERVER['SERVER_SOFTWARE'], 'Apache' ) !== false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check whether server is LiteSpeed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_litespeed() {&nbsp;</div></li><li><div>      return isset( $_SERVER['SERVER_SOFTWARE'] ) && stristr( $_SERVER['SERVER_SOFTWARE'], 'LiteSpeed' ) !== false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if server is nginx</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_nginx() {&nbsp;</div></li><li><div>      return isset( $_SERVER['SERVER_SOFTWARE'] ) && stristr( $_SERVER['SERVER_SOFTWARE'], 'nginx' ) !== false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns domain from host</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $host</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_to_host( $url ) {&nbsp;</div></li><li><div>      $a = parse_url( $url );&nbsp;</div></li><li><div>      if ( isset( $a['host'] ) )&nbsp;</div></li><li><div>          return $a['host'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns current blog ID</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return integer</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function blog_id() {&nbsp;</div></li><li><div>      global $w3_current_blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_null( $w3_current_blog_id ) )&nbsp;</div></li><li><div>          return $w3_current_blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !Util_Environment::is_wpmu() || is_network_admin() ) {&nbsp;</div></li><li><div>          $w3_current_blog_id = 0;&nbsp;</div></li><li><div>          return $w3_current_blog_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $blog_data = Util_WpmuBlogmap::get_current_blog_data();&nbsp;</div></li><li><div>      if ( !is_null( $blog_data ) )&nbsp;</div></li><li><div>          $w3_current_blog_id = substr( $blog_data, 1 );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $w3_current_blog_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $w3_current_blog_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Memoized version of wp_upload_dir. That function is quite slow</span>&nbsp;</div></li><li><div><span class="comment">   * for a number of times CDN calls it</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function wp_upload_dir() {&nbsp;</div></li><li><div>      static $values_by_blog = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $blog_id = Util_Environment::blog_id();&nbsp;</div></li><li><div>      if ( !isset( $values_by_blog[$blog_id] ) )&nbsp;</div></li><li><div>          $values_by_blog[$blog_id] = wp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $values_by_blog[$blog_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns path to section's cache dir</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $section</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function cache_dir( $section ) {&nbsp;</div></li><li><div>      return W3TC_CACHE_DIR . '/' . $section;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns path to blog's cache dir</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $section</span>&nbsp;</div></li><li><div><span class="comment">   * @param null|int $blog_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function cache_blog_dir( $section, $blog_id = null ) {&nbsp;</div></li><li><div>      if ( !Util_Environment::is_wpmu() )&nbsp;</div></li><li><div>          $postfix = '';&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          if ( is_null( $blog_id ) )&nbsp;</div></li><li><div>              $blog_id = Util_Environment::blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $postfix = '/' . sprintf( '%d', $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( defined( 'W3TC_BLOG_LEVELS' ) ) {&nbsp;</div></li><li><div>              for ( $n = 0; $n &lt; W3TC_BLOG_LEVELS; $n++ )&nbsp;</div></li><li><div>                  $postfix = '/' .&nbsp;</div></li><li><div>                      substr( $postfix, strlen( $postfix ) - 1 - $n, 1 ) .&nbsp;</div></li><li><div>                      $postfix;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return Util_Environment::cache_dir( $section ) . $postfix;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function cache_blog_minify_dir() {&nbsp;</div></li><li><div>      <span class="comment">// when minify manual used with a shared config - shared</span>&nbsp;</div></li><li><div>      <span class="comment">// minify urls has to be used too, since CDN upload is possible</span>&nbsp;</div></li><li><div>      <span class="comment">// only from network admin</span>&nbsp;</div></li><li><div>      if ( Util_Environment::is_wpmu() &&&nbsp;</div></li><li><div>          Util_Environment::is_using_master_config() &&&nbsp;</div></li><li><div>          ! Dispatcher::config()-&gt;get_boolean( 'minify.auto' ) )&nbsp;</div></li><li><div>          $path = Util_Environment::cache_blog_dir( 'minify', 0 );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $path = Util_Environment::cache_blog_dir( 'minify' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns URL regexp from URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function get_url_regexp( $url ) {&nbsp;</div></li><li><div>      $url = preg_replace( '~(https?:)?<span class="comment">//~i', '', $url );</span>&nbsp;</div></li><li><div>      $url = preg_replace( '~^www\.~i', '', $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $regexp = '(https?:)?<span class="comment">//(www\.)?' . Util_Environment::preg_quote( $url );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $regexp;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns SSL URL if current connection is https</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_to_maybe_https( $url ) {&nbsp;</div></li><li><div>      if ( Util_Environment::is_https() ) {&nbsp;</div></li><li><div>          $url = str_replace( 'http:<span class="comment">//', 'https://', $url );</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get domain URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function home_domain_root_url() {&nbsp;</div></li><li><div>      $home_url = get_home_url();&nbsp;</div></li><li><div>      $parse_url = @parse_url( $home_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $parse_url && isset( $parse_url['scheme'] ) && isset( $parse_url['host'] ) ) {&nbsp;</div></li><li><div>          $scheme = $parse_url['scheme'];&nbsp;</div></li><li><div>          $host = $parse_url['host'];&nbsp;</div></li><li><div>          $port = ( isset( $parse_url['port'] ) && $parse_url['port'] != 80 ? ':' . (int) $parse_url['port'] : '' );&nbsp;</div></li><li><div>          $domain_url = sprintf( '%s:<span class="comment">//%s%s', $scheme, $host, $port );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $domain_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns domain url regexp</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function home_domain_root_url_regexp() {&nbsp;</div></li><li><div>      $domain_url = Util_Environment::home_domain_root_url();&nbsp;</div></li><li><div>      $regexp = Util_Environment::get_url_regexp( $domain_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $regexp;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns SSL home url</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function home_url_maybe_https() {&nbsp;</div></li><li><div>      $home_url = get_home_url();&nbsp;</div></li><li><div>      $ssl = Util_Environment::url_to_maybe_https( $home_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $ssl;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns home url regexp</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function home_url_regexp() {&nbsp;</div></li><li><div>      $home_url = get_home_url();&nbsp;</div></li><li><div>      $regexp = Util_Environment::get_url_regexp( $home_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $regexp;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Copy of wordpress get_home_path, but accessible not only for wp-admin</span>&nbsp;</div></li><li><div><span class="comment">   * Get the absolute filesystem path to the root of the WordPress installation</span>&nbsp;</div></li><li><div><span class="comment">   * (i.e. filesystem path of siteurl)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Full filesystem path to the root of the WordPress installation</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function site_path() {&nbsp;</div></li><li><div>      $home = set_url_scheme( get_option( 'home' ), 'http' );&nbsp;</div></li><li><div>      $siteurl = set_url_scheme( get_option( 'siteurl' ), 'http' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $home_path = ABSPATH;&nbsp;</div></li><li><div>      if ( ! empty( $home ) && 0 !== strcasecmp( $home, $siteurl ) ) {&nbsp;</div></li><li><div>          $wp_path_rel_to_home = str_ireplace( $home, '', $siteurl ); <span class="comment">/** $siteurl - $home */</span>&nbsp;</div></li><li><div>          $pos = strripos( str_replace( '\\', '/', $_SERVER['SCRIPT_FILENAME'] ), trailingslashit( $wp_path_rel_to_home ) );&nbsp;</div></li><li><div>          <span class="comment">// fix of get_home_path, used when index.php is moved outside of</span>&nbsp;</div></li><li><div>          <span class="comment">// wp folder.</span>&nbsp;</div></li><li><div>          if ( $pos !== false ) {&nbsp;</div></li><li><div>              $home_path = substr( $_SERVER['SCRIPT_FILENAME'], 0, $pos );&nbsp;</div></li><li><div>              $home_path = trailingslashit( $home_path );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return str_replace( '\\', '/', $home_path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns absolute path to document root</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * No trailing slash!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function document_root() {&nbsp;</div></li><li><div>      static $document_root = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_null( $document_root ) )&nbsp;</div></li><li><div>          return $document_root;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $_SERVER['SCRIPT_FILENAME'] ) &&&nbsp;</div></li><li><div>          !empty( $_SERVER['PHP_SELF'] ) ) {&nbsp;</div></li><li><div>          $script_filename = Util_Environment::normalize_path(&nbsp;</div></li><li><div>              $_SERVER['SCRIPT_FILENAME'] );&nbsp;</div></li><li><div>          $php_self = Util_Environment::normalize_path(&nbsp;</div></li><li><div>              $_SERVER['PHP_SELF'] );&nbsp;</div></li><li><div>          if ( substr( $script_filename, -strlen( $php_self ) ) == $php_self ) {&nbsp;</div></li><li><div>              $document_root = substr( $script_filename, 0, -strlen( $php_self ) );&nbsp;</div></li><li><div>              $document_root = realpath( $document_root );&nbsp;</div></li><li><div>              return $document_root;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $_SERVER['PATH_TRANSLATED'] ) ) {&nbsp;</div></li><li><div>          $document_root = substr(&nbsp;</div></li><li><div>              Util_Environment::normalize_path( $_SERVER['PATH_TRANSLATED'] ), &nbsp;</div></li><li><div>              0, &nbsp;</div></li><li><div>              -strlen( Util_Environment::normalize_path( $_SERVER['PHP_SELF'] ) ) );&nbsp;</div></li><li><div>      } elseif ( !empty( $_SERVER['DOCUMENT_ROOT'] ) ) {&nbsp;</div></li><li><div>          $document_root = Util_Environment::normalize_path( $_SERVER['DOCUMENT_ROOT'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $document_root = ABSPATH;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $document_root = realpath( $document_root );&nbsp;</div></li><li><div>      return $document_root;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns absolute path to blog install dir</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Example:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * DOCUMENT_ROOT=/var/www/vhosts/domain.com</span>&nbsp;</div></li><li><div><span class="comment">   * install dir=/var/www/vhosts/domain.com/site/blog</span>&nbsp;</div></li><li><div><span class="comment">   * return /var/www/vhosts/domain.com/site/blog</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * No trailing slash!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function site_root() {&nbsp;</div></li><li><div>      $site_root = ABSPATH;&nbsp;</div></li><li><div>      $site_root = realpath( $site_root );&nbsp;</div></li><li><div>      $site_root = Util_Environment::normalize_path( $site_root );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_root;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns blog path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Example:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * siteurl=http://domain.com/site/blog</span>&nbsp;</div></li><li><div><span class="comment">   * return /site/blog/</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * With trailing slash!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function site_url_uri() {&nbsp;</div></li><li><div>      $site_url = site_url();&nbsp;</div></li><li><div>      $parse_url = @parse_url( $site_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $parse_url && isset( $parse_url['path'] ) ) {&nbsp;</div></li><li><div>          $site_path = '/' . ltrim( $parse_url['path'], '/' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $site_path = '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( substr( $site_path, -1 ) != '/' ) {&nbsp;</div></li><li><div>          $site_path .= '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns home domain</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function home_url_host() {&nbsp;</div></li><li><div>      $home_url = get_home_url();&nbsp;</div></li><li><div>      $parse_url = @parse_url( $home_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $parse_url && isset( $parse_url['host'] ) ) {&nbsp;</div></li><li><div>          return $parse_url['host'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return Util_Environment::host();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns home path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Example:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * home=http://domain.com/site/</span>&nbsp;</div></li><li><div><span class="comment">   * siteurl=http://domain.com/site/blog</span>&nbsp;</div></li><li><div><span class="comment">   * return /site/</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * With trailing slash!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function home_url_uri() {&nbsp;</div></li><li><div>      $home_url = get_home_url();&nbsp;</div></li><li><div>      $parse_url = @parse_url( $home_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $parse_url && isset( $parse_url['path'] ) ) {&nbsp;</div></li><li><div>          $home_path = '/' . ltrim( $parse_url['path'], '/' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $home_path = '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( substr( $home_path, -1 ) != '/' ) {&nbsp;</div></li><li><div>          $home_path .= '/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $home_path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function network_home_url_uri() {&nbsp;</div></li><li><div>      $uri = network_home_url( '', 'relative' );&nbsp;</div></li><li><div>      if ( empty( $uri ) )&nbsp;</div></li><li><div>          return '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $uri;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns server hostname with port</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function host_port() {&nbsp;</div></li><li><div>      static $host = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $host === null ) {&nbsp;</div></li><li><div>          if ( !empty( $_SERVER['HTTP_HOST'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">// HTTP_HOST sometimes is not set causing warning</span>&nbsp;</div></li><li><div>              $host = $_SERVER['HTTP_HOST'];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $host = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $host;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function host() {&nbsp;</div></li><li><div>      $host_port = Util_Environment::host_port();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pos = strpos( $host_port, ':' );&nbsp;</div></li><li><div>      if ( $pos === false )&nbsp;</div></li><li><div>          return $host_port;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return substr( $host_port, 0, $pos );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns WP config file path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function wp_config_path() {&nbsp;</div></li><li><div>      $search = array(&nbsp;</div></li><li><div>          ABSPATH . 'wp-config.php', &nbsp;</div></li><li><div>          dirname( ABSPATH ) . '/wp-config.php'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $search as $path ) {&nbsp;</div></li><li><div>          if ( file_exists( $path ) ) {&nbsp;</div></li><li><div>              return $path;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parses path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function parse_path( $path ) {&nbsp;</div></li><li><div>      $path = str_replace( array(&nbsp;</div></li><li><div>              '%BLOG_ID%', &nbsp;</div></li><li><div>              '%POST_ID%', &nbsp;</div></li><li><div>              '%BLOG_ID%', &nbsp;</div></li><li><div>              '%HOST%'&nbsp;</div></li><li><div> ), array(&nbsp;</div></li><li><div>              ( isset( $GLOBALS['blog_id'] ) ? (int) $GLOBALS['blog_id'] : 0 ), &nbsp;</div></li><li><div>              ( isset( $GLOBALS['post_id'] ) ? (int) $GLOBALS['post_id'] : 0 ), &nbsp;</div></li><li><div>              Util_Environment::blog_id(), &nbsp;</div></li><li><div>              Util_Environment::host()&nbsp;</div></li><li><div> ), $path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Normalizes file name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Relative to site root!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $file</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function normalize_file( $file ) {&nbsp;</div></li><li><div>      if ( Util_Environment::is_url( $file ) ) {&nbsp;</div></li><li><div>          if ( strstr( $file, '?' ) === false ) {&nbsp;</div></li><li><div>              $home_url_regexp = '~' . Util_Environment::home_url_regexp() . '~i';&nbsp;</div></li><li><div>              $file = preg_replace( $home_url_regexp, '', $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !Util_Environment::is_url( $file ) ) {&nbsp;</div></li><li><div>          $file = Util_Environment::normalize_path( $file );&nbsp;</div></li><li><div>          $file = str_replace( Util_Environment::site_root(), '', $file );&nbsp;</div></li><li><div>          $file = ltrim( $file, '/' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Normalizes file name for minify</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Relative to document root!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $file</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function normalize_file_minify( $file ) {&nbsp;</div></li><li><div>      if ( Util_Environment::is_url( $file ) ) {&nbsp;</div></li><li><div>          if ( strstr( $file, '?' ) === false ) {&nbsp;</div></li><li><div>              $domain_url_regexp = '~' . Util_Environment::home_domain_root_url_regexp() . '~i';&nbsp;</div></li><li><div>              $file = preg_replace( $domain_url_regexp, '', $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !Util_Environment::is_url( $file ) ) {&nbsp;</div></li><li><div>          $file = Util_Environment::normalize_path( $file );&nbsp;</div></li><li><div>          $file = str_replace( Util_Environment::document_root(), '', $file );&nbsp;</div></li><li><div>          $file = ltrim( $file, '/' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Normalizes file name for minify</span>&nbsp;</div></li><li><div><span class="comment">   * Relative to document root!</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $file</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_to_docroot_filename( $url ) {&nbsp;</div></li><li><div>      $data = array(&nbsp;</div></li><li><div>          'home_url' =&gt; get_home_url(), &nbsp;</div></li><li><div>          'url' =&gt; $url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $data = apply_filters( 'w3tc_url_to_docroot_filename', $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $home_url = $data['home_url'];&nbsp;</div></li><li><div>      $normalized_url = $data['url'];&nbsp;</div></li><li><div>      $normalized_url = Util_Environment::remove_query_all( $normalized_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// cut protocol</span>&nbsp;</div></li><li><div>      $normalized_url = preg_replace( '~^http(s)?:<span class="comment">//~', '//', $normalized_url );</span>&nbsp;</div></li><li><div>      $home_url = preg_replace( '~^http(s)?:<span class="comment">//~', '//', $home_url );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( substr( $normalized_url, 0, strlen( $home_url ) ) != $home_url ) {&nbsp;</div></li><li><div>          <span class="comment">// not a home url, return unchanged since cant be</span>&nbsp;</div></li><li><div>          <span class="comment">// converted to filename</span>&nbsp;</div></li><li><div>          return $url;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $path_relative_to_home = str_replace( $home_url, '', $normalized_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $home = set_url_scheme( get_option( 'home' ), 'http' );&nbsp;</div></li><li><div>          $siteurl = set_url_scheme( get_option( 'siteurl' ), 'http' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $home_path = rtrim( Util_Environment::site_path(), '/' );&nbsp;</div></li><li><div>          <span class="comment">// adjust home_path if site is not is home</span>&nbsp;</div></li><li><div>          if ( ! empty( $home ) && 0 !== strcasecmp( $home, $siteurl ) ) {&nbsp;</div></li><li><div>              <span class="comment">// $siteurl - $home</span>&nbsp;</div></li><li><div>              $wp_path_rel_to_home = rtrim( str_ireplace( $home, '', $siteurl ), '/' );&nbsp;</div></li><li><div>              if ( substr( $home_path, -strlen( $wp_path_rel_to_home ) ) ==&nbsp;</div></li><li><div>                  $wp_path_rel_to_home ) {&nbsp;</div></li><li><div>                  $home_path = substr( $home_path, 0, -strlen( $wp_path_rel_to_home ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// common encoded characters</span>&nbsp;</div></li><li><div>          $path_relative_to_home = str_replace( '%20', ' ', $path_relative_to_home );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $full_filename = $home_path . '/' . trim( $path_relative_to_home, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $docroot = Util_Environment::document_root();&nbsp;</div></li><li><div>          if ( substr( $full_filename, 0, strlen( $docroot ) ) == $docroot )&nbsp;</div></li><li><div>              $docroot_filename = substr( $full_filename, strlen( $docroot ) );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $docroot_filename = $path_relative_to_home;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// sometimes urls (coming from other plugins/themes)</span>&nbsp;</div></li><li><div>      <span class="comment">// contain multiple &quot;/&quot; like &quot;my-folder//myfile.js&quot; which</span>&nbsp;</div></li><li><div>      <span class="comment">// fails to recognize by filesystem, while url is accessible</span>&nbsp;</div></li><li><div>      $docroot_filename = str_replace( '<span class="comment">//', '/', $docroot_filename );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ltrim( $docroot_filename, '/' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Translates remote file to local file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $file</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function translate_file( $file ) {&nbsp;</div></li><li><div>      return $file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes WP query string from URL</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function remove_query( $url ) {&nbsp;</div></li><li><div>      $url = preg_replace( '~[&\?]+(ver=([a-z0-9-_\.]+|[0-9-]+))~i', '', $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes all query strings from url</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function remove_query_all( $url ) {&nbsp;</div></li><li><div>      $pos = strpos( $url, '?' );&nbsp;</div></li><li><div>      if ( $pos === false )&nbsp;</div></li><li><div>          return $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return substr( $url, 0, $pos );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converts win path to unix</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function normalize_path( $path ) {&nbsp;</div></li><li><div>      $path = preg_replace( '~[/\\\]+~', '/', $path );&nbsp;</div></li><li><div>      $path = rtrim( $path, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns real path of given path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function realpath( $path ) {&nbsp;</div></li><li><div>      $path = Util_Environment::normalize_path( $path );&nbsp;</div></li><li><div>      $parts = explode( '/', $path );&nbsp;</div></li><li><div>      $absolutes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $parts as $part ) {&nbsp;</div></li><li><div>          if ( '.' == $part ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( '..' == $part ) {&nbsp;</div></li><li><div>              array_pop( $absolutes );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $absolutes[] = $part;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode( '/', $absolutes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns real path of given path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function path_remove_dots( $path ) {&nbsp;</div></li><li><div>      $parts = explode( '/', $path );&nbsp;</div></li><li><div>      $absolutes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $parts as $part ) {&nbsp;</div></li><li><div>          if ( '.' == $part ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( '..' == $part ) {&nbsp;</div></li><li><div>              array_pop( $absolutes );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $absolutes[] = $part;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode( '/', $absolutes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns full URL from relative one</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function url_relative_to_full( $relative_url ) {&nbsp;</div></li><li><div>      $relative_url = Util_Environment::path_remove_dots( $relative_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $rel = parse_url( $relative_url );&nbsp;</div></li><li><div>      <span class="comment">// it's full url already</span>&nbsp;</div></li><li><div>      if ( isset( $rel['scheme'] ) || isset( $rel['host'] ) )&nbsp;</div></li><li><div>          return $relative_url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset( $rel['host'] ) )&nbsp;</div></li><li><div>          $rel['host'] = parse_url( get_home_url(), PHP_URL_HOST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $scheme = isset( $rel['scheme'] ) ? $rel['scheme'] . '://' : '<span class="comment">//';</span>&nbsp;</div></li><li><div>      $host = isset( $rel['host'] ) ? $rel['host'] : '';&nbsp;</div></li><li><div>      $port = isset( $rel['port'] ) ? ':' . $rel['port'] : '';&nbsp;</div></li><li><div>      $path = isset( $rel['path'] ) ? $rel['path'] : '';&nbsp;</div></li><li><div>      $query = isset( $rel['query'] ) ? '?' . $rel['query'] : '';&nbsp;</div></li><li><div>      return &quot;$scheme$host$port$path$query&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Redirects to URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function redirect( $url = '', $params = array() ) {&nbsp;</div></li><li><div>      $url = Util_Environment::url_format( $url, $params );&nbsp;</div></li><li><div>      if ( function_exists( 'do_action' ) )&nbsp;</div></li><li><div>          do_action( 'w3tc_redirect' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      @header( 'Location: ' . $url );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Redirects to URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $params</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function redirect_temp( $url = '', $params = array() ) {&nbsp;</div></li><li><div>      $url = Util_Environment::url_format( $url, $params );&nbsp;</div></li><li><div>      if ( function_exists( 'do_action' ) )&nbsp;</div></li><li><div>          do_action( 'w3tc_redirect' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status_code = 301;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $protocol = $_SERVER[&quot;SERVER_PROTOCOL&quot;];&nbsp;</div></li><li><div>      if ( 'HTTP/1.1' === $protocol ) {&nbsp;</div></li><li><div>          $status_code = 307;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $text = get_status_header_desc( $status_code );&nbsp;</div></li><li><div>      if ( !empty( $text ) ) {&nbsp;</div></li><li><div>          $status_header = &quot;$protocol $status_code $text&quot;;&nbsp;</div></li><li><div>          @header( $status_header, true, $status_code );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      @header( 'Cache-Control: no-cache' );&nbsp;</div></li><li><div>      @header( 'Location: ' . $url, true, $status_code );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Detects post ID</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return integer</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function detect_post_id() {&nbsp;</div></li><li><div>      global $posts, $comment_post_ID, $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $post_ID ) {&nbsp;</div></li><li><div>          return $post_ID;&nbsp;</div></li><li><div>      } elseif ( $comment_post_ID ) {&nbsp;</div></li><li><div>          return $comment_post_ID;&nbsp;</div></li><li><div>      } elseif ( ( is_single() || is_page() ) && is_array( $posts ) ) {&nbsp;</div></li><li><div>          return $posts[0]-&gt;ID;&nbsp;</div></li><li><div>      } elseif ( is_object( $posts ) && property_exists( $posts, 'ID' ) ) {&nbsp;</div></li><li><div>          return $posts-&gt;ID;&nbsp;</div></li><li><div>      } elseif ( isset( $_REQUEST['p'] ) ) {&nbsp;</div></li><li><div>          return (integer) $_REQUEST['p'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public function instance_id() {&nbsp;</div></li><li><div>      static $instance_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset( $instance_id ) ) {&nbsp;</div></li><li><div>          $config = Dispatcher::config();&nbsp;</div></li><li><div>          $instance_id = $config-&gt;get_integer( 'common.instance_id', 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $instance_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var Config $config</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function w3tc_edition( $config = null ) {&nbsp;</div></li><li><div>      if ( Util_Environment::is_w3tc_enterprise( $config ) )&nbsp;</div></li><li><div>          return 'enterprise';&nbsp;</div></li><li><div>      if ( Util_Environment::is_w3tc_pro( $config ) &&  Util_Environment::is_w3tc_pro_dev() )&nbsp;</div></li><li><div>          return 'pro development';&nbsp;</div></li><li><div>      if ( Util_Environment::is_w3tc_pro( $config ) )&nbsp;</div></li><li><div>          return 'pro';&nbsp;</div></li><li><div>      return 'community';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param Config  $config</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_w3tc_pro( $config = null ) {&nbsp;</div></li><li><div>      $result = $config-&gt;get_string( 'plugin.type' ) == 'pro' ||&nbsp;</div></li><li><div>          $config-&gt;get_string( 'plugin.type' ) == 'pro_dev' ||&nbsp;</div></li><li><div>          Util_Environment::is_w3tc_enterprise( $config ) ||&nbsp;</div></li><li><div>          ( defined( 'W3TC_PRO' ) && W3TC_PRO );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enable Pro Dev mode support</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_w3tc_pro_dev() {&nbsp;</div></li><li><div>      return defined( 'W3TC_PRO_DEV_MODE' ) && W3TC_PRO_DEV_MODE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param Config  $config</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_w3tc_enterprise( $config = null ) {&nbsp;</div></li><li><div>      $result = false;&nbsp;</div></li><li><div>      if ( $config )&nbsp;</div></li><li><div>          $result = $config-&gt;get_string( 'plugin.type' ) == 'enterprise' ||&nbsp;</div></li><li><div>              ( defined( 'W3TC_ENTERPRISE' ) && W3TC_ENTERPRISE );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if site is using edge mode.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_w3tc_edge( $config ) {&nbsp;</div></li><li><div>      return $config-&gt;get_boolean( 'common.edge' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Quotes regular expression string</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $string</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $delimiter</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function preg_quote( $string, $delimiter = '~' ) {&nbsp;</div></li><li><div>      $string = preg_quote( $string, $delimiter );&nbsp;</div></li><li><div>      $string = strtr( $string, array(&nbsp;</div></li><li><div>              ' ' =&gt; '\ '&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if zlib output compression is enabled otherwise false</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_zlib_enabled() {&nbsp;</div></li><li><div>      return Util_Environment::to_boolean( ini_get( 'zlib.output_compression' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recursive strips slahes from the var</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed   $var</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function stripslashes( $var ) {&nbsp;</div></li><li><div>      if ( is_string( $var ) ) {&nbsp;</div></li><li><div>          return stripslashes( $var );&nbsp;</div></li><li><div>      } elseif ( is_array( $var ) ) {&nbsp;</div></li><li><div>          $var = array_map( array( '\W3TC\Util_Environment', 'stripslashes' ), $var );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $var;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if post should be flushed or not. Returns true if it should not be flushed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $post</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $module which cache module to check against (pgcache, varnish, dbcache or objectcache)</span>&nbsp;</div></li><li><div><span class="comment">   * @param Config  $config</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function is_flushable_post( $post, $module, $config ) {&nbsp;</div></li><li><div>      if ( is_numeric( $post ) )&nbsp;</div></li><li><div>          $post = get_post( $post );&nbsp;</div></li><li><div>      $post_status = array( 'publish' );&nbsp;</div></li><li><div>      <span class="comment">// dont flush when we have post &quot;attachment&quot;</span>&nbsp;</div></li><li><div>      <span class="comment">// its child of the post and is flushed always when post is published, while not changed in fact</span>&nbsp;</div></li><li><div>      $post_type = array( 'revision', 'attachment' );&nbsp;</div></li><li><div>      switch ( $module ) {&nbsp;</div></li><li><div>      case 'pgcache':&nbsp;</div></li><li><div>      case 'varnish':&nbsp;</div></li><li><div>      case 'posts':   <span class="comment">// means html content of post pages</span>&nbsp;</div></li><li><div>          if ( !$config-&gt;get_boolean( 'pgcache.reject.logged' ) )&nbsp;</div></li><li><div>              $post_status[] = 'private';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'dbcache':&nbsp;</div></li><li><div>          if ( !$config-&gt;get_boolean( 'dbcache.reject.logged' ) )&nbsp;</div></li><li><div>              $post_status[] = 'private';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $flushable = is_object( $post ) &&&nbsp;</div></li><li><div>          !in_array( $post-&gt;post_type, $post_type ) &&&nbsp;</div></li><li><div>          in_array( $post-&gt;post_status, $post_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'w3tc_flushable_post', $flushable, $post, $module );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converts value to boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed   $value</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function to_boolean( $value ) {&nbsp;</div></li><li><div>      if ( is_string( $value ) ) {&nbsp;</div></li><li><div>          switch ( strtolower( $value ) ) {&nbsp;</div></li><li><div>          case '+':&nbsp;</div></li><li><div>          case '1':&nbsp;</div></li><li><div>          case 'y':&nbsp;</div></li><li><div>          case 'on':&nbsp;</div></li><li><div>          case 'yes':&nbsp;</div></li><li><div>          case 'true':&nbsp;</div></li><li><div>          case 'enabled':&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case '-':&nbsp;</div></li><li><div>          case '0':&nbsp;</div></li><li><div>          case 'n':&nbsp;</div></li><li><div>          case 'no':&nbsp;</div></li><li><div>          case 'off':&nbsp;</div></li><li><div>          case 'false':&nbsp;</div></li><li><div>          case 'disabled':&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (boolean) $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>W3 Total Cache</li><li><span></span>0.9.5.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>