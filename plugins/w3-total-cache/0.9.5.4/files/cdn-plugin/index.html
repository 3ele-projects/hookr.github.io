<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="0.9.5.4" data-slug="w3-total-cache" data-type="file" data-id="94073"><head xmlns="http://www.w3.org/1999/xhtml"><title> cdn-plugin | file | W3 Total Cache | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, w3-total-cache, 0.9.5.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=70c400f96b4c583f23735fad2a39ac84' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/cdn-plugin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcdn-plugin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcdn-plugin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-w3-total-cache-0.9.5.4-file-cdn-plugin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="cdn-plugin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to w3-total-cache." href="http://hookr.io/plugins/w3-total-cache/" class="plugin"><span property="name">w3-total-cache</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 0.9.5.4." href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/" class="H_VERSION"><span property="name">0.9.5.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">cdn-plugin</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1105"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/all/" title="All">All <span class="count badge">1105</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="159"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/hooks/" title="Hooks">Hooks <span class="count badge">159</span></a></li><li class="" data-id="action" data-count="69"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/actions/" title="Actions">Actions <span class="count badge">69</span></a></li><li class="" data-id="filter" data-count="90"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/filters/" title="Filters">Filters <span class="count badge">90</span></a></li><li class="" data-id="class" data-count="635"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/classes/" title="Classes">Classes <span class="count badge">635</span></a></li><li class="" data-id="constant" data-count="229"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/constants/" title="Constants">Constants <span class="count badge">229</span></a></li><li class="" data-id="function" data-count="82"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/functions/" title="Functions">Functions <span class="count badge">82</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/Cdn_Plugin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>namespace W3TC;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * W3 Total Cache CDN Plugin</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Cdn_Plugin {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * CDN reject reason</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $cdn_reject_reason = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Config</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $_config = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $_replaced_urls = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;_config = Dispatcher::config();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Runs plugin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function run() {&nbsp;</div></li><li><div>      $cdn_engine = $this-&gt;_config-&gt;get_string( 'cdn.engine' );&nbsp;</div></li><li><div>      if ( Cdn_Util::is_engine_fsd( $cdn_engine ) ) {&nbsp;</div></li><li><div>          $this-&gt;run_fsd();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'cron_schedules', array(&nbsp;</div></li><li><div>              $this, &nbsp;</div></li><li><div>              'cron_schedules'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$this-&gt;_config-&gt;get_boolean( 'cdn.debug' ) )&nbsp;</div></li><li><div>          add_filter( 'w3tc_footer_comment', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'w3tc_footer_comment'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !Cdn_Util::is_engine_mirror( $cdn_engine ) ) {&nbsp;</div></li><li><div>          add_action( 'delete_attachment', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'delete_attachment'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'update_attached_file', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'update_attached_file'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'wp_update_attachment_metadata', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'update_attachment_metadata'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'w3_cdn_cron_queue_process', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'cron_queue_process'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'w3_cdn_cron_upload', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'cron_upload'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'switch_theme', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'switch_theme'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'update_feedback', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'update_feedback'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'w3tc_admin_bar_menu', &nbsp;</div></li><li><div>          array( $this, 'w3tc_admin_bar_menu' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          add_action( 'w3tc_config_ui_save-w3tc_cdn', array(&nbsp;</div></li><li><div>                  $this, 'change_canonical_header' ), 0, 0 );&nbsp;</div></li><li><div>          add_filter( 'w3tc_module_is_running-cdn', array( $this, 'cdn_is_running' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Start rewrite engine</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;can_cdn() ) {&nbsp;</div></li><li><div>          Util_Bus::add_ob_callback( 'cdn', array( $this, 'ob_callback' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() && Cdn_Util::can_purge( $cdn_engine ) ) {&nbsp;</div></li><li><div>          add_filter( 'media_row_actions', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'media_row_actions'&nbsp;</div></li><li><div> ), 0, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * run code for FSD CDN</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function run_fsd() {&nbsp;</div></li><li><div>      add_action( 'w3tc_flush_all', array(&nbsp;</div></li><li><div>              '\W3TC\Cdn_Fsd_CacheFlush', &nbsp;</div></li><li><div>              'w3tc_flush_all'&nbsp;</div></li><li><div> ), 3000, 1 );&nbsp;</div></li><li><div>      add_action( 'w3tc_flush_post', array(&nbsp;</div></li><li><div>              '\W3TC\Cdn_Fsd_CacheFlush', &nbsp;</div></li><li><div>              'w3tc_flush_post'&nbsp;</div></li><li><div> ), 3000, 1 );&nbsp;</div></li><li><div>      add_action( 'w3tc_flushable_posts', '__return_true', 3000 );&nbsp;</div></li><li><div>      add_action( 'w3tc_flush_posts', array(&nbsp;</div></li><li><div>              '\W3TC\Cdn_Fsd_CacheFlush', &nbsp;</div></li><li><div>              'w3tc_flush_all'&nbsp;</div></li><li><div> ), 3000 );&nbsp;</div></li><li><div>      add_action( 'w3tc_flush_url', array(&nbsp;</div></li><li><div>              '\W3TC\Cdn_Fsd_CacheFlush', &nbsp;</div></li><li><div>              'w3tc_flush_url'&nbsp;</div></li><li><div> ), 3000, 1 );&nbsp;</div></li><li><div>      add_filter( 'w3tc_flush_execute_delayed_operations', array(&nbsp;</div></li><li><div>              '\W3TC\Cdn_Fsd_CacheFlush', &nbsp;</div></li><li><div>              'w3tc_flush_execute_delayed_operations'&nbsp;</div></li><li><div> ), 3000 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      Util_AttachToActions::flush_posts_on_actions();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates worker with admin functionality on demand</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return Cdn_Core_Admin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_admin() {&nbsp;</div></li><li><div>      return Dispatcher::component( 'Cdn_Core_Admin' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cron queue process event</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cron_queue_process() {&nbsp;</div></li><li><div>      $queue_limit = $this-&gt;_config-&gt;get_integer( 'cdn.queue.limit' );&nbsp;</div></li><li><div>      return $this-&gt;get_admin()-&gt;queue_process( $queue_limit );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cron upload event</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cron_upload() {&nbsp;</div></li><li><div>      $files = $this-&gt;get_files();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $upload = array();&nbsp;</div></li><li><div>      $results = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $files as $file ) {&nbsp;</div></li><li><div>          $local_path = $common-&gt;docroot_filename_to_absolute_path( $file );&nbsp;</div></li><li><div>          $remote_path = $common-&gt;uri_to_cdn_uri( $common-&gt;docroot_filename_to_uri( $file ) );&nbsp;</div></li><li><div>          $upload[] = $common-&gt;build_file_descriptor( $local_path, $remote_path );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common-&gt;upload( $upload, true, $results );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update attachment file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Upload _wp_attached_file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $attached_file</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function update_attached_file( $attached_file ) {&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>      $files = $common-&gt;get_files_for_upload( $attached_file );&nbsp;</div></li><li><div>      $files = apply_filters( 'w3tc_cdn_update_attachment', $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common-&gt;upload( $files, true, $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $attached_file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * On attachment delete action</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Delete _wp_attached_file, _wp_attachment_metadata, _wp_attachment_backup_sizes</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $attachment_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function delete_attachment( $attachment_id ) {&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>      $files = $common-&gt;get_attachment_files( $attachment_id );&nbsp;</div></li><li><div>      $files = apply_filters( 'w3tc_cdn_delete_attachment', $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common-&gt;delete( $files, true, $results );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update attachment metadata filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Upload _wp_attachment_metadata</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $metadata</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function update_attachment_metadata( $metadata ) {&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>      $files = $common-&gt;get_metadata_files( $metadata );&nbsp;</div></li><li><div>      $files = apply_filters( 'w3tc_cdn_update_attachment_metadata', $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common-&gt;upload( $files, true, $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $metadata;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cron schedules filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $schedules</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cron_schedules( $schedules ) {&nbsp;</div></li><li><div>      $c = $this-&gt;_config;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $c-&gt;get_boolean( 'cdn.enabled' ) &&&nbsp;</div></li><li><div>          !Cdn_Util::is_engine_mirror( $c-&gt;get_string( 'cdn.engine' ) ) ) {&nbsp;</div></li><li><div>          $queue_interval = $c-&gt;get_integer( 'cdn.queue.interval' );&nbsp;</div></li><li><div>          $schedules['w3_cdn_cron_queue_process'] = array(&nbsp;</div></li><li><div>                  'interval' =&gt; $queue_interval, &nbsp;</div></li><li><div>                  'display' =&gt; sprintf(&nbsp;</div></li><li><div>                      '[W3TC] CDN queue process (every %d seconds)', $queue_interval&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $c-&gt;get_boolean( 'cdn.enabled' ) &&&nbsp;</div></li><li><div>          $c-&gt;get_boolean( 'cdn.autoupload.enabled' ) &&&nbsp;</div></li><li><div>          !Cdn_Util::is_engine_mirror( $c-&gt;get_string( 'cdn.engine' ) ) ) {&nbsp;</div></li><li><div>          $autoupload_interval = $c-&gt;get_integer( 'cdn.autoupload.interval' );&nbsp;</div></li><li><div>          $schedules['w3_cdn_cron_upload'] = array(&nbsp;</div></li><li><div>                  'interval' =&gt; $autoupload_interval, &nbsp;</div></li><li><div>                  'display' =&gt; sprintf(&nbsp;</div></li><li><div>                      '[W3TC] CDN auto upload (every %d seconds)', $autoupload_interval&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $schedules;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Switch theme action</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function switch_theme() {&nbsp;</div></li><li><div>      $state = Dispatcher::config_state();&nbsp;</div></li><li><div>      $state-&gt;set( 'cdn.show_note_theme_changed', true );&nbsp;</div></li><li><div>      $state-&gt;save();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * WP Upgrade action hack</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $message</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function update_feedback( $message ) {&nbsp;</div></li><li><div>      if ( $message == __( 'Upgrading database' ) ) {&nbsp;</div></li><li><div>          $state = Dispatcher::config_state();&nbsp;</div></li><li><div>          $state-&gt;set( 'cdn.show_note_wp_upgraded', true );&nbsp;</div></li><li><div>          $state-&gt;save();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * OB Callback</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $buffer</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function ob_callback( $buffer ) {&nbsp;</div></li><li><div>      if ( $buffer != '' && Util_Content::is_html_xml( $buffer ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;can_cdn2( $buffer ) ) {&nbsp;</div></li><li><div>              $srcset_helper = new _Cdn_Plugin_ContentFilter();&nbsp;</div></li><li><div>              $buffer = $srcset_helper-&gt;replace_all_links( $buffer );&nbsp;</div></li><li><div>              $this-&gt;_replaced_urls = $srcset_helper-&gt;get_replaced_urls();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $buffer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns array of files to upload</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_files() {&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.includes.enable' ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, $this-&gt;get_files_includes() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.theme.enable' ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, $this-&gt;get_files_theme() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.minify.enable' ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, $this-&gt;get_files_minify() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.custom.enable' ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, $this-&gt;get_files_custom() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Exports includes to CDN</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_files_includes() {&nbsp;</div></li><li><div>      $includes_root = Util_Environment::normalize_path( ABSPATH . WPINC );&nbsp;</div></li><li><div>      $doc_root = Util_Environment::normalize_path( Util_Environment::document_root() );&nbsp;</div></li><li><div>      $includes_path = ltrim( str_replace( $doc_root, '', $includes_root ), '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $files = Cdn_Util::search_files(&nbsp;</div></li><li><div>          $includes_root, $includes_path, $this-&gt;_config-&gt;get_string( 'cdn.includes.files' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Exports theme to CDN</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_files_theme() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If mobile or referrer support enabled</span>&nbsp;</div></li><li><div><span class="comment">       * we should upload whole themes directory</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'mobile.enabled' )&nbsp;</div></li><li><div>          || $this-&gt;_config-&gt;get_boolean( 'referrer.enabled' ) ) {&nbsp;</div></li><li><div>          $themes_root = get_theme_root();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $themes_root = get_stylesheet_directory();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $themes_root = Util_Environment::normalize_path( $themes_root );&nbsp;</div></li><li><div>      $themes_path = ltrim( str_replace(&nbsp;</div></li><li><div>              Util_Environment::normalize_path( Util_Environment::document_root() ), '', $themes_root ), '/' );&nbsp;</div></li><li><div>      $files = Cdn_Util::search_files(&nbsp;</div></li><li><div>          $themes_root, $themes_path, $this-&gt;_config-&gt;get_string( 'cdn.theme.files' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Exports min files to CDN</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_files_minify() {&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.rewrite' ) &&&nbsp;</div></li><li><div>          Util_Rule::can_check_rules() &&&nbsp;</div></li><li><div>          ( !$this-&gt;_config-&gt;get_boolean( 'minify.auto' ) ||&nbsp;</div></li><li><div>              Cdn_Util::is_engine_mirror( $this-&gt;_config-&gt;get_string( 'cdn.engine' ) ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $minify = Dispatcher::component( 'Minify_Plugin' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $document_root = Util_Environment::normalize_path(&nbsp;</div></li><li><div>              Util_Environment::document_root() );&nbsp;</div></li><li><div>          $minify_root = Util_Environment::normalize_path(&nbsp;</div></li><li><div>              Util_Environment::cache_blog_dir( 'minify' ) );&nbsp;</div></li><li><div>          $minify_path = ltrim( str_replace( $document_root, '', $minify_root ), '/' );&nbsp;</div></li><li><div>          $urls = $minify-&gt;get_urls();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// in WPMU + network admin (this code used for minify manual only)</span>&nbsp;</div></li><li><div>          <span class="comment">// common minify files are stored under context of main blog (i.e. 1)</span>&nbsp;</div></li><li><div>          <span class="comment">// but have urls of 0 blog, so download has to be used</span>&nbsp;</div></li><li><div>          if ( $this-&gt;_config-&gt;get_string( 'minify.engine' ) == 'file' &&&nbsp;</div></li><li><div>              !( Util_Environment::is_wpmu() && is_network_admin() ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $urls as $url ) {&nbsp;</div></li><li><div>                  Util_Http::get( $url );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $files = Cdn_Util::search_files( $minify_root, &nbsp;</div></li><li><div>                  $minify_path, '*.css;*.js' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              foreach ( $urls as $url ) {&nbsp;</div></li><li><div>                  $file = Util_Environment::normalize_file_minify( $url );&nbsp;</div></li><li><div>                  $file = Util_Environment::translate_file( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( !Util_Environment::is_url( $file ) ) {&nbsp;</div></li><li><div>                      $file = $document_root . '/' . $file;&nbsp;</div></li><li><div>                      $file = ltrim( str_replace( $minify_root, '', $file ), '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $dir = dirname( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $dir ) {&nbsp;</div></li><li><div>                          Util_File::mkdir( $dir, 0777, $minify_root );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( Util_Http::download( $url, $minify_root . '/' . $file ) !== false ) {&nbsp;</div></li><li><div>                          $files[] = $minify_path . '/' . $file;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Exports custom files to CDN</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_files_custom() {&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>      $document_root = Util_Environment::normalize_path(&nbsp;</div></li><li><div>          Util_Environment::document_root() );&nbsp;</div></li><li><div>      $custom_files = $this-&gt;_config-&gt;get_array( 'cdn.custom.files' );&nbsp;</div></li><li><div>      $custom_files = array_map( array( '\W3TC\Util_Environment', 'parse_path' ), $custom_files );&nbsp;</div></li><li><div>      $site_root = Util_Environment::normalize_path( Util_Environment::site_root() );&nbsp;</div></li><li><div>      $path = Util_Environment::site_url_uri();&nbsp;</div></li><li><div>      $site_root_dir = str_replace( $document_root, '', $site_root );&nbsp;</div></li><li><div>      if ( strstr( WP_CONTENT_DIR, Util_Environment::site_root() ) === false ) {&nbsp;</div></li><li><div>          $site_root = Util_Environment::normalize_path( Util_Environment::document_root() );&nbsp;</div></li><li><div>          $path = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content_path = trim( str_replace( WP_CONTENT_DIR, '', $site_root ), '/\\' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $custom_files as $custom_file ) {&nbsp;</div></li><li><div>          if ( $custom_file != '' ) {&nbsp;</div></li><li><div>              $custom_file = Cdn_Util::replace_folder_placeholders( $custom_file );&nbsp;</div></li><li><div>              $custom_file = Util_Environment::normalize_file( $custom_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !Util_Environment::is_wpmu() ) {&nbsp;</div></li><li><div>                  $dir = trim( dirname( $custom_file ), '/\\' );&nbsp;</div></li><li><div>                  $rel_path = trim( dirname( $custom_file ), '/\\' );&nbsp;</div></li><li><div>              } else&nbsp;</div></li><li><div>                  $rel_path = $dir = trim( dirname( $custom_file ), '/\\' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( strpos( $dir, '&lt;currentblog&gt;' ) != false ) {&nbsp;</div></li><li><div>                  $rel_path = $dir = str_replace(&nbsp;</div></li><li><div>                      '&lt;currentblog&gt;', 'blogs.dir/'&nbsp;</div></li><li><div>                      . Util_Environment::blog_id(), $dir&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $dir == '.' ) {&nbsp;</div></li><li><div>                  $rel_path = $dir = '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $mask = basename( $custom_file );&nbsp;</div></li><li><div>              $files = array_merge(&nbsp;</div></li><li><div>                  $files, Cdn_Util::search_files( $document_root . '/'&nbsp;</div></li><li><div>                      . $dir, $rel_path, $mask )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if we can do CDN logic</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function can_cdn() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if admin</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'WP_ADMIN' ) ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'wp-admin';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for WPMU's and WP's 3.0 short init</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'SHORTINIT' ) && SHORTINIT ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'Short init';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check User agent</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( !$this-&gt;check_ua() ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'user agent is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check request URI</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( !$this-&gt;_check_request_uri() ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'request URI is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Do not replace urls if SSL and SSL support is do not replace</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( Util_Environment::is_https() && $this-&gt;_config-&gt;get_boolean( 'cdn.reject.ssl' ) ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'SSL is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if we can do CDN logic</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $buffer</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function can_cdn2( $buffer ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for database error</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( Util_Content::is_database_error( $buffer ) ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'Database Error occurred';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for DONOTCDN constant</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'DONOTCDN' ) && DONOTCDN ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'DONOTCDN constant is defined';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check logged users roles</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean(&nbsp;</div></li><li><div>              'cdn.reject.logged_roles' ) && !$this-&gt;_check_logged_in_role_allowed()&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $this-&gt;cdn_reject_reason = 'logged in role is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks User Agent</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_ua() {&nbsp;</div></li><li><div>      $uas = array_merge( $this-&gt;_config-&gt;get_array( 'cdn.reject.ua' ), array(&nbsp;</div></li><li><div>              W3TC_POWERED_BY&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $uas as $ua ) {&nbsp;</div></li><li><div>          if ( !empty( $ua ) ) {&nbsp;</div></li><li><div>              if ( isset( $_SERVER['HTTP_USER_AGENT'] ) && stristr(&nbsp;</div></li><li><div>                      $_SERVER['HTTP_USER_AGENT'], $ua ) !== false&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks request URI</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _check_request_uri() {&nbsp;</div></li><li><div>      $reject_uri = $this-&gt;_config-&gt;get_array( 'cdn.reject.uri' );&nbsp;</div></li><li><div>      $reject_uri = array_map( array( '\W3TC\Util_Environment', 'parse_path' ), $reject_uri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $reject_uri as $expr ) {&nbsp;</div></li><li><div>          $expr = trim( $expr );&nbsp;</div></li><li><div>          $expr = str_replace( '~', '\~', $expr );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $expr != '' && preg_match( '~' . $expr . '~i', $_SERVER['REQUEST_URI'] ) ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Util_Request::get_string( 'wp_customize' ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if logged in user role is allwed to use CDN</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _check_logged_in_role_allowed() {&nbsp;</div></li><li><div>      $current_user = wp_get_current_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_user_logged_in() )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $roles = $this-&gt;_config-&gt;get_array( 'cdn.reject.roles' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $roles ) || empty( $current_user-&gt;roles ) ||&nbsp;</div></li><li><div>          !is_array( $current_user-&gt;roles ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $current_user-&gt;roles as $role ) {&nbsp;</div></li><li><div>          if ( in_array( $role, $roles ) )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * media_row_actions filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $actions</span>&nbsp;</div></li><li><div><span class="comment">   * @param object  $post</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function media_row_actions( $actions, $post ) {&nbsp;</div></li><li><div>      return $this-&gt;get_admin()-&gt;media_row_actions( $actions, $post );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $current_state</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cdn_is_running( $current_state ) {&nbsp;</div></li><li><div>      $admin = $this-&gt;get_admin();&nbsp;</div></li><li><div>      return $admin-&gt;is_running();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Change canonical header</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function change_canonical_header() {&nbsp;</div></li><li><div>      $admin = $this-&gt;get_admin();&nbsp;</div></li><li><div>      $admin-&gt;change_canonical_header();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function w3tc_admin_bar_menu( $menu_items ) {&nbsp;</div></li><li><div>      $cdn_engine = $this-&gt;_config-&gt;get_string( 'cdn.engine' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Cdn_Util::can_purge_all( $cdn_engine ) ) {&nbsp;</div></li><li><div>          $menu_items['20710.cdn'] = array(&nbsp;</div></li><li><div>              'id' =&gt; 'w3tc_cdn_flush_all', &nbsp;</div></li><li><div>              'parent' =&gt; 'w3tc_flush', &nbsp;</div></li><li><div>              'title' =&gt; __( 'CDN: All', 'w3-total-cache' ), &nbsp;</div></li><li><div>              'href' =&gt; wp_nonce_url( network_admin_url(&nbsp;</div></li><li><div>                      'admin.php?page=w3tc_cdn&amp;w3tc_flush_cdn' ), &nbsp;</div></li><li><div>                  'w3tc' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Cdn_Util::can_purge( $cdn_engine ) ) {&nbsp;</div></li><li><div>          $menu_items['20790.cdn'] = array(&nbsp;</div></li><li><div>              'id' =&gt; 'w3tc_cdn_flush', &nbsp;</div></li><li><div>              'parent' =&gt; 'w3tc_flush', &nbsp;</div></li><li><div>              'title' =&gt; __( 'CDN: Manual Purge', 'w3-total-cache' ), &nbsp;</div></li><li><div>              'href' =&gt; wp_nonce_url( network_admin_url( 'admin.php?page=w3tc_cdn&amp;w3tc_cdn_purge' ), 'w3tc' ), &nbsp;</div></li><li><div>              'meta' =&gt; array( 'onclick' =&gt; &quot;w3tc_popupadmin_bar(this.href); return false&quot; )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $menu_items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function w3tc_footer_comment( $strings ) {&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>      $cdn = $common-&gt;get_cdn();&nbsp;</div></li><li><div>      $via = $cdn-&gt;get_via();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $strings[] = sprintf(&nbsp;</div></li><li><div>          __( 'Content Delivery Network via %s%s', 'w3-total-cache' ), &nbsp;</div></li><li><div>          ( $via ? $via : 'N/A' ), &nbsp;</div></li><li><div>          ( empty( $this-&gt;cdn_reject_reason ) ? '' :&nbsp;</div></li><li><div>              sprintf( ' (%s)', $this-&gt;cdn_reject_reason ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.debug' ) ) {&nbsp;</div></li><li><div>          $strings[] = &quot;CDN debug info:&quot;;&nbsp;</div></li><li><div>          $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Engine: ', 20 ), &nbsp;</div></li><li><div>              $this-&gt;_config-&gt;get_string( 'cdn.engine' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;cdn_reject_reason ) {&nbsp;</div></li><li><div>              $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Reject reason: ', 20 ), &nbsp;</div></li><li><div>                  $this-&gt;cdn_reject_reason );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( count( $this-&gt;_replaced_urls ) ) {&nbsp;</div></li><li><div>              $strings[] = &quot;Replaced URLs:&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $this-&gt;_footer_comment_postfix as $old_url =&gt; $new_url ) {&nbsp;</div></li><li><div>                  $strings[] = sprintf( &quot;%s =&gt; %s&quot;, &nbsp;</div></li><li><div>                      Util_Content::escape_comment( $old_url ), &nbsp;</div></li><li><div>                      Util_Content::escape_comment( $new_url ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $strings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class _Cdn_Plugin_ContentFilter {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $_regexps = array();&nbsp;</div></li><li><div>  private $_placeholders = array();&nbsp;</div></li><li><div>  private $_config;&nbsp;</div></li><li><div>  private $_replaced_urls;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If background uploading already scheduled</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static $_upload_scheduled = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;_config = Dispatcher::config();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function replace_all_links( $buffer ) {&nbsp;</div></li><li><div>      $this-&gt;fill_regexps();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $srcset_pattern = '~srcset\s*=\s*[\&quot;\'](.*?)[\&quot;\']~';&nbsp;</div></li><li><div>      $buffer = preg_replace_callback(&nbsp;</div></li><li><div>          $srcset_pattern, array( $this, '_srcset_replace_callback' ), $buffer&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;_regexps as $regexp ) {&nbsp;</div></li><li><div>          $buffer = preg_replace_callback(&nbsp;</div></li><li><div>              $regexp, array( $this, '_link_replace_callback' ), $buffer&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.minify.enable' ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;_config-&gt;get_boolean( 'minify.auto' ) ) {&nbsp;</div></li><li><div>              $regexp = '~([&quot;\'(=])\s*' .&nbsp;</div></li><li><div>                  $this-&gt;minify_url_regexp( '/[a-zA-Z0-9-_]+\.(css|js)' ) .&nbsp;</div></li><li><div>                  '~U';&nbsp;</div></li><li><div>              if ( Cdn_Util::is_engine_mirror( $this-&gt;_config-&gt;get_string( 'cdn.engine' ) ) )&nbsp;</div></li><li><div>                  $processor = array( $this, '_link_replace_callback' );&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $processor = array( $this, '_minify_auto_pushcdn_link_replace_callback' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $regexp = '~([&quot;\'(=])\s*' .&nbsp;</div></li><li><div>                  $this-&gt;minify_url_regexp(&nbsp;</div></li><li><div>                  '/[a-z0-9]+\..+\.include(-(footer|body))?(-nb)?\.[a-f0-9]+\.(css|js)' )&nbsp;</div></li><li><div>                  .'~U';&nbsp;</div></li><li><div>              $processor = array( $this, '_link_replace_callback' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $buffer = preg_replace_callback( $regexp, $processor, $buffer );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $buffer = $this-&gt;replace_placeholders( $buffer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $buffer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Link replace callback</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $matches</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _link_replace_callback( $matches ) {&nbsp;</div></li><li><div>      list( $match, $quote, $url, , , , $path ) = $matches;&nbsp;</div></li><li><div>      $path = ltrim( $path, '/' );&nbsp;</div></li><li><div>      $r = $this-&gt;_link_replace_callback_checks( $match, $quote, $url, $path );&nbsp;</div></li><li><div>      if ( is_null( $r ) ) {&nbsp;</div></li><li><div>          $r = $this-&gt;_link_replace_callback_ask_cdn( $match, $quote, $url, $path );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function _srcset_replace_callback( $matches ) {&nbsp;</div></li><li><div>      list( $match, $srcset ) = $matches;&nbsp;</div></li><li><div>      if ( empty( $this-&gt;_regexps ) )&nbsp;</div></li><li><div>          return $match;&nbsp;</div></li><li><div>      $index = &quot;%srcset-&quot; . count( $this-&gt;_placeholders ) . &quot;%&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $srcset_urls = explode( ', ', $srcset );&nbsp;</div></li><li><div>      $new_srcset_urls = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $srcset_urls as $set ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          preg_match( &quot;~(?P&lt;spaces&gt;^\s*)(?P&lt;url&gt;\S+)(?P&lt;rest&gt;.*)~&quot;, $set, $parts );&nbsp;</div></li><li><div>          if ( isset( $parts['url'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $this-&gt;_regexps as $regexp ) {&nbsp;</div></li><li><div>                  $new_url = preg_replace_callback( $regexp, array(&nbsp;</div></li><li><div>                          $this, &nbsp;</div></li><li><div>                          '_link_replace_callback'&nbsp;</div></li><li><div> ), '&quot;' . $parts['url'] . '&quot;&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( '&quot;' . $parts['url'] . '&quot;&gt;' != $new_url ) {&nbsp;</div></li><li><div>                      $parts['url'] = substr( $new_url, 1, -2 );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $new_srcset_urls[] = $parts['spaces'] .$parts['url']&nbsp;</div></li><li><div>                  . $parts['rest'];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $new_srcset_urls[] = $set;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;_placeholders[$index] = implode( ', ', $new_srcset_urls );&nbsp;</div></li><li><div>      return 'srcset=&quot;' . $index . '&quot;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function replace_placeholders( $buffer ) {&nbsp;</div></li><li><div>      foreach ( $this-&gt;_placeholders as $srcset_id =&gt; $srcset_content ) {&nbsp;</div></li><li><div>          $buffer = str_replace( $srcset_id, $srcset_content, $buffer );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $buffer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets regexp for minified files</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function minify_url_regexp( $filename_mask ) {&nbsp;</div></li><li><div>      $minify_base_url = Util_Environment::filename_to_url(&nbsp;</div></li><li><div>          Util_Environment::cache_blog_minify_dir()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $matches = null;&nbsp;</div></li><li><div>      if ( !preg_match( '~((https?:<span class="comment">//)?([^/]+))(.+)~i', $minify_base_url, $matches ) )</span>&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $protocol_domain_regexp = Util_Environment::get_url_regexp( $matches[1] );&nbsp;</div></li><li><div>      $path_regexp = Util_Environment::preg_quote( $matches[4] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $regexp =&nbsp;</div></li><li><div>          '(' .&nbsp;</div></li><li><div>          '(' . $protocol_domain_regexp . ')?' .&nbsp;</div></li><li><div>          '(' . $path_regexp . $filename_mask . ')' .&nbsp;</div></li><li><div>          ')';&nbsp;</div></li><li><div>      return $regexp;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $domain_url_regexp</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $baseurl</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $upload_info</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $regexps</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function make_uploads_regexes( $domain_url_regexp, $baseurl, &nbsp;</div></li><li><div>      $upload_info, $regexps ) {&nbsp;</div></li><li><div>      if ( preg_match( '~' . $domain_url_regexp . '~i', $baseurl ) ) {&nbsp;</div></li><li><div>          $regexps[] = '~([&quot;\'(=])\s*((' . $domain_url_regexp . ')?('&nbsp;</div></li><li><div>              . Util_Environment::preg_quote( $upload_info['baseurlpath'] )&nbsp;</div></li><li><div>              . '([^&quot;\')&gt;]+)))~i';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $parsed = @parse_url( $baseurl );&nbsp;</div></li><li><div>          $upload_url_domain_regexp = isset( $parsed['host'] )&nbsp;</div></li><li><div>              ? Util_Environment::get_url_regexp( $parsed['scheme'] . ':<span class="comment">//'</span>&nbsp;</div></li><li><div>              . $parsed['host'] ) : $domain_url_regexp;&nbsp;</div></li><li><div>          $baseurlpath = isset( $parsed['path'] ) ? rtrim( $parsed['path'], '/' ) : '';&nbsp;</div></li><li><div>          if ( $baseurlpath )&nbsp;</div></li><li><div>              $regexps[] = '~([&quot;\'])\s*((' . $upload_url_domain_regexp . ')?('&nbsp;</div></li><li><div>                  . Util_Environment::preg_quote( $baseurlpath )&nbsp;</div></li><li><div>                  . '([^&quot;\'&gt;]+)))~i';&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $regexps[] = '~([&quot;\'])\s*((' . $upload_url_domain_regexp&nbsp;</div></li><li><div>                  . ')(([^&quot;\'&gt;]+)))~i';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $regexps;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function fill_regexps() {&nbsp;</div></li><li><div>      $regexps = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_path = Util_Environment::site_url_uri();&nbsp;</div></li><li><div>      $domain_url_regexp = Util_Environment::home_domain_root_url_regexp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_domain_url_regexp = false;&nbsp;</div></li><li><div>      if ( $domain_url_regexp != Util_Environment::get_url_regexp(&nbsp;</div></li><li><div>              Util_Environment::url_to_host( site_url() ) ) )&nbsp;</div></li><li><div>          $site_domain_url_regexp = Util_Environment::get_url_regexp(&nbsp;</div></li><li><div>              Util_Environment::url_to_host( site_url() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.uploads.enable' ) ) {&nbsp;</div></li><li><div>          $upload_info = Util_Http::upload_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $upload_info ) {&nbsp;</div></li><li><div>              $baseurl = $upload_info['baseurl'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( defined( 'DOMAIN_MAPPING' ) && DOMAIN_MAPPING ) {&nbsp;</div></li><li><div>                  $parsed = @parse_url( $upload_info['baseurl'] );&nbsp;</div></li><li><div>                  $baseurl = home_url() . $parsed['path'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $regexps = $this-&gt;make_uploads_regexes(&nbsp;</div></li><li><div>                  $domain_url_regexp, $baseurl, $upload_info, $regexps&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              if ( $site_domain_url_regexp )&nbsp;</div></li><li><div>                  $regexps = $this-&gt;make_uploads_regexes(&nbsp;</div></li><li><div>                      $site_domain_url_regexp, $baseurl, $upload_info, $regexps&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.includes.enable' ) ) {&nbsp;</div></li><li><div>          $mask = $this-&gt;_config-&gt;get_string( 'cdn.includes.files' );&nbsp;</div></li><li><div>          if ( $mask != '' ) {&nbsp;</div></li><li><div>              $regexps[] = '~([&quot;\'(=])\s*((' . $domain_url_regexp .&nbsp;</div></li><li><div>                  ')?(' .&nbsp;</div></li><li><div>                  Util_Environment::preg_quote( $site_path . WPINC ) .&nbsp;</div></li><li><div>                  '/(' . Cdn_Util::get_regexp_by_mask( $mask ) . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>              if ( $site_domain_url_regexp )&nbsp;</div></li><li><div>                  $regexps[] = '~([&quot;\'(=])\s*((' .&nbsp;</div></li><li><div>                      $site_domain_url_regexp . ')?(' .&nbsp;</div></li><li><div>                      Util_Environment::preg_quote( $site_path . WPINC ) .&nbsp;</div></li><li><div>                      '/(' . Cdn_Util::get_regexp_by_mask( $mask ) .&nbsp;</div></li><li><div>                      ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.theme.enable' ) ) {&nbsp;</div></li><li><div>          $theme_dir = preg_replace( '~'&nbsp;</div></li><li><div>              . $domain_url_regexp . '~i', '', get_theme_root_uri() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mask = $this-&gt;_config-&gt;get_string( 'cdn.theme.files' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $mask != '' ) {&nbsp;</div></li><li><div>              $regexps[] = '~([&quot;\'(=])\s*((' . $domain_url_regexp . ')?(' .&nbsp;</div></li><li><div>                  Util_Environment::preg_quote( $theme_dir ) . '/(' .&nbsp;</div></li><li><div>                  Cdn_Util::get_regexp_by_mask( $mask ) . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>              if ( $site_domain_url_regexp ) {&nbsp;</div></li><li><div>                  $theme_dir2 = preg_replace( '~' . $site_domain_url_regexp&nbsp;</div></li><li><div>                      . '~i', '', get_theme_root_uri() );&nbsp;</div></li><li><div>                  $regexps[] = '~([&quot;\'(=])\s*((' .&nbsp;</div></li><li><div>                      $site_domain_url_regexp . ')?(' .&nbsp;</div></li><li><div>                      Util_Environment::preg_quote( $theme_dir ) . '/(' .&nbsp;</div></li><li><div>                      Cdn_Util::get_regexp_by_mask( $mask ) .&nbsp;</div></li><li><div>                      ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>                  $regexps[] = '~([&quot;\'(=])\s*((' .&nbsp;</div></li><li><div>                      $site_domain_url_regexp . ')?(' .&nbsp;</div></li><li><div>                      Util_Environment::preg_quote( $theme_dir2 ) .&nbsp;</div></li><li><div>                      '/(' . Cdn_Util::get_regexp_by_mask( $mask ) .&nbsp;</div></li><li><div>                      ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'cdn.custom.enable' ) ) {&nbsp;</div></li><li><div>          $masks = $this-&gt;_config-&gt;get_array( 'cdn.custom.files' );&nbsp;</div></li><li><div>          $masks = array_map( array( '\W3TC\Cdn_Util', 'replace_folder_placeholders_to_uri' ), $masks );&nbsp;</div></li><li><div>          $masks = array_map( array( '\W3TC\Util_Environment', 'parse_path' ), $masks );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( count( $masks ) ) {&nbsp;</div></li><li><div>              $custom_regexps_urls = array();&nbsp;</div></li><li><div>              $custom_regexps_uris = array();&nbsp;</div></li><li><div>              $custom_regexps_docroot_related = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $masks as $mask ) {&nbsp;</div></li><li><div>                  if ( !empty( $mask ) ) {&nbsp;</div></li><li><div>                      if ( Util_Environment::is_url( $mask ) ) {&nbsp;</div></li><li><div>                          $url_match = array();&nbsp;</div></li><li><div>                          if ( preg_match( '~^((https?:)?<span class="comment">//([^/]*))(.*)~', $mask, $url_match ) ) {</span>&nbsp;</div></li><li><div>                              $custom_regexps_urls[] = array(&nbsp;</div></li><li><div>                                  'domain_url' =&gt; Util_Environment::get_url_regexp(&nbsp;</div></li><li><div>                                      $url_match[1] ), &nbsp;</div></li><li><div>                                  'uri' =&gt; Cdn_Util::get_regexp_by_mask( $url_match[4] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } elseif ( substr( $mask, 0, 1 ) == '/' ) {   <span class="comment">// uri</span>&nbsp;</div></li><li><div>                          $custom_regexps_uris[] = Cdn_Util::get_regexp_by_mask( $mask );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $file = Util_Environment::normalize_path( $mask );   <span class="comment">// \ -&gt; backspaces</span>&nbsp;</div></li><li><div>                          $file = str_replace( Util_Environment::site_root(), '', $file );&nbsp;</div></li><li><div>                          $file = ltrim( $file, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $custom_regexps_docroot_related[] = Cdn_Util::get_regexp_by_mask( $mask );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( count( $custom_regexps_urls ) &gt; 0 ) {&nbsp;</div></li><li><div>                  foreach ( $custom_regexps_urls as $regexp ) {&nbsp;</div></li><li><div>                      $regexps[] = '~([&quot;\'(=])\s*((' . $regexp['domain_url'] .&nbsp;</div></li><li><div>                      ')?((' . $regexp['uri'] . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( count( $custom_regexps_uris ) &gt; 0 ) {&nbsp;</div></li><li><div>                  $regexps[] = '~([&quot;\'(=])\s*((' . $domain_url_regexp .&nbsp;</div></li><li><div>                      ')?((' . implode( '|', $custom_regexps_uris ) . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( count( $custom_regexps_docroot_related ) &gt; 0 ) {&nbsp;</div></li><li><div>                  $regexps[] = '~([&quot;\'(=])\s*((' . $domain_url_regexp .&nbsp;</div></li><li><div>                      ')?(' . Util_Environment::preg_quote( $site_path ) .&nbsp;</div></li><li><div>                      '(' . implode( '|', $custom_regexps_docroot_related ) . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>                  if ( $site_domain_url_regexp )&nbsp;</div></li><li><div>                      $regexps[] = '~([&quot;\'(=])\s*((' .&nbsp;</div></li><li><div>                          $site_domain_url_regexp . ')?(' .&nbsp;</div></li><li><div>                          Util_Environment::preg_quote( $site_path ) . '(' .&nbsp;</div></li><li><div>                          implode( '|', $custom_regexps_docroot_related ) . ')([^&quot;\'() &gt;]*)))~i';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;_regexps = $regexps;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Link replace callback, basic checks step</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $match</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $quote</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return null|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _link_replace_callback_checks( $match, $quote, $url, $path ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      static $queue = null, $reject_files = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if URL was already replaced</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;replaced_urls[$url] ) ) {&nbsp;</div></li><li><div>          return $quote . $this-&gt;replaced_urls[$url];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check URL for rejected files</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $reject_files === null ) {&nbsp;</div></li><li><div>          $reject_files = $this-&gt;_config-&gt;get_array( 'cdn.reject.files' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $reject_files as $reject_file ) {&nbsp;</div></li><li><div>          if ( $reject_file != '' ) {&nbsp;</div></li><li><div>              $reject_file = Cdn_Util::replace_folder_placeholders( $reject_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $reject_file = Util_Environment::normalize_file( $reject_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $reject_file_regexp = '~^('&nbsp;</div></li><li><div>                  . Cdn_Util::get_regexp_by_mask( $reject_file ) . ')~i';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( preg_match( $reject_file_regexp, $path ) ) {&nbsp;</div></li><li><div>                  return $match;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Don't replace URL for files that are in the CDN queue</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $queue === null ) {&nbsp;</div></li><li><div>          if ( !Cdn_Util::is_engine_mirror( $this-&gt;_config-&gt;get_string( 'cdn.engine' ) ) ) {&nbsp;</div></li><li><div>              $sql = $wpdb-&gt;prepare( 'SELECT remote_path FROM '&nbsp;</div></li><li><div>                  . $wpdb-&gt;base_prefix . W3TC_CDN_TABLE_QUEUE&nbsp;</div></li><li><div>                  . ' WHERE remote_path = %s', $path );&nbsp;</div></li><li><div>              $queue = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $queue = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $queue ) {&nbsp;</div></li><li><div>          return $match;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Link replace callback, url replacement using cdn engine</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $match</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $quote</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return null|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _link_replace_callback_ask_cdn( $match, $quote, $url, $path ) {&nbsp;</div></li><li><div>      $common = Dispatcher::component( 'Cdn_Core' );&nbsp;</div></li><li><div>      $cdn = $common-&gt;get_cdn();&nbsp;</div></li><li><div>      $remote_path = $common-&gt;uri_to_cdn_uri( $path );&nbsp;</div></li><li><div>      $new_url = $cdn-&gt;format_url( $remote_path );&nbsp;</div></li><li><div>      if ( $new_url ) {&nbsp;</div></li><li><div>          $is_engine_mirror = Cdn_Util::is_engine_mirror(&nbsp;</div></li><li><div>              $this-&gt;_config-&gt;get_string( 'cdn.engine' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $new_url = apply_filters( 'w3tc_cdn_url', $new_url, $url, &nbsp;</div></li><li><div>              $is_engine_mirror );&nbsp;</div></li><li><div>          $this-&gt;replaced_urls[$url] = $new_url;&nbsp;</div></li><li><div>          return $quote . $new_url;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $match;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Link replace callback for urls from minify module using auto mode and in cdn of push type</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $matches</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _minify_auto_pushcdn_link_replace_callback( $matches ) {&nbsp;</div></li><li><div>      static $dispatcher = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $match, $quote, $url, , , , $path ) = $matches;&nbsp;</div></li><li><div>      $path = ltrim( $path, '/' );&nbsp;</div></li><li><div>      $r = $this-&gt;_link_replace_callback_checks( $match, $quote, $url, $path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if we can replace that URL (for auto mode it should be uploaded)</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( !Dispatcher::is_url_cdn_uploaded( $url ) ) {&nbsp;</div></li><li><div>          Dispatcher::component( 'Cdn_Core' )-&gt;queue_upload_url( $url );&nbsp;</div></li><li><div>          if ( !self::$_upload_scheduled ) {&nbsp;</div></li><li><div>              wp_schedule_single_event( time(), 'w3_cdn_cron_queue_process' );&nbsp;</div></li><li><div>              add_action( 'shutdown', 'wp_cron' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              self::$_upload_scheduled = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $match;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $r ) ) {&nbsp;</div></li><li><div>          $r = $this-&gt;_link_replace_callback_ask_cdn( $match, $quote, $url, $path );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $r;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_replaced_urls() {&nbsp;</div></li><li><div>      $strings = array();&nbsp;</div></li><li><div>      if ( count( $this-&gt;_replaced_urls ) ) {&nbsp;</div></li><li><div>          $strings[] = &quot;Replaced URLs:&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;_replaced_urls as $old_url =&gt; $new_url ) {&nbsp;</div></li><li><div>              $strings[] = sprintf( &quot;%s =&gt; %s&quot;, &nbsp;</div></li><li><div>                  Util_Content::escape_comment( $old_url ), &nbsp;</div></li><li><div>                  Util_Content::escape_comment( $new_url ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $strings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>W3 Total Cache</li><li><span></span>0.9.5.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>