<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="0.9.5.4" data-slug="w3-total-cache" data-type="file" data-id="94840"><head xmlns="http://www.w3.org/1999/xhtml"><title> minify-plugin | file | W3 Total Cache | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, w3-total-cache, 0.9.5.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=06a1adb0ba5c7670be01fc15a19c6765' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/minify-plugin/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fminify-plugin%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fminify-plugin%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-w3-total-cache-0.9.5.4-file-minify-plugin","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="minify-plugin" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to w3-total-cache." href="http://hookr.io/plugins/w3-total-cache/" class="plugin"><span property="name">w3-total-cache</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 0.9.5.4." href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/" class="H_VERSION"><span property="name">0.9.5.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">minify-plugin</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1105"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/all/" title="All">All <span class="count badge">1105</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="159"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/hooks/" title="Hooks">Hooks <span class="count badge">159</span></a></li><li class="" data-id="action" data-count="69"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/actions/" title="Actions">Actions <span class="count badge">69</span></a></li><li class="" data-id="filter" data-count="90"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/filters/" title="Filters">Filters <span class="count badge">90</span></a></li><li class="" data-id="class" data-count="635"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/classes/" title="Classes">Classes <span class="count badge">635</span></a></li><li class="" data-id="constant" data-count="229"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/constants/" title="Constants">Constants <span class="count badge">229</span></a></li><li class="" data-id="function" data-count="82"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/functions/" title="Functions">Functions <span class="count badge">82</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/w3-total-cache/0.9.5.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/Minify_Plugin.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>namespace W3TC;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * class Minify_Plugin</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Minify_Plugin {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Minify reject reason</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $minify_reject_reason = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array of replaced styles</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $replaced_styles = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array of replaced scripts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $replaced_scripts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Helper object to use</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var _W3_MinifyHelpers</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $minify_helpers;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Config</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $_config = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;_config = Dispatcher::config();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Runs plugin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function run() {&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'init' ) );&nbsp;</div></li><li><div>      add_filter( 'cron_schedules', array( $this, 'cron_schedules' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'w3tc_admin_bar_menu', &nbsp;</div></li><li><div>          array( $this, 'w3tc_admin_bar_menu' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$this-&gt;_config-&gt;get_boolean( 'minify.debug' ) )&nbsp;</div></li><li><div>          add_filter( 'w3tc_footer_comment', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'w3tc_footer_comment'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_string( 'minify.engine' ) == 'file' ) {&nbsp;</div></li><li><div>          add_action( 'w3_minify_cleanup', array(&nbsp;</div></li><li><div>                  $this, &nbsp;</div></li><li><div>                  'cleanup'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// usage statistics handling</span>&nbsp;</div></li><li><div>      add_action( 'w3tc_usage_statistics_of_request', array(&nbsp;</div></li><li><div>              $this, 'w3tc_usage_statistics_of_request' ), 10, 1 );&nbsp;</div></li><li><div>      add_filter( 'w3tc_usage_statistics_metrics', array(&nbsp;</div></li><li><div>              $this, 'w3tc_usage_statistics_metrics' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Start minify</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;can_minify() ) {&nbsp;</div></li><li><div>          Util_Bus::add_ob_callback( 'minify', array( $this, 'ob_callback' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function init() {&nbsp;</div></li><li><div>      $url = Util_Environment::filename_to_url( W3TC_CACHE_MINIFY_DIR );&nbsp;</div></li><li><div>      $parsed = parse_url( $url );&nbsp;</div></li><li><div>      $prefix = '/' . trim( $parsed['path'], '/' ) . '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( substr( $_SERVER['REQUEST_URI'], 0, strlen( $prefix ) ) == $prefix ) {&nbsp;</div></li><li><div>          $w3_minify = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>          $w3_minify-&gt;process( substr( $_SERVER['REQUEST_URI'], strlen( $prefix ) ) );&nbsp;</div></li><li><div>          exit();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $_REQUEST['w3tc_minify'] ) ) {&nbsp;</div></li><li><div>          $w3_minify = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>          $w3_minify-&gt;process( $_REQUEST['w3tc_minify'] );&nbsp;</div></li><li><div>          exit();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Does disk cache cleanup</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cleanup() {&nbsp;</div></li><li><div>      $a = Dispatcher::component( 'Minify_Plugin_Admin' );&nbsp;</div></li><li><div>      $a-&gt;cleanup();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cron schedules filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $schedules</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cron_schedules( $schedules ) {&nbsp;</div></li><li><div>      $gc = $this-&gt;_config-&gt;get_integer( 'minify.file.gc' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_merge( $schedules, array(&nbsp;</div></li><li><div>              'w3_minify_cleanup' =&gt; array(&nbsp;</div></li><li><div>                  'interval' =&gt; $gc, &nbsp;</div></li><li><div>                  'display' =&gt; sprintf( '[W3TC] Minify file GC (every %d seconds)', $gc )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * OB callback</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $buffer</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function ob_callback( $buffer ) {&nbsp;</div></li><li><div>      $enable = Util_Content::is_html( $buffer ) &&&nbsp;</div></li><li><div>          $this-&gt;can_minify2( $buffer );&nbsp;</div></li><li><div>      $enable = apply_filters( 'w3tc_minify_enable', $enable );&nbsp;</div></li><li><div>      if ( !$enable )&nbsp;</div></li><li><div>          return $buffer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;minify_helpers = new _W3_MinifyHelpers( $this-&gt;_config );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Replace script and style tags</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $js_enable = $this-&gt;_config-&gt;get_boolean( 'minify.js.enable' );&nbsp;</div></li><li><div>      $css_enable = $this-&gt;_config-&gt;get_boolean( 'minify.css.enable' );&nbsp;</div></li><li><div>      $html_enable = $this-&gt;_config-&gt;get_boolean( 'minify.html.enable' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'is_feed' ) && is_feed() ) {&nbsp;</div></li><li><div>          $js_enable = false;&nbsp;</div></li><li><div>          $css_enable = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $js_enable = apply_filters( 'w3tc_minify_js_enable', $js_enable );&nbsp;</div></li><li><div>      $css_enable = apply_filters( 'w3tc_minify_css_enable', $css_enable );&nbsp;</div></li><li><div>      $html_enable = apply_filters( 'w3tc_minify_html_enable', $html_enable );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $head_prepend = '';&nbsp;</div></li><li><div>      $body_prepend = '';&nbsp;</div></li><li><div>      $body_append = '';&nbsp;</div></li><li><div>      $embed_extsrcjs = false;&nbsp;</div></li><li><div>      $buffer = apply_filters( 'w3tc_minify_before', $buffer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.auto' ) ) {&nbsp;</div></li><li><div>          if ( $js_enable ) {&nbsp;</div></li><li><div>              $minifier = new _W3_MinifyJsAuto( $this-&gt;_config, &nbsp;</div></li><li><div>                  $buffer, $this-&gt;minify_helpers );&nbsp;</div></li><li><div>              $buffer = $minifier-&gt;execute();&nbsp;</div></li><li><div>              $this-&gt;replaced_scripts =&nbsp;</div></li><li><div>                  $minifier-&gt;get_debug_minified_urls();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $css_enable ) {&nbsp;</div></li><li><div>              $embed_to_html = $this-&gt;_config-&gt;get_boolean( 'minify.css.embed' );&nbsp;</div></li><li><div>              $ignore_css_files = $this-&gt;_config-&gt;get_array( 'minify.reject.files.css' );&nbsp;</div></li><li><div>              $files_to_minify = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $embed_pos = strpos( $buffer, '&lt;!-- W3TC-include-css --&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $buffer = str_replace( '&lt;!-- W3TC-include-css --&gt;', '', $buffer );&nbsp;</div></li><li><div>              if ( $embed_pos === false ) {&nbsp;</div></li><li><div>                  if ( preg_match( '~&lt;head(\s+[^&gt;]*)*&gt;~Ui', $buffer, $match, PREG_OFFSET_CAPTURE ) )&nbsp;</div></li><li><div>                      $embed_pos = strlen( $match[0][0] ) + $match[0][1];&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $embed_pos = 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ignore_css_files = array_map( array( '\W3TC\Util_Environment', 'normalize_file' ), $ignore_css_files );&nbsp;</div></li><li><div>              $handled_styles = array();&nbsp;</div></li><li><div>              $style_tags = Minify_Extract::extract_css( $buffer );&nbsp;</div></li><li><div>              $previous_file_was_ignored = false;&nbsp;</div></li><li><div>              foreach ( $style_tags as $style_tag_tuple ) {&nbsp;</div></li><li><div>                  $style_tag = $style_tag_tuple[0];&nbsp;</div></li><li><div>                  $style_len = strlen( $style_tag );&nbsp;</div></li><li><div>                  $tag_pos = strpos( $buffer, $style_tag );&nbsp;</div></li><li><div>                  $match = array();&nbsp;</div></li><li><div>                  $url = $style_tag_tuple[1];&nbsp;</div></li><li><div>                  if ( $this-&gt;_config-&gt;get_boolean( 'minify.debug' ) ) {&nbsp;</div></li><li><div>                      Minify_Core::log( 'adding ' . $url );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $url = Util_Environment::url_relative_to_full( $url );&nbsp;</div></li><li><div>                  $file = Util_Environment::url_to_docroot_filename( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $include_type = $this-&gt;minify_helpers-&gt;is_file_for_minification( $url, $file );&nbsp;</div></li><li><div>                  if ( $include_type == 'url' )&nbsp;</div></li><li><div>                      $file = $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $do_tag_minification = !empty( $include_type ) &&&nbsp;</div></li><li><div>                      !in_array( $file, $handled_styles );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $do_tag_minification = apply_filters( 'w3tc_minify_css_do_tag_minification', &nbsp;</div></li><li><div>                      $do_tag_minification, $style_tag, $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( !$do_tag_minification )&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $handled_styles[] = $file;&nbsp;</div></li><li><div>                  $this-&gt;replaced_styles[] = $file;&nbsp;</div></li><li><div>                  if ( in_array( $file, $ignore_css_files ) ) {&nbsp;</div></li><li><div>                      if ( $tag_pos &gt; $embed_pos ) {&nbsp;</div></li><li><div>                          if ( $files_to_minify ) {&nbsp;</div></li><li><div>                              $data = array(&nbsp;</div></li><li><div>                                  'files_to_minify' =&gt; $files_to_minify, &nbsp;</div></li><li><div>                                  'embed_pos' =&gt; $embed_pos, &nbsp;</div></li><li><div>                                  'embed_to_html' =&gt; $embed_to_html&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $data = apply_filters(&nbsp;</div></li><li><div>                                  'w3tc_minify_css_step', &nbsp;</div></li><li><div>                                  $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $style = $this-&gt;get_style_custom(&nbsp;</div></li><li><div>                                  $data['files_to_minify'], &nbsp;</div></li><li><div>                                  $data['embed_to_html'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if ( $this-&gt;_config-&gt;get_boolean( 'minify.css.http2push' ) ) {&nbsp;</div></li><li><div>                                  $this-&gt;minify_helpers-&gt;http2_header_add( $style['url'], &nbsp;</div></li><li><div>                                      'style' );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $buffer = substr_replace( $buffer, $style['body'], $embed_pos, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $files_to_minify = array();&nbsp;</div></li><li><div>                              $style_len = $style_len + strlen( $style['body'] );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $embed_pos = $embed_pos + $style_len;&nbsp;</div></li><li><div>                          $previous_file_was_ignored = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $buffer = substr_replace( $buffer, '', $tag_pos, $style_len );&nbsp;</div></li><li><div>                      if ( $embed_pos &gt; $tag_pos )&nbsp;</div></li><li><div>                          $embed_pos -= $style_len;&nbsp;</div></li><li><div>                      elseif ( $previous_file_was_ignored )&nbsp;</div></li><li><div>                          $embed_pos = $tag_pos;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $files_to_minify[] = $file;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $data = array(&nbsp;</div></li><li><div>                  'files_to_minify' =&gt; $files_to_minify, &nbsp;</div></li><li><div>                  'embed_pos' =&gt; $embed_pos, &nbsp;</div></li><li><div>                  'embed_to_html' =&gt; $embed_to_html&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $data = apply_filters( 'w3tc_minify_css_step', &nbsp;</div></li><li><div>                  $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $style = $this-&gt;get_style_custom(&nbsp;</div></li><li><div>                  $data['files_to_minify'], &nbsp;</div></li><li><div>                  $data['embed_to_html'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;_config-&gt;get_boolean( 'minify.css.http2push' ) ) {&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;http2_header_add( $style['url'], &nbsp;</div></li><li><div>                      'style' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $buffer = substr_replace( $buffer, $style['body'], &nbsp;</div></li><li><div>                  $data['embed_pos'], 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $buffer = apply_filters( 'w3tc_minify_processed', $buffer );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $css_enable ) {&nbsp;</div></li><li><div>              $style = $this-&gt;get_style_group( 'include' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $style['body'] ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;_custom_location_does_not_exist( '/&lt;!-- W3TC-include-css --&gt;/', $buffer, $style['body'] ) )&nbsp;</div></li><li><div>                      $head_prepend .= $style['body'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;remove_styles_group( $buffer, 'include' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;_config-&gt;get_boolean( 'minify.css.http2push' ) ) {&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;http2_header_add( $style['url'], &nbsp;</div></li><li><div>                      'style' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $js_enable ) {&nbsp;</div></li><li><div>              $embed_type = $this-&gt;_config-&gt;get_string( 'minify.js.header.embed_type' );&nbsp;</div></li><li><div>              $http2push = $this-&gt;_config-&gt;get_boolean( 'minify.js.http2push' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $script = $this-&gt;get_script_group( 'include', $embed_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $script['body'] ) {&nbsp;</div></li><li><div>                  $embed_extsrcjs = $embed_type == 'extsrc' || $embed_type == 'asyncsrc'?true:$embed_extsrcjs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;_custom_location_does_not_exist( '/&lt;!-- W3TC-include-js-head --&gt;/', $buffer, $script['body'] ) )&nbsp;</div></li><li><div>                      $head_prepend .= $script['body'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;remove_scripts_group( $buffer, 'include' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $http2push ) {&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;http2_header_add( $script['url'], &nbsp;</div></li><li><div>                      'script' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $embed_type = $this-&gt;_config-&gt;get_string( 'minify.js.body.embed_type' );&nbsp;</div></li><li><div>              $script = $this-&gt;get_script_group( 'include-body', $embed_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $script['body'] ) {&nbsp;</div></li><li><div>                  $embed_extsrcjs = $embed_type == 'extsrc' || $embed_type == 'asyncsrc'?true:$embed_extsrcjs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;_custom_location_does_not_exist( '/&lt;!-- W3TC-include-js-body-start --&gt;/', $buffer, $script['body'] ) )&nbsp;</div></li><li><div>                      $body_prepend .= $script['body'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;remove_scripts_group( $buffer, 'include-body' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $http2push ) {&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;http2_header_add( $script['url'], &nbsp;</div></li><li><div>                      'script' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $embed_type = $this-&gt;_config-&gt;get_string( 'minify.js.footer.embed_type' );&nbsp;</div></li><li><div>              $script = $this-&gt;get_script_group( 'include-footer', $embed_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $script['body'] ) {&nbsp;</div></li><li><div>                  $embed_extsrcjs = $embed_type == 'extsrc' || $embed_type == 'asyncsrc'?true:$embed_extsrcjs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;_custom_location_does_not_exist( '/&lt;!-- W3TC-include-js-body-end --&gt;/', $buffer, $script['body'] ) )&nbsp;</div></li><li><div>                      $body_append .= $script['body'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;remove_scripts_group( $buffer, 'include-footer' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $http2push ) {&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;http2_header_add( $script['url'], &nbsp;</div></li><li><div>                      'script' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $head_prepend != '' ) {&nbsp;</div></li><li><div>          $buffer = preg_replace( '~&lt;head(\s+[^&gt;]*)*&gt;~Ui', &nbsp;</div></li><li><div>              '\\0' . $head_prepend, $buffer, 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $body_prepend != '' ) {&nbsp;</div></li><li><div>          $buffer = preg_replace( '~&lt;body(\s+[^&gt;]*)*&gt;~Ui', &nbsp;</div></li><li><div>              '\\0' . $body_prepend, $buffer, 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $body_append != '' ) {&nbsp;</div></li><li><div>          $buffer = preg_replace( '~&lt;\\/body&gt;~', &nbsp;</div></li><li><div>              $body_append . '\\0', $buffer, 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $embed_extsrcjs ) {&nbsp;</div></li><li><div>          $script = &quot;&nbsp;</div></li><li><div>&lt;script type=\&quot;text/javascript\&quot;&gt;&nbsp;</div></li><li><div>&quot; .&quot;var extsrc=null;&nbsp;</div></li><li><div>&quot;.'(function() {function j() {if(b&&g) {document.write=k;document.writeln=l;var f=document.createElement(&quot;span&quot;);f.innerHTML=b;g.appendChild(f);b=&quot;&quot;}}function d() {j();for(var f=document.getElementsByTagName(&quot;script&quot;), c=0;c&lt;f.length;c++) {var e=f[c], h=e.getAttribute(&quot;asyncsrc&quot;);if(h) {e.setAttribute(&quot;asyncsrc&quot;, &quot;&quot;);var a=document.createElement(&quot;script&quot;);a.async=!0;a.src=h;document.getElementsByTagName(&quot;head&quot;)[0].appendChild(a)}if(h=e.getAttribute(&quot;extsrc&quot;)) {e.setAttribute(&quot;extsrc&quot;, &quot;&quot;);g=document.createElement(&quot;span&quot;);e.parentNode.insertBefore(g, e);document.write=function(a) {b+=a};document.writeln=function(a) {b+=a;b+=&quot;\n&quot;};a=document.createElement(&quot;script&quot;);a.async=!0;a.src=h;/msie/i.test(navigator.userAgent)&&!/opera/i.test(navigator.userAgent)?a.onreadystatechange=function() {(&quot;loaded&quot;==this.readyState||&quot;complete&quot;==this.readyState)&&d()}:-1!=navigator.userAgent.indexOf(&quot;Firefox&quot;)||&quot;onerror&quot;in a?(a.onload=d, a.onerror=d):(a.onload=d, a.onreadystatechange=d);document.getElementsByTagName(&quot;head&quot;)[0].appendChild(a);return}}j();document.write=k;document.writeln=l;for(c=0;c&lt;extsrc.complete.funcs.length;c++)extsrc.complete.funcs[c]()}function i() {arguments.callee.done||(arguments.callee.done=!0, d())}extsrc={complete:function(b) {this.complete.funcs.push(b)}};extsrc.complete.funcs=[];var k=document.write, l=document.writeln, b=&quot;&quot;, g=&quot;&quot;;document.addEventListener&&document.addEventListener(&quot;DOMContentLoaded&quot;, i, !1);if(/WebKit/i.test(navigator.userAgent))var m=setInterval(function() {/loaded|complete/.test(document.readyState)&&(clearInterval(m), i())}, 10);window.onload=i})();' . &quot;&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $buffer = preg_replace( '~&lt;head(\s+[^&gt;]*)*&gt;~Ui', &nbsp;</div></li><li><div>              '\\0' . $script, $buffer, 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Minify HTML/Feed</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $html_enable ) {&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $buffer = $this-&gt;minify_html( $buffer );&nbsp;</div></li><li><div>          } catch ( \Exception $exception ) {&nbsp;</div></li><li><div>              $this-&gt;error = $exception-&gt;getMessage();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $buffer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function w3tc_admin_bar_menu( $menu_items ) {&nbsp;</div></li><li><div>      $menu_items['20210.minify'] = array(&nbsp;</div></li><li><div>          'id' =&gt; 'w3tc_flush_minify', &nbsp;</div></li><li><div>          'parent' =&gt; 'w3tc_flush', &nbsp;</div></li><li><div>          'title' =&gt; __( 'Minify', 'w3-total-cache' ), &nbsp;</div></li><li><div>          'href' =&gt; wp_nonce_url( network_admin_url(&nbsp;</div></li><li><div>                  'admin.php?page=w3tc_dashboard&amp;w3tc_flush_minify' ), &nbsp;</div></li><li><div>              'w3tc' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $menu_items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function w3tc_footer_comment( $strings ) {&nbsp;</div></li><li><div>      $strings[] = sprintf(&nbsp;</div></li><li><div>          __( 'Minified using %s%s', 'w3-total-cache' ), &nbsp;</div></li><li><div>          Cache::engine_name( $this-&gt;_config-&gt;get_string( 'minify.engine' ) ), &nbsp;</div></li><li><div>          ( $this-&gt;minify_reject_reason != ''&nbsp;</div></li><li><div>              ? sprintf( ' (%s)', $this-&gt;minify_reject_reason )&nbsp;</div></li><li><div>              : '' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.debug' ) ) {&nbsp;</div></li><li><div>          $strings[] = &quot;Minify debug info:&quot;;&nbsp;</div></li><li><div>          $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Engine: ', 20 ), Cache::engine_name( $this-&gt;_config-&gt;get_string( 'minify.engine' ) ) );&nbsp;</div></li><li><div>          $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Theme: ', 20 ), $this-&gt;get_theme() );&nbsp;</div></li><li><div>          $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Template: ', 20 ), $this-&gt;get_template() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;minify_reject_reason ) {&nbsp;</div></li><li><div>              $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Reject reason: ', 20 ), $this-&gt;minify_reject_reason );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;error ) {&nbsp;</div></li><li><div>              $strings[] = sprintf( &quot;%s%s&quot;, str_pad( 'Errors: ', 20 ), $this-&gt;error );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( count( $this-&gt;replaced_styles ) ) {&nbsp;</div></li><li><div>              $strings[] = &quot;Replaced CSS files:&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $this-&gt;replaced_styles as $index =&gt; $file ) {&nbsp;</div></li><li><div>                  $strings[] = sprintf( &quot;%d. %s&quot;, $index + 1, Util_Content::escape_comment( $file ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( count( $this-&gt;replaced_scripts ) ) {&nbsp;</div></li><li><div>              $strings[] = &quot;Replaced JavaScript files:&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $this-&gt;replaced_scripts as $index =&gt; $file ) {&nbsp;</div></li><li><div>                  $strings[] = sprintf( &quot;%d. %s\r\n&quot;, $index + 1, Util_Content::escape_comment( $file ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $strings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks to see if pattern exists in source if so replaces it with the provided script</span>&nbsp;</div></li><li><div><span class="comment">   * and returns false. If pattern does not exists returns true.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $pattern</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $source</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $script</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _custom_location_does_not_exist( $pattern, &$source, $script ) {&nbsp;</div></li><li><div>      $count = 0;&nbsp;</div></li><li><div>      $source = preg_replace( $pattern, $script, $source, 1, $count );&nbsp;</div></li><li><div>      return $count==0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes style tags from the source</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $content</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $files</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function remove_styles( &$content, $files ) {&nbsp;</div></li><li><div>      $regexps = array();&nbsp;</div></li><li><div>      $home_url_regexp = Util_Environment::home_url_regexp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = '';&nbsp;</div></li><li><div>      if ( Util_Environment::is_wpmu() && !Util_Environment::is_wpmu_subdomain() )&nbsp;</div></li><li><div>          $path = ltrim( Util_Environment::home_url_uri(), '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $files as $file ) {&nbsp;</div></li><li><div>          if ( $path && strpos( $file, $path ) === 0 )&nbsp;</div></li><li><div>              $file = substr( $file, strlen( $path ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;replaced_styles[] = $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( Util_Environment::is_url( $file ) && !preg_match( '~' . $home_url_regexp . '~i', $file ) ) {&nbsp;</div></li><li><div>              <span class="comment">// external CSS files</span>&nbsp;</div></li><li><div>              $regexps[] = Util_Environment::preg_quote( $file );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// local CSS files</span>&nbsp;</div></li><li><div>              $file = ltrim( $file, '/' );&nbsp;</div></li><li><div>              if ( home_url() == site_url() && ltrim( Util_Environment::site_url_uri(), '/' ) && strpos( $file, ltrim( Util_Environment::site_url_uri(), '/' ) ) === 0 )&nbsp;</div></li><li><div>                  $file = str_replace( ltrim( Util_Environment::site_url_uri(), '/' ), '', $file );&nbsp;</div></li><li><div>              $file = ltrim( preg_replace( '~' . $home_url_regexp . '~i', '', $file ), '/\\' );&nbsp;</div></li><li><div>              $regexps[] = '(' . $home_url_regexp . ')?/?' . Util_Environment::preg_quote( $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $regexps as $regexp ) {&nbsp;</div></li><li><div>          $content = preg_replace( '~&lt;link\s+[^&lt;&gt;]*href=[&quot;\']?' . $regexp . '[&quot;\']?[^&lt;&gt;]*/?&gt;(.*&lt;/link&gt;)?~Uis', '', $content );&nbsp;</div></li><li><div>          $content = preg_replace( '~@import\s+(url\s*)?\(?[&quot;\']?\s*' . $regexp . '\s*[&quot;\']?\)?[^;]*;?~is', '', $content );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = preg_replace( '~&lt;style[^&lt;&gt;]*&gt;\s*&lt;/style&gt;~', '', $content );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove script tags from the source</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $content</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $files</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function remove_scripts( &$content, $files ) {&nbsp;</div></li><li><div>      $regexps = array();&nbsp;</div></li><li><div>      $home_url_regexp = Util_Environment::home_url_regexp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = '';&nbsp;</div></li><li><div>      if ( Util_Environment::is_wpmu() && !Util_Environment::is_wpmu_subdomain() )&nbsp;</div></li><li><div>          $path = ltrim( Util_Environment::home_url_uri(), '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $files as $file ) {&nbsp;</div></li><li><div>          if ( $path && strpos( $file, $path ) === 0 )&nbsp;</div></li><li><div>              $file = substr( $file, strlen( $path ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;replaced_scripts[] = $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( Util_Environment::is_url( $file ) && !preg_match( '~' . $home_url_regexp . '~i', $file ) ) {&nbsp;</div></li><li><div>              <span class="comment">// external JS files</span>&nbsp;</div></li><li><div>              $regexps[] = Util_Environment::preg_quote( $file );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// local JS files</span>&nbsp;</div></li><li><div>              $file = ltrim( $file, '/' );&nbsp;</div></li><li><div>              if ( home_url() == site_url() && ltrim( Util_Environment::site_url_uri(), '/' ) && strpos( $file, ltrim( Util_Environment::site_url_uri(), '/' ) ) === 0 )&nbsp;</div></li><li><div>                  $file = str_replace( ltrim( Util_Environment::site_url_uri(), '/' ), '', $file );&nbsp;</div></li><li><div>              $file = ltrim( preg_replace( '~' . $home_url_regexp . '~i', '', $file ), '/\\' );&nbsp;</div></li><li><div>              $regexps[] = '(' . $home_url_regexp . ')?/?' . Util_Environment::preg_quote( $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $regexps as $regexp ) {&nbsp;</div></li><li><div>          $content = preg_replace( '~&lt;script\s+[^&lt;&gt;]*src=[&quot;\']?' . $regexp . '[&quot;\']?[^&lt;&gt;]*&gt;\s*&lt;/script&gt;~Uis', '', $content );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes style tag from the source for group</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $content</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $location</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function remove_styles_group( &$content, $location ) {&nbsp;</div></li><li><div>      $theme = $this-&gt;get_theme();&nbsp;</div></li><li><div>      $template = $this-&gt;get_template();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>      $groups = $this-&gt;_config-&gt;get_array( 'minify.css.groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $groups[$theme]['default'][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $files = (array) $groups[$theme]['default'][$location]['files'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $template != 'default' && isset( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, (array) $groups[$theme][$template][$location]['files'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;remove_styles( $content, $files );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes script tags from the source for group</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $content</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $location</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function remove_scripts_group( &$content, $location ) {&nbsp;</div></li><li><div>      $theme = $this-&gt;get_theme();&nbsp;</div></li><li><div>      $template = $this-&gt;get_template();&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>      $groups = $this-&gt;_config-&gt;get_array( 'minify.js.groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $groups[$theme]['default'][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $files = (array) $groups[$theme]['default'][$location]['files'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $template != 'default' && isset( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $files = array_merge( $files, (array) $groups[$theme][$template][$location]['files'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;remove_scripts( $content, $files );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Minifies HTML</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $html</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function minify_html( $html ) {&nbsp;</div></li><li><div>      $w3_minifier = Dispatcher::component( 'Minify_ContentMinifier' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ignored_comments = $this-&gt;_config-&gt;get_array( 'minify.html.comments.ignore' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $ignored_comments ) ) {&nbsp;</div></li><li><div>          $ignored_comments_preserver = new \Minify_IgnoredCommentPreserver();&nbsp;</div></li><li><div>          $ignored_comments_preserver-&gt;setIgnoredComments( $ignored_comments );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $html = $ignored_comments_preserver-&gt;search( $html );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.html.inline.js' ) ) {&nbsp;</div></li><li><div>          $js_engine = $this-&gt;_config-&gt;get_string( 'minify.js.engine' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$w3_minifier-&gt;exists( $js_engine ) || !$w3_minifier-&gt;available( $js_engine ) ) {&nbsp;</div></li><li><div>              $js_engine = 'js';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $js_minifier = $w3_minifier-&gt;get_minifier( $js_engine );&nbsp;</div></li><li><div>          $js_options = $w3_minifier-&gt;get_options( $js_engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $w3_minifier-&gt;init( $js_engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $html = \Minify_Inline_JavaScript::minify( $html, $js_minifier, $js_options );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.html.inline.css' ) ) {&nbsp;</div></li><li><div>          $css_engine = $this-&gt;_config-&gt;get_string( 'minify.css.engine' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !$w3_minifier-&gt;exists( $css_engine ) || !$w3_minifier-&gt;available( $css_engine ) ) {&nbsp;</div></li><li><div>              $css_engine = 'css';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $css_minifier = $w3_minifier-&gt;get_minifier( $css_engine );&nbsp;</div></li><li><div>          $css_options = $w3_minifier-&gt;get_options( $css_engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $w3_minifier-&gt;init( $css_engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $html = \Minify_Inline_CSS::minify( $html, $css_minifier, $css_options );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $engine = $this-&gt;_config-&gt;get_string( 'minify.html.engine' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$w3_minifier-&gt;exists( $engine ) || !$w3_minifier-&gt;available( $engine ) ) {&nbsp;</div></li><li><div>          $engine = 'html';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'is_feed' ) && is_feed() ) {&nbsp;</div></li><li><div>          $engine .= 'xml';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $minifier = $w3_minifier-&gt;get_minifier( $engine );&nbsp;</div></li><li><div>      $options = $w3_minifier-&gt;get_options( $engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $w3_minifier-&gt;init( $engine );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html = call_user_func( $minifier, $html, $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $ignored_comments_preserver ) ) {&nbsp;</div></li><li><div>          $html = $ignored_comments_preserver-&gt;replace( $html );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $html;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns current theme</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_theme() {&nbsp;</div></li><li><div>      static $theme = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $theme === null ) {&nbsp;</div></li><li><div>          $theme = Util_Theme::get_theme_key( get_theme_root(), get_template(), get_stylesheet() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $theme;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns current template</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_template() {&nbsp;</div></li><li><div>      static $template = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $template === null ) {&nbsp;</div></li><li><div>          $template_file = 'index.php';&nbsp;</div></li><li><div>          switch ( true ) {&nbsp;</div></li><li><div>          case ( is_404() && ( $template_file = get_404_template() ) ):&nbsp;</div></li><li><div>          case ( is_search() && ( $template_file = get_search_template() ) ):&nbsp;</div></li><li><div>          case ( is_tax() && ( $template_file = get_taxonomy_template() ) ):&nbsp;</div></li><li><div>          case ( is_front_page() && function_exists( 'get_front_page_template' ) && $template_file = get_front_page_template() ):&nbsp;</div></li><li><div>          case ( is_home() && ( $template_file = get_home_template() ) ):&nbsp;</div></li><li><div>          case ( is_attachment() && ( $template_file = get_attachment_template() ) ):&nbsp;</div></li><li><div>          case ( is_single() && ( $template_file = get_single_template() ) ):&nbsp;</div></li><li><div>          case ( is_page() && ( $template_file = get_page_template() ) ):&nbsp;</div></li><li><div>          case ( is_category() && ( $template_file = get_category_template() ) ):&nbsp;</div></li><li><div>          case ( is_tag() && ( $template_file = get_tag_template() ) ):&nbsp;</div></li><li><div>          case ( is_author() && ( $template_file = get_author_template() ) ):&nbsp;</div></li><li><div>          case ( is_date() && ( $template_file = get_date_template() ) ):&nbsp;</div></li><li><div>          case ( is_archive() && ( $template_file = get_archive_template() ) ):&nbsp;</div></li><li><div>          case ( is_comments_popup() && ( $template_file = get_comments_popup_template() ) ):&nbsp;</div></li><li><div>          case ( is_paged() && ( $template_file = get_paged_template() ) ):&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              if ( function_exists( 'get_index_template' ) ) {&nbsp;</div></li><li><div>                  $template_file = get_index_template();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $template_file = 'index.php';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $template = basename( $template_file, '.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $template;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns style tag</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $import</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $use_style</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_style( $url, $import = false, $use_style = true ) {&nbsp;</div></li><li><div>      if ( $import && $use_style ) {&nbsp;</div></li><li><div>          return &quot;&lt;style type=\&quot;text/css\&quot; media=\&quot;all\&quot;&gt;@import url(\&quot;&quot; . $url . &quot;\&quot;);&lt;/style&gt;\r\n&quot;;&nbsp;</div></li><li><div>      } elseif ( $import && !$use_style ) {&nbsp;</div></li><li><div>          return &quot;@import url(\&quot;&quot; . $url . &quot;\&quot;);\r\n&quot;;&nbsp;</div></li><li><div>      }else {&nbsp;</div></li><li><div>          return &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot; . str_replace( '&', '&amp;', $url ) . &quot;\&quot; media=\&quot;all\&quot; /&gt;\r\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns style tag for style group</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $location</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_style_group( $location ) {&nbsp;</div></li><li><div>      $style = false;&nbsp;</div></li><li><div>      $type = 'css';&nbsp;</div></li><li><div>      $groups = $this-&gt;_config-&gt;get_array( 'minify.css.groups' );&nbsp;</div></li><li><div>      $theme = $this-&gt;get_theme();&nbsp;</div></li><li><div>      $template = $this-&gt;get_template();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $template != 'default' && empty( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $template = 'default';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = array(&nbsp;</div></li><li><div>          'url' =&gt; null, &nbsp;</div></li><li><div>          'body' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;_config-&gt;get_boolean( 'minify.css.embed' ) ) {&nbsp;</div></li><li><div>              $minify = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>              $minify_filename = $this-&gt;get_minify_manual_filename(&nbsp;</div></li><li><div>                  $theme, $template, $location, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $m = $minify-&gt;process( $minify_filename, true );&nbsp;</div></li><li><div>              if ( isset( $m['content'] ) )&nbsp;</div></li><li><div>                  $style = $m['content'];&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $style = 'not set';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $return['body'] = &quot;&lt;style type=\&quot;text/css\&quot; media=\&quot;all\&quot;&gt;$style&lt;/style&gt;\r\n&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $return['url'] = $this-&gt;get_minify_manual_url( $theme, $template, $location, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $return['url'] ) {&nbsp;</div></li><li><div>                  $import = ( isset( $groups[$theme][$template][$location]['import'] ) ? (boolean) $groups[$theme][$template][$location]['import'] : false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $return['body'] = $this-&gt;get_style( $return['url'], $import );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns script tag for script group</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $location</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $embed_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_script_group( $location, $embed_type = 'blocking' ) {&nbsp;</div></li><li><div>      $script = false;&nbsp;</div></li><li><div>      $fileType = 'js';&nbsp;</div></li><li><div>      $theme = $this-&gt;get_theme();&nbsp;</div></li><li><div>      $template = $this-&gt;get_template();&nbsp;</div></li><li><div>      $groups = $this-&gt;_config-&gt;get_array( 'minify.js.groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $template != 'default' && empty( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $template = 'default';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = array(&nbsp;</div></li><li><div>          'url' =&gt; null, &nbsp;</div></li><li><div>          'body' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $groups[$theme][$template][$location]['files'] ) ) {&nbsp;</div></li><li><div>          $return['url'] = $this-&gt;get_minify_manual_url( $theme, $template, $location, $fileType );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $return['url'] ) {&nbsp;</div></li><li><div>              $return['body'] = $this-&gt;minify_helpers-&gt;generate_script_tag(&nbsp;</div></li><li><div>                  $return['url'], $embed_type );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns style tag for custom files</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_style_custom( $files, $embed_to_html = false ) {&nbsp;</div></li><li><div>      $return = array(&nbsp;</div></li><li><div>          'url' =&gt; null, &nbsp;</div></li><li><div>          'body' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $files ) ) {&nbsp;</div></li><li><div>          if ( $embed_to_html ) {&nbsp;</div></li><li><div>              $return['body'] =&nbsp;</div></li><li><div>                  $this-&gt;minify_helpers-&gt;get_minified_content_for_files(&nbsp;</div></li><li><div>                      $files, 'css' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $return['url'] = $this-&gt;minify_helpers-&gt;get_minify_url_for_files(&nbsp;</div></li><li><div>                  $files, 'css' );&nbsp;</div></li><li><div>              if ( !is_null( $return['url'] ) ) {&nbsp;</div></li><li><div>                  $return['body'] = $this-&gt;get_style( $return['url'], false, &nbsp;</div></li><li><div>                      false );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates filename for minify manual resource</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_minify_manual_filename( $theme, $template, $location, $type ) {&nbsp;</div></li><li><div>      $minify = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>      $id = $minify-&gt;get_id_group( $theme, $template, $location, $type );&nbsp;</div></li><li><div>      if ( !$id )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $theme . '.' . $template . '.' . $location . '.'. $id .&nbsp;</div></li><li><div>          '.' . $type;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates URL for minify manual resource</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_minify_manual_url( $theme, $template, $location, $type ) {&nbsp;</div></li><li><div>      return Minify_Core::minified_url( $this-&gt;get_minify_manual_filename(&nbsp;</div></li><li><div>          $theme, $template, $location, $type ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns array of minify URLs</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_urls() {&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $js_groups = $this-&gt;_config-&gt;get_array( 'minify.js.groups' );&nbsp;</div></li><li><div>      $css_groups = $this-&gt;_config-&gt;get_array( 'minify.css.groups' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $js_groups as $js_theme =&gt; $js_templates ) {&nbsp;</div></li><li><div>          foreach ( $js_templates as $js_template =&gt; $js_locations ) {&nbsp;</div></li><li><div>              foreach ( (array) $js_locations as $js_location =&gt; $js_config ) {&nbsp;</div></li><li><div>                  if ( !empty( $js_config['files'] ) ) {&nbsp;</div></li><li><div>                      $files[] = $this-&gt;get_minify_manual_url( $js_theme, $js_template, $js_location, 'js' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $css_groups as $css_theme =&gt; $css_templates ) {&nbsp;</div></li><li><div>          foreach ( $css_templates as $css_template =&gt; $css_locations ) {&nbsp;</div></li><li><div>              foreach ( (array) $css_locations as $css_location =&gt; $css_config ) {&nbsp;</div></li><li><div>                  if ( !empty( $css_config['files'] ) ) {&nbsp;</div></li><li><div>                      $files[] = $this-&gt;get_minify_manual_url( $css_theme, $css_template, $css_location, 'css' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $files;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if we can do minify logic</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function can_minify() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if doint AJAX</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'DOING_AJAX' ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Doing AJAX';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if doing cron</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'DOING_CRON' ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Doing cron';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if APP request</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'APP_REQUEST' ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Application request';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if XMLRPC request</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'XMLRPC_REQUEST' ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'XMLRPC request';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if Admin</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'WP_ADMIN' ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'wp-admin';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for WPMU's and WP's 3.0 short init</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'SHORTINIT' ) && SHORTINIT ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Short init';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check User agent</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( !$this-&gt;check_ua() ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'User agent is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check request URI</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( !$this-&gt;check_request_uri() ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Request URI is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Skip if user is logged in</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.reject.logged' ) && !$this-&gt;check_logged_in() ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'User is logged in';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if we can minify</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $buffer</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function can_minify2( $buffer ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for database error</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( Util_Content::is_database_error( $buffer ) ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Database Error occurred';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check for DONOTMINIFY constant</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'DONOTMINIFY' ) && DONOTMINIFY ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'DONOTMINIFY constant is defined';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check feed minify</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( $this-&gt;_config-&gt;get_boolean( 'minify.html.reject.feed' ) && function_exists( 'is_feed' ) && is_feed() ) {&nbsp;</div></li><li><div>          $this-&gt;minify_reject_reason = 'Feed is rejected';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks User Agent</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_ua() {&nbsp;</div></li><li><div>      $uas = array_merge( $this-&gt;_config-&gt;get_array( 'minify.reject.ua' ), array(&nbsp;</div></li><li><div>              W3TC_POWERED_BY&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $uas as $ua ) {&nbsp;</div></li><li><div>          if ( !empty( $ua ) ) {&nbsp;</div></li><li><div>              if ( isset( $_SERVER['HTTP_USER_AGENT'] ) && stristr( $_SERVER['HTTP_USER_AGENT'], $ua ) !== false ) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if user is logged in</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_logged_in() {&nbsp;</div></li><li><div>      foreach ( array_keys( $_COOKIE ) as $cookie_name ) {&nbsp;</div></li><li><div>          if ( strpos( $cookie_name, 'wordpress_logged_in' ) === 0 )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks request URI</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_request_uri() {&nbsp;</div></li><li><div>      $auto_reject_uri = array(&nbsp;</div></li><li><div>          'wp-login', &nbsp;</div></li><li><div>          'wp-register'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $auto_reject_uri as $uri ) {&nbsp;</div></li><li><div>          if ( strstr( $_SERVER['REQUEST_URI'], $uri ) !== false ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $reject_uri = $this-&gt;_config-&gt;get_array( 'minify.reject.uri' );&nbsp;</div></li><li><div>      $reject_uri = array_map( array( '\W3TC\Util_Environment', 'parse_path' ), $reject_uri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $reject_uri as $expr ) {&nbsp;</div></li><li><div>          $expr = trim( $expr );&nbsp;</div></li><li><div>          $expr = str_replace( '~', '\~', $expr );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $expr != '' && preg_match( '~' . $expr . '~i', $_SERVER['REQUEST_URI'] ) ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Util_Request::get_string( 'wp_customize' ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function w3tc_usage_statistics_of_request( $storage ) {&nbsp;</div></li><li><div>      $o = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>      $o-&gt;w3tc_usage_statistics_of_request( $storage );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function w3tc_usage_statistics_metrics( $metrics ) {&nbsp;</div></li><li><div>      return array_merge( $metrics, array(&nbsp;</div></li><li><div>              'minify_requests_total', &nbsp;</div></li><li><div>              'minify_original_length_css', 'minify_output_length_css', &nbsp;</div></li><li><div>              'minify_original_length_js', 'minify_output_length_js', ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class _W3_MinifyHelpers {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Config</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $config;&nbsp;</div></li><li><div>  private $debug = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param W3_COnfig $config</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct( $config ) {&nbsp;</div></li><li><div>      $this-&gt;config = $config;&nbsp;</div></li><li><div>      $this-&gt;debug = $config-&gt;get_boolean( 'minify.debug' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Formats custom URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $files</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $type</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_minify_url_for_files( $files, $type ) {&nbsp;</div></li><li><div>      $minify_filename =&nbsp;</div></li><li><div>          Minify_Core::urls_for_minification_to_minify_filename(&nbsp;</div></li><li><div>          $files, $type );&nbsp;</div></li><li><div>      if ( is_null( $minify_filename ) )&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = Minify_Core::minified_url( $minify_filename );&nbsp;</div></li><li><div>      $url = Util_Environment::url_to_maybe_https( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns minified content</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $files</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $type</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_minified_content_for_files( $files, $type ) {&nbsp;</div></li><li><div>      $minify_filename =&nbsp;</div></li><li><div>          Minify_Core::urls_for_minification_to_minify_filename(&nbsp;</div></li><li><div>          $files, $type );&nbsp;</div></li><li><div>      if ( is_null( $minify_filename ) )&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      $minify = Dispatcher::component( 'Minify_MinifiedFileRequestHandler' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $m = $minify-&gt;process( $minify_filename, true );&nbsp;</div></li><li><div>      if ( isset( $m['content'] ) )&nbsp;</div></li><li><div>          $style = $m['content'];&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $style = 'not set';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return &quot;&lt;style type=\&quot;text/css\&quot; media=\&quot;all\&quot;&gt;$style&lt;/style&gt;\r\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Prints script tag</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $embed_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_script_tag( $url, $embed_type = 'blocking' ) {&nbsp;</div></li><li><div>      static $non_blocking_function = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $embed_type == 'blocking' ) {&nbsp;</div></li><li><div>          $script = '&lt;script type=&quot;text/javascript&quot; src=&quot;' .&nbsp;</div></li><li><div>              str_replace( '&', '&amp;', $url ) . '&quot;&gt;&lt;/script&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $script = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $embed_type == 'nb-js' ) {&nbsp;</div></li><li><div>              if ( !$non_blocking_function ) {&nbsp;</div></li><li><div>                  $non_blocking_function = true;&nbsp;</div></li><li><div>                  $script = &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;function w3tc_load_js(u) {var d=document, p=d.getElementsByTagName('HEAD')[0], c=d.createElement('script');c.type='text/javascript';c.src=u;p.appendChild(c);}&lt;/script&gt;&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $script .= &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;w3tc_load_js('&quot; .&nbsp;</div></li><li><div>                  $url . &quot;');&lt;/script&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else if ( $embed_type == 'nb-async' ) {&nbsp;</div></li><li><div>                  $script = '&lt;script async type=&quot;text/javascript&quot; src=&quot;' .&nbsp;</div></li><li><div>                      str_replace( '&', '&amp;', $url ) . '&quot;&gt;&lt;/script&gt;';&nbsp;</div></li><li><div>              } else if ( $embed_type == 'nb-defer' ) {&nbsp;</div></li><li><div>                  $script = '&lt;script defer type=&quot;text/javascript&quot; src=&quot;' .&nbsp;</div></li><li><div>                      str_replace( '&', '&amp;', $url ) . '&quot;&gt;&lt;/script&gt;';&nbsp;</div></li><li><div>              } else if ( $embed_type == 'extsrc' ) {&nbsp;</div></li><li><div>                  $script = '&lt;script type=&quot;text/javascript&quot; extsrc=&quot;' .&nbsp;</div></li><li><div>                      str_replace( '&', '&amp;', $url ) . '&quot;&gt;&lt;/script&gt;';&nbsp;</div></li><li><div>              } else if ( $embed_type == 'asyncsrc' ) {&nbsp;</div></li><li><div>                  $script = '&lt;script type=&quot;text/javascript&quot; asyncsrc=&quot;' .&nbsp;</div></li><li><div>                      str_replace( '&', '&amp;', $url ) . '&quot;&gt;&lt;/script&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $script . &quot;\r\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * URL file filter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $file</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_file_for_minification( $url, $file ) {&nbsp;</div></li><li><div>      static $external;&nbsp;</div></li><li><div>      static $external_regexp;&nbsp;</div></li><li><div>      if ( !isset( $external ) ) {&nbsp;</div></li><li><div>          $external = $this-&gt;config-&gt;get_array( 'minify.cache.files' );&nbsp;</div></li><li><div>          $external_regexp = $this-&gt;config-&gt;get_boolean( 'minify.cache.files_regexp' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $external as $item ) {&nbsp;</div></li><li><div>          if ( empty( $item ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $external_regexp ) {&nbsp;</div></li><li><div>              $item = str_replace( '~', '\~', $item );&nbsp;</div></li><li><div>              if ( ! preg_match( '~' . $item . '~', $url ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( ! preg_match( '~^' . Util_Environment::get_url_regexp( $item ) . '~', $url ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log(&nbsp;</div></li><li><div>                  'is_file_for_minification: whilelisted ' . $url . ' by ' . $item );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return 'url';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file_normalized = Util_Environment::remove_query_all( $file );&nbsp;</div></li><li><div>      $ext = strrchr( $file_normalized, '.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $ext != '.js' && $ext != '.css' ) {&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log(&nbsp;</div></li><li><div>                  'is_file_for_minification: unknown extension ' . $ext .&nbsp;</div></li><li><div>                  ' for ' . $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Util_Environment::is_url( $file_normalized ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log(&nbsp;</div></li><li><div>                  'is_file_for_minification: its url ' . $file . ' for url ' . $url );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = Util_Environment::document_root() . '/' . $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !file_exists( $path ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log(&nbsp;</div></li><li><div>                  'is_file_for_minification: file doesnt exists ' . $path );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>          Minify_Core::log(&nbsp;</div></li><li><div>              'is_file_for_minification: true for file ' . $file .&nbsp;</div></li><li><div>              ' path ' . $path );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return 'file';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends HTTP/2 push header</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function http2_header_add( $url, $as ) {&nbsp;</div></li><li><div>      if ( empty( $url ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cloudflare needs URI without host</span>&nbsp;</div></li><li><div>      $uri = Util_Environment::url_to_uri( $url );&nbsp;</div></li><li><div>      header( 'Link: &lt;' . $uri . '&gt;; rel=preload; as=' . $as, false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class _W3_MinifyJsAuto</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class _W3_MinifyJsAuto {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Config</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $config;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Processed buffer</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $buffer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * JS files to ignore</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $ignore_js_files;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Embed type</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $embed_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Helper object to use</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var _W3_MinifyHelpers</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $minify_helpers;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array of processed scripts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $debug_minified_urls = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Current position to embed minified script</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var integer</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $embed_pos;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Current list of files to minify</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $files_to_minify;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Current group type</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $group_type = 'head';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Current number of minification group</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var integer</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $minify_group_number = 0;&nbsp;</div></li><li><div>  private $debug = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $config</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $buffer</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $minify_helpers</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct( $config, $buffer, $minify_helpers ) {&nbsp;</div></li><li><div>      $this-&gt;config = $config;&nbsp;</div></li><li><div>      $this-&gt;debug = $config-&gt;get_boolean( 'minify.debug' );&nbsp;</div></li><li><div>      $this-&gt;buffer = $buffer;&nbsp;</div></li><li><div>      $this-&gt;minify_helpers = $minify_helpers;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// ignored files</span>&nbsp;</div></li><li><div>      $this-&gt;ignore_js_files = $this-&gt;config-&gt;get_array( 'minify.reject.files.js' );&nbsp;</div></li><li><div>      $this-&gt;ignore_js_files = array_map( array( '\W3TC\Util_Environment', 'normalize_file' ), $this-&gt;ignore_js_files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// define embed type</span>&nbsp;</div></li><li><div>      $this-&gt;embed_type = array(&nbsp;</div></li><li><div>          'head' =&gt; $this-&gt;config-&gt;get_string( 'minify.js.header.embed_type' ), &nbsp;</div></li><li><div>          'body' =&gt; $this-&gt;config-&gt;get_string( 'minify.js.body.embed_type' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Does auto-minification</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string buffer of minified content</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function execute() {&nbsp;</div></li><li><div>      <span class="comment">// find all script tags</span>&nbsp;</div></li><li><div>      $buffer_nocomments = preg_replace( '~&lt;!--.*?--&gt;\s*~s', '', $this-&gt;buffer );&nbsp;</div></li><li><div>      $matches = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// end of &lt;head&gt; means another group of scripts, cannt be combined</span>&nbsp;</div></li><li><div>      if ( !preg_match_all( '~(&lt;script\s*[^&gt;]*&gt;.*?&lt;/script&gt;|&lt;/head&gt;)~is', &nbsp;</div></li><li><div>              $buffer_nocomments, $matches ) ) {&nbsp;</div></li><li><div>          $matches = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $matches ) ) {&nbsp;</div></li><li><div>          return $this-&gt;buffer;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $script_tags = $matches[1];&nbsp;</div></li><li><div>      $script_tags = apply_filters( 'w3tc_minify_js_script_tags', &nbsp;</div></li><li><div>          $script_tags );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// pass scripts</span>&nbsp;</div></li><li><div>      $this-&gt;embed_pos = null;&nbsp;</div></li><li><div>      $this-&gt;files_to_minify = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      for ( $n = 0; $n &lt; count( $script_tags ); $n++ ) {&nbsp;</div></li><li><div>          $this-&gt;process_script_tag( $script_tags[$n], $n );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;flush_collected( '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;buffer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns list of minified scripts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_debug_minified_urls() {&nbsp;</div></li><li><div>      return $this-&gt;debug_minified_urls;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Processes script tag</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param unknown $script_tag</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function process_script_tag( $script_tag, $script_tag_number ) {&nbsp;</div></li><li><div>      if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>          Minify_Core::log( 'processing tag ' . substr( $script_tag, 0, 150 ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tag_pos = strpos( $this-&gt;buffer, $script_tag );&nbsp;</div></li><li><div>      if ( $tag_pos === false ) {&nbsp;</div></li><li><div>          <span class="comment">// script is external but not found, skip processing it</span>&nbsp;</div></li><li><div>          error_log( 'script not found:' . $script_tag );&nbsp;</div></li><li><div>          Minify_Core::log( 'script not found:' . $script_tag );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $match = null;&nbsp;</div></li><li><div>      if ( !preg_match( '~&lt;script\s+[^&lt;&gt;]*src=[&quot;\']?([^&quot;\'&gt; ]+)[&quot;\'&gt; ]~is', &nbsp;</div></li><li><div>              $script_tag, $match ) ) {&nbsp;</div></li><li><div>          $match = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( is_null( $match ) ) {&nbsp;</div></li><li><div>          $data = array(&nbsp;</div></li><li><div>              'script_tag_original' =&gt; $script_tag, &nbsp;</div></li><li><div>              'script_tag_new' =&gt; $script_tag, &nbsp;</div></li><li><div>              'script_tag_number' =&gt; $script_tag_number, &nbsp;</div></li><li><div>              'script_tag_pos' =&gt; $tag_pos, &nbsp;</div></li><li><div>              'should_replace' =&gt; false, &nbsp;</div></li><li><div>              'buffer' =&gt; $this-&gt;buffer&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data = apply_filters( 'w3tc_minify_js_do_local_script_minification', &nbsp;</div></li><li><div>              $data );&nbsp;</div></li><li><div>          $this-&gt;buffer = $data['buffer'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data['should_replace'] ) {&nbsp;</div></li><li><div>              $this-&gt;buffer = substr_replace( $this-&gt;buffer, &nbsp;</div></li><li><div>                  $data['script_tag_new'], $tag_pos, &nbsp;</div></li><li><div>                  strlen( $script_tag ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// it's not external script, have to flush what we have before it</span>&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log( 'its not src=, flushing' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;flush_collected( $script_tag );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( preg_match( '~&lt;/head&gt;~is', $script_tag, $match ) )&nbsp;</div></li><li><div>              $this-&gt;group_type = 'body';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $script_src = $match[1];&nbsp;</div></li><li><div>      $script_src = Util_Environment::url_relative_to_full( $script_src );&nbsp;</div></li><li><div>      $file = Util_Environment::url_to_docroot_filename( $script_src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $step1_result = $this-&gt;minify_helpers-&gt;is_file_for_minification( $script_src, $file );&nbsp;</div></li><li><div>      $step1 = !empty( $step1_result );&nbsp;</div></li><li><div>      $step2 = !in_array( $file, $this-&gt;ignore_js_files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $do_tag_minification = $step1 && $step2;&nbsp;</div></li><li><div>      $do_tag_minification = apply_filters( 'w3tc_minify_js_do_tag_minification', &nbsp;</div></li><li><div>          $do_tag_minification, $script_tag, $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$do_tag_minification ) {&nbsp;</div></li><li><div>          if ( $this-&gt;debug ) {&nbsp;</div></li><li><div>              Minify_Core::log( 'file ' . $file .&nbsp;</div></li><li><div>                  ' didnt pass minification check:' .&nbsp;</div></li><li><div>                  ' file_for_min: ' . ( $step1 ? 'true' : 'false' ) .&nbsp;</div></li><li><div>                  ' ignore_js_files: ' . ( $step2 ? 'true' : 'false' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data = array(&nbsp;</div></li><li><div>              'script_tag_original' =&gt; $script_tag, &nbsp;</div></li><li><div>              'script_tag_new' =&gt; $script_tag, &nbsp;</div></li><li><div>              'script_tag_number' =&gt; $script_tag_number, &nbsp;</div></li><li><div>              'script_tag_pos' =&gt; $tag_pos, &nbsp;</div></li><li><div>              'script_src' =&gt; $script_src, &nbsp;</div></li><li><div>              'should_replace' =&gt; false, &nbsp;</div></li><li><div>              'buffer' =&gt; $this-&gt;buffer&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data = apply_filters( 'w3tc_minify_js_do_excluded_tag_script_minification', &nbsp;</div></li><li><div>              $data );&nbsp;</div></li><li><div>          $this-&gt;buffer = $data['buffer'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data['should_replace'] ) {&nbsp;</div></li><li><div>              $this-&gt;buffer = substr_replace( $this-&gt;buffer, &nbsp;</div></li><li><div>                  $data['script_tag_new'], $tag_pos, &nbsp;</div></li><li><div>                  strlen( $script_tag ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;flush_collected( $script_tag );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;debug_minified_urls[] = $file;&nbsp;</div></li><li><div>      $this-&gt;buffer = substr_replace( $this-&gt;buffer, '', &nbsp;</div></li><li><div>          $tag_pos, strlen( $script_tag ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// for head group - put minified file at the place of first script</span>&nbsp;</div></li><li><div>      <span class="comment">// for body - put at the place of last script, to make as more DOM</span>&nbsp;</div></li><li><div>      <span class="comment">// objects available as possible</span>&nbsp;</div></li><li><div>      if ( count( $this-&gt;files_to_minify ) &lt;= 0 || $this-&gt;group_type == 'body' )&nbsp;</div></li><li><div>          $this-&gt;embed_pos = $tag_pos;&nbsp;</div></li><li><div>      $this-&gt;files_to_minify[] = $file;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Minifies collected scripts</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function flush_collected( $last_script_tag ) {&nbsp;</div></li><li><div>      if ( count( $this-&gt;files_to_minify ) &lt;= 0 )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      $do_flush_collected = apply_filters( 'w3tc_minify_js_do_flush_collected', &nbsp;</div></li><li><div>          true, $last_script_tag, $this );&nbsp;</div></li><li><div>      if ( !$do_flush_collected )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// find embed position</span>&nbsp;</div></li><li><div>      $embed_pos = $this-&gt;embed_pos;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// build minified script tag</span>&nbsp;</div></li><li><div>      $data = array(&nbsp;</div></li><li><div>          'files_to_minify' =&gt; $this-&gt;files_to_minify, &nbsp;</div></li><li><div>          'embed_pos' =&gt; $embed_pos, &nbsp;</div></li><li><div>          'embed_type' =&gt; $this-&gt;embed_type[$this-&gt;group_type], &nbsp;</div></li><li><div>          'buffer' =&gt; $this-&gt;buffer&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = apply_filters( 'w3tc_minify_js_step', $data );&nbsp;</div></li><li><div>      $this-&gt;buffer = $data['buffer'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $data['files_to_minify'] ) ) {&nbsp;</div></li><li><div>          $url = $this-&gt;minify_helpers-&gt;get_minify_url_for_files(&nbsp;</div></li><li><div>              $data['files_to_minify'], 'js' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $script = '';&nbsp;</div></li><li><div>          if ( !is_null( $url ) ) {&nbsp;</div></li><li><div>              $script .= $this-&gt;minify_helpers-&gt;generate_script_tag( $url, &nbsp;</div></li><li><div>                  $data['embed_type'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data['script_to_embed_url'] = $url;&nbsp;</div></li><li><div>          $data['script_to_embed_body'] = $script;&nbsp;</div></li><li><div>          $data = apply_filters( 'w3tc_minify_js_step_script_to_embed', &nbsp;</div></li><li><div>              $data );&nbsp;</div></li><li><div>          $this-&gt;buffer = $data['buffer'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;config-&gt;get_boolean( 'minify.js.http2push' ) ) {&nbsp;</div></li><li><div>              $this-&gt;minify_helpers-&gt;http2_header_add(&nbsp;</div></li><li><div>                  $data['script_to_embed_url'], 'script' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// replace</span>&nbsp;</div></li><li><div>          $this-&gt;buffer = substr_replace( $this-&gt;buffer, &nbsp;</div></li><li><div>              $data['script_to_embed_body'], $data['embed_pos'], 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;files_to_minify = array();&nbsp;</div></li><li><div>      $this-&gt;minify_group_number++;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>W3 Total Cache</li><li><span></span>0.9.5.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>