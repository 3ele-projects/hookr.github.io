<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.3.2" data-slug="wp-fb-autoconnect" data-type="file" data-id="17530"><head xmlns="http://www.w3.org/1999/xhtml"><title> main | file | Wp Fb Autoconnect | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-fb-autoconnect, 4.3.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=eaa1019fa00e313a4fe46598e5f1fb93' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/main/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmain%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmain%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-fb-autoconnect-4.3.2-file-main","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="main" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-fb-autoconnect." href="http://hookr.io/plugins/wp-fb-autoconnect/" class="plugin"><span property="name">wp-fb-autoconnect</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.3.2." href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/" class="H_VERSION"><span property="name">4.3.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">main</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="58"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/all/" title="All">All <span class="count badge">58</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="25"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/hooks/" title="Hooks">Hooks <span class="count badge">25</span></a></li><li class="" data-id="action" data-count="12"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/actions/" title="Actions">Actions <span class="count badge">12</span></a></li><li class="" data-id="filter" data-count="13"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/filters/" title="Filters">Filters <span class="count badge">13</span></a></li><li class="" data-id="class" data-count="1"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/classes/" title="Classes">Classes <span class="count badge">1</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="32"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/functions/" title="Functions">Functions <span class="count badge">32</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/wp-fb-autoconnect/4.3.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/Main.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/** Plugin Name: WP-FB-AutoConnect</span>&nbsp;</div></li><li><div><span class="comment"> * Description: A lightweight but powerful Facebook login plugin, easy to setup and transparent to new and returning users alike.  Supports Buddypress.</span>&nbsp;</div></li><li><div><span class="comment"> * Author: Justin Klein</span>&nbsp;</div></li><li><div><span class="comment"> * Version: 4.3.2</span>&nbsp;</div></li><li><div><span class="comment"> * Author URI: http://www.justin-klein.com/</span>&nbsp;</div></li><li><div><span class="comment"> * Plugin URI: http://www.justin-klein.com/projects/wp-fb-autoconnect</span>&nbsp;</div></li><li><div><span class="comment"> * Text Domain: wp-fb-autoconnect</span>&nbsp;</div></li><li><div><span class="comment"> * Domain Path: /languages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Copyright 2010-2016 Justin Klein (www.justin-klein.com)</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> * This program is free software; you can redistribute it and/or modify it</span>&nbsp;</div></li><li><div><span class="comment"> * under the terms of the GNU General Public License as published by the Free</span>&nbsp;</div></li><li><div><span class="comment"> * Software Foundation; either version 2 of the License, or (at your option)</span>&nbsp;</div></li><li><div><span class="comment"> * any later version.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>&nbsp;</div></li><li><div><span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>&nbsp;</div></li><li><div><span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</span>&nbsp;</div></li><li><div><span class="comment"> * more details.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You should have received a copy of the GNU General Public License along with</span>&nbsp;</div></li><li><div><span class="comment"> * this program; if not, write to the Free Software Foundation, Inc., 51</span>&nbsp;</div></li><li><div><span class="comment"> * Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * -------------------------------------------</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * --------Adding to WP-FB-AutoConnect--------</span>&nbsp;</div></li><li><div><span class="comment"> * If you're interested in creating a derived plugin, please contact me (Justin Klein) first;</span>&nbsp;</div></li><li><div><span class="comment"> * although duplicating and supplementing the existing code is one approach, doing so </span>&nbsp;</div></li><li><div><span class="comment"> * also means that your duplicate will not benefit from any future updates or bug fixes.</span>&nbsp;</div></li><li><div><span class="comment"> * Instead, with a bit of coordination I'm sure we could arrange for your addon to tie into the</span>&nbsp;</div></li><li><div><span class="comment"> * existing hooks & filters (which I can supplement if needed), allowing users to benefit </span>&nbsp;</div></li><li><div><span class="comment"> * both from your improvements as well as any future fixes I may provide.</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> * If you do choose to create and release a derived plugin anyway, please just be sure not to represent it</span>&nbsp;</div></li><li><div><span class="comment"> * as a fully original work, nor attempt to confuse it with the original WP-FB-AutoConnect by means of </span>&nbsp;</div></li><li><div><span class="comment"> * its name or otherwise.  You should give credit to the original plugin in a plainly visible location, </span>&nbsp;</div></li><li><div><span class="comment"> * such as the admin panel and readme file.  Also, please do not remove my links to Paypal or the </span>&nbsp;</div></li><li><div><span class="comment"> * Premium Addon as these are the only means through which I fund the considerable time I've devoted to </span>&nbsp;</div></li><li><div><span class="comment"> * creating and maintaining this otherwise free plugin.  If you'd like to add your own link that's of course</span>&nbsp;</div></li><li><div><span class="comment"> * fine, but just make sure it's no more prominent than the original.</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> * Put simply, be fair.  I've put hundreds of hours into this work, and I *have* experienced someone else </span>&nbsp;</div></li><li><div><span class="comment"> * trying to claim credit for it.  Please don't be that person.  I'm happy if you feel it's worthy of </span>&nbsp;</div></li><li><div><span class="comment"> * additional development, but would appreciate it if you'd work with me and not against me.  Expanding upon </span>&nbsp;</div></li><li><div><span class="comment"> * my work in the spirit of free software is welcome.  Stealing my credit and donations is not.</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> * Thanks! :)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>require_once(&quot;__inc_opts.php&quot;);&nbsp;</div></li><li><div>@include_once(realpath(dirname(__FILE__)).&quot;/../WP-FB-AutoConnect-Premium.php&quot;);&nbsp;</div></li><li><div>if( !defined('JFB_PREMIUM') ) @include_once(&quot;Premium.php&quot;);&nbsp;</div></li><li><div>require_once(&quot;AdminPage.php&quot;);&nbsp;</div></li><li><div>require_once(&quot;Widget.php&quot;);&nbsp;</div></li><li><div>require_once(&quot;_process_login.php&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/*******************************GENERAL********************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* Enqueue some basic styles</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>add_action('wp_enqueue_scripts', 'jfb_enqueue_styles');&nbsp;</div></li><li><div>function jfb_enqueue_styles()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_version;&nbsp;</div></li><li><div>  wp_enqueue_style('jfb', plugins_url(dirname(plugin_basename(__FILE__))).'/style.css', array(), $jfb_version );  &nbsp;</div></li><li><div>  wp_enqueue_script('jquery');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output a Login with Facebook Button.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function jfb_output_facebook_btn($callbackName=0)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">//Make sure the plugin has been setup</span>&nbsp;</div></li><li><div>  global $jfb_name, $jfb_version, $jfb_js_callbackfunc, $opt_jfb_valid;&nbsp;</div></li><li><div>  global $opt_jfb_ask_perms, $opt_jfb_ask_stream, $opt_jfbp_requirerealmail;&nbsp;</div></li><li><div>  echo &quot;&lt;!-- $jfb_name Button v$jfb_version --&gt;\n&quot;;&nbsp;</div></li><li><div>  if( !get_option($opt_jfb_valid) )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      echo &quot;&lt;!--WARNING: Invalid or Unset Facebook API Key--&gt;&quot;;&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//If a callback name is explicitly specified, use that.  Otherwise, use the global (main) callback.</span>&nbsp;</div></li><li><div>  if( !$callbackName ) $callbackName = $jfb_js_callbackfunc;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Figure out our scope (aka extended permissions)</span>&nbsp;</div></li><li><div>  $email_perms = get_option($opt_jfb_ask_perms) || get_option($opt_jfbp_requirerealmail);&nbsp;</div></li><li><div>  $stream_perms = get_option($opt_jfb_ask_stream);&nbsp;</div></li><li><div>  if( $email_perms && $stream_perms )    $scope = 'email, publish_actions';&nbsp;</div></li><li><div>  else if( $email_perms )                $scope = 'email';&nbsp;</div></li><li><div>  else if( $stream_perms )               $scope = 'publish_actions';&nbsp;</div></li><li><div>  else                                   $scope = '';&nbsp;</div></li><li><div>  $scope = apply_filters('wpfb_extended_permissions', $scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Output the button for the Premium version.  NOTE: This will not work with pre-v30 Premium addons.</span>&nbsp;</div></li><li><div>  if(defined('JFB_PREMIUM_VER') && function_exists('jfb_output_facebook_btn_premium_30'))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//The $callbackName param was introduced to this fxn in v3.1.4.  In order to avoid having to simultaneously</span>&nbsp;</div></li><li><div>      <span class="comment">//update both the premium addon and the core plugin, I'm gonna use this kinda &quot;hacky&quot; way to tell the addon</span>&nbsp;</div></li><li><div>      <span class="comment">//about the $callbackName.  If no $callbackName param was specified, it'll be the same as $jfb_js_callbackfunc</span>&nbsp;</div></li><li><div>      <span class="comment">//(aka the global option), so this save-and-restore approach will have no effect.</span>&nbsp;</div></li><li><div>      $savedGlobalCallback = $jfb_js_callbackfunc;&nbsp;</div></li><li><div>      $jfb_js_callbackfunc = $callbackName;&nbsp;</div></li><li><div>      jfb_output_facebook_btn_premium_30($scope);&nbsp;</div></li><li><div>      $jfb_js_callbackfunc = $savedGlobalCallback;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Output the button for the free version.  NOTE that I explicitly check that this is the free version, vs an older </span>&nbsp;</div></li><li><div>  <span class="comment">//Premium version; it's not safe to allow logins with old Premium versions, as those depend on the PHP API which is no longer present.</span>&nbsp;</div></li><li><div>  <span class="comment">//(Allowing out-of-date premium addons to login will crash in some circumstances - i.e. with autoregistration restrictions, etc.)</span>&nbsp;</div></li><li><div>  else if(!defined('JFB_PREMIUM_VER'))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      ?&gt;&lt;span class=&quot;fbLoginButton&quot;&gt;&lt;script type=&quot;text/javascript&quot;&gt;<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&lt;!--</span></span></span></span>&nbsp;</div></li><li><div>          document.write('&lt;fb:login-button scope=&quot;&lt;?php echo $scope ?&gt;&quot; v=&quot;2&quot; size=&quot;small&quot; onlogin=&quot;&lt;?php echo $callbackName ?&gt;();&quot;&gt;&lt;?php echo apply_filters('wpfb_button_text', 'Login with Facebook') ?&gt;&lt;/fb:login-button&gt;');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//--&gt;&lt;/script&gt;</span></span></span>&lt;/span&gt;&lt;?php</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Run action</span>&nbsp;</div></li><li><div>  do_action('wpfb_after_button');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * As an alternative to jfb_output_facebook_btn, this will setup an event to automatically popup the</span>&nbsp;</div></li><li><div><span class="comment"> * Facebook Connect dialog as soon as the page finishes loading (as if they clicked the button manually) </span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function jfb_output_facebook_instapopup( $callbackName=0 )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_js_callbackfunc;&nbsp;</div></li><li><div>  if( !$callbackName ) $callbackName = $jfb_js_callbackfunc;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  add_action('wpfb_add_to_asyncinit', 'jfb_invoke_instapopup');&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;script type=&quot;text/javascript&quot;&gt;<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&lt;!--</span></span></span></span>&nbsp;</div></li><li><div>  function showInstaPopup()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      FB.login(function(response)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>            if (response.authResponse)&nbsp;</div></li><li><div>              &lt;?php echo $callbackName?&gt;();&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>              alert(&quot;Sorry, you must be logged in to access this content.&quot;);&nbsp;</div></li><li><div>      }); &nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//--&gt;&lt;/script&gt;</span></span></span>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>function jfb_invoke_instapopup()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  echo &quot;showInstaPopup();&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output the JS to init the Facebook API, which will also setup a &lt;fb:login-button&gt; if present.</span>&nbsp;</div></li><li><div><span class="comment"> * Output this in the footer, so it always comes after the buttons.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action('wp_footer', 'jfb_output_facebook_init');&nbsp;</div></li><li><div>function jfb_output_facebook_init()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_name, $jfb_version, $opt_jfb_app_id, $opt_jfb_api_key, $opt_jfb_valid, $jfb_apiver;&nbsp;</div></li><li><div>  if( !get_option($opt_jfb_valid) ) return;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  echo &quot;\n&lt;!-- $jfb_name Init v$jfb_version (NEW API) --&gt;\n&quot;;&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>  &lt;script type=&quot;text/javascript&quot;&gt;<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&lt;!--</span></span></span></span>&nbsp;</div></li><li><div>    window.fbAsyncInit = function()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>      FB.init({&nbsp;</div></li><li><div>          appId: '&lt;?php echo get_option($opt_jfb_app_id); ?&gt;', &nbsp;</div></li><li><div>          status: true, &nbsp;</div></li><li><div>          cookie: true, &nbsp;</div></li><li><div>          xfbml: true, &nbsp;</div></li><li><div>          version: '&lt;?php echo $jfb_apiver?&gt;'&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>      &lt;?php do_action('wpfb_add_to_asyncinit'); ?&gt;            &nbsp;</div></li><li><div>    };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    (function() {&nbsp;</div></li><li><div>      var e = document.createElement('script');&nbsp;</div></li><li><div>      e.src = document.location.protocol + '<span class="comment">//connect.facebook.net/&lt;?php echo apply_filters('wpfb_output_facebook_locale', 'en_US'); ?&gt;/sdk.js';</span>&nbsp;</div></li><li><div>      e.async = true;&nbsp;</div></li><li><div>      document.getElementById('fb-root').appendChild(e);&nbsp;</div></li><li><div>    }());&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//--&gt;&lt;/script&gt;</span></span></span>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output the JS callback function that'll handle FB logins.</span>&nbsp;</div></li><li><div><span class="comment"> * NOTE: The Premium addon may alter its behavior via the hooks below.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action('wp_footer', 'jfb_output_facebook_callback');&nbsp;</div></li><li><div>function jfb_output_facebook_callback($redirectTo=0, $callbackName=0)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>   <span class="comment">//Make sure the plugin is setup properly before doing anything</span>&nbsp;</div></li><li><div>   global $jfb_name, $jfb_version, $opt_jfb_ask_perms, $opt_jfb_valid, $jfb_nonce_name;&nbsp;</div></li><li><div>   global $jfb_js_callbackfunc, $opt_jfb_ask_stream, $jfb_callback_list;&nbsp;</div></li><li><div>   if( !get_option($opt_jfb_valid) ) return;&nbsp;</div></li><li><div>   &nbsp;</div></li><li><div>   <span class="comment">//Get out our params</span>&nbsp;</div></li><li><div>   if( !$redirectTo )  $redirectTo = htmlspecialchars($_SERVER['REQUEST_URI']);&nbsp;</div></li><li><div>   if( !$callbackName )$callbackName = $jfb_js_callbackfunc;&nbsp;</div></li><li><div>   echo &quot;\n&lt;!-- $jfb_name Callback v$jfb_version --&gt;\n&quot;;&nbsp;</div></li><li><div>   &nbsp;</div></li><li><div>   <span class="comment">//Make sure we haven't already output a callback with this name</span>&nbsp;</div></li><li><div>   if( in_array($callbackName, $jfb_callback_list) )&nbsp;</div></li><li><div>   {&nbsp;</div></li><li><div>       echo &quot;\n&lt;!--jfb_output_facebook_callback has already generated a callback named $callbackName!  Skipping.--&gt;\n&quot;;&nbsp;</div></li><li><div>       return;&nbsp;</div></li><li><div>   }&nbsp;</div></li><li><div>   else&nbsp;</div></li><li><div>      array_push($jfb_callback_list, $callbackName);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   <span class="comment">//Output an html form that we'll submit via JS once the FB popup is dismissed.</span>&nbsp;</div></li><li><div>   <span class="comment">//NOTE: Regardless of where we submit the form to (the &quot;action&quot;), the FB login is handled completely by _process_login.php, </span>&nbsp;</div></li><li><div>   <span class="comment">//which runs in the &quot;init&quot; action and then immediately redirects elsewhere.  We could basically submit this form to </span>&nbsp;</div></li><li><div>   <span class="comment">//anywhere and it'd still work; I just use wp-login.php for simplicity (and because WP will guarantee that it's https</span>&nbsp;</div></li><li><div>   <span class="comment">//if ssl logins are required).</span>&nbsp;</div></li><li><div>   <span class="comment">//NOTE: I was previously submitting to wp_login_url(), which broke WPEngine.  They specifically require I post to </span>&nbsp;</div></li><li><div>   <span class="comment">//      site_url(), with the 'login_post' param...)</span>&nbsp;</div></li><li><div>   ?&gt;&lt;form id=&quot;wp-fb-ac-fm&quot; name=&quot;&lt;?php echo $callbackName ?&gt;_form&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url(site_url( 'wp-login.php', 'login_post' )); ?&gt;&quot; &gt;&nbsp;</div></li><li><div>        &lt;input type=&quot;hidden&quot; name=&quot;redirectTo&quot; value=&quot;&lt;?php echo $redirectTo?&gt;&quot; /&gt;&nbsp;</div></li><li><div>        &lt;input type=&quot;hidden&quot; name=&quot;access_token&quot; id=&quot;jfb_access_token&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>        &lt;input type=&quot;hidden&quot; name=&quot;fbuid&quot; id=&quot;jfb_fbuid&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>        &lt;?php wp_nonce_field ($jfb_nonce_name, $jfb_nonce_name) ?&gt;&nbsp;</div></li><li><div>        &lt;?php do_action('wpfb_add_to_form'); ?&gt;   &nbsp;</div></li><li><div>   &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php <span class="comment">//Output the JS callback, which Facebook will automatically call once it's been logged in. ?&gt;</span>&nbsp;</div></li><li><div>  &lt;script type=&quot;text/javascript&quot;&gt;<span class="comment"><span class="comment"><span class="comment"><span class="comment">//&lt;!--</span></span></span></span>&nbsp;</div></li><li><div>  function &lt;?php echo $callbackName ?&gt;()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//wpfb_add_to_js: An action to allow the user to inject additional JS to be executed before the login takes place</span>&nbsp;</div></li><li><div>      &lt;?php do_action('wpfb_add_to_js', $callbackName); ?&gt;&nbsp;</div></li><li><div>      <span class="comment">//wpfb_add_to_js: Finished</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Make sure the user logged into Facebook (didn't click &quot;cancel&quot; in the login prompt)</span>&nbsp;</div></li><li><div>      FB.getLoginStatus(function(response)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if (!response.authResponse)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              <span class="comment">//Note to self: if this is happening unexpectedly, it could be because third-party browser cookies are disabled.</span>&nbsp;</div></li><li><div>              &lt;?php echo apply_filters('wpfb_login_rejected', ''); ?&gt;&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          &nbsp;</div></li><li><div>          <span class="comment">//Set the uid & access token to be sent in to our login script</span>&nbsp;</div></li><li><div>          jQuery('#jfb_access_token').val(response.authResponse.accessToken);&nbsp;</div></li><li><div>          jQuery(&quot;#jfb_fbuid&quot;).val(response.authResponse.userID);&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>          <span class="comment">//Submit the login and close the FB.getLoginStatus call</span>&nbsp;</div></li><li><div>          &lt;?php echo apply_filters('wpfb_submit_loginfrm', &quot;document.&quot; . $callbackName . &quot;_form.submit();\n&quot; ); ?&gt;&nbsp;</div></li><li><div>      })&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">//--&gt;&lt;/script&gt;</span></span></span>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/*******************************CREDIT*********************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>global $opt_jfb_show_credit;&nbsp;</div></li><li><div>if( get_option($opt_jfb_show_credit) ) add_action('wp_footer', 'jfb_show_credit');&nbsp;</div></li><li><div>function jfb_show_credit()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_homepage;&nbsp;</div></li><li><div>  echo &quot;Facebook login by &lt;a href=\&quot;$jfb_homepage\&quot;&gt;WP-FB-AutoConnect&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/*******************************AVATARS********************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Legacy Support: there used to be two separate options for WP and BP; it's now just one option</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if( get_option($opt_jfb_bp_avatars) )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  delete_option($opt_jfb_bp_avatars);&nbsp;</div></li><li><div>  update_option($opt_jfb_wp_avatars, 1);    &nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* Optionally replace WORDPRESS avatars with FACEBOOK profile pictures</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>if( get_option($opt_jfb_wp_avatars) ) add_filter('get_avatar', 'jfb_wp_avatar', 10, 5);&nbsp;</div></li><li><div>function jfb_wp_avatar($avatar, $id_or_email, $size, $default, $alt)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//First, get the userid</span></span>&nbsp;</div></li><li><div>  if (is_numeric($id_or_email))        &nbsp;</div></li><li><div>      $user_id = $id_or_email;&nbsp;</div></li><li><div>  else if(is_object($id_or_email) && !empty($id_or_email-&gt;user_id))&nbsp;</div></li><li><div>     $user_id = $id_or_email-&gt;user_id;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>     return $avatar;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//If we couldn't get the userID, just return default behavior (email-based gravatar, etc)</span>&nbsp;</div></li><li><div>  if(!isset($user_id) || !$user_id) return $avatar;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Now that we have a userID, let's see if we have their facebook profile pic stored in usermeta.</span>&nbsp;</div></li><li><div>  <span class="comment">//Note: Facebook &quot;thumbs&quot; are 50x50; if they request that resolution or lower, return facebook_avatar_thumb; otherwise, </span>&nbsp;</div></li><li><div>  <span class="comment">//return facebook_avatar_full.  If neither are available, just fallback on WP's default behavior.</span>&nbsp;</div></li><li><div>  if(is_numeric($size) && $size &gt; 50)         $fb_img = get_user_meta($user_id, 'facebook_avatar_full', true);&nbsp;</div></li><li><div>  else if(is_numeric($size) && $size &lt;= 50)    $fb_img = get_user_meta($user_id, 'facebook_avatar_thumb', true);&nbsp;</div></li><li><div>  if( !$fb_img ) return $avatar;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//Users who didn't update to 2.3.1 when it was released may have some malformed avatar URLs in their db.  Handle this.</span></span>&nbsp;</div></li><li><div>  if( is_array($fb_img) && isset($fb_img['data']['url'])) $fb_img = $fb_img['data']['url'];&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//If the usermeta doesn't contain an absolute path, prefix it with the path to the uploads dir</span></span>&nbsp;</div></li><li><div>  if( strpos($fb_img, &quot;http&quot;) === FALSE )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if(function_exists('jfb_p_get_avatar_cache_dir'))&nbsp;</div></li><li><div>         $ud = jfb_p_get_avatar_cache_dir();&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>         $ud = wp_upload_dir();&nbsp;</div></li><li><div>      $uploads_url = $ud['baseurl'];&nbsp;</div></li><li><div>      $fb_img = trailingslashit($uploads_url) . $fb_img;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//And return the Facebook avatar (rather than the default WP one)</span></span>&nbsp;</div></li><li><div>  return &quot;&lt;img alt='&quot; . esc_attr($alt) . &quot;' src='$fb_img' class='avatar avatar-{$size} photo' height='{$size}' width='{$size}' /&gt;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Optionally replace BUDDYPRESS avatars with FACEBOOK profile pictures</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if( get_option($opt_jfb_wp_avatars) ) add_filter( 'bp_core_fetch_avatar', 'jfb_bp_avatar', 9, 4 );    &nbsp;</div></li><li><div>function jfb_bp_avatar($avatar, $params='')&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//First, get the userid</span></span>&nbsp;</div></li><li><div>  global $comment;&nbsp;</div></li><li><div>  if (is_object($comment))                            $user_id = $comment-&gt;user_id;&nbsp;</div></li><li><div>  if (is_object($params))                             $user_id = $params-&gt;user_id;&nbsp;</div></li><li><div>  if (is_array($params) && $params['object']=='user') $user_id = $params['item_id'];&nbsp;</div></li><li><div>  if (!isset($user_id))                               return $avatar;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Now that we have a userID, let's see if we have their facebook profile pic stored in usermeta.</span>  If not, fallback on the default.&nbsp;</div></li><li><div>  $fb_img = 0;&nbsp;</div></li><li><div>  if( $params['type'] == 'full' ) $fb_img = get_user_meta($user_id, 'facebook_avatar_full', true);&nbsp;</div></li><li><div>  if( !$fb_img )                  $fb_img = get_user_meta($user_id, 'facebook_avatar_thumb', true);&nbsp;</div></li><li><div>  if( !$fb_img )                  return $avatar;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//Users who didn't update to 2.3.1 when it was released may have some malformed avatar URLs in their db.  Handle this.</span></span>&nbsp;</div></li><li><div>  if( is_array($fb_img) && isset($fb_img['data']['url'])) $fb_img = $fb_img['data']['url'];&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//If the usermeta doesn't contain an absolute path, prefix it with the path to the uploads dir</span></span>&nbsp;</div></li><li><div>  if( strpos($fb_img, &quot;http&quot;) === FALSE )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $uploads_url = wp_upload_dir();&nbsp;</div></li><li><div>      $uploads_url = $uploads_url['baseurl'];&nbsp;</div></li><li><div>      $fb_img = trailingslashit($uploads_url) . $fb_img;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//And return the Facebook avatar (rather than the default WP one)</span></span>&nbsp;</div></li><li><div>  return '&lt;img alt=&quot;' . esc_attr($params['alt']) . '&quot; src=&quot;' . $fb_img . '&quot; class=&quot;avatar&quot; /&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/******************************USERNAMES*******************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Optionally modify the FB_xxxxxx to something &quot;prettier&quot;, based on the user's real name on Facebook</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>global $opt_jfb_username_style;&nbsp;</div></li><li><div>if( get_option($opt_jfb_username_style) == 1 || get_option($opt_jfb_username_style) == 2 || get_option($opt_jfb_username_style) == 3 ) add_filter( 'wpfb_insert_user', 'jfb_pretty_username', 10, 2 );&nbsp;</div></li><li><div>function jfb_pretty_username( $wp_userdata, $fb_userdata )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_log, $opt_jfb_username_style;&nbsp;</div></li><li><div>  $jfb_log .= &quot;WP: Converting username to \&quot;pretty\&quot; username...\n&quot;;&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Create a username from the user's Facebook name</span>&nbsp;</div></li><li><div>  if( get_option($opt_jfb_username_style) == 1 )&nbsp;</div></li><li><div>      $name = &quot;FB_&quot; . str_replace( ' ', '', $fb_userdata['first_name'] . &quot;_&quot; . $fb_userdata['last_name'] );&nbsp;</div></li><li><div>  else if( get_option($opt_jfb_username_style) == 2 )&nbsp;</div></li><li><div>      $name = str_replace( ' ', '', $fb_userdata['first_name'] . &quot;.&quot; . $fb_userdata['last_name'] );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $name = str_replace( ' ', '', $fb_userdata['first_name'] . &quot;_&quot; . $fb_userdata['last_name'] );&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Strip all non-alphanumeric characters, and make sure we've got something left.  If not, we'll just leave the FB_xxxxx username as is.</span>&nbsp;</div></li><li><div>  $name = sanitize_user($name, true);&nbsp;</div></li><li><div>  if( strlen($name) &lt;= 1 || $name == &quot;FB__&quot; )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $jfb_log .= &quot;WP: Warning - Completely non-alphanumeric Facebook name cannot be used; leaving as default.\n&quot;;&nbsp;</div></li><li><div>      return $wp_userdata;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>  <span class="comment">//Make sure the name is unique: if we've already got a user with this name, append a number to it.</span>&nbsp;</div></li><li><div>  $counter = 1;&nbsp;</div></li><li><div>  if ( username_exists( $name ) )&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      do&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $username = $name;&nbsp;</div></li><li><div>          $counter++;&nbsp;</div></li><li><div>          $username = $username . $counter;&nbsp;</div></li><li><div>      } while ( username_exists( $username ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $username = $name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>  <span class="comment">//Done!</span>&nbsp;</div></li><li><div>  $wp_userdata['user_login'] = $username;&nbsp;</div></li><li><div>  $wp_userdata['user_nicename']= $username;&nbsp;</div></li><li><div>  $jfb_log .= &quot;WP: Name successfully converted to $username.\n&quot;;&nbsp;</div></li><li><div>  return $wp_userdata;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/******************************Post-To-Wall****************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* If the option was selected and permission exists, publish an announcement about the user's registration to their wall </span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>if( get_option($opt_jfb_ask_stream) ) add_action('wpfb_inserted_user', 'jfb_post_to_wall');&nbsp;</div></li><li><div>function jfb_post_to_wall($args)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $opt_jfb_ask_stream, $jfb_log, $opt_jfb_stream_content;&nbsp;</div></li><li><div>  $jfb_log .= &quot;FB: Publishing registration news to user's wall.\n&quot;;&nbsp;</div></li><li><div>  $url = &quot;https:<span class="comment">//graph.facebook.com/me/feed?message=&quot; . urlencode(get_option($opt_jfb_stream_content)) . &quot;&access_token=&quot;.$args['access_token']; </span>&nbsp;</div></li><li><div>  $reply = jfb_api_post($url);&nbsp;</div></li><li><div>  if(isset($reply['error']))&nbsp;</div></li><li><div>      $jfb_log .= &quot;WARNING: Failed to publish to the user's wall (&quot; . $reply['error']['message'] . &quot;)\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/*******************BUDDYPRESS (previously in BuddyPress.php)**********/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Default the username style to &quot;Pretty Usernames&quot; if BP is detected.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action( 'bp_init', 'jfb_turn_on_prettynames' );&nbsp;</div></li><li><div>function jfb_turn_on_prettynames()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $opt_jfb_username_style;&nbsp;</div></li><li><div>  add_option($opt_jfb_username_style, 3);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a Facebook Login button to the Buddypress sidebar login widget</span>&nbsp;</div></li><li><div><span class="comment"> * NOTE: If you use this, you mustn't also use the built-in widget - just one or the other!</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action( 'bp_after_sidebar_login_form', 'jfb_bp_add_fb_login_button' );&nbsp;</div></li><li><div>add_action( 'bp_after_login_widget_loggedout', 'jfb_bp_add_fb_login_button');&nbsp;</div></li><li><div>function jfb_bp_add_fb_login_button()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>if ( !is_user_logged_in() )&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>    echo &quot;&lt;p&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>    jfb_output_facebook_btn();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/***************************Login Counting****************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>add_action('wpfb_login', 'jfb_count_login');&nbsp;</div></li><li><div>function jfb_count_login()&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  global $jfb_name, $jfb_version, $opt_jfb_logincount, $opt_jfb_logincount_recent, $opt_jfb_reportstats;&nbsp;</div></li><li><div>  update_option($opt_jfb_logincount, get_option($opt_jfb_logincount)+1);&nbsp;</div></li><li><div>  update_option($opt_jfb_logincount_recent, get_option($opt_jfb_logincount_recent)+1);&nbsp;</div></li><li><div>  if(get_option($opt_jfb_logincount_recent) &gt;= 24 && get_option($opt_jfb_reportstats))&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      jfb_auth($jfb_name, $jfb_version, 7, 1 );&nbsp;</div></li><li><div>      update_option($opt_jfb_logincount_recent, 0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/***************************Error Reporting****************************/</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/**********************************************************************/</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * I use this for bug-finding; you can remove it if you want, but I'd appreciate it if you didn't.</span>&nbsp;</div></li><li><div><span class="comment"> * I'll always notify you directly if I find & fix a bug thanks to your site (along with providing the fix) :)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function jfb_auth($name, $version, $event, $message=0)&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  $AuthVer = 1; &nbsp;</div></li><li><div>  $data = serialize(array(&nbsp;</div></li><li><div>        'pluginID' =&gt; '3584', &nbsp;</div></li><li><div>        'plugin' =&gt; $name, &nbsp;</div></li><li><div>        'version' =&gt; $version, &nbsp;</div></li><li><div>        'prem_version'=&gt; (defined('JFB_PREMIUM')?(&quot;p&quot; . JFB_PREMIUM . 'v' . JFB_PREMIUM_VER):&quot;&quot;), &nbsp;</div></li><li><div>        'wp_version' =&gt; $GLOBALS['wp_version'], &nbsp;</div></li><li><div>        'php_version' =&gt; PHP_VERSION, &nbsp;</div></li><li><div>        'event' =&gt; $event, &nbsp;</div></li><li><div>        'message' =&gt; $message, &nbsp;</div></li><li><div>        'SERVER' =&gt; array(&nbsp;</div></li><li><div>           'HTTP_HOST' =&gt; $_SERVER['HTTP_HOST'], &nbsp;</div></li><li><div>           'REMOTE_ADDR' =&gt; $_SERVER['REMOTE_ADDR'], &nbsp;</div></li><li><div>            <span class="comment">//Because some hosts, i.e. HostGator, block outgoing posts if they contain 'wp-login.php' for some reason... </span>&nbsp;</div></li><li><div>           'REQUEST_URI' =&gt; str_replace('wp-login.php', 'wp_login.php', $_SERVER['REQUEST_URI']))));&nbsp;</div></li><li><div>  $args = array( 'blocking'=&gt;false, 'body'=&gt;array(&nbsp;</div></li><li><div>                          'auth_plugin' =&gt; 1, &nbsp;</div></li><li><div>                          'AuthVer' =&gt; $AuthVer, &nbsp;</div></li><li><div>                          'hash' =&gt; md5($AuthVer.$data), &nbsp;</div></li><li><div>                          'data' =&gt; $data));&nbsp;</div></li><li><div>  wp_remote_post(&quot;http:<span class="comment">//auth.justin-klein.com&quot;, $args);</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WP-FB-AutoConnect</li><li><span></span>4.3.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>