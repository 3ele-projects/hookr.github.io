<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="0.1.7" data-slug="buddypress-moderation" data-type="class" data-id="97859"><head xmlns="http://www.w3.org/1999/xhtml"><title> bpmodbackend | class | Buddypress Moderation | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="bpModBackend, class, plugin, buddypress-moderation, 0.1.7" /><meta name="description" content="Controls and display the backend part of bp-moderation" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3558126273515f38f27435cfc3cbe881' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/bp_mod_backend/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_mod_backend%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbp_mod_backend%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-moderation-0.1.7-class-bp_mod_backend","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp_mod_backend" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress-moderation." href="http://hookr.io/plugins/buddypress-moderation/" class="plugin"><span property="name">buddypress-moderation</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 0.1.7." href="http://hookr.io/plugins/buddypress-moderation/0.1.7/" class="H_VERSION"><span property="name">0.1.7</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/buddypress-moderation/0.1.7/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp_mod_backend</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="37"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/all/" title="All">All <span class="count badge">37</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="24"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/hooks/" title="Hooks">Hooks <span class="count badge">24</span></a></li><li class="" data-id="action" data-count="15"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/actions/" title="Actions">Actions <span class="count badge">15</span></a></li><li class="" data-id="filter" data-count="9"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/filters/" title="Filters">Filters <span class="count badge">9</span></a></li><li class="active" data-id="class" data-count="13"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/classes/" title="Classes">Classes <span class="count badge">13</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>bpModBackend</strong></h1><p>Controls and display the backend part of bp-moderation.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/files/classes-bpmodbackend/" class="file">/classes/bpModBackend.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="8" class="block" start="8"><li><div>class bpModBackend extends bpModeration&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bpModBackend constructor&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * hooks in wordpress backend&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function  __construct()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (version_compare(get_site_option('bp_moderation_db_version'), $this-&gt;db_ver, '&lt;')) {&nbsp;</div></li><li><div>            bpModLoader::load_class('bpModInstaller');&nbsp;</div></li><li><div>            $installer = new bpModInstaller();&nbsp;</div></li><li><div>            $installer-&gt;install();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action(is_multisite() ? 'network_admin_menu' : 'admin_menu', array(&$this, 'add_admin_menu'));&nbsp;</div></li><li><div>        add_action('admin_head', array(&$this, 'print_page_icon_style'));&nbsp;</div></li><li><div>        add_action('rightnow_end', array(&$this, 'rightnow_widget_section'));&nbsp;</div></li><li><div>        add_action('admin_init', array(&$this, 'register_settings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($this-&gt;options['generate_test_data'])) {&nbsp;</div></li><li><div>            unset($this-&gt;options['generate_test_data']);&nbsp;</div></li><li><div>            update_site_option('bp_moderation_options', $this-&gt;options);&nbsp;</div></li><li><div>            add_action('admin_init', array(bpModLoader, 'test_data'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add aubmenu page and hooks css and js functions&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function add_admin_menu()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $hook = add_menu_page(__('BuddyPress Moderation', 'bp-moderation'), __('BP Moderation', 'bp-moderation'), &nbsp;</div></li><li><div>            'manage_options', 'bp-moderation', array(&$this, 'admin_page'), 'div');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action(&quot;admin_print_styles-$hook&quot;, array(&$this, 'admin_css'));&nbsp;</div></li><li><div>        add_action(&quot;admin_print_scripts-$hook&quot;, array(&$this, 'admin_js'));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function print_page_icon_style()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        echo &lt;&lt;&lt;HTML&nbsp;</div></li><li><div>&lt;style&gt;&nbsp;</div></li><li><div>ul#adminmenu li.toplevel_page_bp-moderation .wp-menu-image {&nbsp;</div></li><li><div>    background-image: url('{$this-&gt;plugin_url}/css/sprite.png');&nbsp;</div></li><li><div>    background-position: 6px 5px;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>ul#adminmenu li.toplevel_page_bp-moderation:hover .wp-menu-image, &nbsp;</div></li><li><div>ul#adminmenu li.toplevel_page_bp-moderation.current .wp-menu-image {&nbsp;</div></li><li><div>    background-position: 6px -61px;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&lt;/style&gt;&nbsp;</div></li><li><div>HTML;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add info on moderation queue in the rightnow widget&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function rightnow_widget_section()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!is_super_admin()) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = __('BP Moderation: ', 'bp-moderation');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT COUNT(*) FROM {$this-&gt;contents_table}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($awating = (int)$wpdb-&gt;get_var(&quot;$sql WHERE status IN ('new', 'warned')&quot;)) {&nbsp;</div></li><li><div>            $link = 'admin.php?page=bp-moderation&view=contents&filters[active_filters][status]=on&filters[status][new]=on&filters[status][warned]=on&order[0][by]=last_flag&order[0][dir]=DESC&per_page=20&submit=1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $text .= sprintf(_n(&nbsp;</div></li><li><div>                    '&lt;a href=&quot;%1$s&quot;&gt;%2$d content&lt;/a&gt; is awaiting your moderation', &nbsp;</div></li><li><div>                    '&lt;a href=&quot;%1$s&quot;&gt;%2$d contents&lt;/a&gt; are awaiting your moderation', &nbsp;</div></li><li><div>                    $awating, 'bp-moderation'), $link, $awating&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($warned = (int)$wpdb-&gt;get_var(&quot;$sql WHERE status = 'warned'&quot;)) {&nbsp;</div></li><li><div>                $link = 'admin.php?page=bp-moderation&view=contents&filters[active_filters][status]=on&filters[status][warned]=on&order[0][by]=last_flag&order[0][dir]=DESC&per_page=20&submit=1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $text .= sprintf(_n(&nbsp;</div></li><li><div>                        ' and the owner of &lt;a href=&quot;%1$s&quot;&gt;%2$d of them&lt;/a&gt; has already been warned', &nbsp;</div></li><li><div>                        ' and the owners of &lt;a href=&quot;%1$s&quot;&gt;%2$d of them&lt;/a&gt; have already been warned', &nbsp;</div></li><li><div>                        $warned, 'bp-moderation'), $link, $warned&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $text .= '.';&nbsp;</div></li><li><div>        } elseif ($total = (int)$wpdb-&gt;get_var($sql)) {&nbsp;</div></li><li><div>            $link = 'admin.php?page=bp-moderation&view=contents';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $text .= sprintf(_n(&nbsp;</div></li><li><div>                    'there are no contents awaiting your moderation, &lt;a href=&quot;%1$s&quot;&gt;%2$d reported content&lt;/a&gt; has already been viewed.', &nbsp;</div></li><li><div>                    'there are no contents awaiting your moderation, &lt;a href=&quot;%1$s&quot;&gt;%2$d reported contents&lt;/a&gt; have already been viewed.', &nbsp;</div></li><li><div>                    $total, 'bp-moderation'), $link, $total&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $text .= __('no content has ever been reported.', 'bp-moderation');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;p class='bp-mod-right-now'&gt;$text&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * enqueues style&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_css()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        wp_enqueue_style('bpmod-admin', $this-&gt;plugin_url . '/css/bpmod-admin.css', false, $this-&gt;plugin_ver, 'screen');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * enqueues styles&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_js()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        wp_enqueue_script('bpmod-admin', $this-&gt;plugin_url . '/js/bpmod-admin.js', array('jquery'), $this-&gt;plugin_ver, !'in footer');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //hotkeys script&nbsp;</div></li><li><div>        if ((empty($_GET['view']) || 'contents' == $_GET['view'] || 'users' == $_GET['view'])&nbsp;</div></li><li><div>            && get_user_option('bp_moderation_hotkeys')&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            wp_enqueue_script('jquery-table-hotkeys');&nbsp;</div></li><li><div>            wp_localize_script('bpmod-admin', 'adminBPModL10n', array(&nbsp;</div></li><li><div>                'hotkeys_highlight_first' =&gt; isset($_GET['hotkeys_highlight_first']), &nbsp;</div></li><li><div>                'hotkeys_highlight_last' =&gt; isset($_GET['hotkeys_highlight_last'])&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print admin pages&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * print common parts of admin pages and call the function for printing current view&nbsp;</div></li><li><div>     * (specified by $_GET['view'], default is 'contents' view)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function admin_page()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!is_super_admin()) {&nbsp;</div></li><li><div>            wp_die(__('Cheatin&#8217; uh?'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;div class='wrap'&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $views = array(&nbsp;</div></li><li><div>            'contents' =&gt; __('Contents', 'bp-moderation'), &nbsp;</div></li><li><div>            'users' =&gt; __('Users', 'bp-moderation'), &nbsp;</div></li><li><div>            'settings' =&gt; __('Settings', 'bp-moderation')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $defview = 'contents';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $view = (!empty($_GET['view']) && in_array($_GET['view'], array_keys($views)))&nbsp;</div></li><li><div>            ? $_GET['view'] : $defview;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $h2 = '&lt;h2 class=&quot;nav-tab-wrapper&quot;&gt;&lt;span style=&quot;margin-right:.5em;&quot;&gt;' . __('BP Moderation', 'bp-moderation') . '&lt;/span&gt;';&nbsp;</div></li><li><div>        foreach ($views as $_view =&gt; $title) {&nbsp;</div></li><li><div>            $current = ($_view == $view) ? ' nav-tab-active' : '';&nbsp;</div></li><li><div>            $h2 .= &quot;&lt;a href='admin.php?page=bp-moderation&amp;view=$_view' class='nav-tab$current'&gt;$title&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $h2 .= &quot;&lt;/h2&gt;\n&quot;;&nbsp;</div></li><li><div>        echo $h2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $messagges_strings = array(&nbsp;</div></li><li><div>            'marked_spammer' =&gt; _n_noop('%s has been marked as spammer.', '%d members have been marked as spammers.'), &nbsp;</div></li><li><div>            'unmarked_spammer' =&gt; _n_noop('%s has been marked as not spammer.', '%d members have been marked as not spammers.'), &nbsp;</div></li><li><div>            'content_ignored' =&gt; _n_noop('%d item has been ignored.', '%d items have been ignored.'), &nbsp;</div></li><li><div>            'content_moderated' =&gt; _n_noop('%d item has been marked as moderated.', '%d items have been marked as moderated.'), &nbsp;</div></li><li><div>            'content_deleted' =&gt; _n_noop('%d item has been deleted.', '%d items have been deleted.'), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($messagges_strings as $arg_key =&gt; $tr) {&nbsp;</div></li><li><div>            if (isset($_GET[$arg_key])) {&nbsp;</div></li><li><div>                $message = is_numeric($_GET[$arg_key])&nbsp;</div></li><li><div>                    ? _n($tr[0], $tr[1], $_GET[$arg_key], 'bp-moderation')&nbsp;</div></li><li><div>                    : $tr[0];&nbsp;</div></li><li><div>                $message = sprintf($message, $_GET[$arg_key]);&nbsp;</div></li><li><div>                if (isset($_GET['err_ids'])) {&nbsp;</div></li><li><div>                    $message .= '&lt;br/&gt;' . sprintf(__('Operation failed on these items: %s'), $_GET['err_ids']);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if (isset($_GET['err_msg'])) {&nbsp;</div></li><li><div>                    $message .= '&lt;br/&gt;' . $_GET['err_msg'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (!empty($message)) {&nbsp;</div></li><li><div>            echo '&lt;div id=&quot;moderated&quot; class=&quot;updated&quot;&gt;&lt;p&gt;' . $message . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        call_user_func(array(&$this, &quot;view_$view&quot;));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &quot;&lt;/div&gt; &lt;!-- .wrap --&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print contents view (custom query + contents table)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function view_contents()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $chk = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>        $sel = ' selected=&quot;selected&quot;';&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;form id=&quot;bpmod-contents-query&quot; class=&quot;bpmod-form-query&quot; action=&quot;admin.php&quot;&nbsp;</div></li><li><div>              method=&quot;get&quot;&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;hidden&quot; name=&quot;page&quot; value=&quot;bp-moderation&quot;/&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;hidden&quot; name=&quot;view&quot; value=&quot;contents&quot;/&gt;&nbsp;</div></li><li><div>            &lt;fieldset&gt;&nbsp;</div></li><li><div>                &lt;legend&gt;&lt;?php _e('Custom Query', 'bp-moderation') ?&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;column&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e('Filters', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-item_type' &lt;?php echo isset($_GET['filters']['active_filters']['item_type'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='filters[active_filters][item_type]'&nbsp;</div></li><li><div>                            type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-item_type'&gt;&lt;?php _e('Content types', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;ul&gt;&nbsp;</div></li><li><div>                            &lt;?php foreach ($this-&gt;content_types as $slug =&gt; $ct) : ?&gt;&nbsp;</div></li><li><div>                                &lt;li&gt;&lt;input&nbsp;</div></li><li><div>                                        id='type_&lt;?php echo $slug ?&gt;'&lt;?php echo isset($_GET['filters']['item_type'][$slug])&nbsp;</div></li><li><div>                                        ? $chk : ''&nbsp;</div></li><li><div>                                    ?&gt; name='filters[item_type][&lt;?php echo $slug ?&gt;]'&nbsp;</div></li><li><div>                                        type='checkbox'/&gt;&nbsp;</div></li><li><div>                                    &lt;label&nbsp;</div></li><li><div>                                        for='type_&lt;?php echo $slug ?&gt;'&gt;&lt;?php echo $ct-&gt;label ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                                &lt;/li&gt;&nbsp;</div></li><li><div>                            &lt;?php endforeach ?&gt;&nbsp;</div></li><li><div>                        &lt;/ul&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-status' &lt;?php echo isset($_GET['filters']['active_filters']['status'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='filters[active_filters][status]'&nbsp;</div></li><li><div>                            type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-status'&gt;&lt;?php _e('Status', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;ul&gt;&nbsp;</div></li><li><div>                            &lt;?php foreach ($this-&gt;content_stati as $slug =&gt; $label) : ?&gt;&nbsp;</div></li><li><div>                                &lt;li&gt;&lt;input&nbsp;</div></li><li><div>                                        id=&quot;&lt;?php echo $slug ?&gt;&quot;&lt;?php echo isset($_GET['filters']['status'][$slug])&nbsp;</div></li><li><div>                                        ? $chk : ''&nbsp;</div></li><li><div>                                    ?&gt; name=&quot;filters[status][&lt;?php echo $slug ?&gt;]&quot;&nbsp;</div></li><li><div>                                        type=&quot;checkbox&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;label&nbsp;</div></li><li><div>                                        for=&quot;&lt;?php echo $slug ?&gt;&quot;&gt;&lt;?php echo $label ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                                &lt;/li&gt;&nbsp;</div></li><li><div>                            &lt;?php endforeach ?&gt;&nbsp;</div></li><li><div>                        &lt;/ul&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-flags' &lt;?php echo isset($_GET['filters']['active_filters']['flags'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='filters[active_filters][flags]'&nbsp;</div></li><li><div>                            type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-flags'&gt;&lt;?php _e('Times reported', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;label for='flags'&gt;&lt;?php&nbsp;</div></li><li><div>                            $input = &quot;&lt;input id='flags' size='4' type='text' name='filters[flags]' value='&quot; . (empty($_GET['filters']['flags'])&nbsp;</div></li><li><div>                                    ? '0' : $_GET['filters']['flags']) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>                            echo sprintf(__('Reported at least %s times', 'bp-moderation'), $input); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-item_author' &lt;?php echo isset($_GET['filters']['active_filters']['item_author'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='filters[active_filters][item_author]'&nbsp;</div></li><li><div>                            type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-item_author'&gt;&lt;?php _e('Content posted by', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;input id='item_author' class='line' size='40' type='text'&nbsp;</div></li><li><div>                               name='filters[item_author]' value='&lt;?php&nbsp;</div></li><li><div>                        echo empty($_GET['filters']['item_author']) ? ''&nbsp;</div></li><li><div>                            : $_GET['filters']['item_author'] ?&gt;'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='item_author'&gt;&lt;?php _e('User ids (comma separeted)', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-reporters' &lt;?php echo isset($_GET['filters']['active_filters']['reporters'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='filters[active_filters][reporters]'&nbsp;</div></li><li><div>                            type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-reporters'&gt;&lt;?php _e('Content reported by', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;input id='reporters' class='line' size='40' type='text'&nbsp;</div></li><li><div>                               name='filters[reporters]' value='&lt;?php&nbsp;</div></li><li><div>                        echo empty($_GET['filters']['reporters']) ? ''&nbsp;</div></li><li><div>                            : $_GET['filters']['reporters'] ?&gt;'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='reporters'&gt;&lt;?php _e('User ids (comma separeted)', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;column&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4 class=&quot;order-by&quot;&gt;&lt;?php _e('Order', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;ol class=&quot;order-by&quot;&gt;&nbsp;</div></li><li><div>                        &lt;?php            $i = 0;&nbsp;</div></li><li><div>                        while (0 == $i || !empty($_GET['order'][$i])) :&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;li&gt;&lt;?php _e('Order by', 'bp-moderation');&nbsp;</div></li><li><div>                                $orby = empty($_GET['order'][$i]['by']) ? 'none'&nbsp;</div></li><li><div>                                    : $_GET['order'][$i]['by'];&nbsp;</div></li><li><div>                                $asc = 'DESC' == @$_GET['order'][$i]['dir'] ? 'DESC'&nbsp;</div></li><li><div>                                        : 'ASC'; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;select name=&quot;order[&lt;?php echo $i ?&gt;][by]&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('none', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;none&quot;&gt;&lt;?php _e('none', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('flags', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;flags&quot;&gt;&lt;?php _e('times reported', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('first_flag', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;first_flag&quot;&gt;&lt;?php _e('first time reported', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('last_flag', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;last_flag&quot;&gt;&lt;?php _e('last time reported', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('item_id', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;item_id&quot;&gt;&lt;?php _e('item id', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('item_id2', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;item_id2&quot;&gt;&lt;?php _e('secondary id', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;select name=&quot;order[&lt;?php echo $i ?&gt;][dir]&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('ASC', $asc) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;ASC&quot;&gt;ASC&nbsp;</div></li><li><div>                                    &lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('DESC', $asc) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;DESC&quot;&gt;DESC&nbsp;</div></li><li><div>                                    &lt;/option&gt;&nbsp;</div></li><li><div>                                &lt;/select&gt;&nbsp;</div></li><li><div>                            &lt;/li&gt;&nbsp;</div></li><li><div>                            &lt;?php            $i++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/ol&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e('Limit', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;label for='limit'&gt;&lt;?php&nbsp;</div></li><li><div>                            $input = &quot;&lt;input id='limit' size='4' type='text' name='per_page' value='&quot; . (empty($_GET['per_page'])&nbsp;</div></li><li><div>                                    ? '20' : $_GET['per_page']) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>                            echo sprintf(__('Display at most %s contents', 'bp-moderation'), $input); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;input name=&quot;submit&quot; type=&quot;submit&quot; class=&quot;button-primary&quot;&nbsp;</div></li><li><div>                           value=&quot;&lt;?php _e('Query Contents', 'bp-moderation'); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/fieldset&gt;&nbsp;</div></li><li><div>        &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        extract($this-&gt;query_contents());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($total) {&nbsp;</div></li><li><div>            $page_links = paginate_links(array(&nbsp;</div></li><li><div>                'base' =&gt; add_query_arg('cpage', '%#%'), &nbsp;</div></li><li><div>                'format' =&gt; '', &nbsp;</div></li><li><div>                'prev_text' =&gt; __('&laquo;'), &nbsp;</div></li><li><div>                'next_text' =&gt; __('&raquo;'), &nbsp;</div></li><li><div>                'total' =&gt; ceil($total / $per_page), &nbsp;</div></li><li><div>                'current' =&gt; $page_index + 1&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;form id=&quot;bpmod-contents-form&quot; class=&quot;bpmod-bulk-form&quot;&nbsp;</div></li><li><div>                  action=&quot;admin.php&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>                        &lt;select name=&quot;bulk-action&quot;&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;-1&quot;&nbsp;</div></li><li><div>                                    selected=&quot;selected&quot;&gt;&lt;?php _e('Bulk Actions', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;ignore&quot;&gt;&lt;?php _e('Ignore', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;mark_moderated&quot;&gt;&lt;?php _e('Mark as moderated', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;delete&quot;&gt;&lt;?php _e('Delete', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;mark_spammer&quot;&gt;&lt;?php _e('Mark authors as spammers', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;unmark_spammer&quot;&gt;&lt;?php _e('Mark authors as not spammers', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;!--&lt;option value=&quot;authors_in_user_view&quot;&gt;&lt;?php _e('View authors in users view', 'bp-moderation'); ?&gt;&lt;/option&gt;--&gt;&nbsp;</div></li><li><div>                        &lt;/select&gt;&nbsp;</div></li><li><div>                        &lt;input type=&quot;hidden&quot; name=&quot;bpmod-action&quot;&nbsp;</div></li><li><div>                               value=&quot;bulk_contents&quot;/&gt;&nbsp;</div></li><li><div>                        &lt;?php wp_nonce_field('bulk_contents'); ?&gt;&nbsp;</div></li><li><div>                        &lt;input type=&quot;submit&quot; name=&quot;doaction&quot; id=&quot;doaction&quot;&nbsp;</div></li><li><div>                               value=&quot;&lt;?php esc_attr_e('Apply', 'bp-moderation'); ?&gt;&quot;&nbsp;</div></li><li><div>                               class=&quot;button-secondary apply&quot;/&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;tablenav-pages&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                        if ($page_links) {&nbsp;</div></li><li><div>                            echo '&lt;span class=&quot;displaying-num&quot;&gt;' .&nbsp;</div></li><li><div>                                sprintf(__('Displaying %s&#8211;%s of %s', 'bp-moderation'), &nbsp;</div></li><li><div>                                    number_format_i18n($page_index * $per_page + 1), &nbsp;</div></li><li><div>                                    number_format_i18n(min(($page_index + 1) * $per_page, $total)), &nbsp;</div></li><li><div>                                    '&lt;span class=&quot;total-type-count&quot;&gt;' . number_format_i18n($total) . '&lt;/span&gt;')&nbsp;</div></li><li><div>                                . &quot;&lt;/span&gt;$page_links&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;table id=&quot;bpmod-contents-table&quot; class=&quot;widefat bpmod-table fixed&quot;&nbsp;</div></li><li><div>                       cellspacing=&quot;0&quot;&gt;&nbsp;</div></li><li><div>                    &lt;thead&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-cb check-column&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-author&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Author', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-content&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Content', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-flags&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Flags', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;/thead&gt;&nbsp;</div></li><li><div>                    &lt;tfoot&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-cb check-column&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-author&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Author', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-content&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Content', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-flags&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Flags', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    foreach ($results as $content) :&nbsp;</div></li><li><div>                        $ctype = isset($this-&gt;content_types[$content-&gt;item_type])&nbsp;</div></li><li><div>                            ? $this-&gt;content_types[$content-&gt;item_type] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $content = apply_filters(&quot;bp_moderation_filter_content_backend_for_$content-&gt;item_type&quot;, $content);&nbsp;</div></li><li><div>                        $author = $this-&gt;author_details($content-&gt;item_author, $content);&nbsp;</div></li><li><div>                        $reporters = join(', ', array_map(array(&$this, 'show_in_users_table_link'), explode(', ', $content-&gt;reporters)));&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr class=&quot;status-&lt;?php echo $content-&gt;status ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                            &lt;th class=&quot;check-column&quot;&nbsp;</div></li><li><div>                                scope=&quot;row&quot;&gt;&lt;input&nbsp;</div></li><li><div>                                    type=&quot;checkbox&quot;&nbsp;</div></li><li><div>                                    value=&quot;&lt;?php echo $content-&gt;content_id ?&gt;&quot;&nbsp;</div></li><li><div>                                    name=&quot;bulk_items[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-author&quot;&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php echo $author['avatar_img'] . $author['user_link'] ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                &lt;br&gt;&lt;?php echo $author['contact_link'] ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php        if ($content-&gt;item_author && get_userdata($content-&gt;item_author)):&nbsp;</div></li><li><div>                                        if (bp_is_user_spammer($content-&gt;item_author)): ?&gt;&nbsp;</div></li><li><div>                                            &lt;a class=&quot;unmark-spammer vim-u&quot;&nbsp;</div></li><li><div>                                               href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=mark_unmark_spammer&user_id=$content-&gt;item_author&set_spam=0&quot;, 'mark_unmark_spammer') ?&gt;&quot;&nbsp;</div></li><li><div>                                               title=&quot;&lt;?php _e('Mark the author of this content as not spammer', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Mark as not spammer', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                        &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                                            &lt;a class=&quot;mark-spammer vim-s&quot;&nbsp;</div></li><li><div>                                               href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=mark_unmark_spammer&user_id=$content-&gt;item_author&set_spam=1&quot;, 'mark_unmark_spammer') ?&gt;&quot;&nbsp;</div></li><li><div>                                               title=&quot;&lt;?php _e('Mark the author of this content as spammer', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Mark as spammer', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                        &lt;?php            endif; elseif ($content-&gt;item_author): ?&gt;&nbsp;</div></li><li><div>                                        &lt;span&nbsp;</div></li><li><div>                                            class=&quot;not-a-member&quot;&gt;&lt;?php _e('Unregistered', 'bp-moderation') ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                                    &lt;?php else: ?&gt;&nbsp;</div></li><li><div>                                        &lt;span&nbsp;</div></li><li><div>                                            class=&quot;not-a-member&quot;&gt;&lt;?php _e('Not a member', 'bp-moderation') ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                                    &lt;?php        endif; ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-content&quot;&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Status:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $this-&gt;content_stati[$content-&gt;status]&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Type:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $ctype&nbsp;</div></li><li><div>                                    ? $ctype-&gt;label&nbsp;</div></li><li><div>                                    : $content-&gt;item_type . ' (' . __('not found', 'bp-moderation') . ')';&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Item ID:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $content-&gt;item_id . ($content-&gt;item_id2&nbsp;</div></li><li><div>                                        ? ' - ' . $content-&gt;item_id2&nbsp;</div></li><li><div>                                        : '')&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Date:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $this-&gt;date_abbr($content-&gt;item_date) ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;a class=&quot;view-content vim-v&quot;&nbsp;</div></li><li><div>                                       href=&quot;&lt;?php echo $content-&gt;item_url ?&gt;&quot;&nbsp;</div></li><li><div>                                       title=&quot;&lt;?php _e('View this content', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('View', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php if ('ignored' != $content-&gt;status): ?&gt;&nbsp;</div></li><li><div>                                        | &lt;a&nbsp;</div></li><li><div>                                            class=&quot;ignore-content vim-a&quot;&nbsp;</div></li><li><div>                                            href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=ignore&cont_id=$content-&gt;content_id&quot;, 'ignore') ?&gt;&quot;&nbsp;</div></li><li><div>                                            title=&quot;&lt;?php _e('Mark this content as clean', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Ignore', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php            endif;&nbsp;</div></li><li><div>                                    if ($ctype && $ctype-&gt;callbacks['edit'] && 'deleted' != $content-&gt;status): ?&gt;&nbsp;</div></li><li><div>                                        | &lt;a&nbsp;</div></li><li><div>                                            class=&quot;edit-content vim-e&quot;&nbsp;</div></li><li><div>                                            href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=edit&cont_id=$content-&gt;content_id&quot;, 'edit') ?&gt;&quot;&nbsp;</div></li><li><div>                                            title=&quot;&lt;?php _e('Link to the edit page for this content', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Edit', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php            endif;&nbsp;</div></li><li><div>                                    if ('deleted' != $content-&gt;status && 'moderated' != $content-&gt;status): ?&gt;&nbsp;</div></li><li><div>                                        | &lt;a&nbsp;</div></li><li><div>                                            class=&quot;mark-moderated vim-m&quot;&nbsp;</div></li><li><div>                                            href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=mark_moderated&cont_id=$content-&gt;content_id&quot;, 'mark_moderated') ?&gt;&quot;&nbsp;</div></li><li><div>                                            title=&quot;&lt;?php _e('Manually mark this content as moderated if it has already been edited/deleted without this plugin', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Mark as moderated', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php            endif;&nbsp;</div></li><li><div>                                    if ($ctype && $ctype-&gt;callbacks['delete'] && 'deleted' != $content-&gt;status): ?&gt;&nbsp;</div></li><li><div>                                        | &lt;a&nbsp;</div></li><li><div>                                            class=&quot;delete-content vim-d&quot;&nbsp;</div></li><li><div>                                            href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=delete&cont_id=$content-&gt;content_id&quot;, 'delete') ?&gt;&quot;&nbsp;</div></li><li><div>                                            title=&quot;&lt;?php _e('Delete this content', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Delete', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-flags&quot;&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Flags:', 'bp-moderation') ?&gt;&lt;/strong&gt;  &lt;?php echo $content-&gt;flags&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('First:', 'bp-moderation') ?&gt;&lt;/strong&gt;  &lt;?php echo $this-&gt;date_abbr($content-&gt;first_flag)&nbsp;</div></li><li><div>                                ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e('Last:', 'bp-moderation') ?&gt;&lt;/strong&gt;  &lt;?php echo $this-&gt;date_abbr($content-&gt;last_flag) ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;br/&gt;&lt;strong&gt;&lt;?php _e('Reporters:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $reporters ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    endforeach;&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;/tbody&gt;&nbsp;</div></li><li><div>                &lt;/table&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php $this-&gt;print_hotkeys_toggle(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            _e('No content to display, try a different search', 'bp-moderation');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * build html tags of contents author details (avatar, webpage, contact)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $uid user id if known or 0&nbsp;</div></li><li><div>     * @param stdClass $content if in content view the current content is passed&nbsp;</div></li><li><div>     * @return array avatar_img, user_link, contact_link: &lt;img&gt;avatar, &lt;a&gt;webpage, &lt;a&gt;contact&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function author_details($uid, $content = false)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if ($uid && $user = get_userdata($uid)) { //id refers to an existing user&nbsp;</div></li><li><div>            $details = array(&nbsp;</div></li><li><div>                'avatar_img' =&gt; '&lt;a href=&quot;' . bp_core_get_user_domain($uid) . '&quot; &gt;' . bp_core_fetch_avatar(array('item_id' =&gt; $uid, 'width' =&gt; 32, 'height' =&gt; 32)) . '&lt;/a&gt;', &nbsp;</div></li><li><div>                'user_link' =&gt; $content ? $this-&gt;show_in_users_table_link($uid)&nbsp;</div></li><li><div>                    : bp_core_get_userlink($uid), &nbsp;</div></li><li><div>                'contact_link' =&gt; bp_is_active('messages') ?&nbsp;</div></li><li><div>                    '&lt;a class=&quot;vim-c&quot; href=&quot;' . bp_loggedin_user_domain() . $GLOBALS['bp']-&gt;messages-&gt;slug . '/compose/?r=' . bp_core_get_username($uid) . '&quot; title=&quot;' . __('Send a private message to the author of this content', 'bp-moderation') . '&quot;&gt;' . __('Send PM', 'bp-moderation') . '&lt;/a&gt;'&nbsp;</div></li><li><div>                    : &quot;&lt;a class='vim-c' href='mailto:$user-&gt;user_email' title='&quot; . __('Send an email to the author of this content', 'bp-moderation') . &quot;' &gt;&quot; . __('Send email', 'bp-moderation') . &quot;&lt;/a&gt;&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } elseif ($uid) { // the user has probably already been deleted&nbsp;</div></li><li><div>            $details = array(&nbsp;</div></li><li><div>                'avatar_img' =&gt; get_avatar('', 32, 'mystery'), &nbsp;</div></li><li><div>                'user_link' =&gt; $content ? $this-&gt;show_in_users_table_link($uid)&nbsp;</div></li><li><div>                    : sprintf(__('User #%d', 'bp-moderation'), $uid), &nbsp;</div></li><li><div>                'contact_link' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $details = array(&nbsp;</div></li><li><div>                'avatar_img' =&gt; '', &nbsp;</div></li><li><div>                'user_link' =&gt; '', &nbsp;</div></li><li><div>                'contact_link' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            // if some content types have non members authors they can add missing details hooking to this filter (e.g. blog comments)&nbsp;</div></li><li><div>            $details = apply_filters(&quot;bp_moderation_author_details_for_$content-&gt;item_type&quot;, $details, $content);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $details;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * generate the links to see info about an user in the user view&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $uid user id&nbsp;</div></li><li><div>     * @return string &lt;a&gt; tag with webpage&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function show_in_users_table_link($uid)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $username = bp_core_get_user_displayname($uid);&nbsp;</div></li><li><div>        $title = $username&nbsp;</div></li><li><div>            ? __('See more details on this user in the users table', 'bp-moderation')&nbsp;</div></li><li><div>            : __('This user is not registered anymore, but you can still see some details on it in the users table', 'bp-moderation');&nbsp;</div></li><li><div>        if (!$username) {&nbsp;</div></li><li><div>            $username = sprintf(__('User #%d', 'bp-moderation'), $uid);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return &quot;&lt;a href='admin.php?page=bp-moderation&amp;view=users&amp;filters[active_filters][user]=on&amp;filters[user]=$uid' title='$title'&gt;$username&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * format a mysql date in an &lt;abbr&gt; tag&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * follow blog option for date format but has complete date and time in tooltip&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $date mysql date&nbsp;</div></li><li><div>     * @return string &lt;abbr&gt; tag with the date&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function date_abbr($date)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        return '&lt;abbr title=&quot;' . mysql2date('Y-m-d\TH:i:sO', $date) . '&quot;&gt;' . mysql2date(get_option('date_format'), $date) . '&lt;/abbr&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print the hotkeys enable/disable link&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function print_hotkeys_toggle()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (get_user_option('bp_moderation_hotkeys')) {&nbsp;</div></li><li><div>            $text = sprintf(__('Hotkeys are enabled. &lt;a href=&quot;%s&quot;&gt;Disable&lt;/a&gt;'), wp_nonce_url('admin.php?bpmod-action=hotkeys&set_hotkeys=0', 'hotkeys'));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $text = sprintf(__('Hotkeys are disabled. &lt;a href=&quot;%s&quot;&gt;Enable&lt;/a&gt;'), wp_nonce_url('admin.php?bpmod-action=hotkeys&set_hotkeys=1', 'hotkeys'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        echo &quot;&lt;p id='hotkeys-toggle'&gt;$text&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Query the contents for the contents page based on get vars&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * TODO: reformat in more functions (parse get vars, do the query)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array total, results&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function query_contents()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = 'WHERE 1';&nbsp;</div></li><li><div>        $having = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //filters&nbsp;</div></li><li><div>        $can_filter = array('item_type', 'status', 'item_author', 'reporters', 'flags');&nbsp;</div></li><li><div>        if (isset($_GET['filters']['active_filters']) && is_array($_GET['filters']['active_filters'])) {&nbsp;</div></li><li><div>            $filters = array_intersect(array_keys($_GET['filters']['active_filters']), $can_filter);&nbsp;</div></li><li><div>            foreach ($filters as $f) {&nbsp;</div></li><li><div>                if (empty($_GET['filters'][$f])) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $val = $_GET['filters'][$f];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ($f) {&nbsp;</div></li><li><div>                    case 'item_type':&nbsp;</div></li><li><div>                    case 'status':&nbsp;</div></li><li><div>                        if (!is_array($val)) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $values = array_keys($val);&nbsp;</div></li><li><div>                        array_walk($values, array(&$wpdb, 'escape_by_ref'));&nbsp;</div></li><li><div>                        $where .= &quot; AND $f IN ('&quot; . join(&quot;', '&quot;, $values) . &quot;')&quot;;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'item_author':&nbsp;</div></li><li><div>                        $authors = join(', ', array_filter(array_map('intval', explode(', ', $val))));&nbsp;</div></li><li><div>                        if ($authors) {&nbsp;</div></li><li><div>                            $where .= &quot; AND item_author IN (&quot; . $authors . &quot;)&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'reporters':&nbsp;</div></li><li><div>                        // TODO: check efficienty of this&nbsp;</div></li><li><div>                        $reporters = join(', ', array_filter(array_map('intval', explode(', ', $val))));&nbsp;</div></li><li><div>                        if ($reporters) {&nbsp;</div></li><li><div>                            $where .= &quot; AND content_id IN (SELECT content_id FROM {$this-&gt;flags_table} WHERE reporter_id IN (&quot; . $reporters . &quot;) )&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'flags':&nbsp;</div></li><li><div>                        $having .= &quot; AND COUNT(*) &gt;= &quot; . (int)$val;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //order&nbsp;</div></li><li><div>        $can_order = array('item_id', 'item_id2', 'flags', 'first_flag', 'last_flag');&nbsp;</div></li><li><div>        $orders = array();&nbsp;</div></li><li><div>        if (isset($_GET['order']) && is_array($_GET['order'])) {&nbsp;</div></li><li><div>            foreach ($_GET['order'] as $o) {&nbsp;</div></li><li><div>                if (!isset($o['by']) || !in_array($o['by'], $can_order)&nbsp;</div></li><li><div>                    || !isset($o['dir'])&nbsp;</div></li><li><div>                    || ('ASC' != $o['dir'] && 'DESC' != $o['dir'])&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $orders[] = $o['by'] . ' ' . $o['dir'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (count($orders)) {&nbsp;</div></li><li><div>            $order = 'ORDER BY ' . join(', ', $orders);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $order = 'ORDER BY last_flag DESC';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //limits&nbsp;</div></li><li><div>        $per_page = (isset($_GET['per_page']) && intval($_GET['per_page']))&nbsp;</div></li><li><div>            ? intval($_GET['per_page']) : 20;&nbsp;</div></li><li><div>        $page_index = (isset($_GET['cpage']) && intval($_GET['cpage']))&nbsp;</div></li><li><div>            ? intval($_GET['cpage']) - 1 : 0;&nbsp;</div></li><li><div>        $limits = 'LIMIT ' . ($page_index * $per_page) . ', ' . $per_page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $from = &quot;FROM {$this-&gt;contents_table} c NATURAL JOIN {$this-&gt;flags_table} f&quot;;&nbsp;</div></li><li><div>        $groupby = 'GROUP BY content_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($having) {&nbsp;</div></li><li><div>            $having = 'HAVING 1' . $having;&nbsp;</div></li><li><div>            $sql = &quot;SELECT content_id $from $where $groupby $having&quot;;&nbsp;</div></li><li><div>            $total = count($wpdb-&gt;get_results($sql));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sql = &quot;SELECT COUNT(*) FROM {$this-&gt;contents_table} c $where&quot;;&nbsp;</div></li><li><div>            $total = (int)$wpdb-&gt;get_var($sql);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($total) {&nbsp;</div></li><li><div>            $sql = &quot;SELECT content_id, c.*, COUNT(*) as flags, GROUP_CONCAT(CAST( f.reporter_id AS CHAR )) as reporters, MIN(f.date) as first_flag, MAX(f.date) as last_flag $from $where $groupby $having $order $limits&quot;;&nbsp;</div></li><li><div>            $results = $wpdb-&gt;get_results($sql);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $results = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('results' =&gt; $results, 'total' =&gt; $total, 'per_page' =&gt; $per_page, 'page_index' =&gt; $page_index);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print users view (custom query + contents table)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function view_users()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $chk = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>        $sel = ' selected=&quot;selected&quot;';&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;form id=&quot;bpmod-users-query&quot; class=&quot;bpmod-form-query&quot; action=&quot;admin.php&quot;&nbsp;</div></li><li><div>              method=&quot;get&quot;&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;hidden&quot; name=&quot;page&quot; value=&quot;bp-moderation&quot;/&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;hidden&quot; name=&quot;view&quot; value=&quot;users&quot;/&gt;&nbsp;</div></li><li><div>            &lt;fieldset&gt;&nbsp;</div></li><li><div>                &lt;legend&gt;&lt;?php _e('Custom Query', 'bp-moderation') ?&gt;&lt;/legend&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;column&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e('Filters', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;dt&gt;&nbsp;</div></li><li><div>                        &lt;input&nbsp;</div></li><li><div>                            id='filter-user' &lt;?php echo isset($_GET['active_filters']['user'])&nbsp;</div></li><li><div>                            ? $chk : ''&nbsp;</div></li><li><div>                        ?&gt; name='active_filters[user]' type='checkbox'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='filter-user'&gt;&lt;?php _e('Specific users', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dt&gt;&nbsp;</div></li><li><div>                    &lt;dd&gt;&nbsp;</div></li><li><div>                        &lt;input id='user' class='line' size='40' type='text'&nbsp;</div></li><li><div>                               name='filters[user]' value='&lt;?php&nbsp;</div></li><li><div>                        echo empty($_GET['filters']['user']) ? ''&nbsp;</div></li><li><div>                            : $_GET['filters']['user'] ?&gt;'/&gt;&nbsp;</div></li><li><div>                        &lt;label&nbsp;</div></li><li><div>                            for='user'&gt;&lt;?php _e('User ids (comma separeted)', 'bp-moderation') ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/dd&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    $filters = array(&nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'own_flags', &nbsp;</div></li><li><div>                            __('Total flags on own contents', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Own contents have been flagged for a total of at least %s flags', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'own_contents', &nbsp;</div></li><li><div>                            __('Total own contents reported', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Own contents have been reported at least %s times', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'own_ignored', &nbsp;</div></li><li><div>                            __('Ignored own contents', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Own contents have been ignored at least %s times', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'own_moderated', &nbsp;</div></li><li><div>                            __('Moderated own contents', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Own contents have been moderated at least %s times', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'others_contents', &nbsp;</div></li><li><div>                            __('Total contents reported by user', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('User has been reported at least %s contents', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'others_ignored', &nbsp;</div></li><li><div>                            __('Ignored contents reported by user', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Contents reported by user have been ignored at least %s times', 'bp-moderation')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'others_moderated', &nbsp;</div></li><li><div>                            __('Moderated contents reported by user', 'bp-moderation'), &nbsp;</div></li><li><div>                            __('Contents reported by user have been moderated at least %s times', 'bp-moderation')&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    foreach ($filters as $filter):&nbsp;</div></li><li><div>                        list($slug, $title, $desc) = $filter;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;dt&gt;&nbsp;</div></li><li><div>                            &lt;input&nbsp;</div></li><li><div>                                id='filter-&lt;?php echo $slug ?&gt;' &lt;?php echo checked('on', @$_GET['active_filters'][$slug])&nbsp;</div></li><li><div>                            ?&gt; name='active_filters[&lt;?php echo $slug ?&gt;]'&nbsp;</div></li><li><div>                                type='checkbox'/&gt;&nbsp;</div></li><li><div>                            &lt;label&nbsp;</div></li><li><div>                                for='filter-&lt;?php echo $slug ?&gt;'&gt;&lt;?php echo $title ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                        &lt;/dt&gt;&nbsp;</div></li><li><div>                        &lt;dd&gt;&nbsp;</div></li><li><div>                            &lt;label&nbsp;</div></li><li><div>                                for='&lt;?php echo $slug ?&gt;'&gt;&lt;?php echo sprintf($desc, &nbsp;</div></li><li><div>                                    &quot;&lt;input id='$slug' size='4' type='text' name='filters[$slug]' value='&quot; . ((int)@$_GET['filters'][$slug]) . &quot;' /&gt;&quot;&nbsp;</div></li><li><div> ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                        &lt;/dd&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;column&quot;&gt;&nbsp;</div></li><li><div>                    &lt;h4 class=&quot;order-by&quot;&gt;&lt;?php _e('Order', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                    &lt;ol class=&quot;order-by&quot;&gt;&nbsp;</div></li><li><div>                        &lt;?php            $i = 0;&nbsp;</div></li><li><div>                        while (0 == $i || !empty($_GET['order'][$i])) :&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;li&gt;&lt;?php _e('Order by', 'bp-moderation');&nbsp;</div></li><li><div>                                $orby = empty($_GET['order'][$i]['by']) ? 'none'&nbsp;</div></li><li><div>                                    : $_GET['order'][$i]['by'];&nbsp;</div></li><li><div>                                $asc = 'DESC' == @$_GET['order'][$i]['dir'] ? 'DESC'&nbsp;</div></li><li><div>                                        : 'ASC'; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                &lt;select name=&quot;order[&lt;?php echo $i ?&gt;][by]&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('none', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;none&quot;&gt;&lt;?php _e('none', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('own_contents', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;own_contents&quot;&gt;&lt;?php _e('total own contents reported', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('own_new', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;own_new&quot;&gt;&lt;?php _e('pending own contents') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('own_ignored', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;own_ignored&quot;&gt;&lt;?php _e('ignored own contents') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('own_moderated', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;own_moderated&quot;&gt;&lt;?php _e('moderated own contents') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('own_flags', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;own_flags&quot;&gt;&lt;?php _e('total flags on own contents') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('others_contents', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;others_contents&quot;&gt;&lt;?php _e('total contents reported by user', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('others_new', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;others_new&quot;&gt;&lt;?php _e('pending contents reported by user', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('others_ignored', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;others_ignored&quot;&gt;&lt;?php _e('ignored contents reported by user', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('others_moderated', $orby) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;others_moderated&quot;&gt;&lt;?php _e('moderated contents reported by user', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                &lt;/select&gt;&nbsp;</div></li><li><div>                                &lt;select name=&quot;order[&lt;?php echo $i ?&gt;][dir]&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('ASC', $asc) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;ASC&quot;&gt;ASC&nbsp;</div></li><li><div>                                    &lt;/option&gt;&nbsp;</div></li><li><div>                                    &lt;option&lt;?php selected('DESC', $asc) ?&gt;&nbsp;</div></li><li><div>                                        value=&quot;DESC&quot;&gt;DESC&nbsp;</div></li><li><div>                                    &lt;/option&gt;&nbsp;</div></li><li><div>                                &lt;/select&gt;&nbsp;</div></li><li><div>                            &lt;/li&gt;&nbsp;</div></li><li><div>                            &lt;?php            $i++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                    &lt;/ol&gt;&nbsp;</div></li><li><div>                    &lt;h4&gt;&lt;?php _e('Limit', 'bp-moderation') ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;label for='limit'&gt;&lt;?php&nbsp;</div></li><li><div>                            $input = &quot;&lt;input id='limit' size='4' type='text' name='per_page' value='&quot; . (empty($_GET['per_page'])&nbsp;</div></li><li><div>                                    ? '20' : $_GET['per_page']) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>                            echo sprintf(__('Display at most %s users', 'bp-moderation'), $input); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;input name=&quot;submit&quot; type=&quot;submit&quot; class=&quot;button-primary&quot;&nbsp;</div></li><li><div>                           value=&quot;&lt;?php _e('Query Users', 'bp-moderation'); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/fieldset&gt;&nbsp;</div></li><li><div>        &lt;/form&gt;&nbsp;</div></li><li><div>        &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        extract($this-&gt;query_users());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($total) {&nbsp;</div></li><li><div>            $page_links = paginate_links(array(&nbsp;</div></li><li><div>                'base' =&gt; add_query_arg('page', '%#%'), &nbsp;</div></li><li><div>                'format' =&gt; '', &nbsp;</div></li><li><div>                'prev_text' =&gt; __('&laquo;'), &nbsp;</div></li><li><div>                'next_text' =&gt; __('&raquo;'), &nbsp;</div></li><li><div>                'total' =&gt; ceil($total / $per_page), &nbsp;</div></li><li><div>                'current' =&gt; $page_index + 1&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;form id=&quot;bpmod-users-form&quot; class=&quot;bpmod-bulk-form&quot; action=&quot;admin.php&quot;&nbsp;</div></li><li><div>                  method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>                        &lt;select name=&quot;bulk-action&quot;&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;-1&quot;&nbsp;</div></li><li><div>                                    selected=&quot;selected&quot;&gt;&lt;?php _e('Bulk Actions', 'bp-moderation') ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;mark_spammer&quot;&gt;&lt;?php _e('Mark users as spammers', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                            &lt;option&nbsp;</div></li><li><div>                                value=&quot;unmark_spammer&quot;&gt;&lt;?php _e('Mark users as not spammers', 'bp-moderation'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;/select&gt;&nbsp;</div></li><li><div>                        &lt;input type=&quot;hidden&quot; name=&quot;bpmod-action&quot;&nbsp;</div></li><li><div>                               value=&quot;bulk_users&quot;/&gt;&nbsp;</div></li><li><div>                        &lt;?php wp_nonce_field('bulk_users'); ?&gt;&nbsp;</div></li><li><div>                        &lt;input type=&quot;submit&quot; name=&quot;doaction&quot; id=&quot;doaction&quot;&nbsp;</div></li><li><div>                               value=&quot;&lt;?php esc_attr_e('Apply', 'bp-moderation'); ?&gt;&quot;&nbsp;</div></li><li><div>                               class=&quot;button-secondary apply&quot;/&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;tablenav-pages&quot;&gt;&lt;?php&nbsp;</div></li><li><div>                        if ($page_links) {&nbsp;</div></li><li><div>                            echo '&lt;span class=&quot;displaying-num&quot;&gt;' .&nbsp;</div></li><li><div>                                sprintf(__('Displaying %s&#8211;%s of %s', 'bp-moderation'), &nbsp;</div></li><li><div>                                    number_format_i18n($page_index * $per_page + 1), &nbsp;</div></li><li><div>                                    number_format_i18n(min(($page_index + 1) * $per_page, $total)), &nbsp;</div></li><li><div>                                    '&lt;span class=&quot;total-type-count&quot;&gt;' . number_format_i18n($total) . '&lt;/span&gt;')&nbsp;</div></li><li><div>                                . &quot;&lt;/span&gt;$page_links&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;table id=&quot;bpmod-users-table&quot; class=&quot;widefat bpmod-table fixed&quot;&nbsp;</div></li><li><div>                       cellspacing=&quot;0&quot;&gt;&nbsp;</div></li><li><div>                    &lt;thead&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-cb check-column&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-author&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('User', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-own-contents&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Own contents reported by others', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-other-contents&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Contents reported by user', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;/thead&gt;&nbsp;</div></li><li><div>                    &lt;tfoot&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-cb check-column&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-author&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('User', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-own-contents&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Own contents reported by others', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;th class=&quot;manage-column column-other-contents&quot;&nbsp;</div></li><li><div>                            scope=&quot;col&quot;&gt;&lt;?php _e('Contents reported by user', 'bp-moderation') ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;/tfoot&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    foreach ($results as $user) :&nbsp;</div></li><li><div>                        $author = $this-&gt;author_details($user-&gt;user_id);&nbsp;</div></li><li><div>                        ?&gt;&nbsp;</div></li><li><div>                        &lt;tr class=&quot;&quot;&gt;&nbsp;</div></li><li><div>                            &lt;th class=&quot;check-column&quot;&nbsp;</div></li><li><div>                                scope=&quot;row&quot;&gt;&lt;input&nbsp;</div></li><li><div>                                    type=&quot;checkbox&quot;&nbsp;</div></li><li><div>                                    value=&quot;&lt;?php echo $user-&gt;user_id ?&gt;&quot;&nbsp;</div></li><li><div>                                    name=&quot;bulk_items[]&quot;&gt;&lt;/th&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-author&quot;&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php echo $author['avatar_img'] . $author['user_link'] ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>                                &lt;br&gt;&lt;?php echo $author['contact_link'] ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;?php if (!get_userdata($user-&gt;user_id)): ?&gt;&nbsp;</div></li><li><div>                                        &lt;span&nbsp;</div></li><li><div>                                            class=&quot;not-a-member&quot;&gt;&lt;?php _e('Unregistered', 'bp-moderation') ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                                    &lt;?php elseif (bp_is_user_spammer($user-&gt;user_id)): ?&gt;&nbsp;</div></li><li><div>                                        &lt;a class=&quot;unmark-spammer vim-u&quot;&nbsp;</div></li><li><div>                                           href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=mark_unmark_spammer&user_id=$user-&gt;user_id&set_spam=0&quot;, 'mark_unmark_spammer') ?&gt;&quot;&nbsp;</div></li><li><div>                                           title=&quot;&lt;?php _e('Mark the author of this content as not spammer', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Mark as not spammer', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php else : ?&gt;&nbsp;</div></li><li><div>                                        &lt;a class=&quot;mark-spammer vim-s&quot;&nbsp;</div></li><li><div>                                           href=&quot;&lt;?php echo wp_nonce_url(&quot;admin.php?bpmod-action=mark_unmark_spammer&user_id=$user-&gt;user_id&set_spam=1&quot;, 'mark_unmark_spammer') ?&gt;&quot;&nbsp;</div></li><li><div>                                           title=&quot;&lt;?php _e('Mark the author of this content as spammer', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Mark as spammer', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                    &lt;?php        endif; ?&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-own-contents&quot;&gt;&nbsp;</div></li><li><div>                                &lt;?php echo sprintf(_n('%d content from this user has been reported', '%d contents from this user have been reported', $user-&gt;own_contents, 'bp-moderation'), $user-&gt;own_contents);&nbsp;</div></li><li><div>                                if ($user-&gt;own_contents):?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('New:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;own_new;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('Ignored:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;own_ignored&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('Moderated:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;own_moderated&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('Total flags:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;own_flags;&nbsp;</div></li><li><div>                                endif; ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;a class=&quot;vim-b&quot;&nbsp;</div></li><li><div>                                       href=&quot;admin.php?page=bp-moderation&amp;view=contents&amp;filters[active_filters][item_author]=on&amp;filters[item_author]=&lt;?php echo $user-&gt;user_id ?&gt;&quot;&nbsp;</div></li><li><div>                                       title=&quot;&lt;?php _e('Show the contents from this user that have been reported in the contents view', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Show in contents view', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td class=&quot;column-other-contents&quot;&gt;&nbsp;</div></li><li><div>                                &lt;?php echo sprintf(_n('this user reported %d content', 'this user reported %d contents', $user-&gt;others_contents, 'bp-moderation'), $user-&gt;others_contents);&nbsp;</div></li><li><div>                                if ($user-&gt;others_contents):?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    &lt;br/&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('New:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;others_new;&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('Ignored:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;others_ignored&nbsp;</div></li><li><div>                                    ?&gt;&nbsp;</div></li><li><div>                                    &lt;strong&gt;&lt;?php _e('Moderated:', 'bp-moderation') ?&gt;&lt;/strong&gt; &lt;?php echo $user-&gt;others_moderated;&nbsp;</div></li><li><div>                                endif; ?&gt;&nbsp;</div></li><li><div>                                &lt;div class=&quot;row-actions&quot;&gt;&nbsp;</div></li><li><div>                                    &lt;a class=&quot;vim-g&quot;&nbsp;</div></li><li><div>                                       href=&quot;admin.php?page=bp-moderation&amp;view=contents&amp;filters[active_filters][reporters]=on&amp;filters[reporters]=&lt;?php echo $user-&gt;user_id ?&gt;&quot;&nbsp;</div></li><li><div>                                       title=&quot;&lt;?php _e('Show the contents from this user that have been reported in the contents view', 'bp-moderation') ?&gt;&quot;&gt;&lt;?php _e('Show in contents view', 'bp-moderation') ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;&nbsp;</div></li><li><div>                    &lt;?php&nbsp;</div></li><li><div>                    endforeach;&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;/tbody&gt;&nbsp;</div></li><li><div>                &lt;/table&gt;&nbsp;</div></li><li><div>            &lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php $this-&gt;print_hotkeys_toggle(); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            _e('No users to display, try a different search', 'bp-moderation');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Query the users for the users table based on get vars&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * TODO: reformat in more functions (parse get vars, do the query)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array total, results&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function query_users()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $own_where = '';&nbsp;</div></li><li><div>        $others_where = '';&nbsp;</div></li><li><div>        $own_having = '';&nbsp;</div></li><li><div>        $others_having = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //filters&nbsp;</div></li><li><div>        $can_filter = array('user', 'own_contents', 'own_ignored', 'own_moderated', 'own_flags', 'others_contents', 'others_ignored', 'others_moderated');&nbsp;</div></li><li><div>        if (isset($_GET['active_filters']) && is_array($_GET['active_filters'])) {&nbsp;</div></li><li><div>            $filters = array_intersect(array_keys($_GET['active_filters']), $can_filter);&nbsp;</div></li><li><div>            foreach ($filters as $f) {&nbsp;</div></li><li><div>                if (empty($_GET['filters'][$f])) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $val = $_GET['filters'][$f];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ($f) {&nbsp;</div></li><li><div>                    case 'user':&nbsp;</div></li><li><div>                        $users = join(', ', array_filter(array_map('intval', explode(', ', $val))));&nbsp;</div></li><li><div>                        if ($users) {&nbsp;</div></li><li><div>                            $own_where = &quot; AND item_author IN ($users)&quot;;&nbsp;</div></li><li><div>                            $others_where = &quot; AND reporter_id IN ($users)&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'own_flags':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $own_having = &quot; AND COUNT(*) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'own_contents':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $own_having = &quot; AND COUNT(DISTINCT content_id) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'own_ignored':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $own_having = &quot; AND COUNT(DISTINCT content_id, IF(c.status='ignored', 1, NULL)) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'own_moderated':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $own_having = &quot; AND COUNT(DISTINCT content_id, IF(c.status IN('edited', 'deleted', 'moderated'), 1, NULL)) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'others_contents':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $others_having = &quot; AND COUNT(DISTINCT content_id) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'others_ignored':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $others_having = &quot; AND COUNT(DISTINCT content_id, IF(c.status='ignored', 1, NULL)) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'others_moderated':&nbsp;</div></li><li><div>                        if ($val = (int)$val) {&nbsp;</div></li><li><div>                            $others_having = &quot; AND COUNT(DISTINCT content_id, IF(c.status IN('edited', 'deleted', 'moderated'), 1, NULL)) &gt;= $val&quot;;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //order&nbsp;</div></li><li><div>        $can_order = array('own_contents', 'own_new', 'own_ignored', 'own_moderated', 'own_flags', 'others_contents', 'others_new', 'others_ignored', 'others_moderated');&nbsp;</div></li><li><div>        $orders = array();&nbsp;</div></li><li><div>        if (isset($_GET['order']) && is_array($_GET['order'])) {&nbsp;</div></li><li><div>            foreach ($_GET['order'] as $o) {&nbsp;</div></li><li><div>                if (!isset($o['by']) || !in_array($o['by'], $can_order)&nbsp;</div></li><li><div>                    || !isset($o['dir'])&nbsp;</div></li><li><div>                    || ('ASC' != $o['dir'] && 'DESC' != $o['dir'])&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $orders[] = $o['by'] . ' ' . $o['dir'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (count($orders)) {&nbsp;</div></li><li><div>            $order = 'ORDER BY ' . join(', ', $orders);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $order = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //limits&nbsp;</div></li><li><div>        $per_page = (isset($_GET['per_page']) && intval($_GET['per_page']))&nbsp;</div></li><li><div>            ? intval($_GET['per_page']) : 20;&nbsp;</div></li><li><div>        $page_index = (isset($_GET['page']) && intval($_GET['page']))&nbsp;</div></li><li><div>            ? intval($_GET['page']) - 1 : 0;&nbsp;</div></li><li><div>        $limits = 'LIMIT ' . ($page_index * $per_page) . ', ' . $per_page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $from = &quot;FROM {$this-&gt;contents_table} c NATURAL JOIN {$this-&gt;flags_table} f&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $own_sql = &quot;SELECT item_author as user_id $from WHERE item_author &gt;0 $own_where GROUP BY item_author&quot;;&nbsp;</div></li><li><div>        $others_sql = &quot;SELECT reporter_id as user_id $from WHERE reporter_id &gt;0 $others_where GROUP BY reporter_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($own_having && $others_having) {&nbsp;</div></li><li><div>            //there are conditions on both sides, so no outer join is needed&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $own_sql HAVING 1 $own_having&nbsp;</div></li><li><div>) own NATURAL JOIN (&nbsp;</div></li><li><div>    $others_sql HAVING 1 $others_having&nbsp;</div></li><li><div>) others&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } elseif ($own_having) {&nbsp;</div></li><li><div>            //there are conditions on own contents side, so outer join is needed on that table&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $own_sql HAVING 1 $own_having&nbsp;</div></li><li><div>) own NATURAL LEFT JOIN (&nbsp;</div></li><li><div>    $others_sql&nbsp;</div></li><li><div>) others&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } elseif ($others_having) {&nbsp;</div></li><li><div>            //there are conditions on others contents side, so outer join is needed on that table&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $others_sql HAVING 1 $others_having&nbsp;</div></li><li><div>) others NATURAL LEFT JOIN (&nbsp;</div></li><li><div>    $own_sql&nbsp;</div></li><li><div>) own&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //there no conditions on any side, so a full outer join is needed but sadly not supported by mysql, using UNION workaround&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>(&nbsp;</div></li><li><div>    SELECT * FROM (&nbsp;</div></li><li><div>        $own_sql&nbsp;</div></li><li><div> ) own NATURAL LEFT JOIN (&nbsp;</div></li><li><div>        $others_sql&nbsp;</div></li><li><div> ) others&nbsp;</div></li><li><div>) UNION ALL (&nbsp;</div></li><li><div>    SELECT * FROM (&nbsp;</div></li><li><div>        $others_sql&nbsp;</div></li><li><div> ) others NATURAL LEFT JOIN (&nbsp;</div></li><li><div>        $own_sql&nbsp;</div></li><li><div> ) own WHERE own.user_id IS NULL&nbsp;</div></li><li><div>)&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $total = count($wpdb-&gt;get_results($sql));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$total) {&nbsp;</div></li><li><div>            return array('results' =&gt; array(), 'total' =&gt; 0, 'per_page' =&gt; $per_page, 'page_index' =&gt; $page_index);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $own_sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT&nbsp;</div></li><li><div>    item_author as user_id, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id) as own_contents, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status='new', 1, NULL)) as own_new, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status='ignored', 1, NULL)) as own_ignored, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status IN('edited', 'deleted', 'moderated'), 1, NULL)) as own_moderated, &nbsp;</div></li><li><div>    COUNT(*) as own_flags&nbsp;</div></li><li><div>$from&nbsp;</div></li><li><div>WHERE&nbsp;</div></li><li><div>    item_author &gt;0&nbsp;</div></li><li><div>    $own_where&nbsp;</div></li><li><div>GROUP BY&nbsp;</div></li><li><div>    item_author&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        $others_sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT&nbsp;</div></li><li><div>    reporter_id as user_id, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id) as others_contents, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status='new', 1, NULL)) as others_new, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status='ignored', 1, NULL)) as others_ignored, &nbsp;</div></li><li><div>    COUNT(DISTINCT content_id, IF(c.status IN('edited', 'deleted', 'moderated'), 1, NULL)) as others_moderated&nbsp;</div></li><li><div>$from&nbsp;</div></li><li><div>WHERE&nbsp;</div></li><li><div>    reporter_id &gt;0&nbsp;</div></li><li><div>    $others_where&nbsp;</div></li><li><div>GROUP BY&nbsp;</div></li><li><div>    reporter_id&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($own_having && $others_having) {&nbsp;</div></li><li><div>            //there are conditions on both sides, so no outer join is needed&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $own_sql HAVING 1 $own_having&nbsp;</div></li><li><div>) own NATURAL JOIN (&nbsp;</div></li><li><div>    $others_sql HAVING 1 $others_having&nbsp;</div></li><li><div>) others $order $limits&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } elseif ($own_having) {&nbsp;</div></li><li><div>            //there are conditions on own contents side, so outer join is needed on that table&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $own_sql HAVING 1 $own_having&nbsp;</div></li><li><div>) own NATURAL LEFT JOIN (&nbsp;</div></li><li><div>    $others_sql&nbsp;</div></li><li><div>) others $order $limits&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } elseif ($others_having) {&nbsp;</div></li><li><div>            //there are conditions on others contents side, so outer join is needed on that table&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>SELECT * FROM (&nbsp;</div></li><li><div>    $others_sql HAVING 1 $others_having&nbsp;</div></li><li><div>) others NATURAL LEFT JOIN (&nbsp;</div></li><li><div>    $own_sql&nbsp;</div></li><li><div>) own $order $limits&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //there no conditions on any side, so a full outer join is needed but sadly not supported by mysql, using UNION workaround&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // all_fields is needed so both united select give same columns in same order&nbsp;</div></li><li><div>            $all_fields = 'user_id, own_contents, own_new, own_ignored, own_moderated, own_flags, others_contents, others_new, others_ignored, others_moderated';&nbsp;</div></li><li><div>            $sql = &lt;&lt;&lt; SQL&nbsp;</div></li><li><div>(&nbsp;</div></li><li><div>    SELECT $all_fields FROM (&nbsp;</div></li><li><div>        $own_sql&nbsp;</div></li><li><div> ) own NATURAL LEFT JOIN (&nbsp;</div></li><li><div>        $others_sql&nbsp;</div></li><li><div> ) others&nbsp;</div></li><li><div>) UNION ALL (&nbsp;</div></li><li><div>    SELECT $all_fields FROM (&nbsp;</div></li><li><div>        $others_sql&nbsp;</div></li><li><div> ) others NATURAL LEFT JOIN (&nbsp;</div></li><li><div>        $own_sql&nbsp;</div></li><li><div> ) own WHERE own.user_id IS NULL&nbsp;</div></li><li><div>) $order $limits&nbsp;</div></li><li><div>SQL;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array('results' =&gt; $results, 'total' =&gt; $total, 'per_page' =&gt; $per_page, 'page_index' =&gt; $page_index);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * register plugin settings option with WP settings API&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register_settings()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        register_setting('bpmod_options', 'bp_moderation_options');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * register settings and display them&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function view_settings()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($_POST['bp_moderation_options']) && is_array($_POST['bp_moderation_options'])) {&nbsp;</div></li><li><div>            check_admin_referer('bpmod_options');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $options = stripslashes_deep($_POST['bp_moderation_options']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $options['unflagged_text'] = wp_kses($options['unflagged_text'], array());&nbsp;</div></li><li><div>            $options['flagged_text'] = wp_kses($options['flagged_text'], array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $options['warning_threshold'] = (int)$options['warning_threshold'];&nbsp;</div></li><li><div>            $options['warning_forward'] = join(', ', array_filter(explode(', ', $options['warning_forward']), 'is_email'));&nbsp;</div></li><li><div>            $options['warning_message'] = wp_kses($options['warning_message'], array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($options != $this-&gt;options) {&nbsp;</div></li><li><div>                update_site_option('bp_moderation_options', $options);&nbsp;</div></li><li><div>                $this-&gt;options = $options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                echo '&lt;div class=&quot;updated settings-error&quot;&gt;&lt;p&gt;&lt;strong&gt;' . __('Settings saved.', 'bp-moderation') . '&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //debugging secret, add 'dump' in get vars for dumping settings&nbsp;</div></li><li><div>        if (isset($_GET['dump'])) {&nbsp;</div></li><li><div>            echo '&lt;pre&gt;';&nbsp;</div></li><li><div>            var_dump($this-&gt;options);&nbsp;</div></li><li><div>            echo '&lt;/pre&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_settings_section('general', __('General Settings', 'bp-moderation'));&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('unflagged_text', __('Link text when unflagged', 'bp-moderation'), 'general', 'text');&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('flagged_text', __('Link text when flagged', 'bp-moderation'), 'general', 'text');&nbsp;</div></li><li><div>        //$this-&gt;add_settings_field('permit_unflag', __( 'Permit Unflagging', 'bp-moderation' ), 'general', 'checkbox');&nbsp;</div></li><li><div>        //$this-&gt;add_settings_field('permit_anonym', __( 'Permit Flagging by Anonymous', 'bp-moderation' ), 'general', 'checkbox');&nbsp;</div></li><li><div>        if ('localhost' == $_SERVER['HTTP_HOST']) {&nbsp;</div></li><li><div>            $this-&gt;add_settings_field('generate_test_data', __('Generate test data', 'bp-moderation'), 'general', 'checkbox', &nbsp;</div></li><li><div>                array('description' =&gt; ' &lt;strong&gt;' . __('NOTE: will destroy all users except #1 * USE ONLY ON WORTHLESS TEST INSTALLS', 'bp-moderation') . '&lt;/strong&gt;'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_settings_section('content_types', __('Content Types', 'bp-moderation'), &nbsp;</div></li><li><div>            __('Choose which content types can be flagged by site members.', 'bp-moderation') . '&lt;br/&gt;' .&nbsp;</div></li><li><div>            __('Note: if you deactivate one that was previously active you will still see previously flagged contents of that type in the backend tables.', 'bp-moderation')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        foreach ($this-&gt;content_types as $slug =&gt; $ct) {&nbsp;</div></li><li><div>            $this-&gt;add_settings_field($slug, $ct-&gt;label, 'content_types', 'checkbox_content_type');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_settings_section('automation', __('Automatic Moderation', 'bp-moderation'), __('Automatic warnings and deletion.', 'bp-moderation'));&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('warning_threshold', __('Automatic warning', 'bp-moderation'), 'automation', 'text', &nbsp;</div></li><li><div>            array('size' =&gt; 3, 'sprintf' =&gt; __('When a content is flagged %s times send a warning message to the author (0 = disabled).', 'bp-moderation')));&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('warning_forward', __('Forward warning', 'bp-moderation'), 'automation', 'text', &nbsp;</div></li><li><div>            array('size' =&gt; 60, 'sprintf' =&gt; __('Forward the warning also to these addresses (comma separated) &lt;br/&gt;%s', 'bp-moderation')));&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('warning_message', __('Warning message', 'bp-moderation'), 'automation', 'textarea', array('description' =&gt; __('&nbsp;</div></li><li><div>                &lt;br/&gt;placeholders:&nbsp;</div></li><li><div>                &lt;br/&gt;%AUTHORNAME% : content author username&nbsp;</div></li><li><div>                &lt;br/&gt;%CONTENTURL% : reported content url&nbsp;</div></li><li><div>                &lt;br/&gt;%SITENAME% : wordpress site name&nbsp;</div></li><li><div>                &lt;br/&gt;%SITEURL% : wordpress site url&nbsp;</div></li><li><div>            ', 'bp-moderation')));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;add_settings_section('uninstall', __('Uninstall', 'bp-moderation'), __('If you check the field below all plugin data will be erased on plugin deactivation.', 'bp-moderation'));&nbsp;</div></li><li><div>        $this-&gt;add_settings_field('clean_up', __('Clean Up on Deactivation', 'bp-moderation'), 'uninstall', 'checkbox');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;form action=&quot;#&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>            &lt;?php wp_nonce_field('bpmod_options'); ?&gt;&nbsp;</div></li><li><div>            &lt;?php do_settings_sections(__FILE__); ?&gt;&nbsp;</div></li><li><div>            &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>                &lt;input name=&quot;Submit&quot; type=&quot;submit&quot; class=&quot;button-primary&quot;&nbsp;</div></li><li><div>                       value=&quot;&lt;?php esc_attr_e('Save Changes'); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>        &lt;/form&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $settings_section_texts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * custom wrap of wp setting api 'add_settings_section'&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $slug&nbsp;</div></li><li><div>     * @param string $title&nbsp;</div></li><li><div>     * @param string $description&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function add_settings_section($slug, $title, $description = '')&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;settings_section_texts[$slug] = $description&nbsp;</div></li><li><div>            ? &quot;&lt;p&gt;$description&lt;/p&gt;&quot; : $description;&nbsp;</div></li><li><div>        add_settings_section($slug, $title, array(&$this, 'print_settings_section_text'), __FILE__);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print a settings section description&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $section&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function print_settings_section_text($section)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        echo $this-&gt;settings_section_texts[$section['id']];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * custom wrap of wp setting api 'add_settings_field'&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $slug&nbsp;</div></li><li><div>     * @param string $title&nbsp;</div></li><li><div>     * @param string $parent&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $args&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function add_settings_field($slug, $title, $parent, $type, $args = array())&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $args['id'] = $args['label_for'] = $slug;&nbsp;</div></li><li><div>        $args['input_type'] = $type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($args['name'])) {&nbsp;</div></li><li><div>            $args['name'] = $slug;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_field($slug, $title, array(&$this, 'print_settings_field'), __FILE__, $parent, $args);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * print a settings section field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function print_settings_field($args)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        extract($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($input_type) {&nbsp;</div></li><li><div>            case 'text':&nbsp;</div></li><li><div>                $size = isset($size) && (int)$size ? (int)$size : 40;&nbsp;</div></li><li><div>                $input = &quot;&lt;input id='$id' name='bp_moderation_options[$name]' size='$size' type='text' value='{$this-&gt;options[$name]}' /&gt;&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'checkbox':&nbsp;</div></li><li><div>                $checked = checked('on', @$this-&gt;options[$name], false);&nbsp;</div></li><li><div>                $input = &quot;&lt;input id='$id' $checked name='bp_moderation_options[$name]' type='checkbox' /&gt;&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'checkbox_content_type':&nbsp;</div></li><li><div>                $checked = checked('on', @$this-&gt;options['active_types'][$name], false);&nbsp;</div></li><li><div>                $input = &quot;&lt;input id='$id' $checked name='bp_moderation_options[active_types][$name]' type='checkbox' /&gt;&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'textarea':&nbsp;</div></li><li><div>                $input = &quot;&lt;textarea id='$id' name='bp_moderation_options[$name]' rows='5' cols='60'&gt;{$this-&gt;options[$name]}&lt;/textarea&gt;&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($sprintf)) {&nbsp;</div></li><li><div>            $input = sprintf($sprintf, $input);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($description)) {&nbsp;</div></li><li><div>            $input .= &quot;$description&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo $input;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 0.1.3</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/buddypress-moderation/0.1.7/classes/bp_mod_backend/" class="active">0.1.7</a></li><li><a href="http://hookr.io/plugins/buddypress-moderation/0.1.6/classes/bp_mod_backend/" class="">0.1.6</a></li><li><a href="http://hookr.io/plugins/buddypress-moderation/0.1.5/classes/bp_mod_backend/" class="">0.1.5</a></li><li><a href="http://hookr.io/plugins/buddypress-moderation/0.1.4/classes/bp_mod_backend/" class="">0.1.4</a></li><li><a href="http://hookr.io/plugins/buddypress-moderation/0.1.3/classes/bp_mod_backend/" class="">0.1.3</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>bpModBackend</li><li><span></span>BuddyPress Moderation</li><li><span></span>0.1.7</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>