<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.7.0" data-slug="buddypress-group-email-subscription" data-type="file" data-id="30670"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-activity-subscription-digest | file | Buddypress Group Email Subscription | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress-group-email-subscription, 3.7.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=98f0b296234b20f1f27e07235c9dd7ec' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-activity-subscription-digest/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-subscription-digest%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-subscription-digest%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-group-email-subscription-3.7.0-file-bp-activity-subscription-digest","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-activity-subscription-digest" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress-group-email-subscr&hellip;." href="http://hookr.io/plugins/buddypress-group-email-subscription/" class="plugin"><span property="name">buddypress-group-email-subscr&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.7.0." href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/" class="H_VERSION"><span property="name">3.7.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-activity-subscription-dige&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="186"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/all/" title="All">All <span class="count badge">186</span></a></li><li class="" data-id="new" data-count="28"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/new/" title="New">New <span class="count badge">28</span></a></li><li class="" data-id="hooks" data-count="68"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/hooks/" title="Hooks">Hooks <span class="count badge">68</span></a></li><li class="" data-id="action" data-count="9"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/actions/" title="Actions">Actions <span class="count badge">9</span></a></li><li class="" data-id="filter" data-count="59"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/filters/" title="Filters">Filters <span class="count badge">59</span></a></li><li class="" data-id="class" data-count="6"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/classes/" title="Classes">Classes <span class="count badge">6</span></a></li><li class="" data-id="constant" data-count="2"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/constants/" title="Constants">Constants <span class="count badge">2</span></a></li><li class="" data-id="function" data-count="110"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/functions/" title="Functions">Functions <span class="count badge">110</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-activity-subscription-digest.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// for testing only</span>&nbsp;</div></li><li><div><span class="comment">//if you need to add this at the TOP of your wp-config.php file. (Here are the timezones http://us3.php.net/manual/en/timezones.php)</span>&nbsp;</div></li><li><div><span class="comment">//date_default_timezone_set('Asia/Tokyo');</span>&nbsp;</div></li><li><div><span class="comment">//date_default_timezone_set('America/New_York');</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** This function was used for debugging the digest scheduling features */</span>&nbsp;</div></li><li><div>function ass_digest_schedule_print() {&nbsp;</div></li><li><div>  print &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>  print &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//    ass_digest_fire( 'dig' );</span>&nbsp;</div></li><li><div>  $crons = _get_cron_array();&nbsp;</div></li><li><div>  echo &quot;&lt;div style='background: #fff;'&gt;&quot;;&nbsp;</div></li><li><div>  $sched = wp_next_scheduled( 'ass_digest_event' );&nbsp;</div></li><li><div>  echo &quot;Scheduled: &quot; . date( 'h:i', $sched );&nbsp;</div></li><li><div>  $until = ( (int)$sched - time() ) / ( 60 * 60 );&nbsp;</div></li><li><div>  echo &quot; Until: &quot; . $until . &quot; hours&quot;;&nbsp;</div></li><li><div>  echo &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">//add_action( 'wp_head', 'ass_digest_schedule_print' );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Digest-specific functions */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_digest_fire( $type ) {&nbsp;</div></li><li><div>  global $bp, $wpdb, $groups_template, $ass_email_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If safe mode isn't on, then let's set the execution time to unlimited</span>&nbsp;</div></li><li><div>  if ( ! ini_get( 'safe_mode' ) ) {&nbsp;</div></li><li><div>      set_time_limit(0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_string($type) )&nbsp;</div></li><li><div>      $type = 'sum';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// HTML emails only work with inline CSS styles. Here we setup the styles to be used in various functions below.</span>&nbsp;</div></li><li><div>  $ass_email_css['wrapper'] = 'style=&quot;color:#333;clear:both;'; <span class="comment">// use this to style the body</span>&nbsp;</div></li><li><div>  $ass_email_css['title'] = 'style=&quot;font-size:130%; margin:0 0 25px 0;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['summary'] = '';&nbsp;</div></li><li><div>  $ass_email_css['summary_ul'] = 'style=&quot;margin:0; padding:0 0 5px; list-style-type:circle; list-style-position:inside;&quot;';&nbsp;</div></li><li><div>  <span class="comment">//$ass_email_css['summary'] = 'style=&quot;display:list-item;&quot;';</span>&nbsp;</div></li><li><div>  $ass_email_css['follow_topic'] = 'style=&quot;padding:15px 0 0; color: #888;clear:both;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['group_title'] = 'style=&quot;font-size:120%; background-color:#F5F5F5; padding:3px; margin:20px 0 0; border-top: 1px #eee solid;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['change_email'] = 'style=&quot;font-size:12px; margin-left:10px; color:#888;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['item_div'] = 'style=&quot;padding: 10px; border-top: 1px #eee solid;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['item_action'] = 'style=&quot;color:#888;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['item_date'] = 'style=&quot;font-size:85%; color:#bbb; margin-left:8px;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['item_content'] = 'style=&quot;color:#333;&quot;';&nbsp;</div></li><li><div>  $ass_email_css['item_weekly'] = 'style=&quot;color:#888; padding:4px 10px 0&quot;'; <span class="comment">// used in weekly in place of other item_ above</span>&nbsp;</div></li><li><div>  $ass_email_css['footer'] = 'class=&quot;ass-footer&quot; style=&quot;margin:25px 0 0; padding-top:5px; border-top:1px #bbb solid;&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// BP 2.5+ overrides.</span>&nbsp;</div></li><li><div>  if ( true === function_exists( 'bp_send_email' ) && true === ! apply_filters( 'bp_email_use_wp_mail', false ) ) {&nbsp;</div></li><li><div>      $ass_email_css['summary_ul'] = 'style=&quot;margin:0; padding:0 0 25px 15px; list-style-type:circle; list-style-position:inside;&quot;';&nbsp;</div></li><li><div>      $ass_email_css['item_action'] = $ass_email_css['item_content'] = '';&nbsp;</div></li><li><div>      $ass_email_css['item_date'] = 'style=&quot;font-size:85%;&quot;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow plugins to filter the CSS</span>&nbsp;</div></li><li><div>  $ass_email_css = apply_filters( 'ass_email_css', $ass_email_css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $title = ass_digest_get_title( $type );&nbsp;</div></li><li><div>  $blogname = get_blog_option( BP_ROOT_BLOG, 'blogname' );&nbsp;</div></li><li><div>  $subject = apply_filters( 'ass_digest_subject', &quot;$title [$blogname]&quot;, $blogname, $title, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $footer = &quot;\n\n&lt;div {$ass_email_css['footer']}&gt;&quot;;&nbsp;</div></li><li><div>  $footer .= sprintf( __( &quot;You have received this message because you are subscribed to receive a digest of activity in some of your groups on %s.&quot;, 'bp-ass' ), $blogname );&nbsp;</div></li><li><div>  $footer = apply_filters( 'ass_digest_footer', $footer, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get all user subscription data</span>&nbsp;</div></li><li><div>  $user_subscriptions = $wpdb-&gt;get_results( &quot;SELECT user_id, meta_value FROM {$wpdb-&gt;usermeta} WHERE meta_key = 'ass_digest_items' AND meta_value != ''&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no subscription data? stop now!</span>&nbsp;</div></li><li><div>  if ( empty( $user_subscriptions ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get all activity IDs for everyone subscribed to a digest</span>&nbsp;</div></li><li><div>  $all_activity_items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach( (array) $user_subscriptions as $us ) {&nbsp;</div></li><li><div>      $subs = maybe_unserialize( $us-&gt;meta_value );&nbsp;</div></li><li><div>      foreach( (array) $subs as $digest_type =&gt; $group_subs ) {&nbsp;</div></li><li><div>          foreach( (array) $group_subs as $group_id =&gt; $sub_ids ) {&nbsp;</div></li><li><div>              foreach( (array) $sub_ids as $sid ) {&nbsp;</div></li><li><div>                  <span class="comment">// note: activity ID is added as the key for performance reasons</span>&nbsp;</div></li><li><div>                  if ( ! isset( $all_activity_items[$sid] ) && ! empty( $sid ) ) {&nbsp;</div></li><li><div>                      $all_activity_items[$sid] = 1;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no activity IDs? stop now!</span>&nbsp;</div></li><li><div>  if ( empty( $all_activity_items ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// setup the IN query</span>&nbsp;</div></li><li><div>  $in = implode( &quot;, &quot;, array_keys( $all_activity_items ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get only the activity data we need</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // we're not using bp_activity_get_specific() to avoid an extra query with the</span>&nbsp;</div></li><li><div>  <span class="comment">// xprofile table</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // @todo MySQL IN query doesn't scale well when querying a ton of IDs</span>&nbsp;</div></li><li><div>  $items = $wpdb-&gt;get_results( &quot;&nbsp;</div></li><li><div>      SELECT id, type, action, content, primary_link, secondary_item_id, date_recorded&nbsp;</div></li><li><div>          FROM {$bp-&gt;activity-&gt;table_name}&nbsp;</div></li><li><div>          WHERE id IN ({$in})&nbsp;</div></li><li><div>  &quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// cache some stuff</span>&nbsp;</div></li><li><div>  $bp-&gt;ass = new stdClass;&nbsp;</div></li><li><div>  $bp-&gt;ass-&gt;massdata = ass_get_mass_userdata( wp_list_pluck( $user_subscriptions, 'user_id' ) );&nbsp;</div></li><li><div>  $bp-&gt;ass-&gt;activity_ids = array_flip( (array) wp_list_pluck( $items, 'id' ) );&nbsp;</div></li><li><div>  $bp-&gt;ass-&gt;items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// cache activity items</span>&nbsp;</div></li><li><div>  foreach ( $items as $item ) {&nbsp;</div></li><li><div>      $bp-&gt;ass-&gt;items[$item-&gt;id] = $item;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get list of all groups so we can look them up quickly in the foreach loop below</span>&nbsp;</div></li><li><div>  $all_groups = $wpdb-&gt;get_results( &quot;SELECT id, name, slug FROM {$bp-&gt;groups-&gt;table_name}&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// setup group info array that we'll reference later</span>&nbsp;</div></li><li><div>  $groups_info = array();&nbsp;</div></li><li><div>  foreach ( $all_groups as $group ) {&nbsp;</div></li><li><div>      $groups_info[ $group-&gt;id ] = array(&nbsp;</div></li><li><div>          'name' =&gt; ass_digest_filter( $group-&gt;name ), &nbsp;</div></li><li><div>          'slug' =&gt; $group-&gt;slug&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// start the digest loop for each user</span>&nbsp;</div></li><li><div>  foreach ( (array) $user_subscriptions as $user ) {&nbsp;</div></li><li><div>      $user_id = $user-&gt;user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get the group subscriptions for the user</span>&nbsp;</div></li><li><div>      $group_activity_ids_array = unserialize( $user-&gt;meta_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// initialize some strings</span>&nbsp;</div></li><li><div>      $summary = $activity_message = $body = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We only want the weekly or daily ones</span>&nbsp;</div></li><li><div>      if ( empty( $group_activity_ids_array[$type] ) || !$group_activity_ids = (array)$group_activity_ids_array[$type] )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get userdata</span>&nbsp;</div></li><li><div>      <span class="comment">// @see ass_get_mass_userdata()</span>&nbsp;</div></li><li><div>      $userdata = $bp-&gt;ass-&gt;massdata[$user_id];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// sanity check!</span>&nbsp;</div></li><li><div>      if ( empty( $userdata ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// email address of user</span>&nbsp;</div></li><li><div>      $to = $userdata['email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $userdomain = ass_digest_get_user_domain( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// filter the list - can be used to sort the groups</span>&nbsp;</div></li><li><div>      $group_activity_ids = apply_filters( 'ass_digest_group_activity_ids', @$group_activity_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $header = &quot;&lt;div {$ass_email_css['title']}&gt;$title &quot; . __('at', 'bp-ass').&quot; &lt;a href='&quot; . $bp-&gt;root_domain . &quot;'&gt;$blogname&lt;/a&gt;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>      $message = apply_filters( 'ass_digest_header', $header, $title, $ass_email_css['title'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// loop through each group for this user</span>&nbsp;</div></li><li><div>      foreach ( $group_activity_ids as $group_id =&gt; $activity_ids ) {&nbsp;</div></li><li><div>          <span class="comment">// check to see if our activity IDs exist</span>&nbsp;</div></li><li><div>          <span class="comment">// intersect against our master activity IDs array</span>&nbsp;</div></li><li><div>          $activity_ids = array_intersect_key( array_flip( $activity_ids ), $bp-&gt;ass-&gt;activity_ids );&nbsp;</div></li><li><div>          $activity_ids = array_keys( $activity_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $group_name = $groups_info[ $group_id ][ 'name' ];&nbsp;</div></li><li><div>          $group_slug = $groups_info[ $group_id ][ 'slug' ];&nbsp;</div></li><li><div>          $group_permalink = apply_filters( 'bp_get_group_permalink', trailingslashit( bp_get_root_domain() . '/' . bp_get_groups_root_slug() . '/' . $group_slug . '/' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Might be nice here to link to anchor tags in the message.</span>&nbsp;</div></li><li><div>          if ( 'dig' == $type ) {&nbsp;</div></li><li><div>              $summary .= apply_filters( 'ass_digest_summary', &quot;&lt;li {$ass_email_css['summary']}&gt;&lt;a href='{$group_permalink}'&gt;$group_name&lt;/a&gt; &quot; . sprintf( __( '(%s items)', 'bp-ass' ), count( $activity_ids ) ) .&quot;&lt;/li&gt;\n&quot;, $ass_email_css['summary'], $group_slug, $group_name, $activity_ids );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $activity_message .= ass_digest_format_item_group( $group_id, $activity_ids, $type, $group_name, $group_slug, $user_id );&nbsp;</div></li><li><div>          unset( $group_activity_ids[ $group_id ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// reset the user's sub array removing those sent</span>&nbsp;</div></li><li><div>      $group_activity_ids_array[$type] = $group_activity_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// show group summary for digest, and follow help text for weekly summary</span>&nbsp;</div></li><li><div>      if ( 'dig' == $type ) {&nbsp;</div></li><li><div>          $message .= apply_filters( 'ass_digest_summary_full', __( 'Group Summary', 'bp-ass') . &quot;:\n&lt;ul {$ass_email_css['summary_ul']}&gt;&quot; .  $summary . &quot;&lt;/ul&gt;&quot;, $ass_email_css['summary_ul'], $summary );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the meat of the message which we generated above goes here</span>&nbsp;</div></li><li><div>      $message .= $activity_message;&nbsp;</div></li><li><div>      $body .= $activity_message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// user is subscribed to &quot;New Topics&quot;</span>&nbsp;</div></li><li><div>      <span class="comment">// add follow help text only if bundled forums are enabled</span>&nbsp;</div></li><li><div>      if ( 'sum' == $type && class_exists( 'BP_Forums_Component' ) ) {&nbsp;</div></li><li><div>          $message .= apply_filters( 'ass_summary_follow_topic', &quot;&lt;div {$ass_email_css['follow_topic']}&gt;&quot; . __( &quot;How to follow a topic: to get email updates for a specific topic, click the topic title - then on the webpage click the &lt;i&gt;Follow this topic&lt;/i&gt; button. (If you don't see the button you need to login first.)&quot;, 'bp-ass' ) . &quot;&lt;/div&gt;\n&quot;, $ass_email_css['follow_topic'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message .= $footer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $unsubscribe_message = &quot;\n\n&quot; . sprintf( __( &quot;To disable these notifications per group please login and go to: %s where you can change your email settings for each group.&quot;, 'bp-ass' ), &quot;&lt;a href=\&quot;{$userdomain}{$bp-&gt;groups-&gt;slug}/\&quot;&gt;&quot; . __( 'My Groups', 'bp-ass' ) . &quot;&lt;/a&gt;&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_option( 'ass-global-unsubscribe-link' ) == 'yes' ) {&nbsp;</div></li><li><div>          $unsubscribe_link = &quot;$userdomain?bpass-action=unsubscribe&access_key=&quot; . md5( $user_id . 'unsubscribe' . wp_salt() );&nbsp;</div></li><li><div>          $unsubscribe_message .= &quot;\n\n&lt;br&gt;&lt;br&gt;&lt;a href=\&quot;$unsubscribe_link\&quot;&gt;&quot; . __( 'Disable these notifications for all my groups at once.', 'bp-ass' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message .= apply_filters( 'ass_digest_disable_notifications', $unsubscribe_message, $userdomain . $bp-&gt;groups-&gt;slug );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['sum'] ) ) {&nbsp;</div></li><li><div>          <span class="comment">// test mode run from the browser, dont send the emails, just show them on screen using domain.com?sum=1</span>&nbsp;</div></li><li><div>          echo '&lt;div style=&quot;background-color:white; width:75%;padding:20px 10px;&quot;&gt;';&nbsp;</div></li><li><div>          echo '&lt;p&gt;======================== to: &lt;b&gt;'.$to.'&lt;/b&gt; ========================&lt;/p&gt;';&nbsp;</div></li><li><div>          echo $message;&nbsp;</div></li><li><div>          <span class="comment">//echo '&lt;br&gt;PLAIN TEXT PART:&lt;br&gt;&lt;pre&gt;'; echo $message_plaintext ; echo '&lt;/pre&gt;';</span>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Sending time!</span>&nbsp;</div></li><li><div>          if ( true === function_exists( 'bp_send_email' ) && true === ! apply_filters( 'bp_email_use_wp_mail', false ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Custom GES email tokens.</span>&nbsp;</div></li><li><div>              $user_message_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Digest summary only available for daily digests.</span>&nbsp;</div></li><li><div>              $user_message_args['ges.digest-summary'] = '';&nbsp;</div></li><li><div>              if ( 'dig' == $type ) {&nbsp;</div></li><li><div>                  $user_message_args['ges.digest-summary'] = apply_filters( 'ass_digest_summary_full', __( 'Group Summary', 'bp-ass' ) . &quot;:\n&lt;ul {$ass_email_css['summary_ul']}&gt;&quot; .  $summary . &quot;&lt;/ul&gt;&quot;, $ass_email_css['summary_ul'], $summary );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $user_message_args['ges.subject'] = $title;&nbsp;</div></li><li><div>              $user_message_args['ges.settings-link'] = ass_get_login_redirect_url( &quot;{$userdomain}{$bp-&gt;groups-&gt;slug}&quot; );&nbsp;</div></li><li><div>              $user_message_args['subscription_type'] = $type;&nbsp;</div></li><li><div>              $user_message_args['recipient.id'] = $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Unused</span>.</span>&nbsp;</div></li><li><div>              $user_message_args['poster.url'] = $userdomain;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// BP-specific tokens.</span>&nbsp;</div></li><li><div>              $user_message_args['usermessage'] = $body;&nbsp;</div></li><li><div>              $user_message_args['poster.name'] = $userdata['user_login']; <span class="comment">// Unused</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Filters.</span>&nbsp;</div></li><li><div>              add_filter( 'bp_email_get_salutation', 'ass_digest_filter_salutation' );&nbsp;</div></li><li><div>              add_filter( 'bp_email_get_property', 'ass_digest_strip_plaintext_separators', 1, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Send the email.</span>&nbsp;</div></li><li><div>              ass_send_email( 'bp-ges-digest', $to, array(&nbsp;</div></li><li><div>                  'tokens' =&gt; $user_message_args&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Remove filter.</span>&nbsp;</div></li><li><div>              remove_filter( 'bp_email_get_salutation', 'ass_digest_filter_salutation' );&nbsp;</div></li><li><div>              remove_filter( 'bp_email_get_property', 'ass_digest_strip_plaintext_separators', 1, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Old version.</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $message_plaintext = ass_convert_html_to_plaintext( $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Send out the email.</span>&nbsp;</div></li><li><div>              ass_send_multipart_email( $to, $subject, $message_plaintext, str_replace( '---', '', $message ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// update the subscriber's digest list</span>&nbsp;</div></li><li><div>          bp_update_user_meta( $user_id, 'ass_digest_items', $group_activity_ids_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $message, $message_plaintext, $message, $to, $userdata, $userdomain, $activity_message, $summary, $group_activity_ids_array, $group_activity_ids );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the title for the digest email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $type Type of digest. Either 'dig' for daily digest or 'sum' for weekly summary.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_digest_get_title( $type = '' ) {&nbsp;</div></li><li><div>  if ( $type == 'dig' ) {&nbsp;</div></li><li><div>      $title = sprintf( __( 'Your daily digest of group activity', 'bp-ass' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $title = sprintf( __( 'Your weekly summary of group topics', 'bp-ass' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'ass_digest_title', $title, $type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filter the &quot;Hi, X&quot; salutation in BP 2.5 emails to use the digest title.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $retval Current salutation.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_digest_filter_salutation( $retval = '' ) {&nbsp;</div></li><li><div>  if ( true === empty( buddypress()-&gt;ges_tokens ) ) {&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return ass_digest_get_title( buddypress()-&gt;ges_tokens['subscription_type'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Strip plain-text only content from BP 2.5 digest HTML emails.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Email::get() and the nl2br() call.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content   Content to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $prop      Property to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $transform Transform type to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_digest_strip_plaintext_separators( $content = '', $prop = '', $transform = '' ) {&nbsp;</div></li><li><div>  if ( $transform !== 'add-content' ) {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $find = array(&nbsp;</div></li><li><div>      &quot;---&quot;, &nbsp;</div></li><li><div>      &quot;&lt;br /&gt;&quot;, &nbsp;</div></li><li><div>      &quot;\n&ndash;\n&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $replace = array(&nbsp;</div></li><li><div>      '', &nbsp;</div></li><li><div>      '', &nbsp;</div></li><li><div>      '&lt;br /&gt;&ndash;&lt;br /&gt;', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return str_replace( $find, $replace, $content );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// these functions are hooked in via the cron</span>&nbsp;</div></li><li><div>function ass_daily_digest_fire() {&nbsp;</div></li><li><div>  ass_digest_fire( 'dig' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'ass_digest_event', 'ass_daily_digest_fire' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_weekly_digest_fire() {&nbsp;</div></li><li><div>  ass_digest_fire( 'sum' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'ass_digest_event_weekly', 'ass_weekly_digest_fire' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Use these two lines for testing the digest firing in real-time</span>&nbsp;</div></li><li><div>//add_action( 'bp_actions', 'ass_daily_digest_fire' ); <span class="comment">// for testing only</span>&nbsp;</div></li><li><div>//add_action( 'bp_actions', 'ass_weekly_digest_fire' ); <span class="comment">// for testing only</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// for testing the digest firing in real-time, add /?sum=1 to the url</span>&nbsp;</div></li><li><div>function ass_digest_fire_test() {&nbsp;</div></li><li><div>  if ( isset( $_GET['sum'] ) && is_super_admin() ) {&nbsp;</div></li><li><div>      echo &quot;&lt;h2&gt;&quot;.__('DAILY DIGEST:', 'bp-ass').&quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>      ass_digest_fire( 'dig' );&nbsp;</div></li><li><div>      echo &quot;&lt;h2 style='margin-top:150px'&gt;&quot;.__('WEEKLY DIGEST:', 'bp-ass').&quot;&lt;/h2&gt;&quot;;&nbsp;</div></li><li><div>      ass_digest_fire( 'sum' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//global $wpdb;</span>&nbsp;</div></li><li><div>      <span class="comment">//echo '&lt;pre&gt;';print_r( $wpdb-&gt;queries );</span>&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_actions', 'ass_digest_fire_test' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the introduction for the group and loops through each item</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * I've chosen to cache on an individual-activity basis, instead of a group-by-group basis. This</span>&nbsp;</div></li><li><div><span class="comment"> * requires just a touch more overhead (in terms of looping through individual activity_ids), and</span>&nbsp;</div></li><li><div><span class="comment"> * doesn't really have any added effect at the moment (since an activity item can only be associated</span>&nbsp;</div></li><li><div><span class="comment"> * with a single group). But it provides the greatest amount of flexibility going forward, both in</span>&nbsp;</div></li><li><div><span class="comment"> * terms of the possibility that activity items could be associated with more than one group, and</span>&nbsp;</div></li><li><div><span class="comment"> * the possibility that users within a single group would want more highly-filtered digests.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_digest_format_item_group( $group_id, $activity_ids, $type, $group_name, $group_slug, $user_id ) {&nbsp;</div></li><li><div>  global $bp, $ass_email_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_permalink = apply_filters( 'bp_get_group_permalink', bp_get_root_domain() . '/' . bp_get_groups_root_slug() . '/' . $group_slug . '/' );&nbsp;</div></li><li><div>  $group_name_link = '&lt;a href=&quot;'.$group_permalink.'&quot; name=&quot;'.$group_slug.'&quot;&gt;'.$group_name.'&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $userdomain = ass_digest_get_user_domain( $user_id );&nbsp;</div></li><li><div>  $unsubscribe_link = &quot;$userdomain?bpass-action=unsubscribe&group=$group_id&access_key=&quot; . md5( &quot;{$group_id}{$user_id}unsubscribe&quot; . wp_salt() );&nbsp;</div></li><li><div>  $gnotifications_link = ass_get_login_redirect_url( $group_permalink . 'notifications/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// add the group title bar</span>&nbsp;</div></li><li><div>  if ( $type == 'dig' ) {&nbsp;</div></li><li><div>      $group_message = &quot;\n---\n\n&lt;div {$ass_email_css['group_title']}&gt;&quot;. sprintf( __( 'Group: %s', 'bp-ass' ), $group_name_link ) . &quot;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>  } elseif ( $type == 'sum' ) {&nbsp;</div></li><li><div>      $group_message = &quot;\n---\n\n&lt;div {$ass_email_css['group_title']}&gt;&quot;. sprintf( __( 'Group: %s weekly summary', 'bp-ass' ), $group_name_link ) . &quot;&lt;/div&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// add change email settings link</span>&nbsp;</div></li><li><div>  $group_message .= &quot;\n&lt;div {$ass_email_css['change_email']}&gt;&quot;;&nbsp;</div></li><li><div>  $group_message .= __('To disable these notifications for this group click ', 'bp-ass'). &quot; &lt;a href=\&quot;$unsubscribe_link\&quot;&gt;&quot; . __( 'unsubscribe', 'bp-ass' ) . '&lt;/a&gt; - ';&nbsp;</div></li><li><div>  $group_message .=  __('change ', 'bp-ass') . '&lt;a href=&quot;' . $gnotifications_link . '&quot;&gt;' . __( 'email options', 'bp-ass' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>  $group_message .= &quot;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_message = apply_filters( 'ass_digest_group_message_title', $group_message, $group_id, $type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally, add the markup to the digest</span>&nbsp;</div></li><li><div>  foreach ( $activity_ids as $activity_id ) {&nbsp;</div></li><li><div>      <span class="comment">// Cache is set earlier in ass_digest_fire()</span>&nbsp;</div></li><li><div>      $activity_item = ! empty( $bp-&gt;ass-&gt;items[$activity_id] ) ? $bp-&gt;ass-&gt;items[$activity_id] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $activity_item ) ) {&nbsp;</div></li><li><div>          $group_message .= ass_digest_format_item( $activity_item, $type );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//$group_message .= '&lt;pre&gt;'. $item-&gt;id .'&lt;/pre&gt;';</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'ass_digest_format_item_group', $group_message, $group_id, $type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// displays each item in a group</span>&nbsp;</div></li><li><div>function ass_digest_format_item( $item, $type ) {&nbsp;</div></li><li><div>  global $ass_email_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $replies = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//load from the cache if it exists</span>&nbsp;</div></li><li><div>  if ( $item_cached = wp_cache_get( 'digest_item_' . $type . '_' . $item-&gt;id, 'ass' ) ) {&nbsp;</div></li><li><div>      <span class="comment">//$item_cached .= &quot;GENERATED FROM CACHE&quot;;</span>&nbsp;</div></li><li><div>      return $item_cached;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Action text - This technique will not translate well */</span>&nbsp;</div></li><li><div>  <span class="comment">// bbPress 2 support</span>&nbsp;</div></li><li><div>  if ( strpos( $item-&gt;type, 'bbp_' ) !== false ) {&nbsp;</div></li><li><div>      $action_split = explode( ' in the forum', ass_clean_subject_html( $item-&gt;action ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// regular group activity items</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $action_split = explode( ' in the group', ass_clean_subject_html( $item-&gt;action ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $action_split[1] )&nbsp;</div></li><li><div>      $action = $action_split[0];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $action = $item-&gt;action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $action = ass_digest_filter( $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $action = str_replace( ' started the forum topic', ' started', $action ); <span class="comment">// won't translate but it's not essential</span>&nbsp;</div></li><li><div>  $action = str_replace( ' posted on the forum topic', ' posted on', $action );&nbsp;</div></li><li><div>  $action = str_replace( ' started the discussion topic', ' started', $action );&nbsp;</div></li><li><div>  $action = str_replace( ' posted on the discussion topic', ' posted on', $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Activity timestamp */</span>&nbsp;</div></li><li><div><span class="comment">//    $timestamp = strtotime( $item-&gt;date_recorded );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Because BuddyPress core set gmt = true, timezone must be added */</span>&nbsp;</div></li><li><div>  $timestamp = strtotime( $item-&gt;date_recorded ) +date('Z');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time_posted = date( get_option( 'time_format' ), $timestamp );&nbsp;</div></li><li><div>  $date_posted = date( get_option( 'date_format' ), $timestamp );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Daily Digest</span>&nbsp;</div></li><li><div>  if ( $type == 'dig' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//$item_message = strip_tags( $action ) . &quot;: \n&quot;;</span>&nbsp;</div></li><li><div>      $item_message =  &quot;&lt;div {$ass_email_css['item_div']}&gt;&quot;;&nbsp;</div></li><li><div>      $item_message .=  &quot;&lt;span {$ass_email_css['item_action']}&gt;&quot; . $action . &quot;: &quot;;&nbsp;</div></li><li><div>      $item_message .= &quot;&lt;span {$ass_email_css['item_date']}&gt;&quot; . sprintf( __('at %s, %s', 'bp-ass'), $time_posted, $date_posted ) .&quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      $item_message .=  &quot;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// activity content</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $item-&gt;content ) )&nbsp;</div></li><li><div>          $item_message .= &quot;&lt;br&gt;&lt;span {$ass_email_css['item_content']}&gt;&quot; . apply_filters( 'ass_digest_content', $item-&gt;content, $item, $type ) . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// view link</span></span>&nbsp;</div></li><li><div>      if ( $item-&gt;type == 'activity_update' || $item-&gt;type == 'activity_comment' ) {&nbsp;</div></li><li><div>          $item_message .= ' - &lt;a href=&quot;' . bp_activity_get_permalink( $item-&gt;id, $item ).'&quot;&gt;'.__('View', 'bp-ass').'&lt;/a&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $item_message .= ' - &lt;a href=&quot;' . $item-&gt;primary_link .'&quot;&gt;'.__('View', 'bp-ass').'&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_message .= &quot;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Weekly summary</span>&nbsp;</div></li><li><div>  } elseif ( $type == 'sum' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// count the number of replies</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      // commented out for now</span>&nbsp;</div></li><li><div>      <span class="comment">// if we want to bring this back we should use a direct DB query to the</span>&nbsp;</div></li><li><div>      <span class="comment">// wp_bb_topics table and locally cache the value</span>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      if ( $item-&gt;type == 'new_forum_topic' ) {</span>&nbsp;</div></li><li><div><span class="comment">          if ( $posts = bp_forums_get_topic_posts( 'per_page=10000&topic_id='. $item-&gt;secondary_item_id ) ) {</span>&nbsp;</div></li><li><div><span class="comment">              foreach ( $posts as $post ) {</span>&nbsp;</div></li><li><div><span class="comment">                  $since = time() - strtotime( $post-&gt;post_time );</span>&nbsp;</div></li><li><div><span class="comment">                  if ( $since &lt; 604800 ) //number of seconds in a week</span>&nbsp;</div></li><li><div><span class="comment">                      $counter++;</span>&nbsp;</div></li><li><div><span class="comment">              }</span>&nbsp;</div></li><li><div><span class="comment">          }</span>&nbsp;</div></li><li><div><span class="comment">          $replies = ' ' . sprintf( __( '(%s replies)', 'bp-ass' ), $counter );</span>&nbsp;</div></li><li><div><span class="comment">      }</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_message =  &quot;&lt;div {$ass_email_css['item_div']}&gt;&quot;;&nbsp;</div></li><li><div>      $item_message .=  &quot;&lt;span {$ass_email_css['item_action']}&gt;&quot; . $action . &quot;: &quot;;&nbsp;</div></li><li><div>      $item_message .= &quot;&lt;span {$ass_email_css['item_date']}&gt;&quot; . sprintf( __('at %s, %s', 'bp-ass'), $time_posted, $date_posted ) .&quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      $item_message .=  &quot;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// activity content</span></span>&nbsp;</div></li><li><div>      if ( ! empty( $item-&gt;content ) )&nbsp;</div></li><li><div>          $item_message .= &quot;&lt;br&gt;&lt;span {$ass_email_css['item_content']}&gt;&quot; . apply_filters( 'ass_digest_content', $item-&gt;content, $item, $type ) . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// view link</span></span>&nbsp;</div></li><li><div>      if ( $item-&gt;type == 'activity_update' || $item-&gt;type == 'activity_comment' ) {&nbsp;</div></li><li><div>          $item_message .= ' - &lt;a href=&quot;' . bp_activity_get_permalink( $item-&gt;id, $item ).'&quot;&gt;'.__('View', 'bp-ass').'&lt;/a&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $item_message .= ' - &lt;a href=&quot;' . $item-&gt;primary_link .'&quot;&gt;'.__('View', 'bp-ass').'&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_message .= &quot;&lt;/div&gt;\n\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $item_message = apply_filters( 'ass_digest_format_item', $item_message, $item, $action, $timestamp, $type, $replies );&nbsp;</div></li><li><div>  $item_message = ass_digest_filter( $item_message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// save the cache</span>&nbsp;</div></li><li><div>  if ( $item-&gt;id )&nbsp;</div></li><li><div>      wp_cache_set( 'digest_item_' . $type . '_' . $item-&gt;id, $item_message, 'ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $item_message;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// standard wp filters to clean up things that might mess up email display - (maybe not necessary?)</span>&nbsp;</div></li><li><div>function ass_digest_filter( $item ) {&nbsp;</div></li><li><div>  $item = wptexturize( $item );&nbsp;</div></li><li><div>  $item = convert_chars( $item );&nbsp;</div></li><li><div>  $item = stripslashes( $item );&nbsp;</div></li><li><div>  return $item;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// convert the email to plain text, and fancy it up a bit. these conversion only work in English, but it's ok.</span>&nbsp;</div></li><li><div>function ass_convert_html_to_plaintext( $message ) {&nbsp;</div></li><li><div>  <span class="comment">// convert view links to http:// links</span>&nbsp;</div></li><li><div>  $message = preg_replace( &quot;/&lt;a href=\&quot;(.[^\&quot;]*)\&quot;&gt;View&lt;\/a&gt;/i&quot;, &quot;\\1&quot;, $message );&nbsp;</div></li><li><div>  <span class="comment">// convert group div to two lines encasing the group name</span>&nbsp;</div></li><li><div>  $message = preg_replace( &quot;/&lt;div.*&gt;Group: &lt;a href=\&quot;(.[^\&quot;]*)\&quot;&gt;(.*)&lt;\/a&gt;.*&lt;\/div&gt;/i&quot;, &quot;------\n\\2 - \\1\n------&quot;, $message );&nbsp;</div></li><li><div>  <span class="comment">// convert footer line to two dashes</span>&nbsp;</div></li><li><div>  $message = preg_replace( &quot;/\n&lt;div class=\&quot;ass-footer\&quot;/i&quot;, &quot;--\n&lt;div&quot;, $message );&nbsp;</div></li><li><div>  <span class="comment">// convert My Groups links to http:// links</span>&nbsp;</div></li><li><div>  $message = preg_replace( &quot;/&lt;a href=\&quot;(.[^\&quot;]*)\&quot;&gt;My Groups&lt;\/a&gt;/i&quot;, &quot;\\1&quot;, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = preg_replace( &quot;/&lt;a href=\&quot;(.[^\&quot;]*)\&quot;&gt;(.*)&lt;\/a&gt;/i&quot;, &quot;\\2 (\\1)&quot;, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = strip_tags( stripslashes( $message ) );&nbsp;</div></li><li><div>  <span class="comment">// remove uneccesary lines</span>&nbsp;</div></li><li><div>  $message = str_replace( &quot;change email options for this group\n\n&quot;, '', $message );&nbsp;</div></li><li><div>  $message = html_entity_decode( $message , ENT_QUOTES, 'UTF-8' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $message;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Formats and sends a MIME multipart email with both HTML and plaintext</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We have to use some fancy filters from the wp_mail function to configure the $phpmailer object</span>&nbsp;</div></li><li><div><span class="comment"> * properly</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_send_multipart_email( $to, $subject, $message_plaintext, $message ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   <span class="comment">// setup HTML body. plugins that wrap emails with HTML templates can filter this</span>&nbsp;</div></li><li><div>  $message = apply_filters( 'ass_digest_message_html', &quot;&lt;html&gt;&lt;body&gt;{$message}&lt;/body&gt;&lt;/html&gt;&quot;, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get admin email</span>&nbsp;</div></li><li><div>  $admin_email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if no admin email, use a dummy 'from' email address</span>&nbsp;</div></li><li><div>  if ( $admin_email == '' ) {&nbsp;</div></li><li><div>      $admin_email = 'support@' . $_SERVER['SERVER_NAME'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get from name</span>&nbsp;</div></li><li><div>  $from_name = get_site_option( 'site_name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if no site name, use WordPress as dummy 'from' name</span>&nbsp;</div></li><li><div>  if ( empty( $from_name ) ) {&nbsp;</div></li><li><div>      $from_name = 'WordPress';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set up anonymous functions to be used to override some WP mail stuff</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // due to a bug with wp_mail(), we should reset some $phpmailer properties</span>&nbsp;</div></li><li><div>  <span class="comment">// (see http://core.trac.wordpress.org/ticket/18493#comment:13).</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // we're doing this during the 'wp_mail_from' filter because this runs before</span>&nbsp;</div></li><li><div>  <span class="comment">// 'phpmailer_init'</span>&nbsp;</div></li><li><div>  $admin_email = addslashes( $admin_email );&nbsp;</div></li><li><div>  $admin_email_filter = create_function( '$admin_email', '&nbsp;</div></li><li><div>      global $phpmailer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $phpmailer-&gt;Body = &quot;&quot;;&nbsp;</div></li><li><div>      $phpmailer-&gt;AltBody = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $admin_email;&nbsp;</div></li><li><div>  ' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $from_name = addslashes( $from_name );&nbsp;</div></li><li><div>  $from_name_filter = create_function( '$from_name', 'return $from_name;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set the WP email overrides</span>&nbsp;</div></li><li><div>  add_filter( 'wp_mail_from', $admin_email_filter );&nbsp;</div></li><li><div>  add_filter( 'wp_mail_from_name', $from_name_filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// setup plain-text body</span>&nbsp;</div></li><li><div>  $message_plaintext = addslashes( $message_plaintext );&nbsp;</div></li><li><div>  add_action( 'phpmailer_init', create_function( '$phpmailer', '&nbsp;</div></li><li><div>      $phpmailer-&gt;AltBody = &quot;' . $message_plaintext . '&quot;;&nbsp;</div></li><li><div>  ' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// set content type as HTML</span>&nbsp;</div></li><li><div>  $headers = array( 'Content-type: text/html' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// send the email!</span>&nbsp;</div></li><li><div>  $result = wp_mail( $to, $subject, $message, $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove our custom hooks</span>&nbsp;</div></li><li><div>  remove_filter( 'wp_mail_from', $admin_email_filter );&nbsp;</div></li><li><div>  remove_filter( 'wp_mail_from_name', $from_name_filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// clean up after ourselves</span>&nbsp;</div></li><li><div>  <span class="comment">// reset $phpmailer-&gt;AltBody after we set it in the 'phpmailer_init' hook</span>&nbsp;</div></li><li><div>  <span class="comment">// this is so subsequent calls to wp_mail() by other plugins will be clean</span>&nbsp;</div></li><li><div>  global $phpmailer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $phpmailer-&gt;AltBody = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_digest_record_activity( $activity_id, $user_id, $group_id, $type = 'dig' ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$activity_id || !$user_id || !$group_id )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Prevent the addition of specific activity item IDs for specific users.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.6.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $proceed     Whether to continue adding this activity item to a user's digest.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $activity_id ID of activity item to be added.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id     ID of user whose digest record is being modified.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $group_id    ID of the group where the action took place.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type        Type of digest.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( false === apply_filters( 'ass_digest_record_activity_allow', true, $activity_id, $user_id, $group_id, $type ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get the digest/summary items for all groups for this user</span>&nbsp;</div></li><li><div>  $group_activity_ids = bp_get_user_meta( $user_id, 'ass_digest_items', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// update multi-dimensional array with the current activity_id</span>&nbsp;</div></li><li><div>  $group_activity_ids[$type][$group_id][] = $activity_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// re-save it</span>&nbsp;</div></li><li><div>  bp_update_user_meta( $user_id, 'ass_digest_items', $group_activity_ids );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_cron_add_weekly( $schedules ) {&nbsp;</div></li><li><div>  if ( !isset( $schedules[ 'weekly' ] ) ) {&nbsp;</div></li><li><div>      $schedules['weekly'] = array( 'interval' =&gt; 604800, 'display' =&gt; __( 'Once Weekly', 'bp-ass' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $schedules;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'cron_schedules', 'ass_cron_add_weekly' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_set_daily_digest_time( $hours, $minutes ) {&nbsp;</div></li><li><div>  $the_time = date( 'Y-m-d' ) . ' ' . $hours . ':' . $minutes;&nbsp;</div></li><li><div>  $the_timestamp = strtotime( $the_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** If the time has already passed today, the next run will be tomorrow */</span>&nbsp;</div></li><li><div>  $the_timestamp = ( $the_timestamp &gt; time() ) ? $the_timestamp : (int)$the_timestamp + 86400;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Clear the old recurring event and set up a new one */</span></span>&nbsp;</div></li><li><div>  wp_clear_scheduled_hook( 'ass_digest_event' );&nbsp;</div></li><li><div>  wp_schedule_event( $the_timestamp, 'daily', 'ass_digest_event' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Finally, save the option */</span></span>&nbsp;</div></li><li><div>  update_option( 'ass_digest_time', array( 'hours' =&gt; $hours, 'minutes' =&gt; $minutes ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Takes the numeral equivalent of a $day: 0 for Sunday, 1 for Monday, etc</span>&nbsp;</div></li><li><div>function ass_set_weekly_digest_time( $day ) {&nbsp;</div></li><li><div>  if ( !$next_weekly = wp_next_scheduled( 'ass_digest_event' ) )&nbsp;</div></li><li><div>      $next_weekly = time() + 60;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  while ( date( 'w', $next_weekly ) != $day ) {&nbsp;</div></li><li><div>      $next_weekly += 86400;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Clear the old recurring event and set up a new one */</span></span>&nbsp;</div></li><li><div>  wp_clear_scheduled_hook( 'ass_digest_event_weekly' );&nbsp;</div></li><li><div>  wp_schedule_event( $next_weekly, 'weekly', 'ass_digest_event_weekly' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** Finally, save the option */</span></span>&nbsp;</div></li><li><div>  update_option( 'ass_weekly_digest', $day );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">// if in the future we want to do flexible schedules. this is how we could add the custom cron. Then we need to change the digest or summary to use this custom schedule.</span>&nbsp;</div></li><li><div><span class="comment">function ass_custom_digest_frequency( $schedules ) {</span>&nbsp;</div></li><li><div><span class="comment">  if( ( $freq = get_option(  'ass_digest_frequency' ) ) ) {</span>&nbsp;</div></li><li><div><span class="comment">      if( !isset( $schedules[$freq.'_hrs'] ) ) {</span>&nbsp;</div></li><li><div><span class="comment">          $schedules[$freq.'_hrs'] = array( 'interval' =&gt; $freq * 3600, 'display' =&gt; &quot;Every $freq hours&quot; );</span>&nbsp;</div></li><li><div><span class="comment">      }</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">  return $schedules;</span>&nbsp;</div></li><li><div><span class="comment">}</span>&nbsp;</div></li><li><div><span class="comment">add_filter( 'cron_schedules', 'ass_custom_digest_frequency' );</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the user_login, user_nicename and email address for an array of user IDs</span>&nbsp;</div></li><li><div><span class="comment"> * all in one fell swoop!</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is designed to avoid pinging the DB over and over in a foreach loop.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_get_mass_userdata( $user_ids = array() ) {&nbsp;</div></li><li><div>  if ( empty( $user_ids ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// implode user IDs</span>&nbsp;</div></li><li><div>  $in = implode( ', ', wp_parse_id_list( $user_ids ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get our results</span>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results( &quot;&nbsp;</div></li><li><div>      SELECT ID, user_login, user_nicename, user_email&nbsp;</div></li><li><div>          FROM {$wpdb-&gt;users}&nbsp;</div></li><li><div>          WHERE ID IN ({$in})&nbsp;</div></li><li><div>  &quot;, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $results ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// setup associative array</span>&nbsp;</div></li><li><div>  foreach( (array) $results as $result ) {&nbsp;</div></li><li><div>      $users[ $result['ID'] ]['user_login'] = $result['user_login'];&nbsp;</div></li><li><div>      $users[ $result['ID'] ]['user_nicename'] = $result['user_nicename'];&nbsp;</div></li><li><div>      $users[ $result['ID'] ]['email'] = $result['user_email'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $users;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get user domain.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Do not use this outside of digests!</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is almost a duplicate of bp_core_get_user_domain(), but references</span>&nbsp;</div></li><li><div><span class="comment"> * our already-fetched mass-userdata array to avoid pinging the DB over and</span>&nbsp;</div></li><li><div><span class="comment"> * over again in a foreach loop.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_digest_get_user_domain( $user_id ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $bp-&gt;ass-&gt;massdata ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $mass_userdata = $bp-&gt;ass-&gt;massdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $username = bp_is_username_compatibility_mode() ? $mass_userdata[ $user_id ]['user_login'] : $mass_userdata[ $user_id ]['user_nicename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_core_enable_root_profiles() ) {&nbsp;</div></li><li><div>      $after_domain = $username;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $after_domain =  bp_get_members_root_slug() . '/';&nbsp;</div></li><li><div>      $after_domain .= bp_is_username_compatibility_mode() ? rawurlencode( $username ) : $username;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $domain = trailingslashit( bp_get_root_domain() . '/' . $after_domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $domain = apply_filters( 'bp_core_get_user_domain_pre_cache', $domain, $user_id, $mass_userdata[ $user_id ]['user_nicename'], $mass_userdata[ $user_id ]['user_login'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'bp_core_get_user_domain', $domain, $user_id, $mass_userdata[ $user_id ]['user_nicename'], $mass_userdata[ $user_id ]['user_login'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// if the WP_Better_Emails plugin is installed, don't wrap the message with &lt;html&gt;&lt;body&gt;$message&lt;/body&gt;&lt;/html&gt;</span>&nbsp;</div></li><li><div>function ass_digest_support_wp_better_emails( $message, $message_pre_html_wrap ) {&nbsp;</div></li><li><div>  if ( class_exists( 'WP_Better_Emails' ) ) {&nbsp;</div></li><li><div>      $message = $message_pre_html_wrap;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $message;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'ass_digest_message_html', 'ass_digest_support_wp_better_emails', 10, 2 );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress Group Email Subscription</li><li><span></span>3.7.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>