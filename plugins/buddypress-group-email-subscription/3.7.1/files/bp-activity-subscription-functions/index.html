<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.7.1" data-slug="buddypress-group-email-subscription" data-type="file" data-id="30671"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-activity-subscription-functions | file | Buddypress Group Email Subscription | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, buddypress-group-email-subscription, 3.7.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.11"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=6321348772a2e30695d48d6b76b045ce' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.11' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-activity-subscription-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-subscription-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-activity-subscription-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-group-email-subscription-3.7.1-file-bp-activity-subscription-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-activity-subscription-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress-group-email-subscr&hellip;." href="http://hookr.io/plugins/buddypress-group-email-subscription/" class="plugin"><span property="name">buddypress-group-email-subscr&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.7.1." href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/" class="H_VERSION"><span property="name">3.7.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-activity-subscription-func&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="184"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/all/" title="All">All <span class="count badge">184</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="65"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/hooks/" title="Hooks">Hooks <span class="count badge">65</span></a></li><li class="" data-id="action" data-count="9"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/actions/" title="Actions">Actions <span class="count badge">9</span></a></li><li class="" data-id="filter" data-count="56"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/filters/" title="Filters">Filters <span class="count badge">56</span></a></li><li class="" data-id="class" data-count="6"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/classes/" title="Classes">Classes <span class="count badge">6</span></a></li><li class="" data-id="constant" data-count="2"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/constants/" title="Constants">Constants <span class="count badge">2</span></a></li><li class="" data-id="function" data-count="111"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/functions/" title="Functions">Functions <span class="count badge">111</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress-group-email-subscription/3.7.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-activity-subscription-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Core functions for GES.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// !SEND EMAIL UPDATES FOR FORUM TOPICS AND POSTS</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns an unsubscribe link to disable email notifications for a given group and/or all groups.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_group_unsubscribe_links( $user_id ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//$settings_link = &quot;{$bp-&gt;root_domain}/{$bp-&gt;groups-&gt;slug}/{$bp-&gt;groups-&gt;current_group-&gt;slug}/notifications/&quot;;</span>&nbsp;</div></li><li><div>  <span class="comment">//$links = sprintf( __( 'To disable these notifications please log in and go to: %s', 'bp-ass' ), $settings_link );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $links = sprintf( __( 'To disable all notifications for this group, click: %s', 'bp-ass' ), ass_get_group_unsubscribe_link_for_user( $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_option( 'ass-global-unsubscribe-link' ) == 'yes' ) {&nbsp;</div></li><li><div>      $links .= &quot;\n\n&quot; . sprintf( __( 'Or to disable notifications for *all* your groups, click: %s', 'bp-ass' ), ass_get_group_unsubscribe_link_for_user( $user_id, 0, true ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $links .= &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $links;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the group unsubscribe link for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int  $user_id  WP user ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int  $group_id BuddyPress group ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  bool $global   Should we use the global unsubscribe link? If 'false', we will use the</span>&nbsp;</div></li><li><div><span class="comment">*                       single group's unsubscribe link. Default: false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|bool URL for unsubscribe link on success; boolean false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_get_group_unsubscribe_link_for_user( $user_id = 0, $group_id = 0, $global = false ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'bpass-action' =&gt; 'unsubscribe', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use global unsubscribe link.</span>&nbsp;</div></li><li><div>  if ( true === $global ) {&nbsp;</div></li><li><div>      $access_key = md5( &quot;{$user_id}unsubscribe&quot; . wp_salt() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Single group unsubscribe link.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $group_id = empty( $group_id ) ? bp_get_current_group_id() : (int) $group_id;&nbsp;</div></li><li><div>      if ( empty( $group_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $access_key = md5( &quot;{$group_id}{$user_id}unsubscribe&quot; . wp_salt() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['group'] = $group_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args['access_key'] = $access_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return esc_url( add_query_arg( $args, bp_core_get_user_domain( $user_id ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Temporarily save the full activity content before activity KSES kicks in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * At the moment, we only do this for bbPress content since bbPress supports a</span>&nbsp;</div></li><li><div><span class="comment"> * larger amount of elements than BuddyPress' activity KSES filter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string               $retval   Current activity content.</span>&nbsp;</div></li><li><div><span class="comment"> * @param BP_Activity_Activity $activity Activity object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_group_notification_activity_content_before_save( $retval = '', BP_Activity_Activity $activity ) {&nbsp;</div></li><li><div>  <span class="comment">// If not bbPress content, bail.</span>&nbsp;</div></li><li><div>  if ( 0 !== strpos( $activity-&gt;type, 'bbp_' ) ) {&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Temporarily save bbPress content.</span>&nbsp;</div></li><li><div>  $GLOBALS['bp']-&gt;ges_content = $retval;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'bp_activity_content_before_save', 'ass_group_notification_activity_content_before_save', -999, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Records group activity items in GES for all activity except:</span>&nbsp;</div></li><li><div><span class="comment"> *  - group forum posts (handled in ass_group_notification_forum_posts())</span>&nbsp;</div></li><li><div><span class="comment"> *  - created and joined group entries (irrelevant)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You can do more fine-grained activity filtering with the</span>&nbsp;</div></li><li><div><span class="comment"> * 'ass_block_group_activity_types' filter.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_group_notification_activity( BP_Activity_Activity $activity ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $component = $activity-&gt;component;&nbsp;</div></li><li><div>  $sender_id = $activity-&gt;user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get group activity update replies to work (there is no group id passed in $content, but we can get it from $bp)</span>&nbsp;</div></li><li><div>  if ( $activity-&gt;type == 'activity_comment' && bp_is_groups_component() && $component == 'activity' ) {&nbsp;</div></li><li><div>      $component = 'groups';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// at this point we only want group activity, perhaps later we can make a function and interface for personal activity...</span>&nbsp;</div></li><li><div>  if ( $component != 'groups' ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if you want to conditionally block certain activity types from appearing, </span>&nbsp;</div></li><li><div>  <span class="comment">// use the filter below</span>&nbsp;</div></li><li><div>  if ( false === apply_filters( 'ass_block_group_activity_types', true, $activity-&gt;type, $activity ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !ass_registered_long_enough( $sender_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'activity_comment' === $activity-&gt;type ) { <span class="comment">// if it's an group activity comment, reset to the proper group id and append the group name to the action</span>&nbsp;</div></li><li><div>      <span class="comment">// this will need to be filtered for plugins manually adding group activity comments</span>&nbsp;</div></li><li><div>      $group_id = bp_get_current_group_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $action = ass_clean_subject( $activity-&gt;action ) . ' ' . __( 'in the group', 'bp-ass' ) . ' ' . bp_get_current_group_name();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $group_id = $activity-&gt;item_id;&nbsp;</div></li><li><div>      $action = ass_clean_subject( $activity-&gt;action );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $action = apply_filters( 'bp_ass_activity_notification_action', $action, $activity );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group = groups_get_group( array( 'group_id' =&gt; $group_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If it's an activity item, switch the activity permalink to the group homepage</span>&nbsp;</div></li><li><div><span class="comment">   * rather than the user's homepage.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $link = bp_get_group_permalink( $group );&nbsp;</div></li><li><div>  if ( $activity-&gt;primary_link && $activity-&gt;primary_link !== bp_core_get_user_domain( $sender_id ) ) {&nbsp;</div></li><li><div>      $link = $activity-&gt;primary_link;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $send_args = array(&nbsp;</div></li><li><div>      'group_id' =&gt; $group_id, &nbsp;</div></li><li><div>      'sender_id' =&gt; $sender_id, &nbsp;</div></li><li><div>      'activity_id' =&gt; $activity-&gt;id, &nbsp;</div></li><li><div>      'action' =&gt; $action, &nbsp;</div></li><li><div>      'content' =&gt; $activity-&gt;content, &nbsp;</div></li><li><div>      'link' =&gt; $link, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ass_generate_notification( $send_args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_activity_after_save' , 'ass_group_notification_activity' , 50 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate and send a group notification.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int $group_id ID of the group.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int $sender_id ID of the user triggering the activity.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int $activity_id ID of the activity item being triggered.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $action Activity action. Used to generate the email subject.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $content Activity content. Used to generate the email content.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string $link Primary link for the activity item.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_generate_notification( $args = array() ) {&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'group_id' =&gt; null, &nbsp;</div></li><li><div>      'sender_id' =&gt; null, &nbsp;</div></li><li><div>      'activity_id' =&gt; null, &nbsp;</div></li><li><div>      'action' =&gt; null, &nbsp;</div></li><li><div>      'content' =&gt; null, &nbsp;</div></li><li><div>      'link' =&gt; null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group = groups_get_group( array( 'group_id' =&gt; $r['group_id'] ) );&nbsp;</div></li><li><div>  if ( ! $group-&gt;id ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activity_obj = new BP_Activity_Activity( $r['activity_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Subject & Content */</span>&nbsp;</div></li><li><div>  $blogname = '[' . get_blog_option( BP_ROOT_BLOG, 'blogname' ) . ']';&nbsp;</div></li><li><div>  $subject = apply_filters( 'bp_ass_activity_notification_subject', $r['action'] . ' ' . $blogname, $r['action'], $blogname );&nbsp;</div></li><li><div>  $the_content = apply_filters( 'bp_ass_activity_notification_content', $r['content'], $activity_obj, $r['action'], $group );&nbsp;</div></li><li><div>  $the_content = ass_clean_content( $the_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If message has no content (as in the case of group joins, etc), we'll use a different</span>&nbsp;</div></li><li><div>  <span class="comment">// $message template</span>&nbsp;</div></li><li><div>  if ( empty( $the_content ) ) {&nbsp;</div></li><li><div>      $message = sprintf( __(&nbsp;</div></li><li><div>'%1$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>To view or reply, log in and go to:&nbsp;</div></li><li><div>%2$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>---------------------&nbsp;</div></li><li><div>', 'bp-ass' ), $r['action'], $r['link'] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $message = sprintf( __(&nbsp;</div></li><li><div>'%1$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&quot;%2$s&quot;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>To view or reply, log in and go to:&nbsp;</div></li><li><div>%3$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>---------------------&nbsp;</div></li><li><div>', 'bp-ass' ), $r['action'], $the_content, $r['link'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Use bbPress filtered post content and reapply GES filter... sigh.</span>&nbsp;</div></li><li><div>  if ( 0 === strpos( $activity_obj-&gt;type, 'bbp_' ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Not in global cache? Query for post content.</span>&nbsp;</div></li><li><div>      if ( empty( $GLOBALS['bp']-&gt;ges_content ) ) {&nbsp;</div></li><li><div>          $the_content = get_post_field( 'post_content', $activity_obj-&gt;secondary_item_id, 'raw' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $the_content = $GLOBALS['bp']-&gt;ges_content;&nbsp;</div></li><li><div>          unset( $GLOBALS['bp']-&gt;ges_content );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Apply bbPress KSES filter if it exists (sanity check!)</span>&nbsp;</div></li><li><div>      $the_content = ( true === function_exists( 'bbp_filter_kses' ) ) ? wp_unslash( bbp_filter_kses( $the_content ) ) : $the_content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $the_content = apply_filters( 'bp_ass_activity_notification_content', $the_content, $activity_obj, $r['action'], $group );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get subscribed users for the group</span>&nbsp;</div></li><li><div>  $subscribed_users = groups_get_groupmeta( $r['group_id'], 'ass_subscribed_users' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// this is used if a user is subscribed to the &quot;Weekly Summary&quot; option.</span>&nbsp;</div></li><li><div>  <span class="comment">// the weekly summary shouldn't record everything, so we have a filter:</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>  // 'ass_this_activity_is_important'&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>  // this hook can be used by plugin authors to record important activity items&nbsp;</div></li><li><div>  <span class="comment">// into the weekly summary</span>&nbsp;</div></li><li><div>  <span class="comment">// @see ass_default_weekly_summary_activity_types()</span>&nbsp;</div></li><li><div>  $this_activity_is_important = apply_filters( 'ass_this_activity_is_important', false, $activity_obj-&gt;type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// cycle through subscribed users</span>&nbsp;</div></li><li><div>  foreach ( (array) $subscribed_users as $user_id =&gt; $group_status ) {&nbsp;</div></li><li><div>      $self_notify = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If user is banned from group, do not send mail.</span>&nbsp;</div></li><li><div>      if ( groups_is_user_banned( $user_id, $group-&gt;id ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Does the author want updates of their own forum posts?</span>&nbsp;</div></li><li><div>      if ( $activity_obj-&gt;type == 'bbp_topic_create' || $activity_obj-&gt;type == 'bbp_reply_create' ) {&nbsp;</div></li><li><div>          if ( $user_id == $r['sender_id'] ) {&nbsp;</div></li><li><div>              $self_notify = ass_self_post_notification( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Author does not want notifications of their own posts</span>&nbsp;</div></li><li><div>              if ( ! $self_notify ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If this is an activity comment, and the $user_id is the user who is being replied</span>&nbsp;</div></li><li><div><span class="comment">       * to, check to make sure that the user is not subscribed to BP's native activity reply notifications.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      } elseif ( 'activity_comment' == $activity_obj-&gt;type ) {&nbsp;</div></li><li><div>          <span class="comment">// First, look at the immediate parent</span>&nbsp;</div></li><li><div>          $immediate_parent = new BP_Activity_Activity( $activity_obj-&gt;secondary_item_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Don't send the bp-ass notification if the user is subscribed through BP</span></span>&nbsp;</div></li><li><div>          if ( $user_id == $immediate_parent-&gt;user_id && 'no' != bp_get_user_meta( $user_id, 'notification_activity_new_reply', true ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We only need to check the root parent if it's different from the immediate parent.</span>&nbsp;</div></li><li><div>          if ( $activity_obj-&gt;secondary_item_id != $activity_obj-&gt;item_id ) {&nbsp;</div></li><li><div>              $root_parent = new BP_Activity_Activity( $activity_obj-&gt;item_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Don't send the bp-ass notification if the user is subscribed through BP</span></span>&nbsp;</div></li><li><div>              if ( $user_id == $root_parent-&gt;user_id && 'no' != bp_get_user_meta( $user_id, 'notification_activity_new_reply', true ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $send_it = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Self-notification email for bbPress posts</span>&nbsp;</div></li><li><div>      if ( $self_notify === true ) {&nbsp;</div></li><li><div>          $send_it = true;&nbsp;</div></li><li><div>          $group_status = 'self_notify';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// notification settings link</span>&nbsp;</div></li><li><div>          $settings_link = trailingslashit( bp_core_get_user_domain( $user_id ) . bp_get_settings_slug() ) . 'notifications/#groups-subscription-notification-settings';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// set notice</span>&nbsp;</div></li><li><div>          $notice = $email_setting_desc = __( 'You are currently receiving notifications for your own posts.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $email_setting_links = sprintf( __( 'To disable these notifications please log in and go to: %s', 'bp-ass' ), $settings_link );&nbsp;</div></li><li><div>          $email_setting_links .= &quot;\n\n&quot; . __( 'Once you are logged in, uncheck &quot;Receive notifications of your own posts?&quot;.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $notice .= &quot;\n\n&quot; . $email_setting_links;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User is subscribed to &quot;All Mail&quot;</span>&nbsp;</div></li><li><div>      <span class="comment">// OR user is subscribed to &quot;New Topics&quot; (bbPress 2)</span>&nbsp;</div></li><li><div>      } elseif ( $group_status == 'supersub' || ( $group_status == 'sub' && $activity_obj-&gt;type == 'bbp_topic_create' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * If someone is signed up for all email and they post a group update, </span>&nbsp;</div></li><li><div><span class="comment">           * they should not receive an email.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( 'activity_update' == $activity_obj-&gt;type && $r['sender_id'] === $user_id ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $send_it = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $settings_link = ass_get_login_redirect_url( trailingslashit( bp_get_group_permalink( $group ) . 'notifications' ), $group_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $email_setting_string = __( 'Your email setting for this group is: %s', 'bp-ass' );&nbsp;</div></li><li><div>          $group_status_string = ass_subscribe_translate( $group_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $notice = sprintf( $email_setting_string, $group_status_string );&nbsp;</div></li><li><div>          $email_setting_desc = sprintf( $email_setting_string, '&lt;strong&gt; ' . $group_status_string . '&lt;/strong&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $email_setting_links = sprintf( __( 'To change your email setting for this group, please log in and go to: %s', 'bp-ass' ), $settings_link );&nbsp;</div></li><li><div>          $email_setting_links .= &quot;\n\n&quot; . ass_group_unsubscribe_links( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $notice .= &quot;\n&quot; . $email_setting_links;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter whether a given user should receive immediate notification of the current activity.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool   $send_it True to send an immediate email notification, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">       * @param object $content Activity object.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $user_id ID of the user.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $send_it = apply_filters( 'bp_ass_send_activity_notification_for_user', $send_it, $activity_obj, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we're good to send, send the email!</span>&nbsp;</div></li><li><div>      if ( $send_it ) {&nbsp;</div></li><li><div>          $user_message_args = array(&nbsp;</div></li><li><div>              'message' =&gt; $message, &nbsp;</div></li><li><div>              'notice' =&gt; $notice, &nbsp;</div></li><li><div>              'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>              'subscription_type' =&gt; $group_status, &nbsp;</div></li><li><div>              'content' =&gt; $the_content, &nbsp;</div></li><li><div>              'settings_link' =&gt; ! empty( $settings_link ) ? $settings_link : '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// One last chance to filter the message content</span>&nbsp;</div></li><li><div>          $user_message = apply_filters( 'bp_ass_activity_notification_message', $message . $notice, $user_message_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the details for the user</span>&nbsp;</div></li><li><div>          $user = bp_core_get_core_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Send the email</span>&nbsp;</div></li><li><div>          if ( $user-&gt;user_email ) {&nbsp;</div></li><li><div>              <span class="comment">// Custom GES email tokens.</span>&nbsp;</div></li><li><div>              $user_message_args['ges.action'] = stripslashes( $activity_obj-&gt;action ); <span class="comment"><span class="comment">// Unfiltered.</span></span>&nbsp;</div></li><li><div>              $user_message_args['ges.subject'] = strip_tags( stripslashes( $r['action'] ) ); <span class="comment"><span class="comment">// Unfiltered.</span></span>&nbsp;</div></li><li><div>              $user_message_args['ges.email-setting-description'] = $email_setting_desc;&nbsp;</div></li><li><div>              $user_message_args['ges.email-setting-links'] = $email_setting_links;&nbsp;</div></li><li><div>              $user_message_args['ges.unsubscribe-global'] = ass_get_group_unsubscribe_link_for_user( $user-&gt;ID, $r['group_id'], true );&nbsp;</div></li><li><div>              $user_message_args['ges.unsubscribe'] = ass_get_group_unsubscribe_link_for_user( $user-&gt;ID, $r['group_id'] );&nbsp;</div></li><li><div>              $user_message_args['ges.settings-link'] = $user_message_args['settings_link'];&nbsp;</div></li><li><div>              $user_message_args['poster.url'] = bp_core_get_user_domain( $r['sender_id'] );&nbsp;</div></li><li><div>              $user_message_args['recipient.id'] = $user-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// BP-specific tokens.</span>&nbsp;</div></li><li><div>              $user_message_args['usermessage'] = $the_content;&nbsp;</div></li><li><div>              $user_message_args['poster.name'] = bp_core_get_user_displayname( $r['sender_id'] );&nbsp;</div></li><li><div>              $user_message_args['thread.url'] = $r['link'];&nbsp;</div></li><li><div>              $user_message_args['group.id'] = $r['group_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Remove tokens that we're not using.</span>&nbsp;</div></li><li><div>              unset( $user_message_args['content'], $user_message_args['notice'], $user_message_args['message'], $user_message_args['settings_link'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If activity type is not a bbPress item, add activity KSES filter.</span>&nbsp;</div></li><li><div>              if ( false === strpos( $activity_obj-&gt;type, 'bbp_' ) ) {&nbsp;</div></li><li><div>                  add_filter( 'bp_email_set_content_html', 'bp_activity_filter_kses', 6 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Sending time!</span></span>&nbsp;</div></li><li><div>              ass_send_email( 'bp-ges-single', $user-&gt;user_email, array(&nbsp;</div></li><li><div>                  'tokens' =&gt; $user_message_args, &nbsp;</div></li><li><div>                  'subject' =&gt; $subject, &nbsp;</div></li><li><div>                  'content' =&gt; $user_message&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Revert!</span>&nbsp;</div></li><li><div>              if ( false === strpos( $activity_obj-&gt;type, 'bbp_' ) ) {&nbsp;</div></li><li><div>                  remove_filter( 'bp_email_set_content_html', 'bp_activity_filter_kses', 6 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// otherwise, user is subscribed to &quot;Daily Digest&quot; so record item in digest!</span>&nbsp;</div></li><li><div>      <span class="comment">// OR user is subscribed to &quot;Weekly Summary&quot; and activity item is important</span>&nbsp;</div></li><li><div>      <span class="comment">// enough to be recorded</span>&nbsp;</div></li><li><div>      if ( $group_status == 'dig' || ( $group_status == 'sum' && $this_activity_is_important ) ) {&nbsp;</div></li><li><div>          ass_digest_record_activity( $r['activity_id'], $user_id, $r['group_id'], $group_status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Email wrapper function for BP-GES.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Created to be backward compatible when used on &lt; BP 2.5.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                   $email_type Type of email being sent.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array|int|WP_User $to         Either a email address, user ID, WP_User object, </span>&nbsp;</div></li><li><div><span class="comment"> *                                             or an array containg the address and name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array                    $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Optional. Array of extra parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array $tokens Optional. Assocative arrays of string replacements for the email.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|WP_Error True if the email was sent successfully. Otherwise, a WP_Error object</span>&nbsp;</div></li><li><div><span class="comment"> *                       describing why the email failed to send. The contents will vary based</span>&nbsp;</div></li><li><div><span class="comment"> *                       on the email delivery class you are using.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_send_email( $email_type, $to, $args ) {&nbsp;</div></li><li><div>  <span class="comment">// BP 2.5+</span>&nbsp;</div></li><li><div>  if ( true === function_exists( 'bp_send_email' ) && true === ! apply_filters( 'bp_email_use_wp_mail', false ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Unset array keys used for older BP installs.</span>&nbsp;</div></li><li><div>      unset( $args['subject'], $args['content'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Temporary save tokens.</span>&nbsp;</div></li><li><div>      buddypress()-&gt;ges_tokens = $args['tokens'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove BP's restrictive HTML filtering.</span>&nbsp;</div></li><li><div>      remove_filter( 'bp_email_set_content_html', 'wp_filter_post_kses', 6 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove BP's plain-text filter and convert the HTML email content to Markdown.</span>&nbsp;</div></li><li><div>      remove_filter( 'bp_email_set_content_plaintext', 'wp_strip_all_tags', 6 );&nbsp;</div></li><li><div>      add_filter( 'bp_email_get_property', 'ass_email_strip_trailing_breaklines', 1, 3 );&nbsp;</div></li><li><div>      add_filter( 'bp_email_get_property', 'ass_email_convert_html_to_plaintext', 20, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove default BP email footer.</span>&nbsp;</div></li><li><div>      add_action( 'bp_before_email_footer', 'ob_start', 999, 0 );&nbsp;</div></li><li><div>      add_action( 'bp_after_email_footer', 'ob_get_clean', -999, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add our custom BP email footer.</span>&nbsp;</div></li><li><div>      add_action( 'bp_after_email_footer', 'ass_bp_email_footer_text' );&nbsp;</div></li><li><div>      add_action( 'bp_after_email_footer', 'ass_bp_email_footer_html_unsubscribe_links' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['from'] ) ) {&nbsp;</div></li><li><div>          buddypress()-&gt;ges_from = $args['from'];&nbsp;</div></li><li><div>          add_action( 'bp_email_set_tokens', 'ass_email_set_from_during_token_addition', 10, 3 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Hook to do something before GES sends a BP email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $email_type The GES email type.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_ges_before_bp_send_email', $email_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the arguments before GES sends a BuddyPress email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $args       See bp_send_email()'s third argument for full documentation.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $email_type Current BP email post type.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args = apply_filters( 'ass_send_email_args', $args, $email_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Email time!</span>&nbsp;</div></li><li><div>      $send = bp_send_email( $email_type, (int) $args['tokens']['recipient.id'], $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clean up after ourselves!</span>&nbsp;</div></li><li><div>      add_filter( 'bp_email_set_content_html', 'wp_filter_post_kses', 6 );&nbsp;</div></li><li><div>      add_filter( 'bp_email_set_content_plaintext', 'wp_strip_all_tags', 6 );&nbsp;</div></li><li><div>      remove_filter( 'bp_email_get_property', 'ass_email_strip_trailing_breaklines', 1, 3 );&nbsp;</div></li><li><div>      remove_filter( 'bp_email_get_property', 'ass_email_convert_html_to_plaintext', 20, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Hook to do something after GES sends a BP email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $email_type The GES email type.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'bp_ges_after_bp_send_email', $email_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $send;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Older BP versions use wp_mail().</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $headers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['from'] ) ) {&nbsp;</div></li><li><div>          $headers[] = &quot;From: \&quot;{$args['from']['name']}\&quot; &lt;{$args['from']['email']}&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return wp_mail( $to, $args['subject'], $args['content'], $headers );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets the email situation type for use in GES.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Only applicable for BuddyPress 2.5+.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $email_type The email type to fetch.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $term_check Check if our GES email term exists before creating our specific email</span>&nbsp;</div></li><li><div><span class="comment"> *                           situation. Default: true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_set_email_type( $email_type, $term_check = true ) {&nbsp;</div></li><li><div>  $switched = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === bp_is_root_blog() ) {&nbsp;</div></li><li><div>      $switched = true;&nbsp;</div></li><li><div>      switch_to_blog( bp_get_root_blog_id() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( true === $term_check ) {&nbsp;</div></li><li><div>      $term = term_exists( $email_type, bp_get_email_tax_type() );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $term = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Term already exists so don't do anything.</span>&nbsp;</div></li><li><div>  if ( true === $term_check && $term !== 0 && $term !== null ) {&nbsp;</div></li><li><div>      if ( true === $switched ) {&nbsp;</div></li><li><div>          restore_current_blog();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create our email situation.</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Set up default email content depending on the email type.</span>&nbsp;</div></li><li><div>      switch ( $email_type ) {&nbsp;</div></li><li><div>          <span class="comment">// Group activity single items.</span>&nbsp;</div></li><li><div>          case 'bp-ges-single' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $post_title = __( '[{{{site.name}}}] {{{ges.subject}}}', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $html_content = __( &quot;{{{ges.action}}}:\n\n&lt;blockquote&gt;{{{usermessage}}}&lt;/blockquote&gt;\n&ndash;\n&lt;a href=\&quot;{{{thread.url}}}\&quot;&gt;Go to the discussion&lt;/a&gt; to reply or catch up on the conversation.\n{{{ges.email-setting-description}}}&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $plaintext_content = __( &quot;{{{ges.action}}}:\n\n\&quot;{{{usermessage}}}\&quot;\n\nGo to the discussion to reply or catch up on the conversation:\n{{{thread.url}}}\n\n----\n\n{{{ges.email-setting-description}}}\n\n{{{ges.email-setting-links}}}&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $situation_desc = __( 'A member created a group activity entry. Used by the Group Email Subscription plugin during immediate sendouts.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Digests.</span></span>&nbsp;</div></li><li><div>          case 'bp-ges-digest' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $post_title = __( '[{{{site.name}}}] {{{ges.subject}}}', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $html_content = __( &quot;{{{ges.digest-summary}}}{{{usermessage}}}\n&ndash;\nYou have received this message because you are subscribed to receive a digest of activity in some of your groups on {{site.name}}.&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $plaintext_content = __( &quot;{{{ges.digest-summary}}}\n\n{{{usermessage}}}\n\n----\n\nYou have received this message because you are subscribed to receive a digest of activity in some of your groups on {{{site.name}}}.\n\nTo disable these notifications per group, please login and [visit your groups page]({{{ges.settings-link}}}) where you can manage your email settings for each group.&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $situation_desc = __( 'An email digest is sent to a member. Used by the Group Email Subscription plugin during daily or weekly digest sendouts.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Admin notice.</span>&nbsp;</div></li><li><div>          case 'bp-ges-notice' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $post_title = __( '[{{{site.name}}}] {{{ges.subject}}} - from the group &quot;{{{group.name}}}&quot;', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $html_content = __( &quot;This is a notice from the group {{{group.link}}}:\n\n{{{usermessage}}}\n\n&ndash;\n&lt;strong&gt;Please note:&lt;/strong&gt; admin notices are sent to everyone in the group and cannot be disabled.\nIf you feel this service is being misused please speak to the website administrator.&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $plaintext_content = __( &quot;This is a notice from the group \&quot;{{{group.name}}}\&quot;:\n\n\&quot;{{{usermessage}}}\&quot;\n\n----\n\nPlease note: admin notices are sent to everyone in the group and cannot be disabled.\n\nIf you feel this service is being misused please speak to the website administrator.\n\nTo visit the group homepage, click on the link below:\n{{{group.url}}}&quot;, 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $situation_desc = __( 'An email notice is sent by a group administrator to all members of the group. Used by the Group Email Subscription plugin.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Welcome email.</span>&nbsp;</div></li><li><div>          case 'bp-ges-welcome' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: do not remove {} brackets or translate its contents. */</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $post_title = __( '[{{{site.name}}}] {{{ges.subject}}}', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $html_content = $plaintext_content = &quot;{{{usermessage}}}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $situation_desc = __( 'A welcome email is sent to new members of a group. Used by the Group Email Subscription plugin.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Sanity check!</span>&nbsp;</div></li><li><div>      if ( false === isset( $post_title ) ) {&nbsp;</div></li><li><div>          if ( true === $switched ) {&nbsp;</div></li><li><div>              restore_current_blog();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = $email_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>          'post_type' =&gt; bp_get_email_post_type(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $email = array(&nbsp;</div></li><li><div>          'post_title' =&gt; $post_title, &nbsp;</div></li><li><div>          'post_content' =&gt; $html_content, &nbsp;</div></li><li><div>          'post_excerpt' =&gt; $plaintext_content, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Email post content.</span>&nbsp;</div></li><li><div>      $post_id = wp_insert_post( bp_parse_args( $email, $defaults, 'install_email_' . $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save the situation.</span>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $post_id ) ) {&nbsp;</div></li><li><div>          $tt_ids = wp_set_object_terms( $post_id, $id, bp_get_email_tax_type() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Situation description.</span>&nbsp;</div></li><li><div>          if ( ! is_wp_error( $tt_ids ) ) {&nbsp;</div></li><li><div>              $term = get_term_by( 'term_taxonomy_id', (int) $tt_ids[0], bp_get_email_tax_type() );&nbsp;</div></li><li><div>              wp_update_term( (int) $term-&gt;term_id, bp_get_email_tax_type(), array(&nbsp;</div></li><li><div>                  'description' =&gt; $situation_desc, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( true === $switched ) {&nbsp;</div></li><li><div>      restore_current_blog();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets 'From' email header for BuddyPress 2.5 emails during token addition.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array    $retval Formatted tokens.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array    $tokens Unformatted tokens.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  BP_Email $email  BP Email object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array    Token array.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_email_set_from_during_token_addition( $retval, $tokens, BP_Email $email ) {&nbsp;</div></li><li><div>  if ( isset( buddypress()-&gt;ges_from ) ) {&nbsp;</div></li><li><div>      $email-&gt;set_from( buddypress()-&gt;ges_from['email'], buddypress()-&gt;ges_from['name'] );&nbsp;</div></li><li><div>      unset( buddypress()-&gt;ges_from );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $retval;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Strip trailing breaklines created by BuddyPress during token additions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see BP_Email::get() and the nl2br() call.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content   Content to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $prop      Property to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $transform Transform type to check.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_email_strip_trailing_breaklines( $content = '', $prop = '', $transform = '' ) {&nbsp;</div></li><li><div>  if ( $transform !== 'add-content' ) {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $find = array(&nbsp;</div></li><li><div>      'ul&gt;&lt;br /&gt;', &nbsp;</div></li><li><div>      'ol&gt;&lt;br /&gt;', &nbsp;</div></li><li><div>      'li&gt;&lt;br /&gt;', &nbsp;</div></li><li><div>      '&lt;/p&gt;&lt;br /&gt;', &nbsp;</div></li><li><div>      '&lt;/blockquote&gt;&lt;br /&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $replace = array(&nbsp;</div></li><li><div>      'ul&gt;', &nbsp;</div></li><li><div>      'ol&gt;', &nbsp;</div></li><li><div>      'li&gt;', &nbsp;</div></li><li><div>      '&lt;/p&gt;', &nbsp;</div></li><li><div>      '&lt;/blockquote&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return str_replace( $find, $replace, $content );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Convert HTML over to a form of Markdown plaintext.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Do not confuse with {@link ass_convert_html_to_text()}. That function</span>&nbsp;</div></li><li><div><span class="comment"> * strips tags.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses html2text() by Jevon Wright. Licensed under the EPL v1.0 and LGPL v3.0.</span>&nbsp;</div></li><li><div><span class="comment"> *       We use a fork of 0.1.1 to maintain PHP 5.2 compatibility.</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://github.com/r-a-y/html2text/tree/0.1.x</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://github.com/soundasleep/html2text/</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The HTML content to convert to plaintext.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $prop    Unused. This is only used by the 'bp_email_get_property' filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $prop    Unused. This is only used by the 'bp_email_get_property' filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_email_convert_html_to_plaintext( $content = '', $prop = 'content_plaintext', $transform = 'replace-tokens' ) {&nbsp;</div></li><li><div>  if ( empty( $content ) || 'content_plaintext' !== $prop || 'replace-tokens' !== $transform ) {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === function_exists( 'convert_html_to_text' ) ) {&nbsp;</div></li><li><div>      require dirname( __FILE__ ) . '/html2text.php';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Suppress warnings when using DOMDocument.</span>&nbsp;</div></li><li><div>  <span class="comment">// This addresses issues when failing to parse certain HTML.</span>&nbsp;</div></li><li><div>  if ( function_exists( 'libxml_use_internal_errors' ) ) {&nbsp;</div></li><li><div>      libxml_use_internal_errors( true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Convert newlines to breaklines before using our HTML to text function.</span>&nbsp;</div></li><li><div>  return convert_html_to_text( nl2br( $content ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output footer text from the BP Emails Customizer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * For BuddyPress 2.5+.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_bp_email_footer_text() {&nbsp;</div></li><li><div>  if ( false === function_exists( 'bp_email_get_appearance_settings' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $settings = bp_email_get_appearance_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $footer_text = stripslashes( $settings['footer_text'] );&nbsp;</div></li><li><div>  if ( $footer_text ) :&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;span class=&quot;footer_text&quot;&gt;&lt;?php echo nl2br( $footer_text ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>  &lt;br&gt;&lt;br&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add custom BP email footer for HTML emails.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We want to override the default {{unsubscribe}} token with something else.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_bp_email_footer_html_unsubscribe_links() {&nbsp;</div></li><li><div>  $tokens = buddypress()-&gt;ges_tokens;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $tokens['subscription_type'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $link_format = '&lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot; style=&quot;text-decoration: underline;&quot;&gt;%3$s&lt;/a&gt;';&nbsp;</div></li><li><div>  $footer_links = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch( $tokens['subscription_type'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Self-notifications.</span>&nbsp;</div></li><li><div>      case 'self_notify' :&nbsp;</div></li><li><div>          $footer_links[] = sprintf( $link_format, &nbsp;</div></li><li><div>              $tokens['ges.settings-link'], &nbsp;</div></li><li><div>              esc_attr__( 'Once you are logged in, uncheck &quot;Receive notifications of your own posts?&quot;.', 'bp-ass' ), &nbsp;</div></li><li><div>              esc_html__( 'Change email settings', 'bp-ass' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// 'New Topics' or 'All Mail'.</span>&nbsp;</div></li><li><div>      case 'sub':&nbsp;</div></li><li><div>      case 'supersub':&nbsp;</div></li><li><div>          $footer_links[] = sprintf( $link_format, &nbsp;</div></li><li><div>              $tokens['ges.settings-link'], &nbsp;</div></li><li><div>              esc_attr__( 'To change your email settings for this group only, click on this link', 'bp-ass' ), &nbsp;</div></li><li><div>              esc_html__( 'Change group email Settings', 'bp-ass' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $footer_links[] = sprintf( '&lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot;&gt;%3$s&lt;/a&gt;', &nbsp;</div></li><li><div>              $tokens['ges.unsubscribe'], &nbsp;</div></li><li><div>              esc_attr__( 'To disable all notifications for this group, click on this link', 'bp-ass' ), &nbsp;</div></li><li><div>              esc_html__( 'Unsubscribe from this group', 'bp-ass' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'yes' == get_option( 'ass-global-unsubscribe-link' ) ) {&nbsp;</div></li><li><div>              $footer_links[] = sprintf( $link_format, &nbsp;</div></li><li><div>                  $tokens['ges.unsubscribe-global'], &nbsp;</div></li><li><div>                  esc_attr__( 'To disable notifications from all your groups, click on this link', 'bp-ass' ), &nbsp;</div></li><li><div>                  esc_html__( 'Unsubscribe from all groups', 'bp-ass' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Digests.</span></span>&nbsp;</div></li><li><div>      case 'dig' :&nbsp;</div></li><li><div>      case 'sum' :&nbsp;</div></li><li><div>          $footer_links[] = sprintf( $link_format, &nbsp;</div></li><li><div>              $tokens['ges.settings-link'], &nbsp;</div></li><li><div>              esc_attr__( 'Once you are logged in, change your email settings for each group.', 'bp-ass' ), &nbsp;</div></li><li><div>              esc_html__( 'Change email settings', 'bp-ass' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $footer_links ) ) {&nbsp;</div></li><li><div>      echo implode( ' &middot; ', $footer_links );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset( buddypress()-&gt;ges_tokens );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Activity edit checker.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Catch attempts to save activity entries to see if they already exist.</span>&nbsp;</div></li><li><div><span class="comment"> * If they do exist, stop GES from doing its thang.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.2.2</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_group_activity_edits( $activity ) {&nbsp;</div></li><li><div>  <span class="comment">// hack to avoid duplicate action firing during activity saving</span>&nbsp;</div></li><li><div>  <span class="comment">// @see https://buddypress.trac.wordpress.org/ticket/3980</span>&nbsp;</div></li><li><div>  static $run_once = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $run_once ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if the activity doesn't match the groups component, stop now</span>&nbsp;</div></li><li><div>  if ( $activity-&gt;component != 'groups' )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if the activity ID already exists, this means this is an edit</span>&nbsp;</div></li><li><div>  <span class="comment">// we don't want GES to send emails for edits!</span>&nbsp;</div></li><li><div>  if ( ! empty( $activity-&gt;id ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Make sure GES doesn't fire</span>&nbsp;</div></li><li><div>      remove_action( 'bp_activity_after_save', 'ass_group_notification_activity', 50 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $run_once = true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_activity_before_save', 'ass_group_activity_edits' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Block some activity types from being sent / recorded in groups.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.2.2</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_default_block_group_activity_types( $retval, $type, $activity ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch( $type ) {&nbsp;</div></li><li><div>      <span class="comment">/** ACTIVITY TYPES TO BLOCK **************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// we handle these in ass_group_notification_forum_posts()</span>&nbsp;</div></li><li><div>      case 'new_forum_topic' :&nbsp;</div></li><li><div>      case 'new_forum_post' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// @todo in the future, it might be nice for admins to optionally get this message</span>&nbsp;</div></li><li><div>      case 'joined_group' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'created_group' :&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** bbPress 2 ****************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// groan! bbPress 2 hacks!</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>      // when bbPress first records an item into the group activity stream, it is&nbsp;</div></li><li><div>      <span class="comment">// incomplete as it is first recorded on the 'wp_insert_post' action</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>      // it is later updated on the 'bbp_new_reply' / 'bbp_new_topic' action&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>      // we want to block the first instance, so GES doesn't record or send this&nbsp;</div></li><li><div>      <span class="comment">// incomplete activity item</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// reply</span>&nbsp;</div></li><li><div>      case 'bbp_reply_create' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// to determine if the reply activity item is incomplete, the primary link</span>&nbsp;</div></li><li><div>          <span class="comment">// will be missing the scheme (HTTP) and host (example.com), so our hack does</span>&nbsp;</div></li><li><div>          <span class="comment">// a search for '://' because the site could be using HTTPS.</span>&nbsp;</div></li><li><div>          if ( strpos( $activity-&gt;primary_link, ':<span class="comment">//' ) === false ) {</span>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// we're okay again!</span></span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $retval;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// topic</span>&nbsp;</div></li><li><div>      case 'bbp_topic_create' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// to determine if the topic activity item is incomplete, the primary link</span>&nbsp;</div></li><li><div>          <span class="comment">// will be missing the groups root slug</span>&nbsp;</div></li><li><div>          if ( strpos( $activity-&gt;primary_link, '/' . bp_get_groups_root_slug() . '/' ) === false ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// we're okay again!</span></span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $retval;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** ALL OTHER TYPES **********************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'ass_block_group_activity_types', 'ass_default_block_group_activity_types', 5, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Allow certain activity types to be recorded for users subscribed to the</span>&nbsp;</div></li><li><div><span class="comment"> * &quot;Weekly Summary&quot; option.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The rationale behind this is the weekly summary shouldn't record every</span>&nbsp;</div></li><li><div><span class="comment"> * single activity item because the summary could get rather long.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.2.4</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_default_weekly_summary_activity_types( $retval, $type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch( $type ) {&nbsp;</div></li><li><div>      <span class="comment">/** ACTIVITY TYPES TO RECORD FOR WEEKLY SUMMARY ******************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// backpat items</span>&nbsp;</div></li><li><div>      case 'wiki_group_page_create' :&nbsp;</div></li><li><div>      case 'new_calendar_event' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// bbPress 2 forum topic</span>&nbsp;</div></li><li><div>      case 'bbp_topic_create' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// activity update</span>&nbsp;</div></li><li><div>      case 'activity_update' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** ALL OTHER TYPES **********************************************/</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'ass_this_activity_is_important', 'ass_default_weekly_summary_activity_types', 1, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Login redirector.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If group is not public, the group link in the email will use {@link wp_login_url()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If a user clicks on this link and is already logged in, we should attempt</span>&nbsp;</div></li><li><div><span class="comment"> * to redirect the user to the authorized content instead of forcing the user</span>&nbsp;</div></li><li><div><span class="comment"> * to re-authenticate.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.2.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses bp_loggedin_user_id() To see if a user is logged in</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_login_redirector() {&nbsp;</div></li><li><div>  <span class="comment">// see if a redirect link was passed</span>&nbsp;</div></li><li><div>  if ( empty( $_GET['redirect_to'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// see if our special 'auth' variable was passed</span>&nbsp;</div></li><li><div>  if( empty( $_GET['auth'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if user is *not* logged in, stop now!</span>&nbsp;</div></li><li><div>  if ( ! bp_loggedin_user_id() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// user is logged in, so let's redirect them to the content</span>&nbsp;</div></li><li><div>  wp_safe_redirect( esc_url_raw( $_GET['redirect_to'] ) );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'login_init', 'ass_login_redirector', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the login URL with a redirect link.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Pass the link you want the user to redirect to when authenticated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Redirection occurs in {@link ass_login_redirector()}.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url The URL you want to redirect to.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $context The context of the redirect.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed String of the login URL with the passed redirect link. Boolean false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_get_login_redirect_url( $url = '', $context = '' ) {&nbsp;</div></li><li><div>  $url = esc_url_raw( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $url ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// setup query args</span>&nbsp;</div></li><li><div>  $query_args = array(&nbsp;</div></li><li><div>      'action' =&gt; 'bpnoaccess', &nbsp;</div></li><li><div>      'auth' =&gt; 1, &nbsp;</div></li><li><div>      'redirect_to' =&gt; apply_filters( 'ass_login_redirect_to', urlencode( $url ), $context )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return add_query_arg(&nbsp;</div></li><li><div>      $query_args, &nbsp;</div></li><li><div>      apply_filters( 'ass_login_url', wp_login_url() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>//    !GROUP SUBSCRIPTION&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// returns the subscription status of a user in a group</span>&nbsp;</div></li><li><div>function ass_get_group_subscription_status( $user_id, $group_id ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$user_id )&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$group_id )&nbsp;</div></li><li><div>      $group_id = bp_get_current_group_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_user_subscriptions = groups_get_groupmeta( $group_id, 'ass_subscribed_users' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_subscription = isset( $group_user_subscriptions[$user_id] ) ? $group_user_subscriptions[$user_id] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_subscription;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// updates the group's user subscription list.</span>&nbsp;</div></li><li><div>function ass_group_subscription( $action, $user_id, $group_id ) {&nbsp;</div></li><li><div>  if ( !$action || !$user_id || !$group_id )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_user_subscriptions = groups_get_groupmeta( $group_id , 'ass_subscribed_users' );&nbsp;</div></li><li><div>  if ( ! is_array( $group_user_subscriptions ) ) {&nbsp;</div></li><li><div>      $group_user_subscriptions = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// we're being overly careful here</span>&nbsp;</div></li><li><div>  if ( $action == 'no' ) {&nbsp;</div></li><li><div>      $group_user_subscriptions[ $user_id ] = 'no';&nbsp;</div></li><li><div>  } elseif ( $action == 'sum' ) {&nbsp;</div></li><li><div>      $group_user_subscriptions[ $user_id ] = 'sum';&nbsp;</div></li><li><div>  } elseif ( $action == 'dig' ) {&nbsp;</div></li><li><div>      $group_user_subscriptions[ $user_id ] = 'dig';&nbsp;</div></li><li><div>  } elseif ( $action == 'sub' ) {&nbsp;</div></li><li><div>      $group_user_subscriptions[ $user_id ] = 'sub';&nbsp;</div></li><li><div>  } elseif ( $action == 'supersub' ) {&nbsp;</div></li><li><div>      $group_user_subscriptions[ $user_id ] = 'supersub';&nbsp;</div></li><li><div>  } elseif ( $action == 'delete' ) {&nbsp;</div></li><li><div>      if ( isset( $group_user_subscriptions[ $user_id ] ) )&nbsp;</div></li><li><div>          unset( $group_user_subscriptions[ $user_id ] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  groups_update_groupmeta( $group_id , 'ass_subscribed_users', $group_user_subscriptions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// add a hook for 3rd-party plugin devs</span>&nbsp;</div></li><li><div>  do_action( 'ass_group_subscription', $user_id, $group_id, $action );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// translate the short code subscription status into a nicer version</span>&nbsp;</div></li><li><div>function ass_subscribe_translate( $status ) {&nbsp;</div></li><li><div>  if ( $status == 'no' || !$status )&nbsp;</div></li><li><div>      $output = __('No Email', 'bp-ass');&nbsp;</div></li><li><div>  elseif ( $status == 'sum' )&nbsp;</div></li><li><div>      $output = __('Weekly Summary', 'bp-ass');&nbsp;</div></li><li><div>  elseif ( $status == 'dig' )&nbsp;</div></li><li><div>      $output = __('Daily Digest', 'bp-ass');&nbsp;</div></li><li><div>  elseif ( $status == 'sub' )&nbsp;</div></li><li><div>      $output = __('New Topics', 'bp-ass');&nbsp;</div></li><li><div>  elseif ( $status == 'supersub' )&nbsp;</div></li><li><div>      $output = __('All Email', 'bp-ass');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Handles AJAX request to subscribe/unsubscribe from group</span>&nbsp;</div></li><li><div>function ass_group_ajax_callback() {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>  <span class="comment">//check_ajax_referer( &quot;ass_group_subscribe&quot; );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $action = $_POST['a'];&nbsp;</div></li><li><div>  $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>  $group_id = $_POST['group_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ass_group_subscription( $action, $user_id, $group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $action;&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_ass_group_ajax', 'ass_group_ajax_callback' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// if the user leaves the group or if they are removed by an admin, delete their subscription status</span>&nbsp;</div></li><li><div>function ass_unsubscribe_on_leave( $group_id, $user_id ) {&nbsp;</div></li><li><div>  ass_group_subscription( 'delete', $user_id, $group_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'groups_leave_group', 'ass_unsubscribe_on_leave', 100, 2 );&nbsp;</div></li><li><div>add_action( 'groups_remove_member', 'ass_unsubscribe_on_leave', 100, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>//    !Default Group Subscription&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">// when a user joins a group, set their default subscription level</span>&nbsp;</div></li><li><div>function ass_set_default_subscription( $groups_member ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// only set the default if the user has no subscription history for this group</span>&nbsp;</div></li><li><div>  if ( ass_get_group_subscription_status( $groups_member-&gt;user_id, $groups_member-&gt;group_id ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if the person has requested access to a private group but has not been approved, don't subscribe them</span>&nbsp;</div></li><li><div>  if ( !$groups_member-&gt;is_confirmed )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_gsub = apply_filters( 'ass_default_subscription_level', groups_get_groupmeta( $groups_member-&gt;group_id, 'ass_default_subscription' ), $groups_member-&gt;group_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $default_gsub ) {&nbsp;</div></li><li><div>      ass_group_subscription( $default_gsub, $groups_member-&gt;user_id, $groups_member-&gt;group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'groups_member_after_save', 'ass_set_default_subscription', 20, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// echo subscription default checked setting for the group admin settings - default to 'unsubscribed' in group creation</span>&nbsp;</div></li><li><div>function ass_default_subscription_settings( $setting ) {&nbsp;</div></li><li><div>  $stored_setting = ass_get_default_subscription();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $setting == $stored_setting )&nbsp;</div></li><li><div>      echo ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>  else if ( $setting == 'no' && !$stored_setting )&nbsp;</div></li><li><div>      echo ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Save the default group subscription setting in the group meta, if no, delete it</span>&nbsp;</div></li><li><div>function ass_save_default_subscription( $group ) {&nbsp;</div></li><li><div>  if ( isset( $_POST['ass-default-subscription'] ) && $postval = $_POST['ass-default-subscription'] ) {&nbsp;</div></li><li><div>      if ( $postval ) {&nbsp;</div></li><li><div>          groups_update_groupmeta( $group-&gt;id, 'ass_default_subscription', $postval );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// during group creation, also save the sub level for the group creator</span>&nbsp;</div></li><li><div>          if ( 'group-settings' == bp_get_groups_current_create_step() ) {&nbsp;</div></li><li><div>              ass_group_subscription( $postval, $group-&gt;creator_id, $group-&gt;id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'groups_group_after_save', 'ass_save_default_subscription' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Get the default subscription settings for the group</span>&nbsp;</div></li><li><div>function ass_get_default_subscription( $group = false ) {&nbsp;</div></li><li><div>  global $bp, $groups_template;&nbsp;</div></li><li><div>  if ( !$group )&nbsp;</div></li><li><div>      $group =& $groups_template-&gt;group;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $group-&gt;id ) )&nbsp;</div></li><li><div>      $group_id = $group-&gt;id;&nbsp;</div></li><li><div>  else if ( isset( $bp-&gt;groups-&gt;new_group_id ) )&nbsp;</div></li><li><div>      $group_id = $bp-&gt;groups-&gt;new_group_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_subscription =  groups_get_groupmeta( $group_id, 'ass_default_subscription' );&nbsp;</div></li><li><div>  return apply_filters( 'ass_get_default_subscription', $default_subscription );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>//    !SUPPORT FUNCTIONS&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">// return array of users who match a usermeta value</span>&nbsp;</div></li><li><div>function ass_user_settings_array( $setting ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results( &quot;SELECT user_id, meta_value FROM $wpdb-&gt;usermeta WHERE meta_key LIKE '{$setting}'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $settings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $results as $result ) {&nbsp;</div></li><li><div>      $settings[ $result-&gt;user_id ] = $result-&gt;meta_value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $settings;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">// here lies a failed attempt ...</span>&nbsp;</div></li><li><div><span class="comment">// return array of users who are admins or mods in a specific group</span>&nbsp;</div></li><li><div><span class="comment">function ass_get_group_admins_mods( $group_id ) {</span>&nbsp;</div></li><li><div><span class="comment">  global $bp;</span>&nbsp;</div></li><li><div><span class="comment">  $results = $wpdb-&gt;get_results( &quot;SELECT user_id, is_admin, is_mod FROM {$bp-&gt;groups-&gt;table_name_members} WHERE group_id = $group_id AND (is_admin = 1 OR is_mod = 1)&quot;, ARRAY_A );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  return $results;</span>&nbsp;</div></li><li><div><span class="comment">}</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Cleans up the email content</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * By default we do the following to outgoing email content:</span>&nbsp;</div></li><li><div><span class="comment"> *   - strip slashes</span>&nbsp;</div></li><li><div><span class="comment"> *   - convert anchor tags to &quot;Link Text &lt;URL&gt;&quot; format, then strip other HTML tags</span>&nbsp;</div></li><li><div><span class="comment"> *   - convert HTML entities</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Filter 'ass_clean_content' to modify our cleaning routine</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The email content</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $clean_content The email content, cleaned up for plaintext email</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_clean_content( $content ) {&nbsp;</div></li><li><div>  return apply_filters( 'ass_clean_content', $content );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">// By default, we run content through these filters, which can be individually removed</span></span>&nbsp;</div></li><li><div>add_filter( 'ass_clean_content', 'stripslashes', 2 );&nbsp;</div></li><li><div>add_filter( 'ass_clean_content', 'strip_tags', 4 );&nbsp;</div></li><li><div>add_filter( 'ass_clean_content', 'ass_convert_links', 6 );&nbsp;</div></li><li><div>add_filter( 'ass_clean_content', 'ass_html_entity_decode', 8 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Wrapper for html_entity_decode() that can be used as an apply_filters() callback</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_html_entity_decode( $content ) {&nbsp;</div></li><li><div>  return html_entity_decode( $content, ENT_QUOTES );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Convert &lt;a&gt; tags to a plain-text version.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Links like &lt;a href=&quot;http://foo.com&quot;&gt;Foo&lt;/a&gt; become Foo &lt;http://foo.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_convert_links( $content ) {&nbsp;</div></li><li><div>  $pattern = '|&lt;a .*?href=[&quot;\']([a-zA-Z0-9\-_\./:]+?)[&quot;\'].*?&gt;([^&lt;]+)&lt;/a&gt;|';&nbsp;</div></li><li><div>  $content = preg_replace( $pattern, '\2 &lt;\1&gt;', $content );&nbsp;</div></li><li><div>  return $content;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Cleans up the subject for email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function does a few things:</span>&nbsp;</div></li><li><div><span class="comment"> *  - Add quotes to topic name</span>&nbsp;</div></li><li><div><span class="comment"> *  - Strips trailing colon</span>&nbsp;</div></li><li><div><span class="comment"> *  - Strips slashes, HTML</span>&nbsp;</div></li><li><div><span class="comment"> *  - Convert HTML entities</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $subject The email subject line to clean</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $add_quotes Should we try to add quotes to forum topics?</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_clean_subject( $subject, $add_quotes = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// this feature of adding quotes only happens in english installs</span>&nbsp;</div></li><li><div>  <span class="comment">// and is not that useful in the HTML digest</span>&nbsp;</div></li><li><div>  if ( $add_quotes === true ) {&nbsp;</div></li><li><div>      $subject_quotes = preg_replace( '/posted on the forum topic /', 'posted on the forum topic &quot;', $subject );&nbsp;</div></li><li><div>      $subject_quotes = preg_replace( '/started the forum topic /', 'started the forum topic &quot;', $subject_quotes );&nbsp;</div></li><li><div>      if ( $subject != $subject_quotes )&nbsp;</div></li><li><div>          $subject = preg_replace( '/ in the group /', '&quot; in the group ', $subject_quotes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subject = preg_replace( '/:$/', '', $subject ); <span class="comment"><span class="comment">// remove trailing colon</span></span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'ass_clean_subject', $subject );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment">// By default, we run content through these filters, which can be individually removed</span></span>&nbsp;</div></li><li><div>add_filter( 'ass_clean_subject', 'stripslashes', 2 );&nbsp;</div></li><li><div>add_filter( 'ass_clean_subject', 'strip_tags', 4 );&nbsp;</div></li><li><div>add_filter( 'ass_clean_subject', 'ass_html_entity_decode', 8 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_clean_subject_html( $subject ) {&nbsp;</div></li><li><div>  $subject = preg_replace( '/:$/', '', $subject ); <span class="comment"><span class="comment">// remove trailing colon</span></span>&nbsp;</div></li><li><div>  return apply_filters( 'ass_clean_subject_html', $subject );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Check how long the user has been registered and return false if not long enough. Return true if setting not active off ( ie. 'n/a')</span>&nbsp;</div></li><li><div>function ass_registered_long_enough( $activity_user_id ) {&nbsp;</div></li><li><div>  $ass_reg_age_setting = get_site_option( 'ass_activity_frequency_ass_registered_req' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_numeric( $ass_reg_age_setting ) ) {&nbsp;</div></li><li><div>      $current_user_info = get_userdata( $activity_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strtotime(current_time(&quot;mysql&quot;, 0)) - strtotime($current_user_info-&gt;user_registered) &lt; ( $ass_reg_age_setting*24*60*60 ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Allow group admins and mods to manage each group member's email</span>&nbsp;</div></li><li><div><span class="comment"> * subscription settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is only enabled if this option is enabled under the main &quot;Group Email</span>&nbsp;</div></li><li><div><span class="comment"> * Options&quot; settings page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is hooked to:</span>&nbsp;</div></li><li><div><span class="comment"> *  - The frontend group's &quot;Admin &gt; Members&quot; page</span>&nbsp;</div></li><li><div><span class="comment"> *  - The backend group's &quot;Manage Members&quot; metabox (only in BP 1.8+)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The user ID of the group member</span>&nbsp;</div></li><li><div><span class="comment"> * @param obj $group The BP Group object</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_manage_members_email_status(  $user_id = '', $group = '' ) {&nbsp;</div></li><li><div>  global $members_template, $groups_template;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if group admins / mods cannot manage email subscription settings, stop now!</span>&nbsp;</div></li><li><div>  if ( get_option('ass-admin-can-edit-email') == 'no' ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no user ID? fallback on members loop user ID if it exists</span>&nbsp;</div></li><li><div>  if ( ! $user_id || ! is_numeric( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = ! empty( $members_template-&gt;member-&gt;user_id ) ? $members_template-&gt;member-&gt;user_id : false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no user ID? fallback on group loop if it exists</span>&nbsp;</div></li><li><div>  if( ! $group ) {&nbsp;</div></li><li><div>      $group = ! empty( $groups_template-&gt;group ) ? $groups_template-&gt;group : false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no user or group? stop now!</span>&nbsp;</div></li><li><div>  if ( ! $user_id || ! is_object( $group ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_url = bp_get_group_permalink( $group ) . 'admin/manage-members/email';&nbsp;</div></li><li><div>  $sub_type = ass_get_group_subscription_status( $user_id, $group-&gt;id );&nbsp;</div></li><li><div>  echo '&lt;span class=&quot;ass_manage_members_links&quot;&gt; '.__('Email status:', 'bp-ass').' ' . ass_subscribe_translate( $sub_type ) . '.';&nbsp;</div></li><li><div>  echo ' &nbsp; '.__('Change to:', 'bp-ass').' ';&nbsp;</div></li><li><div>  echo '&lt;a href=&quot;' . wp_nonce_url( $group_url.'/no/'.$user_id, 'ass_member_email_status' ) . '&quot;&gt;'.__('No Email', 'bp-ass').'&lt;/a&gt; | ';&nbsp;</div></li><li><div>  echo '&lt;a href=&quot;' . wp_nonce_url( $group_url.'/sum/'.$user_id, 'ass_member_email_status' ) . '&quot;&gt;'.__('Weekly', 'bp-ass').'&lt;/a&gt; | ';&nbsp;</div></li><li><div>  echo '&lt;a href=&quot;' . wp_nonce_url( $group_url.'/dig/'.$user_id, 'ass_member_email_status' ) . '&quot;&gt;'.__('Daily', 'bp-ass').'&lt;/a&gt; | ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ass_get_forum_type() ) {&nbsp;</div></li><li><div>      echo '&lt;a href=&quot;' . wp_nonce_url( $group_url.'/sub/'.$user_id, 'ass_member_email_status' ) . '&quot;&gt;'.__('New Topics', 'bp-ass').'&lt;/a&gt; | ';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo '&lt;a href=&quot;' . wp_nonce_url( $group_url.'/supersub/'.$user_id, 'ass_member_email_status' ) . '&quot;&gt;'.__('All Email', 'bp-ass').'&lt;/a&gt;';&nbsp;</div></li><li><div>  echo '&lt;/span&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_group_manage_members_admin_item', 'ass_manage_members_email_status' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output the group default status</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * First tries to get it out of groupmeta. If not found, falls back on supersub. Filter the supersub</span>&nbsp;</div></li><li><div><span class="comment"> * default with 'ass_default_subscription_level'</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $group_id ID of the group. Defaults to current group, if present</span>&nbsp;</div></li><li><div><span class="comment"> * @return str $status</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_group_default_status( $group_id = false ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$group_id )&nbsp;</div></li><li><div>      $group_id = bp_is_group() ? bp_get_current_group_id() : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$group_id )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = groups_get_groupmeta( $group_id, 'ass_default_subscription' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$status ) {&nbsp;</div></li><li><div>      $status = apply_filters( 'ass_default_subscription_level', 'supersub', $group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'ass_group_default_status', $status, $group_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Unsubscribe a user from all or a subset of their groups</span>&nbsp;</div></li><li><div>function ass_unsubscribe_user( $user_id = 0, $groups = array() ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) )&nbsp;</div></li><li><div>      $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $groups ) ) {&nbsp;</div></li><li><div>      $groups = groups_get_user_groups( $user_id );&nbsp;</div></li><li><div>      $groups = $groups['groups'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $groups as $group_id ) {&nbsp;</div></li><li><div>      ass_group_subscription( 'no', $user_id, $group_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Process request for logged in user unsubscribing via link in notifications settings</span>&nbsp;</div></li><li><div>function ass_user_unsubscribe_action() {&nbsp;</div></li><li><div>  if ( get_option( 'ass-global-unsubscribe-link' ) != 'yes' || ! bp_is_settings_component() || ! isset( $_GET['ass_unsubscribe'] ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_admin_referer( 'ass_unsubscribe_all' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ass_unsubscribe_user();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( bp_is_my_profile() )&nbsp;</div></li><li><div>      bp_core_add_message( __( 'You have been unsubscribed from all groups notifications.', 'bp-ass' ), 'success' );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      bp_core_add_message( __( &quot;This user's has been unsubscribed from all groups notifications.&quot;, 'bp-ass' ), 'success' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  bp_core_redirect( bp_displayed_user_domain() . bp_get_settings_slug() . '/notifications/' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_actions', 'ass_user_unsubscribe_action' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Form to confirm unsubscription from all groups</span>&nbsp;</div></li><li><div>function ass_user_unsubscribe_form() {&nbsp;</div></li><li><div>  $action = isset( $_GET['bpass-action'] ) ? $_GET['bpass-action'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'unsubscribe' != $action )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_GET['group'] ) && get_option( 'ass-global-unsubscribe-link' ) != 'yes' )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = bp_displayed_user_id();&nbsp;</div></li><li><div>  $access_key = $_GET['access_key'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// unsubscribing from one group only</span>&nbsp;</div></li><li><div>  if ( isset( $_GET['group'] ) ) {&nbsp;</div></li><li><div>      $group = groups_get_group( array( 'group_id' =&gt; $_GET['group'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $access_key != md5( &quot;{$group-&gt;id}{$user_id}unsubscribe&quot; . wp_salt() ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ass_unsubscribe_user( $user_id, (array) $group-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message = sprintf( __( 'Your unsubscription was successful. You will no longer receive email notifications from the group %s.', 'bp-ass' ), '&lt;a href=&quot;' . bp_get_group_permalink( $group ) . '&quot;&gt;' . $group-&gt;name . '&lt;/a&gt;' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $continue_link = sprintf( __( '&lt;a href=&quot;%1$s&quot;&gt;Continue to %2$s&lt;/a&gt;', 'bp-ass' ), bp_get_group_permalink( $group ), esc_html( $group-&gt;name ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $unsubscribed = true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// unsubscribe from all groups</span>&nbsp;</div></li><li><div>      if ( $access_key != md5( $user_id . 'unsubscribe' . wp_salt() ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['submit'] ) ) {&nbsp;</div></li><li><div>          ass_unsubscribe_user( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $message = __( 'Your unsubscription was successful. You will no longer receive email notifications from any of your groups.', 'bp-ass' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $continue_link = sprintf( __( '&lt;a href=&quot;%1$s&quot;&gt;Continue to %2$s&lt;/a&gt;', 'bp-ass' ), bp_get_root_domain(), get_option( 'blogname' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $unsubscribed = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;html&gt;&nbsp;</div></li><li><div>&lt;head&gt;&nbsp;</div></li><li><div>  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&nbsp;</div></li><li><div>  &lt;meta name = &quot;viewport&quot; content=&quot;width=640&quot; /&gt;&nbsp;</div></li><li><div>  &lt;title&gt;&lt;?php echo bloginfo( 'name' ); ?&gt; - &lt;?php _e( 'Unsubscribe from all groups notifications' ); ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>  &lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>      .container {&nbsp;</div></li><li><div>          background-color:#fff;&nbsp;</div></li><li><div>          width:400px;&nbsp;</div></li><li><div>          border:1px solid #999;&nbsp;</div></li><li><div>          padding: 20px;&nbsp;</div></li><li><div>          margin: 0 auto;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  &lt;/style&gt;&nbsp;</div></li><li><div>  &lt;?php wp_head(); ?&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;container&quot;&gt;&nbsp;</div></li><li><div>      &lt;h1&gt;&lt;?php echo bloginfo( 'name' ); ?&gt; - &lt;?php _e( 'Unsubscribe' ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>      &lt;?php if ( isset( $unsubscribed ) ) : ?&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php echo $message ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php echo $continue_link ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;?php else : ?&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php _e( 'Do you really want to unsubscribe from all groups notifications?' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;form id=&quot;ass-unsubscribe-form&quot; action=&quot;&quot; method=&quot;get&quot;&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;bpass-action&quot; value=&quot;&lt;?php echo $action; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;access_key&quot; value=&quot;&lt;?php echo $access_key; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e( 'Yes, unsubscribe from all my groups' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;a href=&quot;&lt;?php echo esc_attr( site_url() ); ?&gt;&quot;&gt;&lt;?php _e( 'No, close' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  die;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'bp_init', 'ass_user_unsubscribe_form' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>//    !FRONT END ADMIN AND SETTINGS FUNCTIONS&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send welcome email to new group members</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses apply_filters() Filter 'ass_welcome_email' to change the content/subject of the email</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_send_welcome_email( $group_id, $user_id ) {&nbsp;</div></li><li><div>  $user = bp_core_get_core_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $welcome_email = groups_get_groupmeta( $group_id, 'ass_welcome_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the parameters of the welcome email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.1.1</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.7.0 Added $user parameter.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $welcome_email Message details {</span>&nbsp;</div></li><li><div><span class="comment">   *              $enabled Whether the group has a welcome email enabled or not.</span>&nbsp;</div></li><li><div><span class="comment">   *              $subject The saved subject of the welcome email.</span>&nbsp;</div></li><li><div><span class="comment">   *              $content The saved content of the welcome email.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">    * @param int   $group_id ID of the group the email is sent by.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $user     Details of the user who just joined the group.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $welcome_email = apply_filters( 'ass_welcome_email', $welcome_email, $group_id, $user ); <span class="comment">// for multilingual filtering</span>&nbsp;</div></li><li><div>  $welcome_email_enabled = isset( $welcome_email['enabled'] ) ? $welcome_email['enabled'] : 'no';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'no' == $welcome_email_enabled ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $subject = ass_clean_subject( $welcome_email['subject'], false );&nbsp;</div></li><li><div>  $message = ass_clean_content( $welcome_email['content'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user-&gt;user_email || 'yes' != $welcome_email_enabled || empty( $message ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_option( 'ass-global-unsubscribe-link' ) == 'yes' ) {&nbsp;</div></li><li><div>      $global_link = bp_core_get_user_domain( $user_id ) . '?bpass-action=unsubscribe&access_key=' . md5( &quot;{$user_id}unsubscribe&quot; . wp_salt() );&nbsp;</div></li><li><div>      $message .= &quot;\n\n---------------------\n&quot;;&nbsp;</div></li><li><div>      $message .= sprintf( __( 'To disable emails from all your groups at once click: %s', 'bp-ass' ), $global_link );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group_admin_ids = groups_get_group_admins( $group_id );&nbsp;</div></li><li><div>  $group_admin = bp_core_get_core_userdata( $group_admin_ids[0]-&gt;user_id );&nbsp;</div></li><li><div>  $headers = array(&nbsp;</div></li><li><div>      &quot;From: \&quot;{$group_admin-&gt;display_name}\&quot; &lt;{$group_admin-&gt;user_email}&gt;&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $group = groups_get_group( array( 'group_id' =&gt; $group_id ) );&nbsp;</div></li><li><div>  $group_name = bp_get_group_name( $group );&nbsp;</div></li><li><div>  $group_link = bp_get_group_permalink( $group );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Sending time!</span></span>&nbsp;</div></li><li><div>  ass_send_email( 'bp-ges-welcome', $user-&gt;user_email, array(&nbsp;</div></li><li><div>      'tokens' =&gt; array(&nbsp;</div></li><li><div>          'ges.subject' =&gt; stripslashes( strip_tags( $welcome_email['subject'] ) ), &nbsp;</div></li><li><div>          'usermessage' =&gt; stripslashes( $welcome_email['content'] ), &nbsp;</div></li><li><div>          'group.link' =&gt; sprintf( '&lt;a href=&quot;%1$s&quot;&gt;%2$s&lt;/a&gt;', esc_url( $group_link ), $group_name ), &nbsp;</div></li><li><div>          'group.name' =&gt; $group_name, &nbsp;</div></li><li><div>          'group.url' =&gt; esc_url( $group_link ), &nbsp;</div></li><li><div>          'group.id' =&gt; $group_id, &nbsp;</div></li><li><div>          'recipient.id' =&gt; $user-&gt;ID, &nbsp;</div></li><li><div>          'subscription_type' =&gt; 'sub', &nbsp;</div></li><li><div>          'ges.settings-link' =&gt; ass_get_login_redirect_url( trailingslashit( $group_link . 'notifications' ), 'welcome' ), &nbsp;</div></li><li><div>          'ges.unsubscribe' =&gt; ass_get_group_unsubscribe_link_for_user( $user-&gt;ID, $group_id ), &nbsp;</div></li><li><div>          'ges.unsubscribe-global' =&gt; ass_get_group_unsubscribe_link_for_user( $user-&gt;ID, $group_id, true ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'subject' =&gt; $subject, &nbsp;</div></li><li><div>      'content' =&gt; $message, &nbsp;</div></li><li><div>      'from' =&gt; array(&nbsp;</div></li><li><div>          'name' =&gt; $group_name, &nbsp;</div></li><li><div>          'email' =&gt; $group_admin-&gt;user_email&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'groups_join_group', 'ass_send_welcome_email', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send welcome email to new group members when they join via accepting an invitation</span>&nbsp;</div></li><li><div><span class="comment"> * or having their membership request is approved.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id  ID of the user who joined the group.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $group_id ID of the group the member has joined.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_send_welcome_email_on_accept_invite_or_request( $user_id, $group_id ) {&nbsp;</div></li><li><div>  ass_send_welcome_email( $group_id, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'groups_accept_invite', 'ass_send_welcome_email_on_accept_invite_or_request', 10, 2 );&nbsp;</div></li><li><div>add_action( 'groups_membership_accepted', 'ass_send_welcome_email_on_accept_invite_or_request', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine what type of forums are running on this BP install.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns either 'bbpress' or 'buddypress' on success.</span>&nbsp;</div></li><li><div><span class="comment"> * Boolean false if neither forums are enabled.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed String of forum type on success; boolean false if forums aren't installed.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_get_forum_type() {&nbsp;</div></li><li><div>  <span class="comment">// sanity check</span>&nbsp;</div></li><li><div>  if ( ! bp_is_active( 'groups' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $type = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// check if bbP is installed</span>&nbsp;</div></li><li><div>  if ( class_exists( 'bbpress' ) AND function_exists( 'bbp_is_group_forums_active' ) ) {&nbsp;</div></li><li><div>      <span class="comment">// check if bbP group forum support is active</span>&nbsp;</div></li><li><div>      if ( ! bbp_is_group_forums_active() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $type = 'bbpress';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// check for BP's bundled forums</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// BP's bundled forums aren't installed correctly, so stop!</span>&nbsp;</div></li><li><div>      if ( ! bp_is_active( 'forums' ) || ! bp_forums_is_installed_correctly() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $type = 'buddypress';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $type;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine whether user should receive a notification of their own posts</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The main purpose of the filter is so that admins can override the setting, especially</span>&nbsp;</div></li><li><div><span class="comment"> * in cases where the user has not specified a setting (ie you can set the default to true)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id Optional</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|array Single metadata value, or array of values</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ass_self_post_notification( $user_id = false ) {&nbsp;</div></li><li><div>  global $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) )&nbsp;</div></li><li><div>      $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta = bp_get_user_meta( $user_id, 'ass_self_post_notification', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $self_notify = $meta == 'yes' ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if ( $user_id == 4 ) { if ( $self_notify) print_r( $bp ); print_r( $meta ); die(); }</span>&nbsp;</div></li><li><div>  return apply_filters( 'ass_self_post_notification', $self_notify, $meta, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function ass_weekly_digest_week() {&nbsp;</div></li><li><div>  $ass_weekly_digest = get_option( 'ass_weekly_digest' );&nbsp;</div></li><li><div>  if ( $ass_weekly_digest == 1 )&nbsp;</div></li><li><div>      return __('Monday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 2 )&nbsp;</div></li><li><div>      return __('Tuesday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 3 )&nbsp;</div></li><li><div>      return __('Wednesday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 4 )&nbsp;</div></li><li><div>      return __('Thursday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 5 )&nbsp;</div></li><li><div>      return __('Friday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 6 )&nbsp;</div></li><li><div>      return __('Saturday' );&nbsp;</div></li><li><div>  elseif ( $ass_weekly_digest == 0 )&nbsp;</div></li><li><div>      return __('Sunday' );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BuddyPress Group Email Subscription</li><li><span></span>3.7.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>