<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.1" data-slug="booster-for-woocommerce" data-type="file" data-id="58658"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-lib-tcpdf-min-include-barcodes-qrcode | file | Booster For Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, booster-for-woocommerce, 2.7.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=bdd85fac4261ee50af491e55f03cfd20' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-lib-tcpdf-min-include-barcodes-qrcode/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-lib-tcpdf-min-include-barcodes-qrcode%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-lib-tcpdf-min-include-barcodes-qrcode%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-booster-for-woocommerce-2.7.1-file-includes-lib-tcpdf-min-include-barcodes-qrcode","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-lib-tcpdf-min-include-barcodes-qrcode" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to booster-for-woocommerce." href="http://hookr.io/plugins/booster-for-woocommerce/" class="plugin"><span property="name">booster-for-woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.1." href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/" class="H_VERSION"><span property="name">2.7.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-lib-tcpdf-min-includ&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="865"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/all/" title="All">All <span class="count badge">865</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="551"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/hooks/" title="Hooks">Hooks <span class="count badge">551</span></a></li><li class="" data-id="action" data-count="17"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/actions/" title="Actions">Actions <span class="count badge">17</span></a></li><li class="" data-id="filter" data-count="534"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/filters/" title="Filters">Filters <span class="count badge">534</span></a></li><li class="" data-id="class" data-count="152"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/classes/" title="Classes">Classes <span class="count badge">152</span></a></li><li class="" data-id="constant" data-count="61"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/constants/" title="Constants">Constants <span class="count badge">61</span></a></li><li class="" data-id="function" data-count="100"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/functions/" title="Functions">Functions <span class="count badge">100</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/booster-for-woocommerce/2.7.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/lib/tcpdf_min/include/barcodes/qrcode.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//============================================================+</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">// File name   : qrcode.php</span>&nbsp;</div></li><li><div><span class="comment">// Version     : 1.0.010</span>&nbsp;</div></li><li><div><span class="comment">// Begin       : 2010-03-22</span>&nbsp;</div></li><li><div><span class="comment">// Last Update : 2012-07-25</span>&nbsp;</div></li><li><div><span class="comment">// Author      : Nicola Asuni - Tecnick.com LTD - www.tecnick.com - info@tecnick.com</span>&nbsp;</div></li><li><div><span class="comment">// License     : GNU-LGPL v3 (http://www.gnu.org/copyleft/lesser.html)</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>----</span></span>----------</span></span>&nbsp;</div></li><li><div><span class="comment">// Copyright (C) 2010-2012 Nicola Asuni - Tecnick.com LTD</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// This file is part of TCPDF software library.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// TCPDF is free software: you can redistribute it and/or modify it</span>&nbsp;</div></li><li><div><span class="comment">// under the terms of the GNU Lesser General Public License as</span>&nbsp;</div></li><li><div><span class="comment">// published by the Free Software Foundation, either version 3 of the</span>&nbsp;</div></li><li><div><span class="comment">// License, or (at your option) any later version.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// TCPDF is distributed in the hope that it will be useful, but</span>&nbsp;</div></li><li><div><span class="comment">// WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>&nbsp;</div></li><li><div><span class="comment">// See the GNU Lesser General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// You should have received a copy of the GNU Lesser General Public License</span>&nbsp;</div></li><li><div><span class="comment">// along with TCPDF.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// See LICENSE.TXT file for more information.</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>----</span></span>----------</span></span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// DESCRIPTION :</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// Class to create QR-code arrays for TCPDF class.</span>&nbsp;</div></li><li><div><span class="comment">// QR Code symbol is a 2D barcode that can be scanned by</span>&nbsp;</div></li><li><div><span class="comment">// handy terminals such as a mobile phone with CCD.</span>&nbsp;</div></li><li><div><span class="comment">// The capacity of QR Code is up to 7000 digits or 4000</span>&nbsp;</div></li><li><div><span class="comment">// characters, and has high robustness.</span>&nbsp;</div></li><li><div><span class="comment">// This class supports QR Code model 2, described in</span>&nbsp;</div></li><li><div><span class="comment">// JIS (Japanese Industrial Standards) X0510:2004</span>&nbsp;</div></li><li><div><span class="comment">// or ISO/IEC 18004.</span>&nbsp;</div></li><li><div><span class="comment">// Currently the following features are not supported:</span>&nbsp;</div></li><li><div><span class="comment">// ECI and FNC1 mode, Micro QR Code, QR Code model 1, </span>&nbsp;</div></li><li><div><span class="comment">// Structured mode.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// This class is derived from the following projects:</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>----</span></span>&nbsp;</div></li><li><div><span class="comment">// &quot;PHP QR Code encoder&quot;</span>&nbsp;</div></li><li><div><span class="comment">// License: GNU-LGPLv3</span>&nbsp;</div></li><li><div><span class="comment">// Copyright (C) 2010 by Dominik Dzienia &lt;deltalab at poczta dot fm&gt;</span>&nbsp;</div></li><li><div><span class="comment">// http://phpqrcode.sourceforge.net/</span>&nbsp;</div></li><li><div><span class="comment">// https://sourceforge.net/projects/phpqrcode/</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// The &quot;PHP QR Code encoder&quot; is based on</span>&nbsp;</div></li><li><div><span class="comment">// &quot;C libqrencode library&quot; (ver. 3.1.1)</span>&nbsp;</div></li><li><div><span class="comment">// License: GNU-LGPL 2.1</span>&nbsp;</div></li><li><div><span class="comment">// Copyright (C) 2006-2010 by Kentaro Fukuchi</span>&nbsp;</div></li><li><div><span class="comment">// http://megaui.net/fukuchi/works/qrencode/index.en.html</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// Reed-Solomon code encoder is written by Phil Karn, KA9Q.</span>&nbsp;</div></li><li><div><span class="comment">// Copyright (C) 2002-2006 Phil Karn, KA9Q</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// QR Code is registered trademark of DENSO WAVE INCORPORATED</span>&nbsp;</div></li><li><div><span class="comment">// http://www.denso-wave.com/qrcode/index-e.html</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>----</span></span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//============================================================+</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @file</span>&nbsp;</div></li><li><div><span class="comment"> * Class to create QR-code arrays for TCPDF class.</span>&nbsp;</div></li><li><div><span class="comment"> * QR Code symbol is a 2D barcode that can be scanned by handy terminals such as a mobile phone with CCD.</span>&nbsp;</div></li><li><div><span class="comment"> * The capacity of QR Code is up to 7000 digits or 4000 characters, and has high robustness.</span>&nbsp;</div></li><li><div><span class="comment"> * This class supports QR Code model 2, described in JIS (Japanese Industrial Standards) X0510:2004 or ISO/IEC 18004.</span>&nbsp;</div></li><li><div><span class="comment"> * Currently the following features are not supported: ECI and FNC1 mode, Micro QR Code, QR Code model 1, Structured mode.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This class is derived from &quot;PHP QR Code encoder&quot; by Dominik Dzienia (http://phpqrcode.sourceforge.net/) based on &quot;libqrencode C library 3.1.1.&quot; by Kentaro Fukuchi (http://megaui.net/fukuchi/works/qrencode/index.en.html), contains Reed-Solomon code written by Phil Karn, KA9Q. QR Code is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/index-e.html).</span>&nbsp;</div></li><li><div><span class="comment"> * Please read comments on this class source file for full copyright and license information.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package com.tecnick.tcpdf</span>&nbsp;</div></li><li><div><span class="comment"> * @author Nicola Asuni</span>&nbsp;</div></li><li><div><span class="comment"> * @version 1.0.010</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// definitions</span>&nbsp;</div></li><li><div>if (!defined('QRCODEDEFS')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Indicate that definitions for this class are set</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRCODEDEFS', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Encoding modes (characters which can be encoded in QRcode)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_NL', -1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode numeric (0-9). 3 characters are encoded to 10bit length. In theory, 7089 characters or less can be stored in a QRcode.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_NM', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode alphanumeric (0-9A-Z $%*+-./:) 45characters. 2 characters are encoded to 11bit length. In theory, 4296 characters or less can be stored in a QRcode.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_AN', 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode 8bit byte data. In theory, 2953 characters or less can be stored in a QRcode.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_8B', 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode KANJI. A KANJI character (multibyte character) is encoded to 13bit length. In theory, 1817 characters or less can be stored in a QRcode.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_KJ', 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode STRUCTURED (currently unsupported)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_MODE_ST', 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Levels of error correction.</span>&nbsp;</div></li><li><div>  <span class="comment">// QRcode has a function of an error correcting for miss reading that white is black.</span>&nbsp;</div></li><li><div>  <span class="comment">// Error correcting is defined in 4 level as below.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction level L : About 7% or less errors can be corrected.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_ECLEVEL_L', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction level M : About 15% or less errors can be corrected.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_ECLEVEL_M', 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction level Q : About 25% or less errors can be corrected.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_ECLEVEL_Q', 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction level H : About 30% or less errors can be corrected.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_ECLEVEL_H', 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Version. Size of QRcode is defined as version.</span>&nbsp;</div></li><li><div>  <span class="comment">// Version is from 1 to 40.</span>&nbsp;</div></li><li><div>  <span class="comment">// Version 1 is 21*21 matrix. And 4 modules increases whenever 1 version increases.</span>&nbsp;</div></li><li><div>  <span class="comment">// So version 40 is 177*177 matrix.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Maximum QR Code version.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRSPEC_VERSION_MAX', 40);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Maximum matrix size for maximum version (version 40 is 177*177 matrix).</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRSPEC_WIDTH_MAX', 177);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Matrix index to get width from $capacity array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRCAP_WIDTH', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Matrix index to get number of words from $capacity array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRCAP_WORDS', 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Matrix index to get remainder from $capacity array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRCAP_REMINDER', 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Matrix index to get error correction level from $capacity array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QRCAP_EC', 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Structure (currently usupported)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Number of header bits for structured mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('STRUCTURE_HEADER_BITS', 20);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Max number of symbols for structured mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('MAX_STRUCTURED_SYMBOLS', 16);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Masks</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Down point base value for case 1 mask pattern (concatenation of same color in a line or a column)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('N1', 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Down point base value for case 2 mask pattern (module block of same color)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('N2', 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Down point base value for case 3 mask pattern (1:1:3:1:1(dark:bright:dark:bright:dark)pattern in a line or a column)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('N3', 40);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Down point base value for case 4 mask pattern (ration of dark modules in whole)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('N4', 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Optimization settings</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * if true, estimates best mask (spec. default, but extremally slow; set to false to significant performance boost but (propably) worst quality code</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_FIND_BEST_MASK', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * if false, checks all masks available, otherwise value tells count of masks need to be checked, mask id are got randomly</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_FIND_FROM_RANDOM', 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * when QR_FIND_BEST_MASK === false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  define('QR_DEFAULT_MASK', 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// -------------------------------------------------</span></span>----</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>} <span class="comment">// end of definitions</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// #*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// for compatibility with PHP4</span>&nbsp;</div></li><li><div>if (!function_exists('str_split')) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Convert a string to an array (needed for PHP4 compatibility)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $string (string) The input string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $split_length (int) Maximum length of the chunk.</span>&nbsp;</div></li><li><div><span class="comment">   * @return  If the optional split_length  parameter is specified, the returned array will be broken down into chunks with each being split_length  in length, otherwise each chunk will be one character in length. FALSE is returned if split_length is less than 1. If the split_length length exceeds the length of string , the entire string is returned as the first (and only) array element.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function str_split($string, $split_length=1) {&nbsp;</div></li><li><div>      if ((strlen($string) &gt; $split_length) OR (!$split_length)) {&nbsp;</div></li><li><div>          do {&nbsp;</div></li><li><div>              $c = strlen($string);&nbsp;</div></li><li><div>              $parts[] = substr($string, 0, $split_length);&nbsp;</div></li><li><div>              $string = substr($string, $split_length);&nbsp;</div></li><li><div>          } while ($string !== false);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $parts = array($string);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $parts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// #####################################################</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @class QRcode</span>&nbsp;</div></li><li><div><span class="comment"> * Class to create QR-code arrays for TCPDF class.</span>&nbsp;</div></li><li><div><span class="comment"> * QR Code symbol is a 2D barcode that can be scanned by handy terminals such as a mobile phone with CCD.</span>&nbsp;</div></li><li><div><span class="comment"> * The capacity of QR Code is up to 7000 digits or 4000 characters, and has high robustness.</span>&nbsp;</div></li><li><div><span class="comment"> * This class supports QR Code model 2, described in JIS (Japanese Industrial Standards) X0510:2004 or ISO/IEC 18004.</span>&nbsp;</div></li><li><div><span class="comment"> * Currently the following features are not supported: ECI and FNC1 mode, Micro QR Code, QR Code model 1, Structured mode.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This class is derived from &quot;PHP QR Code encoder&quot; by Dominik Dzienia (http://phpqrcode.sourceforge.net/) based on &quot;libqrencode C library 3.1.1.&quot; by Kentaro Fukuchi (http://megaui.net/fukuchi/works/qrencode/index.en.html), contains Reed-Solomon code written by Phil Karn, KA9Q. QR Code is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/index-e.html).</span>&nbsp;</div></li><li><div><span class="comment"> * Please read comments on this class source file for full copyright and license information.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package com.tecnick.tcpdf</span>&nbsp;</div></li><li><div><span class="comment"> * @author Nicola Asuni</span>&nbsp;</div></li><li><div><span class="comment"> * @version 1.0.010</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class QRcode {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Barcode array to be returned which is readable by TCPDF.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $barcode_array = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * QR code version. Size of QRcode is defined as version. Version is from 1 to 40. Version 1 is 21*21 matrix. And 4 modules increases whenever 1 version increases. So version 40 is 177*177 matrix.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $version = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Levels of error correction. See definitions for possible values.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encoding mode.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $hint = QR_MODE_8B;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Boolean flag, if true the input string will be converted to uppercase.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $casesensitive = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Structured QR code (not supported yet).</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $structured = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Mask data.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// FrameFiller</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Width.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Frame.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $frame;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * X position of bit.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $x;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Y position of bit.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Direction.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Single bit value.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $bit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// ---- QRrawcode ----</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Data code.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $datacode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction code.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $ecccode = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Blocks.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $blocks;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reed-Solomon blocks.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $rsblocks = array(); <span class="comment">//of RSblock</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Counter.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Data length.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $dataLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error correction length.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $eccLength;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Value b1.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $b1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// ---- QRmask ----</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Run length.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $runLength = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// ---- QRsplit ----</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Input data string.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $dataStr = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Input items.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Reed-Solomon items</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reed-Solomon items.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $rsitems = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array of frames.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $frames = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alphabet-numeric convesion table.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $anTable = array(&nbsp;</div></li><li><div>      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //</span>&nbsp;</div></li><li><div>      36, -1, -1, -1, 37, 38, -1, -1, -1, -1, 39, 40, -1, 41, 42, 43, <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">       0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 44, -1, -1, -1, -1, -1, //</span>&nbsp;</div></li><li><div>      -1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, //&nbsp;</div></li><li><div>      25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, -1, -1, -1, -1, -1, <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, //</span>&nbsp;</div></li><li><div>      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1  //&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Table of the capacity of symbols.</span>&nbsp;</div></li><li><div><span class="comment">   * See Table 1 (pp.13) and Table 12-16 (pp.30-36), JIS X0510:2004.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $capacity = array(&nbsp;</div></li><li><div>      array(  0, 0, 0, array(   0, 0, 0, 0)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 21, 26, 0, array(   7, 10, 13, 17)), //  1</span>&nbsp;</div></li><li><div>      array( 25, 44, 7, array(  10, 16, 22, 28)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 29, 70, 7, array(  15, 26, 36, 44)), //</span>&nbsp;</div></li><li><div>      array( 33, 100, 7, array(  20, 36, 52, 64)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 37, 134, 7, array(  26, 48, 72, 88)), //  5</span>&nbsp;</div></li><li><div>      array( 41, 172, 7, array(  36, 64, 96, 112)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 45, 196, 0, array(  40, 72, 108, 130)), //</span>&nbsp;</div></li><li><div>      array( 49, 242, 0, array(  48, 88, 132, 156)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 53, 292, 0, array(  60, 110, 160, 192)), //</span>&nbsp;</div></li><li><div>      array( 57, 346, 0, array(  72, 130, 192, 224)), <span class="comment"><span class="comment">// 10</span></span>&nbsp;</div></li><li><div>      array( 61, 404, 0, array(  80, 150, 224, 264)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 65, 466, 0, array(  96, 176, 260, 308)), //</span>&nbsp;</div></li><li><div>      array( 69, 532, 0, array( 104, 198, 288, 352)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 73, 581, 3, array( 120, 216, 320, 384)), //</span>&nbsp;</div></li><li><div>      array( 77, 655, 3, array( 132, 240, 360, 432)), <span class="comment"><span class="comment">// 15</span></span>&nbsp;</div></li><li><div>      array( 81, 733, 3, array( 144, 280, 408, 480)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 85, 815, 3, array( 168, 308, 448, 532)), //</span>&nbsp;</div></li><li><div>      array( 89, 901, 3, array( 180, 338, 504, 588)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array( 93, 991, 3, array( 196, 364, 546, 650)), //</span>&nbsp;</div></li><li><div>      array( 97, 1085, 3, array( 224, 416, 600, 700)), <span class="comment"><span class="comment">// 20</span></span>&nbsp;</div></li><li><div>      array(101, 1156, 4, array( 224, 442, 644, 750)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(105, 1258, 4, array( 252, 476, 690, 816)), //</span>&nbsp;</div></li><li><div>      array(109, 1364, 4, array( 270, 504, 750, 900)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(113, 1474, 4, array( 300, 560, 810, 960)), //</span>&nbsp;</div></li><li><div>      array(117, 1588, 4, array( 312, 588, 870, 1050)), <span class="comment"><span class="comment">// 25</span></span>&nbsp;</div></li><li><div>      array(121, 1706, 4, array( 336, 644, 952, 1110)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(125, 1828, 4, array( 360, 700, 1020, 1200)), //</span>&nbsp;</div></li><li><div>      array(129, 1921, 3, array( 390, 728, 1050, 1260)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(133, 2051, 3, array( 420, 784, 1140, 1350)), //</span>&nbsp;</div></li><li><div>      array(137, 2185, 3, array( 450, 812, 1200, 1440)), <span class="comment"><span class="comment">// 30</span></span>&nbsp;</div></li><li><div>      array(141, 2323, 3, array( 480, 868, 1290, 1530)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(145, 2465, 3, array( 510, 924, 1350, 1620)), //</span>&nbsp;</div></li><li><div>      array(149, 2611, 3, array( 540, 980, 1440, 1710)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(153, 2761, 3, array( 570, 1036, 1530, 1800)), //</span>&nbsp;</div></li><li><div>      array(157, 2876, 0, array( 570, 1064, 1590, 1890)), <span class="comment"><span class="comment">// 35</span></span>&nbsp;</div></li><li><div>      array(161, 3034, 0, array( 600, 1120, 1680, 1980)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(165, 3196, 0, array( 630, 1204, 1770, 2100)), //</span>&nbsp;</div></li><li><div>      array(169, 3362, 0, array( 660, 1260, 1860, 2220)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(173, 3532, 0, array( 720, 1316, 1950, 2310)), //</span>&nbsp;</div></li><li><div>      array(177, 3706, 0, array( 750, 1372, 2040, 2430))  <span class="comment"><span class="comment">// 40</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Length indicator.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $lengthTableBits = array(&nbsp;</div></li><li><div>      array(10, 12, 14), &nbsp;</div></li><li><div>      array( 9, 11, 13), &nbsp;</div></li><li><div>      array( 8, 16, 16), &nbsp;</div></li><li><div>      array( 8, 10, 12)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Table of the error correction code (Reed-Solomon block).</span>&nbsp;</div></li><li><div><span class="comment">   * See Table 12-16 (pp.30-36), JIS X0510:2004.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $eccTable = array(&nbsp;</div></li><li><div>      array(array( 0, 0), array( 0, 0), array( 0, 0), array( 0, 0)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), //  1</span>&nbsp;</div></li><li><div>      array(array( 1, 0), array( 1, 0), array( 1, 0), array( 1, 0)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 1, 0), array( 1, 0), array( 2, 0), array( 2, 0)), //</span>&nbsp;</div></li><li><div>      array(array( 1, 0), array( 2, 0), array( 2, 0), array( 4, 0)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 1, 0), array( 2, 0), array( 2, 2), array( 2, 2)), //  5</span>&nbsp;</div></li><li><div>      array(array( 2, 0), array( 4, 0), array( 4, 0), array( 4, 0)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 2, 0), array( 4, 0), array( 2, 4), array( 4, 1)), //</span>&nbsp;</div></li><li><div>      array(array( 2, 0), array( 2, 2), array( 4, 2), array( 4, 2)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 2, 0), array( 3, 2), array( 4, 4), array( 4, 4)), //</span>&nbsp;</div></li><li><div>      array(array( 2, 2), array( 4, 1), array( 6, 2), array( 6, 2)), <span class="comment"><span class="comment">// 10</span></span>&nbsp;</div></li><li><div>      array(array( 4, 0), array( 1, 4), array( 4, 4), array( 3, 8)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 2, 2), array( 6, 2), array( 4, 6), array( 7, 4)), //</span>&nbsp;</div></li><li><div>      array(array( 4, 0), array( 8, 1), array( 8, 4), array(12, 4)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 3, 1), array( 4, 5), array(11, 5), array(11, 5)), //</span>&nbsp;</div></li><li><div>      array(array( 5, 1), array( 5, 5), array( 5, 7), array(11, 7)), <span class="comment"><span class="comment">// 15</span></span>&nbsp;</div></li><li><div>      array(array( 5, 1), array( 7, 3), array(15, 2), array( 3, 13)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 1, 5), array(10, 1), array( 1, 15), array( 2, 17)), //</span>&nbsp;</div></li><li><div>      array(array( 5, 1), array( 9, 4), array(17, 1), array( 2, 19)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 3, 4), array( 3, 11), array(17, 4), array( 9, 16)), //</span>&nbsp;</div></li><li><div>      array(array( 3, 5), array( 3, 13), array(15, 5), array(15, 10)), <span class="comment"><span class="comment">// 20</span></span>&nbsp;</div></li><li><div>      array(array( 4, 4), array(17, 0), array(17, 6), array(19, 6)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 2, 7), array(17, 0), array( 7, 16), array(34, 0)), //</span>&nbsp;</div></li><li><div>      array(array( 4, 5), array( 4, 14), array(11, 14), array(16, 14)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 6, 4), array( 6, 14), array(11, 16), array(30, 2)), //</span>&nbsp;</div></li><li><div>      array(array( 8, 4), array( 8, 13), array( 7, 22), array(22, 13)), <span class="comment"><span class="comment">// 25</span></span>&nbsp;</div></li><li><div>      array(array(10, 2), array(19, 4), array(28, 6), array(33, 4)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 8, 4), array(22, 3), array( 8, 26), array(12, 28)), //</span>&nbsp;</div></li><li><div>      array(array( 3, 10), array( 3, 23), array( 4, 31), array(11, 31)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array( 7, 7), array(21, 7), array( 1, 37), array(19, 26)), //</span>&nbsp;</div></li><li><div>      array(array( 5, 10), array(19, 10), array(15, 25), array(23, 25)), <span class="comment"><span class="comment">// 30</span></span>&nbsp;</div></li><li><div>      array(array(13, 3), array( 2, 29), array(42, 1), array(23, 28)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array(17, 0), array(10, 23), array(10, 35), array(19, 35)), //</span>&nbsp;</div></li><li><div>      array(array(17, 1), array(14, 21), array(29, 19), array(11, 46)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array(13, 6), array(14, 23), array(44, 7), array(59, 1)), //</span>&nbsp;</div></li><li><div>      array(array(12, 7), array(12, 26), array(39, 14), array(22, 41)), <span class="comment"><span class="comment">// 35</span></span>&nbsp;</div></li><li><div>      array(array( 6, 14), array( 6, 34), array(46, 10), array( 2, 64)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array(17, 4), array(29, 14), array(49, 10), array(24, 46)), //</span>&nbsp;</div></li><li><div>      array(array( 4, 18), array(13, 32), array(48, 14), array(42, 32)), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(array(20, 4), array(40, 7), array(43, 22), array(10, 67)), //</span>&nbsp;</div></li><li><div>      array(array(19, 6), array(18, 31), array(34, 34), array(20, 61))  <span class="comment"><span class="comment">// 40</span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Positions of alignment patterns.</span>&nbsp;</div></li><li><div><span class="comment">   * This array includes only the second and the third position of the alignment patterns. Rest of them can be calculated from the distance between them.</span>&nbsp;</div></li><li><div><span class="comment">   * See Table 1 in Appendix E (pp.71) of JIS X0510:2004.</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $alignmentPattern = array(&nbsp;</div></li><li><div>      array( 0, 0), &nbsp;</div></li><li><div>      array( 0, 0), array(18, 0), array(22, 0), array(26, 0), array(30, 0), <span class="comment">//  1- 5</span>&nbsp;</div></li><li><div>      array(34, 0), array(22, 38), array(24, 42), array(26, 46), array(28, 50), <span class="comment">//  6-10</span>&nbsp;</div></li><li><div>      array(30, 54), array(32, 58), array(34, 62), array(26, 46), array(26, 48), <span class="comment">// 11-15</span>&nbsp;</div></li><li><div>      array(26, 50), array(30, 54), array(30, 56), array(30, 58), array(34, 62), <span class="comment">// 16-20</span>&nbsp;</div></li><li><div>      array(28, 50), array(26, 50), array(30, 54), array(28, 54), array(32, 58), <span class="comment">// 21-25</span>&nbsp;</div></li><li><div>      array(30, 58), array(34, 62), array(26, 50), array(30, 54), array(26, 52), <span class="comment">// 26-30</span>&nbsp;</div></li><li><div>      array(30, 56), array(34, 60), array(30, 58), array(34, 62), array(30, 54), <span class="comment">// 31-35</span>&nbsp;</div></li><li><div>      array(24, 50), array(28, 54), array(32, 58), array(26, 54), array(30, 58)  <span class="comment"><span class="comment">// 35</span></span>-40&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Version information pattern (BCH coded).</span>&nbsp;</div></li><li><div><span class="comment">   * See Table 1 in Appendix D (pp.68) of JIS X0510:2004.</span>&nbsp;</div></li><li><div><span class="comment">   * size: [QRSPEC_VERSION_MAX - 6]</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $versionPattern = array(&nbsp;</div></li><li><div>      0x07c94, 0x085bc, 0x09a99, 0x0a4d3, 0x0bbf6, 0x0c762, 0x0d847, 0x0e60d, <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      0x0f928, 0x10b78, 0x1145d, 0x12a17, 0x13532, 0x149a6, 0x15683, 0x168c9, //</span>&nbsp;</div></li><li><div>      0x177ec, 0x18ec4, 0x191e1, 0x1afab, 0x1b08e, 0x1cc1a, 0x1d33f, 0x1ed75, <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      0x1f250, 0x209d5, 0x216f0, 0x228ba, 0x2379f, 0x24b0b, 0x2542e, 0x26a64, //</span>&nbsp;</div></li><li><div>      0x27541, 0x28c69&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Array Format information</span>&nbsp;</div></li><li><div><span class="comment">   * @protected</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $formatInfo = array(&nbsp;</div></li><li><div>      array(0x77c4, 0x72f3, 0x7daa, 0x789d, 0x662f, 0x6318, 0x6c41, 0x6976), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(0x5412, 0x5125, 0x5e7c, 0x5b4b, 0x45f9, 0x40ce, 0x4f97, 0x4aa0), //</span>&nbsp;</div></li><li><div>      array(0x355f, 0x3068, 0x3f31, 0x3a06, 0x24b4, 0x2183, 0x2eda, 0x2bed), <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      array(0x1689, 0x13be, 0x1ce7, 0x19d0, 0x0762, 0x0255, 0x0d0c, 0x083b)  //</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// -------------------------------------------------</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// -------------------------------------------------</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This is the class constructor.</span>&nbsp;</div></li><li><div><span class="comment">   * Creates a QRcode object</span>&nbsp;</div></li><li><div><span class="comment">   * @param $code (string) code to represent using QRcode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $eclevel (string) error level: &lt;ul&gt;&lt;li&gt;L : About 7% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;M : About 15% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;Q : About 25% or less errors can be corrected.&lt;/li&gt;&lt;li&gt;H : About 30% or less errors can be corrected.&lt;/li&gt;&lt;/ul&gt;</span>&nbsp;</div></li><li><div><span class="comment">   * @public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.0.000</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($code, $eclevel = 'L') {&nbsp;</div></li><li><div>      $barcode_array = array();&nbsp;</div></li><li><div>      if ((is_null($code)) OR ($code == '\0') OR ($code == '')) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// set error correction level</span>&nbsp;</div></li><li><div>      $this-&gt;level = array_search($eclevel, array('L', 'M', 'Q', 'H'));&nbsp;</div></li><li><div>      if ($this-&gt;level === false) {&nbsp;</div></li><li><div>          $this-&gt;level = QR_ECLEVEL_L;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($this-&gt;hint != QR_MODE_8B) AND ($this-&gt;hint != QR_MODE_KJ)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($this-&gt;version &lt; 0) OR ($this-&gt;version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;items = array();&nbsp;</div></li><li><div>      $this-&gt;encodeString($code);&nbsp;</div></li><li><div>      if (is_null($this-&gt;data)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $qrTab = $this-&gt;binarize($this-&gt;data);&nbsp;</div></li><li><div>      $size = count($qrTab);&nbsp;</div></li><li><div>      $barcode_array['num_rows'] = $size;&nbsp;</div></li><li><div>      $barcode_array['num_cols'] = $size;&nbsp;</div></li><li><div>      $barcode_array['bcode'] = array();&nbsp;</div></li><li><div>      foreach ($qrTab as $line) {&nbsp;</div></li><li><div>          $arrAdd = array();&nbsp;</div></li><li><div>          foreach (str_split($line) as $char) {&nbsp;</div></li><li><div>              $arrAdd[] = ($char=='1')?1:0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $barcode_array['bcode'][] = $arrAdd;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;barcode_array = $barcode_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a barcode array which is readable by TCPDF</span>&nbsp;</div></li><li><div><span class="comment">   * @return array barcode array readable by TCPDF;</span>&nbsp;</div></li><li><div><span class="comment">   * @public</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function getBarcodeArray() {&nbsp;</div></li><li><div>      return $this-&gt;barcode_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Convert the frame in binary form</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) array to binarize</span>&nbsp;</div></li><li><div><span class="comment">   * @return array frame in binary form</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function binarize($frame) {&nbsp;</div></li><li><div>      $len = count($frame);&nbsp;</div></li><li><div>      <span class="comment">// the frame is square (width = height)</span>&nbsp;</div></li><li><div>      foreach ($frame as &$frameLine) {&nbsp;</div></li><li><div>          for ($i=0; $i&lt;$len; $i++) {&nbsp;</div></li><li><div>              $frameLine[$i] = (ord($frameLine[$i])&1)?'1':'0';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $frame;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encode the input string to QR code</span>&nbsp;</div></li><li><div><span class="comment">   * @param $string (string) input string to encode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function encodeString($string) {&nbsp;</div></li><li><div>      $this-&gt;dataStr = $string;&nbsp;</div></li><li><div>      if (!$this-&gt;casesensitive) {&nbsp;</div></li><li><div>          $this-&gt;toUpper();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $ret = $this-&gt;splitString();&nbsp;</div></li><li><div>      if ($ret &lt; 0) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;encodeMask(-1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encode mask</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mask (int) masking mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function encodeMask($mask) {&nbsp;</div></li><li><div>      $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>      $this-&gt;datacode = $this-&gt;getByteStream($this-&gt;items);&nbsp;</div></li><li><div>      if (is_null($this-&gt;datacode)) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $spec = $this-&gt;getEccSpec($this-&gt;version, $this-&gt;level, $spec);&nbsp;</div></li><li><div>      $this-&gt;b1 = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>      $this-&gt;dataLength = $this-&gt;rsDataLength($spec);&nbsp;</div></li><li><div>      $this-&gt;eccLength = $this-&gt;rsEccLength($spec);&nbsp;</div></li><li><div>      $this-&gt;ecccode = array_fill(0, $this-&gt;eccLength, 0);&nbsp;</div></li><li><div>      $this-&gt;blocks = $this-&gt;rsBlockNum($spec);&nbsp;</div></li><li><div>      $ret = $this-&gt;init($spec);&nbsp;</div></li><li><div>      if ($ret &lt; 0) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;count = 0;&nbsp;</div></li><li><div>      $this-&gt;width = $this-&gt;getWidth($this-&gt;version);&nbsp;</div></li><li><div>      $this-&gt;frame = $this-&gt;newFrame($this-&gt;version);&nbsp;</div></li><li><div>      $this-&gt;x = $this-&gt;width - 1;&nbsp;</div></li><li><div>      $this-&gt;y = $this-&gt;width - 1;&nbsp;</div></li><li><div>      $this-&gt;dir = -1;&nbsp;</div></li><li><div>      $this-&gt;bit = -1;&nbsp;</div></li><li><div>      <span class="comment">// inteleaved data and ecc codes</span>&nbsp;</div></li><li><div>      for ($i=0; $i &lt; ($this-&gt;dataLength + $this-&gt;eccLength); $i++) {&nbsp;</div></li><li><div>          $code = $this-&gt;getCode();&nbsp;</div></li><li><div>          $bit = 0x80;&nbsp;</div></li><li><div>          for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>              $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>              $this-&gt;setFrameAt($addr, 0x02 | (($bit & $code) != 0));&nbsp;</div></li><li><div>              $bit = $bit &gt;&gt; 1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// remainder bits</span>&nbsp;</div></li><li><div>      $j = $this-&gt;getRemainder($this-&gt;version);&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$j; $i++) {&nbsp;</div></li><li><div>          $addr = $this-&gt;getNextPosition();&nbsp;</div></li><li><div>          $this-&gt;setFrameAt($addr, 0x02);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// masking</span>&nbsp;</div></li><li><div>      $this-&gt;runLength = array_fill(0, QRSPEC_WIDTH_MAX + 1, 0);&nbsp;</div></li><li><div>      if ($mask &lt; 0) {&nbsp;</div></li><li><div>          if (QR_FIND_BEST_MASK) {&nbsp;</div></li><li><div>              $masked = $this-&gt;mask($this-&gt;width, $this-&gt;frame, $this-&gt;level);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, (intval(QR_DEFAULT_MASK) % 8), $this-&gt;level);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $masked = $this-&gt;makeMask($this-&gt;width, $this-&gt;frame, $mask, $this-&gt;level);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($masked == NULL) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;data = $masked;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// FrameFiller</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set frame value at specified position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $at (array) x, y position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $val (int) value of the character to set</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function setFrameAt($at, $val) {&nbsp;</div></li><li><div>      $this-&gt;frame[$at['y']][$at['x']] = chr($val);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get frame value at specified position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $at (array) x, y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return value at specified position</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getFrameAt($at) {&nbsp;</div></li><li><div>      return ord($this-&gt;frame[$at['y']][$at['x']]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the next frame position</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of x, y coordinates</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getNextPosition() {&nbsp;</div></li><li><div>      do {&nbsp;</div></li><li><div>          if ($this-&gt;bit == -1) {&nbsp;</div></li><li><div>              $this-&gt;bit = 0;&nbsp;</div></li><li><div>              return array('x'=&gt;$this-&gt;x, 'y'=&gt;$this-&gt;y);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $x = $this-&gt;x;&nbsp;</div></li><li><div>          $y = $this-&gt;y;&nbsp;</div></li><li><div>          $w = $this-&gt;width;&nbsp;</div></li><li><div>          if ($this-&gt;bit == 0) {&nbsp;</div></li><li><div>              $x--;&nbsp;</div></li><li><div>              $this-&gt;bit++;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $x++;&nbsp;</div></li><li><div>              $y += $this-&gt;dir;&nbsp;</div></li><li><div>              $this-&gt;bit--;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($this-&gt;dir &lt; 0) {&nbsp;</div></li><li><div>              if ($y &lt; 0) {&nbsp;</div></li><li><div>                  $y = 0;&nbsp;</div></li><li><div>                  $x -= 2;&nbsp;</div></li><li><div>                  $this-&gt;dir = 1;&nbsp;</div></li><li><div>                  if ($x == 6) {&nbsp;</div></li><li><div>                      $x--;&nbsp;</div></li><li><div>                      $y = 9;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($y == $w) {&nbsp;</div></li><li><div>                  $y = $w - 1;&nbsp;</div></li><li><div>                  $x -= 2;&nbsp;</div></li><li><div>                  $this-&gt;dir = -1;&nbsp;</div></li><li><div>                  if ($x == 6) {&nbsp;</div></li><li><div>                      $x--;&nbsp;</div></li><li><div>                      $y -= 8;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (($x &lt; 0) OR ($y &lt; 0)) {&nbsp;</div></li><li><div>              return NULL;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;x = $x;&nbsp;</div></li><li><div>          $this-&gt;y = $y;&nbsp;</div></li><li><div>      } while(ord($this-&gt;frame[$y][$x]) & 0x80);&nbsp;</div></li><li><div>      return array('x'=&gt;$x, 'y'=&gt;$y);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRrawcode</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize code.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array) array of ECC specification</span>&nbsp;</div></li><li><div><span class="comment">   * @return 0 in case of success, -1 in case of error</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function init($spec) {&nbsp;</div></li><li><div>      $dl = $this-&gt;rsDataCodes1($spec);&nbsp;</div></li><li><div>      $el = $this-&gt;rsEccCodes1($spec);&nbsp;</div></li><li><div>      $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>      $blockNo = 0;&nbsp;</div></li><li><div>      $dataPos = 0;&nbsp;</div></li><li><div>      $eccPos = 0;&nbsp;</div></li><li><div>      $endfor = $this-&gt;rsBlockNum1($spec);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>          $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>          $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>          $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>          $dataPos += $dl;&nbsp;</div></li><li><div>          $eccPos += $el;&nbsp;</div></li><li><div>          $blockNo++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;rsBlockNum2($spec) == 0) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $dl = $this-&gt;rsDataCodes2($spec);&nbsp;</div></li><li><div>      $el = $this-&gt;rsEccCodes2($spec);&nbsp;</div></li><li><div>      $rs = $this-&gt;init_rs(8, 0x11d, 0, 1, $el, 255 - $dl - $el);&nbsp;</div></li><li><div>      if ($rs == NULL) {&nbsp;</div></li><li><div>          return -1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $endfor = $this-&gt;rsBlockNum2($spec);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; $endfor; ++$i) {&nbsp;</div></li><li><div>          $ecc = array_slice($this-&gt;ecccode, $eccPos);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo] = array();&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['dataLength'] = $dl;&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['data'] = array_slice($this-&gt;datacode, $dataPos);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['eccLength'] = $el;&nbsp;</div></li><li><div>          $ecc = $this-&gt;encode_rs_char($rs, $this-&gt;rsblocks[$blockNo]['data'], $ecc);&nbsp;</div></li><li><div>          $this-&gt;rsblocks[$blockNo]['ecc'] = $ecc;&nbsp;</div></li><li><div>          $this-&gt;ecccode = array_merge(array_slice($this-&gt;ecccode, 0, $eccPos), $ecc);&nbsp;</div></li><li><div>          $dataPos += $dl;&nbsp;</div></li><li><div>          $eccPos += $el;&nbsp;</div></li><li><div>          $blockNo++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return Reed-Solomon block code.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array rsblocks</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getCode() {&nbsp;</div></li><li><div>      if ($this-&gt;count &lt; $this-&gt;dataLength) {&nbsp;</div></li><li><div>          $row = $this-&gt;count % $this-&gt;blocks;&nbsp;</div></li><li><div>          $col = $this-&gt;count / $this-&gt;blocks;&nbsp;</div></li><li><div>          if ($col &gt;= $this-&gt;rsblocks[0]['dataLength']) {&nbsp;</div></li><li><div>              $row += $this-&gt;b1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $ret = $this-&gt;rsblocks[$row]['data'][$col];&nbsp;</div></li><li><div>      } elseif ($this-&gt;count &lt; $this-&gt;dataLength + $this-&gt;eccLength) {&nbsp;</div></li><li><div>          $row = ($this-&gt;count - $this-&gt;dataLength) % $this-&gt;blocks;&nbsp;</div></li><li><div>          $col = ($this-&gt;count - $this-&gt;dataLength) / $this-&gt;blocks;&nbsp;</div></li><li><div>          $ret = $this-&gt;rsblocks[$row]['ecc'][$col];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;count++;&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRmask</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Write Format Information on frame and returns the number of black bits</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int) frame width</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) frame</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mask (array) masking mode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @return int blacks</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function writeFormatInformation($width, &$frame, $mask, $level) {&nbsp;</div></li><li><div>      $blacks = 0;&nbsp;</div></li><li><div>      $format =  $this-&gt;getFormatInfo($mask, $level);&nbsp;</div></li><li><div>      for ($i=0; $i&lt;8; ++$i) {&nbsp;</div></li><li><div>          if ($format & 1) {&nbsp;</div></li><li><div>              $blacks += 2;&nbsp;</div></li><li><div>              $v = 0x85;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $v = 0x84;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $frame[8][$width - 1 - $i] = chr($v);&nbsp;</div></li><li><div>          if ($i &lt; 6) {&nbsp;</div></li><li><div>              $frame[$i][8] = chr($v);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $frame[$i + 1][8] = chr($v);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      for ($i=0; $i&lt;7; ++$i) {&nbsp;</div></li><li><div>      if ($format & 1) {&nbsp;</div></li><li><div>          $blacks += 2;&nbsp;</div></li><li><div>          $v = 0x85;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $v = 0x84;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $frame[$width - 7 + $i][8] = chr($v);&nbsp;</div></li><li><div>      if ($i == 0) {&nbsp;</div></li><li><div>          $frame[8][7] = chr($v);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $frame[8][6 - $i] = chr($v);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $format = $format &gt;&gt; 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $blacks;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask0</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask0($x, $y) {&nbsp;</div></li><li><div>      return ($x + $y) & 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask1</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask1($x, $y) {&nbsp;</div></li><li><div>      return ($y & 1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask2</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask2($x, $y) {&nbsp;</div></li><li><div>      return ($x % 3);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask3</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask3($x, $y) {&nbsp;</div></li><li><div>      return ($x + $y) % 3;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask4</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask4($x, $y) {&nbsp;</div></li><li><div>      return (((int)($y / 2)) + ((int)($x / 3))) & 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask5</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask5($x, $y) {&nbsp;</div></li><li><div>      return (($x * $y) & 1) + ($x * $y) % 3;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask6</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask6($x, $y) {&nbsp;</div></li><li><div>      return ((($x * $y) & 1) + ($x * $y) % 3) & 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask7</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask7($x, $y) {&nbsp;</div></li><li><div>      return ((($x * $y) % 3) + (($x + $y) & 1)) & 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return bitmask</span>&nbsp;</div></li><li><div><span class="comment">   * @param $maskNo (int) mask number</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int) width</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) frame</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitmask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function generateMaskNo($maskNo, $width, $frame) {&nbsp;</div></li><li><div>      $bitMask = array_fill(0, $width, array_fill(0, $width, 0));&nbsp;</div></li><li><div>      for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>          for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>              if (ord($frame[$y][$x]) & 0x80) {&nbsp;</div></li><li><div>                  $bitMask[$y][$x] = 0;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $maskFunc = call_user_func(array($this, 'mask'.$maskNo), $x, $y);&nbsp;</div></li><li><div>                  $bitMask[$y][$x] = ($maskFunc == 0)?1:0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bitMask;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * makeMaskNo</span>&nbsp;</div></li><li><div><span class="comment">   * @param $maskNo (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $s (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $d (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $maskGenOnly (boolean)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int b</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function makeMaskNo($maskNo, $width, $s, &$d, $maskGenOnly=false) {&nbsp;</div></li><li><div>      $b = 0;&nbsp;</div></li><li><div>      $bitMask = array();&nbsp;</div></li><li><div>      $bitMask = $this-&gt;generateMaskNo($maskNo, $width, $s, $d);&nbsp;</div></li><li><div>      if ($maskGenOnly) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $d = $s;&nbsp;</div></li><li><div>      for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>          for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>              if ($bitMask[$y][$x] == 1) {&nbsp;</div></li><li><div>                  $d[$y][$x] = chr(ord($s[$y][$x]) ^ ((int)($bitMask[$y][$x])));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $b += (int)(ord($d[$y][$x]) & 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $b;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * makeMask</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $maskNo (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function makeMask($width, $frame, $maskNo, $level) {&nbsp;</div></li><li><div>      $masked = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>      $this-&gt;makeMaskNo($maskNo, $width, $frame, $masked);&nbsp;</div></li><li><div>      $this-&gt;writeFormatInformation($width, $masked, $maskNo, $level);&nbsp;</div></li><li><div>      return $masked;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * calcN1N3</span>&nbsp;</div></li><li><div><span class="comment">   * @param $length (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int demerit</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function calcN1N3($length) {&nbsp;</div></li><li><div>      $demerit = 0;&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$length; ++$i) {&nbsp;</div></li><li><div>          if ($this-&gt;runLength[$i] &gt;= 5) {&nbsp;</div></li><li><div>              $demerit += (N1 + ($this-&gt;runLength[$i] - 5));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($i & 1) {&nbsp;</div></li><li><div>              if (($i &gt;= 3) AND ($i &lt; ($length-2)) AND ($this-&gt;runLength[$i] % 3 == 0)) {&nbsp;</div></li><li><div>                  $fact = (int)($this-&gt;runLength[$i] / 3);&nbsp;</div></li><li><div>                  if (($this-&gt;runLength[$i-2] == $fact)&nbsp;</div></li><li><div>                      AND ($this-&gt;runLength[$i-1] == $fact)&nbsp;</div></li><li><div>                      AND ($this-&gt;runLength[$i+1] == $fact)&nbsp;</div></li><li><div>                      AND ($this-&gt;runLength[$i+2] == $fact)) {&nbsp;</div></li><li><div>                      if (($this-&gt;runLength[$i-3] &lt; 0) OR ($this-&gt;runLength[$i-3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                          $demerit += N3;&nbsp;</div></li><li><div>                      } elseif ((($i+3) &gt;= $length) OR ($this-&gt;runLength[$i+3] &gt;= (4 * $fact))) {&nbsp;</div></li><li><div>                          $demerit += N3;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $demerit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * evaluateSymbol</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int demerit</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function evaluateSymbol($width, $frame) {&nbsp;</div></li><li><div>      $head = 0;&nbsp;</div></li><li><div>      $demerit = 0;&nbsp;</div></li><li><div>      for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>          $head = 0;&nbsp;</div></li><li><div>          $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>          $frameY = $frame[$y];&nbsp;</div></li><li><div>          if ($y &gt; 0) {&nbsp;</div></li><li><div>              $frameYM = $frame[$y-1];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>              if (($x &gt; 0) AND ($y &gt; 0)) {&nbsp;</div></li><li><div>                  $b22 = ord($frameY[$x]) & ord($frameY[$x-1]) & ord($frameYM[$x]) & ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                  $w22 = ord($frameY[$x]) | ord($frameY[$x-1]) | ord($frameYM[$x]) | ord($frameYM[$x-1]);&nbsp;</div></li><li><div>                  if (($b22 | ($w22 ^ 1)) & 1) {&nbsp;</div></li><li><div>                      $demerit += N2;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (($x == 0) AND (ord($frameY[$x]) & 1)) {&nbsp;</div></li><li><div>                  $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                  $head = 1;&nbsp;</div></li><li><div>                  $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>              } elseif ($x &gt; 0) {&nbsp;</div></li><li><div>                  if ((ord($frameY[$x]) ^ ord($frameY[$x-1])) & 1) {&nbsp;</div></li><li><div>                      $head++;&nbsp;</div></li><li><div>                      $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      for ($x=0; $x&lt;$width; ++$x) {&nbsp;</div></li><li><div>          $head = 0;&nbsp;</div></li><li><div>          $this-&gt;runLength[0] = 1;&nbsp;</div></li><li><div>          for ($y=0; $y&lt;$width; ++$y) {&nbsp;</div></li><li><div>              if (($y == 0) AND (ord($frame[$y][$x]) & 1)) {&nbsp;</div></li><li><div>                  $this-&gt;runLength[0] = -1;&nbsp;</div></li><li><div>                  $head = 1;&nbsp;</div></li><li><div>                  $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>              } elseif ($y &gt; 0) {&nbsp;</div></li><li><div>                  if ((ord($frame[$y][$x]) ^ ord($frame[$y-1][$x])) & 1) {&nbsp;</div></li><li><div>                      $head++;&nbsp;</div></li><li><div>                      $this-&gt;runLength[$head] = 1;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this-&gt;runLength[$head]++;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $demerit += $this-&gt;calcN1N3($head+1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $demerit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mask</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array best mask</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mask($width, $frame, $level) {&nbsp;</div></li><li><div>      $minDemerit = PHP_INT_MAX;&nbsp;</div></li><li><div>      $bestMaskNum = 0;&nbsp;</div></li><li><div>      $bestMask = array();&nbsp;</div></li><li><div>      $checked_masks = array(0, 1, 2, 3, 4, 5, 6, 7);&nbsp;</div></li><li><div>      if (QR_FIND_FROM_RANDOM !== false) {&nbsp;</div></li><li><div>          $howManuOut = 8 - (QR_FIND_FROM_RANDOM % 9);&nbsp;</div></li><li><div>          for ($i = 0; $i &lt;  $howManuOut; ++$i) {&nbsp;</div></li><li><div>              $remPos = rand (0, count($checked_masks)-1);&nbsp;</div></li><li><div>              unset($checked_masks[$remPos]);&nbsp;</div></li><li><div>              $checked_masks = array_values($checked_masks);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $bestMask = $frame;&nbsp;</div></li><li><div>      foreach ($checked_masks as $i) {&nbsp;</div></li><li><div>          $mask = array_fill(0, $width, str_repeat(&quot;\0&quot;, $width));&nbsp;</div></li><li><div>          $demerit = 0;&nbsp;</div></li><li><div>          $blacks = 0;&nbsp;</div></li><li><div>          $blacks = $this-&gt;makeMaskNo($i, $width, $frame, $mask);&nbsp;</div></li><li><div>          $blacks += $this-&gt;writeFormatInformation($width, $mask, $i, $level);&nbsp;</div></li><li><div>          $blacks = (int)(100 * $blacks / ($width * $width));&nbsp;</div></li><li><div>          $demerit = (int)((int)(abs($blacks - 50) / 5) * N4);&nbsp;</div></li><li><div>          $demerit += $this-&gt;evaluateSymbol($width, $mask);&nbsp;</div></li><li><div>          if ($demerit &lt; $minDemerit) {&nbsp;</div></li><li><div>              $minDemerit = $demerit;&nbsp;</div></li><li><div>              $bestMask = $mask;&nbsp;</div></li><li><div>              $bestMaskNum = $i;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bestMask;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRsplit</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return true if the character at specified position is a number</span>&nbsp;</div></li><li><div><span class="comment">   * @param $str (string) string</span>&nbsp;</div></li><li><div><span class="comment">   * @param $pos (int) characted position</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true of false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function isdigitat($str, $pos) {&nbsp;</div></li><li><div>      if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return ((ord($str[$pos]) &gt;= ord('0'))&&(ord($str[$pos]) &lt;= ord('9')));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return true if the character at specified position is an alphanumeric character</span>&nbsp;</div></li><li><div><span class="comment">   * @param $str (string) string</span>&nbsp;</div></li><li><div><span class="comment">   * @param $pos (int) characted position</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true of false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function isalnumat($str, $pos) {&nbsp;</div></li><li><div>      if ($pos &gt;= strlen($str)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return ($this-&gt;lookAnTable(ord($str[$pos])) &gt;= 0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * identifyMode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $pos (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function identifyMode($pos) {&nbsp;</div></li><li><div>      if ($pos &gt;= strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>          return QR_MODE_NL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $c = $this-&gt;dataStr[$pos];&nbsp;</div></li><li><div>      if ($this-&gt;isdigitat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>          return QR_MODE_NM;&nbsp;</div></li><li><div>      } elseif ($this-&gt;isalnumat($this-&gt;dataStr, $pos)) {&nbsp;</div></li><li><div>          return QR_MODE_AN;&nbsp;</div></li><li><div>      } elseif ($this-&gt;hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>          if ($pos+1 &lt; strlen($this-&gt;dataStr)) {&nbsp;</div></li><li><div>              $d = $this-&gt;dataStr[$pos+1];&nbsp;</div></li><li><div>              $word = (ord($c) &lt;&lt; 8) | ord($d);&nbsp;</div></li><li><div>              if (($word &gt;= 0x8140 && $word &lt;= 0x9ffc) OR ($word &gt;= 0xe040 && $word &lt;= 0xebbf)) {&nbsp;</div></li><li><div>                  return QR_MODE_KJ;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return QR_MODE_8B;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * eatNum</span>&nbsp;</div></li><li><div><span class="comment">   * @return int run</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function eatNum() {&nbsp;</div></li><li><div>      $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>      $p = 0;&nbsp;</div></li><li><div>      while($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>          $p++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $run = $p;&nbsp;</div></li><li><div>      $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>      if ($mode == QR_MODE_8B) {&nbsp;</div></li><li><div>          $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>          + $this-&gt;estimateBitsMode8(1)         <span class="comment"><span class="comment"><span class="comment"><span class="comment">// + 4 + l8</span></span></span></span>&nbsp;</div></li><li><div>          - $this-&gt;estimateBitsMode8($run + 1); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// - 4 - l8</span></span></span></span>&nbsp;</div></li><li><div>          if ($dif &gt; 0) {&nbsp;</div></li><li><div>              return $this-&gt;eat8();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>          $dif = $this-&gt;estimateBitsModeNum($run) + 4 + $ln&nbsp;</div></li><li><div>          + $this-&gt;estimateBitsModeAn(1)        <span class="comment"><span class="comment">// + 4 + la</span></span>&nbsp;</div></li><li><div>          - $this-&gt;estimateBitsModeAn($run + 1);<span class="comment"><span class="comment">// - 4 - la</span></span>&nbsp;</div></li><li><div>          if ($dif &gt; 0) {&nbsp;</div></li><li><div>              return $this-&gt;eatAn();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_NM, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>      return $run;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * eatAn</span>&nbsp;</div></li><li><div><span class="comment">   * @return int run</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function eatAn() {&nbsp;</div></li><li><div>      $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>      $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>      $p =1 ;&nbsp;</div></li><li><div>      while($this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>          if ($this-&gt;isdigitat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>              $q = $p;&nbsp;</div></li><li><div>              while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                  $q++;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $dif = $this-&gt;estimateBitsModeAn($p) <span class="comment"><span class="comment">// + 4 + la</span></span>&nbsp;</div></li><li><div>              + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>              - $this-&gt;estimateBitsModeAn($q); <span class="comment"><span class="comment">// - 4 - la</span></span>&nbsp;</div></li><li><div>              if ($dif &lt; 0) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $p = $q;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $run = $p;&nbsp;</div></li><li><div>      if (!$this-&gt;isalnumat($this-&gt;dataStr, $p)) {&nbsp;</div></li><li><div>          $dif = $this-&gt;estimateBitsModeAn($run) + 4 + $la&nbsp;</div></li><li><div>          + $this-&gt;estimateBitsMode8(1) <span class="comment"><span class="comment"><span class="comment"><span class="comment">// + 4 + l8</span></span></span></span>&nbsp;</div></li><li><div>          - $this-&gt;estimateBitsMode8($run + 1); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// - 4 - l8</span></span></span></span>&nbsp;</div></li><li><div>          if ($dif &gt; 0) {&nbsp;</div></li><li><div>              return $this-&gt;eat8();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_AN, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>      return $run;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * eatKanji</span>&nbsp;</div></li><li><div><span class="comment">   * @return int run</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function eatKanji() {&nbsp;</div></li><li><div>      $p = 0;&nbsp;</div></li><li><div>      while($this-&gt;identifyMode($p) == QR_MODE_KJ) {&nbsp;</div></li><li><div>          $p += 2;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_KJ, $p, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>      return $run;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * eat8</span>&nbsp;</div></li><li><div><span class="comment">   * @return int run</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function eat8() {&nbsp;</div></li><li><div>      $la = $this-&gt;lengthIndicator(QR_MODE_AN, $this-&gt;version);&nbsp;</div></li><li><div>      $ln = $this-&gt;lengthIndicator(QR_MODE_NM, $this-&gt;version);&nbsp;</div></li><li><div>      $p = 1;&nbsp;</div></li><li><div>      $dataStrLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>      while($p &lt; $dataStrLen) {&nbsp;</div></li><li><div>          $mode = $this-&gt;identifyMode($p);&nbsp;</div></li><li><div>          if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($mode == QR_MODE_NM) {&nbsp;</div></li><li><div>              $q = $p;&nbsp;</div></li><li><div>              while($this-&gt;isdigitat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                  $q++;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $dif = $this-&gt;estimateBitsMode8($p) <span class="comment"><span class="comment"><span class="comment"><span class="comment">// + 4 + l8</span></span></span></span>&nbsp;</div></li><li><div>              + $this-&gt;estimateBitsModeNum($q - $p) + 4 + $ln&nbsp;</div></li><li><div>              - $this-&gt;estimateBitsMode8($q); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// - 4 - l8</span></span></span></span>&nbsp;</div></li><li><div>              if ($dif &lt; 0) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $p = $q;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ($mode == QR_MODE_AN) {&nbsp;</div></li><li><div>              $q = $p;&nbsp;</div></li><li><div>              while($this-&gt;isalnumat($this-&gt;dataStr, $q)) {&nbsp;</div></li><li><div>                  $q++;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $dif = $this-&gt;estimateBitsMode8($p)  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// + 4 + l8</span></span></span></span>&nbsp;</div></li><li><div>              + $this-&gt;estimateBitsModeAn($q - $p) + 4 + $la&nbsp;</div></li><li><div>              - $this-&gt;estimateBitsMode8($q); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// - 4 - l8</span></span></span></span>&nbsp;</div></li><li><div>              if ($dif &lt; 0) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $p = $q;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $run = $p;&nbsp;</div></li><li><div>      $this-&gt;items = $this-&gt;appendNewInputItem($this-&gt;items, QR_MODE_8B, $run, str_split($this-&gt;dataStr));&nbsp;</div></li><li><div>      return $run;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * splitString</span>&nbsp;</div></li><li><div><span class="comment">   * @return (int)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function splitString() {&nbsp;</div></li><li><div>      while (strlen($this-&gt;dataStr) &gt; 0) {&nbsp;</div></li><li><div>          $mode = $this-&gt;identifyMode(0);&nbsp;</div></li><li><div>          switch ($mode) {&nbsp;</div></li><li><div>              case QR_MODE_NM: {&nbsp;</div></li><li><div>                  $length = $this-&gt;eatNum();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_AN: {&nbsp;</div></li><li><div>                  $length = $this-&gt;eatAn();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_KJ: {&nbsp;</div></li><li><div>                  if ($hint == QR_MODE_KJ) {&nbsp;</div></li><li><div>                      $length = $this-&gt;eatKanji();&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              default: {&nbsp;</div></li><li><div>                  $length = $this-&gt;eat8();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($length == 0) {&nbsp;</div></li><li><div>              return 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($length &lt; 0) {&nbsp;</div></li><li><div>              return -1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;dataStr = substr($this-&gt;dataStr, $length);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * toUpper</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function toUpper() {&nbsp;</div></li><li><div>      $stringLen = strlen($this-&gt;dataStr);&nbsp;</div></li><li><div>      $p = 0;&nbsp;</div></li><li><div>      while ($p &lt; $stringLen) {&nbsp;</div></li><li><div>          $mode = $this-&gt;identifyMode(substr($this-&gt;dataStr, $p), $this-&gt;hint);&nbsp;</div></li><li><div>          if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>              $p += 2;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ((ord($this-&gt;dataStr[$p]) &gt;= ord('a')) AND (ord($this-&gt;dataStr[$p]) &lt;= ord('z'))) {&nbsp;</div></li><li><div>                  $this-&gt;dataStr[$p] = chr(ord($this-&gt;dataStr[$p]) - 32);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;dataStr;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// QRinput</span>Item</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * newInputItem</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bstream (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function newInputItem($mode, $size, $data, $bstream=null) {&nbsp;</div></li><li><div>      $setData = array_slice($data, 0, $size);&nbsp;</div></li><li><div>      if (count($setData) &lt; $size) {&nbsp;</div></li><li><div>          $setData = array_merge($setData, array_fill(0, ($size - count($setData)), 0));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$this-&gt;check($mode, $size, $setData)) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $inputitem = array();&nbsp;</div></li><li><div>      $inputitem['mode'] = $mode;&nbsp;</div></li><li><div>      $inputitem['size'] = $size;&nbsp;</div></li><li><div>      $inputitem['data'] = $setData;&nbsp;</div></li><li><div>      $inputitem['bstream'] = $bstream;&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeModeNum</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeModeNum($inputitem, $version) {&nbsp;</div></li><li><div>      $words = (int)($inputitem['size'] / 3);&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $val = 0x1;&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_NM, $version), $inputitem['size']);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>          $val = (ord($inputitem['data'][$i*3 ]) - ord('0')) * 100;&nbsp;</div></li><li><div>          $val += (ord($inputitem['data'][$i*3+1]) - ord('0')) * 10;&nbsp;</div></li><li><div>          $val += (ord($inputitem['data'][$i*3+2]) - ord('0'));&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 10, $val);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($inputitem['size'] - $words * 3 == 1) {&nbsp;</div></li><li><div>          $val = ord($inputitem['data'][$words*3]) - ord('0');&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, $val);&nbsp;</div></li><li><div>      } elseif (($inputitem['size'] - ($words * 3)) == 2) {&nbsp;</div></li><li><div>          $val = (ord($inputitem['data'][$words*3 ]) - ord('0')) * 10;&nbsp;</div></li><li><div>          $val += (ord($inputitem['data'][$words*3+1]) - ord('0'));&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 7, $val);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeModeAn</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeModeAn($inputitem, $version) {&nbsp;</div></li><li><div>      $words = (int)($inputitem['size'] / 2);&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x02);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_AN, $version), $inputitem['size']);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; $words; ++$i) {&nbsp;</div></li><li><div>          $val = (int)($this-&gt;lookAnTable(ord($inputitem['data'][$i*2])) * 45);&nbsp;</div></li><li><div>          $val += (int)($this-&gt;lookAnTable(ord($inputitem['data'][($i*2)+1])));&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 11, $val);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($inputitem['size'] & 1) {&nbsp;</div></li><li><div>          $val = $this-&gt;lookAnTable(ord($inputitem['data'][($words * 2)]));&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 6, $val);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeMode8</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeMode8($inputitem, $version) {&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x4);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_8B, $version), $inputitem['size']);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; $inputitem['size']; ++$i) {&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][$i]));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeModeKanji</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeModeKanji($inputitem, $version) {&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x8);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], $this-&gt;lengthIndicator(QR_MODE_KJ, $version), (int)($inputitem['size'] / 2));&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$inputitem['size']; $i+=2) {&nbsp;</div></li><li><div>          $val = (ord($inputitem['data'][$i]) &lt;&lt; 8) | ord($inputitem['data'][$i+1]);&nbsp;</div></li><li><div>          if ($val &lt;= 0x9ffc) {&nbsp;</div></li><li><div>              $val -= 0x8140;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $val -= 0xc140;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $h = ($val &gt;&gt; 8) * 0xc0;&nbsp;</div></li><li><div>          $val = ($val & 0xff) + $h;&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 13, $val);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeModeStructure</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeModeStructure($inputitem) {&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, 0x03);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][1]) - 1);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 4, ord($inputitem['data'][0]) - 1);&nbsp;</div></li><li><div>      $inputitem['bstream'] = $this-&gt;appendNum($inputitem['bstream'], 8, ord($inputitem['data'][2]));&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * encodeBitStream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $inputitem (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array input item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encodeBitStream($inputitem, $version) {&nbsp;</div></li><li><div>      $inputitem['bstream'] = array();&nbsp;</div></li><li><div>      $words = $this-&gt;maximumWords($inputitem['mode'], $version);&nbsp;</div></li><li><div>      if ($inputitem['size'] &gt; $words) {&nbsp;</div></li><li><div>          $st1 = $this-&gt;newInputItem($inputitem['mode'], $words, $inputitem['data']);&nbsp;</div></li><li><div>          $st2 = $this-&gt;newInputItem($inputitem['mode'], $inputitem['size'] - $words, array_slice($inputitem['data'], $words));&nbsp;</div></li><li><div>          $st1 = $this-&gt;encodeBitStream($st1, $version);&nbsp;</div></li><li><div>          $st2 = $this-&gt;encodeBitStream($st2, $version);&nbsp;</div></li><li><div>          $inputitem['bstream'] = array();&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st1['bstream']);&nbsp;</div></li><li><div>          $inputitem['bstream'] = $this-&gt;appendBitstream($inputitem['bstream'], $st2['bstream']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          switch($inputitem['mode']) {&nbsp;</div></li><li><div>              case QR_MODE_NM: {&nbsp;</div></li><li><div>                  $inputitem = $this-&gt;encodeModeNum($inputitem, $version);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_AN: {&nbsp;</div></li><li><div>                  $inputitem = $this-&gt;encodeModeAn($inputitem, $version);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_8B: {&nbsp;</div></li><li><div>                  $inputitem = $this-&gt;encodeMode8($inputitem, $version);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_KJ: {&nbsp;</div></li><li><div>                  $inputitem = $this-&gt;encodeModeKanji($inputitem, $version);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_ST: {&nbsp;</div></li><li><div>                  $inputitem = $this-&gt;encodeModeStructure($inputitem);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              default: {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $inputitem;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRinput</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Append data to an input object.</span>&nbsp;</div></li><li><div><span class="comment">   * The data is copied and appended to the input object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (arrray) input items</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int) encoding mode.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int) size of data (byte).</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array) array of input data.</span>&nbsp;</div></li><li><div><span class="comment">   * @return items</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function appendNewInputItem($items, $mode, $size, $data) {&nbsp;</div></li><li><div>      $newitem = $this-&gt;newInputItem($mode, $size, $data);&nbsp;</div></li><li><div>      if (!empty($newitem)) {&nbsp;</div></li><li><div>          $items[] = $newitem;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * insertStructuredAppendHeader</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $index (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $parity (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array items</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function insertStructuredAppendHeader($items, $size, $index, $parity) {&nbsp;</div></li><li><div>      if ($size &gt; MAX_STRUCTURED_SYMBOLS) {&nbsp;</div></li><li><div>          return -1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($index &lt;= 0) OR ($index &gt; MAX_STRUCTURED_SYMBOLS)) {&nbsp;</div></li><li><div>          return -1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $buf = array($size, $index, $parity);&nbsp;</div></li><li><div>      $entry = $this-&gt;newInputItem(QR_MODE_ST, 3, buf);&nbsp;</div></li><li><div>      array_unshift($items, $entry);&nbsp;</div></li><li><div>      return $items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * calcParity</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int parity</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function calcParity($items) {&nbsp;</div></li><li><div>      $parity = 0;&nbsp;</div></li><li><div>      foreach ($items as $item) {&nbsp;</div></li><li><div>          if ($item['mode'] != QR_MODE_ST) {&nbsp;</div></li><li><div>              for ($i=$item['size']-1; $i&gt;=0; --$i) {&nbsp;</div></li><li><div>                  $parity ^= $item['data'][$i];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $parity;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * checkModeNum</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true or false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function checkModeNum($size, $data) {&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>          if ((ord($data[$i]) &lt; ord('0')) OR (ord($data[$i]) &gt; ord('9'))) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Look up the alphabet-numeric convesion table (see JIS X0510:2004, pp.19).</span>&nbsp;</div></li><li><div><span class="comment">   * @param $c (int) character value</span>&nbsp;</div></li><li><div><span class="comment">   * @return value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function lookAnTable($c) {&nbsp;</div></li><li><div>      return (($c &gt; 127)?-1:$this-&gt;anTable[$c]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * checkModeAn</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true or false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function checkModeAn($size, $data) {&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>          if ($this-&gt;lookAnTable(ord($data[$i])) == -1) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateBitsModeNum</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int number of bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateBitsModeNum($size) {&nbsp;</div></li><li><div>      $w = (int)($size / 3);&nbsp;</div></li><li><div>      $bits = ($w * 10);&nbsp;</div></li><li><div>      switch($size - ($w * 3)) {&nbsp;</div></li><li><div>          case 1: {&nbsp;</div></li><li><div>              $bits += 4;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case 2: {&nbsp;</div></li><li><div>              $bits += 7;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bits;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateBitsModeAn</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int number of bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateBitsModeAn($size) {&nbsp;</div></li><li><div>      $bits = (int)($size * 5.5); <span class="comment">// (size / 2 ) * 11</span>&nbsp;</div></li><li><div>      if ($size & 1) {&nbsp;</div></li><li><div>          $bits += 6;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bits;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateBitsMode8</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int number of bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateBitsMode8($size) {&nbsp;</div></li><li><div>      return (int)($size * 8);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateBitsModeKanji</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int number of bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateBitsModeKanji($size) {&nbsp;</div></li><li><div>      return (int)($size * 6.5); <span class="comment">// (size / 2 ) * 13</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * checkModeKanji</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true or false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function checkModeKanji($size, $data) {&nbsp;</div></li><li><div>      if ($size & 1) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$size; $i+=2) {&nbsp;</div></li><li><div>          $val = (ord($data[$i]) &lt;&lt; 8) | ord($data[$i+1]);&nbsp;</div></li><li><div>          if (($val &lt; 0x8140) OR (($val &gt; 0x9ffc) AND ($val &lt; 0xe040)) OR ($val &gt; 0xebbf)) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Validate the input data.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int) encoding mode.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int) size of data (byte).</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array) data to validate</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean true in case of valid data, false otherwise</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function check($mode, $size, $data) {&nbsp;</div></li><li><div>      if ($size &lt;= 0) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      switch($mode) {&nbsp;</div></li><li><div>          case QR_MODE_NM: {&nbsp;</div></li><li><div>              return $this-&gt;checkModeNum($size, $data);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_AN: {&nbsp;</div></li><li><div>              return $this-&gt;checkModeAn($size, $data);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_KJ: {&nbsp;</div></li><li><div>              return $this-&gt;checkModeKanji($size, $data);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_8B: {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_ST: {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          default: {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateBitStreamSize</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateBitStreamSize($items, $version) {&nbsp;</div></li><li><div>      $bits = 0;&nbsp;</div></li><li><div>      if ($version == 0) {&nbsp;</div></li><li><div>          $version = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ($items as $item) {&nbsp;</div></li><li><div>          switch($item['mode']) {&nbsp;</div></li><li><div>              case QR_MODE_NM: {&nbsp;</div></li><li><div>                  $bits = $this-&gt;estimateBitsModeNum($item['size']);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_AN: {&nbsp;</div></li><li><div>                  $bits = $this-&gt;estimateBitsModeAn($item['size']);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_8B: {&nbsp;</div></li><li><div>                  $bits = $this-&gt;estimateBitsMode8($item['size']);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_KJ: {&nbsp;</div></li><li><div>                  $bits = $this-&gt;estimateBitsModeKanji($item['size']);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              case QR_MODE_ST: {&nbsp;</div></li><li><div>                  return STRUCTURE_HEADER_BITS;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              default: {&nbsp;</div></li><li><div>                  return 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $l = $this-&gt;lengthIndicator($item['mode'], $version);&nbsp;</div></li><li><div>          $m = 1 &lt;&lt; $l;&nbsp;</div></li><li><div>          $num = (int)(($item['size'] + $m - 1) / $m);&nbsp;</div></li><li><div>          $bits += $num * (4 + $l);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bits;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * estimateVersion</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int version</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function estimateVersion($items) {&nbsp;</div></li><li><div>      $version = 0;&nbsp;</div></li><li><div>      $prev = 0;&nbsp;</div></li><li><div>      do {&nbsp;</div></li><li><div>          $prev = $version;&nbsp;</div></li><li><div>          $bits = $this-&gt;estimateBitStreamSize($items, $prev);&nbsp;</div></li><li><div>          $version = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>          if ($version &lt; 0) {&nbsp;</div></li><li><div>              return -1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } while ($version &gt; $prev);&nbsp;</div></li><li><div>      return $version;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * lengthOfCode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bits (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int size</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function lengthOfCode($mode, $version, $bits) {&nbsp;</div></li><li><div>      $payload = $bits - 4 - $this-&gt;lengthIndicator($mode, $version);&nbsp;</div></li><li><div>      switch($mode) {&nbsp;</div></li><li><div>          case QR_MODE_NM: {&nbsp;</div></li><li><div>              $chunks = (int)($payload / 10);&nbsp;</div></li><li><div>              $remain = $payload - $chunks * 10;&nbsp;</div></li><li><div>              $size = $chunks * 3;&nbsp;</div></li><li><div>              if ($remain &gt;= 7) {&nbsp;</div></li><li><div>                  $size += 2;&nbsp;</div></li><li><div>              } elseif ($remain &gt;= 4) {&nbsp;</div></li><li><div>                  $size += 1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_AN: {&nbsp;</div></li><li><div>              $chunks = (int)($payload / 11);&nbsp;</div></li><li><div>              $remain = $payload - $chunks * 11;&nbsp;</div></li><li><div>              $size = $chunks * 2;&nbsp;</div></li><li><div>              if ($remain &gt;= 6) {&nbsp;</div></li><li><div>                  ++$size;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_8B: {&nbsp;</div></li><li><div>              $size = (int)($payload / 8);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_KJ: {&nbsp;</div></li><li><div>              $size = (int)(($payload / 13) * 2);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          case QR_MODE_ST: {&nbsp;</div></li><li><div>              $size = (int)($payload / 8);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          default: {&nbsp;</div></li><li><div>              $size = 0;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $maxsize = $this-&gt;maximumWords($mode, $version);&nbsp;</div></li><li><div>      if ($size &lt; 0) {&nbsp;</div></li><li><div>          $size = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($size &gt; $maxsize) {&nbsp;</div></li><li><div>          $size = $maxsize;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $size;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * createBitStream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of items and total bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function createBitStream($items) {&nbsp;</div></li><li><div>      $total = 0;&nbsp;</div></li><li><div>      foreach ($items as $key =&gt; $item) {&nbsp;</div></li><li><div>          $items[$key] = $this-&gt;encodeBitStream($item, $this-&gt;version);&nbsp;</div></li><li><div>          $bits = count($items[$key]['bstream']);&nbsp;</div></li><li><div>          $total += $bits;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array($items, $total);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * convertData</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array items</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function convertData($items) {&nbsp;</div></li><li><div>      $ver = $this-&gt;estimateVersion($items);&nbsp;</div></li><li><div>      if ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>          $this-&gt;version = $ver;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          $cbs = $this-&gt;createBitStream($items);&nbsp;</div></li><li><div>          $items = $cbs[0];&nbsp;</div></li><li><div>          $bits = $cbs[1];&nbsp;</div></li><li><div>          if ($bits &lt; 0) {&nbsp;</div></li><li><div>              return -1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $ver = $this-&gt;getMinimumVersion((int)(($bits + 7) / 8), $this-&gt;level);&nbsp;</div></li><li><div>          if ($ver &lt; 0) {&nbsp;</div></li><li><div>              return -1;&nbsp;</div></li><li><div>          } elseif ($ver &gt; $this-&gt;version) {&nbsp;</div></li><li><div>              $this-&gt;version = $ver;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Append Padding Bit to bitstream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bstream (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function appendPaddingBit($bstream) {&nbsp;</div></li><li><div>       if (is_null($bstream)) {&nbsp;</div></li><li><div>           return null;&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>      $bits = count($bstream);&nbsp;</div></li><li><div>      $maxwords = $this-&gt;getDataLength($this-&gt;version, $this-&gt;level);&nbsp;</div></li><li><div>      $maxbits = $maxwords * 8;&nbsp;</div></li><li><div>      if ($maxbits == $bits) {&nbsp;</div></li><li><div>          return $bstream;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($maxbits - $bits &lt; 5) {&nbsp;</div></li><li><div>          return $this-&gt;appendNum($bstream, $maxbits - $bits, 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $bits += 4;&nbsp;</div></li><li><div>      $words = (int)(($bits + 7) / 8);&nbsp;</div></li><li><div>      $padding = array();&nbsp;</div></li><li><div>      $padding = $this-&gt;appendNum($padding, $words * 8 - $bits + 4, 0);&nbsp;</div></li><li><div>      $padlen = $maxwords - $words;&nbsp;</div></li><li><div>      if ($padlen &gt; 0) {&nbsp;</div></li><li><div>          $padbuf = array();&nbsp;</div></li><li><div>          for ($i=0; $i&lt;$padlen; ++$i) {&nbsp;</div></li><li><div>              $padbuf[$i] = ($i&1)?0x11:0xec;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $padding = $this-&gt;appendBytes($padding, $padlen, $padbuf);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;appendBitstream($bstream, $padding);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * mergeBitStream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (array) items</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function mergeBitStream($items) {&nbsp;</div></li><li><div>      $items = $this-&gt;convertData($items);&nbsp;</div></li><li><div>      if (!is_array($items)) {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $bstream = array();&nbsp;</div></li><li><div>      foreach ($items as $item) {&nbsp;</div></li><li><div>          $bstream = $this-&gt;appendBitstream($bstream, $item['bstream']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bstream;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a stream of bits.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array padded merged byte stream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getBitStream($items) {&nbsp;</div></li><li><div>      $bstream = $this-&gt;mergeBitStream($items);&nbsp;</div></li><li><div>      return $this-&gt;appendPaddingBit($bstream);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pack all bit streams padding bits into a byte array.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $items (int)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array padded merged byte stream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getByteStream($items) {&nbsp;</div></li><li><div>      $bstream = $this-&gt;getBitStream($items);&nbsp;</div></li><li><div>      return $this-&gt;bitstreamToByte($bstream);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRbitstream</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array with zeros</span>&nbsp;</div></li><li><div><span class="comment">   * @param $setLength (int) array size</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function allocate($setLength) {&nbsp;</div></li><li><div>      return array_fill(0, $setLength, 0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return new bitstream from number</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bits (int) number of bits</span>&nbsp;</div></li><li><div><span class="comment">   * @param $num (int) number</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function newFromNum($bits, $num) {&nbsp;</div></li><li><div>      $bstream = $this-&gt;allocate($bits);&nbsp;</div></li><li><div>      $mask = 1 &lt;&lt; ($bits - 1);&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$bits; ++$i) {&nbsp;</div></li><li><div>          if ($num & $mask) {&nbsp;</div></li><li><div>              $bstream[$i] = 1;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $bstream[$i] = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bstream;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return new bitstream from bytes</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int) size</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array) bytes</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function newFromBytes($size, $data) {&nbsp;</div></li><li><div>      $bstream = $this-&gt;allocate($size * 8);&nbsp;</div></li><li><div>      $p=0;&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$size; ++$i) {&nbsp;</div></li><li><div>          $mask = 0x80;&nbsp;</div></li><li><div>          for ($j=0; $j&lt;8; ++$j) {&nbsp;</div></li><li><div>              if ($data[$i] & $mask) {&nbsp;</div></li><li><div>                  $bstream[$p] = 1;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $bstream[$p] = 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>              $mask = $mask &gt;&gt; 1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bstream;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Append one bitstream to another</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bitstream (array) original bitstream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $append (array) bitstream to append</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function appendBitstream($bitstream, $append) {&nbsp;</div></li><li><div>      if ((!is_array($append)) OR (count($append) == 0)) {&nbsp;</div></li><li><div>          return $bitstream;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (count($bitstream) == 0) {&nbsp;</div></li><li><div>          return $append;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array_values(array_merge($bitstream, $append));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Append one bitstream created from number to another</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bitstream (array) original bitstream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bits (int) number of bits</span>&nbsp;</div></li><li><div><span class="comment">   * @param $num (int) number</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function appendNum($bitstream, $bits, $num) {&nbsp;</div></li><li><div>      if ($bits == 0) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $b = $this-&gt;newFromNum($bits, $num);&nbsp;</div></li><li><div>      return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Append one bitstream created from bytes to another</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bitstream (array) original bitstream</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int) size</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array) bytes</span>&nbsp;</div></li><li><div><span class="comment">   * @return array bitstream</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function appendBytes($bitstream, $size, $data) {&nbsp;</div></li><li><div>      if ($size == 0) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $b = $this-&gt;newFromBytes($size, $data);&nbsp;</div></li><li><div>      return $this-&gt;appendBitstream($bitstream, $b);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Convert bitstream to bytes</span>&nbsp;</div></li><li><div><span class="comment">   * @param $bstream (array) original bitstream</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of bytes</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function bitstreamToByte($bstream) {&nbsp;</div></li><li><div>      if (is_null($bstream)) {&nbsp;</div></li><li><div>           return null;&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>      $size = count($bstream);&nbsp;</div></li><li><div>      if ($size == 0) {&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $data = array_fill(0, (int)(($size + 7) / 8), 0);&nbsp;</div></li><li><div>      $bytes = (int)($size / 8);&nbsp;</div></li><li><div>      $p = 0;&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$bytes; $i++) {&nbsp;</div></li><li><div>          $v = 0;&nbsp;</div></li><li><div>          for ($j=0; $j&lt;8; $j++) {&nbsp;</div></li><li><div>              $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>              $v |= $bstream[$p];&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $data[$i] = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($size & 7) {&nbsp;</div></li><li><div>          $v = 0;&nbsp;</div></li><li><div>          for ($j=0; $j&lt;($size & 7); $j++) {&nbsp;</div></li><li><div>              $v = $v &lt;&lt; 1;&nbsp;</div></li><li><div>              $v |= $bstream[$p];&nbsp;</div></li><li><div>              $p++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $data[$bytes] = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRspec</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Replace a value on the array at the specified position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $srctab (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $y (int) Y position</span>&nbsp;</div></li><li><div><span class="comment">   * @param $repl (string) value to replace</span>&nbsp;</div></li><li><div><span class="comment">   * @param $replLen (int) length of the repl string</span>&nbsp;</div></li><li><div><span class="comment">   * @return array srctab</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function qrstrset($srctab, $x, $y, $repl, $replLen=false) {&nbsp;</div></li><li><div>      $srctab[$y] = substr_replace($srctab[$y], ($replLen !== false)?substr($repl, 0, $replLen):$repl, $x, ($replLen !== false)?$replLen:strlen($repl));&nbsp;</div></li><li><div>      return $srctab;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return maximum data code length (bytes) for the version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @return int maximum size (bytes)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getDataLength($version, $level) {&nbsp;</div></li><li><div>      return $this-&gt;capacity[$version][QRCAP_WORDS] - $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return maximum error correction code length (bytes) for the version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @return int ECC size (bytes)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getECCLength($version, $level) {&nbsp;</div></li><li><div>      return $this-&gt;capacity[$version][QRCAP_EC][$level];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the width of the symbol for the version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return int width</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getWidth($version) {&nbsp;</div></li><li><div>      return $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the numer of remainder bits.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return int number of remainder bits</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getRemainder($version) {&nbsp;</div></li><li><div>      return $this-&gt;capacity[$version][QRCAP_REMINDER];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return a version number that satisfies the input code length.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $size (int) input code length (bytes)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @return int version number</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getMinimumVersion($size, $level) {&nbsp;</div></li><li><div>      for ($i = 1; $i &lt;= QRSPEC_VERSION_MAX; ++$i) {&nbsp;</div></li><li><div>          $words = ($this-&gt;capacity[$i][QRCAP_WORDS] - $this-&gt;capacity[$i][QRCAP_EC][$level]);&nbsp;</div></li><li><div>          if ($words &gt;= $size) {&nbsp;</div></li><li><div>              return $i;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// the size of input data is greater than QR capacity, try to lover the error correction mode</span>&nbsp;</div></li><li><div>      return -1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the size of length indicator for the mode and version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int) encoding mode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return int the size of the appropriate length indicator (bits).</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function lengthIndicator($mode, $version) {&nbsp;</div></li><li><div>      if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($version &lt;= 9) {&nbsp;</div></li><li><div>          $l = 0;&nbsp;</div></li><li><div>      } elseif ($version &lt;= 26) {&nbsp;</div></li><li><div>          $l = 1;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $l = 2;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the maximum length for the mode and version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mode (int) encoding mode</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return int the maximum length (bytes)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function maximumWords($mode, $version) {&nbsp;</div></li><li><div>      if ($mode == QR_MODE_ST) {&nbsp;</div></li><li><div>          return 3;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($version &lt;= 9) {&nbsp;</div></li><li><div>          $l = 0;&nbsp;</div></li><li><div>      } else if ($version &lt;= 26) {&nbsp;</div></li><li><div>          $l = 1;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $l = 2;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $bits = $this-&gt;lengthTableBits[$mode][$l];&nbsp;</div></li><li><div>      $words = (1 &lt;&lt; $bits) - 1;&nbsp;</div></li><li><div>      if ($mode == QR_MODE_KJ) {&nbsp;</div></li><li><div>          $words *= 2; <span class="comment">// the number of bytes is required</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $words;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array of ECC specification.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array) an array of ECC specification contains as following: {# of type1 blocks, # of data code, # of ecc code, # of type2 blocks, # of data code}</span>&nbsp;</div></li><li><div><span class="comment">   * @return array spec</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getEccSpec($version, $level, $spec) {&nbsp;</div></li><li><div>      if (count($spec) &lt; 5) {&nbsp;</div></li><li><div>          $spec = array(0, 0, 0, 0, 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $b1 = $this-&gt;eccTable[$version][$level][0];&nbsp;</div></li><li><div>      $b2 = $this-&gt;eccTable[$version][$level][1];&nbsp;</div></li><li><div>      $data = $this-&gt;getDataLength($version, $level);&nbsp;</div></li><li><div>      $ecc = $this-&gt;getECCLength($version, $level);&nbsp;</div></li><li><div>      if ($b2 == 0) {&nbsp;</div></li><li><div>          $spec[0] = $b1;&nbsp;</div></li><li><div>          $spec[1] = (int)($data / $b1);&nbsp;</div></li><li><div>          $spec[2] = (int)($ecc / $b1);&nbsp;</div></li><li><div>          $spec[3] = 0;&nbsp;</div></li><li><div>          $spec[4] = 0;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $spec[0] = $b1;&nbsp;</div></li><li><div>          $spec[1] = (int)($data / ($b1 + $b2));&nbsp;</div></li><li><div>          $spec[2] = (int)($ecc  / ($b1 + $b2));&nbsp;</div></li><li><div>          $spec[3] = $b2;&nbsp;</div></li><li><div>          $spec[4] = $spec[1] + 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $spec;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Put an alignment marker.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) frame</span>&nbsp;</div></li><li><div><span class="comment">   * @param $ox (int) X center coordinate of the pattern</span>&nbsp;</div></li><li><div><span class="comment">   * @param $oy (int) Y center coordinate of the pattern</span>&nbsp;</div></li><li><div><span class="comment">   * @return array frame</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function putAlignmentMarker($frame, $ox, $oy) {&nbsp;</div></li><li><div>      $finder = array(&nbsp;</div></li><li><div>          &quot;\xa1\xa1\xa1\xa1\xa1&quot;, &nbsp;</div></li><li><div>          &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>          &quot;\xa1\xa0\xa1\xa0\xa1&quot;, &nbsp;</div></li><li><div>          &quot;\xa1\xa0\xa0\xa0\xa1&quot;, &nbsp;</div></li><li><div>          &quot;\xa1\xa1\xa1\xa1\xa1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $yStart = $oy - 2;&nbsp;</div></li><li><div>      $xStart = $ox - 2;&nbsp;</div></li><li><div>      for ($y=0; $y &lt; 5; $y++) {&nbsp;</div></li><li><div>          $frame = $this-&gt;qrstrset($frame, $xStart, $yStart+$y, $finder[$y]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $frame;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Put an alignment pattern.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) frame</span>&nbsp;</div></li><li><div><span class="comment">   * @param $width (int) width</span>&nbsp;</div></li><li><div><span class="comment">   * @return array frame</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function putAlignmentPattern($version, $frame, $width) {&nbsp;</div></li><li><div>      if ($version &lt; 2) {&nbsp;</div></li><li><div>          return $frame;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $d = $this-&gt;alignmentPattern[$version][1] - $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>      if ($d &lt; 0) {&nbsp;</div></li><li><div>          $w = 2;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $w = (int)(($width - $this-&gt;alignmentPattern[$version][0]) / $d + 2);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($w * $w - 3 == 1) {&nbsp;</div></li><li><div>          $x = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>          $y = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>          $frame = $this-&gt;putAlignmentMarker($frame, $x, $y);&nbsp;</div></li><li><div>          return $frame;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>      $wo = $w - 1;&nbsp;</div></li><li><div>      for ($x=1; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>          $frame = $this-&gt;putAlignmentMarker($frame, 6, $cx);&nbsp;</div></li><li><div>          $frame = $this-&gt;putAlignmentMarker($frame, $cx, 6);&nbsp;</div></li><li><div>          $cx += $d;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cy = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>      for ($y=0; $y &lt; $wo; ++$y) {&nbsp;</div></li><li><div>          $cx = $this-&gt;alignmentPattern[$version][0];&nbsp;</div></li><li><div>          for ($x=0; $x &lt; $wo; ++$x) {&nbsp;</div></li><li><div>              $frame = $this-&gt;putAlignmentMarker($frame, $cx, $cy);&nbsp;</div></li><li><div>              $cx += $d;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $cy += $d;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $frame;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return BCH encoded version information pattern that is used for the symbol of version 7 or greater. Use lower 18 bits.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return BCH encoded version information pattern</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getVersionPattern($version) {&nbsp;</div></li><li><div>      if (($version &lt; 7) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;versionPattern[($version - 7)];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return BCH encoded format information pattern.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $mask (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $level (int) error correction level</span>&nbsp;</div></li><li><div><span class="comment">   * @return BCH encoded format information pattern</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getFormatInfo($mask, $level) {&nbsp;</div></li><li><div>      if (($mask &lt; 0) OR ($mask &gt; 7)) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($level &lt; 0) OR ($level &gt; 3)) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;formatInfo[$level][$mask];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Put a finder pattern.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $frame (array) frame</span>&nbsp;</div></li><li><div><span class="comment">   * @param $ox (int) X center coordinate of the pattern</span>&nbsp;</div></li><li><div><span class="comment">   * @param $oy (int) Y center coordinate of the pattern</span>&nbsp;</div></li><li><div><span class="comment">   * @return array frame</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function putFinderPattern($frame, $ox, $oy) {&nbsp;</div></li><li><div>      $finder = array(&nbsp;</div></li><li><div>      &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc0\xc1\xc1\xc1\xc0\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc0\xc0\xc0\xc0\xc0\xc1&quot;, &nbsp;</div></li><li><div>      &quot;\xc1\xc1\xc1\xc1\xc1\xc1\xc1&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      for ($y=0; $y &lt; 7; $y++) {&nbsp;</div></li><li><div>          $frame = $this-&gt;qrstrset($frame, $ox, ($oy + $y), $finder[$y]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $frame;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return a copy of initialized frame.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return Array of unsigned char.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function createFrame($version) {&nbsp;</div></li><li><div>      $width = $this-&gt;capacity[$version][QRCAP_WIDTH];&nbsp;</div></li><li><div>      $frameLine = str_repeat (&quot;\0&quot;, $width);&nbsp;</div></li><li><div>      $frame = array_fill(0, $width, $frameLine);&nbsp;</div></li><li><div>      <span class="comment">// Finder pattern</span>&nbsp;</div></li><li><div>      $frame = $this-&gt;putFinderPattern($frame, 0, 0);&nbsp;</div></li><li><div>      $frame = $this-&gt;putFinderPattern($frame, $width - 7, 0);&nbsp;</div></li><li><div>      $frame = $this-&gt;putFinderPattern($frame, 0, $width - 7);&nbsp;</div></li><li><div>      <span class="comment">// Separator</span>&nbsp;</div></li><li><div>      $yOffset = $width - 7;&nbsp;</div></li><li><div>      for ($y=0; $y &lt; 7; ++$y) {&nbsp;</div></li><li><div>          $frame[$y][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>          $frame[$y][$width - 8] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>          $frame[$yOffset][7] = &quot;\xc0&quot;;&nbsp;</div></li><li><div>          ++$yOffset;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $setPattern = str_repeat(&quot;\xc0&quot;, 8);&nbsp;</div></li><li><div>      $frame = $this-&gt;qrstrset($frame, 0, 7, $setPattern);&nbsp;</div></li><li><div>      $frame = $this-&gt;qrstrset($frame, $width-8, 7, $setPattern);&nbsp;</div></li><li><div>      $frame = $this-&gt;qrstrset($frame, 0, $width - 8, $setPattern);&nbsp;</div></li><li><div>      <span class="comment">// Format info</span>&nbsp;</div></li><li><div>      $setPattern = str_repeat(&quot;\x84&quot;, 9);&nbsp;</div></li><li><div>      $frame = $this-&gt;qrstrset($frame, 0, 8, $setPattern);&nbsp;</div></li><li><div>      $frame = $this-&gt;qrstrset($frame, $width - 8, 8, $setPattern, 8);&nbsp;</div></li><li><div>      $yOffset = $width - 8;&nbsp;</div></li><li><div>      for ($y=0; $y &lt; 8; ++$y, ++$yOffset) {&nbsp;</div></li><li><div>          $frame[$y][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>          $frame[$yOffset][8] = &quot;\x84&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Timing pattern</span>&nbsp;</div></li><li><div>      $wo = $width - 15;&nbsp;</div></li><li><div>      for ($i=1; $i &lt; $wo; ++$i) {&nbsp;</div></li><li><div>          $frame[6][7+$i] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>          $frame[7+$i][6] = chr(0x90 | ($i & 1));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Alignment pattern</span>&nbsp;</div></li><li><div>      $frame = $this-&gt;putAlignmentPattern($version, $frame, $width);&nbsp;</div></li><li><div>      <span class="comment">// Version information</span>&nbsp;</div></li><li><div>      if ($version &gt;= 7) {&nbsp;</div></li><li><div>          $vinf = $this-&gt;getVersionPattern($version);&nbsp;</div></li><li><div>          $v = $vinf;&nbsp;</div></li><li><div>          for ($x=0; $x&lt;6; ++$x) {&nbsp;</div></li><li><div>              for ($y=0; $y&lt;3; ++$y) {&nbsp;</div></li><li><div>                  $frame[($width - 11)+$y][$x] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                  $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $v = $vinf;&nbsp;</div></li><li><div>          for ($y=0; $y&lt;6; ++$y) {&nbsp;</div></li><li><div>              for ($x=0; $x&lt;3; ++$x) {&nbsp;</div></li><li><div>                  $frame[$y][$x+($width - 11)] = chr(0x88 | ($v & 1));&nbsp;</div></li><li><div>                  $v = $v &gt;&gt; 1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// and a little bit...</span>&nbsp;</div></li><li><div>      $frame[$width - 8][8] = &quot;\x81&quot;;&nbsp;</div></li><li><div>      return $frame;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set new frame for the specified version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $version (int) version</span>&nbsp;</div></li><li><div><span class="comment">   * @return Array of unsigned char.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function newFrame($version) {&nbsp;</div></li><li><div>      if (($version &lt; 1) OR ($version &gt; QRSPEC_VERSION_MAX)) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>          $this-&gt;frames[$version] = $this-&gt;createFrame($version);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_null($this-&gt;frames[$version])) {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;frames[$version];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return block number 0</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsBlockNum($spec) {&nbsp;</div></li><li><div>      return ($spec[0] + $spec[3]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * Return block number 1</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsBlockNum1($spec) {&nbsp;</div></li><li><div>      return $spec[0];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return data codes 1</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsDataCodes1($spec) {&nbsp;</div></li><li><div>      return $spec[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return ecc codes 1</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsEccCodes1($spec) {&nbsp;</div></li><li><div>      return $spec[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return block number 2</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsBlockNum2($spec) {&nbsp;</div></li><li><div>      return $spec[3];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return data codes 2</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsDataCodes2($spec) {&nbsp;</div></li><li><div>      return $spec[4];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return ecc codes 2</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsEccCodes2($spec) {&nbsp;</div></li><li><div>      return $spec[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return data length</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsDataLength($spec) {&nbsp;</div></li><li><div>      return ($spec[0] * $spec[1]) + ($spec[3] * $spec[4]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return ecc length</span>&nbsp;</div></li><li><div><span class="comment">   * @param $spec (array)</span>&nbsp;</div></li><li><div><span class="comment">   * @return int value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function rsEccLength($spec) {&nbsp;</div></li><li><div>      return ($spec[0] + $spec[3]) * $spec[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRrs</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize a Reed-Solomon codec and add it to existing rsitems</span>&nbsp;</div></li><li><div><span class="comment">   * @param $symsize (int) symbol size, bits</span>&nbsp;</div></li><li><div><span class="comment">   * @param $gfpoly (int)  Field generator polynomial coefficients</span>&nbsp;</div></li><li><div><span class="comment">   * @param $fcr (int)  first root of RS code generator polynomial, index form</span>&nbsp;</div></li><li><div><span class="comment">   * @param $prim (int)  primitive element to generate polynomial roots</span>&nbsp;</div></li><li><div><span class="comment">   * @param $nroots (int) RS code generator polynomial degree (number of roots)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $pad (int)  padding bytes at front of shortened block</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function init_rs($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>      foreach ($this-&gt;rsitems as $rs) {&nbsp;</div></li><li><div>          if (($rs['pad'] != $pad) OR ($rs['nroots'] != $nroots) OR ($rs['mm'] != $symsize)&nbsp;</div></li><li><div>              OR ($rs['gfpoly'] != $gfpoly) OR ($rs['fcr'] != $fcr) OR ($rs['prim'] != $prim)) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $rs = $this-&gt;init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad);&nbsp;</div></li><li><div>      array_unshift($this-&gt;rsitems, $rs);&nbsp;</div></li><li><div>      return $rs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// - - - - - - - - - - - - - - - - - - - - - - - - -</span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// QRrs</span>Item&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * modnn</span>&nbsp;</div></li><li><div><span class="comment">   * @param $rs (array) RS values</span>&nbsp;</div></li><li><div><span class="comment">   * @param $x (int) X position</span>&nbsp;</div></li><li><div><span class="comment">   * @return int X osition</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function modnn($rs, $x) {&nbsp;</div></li><li><div>      while ($x &gt;= $rs['nn']) {&nbsp;</div></li><li><div>          $x -= $rs['nn'];&nbsp;</div></li><li><div>          $x = ($x &gt;&gt; $rs['mm']) + ($x & $rs['nn']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $x;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initialize a Reed-Solomon codec and returns an array of values.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $symsize (int) symbol size, bits</span>&nbsp;</div></li><li><div><span class="comment">   * @param $gfpoly (int)  Field generator polynomial coefficients</span>&nbsp;</div></li><li><div><span class="comment">   * @param $fcr (int)  first root of RS code generator polynomial, index form</span>&nbsp;</div></li><li><div><span class="comment">   * @param $prim (int)  primitive element to generate polynomial roots</span>&nbsp;</div></li><li><div><span class="comment">   * @param $nroots (int) RS code generator polynomial degree (number of roots)</span>&nbsp;</div></li><li><div><span class="comment">   * @param $pad (int)  padding bytes at front of shortened block</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Array of RS values:&lt;ul&gt;&lt;li&gt;mm = Bits per symbol;&lt;/li&gt;&lt;li&gt;nn = Symbols per block;&lt;/li&gt;&lt;li&gt;alpha_to = log lookup table array;&lt;/li&gt;&lt;li&gt;index_of = Antilog lookup table array;&lt;/li&gt;&lt;li&gt;genpoly = Generator polynomial array;&lt;/li&gt;&lt;li&gt;nroots = Number of generator;&lt;/li&gt;&lt;li&gt;roots = number of parity symbols;&lt;/li&gt;&lt;li&gt;fcr = First consecutive root, index form;&lt;/li&gt;&lt;li&gt;prim = Primitive element, index form;&lt;/li&gt;&lt;li&gt;iprim = prim-th root of 1, index form;&lt;/li&gt;&lt;li&gt;pad = Padding bytes in shortened block;&lt;/li&gt;&lt;li&gt;gfpoly&lt;/ul&gt;.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function init_rs_char($symsize, $gfpoly, $fcr, $prim, $nroots, $pad) {&nbsp;</div></li><li><div>      <span class="comment">// Based on Reed solomon encoder by Phil Karn, KA9Q (GNU-LGPLv2)</span>&nbsp;</div></li><li><div>      $rs = null;&nbsp;</div></li><li><div>      <span class="comment">// Check parameter ranges</span>&nbsp;</div></li><li><div>      if (($symsize &lt; 0) OR ($symsize &gt; 8)) {&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($fcr &lt; 0) OR ($fcr &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($prim &lt;= 0) OR ($prim &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($nroots &lt; 0) OR ($nroots &gt;= (1&lt;&lt;$symsize))) {&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($pad &lt; 0) OR ($pad &gt;= ((1&lt;&lt;$symsize) -1 - $nroots))) {&nbsp;</div></li><li><div>          return $rs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $rs = array();&nbsp;</div></li><li><div>      $rs['mm'] = $symsize;&nbsp;</div></li><li><div>      $rs['nn'] = (1 &lt;&lt; $symsize) - 1;&nbsp;</div></li><li><div>      $rs['pad'] = $pad;&nbsp;</div></li><li><div>      $rs['alpha_to'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>      $rs['index_of'] = array_fill(0, ($rs['nn'] + 1), 0);&nbsp;</div></li><li><div>      <span class="comment">// PHP style macro replacement ;)</span>&nbsp;</div></li><li><div>      $NN =& $rs['nn'];&nbsp;</div></li><li><div>      $A0 =& $NN;&nbsp;</div></li><li><div>      <span class="comment">// Generate Galois field lookup tables</span>&nbsp;</div></li><li><div>      $rs['index_of'][0] = $A0; <span class="comment">// log(zero) = -inf</span>&nbsp;</div></li><li><div>      $rs['alpha_to'][$A0] = 0; <span class="comment">// alpha**-inf = 0</span>&nbsp;</div></li><li><div>      $sr = 1;&nbsp;</div></li><li><div>      for ($i=0; $i&lt;$rs['nn']; ++$i) {&nbsp;</div></li><li><div>          $rs['index_of'][$sr] = $i;&nbsp;</div></li><li><div>          $rs['alpha_to'][$i] = $sr;&nbsp;</div></li><li><div>          $sr &lt;&lt;= 1;&nbsp;</div></li><li><div>          if ($sr & (1 &lt;&lt; $symsize)) {&nbsp;</div></li><li><div>              $sr ^= $gfpoly;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $sr &= $rs['nn'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($sr != 1) {&nbsp;</div></li><li><div>          <span class="comment">// field generator polynomial is not primitive!</span>&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Form RS code generator polynomial from its roots</span>&nbsp;</div></li><li><div>      $rs['genpoly'] = array_fill(0, ($nroots + 1), 0);&nbsp;</div></li><li><div>      $rs['fcr'] = $fcr;&nbsp;</div></li><li><div>      $rs['prim'] = $prim;&nbsp;</div></li><li><div>      $rs['nroots'] = $nroots;&nbsp;</div></li><li><div>      $rs['gfpoly'] = $gfpoly;&nbsp;</div></li><li><div>      <span class="comment">// Find prim-th root of 1, used in decoding</span>&nbsp;</div></li><li><div>      for ($iprim=1; ($iprim % $prim) != 0; $iprim += $rs['nn']) {&nbsp;</div></li><li><div>          ; <span class="comment">// intentional empty-body loop!</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $rs['iprim'] = (int)($iprim / $prim);&nbsp;</div></li><li><div>      $rs['genpoly'][0] = 1;&nbsp;</div></li><li><div>      for ($i = 0, $root=$fcr*$prim; $i &lt; $nroots; $i++, $root += $prim) {&nbsp;</div></li><li><div>          $rs['genpoly'][$i+1] = 1;&nbsp;</div></li><li><div>          <span class="comment">// Multiply rs-&gt;genpoly[] by  @**(root + x)</span>&nbsp;</div></li><li><div>          for ($j = $i; $j &gt; 0; --$j) {&nbsp;</div></li><li><div>              if ($rs['genpoly'][$j] != 0) {&nbsp;</div></li><li><div>                  $rs['genpoly'][$j] = $rs['genpoly'][$j-1] ^ $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][$j]] + $root)];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $rs['genpoly'][$j] = $rs['genpoly'][$j-1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// rs-&gt;genpoly[0] can never be zero</span>&nbsp;</div></li><li><div>          $rs['genpoly'][0] = $rs['alpha_to'][$this-&gt;modnn($rs, $rs['index_of'][$rs['genpoly'][0]] + $root)];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// convert rs-&gt;genpoly[] to index form for quicker encoding</span>&nbsp;</div></li><li><div>      for ($i = 0; $i &lt;= $nroots; ++$i) {&nbsp;</div></li><li><div>          $rs['genpoly'][$i] = $rs['index_of'][$rs['genpoly'][$i]];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $rs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Encode a Reed-Solomon codec and returns the parity array</span>&nbsp;</div></li><li><div><span class="comment">   * @param $rs (array) RS values</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data (array) data</span>&nbsp;</div></li><li><div><span class="comment">   * @param $parity (array) parity</span>&nbsp;</div></li><li><div><span class="comment">   * @return parity array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>   protected function encode_rs_char($rs, $data, $parity) {&nbsp;</div></li><li><div>      $MM =& $rs['mm']; <span class="comment">// bits per symbol</span>&nbsp;</div></li><li><div>      $NN =& $rs['nn']; <span class="comment">// the total number of symbols in a RS block</span>&nbsp;</div></li><li><div>      $ALPHA_TO =& $rs['alpha_to']; <span class="comment">// the address of an array of NN elements to convert Galois field elements in index (log) form to polynomial form</span>&nbsp;</div></li><li><div>      $INDEX_OF =& $rs['index_of']; <span class="comment">// the address of an array of NN elements to convert Galois field elements in polynomial form to index (log) form</span>&nbsp;</div></li><li><div>      $GENPOLY =& $rs['genpoly']; <span class="comment">// an array of NROOTS+1 elements containing the generator polynomial in index form</span>&nbsp;</div></li><li><div>      $NROOTS =& $rs['nroots']; <span class="comment">// the number of roots in the RS code generator polynomial, which is the same as the number of parity symbols in a block</span>&nbsp;</div></li><li><div>      $FCR =& $rs['fcr']; <span class="comment">// first consecutive root, index form</span>&nbsp;</div></li><li><div>      $PRIM =& $rs['prim']; <span class="comment">// primitive element, index form</span>&nbsp;</div></li><li><div>      $IPRIM =& $rs['iprim']; <span class="comment">// prim-th root of 1, index form</span>&nbsp;</div></li><li><div>      $PAD =& $rs['pad']; <span class="comment">// the number of pad symbols in a block</span>&nbsp;</div></li><li><div>      $A0 =& $NN;&nbsp;</div></li><li><div>      $parity = array_fill(0, $NROOTS, 0);&nbsp;</div></li><li><div>      for ($i=0; $i &lt; ($NN - $NROOTS - $PAD); $i++) {&nbsp;</div></li><li><div>          $feedback = $INDEX_OF[$data[$i] ^ $parity[0]];&nbsp;</div></li><li><div>          if ($feedback != $A0) {&nbsp;</div></li><li><div>              <span class="comment">// feedback term is non-zero</span>&nbsp;</div></li><li><div>              <span class="comment">// This line is unnecessary when GENPOLY[NROOTS] is unity, as it must</span>&nbsp;</div></li><li><div>              <span class="comment">// always be for the polynomials constructed by init_rs()</span>&nbsp;</div></li><li><div>              $feedback = $this-&gt;modnn($rs, $NN - $GENPOLY[$NROOTS] + $feedback);&nbsp;</div></li><li><div>              for ($j=1; $j &lt; $NROOTS; ++$j) {&nbsp;</div></li><li><div>              $parity[$j] ^= $ALPHA_TO[$this-&gt;modnn($rs, $feedback + $GENPOLY[($NROOTS - $j)])];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Shift</span>&nbsp;</div></li><li><div>          array_shift($parity);&nbsp;</div></li><li><div>          if ($feedback != $A0) {&nbsp;</div></li><li><div>              array_push($parity, $ALPHA_TO[$this-&gt;modnn($rs, $feedback + $GENPOLY[0])]);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              array_push($parity, 0);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $parity;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>} <span class="comment">// end QRcode class</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//============================================================+</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">// END OF FILE</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//============================================================+</span></span></span></span>&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Booster for WooCommerce</li><li><span></span>2.7.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>